import{r as a,j as e,u as Rn,a as Ea,b as An,c as En,d as Pn,R as nn,B as sn,C as rn}from"./vendor-CL5v9b84.js";import{L as Ns,A as Ss,g as Ts,a as Gs,b as Oa,c as Cs,s as Hn,d as Kn,e as Ys,f as Wn,h as aa,i as Qs,j as Xs,k as Ua,l as qa,m as Is,n as Fn,o as Ln,p as Zs,u as Gn,q as Ms,r as ei,t as ti,v as ai,w as ni,x as si,y as Ls,z as ii,B as $s,C as Rs,D as ri,E as oi,F as on,G as Ja,H as li,I as As,J as ci,K as di,M as Es,N as ui,O as hi,P as gi,Q as Yn,R as ua,S as mi,T as pi,U as fi,V as bi,W as yi,X as xi,Y as vi,Z as wi,_ as ji,$ as ki,a0 as Ni,a1 as Si,a2 as Ti,a3 as Qn}from"./recreatio-core-ULPb4Sxr.js";import"./vendor-cogita-ui-mbCyoqV0.js";const La={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},Ma={moveMs:900,pauseMs:220,errorMs:900},Ci=(t=11)=>{let n=t;const s=()=>(n=(n*1664525+1013904223)%4294967296,n/4294967296),{width:i,height:r,paddingX:h,paddingY:g,levels:k}=La,j=(r-g*2)/(k.length-1),L=[],o=[],y=[];k.forEach((m,u)=>{const ue=r-g-u*j,K=i-h*2,p=[];for(let V=0;V<m;V+=1){const N=h+(V+1)*K/(m+1),Y=(s()-.5)*18,F=Math.max(h,Math.min(i-h,N+Y)),I=u===0?3:u<2?2.1:1.4,ge=u===0?"root":`l${u}-${V}`;p.push({id:ge,x:u===0?i/2:F,y:ue,r:I,level:u,role:u===0?"root":void 0})}y.push(p),L.push(...p)});const l=y[y.length-1];if(l!=null&&l.length){const m=l[Math.floor(l.length/2)];m.role="goal",m.r=2}for(let m=1;m<y.length;m+=1){const u=y[m-1];y[m].forEach(K=>{const p=[...u].sort((F,I)=>Math.abs(F.x-K.x)-Math.abs(I.x-K.x)),V=p[0],N=p[1]&&s()<.45?p[1]:null;(N?[V,N]:[V]).forEach(F=>{o.push({from:F.id,to:K.id,key:`${F.id}-${K.id}`})}),s()<.2&&p[2]&&o.push({from:p[2].id,to:K.id,key:`${p[2].id}-${K.id}`})})}const d=new Map;o.forEach(m=>{const u=d.get(m.to)??[];u.push(m.from),d.set(m.to,u)});const v=new Map,w=new Map,T=new Map;o.forEach(m=>{const u=v.get(m.from)??[];u.push(m.key),v.set(m.from,u);const ue=w.get(m.from)??[];ue.push(m.to),w.set(m.from,ue);const K=T.get(m.from)??[];K.push(m.to),T.set(m.from,K);const p=T.get(m.to)??[];p.push(m.from),T.set(m.to,p)});const z=new Map;return L.forEach(m=>{z.set(m.id,m)}),{nodes:L,links:o,parentsById:d,linksByFrom:v,childrenByFrom:w,neighborsById:T,nodesById:z}};function Ii({slides:t,activeIndex:n,introOpen:s,prefersReducedMotion:i,onNext:r,onPrev:h,onSelect:g,onExit:k,onOpen:j,onRegister:L}){const o=n===t.length-1,y=s&&n===0?"entry":"docked",l=t[t.length-1],[d,v]=a.useState(!1),w=a.useMemo(()=>Array.from({length:20},(R,Z)=>({src:`/cogita/logo/Cogita${String(Z).padStart(2,"0")}.png`,kind:Z<=11?"bubble":Z<=17?"text":"recreatio"})),[]),T=s&&n===0;a.useEffect(()=>{if(!s){v(!1);return}n>0&&!d&&v(!0)},[n,s,d]);const z=a.useRef(0),m=a.useRef(null),u=a.useMemo(()=>{const R={x:40,y:160},Z={x:260,y:48},re=6,S=Z.x-R.x,J=R.y-Z.y,P=S/re,G=[.3,.45,.6,.65,1.4,2.2],ne=G.reduce((he,de)=>he+de,0),Se=G.map(he=>J*he/ne),Re=[R];let De=R.x,ke=R.y;for(let he=1;he<=re;he+=1){const de=(Math.random()-.5)*14,ze=(Math.random()-.5)*28;De=Math.max(R.x+he*14,Math.min(Z.x-(re-he)*14,De+P+de));const _e=Se[he-1]??Se[Se.length-1];ke=ke-_e+ze;const nt=Math.max(Z.y,Math.min(R.y-4,ke));Re.push({x:Math.round(De),y:Math.round(nt)})}return Re[Re.length-1]=Z,Re},[]),ue=a.useMemo(()=>{const J=(ne,Se,Re)=>Math.min(Re,Math.max(Se,ne)),P=u.map(ne=>{const Se=10+Math.random()*36;return{x:J(ne.x,40,260),y:J(ne.y-Se,40,140)}}),G=u.map((ne,Se)=>{var ke;const Re=12+Math.random()*40,De=((ke=P[Se])==null?void 0:ke.y)??ne.y;return{x:J(ne.x,40,260),y:J(Math.max(De+10,ne.y+Re),60,170)}});return{upper:P,lower:G}},[u]),K=a.useMemo(()=>{var Z;const R=((Z=u[4])==null?void 0:Z.x)??260;return Math.max(0,Math.min(240,R-40))},[u]),p=a.useMemo(()=>{var Se,Re;const R=(De,ke,he)=>Math.min(he,Math.max(ke,De)),Z=(De,ke,he)=>u.map((de,ze)=>{var bt,wt;const _e=((bt=ue.upper[ze])==null?void 0:bt.y)??de.y,nt=((wt=ue.lower[ze])==null?void 0:wt.y)??de.y,dt=(Math.random()-.5)*70,vt=de.y+De+dt,We=R(de.y+ke,_e+6,nt-6),ot=R(de.y+he,_e+6,nt-6);return{x:de.x,y:R(vt,Math.min(We,ot),Math.max(We,ot))}}),re=-14+Math.random()*28,S=14+Math.random()*28,J=Z(re,-80,12),P=Z(S,-12,80);for(let De=4;De<u.length;De+=1){const ke=u[De],he=((Se=ue.upper[De])==null?void 0:Se.y)??ke.y,de=((Re=ue.lower[De])==null?void 0:Re.y)??ke.y;J[De]={x:ke.x,y:R(ke.y-12,he+6,de-6)},P[De]={x:ke.x,y:R(ke.y+12,he+6,de-6)}}const G=ue.upper.length?ue.upper[ue.upper.length-1].y:40,ne=ue.lower.length?ue.lower[ue.lower.length-1].y:170;return J[J.length-1]={x:u[u.length-1].x,y:R(u[u.length-1].y-14,G,ne)},P[P.length-1]={x:u[u.length-1].x,y:R(u[u.length-1].y+12,G,ne)},{higher:J,lower:P}},[u,ue]),V=1e4,N=a.useMemo(()=>{let R=17;const Z=()=>(R=(R*1664525+1013904223)%4294967296,R/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((S,J)=>{const P=(Z()-.5)*240,G=(Z()-.5)*180,ne=(Z()-.5)*24;return{id:`card-${J+1}`,throw:{x:`${P.toFixed(0)}px`,y:`${G.toFixed(0)}px`,rot:`${ne.toFixed(1)}deg`},grid:{x:`${S.x}px`,y:`${S.y}px`},delay:`${J*.12}s`}})},[]),Y=a.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[F,I]=a.useState([]),ge=a.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),le=a.useMemo(()=>{const Z=[],S=(P,G)=>P+Math.random()*(G-P);for(let P=0;P<6;P+=1){let G=!1;for(let ne=0;ne<80;ne+=1){const Se=S(14,86),Re=S(10,34);if(Z.every(ke=>{const he=ke.x-Se,de=ke.y-Re;return Math.hypot(he,de)>=12})){Z.push({x:Se,y:Re}),G=!0;break}}G||Z.push({x:S(16,84),y:S(12,32)})}return Z.map((P,G)=>({id:`p${G+1}`,x:`${P.x.toFixed(1)}%`,y:`${P.y.toFixed(1)}%`,xNum:P.x,yNum:P.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[xe,Ce]=a.useState(0),[te,C]=a.useState(0),[Ie,O]=a.useState([]),ae=1e4,H=a.useMemo(()=>{if(le.length<2)return[];const R=G=>{let ne=G+1831565813;return ne=Math.imul(ne^ne>>>15,ne|1),ne^=ne+Math.imul(ne^ne>>>7,ne|61),((ne^ne>>>14)>>>0)/4294967296},Z=(G,ne)=>Math.floor(R(G)*ne),re=new Set,S=[],J=Math.min(3,le.length);let P=0;for(;S.length<J&&P<30;){P+=1;const G=Z(xe*13+P*5,le.length),ne=Z(xe*29+P*7,le.length);if(G===ne)continue;const Se=G<ne?`${G}-${ne}`:`${ne}-${G}`;re.has(Se)||(re.add(Se),S.push({id:`link-${Se}`,from:le[G],to:le[ne],delay:`${(P*.35).toFixed(2)}s`}))}return S},[xe,le]);a.useEffect(()=>{if(!s||n!==2)return;const R=()=>{const re=N.map(S=>S.id);for(let S=re.length-1;S>0;S-=1){const J=Math.floor(Math.random()*(S+1));[re[S],re[J]]=[re[J],re[S]]}return re.slice(0,4)};I(R());const Z=window.setInterval(()=>{I(R())},V);return()=>window.clearInterval(Z)},[n,s,N,V]),a.useEffect(()=>{if(!s||n!==3)return;const R=()=>{C(Math.floor(Math.random()*ge.length)),O(le.map(()=>Math.random()<.6?"good":"bad")),Ce(re=>re+1)};R();const Z=window.setInterval(R,ae);return()=>window.clearInterval(Z)},[n,s,ge.length,le,ae]);const ye=a.useMemo(()=>Ci(11),[]),[_,ce]=a.useState(new Set(["root"])),[ve,Pe]=a.useState(new Set),[qe,Me]=a.useState(new Set),[Oe,Ye]=a.useState({fromId:"root",toId:"root",key:0}),Le=a.useRef(_),He=a.useRef("root"),at=a.useRef(0),it=a.useRef(null),Be=a.useRef(null),Ne=a.useRef([]);a.useEffect(()=>{Le.current=_},[_]);const W=a.useMemo(()=>{const R=new Set;return _.forEach(Z=>{const re=ye.linksByFrom.get(Z);re&&re.forEach(S=>R.add(S))}),R},[_,ye]),$e=ye.nodesById.get(Oe.toId)??ye.nodesById.get("root"),oe=$e?`${$e.x/La.width*100}%`:"50%",U=$e?`${$e.y/La.height*100}%`:"90%";a.useEffect(()=>{if(!s||n!==1||i)return;(()=>{ce(new Set(["root"])),Pe(new Set),Me(new Set),Ye({fromId:"root",toId:"root",key:0}),Be.current=null,at.current=0,He.current="root",Ne.current=[]})();const Z=()=>{const S=He.current,J=Le.current,G=(ye.childrenByFrom.get(S)??[]).filter(de=>!J.has(de));if(G.length)return G[Math.floor(Math.random()*G.length)];if(J.size>=ye.nodes.length){const de=ye.neighborsById.get(S)??[];return de.length?de[Math.floor(Math.random()*de.length)]:null}const ne=de=>(ye.childrenByFrom.get(de)??[]).some(_e=>!J.has(_e)),Se=[S],Re=new Set([S]),De=new Map;let ke=null;for(;Se.length;){const de=Se.shift();if(!de)break;if(de!==S&&ne(de)){ke=de;break}(ye.neighborsById.get(de)??[]).forEach(_e=>{Re.has(_e)||(Re.add(_e),De.set(_e,de),Se.push(_e))})}if(!ke)return null;let he=ke;for(;De.get(he)&&De.get(he)!==S;)he=De.get(he)??he;return he},re=(S,J)=>{if(S===J){const P=Z();P&&re(S,P);return}at.current+=1,Ye({fromId:S,toId:J,key:at.current}),He.current=J,it.current=window.setTimeout(()=>{const P=ye.parentsById.get(J)??[],G=Le.current,ne=P.filter(ke=>!G.has(ke));if(!ne.length){const ke=new Set(G);ke.add(J),ce(ke),it.current=window.setTimeout(()=>{for(;Ne.current.length;){const de=Ne.current[Ne.current.length-1];if(!ke.has(de)){if(de!==J){re(J,de);return}break}Ne.current.pop()}const he=Z();he&&re(J,he)},Ma.pauseMs);return}const Se=new Set([J,...ne]),Re=new Set(ne.map(ke=>`${ke}-${J}`));Pe(Se),Me(Re),Ne.current.includes(J)||Ne.current.push(J);const De=ne[Math.floor(Math.random()*ne.length)];Be.current={fromId:J,toId:De},it.current=window.setTimeout(()=>{Pe(new Set),Me(new Set);const ke=Be.current;ke&&re(ke.fromId,ke.toId)},Ma.errorMs)},Ma.moveMs)};return it.current=window.setTimeout(()=>{const S=Z();S&&re(He.current,S)},Ma.pauseMs),()=>{it.current&&window.clearTimeout(it.current)}},[n,s,ye,i]);const fe=R=>{if(!s)return;const Z=Date.now();Z-z.current<520||Math.abs(R.deltaY)<10||(z.current=Z,R.deltaY>0?r():h(),R.preventDefault())},Je=R=>{if(!s)return;const Z=R.touches[0];Z&&(m.current={x:Z.clientX,y:Z.clientY})},E=R=>{if(!s)return;const Z=m.current;if(m.current=null,!Z)return;const re=R.changedTouches[0];if(!re)return;const S=re.clientX-Z.x,J=re.clientY-Z.y;Math.abs(J)<40||Math.abs(J)<Math.abs(S)||(J<0?r():h())};return e.jsxs("div",{className:`cogita-intro ${s?"is-open":"is-closed"} ${i?"is-reduced":""} ${o?"is-final":""}`,"data-slide":n+1,onWheel:fe,onTouchStart:Je,onTouchEnd:E,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":y,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${T&&!d?"is-entry":""}`,children:w.map((R,Z)=>e.jsx("img",{src:R.src,alt:"",className:`cogita-logo-layer ${Z===0?"is-base":""} ${R.kind==="text"?"is-text":R.kind==="recreatio"?"is-recreatio":""} ${R.kind==="bubble"?"is-bubble":""}`},R.src))})}),s&&t.map((R,Z)=>{const re=Z===n;return e.jsxs("section",{className:`cogita-intro-slide slide-${Z+1} ${re?"is-active":""}`,"aria-hidden":!re,children:[e.jsxs("div",{className:"cogita-intro-text",children:[R.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:R.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:R.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:R.title}),R.body&&e.jsx("p",{children:R.body.split(`
`).map((S,J)=>e.jsxs("span",{children:[S,J===0&&e.jsx("br",{})]},String(J)))})]}),R.micro&&e.jsx("p",{className:"cogita-intro-micro",children:R.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:o?L:r,children:R.cta}),o&&R.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>g(0),children:R.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[Z===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${La.width} ${La.height}`,preserveAspectRatio:"none",children:[ye.links.map(S=>{const J=ye.nodesById.get(S.from),P=ye.nodesById.get(S.to);if(!J||!P)return null;const G=W.has(S.key),ne=qe.has(S.key);return e.jsx("line",{className:`map-link ${G?"is-active":""} ${ne?"is-error":""}`,x1:J.x,y1:J.y,x2:P.x,y2:P.y},S.key)}),ye.nodes.map(S=>{const J=_.has(S.id),P=ve.has(S.id);return e.jsx("circle",{className:`map-node ${S.role?`is-${S.role}`:""} ${J?"is-active":""} ${P?"is-error":""}`,cx:S.x,cy:S.y,r:S.r},S.id)})]}),$e&&e.jsx("span",{className:"map-explorer-dot",style:{left:oe,top:U,"--move":`${Ma.moveMs}ms`}})]}),Z===2&&e.jsx("div",{className:"cogita-index-cards",children:N.map(S=>{const J=F.indexOf(S.id),P=J>=0?Y[J]:null,G=(P==null?void 0:P.x)??"140px",ne=(P==null?void 0:P.y)??"140px",Se=J>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":S.throw.x,"--throw-y":S.throw.y,"--throw-rot":S.throw.rot,"--grid-x":S.grid.x,"--grid-y":S.grid.y,"--stack-x":G,"--stack-y":ne,"--stack-opacity":Se,"--delay":S.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},S.id)})}),Z===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[ge.map((S,J)=>e.jsxs("div",{className:`round-card ${J===te?"is-active":""}`,style:{"--card-x":S.x,"--card-y":S.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},S.id)),ge[te]&&e.jsx("span",{className:"round-ring",style:{"--card-x":ge[te].x,"--card-y":`calc(${ge[te].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:le.map(S=>e.jsx("span",{className:"player-dot",style:{left:S.x,top:S.y,"--jitter-x":S.jitterX,"--jitter-y":S.jitterY,"--breath-delay":S.delay}},S.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:H.map(S=>e.jsx("line",{className:"round-link",x1:S.from.xNum,y1:S.from.yNum,x2:S.to.xNum,y2:S.to.yNum,style:{"--delay":S.delay}},S.id))}),e.jsx("div",{className:"round-flows",children:le.map((S,J)=>{const P=Ie[J]??"good",G=ge[te];if(!G)return null;const ne=`calc(${G.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":S.x,"--from-y":S.y,"--to-x":G.x,"--to-y":ne,"--delay":`${J*.12}s`}}),e.jsx("span",{className:`return-dot is-${P}`,style:{"--from-x":G.x,"--from-y":ne,"--to-x":S.x,"--to-y":S.y,"--delay":`${J*.12}s`}}),e.jsx("span",{className:`result-pop is-${P}`,style:{"--at-x":S.x,"--at-y":S.y,"--delay":`${J*.12}s`}})]},`${S.id}-${xe}`)})})]},`round-${xe}`),Z===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${u[0].x} ${u[0].y} L${u[1].x} ${u[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${u[1].x} ${u[1].y} L${u[2].x} ${u[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${u[2].x} ${u[2].y} L${u[3].x} ${u[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${u[3].x} ${u[3].y} L${u[4].x} ${u[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${u[4].x} ${u[4].y} L${u[5].x} ${u[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${u[5].x} ${u[5].y} L${u[6].x} ${u[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${K};${K};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${ue.upper.map((S,J)=>`${J===0?"M":"L"}${S.x} ${S.y}`).join(" ")} ${ue.lower.slice().reverse().map(S=>`L${S.x} ${S.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${ue.upper.map((S,J)=>`${J===0?"M":"L"}${S.x} ${S.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${ue.lower.map((S,J)=>`${J===0?"M":"L"}${S.x} ${S.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[p.higher.slice(0,6).map((S,J)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${J+1}`,d:`M${S.x} ${S.y} L${p.higher[J+1].x} ${p.higher[J+1].y}`,pathLength:"100"},`peer-1-${J}`)),p.lower.slice(0,6).map((S,J)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${J+1}`,d:`M${S.x} ${S.y} L${p.lower[J+1].x} ${p.lower[J+1].y}`,pathLength:"100"},`peer-2-${J}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${u[0].x/300*100}%`,"--p0y":`${u[0].y/200*100}%`,"--p1x":`${u[1].x/300*100}%`,"--p1y":`${u[1].y/200*100}%`,"--p2x":`${u[2].x/300*100}%`,"--p2y":`${u[2].y/200*100}%`,"--p3x":`${u[3].x/300*100}%`,"--p3y":`${u[3].y/200*100}%`,"--p4x":`${u[4].x/300*100}%`,"--p4y":`${u[4].y/200*100}%`,"--p5x":`${u[5].x/300*100}%`,"--p5y":`${u[5].y/200*100}%`,"--p6x":`${u[6].x/300*100}%`,"--p6y":`${u[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${p.higher[0].x/300*100}%`,"--q0y":`${p.higher[0].y/200*100}%`,"--q1x":`${p.higher[1].x/300*100}%`,"--q1y":`${p.higher[1].y/200*100}%`,"--q2x":`${p.higher[2].x/300*100}%`,"--q2y":`${p.higher[2].y/200*100}%`,"--q3x":`${p.higher[3].x/300*100}%`,"--q3y":`${p.higher[3].y/200*100}%`,"--q4x":`${p.higher[4].x/300*100}%`,"--q4y":`${p.higher[4].y/200*100}%`,"--q5x":`${p.higher[5].x/300*100}%`,"--q5y":`${p.higher[5].y/200*100}%`,"--q6x":`${p.higher[6].x/300*100}%`,"--q6y":`${p.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${p.lower[0].x/300*100}%`,"--q0y":`${p.lower[0].y/200*100}%`,"--q1x":`${p.lower[1].x/300*100}%`,"--q1y":`${p.lower[1].y/200*100}%`,"--q2x":`${p.lower[2].x/300*100}%`,"--q2y":`${p.lower[2].y/200*100}%`,"--q3x":`${p.lower[3].x/300*100}%`,"--q3y":`${p.lower[3].y/200*100}%`,"--q4x":`${p.lower[4].x/300*100}%`,"--q4y":`${p.lower[4].y/200*100}%`,"--q5x":`${p.lower[5].x/300*100}%`,"--q5y":`${p.lower[5].y/200*100}%`,"--q6x":`${p.lower[6].x/300*100}%`,"--q6y":`${p.lower[6].y/200*100}%`}})]})})}),Z===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),Z===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},R.id)}),!s&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:l.title}),l.body&&e.jsx("p",{children:l.body}),l.micro&&e.jsx("p",{className:"cogita-intro-micro",children:l.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:L,children:l.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:j,children:"Otwórz pokaz"})]})]})})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((R,Z)=>e.jsx("button",{type:"button",className:`dot ${n===Z?"active":""}`,"aria-label":R.title,onClick:()=>g(Z)},R.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:k,children:"Pomiń"})]})]})}const Mi=6,Li=4;function $i({copy:t,onAuthAction:n,authLabel:s,showProfileMenu:i,onProfileNavigate:r,onToggleSecureMode:h,onLogout:g,secureMode:k,onNavigate:j,language:L,onLanguageChange:o}){const y=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}j("home")},l=a.useRef(null),d=a.useRef([]),v=a.useMemo(()=>{let O=Date.now()%2147483647;const ae=()=>(O=O*48271%2147483647,O/2147483647);return Array.from({length:Mi},(H,ye)=>{const _=6+ae()*8,ce=7+ae()*10,ve=6+ae()*9,Pe=-ae()*_,qe=-ae()*ce,Me=-ae()*ve,Oe=.18+ae()*.28,Ye=12+ae()*18,Le=4+ae()*8,He=(ae()-.5)*3.2,at=(ae()-.5)*3.8,it=ae()>.5?"alternate":"alternate-reverse",Be=ae()>.5?"alternate":"alternate-reverse",Ne=ae()>.5?"alternate":"alternate-reverse",W=.18+ae()*.42,$e=30+ae()*60,oe=-45-ae()*38,U=188+ae()*32,fe=.1+ae()*.2;return{id:`wave-${ye+1}`,style:{"--wave-sway-duration":`${_}s`,"--wave-scale-duration":`${ce}s`,"--wave-drift-duration":`${ve}s`,"--wave-sway-delay":`${Pe}s`,"--wave-scale-delay":`${qe}s`,"--wave-drift-delay":`${Me}s`,"--wave-sway-dir":it,"--wave-scale-dir":Be,"--wave-drift-dir":Ne,"--wave-scale":`${Oe}`,"--wave-shift":`${Ye}%`,"--wave-xshift":`${Le}%`,"--wave-x0":`${He}%`,"--wave-y0":`${at}%`,"--wave-opacity":`${W}`,"--wave-blur":`${$e}px`,"--wave-bottom":`${oe}%`,"--wave-hue":`${U}`,"--wave-glow":`${fe}`}}})},[]),w=a.useMemo(()=>{let O=Date.now()*3%2147483647;const ae=()=>(O=O*48271%2147483647,O/2147483647);return Array.from({length:Li},(H,ye)=>{const _=180+ae()*220,ce=220+ae()*280,ve=-ae()*_,Pe=-ae()*ce,qe=.12+ae()*.22,Me=3+ae()*7,Oe=1+ae()*3,Ye=(ae()-.5)*2.8,Le=(ae()-.5)*2.2;return{id:`mesh-${ye+1}`,seed:1e3+ye*991+Math.floor(ae()*999),style:{"--mesh-sway-duration":`${_}s`,"--mesh-drift-duration":`${ce}s`,"--mesh-sway-delay":`${ve}s`,"--mesh-drift-delay":`${Pe}s`,"--mesh-scale":`${qe}`,"--mesh-shift":`${Me}%`,"--mesh-xshift":`${Oe}%`,"--mesh-x0":`${Le}%`,"--mesh-y0":`${Ye}%`}}})},[]),T=a.useMemo(()=>{const O=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],ae=t.cogita.introSlides,H=new Map(ae.map(ye=>[ye.id,ye]));return O.map(ye=>{var ce;const _=H.get(ye.id);return{...ye,..._,title:(_==null?void 0:_.title)??"Cogita",cta:(_==null?void 0:_.cta)??((ce=t.cogita.introSlides[0])==null?void 0:ce.cta)??t.cogita.loginCta,secondary:_==null?void 0:_.secondary}})},[t.cogita.introSlides]),[z,m]=a.useState(0),[u,ue]=a.useState(!0),[K,p]=a.useState(!1),V=T.length-1,N=a.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),Y=a.useCallback(()=>{N(),n()},[N,n]),F=a.useCallback(()=>{ue(!0),m(0)},[]),I=a.useCallback(()=>{ue(!1),m(V)},[V]),ge=a.useCallback(O=>{m(Math.max(0,Math.min(V,O)))},[V]),le=a.useCallback(()=>{z>=V?Y():ge(z+1)},[z,ge,Y,V]),xe=a.useCallback(()=>{ge(z-1)},[z,ge]);a.useEffect(()=>{var H;const O=(H=window.matchMedia)==null?void 0:H.call(window,"(prefers-reduced-motion: reduce)");if(!O)return;const ae=()=>p(O.matches);return ae(),O.addEventListener?(O.addEventListener("change",ae),()=>O.removeEventListener("change",ae)):(O.addListener(ae),()=>O.removeListener(ae))},[]),a.useEffect(()=>{if(!u)return;const O=ae=>{const H=ae.target;if(!H)return;const ye=H.tagName;if(!(H.isContentEditable||ye==="INPUT"||ye==="TEXTAREA"||ye==="SELECT"||ye==="BUTTON"||ye==="A"||H.closest('button, a, [role="button"], [role="link"]'))){if(ae.key==="Escape"){I();return}if(ae.key==="ArrowLeft"||ae.key==="ArrowUp"){xe();return}(ae.key==="ArrowRight"||ae.key==="ArrowDown"||ae.code==="Space"||ae.key===" ")&&(ae.preventDefault(),le())}};return window.addEventListener("keydown",O),()=>window.removeEventListener("keydown",O)},[I,le,xe,u]),a.useEffect(()=>{u&&z===V&&N()},[z,u,V,N]),a.useEffect(()=>{const O=l.current;if(!O)return;const ae=d.current.filter(oe=>!!oe);if(!ae.length)return;const H=1,ye=.6,_=.6,ce=Math.max(1,Math.min(H,window.devicePixelRatio||1));let ve=0,Pe=0,qe=ye,Me=0,Oe=0;const Ye=oe=>{let U=oe%2147483647;return U<=0&&(U+=2147483646),(fe,Je)=>{U=U*48271%2147483647;const E=U/2147483647;return fe+E*(Je-fe)}},Le={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},He=oe=>{const U=Math.sin(oe*12.9898)*43758.5453;return U-Math.floor(U)},at=oe=>{const U=He(oe+.1)||1e-4,fe=He(oe+.7)||1e-4;return Math.sqrt(-2*Math.log(U))*Math.cos(2*Math.PI*fe)},it=(oe,U)=>{const fe=Math.floor(oe),Je=fe+1,E=oe-fe,R=E*E*(3-2*E),Z=He(fe*12.9898+U*78.233),re=He(Je*12.9898+U*78.233);return Z+(re-Z)*R},Be=oe=>{const U=Ye(oe),fe=Math.min(4,Math.max(4,Math.floor(ve/1200*Le.filamentCount)));return Array.from({length:fe},(Je,E)=>{const R=Math.max(-1,Math.min(1,at(oe+E*.37))),Z=Math.min(1,Math.max(0,He(oe+E*1.31))),re=Math.min(Le.depthLayers-1,Math.floor(Z*Le.depthLayers));return{seed:U(0,Math.PI*2)+oe*.01,offset:R,freqA:Le.freq1*(.75+U(0,.5)),freqB:Le.freq2*(.75+U(0,.5)),ampA:Le.amp1*(.6+U(0,.7)),ampB:Le.amp2*(.6+U(0,.7)),width:2+E%5*.32,depth:Z,layer:re}})},Ne=(oe,U,fe)=>{const Je=Math.max(30,Math.floor(ve*Pe/14e4));oe.save(),oe.globalAlpha=.6;for(let E=0;E<Je;E+=1){const R=He(E*9.1+ve*.11)*U+fe,Z=He(E*3.7+Pe*.23)*Pe,re=1.2+He(E*5.9)*2.4,S=oe.createRadialGradient(R,Z,0,R,Z,re*2);S.addColorStop(0,"rgba(10, 30, 60, 0.45)"),S.addColorStop(1,"rgba(10, 30, 60, 0)"),oe.fillStyle=S,oe.beginPath(),oe.arc(R,Z,re*2,0,Math.PI*2),oe.fill()}oe.restore()},W=(oe,U)=>{oe.clearRect(0,0,ve,Pe);const fe=Pe*Le.waveCenter,Je=Le.waveBandPx,E=Le.segments,R=Le.colors.filaments,Z=Me||ve,re=0;Ne(oe,Z,re),oe.strokeStyle=R,oe.lineCap="round",oe.lineJoin="round";for(let S=0;S<U.length;S+=1){const J=U[S],P=J.offset*Je*(.85+He(J.seed)*.4),G=1-Math.min(1,Math.abs(P)/Je),ne=Math.exp(-Math.pow(P/Le.crestThickness,2)),Se=J.layer===0?1.1:J.layer===1?.85:.6,Re=.35+(1-J.depth)*.65,De=G*Re*Se*(.34+ne*.45);oe.globalAlpha=De,oe.lineWidth=J.width*(1+(1-J.depth)*.8);const ke=[];for(let de=0;de<=E;de+=1){const ze=de/E*Z+re,_e=(it(ze*.012,J.seed)-.5)*Le.xJitter,nt=ze+_e,dt=(it(nt*J.freqA,J.seed)-.5)*Le.jitterA,vt=(it(nt*J.freqB,J.seed*1.7)-.5)*Le.jitterB,We=fe+Math.sin(nt*J.freqA+J.seed)*J.ampA+Math.sin(nt*J.freqB+J.seed*1.3)*J.ampB+P+dt+vt;ke.push({x:nt,y:We})}oe.beginPath(),oe.moveTo(ke[0].x,ke[0].y);for(let de=1;de<ke.length-1;de+=1){const ze=(ke[de].x+ke[de+1].x)/2,_e=(ke[de].y+ke[de+1].y)/2;oe.quadraticCurveTo(ke[de].x,ke[de].y,ze,_e)}const he=ke[ke.length-1];oe.quadraticCurveTo(he.x,he.y,he.x,he.y),oe.stroke()}oe.save(),oe.globalCompositeOperation="lighter",oe.strokeStyle=Le.colors.glow,oe.lineCap="round",oe.lineJoin="round";for(let S=0;S<U.length;S+=1){const J=U[S];if(Math.abs(J.offset)*Je>Le.crestThickness)continue;const P=Le.glowAlpha*(.7+(1-J.depth)*.6);oe.globalAlpha=P,oe.lineWidth=1.6+(1-J.depth)*1.2;const G=[];for(let Se=0;Se<=E;Se+=1){const Re=Se/E*Z+re,De=Math.sin(Re*.02+J.seed)*3,ke=fe+Math.sin(Re*J.freqA+J.seed)*J.ampA+Math.sin(Re*J.freqB+J.seed*1.3)*J.ampB+J.offset*Je*.35+De;G.push({x:Re,y:ke})}oe.beginPath(),oe.moveTo(G[0].x,G[0].y);for(let Se=1;Se<G.length-1;Se+=1){const Re=(G[Se].x+G[Se+1].x)/2,De=(G[Se].y+G[Se+1].y)/2;oe.quadraticCurveTo(G[Se].x,G[Se].y,Re,De)}const ne=G[G.length-1];oe.quadraticCurveTo(ne.x,ne.y,ne.x,ne.y),oe.stroke()}oe.restore()},$e=()=>{ve=Math.floor(O.clientWidth),Pe=Math.floor(O.clientHeight),Me=Math.floor(ve*1.8),Oe=Pe,qe=ve<820?_:ye,ae.forEach(oe=>{const U=oe.getContext("2d");if(!U)return;oe.width=Math.floor(Me*ce*qe),oe.height=Math.floor(Oe*ce*qe),oe.style.width=`${Me}px`,oe.style.height=`${Oe}px`,oe.style.left=`${-(Me-ve)/2}px`,U.setTransform(ce*qe,0,0,ce*qe,0,0);const fe=Number(oe.dataset.seed||1),Je=Be(fe);W(U,Je)})};return $e(),window.addEventListener("resize",$e,{passive:!0}),()=>window.removeEventListener("resize",$e)},[w]);const Ce=T[Math.min(z,T.length-1)],te=u?Ce:T[T.length-1],C=(te==null?void 0:te.theme)??T[0].theme,Ie={"--cogita-bg0":C.bg0,"--cogita-bg1":C.bg1,"--cogita-bg2":C.bg2,"--cogita-bloom":C.bloom,"--cogita-sat":C.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:y,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Ns,{value:L,onChange:o}),e.jsx(Ss,{copy:t,label:s,isAuthenticated:i,secureMode:k,onLogin:n,onProfileNavigate:r,onToggleSecureMode:h,onLogout:g,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:l,className:"cogita-section cogita-home",style:Ie,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[w.map((O,ae)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:O.style,"data-seed":O.seed,ref:H=>{d.current[ae]=H}},O.id)),v.map(O=>e.jsx("div",{className:"cogita-home-wave",style:O.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},O.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(Ii,{slides:T,activeIndex:z,introOpen:u,prefersReducedMotion:K,onNext:le,onPrev:xe,onSelect:ge,onExit:I,onOpen:F,onRegister:Y})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const Yr=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:$i},Symbol.toStringTag,{value:"Module"})),Ps=a.createContext(!1);function Pt({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,headerExtra:o,children:y}){if(a.useContext(Ps))return e.jsx(e.Fragment,{children:y});const d=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}k("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:d,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Ns,{value:j,onChange:L}),e.jsxs("div",{className:"cogita-header-right",children:[o,e.jsx(Ss,{copy:t,label:n,isAuthenticated:s,secureMode:g,onLogin:()=>k("home"),onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:y}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function na(t){const[n,s]=a.useState("Cogita library"),[i,r]=a.useState(null);return a.useEffect(()=>{let h=!1;return Ts().then(g=>{if(h)return;const k=g.find(j=>j.libraryId===t);k&&s(k.name)}).catch(()=>{h||s("Cogita library")}),()=>{h=!0}},[t]),a.useEffect(()=>{let h=!1;return Gs(t).then(g=>{h||r(g)}).catch(()=>{h||r(null)}),()=>{h=!0}},[t]),{libraryName:n,stats:i}}function Xn({slices:t}){const n=t.reduce((i,r)=>i+Math.max(0,r.value),0),s=a.useMemo(()=>{if(n<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let i=0;return`conic-gradient(${t.map(h=>{const k=Math.max(0,h.value)/n*360,j=i,L=i+k;return i=L,`${h.color} ${j}deg ${L}deg`}).join(",")})`},[t,n]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:s}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(i=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:i.color}}),e.jsx("strong",{children:i.value}),e.jsx("small",{children:i.label})]},i.label))})]})}function Ri({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,libraryId:o}){const{libraryName:y,stats:l}=na(o),[d,v]=a.useState("infos"),[w,T]=a.useState(0),[z,m]=a.useState(0),[u,ue]=a.useState(0),K=(l==null?void 0:l.totalInfos)??0,p=(l==null?void 0:l.totalCollections)??0,V=0,N=0,Y=0,F=Math.max(0,K-Y-z),I=Math.max(0,K-z-u);a.useEffect(()=>{let le=!1;return(async()=>{try{const Ce=await Oa({libraryId:o,limit:200}),te=await Promise.all(Ce.items.map(C=>Cs({libraryId:o,collectionId:C.collectionId}).catch(()=>[])));if(le)return;T(te.reduce((C,Ie)=>C+Ie.length,0))}catch{le||T(0)}})(),()=>{le=!0}},[o]),a.useEffect(()=>{let le=!1;return(async()=>{try{const[Ce,te,C]=await Promise.all([Hn({libraryId:o,type:"computed",limit:1}).catch(()=>({total:0})),Hn({libraryId:o,type:"source",limit:1}).catch(()=>({total:0})),Kn({libraryId:o}).catch(()=>({items:[]}))]);if(le)return;m((Ce.total??0)+(te.total??0));const Ie=new Set(C.items.filter(O=>O.childItemType.toLowerCase()==="info").map(O=>O.childItemId).filter(Boolean));ue(Ie.size)}catch{le||(m(0),ue(0))}})(),()=>{le=!0}},[o]);const ge=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:K},{key:"collections",label:t.cogita.library.overview.stats.collections,value:p},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:w},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:V},{key:"texts",label:t.cogita.library.overview.stats.texts,value:N}];return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:y})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:ge.map(le=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${d===le.key?"active":""}`,onClick:()=>v(le.key),children:[e.jsx("span",{children:le.label}),e.jsx("strong",{children:le.value})]},le.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),d==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(Xn,{slices:[{label:t.cogita.library.overview.known,value:Y,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:F,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:z,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(Xn,{slices:[{label:t.cogita.library.overview.availableChecks,value:u,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:I,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const Xe=(t,n)=>{const s=t.cogita.library.infoTypes,i=t.cogita.library.connectionTypes,r=t.cogita.library.groupTypes;return{any:s.any,vocab:s.vocab,book:r.book,citation:r.citation,language:s.language,word:s.word,sentence:s.sentence,topic:s.topic,collection:s.collection,person:s.person,institution:s.institution,collective:s.collective,orcid:s.orcid,address:s.address,email:s.email,phone:s.phone,media:s.media,work:s.work,geo:s.geo,music_piece:s.musicPiece,music_fragment:s.musicFragment,source:s.source,computed:s.computed,"word-language":i.wordLanguage,"citation-language":i.citationLanguage,"language-sentence":i.languageSentence,translation:i.translation,"word-topic":i.wordTopic,reference:i.reference,"source-resource":i.sourceResource,"work-contributor":i.workContributor,"work-medium":i.workMedium,"orcid-link":i.orcidLink}[n]??String(n)},Ai=t=>[{value:"any",label:Xe(t,"any")},{value:"language",label:Xe(t,"language")},{value:"word",label:Xe(t,"word")},{value:"sentence",label:Xe(t,"sentence")},{value:"topic",label:Xe(t,"topic")},{value:"collection",label:Xe(t,"collection")},{value:"person",label:Xe(t,"person")},{value:"institution",label:Xe(t,"institution")},{value:"collective",label:Xe(t,"collective")},{value:"orcid",label:Xe(t,"orcid")},{value:"address",label:Xe(t,"address")},{value:"email",label:Xe(t,"email")},{value:"phone",label:Xe(t,"phone")},{value:"media",label:Xe(t,"media")},{value:"work",label:Xe(t,"work")},{value:"geo",label:Xe(t,"geo")},{value:"music_piece",label:Xe(t,"music_piece")},{value:"music_fragment",label:Xe(t,"music_fragment")},{value:"source",label:Xe(t,"source")},{value:"citation",label:Xe(t,"citation")},{value:"computed",label:Xe(t,"computed")},{value:"vocab",label:Xe(t,"vocab")},{value:"book",label:Xe(t,"book")},{value:"word-language",label:Xe(t,"word-language")},{value:"citation-language",label:Xe(t,"citation-language")},{value:"language-sentence",label:Xe(t,"language-sentence")},{value:"translation",label:Xe(t,"translation")},{value:"word-topic",label:Xe(t,"word-topic")},{value:"reference",label:Xe(t,"reference")},{value:"source-resource",label:Xe(t,"source-resource")},{value:"work-contributor",label:Xe(t,"work-contributor")},{value:"work-medium",label:Xe(t,"work-medium")},{value:"orcid-link",label:Xe(t,"orcid-link")}],Ei=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],fn={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},Pi={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[fn]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[fn]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId"]},filterFields:[fn,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text"],connections:[{relationType:"citation-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"citationText",kind:"text",path:"text",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},Zn={infoType:"default",entityKind:"single",structure:{payloadFields:["label"]},filterFields:[]};function Ki(t){return t?Pi[t]??Zn:Zn}function Fi(t,n){return t.optionsSource==="languages"?n.languages.map(s=>({value:s.infoId,label:s.label})):t.optionsSource==="sourceKinds"?Ei:[]}const Di="cogita.revision.seed:";function Ks(t){return`${Di}${t}`}function zi(t,n){if(typeof window>"u")return null;const s=Array.from(new Set(n.map(h=>h.trim()).filter(Boolean)));if(!s.length)return null;const i=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,r={kind:"info-selection",libraryId:t,infoIds:s,createdAt:new Date().toISOString()};return window.localStorage.setItem(Ks(i),JSON.stringify(r)),i}function es(t,n){if(typeof window>"u")return null;const s=window.localStorage.getItem(Ks(n));if(!s)return null;try{const i=JSON.parse(s);if(i.kind!=="info-selection"||i.libraryId!==t||!Array.isArray(i.infoIds))return null;const r=i.infoIds.map(h=>String(h??"").trim()).filter(Boolean);return r.length?{infoIds:r}:null}catch{return null}}const Bi="cogita.collection-draft:";function Fs(t){return`${Bi}${t}`}function _i(t,n){if(typeof window>"u")return null;const s=Array.from(new Set(n.map(h=>h.trim()).filter(Boolean)));if(!s.length)return null;const i=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,r={kind:"info-selection",libraryId:t,infoIds:s,createdAt:new Date().toISOString()};return window.localStorage.setItem(Fs(i),JSON.stringify(r)),i}function Vi(t,n){if(typeof window>"u")return null;const s=window.localStorage.getItem(Fs(n));if(!s)return null;try{const i=JSON.parse(s);if(i.kind!=="info-selection"||i.libraryId!==t||!Array.isArray(i.infoIds))return null;const r=i.infoIds.map(h=>String(h??"").trim()).filter(Boolean);return r.length?{infoIds:r}:null}catch{return null}}const bn=60,Oi=500;function Ds(t){return`cogita.info-selection:${t}`}function ts(t){if(typeof window>"u")return{};const n=window.localStorage.getItem(Ds(t));if(!n)return{};try{const s=JSON.parse(n);return!s||typeof s!="object"?{}:s}catch{return{}}}function Ui({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,libraryId:o,mode:y}){var x;const l=Rn(),d=Ea(),v=t.cogita.library.list,[w,T]=a.useState("any"),[z,m]=a.useState(""),[u,ue]=a.useState("relevance"),[K,p]=a.useState("details"),[V,N]=a.useState(!1),[Y,F]=a.useState("idle"),[I,ge]=a.useState([]),[le,xe]=a.useState(bn),[Ce,te]=a.useState(null),[C,Ie]=a.useState(()=>ts(o)),[O,ae]=a.useState({}),[H,ye]=a.useState([]),[_,ce]=a.useState(null),[ve,Pe]=a.useState(null),[qe,Me]=a.useState(null),[Oe,Ye]=a.useState("idle"),[Le,He]=a.useState([]),[at,it]=a.useState(""),[Be,Ne]=a.useState(null),[W,$e]=a.useState("idle"),[oe,U]=a.useState(null),[fe,Je]=a.useState(null),[E,R]=a.useState("idle"),[Z,re]=a.useState([]),[S,J]=a.useState("idle"),P=a.useMemo(()=>Ai(t),[t]),G=a.useMemo(()=>[{value:"relevance",label:v.sortRelevance},{value:"label_asc",label:v.sortLabelAsc},{value:"label_desc",label:v.sortLabelDesc},{value:"type_asc",label:v.sortTypeAsc},{value:"type_desc",label:v.sortTypeDesc}],[v.sortLabelAsc,v.sortLabelDesc,v.sortRelevance,v.sortTypeAsc,v.sortTypeDesc]);a.useEffect(()=>{Ie(ts(o)),ae({}),N(!1)},[o]),a.useEffect(()=>{Kn({libraryId:o}).then(f=>Me(f)).catch(()=>Me({items:[]}))},[o]),a.useEffect(()=>{Ys({libraryId:o}).then(f=>He(f)).catch(()=>He([]))},[o]),a.useEffect(()=>{Wn({libraryId:o,type:"language",filters:{sourceKind:"info"},limit:200}).then(f=>{const Q=f.map(M=>({infoId:M.infoId??"",infoType:M.entityType,label:M.title})).filter(M=>M.infoId.length>0);ye(Q)}).catch(()=>ye([]))},[o]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(Ds(o),JSON.stringify(C))},[o,C]);const ne=a.useMemo(()=>Ki(w==="any"?null:w),[w]),Se=a.useMemo(()=>new URLSearchParams(d.search),[d.search]),Re=a.useMemo(()=>d.pathname.split("/").filter(Boolean),[d.pathname]),De=Re.findIndex(f=>f==="infos"),ke=De>=0&&(Re[De+1]??"").trim()||null,he=De>=0?(Re[De+2]??"").trim():"",de=De>=0?he==="checkcards"?"cards":he==="collections"?"collections":"overview":"",ze=ke??((Se.get("infoId")??"").trim()||null),_e=ke?de:(Se.get("infoView")??"overview").trim(),nt=_e==="overview"&&!!ze,dt=_e==="collections"&&!!ze,vt=a.useMemo(()=>({language:v.typeFilterLanguage,languageA:v.typeFilterLanguageA,languageB:v.typeFilterLanguageB,originalLanguage:v.typeFilterOriginalLanguage,doi:v.typeFilterDoi,sourceKind:v.typeFilterSourceKind,locator:v.typeFilterLocator,citationText:v.typeFilterCitationText}),[v.typeFilterDoi,v.typeFilterLanguage,v.typeFilterLanguageA,v.typeFilterLanguageB,v.typeFilterLocator,v.typeFilterOriginalLanguage,v.typeFilterCitationText,v.typeFilterSourceKind]),We=a.useMemo(()=>ne.filterFields.map(f=>({...f,label:f.labelKey?vt[f.labelKey]:f.label??f.key,options:Fi(f,{languages:H})})),[vt,H,ne.filterFields]),ot=a.useMemo(()=>We.some(f=>(O[f.key]??"").trim().length>0),[We,O]);a.useEffect(()=>{ae({})},[w]),a.useEffect(()=>{const f={sourceKind:"info"};if(ot)for(const M of We){const Ge=(O[M.key]??"").trim();Ge&&(f[M.path??M.key]=Ge)}F("loading");const Q=window.setTimeout(()=>{Wn({libraryId:o,type:w==="any"?void 0:w,query:z.trim()||void 0,filters:f,limit:Oi}).then(M=>{const Ge=M.map(Qe=>({infoId:Qe.infoId??"",infoType:Qe.entityType,label:Qe.title})).filter(Qe=>Qe.infoId.length>0);ge(Ge),F("ready")}).catch(()=>{ge([]),F("ready")})},240);return()=>window.clearTimeout(Q)},[ot,o,z,w,We,O]),a.useEffect(()=>{if(!ze||_e!=="overview"&&_e!=="collections"){ce(null),Pe(null),Ye("idle");return}let f=!1;return Ye("loading"),Promise.all([aa({libraryId:o,infoId:ze}),Qs({libraryId:o,itemType:"info",itemId:ze}).catch(()=>null)]).then(([Q,M])=>{f||(ce(Q),Pe(M),Ye("ready"))}).catch(()=>{f||(ce(null),Pe(null),Ye("error"))}),()=>{f=!0}},[o,ze,_e]),a.useEffect(()=>{if(!ze||_e!=="collections"){re([]),J("idle");return}let f=!1;return J("loading"),Xs({libraryId:o,infoId:ze}).then(Q=>{f||(re(Q),J("ready"))}).catch(()=>{f||(re([]),J("error"))}),()=>{f=!0}},[o,ze,_e]),a.useEffect(()=>{if(!ze||_e!=="overview"){U(null),Je(null),R("idle");return}let f=!1;return R("loading"),Promise.all([Ua({libraryId:o,infoId:ze}),qa({libraryId:o,infoId:ze})]).then(([Q,M])=>{f||(U(Q),Je(M),R("ready"))}).catch(()=>{f||(U(null),Je(null),R("error"))}),()=>{f=!0}},[o,ze,_e]);const bt=a.useMemo(()=>_?Le.filter(f=>f.sourceInfoTypes.some(Q=>Q.toLowerCase()===_.infoType.toLowerCase())):[],[Le,_]);a.useEffect(()=>{if(!_){it("");return}it(f=>{var Q;return f&&bt.some(M=>M.approachKey===f)?f:((Q=bt[0])==null?void 0:Q.approachKey)??""})},[bt,_]),a.useEffect(()=>{if(!_||!at){Ne(null),$e("idle");return}let f=!1;return $e("loading"),Is({libraryId:o,infoId:_.infoId,approachKey:at}).then(Q=>{f||(Ne(Q),$e("ready"))}).catch(()=>{f||(Ne(null),$e("error"))}),()=>{f=!0}},[o,at,_]);const wt=a.useMemo(()=>{const f=I.slice(),Q=M=>Xe(t,M);return u==="relevance"?f:u==="label_asc"?f.sort((M,Ge)=>M.label.localeCompare(Ge.label)):u==="label_desc"?f.sort((M,Ge)=>Ge.label.localeCompare(M.label)):u==="type_asc"?f.sort((M,Ge)=>M.infoType===Ge.infoType?M.label.localeCompare(Ge.label):Q(M.infoType).localeCompare(Q(Ge.infoType))):f.sort((M,Ge)=>M.infoType===Ge.infoType?M.label.localeCompare(Ge.label):Q(Ge.infoType).localeCompare(Q(M.infoType)))},[t,I,u]),gt=a.useMemo(()=>wt.slice(0,le),[wt,le]),$t=gt.length<wt.length,Et=a.useMemo(()=>new Set(Object.keys(C)),[C]),Ct=a.useMemo(()=>Object.values(C),[C]),ft=a.useMemo(()=>{const f=new Map;for(const Q of Ct)f.set(Q.infoType,(f.get(Q.infoType)??0)+1);return Array.from(f.entries()).sort((Q,M)=>M[1]-Q[1]||Q[0].localeCompare(M[0]))},[Ct]),ia=a.useMemo(()=>{if(!ze||!qe)return 0;const f=new Set;for(const Q of qe.items)Q.childItemType!=="info"||Q.childItemId!==ze||f.add([Q.parentItemType,Q.parentItemId,Q.parentCheckType??"",Q.parentDirection??""].join("|"));return f.size},[qe,ze]);a.useEffect(()=>{xe(bn);const f=new Set(I.map(Q=>Q.infoId));te(Q=>Q&&f.has(Q)?Q:null)},[I]);const et=f=>{Ie(Q=>({...Q,[f.infoId]:{infoId:f.infoId,infoType:f.infoType,label:f.label}}))},Tt=f=>{Ie(Q=>{if(!Q[f])return Q;const M={...Q};return delete M[f],M})},Dt=(f,Q)=>{if(Q){et(f);return}Tt(f.infoId)},mt=f=>{l(`/cogita/library/${o}/infos/${encodeURIComponent(f)}`,{replace:!0})},Ze=()=>{l(`/cogita/library/${o}/list`,{replace:!0})},ht=()=>{ze&&l(`/cogita/library/${o}/edit/${encodeURIComponent(ze)}`,{replace:!0})},It=()=>{const f=zi(o,Ct.map(Q=>Q.infoId));f&&l(`/cogita/library/${o}/revision/run?libraryTarget=revisions&scope=info-selection&seed=${encodeURIComponent(f)}`)},Nt=()=>{const f=_i(o,Ct.map(Q=>Q.infoId));f&&l(`/cogita/library/${o}/collections/new?draft=${encodeURIComponent(f)}&draftType=info-selection`)},Ue=Ct.length===1?((x=Ct[0])==null?void 0:x.infoId)??null:null,ut=v.selectionCount.replace("{count}",String(Ct.length)),jt=y==="collection"?"grid":y==="detail"?"wide":K,st=Ji(j),ga=ve?Math.max(0,Math.min(100,Math.round((ve.score??0)*100))):0,je=ve?Hi(ve,st):st.noKnownnessData;return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":jt,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[nt?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:st.kicker}),e.jsx("h2",{className:"cogita-card-title",children:_?as(_.payload,_.infoType,_.infoId):st.loading}),_?e.jsxs("p",{className:"cogita-card-subtitle",children:[Xe(t,_.infoType)," · ",_.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:Ze,children:st.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:ht,disabled:!ze||Oe!=="ready",children:v.editInfo})]})]}),Oe==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:st.loading})}):Oe==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:st.loadError})}):_?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:st.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[ga,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${ga}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:je})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:st.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(ve==null?void 0:ve.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:st.correct.replace("{correct}",String((ve==null?void 0:ve.correctReviews)??0)).replace("{total}",String((ve==null?void 0:ve.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:ve!=null&&ve.lastReviewedUtc?`${st.lastReview}: ${qi(ve.lastReviewedUtc,j)}`:st.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:st.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:ia}),e.jsx("p",{className:"cogita-library-hint",children:st.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:st.checkcards}),E==="loading"?e.jsx("p",{className:"cogita-library-hint",children:st.loadingCheckcards}):E==="error"?e.jsx("p",{className:"cogita-library-hint",children:st.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:st.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(oe==null?void 0:oe.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:st.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(fe==null?void 0:fe.items.length)??0})]})]})]}),bt.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:st.approach}),e.jsx("select",{value:at,onChange:f=>it(f.target.value),"aria-label":st.approach,children:bt.map(f=>e.jsx("option",{value:f.approachKey,children:f.label},f.approachKey))})]}),W==="loading"?e.jsx("p",{className:"cogita-library-hint",children:st.loadingApproach}):W==="error"?e.jsx("p",{className:"cogita-library-hint",children:st.loadApproachError}):Be?e.jsx(Ha,{value:Be.projection,emptyLabel:st.empty}):e.jsx("p",{className:"cogita-library-hint",children:st.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:st.payload}),e.jsx(Ha,{value:_.payload,emptyLabel:st.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:st.links}),e.jsx(Wi,{links:_.links,emptyLabel:st.noLinks})]})]})]}):null]})}):null,dt?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Informacja"}),e.jsx("h2",{className:"cogita-card-title",children:_?as(_.payload,_.infoType,_.infoId):ze??""}),e.jsx("p",{className:"cogita-card-subtitle",children:"Collections using this info"})]}),e.jsx("div",{className:"cogita-info-overview-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:Ze,children:"Back to search"})})]}),S==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading collections..."})}):null,S==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load collections."})}):null,S==="ready"&&Z.length===0?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"This info is not used in any collection yet."})}):null,S==="ready"&&Z.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:Z.map(f=>e.jsx("article",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`/#/cogita/library/${o}/collections/${f.collectionId}?libraryTarget=collections`,children:[e.jsx("div",{className:"cogita-card-type",children:"Collection"}),e.jsx("h3",{className:"cogita-card-title",children:f.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[f.itemCount," items"]})]})},f.collectionId))}):null]})}):null,!nt&&!dt?e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":v.typeLabel,value:w,onChange:f=>T(f.target.value),children:P.map(f=>e.jsx("option",{value:f.value,children:f.label},f.value))}),e.jsx("input",{type:"text",value:z,onChange:f=>m(f.target.value),placeholder:v.searchPlaceholder}),e.jsx("select",{"aria-label":v.sortLabel,value:u,onChange:f=>ue(f.target.value),children:G.map(f=>e.jsx("option",{value:f.value,children:f.label},f.value))}),e.jsxs("select",{"aria-label":v.viewLabel,value:K,onChange:f=>p(f.target.value),children:[e.jsx("option",{value:"details",children:v.viewDetails}),e.jsx("option",{value:"wide",children:v.viewWide}),e.jsx("option",{value:"grid",children:v.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:v.cardCount.replace("{shown}",String(gt.length)).replace("{total}",String(wt.length))}),e.jsx("span",{children:Y==="loading"?v.loading:v.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>N(f=>!f),children:V?v.hideFilters:v.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:v.filtersOptionalHint})]}),V&&We.length>0?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsx("div",{className:"cogita-filter-grid",children:We.map(f=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:f.label}),f.kind==="select"?e.jsxs("select",{value:O[f.key]??"",onChange:Q=>ae(M=>({...M,[f.key]:Q.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(f.options??[]).map(Q=>e.jsx("option",{value:Q.value,children:Q.label},`${f.key}:${Q.value}`))]}):e.jsx("input",{type:"text",value:O[f.key]??"",onChange:Q=>ae(M=>({...M,[f.key]:Q.target.value}))})]},`type-filter:${f.key}`))})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:ut}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{Ie(f=>{const Q={...f};for(const M of gt)Q[M.infoId]={infoId:M.infoId,infoType:M.infoType,label:M.label};return Q})},disabled:gt.length===0,children:v.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ie({}),disabled:Ct.length===0,children:v.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ue&&mt(Ue),disabled:!Ue,title:Ue?void 0:v.openSelectedDisabled,children:v.openSelected})]})]}),jt==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":v.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:v.detailColumnName}),e.jsx("span",{children:v.detailColumnType}),e.jsx("span",{children:v.detailColumnId}),e.jsx("span",{})]}),gt.length?gt.map(f=>{const Q=Xe(t,f.infoType),M=Et.has(f.infoId),Ge=Ce===f.infoId;return e.jsxs("div",{className:`cogita-details-row ${Ge||M?"active":""}`,role:"row",onClick:()=>te(f.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:M,onChange:Qe=>Dt(f,Qe.target.checked),onClick:Qe=>Qe.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:f.label,children:f.label}),e.jsx("span",{title:Q,children:Q}),e.jsx("span",{title:f.infoId,children:f.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:Qe=>{Qe.stopPropagation(),mt(f.infoId)},"aria-label":v.editInfo,children:">"})]},f.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:v.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${jt}`,"data-view":jt,children:gt.length?gt.map(f=>{const Q=Xe(t,f.infoType),M=Et.has(f.infoId),Ge=Ce===f.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":Ge||M,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:M,onChange:Qe=>Dt(f,Qe.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>te(f.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:Q}),e.jsx("h3",{className:"cogita-card-title",children:f.label}),e.jsx("p",{className:"cogita-card-subtitle",children:f.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>mt(f.infoId),children:v.editInfo})]})},f.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:v.noMatch})})}),$t?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>xe(f=>f+bn),children:v.loadMore})}):null,Ct.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:v.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:v.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:ft.map(([f,Q])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:Xe(t,f)}),e.jsx("span",{className:"cogita-tag-count",children:Q})]},`stack:type:${f}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:It,disabled:Ct.length===0,children:"Start revision"}),e.jsx("button",{type:"button",className:"ghost",onClick:Nt,disabled:Ct.length===0,children:"Create collection from selection"})]})]}):null]}):null]})})})})}function as(t,n,s){if(t&&typeof t=="object"&&!Array.isArray(t)){const i=t,r=["title","name","label","value","text","quote","term"];for(const h of r){const g=i[h];if(typeof g=="string"&&g.trim())return g.trim()}}return`${n} · ${s}`}function qi(t,n){try{const s=n==="pl"?"pl-PL":n==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(s,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function Ji(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function Hi(t,n){return t.totalReviews<=0?n.noKnownnessData:t.totalReviews<3||t.score<.35?n.developmentStart:t.totalReviews<8||t.score<.65?n.developmentGrowing:t.score<.85?n.developmentStable:n.developmentStrong}function Wi({links:t,emptyLabel:n}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([s,i])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(i)?i.length?e.jsx("div",{className:"cogita-selection-overview",children:i.map(r=>e.jsx("span",{className:"cogita-tag-chip",children:r},`${s}:${r}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):i?e.jsx("span",{className:"cogita-tag-chip",children:i}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},s))})}function Ha({value:t,emptyLabel:n}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:n});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((s,i)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:i+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(Ha,{value:s,emptyLabel:n})})]},i))});if(typeof t=="object"){const s=Object.entries(t);return s.length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:s.map(([i,r])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:i}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(Ha,{value:r,emptyLabel:n})})]},i))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const ba=5,ns=50,ss=2,is=[];function qt({libraryId:t,infoType:n,label:s,placeholder:i,value:r,onChange:h,values:g,onChangeMultiple:k,helperText:j,searchFailedText:L,createFailedText:o,createLabel:y,savingLabel:l,loadMoreLabel:d,allowCreate:v=!0,inputRef:w,autoAdvance:T,onCommit:z,multiple:m}){const u=m?g??is:is,[ue,K]=a.useState(m?"":(r==null?void 0:r.label)??""),[p,V]=a.useState([]),[N,Y]=a.useState(ba),[F,I]=a.useState(-1),[ge,le]=a.useState(!1),[xe,Ce]=a.useState(!1),[te,C]=a.useState(null),Ie=a.useRef(0),O=a.useRef(new Map),ae=a.useMemo(()=>v?m?ue.trim().length>0:ue.trim().length>0&&!r:!1,[v,ue,r,m]);a.useEffect(()=>{m||K((r==null?void 0:r.label)??"")},[r,m]),a.useEffect(()=>{const _=ue.trim();if(!_||_.length<ss){V([]),le(!1),Y(ba),I(-1),Ce(!1),C(null);return}const ce=_.toLowerCase(),ve=`${t}:${n}:${ce}`,Pe=O.current.get(ve);if(Pe){if(m&&u.length>0){const Me=new Set(u.map(Oe=>Oe.id));V(Pe.filter(Oe=>!Me.has(Oe.id)))}else V(Pe);Y(ba),I(-1),le(Pe.length>0),Ce(!1),C(null);return}const qe=window.setTimeout(async()=>{const Me=Date.now();Ie.current=Me,Ce(!0),C(null);try{const Oe=await Fn({libraryId:t,type:n,query:_,limit:ns});if(Ie.current!==Me)return;const Ye=Oe.slice(0,ns).map(Le=>({id:Le.infoId,label:Le.label,infoType:Le.infoType}));if(O.current.set(ve,Ye),m&&u.length>0){const Le=new Set(u.map(He=>He.id));V(Ye.filter(He=>!Le.has(He.id)))}else V(Ye);Y(ba),I(-1),le(!0)}catch{if(Ie.current!==Me)return;C(L??"Search failed.")}finally{Ie.current===Me&&Ce(!1)}},250);return()=>window.clearTimeout(qe)},[t,n,ue,u]);const H=_=>{if(m){const ce=u.some(ve=>ve.id===_.id)?u:[...u,_];k==null||k(ce),K(""),le(!1),I(-1);return}h==null||h(_),K(_.label),le(!1),I(-1),T&&(z==null||z())},ye=async()=>{const _=ue.trim();if(_){Ce(!0),C(null);try{const ce=await Ln({libraryId:t,infoType:n,payload:{label:_}}),ve={id:ce.infoId,label:_,infoType:ce.infoType};if(_.length>=ss){const Pe=`${t}:${n}:${_.toLowerCase()}`,qe=O.current.get(Pe)??[];O.current.set(Pe,[ve,...qe])}if(m){k==null||k([...u,ve]),K(""),le(!1),I(-1);return}h==null||h(ve),le(!1),I(-1),T&&(z==null||z())}catch{C(o??"Create failed.")}finally{Ce(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:s}),e.jsx("input",{value:ue,placeholder:i,onChange:_=>{K(_.target.value),!m&&r&&(h==null||h(null))},onKeyDown:_=>{if(_.key==="ArrowDown"){if(_.preventDefault(),!p.length)return;le(!0),I(ce=>{const ve=Math.min(p.length,N)-1,Pe=ce<0?0:Math.min(ce+1,ve);return Pe===ve&&p.length>N?(Y(qe=>Math.min(qe+ba,p.length)),Math.min(ce+1,Math.min(p.length,N+ba)-1)):Pe});return}if(_.key==="ArrowUp"){if(_.preventDefault(),!p.length)return;le(!0),I(ce=>ce<=0?0:ce-1);return}if(_.key==="Enter"){if(_.preventDefault(),F>=0&&p[F]){H(p[F]);return}if(ae){ye();return}}},onFocus:()=>{p.length>0&&le(!0)},autoComplete:"off",ref:w})]}),m&&u.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:u.map(_=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>k==null?void 0:k(u.filter(ce=>ce.id!==_.id)),children:[_.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},_.id))}),j&&e.jsx("p",{className:"cogita-help",children:j}),te&&e.jsx("p",{className:"cogita-error",children:te}),ge&&p.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[p.slice(0,N).map((_,ce)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":ce===F,onClick:()=>H(_),children:[e.jsx("strong",{children:_.label}),e.jsx("span",{children:_.infoType})]},_.id)),N<p.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>Y(_=>Math.min(_+ba,p.length)),children:d??"Load more"})]}),ae&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:ye,disabled:xe,children:xe?l??"Saving...":y??`Create new ${n}`})]})}const rs=[{id:"gen",la:{abbr:"Gen",name:"Genesis"},en:{abbr:"Gen",name:"Genesis"},de:{abbr:"Gen",name:"Genesis"},pl:{abbr:"Rdz",name:"Księga Rodzaju"}},{id:"ex",la:{abbr:"Ex",name:"Exodus"},en:{abbr:"Ex",name:"Exodus"},de:{abbr:"Ex",name:"Exodus"},pl:{abbr:"Wj",name:"Księga Wyjścia"}},{id:"lev",la:{abbr:"Lev",name:"Leviticus"},en:{abbr:"Lev",name:"Leviticus"},de:{abbr:"Lev",name:"Levitikus"},pl:{abbr:"Kpł",name:"Księga Kapłańska"}},{id:"num",la:{abbr:"Num",name:"Numeri"},en:{abbr:"Num",name:"Numbers"},de:{abbr:"Num",name:"Numeri"},pl:{abbr:"Lb",name:"Księga Liczb"}},{id:"deut",la:{abbr:"Deut",name:"Deuteronomium"},en:{abbr:"Deut",name:"Deuteronomy"},de:{abbr:"Dtn",name:"Deuteronomium"},pl:{abbr:"Pwt",name:"Księga Powtórzonego Prawa"}},{id:"ios",la:{abbr:"Ios",name:"Iosue"},en:{abbr:"Josh",name:"Joshua"},de:{abbr:"Jos",name:"Josua"},pl:{abbr:"Joz",name:"Księga Jozuego"}},{id:"iudg",la:{abbr:"Iudg",name:"Iudicum"},en:{abbr:"Judg",name:"Judges"},de:{abbr:"Ri",name:"Richter"},pl:{abbr:"Sdz",name:"Księga Sędziów"}},{id:"ruth",la:{abbr:"Ruth",name:"Ruth"},en:{abbr:"Ruth",name:"Ruth"},de:{abbr:"Rut",name:"Rut"},pl:{abbr:"Rt",name:"Księga Rut"}},{id:"1sam",la:{abbr:"1 Sam",name:"I Samuelis"},en:{abbr:"1 Sam",name:"1 Samuel"},de:{abbr:"1 Sam",name:"1 Samuel"},pl:{abbr:"1 Sm",name:"1 Księga Samuela"}},{id:"2sam",la:{abbr:"2 Sam",name:"II Samuelis"},en:{abbr:"2 Sam",name:"2 Samuel"},de:{abbr:"2 Sam",name:"2 Samuel"},pl:{abbr:"2 Sm",name:"2 Księga Samuela"}},{id:"1reg",la:{abbr:"1 Reg",name:"I Regum"},en:{abbr:"1 Kgs",name:"1 Kings"},de:{abbr:"1 Kön",name:"1 Könige"},pl:{abbr:"1 Krl",name:"1 Księga Królewska"}},{id:"2reg",la:{abbr:"2 Reg",name:"II Regum"},en:{abbr:"2 Kgs",name:"2 Kings"},de:{abbr:"2 Kön",name:"2 Könige"},pl:{abbr:"2 Krl",name:"2 Księga Królewska"}},{id:"1par",la:{abbr:"1 Par",name:"I Paralipomenon"},en:{abbr:"1 Chr",name:"1 Chronicles"},de:{abbr:"1 Chr",name:"1 Chronik"},pl:{abbr:"1 Krn",name:"1 Księga Kronik"}},{id:"2par",la:{abbr:"2 Par",name:"II Paralipomenon"},en:{abbr:"2 Chr",name:"2 Chronicles"},de:{abbr:"2 Chr",name:"2 Chronik"},pl:{abbr:"2 Krn",name:"2 Księga Kronik"}},{id:"esd",la:{abbr:"Esd",name:"Esdrae"},en:{abbr:"Ezra",name:"Ezra"},de:{abbr:"Esra",name:"Esra"},pl:{abbr:"Ezd",name:"Księga Ezdrasza"}},{id:"neh",la:{abbr:"Neh",name:"Nehemiae"},en:{abbr:"Neh",name:"Nehemiah"},de:{abbr:"Neh",name:"Nehemia"},pl:{abbr:"Ne",name:"Księga Nehemiasza"}},{id:"tob",la:{abbr:"Tob",name:"Tobiae"},en:{abbr:"Tob",name:"Tobit"},de:{abbr:"Tob",name:"Tobit"},pl:{abbr:"Tb",name:"Księga Tobiasza"}},{id:"iudt",la:{abbr:"Iudt",name:"Iudith"},en:{abbr:"Jdt",name:"Judith"},de:{abbr:"Jdt",name:"Judit"},pl:{abbr:"Jdt",name:"Księga Judyty"}},{id:"est",la:{abbr:"Est",name:"Esther"},en:{abbr:"Est",name:"Esther"},de:{abbr:"Est",name:"Ester"},pl:{abbr:"Est",name:"Księga Estery"}},{id:"1macc",la:{abbr:"1 Macc",name:"I Maccabaeorum"},en:{abbr:"1 Mc",name:"1 Maccabees"},de:{abbr:"1 Makk",name:"1 Makkabäer"},pl:{abbr:"1 Mch",name:"1 Księga Machabejska"}},{id:"2macc",la:{abbr:"2 Macc",name:"II Maccabaeorum"},en:{abbr:"2 Mc",name:"2 Maccabees"},de:{abbr:"2 Makk",name:"2 Makkabäer"},pl:{abbr:"2 Mch",name:"2 Księga Machabejska"}},{id:"iob",la:{abbr:"Iob",name:"Iob"},en:{abbr:"Job",name:"Job"},de:{abbr:"Ijob",name:"Ijob"},pl:{abbr:"Hi",name:"Księga Hioba"}},{id:"ps",la:{abbr:"Ps",name:"Psalmi"},en:{abbr:"Ps",name:"Psalms"},de:{abbr:"Ps",name:"Psalmen"},pl:{abbr:"Ps",name:"Księga Psalmów"}},{id:"prov",la:{abbr:"Prov",name:"Proverbia"},en:{abbr:"Prov",name:"Proverbs"},de:{abbr:"Spr",name:"Sprichwörter"},pl:{abbr:"Prz",name:"Księga Przysłów"}},{id:"ecc",la:{abbr:"Ecc",name:"Ecclesiastes"},en:{abbr:"Eccl",name:"Ecclesiastes"},de:{abbr:"Koh",name:"Kohelet"},pl:{abbr:"Koh",name:"Księga Koheleta"}},{id:"cant",la:{abbr:"Cant",name:"Canticum Canticorum"},en:{abbr:"Song",name:"Song of Songs"},de:{abbr:"Hld",name:"Hoheslied"},pl:{abbr:"Pnp",name:"Pieśń nad Pieśniami"}},{id:"sap",la:{abbr:"Sap",name:"Sapientia"},en:{abbr:"Wis",name:"Wisdom"},de:{abbr:"Weish",name:"Weisheit"},pl:{abbr:"Mdr",name:"Księga Mądrości"}},{id:"sir",la:{abbr:"Sir",name:"Ecclesiasticus (Sirach)"},en:{abbr:"Sir",name:"Sirach"},de:{abbr:"Sir",name:"Jesus Sirach"},pl:{abbr:"Syr",name:"Mądrość Syracha"}},{id:"isa",la:{abbr:"Isa",name:"Isaias"},en:{abbr:"Isa",name:"Isaiah"},de:{abbr:"Jes",name:"Jesaja"},pl:{abbr:"Iz",name:"Księga Izajasza"}},{id:"ier",la:{abbr:"Ier",name:"Ieremias"},en:{abbr:"Jer",name:"Jeremiah"},de:{abbr:"Jer",name:"Jeremia"},pl:{abbr:"Jr",name:"Księga Jeremiasza"}},{id:"lam",la:{abbr:"Lam",name:"Lamentationes"},en:{abbr:"Lam",name:"Lamentations"},de:{abbr:"Klgl",name:"Klagelieder"},pl:{abbr:"Lm",name:"Lamentacje"}},{id:"bar",la:{abbr:"Bar",name:"Baruch"},en:{abbr:"Bar",name:"Baruch"},de:{abbr:"Bar",name:"Baruch"},pl:{abbr:"Ba",name:"Księga Barucha"}},{id:"ez",la:{abbr:"Ez",name:"Ezechiel"},en:{abbr:"Ezek",name:"Ezekiel"},de:{abbr:"Ez",name:"Ezechiel"},pl:{abbr:"Ez",name:"Księga Ezechiela"}},{id:"dan",la:{abbr:"Dan",name:"Daniel"},en:{abbr:"Dan",name:"Daniel"},de:{abbr:"Dan",name:"Daniel"},pl:{abbr:"Dn",name:"Księga Daniela"}},{id:"hos",la:{abbr:"Hos",name:"Osee"},en:{abbr:"Hos",name:"Hosea"},de:{abbr:"Hos",name:"Hosea"},pl:{abbr:"Oz",name:"Księga Ozeasza"}},{id:"ioel",la:{abbr:"Ioel",name:"Ioel"},en:{abbr:"Joel",name:"Joel"},de:{abbr:"Joel",name:"Joel"},pl:{abbr:"Jl",name:"Księga Joela"}},{id:"amos",la:{abbr:"Amos",name:"Amos"},en:{abbr:"Am",name:"Amos"},de:{abbr:"Am",name:"Amos"},pl:{abbr:"Am",name:"Księga Amosa"}},{id:"abd",la:{abbr:"Abd",name:"Abdias"},en:{abbr:"Obad",name:"Obadiah"},de:{abbr:"Obd",name:"Obadja"},pl:{abbr:"Abd",name:"Księga Abdiasza"}},{id:"ion",la:{abbr:"Ion",name:"Ionas"},en:{abbr:"Jon",name:"Jonah"},de:{abbr:"Jona",name:"Jona"},pl:{abbr:"Jon",name:"Księga Jonasza"}},{id:"mich",la:{abbr:"Mich",name:"Michaeas"},en:{abbr:"Mic",name:"Micah"},de:{abbr:"Mi",name:"Micha"},pl:{abbr:"Mi",name:"Księga Micheasza"}},{id:"nah",la:{abbr:"Nah",name:"Nahum"},en:{abbr:"Nah",name:"Nahum"},de:{abbr:"Nah",name:"Nahum"},pl:{abbr:"Na",name:"Księga Nahuma"}},{id:"hab",la:{abbr:"Hab",name:"Habacuc"},en:{abbr:"Hab",name:"Habakkuk"},de:{abbr:"Hab",name:"Habakuk"},pl:{abbr:"Ha",name:"Księga Habakuka"}},{id:"soph",la:{abbr:"Soph",name:"Sophonias"},en:{abbr:"Zeph",name:"Zephaniah"},de:{abbr:"Zef",name:"Zefanja"},pl:{abbr:"So",name:"Księga Sofoniasza"}},{id:"agg",la:{abbr:"Agg",name:"Aggaeus"},en:{abbr:"Hag",name:"Haggai"},de:{abbr:"Hag",name:"Haggai"},pl:{abbr:"Ag",name:"Księga Aggeusza"}},{id:"zach",la:{abbr:"Zach",name:"Zacharias"},en:{abbr:"Zech",name:"Zechariah"},de:{abbr:"Sach",name:"Sacharja"},pl:{abbr:"Za",name:"Księga Zachariasza"}},{id:"mal",la:{abbr:"Mal",name:"Malachias"},en:{abbr:"Mal",name:"Malachi"},de:{abbr:"Mal",name:"Maleachi"},pl:{abbr:"Ml",name:"Księga Malachiasza"}},{id:"mt",la:{abbr:"Mt",name:"Matthaeus"},en:{abbr:"Matt",name:"Matthew"},de:{abbr:"Mt",name:"Matthäus"},pl:{abbr:"Mt",name:"Ewangelia wg św. Mateusza"}},{id:"mc",la:{abbr:"Mc",name:"Marcus"},en:{abbr:"Mark",name:"Mark"},de:{abbr:"Mk",name:"Markus"},pl:{abbr:"Mk",name:"Ewangelia wg św. Marka"}},{id:"lc",la:{abbr:"Lc",name:"Lucas"},en:{abbr:"Luke",name:"Luke"},de:{abbr:"Lk",name:"Lukas"},pl:{abbr:"Łk",name:"Ewangelia wg św. Łukasza"}},{id:"io",la:{abbr:"Io",name:"Ioannes"},en:{abbr:"John",name:"John"},de:{abbr:"Joh",name:"Johannes"},pl:{abbr:"J",name:"Ewangelia wg św. Jana"}},{id:"act",la:{abbr:"Act",name:"Actus Apostolorum"},en:{abbr:"Acts",name:"Acts"},de:{abbr:"Apg",name:"Apostelgeschichte"},pl:{abbr:"Dz",name:"Dzieje Apostolskie"}},{id:"rom",la:{abbr:"Rom",name:"ad Romanos"},en:{abbr:"Rom",name:"Romans"},de:{abbr:"Röm",name:"Römer"},pl:{abbr:"Rz",name:"List do Rzymian"}},{id:"1cor",la:{abbr:"1 Cor",name:"I ad Corinthios"},en:{abbr:"1 Cor",name:"1 Corinthians"},de:{abbr:"1 Kor",name:"1 Korinther"},pl:{abbr:"1 Kor",name:"1 List do Koryntian"}},{id:"2cor",la:{abbr:"2 Cor",name:"II ad Corinthios"},en:{abbr:"2 Cor",name:"2 Corinthians"},de:{abbr:"2 Kor",name:"2 Korinther"},pl:{abbr:"2 Kor",name:"2 List do Koryntian"}},{id:"gal",la:{abbr:"Gal",name:"ad Galatas"},en:{abbr:"Gal",name:"Galatians"},de:{abbr:"Gal",name:"Galater"},pl:{abbr:"Ga",name:"List do Galatów"}},{id:"eph",la:{abbr:"Eph",name:"ad Ephesios"},en:{abbr:"Eph",name:"Ephesians"},de:{abbr:"Eph",name:"Epheser"},pl:{abbr:"Ef",name:"List do Efezjan"}},{id:"phil",la:{abbr:"Phil",name:"ad Philippenses"},en:{abbr:"Phil",name:"Philippians"},de:{abbr:"Phil",name:"Philipper"},pl:{abbr:"Flp",name:"List do Filipian"}},{id:"col",la:{abbr:"Col",name:"ad Colossenses"},en:{abbr:"Col",name:"Colossians"},de:{abbr:"Kol",name:"Kolosser"},pl:{abbr:"Kol",name:"List do Kolosan"}},{id:"1thess",la:{abbr:"1 Thess",name:"I ad Thessalonicenses"},en:{abbr:"1 Thess",name:"1 Thessalonians"},de:{abbr:"1 Thess",name:"1 Thessalonicher"},pl:{abbr:"1 Tes",name:"1 List do Tesaloniczan"}},{id:"2thess",la:{abbr:"2 Thess",name:"II ad Thessalonicenses"},en:{abbr:"2 Thess",name:"2 Thessalonians"},de:{abbr:"2 Thess",name:"2 Thessalonicher"},pl:{abbr:"2 Tes",name:"2 List do Tesaloniczan"}},{id:"1tim",la:{abbr:"1 Tim",name:"I ad Timotheum"},en:{abbr:"1 Tim",name:"1 Timothy"},de:{abbr:"1 Tim",name:"1 Timotheus"},pl:{abbr:"1 Tm",name:"1 List do Tymoteusza"}},{id:"2tim",la:{abbr:"2 Tim",name:"II ad Timotheum"},en:{abbr:"2 Tim",name:"2 Timothy"},de:{abbr:"2 Tim",name:"2 Timotheus"},pl:{abbr:"2 Tm",name:"2 List do Tymoteusza"}},{id:"tit",la:{abbr:"Tit",name:"ad Titum"},en:{abbr:"Titus",name:"Titus"},de:{abbr:"Tit",name:"Titus"},pl:{abbr:"Tt",name:"List do Tytusa"}},{id:"phlm",la:{abbr:"Phlm",name:"ad Philemonem"},en:{abbr:"Phlm",name:"Philemon"},de:{abbr:"Phlm",name:"Philemon"},pl:{abbr:"Flm",name:"List do Filemona"}},{id:"heb",la:{abbr:"Heb",name:"ad Hebraeos"},en:{abbr:"Heb",name:"Hebrews"},de:{abbr:"Hebr",name:"Hebräer"},pl:{abbr:"Hbr",name:"List do Hebrajczyków"}},{id:"iac",la:{abbr:"Iac",name:"Iacobi"},en:{abbr:"Jas",name:"James"},de:{abbr:"Jak",name:"Jakobus"},pl:{abbr:"Jk",name:"List św. Jakuba"}},{id:"1pet",la:{abbr:"1 Pet",name:"I Petri"},en:{abbr:"1 Pet",name:"1 Peter"},de:{abbr:"1 Petr",name:"1 Petrus"},pl:{abbr:"1 P",name:"1 List św. Piotra"}},{id:"2pet",la:{abbr:"2 Pet",name:"II Petri"},en:{abbr:"2 Pet",name:"2 Peter"},de:{abbr:"2 Petr",name:"2 Petrus"},pl:{abbr:"2 P",name:"2 List św. Piotra"}},{id:"1io",la:{abbr:"1 Io",name:"I Ioannis"},en:{abbr:"1 John",name:"1 John"},de:{abbr:"1 Joh",name:"1 Johannes"},pl:{abbr:"1 J",name:"1 List św. Jana"}},{id:"2io",la:{abbr:"2 Io",name:"II Ioannis"},en:{abbr:"2 John",name:"2 John"},de:{abbr:"2 Joh",name:"2 Johannes"},pl:{abbr:"2 J",name:"2 List św. Jana"}},{id:"3io",la:{abbr:"3 Io",name:"III Ioannis"},en:{abbr:"3 John",name:"3 John"},de:{abbr:"3 Joh",name:"3 Johannes"},pl:{abbr:"3 J",name:"3 List św. Jana"}},{id:"iud",la:{abbr:"Iud",name:"Iudae"},en:{abbr:"Jude",name:"Jude"},de:{abbr:"Jud",name:"Judas"},pl:{abbr:"Jud",name:"List św. Judy"}},{id:"apoc",la:{abbr:"Apoc",name:"Apocalypsis Ioannis"},en:{abbr:"Rev",name:"Revelation"},de:{abbr:"Offb",name:"Offenbarung"},pl:{abbr:"Ap",name:"Apokalipsa św. Jana"}}],os=8;function ls({libraryId:t,copy:n,language:s,sourceKindOptions:i,value:r,onChange:h,labels:g}){const[k,j]=a.useState(!1),[L,o]=a.useState(-1),y=a.useMemo(()=>{const w=s;return rs.map(T=>{var u;const z=(T==null?void 0:T[w])??(T==null?void 0:T.en)??(T==null?void 0:T.la);return{label:`${z.abbr} — ${z.name}`,latin:((u=T==null?void 0:T.la)==null?void 0:u.abbr)??z.abbr}})},[s]),l=(w,T=!1)=>{const z=w.trim().toLowerCase();return z?y.filter(m=>m.label.toLowerCase().includes(z)).slice(0,os):T?y.slice(0,os):[]},d=(w,T)=>{const z=w.trim().toLowerCase();if(!z)return null;const m=rs;for(const u of m){const ue=u==null?void 0:u.la,K=(u==null?void 0:u[T])??(u==null?void 0:u.en)??ue,p=(K==null?void 0:K.abbr)??"",V=(K==null?void 0:K.name)??"";if(p.toLowerCase()===z||V.toLowerCase()===z||`${p} — ${V}`.toLowerCase()===z)return{book:u,entry:K,la:ue}}return null};a.useEffect(()=>{if(r.sourceKind==="bible"&&r.locatorValue&&!k){const w=d(r.locatorValue,s);if(w){const T=`${w.entry.abbr} — ${w.entry.name}`;T!==r.bibleBookDisplay&&h({...r,bibleBookDisplay:T})}}},[s,r,k,h]);const v=w=>h({...r,...w});return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:g.sourceKindLabel}),e.jsx("select",{value:r.sourceKind,onChange:w=>v({sourceKind:w.target.value,churchDocument:null,bookMedia:null,work:null,locatorValue:"",locatorAux:"",bibleBookDisplay:""}),children:i.map(w=>e.jsx("option",{value:w.value,children:w.label},w.value))})]}),r.sourceKind==="bible"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-lookup full",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:g.bibleBookLabel}),e.jsx("input",{type:"text",value:r.bibleBookDisplay,onChange:w=>{const T=w.target.value;v({bibleBookDisplay:T,locatorValue:""}),j(!0),o(-1)},onKeyDown:w=>{var z;const T=l(r.bibleBookDisplay);if(T.length){if(w.key==="ArrowDown")w.preventDefault(),o(m=>Math.min(m+1,T.length-1));else if(w.key==="ArrowUp")w.preventDefault(),o(m=>Math.max(m-1,0));else if((w.key==="Enter"||w.key==="Tab")&&L>=0&&T[L]){const m=T[L],u=d(m.label,s);if(!u)return;v({bibleBookDisplay:m.label,locatorValue:((z=u.la)==null?void 0:z.abbr)??r.locatorValue}),j(!1)}}},onFocus:()=>j(!0),onBlur:()=>window.setTimeout(()=>j(!1),100),placeholder:g.bibleBookPlaceholder})]}),k&&l(r.bibleBookDisplay,!0).length>0&&e.jsx("div",{className:"cogita-lookup-results",children:l(r.bibleBookDisplay,!0).map((w,T)=>e.jsx("button",{type:"button",className:"cogita-lookup-option","data-active":T===L,tabIndex:-1,onMouseDown:()=>{var m;const z=d(w.label,s);z&&v({bibleBookDisplay:w.label,locatorValue:((m=z.la)==null?void 0:m.abbr)??r.locatorValue})},children:e.jsx("strong",{children:w.label})},w.latin))})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:g.bibleRestLabel}),e.jsx("input",{type:"text",value:r.locatorAux,onChange:w=>v({locatorAux:w.target.value}),placeholder:g.bibleRestPlaceholder})]})]}),r.sourceKind==="website"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceUrlLabel}),e.jsx("input",{type:"text",value:r.sourceUrl,onChange:w=>v({sourceUrl:w.target.value}),placeholder:n.cogita.library.add.info.sourceUrlPlaceholder})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceAccessedDateLabel}),e.jsx("input",{type:"text",value:r.sourceAccessedDate,onChange:w=>v({sourceAccessedDate:w.target.value}),placeholder:n.cogita.library.add.info.sourceAccessedDatePlaceholder})]})]}),r.sourceKind==="number_document"&&e.jsxs(e.Fragment,{children:[e.jsx(qt,{libraryId:t,infoType:"work",label:g.churchDocumentLabel,placeholder:g.churchDocumentPlaceholder,value:r.churchDocument,onChange:w=>v({churchDocument:w}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:g.locatorLabel}),e.jsx("input",{type:"text",value:r.locatorValue,onChange:w=>v({locatorValue:w.target.value}),placeholder:g.locatorPlaceholder})]})]}),r.sourceKind==="work"&&e.jsx(qt,{libraryId:t,infoType:"work",label:g.workLabel,placeholder:g.workPlaceholder,value:r.work,onChange:w=>v({work:w}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),r.sourceKind==="book"&&e.jsxs(e.Fragment,{children:[e.jsx(qt,{libraryId:t,infoType:"media",label:g.bookLabel,placeholder:g.bookPlaceholder,value:r.bookMedia,onChange:w=>v({bookMedia:w}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.media),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:g.locatorLabel}),e.jsx("input",{type:"text",value:r.locatorValue,onChange:w=>v({locatorValue:w.target.value}),placeholder:g.locatorPlaceholder})]})]}),r.sourceKind!=="website"&&r.sourceKind!=="bible"&&r.sourceKind!=="book"&&r.sourceKind!=="number_document"&&e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:g.locatorLabel}),e.jsx("input",{type:"text",value:r.locatorValue,onChange:w=>v({locatorValue:w.target.value}),placeholder:g.locatorPlaceholder})]})]})}const cs=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}];function $a(){return{sourceKind:"string",locatorValue:"",locatorAux:"",bibleBookDisplay:"",sourceUrl:"",sourceAccessedDate:"",churchDocument:null,bookMedia:null,work:null}}function ds(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function us(t,n){if(!t||typeof t!="object")return n;const s=t,i=[s.label,s.name,s.title,s.text,s.orcid,s.email,s.number];for(const r of i)if(typeof r=="string"&&r.trim())return r.trim();return n}function hs(t,n){var i;if(!(t instanceof Ms))return n;const s=(i=t.message)==null?void 0:i.trim();if(!s)return n;try{const r=JSON.parse(s);if(typeof r.error=="string"&&r.error.trim())return r.error.trim()}catch{}return s}function Gi(t){const n=t.trim();if(!n)return null;try{const s=JSON.parse(n);return s&&typeof s=="object"&&!Array.isArray(s)?s:null}catch{return null}}function Xt(t,n){const s=t==null?void 0:t[n];return typeof s=="string"?s:""}function Yi(t,n){return n?t==="book"&&n.infoType==="media"?{bookMedia:n}:t==="work"&&n.infoType==="work"?{work:n}:t==="number_document"&&n.infoType==="work"?{churchDocument:n}:{}:{}}function Qi(t,n){const s=$a(),i=(t.sourceKind??"").trim()||s.sourceKind,r=t.locator??"",h=Gi(r);let g="",k="",j="",L="",o="";return i==="website"?(L=Xt(h,"url"),o=Xt(h,"accessedDate"),g=Xt(h,"value")):i==="bible"?(g=Xt(h,"book")||r.trim(),k=Xt(h,"passage")||Xt(h,"rest"),j=Xt(h,"bookDisplay")):h?(g=Xt(h,"value")||Xt(h,"locator"),k=Xt(h,"aux")):g=r,{...s,sourceKind:i,locatorValue:g,locatorAux:k,bibleBookDisplay:j,sourceUrl:L,sourceAccessedDate:o,...Yi(i,n)}}function yn(t){return t.sourceKind==="book"?t.bookMedia:t.sourceKind==="work"?t.work:t.sourceKind==="number_document"?t.churchDocument:null}function xn(t){const n=t.locatorValue.trim(),s=t.locatorAux.trim(),i=t.sourceUrl.trim(),r=t.sourceAccessedDate.trim();switch(t.sourceKind){case"website":return{url:i,accessedDate:r};case"bible":return{book:n,bookDisplay:t.bibleBookDisplay.trim(),passage:s};case"book":case"work":case"number_document":return s?{value:n,aux:s}:n;default:return s?{value:n,aux:s}:n}}function gs(t){var r,h,g;const n=t.locatorValue.trim(),s=t.locatorAux.trim(),i=[n,s].filter(Boolean).join(" ");switch(t.sourceKind){case"website":return t.sourceUrl.trim()||"website";case"bible":return i||"bible";case"book":return[(r=t.bookMedia)==null?void 0:r.label,i].filter(Boolean).join(" · ")||"book";case"work":return[(h=t.work)==null?void 0:h.label,i].filter(Boolean).join(" · ")||"work";case"number_document":return[(g=t.churchDocument)==null?void 0:g.label,i].filter(Boolean).join(" · ")||"number_document";default:return i||t.sourceKind||"source"}}function ms(t){return t.sourceKind.trim()?t.sourceKind==="website"?!!t.sourceUrl.trim():t.sourceKind==="bible"?!!(t.locatorValue.trim()&&t.locatorAux.trim()):t.sourceKind==="book"?!!t.bookMedia:t.sourceKind==="work"?!!t.work:t.sourceKind==="number_document"?!!(t.churchDocument&&t.locatorValue.trim()):!!t.locatorValue.trim():!1}function Xi({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,libraryId:o,editInfoId:y}){var it,Be,Ne;const{libraryName:l}=na(o),d=!!y,[v,w]=a.useState([]),[T,z]=a.useState("word"),[m,u]=a.useState({}),[ue,K]=a.useState({}),[p,V]=a.useState({}),[N,Y]=a.useState({}),[F,I]=a.useState(null),[ge,le]=a.useState("idle"),[xe,Ce]=a.useState($a),[te,C]=a.useState({}),[Ie,O]=a.useState({}),[ae,H]=a.useState({}),[ye,_]=a.useState(null),ce=a.useMemo(()=>v.find(W=>W.infoType===T),[T,v]),ve=a.useMemo(()=>v.find(W=>W.infoType==="source"),[v]),Pe=a.useMemo(()=>v.map(W=>({value:W.infoType,label:Xe(t,W.infoType)})),[t,v]);a.useEffect(()=>{let W=!1;return Zs({libraryId:o}).then($e=>{var oe;if(!W&&(w($e),!d)){const U=(oe=$e[0])==null?void 0:oe.infoType;U&&z(U)}}).catch(()=>{W||w([])}),()=>{W=!0}},[d,o]),a.useEffect(()=>{if(d||!ce)return;const W={},$e={},oe={},U={};for(const fe of ce.payloadFields)W[fe.key]="";for(const fe of ce.linkFields)fe.multiple?oe[fe.key]=[]:$e[fe.key]=null,fe.targetTypes.length>0&&(U[fe.key]=fe.targetTypes[0]);u(W),K($e),V(oe),Y(U)},[ce==null?void 0:ce.infoType,d]),a.useEffect(()=>{if(!d||!y||v.length===0)return;let W=!1;return le("loading"),I(null),(async()=>{const oe=await aa({libraryId:o,infoId:y});if(W)return;const U=oe.infoType;z(U);const fe=v.find(P=>P.infoType===U);if(!fe){le("idle");return}const Je=oe.payload??{},E={};for(const P of fe.payloadFields)E[P.key]=ds(Je[P.key]);u(E);const R=oe.links??{}??{},Z={},re={},S={},J=[];for(const P of fe.linkFields){P.targetTypes.length>0&&(S[P.key]=P.targetTypes[0]);const G=R[P.key];if(P.multiple){const ne=Array.isArray(G)?G.filter(Se=>typeof Se=="string"):[];re[P.key]=[];for(const Se of ne)J.push(aa({libraryId:o,infoId:Se}).then(Re=>{if(W)return;const De={id:Se,infoType:Re.infoType,label:us(Re.payload,Se)};S[P.key]=De.infoType,re[P.key]=[...re[P.key],De]}).catch(()=>{}))}else{const ne=typeof G=="string"?G:null;Z[P.key]=null,ne&&J.push(aa({libraryId:o,infoId:ne}).then(Se=>{if(W)return;const Re={id:ne,infoType:Se.infoType,label:us(Se.payload,ne)};S[P.key]=Re.infoType,Z[P.key]=Re}).catch(()=>{}))}}await Promise.all(J),!W&&(K(Z),V(re),Y(S),le("idle"))})().catch(()=>{W||(I("Failed to load info details."),le("idle"))}),()=>{W=!0}},[y,d,o,v]),a.useEffect(()=>{T==="source"&&Ce(Qi(m,ue.resource??null))},[T,m.sourceKind,m.locator,(it=ue.resource)==null?void 0:it.id,(Be=ue.resource)==null?void 0:Be.infoType,(Ne=ue.resource)==null?void 0:Ne.label]);const qe=W=>{var fe,Je;const $e=((fe=ve==null?void 0:ve.payloadFields.find(E=>E.key==="sourceKind"))==null?void 0:fe.keepOnCreate)??!1,oe=((Je=ve==null?void 0:ve.linkFields.find(E=>E.key==="resource"))==null?void 0:Je.keepOnCreate)??!1,U=$a();return U.sourceKind=$e?W.sourceKind:U.sourceKind,oe&&(U.work=W.work,U.bookMedia=W.bookMedia,U.churchDocument=W.churchDocument),$e&&W.sourceKind==="bible"&&(U.locatorValue=W.locatorValue,U.bibleBookDisplay=W.bibleBookDisplay),$e&&W.sourceKind==="website"&&(U.sourceUrl=W.sourceUrl,U.sourceAccessedDate=W.sourceAccessedDate),U},Me=a.useMemo(()=>({sourceKindLabel:t.cogita.library.add.info.sourceKindLabel,bibleBookLabel:t.cogita.library.add.info.sourceBibleBookLabel,bibleBookPlaceholder:t.cogita.library.add.info.sourceBibleBookPlaceholder,bibleRestLabel:t.cogita.library.add.info.sourceBibleRestLabel,bibleRestPlaceholder:t.cogita.library.add.info.sourceBibleRestPlaceholder,churchDocumentLabel:t.cogita.library.add.info.sourceResourceLabel,churchDocumentPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,workLabel:t.cogita.library.add.info.sourceResourceLabel,workPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,bookLabel:t.cogita.library.add.info.sourceResourceLabel,bookPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,locatorLabel:t.cogita.library.list.typeFilterLocator,locatorPlaceholder:t.cogita.library.list.typeFilterLocator}),[t]),Oe=async W=>{const $e=Ie[W]??$a();if(!ms($e)){H(oe=>({...oe,[W]:t.cogita.library.add.info.referenceMissingSource}));return}_(W),H(oe=>({...oe,[W]:null}));try{const oe=yn($e),U=oe?{resource:oe.id}:{},fe={label:gs($e),sourceKind:$e.sourceKind.trim(),locator:xn($e)},E={id:(await Ln({libraryId:o,infoType:"source",payload:fe,links:U})).infoId,infoType:"source",label:fe.label};if(V(R=>{const Z=R[W]??[];return Z.some(re=>re.id===E.id)?R:{...R,[W]:[...Z,E]}}),d&&y){const R=await aa({libraryId:o,infoId:y}),Z=R.links&&typeof R.links=="object"?{...R.links}:{},re=Z[W],S=Array.isArray(re)?re.filter(J=>typeof J=="string"):typeof re=="string"?[re]:[];S.includes(E.id)||(Z[W]=[...S,E.id],await Gn({libraryId:o,infoId:y,payload:R.payload,links:Z}))}O(R=>({...R,[W]:qe($e)})),H(R=>({...R,[W]:null}))}catch(oe){H(U=>({...U,[W]:hs(oe,t.cogita.library.lookup.createFailed)}))}finally{_(oe=>oe===W?null:oe)}},Ye=async()=>{var oe;if(!ce)return;const W={};for(const U of ce.payloadFields){if(T==="source"&&(U.key==="sourceKind"||U.key==="locator"))continue;const fe=(m[U.key]??"").trim();if(!fe){if(U.required){I(`Field '${U.label}' is required.`);return}continue}if(U.inputType==="json")try{W[U.key]=JSON.parse(fe)}catch{I(`Field '${U.label}' must be valid JSON.`);return}else W[U.key]=fe}const $e={};for(const U of ce.linkFields)if(!(T==="source"&&U.key==="resource"))if(U.multiple){const fe=(p[U.key]??[]).map(Je=>Je.id);if(U.required&&fe.length===0){I(`Link '${U.label}' is required.`);return}fe.length>0&&($e[U.key]=fe)}else{const fe=((oe=ue[U.key])==null?void 0:oe.id)??null;if(U.required&&!fe){I(`Link '${U.label}' is required.`);return}fe&&($e[U.key]=fe)}if(T==="source"){if(!ms(xe)){I(t.cogita.library.add.info.referenceMissingSource);return}const U=xe.sourceKind.trim();W.sourceKind=U,W.locator=xn(xe),(typeof W.label!="string"||!W.label.trim())&&(W.label=gs(xe));const fe=yn(xe);fe&&($e.resource=fe.id)}le("saving"),I(null);try{if(d&&y)await Gn({libraryId:o,infoId:y,payload:W,links:$e}),I("Info updated.");else{await Ln({libraryId:o,infoType:T,payload:W,links:$e}),I("Info saved.");const U={};for(const E of ce.payloadFields)U[E.key]=E.keepOnCreate?m[E.key]??"":"";u(U);const fe={},Je={};for(const E of ce.linkFields)E.multiple?Je[E.key]=E.keepOnCreate?p[E.key]??[]:[]:fe[E.key]=E.keepOnCreate?ue[E.key]??null:null;K(E=>({...E,...fe})),V(E=>({...E,...Je})),T==="source"&&Ce(E=>{const R=qe(E),Z=yn(R);return u(re=>({...re,sourceKind:R.sourceKind,locator:ds(xn(R))})),K(re=>({...re,resource:Z})),Z&&Y(re=>({...re,resource:Z.infoType})),R})}}catch(U){I(hs(U,"Failed to save info."))}finally{le("idle")}},Le=W=>{const $e=m[W.key]??"",oe=W.inputType==="textarea"||W.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:W.label}),oe?e.jsx("textarea",{rows:W.inputType==="json"?8:4,value:$e,onChange:U=>u(fe=>({...fe,[W.key]:U.target.value})),placeholder:W.key}):e.jsx("input",{type:"text",value:$e,onChange:U=>u(fe=>({...fe,[W.key]:U.target.value})),placeholder:W.key})]},`payload:${W.key}`)},He=W=>{const $e=N[W.key]??W.targetTypes[0],oe=W.key==="references"&&W.multiple&&W.targetTypes.includes("source"),U=Ie[W.key]??$a(),fe=te[W.key]??!1,Je=ae[W.key];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:W.label}),W.targetTypes.length>1?e.jsx("select",{value:$e,onChange:E=>Y(R=>({...R,[W.key]:E.target.value})),children:W.targetTypes.map(E=>e.jsx("option",{value:E,children:Xe(t,E)},`${W.key}:${E}`))}):null,W.multiple?e.jsx(qt,{libraryId:o,infoType:$e,label:W.label,placeholder:W.key,multiple:!0,values:p[W.key]??[],onChangeMultiple:E=>V(R=>({...R,[W.key]:E})),allowCreate:!oe,searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(qt,{libraryId:o,infoType:$e,label:W.label,placeholder:W.key,value:ue[W.key]??null,onChange:E=>K(R=>({...R,[W.key]:E})),searchFailedText:"Search failed",createFailedText:"Create failed"}),oe?e.jsxs("div",{children:[e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:fe,onChange:E=>C(R=>({...R,[W.key]:E.target.checked}))}),e.jsx("span",{children:t.cogita.library.add.info.referenceToggle})]}),fe?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(ls,{libraryId:o,copy:t,language:j,sourceKindOptions:[...cs],value:U,onChange:E=>O(R=>({...R,[W.key]:E})),labels:Me}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>Oe(W.key),disabled:ye===W.key,children:ye===W.key?t.cogita.library.lookup.saving:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.source)})}),Je?e.jsx("p",{className:"cogita-library-subtitle",children:Je}):null]}):null]}):null]},`link:${W.key}`)},at=()=>e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(ls,{libraryId:o,copy:t,language:j,sourceKindOptions:[...cs],value:xe,onChange:Ce,labels:Me})]});return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:d?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${o}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[d?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:T,onChange:W=>z(W.target.value),children:Pe.map(W=>e.jsx("option",{value:W.value,children:W.label},W.value))})]}),ge==="loading"&&d?e.jsx("p",{children:"Loading..."}):null,ce&&!(ge==="loading"&&d)?e.jsxs("div",{className:"cogita-form-grid",children:[ce.payloadFields.filter(W=>!(T==="source"&&(W.key==="sourceKind"||W.key==="locator"))).map(Le),T==="source"?at():null,ce.linkFields.filter(W=>!(T==="source"&&W.key==="resource")).map(He)]}):ge==="loading"&&d?null:e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:Ye,disabled:ge==="saving"||!ce,children:ge==="saving"?"Saving...":d?"Update info":"Create info"})}),F?e.jsx("p",{className:"cogita-library-subtitle",children:F}):null]})})})]})})}const ps=t=>/\s/.test(t),Wa=t=>/[\p{L}\p{N}]/u.test(t),fs=(t,n)=>{const s=n>0?t[n-1]:"",i=n<t.length?t[n]:"";if(!s||!i)return 0;const r=ps(s),h=ps(i);if(r||h)return 3;const g=Wa(s),k=Wa(i);return g!==k?2:!g&&!k?1:0},vn=(t,n,s,i,r)=>{const h=Math.max(i-n,s-i);for(let g=0;g<=h;g+=1){const k=i-g;if(k>=n&&k<=s&&fs(t,k)>=r)return k;const j=i+g;if(j>=n&&j<=s&&fs(t,j)>=r)return j}return null},wn=(t,n)=>{const s=n>0?t[n-1]:"",i=n<t.length?t[n]:"";return!s||!i?!0:Wa(s)!==Wa(i)},Zi=(t,n,s,i)=>{const r=s-n,h=n+i,g=s-i;if(r<=i*2||g<=h)return null;const k=Math.floor((n+s)/2),j=vn(t,h,g,k,3);if(j!==null&&wn(t,j))return j;const L=vn(t,h,g,k,2);if(L!==null&&wn(t,L))return L;const o=vn(t,h,g,k,1);return o!==null&&wn(t,o)?o:null},ya=(t,n)=>{const s=Math.max(1,7),i=Math.max(s,13),r={},h=(j,L,o,y,l)=>{const d=String(y),v={id:d,start:j,end:L,text:t.slice(j,L),depth:o,index:y,parentId:l};if(r[d]=v,L-j>i){let T=Zi(t,j,L,s);if(T!==null&&T>j&&T<L){const z=h(j,T,o+1,y*2+1,d),m=h(T,L,o+1,y*2+2,d);v.leftId=z.id,v.rightId=m.id}}return v},g=h(0,t.length,0,0),k=Object.values(r).sort((j,L)=>L.depth-j.depth||j.start-L.start).map(j=>j.id);return{text:t,rootId:g.id,nodes:r,order:k}},Ta=(t,n,s,i,r,h,g)=>{const k=h==="reverse"?t.order.slice().sort((j,L)=>t.nodes[L].start-t.nodes[j].start||t.nodes[L].depth-t.nodes[j].depth):t.order;for(const j of k){if(g&&j===g||n.has(j))continue;const L=t.nodes[j];if(L){if(r&&(L.leftId||L.rightId)){const o=L.leftId?s[L.leftId]??0:i,y=L.rightId?s[L.rightId]??0:i;if((o+y)/2<i)continue}return L}}return null},Dn=(t,n)=>({before:t.slice(0,n.start),fragment:t.slice(n.start,n.end),after:t.slice(n.end)});function er({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,libraryId:o}){const y=`/#/cogita/library/${o}`,[l,d,v]=An([]),[w,T,z]=En([]),[m,u]=a.useState(null),[ue,K]=a.useState(null),[p,V]=a.useState(null),[N,Y]=a.useState(null),F=a.useMemo(()=>l.find(C=>C.id===m)??null,[l,m]);a.useEffect(()=>{let C=!0;return ei({libraryId:o}).then(Ie=>{if(!C)return;const O=Ie.nodes.map(ae=>{var H,ye,_;return{id:ae.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:ae.payload&&typeof ae.payload=="object"&&"label"in ae.payload?String(ae.payload.label):"Item",nodeType:ae.nodeType,itemType:((H=ae.payload)==null?void 0:H.itemType)??"info",itemId:((ye=ae.payload)==null?void 0:ye.itemId)??null,infoType:((_=ae.payload)==null?void 0:_.infoType)??null}}});d(O),T(Ie.edges.map(ae=>({id:ae.edgeId,source:ae.fromNodeId,target:ae.toNodeId})))}).catch(()=>{C&&(d([]),T([]))}),()=>{C=!1}},[o]),a.useEffect(()=>{ti({libraryId:o}).then(K).catch(()=>K(null))},[o,l,w]);const I=a.useCallback(C=>{T(Ie=>Pn(C,Ie))},[]),ge=()=>{const C=crypto.randomUUID();d(Ie=>[...Ie,{id:C,type:"default",position:{x:140+Ie.length*40,y:120+Ie.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},le=()=>{const C=crypto.randomUUID();d(Ie=>[...Ie,{id:C,type:"default",position:{x:180+Ie.length*40,y:160+Ie.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},xe=async()=>{V(null);try{const C=l.map(O=>({nodeId:O.id,nodeType:O.data.nodeType,payload:{itemType:O.data.itemType,itemId:O.data.itemId??null,label:O.data.label,infoType:O.data.infoType??null}})),Ie=w.map(O=>({edgeId:O.id,fromNodeId:O.source,toNodeId:O.target}));await ai({libraryId:o,nodes:C,edges:Ie}),V(t.cogita.library.graph.saveSuccess)}catch{V(t.cogita.library.graph.saveFail)}},Ce=C=>{F&&d(Ie=>Ie.map(O=>O.id===F.id?{...O,data:{...O.data,itemId:(C==null?void 0:C.infoId)??null,itemType:"collection",infoType:"collection",label:(C==null?void 0:C.label)??t.cogita.library.infoTypes.collection}}:O))},te=C=>{F&&d(Ie=>Ie.map(O=>O.id===F.id?{...O,data:{...O.data,itemId:(C==null?void 0:C.infoId)??null,itemType:"info",infoType:(C==null?void 0:C.infoType)??null,label:(C==null?void 0:C.label)??t.cogita.library.infoTypes.any}}:O))};return a.useEffect(()=>{if(!F||F.data.nodeType!=="info"||F.data.infoType!=="citation"||!F.data.itemId){Y(null);return}let C=!0;return aa({libraryId:o,infoId:F.data.itemId}).then(Ie=>{if(!C)return;const O=Ie.payload,ae=(O==null?void 0:O.text)??"";if(!ae){Y(null);return}const H=ya(ae),ye=Object.values(H.nodes).sort((_,ce)=>_.depth-ce.depth||_.start-ce.start).map(_=>({id:_.id,text:_.text,depth:_.depth}));Y({title:(O==null?void 0:O.title)??F.data.label,fragments:ye})}).catch(()=>Y(null)),()=>{C=!1}},[o,F]),e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:y,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:xe,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ge,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:le,children:t.cogita.library.actions.addInfo}),ue?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(ue.totalCollections))})}):null,p?e.jsx("p",{className:"cogita-help",children:p}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(nn,{nodes:l,edges:w,onNodesChange:v,onEdgesChange:z,onConnect:I,onNodeClick:(C,Ie)=>u(Ie.id),fitView:!0,children:[e.jsx(sn,{gap:18,size:1}),e.jsx(rn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),F?e.jsxs("div",{className:"cogita-graph-inspector",children:[F.data.nodeType==="collection"?e.jsx(qt,{libraryId:o,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:F.data.itemId?{id:F.data.itemId,label:F.data.label,infoType:"collection"}:null,onChange:Ce,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(qt,{libraryId:o,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:F.data.itemId?{id:F.data.itemId,label:F.data.label,infoType:F.data.infoType??void 0}:null,onChange:te,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),N?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:N.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:N.fragments.map(C=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:C.id}),e.jsx("span",{children:C.text})]},C.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function zn({children:t,flashState:n,flashTick:s=0,feedbackToken:i,className:r}){const h=i??(n?`${n}-${s}`:"idle");return e.jsx("section",{className:r?`cogita-revision-card ${r}`:"cogita-revision-card","data-feedback":h,children:t})}function Bn({copy:t,currentCard:n,currentTypeLabel:s,prompt:i,languages:r,answer:h,onAnswerChange:g,computedExpected:k,computedAnswers:j,onComputedAnswerChange:L,answerTemplate:o,outputVariables:y,variableValues:l,computedFieldFeedback:d,feedback:v,canAdvance:w,quoteContext:T,quotePlaceholder:z,onCheckAnswer:m,onSkip:u,onLanguageSelect:ue,onMarkReviewed:K,onAdvance:p,showCorrectAnswer:V,setShowCorrectAnswer:N,onRevealCorrect:Y,answerMask:F,expectedAnswer:I,hasExpectedAnswer:ge,handleComputedKeyDown:le,answerInputRef:xe,computedInputRefs:Ce,scriptMode:te,setScriptMode:C,matchPairs:Ie,matchLeftOrder:O,matchRightOrder:ae,matchSelection:H,matchActiveLeft:ye,matchActiveRight:_,matchFeedback:ce,onMatchLeftSelect:ve,onMatchRightSelect:Pe,disableCheckAnswer:qe=!1,hideSkipAction:Me=!1,allowRevealBeforeCheck:Oe=!1,autoRevealAfterAnswer:Ye=!1,disableCheckAfterAnswer:Le=!1}){const He=a.useMemo(()=>{var De;const E=!o&&k.length===2?`The {${k[0].key}} is of type {${k[1].key}}`:null,R=o??E;if(!R)return null;const Z=new Map(k.map(ke=>[ke.key,ke.expected])),re=new Set,S=[],J=/\{([^}]+)\}/g;let P=0,G,ne=null;for(;(G=J.exec(R))!==null;){const ke=R.slice(P,G.index);ke&&S.push({type:"text",value:ke});const he=((De=G[1])==null?void 0:De.trim())??"",de=he&&Z.has(he)?he:he&&y&&y[he]?y[he]:null;he&&re.add(he),de&&re.add(de),de&&Z.has(de)?(S.push({type:"input",value:de}),ne||(ne=de)):he&&l&&l[he]!==void 0?S.push({type:"text",value:l[he]}):S.push({type:"text",value:G[0]}),P=G.index+G[0].length}const Se=R.slice(P);return Se&&S.push({type:"text",value:Se}),k.filter(ke=>!re.has(ke.key)).length>0?null:{parts:S,expectedByKey:Z,firstInputKey:ne}},[o,k,y,l]),at=()=>{if(!He)return null;const{parts:E,expectedByKey:R,firstInputKey:Z}=He;return e.jsx("div",{className:"cogita-revision-inline-answer",children:E.map((re,S)=>{var J,P;return re.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:re.value},`text-${S}`):e.jsx("input",{ref:G=>{Ce.current[re.value]=G},autoFocus:re.value===Z,value:j[re.value]??"",onChange:G=>L(re.value,G.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":d[re.value]??(v==="correct"?"correct":v==="incorrect"?"incorrect":void 0),onKeyDown:G=>W(G)||le(G),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((J=j[re.value])==null?void 0:J.length)??0,((P=R.get(re.value))==null?void 0:P.length)??6)}ch`}},`input-${re.value}-${S}`)})})},it=a.useMemo(()=>{const E=new Map;return(Ie??[]).forEach(R=>E.set(R.leftId,R)),E},[Ie]),Be=a.useMemo(()=>{const E=new Map;return(Ie??[]).forEach(R=>E.set(R.rightId,R)),E},[Ie]);a.useEffect(()=>{var S;if(n.cardType!=="info"||n.infoType!=="computed"||k.length===0)return;const E=typeof document<"u"?document.activeElement:null;if(E&&(E.tagName==="INPUT"||E.tagName==="TEXTAREA"))return;const R=(He==null?void 0:He.firstInputKey)??((S=k[0])==null?void 0:S.key);if(!R)return;const Z=Ce.current[R];if(!Z)return;const re=requestAnimationFrame(()=>{Z.focus()});return()=>cancelAnimationFrame(re)},[n,k,He]);const Ne=(()=>{const E=[I??"",...k.map(re=>re.expected??"")].join(""),R=[h,...Object.values(j)].join(""),Z=`${E}${R}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(Z)})(),W=E=>E.ctrlKey&&(E.key==="^"||E.key==="6")?(E.preventDefault(),C(R=>R==="super"?null:"super"),!0):E.ctrlKey&&(E.key==="_"||E.key==="-")?(E.preventDefault(),C(R=>R==="sub"?null:"sub"),!0):!1,$e=()=>{if(!I||!F)return I??"";const E=I.split(""),R=Array.from(F),Z=R.length>0?R.reduce((re,S)=>re+S,0)/R.length:127;return E.map((re,S)=>{const J=R[S]??Z,P=Math.max(0,Math.min(255,Math.round(J)));let G=255,ne=0;return P<=127?ne=Math.round(P/127*255):(ne=255,G=Math.round(255*(1-(P-127)/128))),e.jsx("span",{style:{color:`rgb(${G}, ${ne}, 0)`},children:re},`mask-${S}`)})},oe=n.cardType==="info"&&n.infoType==="citation"?(T==null?void 0:T.title)||n.label:n.description,U=V||Ye&&v!==null,fe=qe||Le&&(v!==null||U),Je=ge&&(Oe||v==="incorrect"||U);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[s?e.jsx("span",{children:s}):null,e.jsx("strong",{children:oe})]}),n.cardType==="vocab"&&n.checkType==="translation-match"&&Ie?e.jsxs("div",{className:"cogita-revision-body",children:[i?e.jsx("h2",{children:i}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(O??[]).map(E=>{const R=it.get(E);if(!R)return null;const Z=(H==null?void 0:H[E])??null,re=(ce==null?void 0:ce[E])??null,S=ye===E;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":S,"data-state":re??void 0,"data-locked":Z?"true":void 0,onClick:()=>ve==null?void 0:ve(E),children:[e.jsx("span",{children:R.leftLabel}),Z&&V?e.jsx("em",{children:"✓"}):null]},E)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(ae??[]).map(E=>{const R=Be.get(E);if(!R)return null;const Z=Object.values(H??{}).includes(E),re=_===E;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":Z||re,"data-locked":Z?"true":void 0,onClick:()=>Pe==null?void 0:Pe(E),children:e.jsx("span",{children:R.rightLabel})},E)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:m,disabled:n.checkType==="translation-match"||fe,children:t.cogita.library.revision.checkAnswer}),Me?null:e.jsx("button",{type:"button",className:"ghost",onClick:u,children:t.cogita.library.revision.skip})]})]}):n.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:xe,value:h,onChange:E=>g(E.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:E=>{if(E.key==="Enter")if(E.preventDefault(),E.stopPropagation(),w)p();else{if(fe)return;m()}}})]}),Ne?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":te==="super",onClick:()=>C(E=>E==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":te==="sub",onClick:()=>C(E=>E==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:m,disabled:fe,children:t.cogita.library.revision.checkAnswer}),Me?null:e.jsx("button",{type:"button",className:"ghost",onClick:u,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[n.label?e.jsx("p",{className:"cogita-revision-hint",children:n.label}):null,o?null:e.jsx(ni,{value:i??"",mode:"auto"}),k.length>0?(()=>{const E=at();return E?e.jsx("div",{className:"cogita-inline-answer-wrap",children:E}):e.jsx("div",{className:"cogita-form-grid",children:k.map((R,Z)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:R.key}),e.jsx("textarea",{ref:re=>{Ce.current[R.key]=re},autoFocus:Z===0,value:j[R.key]??"",onChange:re=>L(R.key,re.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":d[R.key]??(v==="correct"?"correct":v==="incorrect"?"incorrect":void 0),onKeyDown:re=>W(re)||le(re)})]},R.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:xe,value:h,onChange:E=>g(E.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:E=>{if(!W(E)&&E.key==="Enter")if(E.preventDefault(),E.stopPropagation(),w)p();else{if(fe)return;m()}}})]})}),Ne?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":te==="super",onClick:()=>C(E=>E==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":te==="sub",onClick:()=>C(E=>E==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:m,disabled:fe,children:t.cogita.library.revision.checkAnswer}),Me?null:e.jsx("button",{type:"button",className:"ghost",onClick:u,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="citation"&&T?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(T.completed)).replace("{total}",String(T.total))}),e.jsx("p",{className:"cogita-quote-text",children:T.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:xe,value:h,onChange:E=>g(E.target.value),placeholder:z??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:E=>{if(E.key==="Enter")if(E.preventDefault(),E.stopPropagation(),w)p();else{if(fe)return;m()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:T.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:m,disabled:fe,children:t.cogita.library.revision.checkAnswer}),Me?null:e.jsx("button",{type:"button",className:"ghost",onClick:u,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:r.length?r.map(E=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>ue(E.label),children:E.label},E.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:u,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:K,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:u,children:t.cogita.library.revision.skip})]})]}),v&&e.jsx("div",{className:"cogita-revision-feedback","data-state":v,children:v==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),Je?e.jsxs("div",{className:"cogita-revision-reveal",children:[U?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>N(E=>{const R=!E;return R&&Y(),R}),children:t.cogita.library.revision.showAnswer}),U?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),k.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[k.map(E=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:E.key}),e.jsx("span",{children:E.expected})]},E.key)),I?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:I})]}):null]}):e.jsx("p",{children:F?$e():I})]}):null]}):null,w?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:p,children:t.cogita.library.revision.nextQuestion})}):null]})}const bs={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},tr=(t,n)=>{const s=Math.max(t.length,n.length,1),i=Math.abs(t.length-n.length);return Math.max(0,1-i/s)},ar=(t,n)=>{const s=new Uint8Array(t.length),i=tr(t,n);for(let r=0;r<t.length;r+=1){const h=t[r]===(n[r]??"")?128:0,g=t.length-1-r,k=n.length-1-r,j=t[g]===(n[k]??"")?127:0,L=Math.round((h+j)*i);s[r]=Math.max(0,Math.min(255,L))}return s},nr=(t,n)=>t===n||(bs[t]??[]).includes(n)?!0:(bs[n]??[]).includes(t),Ba=(t,n,s)=>s?nr(t,n):t===n,Ga=(t,n,s)=>{const i=new Uint8Array(t.length);if(!t.length)return i;const r=(s==null?void 0:s.allowSimilarChars)??!0,h=[];for(let k=0;k<=t.length-3;k+=1)h.push({index:k,text:t.slice(k,k+3)});let g=!1;return h.forEach(k=>{for(let j=0;j<=n.length-3;j+=1){const L=n.slice(j,j+3);let o=0;for(let w=0;w<3;w+=1)Ba(k.text[w],L[w],r)&&(o+=1);if(o<2)continue;let y=k.index-1,l=j-1;for(;y>=0&&l>=0;){const w=t[y],T=n[l];if(w===T){i[y]=Math.max(i[y],255),y-=1,l-=1,g=!0;continue}if(Ba(w,T,r)&&w!==T){i[y]=Math.max(i[y],127),y-=1,l-=1,g=!0;continue}if(y>0&&t[y-1]===T){i[y]=Math.max(i[y],0),y-=1,g=!0;continue}if(l>0&&t[y]===n[l-1]){l-=1,g=!0;continue}break}for(let w=0;w<3;w+=1){const T=k.index+w,z=k.text[w],m=L[w],u=z===m?255:Ba(z,m,r)?127:0;i[T]=Math.max(i[T],u),g=!0}let d=k.index+3,v=j+3;for(;d<t.length&&v<n.length;){const w=t[d],T=n[v];if(w===T){i[d]=Math.max(i[d],255),d+=1,v+=1,g=!0;continue}if(Ba(w,T,r)&&w!==T){i[d]=Math.max(i[d],127),d+=1,v+=1,g=!0;continue}if(d+1<t.length&&t[d+1]===T){i[d]=Math.max(i[d],0),d+=1,g=!0;continue}if(v+1<n.length&&t[d]===n[v+1]){v+=1,g=!0;continue}break}}}),g?i:ar(t,n)},jn=t=>/[\p{L}\p{N}]/u.test(t),ys=t=>t.trim().toLowerCase(),ha=(t,n)=>{if(t.length===0)return 100;const s=(n==null?void 0:n.treatSimilarCharsAsSame)??!1,i=Array.from(t).reduce((r,h)=>s&&h===127?r+255:r+h,0);return Math.round(i/(t.length*255)*100)},Ya=(t,n,s)=>{const i=Math.max(0,Math.min(100,(s==null?void 0:s.thresholdPercent)??100)),r=(s==null?void 0:s.treatSimilarCharsAsSame)??!0,h=(s==null?void 0:s.ignorePunctuationAndSpacing)??!1,g=ys(t),k=ys(n);if(!h){const m=Ga(g,k,{allowSimilarChars:r}),u=ha(m,{treatSimilarCharsAsSame:r});return{mask:m,percent:u,isCorrect:u>=i,normalizedExpected:g,normalizedAnswer:k}}const j=Array.from(g),L=Array.from(k),o=[],y=[],l=[];j.forEach((m,u)=>{jn(m)&&(o.push(m),y.push(u))}),L.forEach(m=>{jn(m)&&l.push(m)});const d=o.join(""),v=l.join(""),w=Ga(d,v,{allowSimilarChars:r}),T=new Uint8Array(j.length);for(let m=0;m<T.length;m+=1)T[m]=jn(j[m]??"")?0:255;for(let m=0;m<w.length;m+=1){const u=y[m];u!==void 0&&(T[u]=w[m])}const z=ha(w,{treatSimilarCharsAsSame:r});return{mask:T,percent:z,isCorrect:z>=i,normalizedExpected:d,normalizedAnswer:v}},Ca=(t,n,s)=>{const i=t.trim().toLowerCase(),r=n.trim().toLowerCase();return s==="prefix"||s==="bidirectional"?Ga(i,r,{allowSimilarChars:!0}):Ga(i,r,{allowSimilarChars:!0})};function Zt(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function xs(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function vs(t){const n=t.checkType??"info";return t.direction?`${n} / ${t.direction}`:n}function sr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,libraryId:o,infoId:y,selectedReviewerRoleId:l}){const[d,v]=a.useState(y),[w,T]=a.useState([]),[z,m]=a.useState([]),[u,ue]=a.useState("loading"),[K,p]=a.useState(null),[V,N]=a.useState(null),[Y,F]=a.useState(null),[I,ge]=a.useState(null),[le,xe]=a.useState(""),[Ce,te]=a.useState(null),[C,Ie]=a.useState(1),[O,ae]=a.useState(null),[H,ye]=a.useState(0),[_,ce]=a.useState(!1),[ve,Pe]=a.useState(null),[qe,Me]=a.useState({}),[Oe,Ye]=a.useState({}),[Le]=a.useState({}),[He,at]=a.useState(null),it=a.useRef(null),Be=a.useRef({}),Ne=Rn();a.useEffect(()=>{let P=!1;return ue("loading"),Promise.all([aa({libraryId:o,infoId:y}).catch(()=>null),Ua({libraryId:o,infoId:y}),qa({libraryId:o,infoId:y})]).then(([G,ne,Se])=>{if(P)return;const Re=(G==null?void 0:G.payload)??{},De=typeof Re.title=="string"&&Re.title||typeof Re.label=="string"&&Re.label||typeof Re.name=="string"&&Re.name||y;v(De),N(Re),F((G==null?void 0:G.infoType)??null),T(ne.items),m(Se.items),ue("ready")}).catch(()=>{P||(N(null),F(null),T([]),m([]),ue("error"))}),()=>{P=!0}},[o,y]),a.useEffect(()=>{if(Y!=="translation"){ge(null);return}Is({libraryId:o,infoId:y,approachKey:"vocab-card"}).then(P=>ge(P.projection??null)).catch(()=>ge(null))},[Y,y,o]);const W=a.useMemo(()=>{var ke;const P=new Map(w.map(he=>[Zt(he),he])),G=new Map,ne=new Map;for(const he of w)G.set(Zt(he),0),ne.set(Zt(he),[]);for(const he of z){const de=xs({parentItemId:he.parentItemId,parentCheckType:he.parentCheckType,parentDirection:he.parentDirection}),ze=[he.childItemId,he.childCheckType??"",he.childDirection??""].join("|");!P.has(de)||!P.has(ze)||((ke=ne.get(de))==null||ke.push(ze),G.set(ze,(G.get(ze)??0)+1))}const Se=Array.from(G.entries()).filter(([,he])=>he===0).map(([he])=>he),Re=new Map;for(const he of Se)Re.set(he,0);for(;Se.length;){const he=Se.shift(),de=Re.get(he)??0;for(const ze of ne.get(he)??[]){const _e=Math.max(Re.get(ze)??0,de+1);Re.set(ze,_e),G.set(ze,(G.get(ze)??1)-1),(G.get(ze)??0)<=0&&Se.push(ze)}}const De=new Map;for(const he of w){const de=Zt(he),ze=Re.get(de)??0,_e=De.get(ze)??[];_e.push(de),De.set(ze,_e)}return w.map(he=>{const de=Zt(he),ze=Re.get(de)??0,_e=De.get(ze)??[de],nt=Math.max(0,_e.indexOf(de));return{id:de,position:{x:40+nt*290+(ze%2?18:0),y:30+ze*120},draggable:!1,selectable:!0,data:{label:he.label,subtitle:vs(he),checkType:he.checkType??"info",direction:he.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[w,z]),$e=a.useMemo(()=>new Map(w.map(P=>[Zt(P),P])),[w]),oe=a.useMemo(()=>{const P=[];for(const G of z){const ne=xs({parentItemId:G.parentItemId,parentCheckType:G.parentCheckType,parentDirection:G.parentDirection}),Se=[G.childItemId,G.childCheckType??"",G.childDirection??""].join("|");!$e.has(ne)||!$e.has(Se)||P.push({id:`${ne}->${Se}`,source:ne,target:Se,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return P},[$e,z]),U=a.useMemo(()=>K?$e.get(K)??null:null,[$e,K]);a.useEffect(()=>{xe(""),ae(null),ye(0),ce(!1),Pe(null),te(null),Ye({})},[K]);const fe=a.useMemo(()=>{var Re,De;if(!U)return null;const P=Y??U.infoType??null,G=U.checkType??"info",ne=U.direction??null,Se=V??{};if(U.cardType==="vocab"&&I&&Array.isArray(I.words)){const ke=I.words,he=((Re=ke[0])==null?void 0:Re.label)??"?",de=((De=ke[1])==null?void 0:De.label)??"?";return ne==="a-to-b"?{kind:"vocab",prompt:String(he),expected:String(de)}:ne==="b-to-a"?{kind:"vocab",prompt:String(de),expected:String(he)}:{kind:"generic",prompt:`${he} ↔ ${de}`,expected:`${he} ↔ ${de}`}}if(P==="citation"&&G==="quote-fragment"&&ne&&typeof Se.text=="string"){const ke=ne,he=ya(Se.text),de=he.nodes[ke];if(de){const ze=Dn(Se.text,de);return{kind:"citation-fragment",expected:de.text,quoteContext:{title:d,before:ze.before,after:ze.after,total:Object.keys(he.nodes).length,completed:0},quotePlaceholder:de.text.length>0?".".repeat(Math.max(4,Math.min(18,de.text.length))):"..."}}}return{kind:"generic",prompt:U.description||U.label,expected:U.label}},[Y,V,U,d,I]),Je=async P=>{if(U&&l)try{await si({libraryId:o,outcome:{itemType:"info",itemId:U.cardId,checkType:U.checkType??"info",direction:U.direction??null,revisionType:"direct",evalType:"direct-check",correct:P,clientId:"cogita-info-checkcards",clientSequence:C,personRoleId:l}}),Ie(G=>G+1),te(P?"Saved as correct.":"Saved as incorrect.")}catch{te("Failed to save answer.")}},E=U?Zt(U):null,R=E?!!qe[E]:!1,Z=async()=>{if(!U||!fe)return;const P=Zt(U);if(qe[P]){te("This card was already checked.");return}const G=fe.expected,ne=fe.kind==="citation-fragment",Se=Ya(G,le,{thresholdPercent:ne?90:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:ne}),Re=Se.isCorrect;ae(Re?"correct":"incorrect"),ye(De=>De+1),Pe(Se.mask),ce(!0),te(l?null:"Answer checked locally (not saved: no person selected)."),Me(De=>({...De,[P]:!0})),l&&await Je(Re)},re=()=>{if(!U||!fe)return;const P=Zt(U);qe[P]||(Me(ne=>({...ne,[P]:!0})),te("Answer revealed (not saved)."));const G=Ya(fe.expected,fe.expected,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:fe.kind==="citation-fragment"});Pe(G.mask)},S=a.useMemo(()=>U?U.infoType==="citation"?{...U,description:d}:{...U,description:U.label}:null,[U,d]),J=a.useMemo(()=>Y?Xe(t,Y):t.cogita.library.infoTypes.any,[t,Y]);return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:J}),e.jsx("h2",{className:"cogita-card-title",children:d}),e.jsx("p",{className:"cogita-card-subtitle",children:y})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${w.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${z.length}`}),e.jsx("button",{type:"button",className:"cta",disabled:w.length===0,onClick:()=>Ne(`/cogita/library/${o}/revision/run?libraryTarget=revisions&scope=info&infoId=${encodeURIComponent(y)}`),children:"Start revision"})]})]}),u==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):u==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(nn,{nodes:W,edges:oe,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:(P,G)=>p(G.id),panOnDrag:!0,children:[e.jsx(sn,{}),e.jsx(rn,{showInteractive:!1})]})}),U?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[fe&&S?e.jsx(zn,{flashState:O,flashTick:H,children:e.jsx(Bn,{copy:t,currentCard:S,currentTypeLabel:"",prompt:fe.kind==="citation-fragment"?null:fe.prompt,languages:[],answer:le,onAnswerChange:xe,computedExpected:[],computedAnswers:Oe,onComputedAnswerChange:(P,G)=>Ye(ne=>({...ne,[P]:G})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:Le,feedback:O,canAdvance:!1,quoteContext:fe.kind==="citation-fragment"?fe.quoteContext:null,quotePlaceholder:fe.kind==="citation-fragment"?fe.quotePlaceholder:null,onCheckAnswer:()=>void Z(),onSkip:()=>p(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:_,setShowCorrectAnswer:ce,onRevealCorrect:re,answerMask:ve,expectedAnswer:fe.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:it,computedInputRefs:Be,scriptMode:He,setScriptMode:at,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:R||_,hideSkipAction:!0,allowRevealBeforeCheck:!0,autoRevealAfterAnswer:!0,disableCheckAfterAnswer:!0})}):null,l?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),Ce?e.jsx("p",{className:"cogita-library-hint",children:Ce}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:w.map(P=>{const G=Zt(P),ne=K===G;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${ne?"active":""}`,onClick:()=>p(G),children:[e.jsx("span",{children:P.label}),e.jsx("small",{children:vs(P)})]},G)})})]})]})]})})})})})}function _a(t,n){var s,i;return((i=(s=t.fields.find(r=>r.fieldType===n))==null?void 0:s.plainValue)==null?void 0:i.trim())??""}function ir(t){return _a(t,"role_kind").toLowerCase()==="person"}function rr(t){return _a(t,"label")||_a(t,"display_name")||_a(t,"name")||t.roleId}function or({copy:t,onPersonCreated:n}){const[s,i]=a.useState([]),[r,h]=a.useState("loading"),[g,k]=a.useState(null),[j,L]=a.useState(!1),[o,y]=a.useState(""),l=async()=>{h("loading");try{const w=await Ls();i(w),h("ready")}catch{i([]),h("error")}};a.useEffect(()=>{l()},[]);const d=a.useMemo(()=>s.filter(ir).map(w=>({roleId:w.roleId,label:rr(w)})).sort((w,T)=>w.label.localeCompare(T.label)),[s]),v=async()=>{const w=o.trim();if(!w){k("Name is required.");return}L(!0),k(null);try{const T=await ii({fields:[{fieldType:"role_kind",plainValue:"person"},{fieldType:"label",plainValue:w},{fieldType:"display_name",plainValue:w}]});y(""),k("Person role created."),n==null||n(T.roleId),await l()}catch{k("Failed to create person role.")}finally{L(!1)}};return e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-browser-panel",children:[e.jsx("div",{className:"cogita-info-overview-head",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Cogita"}),e.jsx("h2",{className:"cogita-card-title",children:"Persons"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Select reviewer persons in the header and create new person roles here."})]})}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Create"}),e.jsx("h3",{className:"cogita-detail-title",children:"New person role"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{type:"text",value:o,onChange:w=>y(w.target.value),placeholder:"e.g. Anna Kowalska",disabled:j})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:j,children:j?"Creating...":"Create person"})}),g?e.jsx("p",{className:"cogita-library-hint",children:g}):null]})]}),e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Overview"}),e.jsx("h3",{className:"cogita-detail-title",children:"All person roles"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[r==="loading"?e.jsx("p",{children:"Loading persons..."}):null,r==="error"?e.jsx("p",{children:"Failed to load persons."}):null,r==="ready"&&d.length===0?e.jsx("p",{children:"No person roles found."}):null,r==="ready"&&d.length>0?e.jsxs("div",{className:"cogita-details-grid",children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:"Name"}),e.jsx("span",{children:"Type"}),e.jsx("span",{children:"Role ID"}),e.jsx("span",{})]}),d.map(w=>e.jsxs("div",{className:"cogita-details-row",role:"row",children:[e.jsx("span",{}),e.jsx("span",{title:w.label,children:w.label}),e.jsx("span",{children:"person"}),e.jsx("span",{title:w.roleId,children:w.roleId}),e.jsx("span",{})]},w.roleId))]}):null]})]})]})]})})})})}function lr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,libraryId:o,collectionId:y}){const{libraryName:l}=na(o),[d,v]=a.useState([]),[w,T]=a.useState("loading"),[z,m]=a.useState("idle"),u=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),ue=`/#/cogita/library/${o}`,K=()=>{T("loading"),$s({libraryId:o}).then(N=>{v(N),T("idle")}).catch(()=>{v([]),T("error")})};a.useEffect(()=>{K()},[o]);const p=async N=>{try{await Rs({libraryId:o,shareId:N}),K()}catch{K()}},V=async N=>{const Y=`${u}/${N}`;try{await navigator.clipboard.writeText(Y),m("copied")}catch{m("failed")}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:ue,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${ue}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[w==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):w==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):d.filter(N=>!y||N.collectionId===y).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:d.filter(N=>!y||N.collectionId===y).map(N=>e.jsxs("div",{className:"cogita-share-row","data-state":N.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:N.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(N.createdUtc).toLocaleString(),N.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),N.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${u}/${N.shareCode}`}):null]}),N.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[N.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>V(N.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>p(N.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},N.shareId))}),z==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):z==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function cr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,libraryId:o}){const{libraryName:y}=na(o),[l,d]=a.useState(null),[v,w]=a.useState(null),[T,z]=a.useState(null),[m,u]=a.useState(null),[ue,K]=a.useState(null),[p,V]=a.useState(null),N=a.useRef(null),Y=ge=>{if(!Number.isFinite(ge))return"0 B";if(ge<1024)return`${ge} B`;const le=ge/1024;if(le<1024)return`${le.toFixed(1)} KB`;const xe=le/1024;return xe<1024?`${xe.toFixed(1)} MB`:`${(xe/1024).toFixed(1)} GB`},F=async()=>{d(null),K({loadedBytes:0,totalBytes:null,percent:null});try{d(t.cogita.library.overview.exporting);const ge=await ri(o,K),le=URL.createObjectURL(ge),xe=document.createElement("a");xe.href=le,xe.download=`cogita-library-${y||o}.json`,xe.click(),URL.revokeObjectURL(le),d(t.cogita.library.overview.exportReady)}catch{d(t.cogita.library.overview.exportFail)}finally{K(ge=>ge??{loadedBytes:0,totalBytes:null,percent:null})}},I=async ge=>{var xe;w(null),z(null),u(null);const le=(xe=ge.target.files)==null?void 0:xe[0];if(le)try{w(t.cogita.library.overview.importing),V({loadedBytes:0,totalBytes:le.size,percent:0});const Ce=await oi(o,le,V,te=>{const C=te.stage==="infos"?t.cogita.library.overview.importStageInfos:te.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;u(t.cogita.library.overview.importLiveProgress.replace("{stage}",C).replace("{done}",String(te.processed)).replace("{total}",String(te.total)).replace("{infos}",String(te.infos)).replace("{connections}",String(te.connections)).replace("{collections}",String(te.collections)))});z({infos:Ce.infosImported,connections:Ce.connectionsImported,collections:Ce.collectionsImported}),w(t.cogita.library.overview.importDone)}catch(Ce){const te=Ce instanceof Ms&&Ce.message?` ${Ce.message}`:"";w(`${t.cogita.library.overview.importFail}${te}`)}finally{N.current&&(N.current.value="")}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:y}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:F,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:N,type:"file",accept:"application/json",onChange:I})]})]}),ue?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:ue.percent??void 0,max:ue.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",Y(ue.loadedBytes)).replace("{total}",ue.totalBytes?Y(ue.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,p?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:p.percent??void 0,max:p.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",Y(p.loadedBytes)).replace("{total}",p.totalBytes?Y(p.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,l?e.jsx("p",{className:"cogita-help",children:l}):null,v?e.jsx("p",{className:"cogita-help",children:v}):null,m?e.jsx("p",{className:"cogita-help",children:m}):null,T?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(T.infos)).replace("{connections}",String(T.connections)).replace("{collections}",String(T.collections))}):null]})]})})})]})})}function dr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,libraryId:o}){const{libraryName:y}=na(o),[l,d]=a.useState(""),[v,w]=a.useState([]),T=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:y}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:z=>d(z.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const z=l.trim();z&&(w(m=>[{id:T(),name:z},...m]),d(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[v.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,v.map(z=>e.jsx("button",{type:"button",className:"ghost",children:z.name},z.id))]})]})]})})})]})})}function ur({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,libraryId:o}){const{libraryName:y}=na(o),[l,d]=a.useState(""),[v,w]=a.useState([]),T=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:y}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:z=>d(z.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const z=l.trim();z&&(w(m=>[{id:T(),name:z},...m]),d(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[v.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,v.map(z=>e.jsx("button",{type:"button",className:"ghost",children:z.name},z.id))]})]})]})})})]})})}function hr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,libraryId:o}){const{libraryName:y}=na(o),l=`/#/cogita/library/${o}`,[d,v]=a.useState(""),[w,T]=a.useState([]),[z,m]=a.useState("idle"),[u,ue]=a.useState(0),[K,p]=a.useState(null);a.useEffect(()=>{m("loading");const N=window.setTimeout(()=>{Oa({libraryId:o,query:d.trim()||void 0,limit:30}).then(Y=>{T(Y.items),ue(Y.total),p(Y.nextCursor??null),m("ready")}).catch(()=>{T([]),ue(0),p(null),m("ready")})},240);return()=>window.clearTimeout(N)},[o,d]);const V=async()=>{if(K){m("loading");try{const N=await Oa({libraryId:o,query:d.trim()||void 0,limit:30,cursor:K});T(Y=>[...Y,...N.items]),p(N.nextCursor??null),ue(N.total),m("ready")}catch{m("ready")}}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:y}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${l}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:d,onChange:N=>v(N.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(w.length)).replace("{total}",String(u||w.length))}),e.jsx("span",{children:z==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:w.length?w.map(N=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${l}/collections/${N.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:N.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(N.itemCount))," ·"," ",N.notes||t.cogita.library.collections.noNotes]})]})},N.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${l}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),K?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:V,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const be=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,Ht=(t,n,s,i)=>`${t}:${n}:${s??""}:${i??""}`;function gr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,libraryId:o,collectionId:y}){na(o);const l=`/#/cogita/library/${o}`,[d,v]=a.useState(t.cogita.library.collections.defaultName),[w,T]=a.useState(null),[z,m]=a.useState(0),[u,ue]=a.useState([]),[K,p]=a.useState("idle"),[V,N]=a.useState(null),Y=a.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(u.length)).replace("{total}",String(z||u.length)),[t,u.length,z]);a.useEffect(()=>{on(o,y).then(I=>{v(I.name),T(I.notes??null),m(I.itemCount)}).catch(()=>{v(t.cogita.library.collections.defaultName),T(null)})},[o,y]),a.useEffect(()=>{p("loading"),Ja({libraryId:o,collectionId:y,limit:40}).then(I=>{ue(I.items),N(I.nextCursor??null),m(I.total),p("ready")}).catch(()=>{ue([]),N(null),p("ready")})},[o,y]);const F=async()=>{if(V){p("loading");try{const I=await Ja({libraryId:o,collectionId:y,limit:40,cursor:V});ue(ge=>[...ge,...I.items]),N(I.nextCursor??null),m(I.total),p("ready")}catch{p("ready")}}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:d}),e.jsx("p",{className:"cogita-library-subtitle",children:w||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${l}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${l}/collections/${y}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${l}/collections/${y}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:Y}),e.jsx("span",{children:K==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:u.length?u.map(I=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:I.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:I.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:I.label}),e.jsx("p",{className:"cogita-card-subtitle",children:I.description})]})},be(I))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),V?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:F,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${l}/collections/${y}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const ws=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],mr={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},pr=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],fr=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function br({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,libraryId:o,onCreated:y}){const l=Ea(),{libraryName:d}=na(o),v=`/#/cogita/library/${o}`,[w,T]=a.useState(null),[z,m]=a.useState(""),[u,ue]=a.useState(""),[K,p,V]=An([]),[N,Y,F]=En([]),[I,ge]=a.useState(null),[le,xe]=a.useState(null),Ce=a.useRef(null),te=a.useMemo(()=>K.find(H=>H.id===I)??null,[K,I]);a.useEffect(()=>{const H=new URLSearchParams(l.search),ye=(H.get("draft")??"").trim(),_=(H.get("draftType")??"").trim();if(!ye||_!=="info-selection"||Ce.current===ye)return;const ce=Vi(o,ye);if(!ce||ce.infoIds.length===0)return;const ve=crypto.randomUUID(),Pe=ce.infoIds.length>1?crypto.randomUUID():null,qe=ce.infoIds.map((Le,He)=>({id:crypto.randomUUID(),type:"default",position:{x:80,y:80+He*100},data:{nodeType:"source.info",label:"Selected info",params:{infoId:Le,infoType:"any"}}})),Me=Pe?[{id:Pe,type:"default",position:{x:360,y:120+Math.max(0,(ce.infoIds.length-1)*50)},data:{nodeType:"logic.or",label:"Selected infos",params:{}}}]:[],Oe={id:ve,type:"default",position:{x:660,y:140+Math.max(0,(ce.infoIds.length-1)*35)},data:{nodeType:"output.collection",label:"Collection output",params:{}}},Ye=qe.map(Le=>({id:crypto.randomUUID(),source:Le.id,target:Pe??ve}));Pe&&Ye.push({id:crypto.randomUUID(),source:Pe,target:ve}),p([...qe,...Me,Oe]),Y(Ye),ge(ve),xe(`Draft loaded from ${ce.infoIds.length} selected infos. Set name and save to create collection.`),Ce.current=ye},[o,l.search,Y,p]);const C=H=>{var ve;const ye=crypto.randomUUID(),_=((ve=ws.find(Pe=>Pe.type===H))==null?void 0:ve.label)??H,ce={...mr[H]};p(Pe=>[...Pe,{id:ye,type:"default",position:{x:120+Pe.length*40,y:120+Pe.length*40},data:{nodeType:H,label:_,params:ce}}]),ge(ye)},Ie=a.useCallback(H=>{Y(ye=>Pn({...H,id:crypto.randomUUID()},ye))},[Y]),O=H=>{te&&p(ye=>ye.map(_=>_.id===te.id?{..._,data:{..._.data,params:H}}:_))},ae=async()=>{if(xe(null),!z.trim()){xe(t.cogita.library.collections.saveRequiredName);return}try{const H={nodes:K.map(ce=>({nodeId:ce.id,nodeType:ce.data.nodeType,payload:{position:ce.position,params:ce.data.params}})),edges:N.map(ce=>({edgeId:ce.id,fromNodeId:ce.source,fromPort:ce.sourceHandle??null,toNodeId:ce.target,toPort:ce.targetHandle??null}))};let ye=w,_=!1;if(ye)await As({libraryId:o,collectionId:ye,nodes:H.nodes,edges:H.edges});else{const ce=await li({libraryId:o,name:z.trim(),notes:u.trim()||void 0,items:[],graph:H});ye=ce.collectionId,_=!0,T(ce.collectionId)}xe(_?t.cogita.library.collections.saveSuccess:t.cogita.library.graph.saveSuccess),y(ye)}catch{xe(w?t.cogita.library.graph.saveFail:t.cogita.library.collections.saveFail)}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.createKicker}),e.jsx("h1",{className:"cogita-library-title",children:d}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.createSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${v}/collections`,children:t.cogita.library.actions.collections}),e.jsx("button",{type:"button",className:"cta",onClick:ae,children:t.cogita.library.actions.saveCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.collectionInfoTitle}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{value:z,onChange:H=>m(H.target.value),placeholder:t.cogita.library.collections.namePlaceholder})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.notesLabel}),e.jsx("textarea",{value:u,onChange:H=>ue(H.target.value),placeholder:t.cogita.library.collections.notesPlaceholder})]}),le?e.jsx("p",{className:"cogita-help",children:le}):null,e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:ws.map(H=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>C(H.type),children:H.label},H.type))})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(nn,{nodes:K,edges:N,onNodesChange:V,onEdgesChange:F,onConnect:Ie,onNodeClick:(H,ye)=>ge(ye.id),fitView:!0,children:[e.jsx(sn,{color:"rgba(120,160,200,0.2)"}),e.jsx(rn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),te?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:te.data.label}),te.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(qt,{libraryId:o,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:te.data.params.tagId?{id:te.data.params.tagId,label:te.data.params.tagLabel??"",infoType:"topic"}:null,onChange:H=>O({...te.data.params,tagId:(H==null?void 0:H.id)??null,tagLabel:(H==null?void 0:H.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:te.data.params.scope??"any",onChange:H=>O({...te.data.params,scope:H.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),te.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(qt,{libraryId:o,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:te.data.params.languageId?{id:te.data.params.languageId,label:te.data.params.languageLabel??"",infoType:"language"}:null,onChange:H=>O({...te.data.params,languageId:(H==null?void 0:H.id)??null,languageLabel:(H==null?void 0:H.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:te.data.params.scope??"any",onChange:H=>O({...te.data.params,scope:H.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),te.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:te.data.params.infoType??"word",onChange:H=>O({...te.data.params,infoType:H.target.value}),children:fr.map(H=>e.jsx("option",{value:H.value,children:H.label},H.value))})]}),e.jsx(qt,{libraryId:o,infoType:te.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:te.data.params.infoId?{id:te.data.params.infoId,label:te.data.params.infoLabel??"",infoType:te.data.params.infoType??"word"}:null,onChange:H=>O({...te.data.params,infoId:(H==null?void 0:H.id)??null,infoLabel:(H==null?void 0:H.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),te.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:te.data.params.connectionType??"translation",onChange:H=>O({...te.data.params,connectionType:H.target.value}),children:pr.map(H=>e.jsx("option",{value:H.value,children:H.label},H.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:te.data.params.connectionId??"",onChange:H=>O({...te.data.params,connectionId:H.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(te.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const ea=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const n=t.length,s=t.filter(h=>h.correct).length,i=ln(_n(t));return{score:Math.round(Math.max(0,Math.min(100,i.knowness*100))*100)/100,total:n,correct:s,lastReviewedUtc:i.lastReviewedUtc??null}},yr=t=>{if(t.maskBase64)try{const n=ci(t.maskBase64);if(!n.length)return t.correct?1:0;const s=n.reduce((i,r)=>i+r,0);return Math.max(0,Math.min(1,s/n.length/255))}catch{return t.correct?1:0}return t.correct?1:0},_n=t=>t.map(n=>({correctness:yr(n),createdUtc:n.createdUtc})),ln=(t,n=Date.now())=>{var z;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const i=t.slice().sort((m,u)=>m.createdUtc.localeCompare(u.createdUtc)).slice(-5),r=i.reduce((m,u)=>m+u.correctness,0)/i.length,h=5,g=2,k=.15;let j=0,L=0;for(let m=0;m<i.length;m+=1){const u=new Date(i[m].createdUtc).getTime(),ue=m===i.length-1?n:new Date(i[m+1].createdUtc).getTime(),K=Math.max(0,(ue-u)/(1e3*60)),p=1-Math.exp(-K/h);j+=p,i[m].correctness>.5&&(L+=k)}let o=r*j*g+L;const y=((z=i[i.length-1])==null?void 0:z.createdUtc)??null,l=y?Math.max(0,(n-new Date(y).getTime())/(1e3*60)):0,v=1/(1+Math.log1p(l/60));return o*=v,i.length===1&&i[0].correctness>.5&&(o+=5.44*Math.exp(-l/2)),{knowness:o,avgCorrectness:r,lastReviewedUtc:y}},Aa=t=>{const n=t.slice();for(let s=n.length-1;s>0;s-=1){const i=Math.floor(Math.random()*(s+1));[n[s],n[i]]=[n[i],n[s]]}return n},Va=t=>t[Math.floor(Math.random()*t.length)],xr=(t,n)=>{const s=new Map;return t.forEach(i=>s.set(i,Math.random())),t.sort((i,r)=>{const h=n(i)-n(r);return h!==0?h:(s.get(i)??0)-(s.get(r)??0)})},cn=(t,n,s,i,r)=>{if(!t.length)return null;const h=t.filter(k=>!(r!=null&&r.has(be(k))));if(h.length===0)return null;const g=h.filter(k=>be(k)!==s);return Va(g.length?g:h)},vr=(t,n,s,i,r)=>{if(!t.length)return null;let h=Number.POSITIVE_INFINITY;for(const L of t){const o=be(L);if(s.has(o))continue;const y=n[o]??1;y<h&&(h=y)}if(!Number.isFinite(h))return null;const g=t.filter(L=>{const o=be(L);return!s.has(o)&&(n[o]??1)===h}),k=g.filter(L=>!r||be(L)!==r),j=i?k.filter(L=>!i.has(be(L))):k;return j.length>0?Va(j):k.length>0?Va(k):r&&g.some(L=>be(L)===r)?g.find(L=>be(L)===r)??null:g.length?Va(g):null},zs=(t,n,s,i,r)=>{const h=[],g=t.filter(j=>!r.has(be(j))&&!s.has(be(j))&&(n[be(j)]??0)<1),k=xr(g,j=>n[be(j)]??0);for(const j of k){if(h.length>=i)break;h.push(j),r.add(be(j))}if(h.length<i){const j=Aa(t.filter(L=>!r.has(be(L))&&s.has(be(L))));for(const L of j){if(h.length>=i)break;h.push(L),r.add(be(L))}}return h},wr=(t,n,s,i)=>zs(t,n,s,i,new Set),Vn=(t,n,s,i,r,h)=>{const g=Math.max(1,s.stackSize??n),j=Aa(t).filter((v,w,T)=>T.findIndex(z=>be(z)===be(v))===w),L=wr(j,i,r,g),o=new Set,y=new Set,l=cn(L,{},null,o,y),d=l?[l]:[];return l&&y.add(be(l)),{queue:d,meta:{pool:j,active:L,knownessMap:i,unknownSet:r,outcomesById:h,asked:o,queued:y}}},$n={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,n)=>{const i=Aa(t).filter((r,h,g)=>g.findIndex(k=>be(k)===be(r))===h);return{queue:i.slice(0,Math.min(n,i.length)),meta:{}}},applyOutcome:t=>t},On=(t,n,s,i)=>{const r=Math.max(1,s.stackSize??n),g=Aa(t).filter((w,T,z)=>z.findIndex(m=>be(m)===be(w))===T),k={},j=new Set,L=new Set,o=new Set,y=Math.max(1,s.levels??1);g.forEach(w=>{const T=be(w),z=i==null?void 0:i[T],m=typeof z=="number"&&Number.isFinite(z)?z:1;k[T]=Math.min(y,Math.max(1,Math.round(m)))});const l=[];if(g.length>0){const w=new Map;g.forEach(z=>{var u;const m=k[be(z)]??1;w.has(m)||w.set(m,[]),(u=w.get(m))==null||u.push(z)});const T=Array.from(w.keys()).sort((z,m)=>z-m);for(const z of T){if(l.length>=r)break;const m=Aa(w.get(z)??[]);for(const u of m){if(l.length>=r)break;l.push(u)}}}const d=cn(l,k,null,j,L),v=d?[d]:[];return d&&L.add(be(d)),{queue:v,meta:{pool:g,active:l,levelMap:k,asked:j,queued:L,wrongSinceCorrect:o}}},jr={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,s)=>On(t,n,s),applyOutcome:(t,n,s,i,r)=>{if(!n)return t;const h=Math.max(1,i.levels??1),g=t.meta.pool??[],k=t.meta.active??[],j={...t.meta.levelMap??{}},L=new Set(t.meta.asked??[]),o=new Set(t.meta.queued??[]),y=new Set(t.meta.wrongSinceCorrect??[]),l=be(n);o.delete(l),L.add(l);const d=j[l]??1;r.correct?(j[l]=y.has(l)?1:Math.min(d+1,h),y.delete(l)):(j[l]=1,y.add(l));const v=r.correct?k.filter(z=>be(z)!==l):k.slice();if(r.correct&&v.length<Math.max(1,i.stackSize??1)){const z=new Set(v.map(u=>be(u))),m=vr(g,j,z,L,l);m&&v.push(m)}const w=t.queue.slice(),T=cn(v,j,l,L,o);return T&&(w.push(T),o.add(be(T))),{queue:w,meta:{pool:g,active:v,levelMap:j,asked:L,queued:o,wrongSinceCorrect:y}}}},kr={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,s)=>Vn(t,n,s,{},new Set,{}),applyOutcome:(t,n,s,i,r)=>{if(!n)return t;const h=t.meta.pool??[],g=t.meta.active??[],k={...t.meta.knownessMap??{}},j=new Set(t.meta.unknownSet??[]),L={...t.meta.outcomesById??{}},o=new Set(t.meta.asked??[]),y=new Set(t.meta.queued??[]),l=be(n);y.delete(l),o.add(l);const d={correctness:Math.max(0,Math.min(1,r.correctness??(r.correct?1:0))),createdUtc:r.createdUtc??new Date().toISOString()},w=(L[l]??[]).concat(d).sort((K,p)=>K.createdUtc.localeCompare(p.createdUtc)).slice(-5);L[l]=w,j.delete(l);const T=Date.now();h.forEach(K=>{const p=be(K),V=L[p]??[];if(V.length===0){k[p]=0,j.add(p);return}const N=ln(V,T);k[p]=N.knowness});const z=g.slice();if((k[l]??0)>=1){const K=z.filter(p=>be(p)!==l);z.length=0,z.push(...K)}const u=Math.max(1,i.stackSize??s);if(z.length<u){const K=new Set(z.map(V=>be(V))),p=zs(h,k,j,u-z.length,K);z.push(...p)}const ue=t.queue.slice();if(ue.length===0||be(ue[ue.length-1])===l){const K=cn(z,{},l,o,y);K&&(ue.push(K),y.add(be(K)))}return{queue:ue,meta:{pool:h,active:z,knownessMap:k,unknownSet:j,outcomesById:L,asked:o,queued:y}}}},Bs={random:$n,levels:jr,temporal:kr},Nr=Object.values(Bs),Un=t=>{if(!t)return $n;const n=t.trim().toLowerCase();return n==="random"||n==="levels"||n==="temporal"?Bs[n]:$n},dn=(t,n)=>{const s={...t.defaultSettings};return n&&Object.entries(n).forEach(([i,r])=>{typeof r=="number"&&Number.isFinite(r)&&(s[i]=r),typeof r=="string"&&(s[i]=r)}),t.settingsFields.forEach(i=>{var h;const r=s[i.key];if(i.type==="number"){if(typeof r!="number"||Number.isNaN(r)){s[i.key]=t.defaultSettings[i.key]??0;return}i.min!==void 0&&(s[i.key]=Math.max(i.min,s[i.key])),i.max!==void 0&&(s[i.key]=Math.min(i.max,s[i.key]));return}if(i.type==="select"){const g=((h=i.options)==null?void 0:h.map(k=>k.value))??[];(typeof r!="string"||g.length>0&&!g.includes(r))&&(s[i.key]=t.defaultSettings[i.key]??g[0]??"")}}),s},_s=(t,n)=>{const s={};return t.settingsFields.forEach(i=>{const r=n.get(i.key);if(r){if(i.type==="number"){const h=Number(r);Number.isNaN(h)||(s[i.key]=h);return}s[i.key]=r}}),dn(t,s)},Sr=(t,n)=>{const s=new URLSearchParams;return t.settingsFields.forEach(i=>{const r=n[i.key];(typeof r=="number"||typeof r=="string")&&s.set(i.key,String(r))}),s};function Tr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,libraryId:o,collectionId:y,revisionId:l}){const{libraryName:d}=na(o),v=`/#/cogita/library/${o}`,[w,T]=a.useState(t.cogita.library.collections.defaultName),[z,m]=a.useState(""),[u,ue]=a.useState(20),[K,p]=a.useState("random"),[V,N]=a.useState({}),[Y,F]=a.useState("exact"),[I,ge]=a.useState([]),[le,xe]=a.useState(null),[Ce,te]=a.useState([]),[C,Ie]=a.useState("idle"),[O,ae]=a.useState(null),[H,ye]=a.useState("idle"),[_,ce]=a.useState("idle"),[ve,Pe]=a.useState("idle"),qe=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),Me=a.useMemo(()=>Un(K),[K]),Oe=a.useMemo(()=>dn(Me,V),[Me,V]),Ye=a.useMemo(()=>Sr(Me,Oe).toString(),[Me,Oe]);a.useEffect(()=>{on(o,y).then(Ne=>T(Ne.name)).catch(()=>T(t.cogita.library.collections.defaultName))},[o,y]),a.useEffect(()=>{l&&di({libraryId:o,collectionId:y,revisionId:l}).then(Ne=>{m(Ne.name),p(Ne.mode||"random"),F(Ne.check||"exact"),ue(Ne.limit||20),N(Ne.revisionSettings??{})}).catch(()=>{m("")})},[y,o,l]),a.useEffect(()=>{Es({libraryId:o}).then(Ne=>{ge(Ne),!le&&Ne.length>0&&xe(Ne[0].roleId)}).catch(()=>{ge([])})},[o]);const Le=()=>{ce("loading"),$s({libraryId:o}).then(Ne=>{te(Ne),ce("idle")}).catch(()=>{te([]),ce("error")})};a.useEffect(()=>{Le()},[o]);const He=async()=>{Ie("working"),ye("idle");try{const Ne=await hi({libraryId:o,collectionId:y,revisionType:Me.id,revisionSettings:Oe,mode:K,check:Y,limit:u});ae(`${qe}/${Ne.shareCode}${Ye?`?${Ye}`:""}`),Ie("ready"),Le()}catch{Ie("error")}},at=async()=>{if(l){Pe("saving");try{await ui({libraryId:o,collectionId:y,revisionId:l,name:z||w,revisionType:Me.id,revisionSettings:Oe,mode:K,check:Y,limit:u}),Pe("saved")}catch{Pe("error")}}},it=async()=>{if(O)try{await navigator.clipboard.writeText(O),ye("copied")}catch{ye("failed")}},Be=async Ne=>{try{await Rs({libraryId:o,shareId:Ne}),Le()}catch{Le()}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:w}),e.jsx("p",{className:"cogita-library-subtitle",children:d})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${v}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${v}/collections/${y}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${v}/collections/${y}/revision/run?mode=${encodeURIComponent(K)}&check=${encodeURIComponent(Y)}&limit=${u}${Ye?`&${Ye}`:""}${le?`&reviewer=${encodeURIComponent(le)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:z,onChange:Ne=>m(Ne.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:K,onChange:Ne=>p(Ne.target.value),children:Nr.map(Ne=>e.jsx("option",{value:Ne.id,children:t.cogita.library.revision[Ne.labelKey]},Ne.id))})]}),Me.settingsFields.map(Ne=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[Ne.labelKey]}),Ne.type==="select"?e.jsx("select",{value:String(Oe[Ne.key]??""),onChange:W=>N($e=>({...$e,[Ne.key]:W.target.value})),children:(Ne.options??[]).map(W=>e.jsx("option",{value:W.value,children:t.cogita.library.revision[W.labelKey]},W.value))}):e.jsx("input",{type:"number",min:Ne.min,max:Ne.max,step:Ne.step,value:Oe[Ne.key]??0,onChange:W=>N($e=>({...$e,[Ne.key]:Number(W.target.value||0)}))})]},Ne.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),Me.id!=="levels"&&Me.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:u,onChange:Ne=>ue(Number(Ne.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:le??"",onChange:Ne=>xe(Ne.target.value||null),children:I.map(Ne=>e.jsx("option",{value:Ne.roleId,children:Ne.label},Ne.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[l?e.jsx("button",{type:"button",className:"cta ghost",onClick:at,disabled:ve==="saving",children:ve==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${v}/collections/${y}/revision/run?mode=${encodeURIComponent(K)}&check=${encodeURIComponent(Y)}&limit=${u}${Ye?`&${Ye}`:""}${le?`&reviewer=${encodeURIComponent(le)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]}),ve==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),O?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:O,readOnly:!0})]}):null,C==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,H==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):H==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:He,disabled:C==="working",children:C==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),O?e.jsx("button",{type:"button",className:"cta ghost",onClick:it,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),_==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):Ce.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:Ce.map(Ne=>e.jsxs("div",{className:"cogita-share-row","data-state":Ne.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:Ne.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(Ne.createdUtc).toLocaleString(),Ne.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),Ne.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>Be(Ne.shareId),children:t.cogita.library.revision.shareRevokeAction})]},Ne.shareId))})]})]})]})]})})})]})})}const kn=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function Vs(t,n,s){if(!t)return null;const i=new Map(t.nodes.map(K=>[K.id,K])),r=new Map,h=new Set,g=K=>{if(typeof K=="number")return K;if(typeof K=="string"){const p=Number(K);return Number.isFinite(p)?p:0}return 0},k=K=>{if(r.has(K))return r.get(K);if(h.has(K))return 0;const p=i.get(K);if(!p)return 0;h.add(K);const V=Y=>{var I,ge;return(Y?((I=p.inputsByHandle)==null?void 0:I[Y])??[]:p.inputs??((ge=p.inputsByHandle)==null?void 0:ge.in)??[]).map(le=>k(le))};let N=0;switch(p.type){case"input.random":{const Y=p.min??0,F=p.max??Y+10,I=Math.min(Y,F),ge=Math.max(Y,F);N=Math.floor(Math.random()*(ge-I+1))+I;break}case"input.const":{N=p.value??0;break}case"input.list":{const Y=(p.list??[]).filter(Boolean),F=Math.round(g(V("index")[0]));N=Y.length?Y[Math.max(0,Math.min(Y.length-1,F))]:String(F);break}case"compute.add":{N=V("in").map(F=>g(F)).reduce((F,I)=>F+I,0);break}case"compute.sub":{const Y=V("add").map(I=>g(I)),F=V("sub").map(I=>g(I));N=Y.reduce((I,ge)=>I+ge,0)-F.reduce((I,ge)=>I+ge,0);break}case"compute.mul":{const Y=V("in").map(F=>g(F));N=Y.length?Y.reduce((F,I)=>F*I,1):0;break}case"compute.div":{const Y=g(V("num")[0]),F=V("den").map(I=>g(I)).reduce((I,ge)=>I+ge,0);N=Math.abs(F)<Number.EPSILON?0:Y/F;break}case"compute.pow":{const Y=g(V("base")[0]),F=g(V("exp")[0]);N=Math.pow(Y,F);break}case"compute.exp":{const Y=g(V("base")[0]),F=g(V("exp")[0]);N=Math.pow(Y,F);break}case"compute.log":{const Y=g(V("value")[0]),F=g(V("base")[0]),I=Math.max(Y,Number.EPSILON);N=Math.abs(F)<Number.EPSILON?Math.log(I):Math.log(I)/Math.log(F);break}case"compute.abs":{N=Math.abs(g(V("in")[0]));break}case"compute.min":{const Y=V("in").map(F=>g(F));N=Y.length?Math.min(...Y):0;break}case"compute.max":{const Y=V("in").map(F=>g(F));N=Y.length?Math.max(...Y):0;break}case"compute.floor":{N=Math.floor(g(V("in")[0]));break}case"compute.ceil":{N=Math.ceil(g(V("in")[0]));break}case"compute.round":{N=Math.round(g(V("in")[0]));break}case"compute.mod":{const Y=g(V("a")[0]),F=g(V("b")[0]);N=Math.abs(F)<Number.EPSILON?0:Y%F;break}case"compute.concat":{const F=["in1","in2","in3","in4","in5","in6"].flatMap(xe=>V(xe)),I=F.length?F:V("in");N=(I.length?I:V()).map(xe=>xe==null?"":String(xe)).join("");break}case"compute.trim":{const Y=V("text")[0]??V("in")[0]??"",F=Y==null?"":String(Y),I=Math.max(0,Math.round(g(V("start")[0]))),ge=Math.max(0,Math.round(g(V("end")[0])));I+ge>=F.length?N="":N=F.substring(I,F.length-ge);break}case"output":{N=V("in")[0]??0;break}default:N=0}return h.delete(K),r.set(K,N),N},j=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(K=>K.type==="output").map(K=>K.id);t.nodes.forEach(K=>k(K.id)),j.forEach(K=>k(K));const L=K=>Math.abs(K%1)<1e-5?String(Math.round(K)):K.toFixed(3).replace(/\.?0+$/,""),o=K=>typeof K=="number"?L(K):K??"",y=new Map;j.forEach(K=>{var F,I,ge,le;const p=i.get(K);if(!p)return;const V=(I=(F=p.inputsByHandle)==null?void 0:F.name)==null?void 0:I[0],N=V?o(r.get(V)):"",Y=(N==null?void 0:N.toString().trim())||((ge=p.outputLabel)==null?void 0:ge.trim())||((le=p.name)==null?void 0:le.trim())||K;y.set(K,Y)});const l={},d={},v={};j.forEach(K=>{var N,Y;const p=i.get(K);if(!p)return;const V=y.get(K)??(((N=p.outputLabel)==null?void 0:N.trim())||((Y=p.name)==null?void 0:Y.trim())||K);l[V]=o(r.get(K)),p.name&&(d[p.name.trim()]=V),d[K]=V});const w=(K,p)=>{let V=K;return t.nodes.forEach(N=>{var le,xe;const Y=o(r.get(N.id)),F=j.includes(N.id),I=F?y.get(N.id)??((le=N.outputLabel)==null?void 0:le.trim())??((xe=N.name)==null?void 0:xe.trim())??N.id:"",ge=F&&p?I:Y;V=V.replace(new RegExp(`\\{\\s*${kn(N.id)}\\s*\\}`,"gi"),ge),N.name&&(V=V.replace(new RegExp(`\\{\\s*${kn(N.name)}\\s*\\}`,"gi"),ge)),F&&N.outputLabel&&(V=V.replace(new RegExp(`\\{\\s*${kn(N.outputLabel)}\\s*\\}`,"gi"),I))}),V},T=n;let z=T.trim().length>0?T:"";z||(z=j.length?`Compute ${j.join(", ")}`:"Compute"),z=w(z,!0);const m=(s==null?void 0:s.trim())??"",u=m?w(m,!1):"",ue={};return r.forEach((K,p)=>{ue[p]=K,v[p]=o(K);const V=i.get(p);V!=null&&V.name&&(v[V.name.trim()]=o(K))}),{prompt:z,answers:l,values:ue,answerText:u,outputVariables:d,variableValues:v}}function Os(t){var s;const n=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((s=n[0])==null?void 0:s[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const Nn=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function Us({outcomes:t}){const[n,s]=a.useState("day"),i=a.useMemo(()=>{const r=Nn.find(k=>k.id===n)??Nn[1],h=Date.now()-r.ms,g=t.filter(k=>new Date(k.createdUtc).getTime()>=h);return ea(g)},[t,n]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:Nn.map(r=>e.jsx("button",{type:"button",className:"ghost","data-active":n===r.id,onClick:()=>s(r.id),children:r.label},r.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[i.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[i.correct," / ",i.total]})]})}const Cr="cogita-revision",Ir=1,Qa="outcomes",Mr=()=>new Promise((t,n)=>{const s=indexedDB.open(Cr,Ir);s.onupgradeneeded=()=>{const i=s.result;if(!i.objectStoreNames.contains(Qa)){const r=i.createObjectStore(Qa,{keyPath:"id"});r.createIndex("byItem","itemKey",{unique:!1}),r.createIndex("byPending","pending",{unique:!1})}},s.onerror=()=>n(s.error),s.onsuccess=()=>t(s.result)}),Pa=async(t,n)=>{const s=await Mr();return new Promise((i,r)=>{const h=s.transaction(Qa,t),g=h.objectStore(Qa);n(g).then(i).catch(r),h.onerror=()=>r(h.error)})},qs=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const n=Array.from(t).map(s=>s.toString(16).padStart(2,"0"));return`${n.slice(0,4).join("")}-${n.slice(4,6).join("")}-${n.slice(6,8).join("")}-${n.slice(8,10).join("")}-${n.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},Lr=()=>{const t="cogita_revision_client_id",n=localStorage.getItem(t);if(n)return n;const s=qs();return localStorage.setItem(t,s),s},$r=()=>{const t="cogita_revision_client_seq",n=Number(localStorage.getItem(t)??"0"),s=Number.isFinite(n)?n+1:1;return localStorage.setItem(t,String(s)),s},Js=(t,n,s,i)=>Ht(t,n,s,i),Xa=async t=>{const n=Lr(),s=$r(),i=new Date().toISOString(),r={...t,clientId:n,clientSequence:s,createdUtc:i,id:qs(),pending:!0};return await Pa("readwrite",h=>new Promise((g,k)=>{const j={...r,itemKey:Js(r.itemType,r.itemId,r.checkType,r.direction)},L=h.add(j);L.onsuccess=()=>g(),L.onerror=()=>k(L.error)})),r},Za=async(t,n,s,i)=>{if(!n)return[];try{const r=Js(t,n,s,i);return await Pa("readonly",h=>new Promise((g,k)=>{const L=h.index("byItem").getAll(r);L.onsuccess=()=>{const y=(L.result??[]).map(l=>({itemType:l.itemType,itemId:l.itemId,checkType:l.checkType??null,direction:l.direction??null,revisionType:l.revisionType,evalType:l.evalType,correct:l.correct,createdUtc:l.createdUtc,maskBase64:l.maskBase64,payloadBase64:l.payloadBase64,payloadHashBase64:l.payloadHashBase64,clientId:l.clientId,clientSequence:l.clientSequence,personRoleId:l.personRoleId??null})).sort((l,d)=>l.createdUtc.localeCompare(d.createdUtc));g(y)},L.onerror=()=>k(L.error)}))}catch{return[]}},ta=async()=>{try{return await Pa("readonly",t=>new Promise((n,s)=>{const i=t.getAll();i.onsuccess=()=>{const h=(i.result??[]).map(g=>({itemType:g.itemType,itemId:g.itemId,checkType:g.checkType??null,direction:g.direction??null,revisionType:g.revisionType,evalType:g.evalType,correct:g.correct,createdUtc:g.createdUtc,maskBase64:g.maskBase64,payloadBase64:g.payloadBase64,payloadHashBase64:g.payloadHashBase64,clientId:g.clientId,clientSequence:g.clientSequence,personRoleId:g.personRoleId??null}));n(h)},i.onerror=()=>s(i.error)}))}catch{return[]}},Rr=async(t=100)=>{try{return await Pa("readonly",n=>new Promise((s,i)=>{const h=n.index("byPending").getAll(!0);h.onsuccess=()=>{const g=h.result??[];s(g.slice(0,t))},h.onerror=()=>i(h.error)}))}catch{return[]}},Ar=async t=>{if(t.length!==0)try{await Pa("readwrite",n=>new Promise((s,i)=>{let r=t.length;t.forEach(h=>{const g=n.get(h);g.onsuccess=()=>{const k=g.result;if(k){k.pending=!1;const j=n.put(k);j.onsuccess=()=>{r-=1,r===0&&s()},j.onerror=()=>i(j.error)}else r-=1,r===0&&s()},g.onerror=()=>i(g.error)})}))}catch{}},Sn=async(t,n)=>{const s=await Rr(200);if(s.length===0)return;const i=new Map;s.forEach(r=>{var g;const h=r.personRoleId??n??"";i.has(h)||i.set(h,[]),(g=i.get(h))==null||g.push(r)});for(const[r,h]of i.entries()){const g=h.map(k=>({itemType:k.itemType,itemId:k.itemId,checkType:k.checkType??null,direction:k.direction??null,revisionType:k.revisionType,evalType:k.evalType,correct:k.correct,clientId:k.clientId,clientSequence:k.clientSequence,maskBase64:k.maskBase64??null,payloadHashBase64:k.payloadHashBase64??null,payloadBase64:k.payloadBase64??null,personRoleId:r||null}));try{await gi({libraryId:t,outcomes:g}),await Ar(h.map(k=>k.id))}catch{}}},Ft=t=>t.trim().toLowerCase(),Ot=t=>{const n=t==null?void 0:t.trim();return n?{fragmentId:n}:null},en=(t,n)=>{const s=Ot(n);if(!s)return!0;const i=Ot(t);return(i==null?void 0:i.fragmentId)===s.fragmentId},pt=t=>{const n=t==null?void 0:t.trim().toLowerCase();return n||null},Hs=(t,n)=>{if((pt(t.childItemType)??"info")!==(n.cardType??"").toLowerCase()||t.childItemId!==n.cardId)return!1;const i=pt(t.childCheckType),r=pt(t.childDirection),h=pt(n.checkType),g=pt(n.direction);return!(i&&i!==h||r&&r!==g)},Er={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},Pr={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},tn=(t,n,s)=>{if(!s||!n.startsWith(t))return n;const i=n.slice(t.length);if(!i)return n;const r=s==="super"?Er:Pr,h=i.split("").map(g=>r[g]??g).join("");return t+h},an=(t,n,s)=>{var g,k,j;if(!t)return((g=n[0])==null?void 0:g.key)??null;const i=new Set(n.map(L=>L.key)),r=/\{([^}]+)\}/g;let h;for(;(h=r.exec(t))!==null;){const L=((k=h[1])==null?void 0:k.trim())??"";if(!L)continue;if(i.has(L))return L;const o=s==null?void 0:s[L];if(o&&i.has(o))return o}return((j=n[0])==null?void 0:j.key)??null},Ra=t=>(()=>{const n=new Set;return t.flatMap(s=>{if(s.cardType!=="info"||s.infoType!=="citation")return[s];const i=s.description??"";if(!i.trim())return[s];const r=ya(i),h=Object.keys(r.nodes);return h.length===0?[s]:h.map(g=>({...s,checkType:"quote-fragment",direction:g})).filter(g=>{const k=[g.cardId,g.checkType??"",g.direction??""].join("|");return n.has(k)?!1:(n.add(k),!0)})})})();function js({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,libraryId:o,collectionId:y,revisionId:l}){const d=Ea(),v=`/#/cogita/library/${o}`,w=a.useMemo(()=>new URLSearchParams(d.search),[d.search]),T=Math.max(1,Number(w.get("limit")??20)),z=w.get("mode")??"random",m=a.useMemo(()=>Un(z),[z]),u=a.useMemo(()=>dn(m,_s(m,w)),[m,w]),ue=w.get("check")??"exact",K=w.get("reviewer"),p=(w.get("scope")??"").trim(),V=p==="info"||p==="info-selection"?p:"collection",N=V==="info"?(w.get("infoId")??"").trim():"",Y=V==="info-selection"?(w.get("seed")??"").trim():"",F=V==="collection"&&!!y,I=a.useMemo(()=>t.cogita.library.revision[m.labelKey]??z,[t,z,m]),ge=a.useMemo(()=>ue==="exact"?t.cogita.library.revision.checkValue:ue,[t,ue]),[le,xe]=a.useState(t.cogita.library.collections.defaultName),[Ce,te]=a.useState([]),[C,Ie]=a.useState([]),[O,ae]=a.useState("idle"),[H,ye]=a.useState({current:0,total:0}),[_,ce]=a.useState(0),[ve,Pe]=a.useState(""),[qe,Me]=a.useState(null),[Oe,Ye]=a.useState(null),[Le,He]=a.useState(null),[at,it]=a.useState(null),[Be,Ne]=a.useState([]),[W,$e]=a.useState({}),[oe,U]=a.useState({}),[fe,Je]=a.useState(null),[E,R]=a.useState(null),[Z,re]=a.useState(null),[S,J]=a.useState(null),[P,G]=a.useState(null),[ne,Se]=a.useState({}),Re=a.useRef(0),[De,ke]=a.useState(null),he=a.useRef(null),de=a.useRef(null),[ze,_e]=a.useState(null),[nt,dt]=a.useState(!1),[vt,We]=a.useState(null),[ot,bt]=a.useState([]),[wt,gt]=a.useState(null),$t=a.useRef(null),Et=a.useRef(null),[Ct,ft]=a.useState(null),[ia,et]=a.useState(0),Tt=a.useRef(null),Dt=a.useRef({}),[mt,Ze]=a.useState(!1),[ht,It]=a.useState({}),[Nt,Ue]=a.useState([]),ut=a.useRef(new Map),[jt,st]=a.useState(new Set),[ga,je]=a.useState(!1),x=a.useRef(null),f=a.useRef(new Set),Q=a.useRef({}),M=Ce[_]??null,Ge=(M==null?void 0:M.checkType)==="translation-match"&&P,Qe=a.useRef(new Map),Rt=a.useRef(new Map),St=a.useRef(new Map),zt=a.useRef(new Map),At=a.useMemo(()=>M?M.cardType==="vocab"?t.cogita.library.revision.vocabLabel:M.infoType?Xe(t,M.infoType):t.cogita.library.revision.infoLabel:"",[t,M]),ra=a.useMemo(()=>{var b;return m.id!=="levels"?Ce.length:((b=ht.pool)==null?void 0:b.length)??m.getFetchLimit(T,u)},[ht,u,m,Ce.length,T]),Wt=m.getProgressTotal?m.getProgressTotal(Ce,ht,T,u):m.id==="levels"?Math.min(T,ra):Ce.length,yt=Wt?Math.min(_+1,Wt):0,kt=Math.max(1,Number(u.tries??1)),sa=u.compare??"anchors",Mt=Math.max(0,Math.min(100,Number(u.minCorrectness??0))),xt=(u.considerDependencies??"on")==="on",Ut=Math.max(0,Math.min(100,Number(u.dependencyThreshold??85))),Ka=c=>{const b=c.slice();for(let D=b.length-1;D>0;D-=1){const q=Math.floor(Math.random()*(D+1));[b[D],b[q]]=[b[q],b[D]]}return b},xa=c=>ha(c,{treatSimilarCharsAsSame:!0})>=Mt,Fa=async()=>{const c=await ta(),b=new Map,D=new Map,q=new Map;c.forEach(A=>{const se=`${A.itemType}:${A.itemId}`,we=Ht(A.itemType,A.itemId,A.checkType,A.direction);if(b.has(se)||b.set(se,[]),b.get(se).push(A),D.has(we)||D.set(we,[]),D.get(we).push(A),A.itemType==="info"&&A.checkType==="quote-fragment"&&A.direction){const Ke=`${A.itemId}:${A.direction}`;q.has(Ke)||q.set(Ke,[]),q.get(Ke).push(A)}});const ee=new Map,B=new Map,ie=new Map;return b.forEach((A,se)=>ee.set(se,ea(A).score)),D.forEach((A,se)=>B.set(se,ea(A).score)),q.forEach((A,se)=>ie.set(se,ea(A).score)),{itemKnowness:ee,cardKnowness:B,fragmentKnowness:ie}},Gt=async c=>{const b=[];let D=null;for(;;){const q=await Ja({libraryId:o,collectionId:c,limit:200,cursor:D});if(b.push(...q.items),!q.nextCursor)break;D=q.nextCursor}return Ra(b)},va=async(c,b)=>{if(ut.current.has(c))return ut.current.get(c)??0;const D=await Gt(c);if(D.length===0)return ut.current.set(c,0),0;const ee=D.reduce((B,ie)=>{const A=be(ie);return B+(b.get(A)??0)},0)/D.length;return ut.current.set(c,ee),ee},un=(c,b)=>{if(!xt||c.cardType!=="info"||c.infoType!=="citation"||c.checkType!=="quote-fragment")return!0;const D=Ot(c.direction);if(!(D!=null&&D.fragmentId))return!0;const q=c.description??"";if(!q.trim())return!0;const B=ya(q).nodes[D.fragmentId];if(!B||!B.leftId&&!B.rightId)return!0;const ie=[B.leftId,B.rightId].filter(we=>!!we);if(ie.length===0)return!0;const A=ie.map(we=>{const Ke=Ht("info",c.cardId,"quote-fragment",we);return b.get(Ke)??0});return A.reduce((we,Ke)=>we+Ke,0)/A.length>=Ut},Bt=async c=>{const b=ht,D=c.concat(b.active??[]).concat(b.pool??[]).filter((A,se,we)=>we.findIndex(Ke=>be(Ke)===be(A))===se);if(!xt){st(new Set(D.map(be)));return}const{itemKnowness:q,cardKnowness:ee}=await Fa(),B=Nt.filter(A=>pt(A.childItemType)==="collection"&&A.childItemId===y&&!pt(A.childCheckType)&&!pt(A.childDirection)),ie=new Set;for(const A of D){if(A.cardType!=="info"){ie.add(be(A));continue}if(!un(A,ee))continue;const se=Nt.filter(Fe=>Hs(Fe,A)).concat(B);if(se.length===0){ie.add(be(A));continue}let we=0;for(const Fe of se)if(pt(Fe.parentItemType)==="collection")we+=await va(Fe.parentItemId,ee);else if(pt(Fe.parentCheckType)||pt(Fe.parentDirection)){const Ve=pt(Fe.parentCheckType),tt=pt(Fe.parentDirection),rt=Ht(Fe.parentItemType,Fe.parentItemId,Ve,tt);we+=ee.get(rt)??0}else{const Ve=`${Fe.parentItemType}:${Fe.parentItemId}`;we+=q.get(Ve)??0}we/se.length>=Ut&&ie.add(be(A))}st(ie)},wa=c=>{for(let b=c;b<Ce.length;b+=1){const D=Ce[b];if(D&&(!xt||D.cardType!=="info"||jt.has(be(D))))return b}return-1},oa=c=>!xt||c.cardType!=="info"||jt.has(be(c)),Da=c=>{if(m.id!=="temporal"&&m.id!=="levels")return null;const b=ht,D=(b.active??[]).concat(b.pool??[]),q=new Set;for(const ee of D){const B=be(ee);if(!(q.has(B)||c.has(B))&&(q.add(B),oa(ee)))return ee}return null},Jt=a.useMemo(()=>{if(m.id!=="levels")return null;const c=ht,b=c.pool??[],D=c.active??[],q=c.levelMap??{},ee=Math.max(1,Number(u.levels??1)),B=Array.from({length:ee},()=>0),ie=new Set(D.map(Ke=>be(Ke)));b.forEach(Ke=>{const Fe=Math.min(ee,Math.max(1,q[be(Ke)]??1));B[Fe-1]+=1});const A=b.length||1,se=B.map(Ke=>Ke/A*100),we=M?q[be(M)]??1:null;return{counts:B,percentages:se,currentLevel:we,levelsCount:ee,activeCount:D.length,poolCount:b.length,activeSet:ie}},[ht,u,m,M]),ja=a.useMemo(()=>{if(m.id!=="temporal")return null;const c=ht,b=c.pool??[],D=c.active??[],q=c.knownessMap??{},ee=new Set(c.unknownSet??[]);let B=0;b.forEach(se=>{(q[be(se)]??0)>1&&(B+=1)});const ie=ee.size,A=D.map(se=>({id:be(se),value:ee.has(be(se))?0:Math.max(0,Math.min(1,q[be(se)]??0))}));return{knownCount:B,unknownCount:ie,dots:A}},[ht,m]),hn=a.useMemo(()=>{if(!xt)return 0;const c=ht;return Ce.concat(c.active??[]).concat(c.pool??[]).filter((D,q,ee)=>ee.findIndex(B=>be(B)===be(D))===q).filter(D=>D.cardType==="info"&&!jt.has(be(D))).length},[xt,ht,Ce,jt]);a.useEffect(()=>{if(!xt||O!=="ready")return;const c=ht,D=Ce.concat(c.active??[]).concat(c.pool??[]).filter((B,ie,A)=>A.findIndex(se=>be(se)===be(B))===ie).filter(B=>B.cardType!=="info"||jt.has(be(B))).length,q=$t.current;if($t.current=D,q===null||D<=q)return;const ee=D-q;gt(`New card available (+${ee})`),Et.current&&window.clearTimeout(Et.current),Et.current=window.setTimeout(()=>gt(null),2200)},[xt,O,ht,Ce,jt]),a.useEffect(()=>()=>{Et.current&&window.clearTimeout(Et.current)},[]);const Kt=(c,b)=>{const D=m.applyOutcome({queue:Ce,meta:ht},M,T,u,{correct:c,correctness:b,createdUtc:new Date().toISOString()});te(D.queue),It(D.meta);const q=D.queue[_+1];q&&Ia(q,_+1)};a.useEffect(()=>{if(F&&y){on(o,y).then(c=>xe(c.name)).catch(()=>xe(t.cogita.library.collections.defaultName));return}if(V==="info"&&N){aa({libraryId:o,infoId:N}).then(c=>{const b=c.payload??{};xe(b.title||b.label||b.name||N)}).catch(()=>xe(N||t.cogita.library.revision.runKicker));return}if(V==="info-selection"){const c=Y?es(o,Y):null,b=(c==null?void 0:c.infoIds.length)??0;xe(b>0?`Selected infos (${b})`:"Selected infos");return}xe(t.cogita.library.collections.defaultName)},[t,F,y,o,V,N,Y]),a.useEffect(()=>{Fn({libraryId:o,type:"language"}).then(c=>Ie(c)).catch(()=>Ie([]))},[o]),a.useEffect(()=>{F&&Kn({libraryId:o}).then(c=>Ue(c.items??[])).catch(()=>Ue([]))},[F,o]),a.useEffect(()=>{Sn(o,K)},[o,K]),a.useEffect(()=>{Bt(Ce)},[Ce,Nt,xt,Ut,y]),a.useEffect(()=>{if(!M||!xt){je(!1);return}if(M.cardType!=="info"||jt.has(be(M))){je(!1);return}const c=wa(_+1);if(c>=0){je(!1),ce(c);return}if(m.id==="temporal"||m.id==="levels"){const b=Ce.slice(0,_+1),D=Ce.slice(_+1).filter(oa),q=b.concat(D),ee=new Set(q.map(be)),B=Da(ee);if(B){const A=be(B);ee.has(A)||(q.push(B),ee.add(A),It(se=>{const we=se,Ke=new Set(we.queued??[]);return Ke.add(A),{...we,queued:Ke}}))}const ie=q.findIndex((A,se)=>se!==_&&oa(A));if(ie>=0){te(q),ce(ie),je(!1);return}}je(!0)},[M,jt,xt,_,Ce,ht,m.id]),a.useEffect(()=>{let c=!0;return(async()=>{ae("loading"),ye({current:0,total:m.id==="levels"?0:m.getFetchLimit(T,u)});try{if(!F){if(Ue([]),V==="info"){if(!N){c&&(te([]),Ue([]),It({}),ce(0),ae("ready"));return}const[Fe,Ve]=await Promise.all([Ua({libraryId:o,infoId:N}),qa({libraryId:o,infoId:N})]);if(!c)return;const tt=Ra(Fe.items??[]);Ue(Ve.items??[]);const rt=m.prepare(tt,T,u);te(rt.queue),It(rt.meta),ce(0),ae("ready"),ye({current:tt.length,total:tt.length});return}if(V==="info-selection"){const Fe=Y?es(o,Y):null,Ve=(Fe==null?void 0:Fe.infoIds)??[];if(!Ve.length){c&&(te([]),Ue([]),It({}),ce(0),ae("ready"));return}const tt=await Promise.all(Ve.map(async ca=>{const[Vt,za]=await Promise.all([Ua({libraryId:o,infoId:ca}),qa({libraryId:o,infoId:ca})]);return{cards:Vt.items??[],deps:za.items??[]}}));if(!c)return;const rt=new Map;tt.forEach(ca=>{Ra(ca.cards).forEach(Vt=>{rt.set(be(Vt),Vt)})});const lt=Array.from(rt.values()),ct=new Set(lt.map(be)),Lt=new Map;tt.forEach(ca=>{(ca.deps??[]).forEach(Vt=>{const za=Ht(Vt.parentItemType,Vt.parentItemId,pt(Vt.parentCheckType),pt(Vt.parentDirection)),qn=Ht(Vt.childItemType,Vt.childItemId,pt(Vt.childCheckType),pt(Vt.childDirection));if(!ct.has(za)||!ct.has(qn))return;const Jn=`${za}->${qn}`;Lt.has(Jn)||Lt.set(Jn,Vt)})}),Ue(Array.from(Lt.values()));const fa=m.prepare(lt,T,u);te(fa.queue),It(fa.meta),ce(0),ae("ready"),ye({current:lt.length,total:lt.length});return}}const D=[];let q=null,ee=null;do{const Fe=await Ja({libraryId:o,collectionId:y,limit:300,cursor:q});if(D.push(...Fe.items),(m.id==="levels"||m.id==="temporal")&&Fe.total&&(ee=Fe.total),ye(Ve=>({current:D.length,total:Ve.total||Fe.total||m.getFetchLimit(T,u)})),q=Fe.nextCursor??null,ee!==null&&D.length>=ee||m.id!=="levels"&&m.id!=="temporal"&&D.length>=m.getFetchLimit(T,u))break}while(q);if(!c)return;const B=Ra(D);let ie;if(m.id==="levels"){const Fe=Math.max(1,Number(u.levels??1)),tt=(await ta()).reduce((rt,lt)=>{const ct=Ht(lt.itemType,lt.itemId,lt.checkType,lt.direction);return rt[ct]||(rt[ct]=[]),rt[ct].push(lt),rt},{});ie={},B.forEach(rt=>{const lt=be(rt),ct=tt[lt]??[],Lt=ct.length>0?ea(ct).score:0,fa=Math.max(1,Math.min(Fe,Math.ceil(Lt/100*Fe)));ie[lt]=fa})}let A=null,se=null,we=null;if(m.id==="temporal"){const Fe=await ta(),Ve=new Set(B.map(lt=>be(lt))),tt=Fe.reduce((lt,ct)=>{const Lt=Ht(ct.itemType,ct.itemId,ct.checkType,ct.direction);return Ve.has(Lt)&&(lt[Lt]||(lt[Lt]=[]),lt[Lt].push(ct)),lt},{});A={},se=new Set,we={};const rt=Date.now();B.forEach(lt=>{const ct=be(lt),Lt=tt[ct]??[];if(Lt.length===0){A[ct]=0,se.add(ct),we[ct]=[];return}const fa=_n(Lt);we[ct]=fa;const ca=ln(fa,rt);A[ct]=ca.knowness})}const Ke=m.id==="levels"?On(B,T,u,ie):m.id==="temporal"?Vn(B,T,u,A??{},se??new Set,we??{}):m.prepare(B,T,u);te(Ke.queue),It(Ke.meta),ce(0),ae("ready"),ye(Fe=>({current:Math.min(Fe.current,Fe.total),total:Fe.total}))}catch{c&&ae("error")}})(),()=>{c=!1}},[y,F,o,T,V,u,m,K,N,Y]),a.useEffect(()=>{if(Pe(""),Me(null),ft(null),et(0),Ne([]),$e({}),U({}),R(null),re(null),J(null),dt(!1),Ze(!1),_e(null),G(null),Se({}),!M){Ye(null),He(null),Je(null),We(null);return}M.cardType==="info"&&M.infoType==="computed"&&Ye(t.cogita.library.revision.loadingComputed);let c=!0;return Ia(M,_).then(b=>{!c||!b||(Ye(b.prompt),He(b.expectedAnswer),Ne(b.computedExpected),$e(b.computedAnswers),Je(b.computedValues),R(b.answerTemplate),re(b.outputVariables),J(b.variableValues))}),()=>{c=!1}},[M,t]),a.useEffect(()=>{if(!M||M.cardType!=="info"||M.infoType!=="citation"){x.current=null,f.current=new Set,it(null);return}const c=M.description??"",b=(M.label??"").trim(),D=b.replace(/\s+/g," ").trim(),q=c.replace(/\s+/g," ").trim(),ee=D&&D!==q?b:t.cogita.library.infoTypes.citation;if(!c){it(null),He(null);return}const B=ya(c);x.current=B,Ye(ee);let ie=!0;return Fa().then(({fragmentKnowness:A})=>{if(!ie)return;const se=new Set,we={};A.forEach((Ve,tt)=>{const[rt,lt]=tt.split(":",2);if(rt!==M.cardId)return;const ct=Ot(lt);if(!ct)return;const{fragmentId:Lt}=ct;we[Lt]=Ve,Ve>=Ut&&se.add(Lt)}),f.current=se,Q.current=we;const Ke=Ot(M.direction);if(Ke!=null&&Ke.fragmentId&&B.nodes[Ke.fragmentId]){pa(B,Ke.fragmentId,ee);return}const Fe=Ta(B,se,we,Ut,xt,M.direction);pa(B,(Fe==null?void 0:Fe.id)??null,ee)}).catch(()=>{f.current=new Set,Q.current={};const A=Ot(M.direction);if(A!=null&&A.fragmentId&&B.nodes[A.fragmentId]){pa(B,A.fragmentId,ee);return}const se=Ta(B,f.current,{},Ut,xt,M.direction);pa(B,(se==null?void 0:se.id)??null,ee)}),()=>{ie=!1}},[M,t,xt,Ut]),a.useEffect(()=>{if(!M||M.cardType!=="vocab"||M.checkType!=="translation-match"){G(null),Se({});return}const D=(ht.pool??ht.active??Ce).filter(A=>A.cardType==="vocab"&&A.checkType==="translation-match").filter((A,se,we)=>we.findIndex(Ke=>Ke.cardId===A.cardId)===se);D.some(A=>A.cardId===M.cardId)||D.unshift(M);const ee=Ka(D).slice(0,6).map(A=>{const se=A.label.split("↔").map(Fe=>Fe.trim()).filter(Boolean);if(se.length<2)return null;const we=`${A.cardId}:L`,Ke=`${A.cardId}:R`;return{cardId:A.cardId,leftId:we,rightId:Ke,leftLabel:se[0],rightLabel:se[1]}}).filter(Boolean),B=ee.map(A=>A.leftId),ie=Ka(ee.map(A=>A.rightId));G({pairs:ee,leftOrder:B,rightOrder:ie,selection:{},activeLeft:null,activeRight:null,locked:{}})},[M,Ce,ht]),a.useEffect(()=>()=>{he.current&&window.clearTimeout(he.current),de.current&&window.clearTimeout(de.current)},[]);const _t=a.useRef(null);a.useEffect(()=>{if(!M)return;const c=be(M),b=typeof document<"u"?document.activeElement:null;if(_t.current===c&&b&&(b.tagName==="INPUT"||b.tagName==="TEXTAREA"))return;let D=0;const q=()=>{if(M){if(M.cardType==="info"&&M.infoType==="computed"){if(Be.length>0){const B=an(E,Be,Z),ie=B?Dt.current[B]:null;if(ie&&(ie.focus(),document.activeElement===ie)){_t.current=c;return}}if(Tt.current&&(Tt.current.focus(),document.activeElement===Tt.current)){_t.current=c;return}}else if(M.cardType==="vocab"&&Tt.current&&(Tt.current.focus(),document.activeElement===Tt.current)){_t.current=c;return}D<6&&(D+=1,window.setTimeout(q,40))}},ee=window.setTimeout(q,40);return()=>window.clearTimeout(ee)},[M,Be,E,Z]),a.useEffect(()=>{if(!mt)return;const c=b=>{b.key==="Enter"&&(b.preventDefault(),ma())};return window.addEventListener("keydown",c),()=>window.removeEventListener("keydown",c)},[mt]);const ka=c=>{bt(c),We(ea(c))};a.useEffect(()=>{if(!M){We(null),bt([]);return}const c=M.cardType==="info"?"info":"connection";if(M.cardType==="info"&&M.infoType==="citation"){ta().then(b=>{const D=b.filter(q=>q.itemType==="info"&&q.itemId===M.cardId&&q.checkType==="quote-fragment"&&en(q.direction,M.direction));ka(D)}).catch(()=>{We(null),bt([])});return}Za(c,M.cardId,M.checkType,M.direction).then(b=>ka(b)).catch(()=>{We(null),bt([])})},[o,M,K]);const Na=(c,b,D,q)=>{if(c==="info"&&D==="quote-fragment"){ta().then(ee=>{const B=ee.filter(ie=>ie.itemType==="info"&&ie.itemId===b&&ie.checkType==="quote-fragment"&&en(ie.direction,q));ka(B)}).catch(()=>{We(null),bt([])});return}Za(c,b,D,q).then(ee=>ka(ee)).catch(()=>{We(null),bt([])})},la=(c,b,D)=>{var ie;const q=((ie=D.pairs.find(A=>A.leftId===c))==null?void 0:ie.rightId)??null;if(!q)return D;const ee=q===b;Se(A=>({...A,[c]:ee?"correct":"incorrect"})),he.current&&window.clearTimeout(he.current),de.current&&window.clearTimeout(de.current),Re.current+=1;const B={kind:ee?"correct":"incorrect",tick:Re.current};if(ke(null),he.current=window.setTimeout(()=>ke(B),0),de.current=window.setTimeout(()=>ke(null),420),ee){const A={...D.locked,[c]:!0};return Object.keys(A).length>=D.pairs.length?(Me("correct"),Ze(!0)):Me("correct"),{...D,selection:{...D.selection,[c]:b},activeLeft:null,activeRight:null,locked:A}}return Me("incorrect"),{...D,activeLeft:null,activeRight:null}},gn=c=>{G(b=>!b||b.locked[c]?b:b.activeRight?la(c,b.activeRight,b):{...b,activeLeft:b.activeLeft===c?null:c})},Sa=c=>{G(b=>b&&(b.activeLeft?la(b.activeLeft,c,b):{...b,activeRight:b.activeRight===c?null:c}))},ma=()=>{var c;if(M&&M.cardType==="info"&&M.infoType==="citation"&&x.current&&at&&!((c=Ot(M.direction))!=null&&c.fragmentId)){const b=Ta(x.current,f.current,Q.current,Ut,xt,M.direction,at.fragmentId);if(b){Me(null),Pe(""),dt(!1),U({}),Ze(!1),ft(null),et(0),pa(x.current,b.id,at.title);return}}Me(null),Pe(""),dt(!1),U({}),Ze(!1),ft(null),et(0),ce(b=>Math.min(b+1,Ce.length))},Yt=c=>{if(!M)return;const b=c.expected??null,D=c.answer??"";let q=b??"",ee=D;if(!b&&c.expectedMap&&c.answerMap){const Fe=Object.keys(c.expectedMap).sort((Ve,tt)=>Ve.localeCompare(tt));q=Fe.map(Ve=>{var tt;return((tt=c.expectedMap)==null?void 0:tt[Ve])??""}).join("|"),ee=Fe.map(Ve=>{var tt;return((tt=c.answerMap)==null?void 0:tt[Ve])??""}).join("|")}const B=q?Ca(q,ee,sa):new Uint8Array,ie={revisionType:m.id,evalType:c.evalType,direction:c.direction,prompt:Oe??"",expected:b,answer:D,expectedAnswers:c.expectedMap??null,answers:c.answerMap??null,correct:c.correct,maskBase64:B.length?ua(B):null,values:fe??null,checkMode:ue,compareMode:sa,minCorrectness:Mt},A=new TextEncoder().encode(JSON.stringify(ie)),se=M.cardType==="info"?"info":"connection",we=c.overrideCheckType??M.checkType??null,Ke=c.overrideDirection??M.direction??null;Xa({itemType:se,itemId:M.cardId,checkType:we,direction:Ke,revisionType:m.id,evalType:c.evalType,correct:c.correct,maskBase64:B.length?ua(B):null,payloadBase64:ua(A),personRoleId:K??null}).then(()=>{Na(se,M.cardId,we,Ke),Bt(Ce),Sn(o,K)}).catch(()=>{})},mn=(c,b)=>{const D=Qe.current.get(b);if(D)return Promise.resolve(D);const q=Rt.current.get(b);if(q)return q;const ee=aa({libraryId:o,infoId:c}).then(B=>{var Fe,Ve;const ie=B.payload,A=((Fe=ie.definition)==null?void 0:Fe.graph)??null,se="",we=((Ve=ie.definition)==null?void 0:Ve.answerTemplate)??"",Ke=Vs(A,se,we);if(Ke){const rt={sample:Os(Ke),answerTemplate:we||null};return Qe.current.set(b,rt),rt}return Yn({libraryId:o,infoId:c}).then(tt=>{const rt={sample:tt,answerTemplate:null};return Qe.current.set(b,rt),rt})}).catch(()=>Yn({libraryId:o,infoId:c}).then(B=>{const ie={sample:B,answerTemplate:null};return Qe.current.set(b,ie),ie}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{Rt.current.delete(b)});return Rt.current.set(b,ee),ee},Ia=(c,b)=>{var A;const D=`${be(c)}:${b}`,q=St.current.get(D);if(q)return Promise.resolve(q);const ee=zt.current.get(D);if(ee)return ee;const B=se=>(St.current.set(D,se),se);let ie;if(c.cardType==="vocab"){if(c.checkType==="translation-match")return ie=Promise.resolve(B({prompt:c.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),ie;const se=c.label.split("↔").map(we=>we.trim()).filter(Boolean);if(se.length>=2){const Ke=(c.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",Fe=Ke?se[0]:se[1],Ve=Ke?se[1]:se[0];ie=Promise.resolve(B({prompt:Fe,expectedAnswer:Ve,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else ie=Promise.resolve(B({prompt:c.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(c.cardType==="info"&&c.infoType==="word"){const se=(A=c.description)!=null&&A.startsWith("Language: ")?c.description.replace("Language: ",""):null;ie=Promise.resolve(B({prompt:c.label,expectedAnswer:se,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else c.cardType==="info"&&c.infoType==="computed"?ie=mn(c.cardId,D).then(se=>{var tt,rt;if(!se.sample)return B({prompt:c.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const we=se.sample,Ke=we.expectedAnswers?Object.entries(we.expectedAnswers).map(([lt,ct])=>({key:lt,expected:ct})):[],Fe=Ke.reduce((lt,ct)=>(lt[ct.key]="",lt),{}),Ve=we.expectedAnswerIsSentence&&((tt=we.expectedAnswer)==null?void 0:tt.trim())||null;return B({prompt:we.prompt,expectedAnswer:Ke.length>0?Ve:((rt=we.expectedAnswer)==null?void 0:rt.trim())||null,computedExpected:Ke,computedAnswers:Fe,computedValues:we.values??null,answerTemplate:se.answerTemplate,outputVariables:we.outputVariables??null,variableValues:we.variableValues??null})}).catch(()=>B({prompt:c.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{zt.current.delete(D)}):ie=Promise.resolve(B({prompt:c.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return zt.current.set(D,ie),ie},pa=(c,b,D)=>{const q=Object.keys(c.nodes).length,ee=f.current.size;if(!b){it({title:D,before:c.text,after:"",fragmentId:null,total:q,completed:ee}),He(null),Ze(!0);return}const B=c.nodes[b];if(!B)return;const ie=Dn(c.text,B);it({title:D,before:ie.before,after:ie.after,fragmentId:B.id,total:q,completed:ee}),He(ie.fragment),Ze(!1)},pn=()=>{const c=x.current;c&&it(b=>b&&{...b,total:Object.keys(c.nodes).length,completed:f.current.size})},Qt=()=>{const c=Ce[_+1];c&&Ia(c,_+1)},$=()=>{if(Qt(),M&&M.cardType==="vocab"&&M.checkType==="translation-match"&&P){if(P.pairs.length===0){Me("incorrect"),Ze(!0);return}const B=P.pairs.reduce((Ve,tt)=>(Ve[tt.rightId]=tt.rightLabel,Ve),{});let ie=0;const A={};P.pairs.forEach(Ve=>{const rt=P.selection[Ve.leftId]===Ve.rightId;A[Ve.leftId]=rt?"correct":"incorrect",rt&&(ie+=1)});const se=P.pairs.length||1,we=ie/se,Ke=ie===P.pairs.length;Se(Ve=>({...Ve,...A})),Ke?(Me("correct"),Ze(!0),et(0)):(Me("incorrect"),Ze(!1),et(Ve=>{const tt=Ve+1;return tt>=kt&&(dt(!0),Ze(!0),G(rt=>{if(!rt)return rt;const lt=rt.pairs.reduce((ct,Lt)=>(ct[Lt.leftId]=Lt.rightId,ct),{});return{...rt,selection:lt}})),tt})),Kt(Ke,we);const Fe="connection";Promise.all(P.pairs.map(Ve=>{const tt=P.selection[Ve.leftId]??null,rt=tt?B[tt]:"",lt={left:Ve.leftLabel,expected:Ve.rightLabel,answer:rt,checkType:"translation-match"},ct=new TextEncoder().encode(JSON.stringify(lt));return Xa({itemType:Fe,itemId:Ve.cardId,checkType:"translation-match",direction:null,revisionType:m.id,evalType:"translation-match",correct:tt===Ve.rightId,maskBase64:null,payloadBase64:ua(ct),personRoleId:K??null})})).then(()=>{Na(Fe,M.cardId,M.checkType,M.direction),Sn(o,K)}).catch(()=>{});return}if(Be.length>0){const B=Be.reduce((A,se)=>{const we=W[se.key]??"";return A[se.key]=Ft(we)===Ft(se.expected)?"correct":"incorrect",A},{});Be.every(({key:A,expected:se})=>{const we=W[A]??"";return ue==="exact"&&Ft(we)===Ft(se)})?(Me("correct"),U(B),Ze(!0),et(0),Kt(!0,1),Yt({correct:!0,direction:Oe?`${Oe} -> computed`:"computed",expectedMap:Be.reduce((A,se)=>(A[se.key]=se.expected,A),{}),answerMap:W,evalType:"computed"})):(Me("incorrect"),U(B),Ze(!1),et(A=>{const se=A+1;return se>=kt&&Te&&(dt(!0),Ze(!0)),se}),Kt(!1,0),window.setTimeout(()=>{var se;const A=an(E,Be,Z);A&&Dt.current[A]&&((se=Dt.current[A])==null||se.focus())},40),Yt({correct:!1,direction:Oe?`${Oe} -> computed`:"computed",expectedMap:Be.reduce((A,se)=>(A[se.key]=se.expected,A),{}),answerMap:W,evalType:"computed"}));return}if(M&&M.cardType==="info"&&M.infoType==="citation"&&(at!=null&&at.fragmentId)){if(!Le)return;const B=Ot(M.direction),ie=(B==null?void 0:B.fragmentId)??at.fragmentId,A=Ya(Le,ve,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),se=A.mask,we=A.isCorrect,Ke=A.percent;we?(Q.current[at.fragmentId]=Math.max(Q.current[at.fragmentId]??0,Ke),(Q.current[at.fragmentId]??0)>=Ut&&f.current.add(at.fragmentId),pn(),Me("correct"),U({}),Ze(!0),ft(se),et(0),Ke<100&&kt<=1&&dt(!0),Kt(!0,Ke/100),Yt({correct:!0,direction:`quote:${at.fragmentId}`,expected:Le,answer:ve,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:ie})):(Me("incorrect"),U({}),Ze(!1),ft(se),et(Fe=>{const Ve=Fe+1;return Ve>=kt&&Te&&(dt(!0),Ze(!0)),Ve}),Kt(!1,Ke/100),window.setTimeout(()=>{var Fe;return(Fe=Tt.current)==null?void 0:Fe.focus()},40),Yt({correct:!1,direction:`quote:${at.fragmentId}`,expected:Le,answer:ve,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:ie}));return}if(!Le)return;const c=Ca(Le,ve,sa),b=ue==="exact"&&Ft(ve)===Ft(Le),D=xa(c),q=b||D,ee=ha(c);q?(Me("correct"),U({}),Ze(!0),ft(c),et(0),ee<100&&kt<=1&&dt(!0),Kt(!0,ee/100),Yt({correct:!0,direction:Oe?`${Oe} -> ${Le}`:null,expected:Le,answer:ve,evalType:"text"})):(Me("incorrect"),U({}),Ze(!1),ft(c),et(B=>{const ie=B+1;return ie>=kt&&Te&&(dt(!0),Ze(!0)),ie}),Kt(!1,ee/100),window.setTimeout(()=>{var B;return(B=Tt.current)==null?void 0:B.focus()},40),Yt({correct:!1,direction:Oe?`${Oe} -> ${Le}`:null,expected:Le,answer:ve,evalType:"text"}))},X=c=>{if(Qt(),!Le)return;const b=Ca(Le,c,sa),D=Ft(c)===Ft(Le),q=xa(b),ee=D||q,B=ha(b);ee?(Me("correct"),U({}),Ze(!0),ft(b),et(0),B<100&&kt<=1&&dt(!0),Kt(!0,B/100),Yt({correct:!0,direction:"word->language",expected:Le,answer:c,evalType:"language-select"})):(Me("incorrect"),U({}),Ze(!1),ft(b),et(ie=>{const A=ie+1;return A>=kt&&Te&&(dt(!0),Ze(!0)),A}),Kt(!1,B/100),Yt({correct:!1,direction:"word->language",expected:Le,answer:c,evalType:"language-select"}))},pe=()=>{Qt(),Me("correct"),Ze(!0),et(0),Kt(!0,1),Le&&Yt({correct:!0,direction:"manual",expected:Le,answer:ve,evalType:"manual"})},Ae=()=>{if(Kt(!1,0),M&&M.cardType==="info"&&M.infoType==="citation"){Me(null),Pe(""),dt(!1),U({}),Ze(!1),ft(null),et(0),ce(c=>Math.min(c+1,Ce.length));return}ma()};a.useEffect(()=>{Qt()},[_,Ce]);const Ee=c=>{var D;if(c.key!=="Enter")return;if(c.preventDefault(),c.stopPropagation(),mt){ma();return}const b=Be.find(q=>!(W[q.key]??"").trim());if(b){(D=Dt.current[b.key])==null||D.focus();return}$()},me=t.cogita.library.revision.revealModeAfterIncorrect,Te=Be.length>0||!!Le;return e.jsxs(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,children:[O==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${H.total?Math.min(100,Math.max(0,H.current/H.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:H.total?`${Math.min(H.current,H.total)} / ${H.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:le}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",I).replace("{check}",ge)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),F?e.jsxs(e.Fragment,{children:[e.jsx("a",{className:"cta ghost",href:`${v}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${v}/collections/${y}`,children:t.cogita.library.actions.collectionDetail})]}):e.jsx("a",{className:"cta ghost",href:`${v}/list`,children:t.cogita.library.actions.allCards})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:vt?`${vt.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Jt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Jt.currentLevel??"-"," / ",Jt.levelsCount]}):null,vt?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(vt.correct)).replace("{total}",String(vt.total))}),vt.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(vt.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(Us,{outcomes:ot})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[wt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:wt})}):null,e.jsx(zn,{feedbackToken:De?`${De.kind}-${De.tick}`:Ge?"idle":qe??"idle",children:M?e.jsx(e.Fragment,{children:ga?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(Bn,{copy:t,currentCard:M,currentTypeLabel:At,prompt:Oe,languages:C,answer:ve,onAnswerChange:c=>Pe(b=>tn(b,c,ze)),computedExpected:Be,computedAnswers:W,onComputedAnswerChange:(c,b)=>$e(D=>({...D,[c]:tn(D[c]??"",b,ze)})),answerTemplate:E,outputVariables:Z,variableValues:S,computedFieldFeedback:oe,feedback:qe,canAdvance:mt,quoteContext:at,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:$,onSkip:Ae,onLanguageSelect:X,onMarkReviewed:pe,onAdvance:ma,showCorrectAnswer:nt,setShowCorrectAnswer:dt,onRevealCorrect:()=>Ze(!0),answerMask:Ct,expectedAnswer:Le,hasExpectedAnswer:Te,handleComputedKeyDown:Ee,answerInputRef:Tt,computedInputRefs:Dt,scriptMode:ze,setScriptMode:_e,matchPairs:P==null?void 0:P.pairs,matchLeftOrder:P==null?void 0:P.leftOrder,matchRightOrder:P==null?void 0:P.rightOrder,matchSelection:P==null?void 0:P.selection,matchActiveLeft:P==null?void 0:P.activeLeft,matchActiveRight:P==null?void 0:P.activeRight,matchFeedback:ne,onMatchLeftSelect:gn,onMatchRightSelect:Sa})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:F?`${v}/collections/${y}`:`${v}/list`,children:F?t.cogita.library.actions.collectionDetail:t.cogita.library.actions.allCards})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Wt?`${yt} / ${Wt}`:t.cogita.library.revision.progressUnlimited}),O==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),O==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),O==="ready"&&Ce.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:me}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",kt]})]})]}),Jt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Jt.activeCount," / ",Jt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Jt.counts.map((c,b)=>{const D=b+1,q=Jt.currentLevel===D,ee=Jt.percentages[b]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":q,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:D}),e.jsx("strong",{children:c})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,ee))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[ee.toFixed(1),"%"]})]},`level-${D}`)})})]}):null,ja?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:ja.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:ja.dots.map(c=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,c.value*100))}%`,background:`rgba(${Math.round(255*(1-c.value))}, ${Math.round(200*c.value)}, 80, 0.9)`}},c.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:ja.knownCount})]})]}):null,xt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:hn})]})}):null]})]})]})})})]})]})}const Tn=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],Kr={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},Fr=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Dr=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function zr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,libraryId:o,collectionId:y}){const[l,d]=a.useState(""),[v,w,T]=An([]),[z,m,u]=En([]),[ue,K]=a.useState(null),[p,V]=a.useState(null),[N,Y]=a.useState(null),F=`/#/cogita/library/${o}`;a.useEffect(()=>{on(o,y).then(C=>d(C.name)).catch(()=>d(t.cogita.library.collections.defaultName))},[o,y,t]),a.useEffect(()=>{mi({libraryId:o,collectionId:y}).then(C=>{if(!C.graphId||C.graphId==="00000000-0000-0000-0000-000000000000"){w([]),m([]);return}const Ie=C.nodes.map(ae=>{var ce;const H=ae.payload??{},ye=H.position??{x:120,y:120},_=H.params??{};return{id:ae.nodeId,type:"default",position:ye,data:{nodeType:ae.nodeType,label:((ce=Tn.find(ve=>ve.type===ae.nodeType))==null?void 0:ce.label)??ae.nodeType,params:_}}}),O=C.edges.map(ae=>({id:ae.edgeId,source:ae.fromNodeId,target:ae.toNodeId,sourceHandle:ae.fromPort??void 0,targetHandle:ae.toPort??void 0}));w(Ie),m(O)}).catch(()=>{w([]),m([])})},[o,y,m,w]);const I=a.useMemo(()=>v.find(C=>C.id===ue)??null,[v,ue]),ge=C=>{var H;const Ie=crypto.randomUUID(),O=((H=Tn.find(ye=>ye.type===C))==null?void 0:H.label)??C,ae={...Kr[C]};w(ye=>[...ye,{id:Ie,type:"default",position:{x:120+ye.length*40,y:120+ye.length*40},data:{nodeType:C,label:O,params:ae}}]),K(Ie)},le=a.useCallback(C=>{m(Ie=>Pn({...C,id:crypto.randomUUID()},Ie))},[m]),xe=async()=>{V(null);try{await As({libraryId:o,collectionId:y,nodes:v.map(C=>({nodeId:C.id,nodeType:C.data.nodeType,payload:{position:C.position,params:C.data.params}})),edges:z.map(C=>({edgeId:C.id,fromNodeId:C.source,fromPort:C.sourceHandle??null,toNodeId:C.target,toPort:C.targetHandle??null}))}),V(t.cogita.library.graph.saveSuccess)}catch{V(t.cogita.library.graph.saveFail)}},Ce=async()=>{try{const C=await pi({libraryId:o,collectionId:y});Y(C)}catch{Y(null)}},te=C=>{I&&w(Ie=>Ie.map(O=>O.id===I.id?{...O,data:{...O.data,params:C}}:O))};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${F}/collections/${y}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Ce,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:xe,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Tn.map(C=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>ge(C.type),children:C.label},C.type))}),p?e.jsx("p",{className:"cogita-help",children:p}):null,N&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(N.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(N.connections)).replace("{infos}",String(N.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(nn,{nodes:v,edges:z,onNodesChange:T,onEdgesChange:u,onConnect:le,onNodeClick:(C,Ie)=>K(Ie.id),fitView:!0,children:[e.jsx(sn,{color:"rgba(120,160,200,0.2)"}),e.jsx(rn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),I?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:I.data.label}),I.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(qt,{libraryId:o,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:I.data.params.tagId?{id:I.data.params.tagId,label:I.data.params.tagLabel??"",infoType:"topic"}:null,onChange:C=>te({...I.data.params,tagId:(C==null?void 0:C.id)??null,tagLabel:(C==null?void 0:C.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:I.data.params.scope??"any",onChange:C=>te({...I.data.params,scope:C.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),I.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(qt,{libraryId:o,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:I.data.params.languageId?{id:I.data.params.languageId,label:I.data.params.languageLabel??"",infoType:"language"}:null,onChange:C=>te({...I.data.params,languageId:(C==null?void 0:C.id)??null,languageLabel:(C==null?void 0:C.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:I.data.params.scope??"any",onChange:C=>te({...I.data.params,scope:C.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),I.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:I.data.params.infoType??"word",onChange:C=>te({...I.data.params,infoType:C.target.value}),children:Dr.map(C=>e.jsx("option",{value:C.value,children:C.label},C.value))})]}),e.jsx(qt,{libraryId:o,infoType:I.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:I.data.params.infoId?{id:I.data.params.infoId,label:I.data.params.infoLabel??"",infoType:I.data.params.infoType??"word"}:null,onChange:C=>te({...I.data.params,infoId:(C==null?void 0:C.id)??null,infoLabel:(C==null?void 0:C.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),I.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:I.data.params.connectionType??"translation",onChange:C=>te({...I.data.params,connectionType:C.target.value}),children:Fr.map(C=>e.jsx("option",{value:C.value,children:C.label},C.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:I.data.params.connectionId??"",onChange:C=>te({...I.data.params,connectionId:C.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(I.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const Cn="cogita.preferences",In="cogita.reviewer.preferences",Ws=["library_overview","all_cards","all_collections","all_revisions","storyboards","texts","dependencies","transfer"],Mn={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},all_revisions:{requiresCollection:!0,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},Br=["settings","run","shared"];function _r(t,n=""){const s=t.split("/").filter(Boolean);if(s[0]!=="cogita"||s[1]!=="library")return{};const i=s[2];if(!i)return{};if(!s[3])return{libraryId:i,target:"library_overview"};const r=new URLSearchParams(n),h=r.get("revisionId")??void 0,g=r.get("infoId")??void 0,k=r.get("infoView"),j=k==="cards"?"cards":k==="collections"?"collections":"overview",L=r.get("collectionView")==="overview"?"overview":"infos",o=r.get("collectionAction"),y=r.get("libraryAction"),d=r.get("libraryTarget")==="revisions"?"all_revisions":"all_collections";if(s[3]==="list")return{libraryId:i,target:y==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:h,infoId:g,infoView:j,libraryAction:y==="new-info"?"new-info":void 0};if(s[3]==="detail"||s[3]==="collection")return{libraryId:i,target:"all_cards",cardMode:s[3],revisionId:h,infoId:g,infoView:j};if(s[3]==="new"||s[3]==="add")return{libraryId:i,target:"new_card",revisionId:h,libraryAction:"new-info"};if(s[3]==="edit")return{libraryId:i,target:"new_card",revisionId:h,infoId:s[4]};if(s[3]==="infos"){const w=s[4];return w?s[5]==="checkcards"?{libraryId:i,target:"all_cards",cardMode:"list",revisionId:h,infoId:w,infoView:"cards"}:s[5]==="collections"?{libraryId:i,target:"all_cards",cardMode:"list",revisionId:h,infoId:w,infoView:"collections"}:{libraryId:i,target:"all_cards",cardMode:"list",revisionId:h,infoId:w,infoView:"overview"}:{libraryId:i,target:"all_cards",cardMode:"list",revisionId:h}}if(s[3]==="shared-revisions")return{libraryId:i,target:d,revisionId:h};if(s[3]==="revision"&&s[4]==="run")return{libraryId:i,target:d,revisionView:"run",revisionId:h,infoId:g,infoView:j};if(s[3]==="dependencies")return{libraryId:i,target:"dependencies"};if(s[3]==="transfer")return{libraryId:i,target:"transfer"};if(s[3]==="storyboards")return s[4]==="new"?{libraryId:i,target:"new_storyboard"}:{libraryId:i,target:"storyboards"};if(s[3]==="texts")return s[4]==="new"?{libraryId:i,target:"new_text"}:{libraryId:i,target:"texts"};if(s[3]!=="collections")return{libraryId:i,target:"library_overview"};if(s[4]==="new")return{libraryId:i,target:"new_collection",revisionId:h};const v=s[4];return v?s[5]==="graph"?{libraryId:i,target:d,collectionId:v,revisionId:h,revisionView:"graph"}:s[5]==="shared-revisions"?{libraryId:i,target:d,collectionId:v,revisionId:h,revisionView:"shared"}:s[5]==="revision"?{libraryId:i,target:d,collectionId:v,revisionId:h,revisionView:s[6]==="run"?"run":"settings",collectionView:L}:o==="new-revision"?{libraryId:i,target:d,collectionId:v,revisionId:h,revisionView:"new"}:{libraryId:i,target:d,collectionId:v,revisionId:h,revisionView:"detail",collectionView:L}:o==="new-collection"?{libraryId:i,target:"new_collection",collectionAction:"new-collection"}:{libraryId:i,target:d}}function ks(t,n="library_overview",s,i,r,h,g="overview",k="infos"){const j=(L,o)=>{const y=new URLSearchParams;o!=null&&o.revisionId&&y.set("revisionId",o.revisionId),o!=null&&o.collectionAction&&y.set("collectionAction",o.collectionAction),o!=null&&o.libraryAction&&y.set("libraryAction",o.libraryAction),o!=null&&o.libraryTarget&&y.set("libraryTarget",o.libraryTarget),o!=null&&o.infoId&&y.set("infoId",o.infoId),o!=null&&o.infoView&&(o!=null&&o.infoId)&&y.set("infoView",o.infoView),o!=null&&o.collectionView&&o.collectionView!=="infos"&&y.set("collectionView",o.collectionView);const l=y.toString();return l?`${L}?${l}`:L};if(!t)return"/cogita";if(n==="library_overview")return j(`/cogita/library/${t}`,{revisionId:r});if(n==="all_cards")return h?g==="cards"?j(`/cogita/library/${t}/infos/${h}/checkcards`,{revisionId:r}):g==="collections"?j(`/cogita/library/${t}/infos/${h}/collections`,{revisionId:r}):j(`/cogita/library/${t}/infos/${h}`,{revisionId:r}):j(`/cogita/library/${t}/list`,{revisionId:r,infoId:h,infoView:g});if(n==="new_card")return h?j(`/cogita/library/${t}/edit/${h}`,{revisionId:r}):j(`/cogita/library/${t}/list`,{revisionId:r,libraryAction:"new-info"});if(n==="all_collections"||n==="all_revisions"){const L=n==="all_revisions"?"revisions":void 0;return!s&&i==="run"?j(`/cogita/library/${t}/revision/run`,{revisionId:r,libraryTarget:L}):s?i==="graph"?j(`/cogita/library/${t}/collections/${s}/graph`,{revisionId:r,libraryTarget:L}):i==="settings"?j(`/cogita/library/${t}/collections/${s}/revision`,{revisionId:r,libraryTarget:L}):i==="run"?j(`/cogita/library/${t}/collections/${s}/revision/run`,{revisionId:r,libraryTarget:L}):i==="shared"?j(`/cogita/library/${t}/collections/${s}/shared-revisions`,{revisionId:r,libraryTarget:L}):i==="new"?j(`/cogita/library/${t}/collections/${s}`,{revisionId:r,libraryTarget:L,collectionAction:"new-revision"}):j(`/cogita/library/${t}/collections/${s}`,{revisionId:r,libraryTarget:L,collectionView:k}):j(`/cogita/library/${t}/collections`,{revisionId:r,libraryTarget:L})}return n==="new_collection"?j(`/cogita/library/${t}/collections`,{revisionId:r,collectionAction:"new-collection"}):n==="transfer"?j(`/cogita/library/${t}/transfer`,{revisionId:r}):n==="storyboards"?j(`/cogita/library/${t}/storyboards`,{revisionId:r}):n==="new_storyboard"?j(`/cogita/library/${t}/storyboards/new`,{revisionId:r}):n==="texts"?j(`/cogita/library/${t}/texts`,{revisionId:r}):n==="new_text"?j(`/cogita/library/${t}/texts/new`,{revisionId:r}):n==="dependencies"?j(`/cogita/library/${t}/dependencies`,{revisionId:r}):j(`/cogita/library/${t}`,{revisionId:r})}function da(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function Vr(t){return typeof t=="string"&&Ws.includes(t)}function Or(t,n){var k;if(!t.length)return null;const s=t.filter(j=>n.has(j.roleId)),i=s.length>0?s:t,r=i.map(j=>{var o,y;const L=((y=(o=j.fields.find(l=>l.fieldType==="role_kind"))==null?void 0:o.plainValue)==null?void 0:y.toLowerCase())??"";return{roleId:j.roleId,roleKind:L}}),h=r.find(j=>j.roleKind.includes("master"));if(h)return h.roleId;const g=r.find(j=>j.roleKind.includes("account")||j.roleKind.includes("user"));return g?g.roleId:((k=i[0])==null?void 0:k.roleId)??null}function Ur(t){if(!t)return{version:1,byLibrary:{}};try{const n=JSON.parse(t);return!n||typeof n!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:n.lastLibraryId,byLibrary:n.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function qr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L}){const o=Rn(),y=Ea(),l=a.useMemo(()=>_r(y.pathname,y.search),[y.pathname,y.search]),d=t.cogita.workspace,[v,w]=a.useState([]),[T,z]=a.useState([]),[m,u]=a.useState([]),[ue,K]=a.useState([]),[p,V]=a.useState(void 0),[N,Y]=a.useState("library_overview"),[F,I]=a.useState(void 0),[ge,le]=a.useState(void 0),[xe,Ce]=a.useState("detail"),[te,C]=a.useState(void 0),[Ie,O]=a.useState(!1),[ae,H]=a.useState(!0),[ye,_]=a.useState(!1),[ce,ve]=a.useState(!1),[Pe,qe]=a.useState(null),[Me,Oe]=a.useState(0),[Ye,Le]=a.useState(""),[He,at]=a.useState(""),[it,Be]=a.useState(""),[Ne,W]=a.useState([]),[$e,oe]=a.useState(""),[U,fe]=a.useState(0),[Je,E]=a.useState(null),[R,Z]=a.useState(null),re=a.useRef({version:1,byLibrary:{}}),S=a.useRef(!1),J=a.useRef(!1),P=a.useRef(null),G=a.useMemo(()=>v.find(x=>x.libraryId===p)??null,[v,p]),ne=a.useMemo(()=>T.find(x=>x.collectionId===F)??null,[T,F]),Se=da(y.pathname)==="/cogita/persons";a.useEffect(()=>{if(!p){W([]),oe("");return}let x=!1;return Es({libraryId:p}).then(f=>{if(x)return;const Q=f.filter(M=>(M.roleKind??"").trim().toLowerCase()==="person");W(Q);try{const M=window.localStorage.getItem(In),Qe=(M?JSON.parse(M):{})[p]??"",Rt=Qe&&Q.some(St=>St.roleId===Qe)?Qe:"";oe(Rt)}catch{oe("")}}).catch(()=>{x||(W([]),oe(""))}),()=>{x=!0}},[p,U]),a.useEffect(()=>{if(p)try{const x=window.localStorage.getItem(In),f=x?JSON.parse(x):{};$e?f[p]=$e:delete f[p],window.localStorage.setItem(In,JSON.stringify(f))}catch{}},[p,$e]);const Re=a.useMemo(()=>ue.find(x=>x.revisionId===ge)??null,[ue,ge]),De=a.useMemo(()=>({detail:d.revisions.detail,graph:d.revisions.graph,settings:d.revisions.settings,run:d.revisions.run,shared:d.targets.sharedRevisions,new:d.revisionForm.createAction}),[d.revisions.detail,d.revisions.graph,d.revisions.run,d.revisions.settings,d.targets.sharedRevisions,d.revisionForm.createAction]),ke=a.useMemo(()=>N==="new_card"?"all_cards":N==="new_collection"?"all_collections":N==="new_storyboard"?"storyboards":N==="new_text"?"texts":N,[N]),he=a.useMemo(()=>xe==="new"?"settings":xe,[xe]),de=N==="all_collections"||N==="all_revisions",ze=a.useMemo(()=>N==="new_collection"?"create":de&&F?"selected":"search",[de,F,N]),_e=a.useMemo(()=>l.infoId?"selected":N==="new_card"?"create":"search",[l.infoId,N]),nt=a.useMemo(()=>m.find(x=>x.infoId===l.infoId)??null,[m,l.infoId]),dt=a.useMemo(()=>({library_overview:d.targets.libraryOverview,all_cards:d.targets.allCards,new_card:d.targets.newCard,all_collections:d.targets.allCollections,all_revisions:d.targets.allRevisions,new_collection:d.targets.newCollection,transfer:d.targets.transfer,storyboards:d.targets.storyboards,new_storyboard:d.targets.newStoryboard,texts:d.targets.texts,new_text:d.targets.newText,dependencies:d.targets.dependencies}),[d.targets]),vt=a.useMemo(()=>dt[ke]??ke,[ke,dt]),We=De[he],ot=!!p,bt=a.useMemo(()=>{const x=j==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":j==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return j==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:x},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:x},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:x},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:x},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:x},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:x},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:x},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:x},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:x},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:x},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:x},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:x},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:x},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:j==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:x},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:x},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:x},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:x},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:x},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:x},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:x},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:x},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:x},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:x},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:x},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:x},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:x},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:x},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:x},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:x},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:x},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:x},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:x},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:x},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:x},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:x},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:x},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:x},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:x},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:x},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[j]),wt=bt.length,gt=Math.max(0,Math.min(Me,wt-1)),$t=bt[gt],Et=!!F,Ct=ot&&de,ft=Et&&de,ia=Et&&de&&(he==="settings"||he==="run"||he==="shared"),et=a.useCallback(x=>{const f=!!x.libraryId;let Q=x.target,M=x.collectionId,Ge=x.revisionId,Qe=x.revisionView,Rt=x.infoId,St=x.infoView??l.infoView??"overview",zt=x.collectionView??l.collectionView??"infos";f?Mn[Q].requiresCollection&&!M?(Q=Q==="all_revisions"?"all_revisions":"all_collections",Ge=void 0,Qe="detail"):Q!=="all_collections"&&Q!=="all_revisions"?(M=void 0,Ge=void 0,Q!=="new_card"&&Q!=="all_cards"&&(Rt=void 0,St="overview"),Q!=="new_collection"&&(zt="infos")):Mn[Q].allowsRevision?Br.includes(Qe)||(Ge=void 0):Qe="detail":(Q="library_overview",M=void 0,Ge=void 0,Qe="detail",Rt=void 0,St="overview",zt="infos"),V(x.libraryId),Y(Q),I(M),le(Ge),Ce(Qe),O(!1);const At=da(ks(x.libraryId,Q,M,Qe,Ge,Rt,St,zt));da(`${y.pathname}${y.search}`)!==At&&(P.current=At,o(At))},[y.pathname,y.search,o,l.collectionView,l.infoView]),Tt=a.useMemo(()=>[{key:"library",label:d.layers.library,visible:!0,value:p??"",selectedLabel:(G==null?void 0:G.name)??d.path.noLibrarySelected,disabled:ae||v.length===0,options:v.map(x=>({value:x.libraryId,label:x.name})),emptyOption:d.noLibraryOption,onSelect:x=>{const f=x||void 0;et({libraryId:f,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:d.layers.target,visible:ot,value:ke,selectedLabel:vt,disabled:!ot,options:Ws.map(x=>({value:x,label:dt[x]})),onSelect:x=>{const f=x;et({libraryId:p,target:f,collectionId:F,revisionId:ge,revisionView:xe,infoId:f==="new_card"?l.infoId:void 0})}},{key:"info_mode",label:d.layers.target,visible:ke==="all_cards",value:_e,selectedLabel:_e==="create"?d.infoMode.create:_e==="selected"?(nt==null?void 0:nt.label)??te??t.cogita.library.list.selectedEmpty:d.infoMode.search,disabled:!ot,options:[{value:"search",label:d.infoMode.search},{value:"create",label:d.infoMode.create},...l.infoId?[{value:"selected",label:(nt==null?void 0:nt.label)??te??t.cogita.library.list.selectedEmpty}]:[]],onSelect:x=>{if(x==="selected"){if(!l.infoId)return;et({libraryId:p,target:"all_cards",collectionId:F,revisionId:ge,revisionView:xe,infoId:l.infoId,infoView:"overview"});return}if(x==="create"){et({libraryId:p,target:"new_card",collectionId:F,revisionId:ge,revisionView:xe,infoId:void 0});return}et({libraryId:p,target:"all_cards",collectionId:F,revisionId:ge,revisionView:xe,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:d.layers.target,visible:ke==="all_cards"&&!!l.infoId,value:N==="new_card"&&l.infoId?"edit":l.infoView==="cards"?"cards":l.infoView==="collections"?"collections":"overview",selectedLabel:N==="new_card"&&l.infoId?d.infoActions.edit:l.infoView==="cards"?d.infoActions.seeCards:l.infoView==="collections"?"Kolekcje":d.infoActions.overview,disabled:!ot||!l.infoId,options:[{value:"overview",label:d.infoActions.overview},{value:"edit",label:d.infoActions.edit},{value:"cards",label:d.infoActions.seeCards},{value:"collections",label:"Kolekcje"}],onSelect:x=>{if(l.infoId){if(x==="edit"){et({libraryId:p,target:"new_card",collectionId:F,revisionId:ge,revisionView:xe,infoId:l.infoId});return}if(x==="cards"){et({libraryId:p,target:"all_cards",collectionId:F,revisionId:ge,revisionView:xe,infoId:l.infoId,infoView:"cards"});return}et({libraryId:p,target:"all_cards",collectionId:F,revisionId:ge,revisionView:xe,infoId:l.infoId,infoView:"overview"})}}},{key:"collection_mode",label:d.layers.collection,visible:ot&&(de||N==="new_collection"),value:ze,selectedLabel:ze==="create"?t.cogita.library.actions.createCollection:ze==="selected"?(ne==null?void 0:ne.name)??d.path.noCollectionSelected:t.cogita.library.actions.collections,disabled:!ot,options:[{value:"search",label:t.cogita.library.actions.collections},{value:"create",label:t.cogita.library.actions.createCollection},...F&&ne?[{value:"selected",label:ne.name}]:[]],onSelect:x=>{if(x==="create"){et({libraryId:p,target:"new_collection",collectionId:void 0,revisionId:void 0,revisionView:"detail"});return}if(x==="selected"&&F){et({libraryId:p,target:de?N:"all_collections",collectionId:F,revisionId:ge,revisionView:"detail"});return}if(x==="collections"){et({libraryId:p,target:"all_cards",collectionId:F,revisionId:ge,revisionView:xe,infoId:l.infoId,infoView:"collections"});return}et({libraryId:p,target:de?N:"all_collections",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection",label:d.layers.collection,visible:Ct&&ze!=="create",value:F??"",selectedLabel:(ne==null?void 0:ne.name)??d.path.noCollectionSelected,disabled:!ot||ye||T.length===0,options:T.map(x=>({value:x.collectionId,label:x.name})),emptyOption:d.selectCollectionOption,onSelect:x=>{et({libraryId:p,target:de?N:"all_collections",collectionId:x||void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection_selected_action",label:d.layers.revision,visible:ft,value:he==="graph"?"edit":he==="settings"||he==="run"||he==="shared"?"revisions":(l.collectionView??"infos")==="overview"?"overview":"infos",selectedLabel:he==="graph"?"Edytuj":he==="settings"||he==="run"||he==="shared"?d.targets.allRevisions:(l.collectionView??"infos")==="overview"?"Przegląd":"Informacje",disabled:!F,options:[{value:"overview",label:"Przegląd"},{value:"edit",label:"Edytuj"},{value:"infos",label:"Informacje"},{value:"revisions",label:d.targets.allRevisions}],onSelect:x=>{if(F){if(x==="edit"){et({libraryId:p,target:de?N:"all_collections",collectionId:F,revisionId:void 0,revisionView:"graph"});return}if(x==="revisions"){et({libraryId:p,target:de?N:"all_collections",collectionId:F,revisionId:ge,revisionView:"settings"});return}et({libraryId:p,target:de?N:"all_collections",collectionId:F,revisionId:void 0,revisionView:"detail",infoId:l.infoId,infoView:l.infoView,collectionView:x==="overview"?"overview":"infos"})}}},{key:"revision_entry",label:d.layers.revision,visible:ia,value:ge??"",selectedLabel:(Re==null?void 0:Re.name)??d.status.noRevisions,disabled:!Et||ce||ue.length===0,options:ue.map(x=>({value:x.revisionId,label:x.name})),emptyOption:d.status.noRevisions,onSelect:x=>{et({libraryId:p,target:de?N:"all_collections",collectionId:F,revisionId:x||void 0,revisionView:xe})}}],[T,ye,_e,m,v,ae,et,ue,ce,ne,F,nt,Re,ge,te,Et,ot,G,de,p,We,xe,N,he,ke,vt,Ct,ft,ia,dt,t.cogita.library.list.selectedEmpty,l.infoId,l.infoView,l.collectionView,d.infoActions.edit,d.infoActions.overview,d.infoActions.seeCards,d.layers.collection,d.layers.library,d.layers.revision,d.layers.target,d.noLibraryOption,d.path.noCollectionSelected,d.path.noLibrarySelected,d.selectCollectionOption,d.targets.allRevisions,ze]),Dt=a.useMemo(()=>Tt.filter(x=>x.visible),[Tt]),mt=a.useMemo(()=>Dt.filter(x=>x.key!=="library"&&x.key!=="collection"),[Dt]),Ze=a.useMemo(()=>mt.find(x=>x.key==="target")??null,[mt]),ht=a.useMemo(()=>mt.find(x=>x.key==="info_mode")??null,[mt]),It=a.useMemo(()=>mt.find(x=>x.key==="info_selected_action")??null,[mt]),Nt=a.useMemo(()=>mt.find(x=>x.key==="collection_mode")??null,[mt]),Ue=a.useMemo(()=>mt.find(x=>x.key==="collection_selected_action")??null,[mt]),ut=a.useMemo(()=>mt.find(x=>x.key==="revision_entry")??null,[mt]),jt=a.useCallback((x,f)=>x?e.jsx("div",{className:"cogita-sidebar-actions",children:x.options.map(Q=>e.jsx("button",{type:"button",className:`ghost ${String(x.value)===Q.value?"active":""}`,onClick:()=>x.onSelect(Q.value),disabled:x.disabled,children:Q.label},`${f}:${x.key}:${Q.value}`))}):null,[]),st=a.useMemo(()=>{const x=l.libraryId;if(!x||!y.pathname.startsWith("/cogita/library/"))return null;const f={copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,libraryId:x};if(l.target==="library_overview")return e.jsx(Ri,{...f});if(l.target==="all_cards")return l.infoId&&l.infoView==="cards"?e.jsx(sr,{...f,infoId:l.infoId,selectedReviewerRoleId:$e||null}):e.jsx(Ui,{...f,mode:l.cardMode??"list"});if(l.target==="new_card")return e.jsx(Xi,{...f,editInfoId:l.infoId});if(l.target==="dependencies")return e.jsx(er,{...f});if(l.target==="transfer")return e.jsx(cr,{...f});if(l.target==="storyboards"||l.target==="new_storyboard")return e.jsx(dr,{...f});if(l.target==="texts"||l.target==="new_text")return e.jsx(ur,{...f});if(l.target==="all_collections"||l.target==="all_revisions"){if(!l.collectionId&&l.revisionView==="run")return e.jsx(js,{...f,revisionId:l.revisionId});if(l.collectionId){const Q={...f,collectionId:l.collectionId};return l.revisionView==="graph"?e.jsx(zr,{...Q}):l.revisionView==="shared"?e.jsx(lr,{...f,collectionId:l.collectionId}):l.revisionView==="settings"?e.jsx(Tr,{...Q,revisionId:l.revisionId}):l.revisionView==="run"?e.jsx(js,{...Q,revisionId:l.revisionId}):e.jsx(gr,{...Q})}return e.jsx(hr,{...f})}return l.target==="new_collection"?e.jsx(br,{...f,onCreated:Q=>{et({libraryId:x,target:N==="all_revisions"?"all_revisions":"all_collections",collectionId:Q,revisionId:void 0,revisionView:"graph"})}}):null},[n,et,t,j,y.pathname,o,L,h,k,i,r,l.cardMode,l.collectionId,l.infoId,l.libraryId,l.revisionId,l.revisionView,l.target,g,s,N,$e]);a.useEffect(()=>{let x=!1;return(async()=>{var Q,M,Ge,Qe,Rt;H(!0);try{await fi();const[St,zt,At]=await Promise.all([Ts(),Ls(),bi()]);if(x)return;w(St);const ra=new Set(At.nodes.filter(Mt=>Mt.nodeType==="role"&&Mt.canLink).map(Mt=>Mt.roleId??"")),Wt=Or(zt,ra);if(E(Wt),Wt){const Mt=At.nodes.find(xt=>xt.nodeType==="data"&&xt.roleId===Wt&&(xt.fieldType===Cn||xt.label===Cn));Z((Mt==null?void 0:Mt.dataKeyId)??null),re.current=Ur(Mt==null?void 0:Mt.value)}const yt=(Q=St.find(Mt=>Mt.libraryId===l.libraryId))==null?void 0:Q.libraryId,kt=yt?(Ge=(M=re.current.byLibrary)==null?void 0:M[yt])==null?void 0:Ge.lastTarget:void 0,sa=Vr(kt)?kt:"library_overview";V(yt),Y(l.target??sa),le(l.revisionId??(yt?(Rt=(Qe=re.current.byLibrary)==null?void 0:Qe[yt])==null?void 0:Rt.lastRevisionId:void 0)),Ce(l.revisionView??"detail"),S.current=!0}catch{x||qe(d.status.loadFailed)}finally{x||H(!1)}})(),()=>{x=!0}},[d.status.loadFailed]),a.useLayoutEffect(()=>{if(S.current){if(!l.libraryId){V(void 0),Y(l.target??"library_overview"),I(void 0),le(void 0),Ce("detail");return}l.libraryId&&v.some(x=>x.libraryId===l.libraryId)&&V(l.libraryId),l.target&&Y(l.target),I(l.collectionId),le(l.revisionId),l.revisionView&&Ce(l.revisionView)}},[v,l.collectionId,l.libraryId,l.revisionId,l.revisionView,l.target]),a.useEffect(()=>{if(!p){z([]),I(void 0),u([]),K([]),le(void 0);return}let x=!1;return _(!0),Oa({libraryId:p,limit:200}).then(f=>{var Ge;if(x)return;const Q=f.items;z(Q);const M=(Ge=Q.find(Qe=>Qe.collectionId===l.collectionId))==null?void 0:Ge.collectionId;I(M)}).catch(()=>{x||(z([]),I(void 0))}).finally(()=>{x||_(!1)}),()=>{x=!0}},[l.collectionId,p]),a.useEffect(()=>{if(!p||ke!=="all_cards"&&N!=="new_card"){u([]);return}let x=!1;return Fn({libraryId:p,limit:200}).then(f=>{x||u(f)}).catch(()=>{x||u([])}),()=>{x=!0}},[ke,p,N]),a.useEffect(()=>{if(!p||!F){K([]),le(void 0);return}let x=!1;return ve(!0),Cs({libraryId:p,collectionId:F}).then(f=>{var Ge,Qe,Rt,St;if(x)return;K(f);const Q=(Qe=(Ge=re.current.byLibrary)==null?void 0:Ge[p])==null?void 0:Qe.lastRevisionId,M=((Rt=f.find(zt=>zt.revisionId===l.revisionId))==null?void 0:Rt.revisionId)??((St=f.find(zt=>zt.revisionId===Q))==null?void 0:St.revisionId);le(M)}).catch(()=>{x||(K([]),le(void 0))}).finally(()=>{x||ve(!1)}),()=>{x=!0}},[l.revisionId,F,p]),a.useEffect(()=>{const x=l.infoId;if(!p||!x){C(void 0);return}let f=!1;return aa({libraryId:p,infoId:x}).then(Q=>{if(f)return;const M=Q.payload;C((M==null?void 0:M.label)??(M==null?void 0:M.name)??(M==null?void 0:M.title)??Q.infoId)}).catch(()=>{f||C(x)}),()=>{f=!0}},[l.infoId,p]),a.useEffect(()=>{if(!S.current||l.libraryId&&v.some(Ge=>Ge.libraryId===l.libraryId)&&l.libraryId!==p||l.target&&l.target!==N||l.revisionView&&l.revisionView!==xe||l.revisionId&&l.revisionId!==ge||Mn[N].requiresCollection&&!F&&(l.target==="all_collections"||l.target==="all_revisions")&&l.collectionId)return;const x=da(`${y.pathname}${y.search}`);if(da(y.pathname)==="/cogita"&&!l.libraryId&&!p){P.current=null;return}if(da(y.pathname)==="/cogita/persons"){P.current=null;return}if(da(y.pathname)===`/cogita/library/${p}/revision/run`&&l.revisionView==="run"&&!l.collectionId&&(N==="all_collections"||N==="all_revisions")&&xe==="run"&&!F){P.current=null;return}const M=da(ks(p,N,F,xe,ge,l.infoId,l.infoView??"overview",l.collectionView??"infos"));if(x===M){P.current=null;return}P.current!==M&&(P.current=M,o(M,{replace:!0}))},[v,y.pathname,y.search,o,l.collectionId,l.infoId,l.infoView,l.collectionView,l.libraryId,l.revisionId,l.revisionView,l.target,F,p,ge,xe,N]),a.useEffect(()=>{if(typeof window>"u")return;const x=()=>{window.innerWidth>920&&O(!1)};return window.addEventListener("resize",x),()=>window.removeEventListener("resize",x)},[]),a.useEffect(()=>{if(!S.current||!Je||!p||J.current)return;const x=re.current,f={...x.byLibrary??{}},Q={...f[p]??{},lastCollectionId:F,lastRevisionId:ge,lastRevisionView:xe,lastTarget:N},M={version:1,lastLibraryId:p,byLibrary:{...f,[p]:Q}},Ge=JSON.stringify(x),Qe=JSON.stringify(M);if(Ge===Qe)return;re.current=M,J.current=!0,(async()=>{try{if(R)await yi(R,{plainValue:Qe});else{const St=await xi(Je,{itemName:Cn,itemType:"data",plainValue:Qe});Z(St.dataItemId)}}catch{qe(d.status.savePrefsFailed)}finally{J.current=!1}})()},[R,Je,F,p,ge,xe,N,d.status.savePrefsFailed]);const ga=async()=>{const x=Ye.trim();if(!x){qe(t.cogita.user.libraryNameRequired);return}qe(null);try{const f=await wi({name:x});w(Q=>[f,...Q]),V(f.libraryId),Y("library_overview"),I(void 0),Le("")}catch{qe(t.cogita.user.libraryCreateFailed)}},je=async()=>{if(!p||!F){qe(d.status.selectLibraryFirst);return}const x=it.trim();if(!x){qe(d.revisionForm.nameLabel);return}qe(null);try{const f=await vi({libraryId:p,collectionId:F,name:x,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});K(Q=>[f,...Q]),le(f.revisionId),Y(N==="all_revisions"?"all_revisions":"all_collections"),Ce("settings"),Be("")}catch{qe(d.status.loadFailed)}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,headerExtra:e.jsxs("div",{className:"cogita-header-reviewer-actions",children:[e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:$e,disabled:!p,onChange:x=>{const f=x.target.value;if(f==="__new_person__"){o("/cogita/persons");return}oe(f)},children:[e.jsx("option",{value:"",children:p?"No person":"Select library first"}),Ne.map(x=>e.jsx("option",{value:x.roleId,children:x.label},x.roleId)),e.jsx("option",{value:"__new_person__",children:"+ Create new person"})]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>o("/cogita/persons"),children:"Persons"})]}),children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${Ie?"open":""}`,"aria-label":d.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{children:(G==null?void 0:G.name)??d.path.noLibrarySelected}),e.jsx("p",{className:"cogita-sidebar-note",children:G?d.sidebar.libraryActionsHint:d.status.selectLibraryFirst}),jt(Ze,"sidebar"),ht?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.infoActionsHint}),jt(ht,"sidebar"),It?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(nt==null?void 0:nt.label)??te??t.cogita.library.list.selectedEmpty}),e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.selectedInfoActionsHint}),jt(It,"sidebar")]}):null]}):null,Nt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.collectionActionsHint}),jt(Nt,"sidebar"),ne&&Ue?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:ne.name}),jt(Ue,"sidebar"),ut?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(Re==null?void 0:Re.name)??d.status.noRevisions}),jt(ut,"sidebar")]}):null]}):null]}):null]}),e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:d.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:i,children:d.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{k("cogita"),O(!1)},children:d.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:r,children:g?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),Ie?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":d.sidebar.closeMenu,onClick:()=>O(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":d.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>O(x=>!x),"aria-label":Ie?d.sidebar.closeMenu:d.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),Dt.map((x,f)=>e.jsxs("div",{className:"cogita-browser-segment",children:[f>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,x.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":x.label,children:x.selectedLabel}):e.jsxs("select",{"aria-label":x.label,value:x.value,onChange:Q=>x.onSelect(Q.target.value),disabled:x.disabled,children:[x.emptyOption?e.jsx("option",{value:"",children:x.emptyOption}):null,x.options.map(Q=>e.jsx("option",{value:Q.value,children:Q.label},`${x.key}:${Q.value}`))]})]},`menu:${x.key}`))]}),st?e.jsxs(e.Fragment,{children:[(N==="all_collections"||N==="all_revisions")&&F&&xe==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:d.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:d.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:it,onChange:x=>Be(x.target.value),placeholder:d.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:je,children:d.revisionForm.createAction}),Pe?e.jsx("p",{className:"cogita-form-error",children:Pe}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Ps.Provider,{value:!0,children:st})})]}):null,st?null:e.jsxs(e.Fragment,{children:[Se?e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(or,{copy:t,onPersonCreated:x=>{fe(f=>f+1)}})}):null,!p&&!Se?e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:$t.step}),e.jsx("h2",{children:$t.title})]}),e.jsxs("p",{children:[gt+1," / ",wt]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:$t.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:$t.passages.map(x=>e.jsx("p",{children:x},x))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:$t.focus.map(x=>e.jsx("span",{children:x},x))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:$t.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:bt.map((x,f)=>e.jsx("button",{type:"button",className:`ghost ${f===gt?"active":""}`,onClick:()=>Oe(f),"aria-label":`${f+1}`,children:f+1},`tutorial:${x.title}:${f}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:gt===0,onClick:()=>Oe(x=>Math.max(0,x-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:gt===wt-1,onClick:()=>Oe(x=>Math.min(wt-1,x+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:Ye,onChange:x=>Le(x.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:ga,children:t.cogita.user.createLibraryAction}),Pe?e.jsx("p",{className:"cogita-form-error",children:Pe}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),v.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,v.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:v.map(x=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{et({libraryId:x.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:x.name})]},x.libraryId))}):null]})]})]}):null]})]})]})})}const Qr=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:qr},Symbol.toStringTag,{value:"Module"}));function Jr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,shareId:o}){const[y,l]=a.useState(null),[d,v]=a.useState("loading"),[w,T]=a.useState(t.cogita.library.collections.defaultName),[z,m]=a.useState("Cogita Library"),[u,ue]=a.useState([]),[K,p]=a.useState([]),[V,N]=a.useState("idle"),[Y,F]=a.useState({current:0,total:0}),[I,ge]=a.useState(0),[le,xe]=a.useState(""),[Ce,te]=a.useState(null),[C,Ie]=a.useState(null),[O,ae]=a.useState(null),[H,ye]=a.useState(null),[_,ce]=a.useState([]),[ve,Pe]=a.useState({}),[qe,Me]=a.useState({}),[Oe,Ye]=a.useState(null),[Le,He]=a.useState(null),[at,it]=a.useState(null),[Be,Ne]=a.useState(null),[W,$e]=a.useState({}),oe=a.useRef(0),[U,fe]=a.useState(null),Je=a.useRef(null),E=a.useRef(null),[R,Z]=a.useState(null),[re,S]=a.useState(!1),[J,P]=a.useState(null),[G,ne]=a.useState([]),[Se,Re]=a.useState(null),De=a.useRef(null),ke=a.useRef(null),[he,de]=a.useState(null),[ze,_e]=a.useState(0),nt=a.useRef(null),dt=a.useRef({}),[vt,We]=a.useState(!1),[ot,bt]=a.useState({}),wt=a.useRef(null),gt=a.useRef(new Set),$t=a.useRef({}),[Et,Ct]=a.useState([]),[ft,ia]=a.useState(new Set),[et,Tt]=a.useState(!1),Dt=Ea(),mt=a.useMemo(()=>new URLSearchParams(Dt.search),[Dt.search]),Ze=a.useMemo(()=>mt.get("key")??"",[mt]),ht=(y==null?void 0:y.mode)??"random",It=(y==null?void 0:y.check)??"exact",Nt=(y==null?void 0:y.limit)??20,Ue=a.useMemo(()=>Un((y==null?void 0:y.revisionType)??ht),[y,ht]),ut=a.useMemo(()=>{const $=y==null?void 0:y.revisionSettings,X=_s(Ue,mt);return dn(Ue,$??X)},[y,mt,Ue]),jt=a.useMemo(()=>t.cogita.library.revision[Ue.labelKey]??ht,[t,ht,Ue]),st=a.useMemo(()=>It==="exact"?t.cogita.library.revision.checkValue:It,[t,It]),je=d==="ready"?u[I]??null:null,x=(je==null?void 0:je.checkType)==="translation-match"&&Be,f=a.useRef(new Map),Q=a.useRef(new Map),M=a.useRef(new Map),Ge=a.useRef(new Map),Qe=a.useMemo(()=>je?je.cardType==="vocab"?t.cogita.library.revision.vocabLabel:je.infoType?Xe(t,je.infoType):t.cogita.library.revision.infoLabel:"",[t,je]),Rt=a.useMemo(()=>{var X;return Ue.id!=="levels"?u.length:((X=ot.pool)==null?void 0:X.length)??Ue.getFetchLimit(Nt,ut)},[ot,ut,Ue,u.length,Nt]),St=Ue.getProgressTotal?Ue.getProgressTotal(u,ot,Nt,ut):Ue.id==="levels"?Math.min(Nt,Rt):u.length,zt=St?Math.min(I+1,St):0,At=Math.max(1,Number(ut.tries??1)),ra=ut.compare??"anchors",Wt=Math.max(0,Math.min(100,Number(ut.minCorrectness??0))),yt=(ut.considerDependencies??"on")==="on",kt=Math.max(0,Math.min(100,Number(ut.dependencyThreshold??85))),sa=$=>{const X=$.slice();for(let pe=X.length-1;pe>0;pe-=1){const Ae=Math.floor(Math.random()*(pe+1));[X[pe],X[Ae]]=[X[Ae],X[pe]]}return X},Mt=$=>ha($,{treatSimilarCharsAsSame:!0})>=Wt,xt=async()=>{const $=await ta(),X=new Map,pe=new Map;$.forEach(me=>{const Te=`${me.itemType}:${me.itemId}`,c=Ht(me.itemType,me.itemId,me.checkType,me.direction);X.has(Te)||X.set(Te,[]),X.get(Te).push(me),pe.has(c)||pe.set(c,[]),pe.get(c).push(me)});const Ae=new Map,Ee=new Map;return X.forEach((me,Te)=>Ae.set(Te,ea(me).score)),pe.forEach((me,Te)=>Ee.set(Te,ea(me).score)),{itemKnowness:Ae,cardKnowness:Ee}},Ut=async $=>{const X=ot,pe=$.concat(X.active??[]).concat(X.pool??[]).filter((q,ee,B)=>B.findIndex(ie=>be(ie)===be(q))===ee);if(!yt){ia(new Set(pe.map(be)));return}const{itemKnowness:Ae,cardKnowness:Ee}=await xt(),me=q=>{if(q.cardType!=="info"||q.infoType!=="citation"||q.checkType!=="quote-fragment")return!0;const ee=Ot(q.direction);if(!(ee!=null&&ee.fragmentId))return!0;const B=q.description??"";if(!B.trim())return!0;const A=ya(B).nodes[ee.fragmentId];if(!A||!A.leftId&&!A.rightId)return!0;const se=[A.leftId,A.rightId].filter(Fe=>!!Fe);if(se.length===0)return!0;const we=se.map(Fe=>{const Ve=Ht("info",q.cardId,"quote-fragment",Fe);return Ee.get(Ve)??0});return we.reduce((Fe,Ve)=>Fe+Ve,0)/we.length>=kt},Te=(y==null?void 0:y.collectionId)??null,c=Te?Et.filter(q=>pt(q.childItemType)==="collection"&&q.childItemId===Te&&!pt(q.childCheckType)&&!pt(q.childDirection)):[],b=Te&&pe.length>0?pe.reduce((q,ee)=>q+(Ee.get(be(ee))??0),0)/pe.length:0,D=new Set;for(const q of pe){if(q.cardType!=="info"){D.add(be(q));continue}if(!me(q))continue;const ee=Et.filter(A=>Hs(A,q)).concat(c);if(ee.length===0){D.add(be(q));continue}let B=0;for(const A of ee)if(pt(A.parentItemType)==="collection")B+=A.parentItemId===Te?b:0;else if(pt(A.parentCheckType)||pt(A.parentDirection)){const se=pt(A.parentCheckType),we=pt(A.parentDirection),Ke=Ht(A.parentItemType,A.parentItemId,se,we);B+=Ee.get(Ke)??0}else{const se=`${A.parentItemType}:${A.parentItemId}`;B+=Ae.get(se)??0}B/ee.length>=kt&&D.add(be(q))}ia(D)},Ka=$=>{for(let X=$;X<u.length;X+=1){const pe=u[X];if(pe&&(!yt||pe.cardType!=="info"||ft.has(be(pe))))return X}return-1},xa=$=>!yt||$.cardType!=="info"||ft.has(be($)),Fa=$=>{if(Ue.id!=="temporal"&&Ue.id!=="levels")return null;const X=ot,pe=(X.active??[]).concat(X.pool??[]),Ae=new Set;for(const Ee of pe){const me=be(Ee);if(!(Ae.has(me)||$.has(me))&&(Ae.add(me),xa(Ee)))return Ee}return null},Gt=a.useMemo(()=>{if(Ue.id!=="levels")return null;const $=ot,X=$.pool??[],pe=$.active??[],Ae=$.levelMap??{},Ee=Math.max(1,Number(ut.levels??1)),me=Array.from({length:Ee},()=>0),Te=new Set(pe.map(q=>be(q)));X.forEach(q=>{const ee=Math.min(Ee,Math.max(1,Ae[be(q)]??1));me[ee-1]+=1});const c=X.length||1,b=me.map(q=>q/c*100),D=je?Ae[be(je)]??1:null;return{counts:me,percentages:b,currentLevel:D,levelsCount:Ee,activeCount:pe.length,poolCount:X.length,activeSet:Te}},[ot,ut,Ue,je]),va=a.useMemo(()=>{if(Ue.id!=="temporal")return null;const $=ot,X=$.pool??[],pe=$.active??[],Ae=$.knownessMap??{},Ee=new Set($.unknownSet??[]);let me=0;X.forEach(b=>{(Ae[be(b)]??0)>1&&(me+=1)});const Te=Ee.size,c=pe.map(b=>({id:be(b),value:Ee.has(be(b))?0:Math.max(0,Math.min(1,Ae[be(b)]??0))}));return{knownCount:me,unknownCount:Te,dots:c}},[ot,Ue]),un=a.useMemo(()=>{if(!yt)return 0;const $=ot;return u.concat($.active??[]).concat($.pool??[]).filter((pe,Ae,Ee)=>Ee.findIndex(me=>be(me)===be(pe))===Ae).filter(pe=>pe.cardType==="info"&&!ft.has(be(pe))).length},[yt,ot,u,ft]);a.useEffect(()=>{if(!yt||V!=="ready")return;const $=ot,pe=u.concat($.active??[]).concat($.pool??[]).filter((me,Te,c)=>c.findIndex(b=>be(b)===be(me))===Te).filter(me=>me.cardType!=="info"||ft.has(be(me))).length,Ae=De.current;if(De.current=pe,Ae===null||pe<=Ae)return;const Ee=pe-Ae;Re(`New card available (+${Ee})`),ke.current&&window.clearTimeout(ke.current),ke.current=window.setTimeout(()=>Re(null),2200)},[yt,V,ot,u,ft]),a.useEffect(()=>()=>{ke.current&&window.clearTimeout(ke.current)},[]);const Bt=($,X)=>{const pe=Ue.applyOutcome({queue:u,meta:ot},je,Nt,ut,{correct:$,correctness:X,createdUtc:new Date().toISOString()});ue(pe.queue),bt(pe.meta);const Ae=pe.queue[I+1];Ae&&Na(Ae,I+1)};a.useEffect(()=>{if(!o){v("error");return}v("loading"),ji({shareId:o,key:Ze}).then($=>{l($),T($.collectionName),m($.libraryName),v("ready")}).catch(()=>{v("error")})},[o,Ze]),a.useEffect(()=>{o&&ki({shareId:o,key:Ze,type:"language"}).then($=>p($)).catch(()=>p([]))},[o,Ze]),a.useEffect(()=>{!o||d!=="ready"||Ni({shareId:o,key:Ze}).then($=>Ct($.items??[])).catch(()=>Ct([]))},[o,Ze,d]),a.useEffect(()=>{if(!o||d!=="ready")return;let $=!0;return(async()=>{N("loading"),F({current:0,total:Ue.id==="levels"?0:Ue.getFetchLimit(Nt,ut)});try{const pe=[];let Ae=null,Ee=null;do{const ee=await Si({shareId:o,key:Ze,limit:300,cursor:Ae});if(pe.push(...ee.items),(Ue.id==="levels"||Ue.id==="temporal")&&ee.total&&(Ee=ee.total),F(B=>({current:pe.length,total:B.total||ee.total||Ue.getFetchLimit(Nt,ut)})),Ae=ee.nextCursor??null,Ee!==null&&pe.length>=Ee||Ue.id!=="levels"&&Ue.id!=="temporal"&&pe.length>=Ue.getFetchLimit(Nt,ut))break}while(Ae);if(!$)return;const me=Ra(pe);let Te;if(Ue.id==="levels"){const ee=Math.max(1,Number(ut.levels??1));Te={},me.forEach(B=>{const ie=be(B);Te[ie]=Math.max(1,Math.min(ee,1))})}let c=null,b=null,D=null;if(Ue.id==="temporal"){const ee=await ta(),B=new Set(me.map(se=>be(se))),ie=ee.reduce((se,we)=>{const Ke=Ht(we.itemType,we.itemId,we.checkType,we.direction);return B.has(Ke)&&(se[Ke]||(se[Ke]=[]),se[Ke].push(we)),se},{});c={},b=new Set,D={};const A=Date.now();me.forEach(se=>{const we=be(se),Ke=ie[we]??[];if(Ke.length===0){c[we]=0,b.add(we),D[we]=[];return}const Fe=_n(Ke);D[we]=Fe;const Ve=ln(Fe,A);c[we]=Ve.knowness})}const q=Ue.id==="levels"?On(me,Nt,ut,Te):Ue.id==="temporal"?Vn(me,Nt,ut,c??{},b??new Set,D??{}):Ue.prepare(me,Nt,ut);ue(q.queue),bt(q.meta),ge(0),N("ready"),F(ee=>({current:Math.min(ee.current,ee.total),total:ee.total}))}catch{$&&N("error")}})(),()=>{$=!1}},[o,Ze,Nt,Ue,ut,d]),a.useEffect(()=>{Ut(u)},[u,Et,yt,kt,y==null?void 0:y.collectionId]),a.useEffect(()=>{if(!je||!yt){Tt(!1);return}if(je.cardType!=="info"||ft.has(be(je))){Tt(!1);return}const $=Ka(I+1);if($>=0){Tt(!1),ge($);return}if(Ue.id==="temporal"||Ue.id==="levels"){const X=u.slice(0,I+1),pe=u.slice(I+1).filter(xa),Ae=X.concat(pe),Ee=new Set(Ae.map(be)),me=Fa(Ee);if(me){const c=be(me);Ee.has(c)||(Ae.push(me),Ee.add(c),bt(b=>{const D=b,q=new Set(D.queued??[]);return q.add(c),{...D,queued:q}}))}const Te=Ae.findIndex((c,b)=>b!==I&&xa(c));if(Te>=0){ue(Ae),ge(Te),Tt(!1);return}}Tt(!0)},[je,ft,yt,I,u,ot,Ue.id]),a.useEffect(()=>{if(xe(""),te(null),de(null),_e(0),ce([]),Pe({}),Me({}),Ye(null),He(null),it(null),S(!1),We(!1),Z(null),Ne(null),$e({}),!je){Ie(null),ae(null);return}je.cardType==="info"&&je.infoType==="computed"&&Ie(t.cogita.library.revision.loadingComputed);let $=!0;return Na(je,I).then(X=>{!$||!X||(Ie(X.prompt),ae(X.expectedAnswer),ce(X.computedExpected),Pe(X.computedAnswers),Ye(X.answerTemplate),He(X.outputVariables),it(X.variableValues))}),()=>{$=!1}},[je,o,t]),a.useEffect(()=>{if(!je||je.cardType!=="info"||je.infoType!=="citation"){wt.current=null,gt.current=new Set,ye(null);return}const $=je.description??"",X=(je.label??"").trim(),pe=X.replace(/\s+/g," ").trim(),Ae=$.replace(/\s+/g," ").trim(),Ee=pe&&pe!==Ae?X:t.cogita.library.infoTypes.citation;if(!$){ye(null),ae(null);return}const me=ya($);wt.current=me,Ie(Ee);let Te=!0;return ta().then(c=>{if(!Te)return;const b=new Map;c.forEach(ie=>{if(ie.itemType!=="info"||ie.checkType!=="quote-fragment"||!ie.direction)return;const A=Ot(ie.direction);if(!A)return;const se=`${ie.itemId}:${A.fragmentId}`;b.has(se)||b.set(se,[]),b.get(se).push(ie)});const D={},q=new Set;b.forEach((ie,A)=>{const[se,we]=A.split(":",2);if(se!==je.cardId)return;const Ke=ea(ie).score;D[we]=Ke,Ke>=kt&&q.add(we)}),gt.current=q,$t.current=D;const ee=Ot(je.direction);if(ee!=null&&ee.fragmentId&&me.nodes[ee.fragmentId]){la(me,ee.fragmentId,Ee);return}const B=Ta(me,q,D,kt,yt,je.direction);la(me,(B==null?void 0:B.id)??null,Ee)}).catch(()=>{gt.current=new Set,$t.current={};const c=Ot(je.direction);if(c!=null&&c.fragmentId&&me.nodes[c.fragmentId]){la(me,c.fragmentId,Ee);return}const b=Ta(me,gt.current,{},kt,yt,je.direction);la(me,(b==null?void 0:b.id)??null,Ee)}),()=>{Te=!1}},[je,t,yt,kt]),a.useEffect(()=>{if(!je||je.cardType!=="vocab"||je.checkType!=="translation-match"){Ne(null),$e({});return}const pe=(ot.pool??ot.active??u).filter(c=>c.cardType==="vocab"&&c.checkType==="translation-match").filter((c,b,D)=>D.findIndex(q=>q.cardId===c.cardId)===b);pe.some(c=>c.cardId===je.cardId)||pe.unshift(je);const Ee=sa(pe).slice(0,6).map(c=>{const b=c.label.split("↔").map(ee=>ee.trim()).filter(Boolean);if(b.length<2)return null;const D=`${c.cardId}:L`,q=`${c.cardId}:R`;return{cardId:c.cardId,leftId:D,rightId:q,leftLabel:b[0],rightLabel:b[1]}}).filter(Boolean),me=Ee.map(c=>c.leftId),Te=sa(Ee.map(c=>c.rightId));Ne({pairs:Ee,leftOrder:me,rightOrder:Te,selection:{},activeLeft:null,activeRight:null,locked:{}})},[je,u,ot]),a.useEffect(()=>()=>{Je.current&&window.clearTimeout(Je.current),E.current&&window.clearTimeout(E.current)},[]);const wa=a.useRef(null);a.useEffect(()=>{if(!je)return;const $=be(je),X=typeof document<"u"?document.activeElement:null;if(wa.current===$&&X&&(X.tagName==="INPUT"||X.tagName==="TEXTAREA"))return;let pe=0;const Ae=()=>{if(je){if(je.cardType==="info"&&je.infoType==="computed"){if(_.length>0){const me=an(Oe,_,Le),Te=me?dt.current[me]:null;if(Te&&(Te.focus(),document.activeElement===Te)){wa.current=$;return}}if(nt.current&&(nt.current.focus(),document.activeElement===nt.current)){wa.current=$;return}}else if(je.cardType==="vocab"&&nt.current&&(nt.current.focus(),document.activeElement===nt.current)){wa.current=$;return}pe<6&&(pe+=1,window.setTimeout(Ae,40))}},Ee=window.setTimeout(Ae,40);return()=>window.clearTimeout(Ee)},[je,_,Oe,Le]),a.useEffect(()=>{if(!vt)return;const $=X=>{X.key==="Enter"&&(X.preventDefault(),Kt())};return window.addEventListener("keydown",$),()=>window.removeEventListener("keydown",$)},[vt]);const oa=$=>{ne($),P(ea($))};a.useEffect(()=>{if(!je){P(null),ne([]);return}const $=je.cardType==="info"?"info":"connection";if(je.cardType==="info"&&je.infoType==="citation"){ta().then(X=>{const pe=X.filter(Ae=>Ae.itemType==="info"&&Ae.itemId===je.cardId&&Ae.checkType==="quote-fragment"&&en(Ae.direction,je.direction));oa(pe)}).catch(()=>{P(null),ne([])});return}Za($,je.cardId,je.checkType,je.direction).then(X=>oa(X)).catch(()=>{P(null),ne([])})},[je]);const Da=($,X,pe,Ae)=>{if($==="info"&&pe==="quote-fragment"){ta().then(Ee=>{const me=Ee.filter(Te=>Te.itemType==="info"&&Te.itemId===X&&Te.checkType==="quote-fragment"&&en(Te.direction,Ae));oa(me)}).catch(()=>{P(null),ne([])});return}Za($,X,pe,Ae).then(Ee=>oa(Ee)).catch(()=>{P(null),ne([])})},Jt=($,X,pe)=>{var Te;const Ae=((Te=pe.pairs.find(c=>c.leftId===$))==null?void 0:Te.rightId)??null;if(!Ae)return pe;const Ee=Ae===X;$e(c=>({...c,[$]:Ee?"correct":"incorrect"})),Je.current&&window.clearTimeout(Je.current),E.current&&window.clearTimeout(E.current),oe.current+=1;const me={kind:Ee?"correct":"incorrect",tick:oe.current};if(fe(null),Je.current=window.setTimeout(()=>fe(me),0),E.current=window.setTimeout(()=>fe(null),420),Ee){const c={...pe.locked,[$]:!0};return Object.keys(c).length>=pe.pairs.length?(te("correct"),We(!0)):te("correct"),{...pe,selection:{...pe.selection,[$]:X},activeLeft:null,activeRight:null,locked:c}}return te("incorrect"),{...pe,activeLeft:null,activeRight:null}},ja=$=>{Ne(X=>!X||X.locked[$]?X:X.activeRight?Jt($,X.activeRight,X):{...X,activeLeft:X.activeLeft===$?null:$})},hn=$=>{Ne(X=>X&&(X.activeLeft?Jt(X.activeLeft,$,X):{...X,activeRight:X.activeRight===$?null:$}))},Kt=()=>{var $;if(je&&je.cardType==="info"&&je.infoType==="citation"&&wt.current&&H&&!(($=Ot(je.direction))!=null&&$.fragmentId)){const X=Ta(wt.current,gt.current,$t.current,kt,yt,je.direction,H.fragmentId);if(X){te(null),xe(""),S(!1),Me({}),We(!1),de(null),_e(0),la(wt.current,X.id,H.title);return}}te(null),xe(""),S(!1),Me({}),We(!1),de(null),_e(0),ge(X=>Math.min(X+1,u.length))},_t=$=>{if(!je)return;const X=$.expected??null,pe=$.answer??"";let Ae=X??"",Ee=pe;if(!X&&$.expectedMap&&$.answerMap){const ee=Object.keys($.expectedMap).sort((B,ie)=>B.localeCompare(ie));Ae=ee.map(B=>{var ie;return((ie=$.expectedMap)==null?void 0:ie[B])??""}).join("|"),Ee=ee.map(B=>{var ie;return((ie=$.answerMap)==null?void 0:ie[B])??""}).join("|")}const me=Ae?Ca(Ae,Ee,ra):new Uint8Array,Te={revisionType:Ue.id,evalType:$.evalType,direction:$.direction,prompt:C??"",expected:X,answer:pe,expectedAnswers:$.expectedMap??null,answers:$.answerMap??null,correct:$.correct,maskBase64:me.length?ua(me):null,checkMode:It,compareMode:ra,minCorrectness:Wt},c=new TextEncoder().encode(JSON.stringify(Te)),b=je.cardType==="info"?"info":"connection",D=$.overrideCheckType??je.checkType??null,q=$.overrideDirection??je.direction??null;Xa({itemType:b,itemId:je.cardId,checkType:D,direction:q,revisionType:Ue.id,evalType:$.evalType,correct:$.correct,maskBase64:me.length?ua(me):null,payloadBase64:ua(c)}).then(()=>{Da(b,je.cardId,D,q),Ut(u)}).catch(()=>{})},ka=($,X)=>{const pe=f.current.get(X);if(pe)return Promise.resolve(pe);const Ae=Q.current.get(X);if(Ae)return Ae;const Ee=Ti({shareCode:o,infoId:$,key:Ze}).then(me=>{var ee,B;const Te=me.payload,c=((ee=Te.definition)==null?void 0:ee.graph)??null,b="",D=((B=Te.definition)==null?void 0:B.answerTemplate)??"",q=Vs(c,b,D);if(q){const A={sample:Os(q),answerTemplate:D||null};return f.current.set(X,A),A}return Qn({shareId:o,infoId:$,key:Ze}).then(ie=>{const A={sample:ie,answerTemplate:null};return f.current.set(X,A),A})}).catch(()=>Qn({shareId:o,infoId:$,key:Ze}).then(me=>{const Te={sample:me,answerTemplate:null};return f.current.set(X,Te),Te}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{Q.current.delete(X)});return Q.current.set(X,Ee),Ee},Na=($,X)=>{var c;const pe=`${be($)}:${X}`,Ae=M.current.get(pe);if(Ae)return Promise.resolve(Ae);const Ee=Ge.current.get(pe);if(Ee)return Ee;const me=b=>(M.current.set(pe,b),b);let Te;if($.cardType==="vocab"){if($.checkType==="translation-match")return Te=Promise.resolve(me({prompt:$.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),Te;const b=$.label.split("↔").map(D=>D.trim()).filter(Boolean);if(b.length>=2){const q=($.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",ee=q?b[0]:b[1],B=q?b[1]:b[0];Te=Promise.resolve(me({prompt:ee,expectedAnswer:B,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else Te=Promise.resolve(me({prompt:$.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if($.cardType==="info"&&$.infoType==="word"){const b=(c=$.description)!=null&&c.startsWith("Language: ")?$.description.replace("Language: ",""):null;Te=Promise.resolve(me({prompt:$.label,expectedAnswer:b,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else $.cardType==="info"&&$.infoType==="computed"?Te=ka($.cardId,pe).then(b=>{var ie,A;if(!b.sample)return me({prompt:$.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const D=b.sample,q=D.expectedAnswers?Object.entries(D.expectedAnswers).map(([se,we])=>({key:se,expected:we})):[],ee=q.reduce((se,we)=>(se[we.key]="",se),{}),B=D.expectedAnswerIsSentence&&((ie=D.expectedAnswer)==null?void 0:ie.trim())||null;return me({prompt:D.prompt,expectedAnswer:q.length>0?B:((A=D.expectedAnswer)==null?void 0:A.trim())||null,computedExpected:q,computedAnswers:ee,answerTemplate:b.answerTemplate,outputVariables:D.outputVariables??null,variableValues:D.variableValues??null})}).catch(()=>me({prompt:$.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Ge.current.delete(pe)}):Te=Promise.resolve(me({prompt:$.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return Ge.current.set(pe,Te),Te},la=($,X,pe)=>{const Ae=Object.keys($.nodes).length,Ee=gt.current.size;if(!X){ye({title:pe,before:$.text,after:"",fragmentId:null,total:Ae,completed:Ee}),ae(null),We(!0);return}const me=$.nodes[X];if(!me)return;const Te=Dn($.text,me);ye({title:pe,before:Te.before,after:Te.after,fragmentId:me.id,total:Ae,completed:Ee}),ae(Te.fragment),We(!1)},gn=()=>{const $=wt.current;$&&ye(X=>X&&{...X,total:Object.keys($.nodes).length,completed:gt.current.size})},Sa=()=>{const $=u[I+1];$&&Na($,I+1)},ma=()=>{if(Sa(),je&&je.cardType==="vocab"&&je.checkType==="translation-match"&&Be){if(Be.pairs.length===0){te("incorrect"),We(!0);return}const me=Be.pairs.reduce((B,ie)=>(B[ie.rightId]=ie.rightLabel,B),{});let Te=0;const c={};Be.pairs.forEach(B=>{const A=Be.selection[B.leftId]===B.rightId;c[B.leftId]=A?"correct":"incorrect",A&&(Te+=1)});const b=Be.pairs.length||1,D=Te/b,q=Te===Be.pairs.length;$e(B=>({...B,...c})),q?(te("correct"),We(!0),_e(0)):(te("incorrect"),We(!1),_e(B=>{const ie=B+1;return ie>=At&&(S(!0),We(!0),Ne(A=>{if(!A)return A;const se=A.pairs.reduce((we,Ke)=>(we[Ke.leftId]=Ke.rightId,we),{});return{...A,selection:se}})),ie})),Bt(q,D);const ee="connection";Promise.all(Be.pairs.map(B=>{const ie=Be.selection[B.leftId]??null,A=ie?me[ie]:"",se={left:B.leftLabel,expected:B.rightLabel,answer:A,checkType:"translation-match"},we=new TextEncoder().encode(JSON.stringify(se));return Xa({itemType:ee,itemId:B.cardId,checkType:"translation-match",direction:null,revisionType:Ue.id,evalType:"translation-match",correct:ie===B.rightId,maskBase64:null,payloadBase64:ua(we)})})).then(()=>{Da(ee,je.cardId,je.checkType,je.direction),Ut(u)}).catch(()=>{});return}if(_.length>0){const me=_.reduce((c,b)=>{const D=ve[b.key]??"";return c[b.key]=Ft(D)===Ft(b.expected)?"correct":"incorrect",c},{});_.every(({key:c,expected:b})=>{const D=ve[c]??"";return It==="exact"&&Ft(D)===Ft(b)})?(te("correct"),Me(me),We(!0),_e(0),Bt(!0,1),_t({correct:!0,direction:C?`${C} -> computed`:"computed",expectedMap:_.reduce((c,b)=>(c[b.key]=b.expected,c),{}),answerMap:ve,evalType:"computed"})):(te("incorrect"),Me(me),We(!1),_e(c=>{const b=c+1;return b>=At&&Qt&&(S(!0),We(!0)),b}),Bt(!1,0),window.setTimeout(()=>{var b;const c=an(Oe,_,Le);c&&dt.current[c]&&((b=dt.current[c])==null||b.focus())},40),_t({correct:!1,direction:C?`${C} -> computed`:"computed",expectedMap:_.reduce((c,b)=>(c[b.key]=b.expected,c),{}),answerMap:ve,evalType:"computed"}));return}if(je&&je.cardType==="info"&&je.infoType==="citation"&&(H!=null&&H.fragmentId)){if(!O)return;const me=Ot(je.direction),Te=(me==null?void 0:me.fragmentId)??H.fragmentId,c=Ya(O,le,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),b=c.mask,D=c.isCorrect,q=c.percent;D?($t.current[H.fragmentId]=Math.max($t.current[H.fragmentId]??0,q),($t.current[H.fragmentId]??0)>=kt&&gt.current.add(H.fragmentId),gn(),te("correct"),Me({}),We(!0),de(b),_e(0),q<100&&At<=1&&S(!0),Bt(!0,q/100),_t({correct:!0,direction:`quote:${H.fragmentId}`,expected:O,answer:le,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Te})):(te("incorrect"),Me({}),We(!1),de(b),_e(ee=>{const B=ee+1;return B>=At&&Qt&&(S(!0),We(!0)),B}),Bt(!1,q/100),window.setTimeout(()=>{var ee;return(ee=nt.current)==null?void 0:ee.focus()},40),_t({correct:!1,direction:`quote:${H.fragmentId}`,expected:O,answer:le,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Te}));return}if(!O)return;const $=Ca(O,le,ra),X=It==="exact"&&Ft(le)===Ft(O),pe=Mt($),Ae=X||pe,Ee=ha($);Ae?(te("correct"),Me({}),We(!0),de($),_e(0),Ee<100&&At<=1&&S(!0),Bt(!0,Ee/100),_t({correct:!0,direction:C?`${C} -> ${O}`:null,expected:O,answer:le,evalType:"text"})):(te("incorrect"),Me({}),We(!1),de($),_e(me=>{const Te=me+1;return Te>=At&&Qt&&(S(!0),We(!0)),Te}),Bt(!1,Ee/100),window.setTimeout(()=>{var me;return(me=nt.current)==null?void 0:me.focus()},40),_t({correct:!1,direction:C?`${C} -> ${O}`:null,expected:O,answer:le,evalType:"text"}))},Yt=$=>{if(Sa(),!O)return;const X=Ca(O,$,ra),pe=Ft($)===Ft(O),Ae=Mt(X),Ee=pe||Ae,me=ha(X);Ee?(te("correct"),Me({}),We(!0),de(X),_e(0),me<100&&At<=1&&S(!0),Bt(!0,me/100),_t({correct:!0,direction:"word->language",expected:O,answer:$,evalType:"language-select"})):(te("incorrect"),Me({}),We(!1),de(X),_e(Te=>{const c=Te+1;return c>=At&&Qt&&(S(!0),We(!0)),c}),Bt(!1,me/100),_t({correct:!1,direction:"word->language",expected:O,answer:$,evalType:"language-select"}))},mn=$=>{var pe;if($.key!=="Enter")return;if($.preventDefault(),$.stopPropagation(),vt){Kt();return}const X=_.find(Ae=>!(ve[Ae.key]??"").trim());if(X){(pe=dt.current[X.key])==null||pe.focus();return}ma()},Ia=()=>{Sa(),te("correct"),We(!0),_e(0),Bt(!0,1),O&&_t({correct:!0,direction:"manual",expected:O,answer:le,evalType:"manual"})},pa=()=>{if(Bt(!1,0),je&&je.cardType==="info"&&je.infoType==="citation"){te(null),xe(""),S(!1),Me({}),We(!1),de(null),_e(0),ge($=>Math.min($+1,u.length));return}Kt()};a.useEffect(()=>{Sa()},[I,u]);const pn=t.cogita.library.revision.revealModeAfterIncorrect,Qt=_.length>0||!!O;return e.jsxs(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:h,secureMode:g,onNavigate:k,language:j,onLanguageChange:L,children:[(d==="loading"||V==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:d==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${Y.total?Math.min(100,Math.max(0,Y.current/Y.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:Y.total?`${Math.min(Y.current,Y.total)} / ${Y.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:w}),e.jsx("p",{className:"cogita-library-subtitle",children:z}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",jt).replace("{check}",st)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:J?`${J.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Gt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Gt.currentLevel??"-"," / ",Gt.levelsCount]}):null,J?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(J.correct)).replace("{total}",String(J.total))}),J.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(J.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(Us,{outcomes:G})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[Se?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:Se})}):null,e.jsx(zn,{feedbackToken:U?`${U.kind}-${U.tick}`:x?"idle":Ce??"idle",children:d!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:d==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):je?e.jsx(e.Fragment,{children:et?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(Bn,{copy:t,currentCard:je,currentTypeLabel:Qe,prompt:C,languages:K,answer:le,onAnswerChange:$=>xe(X=>tn(X,$,R)),computedExpected:_,computedAnswers:ve,onComputedAnswerChange:($,X)=>Pe(pe=>({...pe,[$]:tn(pe[$]??"",X,R)})),answerTemplate:Oe,outputVariables:Le,variableValues:at,computedFieldFeedback:qe,feedback:Ce,canAdvance:vt,quoteContext:H,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:ma,onSkip:pa,onLanguageSelect:Yt,onMarkReviewed:Ia,onAdvance:Kt,showCorrectAnswer:re,setShowCorrectAnswer:S,onRevealCorrect:()=>We(!0),answerMask:he,expectedAnswer:O,hasExpectedAnswer:Qt,handleComputedKeyDown:mn,answerInputRef:nt,computedInputRefs:dt,scriptMode:R,setScriptMode:Z,matchPairs:Be==null?void 0:Be.pairs,matchLeftOrder:Be==null?void 0:Be.leftOrder,matchRightOrder:Be==null?void 0:Be.rightOrder,matchSelection:Be==null?void 0:Be.selection,matchActiveLeft:Be==null?void 0:Be.activeLeft,matchActiveRight:Be==null?void 0:Be.activeRight,matchFeedback:W,onMatchLeftSelect:ja,onMatchRightSelect:hn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:St?`${zt} / ${St}`:t.cogita.library.revision.progressUnlimited}),d==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),d==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),d==="ready"&&V==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),d==="ready"&&V==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),d==="ready"&&V==="ready"&&u.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:pn}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",At]})]})]}),Gt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Gt.activeCount," / ",Gt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Gt.counts.map(($,X)=>{const pe=X+1,Ae=Gt.currentLevel===pe,Ee=Gt.percentages[X]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":Ae,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:pe}),e.jsx("strong",{children:$})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,Ee))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[Ee.toFixed(1),"%"]})]},`level-${pe}`)})})]}):null,va?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:va.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:va.dots.map($=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-$.value))}, ${Math.round(200*$.value)}, 80, 0.9)`}},$.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:va.knownCount})]})]}):null,yt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:un})]})}):null]})]})]})})})]})]})}const Xr=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:Jr},Symbol.toStringTag,{value:"Module"}));export{Yr as C,Qr as a,Xr as b};
