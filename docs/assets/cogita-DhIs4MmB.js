import{r as n,j as e,u as mn,a as Ja,b as Hn,c as Wn,d as Qn,R as pn,B as fn,C as bn,Q as mr}from"./vendor-CAC2WLor.js";import{L as qs,A as Us,g as Js,a as pr,b as Oa,c as Gn,s as ls,d as Yn,e as fr,f as In,h as ta,i as br,j as yr,k as tn,l as an,m as Hs,n as Xn,o as qn,p as xr,u as cs,q as Ws,r as vr,t as wr,v as jr,w as kr,x as Nr,y as Qs,z as Sr,B as Gs,C as Ys,D as Tr,E as Cr,F as yn,G as qa,H as Ir,I as Xs,J as Mr,K as Zn,M as Zs,N as Lr,O as Ar,P as $r,Q as Un,R as ya,S as Rr,T as Pr,U as Er,V as Kr,W as Fr,X as _r,Y as Dr,Z as Br,_ as zr,$ as Vr,a0 as Or,a1 as ds,a2 as qr,a3 as us,a4 as Ur,a5 as Jr,a6 as Hr,a7 as Wr,a8 as hs,a9 as Qr,aa as Gr}from"./recreatio-core-_9JRyGgV.js";import"./vendor-cogita-ui-DTaQ_FiW.js";const Ba={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},Fa={moveMs:900,pauseMs:220,errorMs:900},Yr=(t=11)=>{let a=t;const r=()=>(a=(a*1664525+1013904223)%4294967296,a/4294967296),{width:s,height:i,paddingX:o,paddingY:h,levels:j}=Ba,m=(i-h*2)/(j.length-1),v=[],d=[],b=[];j.forEach((x,y)=>{const ce=i-h-y*m,B=s-o*2,p=[];for(let W=0;W<x;W+=1){const N=o+(W+1)*B/(x+1),ee=(r()-.5)*18,U=Math.max(o,Math.min(s-o,N+ee)),R=y===0?3:y<2?2.1:1.4,pe=y===0?"root":`l${y}-${W}`;p.push({id:pe,x:y===0?s/2:U,y:ce,r:R,level:y,role:y===0?"root":void 0})}b.push(p),v.push(...p)});const l=b[b.length-1];if(l!=null&&l.length){const x=l[Math.floor(l.length/2)];x.role="goal",x.r=2}for(let x=1;x<b.length;x+=1){const y=b[x-1];b[x].forEach(B=>{const p=[...y].sort((U,R)=>Math.abs(U.x-B.x)-Math.abs(R.x-B.x)),W=p[0],N=p[1]&&r()<.45?p[1]:null;(N?[W,N]:[W]).forEach(U=>{d.push({from:U.id,to:B.id,key:`${U.id}-${B.id}`})}),r()<.2&&p[2]&&d.push({from:p[2].id,to:B.id,key:`${p[2].id}-${B.id}`})})}const c=new Map;d.forEach(x=>{const y=c.get(x.to)??[];y.push(x.from),c.set(x.to,y)});const w=new Map,g=new Map,S=new Map;d.forEach(x=>{const y=w.get(x.from)??[];y.push(x.key),w.set(x.from,y);const ce=g.get(x.from)??[];ce.push(x.to),g.set(x.from,ce);const B=S.get(x.from)??[];B.push(x.to),S.set(x.from,B);const p=S.get(x.to)??[];p.push(x.from),S.set(x.to,p)});const K=new Map;return v.forEach(x=>{K.set(x.id,x)}),{nodes:v,links:d,parentsById:c,linksByFrom:w,childrenByFrom:g,neighborsById:S,nodesById:K}};function Xr({slides:t,activeIndex:a,introOpen:r,prefersReducedMotion:s,onNext:i,onPrev:o,onSelect:h,onExit:j,onOpen:m,onRegister:v}){const d=a===t.length-1,b=r&&a===0?"entry":"docked",l=t[t.length-1],[c,w]=n.useState(!1),g=n.useMemo(()=>Array.from({length:20},(D,P)=>({src:`/cogita/logo/Cogita${String(P).padStart(2,"0")}.png`,kind:P<=11?"bubble":P<=17?"text":"recreatio"})),[]),S=r&&a===0;n.useEffect(()=>{if(!r){w(!1);return}a>0&&!c&&w(!0)},[a,r,c]);const K=n.useRef(0),x=n.useRef(null),y=n.useMemo(()=>{const D={x:40,y:160},P={x:260,y:48},k=6,T=P.x-D.x,I=D.y-P.y,de=T/k,xe=[.3,.45,.6,.65,1.4,2.2],he=xe.reduce((G,Z)=>G+Z,0),te=xe.map(G=>I*G/he),A=[D];let Y=D.x,re=D.y;for(let G=1;G<=k;G+=1){const Z=(Math.random()-.5)*14,Ae=(Math.random()-.5)*28;Y=Math.max(D.x+G*14,Math.min(P.x-(k-G)*14,Y+de+Z));const ge=te[G-1]??te[te.length-1];re=re-ge+Ae;const be=Math.max(P.y,Math.min(D.y-4,re));A.push({x:Math.round(Y),y:Math.round(be)})}return A[A.length-1]=P,A},[]),ce=n.useMemo(()=>{const I=(he,te,A)=>Math.min(A,Math.max(te,he)),de=y.map(he=>{const te=10+Math.random()*36;return{x:I(he.x,40,260),y:I(he.y-te,40,140)}}),xe=y.map((he,te)=>{var re;const A=12+Math.random()*40,Y=((re=de[te])==null?void 0:re.y)??he.y;return{x:I(he.x,40,260),y:I(Math.max(Y+10,he.y+A),60,170)}});return{upper:de,lower:xe}},[y]),B=n.useMemo(()=>{var P;const D=((P=y[4])==null?void 0:P.x)??260;return Math.max(0,Math.min(240,D-40))},[y]),p=n.useMemo(()=>{var te,A;const D=(Y,re,G)=>Math.min(G,Math.max(re,Y)),P=(Y,re,G)=>y.map((Z,Ae)=>{var We,De;const ge=((We=ce.upper[Ae])==null?void 0:We.y)??Z.y,be=((De=ce.lower[Ae])==null?void 0:De.y)??Z.y,Ve=(Math.random()-.5)*70,nt=Z.y+Y+Ve,He=D(Z.y+re,ge+6,be-6),Xe=D(Z.y+G,ge+6,be-6);return{x:Z.x,y:D(nt,Math.min(He,Xe),Math.max(He,Xe))}}),k=-14+Math.random()*28,T=14+Math.random()*28,I=P(k,-80,12),de=P(T,-12,80);for(let Y=4;Y<y.length;Y+=1){const re=y[Y],G=((te=ce.upper[Y])==null?void 0:te.y)??re.y,Z=((A=ce.lower[Y])==null?void 0:A.y)??re.y;I[Y]={x:re.x,y:D(re.y-12,G+6,Z-6)},de[Y]={x:re.x,y:D(re.y+12,G+6,Z-6)}}const xe=ce.upper.length?ce.upper[ce.upper.length-1].y:40,he=ce.lower.length?ce.lower[ce.lower.length-1].y:170;return I[I.length-1]={x:y[y.length-1].x,y:D(y[y.length-1].y-14,xe,he)},de[de.length-1]={x:y[y.length-1].x,y:D(y[y.length-1].y+12,xe,he)},{higher:I,lower:de}},[y,ce]),W=1e4,N=n.useMemo(()=>{let D=17;const P=()=>(D=(D*1664525+1013904223)%4294967296,D/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((T,I)=>{const de=(P()-.5)*240,xe=(P()-.5)*180,he=(P()-.5)*24;return{id:`card-${I+1}`,throw:{x:`${de.toFixed(0)}px`,y:`${xe.toFixed(0)}px`,rot:`${he.toFixed(1)}deg`},grid:{x:`${T.x}px`,y:`${T.y}px`},delay:`${I*.12}s`}})},[]),ee=n.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[U,R]=n.useState([]),pe=n.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),F=n.useMemo(()=>{const P=[],T=(de,xe)=>de+Math.random()*(xe-de);for(let de=0;de<6;de+=1){let xe=!1;for(let he=0;he<80;he+=1){const te=T(14,86),A=T(10,34);if(P.every(re=>{const G=re.x-te,Z=re.y-A;return Math.hypot(G,Z)>=12})){P.push({x:te,y:A}),xe=!0;break}}xe||P.push({x:T(16,84),y:T(12,32)})}return P.map((de,xe)=>({id:`p${xe+1}`,x:`${de.x.toFixed(1)}%`,y:`${de.y.toFixed(1)}%`,xNum:de.x,yNum:de.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[X,Me]=n.useState(0),[Q,L]=n.useState(0),[$,z]=n.useState([]),H=1e4,V=n.useMemo(()=>{if(F.length<2)return[];const D=xe=>{let he=xe+1831565813;return he=Math.imul(he^he>>>15,he|1),he^=he+Math.imul(he^he>>>7,he|61),((he^he>>>14)>>>0)/4294967296},P=(xe,he)=>Math.floor(D(xe)*he),k=new Set,T=[],I=Math.min(3,F.length);let de=0;for(;T.length<I&&de<30;){de+=1;const xe=P(X*13+de*5,F.length),he=P(X*29+de*7,F.length);if(xe===he)continue;const te=xe<he?`${xe}-${he}`:`${he}-${xe}`;k.has(te)||(k.add(te),T.push({id:`link-${te}`,from:F[xe],to:F[he],delay:`${(de*.35).toFixed(2)}s`}))}return T},[X,F]);n.useEffect(()=>{if(!r||a!==2)return;const D=()=>{const k=N.map(T=>T.id);for(let T=k.length-1;T>0;T-=1){const I=Math.floor(Math.random()*(T+1));[k[T],k[I]]=[k[I],k[T]]}return k.slice(0,4)};R(D());const P=window.setInterval(()=>{R(D())},W);return()=>window.clearInterval(P)},[a,r,N,W]),n.useEffect(()=>{if(!r||a!==3)return;const D=()=>{L(Math.floor(Math.random()*pe.length)),z(F.map(()=>Math.random()<.6?"good":"bad")),Me(k=>k+1)};D();const P=window.setInterval(D,H);return()=>window.clearInterval(P)},[a,r,pe.length,F,H]);const me=n.useMemo(()=>Yr(11),[]),[ne,ae]=n.useState(new Set(["root"])),[ke,Le]=n.useState(new Set),[Ee,$e]=n.useState(new Set),[st,mt]=n.useState({fromId:"root",toId:"root",key:0}),Te=n.useRef(ne),Ge=n.useRef("root"),jt=n.useRef(0),Oe=n.useRef(null),Be=n.useRef(null),rt=n.useRef([]);n.useEffect(()=>{Te.current=ne},[ne]);const ht=n.useMemo(()=>{const D=new Set;return ne.forEach(P=>{const k=me.linksByFrom.get(P);k&&k.forEach(T=>D.add(T))}),D},[ne,me]),et=me.nodesById.get(st.toId)??me.nodesById.get("root"),Ce=et?`${et.x/Ba.width*100}%`:"50%",ze=et?`${et.y/Ba.height*100}%`:"90%";n.useEffect(()=>{if(!r||a!==1||s)return;(()=>{ae(new Set(["root"])),Le(new Set),$e(new Set),mt({fromId:"root",toId:"root",key:0}),Be.current=null,jt.current=0,Ge.current="root",rt.current=[]})();const P=()=>{const T=Ge.current,I=Te.current,xe=(me.childrenByFrom.get(T)??[]).filter(Z=>!I.has(Z));if(xe.length)return xe[Math.floor(Math.random()*xe.length)];if(I.size>=me.nodes.length){const Z=me.neighborsById.get(T)??[];return Z.length?Z[Math.floor(Math.random()*Z.length)]:null}const he=Z=>(me.childrenByFrom.get(Z)??[]).some(ge=>!I.has(ge)),te=[T],A=new Set([T]),Y=new Map;let re=null;for(;te.length;){const Z=te.shift();if(!Z)break;if(Z!==T&&he(Z)){re=Z;break}(me.neighborsById.get(Z)??[]).forEach(ge=>{A.has(ge)||(A.add(ge),Y.set(ge,Z),te.push(ge))})}if(!re)return null;let G=re;for(;Y.get(G)&&Y.get(G)!==T;)G=Y.get(G)??G;return G},k=(T,I)=>{if(T===I){const de=P();de&&k(T,de);return}jt.current+=1,mt({fromId:T,toId:I,key:jt.current}),Ge.current=I,Oe.current=window.setTimeout(()=>{const de=me.parentsById.get(I)??[],xe=Te.current,he=de.filter(re=>!xe.has(re));if(!he.length){const re=new Set(xe);re.add(I),ae(re),Oe.current=window.setTimeout(()=>{for(;rt.current.length;){const Z=rt.current[rt.current.length-1];if(!re.has(Z)){if(Z!==I){k(I,Z);return}break}rt.current.pop()}const G=P();G&&k(I,G)},Fa.pauseMs);return}const te=new Set([I,...he]),A=new Set(he.map(re=>`${re}-${I}`));Le(te),$e(A),rt.current.includes(I)||rt.current.push(I);const Y=he[Math.floor(Math.random()*he.length)];Be.current={fromId:I,toId:Y},Oe.current=window.setTimeout(()=>{Le(new Set),$e(new Set);const re=Be.current;re&&k(re.fromId,re.toId)},Fa.errorMs)},Fa.moveMs)};return Oe.current=window.setTimeout(()=>{const T=P();T&&k(Ge.current,T)},Fa.pauseMs),()=>{Oe.current&&window.clearTimeout(Oe.current)}},[a,r,me,s]);const tt=D=>{if(!r)return;const P=Date.now();P-K.current<520||Math.abs(D.deltaY)<10||(K.current=P,D.deltaY>0?i():o(),D.preventDefault())},E=D=>{if(!r)return;const P=D.touches[0];P&&(x.current={x:P.clientX,y:P.clientY})},M=D=>{if(!r)return;const P=x.current;if(x.current=null,!P)return;const k=D.changedTouches[0];if(!k)return;const T=k.clientX-P.x,I=k.clientY-P.y;Math.abs(I)<40||Math.abs(I)<Math.abs(T)||(I<0?i():o())};return e.jsxs("div",{className:`cogita-intro ${r?"is-open":"is-closed"} ${s?"is-reduced":""} ${d?"is-final":""}`,"data-slide":a+1,onWheel:tt,onTouchStart:E,onTouchEnd:M,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":b,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${S&&!c?"is-entry":""}`,children:g.map((D,P)=>e.jsx("img",{src:D.src,alt:"",className:`cogita-logo-layer ${P===0?"is-base":""} ${D.kind==="text"?"is-text":D.kind==="recreatio"?"is-recreatio":""} ${D.kind==="bubble"?"is-bubble":""}`},D.src))})}),r&&t.map((D,P)=>{const k=P===a;return e.jsxs("section",{className:`cogita-intro-slide slide-${P+1} ${k?"is-active":""}`,"aria-hidden":!k,children:[e.jsxs("div",{className:"cogita-intro-text",children:[D.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:D.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:D.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:D.title}),D.body&&e.jsx("p",{children:D.body.split(`
`).map((T,I)=>e.jsxs("span",{children:[T,I===0&&e.jsx("br",{})]},String(I)))})]}),D.micro&&e.jsx("p",{className:"cogita-intro-micro",children:D.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:d?v:i,children:D.cta}),d&&D.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>h(0),children:D.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[P===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${Ba.width} ${Ba.height}`,preserveAspectRatio:"none",children:[me.links.map(T=>{const I=me.nodesById.get(T.from),de=me.nodesById.get(T.to);if(!I||!de)return null;const xe=ht.has(T.key),he=Ee.has(T.key);return e.jsx("line",{className:`map-link ${xe?"is-active":""} ${he?"is-error":""}`,x1:I.x,y1:I.y,x2:de.x,y2:de.y},T.key)}),me.nodes.map(T=>{const I=ne.has(T.id),de=ke.has(T.id);return e.jsx("circle",{className:`map-node ${T.role?`is-${T.role}`:""} ${I?"is-active":""} ${de?"is-error":""}`,cx:T.x,cy:T.y,r:T.r},T.id)})]}),et&&e.jsx("span",{className:"map-explorer-dot",style:{left:Ce,top:ze,"--move":`${Fa.moveMs}ms`}})]}),P===2&&e.jsx("div",{className:"cogita-index-cards",children:N.map(T=>{const I=U.indexOf(T.id),de=I>=0?ee[I]:null,xe=(de==null?void 0:de.x)??"140px",he=(de==null?void 0:de.y)??"140px",te=I>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":T.throw.x,"--throw-y":T.throw.y,"--throw-rot":T.throw.rot,"--grid-x":T.grid.x,"--grid-y":T.grid.y,"--stack-x":xe,"--stack-y":he,"--stack-opacity":te,"--delay":T.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},T.id)})}),P===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[pe.map((T,I)=>e.jsxs("div",{className:`round-card ${I===Q?"is-active":""}`,style:{"--card-x":T.x,"--card-y":T.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},T.id)),pe[Q]&&e.jsx("span",{className:"round-ring",style:{"--card-x":pe[Q].x,"--card-y":`calc(${pe[Q].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:F.map(T=>e.jsx("span",{className:"player-dot",style:{left:T.x,top:T.y,"--jitter-x":T.jitterX,"--jitter-y":T.jitterY,"--breath-delay":T.delay}},T.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:V.map(T=>e.jsx("line",{className:"round-link",x1:T.from.xNum,y1:T.from.yNum,x2:T.to.xNum,y2:T.to.yNum,style:{"--delay":T.delay}},T.id))}),e.jsx("div",{className:"round-flows",children:F.map((T,I)=>{const de=$[I]??"good",xe=pe[Q];if(!xe)return null;const he=`calc(${xe.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":T.x,"--from-y":T.y,"--to-x":xe.x,"--to-y":he,"--delay":`${I*.12}s`}}),e.jsx("span",{className:`return-dot is-${de}`,style:{"--from-x":xe.x,"--from-y":he,"--to-x":T.x,"--to-y":T.y,"--delay":`${I*.12}s`}}),e.jsx("span",{className:`result-pop is-${de}`,style:{"--at-x":T.x,"--at-y":T.y,"--delay":`${I*.12}s`}})]},`${T.id}-${X}`)})})]},`round-${X}`),P===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${y[0].x} ${y[0].y} L${y[1].x} ${y[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${y[1].x} ${y[1].y} L${y[2].x} ${y[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${y[2].x} ${y[2].y} L${y[3].x} ${y[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${y[3].x} ${y[3].y} L${y[4].x} ${y[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${y[4].x} ${y[4].y} L${y[5].x} ${y[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${y[5].x} ${y[5].y} L${y[6].x} ${y[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${B};${B};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${ce.upper.map((T,I)=>`${I===0?"M":"L"}${T.x} ${T.y}`).join(" ")} ${ce.lower.slice().reverse().map(T=>`L${T.x} ${T.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${ce.upper.map((T,I)=>`${I===0?"M":"L"}${T.x} ${T.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${ce.lower.map((T,I)=>`${I===0?"M":"L"}${T.x} ${T.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[p.higher.slice(0,6).map((T,I)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${I+1}`,d:`M${T.x} ${T.y} L${p.higher[I+1].x} ${p.higher[I+1].y}`,pathLength:"100"},`peer-1-${I}`)),p.lower.slice(0,6).map((T,I)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${I+1}`,d:`M${T.x} ${T.y} L${p.lower[I+1].x} ${p.lower[I+1].y}`,pathLength:"100"},`peer-2-${I}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${y[0].x/300*100}%`,"--p0y":`${y[0].y/200*100}%`,"--p1x":`${y[1].x/300*100}%`,"--p1y":`${y[1].y/200*100}%`,"--p2x":`${y[2].x/300*100}%`,"--p2y":`${y[2].y/200*100}%`,"--p3x":`${y[3].x/300*100}%`,"--p3y":`${y[3].y/200*100}%`,"--p4x":`${y[4].x/300*100}%`,"--p4y":`${y[4].y/200*100}%`,"--p5x":`${y[5].x/300*100}%`,"--p5y":`${y[5].y/200*100}%`,"--p6x":`${y[6].x/300*100}%`,"--p6y":`${y[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${p.higher[0].x/300*100}%`,"--q0y":`${p.higher[0].y/200*100}%`,"--q1x":`${p.higher[1].x/300*100}%`,"--q1y":`${p.higher[1].y/200*100}%`,"--q2x":`${p.higher[2].x/300*100}%`,"--q2y":`${p.higher[2].y/200*100}%`,"--q3x":`${p.higher[3].x/300*100}%`,"--q3y":`${p.higher[3].y/200*100}%`,"--q4x":`${p.higher[4].x/300*100}%`,"--q4y":`${p.higher[4].y/200*100}%`,"--q5x":`${p.higher[5].x/300*100}%`,"--q5y":`${p.higher[5].y/200*100}%`,"--q6x":`${p.higher[6].x/300*100}%`,"--q6y":`${p.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${p.lower[0].x/300*100}%`,"--q0y":`${p.lower[0].y/200*100}%`,"--q1x":`${p.lower[1].x/300*100}%`,"--q1y":`${p.lower[1].y/200*100}%`,"--q2x":`${p.lower[2].x/300*100}%`,"--q2y":`${p.lower[2].y/200*100}%`,"--q3x":`${p.lower[3].x/300*100}%`,"--q3y":`${p.lower[3].y/200*100}%`,"--q4x":`${p.lower[4].x/300*100}%`,"--q4y":`${p.lower[4].y/200*100}%`,"--q5x":`${p.lower[5].x/300*100}%`,"--q5y":`${p.lower[5].y/200*100}%`,"--q6x":`${p.lower[6].x/300*100}%`,"--q6y":`${p.lower[6].y/200*100}%`}})]})})}),P===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),P===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},D.id)}),!r&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:l.title}),l.body&&e.jsx("p",{children:l.body}),l.micro&&e.jsx("p",{className:"cogita-intro-micro",children:l.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,children:l.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:m,children:"Otwórz pokaz"})]})]})})]}),r&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((D,P)=>e.jsx("button",{type:"button",className:`dot ${a===P?"active":""}`,"aria-label":D.title,onClick:()=>h(P)},D.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:j,children:"Pomiń"})]})]})}const Zr=6,ei=4;function ti({copy:t,onAuthAction:a,authLabel:r,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:o,onLogout:h,secureMode:j,onNavigate:m,language:v,onLanguageChange:d}){const b=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}m("home")},l=n.useRef(null),c=n.useRef([]),w=n.useMemo(()=>{let z=Date.now()%2147483647;const H=()=>(z=z*48271%2147483647,z/2147483647);return Array.from({length:Zr},(V,me)=>{const ne=6+H()*8,ae=7+H()*10,ke=6+H()*9,Le=-H()*ne,Ee=-H()*ae,$e=-H()*ke,st=.18+H()*.28,mt=12+H()*18,Te=4+H()*8,Ge=(H()-.5)*3.2,jt=(H()-.5)*3.8,Oe=H()>.5?"alternate":"alternate-reverse",Be=H()>.5?"alternate":"alternate-reverse",rt=H()>.5?"alternate":"alternate-reverse",ht=.18+H()*.42,et=30+H()*60,Ce=-45-H()*38,ze=188+H()*32,tt=.1+H()*.2;return{id:`wave-${me+1}`,style:{"--wave-sway-duration":`${ne}s`,"--wave-scale-duration":`${ae}s`,"--wave-drift-duration":`${ke}s`,"--wave-sway-delay":`${Le}s`,"--wave-scale-delay":`${Ee}s`,"--wave-drift-delay":`${$e}s`,"--wave-sway-dir":Oe,"--wave-scale-dir":Be,"--wave-drift-dir":rt,"--wave-scale":`${st}`,"--wave-shift":`${mt}%`,"--wave-xshift":`${Te}%`,"--wave-x0":`${Ge}%`,"--wave-y0":`${jt}%`,"--wave-opacity":`${ht}`,"--wave-blur":`${et}px`,"--wave-bottom":`${Ce}%`,"--wave-hue":`${ze}`,"--wave-glow":`${tt}`}}})},[]),g=n.useMemo(()=>{let z=Date.now()*3%2147483647;const H=()=>(z=z*48271%2147483647,z/2147483647);return Array.from({length:ei},(V,me)=>{const ne=180+H()*220,ae=220+H()*280,ke=-H()*ne,Le=-H()*ae,Ee=.12+H()*.22,$e=3+H()*7,st=1+H()*3,mt=(H()-.5)*2.8,Te=(H()-.5)*2.2;return{id:`mesh-${me+1}`,seed:1e3+me*991+Math.floor(H()*999),style:{"--mesh-sway-duration":`${ne}s`,"--mesh-drift-duration":`${ae}s`,"--mesh-sway-delay":`${ke}s`,"--mesh-drift-delay":`${Le}s`,"--mesh-scale":`${Ee}`,"--mesh-shift":`${$e}%`,"--mesh-xshift":`${st}%`,"--mesh-x0":`${Te}%`,"--mesh-y0":`${mt}%`}}})},[]),S=n.useMemo(()=>{const z=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],H=t.cogita.introSlides,V=new Map(H.map(me=>[me.id,me]));return z.map(me=>{var ae;const ne=V.get(me.id);return{...me,...ne,title:(ne==null?void 0:ne.title)??"Cogita",cta:(ne==null?void 0:ne.cta)??((ae=t.cogita.introSlides[0])==null?void 0:ae.cta)??t.cogita.loginCta,secondary:ne==null?void 0:ne.secondary}})},[t.cogita.introSlides]),[K,x]=n.useState(0),[y,ce]=n.useState(!0),[B,p]=n.useState(!1),W=S.length-1,N=n.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),ee=n.useCallback(()=>{N(),a()},[N,a]),U=n.useCallback(()=>{ce(!0),x(0)},[]),R=n.useCallback(()=>{ce(!1),x(W)},[W]),pe=n.useCallback(z=>{x(Math.max(0,Math.min(W,z)))},[W]),F=n.useCallback(()=>{K>=W?ee():pe(K+1)},[K,pe,ee,W]),X=n.useCallback(()=>{pe(K-1)},[K,pe]);n.useEffect(()=>{var V;const z=(V=window.matchMedia)==null?void 0:V.call(window,"(prefers-reduced-motion: reduce)");if(!z)return;const H=()=>p(z.matches);return H(),z.addEventListener?(z.addEventListener("change",H),()=>z.removeEventListener("change",H)):(z.addListener(H),()=>z.removeListener(H))},[]),n.useEffect(()=>{if(!y)return;const z=H=>{const V=H.target;if(!V)return;const me=V.tagName;if(!(V.isContentEditable||me==="INPUT"||me==="TEXTAREA"||me==="SELECT"||me==="BUTTON"||me==="A"||V.closest('button, a, [role="button"], [role="link"]'))){if(H.key==="Escape"){R();return}if(H.key==="ArrowLeft"||H.key==="ArrowUp"){X();return}(H.key==="ArrowRight"||H.key==="ArrowDown"||H.code==="Space"||H.key===" ")&&(H.preventDefault(),F())}};return window.addEventListener("keydown",z),()=>window.removeEventListener("keydown",z)},[R,F,X,y]),n.useEffect(()=>{y&&K===W&&N()},[K,y,W,N]),n.useEffect(()=>{const z=l.current;if(!z)return;const H=c.current.filter(Ce=>!!Ce);if(!H.length)return;const V=1,me=.6,ne=.6,ae=Math.max(1,Math.min(V,window.devicePixelRatio||1));let ke=0,Le=0,Ee=me,$e=0,st=0;const mt=Ce=>{let ze=Ce%2147483647;return ze<=0&&(ze+=2147483646),(tt,E)=>{ze=ze*48271%2147483647;const M=ze/2147483647;return tt+M*(E-tt)}},Te={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},Ge=Ce=>{const ze=Math.sin(Ce*12.9898)*43758.5453;return ze-Math.floor(ze)},jt=Ce=>{const ze=Ge(Ce+.1)||1e-4,tt=Ge(Ce+.7)||1e-4;return Math.sqrt(-2*Math.log(ze))*Math.cos(2*Math.PI*tt)},Oe=(Ce,ze)=>{const tt=Math.floor(Ce),E=tt+1,M=Ce-tt,D=M*M*(3-2*M),P=Ge(tt*12.9898+ze*78.233),k=Ge(E*12.9898+ze*78.233);return P+(k-P)*D},Be=Ce=>{const ze=mt(Ce),tt=Math.min(4,Math.max(4,Math.floor(ke/1200*Te.filamentCount)));return Array.from({length:tt},(E,M)=>{const D=Math.max(-1,Math.min(1,jt(Ce+M*.37))),P=Math.min(1,Math.max(0,Ge(Ce+M*1.31))),k=Math.min(Te.depthLayers-1,Math.floor(P*Te.depthLayers));return{seed:ze(0,Math.PI*2)+Ce*.01,offset:D,freqA:Te.freq1*(.75+ze(0,.5)),freqB:Te.freq2*(.75+ze(0,.5)),ampA:Te.amp1*(.6+ze(0,.7)),ampB:Te.amp2*(.6+ze(0,.7)),width:2+M%5*.32,depth:P,layer:k}})},rt=(Ce,ze,tt)=>{const E=Math.max(30,Math.floor(ke*Le/14e4));Ce.save(),Ce.globalAlpha=.6;for(let M=0;M<E;M+=1){const D=Ge(M*9.1+ke*.11)*ze+tt,P=Ge(M*3.7+Le*.23)*Le,k=1.2+Ge(M*5.9)*2.4,T=Ce.createRadialGradient(D,P,0,D,P,k*2);T.addColorStop(0,"rgba(10, 30, 60, 0.45)"),T.addColorStop(1,"rgba(10, 30, 60, 0)"),Ce.fillStyle=T,Ce.beginPath(),Ce.arc(D,P,k*2,0,Math.PI*2),Ce.fill()}Ce.restore()},ht=(Ce,ze)=>{Ce.clearRect(0,0,ke,Le);const tt=Le*Te.waveCenter,E=Te.waveBandPx,M=Te.segments,D=Te.colors.filaments,P=$e||ke,k=0;rt(Ce,P,k),Ce.strokeStyle=D,Ce.lineCap="round",Ce.lineJoin="round";for(let T=0;T<ze.length;T+=1){const I=ze[T],de=I.offset*E*(.85+Ge(I.seed)*.4),xe=1-Math.min(1,Math.abs(de)/E),he=Math.exp(-Math.pow(de/Te.crestThickness,2)),te=I.layer===0?1.1:I.layer===1?.85:.6,A=.35+(1-I.depth)*.65,Y=xe*A*te*(.34+he*.45);Ce.globalAlpha=Y,Ce.lineWidth=I.width*(1+(1-I.depth)*.8);const re=[];for(let Z=0;Z<=M;Z+=1){const Ae=Z/M*P+k,ge=(Oe(Ae*.012,I.seed)-.5)*Te.xJitter,be=Ae+ge,Ve=(Oe(be*I.freqA,I.seed)-.5)*Te.jitterA,nt=(Oe(be*I.freqB,I.seed*1.7)-.5)*Te.jitterB,He=tt+Math.sin(be*I.freqA+I.seed)*I.ampA+Math.sin(be*I.freqB+I.seed*1.3)*I.ampB+de+Ve+nt;re.push({x:be,y:He})}Ce.beginPath(),Ce.moveTo(re[0].x,re[0].y);for(let Z=1;Z<re.length-1;Z+=1){const Ae=(re[Z].x+re[Z+1].x)/2,ge=(re[Z].y+re[Z+1].y)/2;Ce.quadraticCurveTo(re[Z].x,re[Z].y,Ae,ge)}const G=re[re.length-1];Ce.quadraticCurveTo(G.x,G.y,G.x,G.y),Ce.stroke()}Ce.save(),Ce.globalCompositeOperation="lighter",Ce.strokeStyle=Te.colors.glow,Ce.lineCap="round",Ce.lineJoin="round";for(let T=0;T<ze.length;T+=1){const I=ze[T];if(Math.abs(I.offset)*E>Te.crestThickness)continue;const de=Te.glowAlpha*(.7+(1-I.depth)*.6);Ce.globalAlpha=de,Ce.lineWidth=1.6+(1-I.depth)*1.2;const xe=[];for(let te=0;te<=M;te+=1){const A=te/M*P+k,Y=Math.sin(A*.02+I.seed)*3,re=tt+Math.sin(A*I.freqA+I.seed)*I.ampA+Math.sin(A*I.freqB+I.seed*1.3)*I.ampB+I.offset*E*.35+Y;xe.push({x:A,y:re})}Ce.beginPath(),Ce.moveTo(xe[0].x,xe[0].y);for(let te=1;te<xe.length-1;te+=1){const A=(xe[te].x+xe[te+1].x)/2,Y=(xe[te].y+xe[te+1].y)/2;Ce.quadraticCurveTo(xe[te].x,xe[te].y,A,Y)}const he=xe[xe.length-1];Ce.quadraticCurveTo(he.x,he.y,he.x,he.y),Ce.stroke()}Ce.restore()},et=()=>{ke=Math.floor(z.clientWidth),Le=Math.floor(z.clientHeight),$e=Math.floor(ke*1.8),st=Le,Ee=ke<820?ne:me,H.forEach(Ce=>{const ze=Ce.getContext("2d");if(!ze)return;Ce.width=Math.floor($e*ae*Ee),Ce.height=Math.floor(st*ae*Ee),Ce.style.width=`${$e}px`,Ce.style.height=`${st}px`,Ce.style.left=`${-($e-ke)/2}px`,ze.setTransform(ae*Ee,0,0,ae*Ee,0,0);const tt=Number(Ce.dataset.seed||1),E=Be(tt);ht(ze,E)})};return et(),window.addEventListener("resize",et,{passive:!0}),()=>window.removeEventListener("resize",et)},[g]);const Me=S[Math.min(K,S.length-1)],Q=y?Me:S[S.length-1],L=(Q==null?void 0:Q.theme)??S[0].theme,$={"--cogita-bg0":L.bg0,"--cogita-bg1":L.bg1,"--cogita-bg2":L.bg2,"--cogita-bloom":L.bloom,"--cogita-sat":L.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:b,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(qs,{value:v,onChange:d}),e.jsx(Us,{copy:t,label:r,isAuthenticated:s,secureMode:j,onLogin:a,onProfileNavigate:i,onToggleSecureMode:o,onLogout:h,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:l,className:"cogita-section cogita-home",style:$,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[g.map((z,H)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:z.style,"data-seed":z.seed,ref:V=>{c.current[H]=V}},z.id)),w.map(z=>e.jsx("div",{className:"cogita-home-wave",style:z.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},z.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(Xr,{slides:S,activeIndex:K,introOpen:y,prefersReducedMotion:B,onNext:F,onPrev:X,onSelect:pe,onExit:R,onOpen:U,onRegister:ee})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const $o=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:ti},Symbol.toStringTag,{value:"Module"})),er=n.createContext(!1);function Et({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,headerExtra:d,children:b}){if(n.useContext(er))return e.jsx(e.Fragment,{children:b});const c=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}j("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:c,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(qs,{value:m,onChange:v}),e.jsxs("div",{className:"cogita-header-right",children:[d,e.jsx(Us,{copy:t,label:a,isAuthenticated:r,secureMode:h,onLogin:()=>j("home"),onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:b}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function ua(t){const[a,r]=n.useState("Cogita library"),[s,i]=n.useState(null);return n.useEffect(()=>{let o=!1;return Js().then(h=>{if(o)return;const j=h.find(m=>m.libraryId===t);j&&r(j.name)}).catch(()=>{o||r("Cogita library")}),()=>{o=!0}},[t]),n.useEffect(()=>{let o=!1;return pr(t).then(h=>{o||i(h)}).catch(()=>{o||i(null)}),()=>{o=!0}},[t]),{libraryName:a,stats:s}}function gs({slices:t}){const a=t.reduce((s,i)=>s+Math.max(0,i.value),0),r=n.useMemo(()=>{if(a<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let s=0;return`conic-gradient(${t.map(o=>{const j=Math.max(0,o.value)/a*360,m=s,v=s+j;return s=v,`${o.color} ${m}deg ${v}deg`}).join(",")})`},[t,a]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:r}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(s=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:s.color}}),e.jsx("strong",{children:s.value}),e.jsx("small",{children:s.label})]},s.label))})]})}function ai({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,libraryId:d}){const{libraryName:b,stats:l}=ua(d),[c,w]=n.useState("infos"),[g,S]=n.useState(0),[K,x]=n.useState(0),[y,ce]=n.useState(0),B=(l==null?void 0:l.totalInfos)??0,p=(l==null?void 0:l.totalCollections)??0,W=0,N=0,ee=0,U=Math.max(0,B-ee-K),R=Math.max(0,B-K-y);n.useEffect(()=>{let F=!1;return(async()=>{try{const Me=await Oa({libraryId:d,limit:200}),Q=await Promise.all(Me.items.map(L=>Gn({libraryId:d,collectionId:L.collectionId}).catch(()=>[])));if(F)return;S(Q.reduce((L,$)=>L+$.length,0))}catch{F||S(0)}})(),()=>{F=!0}},[d]),n.useEffect(()=>{let F=!1;return(async()=>{try{const[Me,Q,L]=await Promise.all([ls({libraryId:d,type:"computed",limit:1}).catch(()=>({total:0})),ls({libraryId:d,type:"source",limit:1}).catch(()=>({total:0})),Yn({libraryId:d}).catch(()=>({items:[]}))]);if(F)return;x((Me.total??0)+(Q.total??0));const $=new Set(L.items.filter(z=>z.childItemType.toLowerCase()==="info").map(z=>z.childItemId).filter(Boolean));ce($.size)}catch{F||(x(0),ce(0))}})(),()=>{F=!0}},[d]);const pe=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:B},{key:"collections",label:t.cogita.library.overview.stats.collections,value:p},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:g},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:W},{key:"texts",label:t.cogita.library.overview.stats.texts,value:N}];return e.jsx(Et,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:b})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:pe.map(F=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${c===F.key?"active":""}`,onClick:()=>w(F.key),children:[e.jsx("span",{children:F.label}),e.jsx("strong",{children:F.value})]},F.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),c==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(gs,{slices:[{label:t.cogita.library.overview.known,value:ee,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:U,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:K,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(gs,{slices:[{label:t.cogita.library.overview.availableChecks,value:y,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:R,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const ot=(t,a)=>{const r=t.cogita.library.infoTypes,s=t.cogita.library.connectionTypes,i=t.cogita.library.groupTypes;return{any:r.any,vocab:r.vocab,book:i.book,citation:i.citation,language:r.language,word:r.word,sentence:r.sentence,topic:r.topic,collection:r.collection,person:r.person,institution:r.institution,collective:r.collective,orcid:r.orcid,address:r.address,email:r.email,phone:r.phone,media:r.media,work:r.work,geo:r.geo,music_piece:r.musicPiece,music_fragment:r.musicFragment,source:r.source,question:r.question,computed:r.computed,"word-language":s.wordLanguage,"citation-language":s.citationLanguage,"language-sentence":s.languageSentence,translation:s.translation,"word-topic":s.wordTopic,reference:s.reference,"source-resource":s.sourceResource,"work-contributor":s.workContributor,"work-medium":s.workMedium,"orcid-link":s.orcidLink}[a]??String(a)},ni=t=>[{value:"any",label:ot(t,"any")},{value:"language",label:ot(t,"language")},{value:"word",label:ot(t,"word")},{value:"sentence",label:ot(t,"sentence")},{value:"topic",label:ot(t,"topic")},{value:"collection",label:ot(t,"collection")},{value:"person",label:ot(t,"person")},{value:"institution",label:ot(t,"institution")},{value:"collective",label:ot(t,"collective")},{value:"orcid",label:ot(t,"orcid")},{value:"address",label:ot(t,"address")},{value:"email",label:ot(t,"email")},{value:"phone",label:ot(t,"phone")},{value:"media",label:ot(t,"media")},{value:"work",label:ot(t,"work")},{value:"geo",label:ot(t,"geo")},{value:"music_piece",label:ot(t,"music_piece")},{value:"music_fragment",label:ot(t,"music_fragment")},{value:"source",label:ot(t,"source")},{value:"question",label:ot(t,"question")},{value:"citation",label:ot(t,"citation")},{value:"computed",label:ot(t,"computed")},{value:"vocab",label:ot(t,"vocab")},{value:"book",label:ot(t,"book")},{value:"word-language",label:ot(t,"word-language")},{value:"citation-language",label:ot(t,"citation-language")},{value:"language-sentence",label:ot(t,"language-sentence")},{value:"translation",label:ot(t,"translation")},{value:"word-topic",label:ot(t,"word-topic")},{value:"reference",label:ot(t,"reference")},{value:"source-resource",label:ot(t,"source-resource")},{value:"work-contributor",label:ot(t,"work-contributor")},{value:"work-medium",label:ot(t,"work-medium")},{value:"orcid-link",label:ot(t,"orcid-link")}],si=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Mn={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},ri={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Mn]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Mn]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId"]},filterFields:[Mn,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text"],connections:[{relationType:"citation-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"citationText",kind:"text",path:"text",matcher:"contains"}]},question:{infoType:"question",entityKind:"single",structure:{payloadFields:["definition"]},filterFields:[{key:"questionType",labelKey:"type",kind:"text",path:"definition.type",matcher:"contains"},{key:"questionText",labelKey:"text",kind:"text",path:"definition.question",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},ms={infoType:"default",entityKind:"single",structure:{payloadFields:["label"]},filterFields:[]};function ii(t){return t?ri[t]??ms:ms}function oi(t,a){return t.optionsSource==="languages"?a.languages.map(r=>({value:r.infoId,label:r.label})):t.optionsSource==="sourceKinds"?si:[]}const li="cogita.revision.seed:";function tr(t){return`${li}${t}`}function ci(t,a){if(typeof window>"u")return null;const r=Array.from(new Set(a.map(o=>o.trim()).filter(Boolean)));if(!r.length)return null;const s=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,i={kind:"info-selection",libraryId:t,infoIds:r,createdAt:new Date().toISOString()};return window.localStorage.setItem(tr(s),JSON.stringify(i)),s}function ps(t,a){if(typeof window>"u")return null;const r=window.localStorage.getItem(tr(a));if(!r)return null;try{const s=JSON.parse(r);if(s.kind!=="info-selection"||s.libraryId!==t||!Array.isArray(s.infoIds))return null;const i=s.infoIds.map(o=>String(o??"").trim()).filter(Boolean);return i.length?{infoIds:i}:null}catch{return null}}const di="cogita.collection-draft:";function ar(t){return`${di}${t}`}function ui(t,a){if(typeof window>"u")return null;const r=Array.from(new Set(a.map(o=>o.trim()).filter(Boolean)));if(!r.length)return null;const s=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,i={kind:"info-selection",libraryId:t,infoIds:r,createdAt:new Date().toISOString()};return window.localStorage.setItem(ar(s),JSON.stringify(i)),s}function hi(t,a){if(typeof window>"u")return null;const r=window.localStorage.getItem(ar(a));if(!r)return null;try{const s=JSON.parse(r);if(s.kind!=="info-selection"||s.libraryId!==t||!Array.isArray(s.infoIds))return null;const i=s.infoIds.map(o=>String(o??"").trim()).filter(Boolean);return i.length?{infoIds:i}:null}catch{return null}}const Ln=60,gi=500;function nr(t){return`cogita.info-selection:${t}`}function fs(t){if(typeof window>"u")return{};const a=window.localStorage.getItem(nr(t));if(!a)return{};try{const r=JSON.parse(a);return!r||typeof r!="object"?{}:r}catch{return{}}}function mi({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,libraryId:d,mode:b}){var qt;const l=mn(),c=Ja(),w=t.cogita.library.list,[g,S]=n.useState("any"),[K,x]=n.useState(""),[y,ce]=n.useState("relevance"),[B,p]=n.useState("details"),[W,N]=n.useState(!1),[ee,U]=n.useState("idle"),[R,pe]=n.useState([]),[F,X]=n.useState(Ln),[Me,Q]=n.useState(null),[L,$]=n.useState(()=>fs(d)),[z,H]=n.useState({}),[V,me]=n.useState([]),[ne,ae]=n.useState([]),[ke,Le]=n.useState(null),[Ee,$e]=n.useState(null),[st,mt]=n.useState(null),[Te,Ge]=n.useState("idle"),[jt,Oe]=n.useState([]),[Be,rt]=n.useState(""),[ht,et]=n.useState(null),[Ce,ze]=n.useState("idle"),[tt,E]=n.useState(null),[M,D]=n.useState(null),[P,k]=n.useState("idle"),[T,I]=n.useState([]),[de,xe]=n.useState("idle"),he=n.useMemo(()=>ni(t),[t]),te=n.useMemo(()=>[{value:"relevance",label:w.sortRelevance},{value:"label_asc",label:w.sortLabelAsc},{value:"label_desc",label:w.sortLabelDesc},{value:"type_asc",label:w.sortTypeAsc},{value:"type_desc",label:w.sortTypeDesc}],[w.sortLabelAsc,w.sortLabelDesc,w.sortRelevance,w.sortTypeAsc,w.sortTypeDesc]);n.useEffect(()=>{$(fs(d)),H({}),N(!1)},[d]),n.useEffect(()=>{Yn({libraryId:d}).then(O=>mt(O)).catch(()=>mt({items:[]}))},[d]),n.useEffect(()=>{fr({libraryId:d}).then(O=>Oe(O)).catch(()=>Oe([]))},[d]),n.useEffect(()=>{In({libraryId:d,type:"language",filters:{sourceKind:"info"},limit:200}).then(O=>{const u=O.map(ie=>({infoId:ie.infoId??"",infoType:ie.entityType,label:ie.title})).filter(ie=>ie.infoId.length>0);me(u)}).catch(()=>me([]))},[d]),n.useEffect(()=>{In({libraryId:d,type:"source",filters:{sourceKind:"info"},limit:200}).then(O=>{const u=O.map(ie=>({infoId:ie.infoId??"",infoType:ie.entityType,label:ie.title})).filter(ie=>ie.infoId.length>0);ae(u)}).catch(()=>ae([]))},[d]),n.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(nr(d),JSON.stringify(L))},[d,L]);const A=n.useMemo(()=>ii(g==="any"?null:g),[g]),Y=n.useMemo(()=>new URLSearchParams(c.search),[c.search]),re=n.useMemo(()=>c.pathname.split("/").filter(Boolean),[c.pathname]),G=re.findIndex(O=>O==="infos"),Z=G>=0&&(re[G+1]??"").trim()||null,Ae=G>=0?(re[G+2]??"").trim():"",ge=G>=0?Ae==="checkcards"?"cards":Ae==="collections"?"collections":"overview":"",be=Z??((Y.get("infoId")??"").trim()||null),Ve=Z?ge:(Y.get("infoView")??"overview").trim(),nt=Ve==="overview"&&!!be,He=Ve==="collections"&&!!be,Xe=n.useMemo(()=>({language:w.typeFilterLanguage,languageA:w.typeFilterLanguageA,languageB:w.typeFilterLanguageB,originalLanguage:w.typeFilterOriginalLanguage,doi:w.typeFilterDoi,sourceKind:w.typeFilterSourceKind,locator:w.typeFilterLocator,citationText:w.typeFilterCitationText}),[w.typeFilterDoi,w.typeFilterLanguage,w.typeFilterLanguageA,w.typeFilterLanguageB,w.typeFilterLocator,w.typeFilterOriginalLanguage,w.typeFilterCitationText,w.typeFilterSourceKind]),We=n.useMemo(()=>A.filterFields.map(O=>({...O,label:O.labelKey?Xe[O.labelKey]:O.label??O.key,options:oi(O,{languages:V})})),[Xe,V,A.filterFields]),De=n.useMemo(()=>We.some(O=>(z[O.key]??"").trim().length>0),[We,z]);n.useEffect(()=>{H({})},[g]),n.useEffect(()=>{const O={sourceKind:"info"};if(De)for(const J of We){const Ye=(z[J.key]??"").trim();Ye&&(O[J.path??J.key]=Ye)}const u=(z.__referenceId??"").trim();u&&(O["link.references"]=u),U("loading");const ie=window.setTimeout(()=>{In({libraryId:d,type:g==="any"?void 0:g,query:K.trim()||void 0,filters:O,limit:gi}).then(J=>{const Ye=J.map(dt=>({infoId:dt.infoId??"",infoType:dt.entityType,label:dt.title})).filter(dt=>dt.infoId.length>0);pe(Ye),U("ready")}).catch(()=>{pe([]),U("ready")})},240);return()=>window.clearTimeout(ie)},[De,d,K,g,We,z]),n.useEffect(()=>{if(!be||Ve!=="overview"&&Ve!=="collections"){Le(null),$e(null),Ge("idle");return}let O=!1;return Ge("loading"),Promise.all([ta({libraryId:d,infoId:be}),br({libraryId:d,itemType:"info",itemId:be}).catch(()=>null)]).then(([u,ie])=>{O||(Le(u),$e(ie),Ge("ready"))}).catch(()=>{O||(Le(null),$e(null),Ge("error"))}),()=>{O=!0}},[d,be,Ve]),n.useEffect(()=>{if(!be||Ve!=="collections"){I([]),xe("idle");return}let O=!1;return xe("loading"),yr({libraryId:d,infoId:be}).then(u=>{O||(I(u),xe("ready"))}).catch(()=>{O||(I([]),xe("error"))}),()=>{O=!0}},[d,be,Ve]),n.useEffect(()=>{if(!be||Ve!=="overview"){E(null),D(null),k("idle");return}let O=!1;return k("loading"),Promise.all([tn({libraryId:d,infoId:be}),an({libraryId:d,infoId:be})]).then(([u,ie])=>{O||(E(u),D(ie),k("ready"))}).catch(()=>{O||(E(null),D(null),k("error"))}),()=>{O=!0}},[d,be,Ve]);const it=n.useMemo(()=>ke?jt.filter(O=>O.sourceInfoTypes.some(u=>u.toLowerCase()===ke.infoType.toLowerCase())):[],[jt,ke]);n.useEffect(()=>{if(!ke){rt("");return}rt(O=>{var u;return O&&it.some(ie=>ie.approachKey===O)?O:((u=it[0])==null?void 0:u.approachKey)??""})},[it,ke]),n.useEffect(()=>{if(!ke||!Be){et(null),ze("idle");return}let O=!1;return ze("loading"),Hs({libraryId:d,infoId:ke.infoId,approachKey:Be}).then(u=>{O||(et(u),ze("ready"))}).catch(()=>{O||(et(null),ze("error"))}),()=>{O=!0}},[d,Be,ke]);const Ze=n.useMemo(()=>{const O=R.slice(),u=ie=>ot(t,ie);return y==="relevance"?O:y==="label_asc"?O.sort((ie,J)=>ie.label.localeCompare(J.label)):y==="label_desc"?O.sort((ie,J)=>J.label.localeCompare(ie.label)):y==="type_asc"?O.sort((ie,J)=>ie.infoType===J.infoType?ie.label.localeCompare(J.label):u(ie.infoType).localeCompare(u(J.infoType))):O.sort((ie,J)=>ie.infoType===J.infoType?ie.label.localeCompare(J.label):u(J.infoType).localeCompare(u(ie.infoType)))},[t,R,y]),xt=n.useMemo(()=>Ze.slice(0,F),[Ze,F]),Ft=xt.length<Ze.length,Mt=n.useMemo(()=>new Set(Object.keys(L)),[L]),Tt=n.useMemo(()=>Object.values(L),[L]),sa=n.useMemo(()=>{const O=new Map;for(const u of Tt)O.set(u.infoType,(O.get(u.infoType)??0)+1);return Array.from(O.entries()).sort((u,ie)=>ie[1]-u[1]||u[0].localeCompare(ie[0]))},[Tt]),It=n.useMemo(()=>{if(!be||!st)return 0;const O=new Set;for(const u of st.items)u.childItemType!=="info"||u.childItemId!==be||O.add([u.parentItemType,u.parentItemId,u.parentCheckType??"",u.parentDirection??""].join("|"));return O.size},[st,be]);n.useEffect(()=>{X(Ln);const O=new Set(R.map(u=>u.infoId));Q(u=>u&&O.has(u)?u:null)},[R]);const ut=O=>{$(u=>({...u,[O.infoId]:{infoId:O.infoId,infoType:O.infoType,label:O.label}}))},St=O=>{$(u=>{if(!u[O])return u;const ie={...u};return delete ie[O],ie})},kt=(O,u)=>{if(u){ut(O);return}St(O.infoId)},wt=O=>{l(`/cogita/library/${d}/infos/${encodeURIComponent(O)}`,{replace:!0})},_t=()=>{l(`/cogita/library/${d}/list`,{replace:!0})},lt=()=>{be&&l(`/cogita/library/${d}/edit/${encodeURIComponent(be)}`,{replace:!0})},Je=()=>{const O=ci(d,Tt.map(u=>u.infoId));O&&l(`/cogita/library/${d}/revision/run?libraryTarget=revisions&scope=info-selection&seed=${encodeURIComponent(O)}`)},vt=()=>{const O=ui(d,Tt.map(u=>u.infoId));O&&l(`/cogita/library/${d}/collections/new?draft=${encodeURIComponent(O)}&draftType=info-selection`)},Qt=Tt.length===1?((qt=Tt[0])==null?void 0:qt.infoId)??null:null,Ot=w.selectionCount.replace("{count}",String(Tt.length)),zt=b==="collection"?"grid":b==="detail"?"wide":B,fe=fi(m),Rt=Ee?Math.max(0,Math.min(100,Math.round((Ee.score??0)*100))):0,Xt=Ee?bi(Ee,fe):fe.noKnownnessData;return e.jsx(Et,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":zt,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[nt?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:fe.kicker}),e.jsx("h2",{className:"cogita-card-title",children:ke?bs(ke.payload,ke.infoType,ke.infoId):fe.loading}),ke?e.jsxs("p",{className:"cogita-card-subtitle",children:[ot(t,ke.infoType)," · ",ke.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:_t,children:fe.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:lt,disabled:!be||Te!=="ready",children:w.editInfo})]})]}),Te==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:fe.loading})}):Te==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:fe.loadError})}):ke?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:fe.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[Rt,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${Rt}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:Xt})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:fe.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(Ee==null?void 0:Ee.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:fe.correct.replace("{correct}",String((Ee==null?void 0:Ee.correctReviews)??0)).replace("{total}",String((Ee==null?void 0:Ee.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:Ee!=null&&Ee.lastReviewedUtc?`${fe.lastReview}: ${pi(Ee.lastReviewedUtc,m)}`:fe.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:fe.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:It}),e.jsx("p",{className:"cogita-library-hint",children:fe.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:fe.checkcards}),P==="loading"?e.jsx("p",{className:"cogita-library-hint",children:fe.loadingCheckcards}):P==="error"?e.jsx("p",{className:"cogita-library-hint",children:fe.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:fe.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(tt==null?void 0:tt.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:fe.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(M==null?void 0:M.items.length)??0})]})]})]}),it.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:fe.approach}),e.jsx("select",{value:Be,onChange:O=>rt(O.target.value),"aria-label":fe.approach,children:it.map(O=>e.jsx("option",{value:O.approachKey,children:O.label},O.approachKey))})]}),Ce==="loading"?e.jsx("p",{className:"cogita-library-hint",children:fe.loadingApproach}):Ce==="error"?e.jsx("p",{className:"cogita-library-hint",children:fe.loadApproachError}):ht?e.jsx(nn,{value:ht.projection,emptyLabel:fe.empty}):e.jsx("p",{className:"cogita-library-hint",children:fe.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:fe.payload}),e.jsx(nn,{value:ke.payload,emptyLabel:fe.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:fe.links}),e.jsx(yi,{links:ke.links,emptyLabel:fe.noLinks})]})]})]}):null]})}):null,He?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Informacja"}),e.jsx("h2",{className:"cogita-card-title",children:ke?bs(ke.payload,ke.infoType,ke.infoId):be??""}),e.jsx("p",{className:"cogita-card-subtitle",children:"Collections using this info"})]}),e.jsx("div",{className:"cogita-info-overview-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:_t,children:"Back to search"})})]}),de==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading collections..."})}):null,de==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load collections."})}):null,de==="ready"&&T.length===0?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"This info is not used in any collection yet."})}):null,de==="ready"&&T.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:T.map(O=>e.jsx("article",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`/#/cogita/library/${d}/collections/${O.collectionId}?libraryTarget=collections`,children:[e.jsx("div",{className:"cogita-card-type",children:"Collection"}),e.jsx("h3",{className:"cogita-card-title",children:O.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[O.itemCount," items"]})]})},O.collectionId))}):null]})}):null,!nt&&!He?e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":w.typeLabel,value:g,onChange:O=>S(O.target.value),children:he.map(O=>e.jsx("option",{value:O.value,children:O.label},O.value))}),e.jsx("input",{type:"text",value:K,onChange:O=>x(O.target.value),placeholder:w.searchPlaceholder}),e.jsx("select",{"aria-label":w.sortLabel,value:y,onChange:O=>ce(O.target.value),children:te.map(O=>e.jsx("option",{value:O.value,children:O.label},O.value))}),e.jsxs("select",{"aria-label":w.viewLabel,value:B,onChange:O=>p(O.target.value),children:[e.jsx("option",{value:"details",children:w.viewDetails}),e.jsx("option",{value:"wide",children:w.viewWide}),e.jsx("option",{value:"grid",children:w.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:w.cardCount.replace("{shown}",String(xt.length)).replace("{total}",String(Ze.length))}),e.jsx("span",{children:ee==="loading"?w.loading:w.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>N(O=>!O),children:W?w.hideFilters:w.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:w.filtersOptionalHint})]}),W?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsxs("div",{className:"cogita-filter-grid",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:w.typeLabel}),e.jsx("select",{value:g,onChange:O=>S(O.target.value),children:he.map(O=>e.jsx("option",{value:O.value,children:O.label},`advanced-type:${O.value}`))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Reference"}),e.jsxs("select",{value:z.__referenceId??"",onChange:O=>H(u=>({...u,__referenceId:O.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),ne.map(O=>e.jsx("option",{value:O.infoId,children:O.label},`reference:${O.infoId}`))]})]}),We.map(O=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:O.label}),O.kind==="select"?e.jsxs("select",{value:z[O.key]??"",onChange:u=>H(ie=>({...ie,[O.key]:u.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(O.options??[]).map(u=>e.jsx("option",{value:u.value,children:u.label},`${O.key}:${u.value}`))]}):e.jsx("input",{type:"text",value:z[O.key]??"",onChange:u=>H(ie=>({...ie,[O.key]:u.target.value}))})]},`type-filter:${O.key}`))]})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:Ot}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{$(O=>{const u={...O};for(const ie of xt)u[ie.infoId]={infoId:ie.infoId,infoType:ie.infoType,label:ie.label};return u})},disabled:xt.length===0,children:w.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>$({}),disabled:Tt.length===0,children:w.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Qt&&wt(Qt),disabled:!Qt,title:Qt?void 0:w.openSelectedDisabled,children:w.openSelected})]})]}),zt==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":w.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:w.detailColumnName}),e.jsx("span",{children:w.detailColumnType}),e.jsx("span",{children:w.detailColumnId}),e.jsx("span",{})]}),xt.length?xt.map(O=>{const u=ot(t,O.infoType),ie=Mt.has(O.infoId),J=Me===O.infoId;return e.jsxs("div",{className:`cogita-details-row ${J||ie?"active":""}`,role:"row",onClick:()=>Q(O.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:ie,onChange:Ye=>kt(O,Ye.target.checked),onClick:Ye=>Ye.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:O.label,children:O.label}),e.jsx("span",{title:u,children:u}),e.jsx("span",{title:O.infoId,children:O.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:Ye=>{Ye.stopPropagation(),wt(O.infoId)},"aria-label":w.editInfo,children:">"})]},O.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:w.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${zt}`,"data-view":zt,children:xt.length?xt.map(O=>{const u=ot(t,O.infoType),ie=Mt.has(O.infoId),J=Me===O.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":J||ie,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:ie,onChange:Ye=>kt(O,Ye.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>Q(O.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:u}),e.jsx("h3",{className:"cogita-card-title",children:O.label}),e.jsx("p",{className:"cogita-card-subtitle",children:O.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>wt(O.infoId),children:w.editInfo})]})},O.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:w.noMatch})})}),Ft?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>X(O=>O+Ln),children:w.loadMore})}):null,Tt.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:w.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:w.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:sa.map(([O,u])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:ot(t,O)}),e.jsx("span",{className:"cogita-tag-count",children:u})]},`stack:type:${O}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:Je,disabled:Tt.length===0,children:"Start revision"}),e.jsx("button",{type:"button",className:"ghost",onClick:vt,disabled:Tt.length===0,children:"Create collection from selection"})]})]}):null]}):null]})})})})}function bs(t,a,r){if(t&&typeof t=="object"&&!Array.isArray(t)){const s=t,i=["title","name","label","value","text","quote","term"];for(const o of i){const h=s[o];if(typeof h=="string"&&h.trim())return h.trim()}}return`${a} · ${r}`}function pi(t,a){try{const r=a==="pl"?"pl-PL":a==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(r,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function fi(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function bi(t,a){return t.totalReviews<=0?a.noKnownnessData:t.totalReviews<3||t.score<.35?a.developmentStart:t.totalReviews<8||t.score<.65?a.developmentGrowing:t.score<.85?a.developmentStable:a.developmentStrong}function yi({links:t,emptyLabel:a}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:a}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([r,s])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(s)?s.length?e.jsx("div",{className:"cogita-selection-overview",children:s.map(i=>e.jsx("span",{className:"cogita-tag-chip",children:i},`${r}:${i}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):s?e.jsx("span",{className:"cogita-tag-chip",children:s}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},r))})}function nn({value:t,emptyLabel:a}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:a});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((r,s)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(nn,{value:r,emptyLabel:a})})]},s))});if(typeof t=="object"){const r=Object.entries(t);return r.length===0?e.jsx("p",{className:"cogita-library-hint",children:a}):e.jsx("div",{className:"cogita-info-tree",children:r.map(([s,i])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(nn,{value:i,emptyLabel:a})})]},s))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const Na=5,ys=50,xs=2,vs=[];function Yt({libraryId:t,infoType:a,label:r,placeholder:s,value:i,onChange:o,values:h,onChangeMultiple:j,helperText:m,searchFailedText:v,createFailedText:d,createLabel:b,savingLabel:l,loadMoreLabel:c,allowCreate:w=!0,inputRef:g,autoAdvance:S,onCommit:K,multiple:x}){const y=x?h??vs:vs,[ce,B]=n.useState(x?"":(i==null?void 0:i.label)??""),[p,W]=n.useState([]),[N,ee]=n.useState(Na),[U,R]=n.useState(-1),[pe,F]=n.useState(!1),[X,Me]=n.useState(!1),[Q,L]=n.useState(null),$=n.useRef(0),z=n.useRef(new Map),H=n.useMemo(()=>w?x?ce.trim().length>0:ce.trim().length>0&&!i:!1,[w,ce,i,x]);n.useEffect(()=>{x||B((i==null?void 0:i.label)??"")},[i,x]),n.useEffect(()=>{const ne=ce.trim();if(!ne||ne.length<xs){W([]),F(!1),ee(Na),R(-1),Me(!1),L(null);return}const ae=ne.toLowerCase(),ke=`${t}:${a}:${ae}`,Le=z.current.get(ke);if(Le){if(x&&y.length>0){const $e=new Set(y.map(st=>st.id));W(Le.filter(st=>!$e.has(st.id)))}else W(Le);ee(Na),R(-1),F(Le.length>0),Me(!1),L(null);return}const Ee=window.setTimeout(async()=>{const $e=Date.now();$.current=$e,Me(!0),L(null);try{const st=await Xn({libraryId:t,type:a,query:ne,limit:ys});if($.current!==$e)return;const mt=st.slice(0,ys).map(Te=>({id:Te.infoId,label:Te.label,infoType:Te.infoType}));if(z.current.set(ke,mt),x&&y.length>0){const Te=new Set(y.map(Ge=>Ge.id));W(mt.filter(Ge=>!Te.has(Ge.id)))}else W(mt);ee(Na),R(-1),F(!0)}catch{if($.current!==$e)return;L(v??"Search failed.")}finally{$.current===$e&&Me(!1)}},250);return()=>window.clearTimeout(Ee)},[t,a,ce,y]);const V=ne=>{if(x){const ae=y.some(ke=>ke.id===ne.id)?y:[...y,ne];j==null||j(ae),B(""),F(!1),R(-1);return}o==null||o(ne),B(ne.label),F(!1),R(-1),S&&(K==null||K())},me=async()=>{const ne=ce.trim();if(ne){Me(!0),L(null);try{const ae=await qn({libraryId:t,infoType:a,payload:{label:ne}}),ke={id:ae.infoId,label:ne,infoType:ae.infoType};if(ne.length>=xs){const Le=`${t}:${a}:${ne.toLowerCase()}`,Ee=z.current.get(Le)??[];z.current.set(Le,[ke,...Ee])}if(x){j==null||j([...y,ke]),B(""),F(!1),R(-1);return}o==null||o(ke),F(!1),R(-1),S&&(K==null||K())}catch{L(d??"Create failed.")}finally{Me(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:r}),e.jsx("input",{value:ce,placeholder:s,onChange:ne=>{B(ne.target.value),!x&&i&&(o==null||o(null))},onKeyDown:ne=>{if(ne.key==="ArrowDown"){if(ne.preventDefault(),!p.length)return;F(!0),R(ae=>{const ke=Math.min(p.length,N)-1,Le=ae<0?0:Math.min(ae+1,ke);return Le===ke&&p.length>N?(ee(Ee=>Math.min(Ee+Na,p.length)),Math.min(ae+1,Math.min(p.length,N+Na)-1)):Le});return}if(ne.key==="ArrowUp"){if(ne.preventDefault(),!p.length)return;F(!0),R(ae=>ae<=0?0:ae-1);return}if(ne.key==="Enter"){if(ne.preventDefault(),U>=0&&p[U]){V(p[U]);return}if(H){me();return}}},onFocus:()=>{p.length>0&&F(!0)},autoComplete:"off",ref:g})]}),x&&y.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:y.map(ne=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>j==null?void 0:j(y.filter(ae=>ae.id!==ne.id)),children:[ne.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},ne.id))}),m&&e.jsx("p",{className:"cogita-help",children:m}),Q&&e.jsx("p",{className:"cogita-error",children:Q}),pe&&p.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[p.slice(0,N).map((ne,ae)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":ae===U,onClick:()=>V(ne),children:[e.jsx("strong",{children:ne.label}),e.jsx("span",{children:ne.infoType})]},ne.id)),N<p.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>ee(ne=>Math.min(ne+Na,p.length)),children:c??"Load more"})]}),H&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:me,disabled:X,children:X?l??"Saving...":b??`Create new ${a}`})]})}const ws=[{id:"gen",la:{abbr:"Gen",name:"Genesis"},en:{abbr:"Gen",name:"Genesis"},de:{abbr:"Gen",name:"Genesis"},pl:{abbr:"Rdz",name:"Księga Rodzaju"}},{id:"ex",la:{abbr:"Ex",name:"Exodus"},en:{abbr:"Ex",name:"Exodus"},de:{abbr:"Ex",name:"Exodus"},pl:{abbr:"Wj",name:"Księga Wyjścia"}},{id:"lev",la:{abbr:"Lev",name:"Leviticus"},en:{abbr:"Lev",name:"Leviticus"},de:{abbr:"Lev",name:"Levitikus"},pl:{abbr:"Kpł",name:"Księga Kapłańska"}},{id:"num",la:{abbr:"Num",name:"Numeri"},en:{abbr:"Num",name:"Numbers"},de:{abbr:"Num",name:"Numeri"},pl:{abbr:"Lb",name:"Księga Liczb"}},{id:"deut",la:{abbr:"Deut",name:"Deuteronomium"},en:{abbr:"Deut",name:"Deuteronomy"},de:{abbr:"Dtn",name:"Deuteronomium"},pl:{abbr:"Pwt",name:"Księga Powtórzonego Prawa"}},{id:"ios",la:{abbr:"Ios",name:"Iosue"},en:{abbr:"Josh",name:"Joshua"},de:{abbr:"Jos",name:"Josua"},pl:{abbr:"Joz",name:"Księga Jozuego"}},{id:"iudg",la:{abbr:"Iudg",name:"Iudicum"},en:{abbr:"Judg",name:"Judges"},de:{abbr:"Ri",name:"Richter"},pl:{abbr:"Sdz",name:"Księga Sędziów"}},{id:"ruth",la:{abbr:"Ruth",name:"Ruth"},en:{abbr:"Ruth",name:"Ruth"},de:{abbr:"Rut",name:"Rut"},pl:{abbr:"Rt",name:"Księga Rut"}},{id:"1sam",la:{abbr:"1 Sam",name:"I Samuelis"},en:{abbr:"1 Sam",name:"1 Samuel"},de:{abbr:"1 Sam",name:"1 Samuel"},pl:{abbr:"1 Sm",name:"1 Księga Samuela"}},{id:"2sam",la:{abbr:"2 Sam",name:"II Samuelis"},en:{abbr:"2 Sam",name:"2 Samuel"},de:{abbr:"2 Sam",name:"2 Samuel"},pl:{abbr:"2 Sm",name:"2 Księga Samuela"}},{id:"1reg",la:{abbr:"1 Reg",name:"I Regum"},en:{abbr:"1 Kgs",name:"1 Kings"},de:{abbr:"1 Kön",name:"1 Könige"},pl:{abbr:"1 Krl",name:"1 Księga Królewska"}},{id:"2reg",la:{abbr:"2 Reg",name:"II Regum"},en:{abbr:"2 Kgs",name:"2 Kings"},de:{abbr:"2 Kön",name:"2 Könige"},pl:{abbr:"2 Krl",name:"2 Księga Królewska"}},{id:"1par",la:{abbr:"1 Par",name:"I Paralipomenon"},en:{abbr:"1 Chr",name:"1 Chronicles"},de:{abbr:"1 Chr",name:"1 Chronik"},pl:{abbr:"1 Krn",name:"1 Księga Kronik"}},{id:"2par",la:{abbr:"2 Par",name:"II Paralipomenon"},en:{abbr:"2 Chr",name:"2 Chronicles"},de:{abbr:"2 Chr",name:"2 Chronik"},pl:{abbr:"2 Krn",name:"2 Księga Kronik"}},{id:"esd",la:{abbr:"Esd",name:"Esdrae"},en:{abbr:"Ezra",name:"Ezra"},de:{abbr:"Esra",name:"Esra"},pl:{abbr:"Ezd",name:"Księga Ezdrasza"}},{id:"neh",la:{abbr:"Neh",name:"Nehemiae"},en:{abbr:"Neh",name:"Nehemiah"},de:{abbr:"Neh",name:"Nehemia"},pl:{abbr:"Ne",name:"Księga Nehemiasza"}},{id:"tob",la:{abbr:"Tob",name:"Tobiae"},en:{abbr:"Tob",name:"Tobit"},de:{abbr:"Tob",name:"Tobit"},pl:{abbr:"Tb",name:"Księga Tobiasza"}},{id:"iudt",la:{abbr:"Iudt",name:"Iudith"},en:{abbr:"Jdt",name:"Judith"},de:{abbr:"Jdt",name:"Judit"},pl:{abbr:"Jdt",name:"Księga Judyty"}},{id:"est",la:{abbr:"Est",name:"Esther"},en:{abbr:"Est",name:"Esther"},de:{abbr:"Est",name:"Ester"},pl:{abbr:"Est",name:"Księga Estery"}},{id:"1macc",la:{abbr:"1 Macc",name:"I Maccabaeorum"},en:{abbr:"1 Mc",name:"1 Maccabees"},de:{abbr:"1 Makk",name:"1 Makkabäer"},pl:{abbr:"1 Mch",name:"1 Księga Machabejska"}},{id:"2macc",la:{abbr:"2 Macc",name:"II Maccabaeorum"},en:{abbr:"2 Mc",name:"2 Maccabees"},de:{abbr:"2 Makk",name:"2 Makkabäer"},pl:{abbr:"2 Mch",name:"2 Księga Machabejska"}},{id:"iob",la:{abbr:"Iob",name:"Iob"},en:{abbr:"Job",name:"Job"},de:{abbr:"Ijob",name:"Ijob"},pl:{abbr:"Hi",name:"Księga Hioba"}},{id:"ps",la:{abbr:"Ps",name:"Psalmi"},en:{abbr:"Ps",name:"Psalms"},de:{abbr:"Ps",name:"Psalmen"},pl:{abbr:"Ps",name:"Księga Psalmów"}},{id:"prov",la:{abbr:"Prov",name:"Proverbia"},en:{abbr:"Prov",name:"Proverbs"},de:{abbr:"Spr",name:"Sprichwörter"},pl:{abbr:"Prz",name:"Księga Przysłów"}},{id:"ecc",la:{abbr:"Ecc",name:"Ecclesiastes"},en:{abbr:"Eccl",name:"Ecclesiastes"},de:{abbr:"Koh",name:"Kohelet"},pl:{abbr:"Koh",name:"Księga Koheleta"}},{id:"cant",la:{abbr:"Cant",name:"Canticum Canticorum"},en:{abbr:"Song",name:"Song of Songs"},de:{abbr:"Hld",name:"Hoheslied"},pl:{abbr:"Pnp",name:"Pieśń nad Pieśniami"}},{id:"sap",la:{abbr:"Sap",name:"Sapientia"},en:{abbr:"Wis",name:"Wisdom"},de:{abbr:"Weish",name:"Weisheit"},pl:{abbr:"Mdr",name:"Księga Mądrości"}},{id:"sir",la:{abbr:"Sir",name:"Ecclesiasticus (Sirach)"},en:{abbr:"Sir",name:"Sirach"},de:{abbr:"Sir",name:"Jesus Sirach"},pl:{abbr:"Syr",name:"Mądrość Syracha"}},{id:"isa",la:{abbr:"Isa",name:"Isaias"},en:{abbr:"Isa",name:"Isaiah"},de:{abbr:"Jes",name:"Jesaja"},pl:{abbr:"Iz",name:"Księga Izajasza"}},{id:"ier",la:{abbr:"Ier",name:"Ieremias"},en:{abbr:"Jer",name:"Jeremiah"},de:{abbr:"Jer",name:"Jeremia"},pl:{abbr:"Jr",name:"Księga Jeremiasza"}},{id:"lam",la:{abbr:"Lam",name:"Lamentationes"},en:{abbr:"Lam",name:"Lamentations"},de:{abbr:"Klgl",name:"Klagelieder"},pl:{abbr:"Lm",name:"Lamentacje"}},{id:"bar",la:{abbr:"Bar",name:"Baruch"},en:{abbr:"Bar",name:"Baruch"},de:{abbr:"Bar",name:"Baruch"},pl:{abbr:"Ba",name:"Księga Barucha"}},{id:"ez",la:{abbr:"Ez",name:"Ezechiel"},en:{abbr:"Ezek",name:"Ezekiel"},de:{abbr:"Ez",name:"Ezechiel"},pl:{abbr:"Ez",name:"Księga Ezechiela"}},{id:"dan",la:{abbr:"Dan",name:"Daniel"},en:{abbr:"Dan",name:"Daniel"},de:{abbr:"Dan",name:"Daniel"},pl:{abbr:"Dn",name:"Księga Daniela"}},{id:"hos",la:{abbr:"Hos",name:"Osee"},en:{abbr:"Hos",name:"Hosea"},de:{abbr:"Hos",name:"Hosea"},pl:{abbr:"Oz",name:"Księga Ozeasza"}},{id:"ioel",la:{abbr:"Ioel",name:"Ioel"},en:{abbr:"Joel",name:"Joel"},de:{abbr:"Joel",name:"Joel"},pl:{abbr:"Jl",name:"Księga Joela"}},{id:"amos",la:{abbr:"Amos",name:"Amos"},en:{abbr:"Am",name:"Amos"},de:{abbr:"Am",name:"Amos"},pl:{abbr:"Am",name:"Księga Amosa"}},{id:"abd",la:{abbr:"Abd",name:"Abdias"},en:{abbr:"Obad",name:"Obadiah"},de:{abbr:"Obd",name:"Obadja"},pl:{abbr:"Abd",name:"Księga Abdiasza"}},{id:"ion",la:{abbr:"Ion",name:"Ionas"},en:{abbr:"Jon",name:"Jonah"},de:{abbr:"Jona",name:"Jona"},pl:{abbr:"Jon",name:"Księga Jonasza"}},{id:"mich",la:{abbr:"Mich",name:"Michaeas"},en:{abbr:"Mic",name:"Micah"},de:{abbr:"Mi",name:"Micha"},pl:{abbr:"Mi",name:"Księga Micheasza"}},{id:"nah",la:{abbr:"Nah",name:"Nahum"},en:{abbr:"Nah",name:"Nahum"},de:{abbr:"Nah",name:"Nahum"},pl:{abbr:"Na",name:"Księga Nahuma"}},{id:"hab",la:{abbr:"Hab",name:"Habacuc"},en:{abbr:"Hab",name:"Habakkuk"},de:{abbr:"Hab",name:"Habakuk"},pl:{abbr:"Ha",name:"Księga Habakuka"}},{id:"soph",la:{abbr:"Soph",name:"Sophonias"},en:{abbr:"Zeph",name:"Zephaniah"},de:{abbr:"Zef",name:"Zefanja"},pl:{abbr:"So",name:"Księga Sofoniasza"}},{id:"agg",la:{abbr:"Agg",name:"Aggaeus"},en:{abbr:"Hag",name:"Haggai"},de:{abbr:"Hag",name:"Haggai"},pl:{abbr:"Ag",name:"Księga Aggeusza"}},{id:"zach",la:{abbr:"Zach",name:"Zacharias"},en:{abbr:"Zech",name:"Zechariah"},de:{abbr:"Sach",name:"Sacharja"},pl:{abbr:"Za",name:"Księga Zachariasza"}},{id:"mal",la:{abbr:"Mal",name:"Malachias"},en:{abbr:"Mal",name:"Malachi"},de:{abbr:"Mal",name:"Maleachi"},pl:{abbr:"Ml",name:"Księga Malachiasza"}},{id:"mt",la:{abbr:"Mt",name:"Matthaeus"},en:{abbr:"Matt",name:"Matthew"},de:{abbr:"Mt",name:"Matthäus"},pl:{abbr:"Mt",name:"Ewangelia wg św. Mateusza"}},{id:"mc",la:{abbr:"Mc",name:"Marcus"},en:{abbr:"Mark",name:"Mark"},de:{abbr:"Mk",name:"Markus"},pl:{abbr:"Mk",name:"Ewangelia wg św. Marka"}},{id:"lc",la:{abbr:"Lc",name:"Lucas"},en:{abbr:"Luke",name:"Luke"},de:{abbr:"Lk",name:"Lukas"},pl:{abbr:"Łk",name:"Ewangelia wg św. Łukasza"}},{id:"io",la:{abbr:"Io",name:"Ioannes"},en:{abbr:"John",name:"John"},de:{abbr:"Joh",name:"Johannes"},pl:{abbr:"J",name:"Ewangelia wg św. Jana"}},{id:"act",la:{abbr:"Act",name:"Actus Apostolorum"},en:{abbr:"Acts",name:"Acts"},de:{abbr:"Apg",name:"Apostelgeschichte"},pl:{abbr:"Dz",name:"Dzieje Apostolskie"}},{id:"rom",la:{abbr:"Rom",name:"ad Romanos"},en:{abbr:"Rom",name:"Romans"},de:{abbr:"Röm",name:"Römer"},pl:{abbr:"Rz",name:"List do Rzymian"}},{id:"1cor",la:{abbr:"1 Cor",name:"I ad Corinthios"},en:{abbr:"1 Cor",name:"1 Corinthians"},de:{abbr:"1 Kor",name:"1 Korinther"},pl:{abbr:"1 Kor",name:"1 List do Koryntian"}},{id:"2cor",la:{abbr:"2 Cor",name:"II ad Corinthios"},en:{abbr:"2 Cor",name:"2 Corinthians"},de:{abbr:"2 Kor",name:"2 Korinther"},pl:{abbr:"2 Kor",name:"2 List do Koryntian"}},{id:"gal",la:{abbr:"Gal",name:"ad Galatas"},en:{abbr:"Gal",name:"Galatians"},de:{abbr:"Gal",name:"Galater"},pl:{abbr:"Ga",name:"List do Galatów"}},{id:"eph",la:{abbr:"Eph",name:"ad Ephesios"},en:{abbr:"Eph",name:"Ephesians"},de:{abbr:"Eph",name:"Epheser"},pl:{abbr:"Ef",name:"List do Efezjan"}},{id:"phil",la:{abbr:"Phil",name:"ad Philippenses"},en:{abbr:"Phil",name:"Philippians"},de:{abbr:"Phil",name:"Philipper"},pl:{abbr:"Flp",name:"List do Filipian"}},{id:"col",la:{abbr:"Col",name:"ad Colossenses"},en:{abbr:"Col",name:"Colossians"},de:{abbr:"Kol",name:"Kolosser"},pl:{abbr:"Kol",name:"List do Kolosan"}},{id:"1thess",la:{abbr:"1 Thess",name:"I ad Thessalonicenses"},en:{abbr:"1 Thess",name:"1 Thessalonians"},de:{abbr:"1 Thess",name:"1 Thessalonicher"},pl:{abbr:"1 Tes",name:"1 List do Tesaloniczan"}},{id:"2thess",la:{abbr:"2 Thess",name:"II ad Thessalonicenses"},en:{abbr:"2 Thess",name:"2 Thessalonians"},de:{abbr:"2 Thess",name:"2 Thessalonicher"},pl:{abbr:"2 Tes",name:"2 List do Tesaloniczan"}},{id:"1tim",la:{abbr:"1 Tim",name:"I ad Timotheum"},en:{abbr:"1 Tim",name:"1 Timothy"},de:{abbr:"1 Tim",name:"1 Timotheus"},pl:{abbr:"1 Tm",name:"1 List do Tymoteusza"}},{id:"2tim",la:{abbr:"2 Tim",name:"II ad Timotheum"},en:{abbr:"2 Tim",name:"2 Timothy"},de:{abbr:"2 Tim",name:"2 Timotheus"},pl:{abbr:"2 Tm",name:"2 List do Tymoteusza"}},{id:"tit",la:{abbr:"Tit",name:"ad Titum"},en:{abbr:"Titus",name:"Titus"},de:{abbr:"Tit",name:"Titus"},pl:{abbr:"Tt",name:"List do Tytusa"}},{id:"phlm",la:{abbr:"Phlm",name:"ad Philemonem"},en:{abbr:"Phlm",name:"Philemon"},de:{abbr:"Phlm",name:"Philemon"},pl:{abbr:"Flm",name:"List do Filemona"}},{id:"heb",la:{abbr:"Heb",name:"ad Hebraeos"},en:{abbr:"Heb",name:"Hebrews"},de:{abbr:"Hebr",name:"Hebräer"},pl:{abbr:"Hbr",name:"List do Hebrajczyków"}},{id:"iac",la:{abbr:"Iac",name:"Iacobi"},en:{abbr:"Jas",name:"James"},de:{abbr:"Jak",name:"Jakobus"},pl:{abbr:"Jk",name:"List św. Jakuba"}},{id:"1pet",la:{abbr:"1 Pet",name:"I Petri"},en:{abbr:"1 Pet",name:"1 Peter"},de:{abbr:"1 Petr",name:"1 Petrus"},pl:{abbr:"1 P",name:"1 List św. Piotra"}},{id:"2pet",la:{abbr:"2 Pet",name:"II Petri"},en:{abbr:"2 Pet",name:"2 Peter"},de:{abbr:"2 Petr",name:"2 Petrus"},pl:{abbr:"2 P",name:"2 List św. Piotra"}},{id:"1io",la:{abbr:"1 Io",name:"I Ioannis"},en:{abbr:"1 John",name:"1 John"},de:{abbr:"1 Joh",name:"1 Johannes"},pl:{abbr:"1 J",name:"1 List św. Jana"}},{id:"2io",la:{abbr:"2 Io",name:"II Ioannis"},en:{abbr:"2 John",name:"2 John"},de:{abbr:"2 Joh",name:"2 Johannes"},pl:{abbr:"2 J",name:"2 List św. Jana"}},{id:"3io",la:{abbr:"3 Io",name:"III Ioannis"},en:{abbr:"3 John",name:"3 John"},de:{abbr:"3 Joh",name:"3 Johannes"},pl:{abbr:"3 J",name:"3 List św. Jana"}},{id:"iud",la:{abbr:"Iud",name:"Iudae"},en:{abbr:"Jude",name:"Jude"},de:{abbr:"Jud",name:"Judas"},pl:{abbr:"Jud",name:"List św. Judy"}},{id:"apoc",la:{abbr:"Apoc",name:"Apocalypsis Ioannis"},en:{abbr:"Rev",name:"Revelation"},de:{abbr:"Offb",name:"Offenbarung"},pl:{abbr:"Ap",name:"Apokalipsa św. Jana"}}],js=8;function ks({libraryId:t,copy:a,language:r,sourceKindOptions:s,value:i,onChange:o,labels:h}){const[j,m]=n.useState(!1),[v,d]=n.useState(-1),b=n.useMemo(()=>{const g=r;return ws.map(S=>{var y;const K=(S==null?void 0:S[g])??(S==null?void 0:S.en)??(S==null?void 0:S.la);return{label:`${K.abbr} — ${K.name}`,latin:((y=S==null?void 0:S.la)==null?void 0:y.abbr)??K.abbr}})},[r]),l=(g,S=!1)=>{const K=g.trim().toLowerCase();return K?b.filter(x=>x.label.toLowerCase().includes(K)).slice(0,js):S?b.slice(0,js):[]},c=(g,S)=>{const K=g.trim().toLowerCase();if(!K)return null;const x=ws;for(const y of x){const ce=y==null?void 0:y.la,B=(y==null?void 0:y[S])??(y==null?void 0:y.en)??ce,p=(B==null?void 0:B.abbr)??"",W=(B==null?void 0:B.name)??"";if(p.toLowerCase()===K||W.toLowerCase()===K||`${p} — ${W}`.toLowerCase()===K)return{book:y,entry:B,la:ce}}return null};n.useEffect(()=>{if(i.sourceKind==="bible"&&i.locatorValue&&!j){const g=c(i.locatorValue,r);if(g){const S=`${g.entry.abbr} — ${g.entry.name}`;S!==i.bibleBookDisplay&&o({...i,bibleBookDisplay:S})}}},[r,i,j,o]);const w=g=>o({...i,...g});return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.sourceKindLabel}),e.jsx("select",{value:i.sourceKind,onChange:g=>w({sourceKind:g.target.value,churchDocument:null,bookMedia:null,work:null,locatorValue:"",locatorAux:"",bibleBookDisplay:""}),children:s.map(g=>e.jsx("option",{value:g.value,children:g.label},g.value))})]}),i.sourceKind==="bible"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-lookup full",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.bibleBookLabel}),e.jsx("input",{type:"text",value:i.bibleBookDisplay,onChange:g=>{const S=g.target.value;w({bibleBookDisplay:S,locatorValue:""}),m(!0),d(-1)},onKeyDown:g=>{var K;const S=l(i.bibleBookDisplay);if(S.length){if(g.key==="ArrowDown")g.preventDefault(),d(x=>Math.min(x+1,S.length-1));else if(g.key==="ArrowUp")g.preventDefault(),d(x=>Math.max(x-1,0));else if((g.key==="Enter"||g.key==="Tab")&&v>=0&&S[v]){const x=S[v],y=c(x.label,r);if(!y)return;w({bibleBookDisplay:x.label,locatorValue:((K=y.la)==null?void 0:K.abbr)??i.locatorValue}),m(!1)}}},onFocus:()=>m(!0),onBlur:()=>window.setTimeout(()=>m(!1),100),placeholder:h.bibleBookPlaceholder})]}),j&&l(i.bibleBookDisplay,!0).length>0&&e.jsx("div",{className:"cogita-lookup-results",children:l(i.bibleBookDisplay,!0).map((g,S)=>e.jsx("button",{type:"button",className:"cogita-lookup-option","data-active":S===v,tabIndex:-1,onMouseDown:()=>{var x;const K=c(g.label,r);K&&w({bibleBookDisplay:g.label,locatorValue:((x=K.la)==null?void 0:x.abbr)??i.locatorValue})},children:e.jsx("strong",{children:g.label})},g.latin))})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.bibleRestLabel}),e.jsx("input",{type:"text",value:i.locatorAux,onChange:g=>w({locatorAux:g.target.value}),placeholder:h.bibleRestPlaceholder})]})]}),i.sourceKind==="website"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:a.cogita.library.add.info.sourceUrlLabel}),e.jsx("input",{type:"text",value:i.sourceUrl,onChange:g=>w({sourceUrl:g.target.value}),placeholder:a.cogita.library.add.info.sourceUrlPlaceholder})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:a.cogita.library.add.info.sourceAccessedDateLabel}),e.jsx("input",{type:"text",value:i.sourceAccessedDate,onChange:g=>w({sourceAccessedDate:g.target.value}),placeholder:a.cogita.library.add.info.sourceAccessedDatePlaceholder})]})]}),i.sourceKind==="number_document"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:t,infoType:"work",label:h.churchDocumentLabel,placeholder:h.churchDocumentPlaceholder,value:i.churchDocument,onChange:g=>w({churchDocument:g}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.work),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:g=>w({locatorValue:g.target.value}),placeholder:h.locatorPlaceholder})]})]}),i.sourceKind==="work"&&e.jsx(Yt,{libraryId:t,infoType:"work",label:h.workLabel,placeholder:h.workPlaceholder,value:i.work,onChange:g=>w({work:g}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.work),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),i.sourceKind==="book"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:t,infoType:"media",label:h.bookLabel,placeholder:h.bookPlaceholder,value:i.bookMedia,onChange:g=>w({bookMedia:g}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.media),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:g=>w({locatorValue:g.target.value}),placeholder:h.locatorPlaceholder})]})]}),i.sourceKind!=="website"&&i.sourceKind!=="bible"&&i.sourceKind!=="book"&&i.sourceKind!=="number_document"&&e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:g=>w({locatorValue:g.target.value}),placeholder:h.locatorPlaceholder})]})]})}const _a=JSON.stringify({type:"selection",title:"Question title",question:"Question text",options:["Option A","Option B","Option C"],answer:[0]},null,2);function Ya(t="selection"){return t==="matching"?{type:t,title:"",question:"",columns:[[""],[""]],answer:{paths:[]},matchingPaths:[["",""]]}:t==="ordering"?{type:t,title:"",question:"",options:[""]}:t==="truefalse"?{type:t,title:"",question:"",answer:!0}:t==="text"||t==="date"?{type:t,title:"",question:"",answer:""}:t==="number"?{type:t,title:"",question:"",answer:""}:{type:t,title:"",question:"",options:[""],answer:[]}}function xi(t){return["selection","truefalse","text","number","date","matching","ordering"].includes(t)}function Da(t){if(!t||typeof t!="object")return null;const a=t,r=typeof a.type=="string"?a.type:typeof a.kind=="string"?a.kind:"selection",s=r==="multi_select"||r==="single_select"?"selection":r==="boolean"?"truefalse":r==="order"?"ordering":r,i=xi(s)?s:"selection",o=typeof a.title=="string"?a.title:"",h=typeof a.question=="string"?a.question:"";if(i==="matching"){let v=[];Array.isArray(a.columns)?v=a.columns.map(g=>Array.isArray(g)?g.map(S=>typeof S=="string"?S:""):[""]):Array.isArray(a.left)&&Array.isArray(a.right)&&(v=[a.left.map(g=>typeof g=="string"?g:""),a.right.map(g=>typeof g=="string"?g:"")]),v.length<2&&(v=[[""],[""]]);const d=a.answer&&typeof a.answer=="object"?a.answer:null,l=(Array.isArray(d==null?void 0:d.paths)?d==null?void 0:d.paths:Array.isArray(a.correctPairs)?a.correctPairs:[]).map(g=>Array.isArray(g)?g.map(S=>Number(S)).filter(S=>Number.isInteger(S)&&S>=0):[]).filter(g=>g.length>0),c=Array.isArray(a.matchingPaths)?a.matchingPaths.map(g=>Array.isArray(g)?Array.from({length:v.length},(S,K)=>String(g[K]??"")):new Array(v.length).fill("")):null,w=c&&c.length>0?c:[...l.map(g=>g.map(String)),new Array(v.length).fill("")];return{type:i,title:o,question:h,columns:v,answer:{paths:l},matchingPaths:w}}if(i==="ordering"){const v=Array.isArray(a.options)?a.options.map(d=>typeof d=="string"?d:""):Array.isArray(a.items)?a.items.map(d=>typeof d=="string"?d:""):[""];return{type:i,title:o,question:h,options:v.length?v:[""]}}if(i==="truefalse"){const v=typeof a.answer=="boolean"?a.answer:typeof a.expected=="boolean"?a.expected:!0;return{type:i,title:o,question:h,answer:v}}if(i==="number")return typeof a.answer=="number"?{type:i,title:o,question:h,answer:a.answer}:typeof a.answer=="string"?{type:i,title:o,question:h,answer:a.answer}:typeof a.expected=="number"?{type:i,title:o,question:h,answer:a.expected}:{type:i,title:o,question:h,answer:""};if(i==="text"||i==="date"){const v=typeof a.answer=="string"?a.answer:typeof a.expected=="string"?a.expected:"";return{type:i,title:o,question:h,answer:v}}const j=Array.isArray(a.options)?a.options.map(v=>typeof v=="string"?v:""):[""],m=Array.isArray(a.answer)?a.answer.map(v=>Number(v)).filter(v=>Number.isInteger(v)&&v>=0):Array.isArray(a.correct)?a.correct.map(v=>Number(v)).filter(v=>Number.isInteger(v)&&v>=0):[];return{type:i,title:o,question:h,options:j.length?j:[""],answer:m}}function vi(t){const a=(t.title??"").trim(),r=(t.question??"").trim();switch(t.type){case"matching":{const s=(t.columns??[[""],[""]]).map(b=>b.map(l=>l.trim()).filter(Boolean)).filter(b=>b.length>0),i=s.length>=2?s:[[""],[""]],o=t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[],h=(t.matchingPaths??[]).map(b=>b.map(l=>String(l??""))),j=i.length,m=h.map(b=>b.slice(0,j).map(l=>l.trim())).filter(b=>b.some(Boolean)).map(b=>b.map(l=>Number(l))).filter(b=>b.length===j&&b.every(l=>Number.isInteger(l)&&l>=0)),v=(Array.isArray(o)?o:[]).map(b=>Array.isArray(b)?b.map(l=>Number(l)).filter(l=>Number.isInteger(l)&&l>=0):[]).filter(b=>b.length===j),d=Array.from(new Set([...v,...m].map(b=>JSON.stringify(b)))).map(b=>JSON.parse(b));return JSON.stringify({type:t.type,...a?{title:a}:{},question:r,columns:i,answer:{paths:d}},null,2)}case"ordering":{const s=(t.options??[]).map(i=>i.trim()).filter(Boolean);return JSON.stringify({type:t.type,...a?{title:a}:{},question:r,options:s},null,2)}case"truefalse":return JSON.stringify({type:t.type,...a?{title:a}:{},question:r,answer:!!t.answer},null,2);case"number":return JSON.stringify({type:t.type,...a?{title:a}:{},question:r,answer:typeof t.answer=="number"||typeof t.answer=="string"?t.answer:""},null,2);case"date":case"text":return JSON.stringify({type:t.type,...a?{title:a}:{},question:r,answer:String(t.answer??"")},null,2);case"selection":default:{const s=(t.options??[]).map(h=>h.trim()).filter(Boolean),i=Array.isArray(t.answer)?t.answer:[],o=Array.from(new Set(i.filter(h=>Number.isInteger(h)&&h>=0&&h<s.length))).sort((h,j)=>h-j);return JSON.stringify({type:t.type,...a?{title:a}:{},question:r,options:s,answer:o},null,2)}}}const Ns=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}];function za(){return{sourceKind:"string",locatorValue:"",locatorAux:"",bibleBookDisplay:"",sourceUrl:"",sourceAccessedDate:"",churchDocument:null,bookMedia:null,work:null}}function Ss(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function Ts(t,a){if(!t||typeof t!="object")return a;const r=t,s=r.definition&&typeof r.definition=="object"?r.definition:null,i=[r.label,r.name,r.title,r.text,r.orcid,r.email,r.number];s&&i.unshift(s.title,s.question);for(const o of i)if(typeof o=="string"&&o.trim())return o.trim();return a}function Cs(t,a){var s;if(!(t instanceof Ws))return a;const r=(s=t.message)==null?void 0:s.trim();if(!r)return a;try{const i=JSON.parse(r);if(typeof i.error=="string"&&i.error.trim())return i.error.trim()}catch{}return r}function wi(t){const a=t.trim();if(!a)return null;try{const r=JSON.parse(a);return r&&typeof r=="object"&&!Array.isArray(r)?r:null}catch{return null}}function ia(t,a){const r=t==null?void 0:t[a];return typeof r=="string"?r:""}function ji(t,a){return a?t==="book"&&a.infoType==="media"?{bookMedia:a}:t==="work"&&a.infoType==="work"?{work:a}:t==="number_document"&&a.infoType==="work"?{churchDocument:a}:{}:{}}function ki(t,a){const r=za(),s=(t.sourceKind??"").trim()||r.sourceKind,i=t.locator??"",o=wi(i);let h="",j="",m="",v="",d="";return s==="website"?(v=ia(o,"url"),d=ia(o,"accessedDate"),h=ia(o,"value")):s==="bible"?(h=ia(o,"book")||i.trim(),j=ia(o,"passage")||ia(o,"rest"),m=ia(o,"bookDisplay")):o?(h=ia(o,"value")||ia(o,"locator"),j=ia(o,"aux")):h=i,{...r,sourceKind:s,locatorValue:h,locatorAux:j,bibleBookDisplay:m,sourceUrl:v,sourceAccessedDate:d,...ji(s,a)}}function An(t){return t.sourceKind==="book"?t.bookMedia:t.sourceKind==="work"?t.work:t.sourceKind==="number_document"?t.churchDocument:null}function $n(t){const a=t.locatorValue.trim(),r=t.locatorAux.trim(),s=t.sourceUrl.trim(),i=t.sourceAccessedDate.trim();switch(t.sourceKind){case"website":return{url:s,accessedDate:i};case"bible":return{book:a,bookDisplay:t.bibleBookDisplay.trim(),passage:r};case"book":case"work":case"number_document":return r?{value:a,aux:r}:a;default:return r?{value:a,aux:r}:a}}function Is(t){var i,o,h;const a=t.locatorValue.trim(),r=t.locatorAux.trim(),s=[a,r].filter(Boolean).join(" ");switch(t.sourceKind){case"website":return t.sourceUrl.trim()||"website";case"bible":return s||"bible";case"book":return[(i=t.bookMedia)==null?void 0:i.label,s].filter(Boolean).join(" · ")||"book";case"work":return[(o=t.work)==null?void 0:o.label,s].filter(Boolean).join(" · ")||"work";case"number_document":return[(h=t.churchDocument)==null?void 0:h.label,s].filter(Boolean).join(" · ")||"number_document";default:return s||t.sourceKind||"source"}}function Ms(t){return t.sourceKind.trim()?t.sourceKind==="website"?!!t.sourceUrl.trim():t.sourceKind==="bible"?!!(t.locatorValue.trim()&&t.locatorAux.trim()):t.sourceKind==="book"?!!t.bookMedia:t.sourceKind==="work"?!!t.work:t.sourceKind==="number_document"?!!(t.churchDocument&&t.locatorValue.trim()):!!t.locatorValue.trim():!1}function Ni({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,libraryId:d,editInfoId:b}){var Ce,ze,tt;const{libraryName:l}=ua(d),c=!!b,[w,g]=n.useState([]),[S,K]=n.useState("word"),[x,y]=n.useState({}),[ce,B]=n.useState({}),[p,W]=n.useState({}),[N,ee]=n.useState({}),[U,R]=n.useState(null),[pe,F]=n.useState("idle"),[X,Me]=n.useState(za),[Q,L]=n.useState({}),[$,z]=n.useState({}),[H,V]=n.useState({}),[me,ne]=n.useState(null),[ae,ke]=n.useState(()=>Da(JSON.parse(_a))??Ya()),[Le,Ee]=n.useState(_a),$e=n.useMemo(()=>w.find(E=>E.infoType===S),[S,w]),st=n.useMemo(()=>w.find(E=>E.infoType==="source"),[w]),mt=n.useMemo(()=>w.map(E=>({value:E.infoType,label:ot(t,E.infoType)})),[t,w]),Te=E=>{const M=Da(E)??Ya(),D=vi(M);ke(M),y(P=>({...P,definition:D}))};n.useEffect(()=>{let E=!1;return xr({libraryId:d}).then(M=>{var D;if(!E&&(g(M),!c)){const P=(D=M[0])==null?void 0:D.infoType;P&&K(P)}}).catch(()=>{E||g([])}),()=>{E=!0}},[c,d]),n.useEffect(()=>{if(c||!$e)return;const E={},M={},D={},P={};for(const k of $e.payloadFields)$e.infoType==="question"&&k.key==="definition"&&k.inputType==="json"?E[k.key]=_a:E[k.key]="";for(const k of $e.linkFields)k.multiple?D[k.key]=[]:M[k.key]=null,k.targetTypes.length>0&&(P[k.key]=k.targetTypes[0]);y(E),B(M),W(D),ee(P)},[$e==null?void 0:$e.infoType,c]),n.useEffect(()=>{if(S!=="question")return;const E=x.definition??"";if(!E.trim()){const M=Da(JSON.parse(_a))??Ya();ke(M),Ee(_a);return}try{const M=JSON.parse(E),D=Da(M);if(!D)return;ke(D),Ee(JSON.stringify(M,null,2))}catch{}},[x.definition,S]),n.useEffect(()=>{if(!c||!b||w.length===0)return;let E=!1;return F("loading"),R(null),(async()=>{const D=await ta({libraryId:d,infoId:b});if(E)return;const P=D.infoType;K(P);const k=w.find(Y=>Y.infoType===P);if(!k){F("idle");return}const T=D.payload??{},I={};for(const Y of k.payloadFields)I[Y.key]=Ss(T[Y.key]);y(I);const de=D.links??{}??{},xe={},he={},te={},A=[];for(const Y of k.linkFields){Y.targetTypes.length>0&&(te[Y.key]=Y.targetTypes[0]);const re=de[Y.key];if(Y.multiple){const G=Array.isArray(re)?re.filter(Z=>typeof Z=="string"):[];he[Y.key]=[];for(const Z of G)A.push(ta({libraryId:d,infoId:Z}).then(Ae=>{if(E)return;const ge={id:Z,infoType:Ae.infoType,label:Ts(Ae.payload,Z)};te[Y.key]=ge.infoType,he[Y.key]=[...he[Y.key],ge]}).catch(()=>{}))}else{const G=typeof re=="string"?re:null;xe[Y.key]=null,G&&A.push(ta({libraryId:d,infoId:G}).then(Z=>{if(E)return;const Ae={id:G,infoType:Z.infoType,label:Ts(Z.payload,G)};te[Y.key]=Ae.infoType,xe[Y.key]=Ae}).catch(()=>{}))}}await Promise.all(A),!E&&(B(xe),W(he),ee(te),F("idle"))})().catch(()=>{E||(R("Failed to load info details."),F("idle"))}),()=>{E=!0}},[b,c,d,w]),n.useEffect(()=>{S==="source"&&Me(ki(x,ce.resource??null))},[S,x.sourceKind,x.locator,(Ce=ce.resource)==null?void 0:Ce.id,(ze=ce.resource)==null?void 0:ze.infoType,(tt=ce.resource)==null?void 0:tt.label]);const Ge=E=>{var k,T;const M=((k=st==null?void 0:st.payloadFields.find(I=>I.key==="sourceKind"))==null?void 0:k.keepOnCreate)??!1,D=((T=st==null?void 0:st.linkFields.find(I=>I.key==="resource"))==null?void 0:T.keepOnCreate)??!1,P=za();return P.sourceKind=M?E.sourceKind:P.sourceKind,D&&(P.work=E.work,P.bookMedia=E.bookMedia,P.churchDocument=E.churchDocument),M&&E.sourceKind==="bible"&&(P.locatorValue=E.locatorValue,P.bibleBookDisplay=E.bibleBookDisplay),M&&E.sourceKind==="website"&&(P.sourceUrl=E.sourceUrl,P.sourceAccessedDate=E.sourceAccessedDate),P},jt=n.useMemo(()=>({sourceKindLabel:t.cogita.library.add.info.sourceKindLabel,bibleBookLabel:t.cogita.library.add.info.sourceBibleBookLabel,bibleBookPlaceholder:t.cogita.library.add.info.sourceBibleBookPlaceholder,bibleRestLabel:t.cogita.library.add.info.sourceBibleRestLabel,bibleRestPlaceholder:t.cogita.library.add.info.sourceBibleRestPlaceholder,churchDocumentLabel:t.cogita.library.add.info.sourceResourceLabel,churchDocumentPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,workLabel:t.cogita.library.add.info.sourceResourceLabel,workPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,bookLabel:t.cogita.library.add.info.sourceResourceLabel,bookPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,locatorLabel:t.cogita.library.list.typeFilterLocator,locatorPlaceholder:t.cogita.library.list.typeFilterLocator}),[t]),Oe=async E=>{const M=$[E]??za();if(!Ms(M)){V(D=>({...D,[E]:t.cogita.library.add.info.referenceMissingSource}));return}ne(E),V(D=>({...D,[E]:null}));try{const D=An(M),P=D?{resource:D.id}:{},k={label:Is(M),sourceKind:M.sourceKind.trim(),locator:$n(M)},I={id:(await qn({libraryId:d,infoType:"source",payload:k,links:P})).infoId,infoType:"source",label:k.label};if(W(de=>{const xe=de[E]??[];return xe.some(he=>he.id===I.id)?de:{...de,[E]:[...xe,I]}}),c&&b){const de=await ta({libraryId:d,infoId:b}),xe=de.links&&typeof de.links=="object"?{...de.links}:{},he=xe[E],te=Array.isArray(he)?he.filter(A=>typeof A=="string"):typeof he=="string"?[he]:[];te.includes(I.id)||(xe[E]=[...te,I.id],await cs({libraryId:d,infoId:b,payload:de.payload,links:xe}))}z(de=>({...de,[E]:Ge(M)})),V(de=>({...de,[E]:null}))}catch(D){V(P=>({...P,[E]:Cs(D,t.cogita.library.lookup.createFailed)}))}finally{ne(D=>D===E?null:D)}},Be=async()=>{var D;if(!$e)return;const E={};for(const P of $e.payloadFields){if(S==="source"&&(P.key==="sourceKind"||P.key==="locator"))continue;const k=(x[P.key]??"").trim();if(!k){if(P.required){R(`Field '${P.label}' is required.`);return}continue}if(P.inputType==="json")try{E[P.key]=JSON.parse(k)}catch{R(`Field '${P.label}' must be valid JSON.`);return}else E[P.key]=k}const M={};for(const P of $e.linkFields)if(!(S==="source"&&P.key==="resource"))if(P.multiple){const k=(p[P.key]??[]).map(T=>T.id);if(P.required&&k.length===0){R(`Link '${P.label}' is required.`);return}k.length>0&&(M[P.key]=k)}else{const k=((D=ce[P.key])==null?void 0:D.id)??null;if(P.required&&!k){R(`Link '${P.label}' is required.`);return}k&&(M[P.key]=k)}if(S==="source"){if(!Ms(X)){R(t.cogita.library.add.info.referenceMissingSource);return}const P=X.sourceKind.trim();E.sourceKind=P,E.locator=$n(X),(typeof E.label!="string"||!E.label.trim())&&(E.label=Is(X));const k=An(X);k&&(M.resource=k.id)}F("saving"),R(null);try{if(c&&b)await cs({libraryId:d,infoId:b,payload:E,links:M}),R("Info updated.");else{await qn({libraryId:d,infoType:S,payload:E,links:M}),R("Info saved.");const P={};for(const I of $e.payloadFields)P[I.key]=I.keepOnCreate?x[I.key]??"":"";y(P);const k={},T={};for(const I of $e.linkFields)I.multiple?T[I.key]=I.keepOnCreate?p[I.key]??[]:[]:k[I.key]=I.keepOnCreate?ce[I.key]??null:null;B(I=>({...I,...k})),W(I=>({...I,...T})),S==="source"&&Me(I=>{const de=Ge(I),xe=An(de);return y(he=>({...he,sourceKind:de.sourceKind,locator:Ss($n(de))})),B(he=>({...he,resource:xe})),xe&&ee(he=>({...he,resource:xe.infoType})),de})}}catch(P){R(Cs(P,"Failed to save info."))}finally{F("idle")}},rt=E=>{const M=x[E.key]??"";if(S==="question"&&E.key==="definition"&&E.inputType==="json"){const P=ae.type,k=A=>{const Y=ae.title??"",re=ae.question??"";Te({...Ya(A),title:Y,question:re})},T=A=>A.length===0?[""]:A[A.length-1].trim()?[...A,""]:A,I=A=>{const Y=(A.length?A:[[""],[""]]).map(re=>T(re));return Y.length>=2?Y:[...Y,[""]]},de=(A,Y)=>{const re=A.map(Z=>Array.from({length:Y},(Ae,ge)=>Z[ge]??"")).filter(Z=>Z.some(Ae=>Ae.trim())||Z===A[A.length-1]);return re.length===0?[new Array(Y).fill("")]:re[re.length-1].some(Z=>Z.trim())?[...re,new Array(Y).fill("")]:re},xe=Array.isArray(ae.answer)?ae.answer:[],he=I(ae.columns??[[""],[""]]),te=de(ae.matchingPaths??[[]],he.length);return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:E.label}),e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.8rem"},children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question type"}),e.jsxs("select",{value:P,onChange:A=>k(A.target.value),children:[e.jsx("option",{value:"selection",children:"Selection"}),e.jsx("option",{value:"truefalse",children:"True / false"}),e.jsx("option",{value:"text",children:"Text answer"}),e.jsx("option",{value:"number",children:"Number answer"}),e.jsx("option",{value:"date",children:"Date answer"}),e.jsx("option",{value:"matching",children:"Matching"}),e.jsx("option",{value:"ordering",children:"Right order"})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Title"}),e.jsx("input",{type:"text",value:ae.title??"",onChange:A=>Te({...ae,title:A.target.value}),placeholder:"Optional title"})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question"}),e.jsx("textarea",{rows:3,value:ae.question??"",onChange:A=>Te({...ae,question:A.target.value}),placeholder:"Question text"})]}),P==="selection"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Options / correct indices"}),T(ae.options??[""]).map((A,Y,re)=>{const G=new Set(xe.filter(Ae=>Number.isInteger(Ae))),Z=Y===re.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:G.has(Y),disabled:!A.trim(),onChange:Ae=>{const ge=Ae.target.checked?[...G,Y]:[...G].filter(be=>be!==Y);Te({...ae,answer:ge})}}),e.jsx("input",{type:"text",value:A,placeholder:`Answer ${Y+1}`,onChange:Ae=>{const ge=[...ae.options??[""]];ge[Y]=Ae.target.value;const be=T(ge),Ve=be.length-1,nt=xe.filter(He=>He>=0&&He<Ve);Te({...ae,options:be,answer:nt})}}),Z?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const ge=(ae.options??[""]).filter((Ve,nt)=>nt!==Y),be=xe.filter(Ve=>Ve!==Y).map(Ve=>Ve>Y?Ve-1:Ve);Te({...ae,options:T(ge),answer:be})},children:"Remove"})]},`question-option:${Y}`)})]}):null,P==="text"||P==="date"||P==="number"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsx("input",{type:P==="date"?"date":"text",value:typeof ae.answer=="string"||typeof ae.answer=="number"?String(ae.answer):"",onChange:A=>Te({...ae,answer:A.target.value})})]}):null,P==="truefalse"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsxs("select",{value:String(!!ae.answer),onChange:A=>Te({...ae,answer:A.target.value==="true"}),children:[e.jsx("option",{value:"true",children:"True"}),e.jsx("option",{value:"false",children:"False"})]})]}):null,P==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Columns"}),he.map((A,Y)=>e.jsxs("div",{style:{display:"grid",gap:"0.35rem",border:"1px solid rgba(120,170,220,0.22)",borderRadius:"0.6rem",padding:"0.55rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"0.5rem"},children:[e.jsxs("span",{style:{fontSize:"0.8rem",color:"rgba(184,209,234,0.85)"},children:["Column ",Y+1]}),he.length>2?e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const re=he.filter((Z,Ae)=>Ae!==Y),G=te.map(Z=>Z.filter((Ae,ge)=>ge!==Y));Te({...ae,columns:I(re),matchingPaths:de(G,Math.max(2,re.length))})},children:"Remove column"}):null]}),A.map((re,G)=>{const Z=G===A.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",gap:"0.4rem",alignItems:"center"},children:[e.jsx("input",{type:"text",value:re,placeholder:`Option ${G+1}`,onChange:Ae=>{const ge=he.map(be=>[...be]);ge[Y][G]=Ae.target.value,Te({...ae,columns:I(ge),matchingPaths:de(te,he.length)})}}),Z?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const Ae=he.map(ge=>[...ge]);Ae[Y]=Ae[Y].filter((ge,be)=>be!==G),Te({...ae,columns:I(Ae),matchingPaths:de(te,he.length)})},children:"Remove"})]},`question-column:${Y}:row:${G}`)})]},`question-column:${Y}`)),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{const A=[...he.map(re=>[...re]),[""]],Y=te.map(re=>[...re,""]);Te({...ae,columns:I(A),matchingPaths:de(Y,A.length)})},children:"Add column"})}),e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Correct paths (0-based indices)"}),te.map((A,Y)=>{const re=Y===te.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:`repeat(${he.length}, minmax(0,1fr)) auto`,gap:"0.35rem",alignItems:"center"},children:[A.map((G,Z)=>e.jsx("input",{type:"number",min:0,step:1,value:G,placeholder:`${Z}`,onChange:Ae=>{const ge=te.map(nt=>[...nt]);ge[Y][Z]=Ae.target.value;const be=de(ge,he.length),Ve=be.map(nt=>nt.map(He=>He.trim())).filter(nt=>nt.every(He=>He!=="")).map(nt=>nt.map(He=>Number(He))).filter(nt=>nt.every(He=>Number.isInteger(He)&&He>=0));Te({...ae,matchingPaths:be,answer:{paths:Ve}})}},`question-path:${Y}:${Z}`)),re?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const G=te.filter((ge,be)=>be!==Y),Z=de(G,he.length),Ae=Z.map(ge=>ge.map(be=>be.trim())).filter(ge=>ge.every(be=>be!=="")).map(ge=>ge.map(be=>Number(be))).filter(ge=>ge.every(be=>Number.isInteger(be)&&be>=0));Te({...ae,matchingPaths:Z,answer:{paths:Ae}})},children:"Remove"})]},`question-path:${Y}`)})]}):null,P==="ordering"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Ordered options (correct order = listed order)"}),T(ae.options??[""]).map((A,Y,re)=>{const G=Y===re.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)",minWidth:"1.5rem"},children:[Y+1,"."]}),e.jsx("input",{type:"text",value:A,placeholder:`Step ${Y+1}`,onChange:Z=>{const Ae=[...ae.options??[""]];Ae[Y]=Z.target.value,Te({...ae,options:T(Ae)})}}),G?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>Te({...ae,options:T((ae.options??[]).filter((Z,Ae)=>Ae!==Y))}),children:"Remove"})]},`question-order:${Y}`)})]}):null,e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"JSON import"}),e.jsx("textarea",{rows:8,value:Le,onChange:A=>Ee(A.target.value),placeholder:"Paste question JSON"}),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{try{const A=JSON.parse(Le),Y=Da(A);if(!Y){R("Question JSON must be an object.");return}Te(Y),R(null)}catch{R("Question JSON is invalid.")}},children:"Interpret JSON"})})]})]})]},`payload:${E.key}`)}const D=E.inputType==="textarea"||E.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:E.label}),D?e.jsx("textarea",{rows:E.inputType==="json"?8:4,value:M,onChange:P=>y(k=>({...k,[E.key]:P.target.value})),placeholder:E.key}):e.jsx("input",{type:"text",value:M,onChange:P=>y(k=>({...k,[E.key]:P.target.value})),placeholder:E.key})]},`payload:${E.key}`)},ht=E=>{const M=N[E.key]??E.targetTypes[0],D=E.key==="references"&&E.multiple&&E.targetTypes.includes("source"),P=$[E.key]??za(),k=Q[E.key]??!1,T=H[E.key];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:E.label}),E.targetTypes.length>1?e.jsx("select",{value:M,onChange:I=>ee(de=>({...de,[E.key]:I.target.value})),children:E.targetTypes.map(I=>e.jsx("option",{value:I,children:ot(t,I)},`${E.key}:${I}`))}):null,E.multiple?e.jsx(Yt,{libraryId:d,infoType:M,label:E.label,placeholder:E.key,multiple:!0,values:p[E.key]??[],onChangeMultiple:I=>W(de=>({...de,[E.key]:I})),allowCreate:!D,searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(Yt,{libraryId:d,infoType:M,label:E.label,placeholder:E.key,value:ce[E.key]??null,onChange:I=>B(de=>({...de,[E.key]:I})),searchFailedText:"Search failed",createFailedText:"Create failed"}),D?e.jsxs("div",{children:[e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:k,onChange:I=>L(de=>({...de,[E.key]:I.target.checked}))}),e.jsx("span",{children:t.cogita.library.add.info.referenceToggle})]}),k?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(ks,{libraryId:d,copy:t,language:m,sourceKindOptions:[...Ns],value:P,onChange:I=>z(de=>({...de,[E.key]:I})),labels:jt}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>Oe(E.key),disabled:me===E.key,children:me===E.key?t.cogita.library.lookup.saving:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.source)})}),T?e.jsx("p",{className:"cogita-library-subtitle",children:T}):null]}):null]}):null]},`link:${E.key}`)},et=()=>e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(ks,{libraryId:d,copy:t,language:m,sourceKindOptions:[...Ns],value:X,onChange:Me,labels:jt})]});return e.jsx(Et,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:c?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${d}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[c?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:S,onChange:E=>K(E.target.value),children:mt.map(E=>e.jsx("option",{value:E.value,children:E.label},E.value))})]}),pe==="loading"&&c?e.jsx("p",{children:"Loading..."}):null,$e&&!(pe==="loading"&&c)?e.jsxs("div",{className:"cogita-form-grid",children:[$e.payloadFields.filter(E=>!(S==="source"&&(E.key==="sourceKind"||E.key==="locator"))).map(rt),S==="source"?et():null,$e.linkFields.filter(E=>!(S==="source"&&E.key==="resource")).map(ht)]}):pe==="loading"&&c?null:e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:Be,disabled:pe==="saving"||!$e,children:pe==="saving"?"Saving...":c?"Update info":"Create info"})}),U?e.jsx("p",{className:"cogita-library-subtitle",children:U}):null]})})})]})})}const Ls=t=>/\s/.test(t),sn=t=>/[\p{L}\p{N}]/u.test(t),As=(t,a)=>{const r=a>0?t[a-1]:"",s=a<t.length?t[a]:"";if(!r||!s)return 0;const i=Ls(r),o=Ls(s);if(i||o)return 3;const h=sn(r),j=sn(s);return h!==j?2:!h&&!j?1:0},Rn=(t,a,r,s,i)=>{const o=Math.max(s-a,r-s);for(let h=0;h<=o;h+=1){const j=s-h;if(j>=a&&j<=r&&As(t,j)>=i)return j;const m=s+h;if(m>=a&&m<=r&&As(t,m)>=i)return m}return null},Pn=(t,a)=>{const r=a>0?t[a-1]:"",s=a<t.length?t[a]:"";return!r||!s?!0:sn(r)!==sn(s)},Si=(t,a,r,s)=>{const i=r-a,o=a+s,h=r-s;if(i<=s*2||h<=o)return null;const j=Math.floor((a+r)/2),m=Rn(t,o,h,j,3);if(m!==null&&Pn(t,m))return m;const v=Rn(t,o,h,j,2);if(v!==null&&Pn(t,v))return v;const d=Rn(t,o,h,j,1);return d!==null&&Pn(t,d)?d:null},va=(t,a)=>{const r=Math.max(1,(a==null?void 0:a.minLen)??7),s=Math.max(r,(a==null?void 0:a.maxLen)??13),i={},o=(m,v,d,b,l)=>{const c=String(b),w={id:c,start:m,end:v,text:t.slice(m,v),depth:d,index:b,parentId:l};if(i[c]=w,v-m>s){let S=Si(t,m,v,r);if(S!==null&&S>m&&S<v){const K=o(m,S,d+1,b*2+1,c),x=o(S,v,d+1,b*2+2,c);w.leftId=K.id,w.rightId=x.id}}return w},h=o(0,t.length,0,0),j=Object.values(i).sort((m,v)=>v.depth-m.depth||m.start-v.start).map(m=>m.id);return{text:t,rootId:h.id,nodes:i,order:j}},$a=(t,a,r,s,i,o,h)=>{const j=o==="reverse"?t.order.slice().sort((m,v)=>t.nodes[v].start-t.nodes[m].start||t.nodes[v].depth-t.nodes[m].depth):t.order;for(const m of j){if(h&&m===h||a.has(m))continue;const v=t.nodes[m];if(v){if(i&&(v.leftId||v.rightId)){const d=v.leftId?r[v.leftId]??0:s,b=v.rightId?r[v.rightId]??0:s;if((d+b)/2<s)continue}return v}}return null},xn=(t,a)=>({before:t.slice(0,a.start),fragment:t.slice(a.start,a.end),after:t.slice(a.end)});function Ti({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,libraryId:d}){const b=`/#/cogita/library/${d}`,[l,c,w]=Hn([]),[g,S,K]=Wn([]),[x,y]=n.useState(null),[ce,B]=n.useState(null),[p,W]=n.useState(null),[N,ee]=n.useState(null),U=n.useMemo(()=>l.find(L=>L.id===x)??null,[l,x]);n.useEffect(()=>{let L=!0;return vr({libraryId:d}).then($=>{if(!L)return;const z=$.nodes.map(H=>{var V,me,ne;return{id:H.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:H.payload&&typeof H.payload=="object"&&"label"in H.payload?String(H.payload.label):"Item",nodeType:H.nodeType,itemType:((V=H.payload)==null?void 0:V.itemType)??"info",itemId:((me=H.payload)==null?void 0:me.itemId)??null,infoType:((ne=H.payload)==null?void 0:ne.infoType)??null}}});c(z),S($.edges.map(H=>({id:H.edgeId,source:H.fromNodeId,target:H.toNodeId})))}).catch(()=>{L&&(c([]),S([]))}),()=>{L=!1}},[d]),n.useEffect(()=>{wr({libraryId:d}).then(B).catch(()=>B(null))},[d,l,g]);const R=n.useCallback(L=>{S($=>Qn(L,$))},[]),pe=()=>{const L=crypto.randomUUID();c($=>[...$,{id:L,type:"default",position:{x:140+$.length*40,y:120+$.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},F=()=>{const L=crypto.randomUUID();c($=>[...$,{id:L,type:"default",position:{x:180+$.length*40,y:160+$.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},X=async()=>{W(null);try{const L=l.map(z=>({nodeId:z.id,nodeType:z.data.nodeType,payload:{itemType:z.data.itemType,itemId:z.data.itemId??null,label:z.data.label,infoType:z.data.infoType??null}})),$=g.map(z=>({edgeId:z.id,fromNodeId:z.source,toNodeId:z.target}));await jr({libraryId:d,nodes:L,edges:$}),W(t.cogita.library.graph.saveSuccess)}catch{W(t.cogita.library.graph.saveFail)}},Me=L=>{U&&c($=>$.map(z=>z.id===U.id?{...z,data:{...z.data,itemId:(L==null?void 0:L.infoId)??null,itemType:"collection",infoType:"collection",label:(L==null?void 0:L.label)??t.cogita.library.infoTypes.collection}}:z))},Q=L=>{U&&c($=>$.map(z=>z.id===U.id?{...z,data:{...z.data,itemId:(L==null?void 0:L.infoId)??null,itemType:"info",infoType:(L==null?void 0:L.infoType)??null,label:(L==null?void 0:L.label)??t.cogita.library.infoTypes.any}}:z))};return n.useEffect(()=>{if(!U||U.data.nodeType!=="info"||U.data.infoType!=="citation"||!U.data.itemId){ee(null);return}let L=!0;return ta({libraryId:d,infoId:U.data.itemId}).then($=>{if(!L)return;const z=$.payload,H=(z==null?void 0:z.text)??"";if(!H){ee(null);return}const V=va(H),me=Object.values(V.nodes).sort((ne,ae)=>ne.depth-ae.depth||ne.start-ae.start).map(ne=>({id:ne.id,text:ne.text,depth:ne.depth}));ee({title:(z==null?void 0:z.title)??U.data.label,fragments:me})}).catch(()=>ee(null)),()=>{L=!1}},[d,U]),e.jsx(Et,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:b,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:X,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:pe,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:F,children:t.cogita.library.actions.addInfo}),ce?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(ce.totalCollections))})}):null,p?e.jsx("p",{className:"cogita-help",children:p}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(pn,{nodes:l,edges:g,onNodesChange:w,onEdgesChange:K,onConnect:R,onNodeClick:(L,$)=>y($.id),fitView:!0,children:[e.jsx(fn,{gap:18,size:1}),e.jsx(bn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),U?e.jsxs("div",{className:"cogita-graph-inspector",children:[U.data.nodeType==="collection"?e.jsx(Yt,{libraryId:d,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:U.data.itemId?{id:U.data.itemId,label:U.data.label,infoType:"collection"}:null,onChange:Me,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(Yt,{libraryId:d,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:U.data.itemId?{id:U.data.itemId,label:U.data.label,infoType:U.data.infoType??void 0}:null,onChange:Q,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),N?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:N.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:N.fragments.map(L=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:L.id}),e.jsx("span",{children:L.text})]},L.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function es({children:t,flashState:a,flashTick:r=0,feedbackToken:s,className:i}){const o=s??(a?`${a}-${r}`:"idle");return e.jsx("section",{className:i?`cogita-revision-card ${i}`:"cogita-revision-card","data-feedback":o,children:t})}function ts({copy:t,currentCard:a,currentTypeLabel:r,prompt:s,languages:i,answer:o,onAnswerChange:h,computedExpected:j,computedAnswers:m,onComputedAnswerChange:v,answerTemplate:d,outputVariables:b,variableValues:l,computedFieldFeedback:c,feedback:w,canAdvance:g,quoteContext:S,quotePlaceholder:K,onCheckAnswer:x,onSkip:y,onLanguageSelect:ce,onMarkReviewed:B,onAdvance:p,showCorrectAnswer:W,setShowCorrectAnswer:N,onRevealCorrect:ee,answerMask:U,expectedAnswer:R,hasExpectedAnswer:pe,handleComputedKeyDown:F,answerInputRef:X,computedInputRefs:Me,scriptMode:Q,setScriptMode:L,matchPairs:$,matchLeftOrder:z,matchRightOrder:H,matchSelection:V,matchActiveLeft:me,matchActiveRight:ne,matchFeedback:ae,onMatchLeftSelect:ke,onMatchRightSelect:Le,disableCheckAnswer:Ee=!1,hideSkipAction:$e=!1,allowRevealBeforeCheck:st=!1,autoRevealAfterAnswer:mt=!1,disableCheckAfterAnswer:Te=!1}){const Ge=n.useMemo(()=>{var Y;const M=!d&&j.length===2?`The {${j[0].key}} is of type {${j[1].key}}`:null,D=d??M;if(!D)return null;const P=new Map(j.map(re=>[re.key,re.expected])),k=new Set,T=[],I=/\{([^}]+)\}/g;let de=0,xe,he=null;for(;(xe=I.exec(D))!==null;){const re=D.slice(de,xe.index);re&&T.push({type:"text",value:re});const G=((Y=xe[1])==null?void 0:Y.trim())??"",Z=G&&P.has(G)?G:G&&b&&b[G]?b[G]:null;G&&k.add(G),Z&&k.add(Z),Z&&P.has(Z)?(T.push({type:"input",value:Z}),he||(he=Z)):G&&l&&l[G]!==void 0?T.push({type:"text",value:l[G]}):T.push({type:"text",value:xe[0]}),de=xe.index+xe[0].length}const te=D.slice(de);return te&&T.push({type:"text",value:te}),j.filter(re=>!k.has(re.key)).length>0?null:{parts:T,expectedByKey:P,firstInputKey:he}},[d,j,b,l]),jt=()=>{if(!Ge)return null;const{parts:M,expectedByKey:D,firstInputKey:P}=Ge;return e.jsx("div",{className:"cogita-revision-inline-answer",children:M.map((k,T)=>{var I,de;return k.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:k.value},`text-${T}`):e.jsx("input",{ref:xe=>{Me.current[k.value]=xe},autoFocus:k.value===P,value:m[k.value]??"",onChange:xe=>v(k.value,xe.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":c[k.value]??(w==="correct"?"correct":w==="incorrect"?"incorrect":void 0),onKeyDown:xe=>ht(xe)||F(xe),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((I=m[k.value])==null?void 0:I.length)??0,((de=D.get(k.value))==null?void 0:de.length)??6)}ch`}},`input-${k.value}-${T}`)})})},Oe=n.useMemo(()=>{const M=new Map;return($??[]).forEach(D=>M.set(D.leftId,D)),M},[$]),Be=n.useMemo(()=>{const M=new Map;return($??[]).forEach(D=>M.set(D.rightId,D)),M},[$]);n.useEffect(()=>{var T;if(a.cardType!=="info"||a.infoType!=="computed"||j.length===0)return;const M=typeof document<"u"?document.activeElement:null;if(M&&(M.tagName==="INPUT"||M.tagName==="TEXTAREA"))return;const D=(Ge==null?void 0:Ge.firstInputKey)??((T=j[0])==null?void 0:T.key);if(!D)return;const P=Me.current[D];if(!P)return;const k=requestAnimationFrame(()=>{P.focus()});return()=>cancelAnimationFrame(k)},[a,j,Ge]);const rt=(()=>{const M=[R??"",...j.map(k=>k.expected??"")].join(""),D=[o,...Object.values(m)].join(""),P=`${M}${D}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(P)})(),ht=M=>M.ctrlKey&&(M.key==="^"||M.key==="6")?(M.preventDefault(),L(D=>D==="super"?null:"super"),!0):M.ctrlKey&&(M.key==="_"||M.key==="-")?(M.preventDefault(),L(D=>D==="sub"?null:"sub"),!0):!1,et=()=>{if(!R||!U)return R??"";const M=R.split(""),D=Array.from(U),P=D.length>0?D.reduce((k,T)=>k+T,0)/D.length:127;return M.map((k,T)=>{const I=D[T]??P,de=Math.max(0,Math.min(255,Math.round(I)));let xe=255,he=0;return de<=127?he=Math.round(de/127*255):(he=255,xe=Math.round(255*(1-(de-127)/128))),e.jsx("span",{style:{color:`rgb(${xe}, ${he}, 0)`},children:k},`mask-${T}`)})},Ce=a.cardType==="info"&&a.infoType==="citation"?(S==null?void 0:S.title)||a.label:a.description,ze=W||mt&&w!==null,tt=Ee||Te&&(w!==null||ze),E=pe&&(st||w==="incorrect"||ze);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[r?e.jsx("span",{children:r}):null,e.jsx("strong",{children:Ce})]}),a.cardType==="vocab"&&a.checkType==="translation-match"&&$?e.jsxs("div",{className:"cogita-revision-body",children:[s?e.jsx("h2",{children:s}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(z??[]).map(M=>{const D=Oe.get(M);if(!D)return null;const P=(V==null?void 0:V[M])??null,k=(ae==null?void 0:ae[M])??null,T=me===M;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":T,"data-state":k??void 0,"data-locked":P?"true":void 0,onClick:()=>ke==null?void 0:ke(M),children:[e.jsx("span",{children:D.leftLabel}),P&&W?e.jsx("em",{children:"✓"}):null]},M)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(H??[]).map(M=>{const D=Be.get(M);if(!D)return null;const P=Object.values(V??{}).includes(M),k=ne===M;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":P||k,"data-locked":P?"true":void 0,onClick:()=>Le==null?void 0:Le(M),children:e.jsx("span",{children:D.rightLabel})},M)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:a.checkType==="translation-match"||tt,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):a.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:s}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:X,value:o,onChange:M=>h(M.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":w==="correct"?"correct":w==="incorrect"?"incorrect":void 0,onKeyDown:M=>{if(M.key==="Enter")if(M.preventDefault(),M.stopPropagation(),g)p();else{if(tt)return;x()}}})]}),rt?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":Q==="super",onClick:()=>L(M=>M==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":Q==="sub",onClick:()=>L(M=>M==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:tt,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[a.label?e.jsx("p",{className:"cogita-revision-hint",children:a.label}):null,d?null:e.jsx(kr,{value:s??"",mode:"auto"}),j.length>0?(()=>{const M=jt();return M?e.jsx("div",{className:"cogita-inline-answer-wrap",children:M}):e.jsx("div",{className:"cogita-form-grid",children:j.map((D,P)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:D.key}),e.jsx("textarea",{ref:k=>{Me.current[D.key]=k},autoFocus:P===0,value:m[D.key]??"",onChange:k=>v(D.key,k.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":c[D.key]??(w==="correct"?"correct":w==="incorrect"?"incorrect":void 0),onKeyDown:k=>ht(k)||F(k)})]},D.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:X,value:o,onChange:M=>h(M.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":w==="correct"?"correct":w==="incorrect"?"incorrect":void 0,onKeyDown:M=>{if(!ht(M)&&M.key==="Enter")if(M.preventDefault(),M.stopPropagation(),g)p();else{if(tt)return;x()}}})]})}),rt?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":Q==="super",onClick:()=>L(M=>M==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":Q==="sub",onClick:()=>L(M=>M==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:tt,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="citation"&&S?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(S.completed)).replace("{total}",String(S.total))}),e.jsx("p",{className:"cogita-quote-text",children:S.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:X,value:o,onChange:M=>h(M.target.value),placeholder:K??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":w==="correct"?"correct":w==="incorrect"?"incorrect":void 0,onKeyDown:M=>{if(M.key==="Enter")if(M.preventDefault(),M.stopPropagation(),g)p();else{if(tt)return;x()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:S.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:tt,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:s}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:i.length?i.map(M=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>ce(M.label),children:M.label},M.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:s}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:B,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}),w&&e.jsx("div",{className:"cogita-revision-feedback","data-state":w,children:w==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),E?e.jsxs("div",{className:"cogita-revision-reveal",children:[ze?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>N(M=>{const D=!M;return D&&ee(),D}),children:t.cogita.library.revision.showAnswer}),ze?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),j.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[j.map(M=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:M.key}),e.jsx("span",{children:M.expected})]},M.key)),R?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:R})]}):null]}):e.jsx("p",{children:U?et():R})]}):null]}):null,g?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:p,children:t.cogita.library.revision.nextQuestion})}):null]})}const $s={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},Ci=(t,a)=>{const r=Math.max(t.length,a.length,1),s=Math.abs(t.length-a.length);return Math.max(0,1-s/r)},Ii=(t,a)=>{const r=new Uint8Array(t.length),s=Ci(t,a);for(let i=0;i<t.length;i+=1){const o=t[i]===(a[i]??"")?128:0,h=t.length-1-i,j=a.length-1-i,m=t[h]===(a[j]??"")?127:0,v=Math.round((o+m)*s);r[i]=Math.max(0,Math.min(255,v))}return r},Mi=(t,a)=>t===a||($s[t]??[]).includes(a)?!0:($s[a]??[]).includes(t),Xa=(t,a,r)=>r?Mi(t,a):t===a,rn=(t,a,r)=>{const s=new Uint8Array(t.length);if(!t.length)return s;const i=(r==null?void 0:r.allowSimilarChars)??!0,o=[];for(let j=0;j<=t.length-3;j+=1)o.push({index:j,text:t.slice(j,j+3)});let h=!1;return o.forEach(j=>{for(let m=0;m<=a.length-3;m+=1){const v=a.slice(m,m+3);let d=0;for(let g=0;g<3;g+=1)Xa(j.text[g],v[g],i)&&(d+=1);if(d<2)continue;let b=j.index-1,l=m-1;for(;b>=0&&l>=0;){const g=t[b],S=a[l];if(g===S){s[b]=Math.max(s[b],255),b-=1,l-=1,h=!0;continue}if(Xa(g,S,i)&&g!==S){s[b]=Math.max(s[b],127),b-=1,l-=1,h=!0;continue}if(b>0&&t[b-1]===S){s[b]=Math.max(s[b],0),b-=1,h=!0;continue}if(l>0&&t[b]===a[l-1]){l-=1,h=!0;continue}break}for(let g=0;g<3;g+=1){const S=j.index+g,K=j.text[g],x=v[g],y=K===x?255:Xa(K,x,i)?127:0;s[S]=Math.max(s[S],y),h=!0}let c=j.index+3,w=m+3;for(;c<t.length&&w<a.length;){const g=t[c],S=a[w];if(g===S){s[c]=Math.max(s[c],255),c+=1,w+=1,h=!0;continue}if(Xa(g,S,i)&&g!==S){s[c]=Math.max(s[c],127),c+=1,w+=1,h=!0;continue}if(c+1<t.length&&t[c+1]===S){s[c]=Math.max(s[c],0),c+=1,h=!0;continue}if(w+1<a.length&&t[c]===a[w+1]){w+=1,h=!0;continue}break}}}),h?s:Ii(t,a)},En=t=>/[\p{L}\p{N}]/u.test(t),Rs=t=>t.trim().toLowerCase(),xa=(t,a)=>{if(t.length===0)return 100;const r=(a==null?void 0:a.treatSimilarCharsAsSame)??!1,s=Array.from(t).reduce((i,o)=>r&&o===127?i+255:i+o,0);return Math.round(s/(t.length*255)*100)},Sa=(t,a,r)=>{const s=Math.max(0,Math.min(100,(r==null?void 0:r.thresholdPercent)??100)),i=(r==null?void 0:r.treatSimilarCharsAsSame)??!0,o=(r==null?void 0:r.ignorePunctuationAndSpacing)??!1,h=Rs(t),j=Rs(a);if(!o){const x=rn(h,j,{allowSimilarChars:i}),y=xa(x,{treatSimilarCharsAsSame:i});return{mask:x,percent:y,isCorrect:y>=s,normalizedExpected:h,normalizedAnswer:j}}const m=Array.from(h),v=Array.from(j),d=[],b=[],l=[];m.forEach((x,y)=>{En(x)&&(d.push(x),b.push(y))}),v.forEach(x=>{En(x)&&l.push(x)});const c=d.join(""),w=l.join(""),g=rn(c,w,{allowSimilarChars:i}),S=new Uint8Array(m.length);for(let x=0;x<S.length;x+=1)S[x]=En(m[x]??"")?0:255;for(let x=0;x<g.length;x+=1){const y=b[x];y!==void 0&&(S[y]=g[x])}const K=xa(g,{treatSimilarCharsAsSame:i});return{mask:S,percent:K,isCorrect:K>=s,normalizedExpected:c,normalizedAnswer:w}},Ra=(t,a,r)=>{const s=t.trim().toLowerCase(),i=a.trim().toLowerCase();return r==="prefix"||r==="bidirectional"?rn(s,i,{allowSimilarChars:!0}):rn(s,i,{allowSimilarChars:!0})};function Li(t){if(!t||typeof t!="object")return null;const r=t.definition;if(!r||typeof r!="object")return null;const s=r,i=typeof s.type=="string"?s.type:typeof s.kind=="string"?s.kind:"selection",o=i==="multi_select"||i==="single_select"?"selection":i==="boolean"?"truefalse":i==="order"?"ordering":i;if(!["selection","truefalse","text","number","date","ordering","matching"].includes(o))return null;const h=o,j=typeof s.title=="string"?s.title:void 0,m=typeof s.question=="string"?s.question:"",v=Array.isArray(s.options)?s.options.map(l=>typeof l=="string"?l:"").filter(Boolean):void 0,d=Array.isArray(s.columns)?s.columns.map(l=>Array.isArray(l)?l.map(c=>typeof c=="string"?c:"").filter(Boolean):[]).filter(l=>l.length>0):void 0,b=(()=>{if(o==="selection")return(Array.isArray(s.answer)?s.answer:Array.isArray(s.correct)?s.correct:[]).map(c=>Number(c)).filter(c=>Number.isInteger(c)&&c>=0);if(o==="truefalse")return typeof s.answer=="boolean"?s.answer:typeof s.expected=="boolean"?s.expected:!1;if(o==="matching"){const l=s.answer&&typeof s.answer=="object"?s.answer:null;return{paths:(Array.isArray(l==null?void 0:l.paths)?l==null?void 0:l.paths:Array.isArray(s.correctPairs)?s.correctPairs:[]).map(g=>Array.isArray(g)?g.map(S=>Number(S)).filter(S=>Number.isInteger(S)&&S>=0):[]).filter(g=>g.length>0)}}if(typeof s.answer=="string"||typeof s.answer=="number")return s.answer;if(typeof s.expected=="string"||typeof s.expected=="number")return s.expected})();return{type:h,title:j,question:m,options:v,columns:d,answer:b}}function Ai(t){const a=[...t];for(let r=a.length-1;r>0;r-=1){const s=Math.floor(Math.random()*(r+1));[a[r],a[s]]=[a[s],a[r]]}return a}function Ps(t){const a=t.map((i,o)=>({value:i,oldIndex:o}));for(let i=a.length-1;i>0;i-=1){const o=Math.floor(Math.random()*(i+1));[a[i],a[o]]=[a[o],a[i]]}const r=a.map(i=>i.value),s=new Map;return a.forEach((i,o)=>s.set(i.oldIndex,o)),{values:r,oldToNew:s}}function $i(t){if(t.type==="selection"){const a=t.options??[],r=Ps(a),s=Array.isArray(t.answer)?t.answer:[];return{...t,options:r.values,answer:s.map(i=>r.oldToNew.get(i)).filter(i=>Number.isInteger(i)).sort((i,o)=>i-o)}}if(t.type==="matching"){const r=(t.columns??[]).map(o=>Ps(o??[])),i=(t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[]).map(o=>o.map((h,j)=>{var m;return((m=r[j])==null?void 0:m.oldToNew.get(h))??h}));return{...t,columns:r.map(o=>o.values),answer:{paths:i}}}return t}function oa(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function Es(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function Ks(t){const a=t.checkType??"info",r=a.startsWith("question-")?`question / ${a.slice(9)}`:a;return t.direction?`${r} / ${t.direction}`:r}function Ri({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,libraryId:d,infoId:b,selectedReviewerRoleId:l}){const[c,w]=n.useState(b),[g,S]=n.useState([]),[K,x]=n.useState([]),[y,ce]=n.useState("loading"),[B,p]=n.useState(null),[W,N]=n.useState(null),[ee,U]=n.useState(null),[R,pe]=n.useState(null),[F,X]=n.useState(""),[Me,Q]=n.useState(null),[L,$]=n.useState(1),[z,H]=n.useState(null),[V,me]=n.useState(0),[ne,ae]=n.useState(!1),[ke,Le]=n.useState(null),[Ee,$e]=n.useState({}),[st,mt]=n.useState({}),[Te]=n.useState({}),[Ge,jt]=n.useState(null),[Oe,Be]=n.useState({selection:[],booleanAnswer:null,ordering:[],matchingRows:[],matchingSelection:[]}),rt=n.useRef(null),ht=n.useRef({}),et=mn();n.useEffect(()=>{let te=!1;return ce("loading"),Promise.all([ta({libraryId:d,infoId:b}).catch(()=>null),tn({libraryId:d,infoId:b}),an({libraryId:d,infoId:b})]).then(([A,Y,re])=>{if(te)return;const G=(A==null?void 0:A.payload)??{},Z=typeof G.title=="string"&&G.title||typeof G.label=="string"&&G.label||typeof G.name=="string"&&G.name||b;w(Z),N(G),U((A==null?void 0:A.infoType)??null),S(Y.items),x(re.items),ce("ready")}).catch(()=>{te||(N(null),U(null),S([]),x([]),ce("error"))}),()=>{te=!0}},[d,b]),n.useEffect(()=>{if(ee!=="translation"){pe(null);return}Hs({libraryId:d,infoId:b,approachKey:"vocab-card"}).then(te=>pe(te.projection??null)).catch(()=>pe(null))},[ee,b,d]);const Ce=n.useMemo(()=>{var Ae;const te=new Map(g.map(ge=>[oa(ge),ge])),A=new Map,Y=new Map;for(const ge of g)A.set(oa(ge),0),Y.set(oa(ge),[]);for(const ge of K){const be=Es({parentItemId:ge.parentItemId,parentCheckType:ge.parentCheckType,parentDirection:ge.parentDirection}),Ve=[ge.childItemId,ge.childCheckType??"",ge.childDirection??""].join("|");!te.has(be)||!te.has(Ve)||((Ae=Y.get(be))==null||Ae.push(Ve),A.set(Ve,(A.get(Ve)??0)+1))}const re=Array.from(A.entries()).filter(([,ge])=>ge===0).map(([ge])=>ge),G=new Map;for(const ge of re)G.set(ge,0);for(;re.length;){const ge=re.shift(),be=G.get(ge)??0;for(const Ve of Y.get(ge)??[]){const nt=Math.max(G.get(Ve)??0,be+1);G.set(Ve,nt),A.set(Ve,(A.get(Ve)??1)-1),(A.get(Ve)??0)<=0&&re.push(Ve)}}const Z=new Map;for(const ge of g){const be=oa(ge),Ve=G.get(be)??0,nt=Z.get(Ve)??[];nt.push(be),Z.set(Ve,nt)}return g.map(ge=>{const be=oa(ge),Ve=G.get(be)??0,nt=Z.get(Ve)??[be],He=Math.max(0,nt.indexOf(be));return{id:be,position:{x:40+He*290+(Ve%2?18:0),y:30+Ve*120},draggable:!1,selectable:!0,data:{label:ge.label,subtitle:Ks(ge),checkType:ge.checkType??"info",direction:ge.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[g,K]),ze=n.useMemo(()=>new Map(g.map(te=>[oa(te),te])),[g]),tt=n.useMemo(()=>{const te=[];for(const A of K){const Y=Es({parentItemId:A.parentItemId,parentCheckType:A.parentCheckType,parentDirection:A.parentDirection}),re=[A.childItemId,A.childCheckType??"",A.childDirection??""].join("|");!ze.has(Y)||!ze.has(re)||te.push({id:`${Y}->${re}`,source:Y,target:re,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return te},[ze,K]),E=n.useMemo(()=>B?ze.get(B)??null:null,[ze,B]);n.useEffect(()=>{X(""),H(null),me(0),ae(!1),Le(null),Q(null),mt({}),Be({selection:[],booleanAnswer:null,ordering:[],matchingRows:[],matchingSelection:[]})},[B]);const M=n.useMemo(()=>{var G,Z;if(!E)return null;const te=ee??E.infoType??null,A=E.checkType??"info",Y=E.direction??null,re=W??{};if(E.cardType==="vocab"&&R&&Array.isArray(R.words)){const Ae=R.words,ge=((G=Ae[0])==null?void 0:G.label)??"?",be=((Z=Ae[1])==null?void 0:Z.label)??"?";return Y==="a-to-b"?{kind:"vocab",prompt:String(ge),expected:String(be)}:Y==="b-to-a"?{kind:"vocab",prompt:String(be),expected:String(ge)}:{kind:"generic",prompt:`${ge} ↔ ${be}`,expected:`${ge} ↔ ${be}`}}if(te==="citation"&&A==="quote-fragment"&&Y&&typeof re.text=="string"){const Ae=Y,ge=va(re.text),be=ge.nodes[Ae];if(be){const Ve=xn(re.text,be);return{kind:"citation-fragment",expected:be.text,quoteContext:{title:c,before:Ve.before,after:Ve.after,total:Object.keys(ge.nodes).length,completed:0},quotePlaceholder:be.text.length>0?".".repeat(Math.max(4,Math.min(18,be.text.length))):"..."}}}if(te==="question"){const Ae=Li(re);if(Ae)return{kind:"question",definition:$i(Ae)}}return{kind:"generic",prompt:E.description||E.label,expected:E.label}},[ee,W,E,c,R]);n.useEffect(()=>{var A;if(!M||M.kind!=="question")return;const te=M.definition;Be({selection:[],booleanAnswer:null,ordering:te.type==="ordering"?Ai(te.options??[]):[],matchingRows:[],matchingSelection:te.type==="matching"?new Array(Math.max(2,((A=te.columns)==null?void 0:A.length)??2)).fill(null):[]})},[M,B]);const D=async te=>{if(E&&l)try{await Nr({libraryId:d,outcome:{itemType:"info",itemId:E.cardId,checkType:E.checkType??"info",direction:E.direction??null,revisionType:"direct",evalType:"direct-check",correct:te,clientId:"cogita-info-checkcards",clientSequence:L,personRoleId:l}}),$(A=>A+1),Q(te?"Saved as correct.":"Saved as incorrect.")}catch{Q("Failed to save answer.")}},P=E?oa(E):null,k=P?!!Ee[P]:!1,T=async()=>{var re;if(!E||!M)return;const te=oa(E);if(Ee[te]){Q("This card was already checked.");return}let A=!1,Y=null;if(M.kind==="question"){const G=M.definition;if(G.type==="selection"){const Z=Array.isArray(G.answer)?[...G.answer].sort((ge,be)=>ge-be):[],Ae=[...Oe.selection].sort((ge,be)=>ge-be);A=Z.length===Ae.length&&Z.every((ge,be)=>ge===Ae[be])}else if(G.type==="truefalse")A=typeof G.answer=="boolean"&&Oe.booleanAnswer!==null&&G.answer===Oe.booleanAnswer;else if(G.type==="ordering"){const Z=(G.options??[]).join(`
`),Ae=Oe.ordering.join(`
`),ge=Sa(Z,Ae,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});A=ge.isCorrect,Y=ge.mask}else if(G.type==="matching"){const Z=Math.max(2,((re=G.columns)==null?void 0:re.length)??2),Ae=Oe.matchingRows.map(nt=>nt.slice(0,Z)).filter(nt=>nt.length===Z&&nt.every(He=>Number.isInteger(He)&&He>=0)).map(nt=>JSON.stringify(nt)),ge=(G.answer&&typeof G.answer=="object"&&"paths"in G.answer?G.answer.paths:[]).map(nt=>JSON.stringify(nt)),be=Array.from(new Set(Ae)).sort(),Ve=Array.from(new Set(ge)).sort();A=be.length===Ve.length&&be.every((nt,He)=>nt===Ve[He])}else{const Z=String(G.answer??""),Ae=Sa(Z,F,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});A=Ae.isCorrect,Y=Ae.mask}Le(Y),ae(!0)}else{const G=M.expected,Z=M.kind==="citation-fragment",Ae=Sa(G,F,{thresholdPercent:Z?90:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:Z});A=Ae.isCorrect,Le(Ae.mask),ae(!0)}H(A?"correct":"incorrect"),me(G=>G+1),Q(l?null:"Answer checked locally (not saved: no person selected)."),$e(G=>({...G,[te]:!0})),l&&await D(A)},I=()=>{if(!E||!M)return;const te=oa(E);if(Ee[te]||($e(Y=>({...Y,[te]:!0})),Q("Answer revealed (not saved).")),M.kind==="question"){Le(null);return}const A=Sa(M.expected,M.expected,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:M.kind==="citation-fragment"});Le(A.mask)},de=n.useMemo(()=>E?E.infoType==="question"?{...E,description:E.label}:E.infoType==="citation"?{...E,description:c}:{...E,description:E.label}:null,[E,c]),xe=te=>{var He,Xe;const A=te.definition,Y=k||ne,re=Array.isArray(A.answer)?A.answer:[],G=A.answer&&typeof A.answer=="object"&&"paths"in A.answer?A.answer.paths:[],Z=Math.max(2,((He=A.columns)==null?void 0:He.length)??2),Ae=A.type==="matching"?Oe.matchingRows.filter(We=>We.length===Z&&We.every(De=>Number.isInteger(De)&&De>=0)):[],ge=Array.from({length:Z},(We,De)=>Oe.matchingSelection[De]??null),be=We=>We.join("|"),Ve=new Map;for(const We of G){const De=be(We);Ve.set(De,(Ve.get(De)??0)+1)}const nt=(We,De)=>{Y||Be(it=>{var It;const Ze=Math.max(2,((It=A.columns)==null?void 0:It.length)??2),xt=Array.from({length:Ze},(ut,St)=>it.matchingSelection[St]??null);if(xt[We]=xt[We]===De?null:De,xt.some(ut=>ut==null))return{...it,matchingSelection:xt};const Ft=xt.map(ut=>Number(ut)),Mt=be(Ft),Tt=it.matchingRows.filter(ut=>be(ut)===Mt).length;return(Ve.get(Mt)??0)>Tt?(H("correct"),me(ut=>ut+1),Q(null),{...it,matchingRows:[...it.matchingRows,Ft],matchingSelection:new Array(Ze).fill(null)}):(H("incorrect"),me(ut=>ut+1),Q("This path is not valid or has already been used."),{...it,matchingSelection:new Array(Ze).fill(null)})})};return e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:A.question||(E==null?void 0:E.label)}),A.title?e.jsx("p",{className:"cogita-revision-hint",children:A.title}):null,A.type==="selection"?e.jsx("div",{className:"cogita-choice-grid",style:{gridTemplateColumns:"1fr"},children:(A.options??[]).map((We,De)=>e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.6rem"},children:[e.jsx("input",{type:"checkbox",checked:Oe.selection.includes(De),disabled:Y,onChange:it=>Be(Ze=>({...Ze,selection:it.target.checked?Array.from(new Set([...Ze.selection,De])):Ze.selection.filter(xt=>xt!==De)}))}),e.jsx("span",{children:We})]},`q-opt:${De}`))}):null,A.type==="truefalse"?e.jsxs("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:[e.jsx("button",{type:"button",className:"ghost","data-active":Oe.booleanAnswer===!0,disabled:Y,onClick:()=>Be(We=>({...We,booleanAnswer:!0})),children:"True"}),e.jsx("button",{type:"button",className:"ghost","data-active":Oe.booleanAnswer===!1,disabled:Y,onClick:()=>Be(We=>({...We,booleanAnswer:!1})),children:"False"})]}):null,A.type==="text"||A.type==="number"||A.type==="date"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:rt,type:A.type==="date"?"date":"text",value:F,onChange:We=>X(We.target.value),disabled:Y,"data-state":z==="correct"?"correct":z==="incorrect"?"incorrect":void 0})]}):null,A.type==="ordering"?e.jsx("div",{style:{display:"grid",gap:"0.45rem"},children:Oe.ordering.map((We,De)=>e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)"},children:[De+1,"."]}),e.jsx("span",{children:We}),e.jsx("button",{type:"button",className:"ghost",disabled:Y||De===0,onClick:()=>Be(it=>{const Ze=[...it.ordering];return[Ze[De-1],Ze[De]]=[Ze[De],Ze[De-1]],{...it,ordering:Ze}}),children:"Up"}),e.jsx("button",{type:"button",className:"ghost",disabled:Y||De>=Oe.ordering.length-1,onClick:()=>Be(it=>{const Ze=[...it.ordering];return[Ze[De+1],Ze[De]]=[Ze[De],Ze[De+1]],{...it,ordering:Ze}}),children:"Down"})]},`q-order:${De}:${We}`))}):null,A.type==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.65rem"},children:[e.jsx("div",{style:{display:"grid",gap:"0.65rem",gridTemplateColumns:`repeat(${Math.max(2,((Xe=A.columns)==null?void 0:Xe.length)??2)}, minmax(0, 1fr))`,alignItems:"start"},children:(A.columns??[]).map((We,De)=>e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.35rem",padding:"0.6rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:`Column ${De+1}`}),We.map((it,Ze)=>e.jsxs("button",{type:"button",className:"ghost cogita-checkcard-row",style:{textAlign:"left"},disabled:Y,"data-active":ge[De]===Ze?"true":void 0,onClick:()=>nt(De,Ze),children:[e.jsx("span",{children:it}),e.jsx("small",{children:Ze})]},`q-col:${De}:${Ze}`))]},`q-col:${De}`))}),e.jsxs("div",{style:{display:"grid",gap:"0.4rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:"Selected paths"}),Ae.length?Ae.map((We,De)=>e.jsxs("div",{className:"cogita-share-row",style:{alignItems:"center"},children:[e.jsx("span",{children:We.map((it,Ze)=>{var Ft,Mt;const xt=String(((Mt=(Ft=A.columns)==null?void 0:Ft[Ze])==null?void 0:Mt[it])??it);return`${Ze>0?" -> ":""}${xt}`})}),Y?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>Be(it=>({...it,matchingRows:it.matchingRows.filter((Ze,xt)=>xt!==De)})),children:"Remove"})]},`q-path:${De}`)):e.jsx("p",{className:"cogita-library-hint",children:"Choose one option in each column. After the last column is selected, the path is checked automatically."})]})]}):null,e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>void T(),disabled:Y,children:t.cogita.library.revision.checkAnswer})}),ne?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),A.type==="selection"?e.jsx("p",{children:re.length?re.map(We=>{var De;return`${We}${(De=A.options)!=null&&De[We]?`: ${A.options[We]}`:""}`}).join(", "):"-"}):A.type==="truefalse"?e.jsx("p",{children:String(!!A.answer)}):A.type==="ordering"?e.jsx("ol",{children:(A.options??[]).map((We,De)=>e.jsx("li",{children:We},`ans-order:${De}`))}):A.type==="matching"?e.jsx("div",{style:{display:"grid",gap:"0.35rem"},children:G.length?G.map((We,De)=>e.jsx("p",{children:We.join(" → ")},`ans-path:${De}`)):e.jsx("p",{children:"-"})}):e.jsx("p",{children:String(A.answer??"")})]}):e.jsx("div",{className:"cogita-revision-reveal",children:e.jsx("button",{type:"button",className:"ghost",onClick:()=>{ae(!0),I()},children:t.cogita.library.revision.showAnswer})})]})},he=n.useMemo(()=>ee?ot(t,ee):t.cogita.library.infoTypes.any,[t,ee]);return e.jsx(Et,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:he}),e.jsx("h2",{className:"cogita-card-title",children:c}),e.jsx("p",{className:"cogita-card-subtitle",children:b})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${g.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${K.length}`}),e.jsx("button",{type:"button",className:"cta",disabled:g.length===0,onClick:()=>et(`/cogita/library/${d}/revision/run?libraryTarget=revisions&scope=info&infoId=${encodeURIComponent(b)}`),children:"Start revision"})]})]}),y==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):y==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(pn,{nodes:Ce,edges:tt,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:(te,A)=>p(A.id),panOnDrag:!0,children:[e.jsx(fn,{}),e.jsx(bn,{showInteractive:!1})]})}),E?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[M&&de?e.jsx(es,{flashState:z,flashTick:V,children:M.kind==="question"?xe(M):e.jsx(ts,{copy:t,currentCard:de,currentTypeLabel:"",prompt:M.kind==="citation-fragment"?null:M.prompt,languages:[],answer:F,onAnswerChange:X,computedExpected:[],computedAnswers:st,onComputedAnswerChange:(te,A)=>mt(Y=>({...Y,[te]:A})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:Te,feedback:z,canAdvance:!1,quoteContext:M.kind==="citation-fragment"?M.quoteContext:null,quotePlaceholder:M.kind==="citation-fragment"?M.quotePlaceholder:null,onCheckAnswer:()=>void T(),onSkip:()=>p(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:ne,setShowCorrectAnswer:ae,onRevealCorrect:I,answerMask:ke,expectedAnswer:M.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:rt,computedInputRefs:ht,scriptMode:Ge,setScriptMode:jt,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:k||ne,hideSkipAction:!0,allowRevealBeforeCheck:!0,autoRevealAfterAnswer:!0,disableCheckAfterAnswer:!0})}):null,l?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),Me?e.jsx("p",{className:"cogita-library-hint",children:Me}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:g.map(te=>{const A=oa(te),Y=B===A;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${Y?"active":""}`,onClick:()=>p(A),children:[e.jsx("span",{children:te.label}),e.jsx("small",{children:Ks(te)})]},A)})})]})]})]})})})})})}function Za(t,a){var r,s;return((s=(r=t.fields.find(i=>i.fieldType===a))==null?void 0:r.plainValue)==null?void 0:s.trim())??""}function Pi(t){return Za(t,"role_kind").toLowerCase()==="person"}function Ei(t){return Za(t,"label")||Za(t,"display_name")||Za(t,"name")||t.roleId}function Ki({copy:t,onPersonCreated:a}){const[r,s]=n.useState([]),[i,o]=n.useState("loading"),[h,j]=n.useState(null),[m,v]=n.useState(!1),[d,b]=n.useState(""),l=async()=>{o("loading");try{const g=await Qs();s(g),o("ready")}catch{s([]),o("error")}};n.useEffect(()=>{l()},[]);const c=n.useMemo(()=>r.filter(Pi).map(g=>({roleId:g.roleId,label:Ei(g)})).sort((g,S)=>g.label.localeCompare(S.label)),[r]),w=async()=>{const g=d.trim();if(!g){j("Name is required.");return}v(!0),j(null);try{const S=await Sr({fields:[{fieldType:"nick",plainValue:g},{fieldType:"role_kind",plainValue:"person"},{fieldType:"label",plainValue:g},{fieldType:"display_name",plainValue:g}]});b(""),j("Person role created."),a==null||a(S.roleId),await l()}catch{j("Failed to create person role.")}finally{v(!1)}};return e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-browser-panel",children:[e.jsx("div",{className:"cogita-info-overview-head",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Cogita"}),e.jsx("h2",{className:"cogita-card-title",children:"Persons"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Select reviewer persons in the header and create new person roles here."})]})}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Create"}),e.jsx("h3",{className:"cogita-detail-title",children:"New person role"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{type:"text",value:d,onChange:g=>b(g.target.value),placeholder:"e.g. Anna Kowalska",disabled:m})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:w,disabled:m,children:m?"Creating...":"Create person"})}),h?e.jsx("p",{className:"cogita-library-hint",children:h}):null]})]}),e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Overview"}),e.jsx("h3",{className:"cogita-detail-title",children:"All person roles"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[i==="loading"?e.jsx("p",{children:"Loading persons..."}):null,i==="error"?e.jsx("p",{children:"Failed to load persons."}):null,i==="ready"&&c.length===0?e.jsx("p",{children:"No person roles found."}):null,i==="ready"&&c.length>0?e.jsxs("div",{className:"cogita-details-grid",children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:"Name"}),e.jsx("span",{children:"Type"}),e.jsx("span",{children:"Role ID"}),e.jsx("span",{})]}),c.map(g=>e.jsxs("div",{className:"cogita-details-row",role:"row",children:[e.jsx("span",{}),e.jsx("span",{title:g.label,children:g.label}),e.jsx("span",{children:"person"}),e.jsx("span",{title:g.roleId,children:g.roleId}),e.jsx("span",{})]},g.roleId))]}):null]})]})]})]})})})})}function Fi({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,libraryId:d,collectionId:b}){const{libraryName:l}=ua(d),[c,w]=n.useState([]),[g,S]=n.useState("loading"),[K,x]=n.useState("idle"),y=n.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),ce=`/#/cogita/library/${d}`,B=()=>{S("loading"),Gs({libraryId:d}).then(N=>{w(N),S("idle")}).catch(()=>{w([]),S("error")})};n.useEffect(()=>{B()},[d]);const p=async N=>{try{await Ys({libraryId:d,shareId:N}),B()}catch{B()}},W=async N=>{const ee=`${y}/${N}`;try{await navigator.clipboard.writeText(ee),x("copied")}catch{x("failed")}};return e.jsx(Et,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:ce,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${ce}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[g==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):g==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):c.filter(N=>!b||N.collectionId===b).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:c.filter(N=>!b||N.collectionId===b).map(N=>e.jsxs("div",{className:"cogita-share-row","data-state":N.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:N.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(N.createdUtc).toLocaleString(),N.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),N.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${y}/${N.shareCode}`}):null]}),N.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[N.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>W(N.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>p(N.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},N.shareId))}),K==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):K==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function _i({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,libraryId:d}){const{libraryName:b}=ua(d),[l,c]=n.useState(null),[w,g]=n.useState(null),[S,K]=n.useState(null),[x,y]=n.useState(null),[ce,B]=n.useState(null),[p,W]=n.useState(null),N=n.useRef(null),ee=pe=>{if(!Number.isFinite(pe))return"0 B";if(pe<1024)return`${pe} B`;const F=pe/1024;if(F<1024)return`${F.toFixed(1)} KB`;const X=F/1024;return X<1024?`${X.toFixed(1)} MB`:`${(X/1024).toFixed(1)} GB`},U=async()=>{c(null),B({loadedBytes:0,totalBytes:null,percent:null});try{c(t.cogita.library.overview.exporting);const pe=await Tr(d,B),F=URL.createObjectURL(pe),X=document.createElement("a");X.href=F,X.download=`cogita-library-${b||d}.json`,X.click(),URL.revokeObjectURL(F),c(t.cogita.library.overview.exportReady)}catch{c(t.cogita.library.overview.exportFail)}finally{B(pe=>pe??{loadedBytes:0,totalBytes:null,percent:null})}},R=async pe=>{var X;g(null),K(null),y(null);const F=(X=pe.target.files)==null?void 0:X[0];if(F)try{g(t.cogita.library.overview.importing),W({loadedBytes:0,totalBytes:F.size,percent:0});const Me=await Cr(d,F,W,Q=>{const L=Q.stage==="infos"?t.cogita.library.overview.importStageInfos:Q.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;y(t.cogita.library.overview.importLiveProgress.replace("{stage}",L).replace("{done}",String(Q.processed)).replace("{total}",String(Q.total)).replace("{infos}",String(Q.infos)).replace("{connections}",String(Q.connections)).replace("{collections}",String(Q.collections)))});K({infos:Me.infosImported,connections:Me.connectionsImported,collections:Me.collectionsImported}),g(t.cogita.library.overview.importDone)}catch(Me){const Q=Me instanceof Ws&&Me.message?` ${Me.message}`:"";g(`${t.cogita.library.overview.importFail}${Q}`)}finally{N.current&&(N.current.value="")}};return e.jsx(Et,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:b}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:U,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:N,type:"file",accept:"application/json",onChange:R})]})]}),ce?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:ce.percent??void 0,max:ce.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",ee(ce.loadedBytes)).replace("{total}",ce.totalBytes?ee(ce.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,p?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:p.percent??void 0,max:p.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",ee(p.loadedBytes)).replace("{total}",p.totalBytes?ee(p.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,l?e.jsx("p",{className:"cogita-help",children:l}):null,w?e.jsx("p",{className:"cogita-help",children:w}):null,x?e.jsx("p",{className:"cogita-help",children:x}):null,S?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(S.infos)).replace("{connections}",String(S.connections)).replace("{collections}",String(S.collections))}):null]})]})})})]})})}function Di({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,libraryId:d}){const{libraryName:b}=ua(d),[l,c]=n.useState(""),[w,g]=n.useState([]),S=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Et,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:b}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:K=>c(K.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const K=l.trim();K&&(g(x=>[{id:S(),name:K},...x]),c(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[w.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,w.map(K=>e.jsx("button",{type:"button",className:"ghost",children:K.name},K.id))]})]})]})})})]})})}function Bi({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,libraryId:d}){const{libraryName:b}=ua(d),[l,c]=n.useState(""),[w,g]=n.useState([]),S=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Et,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:b}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:K=>c(K.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const K=l.trim();K&&(g(x=>[{id:S(),name:K},...x]),c(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[w.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,w.map(K=>e.jsx("button",{type:"button",className:"ghost",children:K.name},K.id))]})]})]})})})]})})}function zi({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,libraryId:d}){const{libraryName:b}=ua(d),l=`/#/cogita/library/${d}`,[c,w]=n.useState(""),[g,S]=n.useState([]),[K,x]=n.useState("idle"),[y,ce]=n.useState(0),[B,p]=n.useState(null);n.useEffect(()=>{x("loading");const N=window.setTimeout(()=>{Oa({libraryId:d,query:c.trim()||void 0,limit:30}).then(ee=>{S(ee.items),ce(ee.total),p(ee.nextCursor??null),x("ready")}).catch(()=>{S([]),ce(0),p(null),x("ready")})},240);return()=>window.clearTimeout(N)},[d,c]);const W=async()=>{if(B){x("loading");try{const N=await Oa({libraryId:d,query:c.trim()||void 0,limit:30,cursor:B});S(ee=>[...ee,...N.items]),p(N.nextCursor??null),ce(N.total),x("ready")}catch{x("ready")}}};return e.jsx(Et,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:b}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${l}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:c,onChange:N=>w(N.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(g.length)).replace("{total}",String(y||g.length))}),e.jsx("span",{children:K==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:g.length?g.map(N=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${l}/collections/${N.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:N.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(N.itemCount))," ·"," ",N.notes||t.cogita.library.collections.noNotes]})]})},N.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${l}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),B?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:W,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const Se=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,ea=(t,a,r,s)=>`${t}:${a}:${r??""}:${s??""}`;function Vi({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,libraryId:d,collectionId:b}){ua(d);const l=`/#/cogita/library/${d}`,[c,w]=n.useState(t.cogita.library.collections.defaultName),[g,S]=n.useState(null),[K,x]=n.useState(0),[y,ce]=n.useState([]),[B,p]=n.useState("idle"),[W,N]=n.useState(null),ee=n.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(y.length)).replace("{total}",String(K||y.length)),[t,y.length,K]);n.useEffect(()=>{yn(d,b).then(R=>{w(R.name),S(R.notes??null),x(R.itemCount)}).catch(()=>{w(t.cogita.library.collections.defaultName),S(null)})},[d,b]),n.useEffect(()=>{p("loading"),qa({libraryId:d,collectionId:b,limit:40}).then(R=>{ce(R.items),N(R.nextCursor??null),x(R.total),p("ready")}).catch(()=>{ce([]),N(null),p("ready")})},[d,b]);const U=async()=>{if(W){p("loading");try{const R=await qa({libraryId:d,collectionId:b,limit:40,cursor:W});ce(pe=>[...pe,...R.items]),N(R.nextCursor??null),x(R.total),p("ready")}catch{p("ready")}}};return e.jsx(Et,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:g||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${l}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${l}/collections/${b}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${l}/collections/${b}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:ee}),e.jsx("span",{children:B==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:y.length?y.map(R=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:R.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:R.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:R.label}),e.jsx("p",{className:"cogita-card-subtitle",children:R.description})]})},Se(R))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),W?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:U,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${l}/collections/${b}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const Fs=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],Oi={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},qi=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Ui=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function Ji({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,libraryId:d,onCreated:b}){const l=Ja(),{libraryName:c}=ua(d),w=`/#/cogita/library/${d}`,[g,S]=n.useState(null),[K,x]=n.useState(""),[y,ce]=n.useState(""),[B,p,W]=Hn([]),[N,ee,U]=Wn([]),[R,pe]=n.useState(null),[F,X]=n.useState(null),Me=n.useRef(null),Q=n.useMemo(()=>B.find(V=>V.id===R)??null,[B,R]);n.useEffect(()=>{const V=new URLSearchParams(l.search),me=(V.get("draft")??"").trim(),ne=(V.get("draftType")??"").trim();if(!me||ne!=="info-selection"||Me.current===me)return;const ae=hi(d,me);if(!ae||ae.infoIds.length===0)return;const ke=crypto.randomUUID(),Le=ae.infoIds.length>1?crypto.randomUUID():null,Ee=ae.infoIds.map((Te,Ge)=>({id:crypto.randomUUID(),type:"default",position:{x:80,y:80+Ge*100},data:{nodeType:"source.info",label:"Selected info",params:{infoId:Te,infoType:"any"}}})),$e=Le?[{id:Le,type:"default",position:{x:360,y:120+Math.max(0,(ae.infoIds.length-1)*50)},data:{nodeType:"logic.or",label:"Selected infos",params:{}}}]:[],st={id:ke,type:"default",position:{x:660,y:140+Math.max(0,(ae.infoIds.length-1)*35)},data:{nodeType:"output.collection",label:"Collection output",params:{}}},mt=Ee.map(Te=>({id:crypto.randomUUID(),source:Te.id,target:Le??ke}));Le&&mt.push({id:crypto.randomUUID(),source:Le,target:ke}),p([...Ee,...$e,st]),ee(mt),pe(ke),X(`Draft loaded from ${ae.infoIds.length} selected infos. Set name and save to create collection.`),Me.current=me},[d,l.search,ee,p]);const L=V=>{var ke;const me=crypto.randomUUID(),ne=((ke=Fs.find(Le=>Le.type===V))==null?void 0:ke.label)??V,ae={...Oi[V]};p(Le=>[...Le,{id:me,type:"default",position:{x:120+Le.length*40,y:120+Le.length*40},data:{nodeType:V,label:ne,params:ae}}]),pe(me)},$=n.useCallback(V=>{ee(me=>Qn({...V,id:crypto.randomUUID()},me))},[ee]),z=V=>{Q&&p(me=>me.map(ne=>ne.id===Q.id?{...ne,data:{...ne.data,params:V}}:ne))},H=async()=>{if(X(null),!K.trim()){X(t.cogita.library.collections.saveRequiredName);return}try{const V={nodes:B.map(ae=>({nodeId:ae.id,nodeType:ae.data.nodeType,payload:{position:ae.position,params:ae.data.params}})),edges:N.map(ae=>({edgeId:ae.id,fromNodeId:ae.source,fromPort:ae.sourceHandle??null,toNodeId:ae.target,toPort:ae.targetHandle??null}))};let me=g,ne=!1;if(me)await Xs({libraryId:d,collectionId:me,nodes:V.nodes,edges:V.edges});else{const ae=await Ir({libraryId:d,name:K.trim(),notes:y.trim()||void 0,items:[],graph:V});me=ae.collectionId,ne=!0,S(ae.collectionId)}X(ne?t.cogita.library.collections.saveSuccess:t.cogita.library.graph.saveSuccess),b(me)}catch{X(g?t.cogita.library.graph.saveFail:t.cogita.library.collections.saveFail)}};return e.jsx(Et,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.createKicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.createSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:w,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${w}/collections`,children:t.cogita.library.actions.collections}),e.jsx("button",{type:"button",className:"cta",onClick:H,children:t.cogita.library.actions.saveCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.collectionInfoTitle}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{value:K,onChange:V=>x(V.target.value),placeholder:t.cogita.library.collections.namePlaceholder})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.notesLabel}),e.jsx("textarea",{value:y,onChange:V=>ce(V.target.value),placeholder:t.cogita.library.collections.notesPlaceholder})]}),F?e.jsx("p",{className:"cogita-help",children:F}):null,e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Fs.map(V=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>L(V.type),children:V.label},V.type))})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(pn,{nodes:B,edges:N,onNodesChange:W,onEdgesChange:U,onConnect:$,onNodeClick:(V,me)=>pe(me.id),fitView:!0,children:[e.jsx(fn,{color:"rgba(120,160,200,0.2)"}),e.jsx(bn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),Q?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:Q.data.label}),Q.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:d,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:Q.data.params.tagId?{id:Q.data.params.tagId,label:Q.data.params.tagLabel??"",infoType:"topic"}:null,onChange:V=>z({...Q.data.params,tagId:(V==null?void 0:V.id)??null,tagLabel:(V==null?void 0:V.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:Q.data.params.scope??"any",onChange:V=>z({...Q.data.params,scope:V.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),Q.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:d,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:Q.data.params.languageId?{id:Q.data.params.languageId,label:Q.data.params.languageLabel??"",infoType:"language"}:null,onChange:V=>z({...Q.data.params,languageId:(V==null?void 0:V.id)??null,languageLabel:(V==null?void 0:V.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:Q.data.params.scope??"any",onChange:V=>z({...Q.data.params,scope:V.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),Q.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:Q.data.params.infoType??"word",onChange:V=>z({...Q.data.params,infoType:V.target.value}),children:Ui.map(V=>e.jsx("option",{value:V.value,children:V.label},V.value))})]}),e.jsx(Yt,{libraryId:d,infoType:Q.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:Q.data.params.infoId?{id:Q.data.params.infoId,label:Q.data.params.infoLabel??"",infoType:Q.data.params.infoType??"word"}:null,onChange:V=>z({...Q.data.params,infoId:(V==null?void 0:V.id)??null,infoLabel:(V==null?void 0:V.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),Q.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:Q.data.params.connectionType??"translation",onChange:V=>z({...Q.data.params,connectionType:V.target.value}),children:qi.map(V=>e.jsx("option",{value:V.value,children:V.label},V.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:Q.data.params.connectionId??"",onChange:V=>z({...Q.data.params,connectionId:V.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(Q.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const ca=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const a=t.length,r=t.filter(o=>o.correct).length,s=vn(as(t));return{score:Math.round(Math.max(0,Math.min(100,s.knowness*100))*100)/100,total:a,correct:r,lastReviewedUtc:s.lastReviewedUtc??null}},Hi=t=>{if(t.maskBase64)try{const a=Mr(t.maskBase64);if(!a.length)return t.correct?1:0;const r=a.reduce((s,i)=>s+i,0);return Math.max(0,Math.min(1,r/a.length/255))}catch{return t.correct?1:0}return t.correct?1:0},as=t=>t.map(a=>({correctness:Hi(a),createdUtc:a.createdUtc})),vn=(t,a=Date.now())=>{var K;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const s=t.slice().sort((x,y)=>x.createdUtc.localeCompare(y.createdUtc)).slice(-5),i=s.reduce((x,y)=>x+y.correctness,0)/s.length,o=5,h=2,j=.15;let m=0,v=0;for(let x=0;x<s.length;x+=1){const y=new Date(s[x].createdUtc).getTime(),ce=x===s.length-1?a:new Date(s[x+1].createdUtc).getTime(),B=Math.max(0,(ce-y)/(1e3*60)),p=1-Math.exp(-B/o);m+=p,s[x].correctness>.5&&(v+=j)}let d=i*m*h+v;const b=((K=s[s.length-1])==null?void 0:K.createdUtc)??null,l=b?Math.max(0,(a-new Date(b).getTime())/(1e3*60)):0,w=1/(1+Math.log1p(l/60));return d*=w,s.length===1&&s[0].correctness>.5&&(d+=5.44*Math.exp(-l/2)),{knowness:d,avgCorrectness:i,lastReviewedUtc:b}},Ua=t=>{const a=t.slice();for(let r=a.length-1;r>0;r-=1){const s=Math.floor(Math.random()*(r+1));[a[r],a[s]]=[a[s],a[r]]}return a},en=t=>t[Math.floor(Math.random()*t.length)],Wi=(t,a)=>{const r=new Map;return t.forEach(s=>r.set(s,Math.random())),t.sort((s,i)=>{const o=a(s)-a(i);return o!==0?o:(r.get(s)??0)-(r.get(i)??0)})},wn=(t,a,r,s,i)=>{if(!t.length)return null;const o=t.filter(j=>!(i!=null&&i.has(Se(j))));if(o.length===0)return null;const h=o.filter(j=>Se(j)!==r);return en(h.length?h:o)},Qi=(t,a,r,s,i)=>{if(!t.length)return null;let o=Number.POSITIVE_INFINITY;for(const v of t){const d=Se(v);if(r.has(d))continue;const b=a[d]??1;b<o&&(o=b)}if(!Number.isFinite(o))return null;const h=t.filter(v=>{const d=Se(v);return!r.has(d)&&(a[d]??1)===o}),j=h.filter(v=>!i||Se(v)!==i),m=s?j.filter(v=>!s.has(Se(v))):j;return m.length>0?en(m):j.length>0?en(j):i&&h.some(v=>Se(v)===i)?h.find(v=>Se(v)===i)??null:h.length?en(h):null},sr=(t,a,r,s,i)=>{const o=[],h=t.filter(m=>!i.has(Se(m))&&!r.has(Se(m))&&(a[Se(m)]??0)<1),j=Wi(h,m=>a[Se(m)]??0);for(const m of j){if(o.length>=s)break;o.push(m),i.add(Se(m))}if(o.length<s){const m=Ua(t.filter(v=>!i.has(Se(v))&&r.has(Se(v))));for(const v of m){if(o.length>=s)break;o.push(v),i.add(Se(v))}}return o},Gi=(t,a,r,s)=>sr(t,a,r,s,new Set),ns=(t,a,r,s,i,o)=>{const h=Math.max(1,r.stackSize??a),m=Ua(t).filter((w,g,S)=>S.findIndex(K=>Se(K)===Se(w))===g),v=Gi(m,s,i,h),d=new Set,b=new Set,l=wn(v,{},null,d,b),c=l?[l]:[];return l&&b.add(Se(l)),{queue:c,meta:{pool:m,active:v,knownessMap:s,unknownSet:i,outcomesById:o,asked:d,queued:b}}},Jn={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,a)=>{const s=Ua(t).filter((i,o,h)=>h.findIndex(j=>Se(j)===Se(i))===o);return{queue:s.slice(0,Math.min(a,s.length)),meta:{}}},applyOutcome:t=>t},ss=(t,a,r,s)=>{const i=Math.max(1,r.stackSize??a),h=Ua(t).filter((g,S,K)=>K.findIndex(x=>Se(x)===Se(g))===S),j={},m=new Set,v=new Set,d=new Set,b=Math.max(1,r.levels??1);h.forEach(g=>{const S=Se(g),K=s==null?void 0:s[S],x=typeof K=="number"&&Number.isFinite(K)?K:1;j[S]=Math.min(b,Math.max(1,Math.round(x)))});const l=[];if(h.length>0){const g=new Map;h.forEach(K=>{var y;const x=j[Se(K)]??1;g.has(x)||g.set(x,[]),(y=g.get(x))==null||y.push(K)});const S=Array.from(g.keys()).sort((K,x)=>K-x);for(const K of S){if(l.length>=i)break;const x=Ua(g.get(K)??[]);for(const y of x){if(l.length>=i)break;l.push(y)}}}const c=wn(l,j,null,m,v),w=c?[c]:[];return c&&v.add(Se(c)),{queue:w,meta:{pool:h,active:l,levelMap:j,asked:m,queued:v,wrongSinceCorrect:d}}},Yi={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,a)=>Math.max(1,a.stackSize??t),getProgressTotal:()=>null,prepare:(t,a,r)=>ss(t,a,r),applyOutcome:(t,a,r,s,i)=>{if(!a)return t;const o=Math.max(1,s.levels??1),h=t.meta.pool??[],j=t.meta.active??[],m={...t.meta.levelMap??{}},v=new Set(t.meta.asked??[]),d=new Set(t.meta.queued??[]),b=new Set(t.meta.wrongSinceCorrect??[]),l=Se(a);d.delete(l),v.add(l);const c=m[l]??1;i.correct?(m[l]=b.has(l)?1:Math.min(c+1,o),b.delete(l)):(m[l]=1,b.add(l));const w=i.correct?j.filter(K=>Se(K)!==l):j.slice();if(i.correct&&w.length<Math.max(1,s.stackSize??1)){const K=new Set(w.map(y=>Se(y))),x=Qi(h,m,K,v,l);x&&w.push(x)}const g=t.queue.slice(),S=wn(w,m,l,v,d);return S&&(g.push(S),d.add(Se(S))),{queue:g,meta:{pool:h,active:w,levelMap:m,asked:v,queued:d,wrongSinceCorrect:b}}}},Xi={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,a)=>Math.max(1,a.stackSize??t),getProgressTotal:()=>null,prepare:(t,a,r)=>ns(t,a,r,{},new Set,{}),applyOutcome:(t,a,r,s,i)=>{if(!a)return t;const o=t.meta.pool??[],h=t.meta.active??[],j={...t.meta.knownessMap??{}},m=new Set(t.meta.unknownSet??[]),v={...t.meta.outcomesById??{}},d=new Set(t.meta.asked??[]),b=new Set(t.meta.queued??[]),l=Se(a);b.delete(l),d.add(l);const c={correctness:Math.max(0,Math.min(1,i.correctness??(i.correct?1:0))),createdUtc:i.createdUtc??new Date().toISOString()},g=(v[l]??[]).concat(c).sort((B,p)=>B.createdUtc.localeCompare(p.createdUtc)).slice(-5);v[l]=g,m.delete(l);const S=Date.now();o.forEach(B=>{const p=Se(B),W=v[p]??[];if(W.length===0){j[p]=0,m.add(p);return}const N=vn(W,S);j[p]=N.knowness});const K=h.slice();if((j[l]??0)>=1){const B=K.filter(p=>Se(p)!==l);K.length=0,K.push(...B)}const y=Math.max(1,s.stackSize??r);if(K.length<y){const B=new Set(K.map(W=>Se(W))),p=sr(o,j,m,y-K.length,B);K.push(...p)}const ce=t.queue.slice();if(ce.length===0||Se(ce[ce.length-1])===l){const B=wn(K,{},l,d,b);B&&(ce.push(B),b.add(Se(B)))}return{queue:ce,meta:{pool:o,active:K,knownessMap:j,unknownSet:m,outcomesById:v,asked:d,queued:b}}}},rr={random:Jn,levels:Yi,temporal:Xi},Zi=Object.values(rr),rs=t=>{if(!t)return Jn;const a=t.trim().toLowerCase();return a==="random"||a==="levels"||a==="temporal"?rr[a]:Jn},jn=(t,a)=>{const r={...t.defaultSettings};return a&&Object.entries(a).forEach(([s,i])=>{typeof i=="number"&&Number.isFinite(i)&&(r[s]=i),typeof i=="string"&&(r[s]=i)}),t.settingsFields.forEach(s=>{var o;const i=r[s.key];if(s.type==="number"){if(typeof i!="number"||Number.isNaN(i)){r[s.key]=t.defaultSettings[s.key]??0;return}s.min!==void 0&&(r[s.key]=Math.max(s.min,r[s.key])),s.max!==void 0&&(r[s.key]=Math.min(s.max,r[s.key]));return}if(s.type==="select"){const h=((o=s.options)==null?void 0:o.map(j=>j.value))??[];(typeof i!="string"||h.length>0&&!h.includes(i))&&(r[s.key]=t.defaultSettings[s.key]??h[0]??"")}}),r},ir=(t,a)=>{const r={};return t.settingsFields.forEach(s=>{const i=a.get(s.key);if(i){if(s.type==="number"){const o=Number(i);Number.isNaN(o)||(r[s.key]=o);return}r[s.key]=i}}),jn(t,r)},eo=(t,a)=>{const r=new URLSearchParams;return t.settingsFields.forEach(s=>{const i=a[s.key];(typeof i=="number"||typeof i=="string")&&r.set(s.key,String(i))}),r};function _s({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,libraryId:d,collectionId:b,revisionId:l}){const c=mn(),{libraryName:w}=ua(d),g=`/#/cogita/library/${d}`,[S,K]=n.useState(t.cogita.library.collections.defaultName),[x,y]=n.useState([]),[ce,B]=n.useState(b??""),[p,W]=n.useState(""),[N,ee]=n.useState(20),[U,R]=n.useState("random"),[pe,F]=n.useState({}),[X,Me]=n.useState("exact"),[Q,L]=n.useState([]),[$,z]=n.useState(null),[H,V]=n.useState([]),[me,ne]=n.useState([]),[ae,ke]=n.useState(""),[Le,Ee]=n.useState("idle"),[$e,st]=n.useState(null),[mt,Te]=n.useState("idle"),[Ge,jt]=n.useState("idle"),[Oe,Be]=n.useState("idle"),rt=n.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),ht=n.useMemo(()=>rs(U),[U]),et=n.useMemo(()=>jn(ht,pe),[ht,pe]),Ce=n.useMemo(()=>eo(ht,et).toString(),[ht,et]),ze=n.useMemo(()=>{const k=ae.trim().toLocaleLowerCase();return k?me.filter(T=>T.name.toLocaleLowerCase().includes(k)):me},[ae,me]);n.useEffect(()=>{B(b??"")},[b]),n.useEffect(()=>{if(!ce){K(t.cogita.library.collections.defaultName);return}yn(d,ce).then(k=>K(k.name)).catch(()=>K(t.cogita.library.collections.defaultName))},[t.cogita.library.collections.defaultName,d,ce]),n.useEffect(()=>{Oa({libraryId:d,limit:200}).then(k=>y(k.items.map(T=>({collectionId:T.collectionId,name:T.name})))).catch(()=>y([]))},[d]),n.useEffect(()=>{Gn({libraryId:d}).then(k=>ne(k)).catch(()=>ne([]))},[d]),n.useEffect(()=>{l&&Zn({libraryId:d,revisionId:l}).then(k=>{B(k.collectionId),W(k.name),R(k.mode||"random"),Me(k.check||"exact"),ee(k.limit||20),F(k.revisionSettings??{})}).catch(()=>{W("")})},[d,l]),n.useEffect(()=>{Zs({libraryId:d}).then(k=>{L(k),!$&&k.length>0&&z(k[0].roleId)}).catch(()=>{L([])})},[d]);const tt=()=>{jt("loading"),Gs({libraryId:d}).then(k=>{V(k),jt("idle")}).catch(()=>{V([]),jt("error")})};n.useEffect(()=>{tt()},[d]);const E=async()=>{Ee("working"),Te("idle");try{if(!ce){Ee("error");return}const k=await Ar({libraryId:d,collectionId:ce,revisionType:ht.id,revisionSettings:et,mode:U,check:X,limit:N});st(`${rt}/${k.shareCode}${Ce?`?${Ce}`:""}`),Ee("ready"),tt()}catch{Ee("error")}},M=async()=>{if(l){Be("saving");try{await Lr({libraryId:d,collectionId:b??ce,revisionId:l,targetCollectionId:ce,name:p||S,revisionType:ht.id,revisionSettings:et,mode:U,check:X,limit:N}),Be("saved"),ce&&c(`/cogita/library/${d}/revisions/${encodeURIComponent(l)}`,{replace:!0})}catch{Be("error")}}},D=async()=>{if($e)try{await navigator.clipboard.writeText($e),Te("copied")}catch{Te("failed")}},P=async k=>{try{await Ys({libraryId:d,shareId:k}),tt()}catch{tt()}};return e.jsx(Et,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:S}),e.jsx("p",{className:"cogita-library-subtitle",children:w})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:g,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${g}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:ce?`${g}/collections/${ce}`:`${g}/collections`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${g}${l?`/revisions/${encodeURIComponent(l)}/run`:ce?`/collections/${ce}/revision/run`:"/revision/run"}?mode=${encodeURIComponent(U)}&check=${encodeURIComponent(X)}&limit=${N}${Ce?`&${Ce}`:""}${$?`&reviewer=${encodeURIComponent($)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:ae,onChange:k=>ke(k.target.value),placeholder:t.cogita.workspace.revisionForm.namePlaceholder})}),e.jsxs("div",{className:"cogita-card-list","data-view":"list",children:[e.jsxs("a",{className:"cogita-card-select",href:`${g}/revisions/new`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:t.cogita.workspace.revisionForm.createAction})]}),ze.map(k=>e.jsxs("a",{className:"cogita-card-select",href:`${g}/revisions/${encodeURIComponent(k.revisionId)}`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:k.name})]},k.revisionId))]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsx("select",{value:ce,onChange:k=>B(k.target.value),children:x.map(k=>e.jsx("option",{value:k.collectionId,children:k.name},k.collectionId))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:p,onChange:k=>W(k.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:U,onChange:k=>R(k.target.value),children:Zi.map(k=>e.jsx("option",{value:k.id,children:t.cogita.library.revision[k.labelKey]},k.id))})]}),ht.settingsFields.map(k=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[k.labelKey]}),k.type==="select"?e.jsx("select",{value:String(et[k.key]??""),onChange:T=>F(I=>({...I,[k.key]:T.target.value})),children:(k.options??[]).map(T=>e.jsx("option",{value:T.value,children:t.cogita.library.revision[T.labelKey]},T.value))}):e.jsx("input",{type:"number",min:k.min,max:k.max,step:k.step,value:et[k.key]??0,onChange:T=>F(I=>({...I,[k.key]:Number(T.target.value||0)}))})]},k.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),ht.id!=="levels"&&ht.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:N,onChange:k=>ee(Number(k.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:$??"",onChange:k=>z(k.target.value||null),children:Q.map(k=>e.jsx("option",{value:k.roleId,children:k.label},k.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[l?e.jsx("button",{type:"button",className:"cta ghost",onClick:M,disabled:Oe==="saving",children:Oe==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${g}${l?`/revisions/${encodeURIComponent(l)}/run`:ce?`/collections/${ce}/revision/run`:"/revision/run"}?mode=${encodeURIComponent(U)}&check=${encodeURIComponent(X)}&limit=${N}${Ce?`&${Ce}`:""}${$?`&reviewer=${encodeURIComponent($)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision}),l?e.jsx("a",{className:"cta ghost",href:`/#/cogita/live-revision-host/${encodeURIComponent(d)}/${encodeURIComponent(l)}`,children:"Live session"}):null]}),Oe==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),$e?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:$e,readOnly:!0})]}):null,Le==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,mt==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):mt==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:E,disabled:Le==="working",children:Le==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),$e?e.jsx("button",{type:"button",className:"cta ghost",onClick:D,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),Ge==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):H.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:H.map(k=>e.jsxs("div",{className:"cogita-share-row","data-state":k.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:k.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(k.createdUtc).toLocaleString(),k.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),k.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>P(k.shareId),children:t.cogita.library.revision.shareRevokeAction})]},k.shareId))})]})]})]})]})})})]})})}const Kn=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function or(t,a,r){if(!t)return null;const s=new Map(t.nodes.map(B=>[B.id,B])),i=new Map,o=new Set,h=B=>{if(typeof B=="number")return B;if(typeof B=="string"){const p=Number(B);return Number.isFinite(p)?p:0}return 0},j=B=>{if(i.has(B))return i.get(B);if(o.has(B))return 0;const p=s.get(B);if(!p)return 0;o.add(B);const W=ee=>{var R,pe;return(ee?((R=p.inputsByHandle)==null?void 0:R[ee])??[]:p.inputs??((pe=p.inputsByHandle)==null?void 0:pe.in)??[]).map(F=>j(F))};let N=0;switch(p.type){case"input.random":{const ee=p.min??0,U=p.max??ee+10,R=Math.min(ee,U),pe=Math.max(ee,U);N=Math.floor(Math.random()*(pe-R+1))+R;break}case"input.const":{N=p.value??0;break}case"input.list":{const ee=(p.list??[]).filter(Boolean),U=Math.round(h(W("index")[0]));N=ee.length?ee[Math.max(0,Math.min(ee.length-1,U))]:String(U);break}case"compute.add":{N=W("in").map(U=>h(U)).reduce((U,R)=>U+R,0);break}case"compute.sub":{const ee=W("add").map(R=>h(R)),U=W("sub").map(R=>h(R));N=ee.reduce((R,pe)=>R+pe,0)-U.reduce((R,pe)=>R+pe,0);break}case"compute.mul":{const ee=W("in").map(U=>h(U));N=ee.length?ee.reduce((U,R)=>U*R,1):0;break}case"compute.div":{const ee=h(W("num")[0]),U=W("den").map(R=>h(R)).reduce((R,pe)=>R+pe,0);N=Math.abs(U)<Number.EPSILON?0:ee/U;break}case"compute.pow":{const ee=h(W("base")[0]),U=h(W("exp")[0]);N=Math.pow(ee,U);break}case"compute.exp":{const ee=h(W("base")[0]),U=h(W("exp")[0]);N=Math.pow(ee,U);break}case"compute.log":{const ee=h(W("value")[0]),U=h(W("base")[0]),R=Math.max(ee,Number.EPSILON);N=Math.abs(U)<Number.EPSILON?Math.log(R):Math.log(R)/Math.log(U);break}case"compute.abs":{N=Math.abs(h(W("in")[0]));break}case"compute.min":{const ee=W("in").map(U=>h(U));N=ee.length?Math.min(...ee):0;break}case"compute.max":{const ee=W("in").map(U=>h(U));N=ee.length?Math.max(...ee):0;break}case"compute.floor":{N=Math.floor(h(W("in")[0]));break}case"compute.ceil":{N=Math.ceil(h(W("in")[0]));break}case"compute.round":{N=Math.round(h(W("in")[0]));break}case"compute.mod":{const ee=h(W("a")[0]),U=h(W("b")[0]);N=Math.abs(U)<Number.EPSILON?0:ee%U;break}case"compute.concat":{const U=["in1","in2","in3","in4","in5","in6"].flatMap(X=>W(X)),R=U.length?U:W("in");N=(R.length?R:W()).map(X=>X==null?"":String(X)).join("");break}case"compute.trim":{const ee=W("text")[0]??W("in")[0]??"",U=ee==null?"":String(ee),R=Math.max(0,Math.round(h(W("start")[0]))),pe=Math.max(0,Math.round(h(W("end")[0])));R+pe>=U.length?N="":N=U.substring(R,U.length-pe);break}case"output":{N=W("in")[0]??0;break}default:N=0}return o.delete(B),i.set(B,N),N},m=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(B=>B.type==="output").map(B=>B.id);t.nodes.forEach(B=>j(B.id)),m.forEach(B=>j(B));const v=B=>Math.abs(B%1)<1e-5?String(Math.round(B)):B.toFixed(3).replace(/\.?0+$/,""),d=B=>typeof B=="number"?v(B):B??"",b=new Map;m.forEach(B=>{var U,R,pe,F;const p=s.get(B);if(!p)return;const W=(R=(U=p.inputsByHandle)==null?void 0:U.name)==null?void 0:R[0],N=W?d(i.get(W)):"",ee=(N==null?void 0:N.toString().trim())||((pe=p.outputLabel)==null?void 0:pe.trim())||((F=p.name)==null?void 0:F.trim())||B;b.set(B,ee)});const l={},c={},w={};m.forEach(B=>{var N,ee;const p=s.get(B);if(!p)return;const W=b.get(B)??(((N=p.outputLabel)==null?void 0:N.trim())||((ee=p.name)==null?void 0:ee.trim())||B);l[W]=d(i.get(B)),p.name&&(c[p.name.trim()]=W),c[B]=W});const g=(B,p)=>{let W=B;return t.nodes.forEach(N=>{var F,X;const ee=d(i.get(N.id)),U=m.includes(N.id),R=U?b.get(N.id)??((F=N.outputLabel)==null?void 0:F.trim())??((X=N.name)==null?void 0:X.trim())??N.id:"",pe=U&&p?R:ee;W=W.replace(new RegExp(`\\{\\s*${Kn(N.id)}\\s*\\}`,"gi"),pe),N.name&&(W=W.replace(new RegExp(`\\{\\s*${Kn(N.name)}\\s*\\}`,"gi"),pe)),U&&N.outputLabel&&(W=W.replace(new RegExp(`\\{\\s*${Kn(N.outputLabel)}\\s*\\}`,"gi"),R))}),W},S=a;let K=S.trim().length>0?S:"";K||(K=m.length?`Compute ${m.join(", ")}`:"Compute"),K=g(K,!0);const x=(r==null?void 0:r.trim())??"",y=x?g(x,!1):"",ce={};return i.forEach((B,p)=>{ce[p]=B,w[p]=d(B);const W=s.get(p);W!=null&&W.name&&(w[W.name.trim()]=d(B))}),{prompt:K,answers:l,values:ce,answerText:y,outputVariables:c,variableValues:w}}function lr(t){var r;const a=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((r=a[0])==null?void 0:r[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const Fn=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function cr({outcomes:t}){const[a,r]=n.useState("day"),s=n.useMemo(()=>{const i=Fn.find(j=>j.id===a)??Fn[1],o=Date.now()-i.ms,h=t.filter(j=>new Date(j.createdUtc).getTime()>=o);return ca(h)},[t,a]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:Fn.map(i=>e.jsx("button",{type:"button",className:"ghost","data-active":a===i.id,onClick:()=>r(i.id),children:i.label},i.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[s.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[s.correct," / ",s.total]})]})}const to="cogita-revision",ao=1,on="outcomes",no=()=>new Promise((t,a)=>{const r=indexedDB.open(to,ao);r.onupgradeneeded=()=>{const s=r.result;if(!s.objectStoreNames.contains(on)){const i=s.createObjectStore(on,{keyPath:"id"});i.createIndex("byItem","itemKey",{unique:!1}),i.createIndex("byPending","pending",{unique:!1})}},r.onerror=()=>a(r.error),r.onsuccess=()=>t(r.result)}),Ha=async(t,a)=>{const r=await no();return new Promise((s,i)=>{const o=r.transaction(on,t),h=o.objectStore(on);a(h).then(s).catch(i),o.onerror=()=>i(o.error)})},dr=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const a=Array.from(t).map(r=>r.toString(16).padStart(2,"0"));return`${a.slice(0,4).join("")}-${a.slice(4,6).join("")}-${a.slice(6,8).join("")}-${a.slice(8,10).join("")}-${a.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},so=()=>{const t="cogita_revision_client_id",a=localStorage.getItem(t);if(a)return a;const r=dr();return localStorage.setItem(t,r),r},ro=()=>{const t="cogita_revision_client_seq",a=Number(localStorage.getItem(t)??"0"),r=Number.isFinite(a)?a+1:1;return localStorage.setItem(t,String(r)),r},ur=(t,a,r,s)=>ea(t,a,r,s),ln=async t=>{const a=so(),r=ro(),s=new Date().toISOString(),i={...t,clientId:a,clientSequence:r,createdUtc:s,id:dr(),pending:!0};return await Ha("readwrite",o=>new Promise((h,j)=>{const m={...i,itemKey:ur(i.itemType,i.itemId,i.checkType,i.direction)},v=o.add(m);v.onsuccess=()=>h(),v.onerror=()=>j(v.error)})),i},cn=async(t,a,r,s)=>{if(!a)return[];try{const i=ur(t,a,r,s);return await Ha("readonly",o=>new Promise((h,j)=>{const v=o.index("byItem").getAll(i);v.onsuccess=()=>{const b=(v.result??[]).map(l=>({itemType:l.itemType,itemId:l.itemId,checkType:l.checkType??null,direction:l.direction??null,revisionType:l.revisionType,evalType:l.evalType,correct:l.correct,createdUtc:l.createdUtc,maskBase64:l.maskBase64,payloadBase64:l.payloadBase64,payloadHashBase64:l.payloadHashBase64,clientId:l.clientId,clientSequence:l.clientSequence,personRoleId:l.personRoleId??null})).sort((l,c)=>l.createdUtc.localeCompare(c.createdUtc));h(b)},v.onerror=()=>j(v.error)}))}catch{return[]}},da=async()=>{try{return await Ha("readonly",t=>new Promise((a,r)=>{const s=t.getAll();s.onsuccess=()=>{const o=(s.result??[]).map(h=>({itemType:h.itemType,itemId:h.itemId,checkType:h.checkType??null,direction:h.direction??null,revisionType:h.revisionType,evalType:h.evalType,correct:h.correct,createdUtc:h.createdUtc,maskBase64:h.maskBase64,payloadBase64:h.payloadBase64,payloadHashBase64:h.payloadHashBase64,clientId:h.clientId,clientSequence:h.clientSequence,personRoleId:h.personRoleId??null}));a(o)},s.onerror=()=>r(s.error)}))}catch{return[]}},io=async(t=100)=>{try{return await Ha("readonly",a=>new Promise((r,s)=>{const o=a.index("byPending").getAll(!0);o.onsuccess=()=>{const h=o.result??[];r(h.slice(0,t))},o.onerror=()=>s(o.error)}))}catch{return[]}},oo=async t=>{if(t.length!==0)try{await Ha("readwrite",a=>new Promise((r,s)=>{let i=t.length;t.forEach(o=>{const h=a.get(o);h.onsuccess=()=>{const j=h.result;if(j){j.pending=!1;const m=a.put(j);m.onsuccess=()=>{i-=1,i===0&&r()},m.onerror=()=>s(m.error)}else i-=1,i===0&&r()},h.onerror=()=>s(h.error)})}))}catch{}},_n=async(t,a)=>{const r=await io(200);if(r.length===0)return;const s=new Map;r.forEach(i=>{var h;const o=i.personRoleId??a??"";s.has(o)||s.set(o,[]),(h=s.get(o))==null||h.push(i)});for(const[i,o]of s.entries()){const h=o.map(j=>({itemType:j.itemType,itemId:j.itemId,checkType:j.checkType??null,direction:j.direction??null,revisionType:j.revisionType,evalType:j.evalType,correct:j.correct,clientId:j.clientId,clientSequence:j.clientSequence,maskBase64:j.maskBase64??null,payloadHashBase64:j.payloadHashBase64??null,payloadBase64:j.payloadBase64??null,personRoleId:i||null}));try{await $r({libraryId:t,outcomes:h}),await oo(o.map(j=>j.id))}catch{}}},Bt=t=>t.trim().toLowerCase(),Wt=t=>{const a=t==null?void 0:t.trim();return a?{fragmentId:a}:null},dn=(t,a)=>{const r=Wt(a);if(!r)return!0;const s=Wt(t);return(s==null?void 0:s.fragmentId)===r.fragmentId},Ct=t=>{const a=t==null?void 0:t.trim().toLowerCase();return a||null},hr=(t,a)=>{if((Ct(t.childItemType)??"info")!==(a.cardType??"").toLowerCase()||t.childItemId!==a.cardId)return!1;const s=Ct(t.childCheckType),i=Ct(t.childDirection),o=Ct(a.checkType),h=Ct(a.direction);return!(s&&s!==o||i&&i!==h)},lo={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},co={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},un=(t,a,r)=>{if(!r||!a.startsWith(t))return a;const s=a.slice(t.length);if(!s)return a;const i=r==="super"?lo:co,o=s.split("").map(h=>i[h]??h).join("");return t+o},hn=(t,a,r)=>{var h,j,m;if(!t)return((h=a[0])==null?void 0:h.key)??null;const s=new Set(a.map(v=>v.key)),i=/\{([^}]+)\}/g;let o;for(;(o=i.exec(t))!==null;){const v=((j=o[1])==null?void 0:j.trim())??"";if(!v)continue;if(s.has(v))return v;const d=r==null?void 0:r[v];if(d&&s.has(d))return d}return((m=a[0])==null?void 0:m.key)??null},Va=t=>(()=>{const a=new Set;return t.flatMap(r=>{if(r.cardType!=="info"||r.infoType!=="citation")return[r];const s=r.description??"";if(!s.trim())return[r];const i=va(s),o=Object.keys(i.nodes);return o.length===0?[r]:o.map(h=>({...r,checkType:"quote-fragment",direction:h})).filter(h=>{const j=[h.cardId,h.checkType??"",h.direction??""].join("|");return a.has(j)?!1:(a.add(j),!0)})})})();function Dn({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,libraryId:d,collectionId:b,revisionId:l}){const c=Ja(),w=`/#/cogita/library/${d}`,g=n.useMemo(()=>new URLSearchParams(c.search),[c.search]),S=Math.max(1,Number(g.get("limit")??20)),K=g.get("mode")??"random",x=n.useMemo(()=>rs(K),[K]),y=n.useMemo(()=>jn(x,ir(x,g)),[x,g]),ce=g.get("check")??"exact",B=g.get("reviewer"),p=(g.get("scope")??"").trim(),W=p==="info"||p==="info-selection"?p:"collection",N=W==="info"?(g.get("infoId")??"").trim():"",ee=W==="info-selection"?(g.get("seed")??"").trim():"",[U,R]=n.useState(null),pe=b??U??void 0,F=W==="collection"&&!!pe,X=n.useMemo(()=>t.cogita.library.revision[x.labelKey]??K,[t,K,x]),Me=n.useMemo(()=>ce==="exact"?t.cogita.library.revision.checkValue:ce,[t,ce]),[Q,L]=n.useState(t.cogita.library.collections.defaultName),[$,z]=n.useState([]),[H,V]=n.useState([]),[me,ne]=n.useState("idle"),[ae,ke]=n.useState({current:0,total:0}),[Le,Ee]=n.useState(0),[$e,st]=n.useState(""),[mt,Te]=n.useState(null),[Ge,jt]=n.useState(null),[Oe,Be]=n.useState(null),[rt,ht]=n.useState(null),[et,Ce]=n.useState([]),[ze,tt]=n.useState({}),[E,M]=n.useState({}),[D,P]=n.useState(null),[k,T]=n.useState(null),[I,de]=n.useState(null),[xe,he]=n.useState(null),[te,A]=n.useState(null),[Y,re]=n.useState({}),G=n.useRef(0),[Z,Ae]=n.useState(null),ge=n.useRef(null),be=n.useRef(null),[Ve,nt]=n.useState(null),[He,Xe]=n.useState(!1),[We,De]=n.useState(null),[it,Ze]=n.useState([]),[xt,Ft]=n.useState(null),Mt=n.useRef(null),Tt=n.useRef(null),[sa,It]=n.useState(null),[ut,St]=n.useState(0),kt=n.useRef(null),wt=n.useRef({}),[_t,lt]=n.useState(!1),[Je,vt]=n.useState({}),[Qt,Ot]=n.useState([]),zt=n.useRef(new Map),[fe,Rt]=n.useState(new Set),[Xt,qt]=n.useState(!1),O=n.useRef(null),u=n.useRef(new Set),ie=n.useRef({});n.useEffect(()=>{if(!l||b){R(null);return}Zn({libraryId:d,revisionId:l}).then(f=>R(f.collectionId)).catch(()=>R(null))},[b,d,l]);const J=$[Le]??null,Ye=(J==null?void 0:J.checkType)==="translation-match"&&te,dt=n.useRef(new Map),gt=n.useRef(new Map),At=n.useRef(new Map),Lt=n.useRef(new Map),Nt=n.useMemo(()=>J?J.cardType==="vocab"?t.cogita.library.revision.vocabLabel:J.infoType?ot(t,J.infoType):t.cogita.library.revision.infoLabel:"",[t,J]),$t=n.useMemo(()=>{var C;return x.id!=="levels"?$.length:((C=Je.pool)==null?void 0:C.length)??x.getFetchLimit(S,y)},[Je,y,x,$.length,S]),ha=x.getProgressTotal?x.getProgressTotal($,Je,S,y):x.id==="levels"?Math.min(S,$t):$.length,ma=ha?Math.min(Le+1,ha):0,Kt=Math.max(1,Number(y.tries??1)),aa=y.compare??"anchors",Ta=Math.max(0,Math.min(100,Number(y.minCorrectness??0))),ft=(y.considerDependencies??"on")==="on",Dt=Math.max(0,Math.min(100,Number(y.dependencyThreshold??85))),Zt=f=>{const C=f.slice();for(let q=C.length-1;q>0;q-=1){const ue=Math.floor(Math.random()*(q+1));[C[q],C[ue]]=[C[ue],C[q]]}return C},wa=f=>xa(f,{treatSimilarCharsAsSame:!0})>=Ta,Wa=async()=>{const f=await da(),C=new Map,q=new Map,ue=new Map;f.forEach(se=>{const Ne=`${se.itemType}:${se.itemId}`,_e=ea(se.itemType,se.itemId,se.checkType,se.direction);if(C.has(Ne)||C.set(Ne,[]),C.get(Ne).push(se),q.has(_e)||q.set(_e,[]),q.get(_e).push(se),se.itemType==="info"&&se.checkType==="quote-fragment"&&se.direction){const qe=`${se.itemId}:${se.direction}`;ue.has(qe)||ue.set(qe,[]),ue.get(qe).push(se)}});const ye=new Map,oe=new Map,ve=new Map;return C.forEach((se,Ne)=>ye.set(Ne,ca(se).score)),q.forEach((se,Ne)=>oe.set(Ne,ca(se).score)),ue.forEach((se,Ne)=>ve.set(Ne,ca(se).score)),{itemKnowness:ye,cardKnowness:oe,fragmentKnowness:ve}},Gt=async f=>{const C=[];let q=null;for(;;){const ue=await qa({libraryId:d,collectionId:f,limit:200,cursor:q});if(C.push(...ue.items),!ue.nextCursor)break;q=ue.nextCursor}return Va(C)},Ca=async(f,C)=>{if(zt.current.has(f))return zt.current.get(f)??0;const q=await Gt(f);if(q.length===0)return zt.current.set(f,0),0;const ye=q.reduce((oe,ve)=>{const se=Se(ve);return oe+(C.get(se)??0)},0)/q.length;return zt.current.set(f,ye),ye},Ia=(f,C)=>{if(!ft||f.cardType!=="info"||f.infoType!=="citation"||f.checkType!=="quote-fragment")return!0;const q=Wt(f.direction);if(!(q!=null&&q.fragmentId))return!0;const ue=f.description??"";if(!ue.trim())return!0;const oe=va(ue).nodes[q.fragmentId];if(!oe||!oe.leftId&&!oe.rightId)return!0;const ve=[oe.leftId,oe.rightId].filter(_e=>!!_e);if(ve.length===0)return!0;const se=ve.map(_e=>{const qe=ea("info",f.cardId,"quote-fragment",_e);return C.get(qe)??0});return se.reduce((_e,qe)=>_e+qe,0)/se.length>=Dt},Pa=async f=>{const C=Je,q=f.concat(C.active??[]).concat(C.pool??[]).filter((se,Ne,_e)=>_e.findIndex(qe=>Se(qe)===Se(se))===Ne);if(!ft){Rt(new Set(q.map(Se)));return}const{itemKnowness:ue,cardKnowness:ye}=await Wa(),oe=Qt.filter(se=>Ct(se.childItemType)==="collection"&&se.childItemId===b&&!Ct(se.childCheckType)&&!Ct(se.childDirection)),ve=new Set;for(const se of q){if(se.cardType!=="info"){ve.add(Se(se));continue}if(!Ia(se,ye))continue;const Ne=Qt.filter(Ue=>hr(Ue,se)).concat(oe);if(Ne.length===0){ve.add(Se(se));continue}let _e=0;for(const Ue of Ne)if(Ct(Ue.parentItemType)==="collection")_e+=await Ca(Ue.parentItemId,ye);else if(Ct(Ue.parentCheckType)||Ct(Ue.parentDirection)){const at=Ct(Ue.parentCheckType),ct=Ct(Ue.parentDirection),pt=ea(Ue.parentItemType,Ue.parentItemId,at,ct);_e+=ye.get(pt)??0}else{const at=`${Ue.parentItemType}:${Ue.parentItemId}`;_e+=ue.get(at)??0}_e/Ne.length>=Dt&&ve.add(Se(se))}Rt(ve)},Qa=f=>{for(let C=f;C<$.length;C+=1){const q=$[C];if(q&&(!ft||q.cardType!=="info"||fe.has(Se(q))))return C}return-1},Ea=f=>!ft||f.cardType!=="info"||fe.has(Se(f)),kn=f=>{if(x.id!=="temporal"&&x.id!=="levels")return null;const C=Je,q=(C.active??[]).concat(C.pool??[]),ue=new Set;for(const ye of q){const oe=Se(ye);if(!(ue.has(oe)||f.has(oe))&&(ue.add(oe),Ea(ye)))return ye}return null},Ut=n.useMemo(()=>{if(x.id!=="levels")return null;const f=Je,C=f.pool??[],q=f.active??[],ue=f.levelMap??{},ye=Math.max(1,Number(y.levels??1)),oe=Array.from({length:ye},()=>0),ve=new Set(q.map(qe=>Se(qe)));C.forEach(qe=>{const Ue=Math.min(ye,Math.max(1,ue[Se(qe)]??1));oe[Ue-1]+=1});const se=C.length||1,Ne=oe.map(qe=>qe/se*100),_e=J?ue[Se(J)]??1:null;return{counts:oe,percentages:Ne,currentLevel:_e,levelsCount:ye,activeCount:q.length,poolCount:C.length,activeSet:ve}},[Je,y,x,J]),Jt=n.useMemo(()=>{if(x.id!=="temporal")return null;const f=Je,C=f.pool??[],q=f.active??[],ue=f.knownessMap??{},ye=new Set(f.unknownSet??[]);let oe=0;C.forEach(Ne=>{(ue[Se(Ne)]??0)>1&&(oe+=1)});const ve=ye.size,se=q.map(Ne=>({id:Se(Ne),value:ye.has(Se(Ne))?0:Math.max(0,Math.min(1,ue[Se(Ne)]??0))}));return{knownCount:oe,unknownCount:ve,dots:se}},[Je,x]),Nn=n.useMemo(()=>{if(!ft)return 0;const f=Je;return $.concat(f.active??[]).concat(f.pool??[]).filter((q,ue,ye)=>ye.findIndex(oe=>Se(oe)===Se(q))===ue).filter(q=>q.cardType==="info"&&!fe.has(Se(q))).length},[ft,Je,$,fe]);n.useEffect(()=>{if(!ft||me!=="ready")return;const f=Je,q=$.concat(f.active??[]).concat(f.pool??[]).filter((oe,ve,se)=>se.findIndex(Ne=>Se(Ne)===Se(oe))===ve).filter(oe=>oe.cardType!=="info"||fe.has(Se(oe))).length,ue=Mt.current;if(Mt.current=q,ue===null||q<=ue)return;const ye=q-ue;Ft(`New card available (+${ye})`),Tt.current&&window.clearTimeout(Tt.current),Tt.current=window.setTimeout(()=>Ft(null),2200)},[ft,me,Je,$,fe]),n.useEffect(()=>()=>{Tt.current&&window.clearTimeout(Tt.current)},[]);const Vt=(f,C)=>{const q=x.applyOutcome({queue:$,meta:Je},J,S,y,{correct:f,correctness:C,createdUtc:new Date().toISOString()});z(q.queue),vt(q.meta);const ue=q.queue[Le+1];ue&&ga(ue,Le+1)};n.useEffect(()=>{if(F&&pe){yn(d,pe).then(f=>L(f.name)).catch(()=>L(t.cogita.library.collections.defaultName));return}if(W==="info"&&N){ta({libraryId:d,infoId:N}).then(f=>{const C=f.payload??{};L(C.title||C.label||C.name||N)}).catch(()=>L(N||t.cogita.library.revision.runKicker));return}if(W==="info-selection"){const f=ee?ps(d,ee):null,C=(f==null?void 0:f.infoIds.length)??0;L(C>0?`Selected infos (${C})`:"Selected infos");return}L(t.cogita.library.collections.defaultName)},[t,pe,F,d,W,N,ee]),n.useEffect(()=>{Xn({libraryId:d,type:"language"}).then(f=>V(f)).catch(()=>V([]))},[d]),n.useEffect(()=>{F&&Yn({libraryId:d}).then(f=>Ot(f.items??[])).catch(()=>Ot([]))},[F,d]),n.useEffect(()=>{_n(d,B)},[d,B]),n.useEffect(()=>{Pa($)},[$,Qt,ft,Dt,pe]),n.useEffect(()=>{if(!J||!ft){qt(!1);return}if(J.cardType!=="info"||fe.has(Se(J))){qt(!1);return}const f=Qa(Le+1);if(f>=0){qt(!1),Ee(f);return}if(x.id==="temporal"||x.id==="levels"){const C=$.slice(0,Le+1),q=$.slice(Le+1).filter(Ea),ue=C.concat(q),ye=new Set(ue.map(Se)),oe=kn(ye);if(oe){const se=Se(oe);ye.has(se)||(ue.push(oe),ye.add(se),vt(Ne=>{const _e=Ne,qe=new Set(_e.queued??[]);return qe.add(se),{..._e,queued:qe}}))}const ve=ue.findIndex((se,Ne)=>Ne!==Le&&Ea(se));if(ve>=0){z(ue),Ee(ve),qt(!1);return}}qt(!0)},[J,fe,ft,Le,$,Je,x.id]),n.useEffect(()=>{let f=!0;return(async()=>{ne("loading"),ke({current:0,total:x.id==="levels"?0:x.getFetchLimit(S,y)});try{if(!F){if(Ot([]),W==="info"){if(!N){f&&(z([]),Ot([]),vt({}),Ee(0),ne("ready"));return}const[Ue,at]=await Promise.all([tn({libraryId:d,infoId:N}),an({libraryId:d,infoId:N})]);if(!f)return;const ct=Va(Ue.items??[]);Ot(at.items??[]);const pt=x.prepare(ct,S,y);z(pt.queue),vt(pt.meta),Ee(0),ne("ready"),ke({current:ct.length,total:ct.length});return}if(W==="info-selection"){const Ue=ee?ps(d,ee):null,at=(Ue==null?void 0:Ue.infoIds)??[];if(!at.length){f&&(z([]),Ot([]),vt({}),Ee(0),ne("ready"));return}const ct=await Promise.all(at.map(async pa=>{const[Ht,Ga]=await Promise.all([tn({libraryId:d,infoId:pa}),an({libraryId:d,infoId:pa})]);return{cards:Ht.items??[],deps:Ga.items??[]}}));if(!f)return;const pt=new Map;ct.forEach(pa=>{Va(pa.cards).forEach(Ht=>{pt.set(Se(Ht),Ht)})});const bt=Array.from(pt.values()),yt=new Set(bt.map(Se)),Pt=new Map;ct.forEach(pa=>{(pa.deps??[]).forEach(Ht=>{const Ga=ea(Ht.parentItemType,Ht.parentItemId,Ct(Ht.parentCheckType),Ct(Ht.parentDirection)),is=ea(Ht.childItemType,Ht.childItemId,Ct(Ht.childCheckType),Ct(Ht.childDirection));if(!yt.has(Ga)||!yt.has(is))return;const os=`${Ga}->${is}`;Pt.has(os)||Pt.set(os,Ht)})}),Ot(Array.from(Pt.values()));const ka=x.prepare(bt,S,y);z(ka.queue),vt(ka.meta),Ee(0),ne("ready"),ke({current:bt.length,total:bt.length});return}}const q=[];let ue=null,ye=null;do{const Ue=await qa({libraryId:d,collectionId:pe,limit:300,cursor:ue});if(q.push(...Ue.items),(x.id==="levels"||x.id==="temporal")&&Ue.total&&(ye=Ue.total),ke(at=>({current:q.length,total:at.total||Ue.total||x.getFetchLimit(S,y)})),ue=Ue.nextCursor??null,ye!==null&&q.length>=ye||x.id!=="levels"&&x.id!=="temporal"&&q.length>=x.getFetchLimit(S,y))break}while(ue);if(!f)return;const oe=Va(q);let ve;if(x.id==="levels"){const Ue=Math.max(1,Number(y.levels??1)),ct=(await da()).reduce((pt,bt)=>{const yt=ea(bt.itemType,bt.itemId,bt.checkType,bt.direction);return pt[yt]||(pt[yt]=[]),pt[yt].push(bt),pt},{});ve={},oe.forEach(pt=>{const bt=Se(pt),yt=ct[bt]??[],Pt=yt.length>0?ca(yt).score:0,ka=Math.max(1,Math.min(Ue,Math.ceil(Pt/100*Ue)));ve[bt]=ka})}let se=null,Ne=null,_e=null;if(x.id==="temporal"){const Ue=await da(),at=new Set(oe.map(bt=>Se(bt))),ct=Ue.reduce((bt,yt)=>{const Pt=ea(yt.itemType,yt.itemId,yt.checkType,yt.direction);return at.has(Pt)&&(bt[Pt]||(bt[Pt]=[]),bt[Pt].push(yt)),bt},{});se={},Ne=new Set,_e={};const pt=Date.now();oe.forEach(bt=>{const yt=Se(bt),Pt=ct[yt]??[];if(Pt.length===0){se[yt]=0,Ne.add(yt),_e[yt]=[];return}const ka=as(Pt);_e[yt]=ka;const pa=vn(ka,pt);se[yt]=pa.knowness})}const qe=x.id==="levels"?ss(oe,S,y,ve):x.id==="temporal"?ns(oe,S,y,se??{},Ne??new Set,_e??{}):x.prepare(oe,S,y);z(qe.queue),vt(qe.meta),Ee(0),ne("ready"),ke(Ue=>({current:Math.min(Ue.current,Ue.total),total:Ue.total}))}catch{f&&ne("error")}})(),()=>{f=!1}},[pe,F,d,S,W,y,x,B,N,ee]),n.useEffect(()=>{if(st(""),Te(null),It(null),St(0),Ce([]),tt({}),M({}),T(null),de(null),he(null),Xe(!1),lt(!1),nt(null),A(null),re({}),!J){jt(null),Be(null),P(null),De(null);return}J.cardType==="info"&&J.infoType==="computed"&&jt(t.cogita.library.revision.loadingComputed);let f=!0;return ga(J,Le).then(C=>{!f||!C||(jt(C.prompt),Be(C.expectedAnswer),Ce(C.computedExpected),tt(C.computedAnswers),P(C.computedValues),T(C.answerTemplate),de(C.outputVariables),he(C.variableValues))}),()=>{f=!1}},[J,t]),n.useEffect(()=>{if(!J||J.cardType!=="info"||J.infoType!=="citation"){O.current=null,u.current=new Set,ht(null);return}const f=J.description??"",C=(J.label??"").trim(),q=C.replace(/\s+/g," ").trim(),ue=f.replace(/\s+/g," ").trim(),ye=q&&q!==ue?C:t.cogita.library.infoTypes.citation;if(!f){ht(null),Be(null);return}const oe=va(f);O.current=oe,jt(ye);let ve=!0;return Wa().then(({fragmentKnowness:se})=>{if(!ve)return;const Ne=new Set,_e={};se.forEach((at,ct)=>{const[pt,bt]=ct.split(":",2);if(pt!==J.cardId)return;const yt=Wt(bt);if(!yt)return;const{fragmentId:Pt}=yt;_e[Pt]=at,at>=Dt&&Ne.add(Pt)}),u.current=Ne,ie.current=_e;const qe=Wt(J.direction);if(qe!=null&&qe.fragmentId&&oe.nodes[qe.fragmentId]){_(oe,qe.fragmentId,ye);return}const Ue=$a(oe,Ne,_e,Dt,ft,J.direction);_(oe,(Ue==null?void 0:Ue.id)??null,ye)}).catch(()=>{u.current=new Set,ie.current={};const se=Wt(J.direction);if(se!=null&&se.fragmentId&&oe.nodes[se.fragmentId]){_(oe,se.fragmentId,ye);return}const Ne=$a(oe,u.current,{},Dt,ft,J.direction);_(oe,(Ne==null?void 0:Ne.id)??null,ye)}),()=>{ve=!1}},[J,t,ft,Dt]),n.useEffect(()=>{if(!J||J.cardType!=="vocab"||J.checkType!=="translation-match"){A(null),re({});return}const q=(Je.pool??Je.active??$).filter(se=>se.cardType==="vocab"&&se.checkType==="translation-match").filter((se,Ne,_e)=>_e.findIndex(qe=>qe.cardId===se.cardId)===Ne);q.some(se=>se.cardId===J.cardId)||q.unshift(J);const ye=Zt(q).slice(0,6).map(se=>{const Ne=se.label.split("↔").map(Ue=>Ue.trim()).filter(Boolean);if(Ne.length<2)return null;const _e=`${se.cardId}:L`,qe=`${se.cardId}:R`;return{cardId:se.cardId,leftId:_e,rightId:qe,leftLabel:Ne[0],rightLabel:Ne[1]}}).filter(Boolean),oe=ye.map(se=>se.leftId),ve=Zt(ye.map(se=>se.rightId));A({pairs:ye,leftOrder:oe,rightOrder:ve,selection:{},activeLeft:null,activeRight:null,locked:{}})},[J,$,Je]),n.useEffect(()=>()=>{ge.current&&window.clearTimeout(ge.current),be.current&&window.clearTimeout(be.current)},[]);const ra=n.useRef(null);n.useEffect(()=>{if(!J)return;const f=Se(J),C=typeof document<"u"?document.activeElement:null;if(ra.current===f&&C&&(C.tagName==="INPUT"||C.tagName==="TEXTAREA"))return;let q=0;const ue=()=>{if(J){if(J.cardType==="info"&&J.infoType==="computed"){if(et.length>0){const oe=hn(k,et,I),ve=oe?wt.current[oe]:null;if(ve&&(ve.focus(),document.activeElement===ve)){ra.current=f;return}}if(kt.current&&(kt.current.focus(),document.activeElement===kt.current)){ra.current=f;return}}else if(J.cardType==="vocab"&&kt.current&&(kt.current.focus(),document.activeElement===kt.current)){ra.current=f;return}q<6&&(q+=1,window.setTimeout(ue,40))}},ye=window.setTimeout(ue,40);return()=>window.clearTimeout(ye)},[J,et,k,I]),n.useEffect(()=>{if(!_t)return;const f=C=>{C.key==="Enter"&&(C.preventDefault(),La())};return window.addEventListener("keydown",f),()=>window.removeEventListener("keydown",f)},[_t]);const Ma=f=>{Ze(f),De(ca(f))};n.useEffect(()=>{if(!J){De(null),Ze([]);return}const f=J.cardType==="info"?"info":"connection";if(J.cardType==="info"&&J.infoType==="citation"){da().then(C=>{const q=C.filter(ue=>ue.itemType==="info"&&ue.itemId===J.cardId&&ue.checkType==="quote-fragment"&&dn(ue.direction,J.direction));Ma(q)}).catch(()=>{De(null),Ze([])});return}cn(f,J.cardId,J.checkType,J.direction).then(C=>Ma(C)).catch(()=>{De(null),Ze([])})},[d,J,B]);const ja=(f,C,q,ue)=>{if(f==="info"&&q==="quote-fragment"){da().then(ye=>{const oe=ye.filter(ve=>ve.itemType==="info"&&ve.itemId===C&&ve.checkType==="quote-fragment"&&dn(ve.direction,ue));Ma(oe)}).catch(()=>{De(null),Ze([])});return}cn(f,C,q,ue).then(ye=>Ma(ye)).catch(()=>{De(null),Ze([])})},Ka=(f,C,q)=>{var ve;const ue=((ve=q.pairs.find(se=>se.leftId===f))==null?void 0:ve.rightId)??null;if(!ue)return q;const ye=ue===C;re(se=>({...se,[f]:ye?"correct":"incorrect"})),ge.current&&window.clearTimeout(ge.current),be.current&&window.clearTimeout(be.current),G.current+=1;const oe={kind:ye?"correct":"incorrect",tick:G.current};if(Ae(null),ge.current=window.setTimeout(()=>Ae(oe),0),be.current=window.setTimeout(()=>Ae(null),420),ye){const se={...q.locked,[f]:!0};return Object.keys(se).length>=q.pairs.length?(Te("correct"),lt(!0)):Te("correct"),{...q,selection:{...q.selection,[f]:C},activeLeft:null,activeRight:null,locked:se}}return Te("incorrect"),{...q,activeLeft:null,activeRight:null}},Sn=f=>{A(C=>!C||C.locked[f]?C:C.activeRight?Ka(f,C.activeRight,C):{...C,activeLeft:C.activeLeft===f?null:f})},Tn=f=>{A(C=>C&&(C.activeLeft?Ka(C.activeLeft,f,C):{...C,activeRight:C.activeRight===f?null:f}))},La=()=>{var f;if(J&&J.cardType==="info"&&J.infoType==="citation"&&O.current&&rt&&!((f=Wt(J.direction))!=null&&f.fragmentId)){const C=$a(O.current,u.current,ie.current,Dt,ft,J.direction,rt.fragmentId);if(C){Te(null),st(""),Xe(!1),M({}),lt(!1),It(null),St(0),_(O.current,C.id,rt.title);return}}Te(null),st(""),Xe(!1),M({}),lt(!1),It(null),St(0),Ee(C=>Math.min(C+1,$.length))},na=f=>{if(!J)return;const C=f.expected??null,q=f.answer??"";let ue=C??"",ye=q;if(!C&&f.expectedMap&&f.answerMap){const Ue=Object.keys(f.expectedMap).sort((at,ct)=>at.localeCompare(ct));ue=Ue.map(at=>{var ct;return((ct=f.expectedMap)==null?void 0:ct[at])??""}).join("|"),ye=Ue.map(at=>{var ct;return((ct=f.answerMap)==null?void 0:ct[at])??""}).join("|")}const oe=ue?Ra(ue,ye,aa):new Uint8Array,ve={revisionType:x.id,evalType:f.evalType,direction:f.direction,prompt:Ge??"",expected:C,answer:q,expectedAnswers:f.expectedMap??null,answers:f.answerMap??null,correct:f.correct,maskBase64:oe.length?ya(oe):null,values:D??null,checkMode:ce,compareMode:aa,minCorrectness:Ta},se=new TextEncoder().encode(JSON.stringify(ve)),Ne=J.cardType==="info"?"info":"connection",_e=f.overrideCheckType??J.checkType??null,qe=f.overrideDirection??J.direction??null;ln({itemType:Ne,itemId:J.cardId,checkType:_e,direction:qe,revisionType:x.id,evalType:f.evalType,correct:f.correct,maskBase64:oe.length?ya(oe):null,payloadBase64:ya(se),personRoleId:B??null}).then(()=>{ja(Ne,J.cardId,_e,qe),Pa($),_n(d,B)}).catch(()=>{})},Cn=(f,C)=>{const q=dt.current.get(C);if(q)return Promise.resolve(q);const ue=gt.current.get(C);if(ue)return ue;const ye=ta({libraryId:d,infoId:f}).then(oe=>{var Ue,at;const ve=oe.payload,se=((Ue=ve.definition)==null?void 0:Ue.graph)??null,Ne="",_e=((at=ve.definition)==null?void 0:at.answerTemplate)??"",qe=or(se,Ne,_e);if(qe){const pt={sample:lr(qe),answerTemplate:_e||null};return dt.current.set(C,pt),pt}return Un({libraryId:d,infoId:f}).then(ct=>{const pt={sample:ct,answerTemplate:null};return dt.current.set(C,pt),pt})}).catch(()=>Un({libraryId:d,infoId:f}).then(oe=>{const ve={sample:oe,answerTemplate:null};return dt.current.set(C,ve),ve}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{gt.current.delete(C)});return gt.current.set(C,ye),ye},ga=(f,C)=>{var se;const q=`${Se(f)}:${C}`,ue=At.current.get(q);if(ue)return Promise.resolve(ue);const ye=Lt.current.get(q);if(ye)return ye;const oe=Ne=>(At.current.set(q,Ne),Ne);let ve;if(f.cardType==="vocab"){if(f.checkType==="translation-match")return ve=Promise.resolve(oe({prompt:f.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),ve;const Ne=f.label.split("↔").map(_e=>_e.trim()).filter(Boolean);if(Ne.length>=2){const qe=(f.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",Ue=qe?Ne[0]:Ne[1],at=qe?Ne[1]:Ne[0];ve=Promise.resolve(oe({prompt:Ue,expectedAnswer:at,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else ve=Promise.resolve(oe({prompt:f.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(f.cardType==="info"&&f.infoType==="word"){const Ne=(se=f.description)!=null&&se.startsWith("Language: ")?f.description.replace("Language: ",""):null;ve=Promise.resolve(oe({prompt:f.label,expectedAnswer:Ne,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else f.cardType==="info"&&f.infoType==="question"?ve=ta({libraryId:d,infoId:f.cardId}).then(Ne=>{const _e=Ne.payload??{},qe=_e.definition??_e??{},Ue=typeof qe.type=="string"?qe.type:"",at=(typeof qe.question=="string"&&qe.question.trim()?qe.question.trim():null)??(typeof qe.title=="string"&&qe.title.trim()?qe.title.trim():null)??f.label,ct=qe.answer;return oe(Ue==="text"||Ue==="number"||Ue==="date"?{prompt:at,expectedAnswer:typeof ct=="string"||typeof ct=="number"?String(ct):null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}:{prompt:at,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})}).catch(()=>oe({prompt:f.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Lt.current.delete(q)}):f.cardType==="info"&&f.infoType==="computed"?ve=Cn(f.cardId,q).then(Ne=>{var ct,pt;if(!Ne.sample)return oe({prompt:f.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const _e=Ne.sample,qe=_e.expectedAnswers?Object.entries(_e.expectedAnswers).map(([bt,yt])=>({key:bt,expected:yt})):[],Ue=qe.reduce((bt,yt)=>(bt[yt.key]="",bt),{}),at=_e.expectedAnswerIsSentence&&((ct=_e.expectedAnswer)==null?void 0:ct.trim())||null;return oe({prompt:_e.prompt,expectedAnswer:qe.length>0?at:((pt=_e.expectedAnswer)==null?void 0:pt.trim())||null,computedExpected:qe,computedAnswers:Ue,computedValues:_e.values??null,answerTemplate:Ne.answerTemplate,outputVariables:_e.outputVariables??null,variableValues:_e.variableValues??null})}).catch(()=>oe({prompt:f.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Lt.current.delete(q)}):ve=Promise.resolve(oe({prompt:f.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return Lt.current.set(q,ve),ve},_=(f,C,q)=>{const ue=Object.keys(f.nodes).length,ye=u.current.size;if(!C){ht({title:q,before:f.text,after:"",fragmentId:null,total:ue,completed:ye}),Be(null),lt(!0);return}const oe=f.nodes[C];if(!oe)return;const ve=xn(f.text,oe);ht({title:q,before:ve.before,after:ve.after,fragmentId:oe.id,total:ue,completed:ye}),Be(ve.fragment),lt(!1)},le=()=>{const f=O.current;f&&ht(C=>C&&{...C,total:Object.keys(f.nodes).length,completed:u.current.size})},we=()=>{const f=$[Le+1];f&&ga(f,Le+1)},Ke=()=>{if(we(),J&&J.cardType==="vocab"&&J.checkType==="translation-match"&&te){if(te.pairs.length===0){Te("incorrect"),lt(!0);return}const oe=te.pairs.reduce((at,ct)=>(at[ct.rightId]=ct.rightLabel,at),{});let ve=0;const se={};te.pairs.forEach(at=>{const pt=te.selection[at.leftId]===at.rightId;se[at.leftId]=pt?"correct":"incorrect",pt&&(ve+=1)});const Ne=te.pairs.length||1,_e=ve/Ne,qe=ve===te.pairs.length;re(at=>({...at,...se})),qe?(Te("correct"),lt(!0),St(0)):(Te("incorrect"),lt(!1),St(at=>{const ct=at+1;return ct>=Kt&&(Xe(!0),lt(!0),A(pt=>{if(!pt)return pt;const bt=pt.pairs.reduce((yt,Pt)=>(yt[Pt.leftId]=Pt.rightId,yt),{});return{...pt,selection:bt}})),ct})),Vt(qe,_e);const Ue="connection";Promise.all(te.pairs.map(at=>{const ct=te.selection[at.leftId]??null,pt=ct?oe[ct]:"",bt={left:at.leftLabel,expected:at.rightLabel,answer:pt,checkType:"translation-match"},yt=new TextEncoder().encode(JSON.stringify(bt));return ln({itemType:Ue,itemId:at.cardId,checkType:"translation-match",direction:null,revisionType:x.id,evalType:"translation-match",correct:ct===at.rightId,maskBase64:null,payloadBase64:ya(yt),personRoleId:B??null})})).then(()=>{ja(Ue,J.cardId,J.checkType,J.direction),_n(d,B)}).catch(()=>{});return}if(et.length>0){const oe=et.reduce((se,Ne)=>{const _e=ze[Ne.key]??"";return se[Ne.key]=Bt(_e)===Bt(Ne.expected)?"correct":"incorrect",se},{});et.every(({key:se,expected:Ne})=>{const _e=ze[se]??"";return ce==="exact"&&Bt(_e)===Bt(Ne)})?(Te("correct"),M(oe),lt(!0),St(0),Vt(!0,1),na({correct:!0,direction:Ge?`${Ge} -> computed`:"computed",expectedMap:et.reduce((se,Ne)=>(se[Ne.key]=Ne.expected,se),{}),answerMap:ze,evalType:"computed"})):(Te("incorrect"),M(oe),lt(!1),St(se=>{const Ne=se+1;return Ne>=Kt&&Qe&&(Xe(!0),lt(!0)),Ne}),Vt(!1,0),window.setTimeout(()=>{var Ne;const se=hn(k,et,I);se&&wt.current[se]&&((Ne=wt.current[se])==null||Ne.focus())},40),na({correct:!1,direction:Ge?`${Ge} -> computed`:"computed",expectedMap:et.reduce((se,Ne)=>(se[Ne.key]=Ne.expected,se),{}),answerMap:ze,evalType:"computed"}));return}if(J&&J.cardType==="info"&&J.infoType==="citation"&&(rt!=null&&rt.fragmentId)){if(!Oe)return;const oe=Wt(J.direction),ve=(oe==null?void 0:oe.fragmentId)??rt.fragmentId,se=Sa(Oe,$e,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Ne=se.mask,_e=se.isCorrect,qe=se.percent;_e?(ie.current[rt.fragmentId]=Math.max(ie.current[rt.fragmentId]??0,qe),(ie.current[rt.fragmentId]??0)>=Dt&&u.current.add(rt.fragmentId),le(),Te("correct"),M({}),lt(!0),It(Ne),St(0),qe<100&&Kt<=1&&Xe(!0),Vt(!0,qe/100),na({correct:!0,direction:`quote:${rt.fragmentId}`,expected:Oe,answer:$e,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:ve})):(Te("incorrect"),M({}),lt(!1),It(Ne),St(Ue=>{const at=Ue+1;return at>=Kt&&Qe&&(Xe(!0),lt(!0)),at}),Vt(!1,qe/100),window.setTimeout(()=>{var Ue;return(Ue=kt.current)==null?void 0:Ue.focus()},40),na({correct:!1,direction:`quote:${rt.fragmentId}`,expected:Oe,answer:$e,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:ve}));return}if(!Oe)return;const f=Ra(Oe,$e,aa),C=ce==="exact"&&Bt($e)===Bt(Oe),q=wa(f),ue=C||q,ye=xa(f);ue?(Te("correct"),M({}),lt(!0),It(f),St(0),ye<100&&Kt<=1&&Xe(!0),Vt(!0,ye/100),na({correct:!0,direction:Ge?`${Ge} -> ${Oe}`:null,expected:Oe,answer:$e,evalType:"text"})):(Te("incorrect"),M({}),lt(!1),It(f),St(oe=>{const ve=oe+1;return ve>=Kt&&Qe&&(Xe(!0),lt(!0)),ve}),Vt(!1,ye/100),window.setTimeout(()=>{var oe;return(oe=kt.current)==null?void 0:oe.focus()},40),na({correct:!1,direction:Ge?`${Ge} -> ${Oe}`:null,expected:Oe,answer:$e,evalType:"text"}))},Fe=f=>{if(we(),!Oe)return;const C=Ra(Oe,f,aa),q=Bt(f)===Bt(Oe),ue=wa(C),ye=q||ue,oe=xa(C);ye?(Te("correct"),M({}),lt(!0),It(C),St(0),oe<100&&Kt<=1&&Xe(!0),Vt(!0,oe/100),na({correct:!0,direction:"word->language",expected:Oe,answer:f,evalType:"language-select"})):(Te("incorrect"),M({}),lt(!1),It(C),St(ve=>{const se=ve+1;return se>=Kt&&Qe&&(Xe(!0),lt(!0)),se}),Vt(!1,oe/100),na({correct:!1,direction:"word->language",expected:Oe,answer:f,evalType:"language-select"}))},je=()=>{we(),Te("correct"),lt(!0),St(0),Vt(!0,1),Oe&&na({correct:!0,direction:"manual",expected:Oe,answer:$e,evalType:"manual"})},Pe=()=>{if(Vt(!1,0),J&&J.cardType==="info"&&J.infoType==="citation"){Te(null),st(""),Xe(!1),M({}),lt(!1),It(null),St(0),Ee(f=>Math.min(f+1,$.length));return}La()};n.useEffect(()=>{we()},[Le,$]);const Ie=f=>{var q;if(f.key!=="Enter")return;if(f.preventDefault(),f.stopPropagation(),_t){La();return}const C=et.find(ue=>!(ze[ue.key]??"").trim());if(C){(q=wt.current[C.key])==null||q.focus();return}Ke()},Re=t.cogita.library.revision.revealModeAfterIncorrect,Qe=et.length>0||!!Oe;return e.jsxs(Et,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,children:[me==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${ae.total?Math.min(100,Math.max(0,ae.current/ae.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:ae.total?`${Math.min(ae.current,ae.total)} / ${ae.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:Q}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",X).replace("{check}",Me)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:w,children:t.cogita.library.actions.libraryOverview}),F?e.jsxs(e.Fragment,{children:[e.jsx("a",{className:"cta ghost",href:`${w}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${w}/collections/${pe}`,children:t.cogita.library.actions.collectionDetail})]}):e.jsx("a",{className:"cta ghost",href:`${w}/list`,children:t.cogita.library.actions.allCards})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:We?`${We.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Ut?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Ut.currentLevel??"-"," / ",Ut.levelsCount]}):null,We?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(We.correct)).replace("{total}",String(We.total))}),We.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(We.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(cr,{outcomes:it})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[xt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:xt})}):null,e.jsx(es,{feedbackToken:Z?`${Z.kind}-${Z.tick}`:Ye?"idle":mt??"idle",children:J?e.jsx(e.Fragment,{children:Xt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(ts,{copy:t,currentCard:J,currentTypeLabel:Nt,prompt:Ge,languages:H,answer:$e,onAnswerChange:f=>st(C=>un(C,f,Ve)),computedExpected:et,computedAnswers:ze,onComputedAnswerChange:(f,C)=>tt(q=>({...q,[f]:un(q[f]??"",C,Ve)})),answerTemplate:k,outputVariables:I,variableValues:xe,computedFieldFeedback:E,feedback:mt,canAdvance:_t,quoteContext:rt,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Ke,onSkip:Pe,onLanguageSelect:Fe,onMarkReviewed:je,onAdvance:La,showCorrectAnswer:He,setShowCorrectAnswer:Xe,onRevealCorrect:()=>lt(!0),answerMask:sa,expectedAnswer:Oe,hasExpectedAnswer:Qe,handleComputedKeyDown:Ie,answerInputRef:kt,computedInputRefs:wt,scriptMode:Ve,setScriptMode:nt,matchPairs:te==null?void 0:te.pairs,matchLeftOrder:te==null?void 0:te.leftOrder,matchRightOrder:te==null?void 0:te.rightOrder,matchSelection:te==null?void 0:te.selection,matchActiveLeft:te==null?void 0:te.activeLeft,matchActiveRight:te==null?void 0:te.activeRight,matchFeedback:Y,onMatchLeftSelect:Sn,onMatchRightSelect:Tn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:F?`${w}/collections/${pe}`:`${w}/list`,children:F?t.cogita.library.actions.collectionDetail:t.cogita.library.actions.allCards})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:ha?`${ma} / ${ha}`:t.cogita.library.revision.progressUnlimited}),me==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),me==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),me==="ready"&&$.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Re}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",Kt]})]})]}),Ut?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Ut.activeCount," / ",Ut.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Ut.counts.map((f,C)=>{const q=C+1,ue=Ut.currentLevel===q,ye=Ut.percentages[C]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":ue,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:q}),e.jsx("strong",{children:f})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,ye))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[ye.toFixed(1),"%"]})]},`level-${q}`)})})]}):null,Jt?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:Jt.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:Jt.dots.map(f=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,f.value*100))}%`,background:`rgba(${Math.round(255*(1-f.value))}, ${Math.round(200*f.value)}, 80, 0.9)`}},f.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:Jt.knownCount})]})]}):null,ft?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Nn})]})}):null]})]})]})})})]})]})}const Bn=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],uo={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},ho=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],go=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function mo({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,libraryId:d,collectionId:b}){const[l,c]=n.useState(""),[w,g,S]=Hn([]),[K,x,y]=Wn([]),[ce,B]=n.useState(null),[p,W]=n.useState(null),[N,ee]=n.useState(null),U=`/#/cogita/library/${d}`;n.useEffect(()=>{yn(d,b).then(L=>c(L.name)).catch(()=>c(t.cogita.library.collections.defaultName))},[d,b,t]),n.useEffect(()=>{Rr({libraryId:d,collectionId:b}).then(L=>{if(!L.graphId||L.graphId==="00000000-0000-0000-0000-000000000000"){g([]),x([]);return}const $=L.nodes.map(H=>{var ae;const V=H.payload??{},me=V.position??{x:120,y:120},ne=V.params??{};return{id:H.nodeId,type:"default",position:me,data:{nodeType:H.nodeType,label:((ae=Bn.find(ke=>ke.type===H.nodeType))==null?void 0:ae.label)??H.nodeType,params:ne}}}),z=L.edges.map(H=>({id:H.edgeId,source:H.fromNodeId,target:H.toNodeId,sourceHandle:H.fromPort??void 0,targetHandle:H.toPort??void 0}));g($),x(z)}).catch(()=>{g([]),x([])})},[d,b,x,g]);const R=n.useMemo(()=>w.find(L=>L.id===ce)??null,[w,ce]),pe=L=>{var V;const $=crypto.randomUUID(),z=((V=Bn.find(me=>me.type===L))==null?void 0:V.label)??L,H={...uo[L]};g(me=>[...me,{id:$,type:"default",position:{x:120+me.length*40,y:120+me.length*40},data:{nodeType:L,label:z,params:H}}]),B($)},F=n.useCallback(L=>{x($=>Qn({...L,id:crypto.randomUUID()},$))},[x]),X=async()=>{W(null);try{await Xs({libraryId:d,collectionId:b,nodes:w.map(L=>({nodeId:L.id,nodeType:L.data.nodeType,payload:{position:L.position,params:L.data.params}})),edges:K.map(L=>({edgeId:L.id,fromNodeId:L.source,fromPort:L.sourceHandle??null,toNodeId:L.target,toPort:L.targetHandle??null}))}),W(t.cogita.library.graph.saveSuccess)}catch{W(t.cogita.library.graph.saveFail)}},Me=async()=>{try{const L=await Pr({libraryId:d,collectionId:b});ee(L)}catch{ee(null)}},Q=L=>{R&&g($=>$.map(z=>z.id===R.id?{...z,data:{...z.data,params:L}}:z))};return e.jsx(Et,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${U}/collections/${b}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Me,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:X,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Bn.map(L=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>pe(L.type),children:L.label},L.type))}),p?e.jsx("p",{className:"cogita-help",children:p}):null,N&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(N.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(N.connections)).replace("{infos}",String(N.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(pn,{nodes:w,edges:K,onNodesChange:S,onEdgesChange:y,onConnect:F,onNodeClick:(L,$)=>B($.id),fitView:!0,children:[e.jsx(fn,{color:"rgba(120,160,200,0.2)"}),e.jsx(bn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),R?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:R.data.label}),R.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:d,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:R.data.params.tagId?{id:R.data.params.tagId,label:R.data.params.tagLabel??"",infoType:"topic"}:null,onChange:L=>Q({...R.data.params,tagId:(L==null?void 0:L.id)??null,tagLabel:(L==null?void 0:L.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:R.data.params.scope??"any",onChange:L=>Q({...R.data.params,scope:L.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),R.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:d,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:R.data.params.languageId?{id:R.data.params.languageId,label:R.data.params.languageLabel??"",infoType:"language"}:null,onChange:L=>Q({...R.data.params,languageId:(L==null?void 0:L.id)??null,languageLabel:(L==null?void 0:L.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:R.data.params.scope??"any",onChange:L=>Q({...R.data.params,scope:L.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),R.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:R.data.params.infoType??"word",onChange:L=>Q({...R.data.params,infoType:L.target.value}),children:go.map(L=>e.jsx("option",{value:L.value,children:L.label},L.value))})]}),e.jsx(Yt,{libraryId:d,infoType:R.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:R.data.params.infoId?{id:R.data.params.infoId,label:R.data.params.infoLabel??"",infoType:R.data.params.infoType??"word"}:null,onChange:L=>Q({...R.data.params,infoId:(L==null?void 0:L.id)??null,infoLabel:(L==null?void 0:L.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),R.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:R.data.params.connectionType??"translation",onChange:L=>Q({...R.data.params,connectionType:L.target.value}),children:ho.map(L=>e.jsx("option",{value:L.value,children:L.label},L.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:R.data.params.connectionId??"",onChange:L=>Q({...R.data.params,connectionId:L.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(R.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const zn="cogita.preferences",Vn="cogita.reviewer.preferences",gr=["library_overview","all_cards","all_collections","all_revisions","storyboards","texts","dependencies","transfer"],On={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},all_revisions:{requiresCollection:!1,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},po=["settings","run","shared"],Aa=30,Ds=42;function fa(t,a){const r=(t??"").trim();return r.length<=a?r:a<=1?r.slice(0,a):`${r.slice(0,Math.max(1,a-1)).trimEnd()}…`}function fo(t,a=""){const r=t.split("/").filter(Boolean);if(r[0]!=="cogita"||r[1]!=="library")return{};const s=r[2];if(!s)return{};if(!r[3])return{libraryId:s,target:"library_overview"};const i=new URLSearchParams(a),o=i.get("revisionId")??void 0,h=i.get("infoId")??void 0,j=i.get("infoView"),m=j==="cards"?"cards":j==="collections"?"collections":"overview",v=i.get("collectionView")==="overview"?"overview":"infos",d=i.get("collectionAction"),b=i.get("libraryAction"),c=i.get("libraryTarget")==="revisions"?"all_revisions":"all_collections";if(r[3]==="list")return{libraryId:s,target:b==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:o,infoId:h,infoView:m,libraryAction:b==="new-info"?"new-info":void 0};if(r[3]==="detail"||r[3]==="collection")return{libraryId:s,target:"all_cards",cardMode:r[3],revisionId:o,infoId:h,infoView:m};if(r[3]==="new"||r[3]==="add")return{libraryId:s,target:"new_card",revisionId:o,libraryAction:"new-info"};if(r[3]==="edit")return{libraryId:s,target:"new_card",revisionId:o,infoId:r[4]};if(r[3]==="infos"){const g=r[4];return g?r[5]==="checkcards"?{libraryId:s,target:"all_cards",cardMode:"list",revisionId:o,infoId:g,infoView:"cards"}:r[5]==="collections"?{libraryId:s,target:"all_cards",cardMode:"list",revisionId:o,infoId:g,infoView:"collections"}:{libraryId:s,target:"all_cards",cardMode:"list",revisionId:o,infoId:g,infoView:"overview"}:{libraryId:s,target:"all_cards",cardMode:"list",revisionId:o}}if(r[3]==="shared-revisions")return{libraryId:s,target:c,revisionId:o};if(r[3]==="revisions"){const g=r[4];return g?g==="shared-links"?{libraryId:s,target:"all_revisions",revisionView:"shared"}:g==="new"?{libraryId:s,target:"all_revisions",revisionView:"new"}:r[5]==="run"?{libraryId:s,target:"all_revisions",revisionId:g,revisionView:"run"}:r[5]==="shared"?{libraryId:s,target:"all_revisions",revisionId:g,revisionView:"shared"}:{libraryId:s,target:"all_revisions",revisionId:g,revisionView:"settings"}:{libraryId:s,target:"all_revisions"}}if(r[3]==="revision"&&r[4]==="run")return{libraryId:s,target:c,revisionView:"run",revisionId:o,infoId:h,infoView:m};if(r[3]==="dependencies")return{libraryId:s,target:"dependencies"};if(r[3]==="transfer")return{libraryId:s,target:"transfer"};if(r[3]==="storyboards")return r[4]==="new"?{libraryId:s,target:"new_storyboard"}:{libraryId:s,target:"storyboards"};if(r[3]==="texts")return r[4]==="new"?{libraryId:s,target:"new_text"}:{libraryId:s,target:"texts"};if(r[3]!=="collections")return{libraryId:s,target:"library_overview"};if(r[4]==="new")return{libraryId:s,target:"new_collection",revisionId:o};const w=r[4];return w?r[5]==="graph"?{libraryId:s,target:c,collectionId:w,revisionId:o,revisionView:"graph"}:r[5]==="shared-revisions"?{libraryId:s,target:c,collectionId:w,revisionId:o,revisionView:"shared"}:r[5]==="revision"?{libraryId:s,target:c,collectionId:w,revisionId:o,revisionView:r[6]==="run"?"run":"settings",collectionView:v}:d==="new-revision"?{libraryId:s,target:c,collectionId:w,revisionId:o,revisionView:"new"}:{libraryId:s,target:c,collectionId:w,revisionId:o,revisionView:"detail",collectionView:v}:d==="new-collection"?{libraryId:s,target:"new_collection",collectionAction:"new-collection"}:{libraryId:s,target:c}}function Bs(t,a="library_overview",r,s,i,o,h="overview",j="infos"){const m=(v,d)=>{const b=new URLSearchParams;d!=null&&d.revisionId&&b.set("revisionId",d.revisionId),d!=null&&d.collectionAction&&b.set("collectionAction",d.collectionAction),d!=null&&d.libraryAction&&b.set("libraryAction",d.libraryAction),d!=null&&d.libraryTarget&&b.set("libraryTarget",d.libraryTarget),d!=null&&d.infoId&&b.set("infoId",d.infoId),d!=null&&d.infoView&&(d!=null&&d.infoId)&&b.set("infoView",d.infoView),d!=null&&d.collectionView&&d.collectionView!=="infos"&&b.set("collectionView",d.collectionView);const l=b.toString();return l?`${v}?${l}`:v};if(!t)return"/cogita";if(a==="library_overview")return m(`/cogita/library/${t}`,{revisionId:i});if(a==="all_cards")return o?h==="cards"?m(`/cogita/library/${t}/infos/${o}/checkcards`,{revisionId:i}):h==="collections"?m(`/cogita/library/${t}/infos/${o}/collections`,{revisionId:i}):m(`/cogita/library/${t}/infos/${o}`,{revisionId:i}):m(`/cogita/library/${t}/list`,{revisionId:i,infoId:o,infoView:h});if(a==="new_card")return o?m(`/cogita/library/${t}/edit/${o}`,{revisionId:i}):m(`/cogita/library/${t}/list`,{revisionId:i,libraryAction:"new-info"});if(a==="all_collections"||a==="all_revisions"){const v=a==="all_revisions"?"revisions":void 0;return a==="all_revisions"&&i?s==="run"?m(`/cogita/library/${t}/revisions/${i}/run`,{revisionId:i}):s==="shared"?m(`/cogita/library/${t}/revisions/${i}/shared`,{revisionId:i}):m(`/cogita/library/${t}/revisions/${i}`,{revisionId:i}):a==="all_revisions"&&s==="new"?m(`/cogita/library/${t}/revisions/new`,{revisionId:i}):a==="all_revisions"?s==="shared"?m(`/cogita/library/${t}/revisions/shared-links`,{revisionId:i}):s==="run"?m(`/cogita/library/${t}/revision/run`,{revisionId:i,libraryTarget:v}):m(`/cogita/library/${t}/revisions`,{revisionId:i}):!r&&s==="run"?m(`/cogita/library/${t}/revision/run`,{revisionId:i,libraryTarget:v}):r?s==="graph"?m(`/cogita/library/${t}/collections/${r}/graph`,{revisionId:i,libraryTarget:v}):s==="settings"?m(`/cogita/library/${t}/collections/${r}/revision`,{revisionId:i,libraryTarget:v}):s==="run"?m(`/cogita/library/${t}/collections/${r}/revision/run`,{revisionId:i,libraryTarget:v}):s==="shared"?m(`/cogita/library/${t}/collections/${r}/shared-revisions`,{revisionId:i,libraryTarget:v}):s==="new"?m(`/cogita/library/${t}/collections/${r}`,{revisionId:i,libraryTarget:v,collectionAction:"new-revision"}):m(`/cogita/library/${t}/collections/${r}`,{revisionId:i,libraryTarget:v,collectionView:j}):m(`/cogita/library/${t}/collections`,{revisionId:i,libraryTarget:v})}return a==="new_collection"?m(`/cogita/library/${t}/collections`,{revisionId:i,collectionAction:"new-collection"}):a==="transfer"?m(`/cogita/library/${t}/transfer`,{revisionId:i}):a==="storyboards"?m(`/cogita/library/${t}/storyboards`,{revisionId:i}):a==="new_storyboard"?m(`/cogita/library/${t}/storyboards/new`,{revisionId:i}):a==="texts"?m(`/cogita/library/${t}/texts`,{revisionId:i}):a==="new_text"?m(`/cogita/library/${t}/texts/new`,{revisionId:i}):a==="dependencies"?m(`/cogita/library/${t}/dependencies`,{revisionId:i}):m(`/cogita/library/${t}`,{revisionId:i})}function ba(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function bo(t){return typeof t=="string"&&gr.includes(t)}function yo(t,a){var j;if(!t.length)return null;const r=t.filter(m=>a.has(m.roleId)),s=r.length>0?r:t,i=s.map(m=>{var d,b;const v=((b=(d=m.fields.find(l=>l.fieldType==="role_kind"))==null?void 0:d.plainValue)==null?void 0:b.toLowerCase())??"";return{roleId:m.roleId,roleKind:v}}),o=i.find(m=>m.roleKind.includes("master"));if(o)return o.roleId;const h=i.find(m=>m.roleKind.includes("account")||m.roleKind.includes("user"));return h?h.roleId:((j=s[0])==null?void 0:j.roleId)??null}function xo(t){if(!t)return{version:1,byLibrary:{}};try{const a=JSON.parse(t);return!a||typeof a!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:a.lastLibraryId,byLibrary:a.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function vo({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v}){const d=mn(),b=Ja(),l=n.useMemo(()=>fo(b.pathname,b.search),[b.pathname,b.search]),c=t.cogita.workspace,[w,g]=n.useState([]),[S,K]=n.useState([]),[x,y]=n.useState([]),[ce,B]=n.useState([]),[p,W]=n.useState(void 0),[N,ee]=n.useState("library_overview"),[U,R]=n.useState(void 0),[pe,F]=n.useState(void 0),[X,Me]=n.useState("detail"),[Q,L]=n.useState(void 0),[$,z]=n.useState(!1),[H,V]=n.useState(!0),[me,ne]=n.useState(!1),[ae,ke]=n.useState(!1),[Le,Ee]=n.useState(null),[$e,st]=n.useState(0),[mt,Te]=n.useState(""),[Ge,jt]=n.useState(""),[Oe,Be]=n.useState(""),[rt,ht]=n.useState([]),[et,Ce]=n.useState(""),[ze,tt]=n.useState(0),[E,M]=n.useState(null),[D,P]=n.useState(null),k=n.useRef({version:1,byLibrary:{}}),T=n.useRef(!1),I=n.useRef(!1),de=n.useRef(null),xe=n.useMemo(()=>w.find(u=>u.libraryId===p)??null,[w,p]),he=n.useMemo(()=>S.find(u=>u.collectionId===U)??null,[S,U]),te=ba(b.pathname)==="/cogita/persons";n.useEffect(()=>{if(!p){ht([]),Ce("");return}let u=!1;return Zs({libraryId:p}).then(ie=>{if(u)return;const J=ie.filter(Ye=>(Ye.roleKind??"").trim().toLowerCase()==="person");ht(J);try{const Ye=window.localStorage.getItem(Vn),gt=(Ye?JSON.parse(Ye):{})[p]??"",At=gt&&J.some(Lt=>Lt.roleId===gt)?gt:"";Ce(At)}catch{Ce("")}}).catch(()=>{u||(ht([]),Ce(""))}),()=>{u=!0}},[p,ze]),n.useEffect(()=>{if(p)try{const u=window.localStorage.getItem(Vn),ie=u?JSON.parse(u):{};et?ie[p]=et:delete ie[p],window.localStorage.setItem(Vn,JSON.stringify(ie))}catch{}},[p,et]);const A=n.useMemo(()=>ce.find(u=>u.revisionId===pe)??null,[ce,pe]),Y=n.useMemo(()=>({detail:c.revisions.detail,graph:c.revisions.graph,settings:c.revisions.settings,run:c.revisions.run,shared:c.targets.sharedRevisions,new:c.revisionForm.createAction}),[c.revisions.detail,c.revisions.graph,c.revisions.run,c.revisions.settings,c.targets.sharedRevisions,c.revisionForm.createAction]),re=n.useMemo(()=>N==="new_card"?"all_cards":N==="new_collection"?"all_collections":N==="new_storyboard"?"storyboards":N==="new_text"?"texts":N,[N]),G=n.useMemo(()=>X==="new"?"settings":X,[X]),Z=N==="all_collections"||N==="all_revisions",Ae=n.useMemo(()=>N==="new_collection"?"create":N==="all_collections"&&U?"selected":"search",[U,N]),ge=n.useMemo(()=>l.infoId?"selected":N==="new_card"?"create":"search",[l.infoId,N]),be=n.useMemo(()=>x.find(u=>u.infoId===l.infoId)??null,[x,l.infoId]),Ve=n.useMemo(()=>({library_overview:c.targets.libraryOverview,all_cards:c.targets.allCards,new_card:c.targets.newCard,all_collections:c.targets.allCollections,all_revisions:c.targets.allRevisions,new_collection:c.targets.newCollection,transfer:c.targets.transfer,storyboards:c.targets.storyboards,new_storyboard:c.targets.newStoryboard,texts:c.targets.texts,new_text:c.targets.newText,dependencies:c.targets.dependencies}),[c.targets]),nt=n.useMemo(()=>Ve[re]??re,[re,Ve]),He=Y[G],Xe=!!p,We=n.useMemo(()=>{const u=m==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":m==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return m==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:u},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:u},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:u},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:u},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:u},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:u},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:u},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:u},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:u},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:u},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:u},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:u},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:u},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:m==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:u},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:u},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:u},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:u},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:u},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:u},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:u},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:u},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:u},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:u},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:u},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:u},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:u},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:u},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:u},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:u},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:u},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:u},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:u},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:u},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:u},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:u},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:u},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:u},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:u},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:u},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[m]),De=We.length,it=Math.max(0,Math.min($e,De-1)),Ze=We[it],xt=!!U,Ft=Xe&&N==="all_collections",Mt=xt&&N==="all_collections",Tt=Xe&&(N==="all_revisions"||xt&&N==="all_collections")&&(G==="settings"||G==="run"||G==="shared"||N==="all_revisions"),sa=Tt,It=Tt&&!!pe,ut=n.useCallback(u=>{const ie=!!u.libraryId;let J=u.target,Ye=u.collectionId,dt=u.revisionId,gt=u.revisionView,At=u.infoId,Lt=u.infoView??l.infoView??"overview",Nt=u.collectionView??l.collectionView??"infos";ie?On[J].requiresCollection&&!Ye?(J=J==="all_revisions"?"all_revisions":"all_collections",dt=void 0,gt="detail"):J!=="all_collections"&&J!=="all_revisions"?(Ye=void 0,dt=void 0,J!=="new_card"&&J!=="all_cards"&&(At=void 0,Lt="overview"),J!=="new_collection"&&(Nt="infos")):On[J].allowsRevision?po.includes(gt)||(dt=void 0):gt="detail":(J="library_overview",Ye=void 0,dt=void 0,gt="detail",At=void 0,Lt="overview",Nt="infos"),W(u.libraryId),ee(J),R(Ye),F(dt),Me(gt),z(!1);const $t=ba(Bs(u.libraryId,J,Ye,gt,dt,At,Lt,Nt));ba(`${b.pathname}${b.search}`)!==$t&&(de.current=$t,d($t))},[b.pathname,b.search,d,l.collectionView,l.infoView]),St=n.useMemo(()=>[{key:"library",label:c.layers.library,visible:!0,value:p??"",selectedLabel:(xe==null?void 0:xe.name)??c.path.noLibrarySelected,disabled:H||w.length===0,options:w.map(u=>({value:u.libraryId,label:u.name})),emptyOption:c.noLibraryOption,onSelect:u=>{const ie=u||void 0;ut({libraryId:ie,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:c.layers.target,visible:Xe,value:re,selectedLabel:nt,disabled:!Xe,options:gr.map(u=>({value:u,label:Ve[u]})),onSelect:u=>{const ie=u;ut({libraryId:p,target:ie,collectionId:U,revisionId:pe,revisionView:X,infoId:ie==="new_card"?l.infoId:void 0})}},{key:"info_mode",label:c.layers.target,visible:re==="all_cards",value:ge,selectedLabel:ge==="create"?c.infoMode.create:ge==="selected"?(be==null?void 0:be.label)??Q??t.cogita.library.list.selectedEmpty:c.infoMode.search,disabled:!Xe,options:[{value:"search",label:c.infoMode.search},{value:"create",label:c.infoMode.create},...l.infoId?[{value:"selected",label:(be==null?void 0:be.label)??Q??t.cogita.library.list.selectedEmpty}]:[]],onSelect:u=>{if(u==="selected"){if(!l.infoId)return;ut({libraryId:p,target:"all_cards",collectionId:U,revisionId:pe,revisionView:X,infoId:l.infoId,infoView:"overview"});return}if(u==="create"){ut({libraryId:p,target:"new_card",collectionId:U,revisionId:pe,revisionView:X,infoId:void 0});return}ut({libraryId:p,target:"all_cards",collectionId:U,revisionId:pe,revisionView:X,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:c.layers.target,visible:re==="all_cards"&&!!l.infoId,value:N==="new_card"&&l.infoId?"edit":l.infoView==="cards"?"cards":l.infoView==="collections"?"collections":"overview",selectedLabel:N==="new_card"&&l.infoId?c.infoActions.edit:l.infoView==="cards"?c.infoActions.seeCards:l.infoView==="collections"?"Kolekcje":c.infoActions.overview,disabled:!Xe||!l.infoId,options:[{value:"overview",label:c.infoActions.overview},{value:"edit",label:c.infoActions.edit},{value:"cards",label:c.infoActions.seeCards},{value:"collections",label:"Kolekcje"}],onSelect:u=>{if(l.infoId){if(u==="edit"){ut({libraryId:p,target:"new_card",collectionId:U,revisionId:pe,revisionView:X,infoId:l.infoId});return}if(u==="cards"){ut({libraryId:p,target:"all_cards",collectionId:U,revisionId:pe,revisionView:X,infoId:l.infoId,infoView:"cards"});return}ut({libraryId:p,target:"all_cards",collectionId:U,revisionId:pe,revisionView:X,infoId:l.infoId,infoView:"overview"})}}},{key:"collection_mode",label:c.layers.collection,visible:Xe&&(N==="all_collections"||N==="new_collection"),value:Ae,selectedLabel:Ae==="create"?t.cogita.library.actions.createCollection:Ae==="selected"?(he==null?void 0:he.name)??c.path.noCollectionSelected:t.cogita.library.actions.collections,disabled:!Xe,options:[{value:"search",label:t.cogita.library.actions.collections},{value:"create",label:t.cogita.library.actions.createCollection},...U&&he?[{value:"selected",label:he.name}]:[]],onSelect:u=>{if(u==="create"){ut({libraryId:p,target:"new_collection",collectionId:void 0,revisionId:void 0,revisionView:"detail"});return}if(u==="selected"&&U){const ie=Z?N:"all_collections";ut({libraryId:p,target:ie,collectionId:U,revisionId:pe,revisionView:ie==="all_revisions"?"settings":"detail"});return}if(u==="collections"){ut({libraryId:p,target:"all_cards",collectionId:U,revisionId:pe,revisionView:X,infoId:l.infoId,infoView:"collections"});return}ut({libraryId:p,target:Z?N:"all_collections",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection",label:c.layers.collection,visible:Ft&&Ae!=="create",value:U??"",selectedLabel:(he==null?void 0:he.name)??c.path.noCollectionSelected,disabled:!Xe||me||S.length===0,options:S.map(u=>({value:u.collectionId,label:u.name})),emptyOption:c.selectCollectionOption,onSelect:u=>{const ie=u||void 0,J=Z?N:"all_collections";ut({libraryId:p,target:J,collectionId:ie,revisionId:void 0,revisionView:J==="all_revisions"?"settings":"detail"})}},{key:"collection_selected_action",label:c.layers.revision,visible:Mt,value:N==="all_revisions"?"revisions":G==="graph"?"edit":G==="settings"||G==="run"||G==="shared"?"revisions":(l.collectionView??"infos")==="overview"?"overview":"infos",selectedLabel:N==="all_revisions"?c.targets.allRevisions:G==="graph"?"Edytuj":G==="settings"||G==="run"||G==="shared"?c.targets.allRevisions:(l.collectionView??"infos")==="overview"?"Przegląd":"Informacje",disabled:!U,options:[{value:"overview",label:"Przegląd"},{value:"edit",label:"Edytuj"},{value:"infos",label:"Informacje"},{value:"revisions",label:c.targets.allRevisions}],onSelect:u=>{if(U){if(u==="edit"){ut({libraryId:p,target:Z?N:"all_collections",collectionId:U,revisionId:void 0,revisionView:"graph"});return}if(u==="revisions"){ut({libraryId:p,target:Z?N:"all_collections",collectionId:U,revisionId:pe,revisionView:"settings"});return}ut({libraryId:p,target:Z?N:"all_collections",collectionId:U,revisionId:void 0,revisionView:"detail",infoId:l.infoId,infoView:l.infoView,collectionView:u==="overview"?"overview":"infos"})}}},{key:"revision_mode",label:c.layers.revision,visible:sa,value:X==="new"?"create":!pe&&G==="shared"?"shared":"search",selectedLabel:X==="new"?c.revisionForm.createAction:!pe&&G==="shared"?c.targets.sharedRevisions:c.infoActions.search,disabled:N==="all_revisions"?!Xe:!xt,options:[{value:"search",label:c.infoActions.search},{value:"create",label:c.revisionForm.createAction},{value:"shared",label:c.targets.sharedRevisions}],onSelect:u=>{ut({libraryId:p,target:Z?N:"all_revisions",collectionId:N==="all_revisions"?void 0:U,revisionId:void 0,revisionView:u==="create"?"new":u==="shared"?"shared":"settings"})}},{key:"revision_entry",label:c.layers.revision,visible:sa,value:pe??"",selectedLabel:(A==null?void 0:A.name)??c.status.noRevisions,disabled:(N==="all_revisions"?!Xe:!xt)||ae||ce.length===0,options:ce.map(u=>({value:u.revisionId,label:u.name})),emptyOption:c.status.noRevisions,onSelect:u=>{ut({libraryId:p,target:Z?N:"all_collections",collectionId:U,revisionId:u||void 0,revisionView:G==="settings"||G==="run"||G==="shared"?G:"settings"})}},{key:"revision_selected_action",label:c.layers.revision,visible:It,value:G==="run"?"run":G==="shared"?"shared":"settings",selectedLabel:G==="run"?c.revisions.run:G==="shared"?c.targets.sharedRevisions:c.infoActions.edit,disabled:!pe,options:[{value:"settings",label:c.infoActions.edit},{value:"run",label:c.revisions.run},{value:"shared",label:c.targets.sharedRevisions}],onSelect:u=>{pe&&ut({libraryId:p,target:Z?N:"all_collections",collectionId:U,revisionId:pe,revisionView:u==="run"?"run":u==="shared"?"shared":"settings"})}}],[S,me,ge,x,w,H,ut,ce,ae,he,U,be,A,pe,Q,xt,Xe,xe,Z,p,He,X,N,G,re,nt,Ft,Mt,sa,It,Ve,t.cogita.library.list.selectedEmpty,l.infoId,l.infoView,l.collectionView,c.infoActions.edit,c.infoActions.overview,c.infoActions.seeCards,c.layers.collection,c.layers.library,c.layers.revision,c.layers.target,c.noLibraryOption,c.path.noCollectionSelected,c.path.noLibrarySelected,c.selectCollectionOption,c.targets.allRevisions,c.infoActions.search,c.revisionForm.createAction,c.revisions.run,c.targets.sharedRevisions,Ae]),kt=n.useMemo(()=>St.filter(u=>u.visible),[St]),wt=n.useMemo(()=>kt.filter(u=>u.key!=="library"&&u.key!=="collection"),[kt]),_t=n.useMemo(()=>wt.find(u=>u.key==="target")??null,[wt]),lt=n.useMemo(()=>wt.find(u=>u.key==="info_mode")??null,[wt]),Je=n.useMemo(()=>wt.find(u=>u.key==="info_selected_action")??null,[wt]),vt=n.useMemo(()=>wt.find(u=>u.key==="collection_mode")??null,[wt]),Qt=n.useMemo(()=>wt.find(u=>u.key==="revision_mode")??null,[wt]),Ot=n.useMemo(()=>wt.find(u=>u.key==="collection_selected_action")??null,[wt]),zt=n.useMemo(()=>wt.find(u=>u.key==="revision_entry")??null,[wt]),fe=n.useMemo(()=>wt.find(u=>u.key==="revision_selected_action")??null,[wt]),Rt=n.useCallback((u,ie)=>u?e.jsx("div",{className:"cogita-sidebar-actions",children:u.options.map(J=>e.jsx("button",{type:"button",className:`ghost ${String(u.value)===J.value?"active":""}`,onClick:()=>u.onSelect(J.value),disabled:u.disabled,title:J.label,children:fa(J.label,Aa)},`${ie}:${u.key}:${J.value}`))}):null,[]),Xt=n.useMemo(()=>{const u=l.libraryId;if(!u||!b.pathname.startsWith("/cogita/library/"))return null;const ie={copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,libraryId:u};if(l.target==="library_overview")return e.jsx(ai,{...ie});if(l.target==="all_cards")return l.infoId&&l.infoView==="cards"?e.jsx(Ri,{...ie,infoId:l.infoId,selectedReviewerRoleId:et||null}):e.jsx(mi,{...ie,mode:l.cardMode??"list"});if(l.target==="new_card")return e.jsx(Ni,{...ie,editInfoId:l.infoId});if(l.target==="dependencies")return e.jsx(Ti,{...ie});if(l.target==="transfer")return e.jsx(_i,{...ie});if(l.target==="storyboards"||l.target==="new_storyboard")return e.jsx(Di,{...ie});if(l.target==="texts"||l.target==="new_text")return e.jsx(Bi,{...ie});if(l.target==="all_collections"||l.target==="all_revisions"){if(l.target==="all_revisions"&&!l.collectionId)return l.revisionView==="run"?e.jsx(Dn,{...ie,revisionId:l.revisionId}):e.jsx(_s,{...ie,revisionId:l.revisionId});if(!l.collectionId&&l.revisionView==="run")return e.jsx(Dn,{...ie,revisionId:l.revisionId});if(l.collectionId){const J={...ie,collectionId:l.collectionId};return l.revisionView==="graph"?e.jsx(mo,{...J}):l.revisionView==="shared"?e.jsx(Fi,{...ie,collectionId:l.collectionId}):l.revisionView==="settings"?e.jsx(_s,{...J,revisionId:l.revisionId}):l.revisionView==="run"?e.jsx(Dn,{...J,revisionId:l.revisionId}):e.jsx(Vi,{...J})}return e.jsx(zi,{...ie})}return l.target==="new_collection"?e.jsx(Ji,{...ie,onCreated:J=>{ut({libraryId:u,target:N==="all_revisions"?"all_revisions":"all_collections",collectionId:J,revisionId:void 0,revisionView:"graph"})}}):null},[a,ut,t,m,b.pathname,d,v,o,j,s,i,l.cardMode,l.collectionId,l.infoId,l.libraryId,l.revisionId,l.revisionView,l.target,h,r,N,et]);n.useEffect(()=>{let u=!1;return(async()=>{var J,Ye,dt,gt,At;V(!0);try{await Er();const[Lt,Nt,$t]=await Promise.all([Js(),Qs(),Kr()]);if(u)return;g(Lt);const ha=new Set($t.nodes.filter(ft=>ft.nodeType==="role"&&ft.canLink).map(ft=>ft.roleId??"")),ma=yo(Nt,ha);if(M(ma),ma){const ft=$t.nodes.find(Dt=>Dt.nodeType==="data"&&Dt.roleId===ma&&(Dt.fieldType===zn||Dt.label===zn));P((ft==null?void 0:ft.dataKeyId)??null),k.current=xo(ft==null?void 0:ft.value)}const Kt=(J=Lt.find(ft=>ft.libraryId===l.libraryId))==null?void 0:J.libraryId,aa=Kt?(dt=(Ye=k.current.byLibrary)==null?void 0:Ye[Kt])==null?void 0:dt.lastTarget:void 0,Ta=bo(aa)?aa:"library_overview";W(Kt),ee(l.target??Ta),F(l.revisionId??(Kt?(At=(gt=k.current.byLibrary)==null?void 0:gt[Kt])==null?void 0:At.lastRevisionId:void 0)),Me(l.revisionView??"detail"),T.current=!0}catch{u||Ee(c.status.loadFailed)}finally{u||V(!1)}})(),()=>{u=!0}},[c.status.loadFailed]),n.useLayoutEffect(()=>{if(T.current){if(!l.libraryId){W(void 0),ee(l.target??"library_overview"),R(void 0),F(void 0),Me("detail");return}l.libraryId&&w.some(u=>u.libraryId===l.libraryId)&&W(l.libraryId),l.target&&ee(l.target),R(l.collectionId),F(l.revisionId),l.revisionView&&Me(l.revisionView)}},[w,l.collectionId,l.libraryId,l.revisionId,l.revisionView,l.target]),n.useEffect(()=>{if(!p){K([]),R(void 0),y([]),B([]),F(void 0);return}let u=!1;return ne(!0),Oa({libraryId:p,limit:200}).then(ie=>{var dt;if(u)return;const J=ie.items;K(J);const Ye=(dt=J.find(gt=>gt.collectionId===l.collectionId))==null?void 0:dt.collectionId;R(Ye)}).catch(()=>{u||(K([]),R(void 0))}).finally(()=>{u||ne(!1)}),()=>{u=!0}},[l.collectionId,p]),n.useEffect(()=>{if(!p||re!=="all_cards"&&N!=="new_card"){y([]);return}let u=!1;return Xn({libraryId:p,limit:200}).then(ie=>{u||y(ie)}).catch(()=>{u||y([])}),()=>{u=!0}},[re,p,N]),n.useEffect(()=>{if(!p||N!=="all_revisions"&&!U){B([]),N!=="all_revisions"&&F(void 0);return}let u=!1;return ke(!0),Gn({libraryId:p,collectionId:N==="all_revisions"?void 0:U}).then(ie=>{var dt,gt,At,Lt;if(u)return;B(ie);const J=(gt=(dt=k.current.byLibrary)==null?void 0:dt[p])==null?void 0:gt.lastRevisionId,Ye=((At=ie.find(Nt=>Nt.revisionId===l.revisionId))==null?void 0:At.revisionId)??((Lt=ie.find(Nt=>Nt.revisionId===J))==null?void 0:Lt.revisionId);F(Ye)}).catch(()=>{u||(B([]),F(void 0))}).finally(()=>{u||ke(!1)}),()=>{u=!0}},[l.revisionId,U,p,N]),n.useEffect(()=>{const u=l.infoId;if(!p||!u){L(void 0);return}let ie=!1;return ta({libraryId:p,infoId:u}).then(J=>{if(ie)return;const Ye=J.payload??{},dt=Ye.definition&&typeof Ye.definition=="object"?Ye.definition:null,gt=typeof(dt==null?void 0:dt.title)=="string"?dt.title:void 0,At=typeof(dt==null?void 0:dt.question)=="string"?dt.question:void 0,Lt=typeof Ye.label=="string"?Ye.label:void 0,Nt=typeof Ye.name=="string"?Ye.name:void 0,$t=typeof Ye.title=="string"?Ye.title:void 0;L(gt??At??Lt??Nt??$t??J.infoId)}).catch(()=>{ie||L(u)}),()=>{ie=!0}},[l.infoId,p]),n.useEffect(()=>{if(!T.current||l.libraryId&&w.some(dt=>dt.libraryId===l.libraryId)&&l.libraryId!==p||l.target&&l.target!==N||l.revisionView&&l.revisionView!==X||l.revisionId&&l.revisionId!==pe||On[N].requiresCollection&&!U&&(l.target==="all_collections"||l.target==="all_revisions")&&l.collectionId)return;const u=ba(`${b.pathname}${b.search}`);if(ba(b.pathname)==="/cogita"&&!l.libraryId&&!p){de.current=null;return}if(ba(b.pathname)==="/cogita/persons"){de.current=null;return}if(ba(b.pathname)===`/cogita/library/${p}/revision/run`&&l.revisionView==="run"&&!l.collectionId&&(N==="all_collections"||N==="all_revisions")&&X==="run"&&!U){de.current=null;return}const Ye=ba(Bs(p,N,U,X,pe,l.infoId,l.infoView??"overview",l.collectionView??"infos"));if(u===Ye){de.current=null;return}de.current!==Ye&&(de.current=Ye,d(Ye,{replace:!0}))},[w,b.pathname,b.search,d,l.collectionId,l.infoId,l.infoView,l.collectionView,l.libraryId,l.revisionId,l.revisionView,l.target,U,p,pe,X,N]),n.useEffect(()=>{if(typeof window>"u")return;const u=()=>{window.innerWidth>920&&z(!1)};return window.addEventListener("resize",u),()=>window.removeEventListener("resize",u)},[]),n.useEffect(()=>{if(!T.current||!E||!p||I.current)return;const u=k.current,ie={...u.byLibrary??{}},J={...ie[p]??{},lastCollectionId:U,lastRevisionId:pe,lastRevisionView:X,lastTarget:N},Ye={version:1,lastLibraryId:p,byLibrary:{...ie,[p]:J}},dt=JSON.stringify(u),gt=JSON.stringify(Ye);if(dt===gt)return;k.current=Ye,I.current=!0,(async()=>{try{if(D)await Fr(D,{plainValue:gt});else{const Lt=await _r(E,{itemName:zn,itemType:"data",plainValue:gt});P(Lt.dataItemId)}}catch{Ee(c.status.savePrefsFailed)}finally{I.current=!1}})()},[D,E,U,p,pe,X,N,c.status.savePrefsFailed]);const qt=async()=>{const u=mt.trim();if(!u){Ee(t.cogita.user.libraryNameRequired);return}Ee(null);try{const ie=await Br({name:u});g(J=>[ie,...J]),W(ie.libraryId),ee("library_overview"),R(void 0),Te("")}catch{Ee(t.cogita.user.libraryCreateFailed)}},O=async()=>{if(!p||!U){Ee(c.status.selectLibraryFirst);return}const u=Oe.trim();if(!u){Ee(c.revisionForm.nameLabel);return}Ee(null);try{const ie=await Dr({libraryId:p,collectionId:U,name:u,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});B(J=>[ie,...J]),F(ie.revisionId),ee(N==="all_revisions"?"all_revisions":"all_collections"),Me("settings"),Be("")}catch{Ee(c.status.loadFailed)}};return e.jsx(Et,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,headerExtra:e.jsxs("div",{className:"cogita-header-reviewer-actions",children:[e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:et,disabled:!p,onChange:u=>{const ie=u.target.value;if(ie==="__new_person__"){d("/cogita/persons");return}Ce(ie)},children:[e.jsx("option",{value:"",children:p?"No person":"Select library first"}),rt.map(u=>e.jsx("option",{value:u.roleId,children:u.label},u.roleId)),e.jsx("option",{value:"__new_person__",children:"+ Create new person"})]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>d("/cogita/persons"),children:"Persons"})]}),children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${$?"open":""}`,"aria-label":c.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{title:(xe==null?void 0:xe.name)??c.path.noLibrarySelected,children:fa((xe==null?void 0:xe.name)??c.path.noLibrarySelected,Aa)}),e.jsx("p",{className:"cogita-sidebar-note",children:xe?c.sidebar.libraryActionsHint:c.status.selectLibraryFirst}),Rt(_t,"sidebar"),N==="all_revisions"&&zt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.targets.allRevisions}),Rt(Qt,"sidebar"),Rt(zt,"sidebar"),fe?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(A==null?void 0:A.name)??c.status.noRevisions,children:fa((A==null?void 0:A.name)??c.status.noRevisions,Aa)}),Rt(fe,"sidebar")]}):null]}):null,lt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.sidebar.infoActionsHint}),Rt(lt,"sidebar"),Je?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(be==null?void 0:be.label)??Q??t.cogita.library.list.selectedEmpty,children:fa((be==null?void 0:be.label)??Q??t.cogita.library.list.selectedEmpty,Aa)}),e.jsx("p",{className:"cogita-sidebar-note",children:c.sidebar.selectedInfoActionsHint}),Rt(Je,"sidebar")]}):null]}):null,vt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.sidebar.collectionActionsHint}),Rt(vt,"sidebar"),he&&Ot?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:he.name,children:fa(he.name,Aa)}),Rt(Ot,"sidebar"),N!=="all_revisions"&&zt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.targets.allRevisions}),Rt(Qt,"sidebar"),Rt(zt,"sidebar"),fe?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(A==null?void 0:A.name)??c.status.noRevisions,children:fa((A==null?void 0:A.name)??c.status.noRevisions,Aa)}),Rt(fe,"sidebar")]}):null]}):null]}):null]}):null]}),e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:c.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:s,children:c.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{j("cogita"),z(!1)},children:c.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:i,children:h?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),$?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":c.sidebar.closeMenu,onClick:()=>z(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":c.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>z(u=>!u),"aria-label":$?c.sidebar.closeMenu:c.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),kt.map((u,ie)=>e.jsxs("div",{className:"cogita-browser-segment",children:[ie>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,u.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":u.label,title:u.selectedLabel,children:fa(u.selectedLabel,Ds)}):e.jsxs("select",{"aria-label":u.label,value:u.value,onChange:J=>u.onSelect(J.target.value),disabled:u.disabled,children:[u.emptyOption?e.jsx("option",{value:"",children:u.emptyOption}):null,u.options.map(J=>e.jsx("option",{value:J.value,title:J.label,children:fa(J.label,Ds)},`${u.key}:${J.value}`))]})]},`menu:${u.key}`))]}),Xt?e.jsxs(e.Fragment,{children:[(N==="all_collections"||N==="all_revisions")&&X==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:c.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsxs("select",{value:U??"",onChange:u=>R(u.target.value||void 0),children:[e.jsx("option",{value:"",children:c.selectCollectionOption}),S.map(u=>e.jsx("option",{value:u.collectionId,children:u.name},u.collectionId))]})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:c.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Oe,onChange:u=>Be(u.target.value),placeholder:c.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:O,children:c.revisionForm.createAction}),Le?e.jsx("p",{className:"cogita-form-error",children:Le}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(er.Provider,{value:!0,children:Xt})})]}):null,Xt?null:e.jsxs(e.Fragment,{children:[te?e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Ki,{copy:t,onPersonCreated:u=>{tt(ie=>ie+1)}})}):null,!p&&!te?e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:Ze.step}),e.jsx("h2",{children:Ze.title})]}),e.jsxs("p",{children:[it+1," / ",De]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:Ze.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:Ze.passages.map(u=>e.jsx("p",{children:u},u))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:Ze.focus.map(u=>e.jsx("span",{children:u},u))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:Ze.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:We.map((u,ie)=>e.jsx("button",{type:"button",className:`ghost ${ie===it?"active":""}`,onClick:()=>st(ie),"aria-label":`${ie+1}`,children:ie+1},`tutorial:${u.title}:${ie}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:it===0,onClick:()=>st(u=>Math.max(0,u-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:it===De-1,onClick:()=>st(u=>Math.min(De-1,u+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:mt,onChange:u=>Te(u.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:qt,children:t.cogita.user.createLibraryAction}),Le?e.jsx("p",{className:"cogita-form-error",children:Le}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),w.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,w.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:w.map(u=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{ut({libraryId:u.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:u.name})]},u.libraryId))}):null]})]})]}):null]})]})]})})}const Ro=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:vo},Symbol.toStringTag,{value:"Module"}));function wo({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,shareId:d}){const[b,l]=n.useState(null),[c,w]=n.useState("loading"),[g,S]=n.useState(t.cogita.library.collections.defaultName),[K,x]=n.useState("Cogita Library"),[y,ce]=n.useState([]),[B,p]=n.useState([]),[W,N]=n.useState("idle"),[ee,U]=n.useState({current:0,total:0}),[R,pe]=n.useState(0),[F,X]=n.useState(""),[Me,Q]=n.useState(null),[L,$]=n.useState(null),[z,H]=n.useState(null),[V,me]=n.useState(null),[ne,ae]=n.useState([]),[ke,Le]=n.useState({}),[Ee,$e]=n.useState({}),[st,mt]=n.useState(null),[Te,Ge]=n.useState(null),[jt,Oe]=n.useState(null),[Be,rt]=n.useState(null),[ht,et]=n.useState({}),Ce=n.useRef(0),[ze,tt]=n.useState(null),E=n.useRef(null),M=n.useRef(null),[D,P]=n.useState(null),[k,T]=n.useState(!1),[I,de]=n.useState(null),[xe,he]=n.useState([]),[te,A]=n.useState(null),Y=n.useRef(null),re=n.useRef(null),[G,Z]=n.useState(null),[Ae,ge]=n.useState(0),be=n.useRef(null),Ve=n.useRef({}),[nt,He]=n.useState(!1),[Xe,We]=n.useState({}),De=n.useRef(null),it=n.useRef(new Set),Ze=n.useRef({}),[xt,Ft]=n.useState([]),[Mt,Tt]=n.useState(new Set),[sa,It]=n.useState(!1),ut=Ja(),St=n.useMemo(()=>new URLSearchParams(ut.search),[ut.search]),kt=n.useMemo(()=>St.get("key")??"",[St]),wt=(b==null?void 0:b.mode)??"random",_t=(b==null?void 0:b.check)??"exact",lt=(b==null?void 0:b.limit)??20,Je=n.useMemo(()=>rs((b==null?void 0:b.revisionType)??wt),[b,wt]),vt=n.useMemo(()=>{const _=b==null?void 0:b.revisionSettings,le=ir(Je,St);return jn(Je,_??le)},[b,St,Je]),Qt=n.useMemo(()=>t.cogita.library.revision[Je.labelKey]??wt,[t,wt,Je]),Ot=n.useMemo(()=>_t==="exact"?t.cogita.library.revision.checkValue:_t,[t,_t]),fe=c==="ready"?y[R]??null:null,Rt=(fe==null?void 0:fe.checkType)==="translation-match"&&Be,Xt=n.useRef(new Map),qt=n.useRef(new Map),O=n.useRef(new Map),u=n.useRef(new Map),ie=n.useMemo(()=>fe?fe.cardType==="vocab"?t.cogita.library.revision.vocabLabel:fe.infoType?ot(t,fe.infoType):t.cogita.library.revision.infoLabel:"",[t,fe]),J=n.useMemo(()=>{var le;return Je.id!=="levels"?y.length:((le=Xe.pool)==null?void 0:le.length)??Je.getFetchLimit(lt,vt)},[Xe,vt,Je,y.length,lt]),Ye=Je.getProgressTotal?Je.getProgressTotal(y,Xe,lt,vt):Je.id==="levels"?Math.min(lt,J):y.length,dt=Ye?Math.min(R+1,Ye):0,gt=Math.max(1,Number(vt.tries??1)),At=vt.compare??"anchors",Lt=Math.max(0,Math.min(100,Number(vt.minCorrectness??0))),Nt=(vt.considerDependencies??"on")==="on",$t=Math.max(0,Math.min(100,Number(vt.dependencyThreshold??85))),ha=_=>{const le=_.slice();for(let we=le.length-1;we>0;we-=1){const Ke=Math.floor(Math.random()*(we+1));[le[we],le[Ke]]=[le[Ke],le[we]]}return le},ma=_=>xa(_,{treatSimilarCharsAsSame:!0})>=Lt,Kt=async()=>{const _=await da(),le=new Map,we=new Map;_.forEach(je=>{const Pe=`${je.itemType}:${je.itemId}`,Ie=ea(je.itemType,je.itemId,je.checkType,je.direction);le.has(Pe)||le.set(Pe,[]),le.get(Pe).push(je),we.has(Ie)||we.set(Ie,[]),we.get(Ie).push(je)});const Ke=new Map,Fe=new Map;return le.forEach((je,Pe)=>Ke.set(Pe,ca(je).score)),we.forEach((je,Pe)=>Fe.set(Pe,ca(je).score)),{itemKnowness:Ke,cardKnowness:Fe}},aa=async _=>{const le=Xe,we=_.concat(le.active??[]).concat(le.pool??[]).filter((f,C,q)=>q.findIndex(ue=>Se(ue)===Se(f))===C);if(!Nt){Tt(new Set(we.map(Se)));return}const{itemKnowness:Ke,cardKnowness:Fe}=await Kt(),je=f=>{if(f.cardType!=="info"||f.infoType!=="citation"||f.checkType!=="quote-fragment")return!0;const C=Wt(f.direction);if(!(C!=null&&C.fragmentId))return!0;const q=f.description??"";if(!q.trim())return!0;const ye=va(q).nodes[C.fragmentId];if(!ye||!ye.leftId&&!ye.rightId)return!0;const oe=[ye.leftId,ye.rightId].filter(Ne=>!!Ne);if(oe.length===0)return!0;const ve=oe.map(Ne=>{const _e=ea("info",f.cardId,"quote-fragment",Ne);return Fe.get(_e)??0});return ve.reduce((Ne,_e)=>Ne+_e,0)/ve.length>=$t},Pe=(b==null?void 0:b.collectionId)??null,Ie=Pe?xt.filter(f=>Ct(f.childItemType)==="collection"&&f.childItemId===Pe&&!Ct(f.childCheckType)&&!Ct(f.childDirection)):[],Re=Pe&&we.length>0?we.reduce((f,C)=>f+(Fe.get(Se(C))??0),0)/we.length:0,Qe=new Set;for(const f of we){if(f.cardType!=="info"){Qe.add(Se(f));continue}if(!je(f))continue;const C=xt.filter(ye=>hr(ye,f)).concat(Ie);if(C.length===0){Qe.add(Se(f));continue}let q=0;for(const ye of C)if(Ct(ye.parentItemType)==="collection")q+=ye.parentItemId===Pe?Re:0;else if(Ct(ye.parentCheckType)||Ct(ye.parentDirection)){const oe=Ct(ye.parentCheckType),ve=Ct(ye.parentDirection),se=ea(ye.parentItemType,ye.parentItemId,oe,ve);q+=Fe.get(se)??0}else{const oe=`${ye.parentItemType}:${ye.parentItemId}`;q+=Ke.get(oe)??0}q/C.length>=$t&&Qe.add(Se(f))}Tt(Qe)},Ta=_=>{for(let le=_;le<y.length;le+=1){const we=y[le];if(we&&(!Nt||we.cardType!=="info"||Mt.has(Se(we))))return le}return-1},ft=_=>!Nt||_.cardType!=="info"||Mt.has(Se(_)),Dt=_=>{if(Je.id!=="temporal"&&Je.id!=="levels")return null;const le=Xe,we=(le.active??[]).concat(le.pool??[]),Ke=new Set;for(const Fe of we){const je=Se(Fe);if(!(Ke.has(je)||_.has(je))&&(Ke.add(je),ft(Fe)))return Fe}return null},Zt=n.useMemo(()=>{if(Je.id!=="levels")return null;const _=Xe,le=_.pool??[],we=_.active??[],Ke=_.levelMap??{},Fe=Math.max(1,Number(vt.levels??1)),je=Array.from({length:Fe},()=>0),Pe=new Set(we.map(f=>Se(f)));le.forEach(f=>{const C=Math.min(Fe,Math.max(1,Ke[Se(f)]??1));je[C-1]+=1});const Ie=le.length||1,Re=je.map(f=>f/Ie*100),Qe=fe?Ke[Se(fe)]??1:null;return{counts:je,percentages:Re,currentLevel:Qe,levelsCount:Fe,activeCount:we.length,poolCount:le.length,activeSet:Pe}},[Xe,vt,Je,fe]),wa=n.useMemo(()=>{if(Je.id!=="temporal")return null;const _=Xe,le=_.pool??[],we=_.active??[],Ke=_.knownessMap??{},Fe=new Set(_.unknownSet??[]);let je=0;le.forEach(Re=>{(Ke[Se(Re)]??0)>1&&(je+=1)});const Pe=Fe.size,Ie=we.map(Re=>({id:Se(Re),value:Fe.has(Se(Re))?0:Math.max(0,Math.min(1,Ke[Se(Re)]??0))}));return{knownCount:je,unknownCount:Pe,dots:Ie}},[Xe,Je]),Wa=n.useMemo(()=>{if(!Nt)return 0;const _=Xe;return y.concat(_.active??[]).concat(_.pool??[]).filter((we,Ke,Fe)=>Fe.findIndex(je=>Se(je)===Se(we))===Ke).filter(we=>we.cardType==="info"&&!Mt.has(Se(we))).length},[Nt,Xe,y,Mt]);n.useEffect(()=>{if(!Nt||W!=="ready")return;const _=Xe,we=y.concat(_.active??[]).concat(_.pool??[]).filter((je,Pe,Ie)=>Ie.findIndex(Re=>Se(Re)===Se(je))===Pe).filter(je=>je.cardType!=="info"||Mt.has(Se(je))).length,Ke=Y.current;if(Y.current=we,Ke===null||we<=Ke)return;const Fe=we-Ke;A(`New card available (+${Fe})`),re.current&&window.clearTimeout(re.current),re.current=window.setTimeout(()=>A(null),2200)},[Nt,W,Xe,y,Mt]),n.useEffect(()=>()=>{re.current&&window.clearTimeout(re.current)},[]);const Gt=(_,le)=>{const we=Je.applyOutcome({queue:y,meta:Xe},fe,lt,vt,{correct:_,correctness:le,createdUtc:new Date().toISOString()});ce(we.queue),We(we.meta);const Ke=we.queue[R+1];Ke&&Vt(Ke,R+1)};n.useEffect(()=>{if(!d){w("error");return}w("loading"),zr({shareId:d,key:kt}).then(_=>{l(_),S(_.collectionName),x(_.libraryName),w("ready")}).catch(()=>{w("error")})},[d,kt]),n.useEffect(()=>{d&&Vr({shareId:d,key:kt,type:"language"}).then(_=>p(_)).catch(()=>p([]))},[d,kt]),n.useEffect(()=>{!d||c!=="ready"||Or({shareId:d,key:kt}).then(_=>Ft(_.items??[])).catch(()=>Ft([]))},[d,kt,c]),n.useEffect(()=>{if(!d||c!=="ready")return;let _=!0;return(async()=>{N("loading"),U({current:0,total:Je.id==="levels"?0:Je.getFetchLimit(lt,vt)});try{const we=[];let Ke=null,Fe=null;do{const C=await qr({shareId:d,key:kt,limit:300,cursor:Ke});if(we.push(...C.items),(Je.id==="levels"||Je.id==="temporal")&&C.total&&(Fe=C.total),U(q=>({current:we.length,total:q.total||C.total||Je.getFetchLimit(lt,vt)})),Ke=C.nextCursor??null,Fe!==null&&we.length>=Fe||Je.id!=="levels"&&Je.id!=="temporal"&&we.length>=Je.getFetchLimit(lt,vt))break}while(Ke);if(!_)return;const je=Va(we);let Pe;if(Je.id==="levels"){const C=Math.max(1,Number(vt.levels??1));Pe={},je.forEach(q=>{const ue=Se(q);Pe[ue]=Math.max(1,Math.min(C,1))})}let Ie=null,Re=null,Qe=null;if(Je.id==="temporal"){const C=await da(),q=new Set(je.map(oe=>Se(oe))),ue=C.reduce((oe,ve)=>{const se=ea(ve.itemType,ve.itemId,ve.checkType,ve.direction);return q.has(se)&&(oe[se]||(oe[se]=[]),oe[se].push(ve)),oe},{});Ie={},Re=new Set,Qe={};const ye=Date.now();je.forEach(oe=>{const ve=Se(oe),se=ue[ve]??[];if(se.length===0){Ie[ve]=0,Re.add(ve),Qe[ve]=[];return}const Ne=as(se);Qe[ve]=Ne;const _e=vn(Ne,ye);Ie[ve]=_e.knowness})}const f=Je.id==="levels"?ss(je,lt,vt,Pe):Je.id==="temporal"?ns(je,lt,vt,Ie??{},Re??new Set,Qe??{}):Je.prepare(je,lt,vt);ce(f.queue),We(f.meta),pe(0),N("ready"),U(C=>({current:Math.min(C.current,C.total),total:C.total}))}catch{_&&N("error")}})(),()=>{_=!1}},[d,kt,lt,Je,vt,c]),n.useEffect(()=>{aa(y)},[y,xt,Nt,$t,b==null?void 0:b.collectionId]),n.useEffect(()=>{if(!fe||!Nt){It(!1);return}if(fe.cardType!=="info"||Mt.has(Se(fe))){It(!1);return}const _=Ta(R+1);if(_>=0){It(!1),pe(_);return}if(Je.id==="temporal"||Je.id==="levels"){const le=y.slice(0,R+1),we=y.slice(R+1).filter(ft),Ke=le.concat(we),Fe=new Set(Ke.map(Se)),je=Dt(Fe);if(je){const Ie=Se(je);Fe.has(Ie)||(Ke.push(je),Fe.add(Ie),We(Re=>{const Qe=Re,f=new Set(Qe.queued??[]);return f.add(Ie),{...Qe,queued:f}}))}const Pe=Ke.findIndex((Ie,Re)=>Re!==R&&ft(Ie));if(Pe>=0){ce(Ke),pe(Pe),It(!1);return}}It(!0)},[fe,Mt,Nt,R,y,Xe,Je.id]),n.useEffect(()=>{if(X(""),Q(null),Z(null),ge(0),ae([]),Le({}),$e({}),mt(null),Ge(null),Oe(null),T(!1),He(!1),P(null),rt(null),et({}),!fe){$(null),H(null);return}fe.cardType==="info"&&fe.infoType==="computed"&&$(t.cogita.library.revision.loadingComputed);let _=!0;return Vt(fe,R).then(le=>{!_||!le||($(le.prompt),H(le.expectedAnswer),ae(le.computedExpected),Le(le.computedAnswers),mt(le.answerTemplate),Ge(le.outputVariables),Oe(le.variableValues))}),()=>{_=!1}},[fe,d,t]),n.useEffect(()=>{if(!fe||fe.cardType!=="info"||fe.infoType!=="citation"){De.current=null,it.current=new Set,me(null);return}const _=fe.description??"",le=(fe.label??"").trim(),we=le.replace(/\s+/g," ").trim(),Ke=_.replace(/\s+/g," ").trim(),Fe=we&&we!==Ke?le:t.cogita.library.infoTypes.citation;if(!_){me(null),H(null);return}const je=va(_);De.current=je,$(Fe);let Pe=!0;return da().then(Ie=>{if(!Pe)return;const Re=new Map;Ie.forEach(ue=>{if(ue.itemType!=="info"||ue.checkType!=="quote-fragment"||!ue.direction)return;const ye=Wt(ue.direction);if(!ye)return;const oe=`${ue.itemId}:${ye.fragmentId}`;Re.has(oe)||Re.set(oe,[]),Re.get(oe).push(ue)});const Qe={},f=new Set;Re.forEach((ue,ye)=>{const[oe,ve]=ye.split(":",2);if(oe!==fe.cardId)return;const se=ca(ue).score;Qe[ve]=se,se>=$t&&f.add(ve)}),it.current=f,Ze.current=Qe;const C=Wt(fe.direction);if(C!=null&&C.fragmentId&&je.nodes[C.fragmentId]){ra(je,C.fragmentId,Fe);return}const q=$a(je,f,Qe,$t,Nt,fe.direction);ra(je,(q==null?void 0:q.id)??null,Fe)}).catch(()=>{it.current=new Set,Ze.current={};const Ie=Wt(fe.direction);if(Ie!=null&&Ie.fragmentId&&je.nodes[Ie.fragmentId]){ra(je,Ie.fragmentId,Fe);return}const Re=$a(je,it.current,{},$t,Nt,fe.direction);ra(je,(Re==null?void 0:Re.id)??null,Fe)}),()=>{Pe=!1}},[fe,t,Nt,$t]),n.useEffect(()=>{if(!fe||fe.cardType!=="vocab"||fe.checkType!=="translation-match"){rt(null),et({});return}const we=(Xe.pool??Xe.active??y).filter(Ie=>Ie.cardType==="vocab"&&Ie.checkType==="translation-match").filter((Ie,Re,Qe)=>Qe.findIndex(f=>f.cardId===Ie.cardId)===Re);we.some(Ie=>Ie.cardId===fe.cardId)||we.unshift(fe);const Fe=ha(we).slice(0,6).map(Ie=>{const Re=Ie.label.split("↔").map(C=>C.trim()).filter(Boolean);if(Re.length<2)return null;const Qe=`${Ie.cardId}:L`,f=`${Ie.cardId}:R`;return{cardId:Ie.cardId,leftId:Qe,rightId:f,leftLabel:Re[0],rightLabel:Re[1]}}).filter(Boolean),je=Fe.map(Ie=>Ie.leftId),Pe=ha(Fe.map(Ie=>Ie.rightId));rt({pairs:Fe,leftOrder:je,rightOrder:Pe,selection:{},activeLeft:null,activeRight:null,locked:{}})},[fe,y,Xe]),n.useEffect(()=>()=>{E.current&&window.clearTimeout(E.current),M.current&&window.clearTimeout(M.current)},[]);const Ca=n.useRef(null);n.useEffect(()=>{if(!fe)return;const _=Se(fe),le=typeof document<"u"?document.activeElement:null;if(Ca.current===_&&le&&(le.tagName==="INPUT"||le.tagName==="TEXTAREA"))return;let we=0;const Ke=()=>{if(fe){if(fe.cardType==="info"&&fe.infoType==="computed"){if(ne.length>0){const je=hn(st,ne,Te),Pe=je?Ve.current[je]:null;if(Pe&&(Pe.focus(),document.activeElement===Pe)){Ca.current=_;return}}if(be.current&&(be.current.focus(),document.activeElement===be.current)){Ca.current=_;return}}else if(fe.cardType==="vocab"&&be.current&&(be.current.focus(),document.activeElement===be.current)){Ca.current=_;return}we<6&&(we+=1,window.setTimeout(Ke,40))}},Fe=window.setTimeout(Ke,40);return()=>window.clearTimeout(Fe)},[fe,ne,st,Te]),n.useEffect(()=>{if(!nt)return;const _=le=>{le.key==="Enter"&&(le.preventDefault(),Ut())};return window.addEventListener("keydown",_),()=>window.removeEventListener("keydown",_)},[nt]);const Ia=_=>{he(_),de(ca(_))};n.useEffect(()=>{if(!fe){de(null),he([]);return}const _=fe.cardType==="info"?"info":"connection";if(fe.cardType==="info"&&fe.infoType==="citation"){da().then(le=>{const we=le.filter(Ke=>Ke.itemType==="info"&&Ke.itemId===fe.cardId&&Ke.checkType==="quote-fragment"&&dn(Ke.direction,fe.direction));Ia(we)}).catch(()=>{de(null),he([])});return}cn(_,fe.cardId,fe.checkType,fe.direction).then(le=>Ia(le)).catch(()=>{de(null),he([])})},[fe]);const Pa=(_,le,we,Ke)=>{if(_==="info"&&we==="quote-fragment"){da().then(Fe=>{const je=Fe.filter(Pe=>Pe.itemType==="info"&&Pe.itemId===le&&Pe.checkType==="quote-fragment"&&dn(Pe.direction,Ke));Ia(je)}).catch(()=>{de(null),he([])});return}cn(_,le,we,Ke).then(Fe=>Ia(Fe)).catch(()=>{de(null),he([])})},Qa=(_,le,we)=>{var Pe;const Ke=((Pe=we.pairs.find(Ie=>Ie.leftId===_))==null?void 0:Pe.rightId)??null;if(!Ke)return we;const Fe=Ke===le;et(Ie=>({...Ie,[_]:Fe?"correct":"incorrect"})),E.current&&window.clearTimeout(E.current),M.current&&window.clearTimeout(M.current),Ce.current+=1;const je={kind:Fe?"correct":"incorrect",tick:Ce.current};if(tt(null),E.current=window.setTimeout(()=>tt(je),0),M.current=window.setTimeout(()=>tt(null),420),Fe){const Ie={...we.locked,[_]:!0};return Object.keys(Ie).length>=we.pairs.length?(Q("correct"),He(!0)):Q("correct"),{...we,selection:{...we.selection,[_]:le},activeLeft:null,activeRight:null,locked:Ie}}return Q("incorrect"),{...we,activeLeft:null,activeRight:null}},Ea=_=>{rt(le=>!le||le.locked[_]?le:le.activeRight?Qa(_,le.activeRight,le):{...le,activeLeft:le.activeLeft===_?null:_})},kn=_=>{rt(le=>le&&(le.activeLeft?Qa(le.activeLeft,_,le):{...le,activeRight:le.activeRight===_?null:_}))},Ut=()=>{var _;if(fe&&fe.cardType==="info"&&fe.infoType==="citation"&&De.current&&V&&!((_=Wt(fe.direction))!=null&&_.fragmentId)){const le=$a(De.current,it.current,Ze.current,$t,Nt,fe.direction,V.fragmentId);if(le){Q(null),X(""),T(!1),$e({}),He(!1),Z(null),ge(0),ra(De.current,le.id,V.title);return}}Q(null),X(""),T(!1),$e({}),He(!1),Z(null),ge(0),pe(le=>Math.min(le+1,y.length))},Jt=_=>{if(!fe)return;const le=_.expected??null,we=_.answer??"";let Ke=le??"",Fe=we;if(!le&&_.expectedMap&&_.answerMap){const C=Object.keys(_.expectedMap).sort((q,ue)=>q.localeCompare(ue));Ke=C.map(q=>{var ue;return((ue=_.expectedMap)==null?void 0:ue[q])??""}).join("|"),Fe=C.map(q=>{var ue;return((ue=_.answerMap)==null?void 0:ue[q])??""}).join("|")}const je=Ke?Ra(Ke,Fe,At):new Uint8Array,Pe={revisionType:Je.id,evalType:_.evalType,direction:_.direction,prompt:L??"",expected:le,answer:we,expectedAnswers:_.expectedMap??null,answers:_.answerMap??null,correct:_.correct,maskBase64:je.length?ya(je):null,checkMode:_t,compareMode:At,minCorrectness:Lt},Ie=new TextEncoder().encode(JSON.stringify(Pe)),Re=fe.cardType==="info"?"info":"connection",Qe=_.overrideCheckType??fe.checkType??null,f=_.overrideDirection??fe.direction??null;ln({itemType:Re,itemId:fe.cardId,checkType:Qe,direction:f,revisionType:Je.id,evalType:_.evalType,correct:_.correct,maskBase64:je.length?ya(je):null,payloadBase64:ya(Ie)}).then(()=>{Pa(Re,fe.cardId,Qe,f),aa(y)}).catch(()=>{})},Nn=(_,le)=>{const we=Xt.current.get(le);if(we)return Promise.resolve(we);const Ke=qt.current.get(le);if(Ke)return Ke;const Fe=ds({shareCode:d,infoId:_,key:kt}).then(je=>{var C,q;const Pe=je.payload,Ie=((C=Pe.definition)==null?void 0:C.graph)??null,Re="",Qe=((q=Pe.definition)==null?void 0:q.answerTemplate)??"",f=or(Ie,Re,Qe);if(f){const ye={sample:lr(f),answerTemplate:Qe||null};return Xt.current.set(le,ye),ye}return us({shareId:d,infoId:_,key:kt}).then(ue=>{const ye={sample:ue,answerTemplate:null};return Xt.current.set(le,ye),ye})}).catch(()=>us({shareId:d,infoId:_,key:kt}).then(je=>{const Pe={sample:je,answerTemplate:null};return Xt.current.set(le,Pe),Pe}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{qt.current.delete(le)});return qt.current.set(le,Fe),Fe},Vt=(_,le)=>{var Ie;const we=`${Se(_)}:${le}`,Ke=O.current.get(we);if(Ke)return Promise.resolve(Ke);const Fe=u.current.get(we);if(Fe)return Fe;const je=Re=>(O.current.set(we,Re),Re);let Pe;if(_.cardType==="vocab"){if(_.checkType==="translation-match")return Pe=Promise.resolve(je({prompt:_.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),Pe;const Re=_.label.split("↔").map(Qe=>Qe.trim()).filter(Boolean);if(Re.length>=2){const f=(_.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",C=f?Re[0]:Re[1],q=f?Re[1]:Re[0];Pe=Promise.resolve(je({prompt:C,expectedAnswer:q,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else Pe=Promise.resolve(je({prompt:_.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(_.cardType==="info"&&_.infoType==="word"){const Re=(Ie=_.description)!=null&&Ie.startsWith("Language: ")?_.description.replace("Language: ",""):null;Pe=Promise.resolve(je({prompt:_.label,expectedAnswer:Re,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else _.cardType==="info"&&_.infoType==="question"?Pe=ds({shareCode:d,infoId:_.cardId,key:kt}).then(Re=>{const Qe=Re.payload??{},f=Qe.definition??Qe??{},C=typeof f.type=="string"?f.type:"",q=(typeof f.question=="string"&&f.question.trim()?f.question.trim():null)??(typeof f.title=="string"&&f.title.trim()?f.title.trim():null)??_.label,ue=f.answer;return je(C==="text"||C==="number"||C==="date"?{prompt:q,expectedAnswer:typeof ue=="string"||typeof ue=="number"?String(ue):null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}:{prompt:q,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})}).catch(()=>je({prompt:_.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{u.current.delete(we)}):_.cardType==="info"&&_.infoType==="computed"?Pe=Nn(_.cardId,we).then(Re=>{var ue,ye;if(!Re.sample)return je({prompt:_.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const Qe=Re.sample,f=Qe.expectedAnswers?Object.entries(Qe.expectedAnswers).map(([oe,ve])=>({key:oe,expected:ve})):[],C=f.reduce((oe,ve)=>(oe[ve.key]="",oe),{}),q=Qe.expectedAnswerIsSentence&&((ue=Qe.expectedAnswer)==null?void 0:ue.trim())||null;return je({prompt:Qe.prompt,expectedAnswer:f.length>0?q:((ye=Qe.expectedAnswer)==null?void 0:ye.trim())||null,computedExpected:f,computedAnswers:C,answerTemplate:Re.answerTemplate,outputVariables:Qe.outputVariables??null,variableValues:Qe.variableValues??null})}).catch(()=>je({prompt:_.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{u.current.delete(we)}):Pe=Promise.resolve(je({prompt:_.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return u.current.set(we,Pe),Pe},ra=(_,le,we)=>{const Ke=Object.keys(_.nodes).length,Fe=it.current.size;if(!le){me({title:we,before:_.text,after:"",fragmentId:null,total:Ke,completed:Fe}),H(null),He(!0);return}const je=_.nodes[le];if(!je)return;const Pe=xn(_.text,je);me({title:we,before:Pe.before,after:Pe.after,fragmentId:je.id,total:Ke,completed:Fe}),H(Pe.fragment),He(!1)},Ma=()=>{const _=De.current;_&&me(le=>le&&{...le,total:Object.keys(_.nodes).length,completed:it.current.size})},ja=()=>{const _=y[R+1];_&&Vt(_,R+1)},Ka=()=>{if(ja(),fe&&fe.cardType==="vocab"&&fe.checkType==="translation-match"&&Be){if(Be.pairs.length===0){Q("incorrect"),He(!0);return}const je=Be.pairs.reduce((q,ue)=>(q[ue.rightId]=ue.rightLabel,q),{});let Pe=0;const Ie={};Be.pairs.forEach(q=>{const ye=Be.selection[q.leftId]===q.rightId;Ie[q.leftId]=ye?"correct":"incorrect",ye&&(Pe+=1)});const Re=Be.pairs.length||1,Qe=Pe/Re,f=Pe===Be.pairs.length;et(q=>({...q,...Ie})),f?(Q("correct"),He(!0),ge(0)):(Q("incorrect"),He(!1),ge(q=>{const ue=q+1;return ue>=gt&&(T(!0),He(!0),rt(ye=>{if(!ye)return ye;const oe=ye.pairs.reduce((ve,se)=>(ve[se.leftId]=se.rightId,ve),{});return{...ye,selection:oe}})),ue})),Gt(f,Qe);const C="connection";Promise.all(Be.pairs.map(q=>{const ue=Be.selection[q.leftId]??null,ye=ue?je[ue]:"",oe={left:q.leftLabel,expected:q.rightLabel,answer:ye,checkType:"translation-match"},ve=new TextEncoder().encode(JSON.stringify(oe));return ln({itemType:C,itemId:q.cardId,checkType:"translation-match",direction:null,revisionType:Je.id,evalType:"translation-match",correct:ue===q.rightId,maskBase64:null,payloadBase64:ya(ve)})})).then(()=>{Pa(C,fe.cardId,fe.checkType,fe.direction),aa(y)}).catch(()=>{});return}if(ne.length>0){const je=ne.reduce((Ie,Re)=>{const Qe=ke[Re.key]??"";return Ie[Re.key]=Bt(Qe)===Bt(Re.expected)?"correct":"incorrect",Ie},{});ne.every(({key:Ie,expected:Re})=>{const Qe=ke[Ie]??"";return _t==="exact"&&Bt(Qe)===Bt(Re)})?(Q("correct"),$e(je),He(!0),ge(0),Gt(!0,1),Jt({correct:!0,direction:L?`${L} -> computed`:"computed",expectedMap:ne.reduce((Ie,Re)=>(Ie[Re.key]=Re.expected,Ie),{}),answerMap:ke,evalType:"computed"})):(Q("incorrect"),$e(je),He(!1),ge(Ie=>{const Re=Ie+1;return Re>=gt&&ga&&(T(!0),He(!0)),Re}),Gt(!1,0),window.setTimeout(()=>{var Re;const Ie=hn(st,ne,Te);Ie&&Ve.current[Ie]&&((Re=Ve.current[Ie])==null||Re.focus())},40),Jt({correct:!1,direction:L?`${L} -> computed`:"computed",expectedMap:ne.reduce((Ie,Re)=>(Ie[Re.key]=Re.expected,Ie),{}),answerMap:ke,evalType:"computed"}));return}if(fe&&fe.cardType==="info"&&fe.infoType==="citation"&&(V!=null&&V.fragmentId)){if(!z)return;const je=Wt(fe.direction),Pe=(je==null?void 0:je.fragmentId)??V.fragmentId,Ie=Sa(z,F,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Re=Ie.mask,Qe=Ie.isCorrect,f=Ie.percent;Qe?(Ze.current[V.fragmentId]=Math.max(Ze.current[V.fragmentId]??0,f),(Ze.current[V.fragmentId]??0)>=$t&&it.current.add(V.fragmentId),Ma(),Q("correct"),$e({}),He(!0),Z(Re),ge(0),f<100&&gt<=1&&T(!0),Gt(!0,f/100),Jt({correct:!0,direction:`quote:${V.fragmentId}`,expected:z,answer:F,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Pe})):(Q("incorrect"),$e({}),He(!1),Z(Re),ge(C=>{const q=C+1;return q>=gt&&ga&&(T(!0),He(!0)),q}),Gt(!1,f/100),window.setTimeout(()=>{var C;return(C=be.current)==null?void 0:C.focus()},40),Jt({correct:!1,direction:`quote:${V.fragmentId}`,expected:z,answer:F,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Pe}));return}if(!z)return;const _=Ra(z,F,At),le=_t==="exact"&&Bt(F)===Bt(z),we=ma(_),Ke=le||we,Fe=xa(_);Ke?(Q("correct"),$e({}),He(!0),Z(_),ge(0),Fe<100&&gt<=1&&T(!0),Gt(!0,Fe/100),Jt({correct:!0,direction:L?`${L} -> ${z}`:null,expected:z,answer:F,evalType:"text"})):(Q("incorrect"),$e({}),He(!1),Z(_),ge(je=>{const Pe=je+1;return Pe>=gt&&ga&&(T(!0),He(!0)),Pe}),Gt(!1,Fe/100),window.setTimeout(()=>{var je;return(je=be.current)==null?void 0:je.focus()},40),Jt({correct:!1,direction:L?`${L} -> ${z}`:null,expected:z,answer:F,evalType:"text"}))},Sn=_=>{if(ja(),!z)return;const le=Ra(z,_,At),we=Bt(_)===Bt(z),Ke=ma(le),Fe=we||Ke,je=xa(le);Fe?(Q("correct"),$e({}),He(!0),Z(le),ge(0),je<100&&gt<=1&&T(!0),Gt(!0,je/100),Jt({correct:!0,direction:"word->language",expected:z,answer:_,evalType:"language-select"})):(Q("incorrect"),$e({}),He(!1),Z(le),ge(Pe=>{const Ie=Pe+1;return Ie>=gt&&ga&&(T(!0),He(!0)),Ie}),Gt(!1,je/100),Jt({correct:!1,direction:"word->language",expected:z,answer:_,evalType:"language-select"}))},Tn=_=>{var we;if(_.key!=="Enter")return;if(_.preventDefault(),_.stopPropagation(),nt){Ut();return}const le=ne.find(Ke=>!(ke[Ke.key]??"").trim());if(le){(we=Ve.current[le.key])==null||we.focus();return}Ka()},La=()=>{ja(),Q("correct"),He(!0),ge(0),Gt(!0,1),z&&Jt({correct:!0,direction:"manual",expected:z,answer:F,evalType:"manual"})},na=()=>{if(Gt(!1,0),fe&&fe.cardType==="info"&&fe.infoType==="citation"){Q(null),X(""),T(!1),$e({}),He(!1),Z(null),ge(0),pe(_=>Math.min(_+1,y.length));return}Ut()};n.useEffect(()=>{ja()},[R,y]);const Cn=t.cogita.library.revision.revealModeAfterIncorrect,ga=ne.length>0||!!z;return e.jsxs(Et,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:j,language:m,onLanguageChange:v,children:[(c==="loading"||W==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:c==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${ee.total?Math.min(100,Math.max(0,ee.current/ee.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:ee.total?`${Math.min(ee.current,ee.total)} / ${ee.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:g}),e.jsx("p",{className:"cogita-library-subtitle",children:K}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",Qt).replace("{check}",Ot)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:I?`${I.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Zt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Zt.currentLevel??"-"," / ",Zt.levelsCount]}):null,I?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(I.correct)).replace("{total}",String(I.total))}),I.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(I.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(cr,{outcomes:xe})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[te?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:te})}):null,e.jsx(es,{feedbackToken:ze?`${ze.kind}-${ze.tick}`:Rt?"idle":Me??"idle",children:c!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:c==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):fe?e.jsx(e.Fragment,{children:sa?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(ts,{copy:t,currentCard:fe,currentTypeLabel:ie,prompt:L,languages:B,answer:F,onAnswerChange:_=>X(le=>un(le,_,D)),computedExpected:ne,computedAnswers:ke,onComputedAnswerChange:(_,le)=>Le(we=>({...we,[_]:un(we[_]??"",le,D)})),answerTemplate:st,outputVariables:Te,variableValues:jt,computedFieldFeedback:Ee,feedback:Me,canAdvance:nt,quoteContext:V,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Ka,onSkip:na,onLanguageSelect:Sn,onMarkReviewed:La,onAdvance:Ut,showCorrectAnswer:k,setShowCorrectAnswer:T,onRevealCorrect:()=>He(!0),answerMask:G,expectedAnswer:z,hasExpectedAnswer:ga,handleComputedKeyDown:Tn,answerInputRef:be,computedInputRefs:Ve,scriptMode:D,setScriptMode:P,matchPairs:Be==null?void 0:Be.pairs,matchLeftOrder:Be==null?void 0:Be.leftOrder,matchRightOrder:Be==null?void 0:Be.rightOrder,matchSelection:Be==null?void 0:Be.selection,matchActiveLeft:Be==null?void 0:Be.activeLeft,matchActiveRight:Be==null?void 0:Be.activeRight,matchFeedback:ht,onMatchLeftSelect:Ea,onMatchRightSelect:kn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Ye?`${dt} / ${Ye}`:t.cogita.library.revision.progressUnlimited}),c==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),c==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),c==="ready"&&W==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),c==="ready"&&W==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),c==="ready"&&W==="ready"&&y.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Cn}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",gt]})]})]}),Zt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Zt.activeCount," / ",Zt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Zt.counts.map((_,le)=>{const we=le+1,Ke=Zt.currentLevel===we,Fe=Zt.percentages[le]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":Ke,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:we}),e.jsx("strong",{children:_})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,Fe))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[Fe.toFixed(1),"%"]})]},`level-${we}`)})})]}):null,wa?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:wa.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:wa.dots.map(_=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-_.value))}, ${Math.round(200*_.value)}, 80, 0.9)`}},_.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:wa.knownCount})]})]}):null,Nt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Wa})]})}):null]})]})]})})})]})]})}const Po=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:wo},Symbol.toStringTag,{value:"Module"})),la=t=>String(t??"").trim().toLocaleLowerCase(),gn=t=>Array.from(new Set(t.map(a=>Number(a)).filter(Number.isFinite))).sort((a,r)=>a-r),zs=t=>t.map(a=>a.join(",")).sort().join("|");function jo(t){const a=[...t];for(let r=a.length-1;r>0;r-=1){const s=Math.floor(Math.random()*(r+1));[a[r],a[s]]=[a[s],a[r]]}return a}function Vs(t){const a=t.map((i,o)=>({value:i,oldIndex:o}));for(let i=a.length-1;i>0;i-=1){const o=Math.floor(Math.random()*(i+1));[a[i],a[o]]=[a[o],a[i]]}const r=a.map(i=>i.value),s=new Map;return a.forEach((i,o)=>s.set(i.oldIndex,o)),{values:r,oldToNew:s}}function ko(t){const a=t.split("↔").map(r=>r.trim()).filter(Boolean);return a.length>=2?[a[0],a[1]]:null}function No(t){if(!t)return null;const a=t.indexOf(":");return a>=0?t.slice(a+1).trim():t.trim()}function So(t,a,r,s){const i=typeof r.type=="string"?r.type:"",o=typeof r.title=="string"&&r.title.trim()?r.title.trim():a,h=typeof r.question=="string"?r.question:a;if(!i||!h)return null;if(i==="selection"){const j=Array.isArray(r.options)?r.options.filter(b=>typeof b=="string"):[],m=Array.isArray(r.answer)?gn(r.answer):[],v=Vs(j),d=m.map(b=>v.oldToNew.get(b)).filter(b=>Number.isInteger(b)).sort((b,l)=>b-l);return{roundIndex:s,cardKey:`info:${t}:question-selection`,publicPrompt:{kind:"selection",title:o,prompt:h,options:v.values,multiple:!0,cardLabel:"question"},reveal:{kind:"selection",expected:d,title:o},grade:b=>{const l=Array.isArray(b)?gn(b):[];return JSON.stringify(l)===JSON.stringify(d)}}}if(i==="truefalse"){const j=!!r.answer;return{roundIndex:s,cardKey:`info:${t}:question-truefalse`,publicPrompt:{kind:"boolean",title:o,prompt:h,cardLabel:"question"},reveal:{kind:"boolean",expected:j,title:o},grade:m=>!!m===j}}if(i==="text"||i==="number"||i==="date"){const j=String(r.answer??"");return{roundIndex:s,cardKey:`info:${t}:question-${i}`,publicPrompt:{kind:"text",title:o,prompt:h,inputType:i==="number"?"number":i==="date"?"date":"text",cardLabel:"question"},reveal:{kind:"text",expected:j,title:o},grade:m=>{if(i==="number"){const v=Number(m),d=Number(j);return Number.isFinite(v)&&Number.isFinite(d)&&Math.abs(v-d)<1e-9}return la(m)===la(j)}}}if(i==="ordering"){const j=Array.isArray(r.options)?r.options.filter(v=>typeof v=="string"):[],m=jo(j);return{roundIndex:s,cardKey:`info:${t}:question-ordering`,publicPrompt:{kind:"ordering",title:o,prompt:h,options:m,cardLabel:"question"},reveal:{kind:"ordering",expected:j,title:o},grade:v=>JSON.stringify(Array.isArray(v)?v.map(String):[])===JSON.stringify(j)}}if(i==="matching"){const m=(Array.isArray(r.columns)?r.columns.map(l=>Array.isArray(l)?l.filter(c=>typeof c=="string"):[]):[]).map(l=>Vs(l)),v=r.answer??{},b=(Array.isArray(v.paths)?v.paths.map(l=>Array.isArray(l)?l.map(c=>Number(c)).filter(Number.isFinite):null).filter(l=>Array.isArray(l)):[]).map(l=>l.map((c,w)=>{var g;return((g=m[w])==null?void 0:g.oldToNew.get(c))??c}));return{roundIndex:s,cardKey:`info:${t}:question-matching`,publicPrompt:{kind:"matching",title:o,prompt:h,columns:m.map(l=>l.values),cardLabel:"question"},reveal:{kind:"matching",expected:{paths:b},title:o},grade:l=>{const c=l??{},w=Array.isArray(c.paths)?c.paths.map(g=>Array.isArray(g)?g.map(S=>Number(S)).filter(Number.isFinite):null).filter(g=>Array.isArray(g)):[];return zs(w)===zs(b)}}}return null}async function To(t){var b,l;const a=await Zn({libraryId:t.libraryId,revisionId:t.revisionId}),s=(await qa({libraryId:t.libraryId,collectionId:a.collectionId,limit:1e3})).items,i=Array.from(new Set(s.filter(c=>c.cardType==="info").map(c=>c.cardId))),o=new Map;await Promise.all(i.map(async c=>{try{const w=await ta({libraryId:t.libraryId,infoId:c});o.set(c,{infoType:w.infoType,payload:w.payload})}catch{}}));const h=new Map;await Promise.all(Array.from(o.entries()).filter(([,c])=>c.infoType==="computed").map(async([c])=>{try{const w=await Un({libraryId:t.libraryId,infoId:c});h.set(c,w)}catch{}}));const j=Array.from(new Set(s.filter(c=>c.cardType==="vocab").map(c=>c.label))).filter(Boolean),m={selectMatchingPairPrompt:((b=t.labels)==null?void 0:b.selectMatchingPairPrompt)??"Select the matching pair",wordLanguagePromptPrefix:((l=t.labels)==null?void 0:l.wordLanguagePromptPrefix)??"Language of"},v=[],d=new Set;for(const c of s){if(c.cardType==="vocab"){const g=ko(c.label);if(!g)continue;if(c.checkType==="translation"&&c.direction==="a-to-b"){const[S,K]=g;v.push({roundIndex:v.length,cardKey:`connection:${c.cardId}:translation:a-to-b`,publicPrompt:{kind:"text",title:c.label,prompt:S,cardLabel:c.description??void 0},reveal:{kind:"text",expected:K,title:c.label},grade:x=>la(x)===la(K)})}else if(c.checkType==="translation"&&c.direction==="b-to-a"){const[S,K]=g;v.push({roundIndex:v.length,cardKey:`connection:${c.cardId}:translation:b-to-a`,publicPrompt:{kind:"text",title:c.label,prompt:K,cardLabel:c.description??void 0},reveal:{kind:"text",expected:S,title:c.label},grade:x=>la(x)===la(S)})}else if(c.checkType==="translation-match"){const S=Array.from(new Set([c.label,...j.filter(x=>x!==c.label).slice(0,3)])),K=S.findIndex(x=>x===c.label);v.push({roundIndex:v.length,cardKey:`connection:${c.cardId}:translation-match`,publicPrompt:{kind:"selection",title:c.label,prompt:m.selectMatchingPairPrompt,options:S,multiple:!1,cardLabel:c.description??void 0},reveal:{kind:"selection",expected:[K],title:c.label},grade:x=>{const y=Array.isArray(x)?gn(x):gn([x]);return y.length===1&&y[0]===K}})}continue}if(c.cardType!=="info")continue;const w=o.get(c.cardId);if(w){if(w.infoType==="word"&&c.checkType==="word-language"){const g=No(c.description);if(!g)continue;v.push({roundIndex:v.length,cardKey:`info:${c.cardId}:word-language:${c.direction??""}`,publicPrompt:{kind:"text",title:c.label,prompt:`${m.wordLanguagePromptPrefix}: ${c.label}`,cardLabel:"word-language"},reveal:{kind:"text",expected:g,title:c.label},grade:S=>la(S)===la(g)});continue}if(w.infoType==="computed"&&c.checkType==="computed"){const g=h.get(c.cardId);if(!g)continue;v.push({roundIndex:v.length,cardKey:`info:${c.cardId}:computed`,publicPrompt:{kind:"text",title:c.label,prompt:g.prompt,multiLine:!1,cardLabel:"computed"},reveal:{kind:"text",expected:g.expectedAnswer,title:c.label},grade:S=>la(S)===la(g.expectedAnswer)});continue}if(w.infoType==="question"){const g=w.payload,S=g.definition??g,K=So(c.cardId,c.label,S,v.length);K&&(K.roundIndex=v.length,v.push(K));continue}if(w.infoType==="citation"&&!d.has(c.cardId)){d.add(c.cardId);const g=w.payload,S=typeof g.text=="string"?g.text:"",K=typeof g.title=="string"&&g.title.trim()?g.title.trim():c.label;if(!S.trim())continue;const x=va(S,{minLen:7,maxLen:13});for(const y of x.order){const ce=x.nodes[y];if(!ce)continue;const B=xn(S,ce);v.push({roundIndex:v.length,cardKey:`info:${c.cardId}:quote-fragment:${y}`,publicPrompt:{kind:"citation-fragment",title:K,before:B.before,after:B.after,fragmentId:y,cardLabel:"quote-fragment"},reveal:{kind:"citation-fragment",expected:B.fragment,title:K},grade:p=>Sa(B.fragment,String(p??""),{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}).isCorrect})}continue}}}return v.map((c,w)=>({...c,roundIndex:w}))}function Co(t){const{libraryId:a,revisionId:r}=t,s=t.copy.cogita.library.revision,i=s.live,[o,h]=n.useState(null),[j,m]=n.useState([]),[v,d]=n.useState("loading"),[b,l]=n.useState(null),c=`cogita.live.host.${a}.${r}`,w=o?j[o.currentRoundIndex]??null:null,g=o!=null&&o.status&&o.status!=="lobby"?o.currentPrompt??null:null,S=(o==null?void 0:o.currentReveal)??null,K=n.useMemo(()=>o!=null&&o.code&&typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision/${encodeURIComponent(o.code)}`:"",[o==null?void 0:o.code]),x=(o==null?void 0:o.status)==="finished"?"finished":o!=null&&o.status&&o.status!=="lobby"?"active":"lobby",y=(F,X)=>F.replace(/\{(\w+)\}/g,(Me,Q)=>String(X[Q]??"")),ce={lobby:i.statusLobby,running:i.statusRunning,revealed:i.statusRevealed,finished:i.statusFinished},B=(F,X,Me)=>({...F,hostSecret:F.hostSecret||(X==null?void 0:X.hostSecret)||(Me==null?void 0:Me.hostSecret)||"",code:F.code||(X==null?void 0:X.code)||(Me==null?void 0:Me.code)||""});n.useEffect(()=>{let F=!1;return To({libraryId:a,revisionId:r,labels:{selectMatchingPairPrompt:i.selectMatchingPairPrompt,wordLanguagePromptPrefix:i.wordLanguagePromptPrefix}}).then(X=>{F||m(X)}).catch(()=>{F||(l(i.loadRoundsError),d("error"))}),()=>{F=!0}},[a,i.selectMatchingPairPrompt,i.wordLanguagePromptPrefix,r]),n.useEffect(()=>{let F=!1;async function X(){try{typeof localStorage<"u"&&localStorage.removeItem(c);const Me=await Jr({libraryId:a,revisionId:r,title:i.hostKicker});if(F)return;h(Me),localStorage.setItem(c,JSON.stringify({sessionId:Me.sessionId,hostSecret:Me.hostSecret,code:Me.code})),d("ready")}catch{if(F)return;l(i.createSessionError),d("error")}}return X(),()=>{F=!0}},[a,r,c]),n.useEffect(()=>{if(!o)return;const F=window.setInterval(async()=>{try{const X=await Ur({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret});h(Me=>B(X,Me))}catch{}},1200);return()=>window.clearInterval(F)},[a,o]);const p=async F=>{if(!o)return;const X=Object.prototype.hasOwnProperty.call(F,"currentPrompt"),Me=Object.prototype.hasOwnProperty.call(F,"currentReveal"),Q=await Wr({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret,status:F.status??o.status,currentRoundIndex:F.currentRoundIndex??o.currentRoundIndex,revealVersion:F.revealVersion??o.revealVersion,currentPrompt:X?F.currentPrompt??null:o.currentPrompt??null,currentReveal:Me?F.currentReveal??null:o.currentReveal??null});h(L=>B(Q,L))},W=async F=>{const X=j[F];!X||!o||await p({status:"running",currentRoundIndex:F,revealVersion:o.revealVersion+1,currentReveal:null,currentPrompt:{...X.publicPrompt,roundIndex:F,cardKey:X.cardKey}})},N=async()=>{j.length&&await W((o==null?void 0:o.currentRoundIndex)??0)},ee=async()=>{if(!o||!w)return;const F=new Map(o.currentRoundAnswers.map(Q=>[Q.participantId,Q.answer])),X=o.participants.map(Q=>{const L=F.get(Q.participantId),$=w.grade(L);return{participantId:Q.participantId,isCorrect:$,pointsAwarded:$?1:0}}),Me=await Hr({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret,scores:X});h(Q=>B(Me,Q)),await p({status:"revealed",revealVersion:Me.revealVersion+1,currentReveal:w.reveal})},U=async()=>{if(!o)return;const F=o.currentRoundIndex+1;if(F>=j.length){await p({status:"finished",currentReveal:null});return}await W(F)},R=async()=>{if(o){if(o.status==="running"){await ee();return}if(o.status==="revealed"){await U();return}o.status==="lobby"&&await N()}},pe=(F,X)=>{if(!F)return e.jsx("p",{className:"cogita-help",children:i.waitingForHostQuestion});const Me=String(F.kind??""),Q=typeof X<"u",L=Array.isArray(X)?X.map($=>Number($)).filter(Number.isFinite):[];if(Me==="citation-fragment")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":Q?"correct":"idle",children:[e.jsxs("p",{children:[e.jsx("span",{style:{opacity:.7},children:String(F.before??"")}),e.jsx("strong",{children:" [ ... ] "}),e.jsx("span",{style:{opacity:.7},children:String(F.after??"")})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:Q?i.correctFragmentLabel:i.fragmentLabel}),e.jsx("input",{readOnly:!0,value:Q?String(X??""):"",placeholder:i.participantAnswerPlaceholder})]})]});if(Me==="text")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":Q?"correct":"idle",children:[e.jsx("p",{children:String(F.prompt??"")}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:Q?s.correctAnswerLabel:s.answerLabel}),e.jsx("input",{readOnly:!0,value:Q?String(X??""):"",placeholder:i.participantAnswerPlaceholder})]})]});if(Me==="boolean"){const $=!!X;return e.jsxs("div",{className:"cogita-live-card-surface","data-state":Q?"correct":"idle",children:[e.jsx("p",{children:String(F.prompt??"")}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:`cta ghost ${Q&&$?"live-correct-answer":""}`,disabled:!0,children:i.trueLabel}),e.jsx("button",{type:"button",className:`cta ghost ${Q&&!$?"live-correct-answer":""}`,disabled:!0,children:i.falseLabel})]})]})}if(Me==="selection"){const $=Array.isArray(F.options)?F.options.map(String):[],z=!!F.multiple;return e.jsxs("div",{className:"cogita-live-card-surface","data-state":Q?"correct":"idle",children:[e.jsx("p",{children:String(F.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:$.map((H,V)=>e.jsxs("label",{className:"cogita-share-row","data-state":Q&&L.includes(V)?"correct":void 0,children:[e.jsx("span",{children:H}),e.jsx("input",{type:z?"checkbox":"radio",disabled:!0,checked:Q?L.includes(V):!1,readOnly:!0})]},`${V}-${H}`))})]})}if(Me==="ordering"){const $=Array.isArray(Q?X:F.options)?(Q?X:F.options).map(String):[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":Q?"correct":"idle",children:[e.jsx("p",{children:String(F.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:$.map((z,H)=>e.jsxs("div",{className:"cogita-share-row","data-state":Q?"correct":void 0,children:[e.jsx("span",{children:z}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:!0,children:"↑"}),e.jsx("button",{type:"button",className:"ghost",disabled:!0,children:"↓"})]})]},`${H}-${z}`))})]})}if(Me==="matching"){const $=Array.isArray(F.columns)?F.columns:[],z=(X==null?void 0:X.paths)??[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":Q?"correct":"idle",children:[e.jsx("p",{children:String(F.prompt??"")}),Q?e.jsx("div",{className:"cogita-share-list",children:z.map((H,V)=>e.jsx("div",{className:"cogita-share-row","data-state":"correct",children:e.jsx("span",{children:H.map((me,ne)=>{const ae=Array.isArray($[ne])?$[ne]:[],ke=String(ae[me]??me);return`${ne>0?" → ":""}${ke}`})})},`path-${V}`))}):e.jsx("div",{className:"cogita-form-actions",children:$.map((H,V)=>e.jsx("select",{disabled:!0,children:(Array.isArray(H)?H:[]).map((me,ne)=>e.jsx("option",{children:String(me)},`${V}-${ne}`))},`host-col-${V}`))})]})}return e.jsx("p",{className:"cogita-help",children:i.unsupportedPromptType})};return e.jsx(Et,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":x,children:[e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:i.hostKicker}),e.jsx("h2",{className:"cogita-detail-title",children:i.hostTitle}),v==="loading"?e.jsx("p",{children:i.loading}):null,b?e.jsx("p",{className:"cogita-help",children:b}):null,o?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:i.joinCodeLabel}),e.jsx("input",{readOnly:!0,value:o.code})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:i.joinUrlLabel}),e.jsx("input",{readOnly:!0,value:K})]}),K?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:i.qrLabel}),e.jsx("div",{style:{display:"inline-flex",padding:"0.75rem",borderRadius:"12px",background:"#fff"},children:e.jsx(mr,{value:K,size:176,marginSize:2})})]}):null,e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:i.statusLabel}),e.jsx("input",{readOnly:!0,value:ce[o.status]??o.status})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:N,disabled:!j.length,children:i.publishCurrentRound})}),e.jsx("p",{className:"cogita-help",children:y(i.roundsLabel,{count:j.length})})]}):null]}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:i.currentRoundTitle}),e.jsx("h3",{className:"cogita-detail-title",children:g&&typeof g.title=="string"?g.title:(o==null?void 0:o.status)==="lobby"?i.sessionNotStarted:i.waitingForPublishedRound}),(o==null?void 0:o.status)==="lobby"?e.jsx("p",{className:"cogita-help",children:i.hiddenBeforeStart}):pe(g,S==null?void 0:S.expected),x!=="lobby"?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:R,disabled:!j.length||!w||o.status==="finished",children:o.status==="revealed"?s.nextQuestion:s.checkAnswer})}):null,x!=="finished"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:i.participantsTitle}),e.jsxs("div",{className:"cogita-share-list",children:[o==null?void 0:o.participants.map(F=>{const X=o.currentRoundAnswers.find(Me=>Me.participantId===F.participantId);return e.jsx("div",{className:"cogita-share-row",children:e.jsxs("div",{children:[e.jsx("strong",{children:F.displayName}),e.jsxs("div",{className:"cogita-share-meta",children:[X?i.answerStatusAnswered:i.answerStatusWaiting,(X==null?void 0:X.isCorrect)===!0?` · ${i.answerStatusCorrect}`:"",(X==null?void 0:X.isCorrect)===!1?` · ${i.answerStatusIncorrect}`:""]})]})},F.participantId)}),o&&o.participants.length===0?e.jsx("p",{className:"cogita-help",children:i.noParticipants}):null]})]}):null]}),x!=="lobby"?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:x==="finished"?i.finalScoreTitle:i.pointsTitle}),e.jsx("div",{className:"cogita-share-list",children:((o==null?void 0:o.scoreboard)??[]).map(F=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:F.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[F.score," ",i.scoreUnit]})]},`score:${F.participantId}`))})]}):null]})})})})})}const Eo=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionHostPage:Co},Symbol.toStringTag,{value:"Module"}));function Os(t){return`cogita.live.join.${t}`}function Io(t){const{code:a}=t,r=t.copy.cogita.library.revision,s=r.live,[i,o]=n.useState(""),[h,j]=n.useState(()=>typeof localStorage>"u"?null:localStorage.getItem(Os(a))),[m,v]=n.useState(null),[d,b]=n.useState("idle"),[l,c]=n.useState(""),[w,g]=n.useState([]),[S,K]=n.useState(null),[x,y]=n.useState([]),[ce,B]=n.useState([]),p=(m==null?void 0:m.currentPrompt)??null,W=(m==null?void 0:m.currentReveal)??null,N=W==null?void 0:W.expected,ee=(m==null?void 0:m.status)==="finished"?"finished":m!=null&&m.status&&m.status!=="lobby"?"active":"lobby",U=n.useMemo(()=>`${(m==null?void 0:m.currentRoundIndex)??0}:${(m==null?void 0:m.revealVersion)??0}:${String((p==null?void 0:p.cardKey)??"")}`,[p==null?void 0:p.cardKey,m==null?void 0:m.currentRoundIndex,m==null?void 0:m.revealVersion]);n.useEffect(()=>{c(""),g([]),K(null),y(Array.isArray(p==null?void 0:p.options)?[...p.options??[]]:[]),B([])},[U]),n.useEffect(()=>{let $=!0;const z=async()=>{try{const V=await hs({code:a,participantToken:h});if(!$)return;v(V),h&&b("ready")}catch{$&&d!=="joining"&&b("error")}};z();const H=window.setInterval(z,1200);return()=>{$=!1,window.clearInterval(H)}},[a,h,d]);const R=async()=>{b("joining");try{const $=await Qr({code:a,name:i});j($.participantToken),localStorage.setItem(Os(a),$.participantToken),b("ready")}catch{b("error")}},pe=$=>{if(!!(p!=null&&p.multiple)){g(H=>H.includes($)?H.filter(V=>V!==$):[...H,$].sort((V,me)=>V-me));return}g([$])},F=($,z)=>{y(H=>{const V=[...H],me=$+z;return me<0||me>=V.length?H:([V[$],V[me]]=[V[me],V[$]],V)})},X=()=>{const $=Array.isArray(p==null?void 0:p.columns)?p.columns:[];B(z=>[...z,$.map(()=>0)])},Me=($,z,H)=>{B(V=>V.map((me,ne)=>ne!==$?me:me.map((ae,ke)=>ke===z?H:ae)))},Q=async()=>{if(!h||!p||typeof p.cardKey!="string")return;let $=null;switch(p.kind){case"selection":$=w;break;case"boolean":$=S;break;case"ordering":$=x;break;case"matching":$={paths:ce};break;case"citation-fragment":case"text":default:$=l;break}try{await Gr({code:a,participantToken:h,roundIndex:Number(p.roundIndex??(m==null?void 0:m.currentRoundIndex)??0),cardKey:p.cardKey,answer:$});const z=await hs({code:a,participantToken:h});v(z),b("ready")}catch{b("error")}},L=()=>{if(!p)return e.jsx("p",{className:"cogita-help",children:s.waitingForHostQuestion});const $=!!W,z=Array.isArray(N)?N.map(H=>Number(H)).filter(Number.isFinite):[];if(p.kind==="citation-fragment")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":$?"correct":"idle",children:[e.jsxs("p",{children:[e.jsx("span",{style:{opacity:.7},children:String(p.before??"")}),e.jsx("strong",{children:" [ ... ] "}),e.jsx("span",{style:{opacity:.7},children:String(p.after??"")})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:$?s.correctFragmentLabel:s.fragmentLabel}),e.jsx("input",{value:$?String(N??""):l,onChange:H=>c(H.target.value),readOnly:$})]})]});if(p.kind==="text")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":$?"correct":"idle",children:[e.jsx("p",{children:String(p.prompt??"")}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:$?r.correctAnswerLabel:r.answerLabel}),e.jsx("input",{type:p.inputType==="number"?"number":p.inputType==="date"?"date":"text",value:$?String(N??""):l,onChange:H=>c(H.target.value),readOnly:$})]})]});if(p.kind==="boolean"){const H=!!N;return e.jsxs("div",{className:"cogita-live-card-surface","data-state":$?"correct":"idle",children:[e.jsx("p",{children:String(p.prompt??"")}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:`cta ghost ${$&&H?"live-correct-answer":""}`,onClick:()=>K(!0),disabled:$,children:s.trueLabel}),e.jsx("button",{type:"button",className:`cta ghost ${$&&!H?"live-correct-answer":""}`,onClick:()=>K(!1),disabled:$,children:s.falseLabel})]})]})}if(p.kind==="selection")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":$?"correct":"idle",children:[e.jsx("p",{children:String(p.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:(Array.isArray(p.options)?p.options:[]).map((H,V)=>e.jsxs("label",{className:"cogita-share-row","data-state":$&&z.includes(V)?"correct":void 0,children:[e.jsx("span",{children:H}),e.jsx("input",{type:p.multiple?"checkbox":"radio",name:"live-selection",checked:$?z.includes(V):w.includes(V),onChange:()=>pe(V),disabled:$})]},`${V}-${H}`))})]});if(p.kind==="ordering"){const H=Array.isArray($?N:x)?($?N:x).map(String):[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":$?"correct":"idle",children:[e.jsx("p",{children:String(p.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:H.map((V,me)=>e.jsxs("div",{className:"cogita-share-row","data-state":$?"correct":void 0,children:[e.jsx("span",{children:V}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>F(me,-1),disabled:$,children:"↑"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>F(me,1),disabled:$,children:"↓"})]})]},`${me}-${V}`))})]})}if(p.kind==="matching"){const H=Array.isArray(p.columns)?p.columns:[],V=(N==null?void 0:N.paths)??[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":$?"correct":"idle",children:[e.jsx("p",{children:String(p.prompt??"")}),$?e.jsx("div",{className:"cogita-share-list",children:V.map((me,ne)=>e.jsx("div",{className:"cogita-share-row","data-state":"correct",children:e.jsx("span",{children:me.map((ae,ke)=>{const Le=Array.isArray(H[ke])?H[ke]:[];return`${ke>0?" → ":""}${String(Le[ae]??ae)}`})})},`path-${ne}`))}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:X,children:s.addPathAction})}),ce.map((me,ne)=>e.jsx("div",{className:"cogita-form-actions",children:H.map((ae,ke)=>e.jsx("select",{value:me[ke]??0,onChange:Le=>Me(ne,ke,Number(Le.target.value)),children:ae.map((Le,Ee)=>e.jsxs("option",{value:Ee,children:[Ee,": ",Le]},`${ke}-${Ee}`))},`path-${ne}-col-${ke}`))},`path-${ne}`))]})]})}return e.jsx("p",{className:"cogita-help",children:s.unsupportedPromptType})};return e.jsx(Et,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":ee,children:[e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:s.joinKicker}),e.jsx("h2",{className:"cogita-detail-title",children:s.joinTitle}),h?e.jsx("p",{className:"cogita-help",children:s.joinedWaiting}):e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:s.participantNameLabel}),e.jsx("input",{value:i,onChange:$=>o($.target.value)})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:R,disabled:!i.trim()||d==="joining",children:d==="joining"?s.joiningAction:s.joinAction})})]}),d==="error"?e.jsx("p",{className:"cogita-help",children:s.connectionError}):null,ee==="lobby"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:s.scoreboardTitle}),e.jsxs("div",{className:"cogita-share-list",children:[m==null?void 0:m.scoreboard.map($=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:$.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[$.score," ",s.scoreUnit]})]},$.participantId)),m&&m.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:s.noParticipants}):null]})]}):null]}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:s.questionTitle}),e.jsx("h3",{className:"cogita-detail-title",children:typeof(p==null?void 0:p.title)=="string"?p.title:s.waitingForPublishedRound}),p?e.jsxs(e.Fragment,{children:[L(),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:Q,disabled:!h||!p.cardKey||(m==null?void 0:m.answerSubmitted),children:m!=null&&m.answerSubmitted?s.submitted:s.submitAnswer})})]}):e.jsx("p",{className:"cogita-help",children:s.waitingForHostQuestion})]}),ee!=="lobby"?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:ee==="finished"?s.finalScoreTitle:s.pointsTitle}),e.jsxs("div",{className:"cogita-share-list",children:[m==null?void 0:m.scoreboard.map($=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:$.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[$.score," ",s.scoreUnit]})]},`score:${$.participantId}`)),m&&m.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:s.noParticipants}):null]})]}):null]})})})})})}const Ko=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionJoinPage:Io},Symbol.toStringTag,{value:"Module"}));export{$o as C,Ro as a,Po as b,Eo as c,Ko as d};
