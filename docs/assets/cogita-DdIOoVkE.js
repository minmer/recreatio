import{r as a,j as e,u as Us,a as Va,b as Ws,c as Hs,d as Qs,R as ms,B as ps,C as fs}from"./vendor-CL5v9b84.js";import{L as Ys,A as Gs,g as Js,a as vn,b as wa,c as Xs,s as Ss,d as bs,e as wn,f as Ts,h as Yt,i as jn,j as Zs,k as en,l as tn,m as ys,n as an,o as kn,u as Nn,p as Sn,q as Tn,r as Cn,t as Mn,v as In,w as sn,x as nn,y as Ln,z as $n,B as Rn,C as Oa,D as $a,E as En,F as An,G as rn,H as Pn,I as Fn,J as Kn,K as Cs,M as Qt,N as zn,O as Bn,P as Dn,Q as _n,R as Vn,S as On,T as qn,U as Un,V as Wn,W as Hn,X as Qn,Y as Yn,Z as Gn,_ as Jn,$ as Xn,a0 as Zn,a1 as Ms}from"./recreatio-core-r39TKt4X.js";import"./vendor-cogita-ui-mbCyoqV0.js";const va={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},ya={moveMs:900,pauseMs:220,errorMs:900},ei=(t=11)=>{let s=t;const n=()=>(s=(s*1664525+1013904223)%4294967296,s/4294967296),{width:i,height:c,paddingX:y,paddingY:m,levels:p}=va,R=(c-m*2)/(p.length-1),L=[],l=[],x=[];p.forEach((f,h)=>{const ue=c-m-h*R,P=i-y*2,b=[];for(let H=0;H<f;H+=1){const E=y+(H+1)*P/(f+1),J=(n()-.5)*18,$=Math.max(y,Math.min(i-y,E+J)),A=h===0?3:h<2?2.1:1.4,ne=h===0?"root":`l${h}-${H}`;b.push({id:ne,x:h===0?i/2:$,y:ue,r:A,level:h,role:h===0?"root":void 0})}x.push(b),L.push(...b)});const o=x[x.length-1];if(o!=null&&o.length){const f=o[Math.floor(o.length/2)];f.role="goal",f.r=2}for(let f=1;f<x.length;f+=1){const h=x[f-1];x[f].forEach(P=>{const b=[...h].sort(($,A)=>Math.abs($.x-P.x)-Math.abs(A.x-P.x)),H=b[0],E=b[1]&&n()<.45?b[1]:null;(E?[H,E]:[H]).forEach($=>{l.push({from:$.id,to:P.id,key:`${$.id}-${P.id}`})}),n()<.2&&b[2]&&l.push({from:b[2].id,to:P.id,key:`${b[2].id}-${P.id}`})})}const u=new Map;l.forEach(f=>{const h=u.get(f.to)??[];h.push(f.from),u.set(f.to,h)});const S=new Map,Q=new Map,W=new Map;l.forEach(f=>{const h=S.get(f.from)??[];h.push(f.key),S.set(f.from,h);const ue=Q.get(f.from)??[];ue.push(f.to),Q.set(f.from,ue);const P=W.get(f.from)??[];P.push(f.to),W.set(f.from,P);const b=W.get(f.to)??[];b.push(f.from),W.set(f.to,b)});const _=new Map;return L.forEach(f=>{_.set(f.id,f)}),{nodes:L,links:l,parentsById:u,linksByFrom:S,childrenByFrom:Q,neighborsById:W,nodesById:_}};function ti({slides:t,activeIndex:s,introOpen:n,prefersReducedMotion:i,onNext:c,onPrev:y,onSelect:m,onExit:p,onOpen:R,onRegister:L}){const l=s===t.length-1,x=n&&s===0?"entry":"docked",o=t[t.length-1],[u,S]=a.useState(!1),Q=a.useMemo(()=>Array.from({length:20},(O,oe)=>({src:`/cogita/logo/Cogita${String(oe).padStart(2,"0")}.png`,kind:oe<=11?"bubble":oe<=17?"text":"recreatio"})),[]),W=n&&s===0;a.useEffect(()=>{if(!n){S(!1);return}s>0&&!u&&S(!0)},[s,n,u]);const _=a.useRef(0),f=a.useRef(null),h=a.useMemo(()=>{const O={x:40,y:160},oe={x:260,y:48},Pe=6,k=oe.x-O.x,M=O.y-oe.y,se=k/Pe,le=[.3,.45,.6,.65,1.4,2.2],ee=le.reduce((je,ke)=>je+ke,0),$e=le.map(je=>M*je/ee),Re=[O];let we=O.x,be=O.y;for(let je=1;je<=Pe;je+=1){const ke=(Math.random()-.5)*14,ot=(Math.random()-.5)*28;we=Math.max(O.x+je*14,Math.min(oe.x-(Pe-je)*14,we+se+ke));const Ue=$e[je-1]??$e[$e.length-1];be=be-Ue+ot;const Xe=Math.max(oe.y,Math.min(O.y-4,be));Re.push({x:Math.round(we),y:Math.round(Xe)})}return Re[Re.length-1]=oe,Re},[]),ue=a.useMemo(()=>{const M=(ee,$e,Re)=>Math.min(Re,Math.max($e,ee)),se=h.map(ee=>{const $e=10+Math.random()*36;return{x:M(ee.x,40,260),y:M(ee.y-$e,40,140)}}),le=h.map((ee,$e)=>{var be;const Re=12+Math.random()*40,we=((be=se[$e])==null?void 0:be.y)??ee.y;return{x:M(ee.x,40,260),y:M(Math.max(we+10,ee.y+Re),60,170)}});return{upper:se,lower:le}},[h]),P=a.useMemo(()=>{var oe;const O=((oe=h[4])==null?void 0:oe.x)??260;return Math.max(0,Math.min(240,O-40))},[h]),b=a.useMemo(()=>{var $e,Re;const O=(we,be,je)=>Math.min(je,Math.max(be,we)),oe=(we,be,je)=>h.map((ke,ot)=>{var Ct,dt;const Ue=((Ct=ue.upper[ot])==null?void 0:Ct.y)??ke.y,Xe=((dt=ue.lower[ot])==null?void 0:dt.y)??ke.y,lt=(Math.random()-.5)*70,yt=ke.y+we+lt,We=O(ke.y+be,Ue+6,Xe-6),He=O(ke.y+je,Ue+6,Xe-6);return{x:ke.x,y:O(yt,Math.min(We,He),Math.max(We,He))}}),Pe=-14+Math.random()*28,k=14+Math.random()*28,M=oe(Pe,-80,12),se=oe(k,-12,80);for(let we=4;we<h.length;we+=1){const be=h[we],je=(($e=ue.upper[we])==null?void 0:$e.y)??be.y,ke=((Re=ue.lower[we])==null?void 0:Re.y)??be.y;M[we]={x:be.x,y:O(be.y-12,je+6,ke-6)},se[we]={x:be.x,y:O(be.y+12,je+6,ke-6)}}const le=ue.upper.length?ue.upper[ue.upper.length-1].y:40,ee=ue.lower.length?ue.lower[ue.lower.length-1].y:170;return M[M.length-1]={x:h[h.length-1].x,y:O(h[h.length-1].y-14,le,ee)},se[se.length-1]={x:h[h.length-1].x,y:O(h[h.length-1].y+12,le,ee)},{higher:M,lower:se}},[h,ue]),H=1e4,E=a.useMemo(()=>{let O=17;const oe=()=>(O=(O*1664525+1013904223)%4294967296,O/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((k,M)=>{const se=(oe()-.5)*240,le=(oe()-.5)*180,ee=(oe()-.5)*24;return{id:`card-${M+1}`,throw:{x:`${se.toFixed(0)}px`,y:`${le.toFixed(0)}px`,rot:`${ee.toFixed(1)}deg`},grid:{x:`${k.x}px`,y:`${k.y}px`},delay:`${M*.12}s`}})},[]),J=a.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[$,A]=a.useState([]),ne=a.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),ce=a.useMemo(()=>{const oe=[],k=(se,le)=>se+Math.random()*(le-se);for(let se=0;se<6;se+=1){let le=!1;for(let ee=0;ee<80;ee+=1){const $e=k(14,86),Re=k(10,34);if(oe.every(be=>{const je=be.x-$e,ke=be.y-Re;return Math.hypot(je,ke)>=12})){oe.push({x:$e,y:Re}),le=!0;break}}le||oe.push({x:k(16,84),y:k(12,32)})}return oe.map((se,le)=>({id:`p${le+1}`,x:`${se.x.toFixed(1)}%`,y:`${se.y.toFixed(1)}%`,xNum:se.x,yNum:se.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[re,De]=a.useState(0),[me,T]=a.useState(0),[ye,v]=a.useState([]),V=1e4,fe=a.useMemo(()=>{if(ce.length<2)return[];const O=le=>{let ee=le+1831565813;return ee=Math.imul(ee^ee>>>15,ee|1),ee^=ee+Math.imul(ee^ee>>>7,ee|61),((ee^ee>>>14)>>>0)/4294967296},oe=(le,ee)=>Math.floor(O(le)*ee),Pe=new Set,k=[],M=Math.min(3,ce.length);let se=0;for(;k.length<M&&se<30;){se+=1;const le=oe(re*13+se*5,ce.length),ee=oe(re*29+se*7,ce.length);if(le===ee)continue;const $e=le<ee?`${le}-${ee}`:`${ee}-${le}`;Pe.has($e)||(Pe.add($e),k.push({id:`link-${$e}`,from:ce[le],to:ce[ee],delay:`${(se*.35).toFixed(2)}s`}))}return k},[re,ce]);a.useEffect(()=>{if(!n||s!==2)return;const O=()=>{const Pe=E.map(k=>k.id);for(let k=Pe.length-1;k>0;k-=1){const M=Math.floor(Math.random()*(k+1));[Pe[k],Pe[M]]=[Pe[M],Pe[k]]}return Pe.slice(0,4)};A(O());const oe=window.setInterval(()=>{A(O())},H);return()=>window.clearInterval(oe)},[s,n,E,H]),a.useEffect(()=>{if(!n||s!==3)return;const O=()=>{T(Math.floor(Math.random()*ne.length)),v(ce.map(()=>Math.random()<.6?"good":"bad")),De(Pe=>Pe+1)};O();const oe=window.setInterval(O,V);return()=>window.clearInterval(oe)},[s,n,ne.length,ce,V]);const Y=a.useMemo(()=>ei(11),[]),[F,ve]=a.useState(new Set(["root"])),[Me,Te]=a.useState(new Set),[Ke,Ie]=a.useState(new Set),[_e,Be]=a.useState({fromId:"root",toId:"root",key:0}),Le=a.useRef(F),qe=a.useRef("root"),et=a.useRef(0),Ge=a.useRef(null),Ae=a.useRef(null),xe=a.useRef([]);a.useEffect(()=>{Le.current=F},[F]);const te=a.useMemo(()=>{const O=new Set;return F.forEach(oe=>{const Pe=Y.linksByFrom.get(oe);Pe&&Pe.forEach(k=>O.add(k))}),O},[F,Y]),Se=Y.nodesById.get(_e.toId)??Y.nodesById.get("root"),G=Se?`${Se.x/va.width*100}%`:"50%",de=Se?`${Se.y/va.height*100}%`:"90%";a.useEffect(()=>{if(!n||s!==1||i)return;(()=>{ve(new Set(["root"])),Te(new Set),Ie(new Set),Be({fromId:"root",toId:"root",key:0}),Ae.current=null,et.current=0,qe.current="root",xe.current=[]})();const oe=()=>{const k=qe.current,M=Le.current,le=(Y.childrenByFrom.get(k)??[]).filter(ke=>!M.has(ke));if(le.length)return le[Math.floor(Math.random()*le.length)];if(M.size>=Y.nodes.length){const ke=Y.neighborsById.get(k)??[];return ke.length?ke[Math.floor(Math.random()*ke.length)]:null}const ee=ke=>(Y.childrenByFrom.get(ke)??[]).some(Ue=>!M.has(Ue)),$e=[k],Re=new Set([k]),we=new Map;let be=null;for(;$e.length;){const ke=$e.shift();if(!ke)break;if(ke!==k&&ee(ke)){be=ke;break}(Y.neighborsById.get(ke)??[]).forEach(Ue=>{Re.has(Ue)||(Re.add(Ue),we.set(Ue,ke),$e.push(Ue))})}if(!be)return null;let je=be;for(;we.get(je)&&we.get(je)!==k;)je=we.get(je)??je;return je},Pe=(k,M)=>{if(k===M){const se=oe();se&&Pe(k,se);return}et.current+=1,Be({fromId:k,toId:M,key:et.current}),qe.current=M,Ge.current=window.setTimeout(()=>{const se=Y.parentsById.get(M)??[],le=Le.current,ee=se.filter(be=>!le.has(be));if(!ee.length){const be=new Set(le);be.add(M),ve(be),Ge.current=window.setTimeout(()=>{for(;xe.current.length;){const ke=xe.current[xe.current.length-1];if(!be.has(ke)){if(ke!==M){Pe(M,ke);return}break}xe.current.pop()}const je=oe();je&&Pe(M,je)},ya.pauseMs);return}const $e=new Set([M,...ee]),Re=new Set(ee.map(be=>`${be}-${M}`));Te($e),Ie(Re),xe.current.includes(M)||xe.current.push(M);const we=ee[Math.floor(Math.random()*ee.length)];Ae.current={fromId:M,toId:we},Ge.current=window.setTimeout(()=>{Te(new Set),Ie(new Set);const be=Ae.current;be&&Pe(be.fromId,be.toId)},ya.errorMs)},ya.moveMs)};return Ge.current=window.setTimeout(()=>{const k=oe();k&&Pe(qe.current,k)},ya.pauseMs),()=>{Ge.current&&window.clearTimeout(Ge.current)}},[s,n,Y,i]);const ze=O=>{if(!n)return;const oe=Date.now();oe-_.current<520||Math.abs(O.deltaY)<10||(_.current=oe,O.deltaY>0?c():y(),O.preventDefault())},Je=O=>{if(!n)return;const oe=O.touches[0];oe&&(f.current={x:oe.clientX,y:oe.clientY})},Ve=O=>{if(!n)return;const oe=f.current;if(f.current=null,!oe)return;const Pe=O.changedTouches[0];if(!Pe)return;const k=Pe.clientX-oe.x,M=Pe.clientY-oe.y;Math.abs(M)<40||Math.abs(M)<Math.abs(k)||(M<0?c():y())};return e.jsxs("div",{className:`cogita-intro ${n?"is-open":"is-closed"} ${i?"is-reduced":""} ${l?"is-final":""}`,"data-slide":s+1,onWheel:ze,onTouchStart:Je,onTouchEnd:Ve,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":x,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${W&&!u?"is-entry":""}`,children:Q.map((O,oe)=>e.jsx("img",{src:O.src,alt:"",className:`cogita-logo-layer ${oe===0?"is-base":""} ${O.kind==="text"?"is-text":O.kind==="recreatio"?"is-recreatio":""} ${O.kind==="bubble"?"is-bubble":""}`},O.src))})}),n&&t.map((O,oe)=>{const Pe=oe===s;return e.jsxs("section",{className:`cogita-intro-slide slide-${oe+1} ${Pe?"is-active":""}`,"aria-hidden":!Pe,children:[e.jsxs("div",{className:"cogita-intro-text",children:[O.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:O.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:O.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:O.title}),O.body&&e.jsx("p",{children:O.body.split(`
`).map((k,M)=>e.jsxs("span",{children:[k,M===0&&e.jsx("br",{})]},String(M)))})]}),O.micro&&e.jsx("p",{className:"cogita-intro-micro",children:O.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:l?L:c,children:O.cta}),l&&O.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>m(0),children:O.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[oe===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${va.width} ${va.height}`,preserveAspectRatio:"none",children:[Y.links.map(k=>{const M=Y.nodesById.get(k.from),se=Y.nodesById.get(k.to);if(!M||!se)return null;const le=te.has(k.key),ee=Ke.has(k.key);return e.jsx("line",{className:`map-link ${le?"is-active":""} ${ee?"is-error":""}`,x1:M.x,y1:M.y,x2:se.x,y2:se.y},k.key)}),Y.nodes.map(k=>{const M=F.has(k.id),se=Me.has(k.id);return e.jsx("circle",{className:`map-node ${k.role?`is-${k.role}`:""} ${M?"is-active":""} ${se?"is-error":""}`,cx:k.x,cy:k.y,r:k.r},k.id)})]}),Se&&e.jsx("span",{className:"map-explorer-dot",style:{left:G,top:de,"--move":`${ya.moveMs}ms`}})]}),oe===2&&e.jsx("div",{className:"cogita-index-cards",children:E.map(k=>{const M=$.indexOf(k.id),se=M>=0?J[M]:null,le=(se==null?void 0:se.x)??"140px",ee=(se==null?void 0:se.y)??"140px",$e=M>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":k.throw.x,"--throw-y":k.throw.y,"--throw-rot":k.throw.rot,"--grid-x":k.grid.x,"--grid-y":k.grid.y,"--stack-x":le,"--stack-y":ee,"--stack-opacity":$e,"--delay":k.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},k.id)})}),oe===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[ne.map((k,M)=>e.jsxs("div",{className:`round-card ${M===me?"is-active":""}`,style:{"--card-x":k.x,"--card-y":k.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},k.id)),ne[me]&&e.jsx("span",{className:"round-ring",style:{"--card-x":ne[me].x,"--card-y":`calc(${ne[me].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:ce.map(k=>e.jsx("span",{className:"player-dot",style:{left:k.x,top:k.y,"--jitter-x":k.jitterX,"--jitter-y":k.jitterY,"--breath-delay":k.delay}},k.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:fe.map(k=>e.jsx("line",{className:"round-link",x1:k.from.xNum,y1:k.from.yNum,x2:k.to.xNum,y2:k.to.yNum,style:{"--delay":k.delay}},k.id))}),e.jsx("div",{className:"round-flows",children:ce.map((k,M)=>{const se=ye[M]??"good",le=ne[me];if(!le)return null;const ee=`calc(${le.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":k.x,"--from-y":k.y,"--to-x":le.x,"--to-y":ee,"--delay":`${M*.12}s`}}),e.jsx("span",{className:`return-dot is-${se}`,style:{"--from-x":le.x,"--from-y":ee,"--to-x":k.x,"--to-y":k.y,"--delay":`${M*.12}s`}}),e.jsx("span",{className:`result-pop is-${se}`,style:{"--at-x":k.x,"--at-y":k.y,"--delay":`${M*.12}s`}})]},`${k.id}-${re}`)})})]},`round-${re}`),oe===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${h[0].x} ${h[0].y} L${h[1].x} ${h[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${h[1].x} ${h[1].y} L${h[2].x} ${h[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${h[2].x} ${h[2].y} L${h[3].x} ${h[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${h[3].x} ${h[3].y} L${h[4].x} ${h[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${h[4].x} ${h[4].y} L${h[5].x} ${h[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${h[5].x} ${h[5].y} L${h[6].x} ${h[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${P};${P};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${ue.upper.map((k,M)=>`${M===0?"M":"L"}${k.x} ${k.y}`).join(" ")} ${ue.lower.slice().reverse().map(k=>`L${k.x} ${k.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${ue.upper.map((k,M)=>`${M===0?"M":"L"}${k.x} ${k.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${ue.lower.map((k,M)=>`${M===0?"M":"L"}${k.x} ${k.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[b.higher.slice(0,6).map((k,M)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${M+1}`,d:`M${k.x} ${k.y} L${b.higher[M+1].x} ${b.higher[M+1].y}`,pathLength:"100"},`peer-1-${M}`)),b.lower.slice(0,6).map((k,M)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${M+1}`,d:`M${k.x} ${k.y} L${b.lower[M+1].x} ${b.lower[M+1].y}`,pathLength:"100"},`peer-2-${M}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${h[0].x/300*100}%`,"--p0y":`${h[0].y/200*100}%`,"--p1x":`${h[1].x/300*100}%`,"--p1y":`${h[1].y/200*100}%`,"--p2x":`${h[2].x/300*100}%`,"--p2y":`${h[2].y/200*100}%`,"--p3x":`${h[3].x/300*100}%`,"--p3y":`${h[3].y/200*100}%`,"--p4x":`${h[4].x/300*100}%`,"--p4y":`${h[4].y/200*100}%`,"--p5x":`${h[5].x/300*100}%`,"--p5y":`${h[5].y/200*100}%`,"--p6x":`${h[6].x/300*100}%`,"--p6y":`${h[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${b.higher[0].x/300*100}%`,"--q0y":`${b.higher[0].y/200*100}%`,"--q1x":`${b.higher[1].x/300*100}%`,"--q1y":`${b.higher[1].y/200*100}%`,"--q2x":`${b.higher[2].x/300*100}%`,"--q2y":`${b.higher[2].y/200*100}%`,"--q3x":`${b.higher[3].x/300*100}%`,"--q3y":`${b.higher[3].y/200*100}%`,"--q4x":`${b.higher[4].x/300*100}%`,"--q4y":`${b.higher[4].y/200*100}%`,"--q5x":`${b.higher[5].x/300*100}%`,"--q5y":`${b.higher[5].y/200*100}%`,"--q6x":`${b.higher[6].x/300*100}%`,"--q6y":`${b.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${b.lower[0].x/300*100}%`,"--q0y":`${b.lower[0].y/200*100}%`,"--q1x":`${b.lower[1].x/300*100}%`,"--q1y":`${b.lower[1].y/200*100}%`,"--q2x":`${b.lower[2].x/300*100}%`,"--q2y":`${b.lower[2].y/200*100}%`,"--q3x":`${b.lower[3].x/300*100}%`,"--q3y":`${b.lower[3].y/200*100}%`,"--q4x":`${b.lower[4].x/300*100}%`,"--q4y":`${b.lower[4].y/200*100}%`,"--q5x":`${b.lower[5].x/300*100}%`,"--q5y":`${b.lower[5].y/200*100}%`,"--q6x":`${b.lower[6].x/300*100}%`,"--q6y":`${b.lower[6].y/200*100}%`}})]})})}),oe===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),oe===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},O.id)}),!n&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:o.title}),o.body&&e.jsx("p",{children:o.body}),o.micro&&e.jsx("p",{className:"cogita-intro-micro",children:o.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:L,children:o.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:R,children:"Otwórz pokaz"})]})]})})]}),n&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((O,oe)=>e.jsx("button",{type:"button",className:`dot ${s===oe?"active":""}`,"aria-label":O.title,onClick:()=>m(oe)},O.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:p,children:"Pomiń"})]})]})}const ai=6,si=4;function ni({copy:t,onAuthAction:s,authLabel:n,showProfileMenu:i,onProfileNavigate:c,onToggleSecureMode:y,onLogout:m,secureMode:p,onNavigate:R,language:L,onLanguageChange:l}){const x=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}R("home")},o=a.useRef(null),u=a.useRef([]),S=a.useMemo(()=>{let v=Date.now()%2147483647;const V=()=>(v=v*48271%2147483647,v/2147483647);return Array.from({length:ai},(fe,Y)=>{const F=6+V()*8,ve=7+V()*10,Me=6+V()*9,Te=-V()*F,Ke=-V()*ve,Ie=-V()*Me,_e=.18+V()*.28,Be=12+V()*18,Le=4+V()*8,qe=(V()-.5)*3.2,et=(V()-.5)*3.8,Ge=V()>.5?"alternate":"alternate-reverse",Ae=V()>.5?"alternate":"alternate-reverse",xe=V()>.5?"alternate":"alternate-reverse",te=.18+V()*.42,Se=30+V()*60,G=-45-V()*38,de=188+V()*32,ze=.1+V()*.2;return{id:`wave-${Y+1}`,style:{"--wave-sway-duration":`${F}s`,"--wave-scale-duration":`${ve}s`,"--wave-drift-duration":`${Me}s`,"--wave-sway-delay":`${Te}s`,"--wave-scale-delay":`${Ke}s`,"--wave-drift-delay":`${Ie}s`,"--wave-sway-dir":Ge,"--wave-scale-dir":Ae,"--wave-drift-dir":xe,"--wave-scale":`${_e}`,"--wave-shift":`${Be}%`,"--wave-xshift":`${Le}%`,"--wave-x0":`${qe}%`,"--wave-y0":`${et}%`,"--wave-opacity":`${te}`,"--wave-blur":`${Se}px`,"--wave-bottom":`${G}%`,"--wave-hue":`${de}`,"--wave-glow":`${ze}`}}})},[]),Q=a.useMemo(()=>{let v=Date.now()*3%2147483647;const V=()=>(v=v*48271%2147483647,v/2147483647);return Array.from({length:si},(fe,Y)=>{const F=180+V()*220,ve=220+V()*280,Me=-V()*F,Te=-V()*ve,Ke=.12+V()*.22,Ie=3+V()*7,_e=1+V()*3,Be=(V()-.5)*2.8,Le=(V()-.5)*2.2;return{id:`mesh-${Y+1}`,seed:1e3+Y*991+Math.floor(V()*999),style:{"--mesh-sway-duration":`${F}s`,"--mesh-drift-duration":`${ve}s`,"--mesh-sway-delay":`${Me}s`,"--mesh-drift-delay":`${Te}s`,"--mesh-scale":`${Ke}`,"--mesh-shift":`${Ie}%`,"--mesh-xshift":`${_e}%`,"--mesh-x0":`${Le}%`,"--mesh-y0":`${Be}%`}}})},[]),W=a.useMemo(()=>{const v=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],V=t.cogita.introSlides,fe=new Map(V.map(Y=>[Y.id,Y]));return v.map(Y=>{var ve;const F=fe.get(Y.id);return{...Y,...F,title:(F==null?void 0:F.title)??"Cogita",cta:(F==null?void 0:F.cta)??((ve=t.cogita.introSlides[0])==null?void 0:ve.cta)??t.cogita.loginCta,secondary:F==null?void 0:F.secondary}})},[t.cogita.introSlides]),[_,f]=a.useState(0),[h,ue]=a.useState(!0),[P,b]=a.useState(!1),H=W.length-1,E=a.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),J=a.useCallback(()=>{E(),s()},[E,s]),$=a.useCallback(()=>{ue(!0),f(0)},[]),A=a.useCallback(()=>{ue(!1),f(H)},[H]),ne=a.useCallback(v=>{f(Math.max(0,Math.min(H,v)))},[H]),ce=a.useCallback(()=>{_>=H?J():ne(_+1)},[_,ne,J,H]),re=a.useCallback(()=>{ne(_-1)},[_,ne]);a.useEffect(()=>{var fe;const v=(fe=window.matchMedia)==null?void 0:fe.call(window,"(prefers-reduced-motion: reduce)");if(!v)return;const V=()=>b(v.matches);return V(),v.addEventListener?(v.addEventListener("change",V),()=>v.removeEventListener("change",V)):(v.addListener(V),()=>v.removeListener(V))},[]),a.useEffect(()=>{if(!h)return;const v=V=>{const fe=V.target;if(!fe)return;const Y=fe.tagName;if(!(fe.isContentEditable||Y==="INPUT"||Y==="TEXTAREA"||Y==="SELECT"||Y==="BUTTON"||Y==="A"||fe.closest('button, a, [role="button"], [role="link"]'))){if(V.key==="Escape"){A();return}if(V.key==="ArrowLeft"||V.key==="ArrowUp"){re();return}(V.key==="ArrowRight"||V.key==="ArrowDown"||V.code==="Space"||V.key===" ")&&(V.preventDefault(),ce())}};return window.addEventListener("keydown",v),()=>window.removeEventListener("keydown",v)},[A,ce,re,h]),a.useEffect(()=>{h&&_===H&&E()},[_,h,H,E]),a.useEffect(()=>{const v=o.current;if(!v)return;const V=u.current.filter(G=>!!G);if(!V.length)return;const fe=1,Y=.6,F=.6,ve=Math.max(1,Math.min(fe,window.devicePixelRatio||1));let Me=0,Te=0,Ke=Y,Ie=0,_e=0;const Be=G=>{let de=G%2147483647;return de<=0&&(de+=2147483646),(ze,Je)=>{de=de*48271%2147483647;const Ve=de/2147483647;return ze+Ve*(Je-ze)}},Le={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},qe=G=>{const de=Math.sin(G*12.9898)*43758.5453;return de-Math.floor(de)},et=G=>{const de=qe(G+.1)||1e-4,ze=qe(G+.7)||1e-4;return Math.sqrt(-2*Math.log(de))*Math.cos(2*Math.PI*ze)},Ge=(G,de)=>{const ze=Math.floor(G),Je=ze+1,Ve=G-ze,O=Ve*Ve*(3-2*Ve),oe=qe(ze*12.9898+de*78.233),Pe=qe(Je*12.9898+de*78.233);return oe+(Pe-oe)*O},Ae=G=>{const de=Be(G),ze=Math.min(4,Math.max(4,Math.floor(Me/1200*Le.filamentCount)));return Array.from({length:ze},(Je,Ve)=>{const O=Math.max(-1,Math.min(1,et(G+Ve*.37))),oe=Math.min(1,Math.max(0,qe(G+Ve*1.31))),Pe=Math.min(Le.depthLayers-1,Math.floor(oe*Le.depthLayers));return{seed:de(0,Math.PI*2)+G*.01,offset:O,freqA:Le.freq1*(.75+de(0,.5)),freqB:Le.freq2*(.75+de(0,.5)),ampA:Le.amp1*(.6+de(0,.7)),ampB:Le.amp2*(.6+de(0,.7)),width:2+Ve%5*.32,depth:oe,layer:Pe}})},xe=(G,de,ze)=>{const Je=Math.max(30,Math.floor(Me*Te/14e4));G.save(),G.globalAlpha=.6;for(let Ve=0;Ve<Je;Ve+=1){const O=qe(Ve*9.1+Me*.11)*de+ze,oe=qe(Ve*3.7+Te*.23)*Te,Pe=1.2+qe(Ve*5.9)*2.4,k=G.createRadialGradient(O,oe,0,O,oe,Pe*2);k.addColorStop(0,"rgba(10, 30, 60, 0.45)"),k.addColorStop(1,"rgba(10, 30, 60, 0)"),G.fillStyle=k,G.beginPath(),G.arc(O,oe,Pe*2,0,Math.PI*2),G.fill()}G.restore()},te=(G,de)=>{G.clearRect(0,0,Me,Te);const ze=Te*Le.waveCenter,Je=Le.waveBandPx,Ve=Le.segments,O=Le.colors.filaments,oe=Ie||Me,Pe=0;xe(G,oe,Pe),G.strokeStyle=O,G.lineCap="round",G.lineJoin="round";for(let k=0;k<de.length;k+=1){const M=de[k],se=M.offset*Je*(.85+qe(M.seed)*.4),le=1-Math.min(1,Math.abs(se)/Je),ee=Math.exp(-Math.pow(se/Le.crestThickness,2)),$e=M.layer===0?1.1:M.layer===1?.85:.6,Re=.35+(1-M.depth)*.65,we=le*Re*$e*(.34+ee*.45);G.globalAlpha=we,G.lineWidth=M.width*(1+(1-M.depth)*.8);const be=[];for(let ke=0;ke<=Ve;ke+=1){const ot=ke/Ve*oe+Pe,Ue=(Ge(ot*.012,M.seed)-.5)*Le.xJitter,Xe=ot+Ue,lt=(Ge(Xe*M.freqA,M.seed)-.5)*Le.jitterA,yt=(Ge(Xe*M.freqB,M.seed*1.7)-.5)*Le.jitterB,We=ze+Math.sin(Xe*M.freqA+M.seed)*M.ampA+Math.sin(Xe*M.freqB+M.seed*1.3)*M.ampB+se+lt+yt;be.push({x:Xe,y:We})}G.beginPath(),G.moveTo(be[0].x,be[0].y);for(let ke=1;ke<be.length-1;ke+=1){const ot=(be[ke].x+be[ke+1].x)/2,Ue=(be[ke].y+be[ke+1].y)/2;G.quadraticCurveTo(be[ke].x,be[ke].y,ot,Ue)}const je=be[be.length-1];G.quadraticCurveTo(je.x,je.y,je.x,je.y),G.stroke()}G.save(),G.globalCompositeOperation="lighter",G.strokeStyle=Le.colors.glow,G.lineCap="round",G.lineJoin="round";for(let k=0;k<de.length;k+=1){const M=de[k];if(Math.abs(M.offset)*Je>Le.crestThickness)continue;const se=Le.glowAlpha*(.7+(1-M.depth)*.6);G.globalAlpha=se,G.lineWidth=1.6+(1-M.depth)*1.2;const le=[];for(let $e=0;$e<=Ve;$e+=1){const Re=$e/Ve*oe+Pe,we=Math.sin(Re*.02+M.seed)*3,be=ze+Math.sin(Re*M.freqA+M.seed)*M.ampA+Math.sin(Re*M.freqB+M.seed*1.3)*M.ampB+M.offset*Je*.35+we;le.push({x:Re,y:be})}G.beginPath(),G.moveTo(le[0].x,le[0].y);for(let $e=1;$e<le.length-1;$e+=1){const Re=(le[$e].x+le[$e+1].x)/2,we=(le[$e].y+le[$e+1].y)/2;G.quadraticCurveTo(le[$e].x,le[$e].y,Re,we)}const ee=le[le.length-1];G.quadraticCurveTo(ee.x,ee.y,ee.x,ee.y),G.stroke()}G.restore()},Se=()=>{Me=Math.floor(v.clientWidth),Te=Math.floor(v.clientHeight),Ie=Math.floor(Me*1.8),_e=Te,Ke=Me<820?F:Y,V.forEach(G=>{const de=G.getContext("2d");if(!de)return;G.width=Math.floor(Ie*ve*Ke),G.height=Math.floor(_e*ve*Ke),G.style.width=`${Ie}px`,G.style.height=`${_e}px`,G.style.left=`${-(Ie-Me)/2}px`,de.setTransform(ve*Ke,0,0,ve*Ke,0,0);const ze=Number(G.dataset.seed||1),Je=Ae(ze);te(de,Je)})};return Se(),window.addEventListener("resize",Se,{passive:!0}),()=>window.removeEventListener("resize",Se)},[Q]);const De=W[Math.min(_,W.length-1)],me=h?De:W[W.length-1],T=(me==null?void 0:me.theme)??W[0].theme,ye={"--cogita-bg0":T.bg0,"--cogita-bg1":T.bg1,"--cogita-bg2":T.bg2,"--cogita-bloom":T.bloom,"--cogita-sat":T.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:x,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Ys,{value:L,onChange:l}),e.jsx(Gs,{copy:t,label:n,isAuthenticated:i,secureMode:p,onLogin:s,onProfileNavigate:c,onToggleSecureMode:y,onLogout:m,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:o,className:"cogita-section cogita-home",style:ye,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[Q.map((v,V)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:v.style,"data-seed":v.seed,ref:fe=>{u.current[V]=fe}},v.id)),S.map(v=>e.jsx("div",{className:"cogita-home-wave",style:v.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},v.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(ti,{slides:W,activeIndex:_,introOpen:h,prefersReducedMotion:P,onNext:ce,onPrev:re,onSelect:ne,onExit:A,onOpen:$,onRegister:J})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const ur=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:ni},Symbol.toStringTag,{value:"Module"})),on=a.createContext(!1);function Tt({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,headerExtra:l,children:x}){if(a.useContext(on))return e.jsx(e.Fragment,{children:x});const u=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}p("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:u,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Ys,{value:R,onChange:L}),e.jsxs("div",{className:"cogita-header-right",children:[l,e.jsx(Gs,{copy:t,label:s,isAuthenticated:n,secureMode:m,onLogin:()=>p("home"),onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:x}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function Wt(t){const[s,n]=a.useState("Cogita library"),[i,c]=a.useState(null);return a.useEffect(()=>{let y=!1;return Js().then(m=>{if(y)return;const p=m.find(R=>R.libraryId===t);p&&n(p.name)}).catch(()=>{y||n("Cogita library")}),()=>{y=!0}},[t]),a.useEffect(()=>{let y=!1;return vn(t).then(m=>{y||c(m)}).catch(()=>{y||c(null)}),()=>{y=!0}},[t]),{libraryName:s,stats:i}}function Is({slices:t}){const s=t.reduce((i,c)=>i+Math.max(0,c.value),0),n=a.useMemo(()=>{if(s<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let i=0;return`conic-gradient(${t.map(y=>{const p=Math.max(0,y.value)/s*360,R=i,L=i+p;return i=L,`${y.color} ${R}deg ${L}deg`}).join(",")})`},[t,s]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:n}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(i=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:i.color}}),e.jsx("strong",{children:i.value}),e.jsx("small",{children:i.label})]},i.label))})]})}function ii({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,libraryId:l}){const{libraryName:x,stats:o}=Wt(l),[u,S]=a.useState("infos"),[Q,W]=a.useState(0),[_,f]=a.useState(0),[h,ue]=a.useState(0),P=(o==null?void 0:o.totalInfos)??0,b=(o==null?void 0:o.totalCollections)??0,H=0,E=0,J=0,$=Math.max(0,P-J-_),A=Math.max(0,P-_-h);a.useEffect(()=>{let ce=!1;return(async()=>{try{const De=await wa({libraryId:l,limit:200}),me=await Promise.all(De.items.map(T=>Xs({libraryId:l,collectionId:T.collectionId}).catch(()=>[])));if(ce)return;W(me.reduce((T,ye)=>T+ye.length,0))}catch{ce||W(0)}})(),()=>{ce=!0}},[l]),a.useEffect(()=>{let ce=!1;return(async()=>{try{const[De,me,T]=await Promise.all([Ss({libraryId:l,type:"computed",limit:1}).catch(()=>({total:0})),Ss({libraryId:l,type:"source",limit:1}).catch(()=>({total:0})),bs({libraryId:l}).catch(()=>({items:[]}))]);if(ce)return;f((De.total??0)+(me.total??0));const ye=new Set(T.items.filter(v=>v.childItemType.toLowerCase()==="info").map(v=>v.childItemId).filter(Boolean));ue(ye.size)}catch{ce||(f(0),ue(0))}})(),()=>{ce=!0}},[l]);const ne=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:P},{key:"collections",label:t.cogita.library.overview.stats.collections,value:b},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:Q},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:H},{key:"texts",label:t.cogita.library.overview.stats.texts,value:E}];return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:x})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:ne.map(ce=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${u===ce.key?"active":""}`,onClick:()=>S(ce.key),children:[e.jsx("span",{children:ce.label}),e.jsx("strong",{children:ce.value})]},ce.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),u==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(Is,{slices:[{label:t.cogita.library.overview.known,value:J,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:$,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:_,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(Is,{slices:[{label:t.cogita.library.overview.availableChecks,value:h,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:A,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const Ye=(t,s)=>{const n=t.cogita.library.infoTypes,i=t.cogita.library.connectionTypes,c=t.cogita.library.groupTypes;return{any:n.any,vocab:n.vocab,book:c.book,citation:c.citation,language:n.language,word:n.word,sentence:n.sentence,topic:n.topic,collection:n.collection,person:n.person,institution:n.institution,collective:n.collective,orcid:n.orcid,address:n.address,email:n.email,phone:n.phone,media:n.media,work:n.work,geo:n.geo,music_piece:n.musicPiece,music_fragment:n.musicFragment,source:n.source,computed:n.computed,"word-language":i.wordLanguage,"quote-language":i.quoteLanguage,"language-sentence":i.languageSentence,translation:i.translation,"word-topic":i.wordTopic,reference:i.reference,"source-resource":i.sourceResource,"work-contributor":i.workContributor,"work-medium":i.workMedium,"orcid-link":i.orcidLink}[s]??String(s)},ri=t=>[{value:"any",label:Ye(t,"any")},{value:"language",label:Ye(t,"language")},{value:"word",label:Ye(t,"word")},{value:"sentence",label:Ye(t,"sentence")},{value:"topic",label:Ye(t,"topic")},{value:"collection",label:Ye(t,"collection")},{value:"person",label:Ye(t,"person")},{value:"institution",label:Ye(t,"institution")},{value:"collective",label:Ye(t,"collective")},{value:"orcid",label:Ye(t,"orcid")},{value:"address",label:Ye(t,"address")},{value:"email",label:Ye(t,"email")},{value:"phone",label:Ye(t,"phone")},{value:"media",label:Ye(t,"media")},{value:"work",label:Ye(t,"work")},{value:"geo",label:Ye(t,"geo")},{value:"music_piece",label:Ye(t,"music_piece")},{value:"music_fragment",label:Ye(t,"music_fragment")},{value:"source",label:Ye(t,"source")},{value:"citation",label:Ye(t,"citation")},{value:"computed",label:Ye(t,"computed")},{value:"vocab",label:Ye(t,"vocab")},{value:"book",label:Ye(t,"book")},{value:"word-language",label:Ye(t,"word-language")},{value:"quote-language",label:Ye(t,"quote-language")},{value:"language-sentence",label:Ye(t,"language-sentence")},{value:"translation",label:Ye(t,"translation")},{value:"word-topic",label:Ye(t,"word-topic")},{value:"reference",label:Ye(t,"reference")},{value:"source-resource",label:Ye(t,"source-resource")},{value:"work-contributor",label:Ye(t,"work-contributor")},{value:"work-medium",label:Ye(t,"work-medium")},{value:"orcid-link",label:Ye(t,"orcid-link")}],oi=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Za={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},ci={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code","notes"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","notes","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Za]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","notes","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Za]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name","notes"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid","notes"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country","notes"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address","notes"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number","notes"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind","notes"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId","notes"]},filterFields:[Za,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city","notes"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer","notes"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text","notes"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator","notes"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text","notes"],connections:[{relationType:"quote-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"quote",kind:"text",path:"text",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition","notes"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},Ls={infoType:"default",entityKind:"single",structure:{payloadFields:["label","notes"]},filterFields:[]};function li(t){return t?ci[t]??Ls:Ls}function di(t,s){return t.optionsSource==="languages"?s.languages.map(n=>({value:n.infoId,label:n.label})):t.optionsSource==="sourceKinds"?oi:[]}const es=60,ui=500;function cn(t){return`cogita.info-selection:${t}`}function $s(t){if(typeof window>"u")return{};const s=window.localStorage.getItem(cn(t));if(!s)return{};try{const n=JSON.parse(s);return!n||typeof n!="object"?{}:n}catch{return{}}}function hi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,libraryId:l,mode:x}){var jt;const o=Us(),u=Va(),S=t.cogita.library.list,[Q,W]=a.useState("any"),[_,f]=a.useState(""),[h,ue]=a.useState("relevance"),[P,b]=a.useState("details"),[H,E]=a.useState(!1),[J,$]=a.useState("idle"),[A,ne]=a.useState([]),[ce,re]=a.useState(es),[De,me]=a.useState(null),[T,ye]=a.useState(()=>$s(l)),[v,V]=a.useState({}),[fe,Y]=a.useState([]),[F,ve]=a.useState(null),[Me,Te]=a.useState(null),[Ke,Ie]=a.useState(null),[_e,Be]=a.useState("idle"),[Le,qe]=a.useState([]),[et,Ge]=a.useState(""),[Ae,xe]=a.useState(null),[te,Se]=a.useState("idle"),[G,de]=a.useState(null),[ze,Je]=a.useState(null),[Ve,O]=a.useState("idle"),oe=a.useMemo(()=>ri(t),[t]),Pe=a.useMemo(()=>[{value:"relevance",label:S.sortRelevance},{value:"label_asc",label:S.sortLabelAsc},{value:"label_desc",label:S.sortLabelDesc},{value:"type_asc",label:S.sortTypeAsc},{value:"type_desc",label:S.sortTypeDesc}],[S.sortLabelAsc,S.sortLabelDesc,S.sortRelevance,S.sortTypeAsc,S.sortTypeDesc]);a.useEffect(()=>{ye($s(l)),V({}),E(!1)},[l]),a.useEffect(()=>{bs({libraryId:l}).then(D=>Ie(D)).catch(()=>Ie({items:[]}))},[l]),a.useEffect(()=>{wn({libraryId:l}).then(D=>qe(D)).catch(()=>qe([]))},[l]),a.useEffect(()=>{Ts({libraryId:l,type:"language",filters:{sourceKind:"info"},limit:200}).then(D=>{const ae=D.map(Ce=>({infoId:Ce.infoId??"",infoType:Ce.entityType,label:Ce.title})).filter(Ce=>Ce.infoId.length>0);Y(ae)}).catch(()=>Y([]))},[l]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(cn(l),JSON.stringify(T))},[l,T]);const k=a.useMemo(()=>li(Q==="any"?null:Q),[Q]),M=a.useMemo(()=>new URLSearchParams(u.search),[u.search]),se=a.useMemo(()=>u.pathname.split("/").filter(Boolean),[u.pathname]),le=se.findIndex(D=>D==="infos"),ee=le>=0&&(se[le+1]??"").trim()||null,$e=le>=0?(se[le+2]??"").trim()==="checkcards"?"cards":"overview":"",Re=ee??((M.get("infoId")??"").trim()||null),we=ee?$e:(M.get("infoView")??"overview").trim(),be=we==="overview"&&!!Re,je=a.useMemo(()=>({language:S.typeFilterLanguage,languageA:S.typeFilterLanguageA,languageB:S.typeFilterLanguageB,originalLanguage:S.typeFilterOriginalLanguage,doi:S.typeFilterDoi,sourceKind:S.typeFilterSourceKind,locator:S.typeFilterLocator,quote:S.typeFilterQuote}),[S.typeFilterDoi,S.typeFilterLanguage,S.typeFilterLanguageA,S.typeFilterLanguageB,S.typeFilterLocator,S.typeFilterOriginalLanguage,S.typeFilterQuote,S.typeFilterSourceKind]),ke=a.useMemo(()=>k.filterFields.map(D=>({...D,label:D.labelKey?je[D.labelKey]:D.label??D.key,options:di(D,{languages:fe})})),[je,fe,k.filterFields]),ot=a.useMemo(()=>ke.some(D=>(v[D.key]??"").trim().length>0),[ke,v]);a.useEffect(()=>{V({})},[Q]),a.useEffect(()=>{const D={sourceKind:"info"};if(ot)for(const Ce of ke){const d=(v[Ce.key]??"").trim();d&&(D[Ce.path??Ce.key]=d)}$("loading");const ae=window.setTimeout(()=>{Ts({libraryId:l,type:Q==="any"?void 0:Q,query:_.trim()||void 0,filters:D,limit:ui}).then(Ce=>{const d=Ce.map(Ne=>({infoId:Ne.infoId??"",infoType:Ne.entityType,label:Ne.title})).filter(Ne=>Ne.infoId.length>0);ne(d),$("ready")}).catch(()=>{ne([]),$("ready")})},240);return()=>window.clearTimeout(ae)},[ot,l,_,Q,ke,v]),a.useEffect(()=>{if(!Re||we!=="overview"){ve(null),Te(null),Be("idle");return}let D=!1;return Be("loading"),Promise.all([Yt({libraryId:l,infoId:Re}),jn({libraryId:l,itemType:"info",itemId:Re}).catch(()=>null)]).then(([ae,Ce])=>{D||(ve(ae),Te(Ce),Be("ready"))}).catch(()=>{D||(ve(null),Te(null),Be("error"))}),()=>{D=!0}},[l,Re,we]),a.useEffect(()=>{if(!Re||we!=="overview"){de(null),Je(null),O("idle");return}let D=!1;return O("loading"),Promise.all([Zs({libraryId:l,infoId:Re}),en({libraryId:l,infoId:Re})]).then(([ae,Ce])=>{D||(de(ae),Je(Ce),O("ready"))}).catch(()=>{D||(de(null),Je(null),O("error"))}),()=>{D=!0}},[l,Re,we]);const Ue=a.useMemo(()=>F?Le.filter(D=>D.sourceInfoTypes.some(ae=>ae.toLowerCase()===F.infoType.toLowerCase())):[],[Le,F]);a.useEffect(()=>{if(!F){Ge("");return}Ge(D=>{var ae;return D&&Ue.some(Ce=>Ce.approachKey===D)?D:((ae=Ue[0])==null?void 0:ae.approachKey)??""})},[Ue,F]),a.useEffect(()=>{if(!F||!et){xe(null),Se("idle");return}let D=!1;return Se("loading"),tn({libraryId:l,infoId:F.infoId,approachKey:et}).then(ae=>{D||(xe(ae),Se("ready"))}).catch(()=>{D||(xe(null),Se("error"))}),()=>{D=!0}},[l,et,F]);const Xe=a.useMemo(()=>{const D=A.slice(),ae=Ce=>Ye(t,Ce);return h==="relevance"?D:h==="label_asc"?D.sort((Ce,d)=>Ce.label.localeCompare(d.label)):h==="label_desc"?D.sort((Ce,d)=>d.label.localeCompare(Ce.label)):h==="type_asc"?D.sort((Ce,d)=>Ce.infoType===d.infoType?Ce.label.localeCompare(d.label):ae(Ce.infoType).localeCompare(ae(d.infoType))):D.sort((Ce,d)=>Ce.infoType===d.infoType?Ce.label.localeCompare(d.label):ae(d.infoType).localeCompare(ae(Ce.infoType)))},[t,A,h]),lt=a.useMemo(()=>Xe.slice(0,ce),[Xe,ce]),yt=lt.length<Xe.length,We=a.useMemo(()=>new Set(Object.keys(T)),[T]),He=a.useMemo(()=>Object.values(T),[T]),Ct=a.useMemo(()=>{const D=new Map;for(const ae of He)D.set(ae.infoType,(D.get(ae.infoType)??0)+1);return Array.from(D.entries()).sort((ae,Ce)=>Ce[1]-ae[1]||ae[0].localeCompare(Ce[0]))},[He]),dt=a.useMemo(()=>{if(!Re||!Ke)return 0;const D=new Set;for(const ae of Ke.items)ae.childItemType!=="info"||ae.childItemId!==Re||D.add([ae.parentItemType,ae.parentItemId,ae.parentCheckType??"",ae.parentDirection??""].join("|"));return D.size},[Ke,Re]);a.useEffect(()=>{re(es);const D=new Set(A.map(ae=>ae.infoId));me(ae=>ae&&D.has(ae)?ae:null)},[A]);const Lt=D=>{ye(ae=>({...ae,[D.infoId]:{infoId:D.infoId,infoType:D.infoType,label:D.label}}))},ct=D=>{ye(ae=>{if(!ae[D])return ae;const Ce={...ae};return delete Ce[D],Ce})},it=(D,ae)=>{if(ae){Lt(D);return}ct(D.infoId)},$t=D=>{o(`/cogita/library/${l}/infos/${encodeURIComponent(D)}`,{replace:!0})},xt=()=>{o(`/cogita/library/${l}/list`,{replace:!0})},tt=()=>{Re&&o(`/cogita/library/${l}/edit/${encodeURIComponent(Re)}`,{replace:!0})},at=He.length===1?((jt=He[0])==null?void 0:jt.infoId)??null:null,Et=S.selectionCount.replace("{count}",String(He.length)),Rt=x==="collection"?"grid":x==="detail"?"wide":P,Ze=pi(R),gt=Me?Math.max(0,Math.min(100,Math.round((Me.score??0)*100))):0,pt=Me?fi(Me,Ze):Ze.noKnownnessData;return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":Rt,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[be?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:Ze.kicker}),e.jsx("h2",{className:"cogita-card-title",children:F?gi(F.payload,F.infoType,F.infoId):Ze.loading}),F?e.jsxs("p",{className:"cogita-card-subtitle",children:[Ye(t,F.infoType)," · ",F.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:xt,children:Ze.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:tt,disabled:!Re||_e!=="ready",children:S.editInfo})]})]}),_e==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:Ze.loading})}):_e==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:Ze.loadError})}):F?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Ze.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[gt,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${gt}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:pt})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Ze.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(Me==null?void 0:Me.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:Ze.correct.replace("{correct}",String((Me==null?void 0:Me.correctReviews)??0)).replace("{total}",String((Me==null?void 0:Me.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:Me!=null&&Me.lastReviewedUtc?`${Ze.lastReview}: ${mi(Me.lastReviewedUtc,R)}`:Ze.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Ze.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:dt}),e.jsx("p",{className:"cogita-library-hint",children:Ze.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Ze.checkcards}),Ve==="loading"?e.jsx("p",{className:"cogita-library-hint",children:Ze.loadingCheckcards}):Ve==="error"?e.jsx("p",{className:"cogita-library-hint",children:Ze.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:Ze.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(G==null?void 0:G.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:Ze.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(ze==null?void 0:ze.items.length)??0})]})]})]}),Ue.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:Ze.approach}),e.jsx("select",{value:et,onChange:D=>Ge(D.target.value),"aria-label":Ze.approach,children:Ue.map(D=>e.jsx("option",{value:D.approachKey,children:D.label},D.approachKey))})]}),te==="loading"?e.jsx("p",{className:"cogita-library-hint",children:Ze.loadingApproach}):te==="error"?e.jsx("p",{className:"cogita-library-hint",children:Ze.loadApproachError}):Ae?e.jsx(Ra,{value:Ae.projection,emptyLabel:Ze.empty}):e.jsx("p",{className:"cogita-library-hint",children:Ze.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Ze.payload}),e.jsx(Ra,{value:F.payload,emptyLabel:Ze.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Ze.links}),e.jsx(bi,{links:F.links,emptyLabel:Ze.noLinks})]})]})]}):null]})}):null,be?null:e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":S.typeLabel,value:Q,onChange:D=>W(D.target.value),children:oe.map(D=>e.jsx("option",{value:D.value,children:D.label},D.value))}),e.jsx("input",{type:"text",value:_,onChange:D=>f(D.target.value),placeholder:S.searchPlaceholder}),e.jsx("select",{"aria-label":S.sortLabel,value:h,onChange:D=>ue(D.target.value),children:Pe.map(D=>e.jsx("option",{value:D.value,children:D.label},D.value))}),e.jsxs("select",{"aria-label":S.viewLabel,value:P,onChange:D=>b(D.target.value),children:[e.jsx("option",{value:"details",children:S.viewDetails}),e.jsx("option",{value:"wide",children:S.viewWide}),e.jsx("option",{value:"grid",children:S.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:S.cardCount.replace("{shown}",String(lt.length)).replace("{total}",String(Xe.length))}),e.jsx("span",{children:J==="loading"?S.loading:S.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>E(D=>!D),children:H?S.hideFilters:S.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:S.filtersOptionalHint})]}),H&&ke.length>0?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsx("div",{className:"cogita-filter-grid",children:ke.map(D=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:D.label}),D.kind==="select"?e.jsxs("select",{value:v[D.key]??"",onChange:ae=>V(Ce=>({...Ce,[D.key]:ae.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(D.options??[]).map(ae=>e.jsx("option",{value:ae.value,children:ae.label},`${D.key}:${ae.value}`))]}):e.jsx("input",{type:"text",value:v[D.key]??"",onChange:ae=>V(Ce=>({...Ce,[D.key]:ae.target.value}))})]},`type-filter:${D.key}`))})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:Et}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{ye(D=>{const ae={...D};for(const Ce of lt)ae[Ce.infoId]={infoId:Ce.infoId,infoType:Ce.infoType,label:Ce.label};return ae})},disabled:lt.length===0,children:S.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>ye({}),disabled:He.length===0,children:S.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>at&&$t(at),disabled:!at,title:at?void 0:S.openSelectedDisabled,children:S.openSelected})]})]}),He.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:S.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:S.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:Ct.map(([D,ae])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:Ye(t,D)}),e.jsx("span",{className:"cogita-tag-count",children:ae})]},`stack:type:${D}`))})]}):null,Rt==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":S.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:S.detailColumnName}),e.jsx("span",{children:S.detailColumnType}),e.jsx("span",{children:S.detailColumnId}),e.jsx("span",{})]}),lt.length?lt.map(D=>{const ae=Ye(t,D.infoType),Ce=We.has(D.infoId),d=De===D.infoId;return e.jsxs("div",{className:`cogita-details-row ${d||Ce?"active":""}`,role:"row",onClick:()=>me(D.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:Ce,onChange:Ne=>it(D,Ne.target.checked),onClick:Ne=>Ne.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:D.label,children:D.label}),e.jsx("span",{title:ae,children:ae}),e.jsx("span",{title:D.infoId,children:D.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:Ne=>{Ne.stopPropagation(),$t(D.infoId)},"aria-label":S.editInfo,children:">"})]},D.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:S.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${Rt}`,"data-view":Rt,children:lt.length?lt.map(D=>{const ae=Ye(t,D.infoType),Ce=We.has(D.infoId),d=De===D.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":d||Ce,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:Ce,onChange:Ne=>it(D,Ne.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>me(D.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:ae}),e.jsx("h3",{className:"cogita-card-title",children:D.label}),e.jsx("p",{className:"cogita-card-subtitle",children:D.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>$t(D.infoId),children:S.editInfo})]})},D.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:S.noMatch})})}),yt?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>re(D=>D+es),children:S.loadMore})}):null]})]})})})})}function gi(t,s,n){if(t&&typeof t=="object"&&!Array.isArray(t)){const i=t,c=["title","name","label","value","text","quote","term"];for(const y of c){const m=i[y];if(typeof m=="string"&&m.trim())return m.trim()}}return`${s} · ${n}`}function mi(t,s){try{const n=s==="pl"?"pl-PL":s==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(n,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function pi(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function fi(t,s){return t.totalReviews<=0?s.noKnownnessData:t.totalReviews<3||t.score<.35?s.developmentStart:t.totalReviews<8||t.score<.65?s.developmentGrowing:t.score<.85?s.developmentStable:s.developmentStrong}function bi({links:t,emptyLabel:s}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:s}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([n,i])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:n}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(i)?i.length?e.jsx("div",{className:"cogita-selection-overview",children:i.map(c=>e.jsx("span",{className:"cogita-tag-chip",children:c},`${n}:${c}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):i?e.jsx("span",{className:"cogita-tag-chip",children:i}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},n))})}function Ra({value:t,emptyLabel:s}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:s});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((n,i)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:i+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(Ra,{value:n,emptyLabel:s})})]},i))});if(typeof t=="object"){const n=Object.entries(t);return n.length===0?e.jsx("p",{className:"cogita-library-hint",children:s}):e.jsx("div",{className:"cogita-info-tree",children:n.map(([i,c])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:i}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(Ra,{value:c,emptyLabel:s})})]},i))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const ta=5,Rs=50,Es=2,As=[];function aa({libraryId:t,infoType:s,label:n,placeholder:i,value:c,onChange:y,values:m,onChangeMultiple:p,helperText:R,searchFailedText:L,createFailedText:l,createLabel:x,savingLabel:o,loadMoreLabel:u,inputRef:S,autoAdvance:Q,onCommit:W,multiple:_}){const f=_?m??As:As,[h,ue]=a.useState(_?"":(c==null?void 0:c.label)??""),[P,b]=a.useState([]),[H,E]=a.useState(ta),[J,$]=a.useState(-1),[A,ne]=a.useState(!1),[ce,re]=a.useState(!1),[De,me]=a.useState(null),T=a.useRef(0),ye=a.useRef(new Map),v=a.useMemo(()=>_?h.trim().length>0:h.trim().length>0&&!c,[h,c,_]);a.useEffect(()=>{_||ue((c==null?void 0:c.label)??"")},[c,_]),a.useEffect(()=>{const Y=h.trim();if(!Y||Y.length<Es){b([]),ne(!1),E(ta),$(-1),re(!1),me(null);return}const F=Y.toLowerCase(),ve=`${t}:${s}:${F}`,Me=ye.current.get(ve);if(Me){if(_&&f.length>0){const Ke=new Set(f.map(Ie=>Ie.id));b(Me.filter(Ie=>!Ke.has(Ie.id)))}else b(Me);E(ta),$(-1),ne(Me.length>0),re(!1),me(null);return}const Te=window.setTimeout(async()=>{const Ke=Date.now();T.current=Ke,re(!0),me(null);try{const Ie=await ys({libraryId:t,type:s,query:Y,limit:Rs});if(T.current!==Ke)return;const _e=Ie.slice(0,Rs).map(Be=>({id:Be.infoId,label:Be.label,infoType:Be.infoType}));if(ye.current.set(ve,_e),_&&f.length>0){const Be=new Set(f.map(Le=>Le.id));b(_e.filter(Le=>!Be.has(Le.id)))}else b(_e);E(ta),$(-1),ne(!0)}catch{if(T.current!==Ke)return;me(L??"Search failed.")}finally{T.current===Ke&&re(!1)}},250);return()=>window.clearTimeout(Te)},[t,s,h,f]);const V=Y=>{if(_){const F=f.some(ve=>ve.id===Y.id)?f:[...f,Y];p==null||p(F),ue(""),ne(!1),$(-1);return}y==null||y(Y),ue(Y.label),ne(!1),$(-1),Q&&(W==null||W())},fe=async()=>{const Y=h.trim();if(Y){re(!0),me(null);try{const F=await an({libraryId:t,infoType:s,payload:{label:Y}}),ve={id:F.infoId,label:Y,infoType:F.infoType};if(Y.length>=Es){const Me=`${t}:${s}:${Y.toLowerCase()}`,Te=ye.current.get(Me)??[];ye.current.set(Me,[ve,...Te])}if(_){p==null||p([...f,ve]),ue(""),ne(!1),$(-1);return}y==null||y(ve),ne(!1),$(-1),Q&&(W==null||W())}catch{me(l??"Create failed.")}finally{re(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:n}),e.jsx("input",{value:h,placeholder:i,onChange:Y=>{ue(Y.target.value),!_&&c&&(y==null||y(null))},onKeyDown:Y=>{if(Y.key==="ArrowDown"){if(Y.preventDefault(),!P.length)return;ne(!0),$(F=>{const ve=Math.min(P.length,H)-1,Me=F<0?0:Math.min(F+1,ve);return Me===ve&&P.length>H?(E(Te=>Math.min(Te+ta,P.length)),Math.min(F+1,Math.min(P.length,H+ta)-1)):Me});return}if(Y.key==="ArrowUp"){if(Y.preventDefault(),!P.length)return;ne(!0),$(F=>F<=0?0:F-1);return}if(Y.key==="Enter"){if(Y.preventDefault(),J>=0&&P[J]){V(P[J]);return}if(v){fe();return}}},onFocus:()=>{P.length>0&&ne(!0)},autoComplete:"off",ref:S})]}),_&&f.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:f.map(Y=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>p==null?void 0:p(f.filter(F=>F.id!==Y.id)),children:[Y.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},Y.id))}),R&&e.jsx("p",{className:"cogita-help",children:R}),De&&e.jsx("p",{className:"cogita-error",children:De}),A&&P.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[P.slice(0,H).map((Y,F)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":F===J,onClick:()=>V(Y),children:[e.jsx("strong",{children:Y.label}),e.jsx("span",{children:Y.infoType})]},Y.id)),H<P.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>E(Y=>Math.min(Y+ta,P.length)),children:u??"Load more"})]}),v&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:fe,disabled:ce,children:ce?o??"Saving...":x??`Create new ${s}`})]})}function yi(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function Ps(t,s){if(!t||typeof t!="object")return s;const n=t,i=[n.label,n.name,n.title,n.text,n.orcid,n.email,n.number];for(const c of i)if(typeof c=="string"&&c.trim())return c.trim();return s}function xi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,libraryId:l,editInfoId:x}){const{libraryName:o}=Wt(l),u=!!x,[S,Q]=a.useState([]),[W,_]=a.useState("word"),[f,h]=a.useState({}),[ue,P]=a.useState({}),[b,H]=a.useState({}),[E,J]=a.useState({}),[$,A]=a.useState(null),[ne,ce]=a.useState("idle"),re=a.useMemo(()=>S.find(v=>v.infoType===W),[W,S]),De=a.useMemo(()=>S.map(v=>({value:v.infoType,label:Ye(t,v.infoType)})),[t,S]);a.useEffect(()=>{let v=!1;return kn({libraryId:l}).then(V=>{var fe;if(!v&&(Q(V),!u)){const Y=(fe=V[0])==null?void 0:fe.infoType;Y&&_(Y)}}).catch(()=>{v||Q([])}),()=>{v=!0}},[u,l]),a.useEffect(()=>{if(!re)return;const v={},V={},fe={},Y={};for(const F of re.payloadFields)v[F.key]="";for(const F of re.linkFields)F.multiple?fe[F.key]=[]:V[F.key]=null,F.targetTypes.length>0&&(Y[F.key]=F.targetTypes[0]);h(v),P(V),H(fe),J(Y)},[re==null?void 0:re.infoType]),a.useEffect(()=>{if(!u||!x||S.length===0)return;let v=!1;return ce("loading"),A(null),(async()=>{const fe=await Yt({libraryId:l,infoId:x});if(v)return;const Y=fe.infoType;_(Y);const F=S.find(Le=>Le.infoType===Y);if(!F){ce("idle");return}const ve=fe.payload??{},Me={};for(const Le of F.payloadFields)Me[Le.key]=yi(ve[Le.key]);h(Me);const Te=fe.links??{}??{},Ke={},Ie={},_e={},Be=[];for(const Le of F.linkFields){Le.targetTypes.length>0&&(_e[Le.key]=Le.targetTypes[0]);const qe=Te[Le.key];if(Le.multiple){const et=Array.isArray(qe)?qe.filter(Ge=>typeof Ge=="string"):[];Ie[Le.key]=[];for(const Ge of et)Be.push(Yt({libraryId:l,infoId:Ge}).then(Ae=>{if(v)return;const xe={id:Ge,infoType:Ae.infoType,label:Ps(Ae.payload,Ge)};Ie[Le.key]=[...Ie[Le.key],xe]}).catch(()=>{}))}else{const et=typeof qe=="string"?qe:null;Ke[Le.key]=null,et&&Be.push(Yt({libraryId:l,infoId:et}).then(Ge=>{v||(Ke[Le.key]={id:et,infoType:Ge.infoType,label:Ps(Ge.payload,et)})}).catch(()=>{}))}}await Promise.all(Be),!v&&(P(Ke),H(Ie),J(Le=>({...Le,..._e})),ce("idle"))})().catch(()=>{v||(A("Failed to load info details."),ce("idle"))}),()=>{v=!0}},[x,u,l,S]);const me=async()=>{var Y;if(!re)return;const v={};for(const F of re.payloadFields){const ve=(f[F.key]??"").trim();if(!ve){if(F.required){A(`Field '${F.label}' is required.`);return}continue}if(F.inputType==="json")try{v[F.key]=JSON.parse(ve)}catch{A(`Field '${F.label}' must be valid JSON.`);return}else v[F.key]=ve}const V={};for(const F of re.linkFields)if(F.multiple){const ve=(b[F.key]??[]).map(Me=>Me.id);if(F.required&&ve.length===0){A(`Link '${F.label}' is required.`);return}ve.length>0&&(V[F.key]=ve)}else{const ve=((Y=ue[F.key])==null?void 0:Y.id)??null;if(F.required&&!ve){A(`Link '${F.label}' is required.`);return}ve&&(V[F.key]=ve)}const fe=Object.keys(V).length>0;ce("saving"),A(null);try{if(u&&x)await Nn({libraryId:l,infoId:x,payload:v,links:fe?V:void 0}),A("Info updated.");else{await an({libraryId:l,infoType:W,payload:v,links:fe?V:void 0}),A("Info saved.");const F={};for(const Te of re.payloadFields)F[Te.key]="";h(F);const ve={},Me={};for(const Te of re.linkFields)Te.multiple?Me[Te.key]=[]:ve[Te.key]=null;P(Te=>({...Te,...ve})),H(Te=>({...Te,...Me}))}}catch{A("Failed to save info.")}finally{ce("idle")}},T=v=>{const V=f[v.key]??"",fe=v.inputType==="textarea"||v.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:v.label}),fe?e.jsx("textarea",{rows:v.inputType==="json"?8:4,value:V,onChange:Y=>h(F=>({...F,[v.key]:Y.target.value})),placeholder:v.key}):e.jsx("input",{type:"text",value:V,onChange:Y=>h(F=>({...F,[v.key]:Y.target.value})),placeholder:v.key})]},`payload:${v.key}`)},ye=v=>{const V=E[v.key]??v.targetTypes[0];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:v.label}),v.targetTypes.length>1?e.jsx("select",{value:V,onChange:fe=>J(Y=>({...Y,[v.key]:fe.target.value})),children:v.targetTypes.map(fe=>e.jsx("option",{value:fe,children:Ye(t,fe)},`${v.key}:${fe}`))}):null,v.multiple?e.jsx(aa,{libraryId:l,infoType:V,label:v.label,placeholder:v.key,multiple:!0,values:b[v.key]??[],onChangeMultiple:fe=>H(Y=>({...Y,[v.key]:fe})),searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(aa,{libraryId:l,infoType:V,label:v.label,placeholder:v.key,value:ue[v.key]??null,onChange:fe=>P(Y=>({...Y,[v.key]:fe})),searchFailedText:"Search failed",createFailedText:"Create failed"})]},`link:${v.key}`)};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:u?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:o}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${l}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[u?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:W,onChange:v=>_(v.target.value),children:De.map(v=>e.jsx("option",{value:v.value,children:v.label},v.value))})]}),ne==="loading"?e.jsx("p",{children:"Loading..."}):null,re?e.jsxs("div",{className:"cogita-form-grid",children:[re.payloadFields.map(T),re.linkFields.map(ye)]}):e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:me,disabled:ne==="saving"||!re,children:ne==="saving"?"Saving...":u?"Update info":"Create info"})}),$?e.jsx("p",{className:"cogita-library-subtitle",children:$}):null]})})})]})})}const Fs=t=>/\s/.test(t),Ea=t=>/[\p{L}\p{N}]/u.test(t),Ks=(t,s)=>{const n=s>0?t[s-1]:"",i=s<t.length?t[s]:"";if(!n||!i)return 0;const c=Fs(n),y=Fs(i);if(c||y)return 3;const m=Ea(n),p=Ea(i);return m!==p?2:!m&&!p?1:0},ts=(t,s,n,i,c)=>{const y=Math.max(i-s,n-i);for(let m=0;m<=y;m+=1){const p=i-m;if(p>=s&&p<=n&&Ks(t,p)>=c)return p;const R=i+m;if(R>=s&&R<=n&&Ks(t,R)>=c)return R}return null},as=(t,s)=>{const n=s>0?t[s-1]:"",i=s<t.length?t[s]:"";return!n||!i?!0:Ea(n)!==Ea(i)},vi=(t,s,n,i)=>{const c=n-s,y=s+i,m=n-i;if(c<=i*2||m<=y)return null;const p=Math.floor((s+n)/2),R=ts(t,y,m,p,3);if(R!==null&&as(t,R))return R;const L=ts(t,y,m,p,2);if(L!==null&&as(t,L))return L;const l=ts(t,y,m,p,1);return l!==null&&as(t,l)?l:null},sa=(t,s)=>{const n=Math.max(1,7),i=Math.max(n,13),c={},y=(R,L,l,x,o)=>{const u=String(x),S={id:u,start:R,end:L,text:t.slice(R,L),depth:l,index:x,parentId:o};if(c[u]=S,L-R>i){let W=vi(t,R,L,n);if(W!==null&&W>R&&W<L){const _=y(R,W,l+1,x*2+1,u),f=y(W,L,l+1,x*2+2,u);S.leftId=_.id,S.rightId=f.id}}return S},m=y(0,t.length,0,0),p=Object.values(c).sort((R,L)=>L.depth-R.depth||R.start-L.start).map(R=>R.id);return{text:t,rootId:m.id,nodes:c,order:p}},ga=(t,s,n,i,c,y,m)=>{const p=y==="reverse"?t.order.slice().sort((R,L)=>t.nodes[L].start-t.nodes[R].start||t.nodes[L].depth-t.nodes[R].depth):t.order;for(const R of p){if(m&&R===m||s.has(R))continue;const L=t.nodes[R];if(L){if(c&&(L.leftId||L.rightId)){const l=L.leftId?n[L.leftId]??0:i,x=L.rightId?n[L.rightId]??0:i;if((l+x)/2<i)continue}return L}}return null},xs=(t,s)=>({before:t.slice(0,s.start),fragment:t.slice(s.start,s.end),after:t.slice(s.end)});function wi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,libraryId:l}){const x=`/#/cogita/library/${l}`,[o,u,S]=Ws([]),[Q,W,_]=Hs([]),[f,h]=a.useState(null),[ue,P]=a.useState(null),[b,H]=a.useState(null),[E,J]=a.useState(null),$=a.useMemo(()=>o.find(T=>T.id===f)??null,[o,f]);a.useEffect(()=>{let T=!0;return Sn({libraryId:l}).then(ye=>{if(!T)return;const v=ye.nodes.map(V=>{var fe,Y,F;return{id:V.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:V.payload&&typeof V.payload=="object"&&"label"in V.payload?String(V.payload.label):"Item",nodeType:V.nodeType,itemType:((fe=V.payload)==null?void 0:fe.itemType)??"info",itemId:((Y=V.payload)==null?void 0:Y.itemId)??null,infoType:((F=V.payload)==null?void 0:F.infoType)??null}}});u(v),W(ye.edges.map(V=>({id:V.edgeId,source:V.fromNodeId,target:V.toNodeId})))}).catch(()=>{T&&(u([]),W([]))}),()=>{T=!1}},[l]),a.useEffect(()=>{Tn({libraryId:l}).then(P).catch(()=>P(null))},[l,o,Q]);const A=a.useCallback(T=>{W(ye=>Qs(T,ye))},[]),ne=()=>{const T=crypto.randomUUID();u(ye=>[...ye,{id:T,type:"default",position:{x:140+ye.length*40,y:120+ye.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},ce=()=>{const T=crypto.randomUUID();u(ye=>[...ye,{id:T,type:"default",position:{x:180+ye.length*40,y:160+ye.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},re=async()=>{H(null);try{const T=o.map(v=>({nodeId:v.id,nodeType:v.data.nodeType,payload:{itemType:v.data.itemType,itemId:v.data.itemId??null,label:v.data.label,infoType:v.data.infoType??null}})),ye=Q.map(v=>({edgeId:v.id,fromNodeId:v.source,toNodeId:v.target}));await Cn({libraryId:l,nodes:T,edges:ye}),H(t.cogita.library.graph.saveSuccess)}catch{H(t.cogita.library.graph.saveFail)}},De=T=>{$&&u(ye=>ye.map(v=>v.id===$.id?{...v,data:{...v.data,itemId:(T==null?void 0:T.infoId)??null,itemType:"collection",infoType:"collection",label:(T==null?void 0:T.label)??t.cogita.library.infoTypes.collection}}:v))},me=T=>{$&&u(ye=>ye.map(v=>v.id===$.id?{...v,data:{...v.data,itemId:(T==null?void 0:T.infoId)??null,itemType:"info",infoType:(T==null?void 0:T.infoType)??null,label:(T==null?void 0:T.label)??t.cogita.library.infoTypes.any}}:v))};return a.useEffect(()=>{if(!$||$.data.nodeType!=="info"||$.data.infoType!=="citation"||!$.data.itemId){J(null);return}let T=!0;return Yt({libraryId:l,infoId:$.data.itemId}).then(ye=>{if(!T)return;const v=ye.payload,V=(v==null?void 0:v.text)??"";if(!V){J(null);return}const fe=sa(V),Y=Object.values(fe.nodes).sort((F,ve)=>F.depth-ve.depth||F.start-ve.start).map(F=>({id:F.id,text:F.text,depth:F.depth}));J({title:(v==null?void 0:v.title)??$.data.label,fragments:Y})}).catch(()=>J(null)),()=>{T=!1}},[l,$]),e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:x,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:re,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ne,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ce,children:t.cogita.library.actions.addInfo}),ue?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(ue.totalCollections))})}):null,b?e.jsx("p",{className:"cogita-help",children:b}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(ms,{nodes:o,edges:Q,onNodesChange:S,onEdgesChange:_,onConnect:A,onNodeClick:(T,ye)=>h(ye.id),fitView:!0,children:[e.jsx(ps,{gap:18,size:1}),e.jsx(fs,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),$?e.jsxs("div",{className:"cogita-graph-inspector",children:[$.data.nodeType==="collection"?e.jsx(aa,{libraryId:l,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:$.data.itemId?{id:$.data.itemId,label:$.data.label,infoType:"collection"}:null,onChange:De,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(aa,{libraryId:l,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:$.data.itemId?{id:$.data.itemId,label:$.data.label,infoType:$.data.infoType??void 0}:null,onChange:me,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),E?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:E.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:E.fragments.map(T=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:T.id}),e.jsx("span",{children:T.text})]},T.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function ji({children:t,flashState:s,flashTick:n=0,className:i}){const c=s?`${s}-${n}`:"idle";return e.jsx("section",{className:i?`cogita-revision-card ${i}`:"cogita-revision-card","data-feedback":c,children:t})}function vs({copy:t,currentCard:s,currentTypeLabel:n,prompt:i,languages:c,answer:y,onAnswerChange:m,computedExpected:p,computedAnswers:R,onComputedAnswerChange:L,answerTemplate:l,outputVariables:x,variableValues:o,computedFieldFeedback:u,feedback:S,canAdvance:Q,quoteContext:W,quotePlaceholder:_,onCheckAnswer:f,onSkip:h,onLanguageSelect:ue,onMarkReviewed:P,onAdvance:b,showCorrectAnswer:H,setShowCorrectAnswer:E,onRevealCorrect:J,answerMask:$,expectedAnswer:A,hasExpectedAnswer:ne,handleComputedKeyDown:ce,answerInputRef:re,computedInputRefs:De,scriptMode:me,setScriptMode:T,matchPairs:ye,matchLeftOrder:v,matchRightOrder:V,matchSelection:fe,matchActiveLeft:Y,matchActiveRight:F,matchFeedback:ve,onMatchLeftSelect:Me,onMatchRightSelect:Te,disableCheckAnswer:Ke=!1,hideSkipAction:Ie=!1}){const _e=a.useMemo(()=>{var M;const te=!l&&p.length===2?`The {${p[0].key}} is of type {${p[1].key}}`:null,Se=l??te;if(!Se)return null;const G=new Map(p.map(se=>[se.key,se.expected])),de=new Set,ze=[],Je=/\{([^}]+)\}/g;let Ve=0,O,oe=null;for(;(O=Je.exec(Se))!==null;){const se=Se.slice(Ve,O.index);se&&ze.push({type:"text",value:se});const le=((M=O[1])==null?void 0:M.trim())??"",ee=le&&G.has(le)?le:le&&x&&x[le]?x[le]:null;le&&de.add(le),ee&&de.add(ee),ee&&G.has(ee)?(ze.push({type:"input",value:ee}),oe||(oe=ee)):le&&o&&o[le]!==void 0?ze.push({type:"text",value:o[le]}):ze.push({type:"text",value:O[0]}),Ve=O.index+O[0].length}const Pe=Se.slice(Ve);return Pe&&ze.push({type:"text",value:Pe}),p.filter(se=>!de.has(se.key)).length>0?null:{parts:ze,expectedByKey:G,firstInputKey:oe}},[l,p,x,o]),Be=()=>{if(!_e)return null;const{parts:te,expectedByKey:Se,firstInputKey:G}=_e;return e.jsx("div",{className:"cogita-revision-inline-answer",children:te.map((de,ze)=>{var Je,Ve;return de.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:de.value},`text-${ze}`):e.jsx("input",{ref:O=>{De.current[de.value]=O},autoFocus:de.value===G,value:R[de.value]??"",onChange:O=>L(de.value,O.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":u[de.value]??(S==="correct"?"correct":S==="incorrect"?"incorrect":void 0),onKeyDown:O=>Ge(O)||ce(O),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((Je=R[de.value])==null?void 0:Je.length)??0,((Ve=Se.get(de.value))==null?void 0:Ve.length)??6)}ch`}},`input-${de.value}-${ze}`)})})},Le=a.useMemo(()=>{const te=new Map;return(ye??[]).forEach(Se=>te.set(Se.leftId,Se)),te},[ye]),qe=a.useMemo(()=>{const te=new Map;return(ye??[]).forEach(Se=>te.set(Se.rightId,Se)),te},[ye]);a.useEffect(()=>{var ze;if(s.cardType!=="info"||s.infoType!=="computed"||p.length===0)return;const te=typeof document<"u"?document.activeElement:null;if(te&&(te.tagName==="INPUT"||te.tagName==="TEXTAREA"))return;const Se=(_e==null?void 0:_e.firstInputKey)??((ze=p[0])==null?void 0:ze.key);if(!Se)return;const G=De.current[Se];if(!G)return;const de=requestAnimationFrame(()=>{G.focus()});return()=>cancelAnimationFrame(de)},[s,p,_e]);const et=(()=>{const te=[A??"",...p.map(de=>de.expected??"")].join(""),Se=[y,...Object.values(R)].join(""),G=`${te}${Se}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(G)})(),Ge=te=>te.ctrlKey&&(te.key==="^"||te.key==="6")?(te.preventDefault(),T(Se=>Se==="super"?null:"super"),!0):te.ctrlKey&&(te.key==="_"||te.key==="-")?(te.preventDefault(),T(Se=>Se==="sub"?null:"sub"),!0):!1,Ae=()=>{if(!A||!$)return A??"";const te=A.split(""),Se=Array.from($),G=Se.length>0?Se.reduce((de,ze)=>de+ze,0)/Se.length:127;return te.map((de,ze)=>{const Je=Se[ze]??G,Ve=Math.max(0,Math.min(255,Math.round(Je)));let O=255,oe=0;return Ve<=127?oe=Math.round(Ve/127*255):(oe=255,O=Math.round(255*(1-(Ve-127)/128))),e.jsx("span",{style:{color:`rgb(${O}, ${oe}, 0)`},children:de},`mask-${ze}`)})},xe=s.cardType==="info"&&s.infoType==="citation"?(W==null?void 0:W.title)||s.label:s.description;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[n?e.jsx("span",{children:n}):null,e.jsx("strong",{children:xe})]}),s.cardType==="vocab"&&s.checkType==="translation-match"&&ye?e.jsxs("div",{className:"cogita-revision-body",children:[i?e.jsx("h2",{children:i}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(v??[]).map(te=>{const Se=Le.get(te);if(!Se)return null;const G=(fe==null?void 0:fe[te])??null,de=(ve==null?void 0:ve[te])??null,ze=Y===te;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":ze,"data-state":de??void 0,"data-locked":G?"true":void 0,onClick:()=>Me==null?void 0:Me(te),children:[e.jsx("span",{children:Se.leftLabel}),G&&H?e.jsx("em",{children:"✓"}):null]},te)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(V??[]).map(te=>{const Se=qe.get(te);if(!Se)return null;const G=Object.values(fe??{}).includes(te),de=F===te;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":G||de,"data-locked":G?"true":void 0,onClick:()=>Te==null?void 0:Te(te),children:e.jsx("span",{children:Se.rightLabel})},te)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:f,disabled:s.checkType==="translation-match"||Ke,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):s.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:re,value:y,onChange:te=>m(te.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":S==="correct"?"correct":S==="incorrect"?"incorrect":void 0,onKeyDown:te=>{if(te.key==="Enter")if(te.preventDefault(),te.stopPropagation(),Q)b();else{if(Ke)return;f()}}})]}),et?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":me==="super",onClick:()=>T(te=>te==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":me==="sub",onClick:()=>T(te=>te==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:f,disabled:Ke,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[s.label?e.jsx("p",{className:"cogita-revision-hint",children:s.label}):null,l?null:e.jsx(Mn,{value:i??"",mode:"auto"}),p.length>0?(()=>{const te=Be();return te?e.jsx("div",{className:"cogita-inline-answer-wrap",children:te}):e.jsx("div",{className:"cogita-form-grid",children:p.map((Se,G)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:Se.key}),e.jsx("textarea",{ref:de=>{De.current[Se.key]=de},autoFocus:G===0,value:R[Se.key]??"",onChange:de=>L(Se.key,de.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":u[Se.key]??(S==="correct"?"correct":S==="incorrect"?"incorrect":void 0),onKeyDown:de=>Ge(de)||ce(de)})]},Se.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:re,value:y,onChange:te=>m(te.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":S==="correct"?"correct":S==="incorrect"?"incorrect":void 0,onKeyDown:te=>{if(!Ge(te)&&te.key==="Enter")if(te.preventDefault(),te.stopPropagation(),Q)b();else{if(Ke)return;f()}}})]})}),et?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":me==="super",onClick:()=>T(te=>te==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":me==="sub",onClick:()=>T(te=>te==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:f,disabled:Ke,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="citation"&&W?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(W.completed)).replace("{total}",String(W.total))}),e.jsx("p",{className:"cogita-quote-text",children:W.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:re,value:y,onChange:te=>m(te.target.value),placeholder:_??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":S==="correct"?"correct":S==="incorrect"?"incorrect":void 0,onKeyDown:te=>{if(te.key==="Enter")if(te.preventDefault(),te.stopPropagation(),Q)b();else{if(Ke)return;f()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:W.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:f,disabled:Ke,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:c.length?c.map(te=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>ue(te.label),children:te.label},te.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:P,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}),S&&e.jsx("div",{className:"cogita-revision-feedback","data-state":S,children:S==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),S==="incorrect"&&ne?e.jsxs("div",{className:"cogita-revision-reveal",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>E(te=>{const Se=!te;return Se&&J(),Se}),children:t.cogita.library.revision.showAnswer}),H?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),p.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[p.map(te=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:te.key}),e.jsx("span",{children:te.expected})]},te.key)),A?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:A})]}):null]}):e.jsx("p",{children:$?Ae():A})]}):null]}):null,Q?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:b,children:t.cogita.library.revision.nextQuestion})}):null]})}const zs={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},ki=(t,s)=>{const n=Math.max(t.length,s.length,1),i=Math.abs(t.length-s.length);return Math.max(0,1-i/n)},Ni=(t,s)=>{const n=new Uint8Array(t.length),i=ki(t,s);for(let c=0;c<t.length;c+=1){const y=t[c]===(s[c]??"")?128:0,m=t.length-1-c,p=s.length-1-c,R=t[m]===(s[p]??"")?127:0,L=Math.round((y+R)*i);n[c]=Math.max(0,Math.min(255,L))}return n},Si=(t,s)=>t===s||(zs[t]??[]).includes(s)?!0:(zs[s]??[]).includes(t),Ia=(t,s,n)=>n?Si(t,s):t===s,Aa=(t,s,n)=>{const i=new Uint8Array(t.length);if(!t.length)return i;const c=(n==null?void 0:n.allowSimilarChars)??!0,y=[];for(let p=0;p<=t.length-3;p+=1)y.push({index:p,text:t.slice(p,p+3)});let m=!1;return y.forEach(p=>{for(let R=0;R<=s.length-3;R+=1){const L=s.slice(R,R+3);let l=0;for(let Q=0;Q<3;Q+=1)Ia(p.text[Q],L[Q],c)&&(l+=1);if(l<2)continue;let x=p.index-1,o=R-1;for(;x>=0&&o>=0;){const Q=t[x],W=s[o];if(Q===W){i[x]=Math.max(i[x],255),x-=1,o-=1,m=!0;continue}if(Ia(Q,W,c)&&Q!==W){i[x]=Math.max(i[x],127),x-=1,o-=1,m=!0;continue}if(x>0&&t[x-1]===W){i[x]=Math.max(i[x],0),x-=1,m=!0;continue}if(o>0&&t[x]===s[o-1]){o-=1,m=!0;continue}break}for(let Q=0;Q<3;Q+=1){const W=p.index+Q,_=p.text[Q],f=L[Q],h=_===f?255:Ia(_,f,c)?127:0;i[W]=Math.max(i[W],h),m=!0}let u=p.index+3,S=R+3;for(;u<t.length&&S<s.length;){const Q=t[u],W=s[S];if(Q===W){i[u]=Math.max(i[u],255),u+=1,S+=1,m=!0;continue}if(Ia(Q,W,c)&&Q!==W){i[u]=Math.max(i[u],127),u+=1,S+=1,m=!0;continue}if(u+1<t.length&&t[u+1]===W){i[u]=Math.max(i[u],0),u+=1,m=!0;continue}if(S+1<s.length&&t[u]===s[S+1]){S+=1,m=!0;continue}break}}}),m?i:Ni(t,s)},ss=t=>/[\p{L}\p{N}]/u.test(t),Bs=t=>t.trim().toLowerCase(),Ds=t=>{if(t.length===0)return 100;const s=Array.from(t).reduce((n,i)=>n+i,0);return Math.round(s/(t.length*255)*100)},Pa=(t,s,n)=>{const i=Math.max(0,Math.min(100,(n==null?void 0:n.thresholdPercent)??100)),c=(n==null?void 0:n.treatSimilarCharsAsSame)??!0,y=(n==null?void 0:n.ignorePunctuationAndSpacing)??!1,m=Bs(t),p=Bs(s);if(!y){const f=Aa(m,p,{allowSimilarChars:c}),h=Ds(f);return{mask:f,percent:h,isCorrect:h>=i,normalizedExpected:m,normalizedAnswer:p}}const R=Array.from(m),L=Array.from(p),l=[],x=[],o=[];R.forEach((f,h)=>{ss(f)&&(l.push(f),x.push(h))}),L.forEach(f=>{ss(f)&&o.push(f)});const u=l.join(""),S=o.join(""),Q=Aa(u,S,{allowSimilarChars:c}),W=new Uint8Array(R.length);for(let f=0;f<W.length;f+=1)W[f]=ss(R[f]??"")?0:255;for(let f=0;f<Q.length;f+=1){const h=x[f];h!==void 0&&(W[h]=Q[f])}const _=Ds(Q);return{mask:W,percent:_,isCorrect:_>=i,normalizedExpected:u,normalizedAnswer:S}},ma=(t,s,n)=>{const i=t.trim().toLowerCase(),c=s.trim().toLowerCase();return n==="prefix"||n==="bidirectional"?Aa(i,c,{allowSimilarChars:!0}):Aa(i,c,{allowSimilarChars:!0})};function _t(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function _s(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function Vs(t){const s=t.checkType??"info";return t.direction?`${s} / ${t.direction}`:s}function Ti({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,libraryId:l,infoId:x,selectedReviewerRoleId:o}){const[u,S]=a.useState(x),[Q,W]=a.useState([]),[_,f]=a.useState([]),[h,ue]=a.useState("loading"),[P,b]=a.useState(null),[H,E]=a.useState(null),[J,$]=a.useState(null),[A,ne]=a.useState(null),[ce,re]=a.useState(""),[De,me]=a.useState(null),[T,ye]=a.useState(1),[v,V]=a.useState(null),[fe,Y]=a.useState(0),[F,ve]=a.useState(!1),[Me,Te]=a.useState(null),[Ke,Ie]=a.useState({}),[_e,Be]=a.useState({}),[Le]=a.useState({}),[qe,et]=a.useState(null),Ge=a.useRef(null),Ae=a.useRef({});a.useEffect(()=>{let k=!1;return ue("loading"),Promise.all([Yt({libraryId:l,infoId:x}).catch(()=>null),Zs({libraryId:l,infoId:x}),en({libraryId:l,infoId:x})]).then(([M,se,le])=>{if(k)return;const ee=(M==null?void 0:M.payload)??{},$e=typeof ee.title=="string"&&ee.title||typeof ee.label=="string"&&ee.label||typeof ee.name=="string"&&ee.name||x;S($e),E(ee),$((M==null?void 0:M.infoType)??null),W(se.items),f(le.items),ue("ready")}).catch(()=>{k||(E(null),$(null),W([]),f([]),ue("error"))}),()=>{k=!0}},[l,x]),a.useEffect(()=>{if(J!=="translation"){ne(null);return}tn({libraryId:l,infoId:x,approachKey:"vocab-card"}).then(k=>ne(k.projection??null)).catch(()=>ne(null))},[J,x,l]);const xe=a.useMemo(()=>{var Re;const k=new Map(Q.map(we=>[_t(we),we])),M=new Map,se=new Map;for(const we of Q)M.set(_t(we),0),se.set(_t(we),[]);for(const we of _){const be=_s({parentItemId:we.parentItemId,parentCheckType:we.parentCheckType,parentDirection:we.parentDirection}),je=[we.childItemId,we.childCheckType??"",we.childDirection??""].join("|");!k.has(be)||!k.has(je)||((Re=se.get(be))==null||Re.push(je),M.set(je,(M.get(je)??0)+1))}const le=Array.from(M.entries()).filter(([,we])=>we===0).map(([we])=>we),ee=new Map;for(const we of le)ee.set(we,0);for(;le.length;){const we=le.shift(),be=ee.get(we)??0;for(const je of se.get(we)??[]){const ke=Math.max(ee.get(je)??0,be+1);ee.set(je,ke),M.set(je,(M.get(je)??1)-1),(M.get(je)??0)<=0&&le.push(je)}}const $e=new Map;for(const we of Q){const be=_t(we),je=ee.get(be)??0,ke=$e.get(je)??[];ke.push(be),$e.set(je,ke)}return Q.map(we=>{const be=_t(we),je=ee.get(be)??0,ke=$e.get(je)??[be],ot=Math.max(0,ke.indexOf(be));return{id:be,position:{x:40+ot*290+(je%2?18:0),y:30+je*120},draggable:!1,selectable:!0,data:{label:we.label,subtitle:Vs(we),checkType:we.checkType??"info",direction:we.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[Q,_]),te=a.useMemo(()=>new Map(Q.map(k=>[_t(k),k])),[Q]),Se=a.useMemo(()=>{const k=[];for(const M of _){const se=_s({parentItemId:M.parentItemId,parentCheckType:M.parentCheckType,parentDirection:M.parentDirection}),le=[M.childItemId,M.childCheckType??"",M.childDirection??""].join("|");!te.has(se)||!te.has(le)||k.push({id:`${se}->${le}`,source:se,target:le,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return k},[te,_]),G=a.useMemo(()=>P?te.get(P)??null:null,[te,P]);a.useEffect(()=>{re(""),V(null),Y(0),ve(!1),Te(null),me(null),Be({})},[P]);const de=a.useMemo(()=>{var ee,$e;if(!G)return null;const k=J??G.infoType??null,M=G.checkType??"info",se=G.direction??null,le=H??{};if(G.cardType==="vocab"&&A&&Array.isArray(A.words)){const Re=A.words,we=((ee=Re[0])==null?void 0:ee.label)??"?",be=(($e=Re[1])==null?void 0:$e.label)??"?";return se==="a-to-b"?{kind:"vocab",prompt:String(we),expected:String(be)}:se==="b-to-a"?{kind:"vocab",prompt:String(be),expected:String(we)}:{kind:"generic",prompt:`${we} ↔ ${be}`,expected:`${we} ↔ ${be}`}}if(k==="citation"&&M==="quote-fragment"&&se&&typeof le.text=="string"){const Re=se,we=sa(le.text),be=we.nodes[Re];if(be){const je=xs(le.text,be);return{kind:"citation-fragment",expected:be.text,quoteContext:{title:u,before:je.before,after:je.after,total:Object.keys(we.nodes).length,completed:0},quotePlaceholder:be.text.length>0?".".repeat(Math.max(4,Math.min(18,be.text.length))):"..."}}}return{kind:"generic",prompt:G.description||G.label,expected:G.label}},[J,H,G,u,A]),ze=async k=>{if(G&&o)try{await In({libraryId:l,outcome:{itemType:"info",itemId:G.cardId,checkType:G.checkType??"info",direction:G.direction??null,revisionType:"direct",evalType:"direct-check",correct:k,clientId:"cogita-info-checkcards",clientSequence:T,personRoleId:o}}),ye(M=>M+1),me(k?"Saved as correct.":"Saved as incorrect.")}catch{me("Failed to save answer.")}},Je=G?_t(G):null,Ve=Je?!!Ke[Je]:!1,O=async()=>{if(!G||!de)return;const k=_t(G);if(Ke[k]){me("This card was already checked.");return}const M=de.expected,se=de.kind==="citation-fragment",le=Pa(M,ce,{thresholdPercent:se?90:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:se}),ee=le.isCorrect;V(ee?"correct":"incorrect"),Y($e=>$e+1),Te(le.mask),ve(!0),me(o?null:"Answer checked locally (not saved: no person selected)."),Ie($e=>({...$e,[k]:!0})),o&&await ze(ee)},oe=()=>{if(!G||!de)return;const k=_t(G);Ke[k]||(Ie(se=>({...se,[k]:!0})),me("Answer revealed (not saved)."));const M=Pa(de.expected,de.expected,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:de.kind==="citation-fragment"});Te(M.mask)},Pe=a.useMemo(()=>G?G.infoType==="citation"?{...G,description:u}:{...G,description:G.label}:null,[G,u]);return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.infoTypes.citation}),e.jsx("h2",{className:"cogita-card-title",children:u}),e.jsx("p",{className:"cogita-card-subtitle",children:x})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${Q.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${_.length}`})]})]}),h==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):h==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(ms,{nodes:xe,edges:Se,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:(k,M)=>b(M.id),panOnDrag:!0,children:[e.jsx(ps,{}),e.jsx(fs,{showInteractive:!1})]})}),G?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[de&&Pe?e.jsx(ji,{flashState:v,flashTick:fe,children:e.jsx(vs,{copy:t,currentCard:Pe,currentTypeLabel:"",prompt:de.kind==="citation-fragment"?null:de.prompt,languages:[],answer:ce,onAnswerChange:re,computedExpected:[],computedAnswers:_e,onComputedAnswerChange:(k,M)=>Be(se=>({...se,[k]:M})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:Le,feedback:v,canAdvance:!1,quoteContext:de.kind==="citation-fragment"?de.quoteContext:null,quotePlaceholder:de.kind==="citation-fragment"?de.quotePlaceholder:null,onCheckAnswer:()=>void O(),onSkip:()=>b(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:F,setShowCorrectAnswer:ve,onRevealCorrect:oe,answerMask:Me,expectedAnswer:de.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:Ge,computedInputRefs:Ae,scriptMode:qe,setScriptMode:et,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:Ve||F,hideSkipAction:!0})}):null,o?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),De?e.jsx("p",{className:"cogita-library-hint",children:De}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:Q.map(k=>{const M=_t(k),se=P===M;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${se?"active":""}`,onClick:()=>b(M),children:[e.jsx("span",{children:k.label}),e.jsx("small",{children:Vs(k)})]},M)})})]})]})]})})})})})}function Ci({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,libraryId:l,collectionId:x}){const{libraryName:o}=Wt(l),[u,S]=a.useState([]),[Q,W]=a.useState("loading"),[_,f]=a.useState("idle"),h=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),ue=`/#/cogita/library/${l}`,P=()=>{W("loading"),sn({libraryId:l}).then(E=>{S(E),W("idle")}).catch(()=>{S([]),W("error")})};a.useEffect(()=>{P()},[l]);const b=async E=>{try{await nn({libraryId:l,shareId:E}),P()}catch{P()}},H=async E=>{const J=`${h}/${E}`;try{await navigator.clipboard.writeText(J),f("copied")}catch{f("failed")}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:o}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:ue,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${ue}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Q==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):Q==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):u.filter(E=>!x||E.collectionId===x).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:u.filter(E=>!x||E.collectionId===x).map(E=>e.jsxs("div",{className:"cogita-share-row","data-state":E.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:E.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(E.createdUtc).toLocaleString(),E.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),E.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${h}/${E.shareCode}`}):null]}),E.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[E.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>H(E.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>b(E.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},E.shareId))}),_==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):_==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function Mi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,libraryId:l}){const{libraryName:x}=Wt(l),[o,u]=a.useState(null),[S,Q]=a.useState(null),[W,_]=a.useState(null),[f,h]=a.useState(null),[ue,P]=a.useState(null),[b,H]=a.useState(null),E=a.useRef(null),J=ne=>{if(!Number.isFinite(ne))return"0 B";if(ne<1024)return`${ne} B`;const ce=ne/1024;if(ce<1024)return`${ce.toFixed(1)} KB`;const re=ce/1024;return re<1024?`${re.toFixed(1)} MB`:`${(re/1024).toFixed(1)} GB`},$=async()=>{u(null),P({loadedBytes:0,totalBytes:null,percent:null});try{u(t.cogita.library.overview.exporting);const ne=await Ln(l,P),ce=URL.createObjectURL(ne),re=document.createElement("a");re.href=ce,re.download=`cogita-library-${x||l}.json`,re.click(),URL.revokeObjectURL(ce),u(t.cogita.library.overview.exportReady)}catch{u(t.cogita.library.overview.exportFail)}finally{P(ne=>ne??{loadedBytes:0,totalBytes:null,percent:null})}},A=async ne=>{var re;Q(null),_(null),h(null);const ce=(re=ne.target.files)==null?void 0:re[0];if(ce)try{Q(t.cogita.library.overview.importing),H({loadedBytes:0,totalBytes:ce.size,percent:0});const De=await $n(l,ce,H,me=>{const T=me.stage==="infos"?t.cogita.library.overview.importStageInfos:me.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;h(t.cogita.library.overview.importLiveProgress.replace("{stage}",T).replace("{done}",String(me.processed)).replace("{total}",String(me.total)).replace("{infos}",String(me.infos)).replace("{connections}",String(me.connections)).replace("{collections}",String(me.collections)))});_({infos:De.infosImported,connections:De.connectionsImported,collections:De.collectionsImported}),Q(t.cogita.library.overview.importDone)}catch(De){const me=De instanceof Rn&&De.message?` ${De.message}`:"";Q(`${t.cogita.library.overview.importFail}${me}`)}finally{E.current&&(E.current.value="")}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:$,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:E,type:"file",accept:"application/json",onChange:A})]})]}),ue?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:ue.percent??void 0,max:ue.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",J(ue.loadedBytes)).replace("{total}",ue.totalBytes?J(ue.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,b?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:b.percent??void 0,max:b.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",J(b.loadedBytes)).replace("{total}",b.totalBytes?J(b.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,o?e.jsx("p",{className:"cogita-help",children:o}):null,S?e.jsx("p",{className:"cogita-help",children:S}):null,f?e.jsx("p",{className:"cogita-help",children:f}):null,W?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(W.infos)).replace("{connections}",String(W.connections)).replace("{collections}",String(W.collections))}):null]})]})})})]})})}function Ii({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,libraryId:l}){const{libraryName:x}=Wt(l),[o,u]=a.useState(""),[S,Q]=a.useState([]),W=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:o,onChange:_=>u(_.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const _=o.trim();_&&(Q(f=>[{id:W(),name:_},...f]),u(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[S.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,S.map(_=>e.jsx("button",{type:"button",className:"ghost",children:_.name},_.id))]})]})]})})})]})})}function Li({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,libraryId:l}){const{libraryName:x}=Wt(l),[o,u]=a.useState(""),[S,Q]=a.useState([]),W=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:o,onChange:_=>u(_.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const _=o.trim();_&&(Q(f=>[{id:W(),name:_},...f]),u(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[S.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,S.map(_=>e.jsx("button",{type:"button",className:"ghost",children:_.name},_.id))]})]})]})})})]})})}function Os({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,libraryId:l}){const{libraryName:x}=Wt(l),o=`/#/cogita/library/${l}`,[u,S]=a.useState(""),[Q,W]=a.useState([]),[_,f]=a.useState("idle"),[h,ue]=a.useState(0),[P,b]=a.useState(null);a.useEffect(()=>{f("loading");const E=window.setTimeout(()=>{wa({libraryId:l,query:u.trim()||void 0,limit:30}).then(J=>{W(J.items),ue(J.total),b(J.nextCursor??null),f("ready")}).catch(()=>{W([]),ue(0),b(null),f("ready")})},240);return()=>window.clearTimeout(E)},[l,u]);const H=async()=>{if(P){f("loading");try{const E=await wa({libraryId:l,query:u.trim()||void 0,limit:30,cursor:P});W(J=>[...J,...E.items]),b(E.nextCursor??null),ue(E.total),f("ready")}catch{f("ready")}}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:o,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${o}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:u,onChange:E=>S(E.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(Q.length)).replace("{total}",String(h||Q.length))}),e.jsx("span",{children:_==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:Q.length?Q.map(E=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${o}/collections/${E.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:E.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(E.itemCount))," ·"," ",E.notes||t.cogita.library.collections.noNotes]})]})},E.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${o}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),P?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:H,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const he=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,Vt=(t,s,n,i)=>`${t}:${s}:${n??""}:${i??""}`;function $i({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,libraryId:l,collectionId:x}){Wt(l);const o=`/#/cogita/library/${l}`,[u,S]=a.useState(t.cogita.library.collections.defaultName),[Q,W]=a.useState(null),[_,f]=a.useState(0),[h,ue]=a.useState([]),[P,b]=a.useState("idle"),[H,E]=a.useState(null),J=a.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(h.length)).replace("{total}",String(_||h.length)),[t,h.length,_]);a.useEffect(()=>{Oa(l,x).then(A=>{S(A.name),W(A.notes??null),f(A.itemCount)}).catch(()=>{S(t.cogita.library.collections.defaultName),W(null)})},[l,x]),a.useEffect(()=>{b("loading"),$a({libraryId:l,collectionId:x,limit:40}).then(A=>{ue(A.items),E(A.nextCursor??null),f(A.total),b("ready")}).catch(()=>{ue([]),E(null),b("ready")})},[l,x]);const $=async()=>{if(H){b("loading");try{const A=await $a({libraryId:l,collectionId:x,limit:40,cursor:H});ue(ne=>[...ne,...A.items]),E(A.nextCursor??null),f(A.total),b("ready")}catch{b("ready")}}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:u}),e.jsx("p",{className:"cogita-library-subtitle",children:Q||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:o,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${o}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${o}/collections/${x}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${o}/collections/${x}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:J}),e.jsx("span",{children:P==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:h.length?h.map(A=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:A.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:A.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:A.label}),e.jsx("p",{className:"cogita-card-subtitle",children:A.description})]})},he(A))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),H?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:$,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${o}/collections/${x}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const Ot=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const s=t.length,n=t.filter(y=>y.correct).length,i=qa(ws(t));return{score:Math.round(Math.max(0,Math.min(100,i.knowness*100))*100)/100,total:s,correct:n,lastReviewedUtc:i.lastReviewedUtc??null}},Ri=t=>{if(t.maskBase64)try{const s=En(t.maskBase64);if(!s.length)return t.correct?1:0;const n=s.reduce((i,c)=>i+c,0);return Math.max(0,Math.min(1,n/s.length/255))}catch{return t.correct?1:0}return t.correct?1:0},ws=t=>t.map(s=>({correctness:Ri(s),createdUtc:s.createdUtc})),qa=(t,s=Date.now())=>{var _;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const i=t.slice().sort((f,h)=>f.createdUtc.localeCompare(h.createdUtc)).slice(-5),c=i.reduce((f,h)=>f+h.correctness,0)/i.length,y=5,m=2,p=.15;let R=0,L=0;for(let f=0;f<i.length;f+=1){const h=new Date(i[f].createdUtc).getTime(),ue=f===i.length-1?s:new Date(i[f+1].createdUtc).getTime(),P=Math.max(0,(ue-h)/(1e3*60)),b=1-Math.exp(-P/y);R+=b,i[f].correctness>.5&&(L+=p)}let l=c*R*m+L;const x=((_=i[i.length-1])==null?void 0:_.createdUtc)??null,o=x?Math.max(0,(s-new Date(x).getTime())/(1e3*60)):0,S=1/(1+Math.log1p(o/60));return l*=S,i.length===1&&i[0].correctness>.5&&(l+=5.44*Math.exp(-o/2)),{knowness:l,avgCorrectness:c,lastReviewedUtc:x}},ja=t=>{const s=t.slice();for(let n=s.length-1;n>0;n-=1){const i=Math.floor(Math.random()*(n+1));[s[n],s[i]]=[s[i],s[n]]}return s},La=t=>t[Math.floor(Math.random()*t.length)],Ei=(t,s)=>{const n=new Map;return t.forEach(i=>n.set(i,Math.random())),t.sort((i,c)=>{const y=s(i)-s(c);return y!==0?y:(n.get(i)??0)-(n.get(c)??0)})},Ua=(t,s,n,i,c)=>{if(!t.length)return null;const y=t.filter(p=>!(c!=null&&c.has(he(p))));if(y.length===0)return null;const m=y.filter(p=>he(p)!==n);return La(m.length?m:y)},Ai=(t,s,n,i,c)=>{if(!t.length)return null;let y=Number.POSITIVE_INFINITY;for(const L of t){const l=he(L);if(n.has(l))continue;const x=s[l]??1;x<y&&(y=x)}if(!Number.isFinite(y))return null;const m=t.filter(L=>{const l=he(L);return!n.has(l)&&(s[l]??1)===y}),p=m.filter(L=>!c||he(L)!==c),R=i?p.filter(L=>!i.has(he(L))):p;return R.length>0?La(R):p.length>0?La(p):c&&m.some(L=>he(L)===c)?m.find(L=>he(L)===c)??null:m.length?La(m):null},ln=(t,s,n,i,c)=>{const y=[],m=t.filter(R=>!c.has(he(R))&&!n.has(he(R))&&(s[he(R)]??0)<1),p=Ei(m,R=>s[he(R)]??0);for(const R of p){if(y.length>=i)break;y.push(R),c.add(he(R))}if(y.length<i){const R=ja(t.filter(L=>!c.has(he(L))&&n.has(he(L))));for(const L of R){if(y.length>=i)break;y.push(L),c.add(he(L))}}return y},Pi=(t,s,n,i)=>ln(t,s,n,i,new Set),js=(t,s,n,i,c,y)=>{const m=Math.max(1,n.stackSize??s),R=ja(t).filter((S,Q,W)=>W.findIndex(_=>he(_)===he(S))===Q),L=Pi(R,i,c,m),l=new Set,x=new Set,o=Ua(L,{},null,l,x),u=o?[o]:[];return o&&x.add(he(o)),{queue:u,meta:{pool:R,active:L,knownessMap:i,unknownSet:c,outcomesById:y,asked:l,queued:x}}},hs={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,s)=>{const i=ja(t).filter((c,y,m)=>m.findIndex(p=>he(p)===he(c))===y);return{queue:i.slice(0,Math.min(s,i.length)),meta:{}}},applyOutcome:t=>t},ks=(t,s,n,i)=>{const c=Math.max(1,n.stackSize??s),m=ja(t).filter((Q,W,_)=>_.findIndex(f=>he(f)===he(Q))===W),p={},R=new Set,L=new Set,l=new Set,x=Math.max(1,n.levels??1);m.forEach(Q=>{const W=he(Q),_=i==null?void 0:i[W],f=typeof _=="number"&&Number.isFinite(_)?_:1;p[W]=Math.min(x,Math.max(1,Math.round(f)))});const o=[];if(m.length>0){const Q=new Map;m.forEach(_=>{var h;const f=p[he(_)]??1;Q.has(f)||Q.set(f,[]),(h=Q.get(f))==null||h.push(_)});const W=Array.from(Q.keys()).sort((_,f)=>_-f);for(const _ of W){if(o.length>=c)break;const f=ja(Q.get(_)??[]);for(const h of f){if(o.length>=c)break;o.push(h)}}}const u=Ua(o,p,null,R,L),S=u?[u]:[];return u&&L.add(he(u)),{queue:S,meta:{pool:m,active:o,levelMap:p,asked:R,queued:L,wrongSinceCorrect:l}}},Fi={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,s)=>Math.max(1,s.stackSize??t),getProgressTotal:()=>null,prepare:(t,s,n)=>ks(t,s,n),applyOutcome:(t,s,n,i,c)=>{if(!s)return t;const y=Math.max(1,i.levels??1),m=t.meta.pool??[],p=t.meta.active??[],R={...t.meta.levelMap??{}},L=new Set(t.meta.asked??[]),l=new Set(t.meta.queued??[]),x=new Set(t.meta.wrongSinceCorrect??[]),o=he(s);l.delete(o),L.add(o);const u=R[o]??1;c.correct?(R[o]=x.has(o)?1:Math.min(u+1,y),x.delete(o)):(R[o]=1,x.add(o));const S=c.correct?p.filter(_=>he(_)!==o):p.slice();if(c.correct&&S.length<Math.max(1,i.stackSize??1)){const _=new Set(S.map(h=>he(h))),f=Ai(m,R,_,L,o);f&&S.push(f)}const Q=t.queue.slice(),W=Ua(S,R,o,L,l);return W&&(Q.push(W),l.add(he(W))),{queue:Q,meta:{pool:m,active:S,levelMap:R,asked:L,queued:l,wrongSinceCorrect:x}}}},Ki={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,s)=>Math.max(1,s.stackSize??t),getProgressTotal:()=>null,prepare:(t,s,n)=>js(t,s,n,{},new Set,{}),applyOutcome:(t,s,n,i,c)=>{if(!s)return t;const y=t.meta.pool??[],m=t.meta.active??[],p={...t.meta.knownessMap??{}},R=new Set(t.meta.unknownSet??[]),L={...t.meta.outcomesById??{}},l=new Set(t.meta.asked??[]),x=new Set(t.meta.queued??[]),o=he(s);x.delete(o),l.add(o);const u={correctness:Math.max(0,Math.min(1,c.correctness??(c.correct?1:0))),createdUtc:c.createdUtc??new Date().toISOString()},Q=(L[o]??[]).concat(u).sort((P,b)=>P.createdUtc.localeCompare(b.createdUtc)).slice(-5);L[o]=Q,R.delete(o);const W=Date.now();y.forEach(P=>{const b=he(P),H=L[b]??[];if(H.length===0){p[b]=0,R.add(b);return}const E=qa(H,W);p[b]=E.knowness});const _=m.slice();if((p[o]??0)>=1){const P=_.filter(b=>he(b)!==o);_.length=0,_.push(...P)}const h=Math.max(1,i.stackSize??n);if(_.length<h){const P=new Set(_.map(H=>he(H))),b=ln(y,p,R,h-_.length,P);_.push(...b)}const ue=t.queue.slice();if(ue.length===0||he(ue[ue.length-1])===o){const P=Ua(_,{},o,l,x);P&&(ue.push(P),x.add(he(P)))}return{queue:ue,meta:{pool:y,active:_,knownessMap:p,unknownSet:R,outcomesById:L,asked:l,queued:x}}}},dn={random:hs,levels:Fi,temporal:Ki},zi=Object.values(dn),Ns=t=>{if(!t)return hs;const s=t.trim().toLowerCase();return s==="random"||s==="levels"||s==="temporal"?dn[s]:hs},Wa=(t,s)=>{const n={...t.defaultSettings};return s&&Object.entries(s).forEach(([i,c])=>{typeof c=="number"&&Number.isFinite(c)&&(n[i]=c),typeof c=="string"&&(n[i]=c)}),t.settingsFields.forEach(i=>{var y;const c=n[i.key];if(i.type==="number"){if(typeof c!="number"||Number.isNaN(c)){n[i.key]=t.defaultSettings[i.key]??0;return}i.min!==void 0&&(n[i.key]=Math.max(i.min,n[i.key])),i.max!==void 0&&(n[i.key]=Math.min(i.max,n[i.key]));return}if(i.type==="select"){const m=((y=i.options)==null?void 0:y.map(p=>p.value))??[];(typeof c!="string"||m.length>0&&!m.includes(c))&&(n[i.key]=t.defaultSettings[i.key]??m[0]??"")}}),n},un=(t,s)=>{const n={};return t.settingsFields.forEach(i=>{const c=s.get(i.key);if(c){if(i.type==="number"){const y=Number(c);Number.isNaN(y)||(n[i.key]=y);return}n[i.key]=c}}),Wa(t,n)},Bi=(t,s)=>{const n=new URLSearchParams;return t.settingsFields.forEach(i=>{const c=s[i.key];(typeof c=="number"||typeof c=="string")&&n.set(i.key,String(c))}),n};function Di({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,libraryId:l,collectionId:x,revisionId:o}){const{libraryName:u}=Wt(l),S=`/#/cogita/library/${l}`,[Q,W]=a.useState(t.cogita.library.collections.defaultName),[_,f]=a.useState(""),[h,ue]=a.useState(20),[P,b]=a.useState("random"),[H,E]=a.useState({}),[J,$]=a.useState("exact"),[A,ne]=a.useState([]),[ce,re]=a.useState(null),[De,me]=a.useState([]),[T,ye]=a.useState("idle"),[v,V]=a.useState(null),[fe,Y]=a.useState("idle"),[F,ve]=a.useState("idle"),[Me,Te]=a.useState("idle"),Ke=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),Ie=a.useMemo(()=>Ns(P),[P]),_e=a.useMemo(()=>Wa(Ie,H),[Ie,H]),Be=a.useMemo(()=>Bi(Ie,_e).toString(),[Ie,_e]);a.useEffect(()=>{Oa(l,x).then(xe=>W(xe.name)).catch(()=>W(t.cogita.library.collections.defaultName))},[l,x]),a.useEffect(()=>{o&&An({libraryId:l,collectionId:x,revisionId:o}).then(xe=>{f(xe.name),b(xe.mode||"random"),$(xe.check||"exact"),ue(xe.limit||20),E(xe.revisionSettings??{})}).catch(()=>{f("")})},[x,l,o]),a.useEffect(()=>{rn({libraryId:l}).then(xe=>{ne(xe),!ce&&xe.length>0&&re(xe[0].roleId)}).catch(()=>{ne([])})},[l]);const Le=()=>{ve("loading"),sn({libraryId:l}).then(xe=>{me(xe),ve("idle")}).catch(()=>{me([]),ve("error")})};a.useEffect(()=>{Le()},[l]);const qe=async()=>{ye("working"),Y("idle");try{const xe=await Fn({libraryId:l,collectionId:x,revisionType:Ie.id,revisionSettings:_e,mode:P,check:J,limit:h});V(`${Ke}/${xe.shareCode}${Be?`?${Be}`:""}`),ye("ready"),Le()}catch{ye("error")}},et=async()=>{if(o){Te("saving");try{await Pn({libraryId:l,collectionId:x,revisionId:o,name:_||Q,revisionType:Ie.id,revisionSettings:_e,mode:P,check:J,limit:h}),Te("saved")}catch{Te("error")}}},Ge=async()=>{if(v)try{await navigator.clipboard.writeText(v),Y("copied")}catch{Y("failed")}},Ae=async xe=>{try{await nn({libraryId:l,shareId:xe}),Le()}catch{Le()}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:Q}),e.jsx("p",{className:"cogita-library-subtitle",children:u})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:S,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${S}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${S}/collections/${x}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${S}/collections/${x}/revision/run?mode=${encodeURIComponent(P)}&check=${encodeURIComponent(J)}&limit=${h}${Be?`&${Be}`:""}${ce?`&reviewer=${encodeURIComponent(ce)}`:""}${o?`&revisionId=${encodeURIComponent(o)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:_,onChange:xe=>f(xe.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:P,onChange:xe=>b(xe.target.value),children:zi.map(xe=>e.jsx("option",{value:xe.id,children:t.cogita.library.revision[xe.labelKey]},xe.id))})]}),Ie.settingsFields.map(xe=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[xe.labelKey]}),xe.type==="select"?e.jsx("select",{value:String(_e[xe.key]??""),onChange:te=>E(Se=>({...Se,[xe.key]:te.target.value})),children:(xe.options??[]).map(te=>e.jsx("option",{value:te.value,children:t.cogita.library.revision[te.labelKey]},te.value))}):e.jsx("input",{type:"number",min:xe.min,max:xe.max,step:xe.step,value:_e[xe.key]??0,onChange:te=>E(Se=>({...Se,[xe.key]:Number(te.target.value||0)}))})]},xe.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),Ie.id!=="levels"&&Ie.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:h,onChange:xe=>ue(Number(xe.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:ce??"",onChange:xe=>re(xe.target.value||null),children:A.map(xe=>e.jsx("option",{value:xe.roleId,children:xe.label},xe.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[o?e.jsx("button",{type:"button",className:"cta ghost",onClick:et,disabled:Me==="saving",children:Me==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${S}/collections/${x}/revision/run?mode=${encodeURIComponent(P)}&check=${encodeURIComponent(J)}&limit=${h}${Be?`&${Be}`:""}${ce?`&reviewer=${encodeURIComponent(ce)}`:""}${o?`&revisionId=${encodeURIComponent(o)}`:""}`,children:t.cogita.library.actions.startRevision})]}),Me==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),v?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:v,readOnly:!0})]}):null,T==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,fe==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):fe==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:qe,disabled:T==="working",children:T==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),v?e.jsx("button",{type:"button",className:"cta ghost",onClick:Ge,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),F==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):De.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:De.map(xe=>e.jsxs("div",{className:"cogita-share-row","data-state":xe.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:xe.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(xe.createdUtc).toLocaleString(),xe.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),xe.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ae(xe.shareId),children:t.cogita.library.revision.shareRevokeAction})]},xe.shareId))})]})]})]})]})})})]})})}const ns=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function hn(t,s,n){if(!t)return null;const i=new Map(t.nodes.map(P=>[P.id,P])),c=new Map,y=new Set,m=P=>{if(typeof P=="number")return P;if(typeof P=="string"){const b=Number(P);return Number.isFinite(b)?b:0}return 0},p=P=>{if(c.has(P))return c.get(P);if(y.has(P))return 0;const b=i.get(P);if(!b)return 0;y.add(P);const H=J=>{var A,ne;return(J?((A=b.inputsByHandle)==null?void 0:A[J])??[]:b.inputs??((ne=b.inputsByHandle)==null?void 0:ne.in)??[]).map(ce=>p(ce))};let E=0;switch(b.type){case"input.random":{const J=b.min??0,$=b.max??J+10,A=Math.min(J,$),ne=Math.max(J,$);E=Math.floor(Math.random()*(ne-A+1))+A;break}case"input.const":{E=b.value??0;break}case"input.list":{const J=(b.list??[]).filter(Boolean),$=Math.round(m(H("index")[0]));E=J.length?J[Math.max(0,Math.min(J.length-1,$))]:String($);break}case"compute.add":{E=H("in").map($=>m($)).reduce(($,A)=>$+A,0);break}case"compute.sub":{const J=H("add").map(A=>m(A)),$=H("sub").map(A=>m(A));E=J.reduce((A,ne)=>A+ne,0)-$.reduce((A,ne)=>A+ne,0);break}case"compute.mul":{const J=H("in").map($=>m($));E=J.length?J.reduce(($,A)=>$*A,1):0;break}case"compute.div":{const J=m(H("num")[0]),$=H("den").map(A=>m(A)).reduce((A,ne)=>A+ne,0);E=Math.abs($)<Number.EPSILON?0:J/$;break}case"compute.pow":{const J=m(H("base")[0]),$=m(H("exp")[0]);E=Math.pow(J,$);break}case"compute.exp":{const J=m(H("base")[0]),$=m(H("exp")[0]);E=Math.pow(J,$);break}case"compute.log":{const J=m(H("value")[0]),$=m(H("base")[0]),A=Math.max(J,Number.EPSILON);E=Math.abs($)<Number.EPSILON?Math.log(A):Math.log(A)/Math.log($);break}case"compute.abs":{E=Math.abs(m(H("in")[0]));break}case"compute.min":{const J=H("in").map($=>m($));E=J.length?Math.min(...J):0;break}case"compute.max":{const J=H("in").map($=>m($));E=J.length?Math.max(...J):0;break}case"compute.floor":{E=Math.floor(m(H("in")[0]));break}case"compute.ceil":{E=Math.ceil(m(H("in")[0]));break}case"compute.round":{E=Math.round(m(H("in")[0]));break}case"compute.mod":{const J=m(H("a")[0]),$=m(H("b")[0]);E=Math.abs($)<Number.EPSILON?0:J%$;break}case"compute.concat":{const $=["in1","in2","in3","in4","in5","in6"].flatMap(re=>H(re)),A=$.length?$:H("in");E=(A.length?A:H()).map(re=>re==null?"":String(re)).join("");break}case"compute.trim":{const J=H("text")[0]??H("in")[0]??"",$=J==null?"":String(J),A=Math.max(0,Math.round(m(H("start")[0]))),ne=Math.max(0,Math.round(m(H("end")[0])));A+ne>=$.length?E="":E=$.substring(A,$.length-ne);break}case"output":{E=H("in")[0]??0;break}default:E=0}return y.delete(P),c.set(P,E),E},R=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(P=>P.type==="output").map(P=>P.id);t.nodes.forEach(P=>p(P.id)),R.forEach(P=>p(P));const L=P=>Math.abs(P%1)<1e-5?String(Math.round(P)):P.toFixed(3).replace(/\.?0+$/,""),l=P=>typeof P=="number"?L(P):P??"",x=new Map;R.forEach(P=>{var $,A,ne,ce;const b=i.get(P);if(!b)return;const H=(A=($=b.inputsByHandle)==null?void 0:$.name)==null?void 0:A[0],E=H?l(c.get(H)):"",J=(E==null?void 0:E.toString().trim())||((ne=b.outputLabel)==null?void 0:ne.trim())||((ce=b.name)==null?void 0:ce.trim())||P;x.set(P,J)});const o={},u={},S={};R.forEach(P=>{var E,J;const b=i.get(P);if(!b)return;const H=x.get(P)??(((E=b.outputLabel)==null?void 0:E.trim())||((J=b.name)==null?void 0:J.trim())||P);o[H]=l(c.get(P)),b.name&&(u[b.name.trim()]=H),u[P]=H});const Q=(P,b)=>{let H=P;return t.nodes.forEach(E=>{var ce,re;const J=l(c.get(E.id)),$=R.includes(E.id),A=$?x.get(E.id)??((ce=E.outputLabel)==null?void 0:ce.trim())??((re=E.name)==null?void 0:re.trim())??E.id:"",ne=$&&b?A:J;H=H.replace(new RegExp(`\\{\\s*${ns(E.id)}\\s*\\}`,"gi"),ne),E.name&&(H=H.replace(new RegExp(`\\{\\s*${ns(E.name)}\\s*\\}`,"gi"),ne)),$&&E.outputLabel&&(H=H.replace(new RegExp(`\\{\\s*${ns(E.outputLabel)}\\s*\\}`,"gi"),A))}),H},W=s;let _=W.trim().length>0?W:"";_||(_=R.length?`Compute ${R.join(", ")}`:"Compute"),_=Q(_,!0);const f=(n==null?void 0:n.trim())??"",h=f?Q(f,!1):"",ue={};return c.forEach((P,b)=>{ue[b]=P,S[b]=l(P);const H=i.get(b);H!=null&&H.name&&(S[H.name.trim()]=l(P))}),{prompt:_,answers:o,values:ue,answerText:h,outputVariables:u,variableValues:S}}function gn(t){var n;const s=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((n=s[0])==null?void 0:n[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const is=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function mn({outcomes:t}){const[s,n]=a.useState("day"),i=a.useMemo(()=>{const c=is.find(p=>p.id===s)??is[1],y=Date.now()-c.ms,m=t.filter(p=>new Date(p.createdUtc).getTime()>=y);return Ot(m)},[t,s]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:is.map(c=>e.jsx("button",{type:"button",className:"ghost","data-active":s===c.id,onClick:()=>n(c.id),children:c.label},c.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[i.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[i.correct," / ",i.total]})]})}const _i="cogita-revision",Vi=1,Fa="outcomes",Oi=()=>new Promise((t,s)=>{const n=indexedDB.open(_i,Vi);n.onupgradeneeded=()=>{const i=n.result;if(!i.objectStoreNames.contains(Fa)){const c=i.createObjectStore(Fa,{keyPath:"id"});c.createIndex("byItem","itemKey",{unique:!1}),c.createIndex("byPending","pending",{unique:!1})}},n.onerror=()=>s(n.error),n.onsuccess=()=>t(n.result)}),Na=async(t,s)=>{const n=await Oi();return new Promise((i,c)=>{const y=n.transaction(Fa,t),m=y.objectStore(Fa);s(m).then(i).catch(c),y.onerror=()=>c(y.error)})},pn=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const s=Array.from(t).map(n=>n.toString(16).padStart(2,"0"));return`${s.slice(0,4).join("")}-${s.slice(4,6).join("")}-${s.slice(6,8).join("")}-${s.slice(8,10).join("")}-${s.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},qi=()=>{const t="cogita_revision_client_id",s=localStorage.getItem(t);if(s)return s;const n=pn();return localStorage.setItem(t,n),n},Ui=()=>{const t="cogita_revision_client_seq",s=Number(localStorage.getItem(t)??"0"),n=Number.isFinite(s)?s+1:1;return localStorage.setItem(t,String(n)),n},fn=(t,s,n,i)=>Vt(t,s,n,i),Ka=async t=>{const s=qi(),n=Ui(),i=new Date().toISOString(),c={...t,clientId:s,clientSequence:n,createdUtc:i,id:pn(),pending:!0};return await Na("readwrite",y=>new Promise((m,p)=>{const R={...c,itemKey:fn(c.itemType,c.itemId,c.checkType,c.direction)},L=y.add(R);L.onsuccess=()=>m(),L.onerror=()=>p(L.error)})),c},za=async(t,s,n,i)=>{if(!s)return[];try{const c=fn(t,s,n,i);return await Na("readonly",y=>new Promise((m,p)=>{const L=y.index("byItem").getAll(c);L.onsuccess=()=>{const x=(L.result??[]).map(o=>({itemType:o.itemType,itemId:o.itemId,checkType:o.checkType??null,direction:o.direction??null,revisionType:o.revisionType,evalType:o.evalType,correct:o.correct,createdUtc:o.createdUtc,maskBase64:o.maskBase64,payloadBase64:o.payloadBase64,payloadHashBase64:o.payloadHashBase64,clientId:o.clientId,clientSequence:o.clientSequence,personRoleId:o.personRoleId??null})).sort((o,u)=>o.createdUtc.localeCompare(u.createdUtc));m(x)},L.onerror=()=>p(L.error)}))}catch{return[]}},qt=async()=>{try{return await Na("readonly",t=>new Promise((s,n)=>{const i=t.getAll();i.onsuccess=()=>{const y=(i.result??[]).map(m=>({itemType:m.itemType,itemId:m.itemId,checkType:m.checkType??null,direction:m.direction??null,revisionType:m.revisionType,evalType:m.evalType,correct:m.correct,createdUtc:m.createdUtc,maskBase64:m.maskBase64,payloadBase64:m.payloadBase64,payloadHashBase64:m.payloadHashBase64,clientId:m.clientId,clientSequence:m.clientSequence,personRoleId:m.personRoleId??null}));s(y)},i.onerror=()=>n(i.error)}))}catch{return[]}},Wi=async(t=100)=>{try{return await Na("readonly",s=>new Promise((n,i)=>{const y=s.index("byPending").getAll(!0);y.onsuccess=()=>{const m=y.result??[];n(m.slice(0,t))},y.onerror=()=>i(y.error)}))}catch{return[]}},Hi=async t=>{if(t.length!==0)try{await Na("readwrite",s=>new Promise((n,i)=>{let c=t.length;t.forEach(y=>{const m=s.get(y);m.onsuccess=()=>{const p=m.result;if(p){p.pending=!1;const R=s.put(p);R.onsuccess=()=>{c-=1,c===0&&n()},R.onerror=()=>i(R.error)}else c-=1,c===0&&n()},m.onerror=()=>i(m.error)})}))}catch{}},rs=async(t,s)=>{const n=await Wi(200);if(n.length===0)return;const i=new Map;n.forEach(c=>{var m;const y=c.personRoleId??s??"";i.has(y)||i.set(y,[]),(m=i.get(y))==null||m.push(c)});for(const[c,y]of i.entries()){const m=y.map(p=>({itemType:p.itemType,itemId:p.itemId,checkType:p.checkType??null,direction:p.direction??null,revisionType:p.revisionType,evalType:p.evalType,correct:p.correct,clientId:p.clientId,clientSequence:p.clientSequence,maskBase64:p.maskBase64??null,payloadHashBase64:p.payloadHashBase64??null,payloadBase64:p.payloadBase64??null,personRoleId:c||null}));try{await Kn({libraryId:t,outcomes:m}),await Hi(y.map(p=>p.id))}catch{}}},St=t=>t.trim().toLowerCase(),Qi=t=>t==="reverse"?"reverse":"forward",ka=(t,s)=>`${t}|${s}`,It=t=>{if(!t)return null;const[s,n]=t.split("|",2);return(s==="forward"||s==="reverse")&&n?{mode:s,fragmentId:n}:{mode:"forward",fragmentId:t}},Ba=(t,s)=>{var i;const n=It(s);return n?n.fragmentId&&s?(t??null)===s:(((i=It(t))==null?void 0:i.mode)??"forward")===n.mode:!0},mt=t=>{const s=t==null?void 0:t.trim().toLowerCase();return s||null},bn=(t,s)=>{if((mt(t.childItemType)??"info")!==(s.cardType??"").toLowerCase()||t.childItemId!==s.cardId)return!1;const i=mt(t.childCheckType),c=mt(t.childDirection),y=mt(s.checkType),m=mt(s.direction);return!(i&&i!==y||c&&c!==m)},Yi={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},Gi={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},Da=(t,s,n)=>{if(!n||!s.startsWith(t))return s;const i=s.slice(t.length);if(!i)return s;const c=n==="super"?Yi:Gi,y=i.split("").map(m=>c[m]??m).join("");return t+y},_a=(t,s,n)=>{var m,p,R;if(!t)return((m=s[0])==null?void 0:m.key)??null;const i=new Set(s.map(L=>L.key)),c=/\{([^}]+)\}/g;let y;for(;(y=c.exec(t))!==null;){const L=((p=y[1])==null?void 0:p.trim())??"";if(!L)continue;if(i.has(L))return L;const l=n==null?void 0:n[L];if(l&&i.has(l))return l}return((R=s[0])==null?void 0:R.key)??null},gs=t=>t.flatMap(s=>{if(s.cardType!=="info"||s.infoType!=="citation")return[s];const n=s.description??"";if(!n.trim())return[s];const i=It(s.direction),c=(i==null?void 0:i.mode)??Qi(s.direction),y=sa(n),m=Object.keys(y.nodes);return m.length===0?[s]:m.map(p=>({...s,checkType:"quote-fragment",direction:ka(c,p)}))});function Ji({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,libraryId:l,collectionId:x,revisionId:o}){const u=Va(),S=`/#/cogita/library/${l}`,Q=a.useMemo(()=>new URLSearchParams(u.search),[u.search]),W=Math.max(1,Number(Q.get("limit")??20)),_=Q.get("mode")??"random",f=a.useMemo(()=>Ns(_),[_]),h=a.useMemo(()=>Wa(f,un(f,Q)),[f,Q]),ue=Q.get("check")??"exact",P=Q.get("reviewer"),b=a.useMemo(()=>t.cogita.library.revision[f.labelKey]??_,[t,_,f]),H=a.useMemo(()=>ue==="exact"?t.cogita.library.revision.checkValue:ue,[t,ue]),[E,J]=a.useState(t.cogita.library.collections.defaultName),[$,A]=a.useState([]),[ne,ce]=a.useState([]),[re,De]=a.useState("idle"),[me,T]=a.useState({current:0,total:0}),[ye,v]=a.useState(0),[V,fe]=a.useState(""),[Y,F]=a.useState(null),[ve,Me]=a.useState(null),[Te,Ke]=a.useState(null),[Ie,_e]=a.useState(null),[Be,Le]=a.useState([]),[qe,et]=a.useState({}),[Ge,Ae]=a.useState({}),[xe,te]=a.useState(null),[Se,G]=a.useState(null),[de,ze]=a.useState(null),[Je,Ve]=a.useState(null),[O,oe]=a.useState(null),[Pe,k]=a.useState({}),M=a.useRef(0),[se,le]=a.useState(null),ee=a.useRef(null),$e=a.useRef(null),[Re,we]=a.useState(null),[be,je]=a.useState(!1),[ke,ot]=a.useState(null),[Ue,Xe]=a.useState([]),[lt,yt]=a.useState(null),We=a.useRef(null),He=a.useRef(null),[Ct,dt]=a.useState(null),[Lt,ct]=a.useState(0),it=a.useRef(null),$t=a.useRef({}),[xt,tt]=a.useState(!1),[at,Et]=a.useState({}),[Rt,Ze]=a.useState([]),gt=a.useRef(new Map),[pt,jt]=a.useState(new Set),[D,ae]=a.useState(!1),Ce=a.useRef(null),d=a.useRef(new Set),Ne=a.useRef({}),q=$[ye]??null,X=(q==null?void 0:q.checkType)==="translation-match"&&O,ut=a.useRef(new Map),nt=a.useRef(new Map),bt=a.useRef(new Map),ft=a.useRef(new Map),Mt=a.useMemo(()=>q?q.cardType==="vocab"?t.cogita.library.revision.vocabLabel:q.infoType?Ye(t,q.infoType):t.cogita.library.revision.infoLabel:"",[t,q]),na=a.useMemo(()=>{var g;return f.id!=="levels"?$.length:((g=at.pool)==null?void 0:g.length)??f.getFetchLimit(W,h)},[at,h,f,$.length,W]),Ht=f.getProgressTotal?f.getProgressTotal($,at,W,h):f.id==="levels"?Math.min(W,na):$.length,Bt=Ht?Math.min(ye+1,Ht):0,vt=Math.max(1,Number(h.tries??1)),wt=h.compare??"anchors",Ut=Math.max(0,Math.min(100,Number(h.minCorrectness??0))),st=(h.considerDependencies??"on")==="on",rt=Math.max(0,Math.min(100,Number(h.dependencyThreshold??85))),Ft=r=>{const g=r.slice();for(let N=g.length-1;N>0;N-=1){const w=Math.floor(Math.random()*(N+1));[g[N],g[w]]=[g[w],g[N]]}return g},ia=r=>r.length?r.reduce((N,w)=>N+w,0)/r.length/255*100:0,ra=r=>ia(r)>=Ut,pa=async()=>{const r=await qt(),g=new Map,N=new Map,w=new Map;r.forEach(I=>{const B=`${I.itemType}:${I.itemId}`,Z=Vt(I.itemType,I.itemId,I.checkType,I.direction);if(g.has(B)||g.set(B,[]),g.get(B).push(I),N.has(Z)||N.set(Z,[]),N.get(Z).push(I),I.itemType==="info"&&I.checkType==="quote-fragment"&&I.direction){const ie=`${I.itemId}:${I.direction}`;w.has(ie)||w.set(ie,[]),w.get(ie).push(I)}});const z=new Map,j=new Map,K=new Map;return g.forEach((I,B)=>z.set(B,Ot(I).score)),N.forEach((I,B)=>j.set(B,Ot(I).score)),w.forEach((I,B)=>K.set(B,Ot(I).score)),{itemKnowness:z,cardKnowness:j,fragmentKnowness:K}},Ha=async r=>{const g=[];let N=null;for(;;){const w=await $a({libraryId:l,collectionId:r,limit:200,cursor:N});if(g.push(...w.items),!w.nextCursor)break;N=w.nextCursor}return gs(g)},fa=async(r,g)=>{if(gt.current.has(r))return gt.current.get(r)??0;const N=await Ha(r);if(N.length===0)return gt.current.set(r,0),0;const z=N.reduce((j,K)=>{const I=he(K);return j+(g.get(I)??0)},0)/N.length;return gt.current.set(r,z),z},Qa=(r,g)=>{if(!st||r.cardType!=="info"||r.infoType!=="citation"||r.checkType!=="quote-fragment")return!0;const N=It(r.direction);if(!(N!=null&&N.fragmentId))return!0;const w=r.description??"";if(!w.trim())return!0;const j=sa(w).nodes[N.fragmentId];if(!j||!j.leftId&&!j.rightId)return!0;const K=[j.leftId,j.rightId].filter(Z=>!!Z);if(K.length===0)return!0;const I=K.map(Z=>{const ie=Vt("info",r.cardId,"quote-fragment",ka(N.mode,Z));return g.get(ie)??0});return I.reduce((Z,ie)=>Z+ie,0)/I.length>=rt},oa=async r=>{const g=at,N=r.concat(g.active??[]).concat(g.pool??[]).filter((I,B,Z)=>Z.findIndex(ie=>he(ie)===he(I))===B);if(!st){jt(new Set(N.map(he)));return}const{itemKnowness:w,cardKnowness:z}=await pa(),j=Rt.filter(I=>mt(I.childItemType)==="collection"&&I.childItemId===x&&!mt(I.childCheckType)&&!mt(I.childDirection)),K=new Set;for(const I of N){if(I.cardType!=="info"){K.add(he(I));continue}if(!Qa(I,z))continue;const B=Rt.filter(pe=>bn(pe,I)).concat(j);if(B.length===0){K.add(he(I));continue}let Z=0;for(const pe of B)if(mt(pe.parentItemType)==="collection")Z+=await fa(pe.parentItemId,z);else if(mt(pe.parentCheckType)||mt(pe.parentDirection)){const ge=mt(pe.parentCheckType),Ee=mt(pe.parentDirection),Fe=Vt(pe.parentItemType,pe.parentItemId,ge,Ee);Z+=z.get(Fe)??0}else{const ge=`${pe.parentItemType}:${pe.parentItemId}`;Z+=w.get(ge)??0}Z/B.length>=rt&&K.add(he(I))}jt(K)},Ya=r=>{for(let g=r;g<$.length;g+=1){const N=$[g];if(N&&(!st||N.cardType!=="info"||pt.has(he(N))))return g}return-1},At=r=>!st||r.cardType!=="info"||pt.has(he(r)),ca=r=>{if(f.id!=="temporal"&&f.id!=="levels")return null;const g=at,N=(g.active??[]).concat(g.pool??[]),w=new Set;for(const z of N){const j=he(z);if(!(w.has(j)||r.has(j))&&(w.add(j),At(z)))return z}return null},Kt=a.useMemo(()=>{if(f.id!=="levels")return null;const r=at,g=r.pool??[],N=r.active??[],w=r.levelMap??{},z=Math.max(1,Number(h.levels??1)),j=Array.from({length:z},()=>0),K=new Set(N.map(ie=>he(ie)));g.forEach(ie=>{const pe=Math.min(z,Math.max(1,w[he(ie)]??1));j[pe-1]+=1});const I=g.length||1,B=j.map(ie=>ie/I*100),Z=q?w[he(q)]??1:null;return{counts:j,percentages:B,currentLevel:Z,levelsCount:z,activeCount:N.length,poolCount:g.length,activeSet:K}},[at,h,f,q]),kt=a.useMemo(()=>{if(f.id!=="temporal")return null;const r=at,g=r.pool??[],N=r.active??[],w=r.knownessMap??{},z=new Set(r.unknownSet??[]);let j=0;g.forEach(B=>{(w[he(B)]??0)>1&&(j+=1)});const K=z.size,I=N.map(B=>({id:he(B),value:z.has(he(B))?0:Math.max(0,Math.min(1,w[he(B)]??0))}));return{knownCount:j,unknownCount:K,dots:I}},[at,f]),la=a.useMemo(()=>{if(!st)return 0;const r=at;return $.concat(r.active??[]).concat(r.pool??[]).filter((N,w,z)=>z.findIndex(j=>he(j)===he(N))===w).filter(N=>N.cardType==="info"&&!pt.has(he(N))).length},[st,at,$,pt]);a.useEffect(()=>{if(!st||re!=="ready")return;const r=at,N=$.concat(r.active??[]).concat(r.pool??[]).filter((j,K,I)=>I.findIndex(B=>he(B)===he(j))===K).filter(j=>j.cardType!=="info"||pt.has(he(j))).length,w=We.current;if(We.current=N,w===null||N<=w)return;const z=N-w;yt(`New card available (+${z})`),He.current&&window.clearTimeout(He.current),He.current=window.setTimeout(()=>yt(null),2200)},[st,re,at,$,pt]),a.useEffect(()=>()=>{He.current&&window.clearTimeout(He.current)},[]);const Nt=(r,g)=>{const N=f.applyOutcome({queue:$,meta:at},q,W,h,{correct:r,correctness:g,createdUtc:new Date().toISOString()});A(N.queue),Et(N.meta);const w=N.queue[ye+1];w&&ba(w,ye+1)};a.useEffect(()=>{Oa(l,x).then(r=>J(r.name)).catch(()=>J(t.cogita.library.collections.defaultName))},[l,x]),a.useEffect(()=>{ys({libraryId:l,type:"language"}).then(r=>ce(r)).catch(()=>ce([]))},[l]),a.useEffect(()=>{bs({libraryId:l}).then(r=>Ze(r.items??[])).catch(()=>Ze([]))},[l]),a.useEffect(()=>{rs(l,P)},[l,P]),a.useEffect(()=>{oa($)},[$,Rt,st,rt,x]),a.useEffect(()=>{if(!q||!st){ae(!1);return}if(q.cardType!=="info"||pt.has(he(q))){ae(!1);return}const r=Ya(ye+1);if(r>=0){ae(!1),v(r);return}if(f.id==="temporal"||f.id==="levels"){const g=$.slice(0,ye+1),N=$.slice(ye+1).filter(At),w=g.concat(N),z=new Set(w.map(he)),j=ca(z);if(j){const I=he(j);z.has(I)||(w.push(j),z.add(I),Et(B=>{const Z=B,ie=new Set(Z.queued??[]);return ie.add(I),{...Z,queued:ie}}))}const K=w.findIndex((I,B)=>B!==ye&&At(I));if(K>=0){A(w),v(K),ae(!1);return}}ae(!0)},[q,pt,st,ye,$,at,f.id]),a.useEffect(()=>{let r=!0;return(async()=>{De("loading"),T({current:0,total:f.id==="levels"?0:f.getFetchLimit(W,h)});try{const N=[];let w=null,z=null;do{const pe=await $a({libraryId:l,collectionId:x,limit:300,cursor:w});if(N.push(...pe.items),(f.id==="levels"||f.id==="temporal")&&pe.total&&(z=pe.total),T(ge=>({current:N.length,total:ge.total||pe.total||f.getFetchLimit(W,h)})),w=pe.nextCursor??null,z!==null&&N.length>=z||f.id!=="levels"&&f.id!=="temporal"&&N.length>=f.getFetchLimit(W,h))break}while(w);if(!r)return;const j=gs(N);let K;if(f.id==="levels"){const pe=Math.max(1,Number(h.levels??1)),Ee=(await qt()).reduce((Fe,Oe)=>{const Qe=Vt(Oe.itemType,Oe.itemId,Oe.checkType,Oe.direction);return Fe[Qe]||(Fe[Qe]=[]),Fe[Qe].push(Oe),Fe},{});K={},j.forEach(Fe=>{const Oe=he(Fe),Qe=Ee[Oe]??[],ht=Qe.length>0?Ot(Qe).score:0,ea=Math.max(1,Math.min(pe,Math.ceil(ht/100*pe)));K[Oe]=ea})}let I=null,B=null,Z=null;if(f.id==="temporal"){const pe=await qt(),ge=new Set(j.map(Oe=>he(Oe))),Ee=pe.reduce((Oe,Qe)=>{const ht=Vt(Qe.itemType,Qe.itemId,Qe.checkType,Qe.direction);return ge.has(ht)&&(Oe[ht]||(Oe[ht]=[]),Oe[ht].push(Qe)),Oe},{});I={},B=new Set,Z={};const Fe=Date.now();j.forEach(Oe=>{const Qe=he(Oe),ht=Ee[Qe]??[];if(ht.length===0){I[Qe]=0,B.add(Qe),Z[Qe]=[];return}const ea=ws(ht);Z[Qe]=ea;const xn=qa(ea,Fe);I[Qe]=xn.knowness})}const ie=f.id==="levels"?ks(j,W,h,K):f.id==="temporal"?js(j,W,h,I??{},B??new Set,Z??{}):f.prepare(j,W,h);A(ie.queue),Et(ie.meta),v(0),De("ready"),T(pe=>({current:Math.min(pe.current,pe.total),total:pe.total}))}catch{r&&De("error")}})(),()=>{r=!1}},[l,x,W,h,f,P]),a.useEffect(()=>{if(fe(""),F(null),dt(null),ct(0),Le([]),et({}),Ae({}),G(null),ze(null),Ve(null),je(!1),tt(!1),we(null),oe(null),k({}),!q){Me(null),Ke(null),te(null),ot(null);return}q.cardType==="info"&&q.infoType==="computed"&&Me(t.cogita.library.revision.loadingComputed);let r=!0;return ba(q,ye).then(g=>{!r||!g||(Me(g.prompt),Ke(g.expectedAnswer),Le(g.computedExpected),et(g.computedAnswers),te(g.computedValues),G(g.answerTemplate),ze(g.outputVariables),Ve(g.variableValues))}),()=>{r=!1}},[q,t]),a.useEffect(()=>{if(!q||q.cardType!=="info"||q.infoType!=="citation"){Ce.current=null,d.current=new Set,_e(null);return}const r=q.description??"",g=(q.label??"").trim(),N=g.replace(/\s+/g," ").trim(),w=r.replace(/\s+/g," ").trim(),z=N&&N!==w?g:t.cogita.library.infoTypes.citation;if(!r){_e(null),Ke(null);return}const j=sa(r);Ce.current=j,Me(z);let K=!0;return pa().then(({fragmentKnowness:I})=>{if(!K)return;const B=getQuoteMode(q.direction),Z=new Set,ie={};I.forEach((Ee,Fe)=>{const[Oe,Qe]=Fe.split(":",2);if(Oe!==q.cardId)return;const ht=It(Qe);if(!ht||ht.mode!==B)return;const ea=ht.fragmentId;ie[ea]=Ee,Ee>=rt&&Z.add(ea)}),d.current=Z,Ne.current=ie;const pe=It(q.direction);if(pe!=null&&pe.fragmentId&&j.nodes[pe.fragmentId]){Dt(j,pe.fragmentId,z);return}const ge=ga(j,Z,ie,rt,st,q.direction);Dt(j,(ge==null?void 0:ge.id)??null,z)}).catch(()=>{d.current=new Set,Ne.current={};const I=It(q.direction);if(I!=null&&I.fragmentId&&j.nodes[I.fragmentId]){Dt(j,I.fragmentId,z);return}const B=ga(j,d.current,{},rt,st,q.direction);Dt(j,(B==null?void 0:B.id)??null,z)}),()=>{K=!1}},[q,t,st,rt]),a.useEffect(()=>{if(!q||q.cardType!=="vocab"||q.checkType!=="translation-match"){oe(null),k({});return}const N=(at.pool??at.active??$).filter(I=>I.cardType==="vocab"&&I.checkType==="translation-match").filter((I,B,Z)=>Z.findIndex(ie=>ie.cardId===I.cardId)===B);N.some(I=>I.cardId===q.cardId)||N.unshift(q);const z=Ft(N).slice(0,6).map(I=>{const B=I.label.split("↔").map(pe=>pe.trim()).filter(Boolean);if(B.length<2)return null;const Z=`${I.cardId}:L`,ie=`${I.cardId}:R`;return{cardId:I.cardId,leftId:Z,rightId:ie,leftLabel:B[0],rightLabel:B[1]}}).filter(Boolean),j=z.map(I=>I.leftId),K=Ft(z.map(I=>I.rightId));oe({pairs:z,leftOrder:j,rightOrder:K,selection:{},activeLeft:null,activeRight:null,locked:{}})},[q,$,at]),a.useEffect(()=>()=>{ee.current&&window.clearTimeout(ee.current),$e.current&&window.clearTimeout($e.current)},[]);const Gt=a.useRef(null);a.useEffect(()=>{if(!q)return;const r=he(q),g=typeof document<"u"?document.activeElement:null;if(Gt.current===r&&g&&(g.tagName==="INPUT"||g.tagName==="TEXTAREA"))return;let N=0;const w=()=>{if(q){if(q.cardType==="info"&&q.infoType==="computed"){if(Be.length>0){const j=_a(Se,Be,de),K=j?$t.current[j]:null;if(K&&(K.focus(),document.activeElement===K)){Gt.current=r;return}}if(it.current&&(it.current.focus(),document.activeElement===it.current)){Gt.current=r;return}}else if(q.cardType==="vocab"&&it.current&&(it.current.focus(),document.activeElement===it.current)){Gt.current=r;return}N<6&&(N+=1,window.setTimeout(w,40))}},z=window.setTimeout(w,40);return()=>window.clearTimeout(z)},[q,Be,Se,de]),a.useEffect(()=>{if(!xt)return;const r=g=>{g.key==="Enter"&&(g.preventDefault(),ua())};return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)},[xt]);const Jt=r=>{Xe(r),ot(Ot(r))};a.useEffect(()=>{if(!q){ot(null),Xe([]);return}const r=q.cardType==="info"?"info":"connection";if(q.cardType==="info"&&q.infoType==="citation"){qt().then(g=>{const N=g.filter(w=>w.itemType==="info"&&w.itemId===q.cardId&&w.checkType==="quote-fragment"&&Ba(w.direction,q.direction));Jt(N)}).catch(()=>{ot(null),Xe([])});return}za(r,q.cardId,q.checkType,q.direction).then(g=>Jt(g)).catch(()=>{ot(null),Xe([])})},[l,q,P]);const Sa=(r,g,N,w)=>{if(r==="info"&&N==="quote-fragment"){qt().then(z=>{const j=z.filter(K=>K.itemType==="info"&&K.itemId===g&&K.checkType==="quote-fragment"&&Ba(K.direction,w));Jt(j)}).catch(()=>{ot(null),Xe([])});return}za(r,g,N,w).then(z=>Jt(z)).catch(()=>{ot(null),Xe([])})},Ta=(r,g,N)=>{var K;const w=((K=N.pairs.find(I=>I.leftId===r))==null?void 0:K.rightId)??null;if(!w)return N;const z=w===g;k(I=>({...I,[r]:z?"correct":"incorrect"})),ee.current&&window.clearTimeout(ee.current),$e.current&&window.clearTimeout($e.current),M.current+=1;const j={kind:z?"correct":"incorrect",tick:M.current};if(le(null),ee.current=window.setTimeout(()=>le(j),0),$e.current=window.setTimeout(()=>le(null),420),z){const I={...N.locked,[r]:!0};return Object.keys(I).length>=N.pairs.length?(F("correct"),tt(!0)):F("correct"),{...N,selection:{...N.selection,[r]:g},activeLeft:null,activeRight:null,locked:I}}return F("incorrect"),{...N,activeLeft:null,activeRight:null}},da=r=>{oe(g=>!g||g.locked[r]?g:g.activeRight?Ta(r,g.activeRight,g):{...g,activeLeft:g.activeLeft===r?null:r})},zt=r=>{oe(g=>g&&(g.activeLeft?Ta(g.activeLeft,r,g):{...g,activeRight:g.activeRight===r?null:r}))},ua=()=>{var r;if(q&&q.cardType==="info"&&q.infoType==="citation"&&Ce.current&&Ie&&!((r=It(q.direction))!=null&&r.fragmentId)){const g=ga(Ce.current,d.current,Ne.current,rt,st,q.direction,Ie.fragmentId);if(g){F(null),fe(""),je(!1),Ae({}),tt(!1),dt(null),ct(0),Dt(Ce.current,g.id,Ie.title);return}}F(null),fe(""),je(!1),Ae({}),tt(!1),dt(null),ct(0),v(g=>Math.min(g+1,$.length))},Pt=r=>{if(!q)return;const g=r.expected??null,N=r.answer??"";let w=g??"",z=N;if(!g&&r.expectedMap&&r.answerMap){const pe=Object.keys(r.expectedMap).sort((ge,Ee)=>ge.localeCompare(Ee));w=pe.map(ge=>{var Ee;return((Ee=r.expectedMap)==null?void 0:Ee[ge])??""}).join("|"),z=pe.map(ge=>{var Ee;return((Ee=r.answerMap)==null?void 0:Ee[ge])??""}).join("|")}const j=w?ma(w,z,wt):new Uint8Array,K={revisionType:f.id,evalType:r.evalType,direction:r.direction,prompt:ve??"",expected:g,answer:N,expectedAnswers:r.expectedMap??null,answers:r.answerMap??null,correct:r.correct,maskBase64:j.length?Qt(j):null,values:xe??null,checkMode:ue,compareMode:wt,minCorrectness:Ut},I=new TextEncoder().encode(JSON.stringify(K)),B=q.cardType==="info"?"info":"connection",Z=r.overrideCheckType??q.checkType??null,ie=r.overrideDirection??q.direction??null;Ka({itemType:B,itemId:q.cardId,checkType:Z,direction:ie,revisionType:f.id,evalType:r.evalType,correct:r.correct,maskBase64:j.length?Qt(j):null,payloadBase64:Qt(I),personRoleId:P??null}).then(()=>{Sa(B,q.cardId,Z,ie),oa($),rs(l,P)}).catch(()=>{})},Xt=(r,g)=>{const N=ut.current.get(g);if(N)return Promise.resolve(N);const w=nt.current.get(g);if(w)return w;const z=Yt({libraryId:l,infoId:r}).then(j=>{var pe,ge;const K=j.payload,I=((pe=K.definition)==null?void 0:pe.graph)??null,B="",Z=((ge=K.definition)==null?void 0:ge.answerTemplate)??"",ie=hn(I,B,Z);if(ie){const Fe={sample:gn(ie),answerTemplate:Z||null};return ut.current.set(g,Fe),Fe}return Cs({libraryId:l,infoId:r}).then(Ee=>{const Fe={sample:Ee,answerTemplate:null};return ut.current.set(g,Fe),Fe})}).catch(()=>Cs({libraryId:l,infoId:r}).then(j=>{const K={sample:j,answerTemplate:null};return ut.current.set(g,K),K}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{nt.current.delete(g)});return nt.current.set(g,z),z},ba=(r,g)=>{var I;const N=`${he(r)}:${g}`,w=bt.current.get(N);if(w)return Promise.resolve(w);const z=ft.current.get(N);if(z)return z;const j=B=>(bt.current.set(N,B),B);let K;if(r.cardType==="vocab"){if(r.checkType==="translation-match")return K=Promise.resolve(j({prompt:r.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),K;const B=r.label.split("↔").map(Z=>Z.trim()).filter(Boolean);if(B.length>=2){const ie=(r.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",pe=ie?B[0]:B[1],ge=ie?B[1]:B[0];K=Promise.resolve(j({prompt:pe,expectedAnswer:ge,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else K=Promise.resolve(j({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(r.cardType==="info"&&r.infoType==="word"){const B=(I=r.description)!=null&&I.startsWith("Language: ")?r.description.replace("Language: ",""):null;K=Promise.resolve(j({prompt:r.label,expectedAnswer:B,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else r.cardType==="info"&&r.infoType==="computed"?K=Xt(r.cardId,N).then(B=>{var Ee,Fe;if(!B.sample)return j({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const Z=B.sample,ie=Z.expectedAnswers?Object.entries(Z.expectedAnswers).map(([Oe,Qe])=>({key:Oe,expected:Qe})):[],pe=ie.reduce((Oe,Qe)=>(Oe[Qe.key]="",Oe),{}),ge=Z.expectedAnswerIsSentence&&((Ee=Z.expectedAnswer)==null?void 0:Ee.trim())||null;return j({prompt:Z.prompt,expectedAnswer:ie.length>0?ge:((Fe=Z.expectedAnswer)==null?void 0:Fe.trim())||null,computedExpected:ie,computedAnswers:pe,computedValues:Z.values??null,answerTemplate:B.answerTemplate,outputVariables:Z.outputVariables??null,variableValues:Z.variableValues??null})}).catch(()=>j({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{ft.current.delete(N)}):K=Promise.resolve(j({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return ft.current.set(N,K),K},Dt=(r,g,N)=>{const w=Object.keys(r.nodes).length,z=d.current.size;if(!g){_e({title:N,before:r.text,after:"",fragmentId:null,total:w,completed:z}),Ke(null),tt(!0);return}const j=r.nodes[g];if(!j)return;const K=xs(r.text,j);_e({title:N,before:K.before,after:K.after,fragmentId:j.id,total:w,completed:z}),Ke(K.fragment),tt(!1)},Ca=()=>{const r=Ce.current;r&&_e(g=>g&&{...g,total:Object.keys(r.nodes).length,completed:d.current.size})},ha=()=>{const r=$[ye+1];r&&ba(r,ye+1)},Ma=()=>{if(ha(),q&&q.cardType==="vocab"&&q.checkType==="translation-match"&&O){if(O.pairs.length===0){F("incorrect"),tt(!0);return}const j=O.pairs.reduce((ge,Ee)=>(ge[Ee.rightId]=Ee.rightLabel,ge),{});let K=0;const I={};O.pairs.forEach(ge=>{const Fe=O.selection[ge.leftId]===ge.rightId;I[ge.leftId]=Fe?"correct":"incorrect",Fe&&(K+=1)});const B=O.pairs.length||1,Z=K/B,ie=K===O.pairs.length;k(ge=>({...ge,...I})),ie?(F("correct"),tt(!0),ct(0)):(F("incorrect"),tt(!1),ct(ge=>{const Ee=ge+1;return Ee>=vt&&(je(!0),tt(!0),oe(Fe=>{if(!Fe)return Fe;const Oe=Fe.pairs.reduce((Qe,ht)=>(Qe[ht.leftId]=ht.rightId,Qe),{});return{...Fe,selection:Oe}})),Ee})),Nt(ie,Z);const pe="connection";Promise.all(O.pairs.map(ge=>{const Ee=O.selection[ge.leftId]??null,Fe=Ee?j[Ee]:"",Oe={left:ge.leftLabel,expected:ge.rightLabel,answer:Fe,checkType:"translation-match"},Qe=new TextEncoder().encode(JSON.stringify(Oe));return Ka({itemType:pe,itemId:ge.cardId,checkType:"translation-match",direction:null,revisionType:f.id,evalType:"translation-match",correct:Ee===ge.rightId,maskBase64:null,payloadBase64:Qt(Qe),personRoleId:P??null})})).then(()=>{Sa(pe,q.cardId,q.checkType,q.direction),rs(l,P)}).catch(()=>{});return}if(Be.length>0){const j=Be.reduce((I,B)=>{const Z=qe[B.key]??"";return I[B.key]=St(Z)===St(B.expected)?"correct":"incorrect",I},{});Be.every(({key:I,expected:B})=>{const Z=qe[I]??"";return ue==="exact"&&St(Z)===St(B)})?(F("correct"),Ae(j),tt(!0),ct(0),Nt(!0,1),Pt({correct:!0,direction:ve?`${ve} -> computed`:"computed",expectedMap:Be.reduce((I,B)=>(I[B.key]=B.expected,I),{}),answerMap:qe,evalType:"computed"})):(F("incorrect"),Ae(j),tt(!1),ct(I=>{const B=I+1;return B>=vt&&U&&(je(!0),tt(!0)),B}),Nt(!1,0),window.setTimeout(()=>{var B;const I=_a(Se,Be,de);I&&$t.current[I]&&((B=$t.current[I])==null||B.focus())},40),Pt({correct:!1,direction:ve?`${ve} -> computed`:"computed",expectedMap:Be.reduce((I,B)=>(I[B.key]=B.expected,I),{}),answerMap:qe,evalType:"computed"}));return}if(q&&q.cardType==="info"&&q.infoType==="citation"&&(Ie!=null&&Ie.fragmentId)){if(!Te)return;const j=It(q.direction),K=(j==null?void 0:j.mode)??getQuoteMode(q.direction),I=j!=null&&j.fragmentId&&q.direction?q.direction:ka(K,Ie.fragmentId),B=Pa(Te,V,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Z=B.mask,ie=B.isCorrect,pe=B.percent;ie?(Ne.current[Ie.fragmentId]=Math.max(Ne.current[Ie.fragmentId]??0,pe),(Ne.current[Ie.fragmentId]??0)>=rt&&d.current.add(Ie.fragmentId),Ca(),F("correct"),Ae({}),tt(!0),dt(Z),ct(0),pe<100&&vt<=1&&je(!0),Nt(!0,pe/100),Pt({correct:!0,direction:`quote:${Ie.fragmentId}`,expected:Te,answer:V,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:I})):(F("incorrect"),Ae({}),tt(!1),dt(Z),ct(ge=>{const Ee=ge+1;return Ee>=vt&&U&&(je(!0),tt(!0)),Ee}),Nt(!1,pe/100),window.setTimeout(()=>{var ge;return(ge=it.current)==null?void 0:ge.focus()},40),Pt({correct:!1,direction:`quote:${Ie.fragmentId}`,expected:Te,answer:V,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:I}));return}if(!Te)return;const r=ma(Te,V,wt),g=ue==="exact"&&St(V)===St(Te),N=ra(r),w=g||N,z=ia(r);w?(F("correct"),Ae({}),tt(!0),dt(r),ct(0),z<100&&vt<=1&&je(!0),Nt(!0,z/100),Pt({correct:!0,direction:ve?`${ve} -> ${Te}`:null,expected:Te,answer:V,evalType:"text"})):(F("incorrect"),Ae({}),tt(!1),dt(r),ct(j=>{const K=j+1;return K>=vt&&U&&(je(!0),tt(!0)),K}),Nt(!1,z/100),window.setTimeout(()=>{var j;return(j=it.current)==null?void 0:j.focus()},40),Pt({correct:!1,direction:ve?`${ve} -> ${Te}`:null,expected:Te,answer:V,evalType:"text"}))},Ga=r=>{if(ha(),!Te)return;const g=ma(Te,r,wt),N=St(r)===St(Te),w=ra(g),z=N||w,j=ia(g);z?(F("correct"),Ae({}),tt(!0),dt(g),ct(0),j<100&&vt<=1&&je(!0),Nt(!0,j/100),Pt({correct:!0,direction:"word->language",expected:Te,answer:r,evalType:"language-select"})):(F("incorrect"),Ae({}),tt(!1),dt(g),ct(K=>{const I=K+1;return I>=vt&&U&&(je(!0),tt(!0)),I}),Nt(!1,j/100),Pt({correct:!1,direction:"word->language",expected:Te,answer:r,evalType:"language-select"}))},Ja=()=>{ha(),F("correct"),tt(!0),ct(0),Nt(!0,1),Te&&Pt({correct:!0,direction:"manual",expected:Te,answer:V,evalType:"manual"})},Xa=()=>{if(Nt(!1,0),q&&q.cardType==="info"&&q.infoType==="citation"){F(null),fe(""),je(!1),Ae({}),tt(!1),dt(null),ct(0),v(r=>Math.min(r+1,$.length));return}ua()};a.useEffect(()=>{ha()},[ye,$]);const Zt=r=>{var N;if(r.key!=="Enter")return;if(r.preventDefault(),r.stopPropagation(),xt){ua();return}const g=Be.find(w=>!(qe[w.key]??"").trim());if(g){(N=$t.current[g.key])==null||N.focus();return}Ma()},C=t.cogita.library.revision.revealModeAfterIncorrect,U=Be.length>0||!!Te;return e.jsxs(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,children:[re==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${me.total?Math.min(100,Math.max(0,me.current/me.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:me.total?`${Math.min(me.current,me.total)} / ${me.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:E}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",b).replace("{check}",H)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:S,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${S}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${S}/collections/${x}`,children:t.cogita.library.actions.collectionDetail})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:ke?`${ke.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Kt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Kt.currentLevel??"-"," / ",Kt.levelsCount]}):null,ke?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(ke.correct)).replace("{total}",String(ke.total))}),ke.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(ke.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(mn,{outcomes:Ue})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[lt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:lt})}):null,e.jsx("section",{className:"cogita-revision-card","data-feedback":se?`${se.kind}-${se.tick}`:X?"idle":Y??"idle",children:q?e.jsx(e.Fragment,{children:D?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(vs,{copy:t,currentCard:q,currentTypeLabel:Mt,prompt:ve,languages:ne,answer:V,onAnswerChange:r=>fe(g=>Da(g,r,Re)),computedExpected:Be,computedAnswers:qe,onComputedAnswerChange:(r,g)=>et(N=>({...N,[r]:Da(N[r]??"",g,Re)})),answerTemplate:Se,outputVariables:de,variableValues:Je,computedFieldFeedback:Ge,feedback:Y,canAdvance:xt,quoteContext:Ie,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Ma,onSkip:Xa,onLanguageSelect:Ga,onMarkReviewed:Ja,onAdvance:ua,showCorrectAnswer:be,setShowCorrectAnswer:je,onRevealCorrect:()=>tt(!0),answerMask:Ct,expectedAnswer:Te,hasExpectedAnswer:U,handleComputedKeyDown:Zt,answerInputRef:it,computedInputRefs:$t,scriptMode:Re,setScriptMode:we,matchPairs:O==null?void 0:O.pairs,matchLeftOrder:O==null?void 0:O.leftOrder,matchRightOrder:O==null?void 0:O.rightOrder,matchSelection:O==null?void 0:O.selection,matchActiveLeft:O==null?void 0:O.activeLeft,matchActiveRight:O==null?void 0:O.activeRight,matchFeedback:Pe,onMatchLeftSelect:da,onMatchRightSelect:zt})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${S}/collections/${x}`,children:t.cogita.library.actions.collectionDetail})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Ht?`${Bt} / ${Ht}`:t.cogita.library.revision.progressUnlimited}),re==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),re==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),re==="ready"&&$.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:C}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",vt]})]})]}),Kt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Kt.activeCount," / ",Kt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Kt.counts.map((r,g)=>{const N=g+1,w=Kt.currentLevel===N,z=Kt.percentages[g]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":w,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:N}),e.jsx("strong",{children:r})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,z))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[z.toFixed(1),"%"]})]},`level-${N}`)})})]}):null,kt?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:kt.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:kt.dots.map(r=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,r.value*100))}%`,background:`rgba(${Math.round(255*(1-r.value))}, ${Math.round(200*r.value)}, 80, 0.9)`}},r.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:kt.knownCount})]})]}):null,st?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:la})]})}):null]})]})]})})})]})]})}const os=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],Xi={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},Zi=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],er=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function tr({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,libraryId:l,collectionId:x}){const[o,u]=a.useState(""),[S,Q,W]=Ws([]),[_,f,h]=Hs([]),[ue,P]=a.useState(null),[b,H]=a.useState(null),[E,J]=a.useState(null),$=`/#/cogita/library/${l}`;a.useEffect(()=>{Oa(l,x).then(T=>u(T.name)).catch(()=>u(t.cogita.library.collections.defaultName))},[l,x,t]),a.useEffect(()=>{zn({libraryId:l,collectionId:x}).then(T=>{if(!T.graphId||T.graphId==="00000000-0000-0000-0000-000000000000"){Q([]),f([]);return}const ye=T.nodes.map(V=>{var ve;const fe=V.payload??{},Y=fe.position??{x:120,y:120},F=fe.params??{};return{id:V.nodeId,type:"default",position:Y,data:{nodeType:V.nodeType,label:((ve=os.find(Me=>Me.type===V.nodeType))==null?void 0:ve.label)??V.nodeType,params:F}}}),v=T.edges.map(V=>({id:V.edgeId,source:V.fromNodeId,target:V.toNodeId,sourceHandle:V.fromPort??void 0,targetHandle:V.toPort??void 0}));Q(ye),f(v)}).catch(()=>{Q([]),f([])})},[l,x,f,Q]);const A=a.useMemo(()=>S.find(T=>T.id===ue)??null,[S,ue]),ne=T=>{var fe;const ye=crypto.randomUUID(),v=((fe=os.find(Y=>Y.type===T))==null?void 0:fe.label)??T,V={...Xi[T]};Q(Y=>[...Y,{id:ye,type:"default",position:{x:120+Y.length*40,y:120+Y.length*40},data:{nodeType:T,label:v,params:V}}]),P(ye)},ce=a.useCallback(T=>{f(ye=>Qs({...T,id:crypto.randomUUID()},ye))},[f]),re=async()=>{H(null);try{await Dn({libraryId:l,collectionId:x,nodes:S.map(T=>({nodeId:T.id,nodeType:T.data.nodeType,payload:{position:T.position,params:T.data.params}})),edges:_.map(T=>({edgeId:T.id,fromNodeId:T.source,fromPort:T.sourceHandle??null,toNodeId:T.target,toPort:T.targetHandle??null}))}),H(t.cogita.library.graph.saveSuccess)}catch{H(t.cogita.library.graph.saveFail)}},De=async()=>{try{const T=await Bn({libraryId:l,collectionId:x});J(T)}catch{J(null)}},me=T=>{A&&Q(ye=>ye.map(v=>v.id===A.id?{...v,data:{...v.data,params:T}}:v))};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:o}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${$}/collections/${x}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:De,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:re,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:os.map(T=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>ne(T.type),children:T.label},T.type))}),b?e.jsx("p",{className:"cogita-help",children:b}):null,E&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(E.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(E.connections)).replace("{infos}",String(E.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(ms,{nodes:S,edges:_,onNodesChange:W,onEdgesChange:h,onConnect:ce,onNodeClick:(T,ye)=>P(ye.id),fitView:!0,children:[e.jsx(ps,{color:"rgba(120,160,200,0.2)"}),e.jsx(fs,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),A?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:A.data.label}),A.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(aa,{libraryId:l,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:A.data.params.tagId?{id:A.data.params.tagId,label:A.data.params.tagLabel??"",infoType:"topic"}:null,onChange:T=>me({...A.data.params,tagId:(T==null?void 0:T.id)??null,tagLabel:(T==null?void 0:T.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:A.data.params.scope??"any",onChange:T=>me({...A.data.params,scope:T.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),A.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(aa,{libraryId:l,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:A.data.params.languageId?{id:A.data.params.languageId,label:A.data.params.languageLabel??"",infoType:"language"}:null,onChange:T=>me({...A.data.params,languageId:(T==null?void 0:T.id)??null,languageLabel:(T==null?void 0:T.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:A.data.params.scope??"any",onChange:T=>me({...A.data.params,scope:T.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),A.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:A.data.params.infoType??"word",onChange:T=>me({...A.data.params,infoType:T.target.value}),children:er.map(T=>e.jsx("option",{value:T.value,children:T.label},T.value))})]}),e.jsx(aa,{libraryId:l,infoType:A.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:A.data.params.infoId?{id:A.data.params.infoId,label:A.data.params.infoLabel??"",infoType:A.data.params.infoType??"word"}:null,onChange:T=>me({...A.data.params,infoId:(T==null?void 0:T.id)??null,infoLabel:(T==null?void 0:T.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),A.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:A.data.params.connectionType??"translation",onChange:T=>me({...A.data.params,connectionType:T.target.value}),children:Zi.map(T=>e.jsx("option",{value:T.value,children:T.label},T.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:A.data.params.connectionId??"",onChange:T=>me({...A.data.params,connectionId:T.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(A.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const cs="cogita.preferences",ls="cogita.reviewer.preferences",yn=["library_overview","all_cards","all_collections","storyboards","texts","dependencies","transfer"],ds={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},us=["settings","run","shared"];function ar(t,s=""){const n=t.split("/").filter(Boolean);if(n[0]!=="cogita"||n[1]!=="library")return{};const i=n[2];if(!i)return{};if(!n[3])return{libraryId:i,target:"library_overview"};const c=new URLSearchParams(s),y=c.get("revisionId")??void 0,m=c.get("infoId")??void 0,p=c.get("infoView")==="cards"?"cards":"overview",R=c.get("collectionAction"),L=c.get("libraryAction");if(n[3]==="list")return{libraryId:i,target:L==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:y,infoId:m,infoView:p,libraryAction:L==="new-info"?"new-info":void 0};if(n[3]==="detail"||n[3]==="collection")return{libraryId:i,target:"all_cards",cardMode:n[3],revisionId:y,infoId:m,infoView:p};if(n[3]==="new"||n[3]==="add")return{libraryId:i,target:"new_card",revisionId:y,libraryAction:"new-info"};if(n[3]==="edit")return{libraryId:i,target:"new_card",revisionId:y,infoId:n[4]};if(n[3]==="infos"){const x=n[4];return x?n[5]==="checkcards"?{libraryId:i,target:"all_cards",cardMode:"list",revisionId:y,infoId:x,infoView:"cards"}:{libraryId:i,target:"all_cards",cardMode:"list",revisionId:y,infoId:x,infoView:"overview"}:{libraryId:i,target:"all_cards",cardMode:"list",revisionId:y}}if(n[3]==="shared-revisions")return{libraryId:i,target:"all_collections",revisionId:y};if(n[3]==="dependencies")return{libraryId:i,target:"dependencies"};if(n[3]==="transfer")return{libraryId:i,target:"transfer"};if(n[3]==="storyboards")return n[4]==="new"?{libraryId:i,target:"new_storyboard"}:{libraryId:i,target:"storyboards"};if(n[3]==="texts")return n[4]==="new"?{libraryId:i,target:"new_text"}:{libraryId:i,target:"texts"};if(n[3]!=="collections")return{libraryId:i,target:"library_overview"};if(n[4]==="new")return{libraryId:i,target:"new_collection",revisionId:y};const l=n[4];return l?n[5]==="graph"?{libraryId:i,target:"all_collections",collectionId:l,revisionId:y,revisionView:"graph"}:n[5]==="shared-revisions"?{libraryId:i,target:"all_collections",collectionId:l,revisionId:y,revisionView:"shared"}:n[5]==="revision"?{libraryId:i,target:"all_collections",collectionId:l,revisionId:y,revisionView:n[6]==="run"?"run":"settings"}:R==="new-revision"?{libraryId:i,target:"all_collections",collectionId:l,revisionId:y,revisionView:"new"}:{libraryId:i,target:"all_collections",collectionId:l,revisionId:y,revisionView:"detail"}:R==="new-collection"?{libraryId:i,target:"new_collection",collectionAction:"new-collection"}:{libraryId:i,target:"all_collections"}}function qs(t,s="library_overview",n,i,c,y,m="overview"){const p=(R,L)=>{const l=new URLSearchParams;L!=null&&L.revisionId&&l.set("revisionId",L.revisionId),L!=null&&L.collectionAction&&l.set("collectionAction",L.collectionAction),L!=null&&L.libraryAction&&l.set("libraryAction",L.libraryAction),L!=null&&L.infoId&&l.set("infoId",L.infoId),L!=null&&L.infoView&&(L!=null&&L.infoId)&&l.set("infoView",L.infoView);const x=l.toString();return x?`${R}?${x}`:R};return t?s==="library_overview"?p(`/cogita/library/${t}`,{revisionId:c}):s==="all_cards"?y?m==="cards"?p(`/cogita/library/${t}/infos/${y}/checkcards`,{revisionId:c}):p(`/cogita/library/${t}/infos/${y}`,{revisionId:c}):p(`/cogita/library/${t}/list`,{revisionId:c,infoId:y,infoView:m}):s==="new_card"?y?p(`/cogita/library/${t}/edit/${y}`,{revisionId:c}):p(`/cogita/library/${t}/list`,{revisionId:c,libraryAction:"new-info"}):s==="all_collections"?n?i==="graph"?p(`/cogita/library/${t}/collections/${n}/graph`,{revisionId:c}):i==="settings"?p(`/cogita/library/${t}/collections/${n}/revision`,{revisionId:c}):i==="run"?p(`/cogita/library/${t}/collections/${n}/revision/run`,{revisionId:c}):i==="shared"?p(`/cogita/library/${t}/collections/${n}/shared-revisions`,{revisionId:c}):i==="new"?p(`/cogita/library/${t}/collections/${n}`,{revisionId:c,collectionAction:"new-revision"}):p(`/cogita/library/${t}/collections/${n}`,{revisionId:c}):p(`/cogita/library/${t}/collections`,{revisionId:c}):s==="new_collection"?p(`/cogita/library/${t}/collections`,{revisionId:c,collectionAction:"new-collection"}):s==="transfer"?p(`/cogita/library/${t}/transfer`,{revisionId:c}):s==="storyboards"?p(`/cogita/library/${t}/storyboards`,{revisionId:c}):s==="new_storyboard"?p(`/cogita/library/${t}/storyboards/new`,{revisionId:c}):s==="texts"?p(`/cogita/library/${t}/texts`,{revisionId:c}):s==="new_text"?p(`/cogita/library/${t}/texts/new`,{revisionId:c}):s==="dependencies"?p(`/cogita/library/${t}/dependencies`,{revisionId:c}):p(`/cogita/library/${t}`,{revisionId:c}):"/cogita"}function xa(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function sr(t){return typeof t=="string"&&yn.includes(t)}function nr(t,s){var p;if(!t.length)return null;const n=t.filter(R=>s.has(R.roleId)),i=n.length>0?n:t,c=i.map(R=>{var l,x;const L=((x=(l=R.fields.find(o=>o.fieldType==="role_kind"))==null?void 0:l.plainValue)==null?void 0:x.toLowerCase())??"";return{roleId:R.roleId,roleKind:L}}),y=c.find(R=>R.roleKind.includes("master"));if(y)return y.roleId;const m=c.find(R=>R.roleKind.includes("account")||R.roleKind.includes("user"));return m?m.roleId:((p=i[0])==null?void 0:p.roleId)??null}function ir(t){if(!t)return{version:1,byLibrary:{}};try{const s=JSON.parse(t);return!s||typeof s!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:s.lastLibraryId,byLibrary:s.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function rr({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L}){const l=Us(),x=Va(),o=a.useMemo(()=>ar(x.pathname,x.search),[x.pathname,x.search]),u=t.cogita.workspace,[S,Q]=a.useState([]),[W,_]=a.useState([]),[f,h]=a.useState([]),[ue,P]=a.useState([]),[b,H]=a.useState(void 0),[E,J]=a.useState("library_overview"),[$,A]=a.useState(void 0),[ne,ce]=a.useState(void 0),[re,De]=a.useState("detail"),[me,T]=a.useState(void 0),[ye,v]=a.useState(!1),[V,fe]=a.useState(!0),[Y,F]=a.useState(!1),[ve,Me]=a.useState(!1),[Te,Ke]=a.useState(null),[Ie,_e]=a.useState(0),[Be,Le]=a.useState(""),[qe,et]=a.useState(""),[Ge,Ae]=a.useState(""),[xe,te]=a.useState([]),[Se,G]=a.useState(""),[de,ze]=a.useState(null),[Je,Ve]=a.useState(null),O=a.useRef({version:1,byLibrary:{}}),oe=a.useRef(!1),Pe=a.useRef(!1),k=a.useRef(null),M=a.useMemo(()=>S.find(d=>d.libraryId===b)??null,[S,b]),se=a.useMemo(()=>W.find(d=>d.collectionId===$)??null,[W,$]);a.useEffect(()=>{if(!b){te([]),G("");return}let d=!1;return rn({libraryId:b}).then(Ne=>{if(d)return;const q=Ne.filter(X=>(X.roleKind??"").trim().toLowerCase()==="person");te(q);try{const X=window.localStorage.getItem(ls),nt=(X?JSON.parse(X):{})[b]??"",bt=nt&&q.some(ft=>ft.roleId===nt)?nt:"";G(bt)}catch{G("")}}).catch(()=>{d||(te([]),G(""))}),()=>{d=!0}},[b]),a.useEffect(()=>{if(b)try{const d=window.localStorage.getItem(ls),Ne=d?JSON.parse(d):{};Se?Ne[b]=Se:delete Ne[b],window.localStorage.setItem(ls,JSON.stringify(Ne))}catch{}},[b,Se]);const le=a.useMemo(()=>ue.find(d=>d.revisionId===ne)??null,[ue,ne]),ee=a.useMemo(()=>({detail:u.revisions.detail,graph:u.revisions.graph,settings:u.revisions.settings,run:u.revisions.run,shared:u.targets.sharedRevisions,new:u.revisionForm.createAction}),[u.revisions.detail,u.revisions.graph,u.revisions.run,u.revisions.settings,u.targets.sharedRevisions,u.revisionForm.createAction]),$e=a.useMemo(()=>[{value:"detail",label:ee.detail},{value:"graph",label:ee.graph},{value:"settings",label:u.targets.allRevisions},{value:"run",label:ee.run},{value:"shared",label:ee.shared}],[ee.detail,ee.graph,ee.run,ee.shared,u.targets.allRevisions]),Re=a.useMemo(()=>E==="new_card"?"all_cards":E==="new_collection"?"all_collections":E==="new_storyboard"?"storyboards":E==="new_text"?"texts":E,[E]),we=a.useMemo(()=>re==="new"?"settings":re,[re]),be=a.useMemo(()=>o.infoId?"selected":E==="new_card"?"create":"search",[o.infoId,E]),je=a.useMemo(()=>f.find(d=>d.infoId===o.infoId)??null,[f,o.infoId]),ke=a.useMemo(()=>({library_overview:u.targets.libraryOverview,all_cards:u.targets.allCards,new_card:u.targets.newCard,all_collections:u.targets.allCollections,new_collection:u.targets.newCollection,transfer:u.targets.transfer,storyboards:u.targets.storyboards,new_storyboard:u.targets.newStoryboard,texts:u.targets.texts,new_text:u.targets.newText,dependencies:u.targets.dependencies}),[u.targets]),ot=a.useMemo(()=>ke[Re]??Re,[Re,ke]),Ue=ee[we],Xe=!!b,lt=a.useMemo(()=>{const d=R==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":R==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return R==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:d},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:d},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:d},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:d},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:d},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:d},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:d},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:d},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:d},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:d},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:d},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:d},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:d},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:R==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:d},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:d},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:d},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:d},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:d},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:d},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:d},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:d},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:d},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:d},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:d},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:d},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:d},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:d},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:d},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:d},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:d},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:d},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:d},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:d},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:d},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:d},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:d},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:d},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:d},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:d},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[R]),yt=lt.length,We=Math.max(0,Math.min(Ie,yt-1)),He=lt[We],Ct=!!$,dt=Xe&&E==="all_collections",Lt=Ct&&E==="all_collections",ct=Ct&&E==="all_collections"&&us.includes(re),it=a.useCallback(d=>{const Ne=!!d.libraryId;let q=d.target,X=d.collectionId,ut=d.revisionId,nt=d.revisionView,bt=d.infoId,ft=d.infoView??o.infoView??"overview";Ne?ds[q].requiresCollection&&!X?(q="all_collections",ut=void 0,nt="detail"):q!=="all_collections"?(X=void 0,ut=void 0,q!=="new_card"&&q!=="all_cards"&&(bt=void 0,ft="overview")):ds[q].allowsRevision?us.includes(nt)||(ut=void 0):nt="detail":(q="library_overview",X=void 0,ut=void 0,nt="detail",bt=void 0,ft="overview"),H(d.libraryId),J(q),A(X),ce(ut),De(nt),v(!1);const Mt=xa(qs(d.libraryId,q,X,nt,ut,bt,ft));xa(`${x.pathname}${x.search}`)!==Mt&&(k.current=Mt,l(Mt))},[x.pathname,x.search,l,o.infoView]),$t=d=>{it({libraryId:b,target:"all_collections",collectionId:$,revisionId:us.includes(d)?ne:void 0,revisionView:d})},xt=a.useMemo(()=>[{key:"library",label:u.layers.library,visible:!0,value:b??"",selectedLabel:(M==null?void 0:M.name)??u.path.noLibrarySelected,disabled:V||S.length===0,options:S.map(d=>({value:d.libraryId,label:d.name})),emptyOption:u.noLibraryOption,onSelect:d=>{const Ne=d||void 0;it({libraryId:Ne,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:u.layers.target,visible:Xe,value:Re,selectedLabel:ot,disabled:!Xe,options:yn.map(d=>({value:d,label:ke[d]})),onSelect:d=>{const Ne=d;it({libraryId:b,target:Ne,collectionId:$,revisionId:ne,revisionView:re,infoId:Ne==="new_card"?o.infoId:void 0})}},{key:"info_mode",label:u.layers.target,visible:Re==="all_cards",value:be,selectedLabel:be==="create"?u.infoMode.create:be==="selected"?(je==null?void 0:je.label)??me??t.cogita.library.list.selectedEmpty:u.infoMode.search,disabled:!Xe,options:[{value:"search",label:u.infoMode.search},{value:"create",label:u.infoMode.create},...o.infoId?[{value:"selected",label:(je==null?void 0:je.label)??me??t.cogita.library.list.selectedEmpty}]:[]],onSelect:d=>{if(d==="selected"){if(!o.infoId)return;it({libraryId:b,target:"all_cards",collectionId:$,revisionId:ne,revisionView:re,infoId:o.infoId,infoView:"overview"});return}if(d==="create"){it({libraryId:b,target:"new_card",collectionId:$,revisionId:ne,revisionView:re,infoId:void 0});return}it({libraryId:b,target:"all_cards",collectionId:$,revisionId:ne,revisionView:re,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:u.layers.target,visible:Re==="all_cards"&&!!o.infoId,value:E==="new_card"&&o.infoId?"edit":o.infoView==="cards"?"cards":"overview",selectedLabel:E==="new_card"&&o.infoId?u.infoActions.edit:o.infoView==="cards"?u.infoActions.seeCards:u.infoActions.overview,disabled:!Xe||!o.infoId,options:[{value:"overview",label:u.infoActions.overview},{value:"edit",label:u.infoActions.edit},{value:"cards",label:u.infoActions.seeCards}],onSelect:d=>{if(o.infoId){if(d==="edit"){it({libraryId:b,target:"new_card",collectionId:$,revisionId:ne,revisionView:re,infoId:o.infoId});return}if(d==="cards"){it({libraryId:b,target:"all_cards",collectionId:$,revisionId:ne,revisionView:re,infoId:o.infoId,infoView:"cards"});return}it({libraryId:b,target:"all_cards",collectionId:$,revisionId:ne,revisionView:re,infoId:o.infoId,infoView:"overview"})}}},{key:"collection",label:u.layers.collection,visible:dt,value:$??"",selectedLabel:(se==null?void 0:se.name)??u.path.noCollectionSelected,disabled:!Xe||Y||W.length===0,options:W.map(d=>({value:d.collectionId,label:d.name})),emptyOption:u.selectCollectionOption,onSelect:d=>{it({libraryId:b,target:"all_collections",collectionId:d||void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection_action",label:u.layers.revision,visible:Lt,value:we,selectedLabel:Ue,disabled:!$,options:$e.map(d=>({value:d.value,label:d.label})),onSelect:d=>{$t(d)}},{key:"revision_entry",label:u.layers.revision,visible:ct,value:ne??"",selectedLabel:(le==null?void 0:le.name)??u.status.noRevisions,disabled:!Ct||ve||ue.length===0,options:ue.map(d=>({value:d.revisionId,label:d.name})),emptyOption:u.status.noRevisions,onSelect:d=>{it({libraryId:b,target:"all_collections",collectionId:$,revisionId:d||void 0,revisionView:re})}}],[$e,W,Y,be,f,S,V,it,ue,ve,se,$,je,le,ne,me,Ct,Xe,M,b,Ue,re,E,we,Re,ot,dt,Lt,ct,ke,t.cogita.library.list.selectedEmpty,o.infoId,o.infoView,u.infoActions.edit,u.infoActions.overview,u.infoActions.seeCards,u.layers.collection,u.layers.library,u.layers.revision,u.layers.target,u.noLibraryOption,u.path.noCollectionSelected,u.path.noLibrarySelected,u.selectCollectionOption]),tt=a.useMemo(()=>xt.filter(d=>d.visible),[xt]),at=a.useMemo(()=>tt.filter(d=>d.key!=="library"&&d.key!=="collection"&&d.key!=="revision_entry"),[tt]),Et=a.useMemo(()=>at.find(d=>d.key==="target")??null,[at]),Rt=a.useMemo(()=>at.find(d=>d.key==="info_mode")??null,[at]),Ze=a.useMemo(()=>at.find(d=>d.key==="info_selected_action")??null,[at]),gt=a.useMemo(()=>at.find(d=>d.key==="collection_action")??null,[at]),pt=a.useCallback((d,Ne)=>d?e.jsx("div",{className:"cogita-sidebar-actions",children:d.options.map(q=>e.jsx("button",{type:"button",className:`ghost ${String(d.value)===q.value?"active":""}`,onClick:()=>d.onSelect(q.value),disabled:d.disabled,children:q.label},`${Ne}:${d.key}:${q.value}`))}):null,[]),jt=a.useMemo(()=>{const d=o.libraryId;if(!d||!x.pathname.startsWith("/cogita/library/"))return null;const Ne={copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,libraryId:d};if(o.target==="library_overview")return e.jsx(ii,{...Ne});if(o.target==="all_cards")return o.infoId&&o.infoView==="cards"?e.jsx(Ti,{...Ne,infoId:o.infoId,selectedReviewerRoleId:Se||null}):e.jsx(hi,{...Ne,mode:o.cardMode??"list"});if(o.target==="new_card")return e.jsx(xi,{...Ne,editInfoId:o.infoId});if(o.target==="dependencies")return e.jsx(wi,{...Ne});if(o.target==="transfer")return e.jsx(Mi,{...Ne});if(o.target==="storyboards"||o.target==="new_storyboard")return e.jsx(Ii,{...Ne});if(o.target==="texts"||o.target==="new_text")return e.jsx(Li,{...Ne});if(o.target==="all_collections"){if(o.collectionId){const q={...Ne,collectionId:o.collectionId};return o.revisionView==="graph"?e.jsx(tr,{...q}):o.revisionView==="shared"?e.jsx(Ci,{...Ne,collectionId:o.collectionId}):o.revisionView==="settings"?e.jsx(Di,{...q,revisionId:o.revisionId}):o.revisionView==="run"?e.jsx(Ji,{...q,revisionId:o.revisionId}):e.jsx($i,{...q})}return e.jsx(Os,{...Ne})}return o.target==="new_collection"?e.jsx(Os,{...Ne}):null},[s,t,R,x.pathname,l,L,y,p,i,c,o.cardMode,o.collectionId,o.infoId,o.libraryId,o.revisionId,o.revisionView,o.target,m,n,Se]);a.useEffect(()=>{let d=!1;return(async()=>{var q,X,ut,nt,bt;fe(!0);try{await _n();const[ft,Mt,na]=await Promise.all([Js(),Vn(),On()]);if(d)return;Q(ft);const Ht=new Set(na.nodes.filter(st=>st.nodeType==="role"&&st.canLink).map(st=>st.roleId??"")),Bt=nr(Mt,Ht);if(ze(Bt),Bt){const st=na.nodes.find(rt=>rt.nodeType==="data"&&rt.roleId===Bt&&(rt.fieldType===cs||rt.label===cs));Ve((st==null?void 0:st.dataKeyId)??null),O.current=ir(st==null?void 0:st.value)}const vt=(q=ft.find(st=>st.libraryId===o.libraryId))==null?void 0:q.libraryId,wt=vt?(ut=(X=O.current.byLibrary)==null?void 0:X[vt])==null?void 0:ut.lastTarget:void 0,Ut=sr(wt)?wt:"library_overview";H(vt),J(o.target??Ut),ce(o.revisionId??(vt?(bt=(nt=O.current.byLibrary)==null?void 0:nt[vt])==null?void 0:bt.lastRevisionId:void 0)),De(o.revisionView??"detail"),oe.current=!0}catch{d||Ke(u.status.loadFailed)}finally{d||fe(!1)}})(),()=>{d=!0}},[u.status.loadFailed]),a.useLayoutEffect(()=>{if(oe.current){if(!o.libraryId){H(void 0),J(o.target??"library_overview"),A(void 0),ce(void 0),De("detail");return}o.libraryId&&S.some(d=>d.libraryId===o.libraryId)&&H(o.libraryId),o.target&&J(o.target),A(o.collectionId),ce(o.revisionId),o.revisionView&&De(o.revisionView)}},[S,o.collectionId,o.libraryId,o.revisionId,o.revisionView,o.target]),a.useEffect(()=>{if(!b){_([]),A(void 0),h([]),P([]),ce(void 0);return}let d=!1;return F(!0),wa({libraryId:b,limit:200}).then(Ne=>{var ut;if(d)return;const q=Ne.items;_(q);const X=(ut=q.find(nt=>nt.collectionId===o.collectionId))==null?void 0:ut.collectionId;A(X)}).catch(()=>{d||(_([]),A(void 0))}).finally(()=>{d||F(!1)}),()=>{d=!0}},[o.collectionId,b]),a.useEffect(()=>{if(!b||Re!=="all_cards"&&E!=="new_card"){h([]);return}let d=!1;return ys({libraryId:b,limit:200}).then(Ne=>{d||h(Ne)}).catch(()=>{d||h([])}),()=>{d=!0}},[Re,b,E]),a.useEffect(()=>{if(!b||!$){P([]),ce(void 0);return}let d=!1;return Me(!0),Xs({libraryId:b,collectionId:$}).then(Ne=>{var ut,nt,bt,ft;if(d)return;P(Ne);const q=(nt=(ut=O.current.byLibrary)==null?void 0:ut[b])==null?void 0:nt.lastRevisionId,X=((bt=Ne.find(Mt=>Mt.revisionId===o.revisionId))==null?void 0:bt.revisionId)??((ft=Ne.find(Mt=>Mt.revisionId===q))==null?void 0:ft.revisionId);ce(X)}).catch(()=>{d||(P([]),ce(void 0))}).finally(()=>{d||Me(!1)}),()=>{d=!0}},[o.revisionId,$,b]),a.useEffect(()=>{const d=o.infoId;if(!b||!d){T(void 0);return}let Ne=!1;return Yt({libraryId:b,infoId:d}).then(q=>{if(Ne)return;const X=q.payload;T((X==null?void 0:X.label)??(X==null?void 0:X.name)??(X==null?void 0:X.title)??q.infoId)}).catch(()=>{Ne||T(d)}),()=>{Ne=!0}},[o.infoId,b]),a.useEffect(()=>{if(!oe.current||o.libraryId&&S.some(X=>X.libraryId===o.libraryId)&&o.libraryId!==b||o.target&&o.target!==E||o.revisionView&&o.revisionView!==re||o.revisionId&&o.revisionId!==ne||ds[E].requiresCollection&&!$&&o.target==="all_collections"&&o.collectionId)return;const d=xa(`${x.pathname}${x.search}`);if(xa(x.pathname)==="/cogita"&&!o.libraryId&&!b){k.current=null;return}const q=xa(qs(b,E,$,re,ne,o.infoId,o.infoView??"overview"));if(d===q){k.current=null;return}k.current!==q&&(k.current=q,l(q,{replace:!0}))},[S,x.pathname,x.search,l,o.collectionId,o.infoId,o.infoView,o.libraryId,o.revisionId,o.revisionView,o.target,$,b,ne,re,E]),a.useEffect(()=>{if(typeof window>"u")return;const d=()=>{window.innerWidth>920&&v(!1)};return window.addEventListener("resize",d),()=>window.removeEventListener("resize",d)},[]),a.useEffect(()=>{if(!oe.current||!de||!b||Pe.current)return;const d=O.current,Ne={...d.byLibrary??{}},q={...Ne[b]??{},lastCollectionId:$,lastRevisionId:ne,lastRevisionView:re,lastTarget:E},X={version:1,lastLibraryId:b,byLibrary:{...Ne,[b]:q}},ut=JSON.stringify(d),nt=JSON.stringify(X);if(ut===nt)return;O.current=X,Pe.current=!0,(async()=>{try{if(Je)await qn(Je,{plainValue:nt});else{const ft=await Un(de,{itemName:cs,itemType:"data",plainValue:nt});Ve(ft.dataItemId)}}catch{Ke(u.status.savePrefsFailed)}finally{Pe.current=!1}})()},[Je,de,$,b,ne,re,E,u.status.savePrefsFailed]);const D=async()=>{const d=Be.trim();if(!d){Ke(t.cogita.user.libraryNameRequired);return}Ke(null);try{const Ne=await Qn({name:d});Q(q=>[Ne,...q]),H(Ne.libraryId),J("library_overview"),A(void 0),Le("")}catch{Ke(t.cogita.user.libraryCreateFailed)}},ae=async()=>{if(!b){Ke(u.status.selectLibraryFirst);return}const d=qe.trim();if(!d){Ke(t.cogita.library.collections.saveRequiredName);return}Ke(null);try{const Ne=await Wn({libraryId:b,name:d,items:[]}),q=await wa({libraryId:b,limit:200});_(q.items),A(Ne.collectionId),ce(void 0),J("all_collections"),De("detail"),et("")}catch{Ke(t.cogita.library.collections.saveFail)}},Ce=async()=>{if(!b||!$){Ke(u.status.selectLibraryFirst);return}const d=Ge.trim();if(!d){Ke(u.revisionForm.nameLabel);return}Ke(null);try{const Ne=await Hn({libraryId:b,collectionId:$,name:d,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});P(q=>[Ne,...q]),ce(Ne.revisionId),J("all_collections"),De("settings"),Ae("")}catch{Ke(u.status.loadFailed)}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,headerExtra:b?e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:Se,onChange:d=>G(d.target.value),children:[e.jsx("option",{value:"",children:"No person"}),xe.map(d=>e.jsx("option",{value:d.roleId,children:d.label},d.roleId))]})]}):null,children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${ye?"open":""}`,"aria-label":u.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{children:(M==null?void 0:M.name)??u.path.noLibrarySelected}),e.jsx("p",{className:"cogita-sidebar-note",children:M?u.sidebar.libraryActionsHint:u.status.selectLibraryFirst}),pt(Et,"sidebar")]}),Rt?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:u.sidebar.infoActionsHint}),pt(Rt,"sidebar"),Ze?e.jsxs("div",{className:"cogita-sidebar-actions-nested",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(je==null?void 0:je.label)??me??t.cogita.library.list.selectedEmpty}),e.jsx("p",{className:"cogita-sidebar-note",children:u.sidebar.selectedInfoActionsHint}),pt(Ze,"sidebar")]}):null]}):null,se?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:se.name}),e.jsx("p",{className:"cogita-sidebar-note",children:u.sidebar.collectionActionsHint}),pt(gt,"sidebar")]}):null,e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:u.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:i,children:u.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{p("cogita"),v(!1)},children:u.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:c,children:m?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),ye?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":u.sidebar.closeMenu,onClick:()=>v(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":u.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>v(d=>!d),"aria-label":ye?u.sidebar.closeMenu:u.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),tt.map((d,Ne)=>e.jsxs("div",{className:"cogita-browser-segment",children:[Ne>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,d.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":d.label,children:d.selectedLabel}):e.jsxs("select",{"aria-label":d.label,value:d.value,onChange:q=>d.onSelect(q.target.value),disabled:d.disabled,children:[d.emptyOption?e.jsx("option",{value:"",children:d.emptyOption}):null,d.options.map(q=>e.jsx("option",{value:q.value,children:q.label},`${d.key}:${q.value}`))]})]},`menu:${d.key}`))]}),jt?e.jsxs(e.Fragment,{children:[E==="new_collection"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.library.actions.createCollection}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{type:"text",value:qe,onChange:d=>et(d.target.value),placeholder:t.cogita.library.collections.namePlaceholder,disabled:!b})]}),e.jsx("button",{type:"button",className:"cta",onClick:ae,disabled:!b,children:t.cogita.library.actions.createCollection}),Te?e.jsx("p",{className:"cogita-form-error",children:Te}):null]}):null,E==="all_collections"&&$&&re==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:u.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:u.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Ge,onChange:d=>Ae(d.target.value),placeholder:u.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Ce,children:u.revisionForm.createAction}),Te?e.jsx("p",{className:"cogita-form-error",children:Te}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(on.Provider,{value:!0,children:jt})})]}):null,jt?null:e.jsx(e.Fragment,{children:b?null:e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:He.step}),e.jsx("h2",{children:He.title})]}),e.jsxs("p",{children:[We+1," / ",yt]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:He.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:He.passages.map(d=>e.jsx("p",{children:d},d))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:He.focus.map(d=>e.jsx("span",{children:d},d))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:He.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:lt.map((d,Ne)=>e.jsx("button",{type:"button",className:`ghost ${Ne===We?"active":""}`,onClick:()=>_e(Ne),"aria-label":`${Ne+1}`,children:Ne+1},`tutorial:${d.title}:${Ne}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:We===0,onClick:()=>_e(d=>Math.max(0,d-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:We===yt-1,onClick:()=>_e(d=>Math.min(yt-1,d+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:Be,onChange:d=>Le(d.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:D,children:t.cogita.user.createLibraryAction}),Te?e.jsx("p",{className:"cogita-form-error",children:Te}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),S.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,S.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:S.map(d=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{it({libraryId:d.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:d.name})]},d.libraryId))}):null]})]})]})})]})]})})}const hr=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:rr},Symbol.toStringTag,{value:"Module"}));function or({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,shareId:l}){const[x,o]=a.useState(null),[u,S]=a.useState("loading"),[Q,W]=a.useState(t.cogita.library.collections.defaultName),[_,f]=a.useState("Cogita Library"),[h,ue]=a.useState([]),[P,b]=a.useState([]),[H,E]=a.useState("idle"),[J,$]=a.useState({current:0,total:0}),[A,ne]=a.useState(0),[ce,re]=a.useState(""),[De,me]=a.useState(null),[T,ye]=a.useState(null),[v,V]=a.useState(null),[fe,Y]=a.useState(null),[F,ve]=a.useState([]),[Me,Te]=a.useState({}),[Ke,Ie]=a.useState({}),[_e,Be]=a.useState(null),[Le,qe]=a.useState(null),[et,Ge]=a.useState(null),[Ae,xe]=a.useState(null),[te,Se]=a.useState({}),G=a.useRef(0),[de,ze]=a.useState(null),Je=a.useRef(null),Ve=a.useRef(null),[O,oe]=a.useState(null),[Pe,k]=a.useState(!1),[M,se]=a.useState(null),[le,ee]=a.useState([]),[$e,Re]=a.useState(null),we=a.useRef(null),be=a.useRef(null),[je,ke]=a.useState(null),[ot,Ue]=a.useState(0),Xe=a.useRef(null),lt=a.useRef({}),[yt,We]=a.useState(!1),[He,Ct]=a.useState({}),dt=a.useRef(null),Lt=a.useRef(new Set),ct=a.useRef({}),[it,$t]=a.useState([]),[xt,tt]=a.useState(new Set),[at,Et]=a.useState(!1),Rt=Va(),Ze=a.useMemo(()=>new URLSearchParams(Rt.search),[Rt.search]),gt=a.useMemo(()=>Ze.get("key")??"",[Ze]),pt=(x==null?void 0:x.mode)??"random",jt=(x==null?void 0:x.check)??"exact",D=(x==null?void 0:x.limit)??20,ae=a.useMemo(()=>Ns((x==null?void 0:x.revisionType)??pt),[x,pt]),Ce=a.useMemo(()=>{const C=x==null?void 0:x.revisionSettings,U=un(ae,Ze);return Wa(ae,C??U)},[x,Ze,ae]),d=a.useMemo(()=>t.cogita.library.revision[ae.labelKey]??pt,[t,pt,ae]),Ne=a.useMemo(()=>jt==="exact"?t.cogita.library.revision.checkValue:jt,[t,jt]),X=u==="ready"?h[A]??null:null,ut=(X==null?void 0:X.checkType)==="translation-match"&&Ae,nt=a.useRef(new Map),bt=a.useRef(new Map),ft=a.useRef(new Map),Mt=a.useRef(new Map),na=a.useMemo(()=>X?X.cardType==="vocab"?t.cogita.library.revision.vocabLabel:X.infoType?Ye(t,X.infoType):t.cogita.library.revision.infoLabel:"",[t,X]),Ht=a.useMemo(()=>{var U;return ae.id!=="levels"?h.length:((U=He.pool)==null?void 0:U.length)??ae.getFetchLimit(D,Ce)},[He,Ce,ae,h.length,D]),Bt=ae.getProgressTotal?ae.getProgressTotal(h,He,D,Ce):ae.id==="levels"?Math.min(D,Ht):h.length,vt=Bt?Math.min(A+1,Bt):0,wt=Math.max(1,Number(Ce.tries??1)),Ut=Ce.compare??"anchors",st=Math.max(0,Math.min(100,Number(Ce.minCorrectness??0))),rt=(Ce.considerDependencies??"on")==="on",Ft=Math.max(0,Math.min(100,Number(Ce.dependencyThreshold??85))),ia=C=>{const U=C.slice();for(let r=U.length-1;r>0;r-=1){const g=Math.floor(Math.random()*(r+1));[U[r],U[g]]=[U[g],U[r]]}return U},ra=C=>C.length?C.reduce((r,g)=>r+g,0)/C.length/255*100:0,pa=C=>ra(C)>=st,Ha=async()=>{const C=await qt(),U=new Map,r=new Map;C.forEach(w=>{const z=`${w.itemType}:${w.itemId}`,j=Vt(w.itemType,w.itemId,w.checkType,w.direction);U.has(z)||U.set(z,[]),U.get(z).push(w),r.has(j)||r.set(j,[]),r.get(j).push(w)});const g=new Map,N=new Map;return U.forEach((w,z)=>g.set(z,Ot(w).score)),r.forEach((w,z)=>N.set(z,Ot(w).score)),{itemKnowness:g,cardKnowness:N}},fa=async C=>{const U=He,r=C.concat(U.active??[]).concat(U.pool??[]).filter((B,Z,ie)=>ie.findIndex(pe=>he(pe)===he(B))===Z);if(!rt){tt(new Set(r.map(he)));return}const{itemKnowness:g,cardKnowness:N}=await Ha(),w=B=>{if(B.cardType!=="info"||B.infoType!=="citation"||B.checkType!=="quote-fragment")return!0;const Z=It(B.direction);if(!(Z!=null&&Z.fragmentId))return!0;const ie=B.description??"";if(!ie.trim())return!0;const ge=sa(ie).nodes[Z.fragmentId];if(!ge||!ge.leftId&&!ge.rightId)return!0;const Ee=[ge.leftId,ge.rightId].filter(Qe=>!!Qe);if(Ee.length===0)return!0;const Fe=Ee.map(Qe=>{const ht=Vt("info",B.cardId,"quote-fragment",ka(Z.mode,Qe));return N.get(ht)??0});return Fe.reduce((Qe,ht)=>Qe+ht,0)/Fe.length>=Ft},z=(x==null?void 0:x.collectionId)??null,j=z?it.filter(B=>mt(B.childItemType)==="collection"&&B.childItemId===z&&!mt(B.childCheckType)&&!mt(B.childDirection)):[],K=z&&r.length>0?r.reduce((B,Z)=>B+(N.get(he(Z))??0),0)/r.length:0,I=new Set;for(const B of r){if(B.cardType!=="info"){I.add(he(B));continue}if(!w(B))continue;const Z=it.filter(ge=>bn(ge,B)).concat(j);if(Z.length===0){I.add(he(B));continue}let ie=0;for(const ge of Z)if(mt(ge.parentItemType)==="collection")ie+=ge.parentItemId===z?K:0;else if(mt(ge.parentCheckType)||mt(ge.parentDirection)){const Ee=mt(ge.parentCheckType),Fe=mt(ge.parentDirection),Oe=Vt(ge.parentItemType,ge.parentItemId,Ee,Fe);ie+=N.get(Oe)??0}else{const Ee=`${ge.parentItemType}:${ge.parentItemId}`;ie+=g.get(Ee)??0}ie/Z.length>=Ft&&I.add(he(B))}tt(I)},Qa=C=>{for(let U=C;U<h.length;U+=1){const r=h[U];if(r&&(!rt||r.cardType!=="info"||xt.has(he(r))))return U}return-1},oa=C=>!rt||C.cardType!=="info"||xt.has(he(C)),Ya=C=>{if(ae.id!=="temporal"&&ae.id!=="levels")return null;const U=He,r=(U.active??[]).concat(U.pool??[]),g=new Set;for(const N of r){const w=he(N);if(!(g.has(w)||C.has(w))&&(g.add(w),oa(N)))return N}return null},At=a.useMemo(()=>{if(ae.id!=="levels")return null;const C=He,U=C.pool??[],r=C.active??[],g=C.levelMap??{},N=Math.max(1,Number(Ce.levels??1)),w=Array.from({length:N},()=>0),z=new Set(r.map(B=>he(B)));U.forEach(B=>{const Z=Math.min(N,Math.max(1,g[he(B)]??1));w[Z-1]+=1});const j=U.length||1,K=w.map(B=>B/j*100),I=X?g[he(X)]??1:null;return{counts:w,percentages:K,currentLevel:I,levelsCount:N,activeCount:r.length,poolCount:U.length,activeSet:z}},[He,Ce,ae,X]),ca=a.useMemo(()=>{if(ae.id!=="temporal")return null;const C=He,U=C.pool??[],r=C.active??[],g=C.knownessMap??{},N=new Set(C.unknownSet??[]);let w=0;U.forEach(K=>{(g[he(K)]??0)>1&&(w+=1)});const z=N.size,j=r.map(K=>({id:he(K),value:N.has(he(K))?0:Math.max(0,Math.min(1,g[he(K)]??0))}));return{knownCount:w,unknownCount:z,dots:j}},[He,ae]),Kt=a.useMemo(()=>{if(!rt)return 0;const C=He;return h.concat(C.active??[]).concat(C.pool??[]).filter((r,g,N)=>N.findIndex(w=>he(w)===he(r))===g).filter(r=>r.cardType==="info"&&!xt.has(he(r))).length},[rt,He,h,xt]);a.useEffect(()=>{if(!rt||H!=="ready")return;const C=He,r=h.concat(C.active??[]).concat(C.pool??[]).filter((w,z,j)=>j.findIndex(K=>he(K)===he(w))===z).filter(w=>w.cardType!=="info"||xt.has(he(w))).length,g=we.current;if(we.current=r,g===null||r<=g)return;const N=r-g;Re(`New card available (+${N})`),be.current&&window.clearTimeout(be.current),be.current=window.setTimeout(()=>Re(null),2200)},[rt,H,He,h,xt]),a.useEffect(()=>()=>{be.current&&window.clearTimeout(be.current)},[]);const kt=(C,U)=>{const r=ae.applyOutcome({queue:h,meta:He},X,D,Ce,{correct:C,correctness:U,createdUtc:new Date().toISOString()});ue(r.queue),Ct(r.meta);const g=r.queue[A+1];g&&Pt(g,A+1)};a.useEffect(()=>{if(!l){S("error");return}S("loading"),Yn({shareId:l,key:gt}).then(C=>{o(C),W(C.collectionName),f(C.libraryName),S("ready")}).catch(()=>{S("error")})},[l,gt]),a.useEffect(()=>{l&&Gn({shareId:l,key:gt,type:"language"}).then(C=>b(C)).catch(()=>b([]))},[l,gt]),a.useEffect(()=>{!l||u!=="ready"||Jn({shareId:l,key:gt}).then(C=>$t(C.items??[])).catch(()=>$t([]))},[l,gt,u]),a.useEffect(()=>{if(!l||u!=="ready")return;let C=!0;return(async()=>{E("loading"),$({current:0,total:ae.id==="levels"?0:ae.getFetchLimit(D,Ce)});try{const r=[];let g=null,N=null;do{const Z=await Xn({shareId:l,key:gt,limit:300,cursor:g});if(r.push(...Z.items),(ae.id==="levels"||ae.id==="temporal")&&Z.total&&(N=Z.total),$(ie=>({current:r.length,total:ie.total||Z.total||ae.getFetchLimit(D,Ce)})),g=Z.nextCursor??null,N!==null&&r.length>=N||ae.id!=="levels"&&ae.id!=="temporal"&&r.length>=ae.getFetchLimit(D,Ce))break}while(g);if(!C)return;const w=gs(r);let z;if(ae.id==="levels"){const Z=Math.max(1,Number(Ce.levels??1));z={},w.forEach(ie=>{const pe=he(ie);z[pe]=Math.max(1,Math.min(Z,1))})}let j=null,K=null,I=null;if(ae.id==="temporal"){const Z=await qt(),ie=new Set(w.map(Ee=>he(Ee))),pe=Z.reduce((Ee,Fe)=>{const Oe=Vt(Fe.itemType,Fe.itemId,Fe.checkType,Fe.direction);return ie.has(Oe)&&(Ee[Oe]||(Ee[Oe]=[]),Ee[Oe].push(Fe)),Ee},{});j={},K=new Set,I={};const ge=Date.now();w.forEach(Ee=>{const Fe=he(Ee),Oe=pe[Fe]??[];if(Oe.length===0){j[Fe]=0,K.add(Fe),I[Fe]=[];return}const Qe=ws(Oe);I[Fe]=Qe;const ht=qa(Qe,ge);j[Fe]=ht.knowness})}const B=ae.id==="levels"?ks(w,D,Ce,z):ae.id==="temporal"?js(w,D,Ce,j??{},K??new Set,I??{}):ae.prepare(w,D,Ce);ue(B.queue),Ct(B.meta),ne(0),E("ready"),$(Z=>({current:Math.min(Z.current,Z.total),total:Z.total}))}catch{C&&E("error")}})(),()=>{C=!1}},[l,gt,D,ae,Ce,u]),a.useEffect(()=>{fa(h)},[h,it,rt,Ft,x==null?void 0:x.collectionId]),a.useEffect(()=>{if(!X||!rt){Et(!1);return}if(X.cardType!=="info"||xt.has(he(X))){Et(!1);return}const C=Qa(A+1);if(C>=0){Et(!1),ne(C);return}if(ae.id==="temporal"||ae.id==="levels"){const U=h.slice(0,A+1),r=h.slice(A+1).filter(oa),g=U.concat(r),N=new Set(g.map(he)),w=Ya(N);if(w){const j=he(w);N.has(j)||(g.push(w),N.add(j),Ct(K=>{const I=K,B=new Set(I.queued??[]);return B.add(j),{...I,queued:B}}))}const z=g.findIndex((j,K)=>K!==A&&oa(j));if(z>=0){ue(g),ne(z),Et(!1);return}}Et(!0)},[X,xt,rt,A,h,He,ae.id]),a.useEffect(()=>{if(re(""),me(null),ke(null),Ue(0),ve([]),Te({}),Ie({}),Be(null),qe(null),Ge(null),k(!1),We(!1),oe(null),xe(null),Se({}),!X){ye(null),V(null);return}X.cardType==="info"&&X.infoType==="computed"&&ye(t.cogita.library.revision.loadingComputed);let C=!0;return Pt(X,A).then(U=>{!C||!U||(ye(U.prompt),V(U.expectedAnswer),ve(U.computedExpected),Te(U.computedAnswers),Be(U.answerTemplate),qe(U.outputVariables),Ge(U.variableValues))}),()=>{C=!1}},[X,l,t]),a.useEffect(()=>{if(!X||X.cardType!=="info"||X.infoType!=="citation"){dt.current=null,Lt.current=new Set,Y(null);return}const C=X.description??"",U=(X.label??"").trim(),r=U.replace(/\s+/g," ").trim(),g=C.replace(/\s+/g," ").trim(),N=r&&r!==g?U:t.cogita.library.infoTypes.citation;if(!C){Y(null),V(null);return}const w=sa(C);dt.current=w,ye(N);let z=!0;return qt().then(j=>{if(!z)return;const K=getQuoteMode(X.direction),I=new Map;j.forEach(ge=>{if(ge.itemType!=="info"||ge.checkType!=="quote-fragment"||!ge.direction)return;const Ee=It(ge.direction);if(!Ee||Ee.mode!==K)return;const Fe=`${ge.itemId}:${Ee.fragmentId}`;I.has(Fe)||I.set(Fe,[]),I.get(Fe).push(ge)});const B={},Z=new Set;I.forEach((ge,Ee)=>{const[Fe,Oe]=Ee.split(":",2);if(Fe!==X.cardId)return;const Qe=Ot(ge).score;B[Oe]=Qe,Qe>=Ft&&Z.add(Oe)}),Lt.current=Z,ct.current=B;const ie=It(X.direction);if(ie!=null&&ie.fragmentId&&w.nodes[ie.fragmentId]){Xt(w,ie.fragmentId,N);return}const pe=ga(w,Z,B,Ft,rt,X.direction);Xt(w,(pe==null?void 0:pe.id)??null,N)}).catch(()=>{Lt.current=new Set,ct.current={};const j=It(X.direction);if(j!=null&&j.fragmentId&&w.nodes[j.fragmentId]){Xt(w,j.fragmentId,N);return}const K=ga(w,Lt.current,{},Ft,rt,X.direction);Xt(w,(K==null?void 0:K.id)??null,N)}),()=>{z=!1}},[X,t,rt,Ft]),a.useEffect(()=>{if(!X||X.cardType!=="vocab"||X.checkType!=="translation-match"){xe(null),Se({});return}const r=(He.pool??He.active??h).filter(j=>j.cardType==="vocab"&&j.checkType==="translation-match").filter((j,K,I)=>I.findIndex(B=>B.cardId===j.cardId)===K);r.some(j=>j.cardId===X.cardId)||r.unshift(X);const N=ia(r).slice(0,6).map(j=>{const K=j.label.split("↔").map(Z=>Z.trim()).filter(Boolean);if(K.length<2)return null;const I=`${j.cardId}:L`,B=`${j.cardId}:R`;return{cardId:j.cardId,leftId:I,rightId:B,leftLabel:K[0],rightLabel:K[1]}}).filter(Boolean),w=N.map(j=>j.leftId),z=ia(N.map(j=>j.rightId));xe({pairs:N,leftOrder:w,rightOrder:z,selection:{},activeLeft:null,activeRight:null,locked:{}})},[X,h,He]),a.useEffect(()=>()=>{Je.current&&window.clearTimeout(Je.current),Ve.current&&window.clearTimeout(Ve.current)},[]);const la=a.useRef(null);a.useEffect(()=>{if(!X)return;const C=he(X),U=typeof document<"u"?document.activeElement:null;if(la.current===C&&U&&(U.tagName==="INPUT"||U.tagName==="TEXTAREA"))return;let r=0;const g=()=>{if(X){if(X.cardType==="info"&&X.infoType==="computed"){if(F.length>0){const w=_a(_e,F,Le),z=w?lt.current[w]:null;if(z&&(z.focus(),document.activeElement===z)){la.current=C;return}}if(Xe.current&&(Xe.current.focus(),document.activeElement===Xe.current)){la.current=C;return}}else if(X.cardType==="vocab"&&Xe.current&&(Xe.current.focus(),document.activeElement===Xe.current)){la.current=C;return}r<6&&(r+=1,window.setTimeout(g,40))}},N=window.setTimeout(g,40);return()=>window.clearTimeout(N)},[X,F,_e,Le]),a.useEffect(()=>{if(!yt)return;const C=U=>{U.key==="Enter"&&(U.preventDefault(),da())};return window.addEventListener("keydown",C),()=>window.removeEventListener("keydown",C)},[yt]);const Nt=C=>{ee(C),se(Ot(C))};a.useEffect(()=>{if(!X){se(null),ee([]);return}const C=X.cardType==="info"?"info":"connection";if(X.cardType==="info"&&X.infoType==="citation"){qt().then(U=>{const r=U.filter(g=>g.itemType==="info"&&g.itemId===X.cardId&&g.checkType==="quote-fragment"&&Ba(g.direction,X.direction));Nt(r)}).catch(()=>{se(null),ee([])});return}za(C,X.cardId,X.checkType,X.direction).then(U=>Nt(U)).catch(()=>{se(null),ee([])})},[X]);const Gt=(C,U,r,g)=>{if(C==="info"&&r==="quote-fragment"){qt().then(N=>{const w=N.filter(z=>z.itemType==="info"&&z.itemId===U&&z.checkType==="quote-fragment"&&Ba(z.direction,g));Nt(w)}).catch(()=>{se(null),ee([])});return}za(C,U,r,g).then(N=>Nt(N)).catch(()=>{se(null),ee([])})},Jt=(C,U,r)=>{var z;const g=((z=r.pairs.find(j=>j.leftId===C))==null?void 0:z.rightId)??null;if(!g)return r;const N=g===U;Se(j=>({...j,[C]:N?"correct":"incorrect"})),Je.current&&window.clearTimeout(Je.current),Ve.current&&window.clearTimeout(Ve.current),G.current+=1;const w={kind:N?"correct":"incorrect",tick:G.current};if(ze(null),Je.current=window.setTimeout(()=>ze(w),0),Ve.current=window.setTimeout(()=>ze(null),420),N){const j={...r.locked,[C]:!0};return Object.keys(j).length>=r.pairs.length?(me("correct"),We(!0)):me("correct"),{...r,selection:{...r.selection,[C]:U},activeLeft:null,activeRight:null,locked:j}}return me("incorrect"),{...r,activeLeft:null,activeRight:null}},Sa=C=>{xe(U=>!U||U.locked[C]?U:U.activeRight?Jt(C,U.activeRight,U):{...U,activeLeft:U.activeLeft===C?null:C})},Ta=C=>{xe(U=>U&&(U.activeLeft?Jt(U.activeLeft,C,U):{...U,activeRight:U.activeRight===C?null:C}))},da=()=>{var C;if(X&&X.cardType==="info"&&X.infoType==="citation"&&dt.current&&fe&&!((C=It(X.direction))!=null&&C.fragmentId)){const U=ga(dt.current,Lt.current,ct.current,Ft,rt,X.direction,fe.fragmentId);if(U){me(null),re(""),k(!1),Ie({}),We(!1),ke(null),Ue(0),Xt(dt.current,U.id,fe.title);return}}me(null),re(""),k(!1),Ie({}),We(!1),ke(null),Ue(0),ne(U=>Math.min(U+1,h.length))},zt=C=>{if(!X)return;const U=C.expected??null,r=C.answer??"";let g=U??"",N=r;if(!U&&C.expectedMap&&C.answerMap){const Z=Object.keys(C.expectedMap).sort((ie,pe)=>ie.localeCompare(pe));g=Z.map(ie=>{var pe;return((pe=C.expectedMap)==null?void 0:pe[ie])??""}).join("|"),N=Z.map(ie=>{var pe;return((pe=C.answerMap)==null?void 0:pe[ie])??""}).join("|")}const w=g?ma(g,N,Ut):new Uint8Array,z={revisionType:ae.id,evalType:C.evalType,direction:C.direction,prompt:T??"",expected:U,answer:r,expectedAnswers:C.expectedMap??null,answers:C.answerMap??null,correct:C.correct,maskBase64:w.length?Qt(w):null,checkMode:jt,compareMode:Ut,minCorrectness:st},j=new TextEncoder().encode(JSON.stringify(z)),K=X.cardType==="info"?"info":"connection",I=C.overrideCheckType??X.checkType??null,B=C.overrideDirection??X.direction??null;Ka({itemType:K,itemId:X.cardId,checkType:I,direction:B,revisionType:ae.id,evalType:C.evalType,correct:C.correct,maskBase64:w.length?Qt(w):null,payloadBase64:Qt(j)}).then(()=>{Gt(K,X.cardId,I,B),fa(h)}).catch(()=>{})},ua=(C,U)=>{const r=nt.current.get(U);if(r)return Promise.resolve(r);const g=bt.current.get(U);if(g)return g;const N=Zn({shareCode:l,infoId:C,key:gt}).then(w=>{var Z,ie;const z=w.payload,j=((Z=z.definition)==null?void 0:Z.graph)??null,K="",I=((ie=z.definition)==null?void 0:ie.answerTemplate)??"",B=hn(j,K,I);if(B){const ge={sample:gn(B),answerTemplate:I||null};return nt.current.set(U,ge),ge}return Ms({shareId:l,infoId:C,key:gt}).then(pe=>{const ge={sample:pe,answerTemplate:null};return nt.current.set(U,ge),ge})}).catch(()=>Ms({shareId:l,infoId:C,key:gt}).then(w=>{const z={sample:w,answerTemplate:null};return nt.current.set(U,z),z}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{bt.current.delete(U)});return bt.current.set(U,N),N},Pt=(C,U)=>{var j;const r=`${he(C)}:${U}`,g=ft.current.get(r);if(g)return Promise.resolve(g);const N=Mt.current.get(r);if(N)return N;const w=K=>(ft.current.set(r,K),K);let z;if(C.cardType==="vocab"){if(C.checkType==="translation-match")return z=Promise.resolve(w({prompt:C.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),z;const K=C.label.split("↔").map(I=>I.trim()).filter(Boolean);if(K.length>=2){const B=(C.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",Z=B?K[0]:K[1],ie=B?K[1]:K[0];z=Promise.resolve(w({prompt:Z,expectedAnswer:ie,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else z=Promise.resolve(w({prompt:C.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(C.cardType==="info"&&C.infoType==="word"){const K=(j=C.description)!=null&&j.startsWith("Language: ")?C.description.replace("Language: ",""):null;z=Promise.resolve(w({prompt:C.label,expectedAnswer:K,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else C.cardType==="info"&&C.infoType==="computed"?z=ua(C.cardId,r).then(K=>{var pe,ge;if(!K.sample)return w({prompt:C.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const I=K.sample,B=I.expectedAnswers?Object.entries(I.expectedAnswers).map(([Ee,Fe])=>({key:Ee,expected:Fe})):[],Z=B.reduce((Ee,Fe)=>(Ee[Fe.key]="",Ee),{}),ie=I.expectedAnswerIsSentence&&((pe=I.expectedAnswer)==null?void 0:pe.trim())||null;return w({prompt:I.prompt,expectedAnswer:B.length>0?ie:((ge=I.expectedAnswer)==null?void 0:ge.trim())||null,computedExpected:B,computedAnswers:Z,answerTemplate:K.answerTemplate,outputVariables:I.outputVariables??null,variableValues:I.variableValues??null})}).catch(()=>w({prompt:C.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Mt.current.delete(r)}):z=Promise.resolve(w({prompt:C.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return Mt.current.set(r,z),z},Xt=(C,U,r)=>{const g=Object.keys(C.nodes).length,N=Lt.current.size;if(!U){Y({title:r,before:C.text,after:"",fragmentId:null,total:g,completed:N}),V(null),We(!0);return}const w=C.nodes[U];if(!w)return;const z=xs(C.text,w);Y({title:r,before:z.before,after:z.after,fragmentId:w.id,total:g,completed:N}),V(z.fragment),We(!1)},ba=()=>{const C=dt.current;C&&Y(U=>U&&{...U,total:Object.keys(C.nodes).length,completed:Lt.current.size})},Dt=()=>{const C=h[A+1];C&&Pt(C,A+1)},Ca=()=>{if(Dt(),X&&X.cardType==="vocab"&&X.checkType==="translation-match"&&Ae){if(Ae.pairs.length===0){me("incorrect"),We(!0);return}const w=Ae.pairs.reduce((ie,pe)=>(ie[pe.rightId]=pe.rightLabel,ie),{});let z=0;const j={};Ae.pairs.forEach(ie=>{const ge=Ae.selection[ie.leftId]===ie.rightId;j[ie.leftId]=ge?"correct":"incorrect",ge&&(z+=1)});const K=Ae.pairs.length||1,I=z/K,B=z===Ae.pairs.length;Se(ie=>({...ie,...j})),B?(me("correct"),We(!0),Ue(0)):(me("incorrect"),We(!1),Ue(ie=>{const pe=ie+1;return pe>=wt&&(k(!0),We(!0),xe(ge=>{if(!ge)return ge;const Ee=ge.pairs.reduce((Fe,Oe)=>(Fe[Oe.leftId]=Oe.rightId,Fe),{});return{...ge,selection:Ee}})),pe})),kt(B,I);const Z="connection";Promise.all(Ae.pairs.map(ie=>{const pe=Ae.selection[ie.leftId]??null,ge=pe?w[pe]:"",Ee={left:ie.leftLabel,expected:ie.rightLabel,answer:ge,checkType:"translation-match"},Fe=new TextEncoder().encode(JSON.stringify(Ee));return Ka({itemType:Z,itemId:ie.cardId,checkType:"translation-match",direction:null,revisionType:ae.id,evalType:"translation-match",correct:pe===ie.rightId,maskBase64:null,payloadBase64:Qt(Fe)})})).then(()=>{Gt(Z,X.cardId,X.checkType,X.direction),fa(h)}).catch(()=>{});return}if(F.length>0){const w=F.reduce((j,K)=>{const I=Me[K.key]??"";return j[K.key]=St(I)===St(K.expected)?"correct":"incorrect",j},{});F.every(({key:j,expected:K})=>{const I=Me[j]??"";return jt==="exact"&&St(I)===St(K)})?(me("correct"),Ie(w),We(!0),Ue(0),kt(!0,1),zt({correct:!0,direction:T?`${T} -> computed`:"computed",expectedMap:F.reduce((j,K)=>(j[K.key]=K.expected,j),{}),answerMap:Me,evalType:"computed"})):(me("incorrect"),Ie(w),We(!1),Ue(j=>{const K=j+1;return K>=wt&&Zt&&(k(!0),We(!0)),K}),kt(!1,0),window.setTimeout(()=>{var K;const j=_a(_e,F,Le);j&&lt.current[j]&&((K=lt.current[j])==null||K.focus())},40),zt({correct:!1,direction:T?`${T} -> computed`:"computed",expectedMap:F.reduce((j,K)=>(j[K.key]=K.expected,j),{}),answerMap:Me,evalType:"computed"}));return}if(X&&X.cardType==="info"&&X.infoType==="citation"&&(fe!=null&&fe.fragmentId)){if(!v)return;const w=It(X.direction),z=(w==null?void 0:w.mode)??getQuoteMode(X.direction),j=w!=null&&w.fragmentId&&X.direction?X.direction:ka(z,fe.fragmentId),K=Pa(v,ce,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),I=K.mask,B=K.isCorrect,Z=K.percent;B?(ct.current[fe.fragmentId]=Math.max(ct.current[fe.fragmentId]??0,Z),(ct.current[fe.fragmentId]??0)>=Ft&&Lt.current.add(fe.fragmentId),ba(),me("correct"),Ie({}),We(!0),ke(I),Ue(0),Z<100&&wt<=1&&k(!0),kt(!0,Z/100),zt({correct:!0,direction:`quote:${fe.fragmentId}`,expected:v,answer:ce,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:j})):(me("incorrect"),Ie({}),We(!1),ke(I),Ue(ie=>{const pe=ie+1;return pe>=wt&&Zt&&(k(!0),We(!0)),pe}),kt(!1,Z/100),window.setTimeout(()=>{var ie;return(ie=Xe.current)==null?void 0:ie.focus()},40),zt({correct:!1,direction:`quote:${fe.fragmentId}`,expected:v,answer:ce,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:j}));return}if(!v)return;const C=ma(v,ce,Ut),U=jt==="exact"&&St(ce)===St(v),r=pa(C),g=U||r,N=ra(C);g?(me("correct"),Ie({}),We(!0),ke(C),Ue(0),N<100&&wt<=1&&k(!0),kt(!0,N/100),zt({correct:!0,direction:T?`${T} -> ${v}`:null,expected:v,answer:ce,evalType:"text"})):(me("incorrect"),Ie({}),We(!1),ke(C),Ue(w=>{const z=w+1;return z>=wt&&Zt&&(k(!0),We(!0)),z}),kt(!1,N/100),window.setTimeout(()=>{var w;return(w=Xe.current)==null?void 0:w.focus()},40),zt({correct:!1,direction:T?`${T} -> ${v}`:null,expected:v,answer:ce,evalType:"text"}))},ha=C=>{if(Dt(),!v)return;const U=ma(v,C,Ut),r=St(C)===St(v),g=pa(U),N=r||g,w=ra(U);N?(me("correct"),Ie({}),We(!0),ke(U),Ue(0),w<100&&wt<=1&&k(!0),kt(!0,w/100),zt({correct:!0,direction:"word->language",expected:v,answer:C,evalType:"language-select"})):(me("incorrect"),Ie({}),We(!1),ke(U),Ue(z=>{const j=z+1;return j>=wt&&Zt&&(k(!0),We(!0)),j}),kt(!1,w/100),zt({correct:!1,direction:"word->language",expected:v,answer:C,evalType:"language-select"}))},Ma=C=>{var r;if(C.key!=="Enter")return;if(C.preventDefault(),C.stopPropagation(),yt){da();return}const U=F.find(g=>!(Me[g.key]??"").trim());if(U){(r=lt.current[U.key])==null||r.focus();return}Ca()},Ga=()=>{Dt(),me("correct"),We(!0),Ue(0),kt(!0,1),v&&zt({correct:!0,direction:"manual",expected:v,answer:ce,evalType:"manual"})},Ja=()=>{if(kt(!1,0),X&&X.cardType==="info"&&X.infoType==="citation"){me(null),re(""),k(!1),Ie({}),We(!1),ke(null),Ue(0),ne(C=>Math.min(C+1,h.length));return}da()};a.useEffect(()=>{Dt()},[A,h]);const Xa=t.cogita.library.revision.revealModeAfterIncorrect,Zt=F.length>0||!!v;return e.jsxs(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:c,onLogout:y,secureMode:m,onNavigate:p,language:R,onLanguageChange:L,children:[(u==="loading"||H==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:u==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${J.total?Math.min(100,Math.max(0,J.current/J.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:J.total?`${Math.min(J.current,J.total)} / ${J.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:Q}),e.jsx("p",{className:"cogita-library-subtitle",children:_}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",d).replace("{check}",Ne)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:M?`${M.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[At?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",At.currentLevel??"-"," / ",At.levelsCount]}):null,M?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(M.correct)).replace("{total}",String(M.total))}),M.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(M.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(mn,{outcomes:le})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[$e?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:$e})}):null,e.jsx("section",{className:"cogita-revision-card","data-feedback":de?`${de.kind}-${de.tick}`:ut?"idle":De??"idle",children:u!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:u==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):X?e.jsx(e.Fragment,{children:at?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(vs,{copy:t,currentCard:X,currentTypeLabel:na,prompt:T,languages:P,answer:ce,onAnswerChange:C=>re(U=>Da(U,C,O)),computedExpected:F,computedAnswers:Me,onComputedAnswerChange:(C,U)=>Te(r=>({...r,[C]:Da(r[C]??"",U,O)})),answerTemplate:_e,outputVariables:Le,variableValues:et,computedFieldFeedback:Ke,feedback:De,canAdvance:yt,quoteContext:fe,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Ca,onSkip:Ja,onLanguageSelect:ha,onMarkReviewed:Ga,onAdvance:da,showCorrectAnswer:Pe,setShowCorrectAnswer:k,onRevealCorrect:()=>We(!0),answerMask:je,expectedAnswer:v,hasExpectedAnswer:Zt,handleComputedKeyDown:Ma,answerInputRef:Xe,computedInputRefs:lt,scriptMode:O,setScriptMode:oe,matchPairs:Ae==null?void 0:Ae.pairs,matchLeftOrder:Ae==null?void 0:Ae.leftOrder,matchRightOrder:Ae==null?void 0:Ae.rightOrder,matchSelection:Ae==null?void 0:Ae.selection,matchActiveLeft:Ae==null?void 0:Ae.activeLeft,matchActiveRight:Ae==null?void 0:Ae.activeRight,matchFeedback:te,onMatchLeftSelect:Sa,onMatchRightSelect:Ta})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Bt?`${vt} / ${Bt}`:t.cogita.library.revision.progressUnlimited}),u==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),u==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),u==="ready"&&H==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),u==="ready"&&H==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),u==="ready"&&H==="ready"&&h.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Xa}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",wt]})]})]}),At?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",At.activeCount," / ",At.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:At.counts.map((C,U)=>{const r=U+1,g=At.currentLevel===r,N=At.percentages[U]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":g,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:r}),e.jsx("strong",{children:C})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,N))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[N.toFixed(1),"%"]})]},`level-${r}`)})})]}):null,ca?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:ca.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:ca.dots.map(C=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-C.value))}, ${Math.round(200*C.value)}, 80, 0.9)`}},C.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:ca.knownCount})]})]}):null,rt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Kt})]})}):null]})]})]})})})]})]})}const gr=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:or},Symbol.toStringTag,{value:"Module"}));export{ur as C,hr as a,gr as b};
