import{r as a,j as e,u as $s,a as Rs,b as Es,c as As,R as Fs,B as Ps,C as _s,d as ds}from"./vendor-B-s_ukyJ.js";import{L as Bs,A as Ks,g as qs,a as cn,b as va,c as Ds,s as ps,d as Vs,e as bs,f as us,h as Os,i as dn,j as ua,u as un,k as hn,p as gn,l as mn,m as Us,r as zs,n as fn,o as pn,q as bn,t as qa,v as $a,w as yn,x as xn,y as vn,z as wn,B as jn,C as Nn,D as kn,E as ys,F as Qt,G as Tn,H as Sn,I as Cn,J as Mn,K as In,M as Ln,N as $n,O as Rn,P as En,Q as An,R as Fn,S as Pn,T as _n,U as Bn,V as Kn,W as qn,X as xs}from"./recreatio-core-B7V_U7t3.js";import"./vendor-cogita-ui-BuvhRVJJ.js";const xa={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},ya={moveMs:900,pauseMs:220,errorMs:900},Dn=(t=11)=>{let s=t;const n=()=>(s=(s*1664525+1013904223)%4294967296,s/4294967296),{width:r,height:l,paddingX:g,paddingY:b,levels:y}=xa,A=(l-b*2)/(y.length-1),j=[],d=[],N=[];y.forEach((v,h)=>{const ie=l-b-h*A,_=r-g*2,m=[];for(let z=0;z<v;z+=1){const L=g+(z+1)*_/(v+1),G=(n()-.5)*18,T=Math.max(g,Math.min(r-g,L+G)),R=h===0?3:h<2?2.1:1.4,ee=h===0?"root":`l${h}-${z}`;m.push({id:ee,x:h===0?r/2:T,y:ie,r:R,level:h,role:h===0?"root":void 0})}N.push(m),j.push(...m)});const c=N[N.length-1];if(c!=null&&c.length){const v=c[Math.floor(c.length/2)];v.role="goal",v.r=2}for(let v=1;v<N.length;v+=1){const h=N[v-1];N[v].forEach(_=>{const m=[...h].sort((T,R)=>Math.abs(T.x-_.x)-Math.abs(R.x-_.x)),z=m[0],L=m[1]&&n()<.45?m[1]:null;(L?[z,L]:[z]).forEach(T=>{d.push({from:T.id,to:_.id,key:`${T.id}-${_.id}`})}),n()<.2&&m[2]&&d.push({from:m[2].id,to:_.id,key:`${m[2].id}-${_.id}`})})}const o=new Map;d.forEach(v=>{const h=o.get(v.to)??[];h.push(v.from),o.set(v.to,h)});const H=new Map,le=new Map,Y=new Map;d.forEach(v=>{const h=H.get(v.from)??[];h.push(v.key),H.set(v.from,h);const ie=le.get(v.from)??[];ie.push(v.to),le.set(v.from,ie);const _=Y.get(v.from)??[];_.push(v.to),Y.set(v.from,_);const m=Y.get(v.to)??[];m.push(v.from),Y.set(v.to,m)});const U=new Map;return j.forEach(v=>{U.set(v.id,v)}),{nodes:j,links:d,parentsById:o,linksByFrom:H,childrenByFrom:le,neighborsById:Y,nodesById:U}};function Vn({slides:t,activeIndex:s,introOpen:n,prefersReducedMotion:r,onNext:l,onPrev:g,onSelect:b,onExit:y,onOpen:A,onRegister:j}){const d=s===t.length-1,N=n&&s===0?"entry":"docked",c=t[t.length-1],[o,H]=a.useState(!1),le=a.useMemo(()=>Array.from({length:20},(I,X)=>({src:`/cogita/logo/Cogita${String(X).padStart(2,"0")}.png`,kind:X<=11?"bubble":X<=17?"text":"recreatio"})),[]),Y=n&&s===0;a.useEffect(()=>{if(!n){H(!1);return}s>0&&!o&&H(!0)},[s,n,o]);const U=a.useRef(0),v=a.useRef(null),h=a.useMemo(()=>{const I={x:40,y:160},X={x:260,y:48},ve=6,$=X.x-I.x,O=I.y-X.y,fe=$/ve,be=[.3,.45,.6,.65,1.4,2.2],pe=be.reduce((Ae,Te)=>Ae+Te,0),Ee=be.map(Ae=>O*Ae/pe),We=[I];let Oe=I.x,Ie=I.y;for(let Ae=1;Ae<=ve;Ae+=1){const Te=(Math.random()-.5)*14,ot=(Math.random()-.5)*28;Oe=Math.max(I.x+Ae*14,Math.min(X.x-(ve-Ae)*14,Oe+fe+Te));const Ue=Ee[Ae-1]??Ee[Ee.length-1];Ie=Ie-Ue+ot;const at=Math.max(X.y,Math.min(I.y-4,Ie));We.push({x:Math.round(Oe),y:Math.round(at)})}return We[We.length-1]=X,We},[]),ie=a.useMemo(()=>{const O=(pe,Ee,We)=>Math.min(We,Math.max(Ee,pe)),fe=h.map(pe=>{const Ee=10+Math.random()*36;return{x:O(pe.x,40,260),y:O(pe.y-Ee,40,140)}}),be=h.map((pe,Ee)=>{var Ie;const We=12+Math.random()*40,Oe=((Ie=fe[Ee])==null?void 0:Ie.y)??pe.y;return{x:O(pe.x,40,260),y:O(Math.max(Oe+10,pe.y+We),60,170)}});return{upper:fe,lower:be}},[h]),_=a.useMemo(()=>{var X;const I=((X=h[4])==null?void 0:X.x)??260;return Math.max(0,Math.min(240,I-40))},[h]),m=a.useMemo(()=>{var Ee,We;const I=(Oe,Ie,Ae)=>Math.min(Ae,Math.max(Ie,Oe)),X=(Oe,Ie,Ae)=>h.map((Te,ot)=>{var It,lt;const Ue=((It=ie.upper[ot])==null?void 0:It.y)??Te.y,at=((lt=ie.lower[ot])==null?void 0:lt.y)??Te.y,vt=(Math.random()-.5)*70,ft=Te.y+Oe+vt,ze=I(Te.y+Ie,Ue+6,at-6),st=I(Te.y+Ae,Ue+6,at-6);return{x:Te.x,y:I(ft,Math.min(ze,st),Math.max(ze,st))}}),ve=-14+Math.random()*28,$=14+Math.random()*28,O=X(ve,-80,12),fe=X($,-12,80);for(let Oe=4;Oe<h.length;Oe+=1){const Ie=h[Oe],Ae=((Ee=ie.upper[Oe])==null?void 0:Ee.y)??Ie.y,Te=((We=ie.lower[Oe])==null?void 0:We.y)??Ie.y;O[Oe]={x:Ie.x,y:I(Ie.y-12,Ae+6,Te-6)},fe[Oe]={x:Ie.x,y:I(Ie.y+12,Ae+6,Te-6)}}const be=ie.upper.length?ie.upper[ie.upper.length-1].y:40,pe=ie.lower.length?ie.lower[ie.lower.length-1].y:170;return O[O.length-1]={x:h[h.length-1].x,y:I(h[h.length-1].y-14,be,pe)},fe[fe.length-1]={x:h[h.length-1].x,y:I(h[h.length-1].y+12,be,pe)},{higher:O,lower:fe}},[h,ie]),z=1e4,L=a.useMemo(()=>{let I=17;const X=()=>(I=(I*1664525+1013904223)%4294967296,I/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map(($,O)=>{const fe=(X()-.5)*240,be=(X()-.5)*180,pe=(X()-.5)*24;return{id:`card-${O+1}`,throw:{x:`${fe.toFixed(0)}px`,y:`${be.toFixed(0)}px`,rot:`${pe.toFixed(1)}deg`},grid:{x:`${$.x}px`,y:`${$.y}px`},delay:`${O*.12}s`}})},[]),G=a.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[T,R]=a.useState([]),ee=a.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),te=a.useMemo(()=>{const X=[],$=(fe,be)=>fe+Math.random()*(be-fe);for(let fe=0;fe<6;fe+=1){let be=!1;for(let pe=0;pe<80;pe+=1){const Ee=$(14,86),We=$(10,34);if(X.every(Ie=>{const Ae=Ie.x-Ee,Te=Ie.y-We;return Math.hypot(Ae,Te)>=12})){X.push({x:Ee,y:We}),be=!0;break}}be||X.push({x:$(16,84),y:$(12,32)})}return X.map((fe,be)=>({id:`p${be+1}`,x:`${fe.x.toFixed(1)}%`,y:`${fe.y.toFixed(1)}%`,xNum:fe.x,yNum:fe.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[ae,Pe]=a.useState(0),[de,S]=a.useState(0),[ge,x]=a.useState([]),V=1e4,ue=a.useMemo(()=>{if(te.length<2)return[];const I=be=>{let pe=be+1831565813;return pe=Math.imul(pe^pe>>>15,pe|1),pe^=pe+Math.imul(pe^pe>>>7,pe|61),((pe^pe>>>14)>>>0)/4294967296},X=(be,pe)=>Math.floor(I(be)*pe),ve=new Set,$=[],O=Math.min(3,te.length);let fe=0;for(;$.length<O&&fe<30;){fe+=1;const be=X(ae*13+fe*5,te.length),pe=X(ae*29+fe*7,te.length);if(be===pe)continue;const Ee=be<pe?`${be}-${pe}`:`${pe}-${be}`;ve.has(Ee)||(ve.add(Ee),$.push({id:`link-${Ee}`,from:te[be],to:te[pe],delay:`${(fe*.35).toFixed(2)}s`}))}return $},[ae,te]);a.useEffect(()=>{if(!n||s!==2)return;const I=()=>{const ve=L.map($=>$.id);for(let $=ve.length-1;$>0;$-=1){const O=Math.floor(Math.random()*($+1));[ve[$],ve[O]]=[ve[O],ve[$]]}return ve.slice(0,4)};R(I());const X=window.setInterval(()=>{R(I())},z);return()=>window.clearInterval(X)},[s,n,L,z]),a.useEffect(()=>{if(!n||s!==3)return;const I=()=>{S(Math.floor(Math.random()*ee.length)),x(te.map(()=>Math.random()<.6?"good":"bad")),Pe(ve=>ve+1)};I();const X=window.setInterval(I,V);return()=>window.clearInterval(X)},[s,n,ee.length,te,V]);const B=a.useMemo(()=>Dn(11),[]),[Q,Ne]=a.useState(new Set(["root"])),[Se,we]=a.useState(new Set),[$e,ye]=a.useState(new Set),[Ke,_e]=a.useState({fromId:"root",toId:"root",key:0}),je=a.useRef(Q),Be=a.useRef("root"),tt=a.useRef(0),Ye=a.useRef(null),q=a.useRef(null),W=a.useRef([]);a.useEffect(()=>{je.current=Q},[Q]);const De=a.useMemo(()=>{const I=new Set;return Q.forEach(X=>{const ve=B.linksByFrom.get(X);ve&&ve.forEach($=>I.add($))}),I},[Q,B]),xe=B.nodesById.get(Ke.toId)??B.nodesById.get("root"),re=xe?`${xe.x/xa.width*100}%`:"50%",Le=xe?`${xe.y/xa.height*100}%`:"90%";a.useEffect(()=>{if(!n||s!==1||r)return;(()=>{Ne(new Set(["root"])),we(new Set),ye(new Set),_e({fromId:"root",toId:"root",key:0}),q.current=null,tt.current=0,Be.current="root",W.current=[]})();const X=()=>{const $=Be.current,O=je.current,be=(B.childrenByFrom.get($)??[]).filter(Te=>!O.has(Te));if(be.length)return be[Math.floor(Math.random()*be.length)];if(O.size>=B.nodes.length){const Te=B.neighborsById.get($)??[];return Te.length?Te[Math.floor(Math.random()*Te.length)]:null}const pe=Te=>(B.childrenByFrom.get(Te)??[]).some(Ue=>!O.has(Ue)),Ee=[$],We=new Set([$]),Oe=new Map;let Ie=null;for(;Ee.length;){const Te=Ee.shift();if(!Te)break;if(Te!==$&&pe(Te)){Ie=Te;break}(B.neighborsById.get(Te)??[]).forEach(Ue=>{We.has(Ue)||(We.add(Ue),Oe.set(Ue,Te),Ee.push(Ue))})}if(!Ie)return null;let Ae=Ie;for(;Oe.get(Ae)&&Oe.get(Ae)!==$;)Ae=Oe.get(Ae)??Ae;return Ae},ve=($,O)=>{if($===O){const fe=X();fe&&ve($,fe);return}tt.current+=1,_e({fromId:$,toId:O,key:tt.current}),Be.current=O,Ye.current=window.setTimeout(()=>{const fe=B.parentsById.get(O)??[],be=je.current,pe=fe.filter(Ie=>!be.has(Ie));if(!pe.length){const Ie=new Set(be);Ie.add(O),Ne(Ie),Ye.current=window.setTimeout(()=>{for(;W.current.length;){const Te=W.current[W.current.length-1];if(!Ie.has(Te)){if(Te!==O){ve(O,Te);return}break}W.current.pop()}const Ae=X();Ae&&ve(O,Ae)},ya.pauseMs);return}const Ee=new Set([O,...pe]),We=new Set(pe.map(Ie=>`${Ie}-${O}`));we(Ee),ye(We),W.current.includes(O)||W.current.push(O);const Oe=pe[Math.floor(Math.random()*pe.length)];q.current={fromId:O,toId:Oe},Ye.current=window.setTimeout(()=>{we(new Set),ye(new Set);const Ie=q.current;Ie&&ve(Ie.fromId,Ie.toId)},ya.errorMs)},ya.moveMs)};return Ye.current=window.setTimeout(()=>{const $=X();$&&ve(Be.current,$)},ya.pauseMs),()=>{Ye.current&&window.clearTimeout(Ye.current)}},[s,n,B,r]);const qe=I=>{if(!n)return;const X=Date.now();X-U.current<520||Math.abs(I.deltaY)<10||(U.current=X,I.deltaY>0?l():g(),I.preventDefault())},K=I=>{if(!n)return;const X=I.touches[0];X&&(v.current={x:X.clientX,y:X.clientY})},ce=I=>{if(!n)return;const X=v.current;if(v.current=null,!X)return;const ve=I.changedTouches[0];if(!ve)return;const $=ve.clientX-X.x,O=ve.clientY-X.y;Math.abs(O)<40||Math.abs(O)<Math.abs($)||(O<0?l():g())};return e.jsxs("div",{className:`cogita-intro ${n?"is-open":"is-closed"} ${r?"is-reduced":""} ${d?"is-final":""}`,"data-slide":s+1,onWheel:qe,onTouchStart:K,onTouchEnd:ce,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":N,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${Y&&!o?"is-entry":""}`,children:le.map((I,X)=>e.jsx("img",{src:I.src,alt:"",className:`cogita-logo-layer ${X===0?"is-base":""} ${I.kind==="text"?"is-text":I.kind==="recreatio"?"is-recreatio":""} ${I.kind==="bubble"?"is-bubble":""}`},I.src))})}),n&&t.map((I,X)=>{const ve=X===s;return e.jsxs("section",{className:`cogita-intro-slide slide-${X+1} ${ve?"is-active":""}`,"aria-hidden":!ve,children:[e.jsxs("div",{className:"cogita-intro-text",children:[I.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:I.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:I.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:I.title}),I.body&&e.jsx("p",{children:I.body.split(`
`).map(($,O)=>e.jsxs("span",{children:[$,O===0&&e.jsx("br",{})]},String(O)))})]}),I.micro&&e.jsx("p",{className:"cogita-intro-micro",children:I.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:d?j:l,children:I.cta}),d&&I.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>b(0),children:I.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[X===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${xa.width} ${xa.height}`,preserveAspectRatio:"none",children:[B.links.map($=>{const O=B.nodesById.get($.from),fe=B.nodesById.get($.to);if(!O||!fe)return null;const be=De.has($.key),pe=$e.has($.key);return e.jsx("line",{className:`map-link ${be?"is-active":""} ${pe?"is-error":""}`,x1:O.x,y1:O.y,x2:fe.x,y2:fe.y},$.key)}),B.nodes.map($=>{const O=Q.has($.id),fe=Se.has($.id);return e.jsx("circle",{className:`map-node ${$.role?`is-${$.role}`:""} ${O?"is-active":""} ${fe?"is-error":""}`,cx:$.x,cy:$.y,r:$.r},$.id)})]}),xe&&e.jsx("span",{className:"map-explorer-dot",style:{left:re,top:Le,"--move":`${ya.moveMs}ms`}})]}),X===2&&e.jsx("div",{className:"cogita-index-cards",children:L.map($=>{const O=T.indexOf($.id),fe=O>=0?G[O]:null,be=(fe==null?void 0:fe.x)??"140px",pe=(fe==null?void 0:fe.y)??"140px",Ee=O>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":$.throw.x,"--throw-y":$.throw.y,"--throw-rot":$.throw.rot,"--grid-x":$.grid.x,"--grid-y":$.grid.y,"--stack-x":be,"--stack-y":pe,"--stack-opacity":Ee,"--delay":$.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},$.id)})}),X===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[ee.map(($,O)=>e.jsxs("div",{className:`round-card ${O===de?"is-active":""}`,style:{"--card-x":$.x,"--card-y":$.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},$.id)),ee[de]&&e.jsx("span",{className:"round-ring",style:{"--card-x":ee[de].x,"--card-y":`calc(${ee[de].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:te.map($=>e.jsx("span",{className:"player-dot",style:{left:$.x,top:$.y,"--jitter-x":$.jitterX,"--jitter-y":$.jitterY,"--breath-delay":$.delay}},$.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:ue.map($=>e.jsx("line",{className:"round-link",x1:$.from.xNum,y1:$.from.yNum,x2:$.to.xNum,y2:$.to.yNum,style:{"--delay":$.delay}},$.id))}),e.jsx("div",{className:"round-flows",children:te.map(($,O)=>{const fe=ge[O]??"good",be=ee[de];if(!be)return null;const pe=`calc(${be.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":$.x,"--from-y":$.y,"--to-x":be.x,"--to-y":pe,"--delay":`${O*.12}s`}}),e.jsx("span",{className:`return-dot is-${fe}`,style:{"--from-x":be.x,"--from-y":pe,"--to-x":$.x,"--to-y":$.y,"--delay":`${O*.12}s`}}),e.jsx("span",{className:`result-pop is-${fe}`,style:{"--at-x":$.x,"--at-y":$.y,"--delay":`${O*.12}s`}})]},`${$.id}-${ae}`)})})]},`round-${ae}`),X===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${h[0].x} ${h[0].y} L${h[1].x} ${h[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${h[1].x} ${h[1].y} L${h[2].x} ${h[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${h[2].x} ${h[2].y} L${h[3].x} ${h[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${h[3].x} ${h[3].y} L${h[4].x} ${h[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${h[4].x} ${h[4].y} L${h[5].x} ${h[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${h[5].x} ${h[5].y} L${h[6].x} ${h[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${_};${_};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${ie.upper.map(($,O)=>`${O===0?"M":"L"}${$.x} ${$.y}`).join(" ")} ${ie.lower.slice().reverse().map($=>`L${$.x} ${$.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${ie.upper.map(($,O)=>`${O===0?"M":"L"}${$.x} ${$.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${ie.lower.map(($,O)=>`${O===0?"M":"L"}${$.x} ${$.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[m.higher.slice(0,6).map(($,O)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${O+1}`,d:`M${$.x} ${$.y} L${m.higher[O+1].x} ${m.higher[O+1].y}`,pathLength:"100"},`peer-1-${O}`)),m.lower.slice(0,6).map(($,O)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${O+1}`,d:`M${$.x} ${$.y} L${m.lower[O+1].x} ${m.lower[O+1].y}`,pathLength:"100"},`peer-2-${O}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${h[0].x/300*100}%`,"--p0y":`${h[0].y/200*100}%`,"--p1x":`${h[1].x/300*100}%`,"--p1y":`${h[1].y/200*100}%`,"--p2x":`${h[2].x/300*100}%`,"--p2y":`${h[2].y/200*100}%`,"--p3x":`${h[3].x/300*100}%`,"--p3y":`${h[3].y/200*100}%`,"--p4x":`${h[4].x/300*100}%`,"--p4y":`${h[4].y/200*100}%`,"--p5x":`${h[5].x/300*100}%`,"--p5y":`${h[5].y/200*100}%`,"--p6x":`${h[6].x/300*100}%`,"--p6y":`${h[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${m.higher[0].x/300*100}%`,"--q0y":`${m.higher[0].y/200*100}%`,"--q1x":`${m.higher[1].x/300*100}%`,"--q1y":`${m.higher[1].y/200*100}%`,"--q2x":`${m.higher[2].x/300*100}%`,"--q2y":`${m.higher[2].y/200*100}%`,"--q3x":`${m.higher[3].x/300*100}%`,"--q3y":`${m.higher[3].y/200*100}%`,"--q4x":`${m.higher[4].x/300*100}%`,"--q4y":`${m.higher[4].y/200*100}%`,"--q5x":`${m.higher[5].x/300*100}%`,"--q5y":`${m.higher[5].y/200*100}%`,"--q6x":`${m.higher[6].x/300*100}%`,"--q6y":`${m.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${m.lower[0].x/300*100}%`,"--q0y":`${m.lower[0].y/200*100}%`,"--q1x":`${m.lower[1].x/300*100}%`,"--q1y":`${m.lower[1].y/200*100}%`,"--q2x":`${m.lower[2].x/300*100}%`,"--q2y":`${m.lower[2].y/200*100}%`,"--q3x":`${m.lower[3].x/300*100}%`,"--q3y":`${m.lower[3].y/200*100}%`,"--q4x":`${m.lower[4].x/300*100}%`,"--q4y":`${m.lower[4].y/200*100}%`,"--q5x":`${m.lower[5].x/300*100}%`,"--q5y":`${m.lower[5].y/200*100}%`,"--q6x":`${m.lower[6].x/300*100}%`,"--q6y":`${m.lower[6].y/200*100}%`}})]})})}),X===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),X===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},I.id)}),!n&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:c.title}),c.body&&e.jsx("p",{children:c.body}),c.micro&&e.jsx("p",{className:"cogita-intro-micro",children:c.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:j,children:c.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:A,children:"Otwórz pokaz"})]})]})})]}),n&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((I,X)=>e.jsx("button",{type:"button",className:`dot ${s===X?"active":""}`,"aria-label":I.title,onClick:()=>b(X)},I.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:y,children:"Pomiń"})]})]})}const On=6,Un=4;function zn({copy:t,onAuthAction:s,authLabel:n,showProfileMenu:r,onProfileNavigate:l,onToggleSecureMode:g,onLogout:b,secureMode:y,onNavigate:A,language:j,onLanguageChange:d}){const N=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}A("home")},c=a.useRef(null),o=a.useRef([]),H=a.useMemo(()=>{let x=Date.now()%2147483647;const V=()=>(x=x*48271%2147483647,x/2147483647);return Array.from({length:On},(ue,B)=>{const Q=6+V()*8,Ne=7+V()*10,Se=6+V()*9,we=-V()*Q,$e=-V()*Ne,ye=-V()*Se,Ke=.18+V()*.28,_e=12+V()*18,je=4+V()*8,Be=(V()-.5)*3.2,tt=(V()-.5)*3.8,Ye=V()>.5?"alternate":"alternate-reverse",q=V()>.5?"alternate":"alternate-reverse",W=V()>.5?"alternate":"alternate-reverse",De=.18+V()*.42,xe=30+V()*60,re=-45-V()*38,Le=188+V()*32,qe=.1+V()*.2;return{id:`wave-${B+1}`,style:{"--wave-sway-duration":`${Q}s`,"--wave-scale-duration":`${Ne}s`,"--wave-drift-duration":`${Se}s`,"--wave-sway-delay":`${we}s`,"--wave-scale-delay":`${$e}s`,"--wave-drift-delay":`${ye}s`,"--wave-sway-dir":Ye,"--wave-scale-dir":q,"--wave-drift-dir":W,"--wave-scale":`${Ke}`,"--wave-shift":`${_e}%`,"--wave-xshift":`${je}%`,"--wave-x0":`${Be}%`,"--wave-y0":`${tt}%`,"--wave-opacity":`${De}`,"--wave-blur":`${xe}px`,"--wave-bottom":`${re}%`,"--wave-hue":`${Le}`,"--wave-glow":`${qe}`}}})},[]),le=a.useMemo(()=>{let x=Date.now()*3%2147483647;const V=()=>(x=x*48271%2147483647,x/2147483647);return Array.from({length:Un},(ue,B)=>{const Q=180+V()*220,Ne=220+V()*280,Se=-V()*Q,we=-V()*Ne,$e=.12+V()*.22,ye=3+V()*7,Ke=1+V()*3,_e=(V()-.5)*2.8,je=(V()-.5)*2.2;return{id:`mesh-${B+1}`,seed:1e3+B*991+Math.floor(V()*999),style:{"--mesh-sway-duration":`${Q}s`,"--mesh-drift-duration":`${Ne}s`,"--mesh-sway-delay":`${Se}s`,"--mesh-drift-delay":`${we}s`,"--mesh-scale":`${$e}`,"--mesh-shift":`${ye}%`,"--mesh-xshift":`${Ke}%`,"--mesh-x0":`${je}%`,"--mesh-y0":`${_e}%`}}})},[]),Y=a.useMemo(()=>{const x=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],V=t.cogita.introSlides,ue=new Map(V.map(B=>[B.id,B]));return x.map(B=>{var Ne;const Q=ue.get(B.id);return{...B,...Q,title:(Q==null?void 0:Q.title)??"Cogita",cta:(Q==null?void 0:Q.cta)??((Ne=t.cogita.introSlides[0])==null?void 0:Ne.cta)??t.cogita.loginCta,secondary:Q==null?void 0:Q.secondary}})},[t.cogita.introSlides]),[U,v]=a.useState(0),[h,ie]=a.useState(!0),[_,m]=a.useState(!1),z=Y.length-1,L=a.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),G=a.useCallback(()=>{L(),s()},[L,s]),T=a.useCallback(()=>{ie(!0),v(0)},[]),R=a.useCallback(()=>{ie(!1),v(z)},[z]),ee=a.useCallback(x=>{v(Math.max(0,Math.min(z,x)))},[z]),te=a.useCallback(()=>{U>=z?G():ee(U+1)},[U,ee,G,z]),ae=a.useCallback(()=>{ee(U-1)},[U,ee]);a.useEffect(()=>{var ue;const x=(ue=window.matchMedia)==null?void 0:ue.call(window,"(prefers-reduced-motion: reduce)");if(!x)return;const V=()=>m(x.matches);return V(),x.addEventListener?(x.addEventListener("change",V),()=>x.removeEventListener("change",V)):(x.addListener(V),()=>x.removeListener(V))},[]),a.useEffect(()=>{if(!h)return;const x=V=>{const ue=V.target;if(!ue)return;const B=ue.tagName;if(!(ue.isContentEditable||B==="INPUT"||B==="TEXTAREA"||B==="SELECT"||B==="BUTTON"||B==="A"||ue.closest('button, a, [role="button"], [role="link"]'))){if(V.key==="Escape"){R();return}if(V.key==="ArrowLeft"||V.key==="ArrowUp"){ae();return}(V.key==="ArrowRight"||V.key==="ArrowDown"||V.code==="Space"||V.key===" ")&&(V.preventDefault(),te())}};return window.addEventListener("keydown",x),()=>window.removeEventListener("keydown",x)},[R,te,ae,h]),a.useEffect(()=>{h&&U===z&&L()},[U,h,z,L]),a.useEffect(()=>{const x=c.current;if(!x)return;const V=o.current.filter(re=>!!re);if(!V.length)return;const ue=1,B=.6,Q=.6,Ne=Math.max(1,Math.min(ue,window.devicePixelRatio||1));let Se=0,we=0,$e=B,ye=0,Ke=0;const _e=re=>{let Le=re%2147483647;return Le<=0&&(Le+=2147483646),(qe,K)=>{Le=Le*48271%2147483647;const ce=Le/2147483647;return qe+ce*(K-qe)}},je={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},Be=re=>{const Le=Math.sin(re*12.9898)*43758.5453;return Le-Math.floor(Le)},tt=re=>{const Le=Be(re+.1)||1e-4,qe=Be(re+.7)||1e-4;return Math.sqrt(-2*Math.log(Le))*Math.cos(2*Math.PI*qe)},Ye=(re,Le)=>{const qe=Math.floor(re),K=qe+1,ce=re-qe,I=ce*ce*(3-2*ce),X=Be(qe*12.9898+Le*78.233),ve=Be(K*12.9898+Le*78.233);return X+(ve-X)*I},q=re=>{const Le=_e(re),qe=Math.min(4,Math.max(4,Math.floor(Se/1200*je.filamentCount)));return Array.from({length:qe},(K,ce)=>{const I=Math.max(-1,Math.min(1,tt(re+ce*.37))),X=Math.min(1,Math.max(0,Be(re+ce*1.31))),ve=Math.min(je.depthLayers-1,Math.floor(X*je.depthLayers));return{seed:Le(0,Math.PI*2)+re*.01,offset:I,freqA:je.freq1*(.75+Le(0,.5)),freqB:je.freq2*(.75+Le(0,.5)),ampA:je.amp1*(.6+Le(0,.7)),ampB:je.amp2*(.6+Le(0,.7)),width:2+ce%5*.32,depth:X,layer:ve}})},W=(re,Le,qe)=>{const K=Math.max(30,Math.floor(Se*we/14e4));re.save(),re.globalAlpha=.6;for(let ce=0;ce<K;ce+=1){const I=Be(ce*9.1+Se*.11)*Le+qe,X=Be(ce*3.7+we*.23)*we,ve=1.2+Be(ce*5.9)*2.4,$=re.createRadialGradient(I,X,0,I,X,ve*2);$.addColorStop(0,"rgba(10, 30, 60, 0.45)"),$.addColorStop(1,"rgba(10, 30, 60, 0)"),re.fillStyle=$,re.beginPath(),re.arc(I,X,ve*2,0,Math.PI*2),re.fill()}re.restore()},De=(re,Le)=>{re.clearRect(0,0,Se,we);const qe=we*je.waveCenter,K=je.waveBandPx,ce=je.segments,I=je.colors.filaments,X=ye||Se,ve=0;W(re,X,ve),re.strokeStyle=I,re.lineCap="round",re.lineJoin="round";for(let $=0;$<Le.length;$+=1){const O=Le[$],fe=O.offset*K*(.85+Be(O.seed)*.4),be=1-Math.min(1,Math.abs(fe)/K),pe=Math.exp(-Math.pow(fe/je.crestThickness,2)),Ee=O.layer===0?1.1:O.layer===1?.85:.6,We=.35+(1-O.depth)*.65,Oe=be*We*Ee*(.34+pe*.45);re.globalAlpha=Oe,re.lineWidth=O.width*(1+(1-O.depth)*.8);const Ie=[];for(let Te=0;Te<=ce;Te+=1){const ot=Te/ce*X+ve,Ue=(Ye(ot*.012,O.seed)-.5)*je.xJitter,at=ot+Ue,vt=(Ye(at*O.freqA,O.seed)-.5)*je.jitterA,ft=(Ye(at*O.freqB,O.seed*1.7)-.5)*je.jitterB,ze=qe+Math.sin(at*O.freqA+O.seed)*O.ampA+Math.sin(at*O.freqB+O.seed*1.3)*O.ampB+fe+vt+ft;Ie.push({x:at,y:ze})}re.beginPath(),re.moveTo(Ie[0].x,Ie[0].y);for(let Te=1;Te<Ie.length-1;Te+=1){const ot=(Ie[Te].x+Ie[Te+1].x)/2,Ue=(Ie[Te].y+Ie[Te+1].y)/2;re.quadraticCurveTo(Ie[Te].x,Ie[Te].y,ot,Ue)}const Ae=Ie[Ie.length-1];re.quadraticCurveTo(Ae.x,Ae.y,Ae.x,Ae.y),re.stroke()}re.save(),re.globalCompositeOperation="lighter",re.strokeStyle=je.colors.glow,re.lineCap="round",re.lineJoin="round";for(let $=0;$<Le.length;$+=1){const O=Le[$];if(Math.abs(O.offset)*K>je.crestThickness)continue;const fe=je.glowAlpha*(.7+(1-O.depth)*.6);re.globalAlpha=fe,re.lineWidth=1.6+(1-O.depth)*1.2;const be=[];for(let Ee=0;Ee<=ce;Ee+=1){const We=Ee/ce*X+ve,Oe=Math.sin(We*.02+O.seed)*3,Ie=qe+Math.sin(We*O.freqA+O.seed)*O.ampA+Math.sin(We*O.freqB+O.seed*1.3)*O.ampB+O.offset*K*.35+Oe;be.push({x:We,y:Ie})}re.beginPath(),re.moveTo(be[0].x,be[0].y);for(let Ee=1;Ee<be.length-1;Ee+=1){const We=(be[Ee].x+be[Ee+1].x)/2,Oe=(be[Ee].y+be[Ee+1].y)/2;re.quadraticCurveTo(be[Ee].x,be[Ee].y,We,Oe)}const pe=be[be.length-1];re.quadraticCurveTo(pe.x,pe.y,pe.x,pe.y),re.stroke()}re.restore()},xe=()=>{Se=Math.floor(x.clientWidth),we=Math.floor(x.clientHeight),ye=Math.floor(Se*1.8),Ke=we,$e=Se<820?Q:B,V.forEach(re=>{const Le=re.getContext("2d");if(!Le)return;re.width=Math.floor(ye*Ne*$e),re.height=Math.floor(Ke*Ne*$e),re.style.width=`${ye}px`,re.style.height=`${Ke}px`,re.style.left=`${-(ye-Se)/2}px`,Le.setTransform(Ne*$e,0,0,Ne*$e,0,0);const qe=Number(re.dataset.seed||1),K=q(qe);De(Le,K)})};return xe(),window.addEventListener("resize",xe,{passive:!0}),()=>window.removeEventListener("resize",xe)},[le]);const Pe=Y[Math.min(U,Y.length-1)],de=h?Pe:Y[Y.length-1],S=(de==null?void 0:de.theme)??Y[0].theme,ge={"--cogita-bg0":S.bg0,"--cogita-bg1":S.bg1,"--cogita-bg2":S.bg2,"--cogita-bloom":S.bloom,"--cogita-sat":S.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:N,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Bs,{value:j,onChange:d}),e.jsx(Ks,{copy:t,label:n,isAuthenticated:r,secureMode:y,onLogin:s,onProfileNavigate:l,onToggleSecureMode:g,onLogout:b,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:c,className:"cogita-section cogita-home",style:ge,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[le.map((x,V)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:x.style,"data-seed":x.seed,ref:ue=>{o.current[V]=ue}},x.id)),H.map(x=>e.jsx("div",{className:"cogita-home-wave",style:x.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},x.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(Vn,{slides:Y,activeIndex:U,introOpen:h,prefersReducedMotion:_,onNext:te,onPrev:ae,onSelect:ee,onExit:R,onOpen:T,onRegister:G})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const Ui=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:zn},Symbol.toStringTag,{value:"Module"})),Hs=a.createContext(!1);function Nt({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,children:d}){if(a.useContext(Hs))return e.jsx(e.Fragment,{children:d});const c=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}y("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:c,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Bs,{value:A,onChange:j}),e.jsx(Ks,{copy:t,label:s,isAuthenticated:n,secureMode:b,onLogin:()=>y("home"),onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:d}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function Dt(t){const[s,n]=a.useState("Cogita library"),[r,l]=a.useState(null);return a.useEffect(()=>{let g=!1;return qs().then(b=>{if(g)return;const y=b.find(A=>A.libraryId===t);y&&n(y.name)}).catch(()=>{g||n("Cogita library")}),()=>{g=!0}},[t]),a.useEffect(()=>{let g=!1;return cn(t).then(b=>{g||l(b)}).catch(()=>{g||l(null)}),()=>{g=!0}},[t]),{libraryName:s,stats:r}}function vs({slices:t}){const s=t.reduce((r,l)=>r+Math.max(0,l.value),0),n=a.useMemo(()=>{if(s<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let r=0;return`conic-gradient(${t.map(g=>{const y=Math.max(0,g.value)/s*360,A=r,j=r+y;return r=j,`${g.color} ${A}deg ${j}deg`}).join(",")})`},[t,s]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:n}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(r=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:r.color}}),e.jsx("strong",{children:r.value}),e.jsx("small",{children:r.label})]},r.label))})]})}function Hn({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,libraryId:d}){const{libraryName:N,stats:c}=Dt(d),[o,H]=a.useState("infos"),[le,Y]=a.useState(0),[U,v]=a.useState(0),[h,ie]=a.useState(0),_=(c==null?void 0:c.totalInfos)??0,m=(c==null?void 0:c.totalCollections)??0,z=0,L=0,G=0,T=Math.max(0,_-G-U),R=Math.max(0,_-U-h);a.useEffect(()=>{let te=!1;return(async()=>{try{const Pe=await va({libraryId:d,limit:200}),de=await Promise.all(Pe.items.map(S=>Ds({libraryId:d,collectionId:S.collectionId}).catch(()=>[])));if(te)return;Y(de.reduce((S,ge)=>S+ge.length,0))}catch{te||Y(0)}})(),()=>{te=!0}},[d]),a.useEffect(()=>{let te=!1;return(async()=>{try{const[Pe,de,S]=await Promise.all([ps({libraryId:d,type:"computed",limit:1}).catch(()=>({total:0})),ps({libraryId:d,type:"source",limit:1}).catch(()=>({total:0})),Vs({libraryId:d}).catch(()=>({items:[]}))]);if(te)return;v((Pe.total??0)+(de.total??0));const ge=new Set(S.items.filter(x=>x.childItemType.toLowerCase()==="info").map(x=>x.childItemId).filter(Boolean));ie(ge.size)}catch{te||(v(0),ie(0))}})(),()=>{te=!0}},[d]);const ee=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:_},{key:"collections",label:t.cogita.library.overview.stats.collections,value:m},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:le},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:z},{key:"texts",label:t.cogita.library.overview.stats.texts,value:L}];return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:N})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:ee.map(te=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${o===te.key?"active":""}`,onClick:()=>H(te.key),children:[e.jsx("span",{children:te.label}),e.jsx("strong",{children:te.value})]},te.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),o==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(vs,{slices:[{label:t.cogita.library.overview.known,value:G,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:T,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:U,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(vs,{slices:[{label:t.cogita.library.overview.availableChecks,value:h,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:R,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const Qe=(t,s)=>{const n=t.cogita.library.infoTypes,r=t.cogita.library.connectionTypes,l=t.cogita.library.groupTypes;return{any:n.any,vocab:n.vocab,book:l.book,citation:l.citation,language:n.language,word:n.word,sentence:n.sentence,topic:n.topic,collection:n.collection,person:n.person,institution:n.institution,collective:n.collective,orcid:n.orcid,address:n.address,email:n.email,phone:n.phone,media:n.media,work:n.work,geo:n.geo,music_piece:n.musicPiece,music_fragment:n.musicFragment,source:n.source,quote:n.quote,computed:n.computed,"word-language":r.wordLanguage,"quote-language":r.quoteLanguage,"language-sentence":r.languageSentence,translation:r.translation,"word-topic":r.wordTopic,reference:r.reference,"source-resource":r.sourceResource,"work-contributor":r.workContributor,"work-medium":r.workMedium,"orcid-link":r.orcidLink}[s]??String(s)},Qn=t=>[{value:"any",label:Qe(t,"any")},{value:"language",label:Qe(t,"language")},{value:"word",label:Qe(t,"word")},{value:"sentence",label:Qe(t,"sentence")},{value:"topic",label:Qe(t,"topic")},{value:"collection",label:Qe(t,"collection")},{value:"person",label:Qe(t,"person")},{value:"institution",label:Qe(t,"institution")},{value:"collective",label:Qe(t,"collective")},{value:"orcid",label:Qe(t,"orcid")},{value:"address",label:Qe(t,"address")},{value:"email",label:Qe(t,"email")},{value:"phone",label:Qe(t,"phone")},{value:"media",label:Qe(t,"media")},{value:"work",label:Qe(t,"work")},{value:"geo",label:Qe(t,"geo")},{value:"music_piece",label:Qe(t,"music_piece")},{value:"music_fragment",label:Qe(t,"music_fragment")},{value:"source",label:Qe(t,"source")},{value:"quote",label:Qe(t,"quote")},{value:"citation",label:Qe(t,"citation")},{value:"computed",label:Qe(t,"computed")},{value:"vocab",label:Qe(t,"vocab")},{value:"book",label:Qe(t,"book")},{value:"word-language",label:Qe(t,"word-language")},{value:"quote-language",label:Qe(t,"quote-language")},{value:"language-sentence",label:Qe(t,"language-sentence")},{value:"translation",label:Qe(t,"translation")},{value:"word-topic",label:Qe(t,"word-topic")},{value:"reference",label:Qe(t,"reference")},{value:"source-resource",label:Qe(t,"source-resource")},{value:"work-contributor",label:Qe(t,"work-contributor")},{value:"work-medium",label:Qe(t,"work-medium")},{value:"orcid-link",label:Qe(t,"orcid-link")}],Wn=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Xa={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},Yn={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code","notes"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","notes","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Xa]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","notes","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Xa]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name","notes"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid","notes"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country","notes"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address","notes"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number","notes"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind","notes"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId","notes"]},filterFields:[Xa,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city","notes"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer","notes"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text","notes"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator","notes"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},quote:{infoType:"quote",entityKind:"single",structure:{payloadFields:["title","text","notes"],connections:[{relationType:"quote-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"quote",kind:"text",path:"text",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition","notes"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},ws={infoType:"default",entityKind:"single",structure:{payloadFields:["label","notes"]},filterFields:[]};function Xn(t){return t?Yn[t]??ws:ws}function Gn(t,s){return t.optionsSource==="languages"?s.languages.map(n=>({value:n.infoId,label:n.label})):t.optionsSource==="sourceKinds"?Wn:[]}const Ga=60,Jn=500;function Qs(t){return`cogita.info-selection:${t}`}function js(t){if(typeof window>"u")return{};const s=window.localStorage.getItem(Qs(t));if(!s)return{};try{const n=JSON.parse(s);return!n||typeof n!="object"?{}:n}catch{return{}}}function Zn({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,libraryId:d,mode:N}){var qe;const c=$s(),o=t.cogita.library.list,[H,le]=a.useState("any"),[Y,U]=a.useState(""),[v,h]=a.useState("relevance"),[ie,_]=a.useState("details"),[m,z]=a.useState(!1),[L,G]=a.useState("idle"),[T,R]=a.useState([]),[ee,te]=a.useState(Ga),[ae,Pe]=a.useState(null),[de,S]=a.useState(()=>js(d)),[ge,x]=a.useState({}),[V,ue]=a.useState([]),B=a.useMemo(()=>Qn(t),[t]),Q=a.useMemo(()=>[{value:"relevance",label:o.sortRelevance},{value:"label_asc",label:o.sortLabelAsc},{value:"label_desc",label:o.sortLabelDesc},{value:"type_asc",label:o.sortTypeAsc},{value:"type_desc",label:o.sortTypeDesc}],[o.sortLabelAsc,o.sortLabelDesc,o.sortRelevance,o.sortTypeAsc,o.sortTypeDesc]);a.useEffect(()=>{S(js(d)),x({}),z(!1)},[d]),a.useEffect(()=>{bs({libraryId:d,type:"language",filters:{sourceKind:"info"},limit:200}).then(K=>{const ce=K.map(I=>({infoId:I.infoId??"",infoType:I.entityType,label:I.title})).filter(I=>I.infoId.length>0);ue(ce)}).catch(()=>ue([]))},[d]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(Qs(d),JSON.stringify(de))},[d,de]);const Ne=a.useMemo(()=>Xn(H==="any"?null:H),[H]),Se=a.useMemo(()=>({language:o.typeFilterLanguage,languageA:o.typeFilterLanguageA,languageB:o.typeFilterLanguageB,originalLanguage:o.typeFilterOriginalLanguage,doi:o.typeFilterDoi,sourceKind:o.typeFilterSourceKind,locator:o.typeFilterLocator,quote:o.typeFilterQuote}),[o.typeFilterDoi,o.typeFilterLanguage,o.typeFilterLanguageA,o.typeFilterLanguageB,o.typeFilterLocator,o.typeFilterOriginalLanguage,o.typeFilterQuote,o.typeFilterSourceKind]),we=a.useMemo(()=>Ne.filterFields.map(K=>({...K,label:K.labelKey?Se[K.labelKey]:K.label??K.key,options:Gn(K,{languages:V})})),[Se,V,Ne.filterFields]),$e=a.useMemo(()=>we.some(K=>(ge[K.key]??"").trim().length>0),[we,ge]);a.useEffect(()=>{x({})},[H]),a.useEffect(()=>{const K={sourceKind:"info"};if($e)for(const I of we){const X=(ge[I.key]??"").trim();X&&(K[I.path??I.key]=X)}G("loading");const ce=window.setTimeout(()=>{bs({libraryId:d,type:H==="any"?void 0:H,query:Y.trim()||void 0,filters:K,limit:Jn}).then(I=>{const X=I.map(ve=>({infoId:ve.infoId??"",infoType:ve.entityType,label:ve.title})).filter(ve=>ve.infoId.length>0);R(X),G("ready")}).catch(()=>{R([]),G("ready")})},240);return()=>window.clearTimeout(ce)},[$e,d,Y,H,we,ge]);const ye=a.useMemo(()=>{const K=T.slice(),ce=I=>Qe(t,I);return v==="relevance"?K:v==="label_asc"?K.sort((I,X)=>I.label.localeCompare(X.label)):v==="label_desc"?K.sort((I,X)=>X.label.localeCompare(I.label)):v==="type_asc"?K.sort((I,X)=>I.infoType===X.infoType?I.label.localeCompare(X.label):ce(I.infoType).localeCompare(ce(X.infoType))):K.sort((I,X)=>I.infoType===X.infoType?I.label.localeCompare(X.label):ce(X.infoType).localeCompare(ce(I.infoType)))},[t,T,v]),Ke=a.useMemo(()=>ye.slice(0,ee),[ye,ee]),_e=Ke.length<ye.length,je=a.useMemo(()=>new Set(Object.keys(de)),[de]),Be=a.useMemo(()=>Object.values(de),[de]),tt=a.useMemo(()=>{const K=new Map;for(const ce of Be)K.set(ce.infoType,(K.get(ce.infoType)??0)+1);return Array.from(K.entries()).sort((ce,I)=>I[1]-ce[1]||ce[0].localeCompare(I[0]))},[Be]);a.useEffect(()=>{te(Ga);const K=new Set(T.map(ce=>ce.infoId));Pe(ce=>ce&&K.has(ce)?ce:null)},[T]);const Ye=K=>{S(ce=>({...ce,[K.infoId]:{infoId:K.infoId,infoType:K.infoType,label:K.label}}))},q=K=>{S(ce=>{if(!ce[K])return ce;const I={...ce};return delete I[K],I})},W=(K,ce)=>{if(ce){Ye(K);return}q(K.infoId)},De=K=>{c(`/cogita/library/${d}/list?infoId=${encodeURIComponent(K)}&infoView=overview`,{replace:!0})},xe=Be.length===1?((qe=Be[0])==null?void 0:qe.infoId)??null:null,re=o.selectionCount.replace("{count}",String(Be.length)),Le=N==="collection"?"grid":N==="detail"?"wide":ie;return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":Le,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":o.typeLabel,value:H,onChange:K=>le(K.target.value),children:B.map(K=>e.jsx("option",{value:K.value,children:K.label},K.value))}),e.jsx("input",{type:"text",value:Y,onChange:K=>U(K.target.value),placeholder:o.searchPlaceholder}),e.jsx("select",{"aria-label":o.sortLabel,value:v,onChange:K=>h(K.target.value),children:Q.map(K=>e.jsx("option",{value:K.value,children:K.label},K.value))}),e.jsxs("select",{"aria-label":o.viewLabel,value:ie,onChange:K=>_(K.target.value),children:[e.jsx("option",{value:"details",children:o.viewDetails}),e.jsx("option",{value:"wide",children:o.viewWide}),e.jsx("option",{value:"grid",children:o.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:o.cardCount.replace("{shown}",String(Ke.length)).replace("{total}",String(ye.length))}),e.jsx("span",{children:L==="loading"?o.loading:o.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>z(K=>!K),children:m?o.hideFilters:o.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:o.filtersOptionalHint})]}),m&&we.length>0?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsx("div",{className:"cogita-filter-grid",children:we.map(K=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:K.label}),K.kind==="select"?e.jsxs("select",{value:ge[K.key]??"",onChange:ce=>x(I=>({...I,[K.key]:ce.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(K.options??[]).map(ce=>e.jsx("option",{value:ce.value,children:ce.label},`${K.key}:${ce.value}`))]}):e.jsx("input",{type:"text",value:ge[K.key]??"",onChange:ce=>x(I=>({...I,[K.key]:ce.target.value}))})]},`type-filter:${K.key}`))})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:re}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{S(K=>{const ce={...K};for(const I of Ke)ce[I.infoId]={infoId:I.infoId,infoType:I.infoType,label:I.label};return ce})},disabled:Ke.length===0,children:o.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>S({}),disabled:Be.length===0,children:o.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>xe&&De(xe),disabled:!xe,title:xe?void 0:o.openSelectedDisabled,children:o.openSelected})]})]}),Be.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:o.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:o.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:tt.map(([K,ce])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:Qe(t,K)}),e.jsx("span",{className:"cogita-tag-count",children:ce})]},`stack:type:${K}`))})]}):null,Le==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":o.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:o.detailColumnName}),e.jsx("span",{children:o.detailColumnType}),e.jsx("span",{children:o.detailColumnId}),e.jsx("span",{})]}),Ke.length?Ke.map(K=>{const ce=Qe(t,K.infoType),I=je.has(K.infoId),X=ae===K.infoId;return e.jsxs("div",{className:`cogita-details-row ${X||I?"active":""}`,role:"row",onClick:()=>Pe(K.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:I,onChange:ve=>W(K,ve.target.checked),onClick:ve=>ve.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:K.label,children:K.label}),e.jsx("span",{title:ce,children:ce}),e.jsx("span",{title:K.infoId,children:K.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:ve=>{ve.stopPropagation(),De(K.infoId)},"aria-label":o.editInfo,children:">"})]},K.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:o.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${Le}`,"data-view":Le,children:Ke.length?Ke.map(K=>{const ce=Qe(t,K.infoType),I=je.has(K.infoId),X=ae===K.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":X||I,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:I,onChange:ve=>W(K,ve.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>Pe(K.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:ce}),e.jsx("h3",{className:"cogita-card-title",children:K.label}),e.jsx("p",{className:"cogita-card-subtitle",children:K.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>De(K.infoId),children:o.editInfo})]})},K.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:o.noMatch})})}),_e?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>te(K=>K+Ga),children:o.loadMore})}):null]})})})})})}const ea=5,Ns=50,ks=2,Ts=[];function ta({libraryId:t,infoType:s,label:n,placeholder:r,value:l,onChange:g,values:b,onChangeMultiple:y,helperText:A,searchFailedText:j,createFailedText:d,createLabel:N,savingLabel:c,loadMoreLabel:o,inputRef:H,autoAdvance:le,onCommit:Y,multiple:U}){const v=U?b??Ts:Ts,[h,ie]=a.useState(U?"":(l==null?void 0:l.label)??""),[_,m]=a.useState([]),[z,L]=a.useState(ea),[G,T]=a.useState(-1),[R,ee]=a.useState(!1),[te,ae]=a.useState(!1),[Pe,de]=a.useState(null),S=a.useRef(0),ge=a.useRef(new Map),x=a.useMemo(()=>U?h.trim().length>0:h.trim().length>0&&!l,[h,l,U]);a.useEffect(()=>{U||ie((l==null?void 0:l.label)??"")},[l,U]),a.useEffect(()=>{const B=h.trim();if(!B||B.length<ks){m([]),ee(!1),L(ea),T(-1),ae(!1),de(null);return}const Q=B.toLowerCase(),Ne=`${t}:${s}:${Q}`,Se=ge.current.get(Ne);if(Se){if(U&&v.length>0){const $e=new Set(v.map(ye=>ye.id));m(Se.filter(ye=>!$e.has(ye.id)))}else m(Se);L(ea),T(-1),ee(Se.length>0),ae(!1),de(null);return}const we=window.setTimeout(async()=>{const $e=Date.now();S.current=$e,ae(!0),de(null);try{const ye=await us({libraryId:t,type:s,query:B,limit:Ns});if(S.current!==$e)return;const Ke=ye.slice(0,Ns).map(_e=>({id:_e.infoId,label:_e.label,infoType:_e.infoType}));if(ge.current.set(Ne,Ke),U&&v.length>0){const _e=new Set(v.map(je=>je.id));m(Ke.filter(je=>!_e.has(je.id)))}else m(Ke);L(ea),T(-1),ee(!0)}catch{if(S.current!==$e)return;de(j??"Search failed.")}finally{S.current===$e&&ae(!1)}},250);return()=>window.clearTimeout(we)},[t,s,h,v]);const V=B=>{if(U){const Q=v.some(Ne=>Ne.id===B.id)?v:[...v,B];y==null||y(Q),ie(""),ee(!1),T(-1);return}g==null||g(B),ie(B.label),ee(!1),T(-1),le&&(Y==null||Y())},ue=async()=>{const B=h.trim();if(B){ae(!0),de(null);try{const Q=await Os({libraryId:t,infoType:s,payload:{label:B}}),Ne={id:Q.infoId,label:B,infoType:Q.infoType};if(B.length>=ks){const Se=`${t}:${s}:${B.toLowerCase()}`,we=ge.current.get(Se)??[];ge.current.set(Se,[Ne,...we])}if(U){y==null||y([...v,Ne]),ie(""),ee(!1),T(-1);return}g==null||g(Ne),ee(!1),T(-1),le&&(Y==null||Y())}catch{de(d??"Create failed.")}finally{ae(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:n}),e.jsx("input",{value:h,placeholder:r,onChange:B=>{ie(B.target.value),!U&&l&&(g==null||g(null))},onKeyDown:B=>{if(B.key==="ArrowDown"){if(B.preventDefault(),!_.length)return;ee(!0),T(Q=>{const Ne=Math.min(_.length,z)-1,Se=Q<0?0:Math.min(Q+1,Ne);return Se===Ne&&_.length>z?(L(we=>Math.min(we+ea,_.length)),Math.min(Q+1,Math.min(_.length,z+ea)-1)):Se});return}if(B.key==="ArrowUp"){if(B.preventDefault(),!_.length)return;ee(!0),T(Q=>Q<=0?0:Q-1);return}if(B.key==="Enter"){if(B.preventDefault(),G>=0&&_[G]){V(_[G]);return}if(x){ue();return}}},onFocus:()=>{_.length>0&&ee(!0)},autoComplete:"off",ref:H})]}),U&&v.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:v.map(B=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>y==null?void 0:y(v.filter(Q=>Q.id!==B.id)),children:[B.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},B.id))}),A&&e.jsx("p",{className:"cogita-help",children:A}),Pe&&e.jsx("p",{className:"cogita-error",children:Pe}),R&&_.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[_.slice(0,z).map((B,Q)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":Q===G,onClick:()=>V(B),children:[e.jsx("strong",{children:B.label}),e.jsx("span",{children:B.infoType})]},B.id)),z<_.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>L(B=>Math.min(B+ea,_.length)),children:o??"Load more"})]}),x&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:ue,disabled:te,children:te?c??"Saving...":N??`Create new ${s}`})]})}function ei(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function Ss(t,s){if(!t||typeof t!="object")return s;const n=t,r=[n.label,n.name,n.title,n.text,n.orcid,n.email,n.number];for(const l of r)if(typeof l=="string"&&l.trim())return l.trim();return s}function ti({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,libraryId:d,editInfoId:N}){const{libraryName:c}=Dt(d),o=!!N,[H,le]=a.useState([]),[Y,U]=a.useState("word"),[v,h]=a.useState({}),[ie,_]=a.useState({}),[m,z]=a.useState({}),[L,G]=a.useState({}),[T,R]=a.useState(null),[ee,te]=a.useState("idle"),ae=a.useMemo(()=>H.find(x=>x.infoType===Y),[Y,H]),Pe=a.useMemo(()=>H.map(x=>({value:x.infoType,label:Qe(t,x.infoType)})),[t,H]);a.useEffect(()=>{let x=!1;return dn({libraryId:d}).then(V=>{var ue;if(!x&&(le(V),!o)){const B=(ue=V[0])==null?void 0:ue.infoType;B&&U(B)}}).catch(()=>{x||le([])}),()=>{x=!0}},[o,d]),a.useEffect(()=>{if(!ae)return;const x={},V={},ue={},B={};for(const Q of ae.payloadFields)x[Q.key]="";for(const Q of ae.linkFields)Q.multiple?ue[Q.key]=[]:V[Q.key]=null,Q.targetTypes.length>0&&(B[Q.key]=Q.targetTypes[0]);h(x),_(V),z(ue),G(B)},[ae==null?void 0:ae.infoType]),a.useEffect(()=>{if(!o||!N||H.length===0)return;let x=!1;return te("loading"),R(null),(async()=>{const ue=await ua({libraryId:d,infoId:N});if(x)return;const B=ue.infoType;U(B);const Q=H.find(je=>je.infoType===B);if(!Q){te("idle");return}const Ne=ue.payload??{},Se={};for(const je of Q.payloadFields)Se[je.key]=ei(Ne[je.key]);h(Se);const we=ue.links??{}??{},$e={},ye={},Ke={},_e=[];for(const je of Q.linkFields){je.targetTypes.length>0&&(Ke[je.key]=je.targetTypes[0]);const Be=we[je.key];if(je.multiple){const tt=Array.isArray(Be)?Be.filter(Ye=>typeof Ye=="string"):[];ye[je.key]=[];for(const Ye of tt)_e.push(ua({libraryId:d,infoId:Ye}).then(q=>{if(x)return;const W={id:Ye,infoType:q.infoType,label:Ss(q.payload,Ye)};ye[je.key]=[...ye[je.key],W]}).catch(()=>{}))}else{const tt=typeof Be=="string"?Be:null;$e[je.key]=null,tt&&_e.push(ua({libraryId:d,infoId:tt}).then(Ye=>{x||($e[je.key]={id:tt,infoType:Ye.infoType,label:Ss(Ye.payload,tt)})}).catch(()=>{}))}}await Promise.all(_e),!x&&(_($e),z(ye),G(je=>({...je,...Ke})),te("idle"))})().catch(()=>{x||(R("Failed to load info details."),te("idle"))}),()=>{x=!0}},[N,o,d,H]);const de=async()=>{var ue;if(!ae)return;const x={};for(const B of ae.payloadFields){const Q=(v[B.key]??"").trim();if(!Q){if(B.required){R(`Field '${B.label}' is required.`);return}continue}if(B.inputType==="json")try{x[B.key]=JSON.parse(Q)}catch{R(`Field '${B.label}' must be valid JSON.`);return}else x[B.key]=Q}const V={};for(const B of ae.linkFields)if(B.multiple){const Q=(m[B.key]??[]).map(Ne=>Ne.id);if(B.required&&Q.length===0){R(`Link '${B.label}' is required.`);return}V[B.key]=Q}else{const Q=((ue=ie[B.key])==null?void 0:ue.id)??null;if(B.required&&!Q){R(`Link '${B.label}' is required.`);return}V[B.key]=Q}te("saving"),R(null);try{if(o&&N)await un({libraryId:d,infoId:N,payload:x,links:V}),R("Info updated.");else{await Os({libraryId:d,infoType:Y,payload:x,links:V}),R("Info saved.");const B={};for(const Se of ae.payloadFields)B[Se.key]="";h(B);const Q={},Ne={};for(const Se of ae.linkFields)Se.multiple?Ne[Se.key]=[]:Q[Se.key]=null;_(Se=>({...Se,...Q})),z(Se=>({...Se,...Ne}))}}catch{R("Failed to save info.")}finally{te("idle")}},S=x=>{const V=v[x.key]??"",ue=x.inputType==="textarea"||x.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:x.label}),ue?e.jsx("textarea",{rows:x.inputType==="json"?8:4,value:V,onChange:B=>h(Q=>({...Q,[x.key]:B.target.value})),placeholder:x.key}):e.jsx("input",{type:"text",value:V,onChange:B=>h(Q=>({...Q,[x.key]:B.target.value})),placeholder:x.key})]},`payload:${x.key}`)},ge=x=>{const V=L[x.key]??x.targetTypes[0];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:x.label}),x.targetTypes.length>1?e.jsx("select",{value:V,onChange:ue=>G(B=>({...B,[x.key]:ue.target.value})),children:x.targetTypes.map(ue=>e.jsx("option",{value:ue,children:Qe(t,ue)},`${x.key}:${ue}`))}):null,x.multiple?e.jsx(ta,{libraryId:d,infoType:V,label:x.label,placeholder:x.key,multiple:!0,values:m[x.key]??[],onChangeMultiple:ue=>z(B=>({...B,[x.key]:ue})),searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(ta,{libraryId:d,infoType:V,label:x.label,placeholder:x.key,value:ie[x.key]??null,onChange:ue=>_(B=>({...B,[x.key]:ue})),searchFailedText:"Search failed",createFailedText:"Create failed"})]},`link:${x.key}`)};return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:o?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${d}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[o?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:Y,onChange:x=>U(x.target.value),children:Pe.map(x=>e.jsx("option",{value:x.value,children:x.label},x.value))})]}),ee==="loading"?e.jsx("p",{children:"Loading..."}):null,ae?e.jsxs("div",{className:"cogita-form-grid",children:[ae.payloadFields.map(S),ae.linkFields.map(ge)]}):e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:de,disabled:ee==="saving"||!ae,children:ee==="saving"?"Saving...":o?"Update info":"Create info"})}),T?e.jsx("p",{className:"cogita-library-subtitle",children:T}):null]})})})]})})}const Cs=t=>/\s/.test(t),Ra=t=>/[\p{L}\p{N}]/u.test(t),Ms=(t,s)=>{const n=s>0?t[s-1]:"",r=s<t.length?t[s]:"";if(!n||!r)return 0;const l=Cs(n),g=Cs(r);if(l||g)return 3;const b=Ra(n),y=Ra(r);return b!==y?2:!b&&!y?1:0},Ja=(t,s,n,r,l)=>{const g=Math.max(r-s,n-r);for(let b=0;b<=g;b+=1){const y=r-b;if(y>=s&&y<=n&&Ms(t,y)>=l)return y;const A=r+b;if(A>=s&&A<=n&&Ms(t,A)>=l)return A}return null},Za=(t,s)=>{const n=s>0?t[s-1]:"",r=s<t.length?t[s]:"";return!n||!r?!0:Ra(n)!==Ra(r)},ai=(t,s,n,r)=>{const l=n-s,g=s+r,b=n-r;if(l<=r*2||b<=g)return null;const y=Math.floor((s+n)/2),A=Ja(t,g,b,y,3);if(A!==null&&Za(t,A))return A;const j=Ja(t,g,b,y,2);if(j!==null&&Za(t,j))return j;const d=Ja(t,g,b,y,1);return d!==null&&Za(t,d)?d:null},ma=(t,s)=>{const n=Math.max(1,7),r=Math.max(n,13),l={},g=(A,j,d,N,c)=>{const o=String(N),H={id:o,start:A,end:j,text:t.slice(A,j),depth:d,index:N,parentId:c};if(l[o]=H,j-A>r){let Y=ai(t,A,j,n);if(Y!==null&&Y>A&&Y<j){const U=g(A,Y,d+1,N*2+1,o),v=g(Y,j,d+1,N*2+2,o);H.leftId=U.id,H.rightId=v.id}}return H},b=g(0,t.length,0,0),y=Object.values(l).sort((A,j)=>j.depth-A.depth||A.start-j.start).map(A=>A.id);return{text:t,rootId:b.id,nodes:l,order:y}},ha=(t,s,n,r,l,g,b)=>{const y=g==="reverse"?t.order.slice().sort((A,j)=>t.nodes[j].start-t.nodes[A].start||t.nodes[j].depth-t.nodes[A].depth):t.order;for(const A of y){if(b&&A===b||s.has(A))continue;const j=t.nodes[A];if(j){if(l&&(j.leftId||j.rightId)){const d=j.leftId?n[j.leftId]??0:r,N=j.rightId?n[j.rightId]??0:r;if((d+N)/2<r)continue}return j}}return null},Ws=(t,s)=>({before:t.slice(0,s.start),fragment:t.slice(s.start,s.end),after:t.slice(s.end)});function si({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,libraryId:d}){const N=`/#/cogita/library/${d}`,[c,o,H]=Rs([]),[le,Y,U]=Es([]),[v,h]=a.useState(null),[ie,_]=a.useState(null),[m,z]=a.useState(null),[L,G]=a.useState(null),T=a.useMemo(()=>c.find(S=>S.id===v)??null,[c,v]);a.useEffect(()=>{let S=!0;return hn({libraryId:d}).then(ge=>{if(!S)return;const x=ge.nodes.map(V=>{var ue,B,Q;return{id:V.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:V.payload&&typeof V.payload=="object"&&"label"in V.payload?String(V.payload.label):"Item",nodeType:V.nodeType,itemType:((ue=V.payload)==null?void 0:ue.itemType)??"info",itemId:((B=V.payload)==null?void 0:B.itemId)??null,infoType:((Q=V.payload)==null?void 0:Q.infoType)??null}}});o(x),Y(ge.edges.map(V=>({id:V.edgeId,source:V.fromNodeId,target:V.toNodeId})))}).catch(()=>{S&&(o([]),Y([]))}),()=>{S=!1}},[d]),a.useEffect(()=>{gn({libraryId:d}).then(_).catch(()=>_(null))},[d,c,le]);const R=a.useCallback(S=>{Y(ge=>As(S,ge))},[]),ee=()=>{const S=crypto.randomUUID();o(ge=>[...ge,{id:S,type:"default",position:{x:140+ge.length*40,y:120+ge.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},te=()=>{const S=crypto.randomUUID();o(ge=>[...ge,{id:S,type:"default",position:{x:180+ge.length*40,y:160+ge.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},ae=async()=>{z(null);try{const S=c.map(x=>({nodeId:x.id,nodeType:x.data.nodeType,payload:{itemType:x.data.itemType,itemId:x.data.itemId??null,label:x.data.label,infoType:x.data.infoType??null}})),ge=le.map(x=>({edgeId:x.id,fromNodeId:x.source,toNodeId:x.target}));await mn({libraryId:d,nodes:S,edges:ge}),z(t.cogita.library.graph.saveSuccess)}catch{z(t.cogita.library.graph.saveFail)}},Pe=S=>{T&&o(ge=>ge.map(x=>x.id===T.id?{...x,data:{...x.data,itemId:(S==null?void 0:S.infoId)??null,itemType:"collection",infoType:"collection",label:(S==null?void 0:S.label)??t.cogita.library.infoTypes.collection}}:x))},de=S=>{T&&o(ge=>ge.map(x=>x.id===T.id?{...x,data:{...x.data,itemId:(S==null?void 0:S.infoId)??null,itemType:"info",infoType:(S==null?void 0:S.infoType)??null,label:(S==null?void 0:S.label)??t.cogita.library.infoTypes.any}}:x))};return a.useEffect(()=>{if(!T||T.data.nodeType!=="info"||T.data.infoType!=="quote"||!T.data.itemId){G(null);return}let S=!0;return ua({libraryId:d,infoId:T.data.itemId}).then(ge=>{if(!S)return;const x=ge.payload,V=(x==null?void 0:x.text)??"";if(!V){G(null);return}const ue=ma(V),B=Object.values(ue.nodes).sort((Q,Ne)=>Q.depth-Ne.depth||Q.start-Ne.start).map(Q=>({id:Q.id,text:Q.text,depth:Q.depth}));G({title:(x==null?void 0:x.title)??T.data.label,fragments:B})}).catch(()=>G(null)),()=>{S=!1}},[d,T]),e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:N,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:ae,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ee,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:te,children:t.cogita.library.actions.addInfo}),ie?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(ie.totalCollections))})}):null,m?e.jsx("p",{className:"cogita-help",children:m}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(Fs,{nodes:c,edges:le,onNodesChange:H,onEdgesChange:U,onConnect:R,onNodeClick:(S,ge)=>h(ge.id),fitView:!0,children:[e.jsx(Ps,{gap:18,size:1}),e.jsx(_s,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),T?e.jsxs("div",{className:"cogita-graph-inspector",children:[T.data.nodeType==="collection"?e.jsx(ta,{libraryId:d,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:T.data.itemId?{id:T.data.itemId,label:T.data.label,infoType:"collection"}:null,onChange:Pe,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(ta,{libraryId:d,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:T.data.itemId?{id:T.data.itemId,label:T.data.label,infoType:T.data.infoType??void 0}:null,onChange:de,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),L?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:L.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:L.fragments.map(S=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:S.id}),e.jsx("span",{children:S.text})]},S.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function ni({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,libraryId:d,collectionId:N}){const{libraryName:c}=Dt(d),[o,H]=a.useState([]),[le,Y]=a.useState("loading"),[U,v]=a.useState("idle"),h=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),ie=`/#/cogita/library/${d}`,_=()=>{Y("loading"),Us({libraryId:d}).then(L=>{H(L),Y("idle")}).catch(()=>{H([]),Y("error")})};a.useEffect(()=>{_()},[d]);const m=async L=>{try{await zs({libraryId:d,shareId:L}),_()}catch{_()}},z=async L=>{const G=`${h}/${L}`;try{await navigator.clipboard.writeText(G),v("copied")}catch{v("failed")}};return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:ie,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${ie}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[le==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):le==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):o.filter(L=>!N||L.collectionId===N).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:o.filter(L=>!N||L.collectionId===N).map(L=>e.jsxs("div",{className:"cogita-share-row","data-state":L.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:L.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(L.createdUtc).toLocaleString(),L.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),L.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${h}/${L.shareCode}`}):null]}),L.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[L.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>z(L.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>m(L.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},L.shareId))}),U==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):U==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function ii({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,libraryId:d}){const{libraryName:N}=Dt(d),[c,o]=a.useState(null),[H,le]=a.useState(null),[Y,U]=a.useState(null),[v,h]=a.useState(null),[ie,_]=a.useState(null),[m,z]=a.useState(null),L=a.useRef(null),G=ee=>{if(!Number.isFinite(ee))return"0 B";if(ee<1024)return`${ee} B`;const te=ee/1024;if(te<1024)return`${te.toFixed(1)} KB`;const ae=te/1024;return ae<1024?`${ae.toFixed(1)} MB`:`${(ae/1024).toFixed(1)} GB`},T=async()=>{o(null),_({loadedBytes:0,totalBytes:null,percent:null});try{o(t.cogita.library.overview.exporting);const ee=await fn(d,_),te=URL.createObjectURL(ee),ae=document.createElement("a");ae.href=te,ae.download=`cogita-library-${N||d}.json`,ae.click(),URL.revokeObjectURL(te),o(t.cogita.library.overview.exportReady)}catch{o(t.cogita.library.overview.exportFail)}finally{_(ee=>ee??{loadedBytes:0,totalBytes:null,percent:null})}},R=async ee=>{var ae;le(null),U(null),h(null);const te=(ae=ee.target.files)==null?void 0:ae[0];if(te)try{le(t.cogita.library.overview.importing),z({loadedBytes:0,totalBytes:te.size,percent:0});const Pe=await pn(d,te,z,de=>{const S=de.stage==="infos"?t.cogita.library.overview.importStageInfos:de.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;h(t.cogita.library.overview.importLiveProgress.replace("{stage}",S).replace("{done}",String(de.processed)).replace("{total}",String(de.total)).replace("{infos}",String(de.infos)).replace("{connections}",String(de.connections)).replace("{collections}",String(de.collections)))});U({infos:Pe.infosImported,connections:Pe.connectionsImported,collections:Pe.collectionsImported}),le(t.cogita.library.overview.importDone)}catch(Pe){const de=Pe instanceof bn&&Pe.message?` ${Pe.message}`:"";le(`${t.cogita.library.overview.importFail}${de}`)}finally{L.current&&(L.current.value="")}};return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:N}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:T,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:L,type:"file",accept:"application/json",onChange:R})]})]}),ie?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:ie.percent??void 0,max:ie.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",G(ie.loadedBytes)).replace("{total}",ie.totalBytes?G(ie.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,m?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:m.percent??void 0,max:m.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",G(m.loadedBytes)).replace("{total}",m.totalBytes?G(m.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,c?e.jsx("p",{className:"cogita-help",children:c}):null,H?e.jsx("p",{className:"cogita-help",children:H}):null,v?e.jsx("p",{className:"cogita-help",children:v}):null,Y?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(Y.infos)).replace("{connections}",String(Y.connections)).replace("{collections}",String(Y.collections))}):null]})]})})})]})})}function ri({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,libraryId:d}){const{libraryName:N}=Dt(d),[c,o]=a.useState(""),[H,le]=a.useState([]),Y=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:N}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:c,onChange:U=>o(U.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const U=c.trim();U&&(le(v=>[{id:Y(),name:U},...v]),o(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[H.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,H.map(U=>e.jsx("button",{type:"button",className:"ghost",children:U.name},U.id))]})]})]})})})]})})}function oi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,libraryId:d}){const{libraryName:N}=Dt(d),[c,o]=a.useState(""),[H,le]=a.useState([]),Y=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:N}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:c,onChange:U=>o(U.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const U=c.trim();U&&(le(v=>[{id:Y(),name:U},...v]),o(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[H.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,H.map(U=>e.jsx("button",{type:"button",className:"ghost",children:U.name},U.id))]})]})]})})})]})})}function Is({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,libraryId:d}){const{libraryName:N}=Dt(d),c=`/#/cogita/library/${d}`,[o,H]=a.useState(""),[le,Y]=a.useState([]),[U,v]=a.useState("idle"),[h,ie]=a.useState(0),[_,m]=a.useState(null);a.useEffect(()=>{v("loading");const L=window.setTimeout(()=>{va({libraryId:d,query:o.trim()||void 0,limit:30}).then(G=>{Y(G.items),ie(G.total),m(G.nextCursor??null),v("ready")}).catch(()=>{Y([]),ie(0),m(null),v("ready")})},240);return()=>window.clearTimeout(L)},[d,o]);const z=async()=>{if(_){v("loading");try{const L=await va({libraryId:d,query:o.trim()||void 0,limit:30,cursor:_});Y(G=>[...G,...L.items]),m(L.nextCursor??null),ie(L.total),v("ready")}catch{v("ready")}}};return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:N}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:c,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${c}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:o,onChange:L=>H(L.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(le.length)).replace("{total}",String(h||le.length))}),e.jsx("span",{children:U==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:le.length?le.map(L=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${c}/collections/${L.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:L.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(L.itemCount))," ·"," ",L.notes||t.cogita.library.collections.noNotes]})]})},L.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${c}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),_?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:z,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const ne=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,_t=(t,s,n,r)=>`${t}:${s}:${n??""}:${r??""}`;function li({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,libraryId:d,collectionId:N}){Dt(d);const c=`/#/cogita/library/${d}`,[o,H]=a.useState(t.cogita.library.collections.defaultName),[le,Y]=a.useState(null),[U,v]=a.useState(0),[h,ie]=a.useState([]),[_,m]=a.useState("idle"),[z,L]=a.useState(null),G=a.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(h.length)).replace("{total}",String(U||h.length)),[t,h.length,U]);a.useEffect(()=>{qa(d,N).then(R=>{H(R.name),Y(R.notes??null),v(R.itemCount)}).catch(()=>{H(t.cogita.library.collections.defaultName),Y(null)})},[d,N]),a.useEffect(()=>{m("loading"),$a({libraryId:d,collectionId:N,limit:40}).then(R=>{ie(R.items),L(R.nextCursor??null),v(R.total),m("ready")}).catch(()=>{ie([]),L(null),m("ready")})},[d,N]);const T=async()=>{if(z){m("loading");try{const R=await $a({libraryId:d,collectionId:N,limit:40,cursor:z});ie(ee=>[...ee,...R.items]),L(R.nextCursor??null),v(R.total),m("ready")}catch{m("ready")}}};return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:o}),e.jsx("p",{className:"cogita-library-subtitle",children:le||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:c,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${c}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${c}/collections/${N}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${c}/collections/${N}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:G}),e.jsx("span",{children:_==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:h.length?h.map(R=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:R.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:R.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:R.label}),e.jsx("p",{className:"cogita-card-subtitle",children:R.description})]})},ne(R))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),z?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:T,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${c}/collections/${N}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const Bt=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const s=t.length,n=t.filter(g=>g.correct).length,r=Da(hs(t));return{score:Math.round(Math.max(0,Math.min(100,r.knowness*100))*100)/100,total:s,correct:n,lastReviewedUtc:r.lastReviewedUtc??null}},ci=t=>{if(t.maskBase64)try{const s=yn(t.maskBase64);if(!s.length)return t.correct?1:0;const n=s.reduce((r,l)=>r+l,0);return Math.max(0,Math.min(1,n/s.length/255))}catch{return t.correct?1:0}return t.correct?1:0},hs=t=>t.map(s=>({correctness:ci(s),createdUtc:s.createdUtc})),Da=(t,s=Date.now())=>{var U;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const r=t.slice().sort((v,h)=>v.createdUtc.localeCompare(h.createdUtc)).slice(-5),l=r.reduce((v,h)=>v+h.correctness,0)/r.length,g=5,b=2,y=.15;let A=0,j=0;for(let v=0;v<r.length;v+=1){const h=new Date(r[v].createdUtc).getTime(),ie=v===r.length-1?s:new Date(r[v+1].createdUtc).getTime(),_=Math.max(0,(ie-h)/(1e3*60)),m=1-Math.exp(-_/g);A+=m,r[v].correctness>.5&&(j+=y)}let d=l*A*b+j;const N=((U=r[r.length-1])==null?void 0:U.createdUtc)??null,c=N?Math.max(0,(s-new Date(N).getTime())/(1e3*60)):0,H=1/(1+Math.log1p(c/60));return d*=H,r.length===1&&r[0].correctness>.5&&(d+=5.44*Math.exp(-c/2)),{knowness:d,avgCorrectness:l,lastReviewedUtc:N}},wa=t=>{const s=t.slice();for(let n=s.length-1;n>0;n-=1){const r=Math.floor(Math.random()*(n+1));[s[n],s[r]]=[s[r],s[n]]}return s},La=t=>t[Math.floor(Math.random()*t.length)],di=(t,s)=>{const n=new Map;return t.forEach(r=>n.set(r,Math.random())),t.sort((r,l)=>{const g=s(r)-s(l);return g!==0?g:(n.get(r)??0)-(n.get(l)??0)})},Va=(t,s,n,r,l)=>{if(!t.length)return null;const g=t.filter(y=>!(l!=null&&l.has(ne(y))));if(g.length===0)return null;const b=g.filter(y=>ne(y)!==n);return La(b.length?b:g)},ui=(t,s,n,r,l)=>{if(!t.length)return null;let g=Number.POSITIVE_INFINITY;for(const j of t){const d=ne(j);if(n.has(d))continue;const N=s[d]??1;N<g&&(g=N)}if(!Number.isFinite(g))return null;const b=t.filter(j=>{const d=ne(j);return!n.has(d)&&(s[d]??1)===g}),y=b.filter(j=>!l||ne(j)!==l),A=r?y.filter(j=>!r.has(ne(j))):y;return A.length>0?La(A):y.length>0?La(y):l&&b.some(j=>ne(j)===l)?b.find(j=>ne(j)===l)??null:b.length?La(b):null},Ys=(t,s,n,r,l)=>{const g=[],b=t.filter(A=>!l.has(ne(A))&&!n.has(ne(A))&&(s[ne(A)]??0)<1),y=di(b,A=>s[ne(A)]??0);for(const A of y){if(g.length>=r)break;g.push(A),l.add(ne(A))}if(g.length<r){const A=wa(t.filter(j=>!l.has(ne(j))&&n.has(ne(j))));for(const j of A){if(g.length>=r)break;g.push(j),l.add(ne(j))}}return g},hi=(t,s,n,r)=>Ys(t,s,n,r,new Set),gs=(t,s,n,r,l,g)=>{const b=Math.max(1,n.stackSize??s),A=wa(t).filter((H,le,Y)=>Y.findIndex(U=>ne(U)===ne(H))===le),j=hi(A,r,l,b),d=new Set,N=new Set,c=Va(j,{},null,d,N),o=c?[c]:[];return c&&N.add(ne(c)),{queue:o,meta:{pool:A,active:j,knownessMap:r,unknownSet:l,outcomesById:g,asked:d,queued:N}}},ls={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,s)=>{const r=wa(t).filter((l,g,b)=>b.findIndex(y=>ne(y)===ne(l))===g);return{queue:r.slice(0,Math.min(s,r.length)),meta:{}}},applyOutcome:t=>t},ms=(t,s,n,r)=>{const l=Math.max(1,n.stackSize??s),b=wa(t).filter((le,Y,U)=>U.findIndex(v=>ne(v)===ne(le))===Y),y={},A=new Set,j=new Set,d=new Set,N=Math.max(1,n.levels??1);b.forEach(le=>{const Y=ne(le),U=r==null?void 0:r[Y],v=typeof U=="number"&&Number.isFinite(U)?U:1;y[Y]=Math.min(N,Math.max(1,Math.round(v)))});const c=[];if(b.length>0){const le=new Map;b.forEach(U=>{var h;const v=y[ne(U)]??1;le.has(v)||le.set(v,[]),(h=le.get(v))==null||h.push(U)});const Y=Array.from(le.keys()).sort((U,v)=>U-v);for(const U of Y){if(c.length>=l)break;const v=wa(le.get(U)??[]);for(const h of v){if(c.length>=l)break;c.push(h)}}}const o=Va(c,y,null,A,j),H=o?[o]:[];return o&&j.add(ne(o)),{queue:H,meta:{pool:b,active:c,levelMap:y,asked:A,queued:j,wrongSinceCorrect:d}}},gi={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,s)=>Math.max(1,s.stackSize??t),getProgressTotal:()=>null,prepare:(t,s,n)=>ms(t,s,n),applyOutcome:(t,s,n,r,l)=>{if(!s)return t;const g=Math.max(1,r.levels??1),b=t.meta.pool??[],y=t.meta.active??[],A={...t.meta.levelMap??{}},j=new Set(t.meta.asked??[]),d=new Set(t.meta.queued??[]),N=new Set(t.meta.wrongSinceCorrect??[]),c=ne(s);d.delete(c),j.add(c);const o=A[c]??1;l.correct?(A[c]=N.has(c)?1:Math.min(o+1,g),N.delete(c)):(A[c]=1,N.add(c));const H=l.correct?y.filter(U=>ne(U)!==c):y.slice();if(l.correct&&H.length<Math.max(1,r.stackSize??1)){const U=new Set(H.map(h=>ne(h))),v=ui(b,A,U,j,c);v&&H.push(v)}const le=t.queue.slice(),Y=Va(H,A,c,j,d);return Y&&(le.push(Y),d.add(ne(Y))),{queue:le,meta:{pool:b,active:H,levelMap:A,asked:j,queued:d,wrongSinceCorrect:N}}}},mi={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,s)=>Math.max(1,s.stackSize??t),getProgressTotal:()=>null,prepare:(t,s,n)=>gs(t,s,n,{},new Set,{}),applyOutcome:(t,s,n,r,l)=>{if(!s)return t;const g=t.meta.pool??[],b=t.meta.active??[],y={...t.meta.knownessMap??{}},A=new Set(t.meta.unknownSet??[]),j={...t.meta.outcomesById??{}},d=new Set(t.meta.asked??[]),N=new Set(t.meta.queued??[]),c=ne(s);N.delete(c),d.add(c);const o={correctness:Math.max(0,Math.min(1,l.correctness??(l.correct?1:0))),createdUtc:l.createdUtc??new Date().toISOString()},le=(j[c]??[]).concat(o).sort((_,m)=>_.createdUtc.localeCompare(m.createdUtc)).slice(-5);j[c]=le,A.delete(c);const Y=Date.now();g.forEach(_=>{const m=ne(_),z=j[m]??[];if(z.length===0){y[m]=0,A.add(m);return}const L=Da(z,Y);y[m]=L.knowness});const U=b.slice();if((y[c]??0)>=1){const _=U.filter(m=>ne(m)!==c);U.length=0,U.push(..._)}const h=Math.max(1,r.stackSize??n);if(U.length<h){const _=new Set(U.map(z=>ne(z))),m=Ys(g,y,A,h-U.length,_);U.push(...m)}const ie=t.queue.slice();if(ie.length===0||ne(ie[ie.length-1])===c){const _=Va(U,{},c,d,N);_&&(ie.push(_),N.add(ne(_)))}return{queue:ie,meta:{pool:g,active:U,knownessMap:y,unknownSet:A,outcomesById:j,asked:d,queued:N}}}},Xs={random:ls,levels:gi,temporal:mi},fi=Object.values(Xs),fs=t=>{if(!t)return ls;const s=t.trim().toLowerCase();return s==="random"||s==="levels"||s==="temporal"?Xs[s]:ls},Oa=(t,s)=>{const n={...t.defaultSettings};return s&&Object.entries(s).forEach(([r,l])=>{typeof l=="number"&&Number.isFinite(l)&&(n[r]=l),typeof l=="string"&&(n[r]=l)}),t.settingsFields.forEach(r=>{var g;const l=n[r.key];if(r.type==="number"){if(typeof l!="number"||Number.isNaN(l)){n[r.key]=t.defaultSettings[r.key]??0;return}r.min!==void 0&&(n[r.key]=Math.max(r.min,n[r.key])),r.max!==void 0&&(n[r.key]=Math.min(r.max,n[r.key]));return}if(r.type==="select"){const b=((g=r.options)==null?void 0:g.map(y=>y.value))??[];(typeof l!="string"||b.length>0&&!b.includes(l))&&(n[r.key]=t.defaultSettings[r.key]??b[0]??"")}}),n},Gs=(t,s)=>{const n={};return t.settingsFields.forEach(r=>{const l=s.get(r.key);if(l){if(r.type==="number"){const g=Number(l);Number.isNaN(g)||(n[r.key]=g);return}n[r.key]=l}}),Oa(t,n)},pi=(t,s)=>{const n=new URLSearchParams;return t.settingsFields.forEach(r=>{const l=s[r.key];(typeof l=="number"||typeof l=="string")&&n.set(r.key,String(l))}),n};function bi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,libraryId:d,collectionId:N,revisionId:c}){const{libraryName:o}=Dt(d),H=`/#/cogita/library/${d}`,[le,Y]=a.useState(t.cogita.library.collections.defaultName),[U,v]=a.useState(""),[h,ie]=a.useState(20),[_,m]=a.useState("random"),[z,L]=a.useState({}),[G,T]=a.useState("exact"),[R,ee]=a.useState([]),[te,ae]=a.useState(null),[Pe,de]=a.useState([]),[S,ge]=a.useState("idle"),[x,V]=a.useState(null),[ue,B]=a.useState("idle"),[Q,Ne]=a.useState("idle"),[Se,we]=a.useState("idle"),$e=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),ye=a.useMemo(()=>fs(_),[_]),Ke=a.useMemo(()=>Oa(ye,z),[ye,z]),_e=a.useMemo(()=>pi(ye,Ke).toString(),[ye,Ke]);a.useEffect(()=>{qa(d,N).then(W=>Y(W.name)).catch(()=>Y(t.cogita.library.collections.defaultName))},[d,N]),a.useEffect(()=>{c&&xn({libraryId:d,collectionId:N,revisionId:c}).then(W=>{v(W.name),m(W.mode||"random"),T(W.check||"exact"),ie(W.limit||20),L(W.revisionSettings??{})}).catch(()=>{v("")})},[N,d,c]),a.useEffect(()=>{vn({libraryId:d}).then(W=>{ee(W),!te&&W.length>0&&ae(W[0].roleId)}).catch(()=>{ee([])})},[d]);const je=()=>{Ne("loading"),Us({libraryId:d}).then(W=>{de(W),Ne("idle")}).catch(()=>{de([]),Ne("error")})};a.useEffect(()=>{je()},[d]);const Be=async()=>{ge("working"),B("idle");try{const W=await jn({libraryId:d,collectionId:N,revisionType:ye.id,revisionSettings:Ke,mode:_,check:G,limit:h});V(`${$e}/${W.shareCode}${_e?`?${_e}`:""}`),ge("ready"),je()}catch{ge("error")}},tt=async()=>{if(c){we("saving");try{await wn({libraryId:d,collectionId:N,revisionId:c,name:U||le,revisionType:ye.id,revisionSettings:Ke,mode:_,check:G,limit:h}),we("saved")}catch{we("error")}}},Ye=async()=>{if(x)try{await navigator.clipboard.writeText(x),B("copied")}catch{B("failed")}},q=async W=>{try{await zs({libraryId:d,shareId:W}),je()}catch{je()}};return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:le}),e.jsx("p",{className:"cogita-library-subtitle",children:o})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:H,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${H}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${H}/collections/${N}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${H}/collections/${N}/revision/run?mode=${encodeURIComponent(_)}&check=${encodeURIComponent(G)}&limit=${h}${_e?`&${_e}`:""}${te?`&reviewer=${encodeURIComponent(te)}`:""}${c?`&revisionId=${encodeURIComponent(c)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:U,onChange:W=>v(W.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:_,onChange:W=>m(W.target.value),children:fi.map(W=>e.jsx("option",{value:W.id,children:t.cogita.library.revision[W.labelKey]},W.id))})]}),ye.settingsFields.map(W=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[W.labelKey]}),W.type==="select"?e.jsx("select",{value:String(Ke[W.key]??""),onChange:De=>L(xe=>({...xe,[W.key]:De.target.value})),children:(W.options??[]).map(De=>e.jsx("option",{value:De.value,children:t.cogita.library.revision[De.labelKey]},De.value))}):e.jsx("input",{type:"number",min:W.min,max:W.max,step:W.step,value:Ke[W.key]??0,onChange:De=>L(xe=>({...xe,[W.key]:Number(De.target.value||0)}))})]},W.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),ye.id!=="levels"&&ye.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:h,onChange:W=>ie(Number(W.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:te??"",onChange:W=>ae(W.target.value||null),children:R.map(W=>e.jsx("option",{value:W.roleId,children:W.label},W.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[c?e.jsx("button",{type:"button",className:"cta ghost",onClick:tt,disabled:Se==="saving",children:Se==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${H}/collections/${N}/revision/run?mode=${encodeURIComponent(_)}&check=${encodeURIComponent(G)}&limit=${h}${_e?`&${_e}`:""}${te?`&reviewer=${encodeURIComponent(te)}`:""}${c?`&revisionId=${encodeURIComponent(c)}`:""}`,children:t.cogita.library.actions.startRevision})]}),Se==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),x?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:x,readOnly:!0})]}):null,S==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,ue==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):ue==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:Be,disabled:S==="working",children:S==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),x?e.jsx("button",{type:"button",className:"cta ghost",onClick:Ye,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),Q==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):Pe.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:Pe.map(W=>e.jsxs("div",{className:"cogita-share-row","data-state":W.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:W.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(W.createdUtc).toLocaleString(),W.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),W.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>q(W.shareId),children:t.cogita.library.revision.shareRevokeAction})]},W.shareId))})]})]})]})]})})})]})})}const es=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function Js(t,s,n){if(!t)return null;const r=new Map(t.nodes.map(_=>[_.id,_])),l=new Map,g=new Set,b=_=>{if(typeof _=="number")return _;if(typeof _=="string"){const m=Number(_);return Number.isFinite(m)?m:0}return 0},y=_=>{if(l.has(_))return l.get(_);if(g.has(_))return 0;const m=r.get(_);if(!m)return 0;g.add(_);const z=G=>{var R,ee;return(G?((R=m.inputsByHandle)==null?void 0:R[G])??[]:m.inputs??((ee=m.inputsByHandle)==null?void 0:ee.in)??[]).map(te=>y(te))};let L=0;switch(m.type){case"input.random":{const G=m.min??0,T=m.max??G+10,R=Math.min(G,T),ee=Math.max(G,T);L=Math.floor(Math.random()*(ee-R+1))+R;break}case"input.const":{L=m.value??0;break}case"input.list":{const G=(m.list??[]).filter(Boolean),T=Math.round(b(z("index")[0]));L=G.length?G[Math.max(0,Math.min(G.length-1,T))]:String(T);break}case"compute.add":{L=z("in").map(T=>b(T)).reduce((T,R)=>T+R,0);break}case"compute.sub":{const G=z("add").map(R=>b(R)),T=z("sub").map(R=>b(R));L=G.reduce((R,ee)=>R+ee,0)-T.reduce((R,ee)=>R+ee,0);break}case"compute.mul":{const G=z("in").map(T=>b(T));L=G.length?G.reduce((T,R)=>T*R,1):0;break}case"compute.div":{const G=b(z("num")[0]),T=z("den").map(R=>b(R)).reduce((R,ee)=>R+ee,0);L=Math.abs(T)<Number.EPSILON?0:G/T;break}case"compute.pow":{const G=b(z("base")[0]),T=b(z("exp")[0]);L=Math.pow(G,T);break}case"compute.exp":{const G=b(z("base")[0]),T=b(z("exp")[0]);L=Math.pow(G,T);break}case"compute.log":{const G=b(z("value")[0]),T=b(z("base")[0]),R=Math.max(G,Number.EPSILON);L=Math.abs(T)<Number.EPSILON?Math.log(R):Math.log(R)/Math.log(T);break}case"compute.abs":{L=Math.abs(b(z("in")[0]));break}case"compute.min":{const G=z("in").map(T=>b(T));L=G.length?Math.min(...G):0;break}case"compute.max":{const G=z("in").map(T=>b(T));L=G.length?Math.max(...G):0;break}case"compute.floor":{L=Math.floor(b(z("in")[0]));break}case"compute.ceil":{L=Math.ceil(b(z("in")[0]));break}case"compute.round":{L=Math.round(b(z("in")[0]));break}case"compute.mod":{const G=b(z("a")[0]),T=b(z("b")[0]);L=Math.abs(T)<Number.EPSILON?0:G%T;break}case"compute.concat":{const T=["in1","in2","in3","in4","in5","in6"].flatMap(ae=>z(ae)),R=T.length?T:z("in");L=(R.length?R:z()).map(ae=>ae==null?"":String(ae)).join("");break}case"compute.trim":{const G=z("text")[0]??z("in")[0]??"",T=G==null?"":String(G),R=Math.max(0,Math.round(b(z("start")[0]))),ee=Math.max(0,Math.round(b(z("end")[0])));R+ee>=T.length?L="":L=T.substring(R,T.length-ee);break}case"output":{L=z("in")[0]??0;break}default:L=0}return g.delete(_),l.set(_,L),L},A=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(_=>_.type==="output").map(_=>_.id);t.nodes.forEach(_=>y(_.id)),A.forEach(_=>y(_));const j=_=>Math.abs(_%1)<1e-5?String(Math.round(_)):_.toFixed(3).replace(/\.?0+$/,""),d=_=>typeof _=="number"?j(_):_??"",N=new Map;A.forEach(_=>{var T,R,ee,te;const m=r.get(_);if(!m)return;const z=(R=(T=m.inputsByHandle)==null?void 0:T.name)==null?void 0:R[0],L=z?d(l.get(z)):"",G=(L==null?void 0:L.toString().trim())||((ee=m.outputLabel)==null?void 0:ee.trim())||((te=m.name)==null?void 0:te.trim())||_;N.set(_,G)});const c={},o={},H={};A.forEach(_=>{var L,G;const m=r.get(_);if(!m)return;const z=N.get(_)??(((L=m.outputLabel)==null?void 0:L.trim())||((G=m.name)==null?void 0:G.trim())||_);c[z]=d(l.get(_)),m.name&&(o[m.name.trim()]=z),o[_]=z});const le=(_,m)=>{let z=_;return t.nodes.forEach(L=>{var te,ae;const G=d(l.get(L.id)),T=A.includes(L.id),R=T?N.get(L.id)??((te=L.outputLabel)==null?void 0:te.trim())??((ae=L.name)==null?void 0:ae.trim())??L.id:"",ee=T&&m?R:G;z=z.replace(new RegExp(`\\{\\s*${es(L.id)}\\s*\\}`,"gi"),ee),L.name&&(z=z.replace(new RegExp(`\\{\\s*${es(L.name)}\\s*\\}`,"gi"),ee)),T&&L.outputLabel&&(z=z.replace(new RegExp(`\\{\\s*${es(L.outputLabel)}\\s*\\}`,"gi"),R))}),z},Y=s;let U=Y.trim().length>0?Y:"";U||(U=A.length?`Compute ${A.join(", ")}`:"Compute"),U=le(U,!0);const v=(n==null?void 0:n.trim())??"",h=v?le(v,!1):"",ie={};return l.forEach((_,m)=>{ie[m]=_,H[m]=d(_);const z=r.get(m);z!=null&&z.name&&(H[z.name.trim()]=d(_))}),{prompt:U,answers:c,values:ie,answerText:h,outputVariables:o,variableValues:H}}function Zs(t){var n;const s=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((n=s[0])==null?void 0:n[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}function en({copy:t,currentCard:s,currentTypeLabel:n,prompt:r,languages:l,answer:g,onAnswerChange:b,computedExpected:y,computedAnswers:A,onComputedAnswerChange:j,answerTemplate:d,outputVariables:N,variableValues:c,computedFieldFeedback:o,feedback:H,canAdvance:le,quoteContext:Y,quotePlaceholder:U,onCheckAnswer:v,onSkip:h,onLanguageSelect:ie,onMarkReviewed:_,onAdvance:m,showCorrectAnswer:z,setShowCorrectAnswer:L,onRevealCorrect:G,answerMask:T,expectedAnswer:R,hasExpectedAnswer:ee,handleComputedKeyDown:te,answerInputRef:ae,computedInputRefs:Pe,scriptMode:de,setScriptMode:S,matchPairs:ge,matchLeftOrder:x,matchRightOrder:V,matchSelection:ue,matchActiveLeft:B,matchActiveRight:Q,matchFeedback:Ne,onMatchLeftSelect:Se,onMatchRightSelect:we}){const $e=a.useMemo(()=>{var ve;const q=!d&&y.length===2?`The {${y[0].key}} is of type {${y[1].key}}`:null,W=d??q;if(!W)return null;const De=new Map(y.map($=>[$.key,$.expected])),xe=new Set,re=[],Le=/\{([^}]+)\}/g;let qe=0,K,ce=null;for(;(K=Le.exec(W))!==null;){const $=W.slice(qe,K.index);$&&re.push({type:"text",value:$});const O=((ve=K[1])==null?void 0:ve.trim())??"",fe=O&&De.has(O)?O:O&&N&&N[O]?N[O]:null;O&&xe.add(O),fe&&xe.add(fe),fe&&De.has(fe)?(re.push({type:"input",value:fe}),ce||(ce=fe)):O&&c&&c[O]!==void 0?re.push({type:"text",value:c[O]}):re.push({type:"text",value:K[0]}),qe=K.index+K[0].length}const I=W.slice(qe);return I&&re.push({type:"text",value:I}),y.filter($=>!xe.has($.key)).length>0?null:{parts:re,expectedByKey:De,firstInputKey:ce}},[d,y,N,c]),ye=()=>{if(!$e)return null;const{parts:q,expectedByKey:W,firstInputKey:De}=$e;return e.jsx("div",{className:"cogita-revision-inline-answer",children:q.map((xe,re)=>{var Le,qe;return xe.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:xe.value},`text-${re}`):e.jsx("input",{ref:K=>{Pe.current[xe.value]=K},autoFocus:xe.value===De,value:A[xe.value]??"",onChange:K=>j(xe.value,K.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":o[xe.value]??(H==="correct"?"correct":H==="incorrect"?"incorrect":void 0),onKeyDown:K=>Be(K)||te(K),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((Le=A[xe.value])==null?void 0:Le.length)??0,((qe=W.get(xe.value))==null?void 0:qe.length)??6)}ch`}},`input-${xe.value}-${re}`)})})},Ke=a.useMemo(()=>{const q=new Map;return(ge??[]).forEach(W=>q.set(W.leftId,W)),q},[ge]),_e=a.useMemo(()=>{const q=new Map;return(ge??[]).forEach(W=>q.set(W.rightId,W)),q},[ge]);a.useEffect(()=>{var re;if(s.cardType!=="info"||s.infoType!=="computed"||y.length===0)return;const q=typeof document<"u"?document.activeElement:null;if(q&&(q.tagName==="INPUT"||q.tagName==="TEXTAREA"))return;const W=($e==null?void 0:$e.firstInputKey)??((re=y[0])==null?void 0:re.key);if(!W)return;const De=Pe.current[W];if(!De)return;const xe=requestAnimationFrame(()=>{De.focus()});return()=>cancelAnimationFrame(xe)},[s,y,$e]);const je=(()=>{const q=[R??"",...y.map(xe=>xe.expected??"")].join(""),W=[g,...Object.values(A)].join(""),De=`${q}${W}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(De)})(),Be=q=>q.ctrlKey&&(q.key==="^"||q.key==="6")?(q.preventDefault(),S(W=>W==="super"?null:"super"),!0):q.ctrlKey&&(q.key==="_"||q.key==="-")?(q.preventDefault(),S(W=>W==="sub"?null:"sub"),!0):!1,tt=()=>{if(!R||!T)return R??"";const q=R.split(""),W=Array.from(T),De=W.length>0?W.reduce((xe,re)=>xe+re,0)/W.length:127;return q.map((xe,re)=>{const Le=W[re]??De,qe=Math.max(0,Math.min(255,Math.round(Le)));let K=255,ce=0;return qe<=127?ce=Math.round(qe/127*255):(ce=255,K=Math.round(255*(1-(qe-127)/128))),e.jsx("span",{style:{color:`rgb(${K}, ${ce}, 0)`},children:xe},`mask-${re}`)})},Ye=s.cardType==="info"&&s.infoType==="quote"?(Y==null?void 0:Y.title)||s.label:s.description;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[e.jsx("span",{children:n}),e.jsx("strong",{children:Ye})]}),s.cardType==="vocab"&&s.checkType==="translation-match"&&ge?e.jsxs("div",{className:"cogita-revision-body",children:[r?e.jsx("h2",{children:r}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(x??[]).map(q=>{const W=Ke.get(q);if(!W)return null;const De=(ue==null?void 0:ue[q])??null,xe=(Ne==null?void 0:Ne[q])??null,re=B===q;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":re,"data-state":xe??void 0,"data-locked":De?"true":void 0,onClick:()=>Se==null?void 0:Se(q),children:[e.jsx("span",{children:W.leftLabel}),De&&z?e.jsx("em",{children:"✓"}):null]},q)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(V??[]).map(q=>{const W=_e.get(q);if(!W)return null;const De=Object.values(ue??{}).includes(q),xe=Q===q;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":De||xe,"data-locked":De?"true":void 0,onClick:()=>we==null?void 0:we(q),children:e.jsx("span",{children:W.rightLabel})},q)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:s.checkType==="translation-match",children:t.cogita.library.revision.checkAnswer}),e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):s.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ae,value:g,onChange:q=>b(q.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":H==="correct"?"correct":H==="incorrect"?"incorrect":void 0,onKeyDown:q=>{q.key==="Enter"&&(q.preventDefault(),q.stopPropagation(),le?m():v())}})]}),je?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":de==="super",onClick:()=>S(q=>q==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":de==="sub",onClick:()=>S(q=>q==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,children:t.cogita.library.revision.checkAnswer}),e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[s.label?e.jsx("p",{className:"cogita-revision-hint",children:s.label}):null,d?null:e.jsx(Nn,{value:r??"",mode:"auto"}),y.length>0?(()=>{const q=ye();return q?e.jsx("div",{className:"cogita-inline-answer-wrap",children:q}):e.jsx("div",{className:"cogita-form-grid",children:y.map((W,De)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:W.key}),e.jsx("textarea",{ref:xe=>{Pe.current[W.key]=xe},autoFocus:De===0,value:A[W.key]??"",onChange:xe=>j(W.key,xe.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":o[W.key]??(H==="correct"?"correct":H==="incorrect"?"incorrect":void 0),onKeyDown:xe=>Be(xe)||te(xe)})]},W.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:ae,value:g,onChange:q=>b(q.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":H==="correct"?"correct":H==="incorrect"?"incorrect":void 0,onKeyDown:q=>{Be(q)||q.key==="Enter"&&(q.preventDefault(),q.stopPropagation(),le?m():v())}})]})}),je?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":de==="super",onClick:()=>S(q=>q==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":de==="sub",onClick:()=>S(q=>q==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,children:t.cogita.library.revision.checkAnswer}),e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="quote"&&Y?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(Y.completed)).replace("{total}",String(Y.total))}),e.jsx("p",{className:"cogita-quote-text",children:Y.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ae,value:g,onChange:q=>b(q.target.value),placeholder:U??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":H==="correct"?"correct":H==="incorrect"?"incorrect":void 0,onKeyDown:q=>{q.key==="Enter"&&(q.preventDefault(),q.stopPropagation(),le?m():v())}})]}),e.jsx("p",{className:"cogita-quote-text",children:Y.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,children:t.cogita.library.revision.checkAnswer}),e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:l.length?l.map(q=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>ie(q.label),children:q.label},q.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:_,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}),H&&e.jsx("div",{className:"cogita-revision-feedback","data-state":H,children:H==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),H==="incorrect"&&ee?e.jsxs("div",{className:"cogita-revision-reveal",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>L(q=>{const W=!q;return W&&G(),W}),children:t.cogita.library.revision.showAnswer}),z?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),y.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[y.map(q=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:q.key}),e.jsx("span",{children:q.expected})]},q.key)),R?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:R})]}):null]}):e.jsx("p",{children:T?tt():R})]}):null]}):null,le?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:m,children:t.cogita.library.revision.nextQuestion})}):null]})}const ts=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function tn({outcomes:t}){const[s,n]=a.useState("day"),r=a.useMemo(()=>{const l=ts.find(y=>y.id===s)??ts[1],g=Date.now()-l.ms,b=t.filter(y=>new Date(y.createdUtc).getTime()>=g);return Bt(b)},[t,s]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:ts.map(l=>e.jsx("button",{type:"button",className:"ghost","data-active":s===l.id,onClick:()=>n(l.id),children:l.label},l.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[r.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[r.correct," / ",r.total]})]})}const yi="cogita-revision",xi=1,Ea="outcomes",vi=()=>new Promise((t,s)=>{const n=indexedDB.open(yi,xi);n.onupgradeneeded=()=>{const r=n.result;if(!r.objectStoreNames.contains(Ea)){const l=r.createObjectStore(Ea,{keyPath:"id"});l.createIndex("byItem","itemKey",{unique:!1}),l.createIndex("byPending","pending",{unique:!1})}},n.onerror=()=>s(n.error),n.onsuccess=()=>t(n.result)}),Na=async(t,s)=>{const n=await vi();return new Promise((r,l)=>{const g=n.transaction(Ea,t),b=g.objectStore(Ea);s(b).then(r).catch(l),g.onerror=()=>l(g.error)})},an=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const s=Array.from(t).map(n=>n.toString(16).padStart(2,"0"));return`${s.slice(0,4).join("")}-${s.slice(4,6).join("")}-${s.slice(6,8).join("")}-${s.slice(8,10).join("")}-${s.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},wi=()=>{const t="cogita_revision_client_id",s=localStorage.getItem(t);if(s)return s;const n=an();return localStorage.setItem(t,n),n},ji=()=>{const t="cogita_revision_client_seq",s=Number(localStorage.getItem(t)??"0"),n=Number.isFinite(s)?s+1:1;return localStorage.setItem(t,String(n)),n},sn=(t,s,n,r)=>_t(t,s,n,r),Aa=async t=>{const s=wi(),n=ji(),r=new Date().toISOString(),l={...t,clientId:s,clientSequence:n,createdUtc:r,id:an(),pending:!0};return await Na("readwrite",g=>new Promise((b,y)=>{const A={...l,itemKey:sn(l.itemType,l.itemId,l.checkType,l.direction)},j=g.add(A);j.onsuccess=()=>b(),j.onerror=()=>y(j.error)})),l},Fa=async(t,s,n,r)=>{if(!s)return[];try{const l=sn(t,s,n,r);return await Na("readonly",g=>new Promise((b,y)=>{const j=g.index("byItem").getAll(l);j.onsuccess=()=>{const N=(j.result??[]).map(c=>({itemType:c.itemType,itemId:c.itemId,checkType:c.checkType??null,direction:c.direction??null,revisionType:c.revisionType,evalType:c.evalType,correct:c.correct,createdUtc:c.createdUtc,maskBase64:c.maskBase64,payloadBase64:c.payloadBase64,payloadHashBase64:c.payloadHashBase64,clientId:c.clientId,clientSequence:c.clientSequence,personRoleId:c.personRoleId??null})).sort((c,o)=>c.createdUtc.localeCompare(o.createdUtc));b(N)},j.onerror=()=>y(j.error)}))}catch{return[]}},Kt=async()=>{try{return await Na("readonly",t=>new Promise((s,n)=>{const r=t.getAll();r.onsuccess=()=>{const g=(r.result??[]).map(b=>({itemType:b.itemType,itemId:b.itemId,checkType:b.checkType??null,direction:b.direction??null,revisionType:b.revisionType,evalType:b.evalType,correct:b.correct,createdUtc:b.createdUtc,maskBase64:b.maskBase64,payloadBase64:b.payloadBase64,payloadHashBase64:b.payloadHashBase64,clientId:b.clientId,clientSequence:b.clientSequence,personRoleId:b.personRoleId??null}));s(g)},r.onerror=()=>n(r.error)}))}catch{return[]}},Ni=async(t=100)=>{try{return await Na("readonly",s=>new Promise((n,r)=>{const g=s.index("byPending").getAll(!0);g.onsuccess=()=>{const b=g.result??[];n(b.slice(0,t))},g.onerror=()=>r(g.error)}))}catch{return[]}},ki=async t=>{if(t.length!==0)try{await Na("readwrite",s=>new Promise((n,r)=>{let l=t.length;t.forEach(g=>{const b=s.get(g);b.onsuccess=()=>{const y=b.result;if(y){y.pending=!1;const A=s.put(y);A.onsuccess=()=>{l-=1,l===0&&n()},A.onerror=()=>r(A.error)}else l-=1,l===0&&n()},b.onerror=()=>r(b.error)})}))}catch{}},as=async(t,s)=>{const n=await Ni(200);if(n.length===0)return;const r=new Map;n.forEach(l=>{var b;const g=l.personRoleId??s??"";r.has(g)||r.set(g,[]),(b=r.get(g))==null||b.push(l)});for(const[l,g]of r.entries()){const b=g.map(y=>({itemType:y.itemType,itemId:y.itemId,checkType:y.checkType??null,direction:y.direction??null,revisionType:y.revisionType,evalType:y.evalType,correct:y.correct,clientId:y.clientId,clientSequence:y.clientSequence,maskBase64:y.maskBase64??null,payloadHashBase64:y.payloadHashBase64??null,payloadBase64:y.payloadBase64??null,personRoleId:l||null}));try{await kn({libraryId:t,outcomes:b}),await ki(g.map(y=>y.id))}catch{}}},Ls={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},Ti=(t,s)=>{const n=Math.max(t.length,s.length,1),r=Math.abs(t.length-s.length);return Math.max(0,1-r/n)},Si=(t,s)=>{const n=new Uint8Array(t.length),r=Ti(t,s);for(let l=0;l<t.length;l+=1){const g=t[l]===(s[l]??"")?128:0,b=t.length-1-l,y=s.length-1-l,A=t[b]===(s[y]??"")?127:0,j=Math.round((g+A)*r);n[l]=Math.max(0,Math.min(255,j))}return n},Ma=(t,s)=>t===s||(Ls[t]??[]).includes(s)?!0:(Ls[s]??[]).includes(t),Pa=(t,s)=>{const n=new Uint8Array(t.length);if(!t.length)return n;const r=[];for(let g=0;g<=t.length-3;g+=1)r.push({index:g,text:t.slice(g,g+3)});let l=!1;return r.forEach(g=>{for(let b=0;b<=s.length-3;b+=1){const y=s.slice(b,b+3);let A=0;for(let o=0;o<3;o+=1)Ma(g.text[o],y[o])&&(A+=1);if(A<2)continue;let j=g.index-1,d=b-1;for(;j>=0&&d>=0;){const o=t[j],H=s[d];if(o===H){n[j]=Math.max(n[j],255),j-=1,d-=1,l=!0;continue}if(Ma(o,H)){n[j]=Math.max(n[j],127),j-=1,d-=1,l=!0;continue}if(j>0&&t[j-1]===H){n[j]=Math.max(n[j],0),j-=1,l=!0;continue}if(d>0&&t[j]===s[d-1]){d-=1,l=!0;continue}break}for(let o=0;o<3;o+=1){const H=g.index+o,le=g.text[o],Y=y[o],U=le===Y?255:Ma(le,Y)?127:0;n[H]=Math.max(n[H],U),l=!0}let N=g.index+3,c=b+3;for(;N<t.length&&c<s.length;){const o=t[N],H=s[c];if(o===H){n[N]=Math.max(n[N],255),N+=1,c+=1,l=!0;continue}if(Ma(o,H)){n[N]=Math.max(n[N],127),N+=1,c+=1,l=!0;continue}if(N+1<t.length&&t[N+1]===H){n[N]=Math.max(n[N],0),N+=1,l=!0;continue}if(c+1<s.length&&t[N]===s[c+1]){c+=1,l=!0;continue}break}}}),l?n:Si(t,s)},ga=(t,s,n)=>{const r=t.trim().toLowerCase(),l=s.trim().toLowerCase();return Pa(r,l)},fa=t=>t.trim().toLowerCase().replace(/[^\p{L}\p{N}]+/gu,""),nn=(t,s,n)=>{const r=fa(t),l=fa(s);return Pa(r,l)},xt=t=>t.trim().toLowerCase(),Ci=t=>t==="reverse"?"reverse":"forward",ja=(t,s)=>`${t}|${s}`,jt=t=>{if(!t)return null;const[s,n]=t.split("|",2);return(s==="forward"||s==="reverse")&&n?{mode:s,fragmentId:n}:{mode:"forward",fragmentId:t}},_a=(t,s)=>{var r;const n=jt(s);return n?n.fragmentId&&s?(t??null)===s:(((r=jt(t))==null?void 0:r.mode)??"forward")===n.mode:!0},ht=t=>{const s=t==null?void 0:t.trim().toLowerCase();return s||null},rn=(t,s)=>{if((ht(t.childItemType)??"info")!==(s.cardType??"").toLowerCase()||t.childItemId!==s.cardId)return!1;const r=ht(t.childCheckType),l=ht(t.childDirection),g=ht(s.checkType),b=ht(s.direction);return!(r&&r!==g||l&&l!==b)},Mi={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},Ii={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},Ba=(t,s,n)=>{if(!n||!s.startsWith(t))return s;const r=s.slice(t.length);if(!r)return s;const l=n==="super"?Mi:Ii,g=r.split("").map(b=>l[b]??b).join("");return t+g},Ka=(t,s,n)=>{var b,y,A;if(!t)return((b=s[0])==null?void 0:b.key)??null;const r=new Set(s.map(j=>j.key)),l=/\{([^}]+)\}/g;let g;for(;(g=l.exec(t))!==null;){const j=((y=g[1])==null?void 0:y.trim())??"";if(!j)continue;if(r.has(j))return j;const d=n==null?void 0:n[j];if(d&&r.has(d))return d}return((A=s[0])==null?void 0:A.key)??null},cs=t=>t.flatMap(s=>{if(s.cardType!=="info"||s.infoType!=="quote")return[s];const n=s.description??"";if(!n.trim())return[s];const r=jt(s.direction),l=(r==null?void 0:r.mode)??Ci(s.direction),g=ma(n),b=Object.keys(g.nodes);return b.length===0?[s]:b.map(y=>({...s,checkType:"quote-fragment",direction:ja(l,y)}))});function Li({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,libraryId:d,collectionId:N,revisionId:c}){const o=ds(),H=`/#/cogita/library/${d}`,le=a.useMemo(()=>new URLSearchParams(o.search),[o.search]),Y=Math.max(1,Number(le.get("limit")??20)),U=le.get("mode")??"random",v=a.useMemo(()=>fs(U),[U]),h=a.useMemo(()=>Oa(v,Gs(v,le)),[v,le]),ie=le.get("check")??"exact",_=le.get("reviewer"),m=a.useMemo(()=>t.cogita.library.revision[v.labelKey]??U,[t,U,v]),z=a.useMemo(()=>ie==="exact"?t.cogita.library.revision.checkValue:ie,[t,ie]),[L,G]=a.useState(t.cogita.library.collections.defaultName),[T,R]=a.useState([]),[ee,te]=a.useState([]),[ae,Pe]=a.useState("idle"),[de,S]=a.useState({current:0,total:0}),[ge,x]=a.useState(0),[V,ue]=a.useState(""),[B,Q]=a.useState(null),[Ne,Se]=a.useState(null),[we,$e]=a.useState(null),[ye,Ke]=a.useState(null),[_e,je]=a.useState([]),[Be,tt]=a.useState({}),[Ye,q]=a.useState({}),[W,De]=a.useState(null),[xe,re]=a.useState(null),[Le,qe]=a.useState(null),[K,ce]=a.useState(null),[I,X]=a.useState(null),[ve,$]=a.useState({}),O=a.useRef(0),[fe,be]=a.useState(null),pe=a.useRef(null),Ee=a.useRef(null),[We,Oe]=a.useState(null),[Ie,Ae]=a.useState(!1),[Te,ot]=a.useState(null),[Ue,at]=a.useState([]),[vt,ft]=a.useState(null),ze=a.useRef(null),st=a.useRef(null),[It,lt]=a.useState(null),[Lt,nt]=a.useState(0),mt=a.useRef(null),Ft=a.useRef({}),[pt,et]=a.useState(!1),[C,Me]=a.useState({}),[Fe,Ge]=a.useState([]),Xe=a.useRef(new Map),[Ze,dt]=a.useState(new Set),[it,Re]=a.useState(!1),Je=a.useRef(null),Ct=a.useRef(new Set),$t=a.useRef({}),me=T[ge]??null,he=(me==null?void 0:me.checkType)==="translation-match"&&I,Vt=a.useRef(new Map),kt=a.useRef(new Map),qt=a.useRef(new Map),Ot=a.useRef(new Map),ut=a.useMemo(()=>me?me.cardType==="vocab"?t.cogita.library.revision.vocabLabel:me.infoType?Qe(t,me.infoType):t.cogita.library.revision.infoLabel:"",[t,me]),Ut=a.useMemo(()=>{var u;return v.id!=="levels"?T.length:((u=C.pool)==null?void 0:u.length)??v.getFetchLimit(Y,h)},[C,h,v,T.length,Y]),aa=v.getProgressTotal?v.getProgressTotal(T,C,Y,h):v.id==="levels"?Math.min(Y,Ut):T.length,sa=aa?Math.min(ge+1,aa):0,Rt=Math.max(1,Number(h.tries??1)),wt=h.compare??"anchors",zt=Math.max(0,Math.min(100,Number(h.minCorrectness??0))),gt=(h.considerDependencies??"on")==="on",rt=Math.max(0,Math.min(100,Number(h.dependencyThreshold??85))),Mt=i=>{const u=i.slice();for(let w=u.length-1;w>0;w-=1){const f=Math.floor(Math.random()*(w+1));[u[w],u[f]]=[u[f],u[w]]}return u},Wt=i=>i.length?i.reduce((w,f)=>w+f,0)/i.length/255*100:0,Ht=i=>Wt(i)>=zt,na=async()=>{const i=await Kt(),u=new Map,w=new Map,f=new Map;i.forEach(M=>{const F=`${M.itemType}:${M.itemId}`,J=_t(M.itemType,M.itemId,M.checkType,M.direction);if(u.has(F)||u.set(F,[]),u.get(F).push(M),w.has(J)||w.set(J,[]),w.get(J).push(M),M.itemType==="info"&&M.checkType==="quote-fragment"&&M.direction){const Z=`${M.itemId}:${M.direction}`;f.has(Z)||f.set(Z,[]),f.get(Z).push(M)}});const P=new Map,p=new Map,E=new Map;return u.forEach((M,F)=>P.set(F,Bt(M).score)),w.forEach((M,F)=>p.set(F,Bt(M).score)),f.forEach((M,F)=>E.set(F,Bt(M).score)),{itemKnowness:P,cardKnowness:p,fragmentKnowness:E}},Ua=async i=>{const u=[];let w=null;for(;;){const f=await $a({libraryId:d,collectionId:i,limit:200,cursor:w});if(u.push(...f.items),!f.nextCursor)break;w=f.nextCursor}return cs(u)},pa=async(i,u)=>{if(Xe.current.has(i))return Xe.current.get(i)??0;const w=await Ua(i);if(w.length===0)return Xe.current.set(i,0),0;const P=w.reduce((p,E)=>{const M=ne(E);return p+(u.get(M)??0)},0)/w.length;return Xe.current.set(i,P),P},za=(i,u)=>{if(!gt||i.cardType!=="info"||i.infoType!=="quote"||i.checkType!=="quote-fragment")return!0;const w=jt(i.direction);if(!(w!=null&&w.fragmentId))return!0;const f=i.description??"";if(!f.trim())return!0;const p=ma(f).nodes[w.fragmentId];if(!p||!p.leftId&&!p.rightId)return!0;const E=[p.leftId,p.rightId].filter(J=>!!J);if(E.length===0)return!0;const M=E.map(J=>{const Z=_t("info",i.cardId,"quote-fragment",ja(w.mode,J));return u.get(Z)??0});return M.reduce((J,Z)=>J+Z,0)/M.length>=rt},ia=async i=>{const u=C,w=i.concat(u.active??[]).concat(u.pool??[]).filter((M,F,J)=>J.findIndex(Z=>ne(Z)===ne(M))===F);if(!gt){dt(new Set(w.map(ne)));return}const{itemKnowness:f,cardKnowness:P}=await na(),p=Fe.filter(M=>ht(M.childItemType)==="collection"&&M.childItemId===N&&!ht(M.childCheckType)&&!ht(M.childDirection)),E=new Set;for(const M of w){if(M.cardType!=="info"){E.add(ne(M));continue}if(!za(M,P))continue;const F=Fe.filter(oe=>rn(oe,M)).concat(p);if(F.length===0){E.add(ne(M));continue}let J=0;for(const oe of F)if(ht(oe.parentItemType)==="collection")J+=await pa(oe.parentItemId,P);else if(ht(oe.parentCheckType)||ht(oe.parentDirection)){const se=ht(oe.parentCheckType),ke=ht(oe.parentDirection),Ce=_t(oe.parentItemType,oe.parentItemId,se,ke);J+=P.get(Ce)??0}else{const se=`${oe.parentItemType}:${oe.parentItemId}`;J+=f.get(se)??0}J/F.length>=rt&&E.add(ne(M))}dt(E)},Ha=i=>{for(let u=i;u<T.length;u+=1){const w=T[u];if(w&&(!gt||w.cardType!=="info"||Ze.has(ne(w))))return u}return-1},Tt=i=>!gt||i.cardType!=="info"||Ze.has(ne(i)),ra=i=>{if(v.id!=="temporal"&&v.id!=="levels")return null;const u=C,w=(u.active??[]).concat(u.pool??[]),f=new Set;for(const P of w){const p=ne(P);if(!(f.has(p)||i.has(p))&&(f.add(p),Tt(P)))return P}return null},Et=a.useMemo(()=>{if(v.id!=="levels")return null;const i=C,u=i.pool??[],w=i.active??[],f=i.levelMap??{},P=Math.max(1,Number(h.levels??1)),p=Array.from({length:P},()=>0),E=new Set(w.map(Z=>ne(Z)));u.forEach(Z=>{const oe=Math.min(P,Math.max(1,f[ne(Z)]??1));p[oe-1]+=1});const M=u.length||1,F=p.map(Z=>Z/M*100),J=me?f[ne(me)]??1:null;return{counts:p,percentages:F,currentLevel:J,levelsCount:P,activeCount:w.length,poolCount:u.length,activeSet:E}},[C,h,v,me]),bt=a.useMemo(()=>{if(v.id!=="temporal")return null;const i=C,u=i.pool??[],w=i.active??[],f=i.knownessMap??{},P=new Set(i.unknownSet??[]);let p=0;u.forEach(F=>{(f[ne(F)]??0)>1&&(p+=1)});const E=P.size,M=w.map(F=>({id:ne(F),value:P.has(ne(F))?0:Math.max(0,Math.min(1,f[ne(F)]??0))}));return{knownCount:p,unknownCount:E,dots:M}},[C,v]),oa=a.useMemo(()=>{if(!gt)return 0;const i=C;return T.concat(i.active??[]).concat(i.pool??[]).filter((w,f,P)=>P.findIndex(p=>ne(p)===ne(w))===f).filter(w=>w.cardType==="info"&&!Ze.has(ne(w))).length},[gt,C,T,Ze]);a.useEffect(()=>{if(!gt||ae!=="ready")return;const i=C,w=T.concat(i.active??[]).concat(i.pool??[]).filter((p,E,M)=>M.findIndex(F=>ne(F)===ne(p))===E).filter(p=>p.cardType!=="info"||Ze.has(ne(p))).length,f=ze.current;if(ze.current=w,f===null||w<=f)return;const P=w-f;ft(`New card available (+${P})`),st.current&&window.clearTimeout(st.current),st.current=window.setTimeout(()=>ft(null),2200)},[gt,ae,C,T,Ze]),a.useEffect(()=>()=>{st.current&&window.clearTimeout(st.current)},[]);const yt=(i,u)=>{const w=v.applyOutcome({queue:T,meta:C},me,Y,h,{correct:i,correctness:u,createdUtc:new Date().toISOString()});R(w.queue),Me(w.meta);const f=w.queue[ge+1];f&&ba(f,ge+1)};a.useEffect(()=>{qa(d,N).then(i=>G(i.name)).catch(()=>G(t.cogita.library.collections.defaultName))},[d,N]),a.useEffect(()=>{us({libraryId:d,type:"language"}).then(i=>te(i)).catch(()=>te([]))},[d]),a.useEffect(()=>{Vs({libraryId:d}).then(i=>Ge(i.items??[])).catch(()=>Ge([]))},[d]),a.useEffect(()=>{as(d,_)},[d,_]),a.useEffect(()=>{ia(T)},[T,Fe,gt,rt,N]),a.useEffect(()=>{if(!me||!gt){Re(!1);return}if(me.cardType!=="info"||Ze.has(ne(me))){Re(!1);return}const i=Ha(ge+1);if(i>=0){Re(!1),x(i);return}if(v.id==="temporal"||v.id==="levels"){const u=T.slice(0,ge+1),w=T.slice(ge+1).filter(Tt),f=u.concat(w),P=new Set(f.map(ne)),p=ra(P);if(p){const M=ne(p);P.has(M)||(f.push(p),P.add(M),Me(F=>{const J=F,Z=new Set(J.queued??[]);return Z.add(M),{...J,queued:Z}}))}const E=f.findIndex((M,F)=>F!==ge&&Tt(M));if(E>=0){R(f),x(E),Re(!1);return}}Re(!0)},[me,Ze,gt,ge,T,C,v.id]),a.useEffect(()=>{let i=!0;return(async()=>{Pe("loading"),S({current:0,total:v.id==="levels"?0:v.getFetchLimit(Y,h)});try{const w=[];let f=null,P=null;do{const oe=await $a({libraryId:d,collectionId:N,limit:300,cursor:f});if(w.push(...oe.items),(v.id==="levels"||v.id==="temporal")&&oe.total&&(P=oe.total),S(se=>({current:w.length,total:se.total||oe.total||v.getFetchLimit(Y,h)})),f=oe.nextCursor??null,P!==null&&w.length>=P||v.id!=="levels"&&v.id!=="temporal"&&w.length>=v.getFetchLimit(Y,h))break}while(f);if(!i)return;const p=cs(w);let E;if(v.id==="levels"){const oe=Math.max(1,Number(h.levels??1)),ke=(await Kt()).reduce((Ce,Ve)=>{const He=_t(Ve.itemType,Ve.itemId,Ve.checkType,Ve.direction);return Ce[He]||(Ce[He]=[]),Ce[He].push(Ve),Ce},{});E={},p.forEach(Ce=>{const Ve=ne(Ce),He=ke[Ve]??[],ct=He.length>0?Bt(He).score:0,Zt=Math.max(1,Math.min(oe,Math.ceil(ct/100*oe)));E[Ve]=Zt})}let M=null,F=null,J=null;if(v.id==="temporal"){const oe=await Kt(),se=new Set(p.map(Ve=>ne(Ve))),ke=oe.reduce((Ve,He)=>{const ct=_t(He.itemType,He.itemId,He.checkType,He.direction);return se.has(ct)&&(Ve[ct]||(Ve[ct]=[]),Ve[ct].push(He)),Ve},{});M={},F=new Set,J={};const Ce=Date.now();p.forEach(Ve=>{const He=ne(Ve),ct=ke[He]??[];if(ct.length===0){M[He]=0,F.add(He),J[He]=[];return}const Zt=hs(ct);J[He]=Zt;const ln=Da(Zt,Ce);M[He]=ln.knowness})}const Z=v.id==="levels"?ms(p,Y,h,E):v.id==="temporal"?gs(p,Y,h,M??{},F??new Set,J??{}):v.prepare(p,Y,h);R(Z.queue),Me(Z.meta),x(0),Pe("ready"),S(oe=>({current:Math.min(oe.current,oe.total),total:oe.total}))}catch{i&&Pe("error")}})(),()=>{i=!1}},[d,N,Y,h,v,_]),a.useEffect(()=>{if(ue(""),Q(null),lt(null),nt(0),je([]),tt({}),q({}),re(null),qe(null),ce(null),Ae(!1),et(!1),Oe(null),X(null),$({}),!me){Se(null),$e(null),De(null),ot(null);return}me.cardType==="info"&&me.infoType==="computed"&&Se(t.cogita.library.revision.loadingComputed);let i=!0;return ba(me,ge).then(u=>{!i||!u||(Se(u.prompt),$e(u.expectedAnswer),je(u.computedExpected),tt(u.computedAnswers),De(u.computedValues),re(u.answerTemplate),qe(u.outputVariables),ce(u.variableValues))}),()=>{i=!1}},[me,t]),a.useEffect(()=>{if(!me||me.cardType!=="info"||me.infoType!=="quote"){Je.current=null,Ct.current=new Set,Ke(null);return}const i=me.description??"",u=(me.label??"").trim(),w=u.replace(/\s+/g," ").trim(),f=i.replace(/\s+/g," ").trim(),P=w&&w!==f?u:t.cogita.library.infoTypes.quote;if(!i){Ke(null),$e(null);return}const p=ma(i);Je.current=p,Se(P);let E=!0;return na().then(({fragmentKnowness:M})=>{if(!E)return;const F=getQuoteMode(me.direction),J=new Set,Z={};M.forEach((ke,Ce)=>{const[Ve,He]=Ce.split(":",2);if(Ve!==me.cardId)return;const ct=jt(He);if(!ct||ct.mode!==F)return;const Zt=ct.fragmentId;Z[Zt]=ke,ke>=rt&&J.add(Zt)}),Ct.current=J,$t.current=Z;const oe=jt(me.direction);if(oe!=null&&oe.fragmentId&&p.nodes[oe.fragmentId]){Pt(p,oe.fragmentId,P);return}const se=ha(p,J,Z,rt,gt,me.direction);Pt(p,(se==null?void 0:se.id)??null,P)}).catch(()=>{Ct.current=new Set,$t.current={};const M=jt(me.direction);if(M!=null&&M.fragmentId&&p.nodes[M.fragmentId]){Pt(p,M.fragmentId,P);return}const F=ha(p,Ct.current,{},rt,gt,me.direction);Pt(p,(F==null?void 0:F.id)??null,P)}),()=>{E=!1}},[me,t,gt,rt]),a.useEffect(()=>{if(!me||me.cardType!=="vocab"||me.checkType!=="translation-match"){X(null),$({});return}const w=(C.pool??C.active??T).filter(M=>M.cardType==="vocab"&&M.checkType==="translation-match").filter((M,F,J)=>J.findIndex(Z=>Z.cardId===M.cardId)===F);w.some(M=>M.cardId===me.cardId)||w.unshift(me);const P=Mt(w).slice(0,6).map(M=>{const F=M.label.split("↔").map(oe=>oe.trim()).filter(Boolean);if(F.length<2)return null;const J=`${M.cardId}:L`,Z=`${M.cardId}:R`;return{cardId:M.cardId,leftId:J,rightId:Z,leftLabel:F[0],rightLabel:F[1]}}).filter(Boolean),p=P.map(M=>M.leftId),E=Mt(P.map(M=>M.rightId));X({pairs:P,leftOrder:p,rightOrder:E,selection:{},activeLeft:null,activeRight:null,locked:{}})},[me,T,C]),a.useEffect(()=>()=>{pe.current&&window.clearTimeout(pe.current),Ee.current&&window.clearTimeout(Ee.current)},[]);const Yt=a.useRef(null);a.useEffect(()=>{if(!me)return;const i=ne(me),u=typeof document<"u"?document.activeElement:null;if(Yt.current===i&&u&&(u.tagName==="INPUT"||u.tagName==="TEXTAREA"))return;let w=0;const f=()=>{if(me){if(me.cardType==="info"&&me.infoType==="computed"){if(_e.length>0){const p=Ka(xe,_e,Le),E=p?Ft.current[p]:null;if(E&&(E.focus(),document.activeElement===E)){Yt.current=i;return}}if(mt.current&&(mt.current.focus(),document.activeElement===mt.current)){Yt.current=i;return}}else if(me.cardType==="vocab"&&mt.current&&(mt.current.focus(),document.activeElement===mt.current)){Yt.current=i;return}w<6&&(w+=1,window.setTimeout(f,40))}},P=window.setTimeout(f,40);return()=>window.clearTimeout(P)},[me,_e,xe,Le]),a.useEffect(()=>{if(!pt)return;const i=u=>{u.key==="Enter"&&(u.preventDefault(),ca())};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[pt]);const Xt=i=>{at(i),ot(Bt(i))};a.useEffect(()=>{if(!me){ot(null),at([]);return}const i=me.cardType==="info"?"info":"connection";if(me.cardType==="info"&&me.infoType==="quote"){Kt().then(u=>{const w=u.filter(f=>f.itemType==="info"&&f.itemId===me.cardId&&f.checkType==="quote-fragment"&&_a(f.direction,me.direction));Xt(w)}).catch(()=>{ot(null),at([])});return}Fa(i,me.cardId,me.checkType,me.direction).then(u=>Xt(u)).catch(()=>{ot(null),at([])})},[d,me,_]);const ka=(i,u,w,f)=>{if(i==="info"&&w==="quote-fragment"){Kt().then(P=>{const p=P.filter(E=>E.itemType==="info"&&E.itemId===u&&E.checkType==="quote-fragment"&&_a(E.direction,f));Xt(p)}).catch(()=>{ot(null),at([])});return}Fa(i,u,w,f).then(P=>Xt(P)).catch(()=>{ot(null),at([])})},Ta=(i,u,w)=>{var E;const f=((E=w.pairs.find(M=>M.leftId===i))==null?void 0:E.rightId)??null;if(!f)return w;const P=f===u;$(M=>({...M,[i]:P?"correct":"incorrect"})),pe.current&&window.clearTimeout(pe.current),Ee.current&&window.clearTimeout(Ee.current),O.current+=1;const p={kind:P?"correct":"incorrect",tick:O.current};if(be(null),pe.current=window.setTimeout(()=>be(p),0),Ee.current=window.setTimeout(()=>be(null),420),P){const M={...w.locked,[i]:!0};return Object.keys(M).length>=w.pairs.length?(Q("correct"),et(!0)):Q("correct"),{...w,selection:{...w.selection,[i]:u},activeLeft:null,activeRight:null,locked:M}}return Q("incorrect"),{...w,activeLeft:null,activeRight:null}},la=i=>{X(u=>!u||u.locked[i]?u:u.activeRight?Ta(i,u.activeRight,u):{...u,activeLeft:u.activeLeft===i?null:i})},At=i=>{X(u=>u&&(u.activeLeft?Ta(u.activeLeft,i,u):{...u,activeRight:u.activeRight===i?null:i}))},ca=()=>{var i;if(me&&me.cardType==="info"&&me.infoType==="quote"&&Je.current&&ye&&!((i=jt(me.direction))!=null&&i.fragmentId)){const u=ha(Je.current,Ct.current,$t.current,rt,gt,me.direction,ye.fragmentId);if(u){Q(null),ue(""),Ae(!1),q({}),et(!1),lt(null),nt(0),Pt(Je.current,u.id,ye.title);return}}Q(null),ue(""),Ae(!1),q({}),et(!1),lt(null),nt(0),x(u=>Math.min(u+1,T.length))},St=i=>{if(!me)return;const u=i.expected??null,w=i.answer??"";let f=u??"",P=w;if(!u&&i.expectedMap&&i.answerMap){const oe=Object.keys(i.expectedMap).sort((se,ke)=>se.localeCompare(ke));f=oe.map(se=>{var ke;return((ke=i.expectedMap)==null?void 0:ke[se])??""}).join("|"),P=oe.map(se=>{var ke;return((ke=i.answerMap)==null?void 0:ke[se])??""}).join("|")}const p=f?ga(f,P,wt):new Uint8Array,E={revisionType:v.id,evalType:i.evalType,direction:i.direction,prompt:Ne??"",expected:u,answer:w,expectedAnswers:i.expectedMap??null,answers:i.answerMap??null,correct:i.correct,maskBase64:p.length?Qt(p):null,values:W??null,checkMode:ie,compareMode:wt,minCorrectness:zt},M=new TextEncoder().encode(JSON.stringify(E)),F=me.cardType==="info"?"info":"connection",J=i.overrideCheckType??me.checkType??null,Z=i.overrideDirection??me.direction??null;Aa({itemType:F,itemId:me.cardId,checkType:J,direction:Z,revisionType:v.id,evalType:i.evalType,correct:i.correct,maskBase64:p.length?Qt(p):null,payloadBase64:Qt(M),personRoleId:_??null}).then(()=>{ka(F,me.cardId,J,Z),ia(T),as(d,_)}).catch(()=>{})},Gt=(i,u)=>{const w=Vt.current.get(u);if(w)return Promise.resolve(w);const f=kt.current.get(u);if(f)return f;const P=ua({libraryId:d,infoId:i}).then(p=>{var oe,se;const E=p.payload,M=((oe=E.definition)==null?void 0:oe.graph)??null,F="",J=((se=E.definition)==null?void 0:se.answerTemplate)??"",Z=Js(M,F,J);if(Z){const Ce={sample:Zs(Z),answerTemplate:J||null};return Vt.current.set(u,Ce),Ce}return ys({libraryId:d,infoId:i}).then(ke=>{const Ce={sample:ke,answerTemplate:null};return Vt.current.set(u,Ce),Ce})}).catch(()=>ys({libraryId:d,infoId:i}).then(p=>{const E={sample:p,answerTemplate:null};return Vt.current.set(u,E),E}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{kt.current.delete(u)});return kt.current.set(u,P),P},ba=(i,u)=>{var M;const w=`${ne(i)}:${u}`,f=qt.current.get(w);if(f)return Promise.resolve(f);const P=Ot.current.get(w);if(P)return P;const p=F=>(qt.current.set(w,F),F);let E;if(i.cardType==="vocab"){if(i.checkType==="translation-match")return E=Promise.resolve(p({prompt:i.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),E;const F=i.label.split("↔").map(J=>J.trim()).filter(Boolean);if(F.length>=2){const Z=(i.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",oe=Z?F[0]:F[1],se=Z?F[1]:F[0];E=Promise.resolve(p({prompt:oe,expectedAnswer:se,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else E=Promise.resolve(p({prompt:i.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(i.cardType==="info"&&i.infoType==="word"){const F=(M=i.description)!=null&&M.startsWith("Language: ")?i.description.replace("Language: ",""):null;E=Promise.resolve(p({prompt:i.label,expectedAnswer:F,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else i.cardType==="info"&&i.infoType==="computed"?E=Gt(i.cardId,w).then(F=>{var ke,Ce;if(!F.sample)return p({prompt:i.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const J=F.sample,Z=J.expectedAnswers?Object.entries(J.expectedAnswers).map(([Ve,He])=>({key:Ve,expected:He})):[],oe=Z.reduce((Ve,He)=>(Ve[He.key]="",Ve),{}),se=J.expectedAnswerIsSentence&&((ke=J.expectedAnswer)==null?void 0:ke.trim())||null;return p({prompt:J.prompt,expectedAnswer:Z.length>0?se:((Ce=J.expectedAnswer)==null?void 0:Ce.trim())||null,computedExpected:Z,computedAnswers:oe,computedValues:J.values??null,answerTemplate:F.answerTemplate,outputVariables:J.outputVariables??null,variableValues:J.variableValues??null})}).catch(()=>p({prompt:i.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Ot.current.delete(w)}):E=Promise.resolve(p({prompt:i.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return Ot.current.set(w,E),E},Pt=(i,u,w)=>{const f=Object.keys(i.nodes).length,P=Ct.current.size;if(!u){Ke({title:w,before:i.text,after:"",fragmentId:null,total:f,completed:P}),$e(null),et(!0);return}const p=i.nodes[u];if(!p)return;const E=Ws(i.text,p);Ke({title:w,before:E.before,after:E.after,fragmentId:p.id,total:f,completed:P}),$e(E.fragment),et(!1)},Sa=()=>{const i=Je.current;i&&Ke(u=>u&&{...u,total:Object.keys(i.nodes).length,completed:Ct.current.size})},da=()=>{const i=T[ge+1];i&&ba(i,ge+1)},Ca=()=>{if(da(),me&&me.cardType==="vocab"&&me.checkType==="translation-match"&&I){if(I.pairs.length===0){Q("incorrect"),et(!0);return}const p=I.pairs.reduce((se,ke)=>(se[ke.rightId]=ke.rightLabel,se),{});let E=0;const M={};I.pairs.forEach(se=>{const Ce=I.selection[se.leftId]===se.rightId;M[se.leftId]=Ce?"correct":"incorrect",Ce&&(E+=1)});const F=I.pairs.length||1,J=E/F,Z=E===I.pairs.length;$(se=>({...se,...M})),Z?(Q("correct"),et(!0),nt(0)):(Q("incorrect"),et(!1),nt(se=>{const ke=se+1;return ke>=Rt&&(Ae(!0),et(!0),X(Ce=>{if(!Ce)return Ce;const Ve=Ce.pairs.reduce((He,ct)=>(He[ct.leftId]=ct.rightId,He),{});return{...Ce,selection:Ve}})),ke})),yt(Z,J);const oe="connection";Promise.all(I.pairs.map(se=>{const ke=I.selection[se.leftId]??null,Ce=ke?p[ke]:"",Ve={left:se.leftLabel,expected:se.rightLabel,answer:Ce,checkType:"translation-match"},He=new TextEncoder().encode(JSON.stringify(Ve));return Aa({itemType:oe,itemId:se.cardId,checkType:"translation-match",direction:null,revisionType:v.id,evalType:"translation-match",correct:ke===se.rightId,maskBase64:null,payloadBase64:Qt(He),personRoleId:_??null})})).then(()=>{ka(oe,me.cardId,me.checkType,me.direction),as(d,_)}).catch(()=>{});return}if(_e.length>0){const p=_e.reduce((M,F)=>{const J=Be[F.key]??"";return M[F.key]=xt(J)===xt(F.expected)?"correct":"incorrect",M},{});_e.every(({key:M,expected:F})=>{const J=Be[M]??"";return ie==="exact"&&xt(J)===xt(F)})?(Q("correct"),q(p),et(!0),nt(0),yt(!0,1),St({correct:!0,direction:Ne?`${Ne} -> computed`:"computed",expectedMap:_e.reduce((M,F)=>(M[F.key]=F.expected,M),{}),answerMap:Be,evalType:"computed"})):(Q("incorrect"),q(p),et(!1),nt(M=>{const F=M+1;return F>=Rt&&D&&(Ae(!0),et(!0)),F}),yt(!1,0),window.setTimeout(()=>{var F;const M=Ka(xe,_e,Le);M&&Ft.current[M]&&((F=Ft.current[M])==null||F.focus())},40),St({correct:!1,direction:Ne?`${Ne} -> computed`:"computed",expectedMap:_e.reduce((M,F)=>(M[F.key]=F.expected,M),{}),answerMap:Be,evalType:"computed"}));return}if(me&&me.cardType==="info"&&me.infoType==="quote"&&(ye!=null&&ye.fragmentId)){if(!we)return;const p=jt(me.direction),E=(p==null?void 0:p.mode)??getQuoteMode(me.direction),M=p!=null&&p.fragmentId&&me.direction?me.direction:ja(E,ye.fragmentId),F=nn(we,V,wt),J=ie==="exact"&&fa(V)===fa(we),Z=Ht(F),oe=J||Z,se=Wt(F);oe?($t.current[ye.fragmentId]=Math.max($t.current[ye.fragmentId]??0,se),($t.current[ye.fragmentId]??0)>=rt&&Ct.current.add(ye.fragmentId),Sa(),Q("correct"),q({}),et(!0),lt(F),nt(0),se<100&&Rt<=1&&Ae(!0),yt(!0,se/100),St({correct:!0,direction:`quote:${ye.fragmentId}`,expected:we,answer:V,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:M})):(Q("incorrect"),q({}),et(!1),lt(F),nt(ke=>{const Ce=ke+1;return Ce>=Rt&&D&&(Ae(!0),et(!0)),Ce}),yt(!1,se/100),window.setTimeout(()=>{var ke;return(ke=mt.current)==null?void 0:ke.focus()},40),St({correct:!1,direction:`quote:${ye.fragmentId}`,expected:we,answer:V,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:M}));return}if(!we)return;const i=ga(we,V,wt),u=ie==="exact"&&xt(V)===xt(we),w=Ht(i),f=u||w,P=Wt(i);f?(Q("correct"),q({}),et(!0),lt(i),nt(0),P<100&&Rt<=1&&Ae(!0),yt(!0,P/100),St({correct:!0,direction:Ne?`${Ne} -> ${we}`:null,expected:we,answer:V,evalType:"text"})):(Q("incorrect"),q({}),et(!1),lt(i),nt(p=>{const E=p+1;return E>=Rt&&D&&(Ae(!0),et(!0)),E}),yt(!1,P/100),window.setTimeout(()=>{var p;return(p=mt.current)==null?void 0:p.focus()},40),St({correct:!1,direction:Ne?`${Ne} -> ${we}`:null,expected:we,answer:V,evalType:"text"}))},Qa=i=>{if(da(),!we)return;const u=ga(we,i,wt),w=xt(i)===xt(we),f=Ht(u),P=w||f,p=Wt(u);P?(Q("correct"),q({}),et(!0),lt(u),nt(0),p<100&&Rt<=1&&Ae(!0),yt(!0,p/100),St({correct:!0,direction:"word->language",expected:we,answer:i,evalType:"language-select"})):(Q("incorrect"),q({}),et(!1),lt(u),nt(E=>{const M=E+1;return M>=Rt&&D&&(Ae(!0),et(!0)),M}),yt(!1,p/100),St({correct:!1,direction:"word->language",expected:we,answer:i,evalType:"language-select"}))},Wa=()=>{da(),Q("correct"),et(!0),nt(0),yt(!0,1),we&&St({correct:!0,direction:"manual",expected:we,answer:V,evalType:"manual"})},Ya=()=>{if(yt(!1,0),me&&me.cardType==="info"&&me.infoType==="quote"){Q(null),ue(""),Ae(!1),q({}),et(!1),lt(null),nt(0),x(i=>Math.min(i+1,T.length));return}ca()};a.useEffect(()=>{da()},[ge,T]);const Jt=i=>{var w;if(i.key!=="Enter")return;if(i.preventDefault(),i.stopPropagation(),pt){ca();return}const u=_e.find(f=>!(Be[f.key]??"").trim());if(u){(w=Ft.current[u.key])==null||w.focus();return}Ca()},k=t.cogita.library.revision.revealModeAfterIncorrect,D=_e.length>0||!!we;return e.jsxs(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,children:[ae==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${de.total?Math.min(100,Math.max(0,de.current/de.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:de.total?`${Math.min(de.current,de.total)} / ${de.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:L}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",m).replace("{check}",z)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:H,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${H}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${H}/collections/${N}`,children:t.cogita.library.actions.collectionDetail})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Te?`${Te.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Et?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Et.currentLevel??"-"," / ",Et.levelsCount]}):null,Te?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(Te.correct)).replace("{total}",String(Te.total))}),Te.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(Te.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(tn,{outcomes:Ue})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[vt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:vt})}):null,e.jsx("section",{className:"cogita-revision-card","data-feedback":fe?`${fe.kind}-${fe.tick}`:he?"idle":B??"idle",children:me?e.jsx(e.Fragment,{children:it?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(en,{copy:t,currentCard:me,currentTypeLabel:ut,prompt:Ne,languages:ee,answer:V,onAnswerChange:i=>ue(u=>Ba(u,i,We)),computedExpected:_e,computedAnswers:Be,onComputedAnswerChange:(i,u)=>tt(w=>({...w,[i]:Ba(w[i]??"",u,We)})),answerTemplate:xe,outputVariables:Le,variableValues:K,computedFieldFeedback:Ye,feedback:B,canAdvance:pt,quoteContext:ye,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Ca,onSkip:Ya,onLanguageSelect:Qa,onMarkReviewed:Wa,onAdvance:ca,showCorrectAnswer:Ie,setShowCorrectAnswer:Ae,onRevealCorrect:()=>et(!0),answerMask:It,expectedAnswer:we,hasExpectedAnswer:D,handleComputedKeyDown:Jt,answerInputRef:mt,computedInputRefs:Ft,scriptMode:We,setScriptMode:Oe,matchPairs:I==null?void 0:I.pairs,matchLeftOrder:I==null?void 0:I.leftOrder,matchRightOrder:I==null?void 0:I.rightOrder,matchSelection:I==null?void 0:I.selection,matchActiveLeft:I==null?void 0:I.activeLeft,matchActiveRight:I==null?void 0:I.activeRight,matchFeedback:ve,onMatchLeftSelect:la,onMatchRightSelect:At})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${H}/collections/${N}`,children:t.cogita.library.actions.collectionDetail})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:aa?`${sa} / ${aa}`:t.cogita.library.revision.progressUnlimited}),ae==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),ae==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),ae==="ready"&&T.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:k}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",Rt]})]})]}),Et?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Et.activeCount," / ",Et.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Et.counts.map((i,u)=>{const w=u+1,f=Et.currentLevel===w,P=Et.percentages[u]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":f,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:w}),e.jsx("strong",{children:i})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,P))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[P.toFixed(1),"%"]})]},`level-${w}`)})})]}):null,bt?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:bt.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:bt.dots.map(i=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,i.value*100))}%`,background:`rgba(${Math.round(255*(1-i.value))}, ${Math.round(200*i.value)}, 80, 0.9)`}},i.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:bt.knownCount})]})]}):null,gt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:oa})]})}):null]})]})]})})})]})]})}const ss=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],$i={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},Ri=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Ei=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function Ai({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,libraryId:d,collectionId:N}){const[c,o]=a.useState(""),[H,le,Y]=Rs([]),[U,v,h]=Es([]),[ie,_]=a.useState(null),[m,z]=a.useState(null),[L,G]=a.useState(null),T=`/#/cogita/library/${d}`;a.useEffect(()=>{qa(d,N).then(S=>o(S.name)).catch(()=>o(t.cogita.library.collections.defaultName))},[d,N,t]),a.useEffect(()=>{Tn({libraryId:d,collectionId:N}).then(S=>{if(!S.graphId||S.graphId==="00000000-0000-0000-0000-000000000000"){le([]),v([]);return}const ge=S.nodes.map(V=>{var Ne;const ue=V.payload??{},B=ue.position??{x:120,y:120},Q=ue.params??{};return{id:V.nodeId,type:"default",position:B,data:{nodeType:V.nodeType,label:((Ne=ss.find(Se=>Se.type===V.nodeType))==null?void 0:Ne.label)??V.nodeType,params:Q}}}),x=S.edges.map(V=>({id:V.edgeId,source:V.fromNodeId,target:V.toNodeId,sourceHandle:V.fromPort??void 0,targetHandle:V.toPort??void 0}));le(ge),v(x)}).catch(()=>{le([]),v([])})},[d,N,v,le]);const R=a.useMemo(()=>H.find(S=>S.id===ie)??null,[H,ie]),ee=S=>{var ue;const ge=crypto.randomUUID(),x=((ue=ss.find(B=>B.type===S))==null?void 0:ue.label)??S,V={...$i[S]};le(B=>[...B,{id:ge,type:"default",position:{x:120+B.length*40,y:120+B.length*40},data:{nodeType:S,label:x,params:V}}]),_(ge)},te=a.useCallback(S=>{v(ge=>As({...S,id:crypto.randomUUID()},ge))},[v]),ae=async()=>{z(null);try{await Cn({libraryId:d,collectionId:N,nodes:H.map(S=>({nodeId:S.id,nodeType:S.data.nodeType,payload:{position:S.position,params:S.data.params}})),edges:U.map(S=>({edgeId:S.id,fromNodeId:S.source,fromPort:S.sourceHandle??null,toNodeId:S.target,toPort:S.targetHandle??null}))}),z(t.cogita.library.graph.saveSuccess)}catch{z(t.cogita.library.graph.saveFail)}},Pe=async()=>{try{const S=await Sn({libraryId:d,collectionId:N});G(S)}catch{G(null)}},de=S=>{R&&le(ge=>ge.map(x=>x.id===R.id?{...x,data:{...x.data,params:S}}:x))};return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${T}/collections/${N}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Pe,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:ae,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:ss.map(S=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>ee(S.type),children:S.label},S.type))}),m?e.jsx("p",{className:"cogita-help",children:m}):null,L&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(L.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(L.connections)).replace("{infos}",String(L.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(Fs,{nodes:H,edges:U,onNodesChange:Y,onEdgesChange:h,onConnect:te,onNodeClick:(S,ge)=>_(ge.id),fitView:!0,children:[e.jsx(Ps,{color:"rgba(120,160,200,0.2)"}),e.jsx(_s,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),R?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:R.data.label}),R.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(ta,{libraryId:d,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:R.data.params.tagId?{id:R.data.params.tagId,label:R.data.params.tagLabel??"",infoType:"topic"}:null,onChange:S=>de({...R.data.params,tagId:(S==null?void 0:S.id)??null,tagLabel:(S==null?void 0:S.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:R.data.params.scope??"any",onChange:S=>de({...R.data.params,scope:S.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),R.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(ta,{libraryId:d,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:R.data.params.languageId?{id:R.data.params.languageId,label:R.data.params.languageLabel??"",infoType:"language"}:null,onChange:S=>de({...R.data.params,languageId:(S==null?void 0:S.id)??null,languageLabel:(S==null?void 0:S.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:R.data.params.scope??"any",onChange:S=>de({...R.data.params,scope:S.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),R.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:R.data.params.infoType??"word",onChange:S=>de({...R.data.params,infoType:S.target.value}),children:Ei.map(S=>e.jsx("option",{value:S.value,children:S.label},S.value))})]}),e.jsx(ta,{libraryId:d,infoType:R.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:R.data.params.infoId?{id:R.data.params.infoId,label:R.data.params.infoLabel??"",infoType:R.data.params.infoType??"word"}:null,onChange:S=>de({...R.data.params,infoId:(S==null?void 0:S.id)??null,infoLabel:(S==null?void 0:S.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),R.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:R.data.params.connectionType??"translation",onChange:S=>de({...R.data.params,connectionType:S.target.value}),children:Ri.map(S=>e.jsx("option",{value:S.value,children:S.label},S.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:R.data.params.connectionId??"",onChange:S=>de({...R.data.params,connectionId:S.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(R.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const ns="cogita.preferences",on=["library_overview","all_cards","all_collections","storyboards","texts","dependencies","transfer"],is={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},rs=["settings","run","shared"];function Fi(t,s=""){const n=t.split("/").filter(Boolean);if(n[0]!=="cogita"||n[1]!=="library")return{};const r=n[2];if(!r)return{};if(!n[3])return{libraryId:r,target:"library_overview"};const l=new URLSearchParams(s),g=l.get("revisionId")??void 0,b=l.get("infoId")??void 0,y=l.get("infoView")==="cards"?"cards":"overview",A=l.get("collectionAction"),j=l.get("libraryAction");if(n[3]==="list")return{libraryId:r,target:j==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:g,infoId:b,infoView:y,libraryAction:j==="new-info"?"new-info":void 0};if(n[3]==="detail"||n[3]==="collection")return{libraryId:r,target:"all_cards",cardMode:n[3],revisionId:g,infoId:b,infoView:y};if(n[3]==="new"||n[3]==="add")return{libraryId:r,target:"new_card",revisionId:g,libraryAction:"new-info"};if(n[3]==="edit")return{libraryId:r,target:"new_card",revisionId:g,infoId:n[4]};if(n[3]==="shared-revisions")return{libraryId:r,target:"all_collections",revisionId:g};if(n[3]==="dependencies")return{libraryId:r,target:"dependencies"};if(n[3]==="transfer")return{libraryId:r,target:"transfer"};if(n[3]==="storyboards")return n[4]==="new"?{libraryId:r,target:"new_storyboard"}:{libraryId:r,target:"storyboards"};if(n[3]==="texts")return n[4]==="new"?{libraryId:r,target:"new_text"}:{libraryId:r,target:"texts"};if(n[3]!=="collections")return{libraryId:r,target:"library_overview"};if(n[4]==="new")return{libraryId:r,target:"new_collection",revisionId:g};const d=n[4];return d?n[5]==="graph"?{libraryId:r,target:"all_collections",collectionId:d,revisionId:g,revisionView:"graph"}:n[5]==="shared-revisions"?{libraryId:r,target:"all_collections",collectionId:d,revisionId:g,revisionView:"shared"}:n[5]==="revision"?{libraryId:r,target:"all_collections",collectionId:d,revisionId:g,revisionView:n[6]==="run"?"run":"settings"}:A==="new-revision"?{libraryId:r,target:"all_collections",collectionId:d,revisionId:g,revisionView:"new"}:{libraryId:r,target:"all_collections",collectionId:d,revisionId:g,revisionView:"detail"}:A==="new-collection"?{libraryId:r,target:"new_collection",collectionAction:"new-collection"}:{libraryId:r,target:"all_collections"}}function os(t,s="library_overview",n,r,l,g,b="overview"){const y=(A,j)=>{const d=new URLSearchParams;j!=null&&j.revisionId&&d.set("revisionId",j.revisionId),j!=null&&j.collectionAction&&d.set("collectionAction",j.collectionAction),j!=null&&j.libraryAction&&d.set("libraryAction",j.libraryAction),j!=null&&j.infoId&&d.set("infoId",j.infoId),j!=null&&j.infoView&&(j!=null&&j.infoId)&&d.set("infoView",j.infoView);const N=d.toString();return N?`${A}?${N}`:A};return t?s==="library_overview"?y(`/cogita/library/${t}`,{revisionId:l}):s==="all_cards"?y(`/cogita/library/${t}/list`,{revisionId:l,infoId:g,infoView:b}):s==="new_card"?g?y(`/cogita/library/${t}/edit/${g}`,{revisionId:l}):y(`/cogita/library/${t}/list`,{revisionId:l,libraryAction:"new-info"}):s==="all_collections"?n?r==="graph"?y(`/cogita/library/${t}/collections/${n}/graph`,{revisionId:l}):r==="settings"?y(`/cogita/library/${t}/collections/${n}/revision`,{revisionId:l}):r==="run"?y(`/cogita/library/${t}/collections/${n}/revision/run`,{revisionId:l}):r==="shared"?y(`/cogita/library/${t}/collections/${n}/shared-revisions`,{revisionId:l}):r==="new"?y(`/cogita/library/${t}/collections/${n}`,{revisionId:l,collectionAction:"new-revision"}):y(`/cogita/library/${t}/collections/${n}`,{revisionId:l}):y(`/cogita/library/${t}/collections`,{revisionId:l}):s==="new_collection"?y(`/cogita/library/${t}/collections`,{revisionId:l,collectionAction:"new-collection"}):s==="transfer"?y(`/cogita/library/${t}/transfer`,{revisionId:l}):s==="storyboards"?y(`/cogita/library/${t}/storyboards`,{revisionId:l}):s==="new_storyboard"?y(`/cogita/library/${t}/storyboards/new`,{revisionId:l}):s==="texts"?y(`/cogita/library/${t}/texts`,{revisionId:l}):s==="new_text"?y(`/cogita/library/${t}/texts/new`,{revisionId:l}):s==="dependencies"?y(`/cogita/library/${t}/dependencies`,{revisionId:l}):y(`/cogita/library/${t}`,{revisionId:l}):"/cogita"}function Ia(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function Pi(t){return typeof t=="string"&&on.includes(t)}function _i(t,s){var y;if(!t.length)return null;const n=t.filter(A=>s.has(A.roleId)),r=n.length>0?n:t,l=r.map(A=>{var d,N;const j=((N=(d=A.fields.find(c=>c.fieldType==="role_kind"))==null?void 0:d.plainValue)==null?void 0:N.toLowerCase())??"";return{roleId:A.roleId,roleKind:j}}),g=l.find(A=>A.roleKind.includes("master"));if(g)return g.roleId;const b=l.find(A=>A.roleKind.includes("account")||A.roleKind.includes("user"));return b?b.roleId:((y=r[0])==null?void 0:y.roleId)??null}function Bi(t){if(!t)return{version:1,byLibrary:{}};try{const s=JSON.parse(t);return!s||typeof s!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:s.lastLibraryId,byLibrary:s.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function Ki({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j}){const d=$s(),N=ds(),c=a.useMemo(()=>Fi(N.pathname,N.search),[N.pathname,N.search]),o=t.cogita.workspace,[H,le]=a.useState([]),[Y,U]=a.useState([]),[v,h]=a.useState([]),[ie,_]=a.useState([]),[m,z]=a.useState(void 0),[L,G]=a.useState("library_overview"),[T,R]=a.useState(void 0),[ee,te]=a.useState(void 0),[ae,Pe]=a.useState("detail"),[de,S]=a.useState(void 0),[ge,x]=a.useState(!1),[V,ue]=a.useState(!0),[B,Q]=a.useState(!1),[Ne,Se]=a.useState(!1),[we,$e]=a.useState(null),[ye,Ke]=a.useState(""),[_e,je]=a.useState(""),[Be,tt]=a.useState(""),[Ye,q]=a.useState(null),[W,De]=a.useState(null),xe=a.useRef({version:1,byLibrary:{}}),re=a.useRef(!1),Le=a.useRef(!1),qe=a.useRef(null),K=a.useMemo(()=>H.find(C=>C.libraryId===m)??null,[H,m]),ce=a.useMemo(()=>Y.find(C=>C.collectionId===T)??null,[Y,T]),I=a.useMemo(()=>ie.find(C=>C.revisionId===ee)??null,[ie,ee]),X=a.useMemo(()=>({detail:o.revisions.detail,graph:o.revisions.graph,settings:o.revisions.settings,run:o.revisions.run,shared:o.targets.sharedRevisions,new:o.revisionForm.createAction}),[o.revisions.detail,o.revisions.graph,o.revisions.run,o.revisions.settings,o.targets.sharedRevisions,o.revisionForm.createAction]),ve=a.useMemo(()=>[{value:"detail",label:X.detail},{value:"graph",label:X.graph},{value:"settings",label:o.targets.allRevisions},{value:"run",label:X.run},{value:"shared",label:X.shared}],[X.detail,X.graph,X.run,X.shared,o.targets.allRevisions]),$=a.useMemo(()=>L==="new_card"?"all_cards":L==="new_collection"?"all_collections":L==="new_storyboard"?"storyboards":L==="new_text"?"texts":L,[L]),O=a.useMemo(()=>ae==="new"?"settings":ae,[ae]),fe=a.useMemo(()=>c.infoId?"selected":L==="new_card"?"create":"search",[c.infoId,L]),be=a.useMemo(()=>v.find(C=>C.infoId===c.infoId)??null,[v,c.infoId]),pe=a.useMemo(()=>({library_overview:o.targets.libraryOverview,all_cards:o.targets.allCards,new_card:o.targets.newCard,all_collections:o.targets.allCollections,new_collection:o.targets.newCollection,transfer:o.targets.transfer,storyboards:o.targets.storyboards,new_storyboard:o.targets.newStoryboard,texts:o.targets.texts,new_text:o.targets.newText,dependencies:o.targets.dependencies}),[o.targets]),Ee=a.useMemo(()=>pe[$]??$,[$,pe]),We=X[O],Oe=!!m,Ie=!!T,Ae=Oe&&L==="all_collections",Te=Ie&&L==="all_collections",ot=Ie&&L==="all_collections"&&rs.includes(ae),Ue=a.useCallback(C=>{const Me=!!C.libraryId;let Fe=C.target,Ge=C.collectionId,Xe=C.revisionId,Ze=C.revisionView,dt=C.infoId,it=C.infoView??c.infoView??"overview";Me?is[Fe].requiresCollection&&!Ge?(Fe="all_collections",Xe=void 0,Ze="detail"):Fe!=="all_collections"?(Ge=void 0,Xe=void 0,Fe!=="new_card"&&Fe!=="all_cards"&&(dt=void 0,it="overview")):is[Fe].allowsRevision?rs.includes(Ze)||(Xe=void 0):Ze="detail":(Fe="library_overview",Ge=void 0,Xe=void 0,Ze="detail",dt=void 0,it="overview"),z(C.libraryId),G(Fe),R(Ge),te(Xe),Pe(Ze),x(!1);const Re=Ia(os(C.libraryId,Fe,Ge,Ze,Xe,dt,it));Ia(`${N.pathname}${N.search}`)!==Re&&(qe.current=Re,d(Re))},[N.pathname,N.search,d,c.infoView]),at=C=>{Ue({libraryId:m,target:"all_collections",collectionId:T,revisionId:rs.includes(C)?ee:void 0,revisionView:C})},vt=a.useMemo(()=>[{key:"library",label:o.layers.library,visible:!0,value:m??"",selectedLabel:(K==null?void 0:K.name)??o.path.noLibrarySelected,disabled:V||H.length===0,options:H.map(C=>({value:C.libraryId,label:C.name})),emptyOption:o.noLibraryOption,onSelect:C=>{const Me=C||void 0;Ue({libraryId:Me,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:o.layers.target,visible:Oe,value:$,selectedLabel:Ee,disabled:!Oe,options:on.map(C=>({value:C,label:pe[C]})),onSelect:C=>{const Me=C;Ue({libraryId:m,target:Me,collectionId:T,revisionId:ee,revisionView:ae,infoId:Me==="new_card"?c.infoId:void 0})}},{key:"info_mode",label:o.layers.target,visible:$==="all_cards",value:fe,selectedLabel:fe==="create"?o.infoMode.create:fe==="selected"?(be==null?void 0:be.label)??de??t.cogita.library.list.selectedEmpty:o.infoMode.search,disabled:!Oe,options:[{value:"search",label:o.infoMode.search},{value:"create",label:o.infoMode.create},...c.infoId?[{value:"selected",label:(be==null?void 0:be.label)??de??t.cogita.library.list.selectedEmpty}]:[]],onSelect:C=>{if(C!=="selected"){if(C==="create"){Ue({libraryId:m,target:"new_card",collectionId:T,revisionId:ee,revisionView:ae,infoId:void 0});return}Ue({libraryId:m,target:"all_cards",collectionId:T,revisionId:ee,revisionView:ae,infoId:void 0,infoView:"overview"})}}},{key:"info_selected_action",label:o.layers.target,visible:$==="all_cards"&&!!c.infoId,value:L==="new_card"&&c.infoId?"edit":c.infoView==="cards"?"cards":"overview",selectedLabel:L==="new_card"&&c.infoId?o.infoActions.edit:c.infoView==="cards"?o.infoActions.seeCards:o.infoActions.overview,disabled:!Oe||!c.infoId,options:[{value:"overview",label:o.infoActions.overview},{value:"edit",label:o.infoActions.edit},{value:"cards",label:o.infoActions.seeCards}],onSelect:C=>{if(c.infoId){if(C==="edit"){Ue({libraryId:m,target:"new_card",collectionId:T,revisionId:ee,revisionView:ae,infoId:c.infoId});return}if(C==="cards"){Ue({libraryId:m,target:"all_cards",collectionId:T,revisionId:ee,revisionView:ae,infoId:c.infoId,infoView:"cards"});return}Ue({libraryId:m,target:"all_cards",collectionId:T,revisionId:ee,revisionView:ae,infoId:c.infoId,infoView:"overview"})}}},{key:"collection",label:o.layers.collection,visible:Ae,value:T??"",selectedLabel:(ce==null?void 0:ce.name)??o.path.noCollectionSelected,disabled:!Oe||B||Y.length===0,options:Y.map(C=>({value:C.collectionId,label:C.name})),emptyOption:o.selectCollectionOption,onSelect:C=>{Ue({libraryId:m,target:"all_collections",collectionId:C||void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection_action",label:o.layers.revision,visible:Te,value:O,selectedLabel:We,disabled:!T,options:ve.map(C=>({value:C.value,label:C.label})),onSelect:C=>{at(C)}},{key:"revision_entry",label:o.layers.revision,visible:ot,value:ee??"",selectedLabel:(I==null?void 0:I.name)??o.status.noRevisions,disabled:!Ie||Ne||ie.length===0,options:ie.map(C=>({value:C.revisionId,label:C.name})),emptyOption:o.status.noRevisions,onSelect:C=>{Ue({libraryId:m,target:"all_collections",collectionId:T,revisionId:C||void 0,revisionView:ae})}}],[ve,Y,B,fe,v,H,V,Ue,ie,Ne,ce,T,be,I,ee,de,Ie,Oe,K,m,We,ae,L,O,$,Ee,Ae,Te,ot,pe,t.cogita.library.list.selectedEmpty,c.infoId,c.infoView,o.infoActions.edit,o.infoActions.overview,o.infoActions.seeCards,o.layers.collection,o.layers.library,o.layers.revision,o.layers.target,o.noLibraryOption,o.path.noCollectionSelected,o.path.noLibrarySelected,o.selectCollectionOption]),ft=a.useMemo(()=>vt.filter(C=>C.visible),[vt]),ze=a.useMemo(()=>ft.filter(C=>C.key!=="library"&&C.key!=="collection"&&C.key!=="revision_entry"),[ft]),st=a.useMemo(()=>ze.find(C=>C.key==="target")??null,[ze]),It=a.useMemo(()=>ze.find(C=>C.key==="info_mode")??null,[ze]),lt=a.useMemo(()=>ze.find(C=>C.key==="info_selected_action")??null,[ze]),Lt=a.useMemo(()=>ze.find(C=>C.key==="collection_action")??null,[ze]),nt=a.useCallback((C,Me)=>C?e.jsx("div",{className:"cogita-sidebar-actions",children:C.options.map(Fe=>e.jsx("button",{type:"button",className:`ghost ${String(C.value)===Fe.value?"active":""}`,onClick:()=>C.onSelect(Fe.value),disabled:C.disabled,children:Fe.label},`${Me}:${C.key}:${Fe.value}`))}):null,[]),mt=a.useMemo(()=>{const C=c.libraryId;if(!C||!N.pathname.startsWith("/cogita/library/"))return null;const Me={copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,libraryId:C};if(c.target==="library_overview")return e.jsx(Hn,{...Me});if(c.target==="all_cards")return e.jsx(Zn,{...Me,mode:c.cardMode??"list"});if(c.target==="new_card")return e.jsx(ti,{...Me,editInfoId:c.infoId});if(c.target==="dependencies")return e.jsx(si,{...Me});if(c.target==="transfer")return e.jsx(ii,{...Me});if(c.target==="storyboards"||c.target==="new_storyboard")return e.jsx(ri,{...Me});if(c.target==="texts"||c.target==="new_text")return e.jsx(oi,{...Me});if(c.target==="all_collections"){if(c.collectionId){const Fe={...Me,collectionId:c.collectionId};return c.revisionView==="graph"?e.jsx(Ai,{...Fe}):c.revisionView==="shared"?e.jsx(ni,{...Me,collectionId:c.collectionId}):c.revisionView==="settings"?e.jsx(bi,{...Fe,revisionId:c.revisionId}):c.revisionView==="run"?e.jsx(Li,{...Fe,revisionId:c.revisionId}):e.jsx(li,{...Fe})}return e.jsx(Is,{...Me})}return c.target==="new_collection"?e.jsx(Is,{...Me}):null},[s,t,A,N.pathname,d,j,g,y,r,l,c.cardMode,c.collectionId,c.infoId,c.libraryId,c.revisionId,c.revisionView,c.target,b,n]);a.useEffect(()=>{let C=!1;return(async()=>{var Fe,Ge,Xe,Ze,dt,it,Re;ue(!0);try{await Mn();const[Je,Ct,$t]=await Promise.all([qs(),In(),Ln()]);if(C)return;le(Je);const me=new Set($t.nodes.filter(ut=>ut.nodeType==="role"&&ut.canLink).map(ut=>ut.roleId??"")),he=_i(Ct,me);if(q(he),he){const ut=$t.nodes.find(Ut=>Ut.nodeType==="data"&&Ut.roleId===he&&(Ut.fieldType===ns||Ut.label===ns));De((ut==null?void 0:ut.dataKeyId)??null),xe.current=Bi(ut==null?void 0:ut.value)}const Vt=xe.current.lastLibraryId,kt=((Fe=Je.find(ut=>ut.libraryId===c.libraryId))==null?void 0:Fe.libraryId)??(Je.length===1?Je[0].libraryId:void 0)??((Ge=Je.find(ut=>ut.libraryId===Vt))==null?void 0:Ge.libraryId)??((Xe=Je[0])==null?void 0:Xe.libraryId),qt=kt?(dt=(Ze=xe.current.byLibrary)==null?void 0:Ze[kt])==null?void 0:dt.lastTarget:void 0,Ot=Pi(qt)?qt:"library_overview";z(kt),G(c.target??Ot),te(c.revisionId??(kt?(Re=(it=xe.current.byLibrary)==null?void 0:it[kt])==null?void 0:Re.lastRevisionId:void 0)),Pe(c.revisionView??"detail"),re.current=!0}catch{C||$e(o.status.loadFailed)}finally{C||ue(!1)}})(),()=>{C=!0}},[o.status.loadFailed]),a.useLayoutEffect(()=>{re.current&&(c.libraryId&&H.some(C=>C.libraryId===c.libraryId)&&z(c.libraryId),c.target&&G(c.target),R(c.collectionId),te(c.revisionId),c.revisionView&&Pe(c.revisionView))},[H,c.collectionId,c.libraryId,c.revisionId,c.revisionView,c.target]),a.useEffect(()=>{if(!m){U([]),R(void 0),h([]),_([]),te(void 0);return}let C=!1;return Q(!0),va({libraryId:m,limit:200}).then(Me=>{var Xe;if(C)return;const Fe=Me.items;U(Fe);const Ge=(Xe=Fe.find(Ze=>Ze.collectionId===c.collectionId))==null?void 0:Xe.collectionId;R(Ge)}).catch(()=>{C||(U([]),R(void 0))}).finally(()=>{C||Q(!1)}),()=>{C=!0}},[c.collectionId,m]),a.useEffect(()=>{if(!m||$!=="all_cards"&&L!=="new_card"){h([]);return}let C=!1;return us({libraryId:m,limit:200}).then(Me=>{C||h(Me)}).catch(()=>{C||h([])}),()=>{C=!0}},[$,m,L]),a.useEffect(()=>{if(!m||!T){_([]),te(void 0);return}let C=!1;return Se(!0),Ds({libraryId:m,collectionId:T}).then(Me=>{var Xe,Ze,dt,it;if(C)return;_(Me);const Fe=(Ze=(Xe=xe.current.byLibrary)==null?void 0:Xe[m])==null?void 0:Ze.lastRevisionId,Ge=((dt=Me.find(Re=>Re.revisionId===c.revisionId))==null?void 0:dt.revisionId)??((it=Me.find(Re=>Re.revisionId===Fe))==null?void 0:it.revisionId);te(Ge)}).catch(()=>{C||(_([]),te(void 0))}).finally(()=>{C||Se(!1)}),()=>{C=!0}},[c.revisionId,T,m]),a.useEffect(()=>{const C=c.infoId;if(!m||!C){S(void 0);return}let Me=!1;return ua({libraryId:m,infoId:C}).then(Fe=>{if(Me)return;const Ge=Fe.payload;S((Ge==null?void 0:Ge.label)??(Ge==null?void 0:Ge.name)??(Ge==null?void 0:Ge.title)??Fe.infoId)}).catch(()=>{Me||S(C)}),()=>{Me=!0}},[c.infoId,m]),a.useEffect(()=>{if(!re.current||c.libraryId&&H.some(Fe=>Fe.libraryId===c.libraryId)&&c.libraryId!==m||c.target&&c.target!==L||c.revisionView&&c.revisionView!==ae||c.revisionId&&c.revisionId!==ee||is[L].requiresCollection&&!T&&c.target==="all_collections"&&c.collectionId)return;const C=Ia(`${N.pathname}${N.search}`),Me=Ia(os(m,L,T,ae,ee,c.infoId,c.infoView??"overview"));if(C===Me){qe.current=null;return}qe.current!==Me&&(qe.current=Me,d(Me,{replace:!0}))},[H,N.pathname,N.search,d,c.collectionId,c.infoId,c.infoView,c.libraryId,c.revisionId,c.revisionView,c.target,T,m,ee,ae,L]),a.useEffect(()=>{if(typeof window>"u")return;const C=()=>{window.innerWidth>920&&x(!1)};return window.addEventListener("resize",C),()=>window.removeEventListener("resize",C)},[]),a.useEffect(()=>{if(!re.current||!Ye||!m||Le.current)return;const C=xe.current,Me={...C.byLibrary??{}},Fe={...Me[m]??{},lastCollectionId:T,lastRevisionId:ee,lastRevisionView:ae,lastTarget:L},Ge={version:1,lastLibraryId:m,byLibrary:{...Me,[m]:Fe}},Xe=JSON.stringify(C),Ze=JSON.stringify(Ge);if(Xe===Ze)return;xe.current=Ge,Le.current=!0,(async()=>{try{if(W)await $n(W,{plainValue:Ze});else{const it=await Rn(Ye,{itemName:ns,itemType:"data",plainValue:Ze});De(it.dataItemId)}}catch{$e(o.status.savePrefsFailed)}finally{Le.current=!1}})()},[W,Ye,T,m,ee,ae,L,o.status.savePrefsFailed]);const Ft=async()=>{const C=ye.trim();if(!C){$e(t.cogita.user.libraryNameRequired);return}$e(null);try{const Me=await Fn({name:C});le(Fe=>[Me,...Fe]),z(Me.libraryId),G("library_overview"),R(void 0),Ke("")}catch{$e(t.cogita.user.libraryCreateFailed)}},pt=async()=>{if(!m){$e(o.status.selectLibraryFirst);return}const C=_e.trim();if(!C){$e(t.cogita.library.collections.saveRequiredName);return}$e(null);try{const Me=await En({libraryId:m,name:C,items:[]}),Fe=await va({libraryId:m,limit:200});U(Fe.items),R(Me.collectionId),te(void 0),G("all_collections"),Pe("detail"),je("")}catch{$e(t.cogita.library.collections.saveFail)}},et=async()=>{if(!m||!T){$e(o.status.selectLibraryFirst);return}const C=Be.trim();if(!C){$e(o.revisionForm.nameLabel);return}$e(null);try{const Me=await An({libraryId:m,collectionId:T,name:C,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});_(Fe=>[Me,...Fe]),te(Me.revisionId),G("all_collections"),Pe("settings"),tt("")}catch{$e(o.status.loadFailed)}};return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${ge?"open":""}`,"aria-label":o.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{children:(K==null?void 0:K.name)??o.path.noLibrarySelected}),e.jsx("p",{className:"cogita-sidebar-note",children:K?o.sidebar.libraryActionsHint:o.status.selectLibraryFirst}),nt(st,"sidebar")]}),It?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:o.sidebar.infoActionsHint}),nt(It,"sidebar"),lt?e.jsxs("div",{className:"cogita-sidebar-actions-nested",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(be==null?void 0:be.label)??de??t.cogita.library.list.selectedEmpty}),e.jsx("p",{className:"cogita-sidebar-note",children:o.sidebar.selectedInfoActionsHint}),nt(lt,"sidebar")]}):null]}):null,ce?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:ce.name}),e.jsx("p",{className:"cogita-sidebar-note",children:o.sidebar.collectionActionsHint}),nt(Lt,"sidebar")]}):null,e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:o.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:r,children:o.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{y("cogita"),x(!1)},children:o.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:l,children:b?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),ge?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":o.sidebar.closeMenu,onClick:()=>x(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":o.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>x(C=>!C),"aria-label":ge?o.sidebar.closeMenu:o.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),ft.map((C,Me)=>e.jsxs("div",{className:"cogita-browser-segment",children:[Me>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,C.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":C.label,children:C.selectedLabel}):e.jsxs("select",{"aria-label":C.label,value:C.value,onChange:Fe=>C.onSelect(Fe.target.value),disabled:C.disabled,children:[C.emptyOption?e.jsx("option",{value:"",children:C.emptyOption}):null,C.options.map(Fe=>e.jsx("option",{value:Fe.value,children:Fe.label},`${C.key}:${Fe.value}`))]})]},`menu:${C.key}`))]}),mt?e.jsxs(e.Fragment,{children:[L==="new_collection"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.library.actions.createCollection}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{type:"text",value:_e,onChange:C=>je(C.target.value),placeholder:t.cogita.library.collections.namePlaceholder,disabled:!m})]}),e.jsx("button",{type:"button",className:"cta",onClick:pt,disabled:!m,children:t.cogita.library.actions.createCollection}),we?e.jsx("p",{className:"cogita-form-error",children:we}):null]}):null,L==="all_collections"&&T&&ae==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:o.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Be,onChange:C=>tt(C.target.value),placeholder:o.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:et,children:o.revisionForm.createAction}),we?e.jsx("p",{className:"cogita-form-error",children:we}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Hs.Provider,{value:!0,children:mt})})]}):null,mt?null:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-browser-layout",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:o.panels.currentPosition}),e.jsxs("p",{className:"cogita-browser-path",children:[ft.map((C,Me)=>e.jsxs("span",{children:[Me>0?e.jsx("span",{children:" / "}):null,e.jsx("strong",{children:C.selectedLabel})]},`path:${C.key}`)),Ae?null:e.jsxs("span",{children:[e.jsx("span",{children:" / "}),e.jsx("strong",{children:o.path.noCollectionLayer})]})]}),e.jsxs("p",{className:"cogita-browser-note",children:[o.path.currentRoute," ",e.jsx("code",{children:os(m,L,T,ae,ee,c.infoId,c.infoView??"overview")})]}),m?e.jsxs("div",{className:"cogita-browser-links",children:[e.jsx("a",{className:"ghost",href:`/#/cogita/library/${m}`,children:o.links.libraryOverview}),e.jsx("a",{className:"ghost",href:`/#/cogita/library/${m}/list`,children:o.links.allCards}),T?e.jsx("a",{className:"ghost",href:`/#/cogita/library/${m}/collections/${T}/shared-revisions`,children:o.links.sharedRevisions}):null]}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:o.panels.quickCreate}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:ye,onChange:C=>Ke(C.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Ft,children:t.cogita.user.createLibraryAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{type:"text",value:_e,onChange:C=>je(C.target.value),placeholder:t.cogita.library.collections.namePlaceholder,disabled:!m})]}),e.jsx("button",{type:"button",className:"cta",onClick:pt,disabled:!m,children:t.cogita.library.actions.createCollection}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Be,onChange:C=>tt(C.target.value),placeholder:o.revisionForm.namePlaceholder,disabled:!T})]}),e.jsx("button",{type:"button",className:"cta",onClick:et,disabled:!T,children:o.revisionForm.createAction}),we?e.jsx("p",{className:"cogita-form-error",children:we}):null]})]}),e.jsxs("section",{className:"cogita-browser-collections",children:[e.jsx("h2",{children:o.panels.collections}),B?e.jsx("p",{className:"cogita-library-subtitle",children:o.status.loadingCollections}):null,!B&&Y.length===0?e.jsx("p",{className:"cogita-library-subtitle",children:o.status.noCollections}):null,Y.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:Y.map(C=>e.jsxs("button",{type:"button",className:`cogita-card-item ${C.collectionId===T?"active":""}`,onClick:()=>{R(C.collectionId),te(void 0),Pe("detail")},children:[e.jsx("div",{className:"cogita-card-type",children:o.cards.collectionType}),e.jsx("h3",{className:"cogita-card-title",children:C.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[C.itemCount," ",o.cards.itemsSuffix]})]},C.collectionId))}):null]})]})]})]})})}const zi=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:Ki},Symbol.toStringTag,{value:"Module"}));function qi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,shareId:d}){const[N,c]=a.useState(null),[o,H]=a.useState("loading"),[le,Y]=a.useState(t.cogita.library.collections.defaultName),[U,v]=a.useState("Cogita Library"),[h,ie]=a.useState([]),[_,m]=a.useState([]),[z,L]=a.useState("idle"),[G,T]=a.useState({current:0,total:0}),[R,ee]=a.useState(0),[te,ae]=a.useState(""),[Pe,de]=a.useState(null),[S,ge]=a.useState(null),[x,V]=a.useState(null),[ue,B]=a.useState(null),[Q,Ne]=a.useState([]),[Se,we]=a.useState({}),[$e,ye]=a.useState({}),[Ke,_e]=a.useState(null),[je,Be]=a.useState(null),[tt,Ye]=a.useState(null),[q,W]=a.useState(null),[De,xe]=a.useState({}),re=a.useRef(0),[Le,qe]=a.useState(null),K=a.useRef(null),ce=a.useRef(null),[I,X]=a.useState(null),[ve,$]=a.useState(!1),[O,fe]=a.useState(null),[be,pe]=a.useState([]),[Ee,We]=a.useState(null),Oe=a.useRef(null),Ie=a.useRef(null),[Ae,Te]=a.useState(null),[ot,Ue]=a.useState(0),at=a.useRef(null),vt=a.useRef({}),[ft,ze]=a.useState(!1),[st,It]=a.useState({}),lt=a.useRef(null),Lt=a.useRef(new Set),nt=a.useRef({}),[mt,Ft]=a.useState([]),[pt,et]=a.useState(new Set),[C,Me]=a.useState(!1),Fe=ds(),Ge=a.useMemo(()=>new URLSearchParams(Fe.search),[Fe.search]),Xe=a.useMemo(()=>Ge.get("key")??"",[Ge]),Ze=(N==null?void 0:N.mode)??"random",dt=(N==null?void 0:N.check)??"exact",it=(N==null?void 0:N.limit)??20,Re=a.useMemo(()=>fs((N==null?void 0:N.revisionType)??Ze),[N,Ze]),Je=a.useMemo(()=>{const k=N==null?void 0:N.revisionSettings,D=Gs(Re,Ge);return Oa(Re,k??D)},[N,Ge,Re]),Ct=a.useMemo(()=>t.cogita.library.revision[Re.labelKey]??Ze,[t,Ze,Re]),$t=a.useMemo(()=>dt==="exact"?t.cogita.library.revision.checkValue:dt,[t,dt]),he=o==="ready"?h[R]??null:null,Vt=(he==null?void 0:he.checkType)==="translation-match"&&q,kt=a.useRef(new Map),qt=a.useRef(new Map),Ot=a.useRef(new Map),ut=a.useRef(new Map),Ut=a.useMemo(()=>he?he.cardType==="vocab"?t.cogita.library.revision.vocabLabel:he.infoType?Qe(t,he.infoType):t.cogita.library.revision.infoLabel:"",[t,he]),aa=a.useMemo(()=>{var D;return Re.id!=="levels"?h.length:((D=st.pool)==null?void 0:D.length)??Re.getFetchLimit(it,Je)},[st,Je,Re,h.length,it]),sa=Re.getProgressTotal?Re.getProgressTotal(h,st,it,Je):Re.id==="levels"?Math.min(it,aa):h.length,Rt=sa?Math.min(R+1,sa):0,wt=Math.max(1,Number(Je.tries??1)),zt=Je.compare??"anchors",gt=Math.max(0,Math.min(100,Number(Je.minCorrectness??0))),rt=(Je.considerDependencies??"on")==="on",Mt=Math.max(0,Math.min(100,Number(Je.dependencyThreshold??85))),Wt=k=>{const D=k.slice();for(let i=D.length-1;i>0;i-=1){const u=Math.floor(Math.random()*(i+1));[D[i],D[u]]=[D[u],D[i]]}return D},Ht=k=>k.length?k.reduce((i,u)=>i+u,0)/k.length/255*100:0,na=k=>Ht(k)>=gt,Ua=async()=>{const k=await Kt(),D=new Map,i=new Map;k.forEach(f=>{const P=`${f.itemType}:${f.itemId}`,p=_t(f.itemType,f.itemId,f.checkType,f.direction);D.has(P)||D.set(P,[]),D.get(P).push(f),i.has(p)||i.set(p,[]),i.get(p).push(f)});const u=new Map,w=new Map;return D.forEach((f,P)=>u.set(P,Bt(f).score)),i.forEach((f,P)=>w.set(P,Bt(f).score)),{itemKnowness:u,cardKnowness:w}},pa=async k=>{const D=st,i=k.concat(D.active??[]).concat(D.pool??[]).filter((F,J,Z)=>Z.findIndex(oe=>ne(oe)===ne(F))===J);if(!rt){et(new Set(i.map(ne)));return}const{itemKnowness:u,cardKnowness:w}=await Ua(),f=F=>{if(F.cardType!=="info"||F.infoType!=="quote"||F.checkType!=="quote-fragment")return!0;const J=jt(F.direction);if(!(J!=null&&J.fragmentId))return!0;const Z=F.description??"";if(!Z.trim())return!0;const se=ma(Z).nodes[J.fragmentId];if(!se||!se.leftId&&!se.rightId)return!0;const ke=[se.leftId,se.rightId].filter(He=>!!He);if(ke.length===0)return!0;const Ce=ke.map(He=>{const ct=_t("info",F.cardId,"quote-fragment",ja(J.mode,He));return w.get(ct)??0});return Ce.reduce((He,ct)=>He+ct,0)/Ce.length>=Mt},P=(N==null?void 0:N.collectionId)??null,p=P?mt.filter(F=>ht(F.childItemType)==="collection"&&F.childItemId===P&&!ht(F.childCheckType)&&!ht(F.childDirection)):[],E=P&&i.length>0?i.reduce((F,J)=>F+(w.get(ne(J))??0),0)/i.length:0,M=new Set;for(const F of i){if(F.cardType!=="info"){M.add(ne(F));continue}if(!f(F))continue;const J=mt.filter(se=>rn(se,F)).concat(p);if(J.length===0){M.add(ne(F));continue}let Z=0;for(const se of J)if(ht(se.parentItemType)==="collection")Z+=se.parentItemId===P?E:0;else if(ht(se.parentCheckType)||ht(se.parentDirection)){const ke=ht(se.parentCheckType),Ce=ht(se.parentDirection),Ve=_t(se.parentItemType,se.parentItemId,ke,Ce);Z+=w.get(Ve)??0}else{const ke=`${se.parentItemType}:${se.parentItemId}`;Z+=u.get(ke)??0}Z/J.length>=Mt&&M.add(ne(F))}et(M)},za=k=>{for(let D=k;D<h.length;D+=1){const i=h[D];if(i&&(!rt||i.cardType!=="info"||pt.has(ne(i))))return D}return-1},ia=k=>!rt||k.cardType!=="info"||pt.has(ne(k)),Ha=k=>{if(Re.id!=="temporal"&&Re.id!=="levels")return null;const D=st,i=(D.active??[]).concat(D.pool??[]),u=new Set;for(const w of i){const f=ne(w);if(!(u.has(f)||k.has(f))&&(u.add(f),ia(w)))return w}return null},Tt=a.useMemo(()=>{if(Re.id!=="levels")return null;const k=st,D=k.pool??[],i=k.active??[],u=k.levelMap??{},w=Math.max(1,Number(Je.levels??1)),f=Array.from({length:w},()=>0),P=new Set(i.map(F=>ne(F)));D.forEach(F=>{const J=Math.min(w,Math.max(1,u[ne(F)]??1));f[J-1]+=1});const p=D.length||1,E=f.map(F=>F/p*100),M=he?u[ne(he)]??1:null;return{counts:f,percentages:E,currentLevel:M,levelsCount:w,activeCount:i.length,poolCount:D.length,activeSet:P}},[st,Je,Re,he]),ra=a.useMemo(()=>{if(Re.id!=="temporal")return null;const k=st,D=k.pool??[],i=k.active??[],u=k.knownessMap??{},w=new Set(k.unknownSet??[]);let f=0;D.forEach(E=>{(u[ne(E)]??0)>1&&(f+=1)});const P=w.size,p=i.map(E=>({id:ne(E),value:w.has(ne(E))?0:Math.max(0,Math.min(1,u[ne(E)]??0))}));return{knownCount:f,unknownCount:P,dots:p}},[st,Re]),Et=a.useMemo(()=>{if(!rt)return 0;const k=st;return h.concat(k.active??[]).concat(k.pool??[]).filter((i,u,w)=>w.findIndex(f=>ne(f)===ne(i))===u).filter(i=>i.cardType==="info"&&!pt.has(ne(i))).length},[rt,st,h,pt]);a.useEffect(()=>{if(!rt||z!=="ready")return;const k=st,i=h.concat(k.active??[]).concat(k.pool??[]).filter((f,P,p)=>p.findIndex(E=>ne(E)===ne(f))===P).filter(f=>f.cardType!=="info"||pt.has(ne(f))).length,u=Oe.current;if(Oe.current=i,u===null||i<=u)return;const w=i-u;We(`New card available (+${w})`),Ie.current&&window.clearTimeout(Ie.current),Ie.current=window.setTimeout(()=>We(null),2200)},[rt,z,st,h,pt]),a.useEffect(()=>()=>{Ie.current&&window.clearTimeout(Ie.current)},[]);const bt=(k,D)=>{const i=Re.applyOutcome({queue:h,meta:st},he,it,Je,{correct:k,correctness:D,createdUtc:new Date().toISOString()});ie(i.queue),It(i.meta);const u=i.queue[R+1];u&&St(u,R+1)};a.useEffect(()=>{if(!d){H("error");return}H("loading"),Pn({shareId:d,key:Xe}).then(k=>{c(k),Y(k.collectionName),v(k.libraryName),H("ready")}).catch(()=>{H("error")})},[d,Xe]),a.useEffect(()=>{d&&_n({shareId:d,key:Xe,type:"language"}).then(k=>m(k)).catch(()=>m([]))},[d,Xe]),a.useEffect(()=>{!d||o!=="ready"||Bn({shareId:d,key:Xe}).then(k=>Ft(k.items??[])).catch(()=>Ft([]))},[d,Xe,o]),a.useEffect(()=>{if(!d||o!=="ready")return;let k=!0;return(async()=>{L("loading"),T({current:0,total:Re.id==="levels"?0:Re.getFetchLimit(it,Je)});try{const i=[];let u=null,w=null;do{const J=await Kn({shareId:d,key:Xe,limit:300,cursor:u});if(i.push(...J.items),(Re.id==="levels"||Re.id==="temporal")&&J.total&&(w=J.total),T(Z=>({current:i.length,total:Z.total||J.total||Re.getFetchLimit(it,Je)})),u=J.nextCursor??null,w!==null&&i.length>=w||Re.id!=="levels"&&Re.id!=="temporal"&&i.length>=Re.getFetchLimit(it,Je))break}while(u);if(!k)return;const f=cs(i);let P;if(Re.id==="levels"){const J=Math.max(1,Number(Je.levels??1));P={},f.forEach(Z=>{const oe=ne(Z);P[oe]=Math.max(1,Math.min(J,1))})}let p=null,E=null,M=null;if(Re.id==="temporal"){const J=await Kt(),Z=new Set(f.map(ke=>ne(ke))),oe=J.reduce((ke,Ce)=>{const Ve=_t(Ce.itemType,Ce.itemId,Ce.checkType,Ce.direction);return Z.has(Ve)&&(ke[Ve]||(ke[Ve]=[]),ke[Ve].push(Ce)),ke},{});p={},E=new Set,M={};const se=Date.now();f.forEach(ke=>{const Ce=ne(ke),Ve=oe[Ce]??[];if(Ve.length===0){p[Ce]=0,E.add(Ce),M[Ce]=[];return}const He=hs(Ve);M[Ce]=He;const ct=Da(He,se);p[Ce]=ct.knowness})}const F=Re.id==="levels"?ms(f,it,Je,P):Re.id==="temporal"?gs(f,it,Je,p??{},E??new Set,M??{}):Re.prepare(f,it,Je);ie(F.queue),It(F.meta),ee(0),L("ready"),T(J=>({current:Math.min(J.current,J.total),total:J.total}))}catch{k&&L("error")}})(),()=>{k=!1}},[d,Xe,it,Re,Je,o]),a.useEffect(()=>{pa(h)},[h,mt,rt,Mt,N==null?void 0:N.collectionId]),a.useEffect(()=>{if(!he||!rt){Me(!1);return}if(he.cardType!=="info"||pt.has(ne(he))){Me(!1);return}const k=za(R+1);if(k>=0){Me(!1),ee(k);return}if(Re.id==="temporal"||Re.id==="levels"){const D=h.slice(0,R+1),i=h.slice(R+1).filter(ia),u=D.concat(i),w=new Set(u.map(ne)),f=Ha(w);if(f){const p=ne(f);w.has(p)||(u.push(f),w.add(p),It(E=>{const M=E,F=new Set(M.queued??[]);return F.add(p),{...M,queued:F}}))}const P=u.findIndex((p,E)=>E!==R&&ia(p));if(P>=0){ie(u),ee(P),Me(!1);return}}Me(!0)},[he,pt,rt,R,h,st,Re.id]),a.useEffect(()=>{if(ae(""),de(null),Te(null),Ue(0),Ne([]),we({}),ye({}),_e(null),Be(null),Ye(null),$(!1),ze(!1),X(null),W(null),xe({}),!he){ge(null),V(null);return}he.cardType==="info"&&he.infoType==="computed"&&ge(t.cogita.library.revision.loadingComputed);let k=!0;return St(he,R).then(D=>{!k||!D||(ge(D.prompt),V(D.expectedAnswer),Ne(D.computedExpected),we(D.computedAnswers),_e(D.answerTemplate),Be(D.outputVariables),Ye(D.variableValues))}),()=>{k=!1}},[he,d,t]),a.useEffect(()=>{if(!he||he.cardType!=="info"||he.infoType!=="quote"){lt.current=null,Lt.current=new Set,B(null);return}const k=he.description??"",D=(he.label??"").trim(),i=D.replace(/\s+/g," ").trim(),u=k.replace(/\s+/g," ").trim(),w=i&&i!==u?D:t.cogita.library.infoTypes.quote;if(!k){B(null),V(null);return}const f=ma(k);lt.current=f,ge(w);let P=!0;return Kt().then(p=>{if(!P)return;const E=getQuoteMode(he.direction),M=new Map;p.forEach(se=>{if(se.itemType!=="info"||se.checkType!=="quote-fragment"||!se.direction)return;const ke=jt(se.direction);if(!ke||ke.mode!==E)return;const Ce=`${se.itemId}:${ke.fragmentId}`;M.has(Ce)||M.set(Ce,[]),M.get(Ce).push(se)});const F={},J=new Set;M.forEach((se,ke)=>{const[Ce,Ve]=ke.split(":",2);if(Ce!==he.cardId)return;const He=Bt(se).score;F[Ve]=He,He>=Mt&&J.add(Ve)}),Lt.current=J,nt.current=F;const Z=jt(he.direction);if(Z!=null&&Z.fragmentId&&f.nodes[Z.fragmentId]){Gt(f,Z.fragmentId,w);return}const oe=ha(f,J,F,Mt,rt,he.direction);Gt(f,(oe==null?void 0:oe.id)??null,w)}).catch(()=>{Lt.current=new Set,nt.current={};const p=jt(he.direction);if(p!=null&&p.fragmentId&&f.nodes[p.fragmentId]){Gt(f,p.fragmentId,w);return}const E=ha(f,Lt.current,{},Mt,rt,he.direction);Gt(f,(E==null?void 0:E.id)??null,w)}),()=>{P=!1}},[he,t,rt,Mt]),a.useEffect(()=>{if(!he||he.cardType!=="vocab"||he.checkType!=="translation-match"){W(null),xe({});return}const i=(st.pool??st.active??h).filter(p=>p.cardType==="vocab"&&p.checkType==="translation-match").filter((p,E,M)=>M.findIndex(F=>F.cardId===p.cardId)===E);i.some(p=>p.cardId===he.cardId)||i.unshift(he);const w=Wt(i).slice(0,6).map(p=>{const E=p.label.split("↔").map(J=>J.trim()).filter(Boolean);if(E.length<2)return null;const M=`${p.cardId}:L`,F=`${p.cardId}:R`;return{cardId:p.cardId,leftId:M,rightId:F,leftLabel:E[0],rightLabel:E[1]}}).filter(Boolean),f=w.map(p=>p.leftId),P=Wt(w.map(p=>p.rightId));W({pairs:w,leftOrder:f,rightOrder:P,selection:{},activeLeft:null,activeRight:null,locked:{}})},[he,h,st]),a.useEffect(()=>()=>{K.current&&window.clearTimeout(K.current),ce.current&&window.clearTimeout(ce.current)},[]);const oa=a.useRef(null);a.useEffect(()=>{if(!he)return;const k=ne(he),D=typeof document<"u"?document.activeElement:null;if(oa.current===k&&D&&(D.tagName==="INPUT"||D.tagName==="TEXTAREA"))return;let i=0;const u=()=>{if(he){if(he.cardType==="info"&&he.infoType==="computed"){if(Q.length>0){const f=Ka(Ke,Q,je),P=f?vt.current[f]:null;if(P&&(P.focus(),document.activeElement===P)){oa.current=k;return}}if(at.current&&(at.current.focus(),document.activeElement===at.current)){oa.current=k;return}}else if(he.cardType==="vocab"&&at.current&&(at.current.focus(),document.activeElement===at.current)){oa.current=k;return}i<6&&(i+=1,window.setTimeout(u,40))}},w=window.setTimeout(u,40);return()=>window.clearTimeout(w)},[he,Q,Ke,je]),a.useEffect(()=>{if(!ft)return;const k=D=>{D.key==="Enter"&&(D.preventDefault(),la())};return window.addEventListener("keydown",k),()=>window.removeEventListener("keydown",k)},[ft]);const yt=k=>{pe(k),fe(Bt(k))};a.useEffect(()=>{if(!he){fe(null),pe([]);return}const k=he.cardType==="info"?"info":"connection";if(he.cardType==="info"&&he.infoType==="quote"){Kt().then(D=>{const i=D.filter(u=>u.itemType==="info"&&u.itemId===he.cardId&&u.checkType==="quote-fragment"&&_a(u.direction,he.direction));yt(i)}).catch(()=>{fe(null),pe([])});return}Fa(k,he.cardId,he.checkType,he.direction).then(D=>yt(D)).catch(()=>{fe(null),pe([])})},[he]);const Yt=(k,D,i,u)=>{if(k==="info"&&i==="quote-fragment"){Kt().then(w=>{const f=w.filter(P=>P.itemType==="info"&&P.itemId===D&&P.checkType==="quote-fragment"&&_a(P.direction,u));yt(f)}).catch(()=>{fe(null),pe([])});return}Fa(k,D,i,u).then(w=>yt(w)).catch(()=>{fe(null),pe([])})},Xt=(k,D,i)=>{var P;const u=((P=i.pairs.find(p=>p.leftId===k))==null?void 0:P.rightId)??null;if(!u)return i;const w=u===D;xe(p=>({...p,[k]:w?"correct":"incorrect"})),K.current&&window.clearTimeout(K.current),ce.current&&window.clearTimeout(ce.current),re.current+=1;const f={kind:w?"correct":"incorrect",tick:re.current};if(qe(null),K.current=window.setTimeout(()=>qe(f),0),ce.current=window.setTimeout(()=>qe(null),420),w){const p={...i.locked,[k]:!0};return Object.keys(p).length>=i.pairs.length?(de("correct"),ze(!0)):de("correct"),{...i,selection:{...i.selection,[k]:D},activeLeft:null,activeRight:null,locked:p}}return de("incorrect"),{...i,activeLeft:null,activeRight:null}},ka=k=>{W(D=>!D||D.locked[k]?D:D.activeRight?Xt(k,D.activeRight,D):{...D,activeLeft:D.activeLeft===k?null:k})},Ta=k=>{W(D=>D&&(D.activeLeft?Xt(D.activeLeft,k,D):{...D,activeRight:D.activeRight===k?null:k}))},la=()=>{var k;if(he&&he.cardType==="info"&&he.infoType==="quote"&&lt.current&&ue&&!((k=jt(he.direction))!=null&&k.fragmentId)){const D=ha(lt.current,Lt.current,nt.current,Mt,rt,he.direction,ue.fragmentId);if(D){de(null),ae(""),$(!1),ye({}),ze(!1),Te(null),Ue(0),Gt(lt.current,D.id,ue.title);return}}de(null),ae(""),$(!1),ye({}),ze(!1),Te(null),Ue(0),ee(D=>Math.min(D+1,h.length))},At=k=>{if(!he)return;const D=k.expected??null,i=k.answer??"";let u=D??"",w=i;if(!D&&k.expectedMap&&k.answerMap){const J=Object.keys(k.expectedMap).sort((Z,oe)=>Z.localeCompare(oe));u=J.map(Z=>{var oe;return((oe=k.expectedMap)==null?void 0:oe[Z])??""}).join("|"),w=J.map(Z=>{var oe;return((oe=k.answerMap)==null?void 0:oe[Z])??""}).join("|")}const f=u?ga(u,w,zt):new Uint8Array,P={revisionType:Re.id,evalType:k.evalType,direction:k.direction,prompt:S??"",expected:D,answer:i,expectedAnswers:k.expectedMap??null,answers:k.answerMap??null,correct:k.correct,maskBase64:f.length?Qt(f):null,checkMode:dt,compareMode:zt,minCorrectness:gt},p=new TextEncoder().encode(JSON.stringify(P)),E=he.cardType==="info"?"info":"connection",M=k.overrideCheckType??he.checkType??null,F=k.overrideDirection??he.direction??null;Aa({itemType:E,itemId:he.cardId,checkType:M,direction:F,revisionType:Re.id,evalType:k.evalType,correct:k.correct,maskBase64:f.length?Qt(f):null,payloadBase64:Qt(p)}).then(()=>{Yt(E,he.cardId,M,F),pa(h)}).catch(()=>{})},ca=(k,D)=>{const i=kt.current.get(D);if(i)return Promise.resolve(i);const u=qt.current.get(D);if(u)return u;const w=qn({shareCode:d,infoId:k,key:Xe}).then(f=>{var J,Z;const P=f.payload,p=((J=P.definition)==null?void 0:J.graph)??null,E="",M=((Z=P.definition)==null?void 0:Z.answerTemplate)??"",F=Js(p,E,M);if(F){const se={sample:Zs(F),answerTemplate:M||null};return kt.current.set(D,se),se}return xs({shareId:d,infoId:k,key:Xe}).then(oe=>{const se={sample:oe,answerTemplate:null};return kt.current.set(D,se),se})}).catch(()=>xs({shareId:d,infoId:k,key:Xe}).then(f=>{const P={sample:f,answerTemplate:null};return kt.current.set(D,P),P}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{qt.current.delete(D)});return qt.current.set(D,w),w},St=(k,D)=>{var p;const i=`${ne(k)}:${D}`,u=Ot.current.get(i);if(u)return Promise.resolve(u);const w=ut.current.get(i);if(w)return w;const f=E=>(Ot.current.set(i,E),E);let P;if(k.cardType==="vocab"){if(k.checkType==="translation-match")return P=Promise.resolve(f({prompt:k.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),P;const E=k.label.split("↔").map(M=>M.trim()).filter(Boolean);if(E.length>=2){const F=(k.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",J=F?E[0]:E[1],Z=F?E[1]:E[0];P=Promise.resolve(f({prompt:J,expectedAnswer:Z,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else P=Promise.resolve(f({prompt:k.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(k.cardType==="info"&&k.infoType==="word"){const E=(p=k.description)!=null&&p.startsWith("Language: ")?k.description.replace("Language: ",""):null;P=Promise.resolve(f({prompt:k.label,expectedAnswer:E,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else k.cardType==="info"&&k.infoType==="computed"?P=ca(k.cardId,i).then(E=>{var oe,se;if(!E.sample)return f({prompt:k.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const M=E.sample,F=M.expectedAnswers?Object.entries(M.expectedAnswers).map(([ke,Ce])=>({key:ke,expected:Ce})):[],J=F.reduce((ke,Ce)=>(ke[Ce.key]="",ke),{}),Z=M.expectedAnswerIsSentence&&((oe=M.expectedAnswer)==null?void 0:oe.trim())||null;return f({prompt:M.prompt,expectedAnswer:F.length>0?Z:((se=M.expectedAnswer)==null?void 0:se.trim())||null,computedExpected:F,computedAnswers:J,answerTemplate:E.answerTemplate,outputVariables:M.outputVariables??null,variableValues:M.variableValues??null})}).catch(()=>f({prompt:k.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{ut.current.delete(i)}):P=Promise.resolve(f({prompt:k.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return ut.current.set(i,P),P},Gt=(k,D,i)=>{const u=Object.keys(k.nodes).length,w=Lt.current.size;if(!D){B({title:i,before:k.text,after:"",fragmentId:null,total:u,completed:w}),V(null),ze(!0);return}const f=k.nodes[D];if(!f)return;const P=Ws(k.text,f);B({title:i,before:P.before,after:P.after,fragmentId:f.id,total:u,completed:w}),V(P.fragment),ze(!1)},ba=()=>{const k=lt.current;k&&B(D=>D&&{...D,total:Object.keys(k.nodes).length,completed:Lt.current.size})},Pt=()=>{const k=h[R+1];k&&St(k,R+1)},Sa=()=>{if(Pt(),he&&he.cardType==="vocab"&&he.checkType==="translation-match"&&q){if(q.pairs.length===0){de("incorrect"),ze(!0);return}const f=q.pairs.reduce((Z,oe)=>(Z[oe.rightId]=oe.rightLabel,Z),{});let P=0;const p={};q.pairs.forEach(Z=>{const se=q.selection[Z.leftId]===Z.rightId;p[Z.leftId]=se?"correct":"incorrect",se&&(P+=1)});const E=q.pairs.length||1,M=P/E,F=P===q.pairs.length;xe(Z=>({...Z,...p})),F?(de("correct"),ze(!0),Ue(0)):(de("incorrect"),ze(!1),Ue(Z=>{const oe=Z+1;return oe>=wt&&($(!0),ze(!0),W(se=>{if(!se)return se;const ke=se.pairs.reduce((Ce,Ve)=>(Ce[Ve.leftId]=Ve.rightId,Ce),{});return{...se,selection:ke}})),oe})),bt(F,M);const J="connection";Promise.all(q.pairs.map(Z=>{const oe=q.selection[Z.leftId]??null,se=oe?f[oe]:"",ke={left:Z.leftLabel,expected:Z.rightLabel,answer:se,checkType:"translation-match"},Ce=new TextEncoder().encode(JSON.stringify(ke));return Aa({itemType:J,itemId:Z.cardId,checkType:"translation-match",direction:null,revisionType:Re.id,evalType:"translation-match",correct:oe===Z.rightId,maskBase64:null,payloadBase64:Qt(Ce)})})).then(()=>{Yt(J,he.cardId,he.checkType,he.direction),pa(h)}).catch(()=>{});return}if(Q.length>0){const f=Q.reduce((p,E)=>{const M=Se[E.key]??"";return p[E.key]=xt(M)===xt(E.expected)?"correct":"incorrect",p},{});Q.every(({key:p,expected:E})=>{const M=Se[p]??"";return dt==="exact"&&xt(M)===xt(E)})?(de("correct"),ye(f),ze(!0),Ue(0),bt(!0,1),At({correct:!0,direction:S?`${S} -> computed`:"computed",expectedMap:Q.reduce((p,E)=>(p[E.key]=E.expected,p),{}),answerMap:Se,evalType:"computed"})):(de("incorrect"),ye(f),ze(!1),Ue(p=>{const E=p+1;return E>=wt&&Jt&&($(!0),ze(!0)),E}),bt(!1,0),window.setTimeout(()=>{var E;const p=Ka(Ke,Q,je);p&&vt.current[p]&&((E=vt.current[p])==null||E.focus())},40),At({correct:!1,direction:S?`${S} -> computed`:"computed",expectedMap:Q.reduce((p,E)=>(p[E.key]=E.expected,p),{}),answerMap:Se,evalType:"computed"}));return}if(he&&he.cardType==="info"&&he.infoType==="quote"&&(ue!=null&&ue.fragmentId)){if(!x)return;const f=jt(he.direction),P=(f==null?void 0:f.mode)??getQuoteMode(he.direction),p=f!=null&&f.fragmentId&&he.direction?he.direction:ja(P,ue.fragmentId),E=nn(x,te,zt),M=dt==="exact"&&fa(te)===fa(x),F=na(E),J=M||F,Z=Ht(E);J?(nt.current[ue.fragmentId]=Math.max(nt.current[ue.fragmentId]??0,Z),(nt.current[ue.fragmentId]??0)>=Mt&&Lt.current.add(ue.fragmentId),ba(),de("correct"),ye({}),ze(!0),Te(E),Ue(0),Z<100&&wt<=1&&$(!0),bt(!0,Z/100),At({correct:!0,direction:`quote:${ue.fragmentId}`,expected:x,answer:te,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:p})):(de("incorrect"),ye({}),ze(!1),Te(E),Ue(oe=>{const se=oe+1;return se>=wt&&Jt&&($(!0),ze(!0)),se}),bt(!1,Z/100),window.setTimeout(()=>{var oe;return(oe=at.current)==null?void 0:oe.focus()},40),At({correct:!1,direction:`quote:${ue.fragmentId}`,expected:x,answer:te,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:p}));return}if(!x)return;const k=ga(x,te,zt),D=dt==="exact"&&xt(te)===xt(x),i=na(k),u=D||i,w=Ht(k);u?(de("correct"),ye({}),ze(!0),Te(k),Ue(0),w<100&&wt<=1&&$(!0),bt(!0,w/100),At({correct:!0,direction:S?`${S} -> ${x}`:null,expected:x,answer:te,evalType:"text"})):(de("incorrect"),ye({}),ze(!1),Te(k),Ue(f=>{const P=f+1;return P>=wt&&Jt&&($(!0),ze(!0)),P}),bt(!1,w/100),window.setTimeout(()=>{var f;return(f=at.current)==null?void 0:f.focus()},40),At({correct:!1,direction:S?`${S} -> ${x}`:null,expected:x,answer:te,evalType:"text"}))},da=k=>{if(Pt(),!x)return;const D=ga(x,k,zt),i=xt(k)===xt(x),u=na(D),w=i||u,f=Ht(D);w?(de("correct"),ye({}),ze(!0),Te(D),Ue(0),f<100&&wt<=1&&$(!0),bt(!0,f/100),At({correct:!0,direction:"word->language",expected:x,answer:k,evalType:"language-select"})):(de("incorrect"),ye({}),ze(!1),Te(D),Ue(P=>{const p=P+1;return p>=wt&&Jt&&($(!0),ze(!0)),p}),bt(!1,f/100),At({correct:!1,direction:"word->language",expected:x,answer:k,evalType:"language-select"}))},Ca=k=>{var i;if(k.key!=="Enter")return;if(k.preventDefault(),k.stopPropagation(),ft){la();return}const D=Q.find(u=>!(Se[u.key]??"").trim());if(D){(i=vt.current[D.key])==null||i.focus();return}Sa()},Qa=()=>{Pt(),de("correct"),ze(!0),Ue(0),bt(!0,1),x&&At({correct:!0,direction:"manual",expected:x,answer:te,evalType:"manual"})},Wa=()=>{if(bt(!1,0),he&&he.cardType==="info"&&he.infoType==="quote"){de(null),ae(""),$(!1),ye({}),ze(!1),Te(null),Ue(0),ee(k=>Math.min(k+1,h.length));return}la()};a.useEffect(()=>{Pt()},[R,h]);const Ya=t.cogita.library.revision.revealModeAfterIncorrect,Jt=Q.length>0||!!x;return e.jsxs(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:g,secureMode:b,onNavigate:y,language:A,onLanguageChange:j,children:[(o==="loading"||z==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:o==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${G.total?Math.min(100,Math.max(0,G.current/G.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:G.total?`${Math.min(G.current,G.total)} / ${G.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:le}),e.jsx("p",{className:"cogita-library-subtitle",children:U}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",Ct).replace("{check}",$t)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:O?`${O.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Tt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Tt.currentLevel??"-"," / ",Tt.levelsCount]}):null,O?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(O.correct)).replace("{total}",String(O.total))}),O.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(O.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(tn,{outcomes:be})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[Ee?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:Ee})}):null,e.jsx("section",{className:"cogita-revision-card","data-feedback":Le?`${Le.kind}-${Le.tick}`:Vt?"idle":Pe??"idle",children:o!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:o==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):he?e.jsx(e.Fragment,{children:C?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(en,{copy:t,currentCard:he,currentTypeLabel:Ut,prompt:S,languages:_,answer:te,onAnswerChange:k=>ae(D=>Ba(D,k,I)),computedExpected:Q,computedAnswers:Se,onComputedAnswerChange:(k,D)=>we(i=>({...i,[k]:Ba(i[k]??"",D,I)})),answerTemplate:Ke,outputVariables:je,variableValues:tt,computedFieldFeedback:$e,feedback:Pe,canAdvance:ft,quoteContext:ue,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Sa,onSkip:Wa,onLanguageSelect:da,onMarkReviewed:Qa,onAdvance:la,showCorrectAnswer:ve,setShowCorrectAnswer:$,onRevealCorrect:()=>ze(!0),answerMask:Ae,expectedAnswer:x,hasExpectedAnswer:Jt,handleComputedKeyDown:Ca,answerInputRef:at,computedInputRefs:vt,scriptMode:I,setScriptMode:X,matchPairs:q==null?void 0:q.pairs,matchLeftOrder:q==null?void 0:q.leftOrder,matchRightOrder:q==null?void 0:q.rightOrder,matchSelection:q==null?void 0:q.selection,matchActiveLeft:q==null?void 0:q.activeLeft,matchActiveRight:q==null?void 0:q.activeRight,matchFeedback:De,onMatchLeftSelect:ka,onMatchRightSelect:Ta})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:sa?`${Rt} / ${sa}`:t.cogita.library.revision.progressUnlimited}),o==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),o==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),o==="ready"&&z==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),o==="ready"&&z==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),o==="ready"&&z==="ready"&&h.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Ya}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",wt]})]})]}),Tt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Tt.activeCount," / ",Tt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Tt.counts.map((k,D)=>{const i=D+1,u=Tt.currentLevel===i,w=Tt.percentages[D]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":u,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:i}),e.jsx("strong",{children:k})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,w))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[w.toFixed(1),"%"]})]},`level-${i}`)})})]}):null,ra?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:ra.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:ra.dots.map(k=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-k.value))}, ${Math.round(200*k.value)}, 80, 0.9)`}},k.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:ra.knownCount})]})]}):null,rt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Et})]})}):null]})]})]})})})]})]})}const Hi=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:qi},Symbol.toStringTag,{value:"Module"}));export{Ui as C,zi as a,Hi as b};
