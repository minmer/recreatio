import{r as a,j as e,u as mn,a as Ja,b as Hn,c as Wn,d as Qn,R as pn,B as fn,C as bn,Q as ur}from"./vendor-CAC2WLor.js";import{L as zs,A as Os,g as Vs,a as hr,b as Va,c as Gn,s as ls,d as Yn,e as gr,f as In,h as na,i as mr,j as pr,k as tn,l as an,m as qs,n as Xn,o as qn,p as fr,u as cs,q as Us,r as br,t as yr,v as xr,w as vr,x as jr,y as Js,z as wr,B as Hs,C as Ws,D as kr,E as Nr,F as yn,G as qa,H as Sr,I as Qs,J as Tr,K as Zn,M as Gs,N as Cr,O as Ir,P as Mr,Q as Un,R as ya,S as Lr,T as Ar,U as $r,V as Rr,W as Pr,X as Er,Y as Fr,Z as Kr,_ as _r,$ as Dr,a0 as Br,a1 as zr,a2 as Or,a3 as ds,a4 as Vr,a5 as qr,a6 as Ur,a7 as Jr,a8 as us,a9 as Hr,aa as Wr}from"./recreatio-core-B12ledQl.js";import"./vendor-cogita-ui-DTaQ_FiW.js";const Ba={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},Ka={moveMs:900,pauseMs:220,errorMs:900},Qr=(t=11)=>{let n=t;const r=()=>(n=(n*1664525+1013904223)%4294967296,n/4294967296),{width:s,height:o,paddingX:h,paddingY:c,levels:j}=Ba,p=(o-c*2)/(j.length-1),w=[],i=[],m=[];j.forEach((x,b)=>{const D=o-c-b*p,q=s-h*2,y=[];for(let W=0;W<x;W+=1){const N=h+(W+1)*q/(x+1),P=(r()-.5)*18,M=Math.max(h,Math.min(s-h,N+P)),T=b===0?3:b<2?2.1:1.4,Q=b===0?"root":`l${b}-${W}`;y.push({id:Q,x:b===0?s/2:M,y:D,r:T,level:b,role:b===0?"root":void 0})}m.push(y),w.push(...y)});const l=m[m.length-1];if(l!=null&&l.length){const x=l[Math.floor(l.length/2)];x.role="goal",x.r=2}for(let x=1;x<m.length;x+=1){const b=m[x-1];m[x].forEach(q=>{const y=[...b].sort((M,T)=>Math.abs(M.x-q.x)-Math.abs(T.x-q.x)),W=y[0],N=y[1]&&r()<.45?y[1]:null;(N?[W,N]:[W]).forEach(M=>{i.push({from:M.id,to:q.id,key:`${M.id}-${q.id}`})}),r()<.2&&y[2]&&i.push({from:y[2].id,to:q.id,key:`${y[2].id}-${q.id}`})})}const d=new Map;i.forEach(x=>{const b=d.get(x.to)??[];b.push(x.from),d.set(x.to,b)});const v=new Map,g=new Map,S=new Map;i.forEach(x=>{const b=v.get(x.from)??[];b.push(x.key),v.set(x.from,b);const D=g.get(x.from)??[];D.push(x.to),g.set(x.from,D);const q=S.get(x.from)??[];q.push(x.to),S.set(x.from,q);const y=S.get(x.to)??[];y.push(x.from),S.set(x.to,y)});const V=new Map;return w.forEach(x=>{V.set(x.id,x)}),{nodes:w,links:i,parentsById:d,linksByFrom:v,childrenByFrom:g,neighborsById:S,nodesById:V}};function Gr({slides:t,activeIndex:n,introOpen:r,prefersReducedMotion:s,onNext:o,onPrev:h,onSelect:c,onExit:j,onOpen:p,onRegister:w}){const i=n===t.length-1,m=r&&n===0?"entry":"docked",l=t[t.length-1],[d,v]=a.useState(!1),g=a.useMemo(()=>Array.from({length:20},(B,F)=>({src:`/cogita/logo/Cogita${String(F).padStart(2,"0")}.png`,kind:F<=11?"bubble":F<=17?"text":"recreatio"})),[]),S=r&&n===0;a.useEffect(()=>{if(!r){v(!1);return}n>0&&!d&&v(!0)},[n,r,d]);const V=a.useRef(0),x=a.useRef(null),b=a.useMemo(()=>{const B={x:40,y:160},F={x:260,y:48},k=6,C=F.x-B.x,A=B.y-F.y,ue=C/k,be=[.3,.45,.6,.65,1.4,2.2],he=be.reduce((G,te)=>G+te,0),ee=be.map(G=>A*G/he),E=[B];let X=B.x,re=B.y;for(let G=1;G<=k;G+=1){const te=(Math.random()-.5)*14,xe=(Math.random()-.5)*28;X=Math.max(B.x+G*14,Math.min(F.x-(k-G)*14,X+ue+te));const U=ee[G-1]??ee[ee.length-1];re=re-U+xe;const ie=Math.max(F.y,Math.min(B.y-4,re));E.push({x:Math.round(X),y:Math.round(ie)})}return E[E.length-1]=F,E},[]),D=a.useMemo(()=>{const A=(he,ee,E)=>Math.min(E,Math.max(ee,he)),ue=b.map(he=>{const ee=10+Math.random()*36;return{x:A(he.x,40,260),y:A(he.y-ee,40,140)}}),be=b.map((he,ee)=>{var re;const E=12+Math.random()*40,X=((re=ue[ee])==null?void 0:re.y)??he.y;return{x:A(he.x,40,260),y:A(Math.max(X+10,he.y+E),60,170)}});return{upper:ue,lower:be}},[b]),q=a.useMemo(()=>{var F;const B=((F=b[4])==null?void 0:F.x)??260;return Math.max(0,Math.min(240,B-40))},[b]),y=a.useMemo(()=>{var ee,E;const B=(X,re,G)=>Math.min(G,Math.max(re,X)),F=(X,re,G)=>b.map((te,xe)=>{var bt,mt;const U=((bt=D.upper[xe])==null?void 0:bt.y)??te.y,ie=((mt=D.lower[xe])==null?void 0:mt.y)??te.y,Le=(Math.random()-.5)*70,qe=te.y+X+Le,Ke=B(te.y+re,U+6,ie-6),Je=B(te.y+G,U+6,ie-6);return{x:te.x,y:B(qe,Math.min(Ke,Je),Math.max(Ke,Je))}}),k=-14+Math.random()*28,C=14+Math.random()*28,A=F(k,-80,12),ue=F(C,-12,80);for(let X=4;X<b.length;X+=1){const re=b[X],G=((ee=D.upper[X])==null?void 0:ee.y)??re.y,te=((E=D.lower[X])==null?void 0:E.y)??re.y;A[X]={x:re.x,y:B(re.y-12,G+6,te-6)},ue[X]={x:re.x,y:B(re.y+12,G+6,te-6)}}const be=D.upper.length?D.upper[D.upper.length-1].y:40,he=D.lower.length?D.lower[D.lower.length-1].y:170;return A[A.length-1]={x:b[b.length-1].x,y:B(b[b.length-1].y-14,be,he)},ue[ue.length-1]={x:b[b.length-1].x,y:B(b[b.length-1].y+12,be,he)},{higher:A,lower:ue}},[b,D]),W=1e4,N=a.useMemo(()=>{let B=17;const F=()=>(B=(B*1664525+1013904223)%4294967296,B/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((C,A)=>{const ue=(F()-.5)*240,be=(F()-.5)*180,he=(F()-.5)*24;return{id:`card-${A+1}`,throw:{x:`${ue.toFixed(0)}px`,y:`${be.toFixed(0)}px`,rot:`${he.toFixed(1)}deg`},grid:{x:`${C.x}px`,y:`${C.y}px`},delay:`${A*.12}s`}})},[]),P=a.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[M,T]=a.useState([]),Q=a.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),ge=a.useMemo(()=>{const F=[],C=(ue,be)=>ue+Math.random()*(be-ue);for(let ue=0;ue<6;ue+=1){let be=!1;for(let he=0;he<80;he+=1){const ee=C(14,86),E=C(10,34);if(F.every(re=>{const G=re.x-ee,te=re.y-E;return Math.hypot(G,te)>=12})){F.push({x:ee,y:E}),be=!0;break}}be||F.push({x:C(16,84),y:C(12,32)})}return F.map((ue,be)=>({id:`p${be+1}`,x:`${ue.x.toFixed(1)}%`,y:`${ue.y.toFixed(1)}%`,xNum:ue.x,yNum:ue.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[ye,Oe]=a.useState(0),[R,I]=a.useState(0),[Z,_]=a.useState([]),ae=1e4,Y=a.useMemo(()=>{if(ge.length<2)return[];const B=be=>{let he=be+1831565813;return he=Math.imul(he^he>>>15,he|1),he^=he+Math.imul(he^he>>>7,he|61),((he^he>>>14)>>>0)/4294967296},F=(be,he)=>Math.floor(B(be)*he),k=new Set,C=[],A=Math.min(3,ge.length);let ue=0;for(;C.length<A&&ue<30;){ue+=1;const be=F(ye*13+ue*5,ge.length),he=F(ye*29+ue*7,ge.length);if(be===he)continue;const ee=be<he?`${be}-${he}`:`${he}-${be}`;k.has(ee)||(k.add(ee),C.push({id:`link-${ee}`,from:ge[be],to:ge[he],delay:`${(ue*.35).toFixed(2)}s`}))}return C},[ye,ge]);a.useEffect(()=>{if(!r||n!==2)return;const B=()=>{const k=N.map(C=>C.id);for(let C=k.length-1;C>0;C-=1){const A=Math.floor(Math.random()*(C+1));[k[C],k[A]]=[k[A],k[C]]}return k.slice(0,4)};T(B());const F=window.setInterval(()=>{T(B())},W);return()=>window.clearInterval(F)},[n,r,N,W]),a.useEffect(()=>{if(!r||n!==3)return;const B=()=>{I(Math.floor(Math.random()*Q.length)),_(ge.map(()=>Math.random()<.6?"good":"bad")),Oe(k=>k+1)};B();const F=window.setInterval(B,ae);return()=>window.clearInterval(F)},[n,r,Q.length,ge,ae]);const ve=a.useMemo(()=>Qr(11),[]),[le,se]=a.useState(new Set(["root"])),[Te,Ae]=a.useState(new Set),[Ee,$e]=a.useState(new Set),[et,ct]=a.useState({fromId:"root",toId:"root",key:0}),Ce=a.useRef(le),We=a.useRef("root"),xt=a.useRef(0),Ve=a.useRef(null),De=a.useRef(null),tt=a.useRef([]);a.useEffect(()=>{Ce.current=le},[le]);const ot=a.useMemo(()=>{const B=new Set;return le.forEach(F=>{const k=ve.linksByFrom.get(F);k&&k.forEach(C=>B.add(C))}),B},[le,ve]),Ye=ve.nodesById.get(et.toId)??ve.nodesById.get("root"),Ie=Ye?`${Ye.x/Ba.width*100}%`:"50%",Be=Ye?`${Ye.y/Ba.height*100}%`:"90%";a.useEffect(()=>{if(!r||n!==1||s)return;(()=>{se(new Set(["root"])),Ae(new Set),$e(new Set),ct({fromId:"root",toId:"root",key:0}),De.current=null,xt.current=0,We.current="root",tt.current=[]})();const F=()=>{const C=We.current,A=Ce.current,be=(ve.childrenByFrom.get(C)??[]).filter(te=>!A.has(te));if(be.length)return be[Math.floor(Math.random()*be.length)];if(A.size>=ve.nodes.length){const te=ve.neighborsById.get(C)??[];return te.length?te[Math.floor(Math.random()*te.length)]:null}const he=te=>(ve.childrenByFrom.get(te)??[]).some(U=>!A.has(U)),ee=[C],E=new Set([C]),X=new Map;let re=null;for(;ee.length;){const te=ee.shift();if(!te)break;if(te!==C&&he(te)){re=te;break}(ve.neighborsById.get(te)??[]).forEach(U=>{E.has(U)||(E.add(U),X.set(U,te),ee.push(U))})}if(!re)return null;let G=re;for(;X.get(G)&&X.get(G)!==C;)G=X.get(G)??G;return G},k=(C,A)=>{if(C===A){const ue=F();ue&&k(C,ue);return}xt.current+=1,ct({fromId:C,toId:A,key:xt.current}),We.current=A,Ve.current=window.setTimeout(()=>{const ue=ve.parentsById.get(A)??[],be=Ce.current,he=ue.filter(re=>!be.has(re));if(!he.length){const re=new Set(be);re.add(A),se(re),Ve.current=window.setTimeout(()=>{for(;tt.current.length;){const te=tt.current[tt.current.length-1];if(!re.has(te)){if(te!==A){k(A,te);return}break}tt.current.pop()}const G=F();G&&k(A,G)},Ka.pauseMs);return}const ee=new Set([A,...he]),E=new Set(he.map(re=>`${re}-${A}`));Ae(ee),$e(E),tt.current.includes(A)||tt.current.push(A);const X=he[Math.floor(Math.random()*he.length)];De.current={fromId:A,toId:X},Ve.current=window.setTimeout(()=>{Ae(new Set),$e(new Set);const re=De.current;re&&k(re.fromId,re.toId)},Ka.errorMs)},Ka.moveMs)};return Ve.current=window.setTimeout(()=>{const C=F();C&&k(We.current,C)},Ka.pauseMs),()=>{Ve.current&&window.clearTimeout(Ve.current)}},[n,r,ve,s]);const Xe=B=>{if(!r)return;const F=Date.now();F-V.current<520||Math.abs(B.deltaY)<10||(V.current=F,B.deltaY>0?o():h(),B.preventDefault())},K=B=>{if(!r)return;const F=B.touches[0];F&&(x.current={x:F.clientX,y:F.clientY})},$=B=>{if(!r)return;const F=x.current;if(x.current=null,!F)return;const k=B.changedTouches[0];if(!k)return;const C=k.clientX-F.x,A=k.clientY-F.y;Math.abs(A)<40||Math.abs(A)<Math.abs(C)||(A<0?o():h())};return e.jsxs("div",{className:`cogita-intro ${r?"is-open":"is-closed"} ${s?"is-reduced":""} ${i?"is-final":""}`,"data-slide":n+1,onWheel:Xe,onTouchStart:K,onTouchEnd:$,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":m,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${S&&!d?"is-entry":""}`,children:g.map((B,F)=>e.jsx("img",{src:B.src,alt:"",className:`cogita-logo-layer ${F===0?"is-base":""} ${B.kind==="text"?"is-text":B.kind==="recreatio"?"is-recreatio":""} ${B.kind==="bubble"?"is-bubble":""}`},B.src))})}),r&&t.map((B,F)=>{const k=F===n;return e.jsxs("section",{className:`cogita-intro-slide slide-${F+1} ${k?"is-active":""}`,"aria-hidden":!k,children:[e.jsxs("div",{className:"cogita-intro-text",children:[B.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:B.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:B.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:B.title}),B.body&&e.jsx("p",{children:B.body.split(`
`).map((C,A)=>e.jsxs("span",{children:[C,A===0&&e.jsx("br",{})]},String(A)))})]}),B.micro&&e.jsx("p",{className:"cogita-intro-micro",children:B.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:i?w:o,children:B.cta}),i&&B.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>c(0),children:B.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[F===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${Ba.width} ${Ba.height}`,preserveAspectRatio:"none",children:[ve.links.map(C=>{const A=ve.nodesById.get(C.from),ue=ve.nodesById.get(C.to);if(!A||!ue)return null;const be=ot.has(C.key),he=Ee.has(C.key);return e.jsx("line",{className:`map-link ${be?"is-active":""} ${he?"is-error":""}`,x1:A.x,y1:A.y,x2:ue.x,y2:ue.y},C.key)}),ve.nodes.map(C=>{const A=le.has(C.id),ue=Te.has(C.id);return e.jsx("circle",{className:`map-node ${C.role?`is-${C.role}`:""} ${A?"is-active":""} ${ue?"is-error":""}`,cx:C.x,cy:C.y,r:C.r},C.id)})]}),Ye&&e.jsx("span",{className:"map-explorer-dot",style:{left:Ie,top:Be,"--move":`${Ka.moveMs}ms`}})]}),F===2&&e.jsx("div",{className:"cogita-index-cards",children:N.map(C=>{const A=M.indexOf(C.id),ue=A>=0?P[A]:null,be=(ue==null?void 0:ue.x)??"140px",he=(ue==null?void 0:ue.y)??"140px",ee=A>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":C.throw.x,"--throw-y":C.throw.y,"--throw-rot":C.throw.rot,"--grid-x":C.grid.x,"--grid-y":C.grid.y,"--stack-x":be,"--stack-y":he,"--stack-opacity":ee,"--delay":C.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},C.id)})}),F===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[Q.map((C,A)=>e.jsxs("div",{className:`round-card ${A===R?"is-active":""}`,style:{"--card-x":C.x,"--card-y":C.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},C.id)),Q[R]&&e.jsx("span",{className:"round-ring",style:{"--card-x":Q[R].x,"--card-y":`calc(${Q[R].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:ge.map(C=>e.jsx("span",{className:"player-dot",style:{left:C.x,top:C.y,"--jitter-x":C.jitterX,"--jitter-y":C.jitterY,"--breath-delay":C.delay}},C.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:Y.map(C=>e.jsx("line",{className:"round-link",x1:C.from.xNum,y1:C.from.yNum,x2:C.to.xNum,y2:C.to.yNum,style:{"--delay":C.delay}},C.id))}),e.jsx("div",{className:"round-flows",children:ge.map((C,A)=>{const ue=Z[A]??"good",be=Q[R];if(!be)return null;const he=`calc(${be.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":C.x,"--from-y":C.y,"--to-x":be.x,"--to-y":he,"--delay":`${A*.12}s`}}),e.jsx("span",{className:`return-dot is-${ue}`,style:{"--from-x":be.x,"--from-y":he,"--to-x":C.x,"--to-y":C.y,"--delay":`${A*.12}s`}}),e.jsx("span",{className:`result-pop is-${ue}`,style:{"--at-x":C.x,"--at-y":C.y,"--delay":`${A*.12}s`}})]},`${C.id}-${ye}`)})})]},`round-${ye}`),F===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${b[0].x} ${b[0].y} L${b[1].x} ${b[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${b[1].x} ${b[1].y} L${b[2].x} ${b[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${b[2].x} ${b[2].y} L${b[3].x} ${b[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${b[3].x} ${b[3].y} L${b[4].x} ${b[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${b[4].x} ${b[4].y} L${b[5].x} ${b[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${b[5].x} ${b[5].y} L${b[6].x} ${b[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${q};${q};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${D.upper.map((C,A)=>`${A===0?"M":"L"}${C.x} ${C.y}`).join(" ")} ${D.lower.slice().reverse().map(C=>`L${C.x} ${C.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${D.upper.map((C,A)=>`${A===0?"M":"L"}${C.x} ${C.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${D.lower.map((C,A)=>`${A===0?"M":"L"}${C.x} ${C.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[y.higher.slice(0,6).map((C,A)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${A+1}`,d:`M${C.x} ${C.y} L${y.higher[A+1].x} ${y.higher[A+1].y}`,pathLength:"100"},`peer-1-${A}`)),y.lower.slice(0,6).map((C,A)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${A+1}`,d:`M${C.x} ${C.y} L${y.lower[A+1].x} ${y.lower[A+1].y}`,pathLength:"100"},`peer-2-${A}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${b[0].x/300*100}%`,"--p0y":`${b[0].y/200*100}%`,"--p1x":`${b[1].x/300*100}%`,"--p1y":`${b[1].y/200*100}%`,"--p2x":`${b[2].x/300*100}%`,"--p2y":`${b[2].y/200*100}%`,"--p3x":`${b[3].x/300*100}%`,"--p3y":`${b[3].y/200*100}%`,"--p4x":`${b[4].x/300*100}%`,"--p4y":`${b[4].y/200*100}%`,"--p5x":`${b[5].x/300*100}%`,"--p5y":`${b[5].y/200*100}%`,"--p6x":`${b[6].x/300*100}%`,"--p6y":`${b[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${y.higher[0].x/300*100}%`,"--q0y":`${y.higher[0].y/200*100}%`,"--q1x":`${y.higher[1].x/300*100}%`,"--q1y":`${y.higher[1].y/200*100}%`,"--q2x":`${y.higher[2].x/300*100}%`,"--q2y":`${y.higher[2].y/200*100}%`,"--q3x":`${y.higher[3].x/300*100}%`,"--q3y":`${y.higher[3].y/200*100}%`,"--q4x":`${y.higher[4].x/300*100}%`,"--q4y":`${y.higher[4].y/200*100}%`,"--q5x":`${y.higher[5].x/300*100}%`,"--q5y":`${y.higher[5].y/200*100}%`,"--q6x":`${y.higher[6].x/300*100}%`,"--q6y":`${y.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${y.lower[0].x/300*100}%`,"--q0y":`${y.lower[0].y/200*100}%`,"--q1x":`${y.lower[1].x/300*100}%`,"--q1y":`${y.lower[1].y/200*100}%`,"--q2x":`${y.lower[2].x/300*100}%`,"--q2y":`${y.lower[2].y/200*100}%`,"--q3x":`${y.lower[3].x/300*100}%`,"--q3y":`${y.lower[3].y/200*100}%`,"--q4x":`${y.lower[4].x/300*100}%`,"--q4y":`${y.lower[4].y/200*100}%`,"--q5x":`${y.lower[5].x/300*100}%`,"--q5y":`${y.lower[5].y/200*100}%`,"--q6x":`${y.lower[6].x/300*100}%`,"--q6y":`${y.lower[6].y/200*100}%`}})]})})}),F===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),F===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},B.id)}),!r&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:l.title}),l.body&&e.jsx("p",{children:l.body}),l.micro&&e.jsx("p",{className:"cogita-intro-micro",children:l.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:w,children:l.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:p,children:"Otwórz pokaz"})]})]})})]}),r&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((B,F)=>e.jsx("button",{type:"button",className:`dot ${n===F?"active":""}`,"aria-label":B.title,onClick:()=>c(F)},B.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:j,children:"Pomiń"})]})]})}const Yr=6,Xr=4;function Zr({copy:t,onAuthAction:n,authLabel:r,showProfileMenu:s,onProfileNavigate:o,onToggleSecureMode:h,onLogout:c,secureMode:j,onNavigate:p,language:w,onLanguageChange:i}){const m=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}p("home")},l=a.useRef(null),d=a.useRef([]),v=a.useMemo(()=>{let _=Date.now()%2147483647;const ae=()=>(_=_*48271%2147483647,_/2147483647);return Array.from({length:Yr},(Y,ve)=>{const le=6+ae()*8,se=7+ae()*10,Te=6+ae()*9,Ae=-ae()*le,Ee=-ae()*se,$e=-ae()*Te,et=.18+ae()*.28,ct=12+ae()*18,Ce=4+ae()*8,We=(ae()-.5)*3.2,xt=(ae()-.5)*3.8,Ve=ae()>.5?"alternate":"alternate-reverse",De=ae()>.5?"alternate":"alternate-reverse",tt=ae()>.5?"alternate":"alternate-reverse",ot=.18+ae()*.42,Ye=30+ae()*60,Ie=-45-ae()*38,Be=188+ae()*32,Xe=.1+ae()*.2;return{id:`wave-${ve+1}`,style:{"--wave-sway-duration":`${le}s`,"--wave-scale-duration":`${se}s`,"--wave-drift-duration":`${Te}s`,"--wave-sway-delay":`${Ae}s`,"--wave-scale-delay":`${Ee}s`,"--wave-drift-delay":`${$e}s`,"--wave-sway-dir":Ve,"--wave-scale-dir":De,"--wave-drift-dir":tt,"--wave-scale":`${et}`,"--wave-shift":`${ct}%`,"--wave-xshift":`${Ce}%`,"--wave-x0":`${We}%`,"--wave-y0":`${xt}%`,"--wave-opacity":`${ot}`,"--wave-blur":`${Ye}px`,"--wave-bottom":`${Ie}%`,"--wave-hue":`${Be}`,"--wave-glow":`${Xe}`}}})},[]),g=a.useMemo(()=>{let _=Date.now()*3%2147483647;const ae=()=>(_=_*48271%2147483647,_/2147483647);return Array.from({length:Xr},(Y,ve)=>{const le=180+ae()*220,se=220+ae()*280,Te=-ae()*le,Ae=-ae()*se,Ee=.12+ae()*.22,$e=3+ae()*7,et=1+ae()*3,ct=(ae()-.5)*2.8,Ce=(ae()-.5)*2.2;return{id:`mesh-${ve+1}`,seed:1e3+ve*991+Math.floor(ae()*999),style:{"--mesh-sway-duration":`${le}s`,"--mesh-drift-duration":`${se}s`,"--mesh-sway-delay":`${Te}s`,"--mesh-drift-delay":`${Ae}s`,"--mesh-scale":`${Ee}`,"--mesh-shift":`${$e}%`,"--mesh-xshift":`${et}%`,"--mesh-x0":`${Ce}%`,"--mesh-y0":`${ct}%`}}})},[]),S=a.useMemo(()=>{const _=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],ae=t.cogita.introSlides,Y=new Map(ae.map(ve=>[ve.id,ve]));return _.map(ve=>{var se;const le=Y.get(ve.id);return{...ve,...le,title:(le==null?void 0:le.title)??"Cogita",cta:(le==null?void 0:le.cta)??((se=t.cogita.introSlides[0])==null?void 0:se.cta)??t.cogita.loginCta,secondary:le==null?void 0:le.secondary}})},[t.cogita.introSlides]),[V,x]=a.useState(0),[b,D]=a.useState(!0),[q,y]=a.useState(!1),W=S.length-1,N=a.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),P=a.useCallback(()=>{N(),n()},[N,n]),M=a.useCallback(()=>{D(!0),x(0)},[]),T=a.useCallback(()=>{D(!1),x(W)},[W]),Q=a.useCallback(_=>{x(Math.max(0,Math.min(W,_)))},[W]),ge=a.useCallback(()=>{V>=W?P():Q(V+1)},[V,Q,P,W]),ye=a.useCallback(()=>{Q(V-1)},[V,Q]);a.useEffect(()=>{var Y;const _=(Y=window.matchMedia)==null?void 0:Y.call(window,"(prefers-reduced-motion: reduce)");if(!_)return;const ae=()=>y(_.matches);return ae(),_.addEventListener?(_.addEventListener("change",ae),()=>_.removeEventListener("change",ae)):(_.addListener(ae),()=>_.removeListener(ae))},[]),a.useEffect(()=>{if(!b)return;const _=ae=>{const Y=ae.target;if(!Y)return;const ve=Y.tagName;if(!(Y.isContentEditable||ve==="INPUT"||ve==="TEXTAREA"||ve==="SELECT"||ve==="BUTTON"||ve==="A"||Y.closest('button, a, [role="button"], [role="link"]'))){if(ae.key==="Escape"){T();return}if(ae.key==="ArrowLeft"||ae.key==="ArrowUp"){ye();return}(ae.key==="ArrowRight"||ae.key==="ArrowDown"||ae.code==="Space"||ae.key===" ")&&(ae.preventDefault(),ge())}};return window.addEventListener("keydown",_),()=>window.removeEventListener("keydown",_)},[T,ge,ye,b]),a.useEffect(()=>{b&&V===W&&N()},[V,b,W,N]),a.useEffect(()=>{const _=l.current;if(!_)return;const ae=d.current.filter(Ie=>!!Ie);if(!ae.length)return;const Y=1,ve=.6,le=.6,se=Math.max(1,Math.min(Y,window.devicePixelRatio||1));let Te=0,Ae=0,Ee=ve,$e=0,et=0;const ct=Ie=>{let Be=Ie%2147483647;return Be<=0&&(Be+=2147483646),(Xe,K)=>{Be=Be*48271%2147483647;const $=Be/2147483647;return Xe+$*(K-Xe)}},Ce={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},We=Ie=>{const Be=Math.sin(Ie*12.9898)*43758.5453;return Be-Math.floor(Be)},xt=Ie=>{const Be=We(Ie+.1)||1e-4,Xe=We(Ie+.7)||1e-4;return Math.sqrt(-2*Math.log(Be))*Math.cos(2*Math.PI*Xe)},Ve=(Ie,Be)=>{const Xe=Math.floor(Ie),K=Xe+1,$=Ie-Xe,B=$*$*(3-2*$),F=We(Xe*12.9898+Be*78.233),k=We(K*12.9898+Be*78.233);return F+(k-F)*B},De=Ie=>{const Be=ct(Ie),Xe=Math.min(4,Math.max(4,Math.floor(Te/1200*Ce.filamentCount)));return Array.from({length:Xe},(K,$)=>{const B=Math.max(-1,Math.min(1,xt(Ie+$*.37))),F=Math.min(1,Math.max(0,We(Ie+$*1.31))),k=Math.min(Ce.depthLayers-1,Math.floor(F*Ce.depthLayers));return{seed:Be(0,Math.PI*2)+Ie*.01,offset:B,freqA:Ce.freq1*(.75+Be(0,.5)),freqB:Ce.freq2*(.75+Be(0,.5)),ampA:Ce.amp1*(.6+Be(0,.7)),ampB:Ce.amp2*(.6+Be(0,.7)),width:2+$%5*.32,depth:F,layer:k}})},tt=(Ie,Be,Xe)=>{const K=Math.max(30,Math.floor(Te*Ae/14e4));Ie.save(),Ie.globalAlpha=.6;for(let $=0;$<K;$+=1){const B=We($*9.1+Te*.11)*Be+Xe,F=We($*3.7+Ae*.23)*Ae,k=1.2+We($*5.9)*2.4,C=Ie.createRadialGradient(B,F,0,B,F,k*2);C.addColorStop(0,"rgba(10, 30, 60, 0.45)"),C.addColorStop(1,"rgba(10, 30, 60, 0)"),Ie.fillStyle=C,Ie.beginPath(),Ie.arc(B,F,k*2,0,Math.PI*2),Ie.fill()}Ie.restore()},ot=(Ie,Be)=>{Ie.clearRect(0,0,Te,Ae);const Xe=Ae*Ce.waveCenter,K=Ce.waveBandPx,$=Ce.segments,B=Ce.colors.filaments,F=$e||Te,k=0;tt(Ie,F,k),Ie.strokeStyle=B,Ie.lineCap="round",Ie.lineJoin="round";for(let C=0;C<Be.length;C+=1){const A=Be[C],ue=A.offset*K*(.85+We(A.seed)*.4),be=1-Math.min(1,Math.abs(ue)/K),he=Math.exp(-Math.pow(ue/Ce.crestThickness,2)),ee=A.layer===0?1.1:A.layer===1?.85:.6,E=.35+(1-A.depth)*.65,X=be*E*ee*(.34+he*.45);Ie.globalAlpha=X,Ie.lineWidth=A.width*(1+(1-A.depth)*.8);const re=[];for(let te=0;te<=$;te+=1){const xe=te/$*F+k,U=(Ve(xe*.012,A.seed)-.5)*Ce.xJitter,ie=xe+U,Le=(Ve(ie*A.freqA,A.seed)-.5)*Ce.jitterA,qe=(Ve(ie*A.freqB,A.seed*1.7)-.5)*Ce.jitterB,Ke=Xe+Math.sin(ie*A.freqA+A.seed)*A.ampA+Math.sin(ie*A.freqB+A.seed*1.3)*A.ampB+ue+Le+qe;re.push({x:ie,y:Ke})}Ie.beginPath(),Ie.moveTo(re[0].x,re[0].y);for(let te=1;te<re.length-1;te+=1){const xe=(re[te].x+re[te+1].x)/2,U=(re[te].y+re[te+1].y)/2;Ie.quadraticCurveTo(re[te].x,re[te].y,xe,U)}const G=re[re.length-1];Ie.quadraticCurveTo(G.x,G.y,G.x,G.y),Ie.stroke()}Ie.save(),Ie.globalCompositeOperation="lighter",Ie.strokeStyle=Ce.colors.glow,Ie.lineCap="round",Ie.lineJoin="round";for(let C=0;C<Be.length;C+=1){const A=Be[C];if(Math.abs(A.offset)*K>Ce.crestThickness)continue;const ue=Ce.glowAlpha*(.7+(1-A.depth)*.6);Ie.globalAlpha=ue,Ie.lineWidth=1.6+(1-A.depth)*1.2;const be=[];for(let ee=0;ee<=$;ee+=1){const E=ee/$*F+k,X=Math.sin(E*.02+A.seed)*3,re=Xe+Math.sin(E*A.freqA+A.seed)*A.ampA+Math.sin(E*A.freqB+A.seed*1.3)*A.ampB+A.offset*K*.35+X;be.push({x:E,y:re})}Ie.beginPath(),Ie.moveTo(be[0].x,be[0].y);for(let ee=1;ee<be.length-1;ee+=1){const E=(be[ee].x+be[ee+1].x)/2,X=(be[ee].y+be[ee+1].y)/2;Ie.quadraticCurveTo(be[ee].x,be[ee].y,E,X)}const he=be[be.length-1];Ie.quadraticCurveTo(he.x,he.y,he.x,he.y),Ie.stroke()}Ie.restore()},Ye=()=>{Te=Math.floor(_.clientWidth),Ae=Math.floor(_.clientHeight),$e=Math.floor(Te*1.8),et=Ae,Ee=Te<820?le:ve,ae.forEach(Ie=>{const Be=Ie.getContext("2d");if(!Be)return;Ie.width=Math.floor($e*se*Ee),Ie.height=Math.floor(et*se*Ee),Ie.style.width=`${$e}px`,Ie.style.height=`${et}px`,Ie.style.left=`${-($e-Te)/2}px`,Be.setTransform(se*Ee,0,0,se*Ee,0,0);const Xe=Number(Ie.dataset.seed||1),K=De(Xe);ot(Be,K)})};return Ye(),window.addEventListener("resize",Ye,{passive:!0}),()=>window.removeEventListener("resize",Ye)},[g]);const Oe=S[Math.min(V,S.length-1)],R=b?Oe:S[S.length-1],I=(R==null?void 0:R.theme)??S[0].theme,Z={"--cogita-bg0":I.bg0,"--cogita-bg1":I.bg1,"--cogita-bg2":I.bg2,"--cogita-bloom":I.bloom,"--cogita-sat":I.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:m,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(zs,{value:w,onChange:i}),e.jsx(Os,{copy:t,label:r,isAuthenticated:s,secureMode:j,onLogin:n,onProfileNavigate:o,onToggleSecureMode:h,onLogout:c,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:l,className:"cogita-section cogita-home",style:Z,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[g.map((_,ae)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:_.style,"data-seed":_.seed,ref:Y=>{d.current[ae]=Y}},_.id)),v.map(_=>e.jsx("div",{className:"cogita-home-wave",style:_.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},_.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(Gr,{slides:S,activeIndex:V,introOpen:b,prefersReducedMotion:q,onNext:ge,onPrev:ye,onSelect:Q,onExit:T,onOpen:M,onRegister:P})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const Mo=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:Zr},Symbol.toStringTag,{value:"Module"})),Ys=a.createContext(!1);function Pt({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,headerExtra:i,children:m}){if(a.useContext(Ys))return e.jsx(e.Fragment,{children:m});const d=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}j("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:d,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(zs,{value:p,onChange:w}),e.jsxs("div",{className:"cogita-header-right",children:[i,e.jsx(Os,{copy:t,label:n,isAuthenticated:r,secureMode:c,onLogin:()=>j("home"),onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:m}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function da(t){const[n,r]=a.useState("Cogita library"),[s,o]=a.useState(null);return a.useEffect(()=>{let h=!1;return Vs().then(c=>{if(h)return;const j=c.find(p=>p.libraryId===t);j&&r(j.name)}).catch(()=>{h||r("Cogita library")}),()=>{h=!0}},[t]),a.useEffect(()=>{let h=!1;return hr(t).then(c=>{h||o(c)}).catch(()=>{h||o(null)}),()=>{h=!0}},[t]),{libraryName:n,stats:s}}function hs({slices:t}){const n=t.reduce((s,o)=>s+Math.max(0,o.value),0),r=a.useMemo(()=>{if(n<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let s=0;return`conic-gradient(${t.map(h=>{const j=Math.max(0,h.value)/n*360,p=s,w=s+j;return s=w,`${h.color} ${p}deg ${w}deg`}).join(",")})`},[t,n]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:r}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(s=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:s.color}}),e.jsx("strong",{children:s.value}),e.jsx("small",{children:s.label})]},s.label))})]})}function ei({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,libraryId:i}){const{libraryName:m,stats:l}=da(i),[d,v]=a.useState("infos"),[g,S]=a.useState(0),[V,x]=a.useState(0),[b,D]=a.useState(0),q=(l==null?void 0:l.totalInfos)??0,y=(l==null?void 0:l.totalCollections)??0,W=0,N=0,P=0,M=Math.max(0,q-P-V),T=Math.max(0,q-V-b);a.useEffect(()=>{let ge=!1;return(async()=>{try{const Oe=await Va({libraryId:i,limit:200}),R=await Promise.all(Oe.items.map(I=>Gn({libraryId:i,collectionId:I.collectionId}).catch(()=>[])));if(ge)return;S(R.reduce((I,Z)=>I+Z.length,0))}catch{ge||S(0)}})(),()=>{ge=!0}},[i]),a.useEffect(()=>{let ge=!1;return(async()=>{try{const[Oe,R,I]=await Promise.all([ls({libraryId:i,type:"computed",limit:1}).catch(()=>({total:0})),ls({libraryId:i,type:"source",limit:1}).catch(()=>({total:0})),Yn({libraryId:i}).catch(()=>({items:[]}))]);if(ge)return;x((Oe.total??0)+(R.total??0));const Z=new Set(I.items.filter(_=>_.childItemType.toLowerCase()==="info").map(_=>_.childItemId).filter(Boolean));D(Z.size)}catch{ge||(x(0),D(0))}})(),()=>{ge=!0}},[i]);const Q=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:q},{key:"collections",label:t.cogita.library.overview.stats.collections,value:y},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:g},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:W},{key:"texts",label:t.cogita.library.overview.stats.texts,value:N}];return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:m})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:Q.map(ge=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${d===ge.key?"active":""}`,onClick:()=>v(ge.key),children:[e.jsx("span",{children:ge.label}),e.jsx("strong",{children:ge.value})]},ge.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),d==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(hs,{slices:[{label:t.cogita.library.overview.known,value:P,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:M,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:V,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(hs,{slices:[{label:t.cogita.library.overview.availableChecks,value:b,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:T,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const nt=(t,n)=>{const r=t.cogita.library.infoTypes,s=t.cogita.library.connectionTypes,o=t.cogita.library.groupTypes;return{any:r.any,vocab:r.vocab,book:o.book,citation:o.citation,language:r.language,word:r.word,sentence:r.sentence,topic:r.topic,collection:r.collection,person:r.person,institution:r.institution,collective:r.collective,orcid:r.orcid,address:r.address,email:r.email,phone:r.phone,media:r.media,work:r.work,geo:r.geo,music_piece:r.musicPiece,music_fragment:r.musicFragment,source:r.source,question:r.question,computed:r.computed,"word-language":s.wordLanguage,"citation-language":s.citationLanguage,"language-sentence":s.languageSentence,translation:s.translation,"word-topic":s.wordTopic,reference:s.reference,"source-resource":s.sourceResource,"work-contributor":s.workContributor,"work-medium":s.workMedium,"orcid-link":s.orcidLink}[n]??String(n)},ti=t=>[{value:"any",label:nt(t,"any")},{value:"language",label:nt(t,"language")},{value:"word",label:nt(t,"word")},{value:"sentence",label:nt(t,"sentence")},{value:"topic",label:nt(t,"topic")},{value:"collection",label:nt(t,"collection")},{value:"person",label:nt(t,"person")},{value:"institution",label:nt(t,"institution")},{value:"collective",label:nt(t,"collective")},{value:"orcid",label:nt(t,"orcid")},{value:"address",label:nt(t,"address")},{value:"email",label:nt(t,"email")},{value:"phone",label:nt(t,"phone")},{value:"media",label:nt(t,"media")},{value:"work",label:nt(t,"work")},{value:"geo",label:nt(t,"geo")},{value:"music_piece",label:nt(t,"music_piece")},{value:"music_fragment",label:nt(t,"music_fragment")},{value:"source",label:nt(t,"source")},{value:"question",label:nt(t,"question")},{value:"citation",label:nt(t,"citation")},{value:"computed",label:nt(t,"computed")},{value:"vocab",label:nt(t,"vocab")},{value:"book",label:nt(t,"book")},{value:"word-language",label:nt(t,"word-language")},{value:"citation-language",label:nt(t,"citation-language")},{value:"language-sentence",label:nt(t,"language-sentence")},{value:"translation",label:nt(t,"translation")},{value:"word-topic",label:nt(t,"word-topic")},{value:"reference",label:nt(t,"reference")},{value:"source-resource",label:nt(t,"source-resource")},{value:"work-contributor",label:nt(t,"work-contributor")},{value:"work-medium",label:nt(t,"work-medium")},{value:"orcid-link",label:nt(t,"orcid-link")}],ai=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Mn={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},ni={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Mn]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Mn]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId"]},filterFields:[Mn,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text"],connections:[{relationType:"citation-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"citationText",kind:"text",path:"text",matcher:"contains"}]},question:{infoType:"question",entityKind:"single",structure:{payloadFields:["definition"]},filterFields:[{key:"questionType",labelKey:"type",kind:"text",path:"definition.type",matcher:"contains"},{key:"questionText",labelKey:"text",kind:"text",path:"definition.question",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},gs={infoType:"default",entityKind:"single",structure:{payloadFields:["label"]},filterFields:[]};function si(t){return t?ni[t]??gs:gs}function ri(t,n){return t.optionsSource==="languages"?n.languages.map(r=>({value:r.infoId,label:r.label})):t.optionsSource==="sourceKinds"?ai:[]}const ii="cogita.revision.seed:";function Xs(t){return`${ii}${t}`}function oi(t,n){if(typeof window>"u")return null;const r=Array.from(new Set(n.map(h=>h.trim()).filter(Boolean)));if(!r.length)return null;const s=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,o={kind:"info-selection",libraryId:t,infoIds:r,createdAt:new Date().toISOString()};return window.localStorage.setItem(Xs(s),JSON.stringify(o)),s}function ms(t,n){if(typeof window>"u")return null;const r=window.localStorage.getItem(Xs(n));if(!r)return null;try{const s=JSON.parse(r);if(s.kind!=="info-selection"||s.libraryId!==t||!Array.isArray(s.infoIds))return null;const o=s.infoIds.map(h=>String(h??"").trim()).filter(Boolean);return o.length?{infoIds:o}:null}catch{return null}}const li="cogita.collection-draft:";function Zs(t){return`${li}${t}`}function ci(t,n){if(typeof window>"u")return null;const r=Array.from(new Set(n.map(h=>h.trim()).filter(Boolean)));if(!r.length)return null;const s=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,o={kind:"info-selection",libraryId:t,infoIds:r,createdAt:new Date().toISOString()};return window.localStorage.setItem(Zs(s),JSON.stringify(o)),s}function di(t,n){if(typeof window>"u")return null;const r=window.localStorage.getItem(Zs(n));if(!r)return null;try{const s=JSON.parse(r);if(s.kind!=="info-selection"||s.libraryId!==t||!Array.isArray(s.infoIds))return null;const o=s.infoIds.map(h=>String(h??"").trim()).filter(Boolean);return o.length?{infoIds:o}:null}catch{return null}}const Ln=60,ui=500;function er(t){return`cogita.info-selection:${t}`}function ps(t){if(typeof window>"u")return{};const n=window.localStorage.getItem(er(t));if(!n)return{};try{const r=JSON.parse(n);return!r||typeof r!="object"?{}:r}catch{return{}}}function hi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,libraryId:i,mode:m}){var qt;const l=mn(),d=Ja(),v=t.cogita.library.list,[g,S]=a.useState("any"),[V,x]=a.useState(""),[b,D]=a.useState("relevance"),[q,y]=a.useState("details"),[W,N]=a.useState(!1),[P,M]=a.useState("idle"),[T,Q]=a.useState([]),[ge,ye]=a.useState(Ln),[Oe,R]=a.useState(null),[I,Z]=a.useState(()=>ps(i)),[_,ae]=a.useState({}),[Y,ve]=a.useState([]),[le,se]=a.useState([]),[Te,Ae]=a.useState(null),[Ee,$e]=a.useState(null),[et,ct]=a.useState(null),[Ce,We]=a.useState("idle"),[xt,Ve]=a.useState([]),[De,tt]=a.useState(""),[ot,Ye]=a.useState(null),[Ie,Be]=a.useState("idle"),[Xe,K]=a.useState(null),[$,B]=a.useState(null),[F,k]=a.useState("idle"),[C,A]=a.useState([]),[ue,be]=a.useState("idle"),he=a.useMemo(()=>ti(t),[t]),ee=a.useMemo(()=>[{value:"relevance",label:v.sortRelevance},{value:"label_asc",label:v.sortLabelAsc},{value:"label_desc",label:v.sortLabelDesc},{value:"type_asc",label:v.sortTypeAsc},{value:"type_desc",label:v.sortTypeDesc}],[v.sortLabelAsc,v.sortLabelDesc,v.sortRelevance,v.sortTypeAsc,v.sortTypeDesc]);a.useEffect(()=>{Z(ps(i)),ae({}),N(!1)},[i]),a.useEffect(()=>{Yn({libraryId:i}).then(O=>ct(O)).catch(()=>ct({items:[]}))},[i]),a.useEffect(()=>{gr({libraryId:i}).then(O=>Ve(O)).catch(()=>Ve([]))},[i]),a.useEffect(()=>{In({libraryId:i,type:"language",filters:{sourceKind:"info"},limit:200}).then(O=>{const u=O.map(oe=>({infoId:oe.infoId??"",infoType:oe.entityType,label:oe.title})).filter(oe=>oe.infoId.length>0);ve(u)}).catch(()=>ve([]))},[i]),a.useEffect(()=>{In({libraryId:i,type:"source",filters:{sourceKind:"info"},limit:200}).then(O=>{const u=O.map(oe=>({infoId:oe.infoId??"",infoType:oe.entityType,label:oe.title})).filter(oe=>oe.infoId.length>0);se(u)}).catch(()=>se([]))},[i]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(er(i),JSON.stringify(I))},[i,I]);const E=a.useMemo(()=>si(g==="any"?null:g),[g]),X=a.useMemo(()=>new URLSearchParams(d.search),[d.search]),re=a.useMemo(()=>d.pathname.split("/").filter(Boolean),[d.pathname]),G=re.findIndex(O=>O==="infos"),te=G>=0&&(re[G+1]??"").trim()||null,xe=G>=0?(re[G+2]??"").trim():"",U=G>=0?xe==="checkcards"?"cards":xe==="collections"?"collections":"overview":"",ie=te??((X.get("infoId")??"").trim()||null),Le=te?U:(X.get("infoView")??"overview").trim(),qe=Le==="overview"&&!!ie,Ke=Le==="collections"&&!!ie,Je=a.useMemo(()=>({language:v.typeFilterLanguage,languageA:v.typeFilterLanguageA,languageB:v.typeFilterLanguageB,originalLanguage:v.typeFilterOriginalLanguage,doi:v.typeFilterDoi,sourceKind:v.typeFilterSourceKind,locator:v.typeFilterLocator,citationText:v.typeFilterCitationText}),[v.typeFilterDoi,v.typeFilterLanguage,v.typeFilterLanguageA,v.typeFilterLanguageB,v.typeFilterLocator,v.typeFilterOriginalLanguage,v.typeFilterCitationText,v.typeFilterSourceKind]),bt=a.useMemo(()=>E.filterFields.map(O=>({...O,label:O.labelKey?Je[O.labelKey]:O.label??O.key,options:ri(O,{languages:Y})})),[Je,Y,E.filterFields]),mt=a.useMemo(()=>bt.some(O=>(_[O.key]??"").trim().length>0),[bt,_]);a.useEffect(()=>{ae({})},[g]),a.useEffect(()=>{const O={sourceKind:"info"};if(mt)for(const H of bt){const Qe=(_[H.key]??"").trim();Qe&&(O[H.path??H.key]=Qe)}const u=(_.__referenceId??"").trim();u&&(O["link.references"]=u),M("loading");const oe=window.setTimeout(()=>{In({libraryId:i,type:g==="any"?void 0:g,query:V.trim()||void 0,filters:O,limit:ui}).then(H=>{const Qe=H.map(rt=>({infoId:rt.infoId??"",infoType:rt.entityType,label:rt.title})).filter(rt=>rt.infoId.length>0);Q(Qe),M("ready")}).catch(()=>{Q([]),M("ready")})},240);return()=>window.clearTimeout(oe)},[mt,i,V,g,bt,_]),a.useEffect(()=>{if(!ie||Le!=="overview"&&Le!=="collections"){Ae(null),$e(null),We("idle");return}let O=!1;return We("loading"),Promise.all([na({libraryId:i,infoId:ie}),mr({libraryId:i,itemType:"info",itemId:ie}).catch(()=>null)]).then(([u,oe])=>{O||(Ae(u),$e(oe),We("ready"))}).catch(()=>{O||(Ae(null),$e(null),We("error"))}),()=>{O=!0}},[i,ie,Le]),a.useEffect(()=>{if(!ie||Le!=="collections"){A([]),be("idle");return}let O=!1;return be("loading"),pr({libraryId:i,infoId:ie}).then(u=>{O||(A(u),be("ready"))}).catch(()=>{O||(A([]),be("error"))}),()=>{O=!0}},[i,ie,Le]),a.useEffect(()=>{if(!ie||Le!=="overview"){K(null),B(null),k("idle");return}let O=!1;return k("loading"),Promise.all([tn({libraryId:i,infoId:ie}),an({libraryId:i,infoId:ie})]).then(([u,oe])=>{O||(K(u),B(oe),k("ready"))}).catch(()=>{O||(K(null),B(null),k("error"))}),()=>{O=!0}},[i,ie,Le]);const pt=a.useMemo(()=>Te?xt.filter(O=>O.sourceInfoTypes.some(u=>u.toLowerCase()===Te.infoType.toLowerCase())):[],[xt,Te]);a.useEffect(()=>{if(!Te){tt("");return}tt(O=>{var u;return O&&pt.some(oe=>oe.approachKey===O)?O:((u=pt[0])==null?void 0:u.approachKey)??""})},[pt,Te]),a.useEffect(()=>{if(!Te||!De){Ye(null),Be("idle");return}let O=!1;return Be("loading"),qs({libraryId:i,infoId:Te.infoId,approachKey:De}).then(u=>{O||(Ye(u),Be("ready"))}).catch(()=>{O||(Ye(null),Be("error"))}),()=>{O=!0}},[i,De,Te]);const wt=a.useMemo(()=>{const O=T.slice(),u=oe=>nt(t,oe);return b==="relevance"?O:b==="label_asc"?O.sort((oe,H)=>oe.label.localeCompare(H.label)):b==="label_desc"?O.sort((oe,H)=>H.label.localeCompare(oe.label)):b==="type_asc"?O.sort((oe,H)=>oe.infoType===H.infoType?oe.label.localeCompare(H.label):u(oe.infoType).localeCompare(u(H.infoType))):O.sort((oe,H)=>oe.infoType===H.infoType?oe.label.localeCompare(H.label):u(H.infoType).localeCompare(u(oe.infoType)))},[t,T,b]),Ct=a.useMemo(()=>wt.slice(0,ge),[wt,ge]),Ot=Ct.length<wt.length,Et=a.useMemo(()=>new Set(Object.keys(I)),[I]),Nt=a.useMemo(()=>Object.values(I),[I]),ua=a.useMemo(()=>{const O=new Map;for(const u of Nt)O.set(u.infoType,(O.get(u.infoType)??0)+1);return Array.from(O.entries()).sort((u,oe)=>oe[1]-u[1]||u[0].localeCompare(oe[0]))},[Nt]),Lt=a.useMemo(()=>{if(!ie||!et)return 0;const O=new Set;for(const u of et.items)u.childItemType!=="info"||u.childItemId!==ie||O.add([u.parentItemType,u.parentItemId,u.parentCheckType??"",u.parentDirection??""].join("|"));return O.size},[et,ie]);a.useEffect(()=>{ye(Ln);const O=new Set(T.map(u=>u.infoId));R(u=>u&&O.has(u)?u:null)},[T]);const vt=O=>{Z(u=>({...u,[O.infoId]:{infoId:O.infoId,infoType:O.infoType,label:O.label}}))},St=O=>{Z(u=>{if(!u[O])return u;const oe={...u};return delete oe[O],oe})},kt=(O,u)=>{if(u){vt(O);return}St(O.infoId)},yt=O=>{l(`/cogita/library/${i}/infos/${encodeURIComponent(O)}`,{replace:!0})},Kt=()=>{l(`/cogita/library/${i}/list`,{replace:!0})},st=()=>{ie&&l(`/cogita/library/${i}/edit/${encodeURIComponent(ie)}`,{replace:!0})},Ue=()=>{const O=oi(i,Nt.map(u=>u.infoId));O&&l(`/cogita/library/${i}/revision/run?libraryTarget=revisions&scope=info-selection&seed=${encodeURIComponent(O)}`)},ft=()=>{const O=ci(i,Nt.map(u=>u.infoId));O&&l(`/cogita/library/${i}/collections/new?draft=${encodeURIComponent(O)}&draftType=info-selection`)},Qt=Nt.length===1?((qt=Nt[0])==null?void 0:qt.infoId)??null:null,Vt=v.selectionCount.replace("{count}",String(Nt.length)),Bt=m==="collection"?"grid":m==="detail"?"wide":q,me=mi(p),$t=Ee?Math.max(0,Math.min(100,Math.round((Ee.score??0)*100))):0,Xt=Ee?pi(Ee,me):me.noKnownnessData;return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":Bt,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[qe?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:me.kicker}),e.jsx("h2",{className:"cogita-card-title",children:Te?fs(Te.payload,Te.infoType,Te.infoId):me.loading}),Te?e.jsxs("p",{className:"cogita-card-subtitle",children:[nt(t,Te.infoType)," · ",Te.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:Kt,children:me.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:st,disabled:!ie||Ce!=="ready",children:v.editInfo})]})]}),Ce==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:me.loading})}):Ce==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:me.loadError})}):Te?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:me.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[$t,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${$t}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:Xt})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:me.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(Ee==null?void 0:Ee.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:me.correct.replace("{correct}",String((Ee==null?void 0:Ee.correctReviews)??0)).replace("{total}",String((Ee==null?void 0:Ee.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:Ee!=null&&Ee.lastReviewedUtc?`${me.lastReview}: ${gi(Ee.lastReviewedUtc,p)}`:me.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:me.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:Lt}),e.jsx("p",{className:"cogita-library-hint",children:me.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:me.checkcards}),F==="loading"?e.jsx("p",{className:"cogita-library-hint",children:me.loadingCheckcards}):F==="error"?e.jsx("p",{className:"cogita-library-hint",children:me.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:me.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(Xe==null?void 0:Xe.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:me.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:($==null?void 0:$.items.length)??0})]})]})]}),pt.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:me.approach}),e.jsx("select",{value:De,onChange:O=>tt(O.target.value),"aria-label":me.approach,children:pt.map(O=>e.jsx("option",{value:O.approachKey,children:O.label},O.approachKey))})]}),Ie==="loading"?e.jsx("p",{className:"cogita-library-hint",children:me.loadingApproach}):Ie==="error"?e.jsx("p",{className:"cogita-library-hint",children:me.loadApproachError}):ot?e.jsx(nn,{value:ot.projection,emptyLabel:me.empty}):e.jsx("p",{className:"cogita-library-hint",children:me.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:me.payload}),e.jsx(nn,{value:Te.payload,emptyLabel:me.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:me.links}),e.jsx(fi,{links:Te.links,emptyLabel:me.noLinks})]})]})]}):null]})}):null,Ke?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Informacja"}),e.jsx("h2",{className:"cogita-card-title",children:Te?fs(Te.payload,Te.infoType,Te.infoId):ie??""}),e.jsx("p",{className:"cogita-card-subtitle",children:"Collections using this info"})]}),e.jsx("div",{className:"cogita-info-overview-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:Kt,children:"Back to search"})})]}),ue==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading collections..."})}):null,ue==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load collections."})}):null,ue==="ready"&&C.length===0?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"This info is not used in any collection yet."})}):null,ue==="ready"&&C.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:C.map(O=>e.jsx("article",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`/#/cogita/library/${i}/collections/${O.collectionId}?libraryTarget=collections`,children:[e.jsx("div",{className:"cogita-card-type",children:"Collection"}),e.jsx("h3",{className:"cogita-card-title",children:O.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[O.itemCount," items"]})]})},O.collectionId))}):null]})}):null,!qe&&!Ke?e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":v.typeLabel,value:g,onChange:O=>S(O.target.value),children:he.map(O=>e.jsx("option",{value:O.value,children:O.label},O.value))}),e.jsx("input",{type:"text",value:V,onChange:O=>x(O.target.value),placeholder:v.searchPlaceholder}),e.jsx("select",{"aria-label":v.sortLabel,value:b,onChange:O=>D(O.target.value),children:ee.map(O=>e.jsx("option",{value:O.value,children:O.label},O.value))}),e.jsxs("select",{"aria-label":v.viewLabel,value:q,onChange:O=>y(O.target.value),children:[e.jsx("option",{value:"details",children:v.viewDetails}),e.jsx("option",{value:"wide",children:v.viewWide}),e.jsx("option",{value:"grid",children:v.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:v.cardCount.replace("{shown}",String(Ct.length)).replace("{total}",String(wt.length))}),e.jsx("span",{children:P==="loading"?v.loading:v.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>N(O=>!O),children:W?v.hideFilters:v.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:v.filtersOptionalHint})]}),W?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsxs("div",{className:"cogita-filter-grid",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:v.typeLabel}),e.jsx("select",{value:g,onChange:O=>S(O.target.value),children:he.map(O=>e.jsx("option",{value:O.value,children:O.label},`advanced-type:${O.value}`))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Reference"}),e.jsxs("select",{value:_.__referenceId??"",onChange:O=>ae(u=>({...u,__referenceId:O.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),le.map(O=>e.jsx("option",{value:O.infoId,children:O.label},`reference:${O.infoId}`))]})]}),bt.map(O=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:O.label}),O.kind==="select"?e.jsxs("select",{value:_[O.key]??"",onChange:u=>ae(oe=>({...oe,[O.key]:u.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(O.options??[]).map(u=>e.jsx("option",{value:u.value,children:u.label},`${O.key}:${u.value}`))]}):e.jsx("input",{type:"text",value:_[O.key]??"",onChange:u=>ae(oe=>({...oe,[O.key]:u.target.value}))})]},`type-filter:${O.key}`))]})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:Vt}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{Z(O=>{const u={...O};for(const oe of Ct)u[oe.infoId]={infoId:oe.infoId,infoType:oe.infoType,label:oe.label};return u})},disabled:Ct.length===0,children:v.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Z({}),disabled:Nt.length===0,children:v.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Qt&&yt(Qt),disabled:!Qt,title:Qt?void 0:v.openSelectedDisabled,children:v.openSelected})]})]}),Bt==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":v.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:v.detailColumnName}),e.jsx("span",{children:v.detailColumnType}),e.jsx("span",{children:v.detailColumnId}),e.jsx("span",{})]}),Ct.length?Ct.map(O=>{const u=nt(t,O.infoType),oe=Et.has(O.infoId),H=Oe===O.infoId;return e.jsxs("div",{className:`cogita-details-row ${H||oe?"active":""}`,role:"row",onClick:()=>R(O.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:oe,onChange:Qe=>kt(O,Qe.target.checked),onClick:Qe=>Qe.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:O.label,children:O.label}),e.jsx("span",{title:u,children:u}),e.jsx("span",{title:O.infoId,children:O.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:Qe=>{Qe.stopPropagation(),yt(O.infoId)},"aria-label":v.editInfo,children:">"})]},O.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:v.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${Bt}`,"data-view":Bt,children:Ct.length?Ct.map(O=>{const u=nt(t,O.infoType),oe=Et.has(O.infoId),H=Oe===O.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":H||oe,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:oe,onChange:Qe=>kt(O,Qe.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>R(O.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:u}),e.jsx("h3",{className:"cogita-card-title",children:O.label}),e.jsx("p",{className:"cogita-card-subtitle",children:O.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>yt(O.infoId),children:v.editInfo})]})},O.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:v.noMatch})})}),Ot?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>ye(O=>O+Ln),children:v.loadMore})}):null,Nt.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:v.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:v.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:ua.map(([O,u])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:nt(t,O)}),e.jsx("span",{className:"cogita-tag-count",children:u})]},`stack:type:${O}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:Ue,disabled:Nt.length===0,children:"Start revision"}),e.jsx("button",{type:"button",className:"ghost",onClick:ft,disabled:Nt.length===0,children:"Create collection from selection"})]})]}):null]}):null]})})})})}function fs(t,n,r){if(t&&typeof t=="object"&&!Array.isArray(t)){const s=t,o=["title","name","label","value","text","quote","term"];for(const h of o){const c=s[h];if(typeof c=="string"&&c.trim())return c.trim()}}return`${n} · ${r}`}function gi(t,n){try{const r=n==="pl"?"pl-PL":n==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(r,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function mi(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function pi(t,n){return t.totalReviews<=0?n.noKnownnessData:t.totalReviews<3||t.score<.35?n.developmentStart:t.totalReviews<8||t.score<.65?n.developmentGrowing:t.score<.85?n.developmentStable:n.developmentStrong}function fi({links:t,emptyLabel:n}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([r,s])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(s)?s.length?e.jsx("div",{className:"cogita-selection-overview",children:s.map(o=>e.jsx("span",{className:"cogita-tag-chip",children:o},`${r}:${o}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):s?e.jsx("span",{className:"cogita-tag-chip",children:s}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},r))})}function nn({value:t,emptyLabel:n}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:n});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((r,s)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(nn,{value:r,emptyLabel:n})})]},s))});if(typeof t=="object"){const r=Object.entries(t);return r.length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:r.map(([s,o])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(nn,{value:o,emptyLabel:n})})]},s))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const Na=5,bs=50,ys=2,xs=[];function Yt({libraryId:t,infoType:n,label:r,placeholder:s,value:o,onChange:h,values:c,onChangeMultiple:j,helperText:p,searchFailedText:w,createFailedText:i,createLabel:m,savingLabel:l,loadMoreLabel:d,allowCreate:v=!0,inputRef:g,autoAdvance:S,onCommit:V,multiple:x}){const b=x?c??xs:xs,[D,q]=a.useState(x?"":(o==null?void 0:o.label)??""),[y,W]=a.useState([]),[N,P]=a.useState(Na),[M,T]=a.useState(-1),[Q,ge]=a.useState(!1),[ye,Oe]=a.useState(!1),[R,I]=a.useState(null),Z=a.useRef(0),_=a.useRef(new Map),ae=a.useMemo(()=>v?x?D.trim().length>0:D.trim().length>0&&!o:!1,[v,D,o,x]);a.useEffect(()=>{x||q((o==null?void 0:o.label)??"")},[o,x]),a.useEffect(()=>{const le=D.trim();if(!le||le.length<ys){W([]),ge(!1),P(Na),T(-1),Oe(!1),I(null);return}const se=le.toLowerCase(),Te=`${t}:${n}:${se}`,Ae=_.current.get(Te);if(Ae){if(x&&b.length>0){const $e=new Set(b.map(et=>et.id));W(Ae.filter(et=>!$e.has(et.id)))}else W(Ae);P(Na),T(-1),ge(Ae.length>0),Oe(!1),I(null);return}const Ee=window.setTimeout(async()=>{const $e=Date.now();Z.current=$e,Oe(!0),I(null);try{const et=await Xn({libraryId:t,type:n,query:le,limit:bs});if(Z.current!==$e)return;const ct=et.slice(0,bs).map(Ce=>({id:Ce.infoId,label:Ce.label,infoType:Ce.infoType}));if(_.current.set(Te,ct),x&&b.length>0){const Ce=new Set(b.map(We=>We.id));W(ct.filter(We=>!Ce.has(We.id)))}else W(ct);P(Na),T(-1),ge(!0)}catch{if(Z.current!==$e)return;I(w??"Search failed.")}finally{Z.current===$e&&Oe(!1)}},250);return()=>window.clearTimeout(Ee)},[t,n,D,b]);const Y=le=>{if(x){const se=b.some(Te=>Te.id===le.id)?b:[...b,le];j==null||j(se),q(""),ge(!1),T(-1);return}h==null||h(le),q(le.label),ge(!1),T(-1),S&&(V==null||V())},ve=async()=>{const le=D.trim();if(le){Oe(!0),I(null);try{const se=await qn({libraryId:t,infoType:n,payload:{label:le}}),Te={id:se.infoId,label:le,infoType:se.infoType};if(le.length>=ys){const Ae=`${t}:${n}:${le.toLowerCase()}`,Ee=_.current.get(Ae)??[];_.current.set(Ae,[Te,...Ee])}if(x){j==null||j([...b,Te]),q(""),ge(!1),T(-1);return}h==null||h(Te),ge(!1),T(-1),S&&(V==null||V())}catch{I(i??"Create failed.")}finally{Oe(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:r}),e.jsx("input",{value:D,placeholder:s,onChange:le=>{q(le.target.value),!x&&o&&(h==null||h(null))},onKeyDown:le=>{if(le.key==="ArrowDown"){if(le.preventDefault(),!y.length)return;ge(!0),T(se=>{const Te=Math.min(y.length,N)-1,Ae=se<0?0:Math.min(se+1,Te);return Ae===Te&&y.length>N?(P(Ee=>Math.min(Ee+Na,y.length)),Math.min(se+1,Math.min(y.length,N+Na)-1)):Ae});return}if(le.key==="ArrowUp"){if(le.preventDefault(),!y.length)return;ge(!0),T(se=>se<=0?0:se-1);return}if(le.key==="Enter"){if(le.preventDefault(),M>=0&&y[M]){Y(y[M]);return}if(ae){ve();return}}},onFocus:()=>{y.length>0&&ge(!0)},autoComplete:"off",ref:g})]}),x&&b.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:b.map(le=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>j==null?void 0:j(b.filter(se=>se.id!==le.id)),children:[le.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},le.id))}),p&&e.jsx("p",{className:"cogita-help",children:p}),R&&e.jsx("p",{className:"cogita-error",children:R}),Q&&y.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[y.slice(0,N).map((le,se)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":se===M,onClick:()=>Y(le),children:[e.jsx("strong",{children:le.label}),e.jsx("span",{children:le.infoType})]},le.id)),N<y.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>P(le=>Math.min(le+Na,y.length)),children:d??"Load more"})]}),ae&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:ve,disabled:ye,children:ye?l??"Saving...":m??`Create new ${n}`})]})}const vs=[{id:"gen",la:{abbr:"Gen",name:"Genesis"},en:{abbr:"Gen",name:"Genesis"},de:{abbr:"Gen",name:"Genesis"},pl:{abbr:"Rdz",name:"Księga Rodzaju"}},{id:"ex",la:{abbr:"Ex",name:"Exodus"},en:{abbr:"Ex",name:"Exodus"},de:{abbr:"Ex",name:"Exodus"},pl:{abbr:"Wj",name:"Księga Wyjścia"}},{id:"lev",la:{abbr:"Lev",name:"Leviticus"},en:{abbr:"Lev",name:"Leviticus"},de:{abbr:"Lev",name:"Levitikus"},pl:{abbr:"Kpł",name:"Księga Kapłańska"}},{id:"num",la:{abbr:"Num",name:"Numeri"},en:{abbr:"Num",name:"Numbers"},de:{abbr:"Num",name:"Numeri"},pl:{abbr:"Lb",name:"Księga Liczb"}},{id:"deut",la:{abbr:"Deut",name:"Deuteronomium"},en:{abbr:"Deut",name:"Deuteronomy"},de:{abbr:"Dtn",name:"Deuteronomium"},pl:{abbr:"Pwt",name:"Księga Powtórzonego Prawa"}},{id:"ios",la:{abbr:"Ios",name:"Iosue"},en:{abbr:"Josh",name:"Joshua"},de:{abbr:"Jos",name:"Josua"},pl:{abbr:"Joz",name:"Księga Jozuego"}},{id:"iudg",la:{abbr:"Iudg",name:"Iudicum"},en:{abbr:"Judg",name:"Judges"},de:{abbr:"Ri",name:"Richter"},pl:{abbr:"Sdz",name:"Księga Sędziów"}},{id:"ruth",la:{abbr:"Ruth",name:"Ruth"},en:{abbr:"Ruth",name:"Ruth"},de:{abbr:"Rut",name:"Rut"},pl:{abbr:"Rt",name:"Księga Rut"}},{id:"1sam",la:{abbr:"1 Sam",name:"I Samuelis"},en:{abbr:"1 Sam",name:"1 Samuel"},de:{abbr:"1 Sam",name:"1 Samuel"},pl:{abbr:"1 Sm",name:"1 Księga Samuela"}},{id:"2sam",la:{abbr:"2 Sam",name:"II Samuelis"},en:{abbr:"2 Sam",name:"2 Samuel"},de:{abbr:"2 Sam",name:"2 Samuel"},pl:{abbr:"2 Sm",name:"2 Księga Samuela"}},{id:"1reg",la:{abbr:"1 Reg",name:"I Regum"},en:{abbr:"1 Kgs",name:"1 Kings"},de:{abbr:"1 Kön",name:"1 Könige"},pl:{abbr:"1 Krl",name:"1 Księga Królewska"}},{id:"2reg",la:{abbr:"2 Reg",name:"II Regum"},en:{abbr:"2 Kgs",name:"2 Kings"},de:{abbr:"2 Kön",name:"2 Könige"},pl:{abbr:"2 Krl",name:"2 Księga Królewska"}},{id:"1par",la:{abbr:"1 Par",name:"I Paralipomenon"},en:{abbr:"1 Chr",name:"1 Chronicles"},de:{abbr:"1 Chr",name:"1 Chronik"},pl:{abbr:"1 Krn",name:"1 Księga Kronik"}},{id:"2par",la:{abbr:"2 Par",name:"II Paralipomenon"},en:{abbr:"2 Chr",name:"2 Chronicles"},de:{abbr:"2 Chr",name:"2 Chronik"},pl:{abbr:"2 Krn",name:"2 Księga Kronik"}},{id:"esd",la:{abbr:"Esd",name:"Esdrae"},en:{abbr:"Ezra",name:"Ezra"},de:{abbr:"Esra",name:"Esra"},pl:{abbr:"Ezd",name:"Księga Ezdrasza"}},{id:"neh",la:{abbr:"Neh",name:"Nehemiae"},en:{abbr:"Neh",name:"Nehemiah"},de:{abbr:"Neh",name:"Nehemia"},pl:{abbr:"Ne",name:"Księga Nehemiasza"}},{id:"tob",la:{abbr:"Tob",name:"Tobiae"},en:{abbr:"Tob",name:"Tobit"},de:{abbr:"Tob",name:"Tobit"},pl:{abbr:"Tb",name:"Księga Tobiasza"}},{id:"iudt",la:{abbr:"Iudt",name:"Iudith"},en:{abbr:"Jdt",name:"Judith"},de:{abbr:"Jdt",name:"Judit"},pl:{abbr:"Jdt",name:"Księga Judyty"}},{id:"est",la:{abbr:"Est",name:"Esther"},en:{abbr:"Est",name:"Esther"},de:{abbr:"Est",name:"Ester"},pl:{abbr:"Est",name:"Księga Estery"}},{id:"1macc",la:{abbr:"1 Macc",name:"I Maccabaeorum"},en:{abbr:"1 Mc",name:"1 Maccabees"},de:{abbr:"1 Makk",name:"1 Makkabäer"},pl:{abbr:"1 Mch",name:"1 Księga Machabejska"}},{id:"2macc",la:{abbr:"2 Macc",name:"II Maccabaeorum"},en:{abbr:"2 Mc",name:"2 Maccabees"},de:{abbr:"2 Makk",name:"2 Makkabäer"},pl:{abbr:"2 Mch",name:"2 Księga Machabejska"}},{id:"iob",la:{abbr:"Iob",name:"Iob"},en:{abbr:"Job",name:"Job"},de:{abbr:"Ijob",name:"Ijob"},pl:{abbr:"Hi",name:"Księga Hioba"}},{id:"ps",la:{abbr:"Ps",name:"Psalmi"},en:{abbr:"Ps",name:"Psalms"},de:{abbr:"Ps",name:"Psalmen"},pl:{abbr:"Ps",name:"Księga Psalmów"}},{id:"prov",la:{abbr:"Prov",name:"Proverbia"},en:{abbr:"Prov",name:"Proverbs"},de:{abbr:"Spr",name:"Sprichwörter"},pl:{abbr:"Prz",name:"Księga Przysłów"}},{id:"ecc",la:{abbr:"Ecc",name:"Ecclesiastes"},en:{abbr:"Eccl",name:"Ecclesiastes"},de:{abbr:"Koh",name:"Kohelet"},pl:{abbr:"Koh",name:"Księga Koheleta"}},{id:"cant",la:{abbr:"Cant",name:"Canticum Canticorum"},en:{abbr:"Song",name:"Song of Songs"},de:{abbr:"Hld",name:"Hoheslied"},pl:{abbr:"Pnp",name:"Pieśń nad Pieśniami"}},{id:"sap",la:{abbr:"Sap",name:"Sapientia"},en:{abbr:"Wis",name:"Wisdom"},de:{abbr:"Weish",name:"Weisheit"},pl:{abbr:"Mdr",name:"Księga Mądrości"}},{id:"sir",la:{abbr:"Sir",name:"Ecclesiasticus (Sirach)"},en:{abbr:"Sir",name:"Sirach"},de:{abbr:"Sir",name:"Jesus Sirach"},pl:{abbr:"Syr",name:"Mądrość Syracha"}},{id:"isa",la:{abbr:"Isa",name:"Isaias"},en:{abbr:"Isa",name:"Isaiah"},de:{abbr:"Jes",name:"Jesaja"},pl:{abbr:"Iz",name:"Księga Izajasza"}},{id:"ier",la:{abbr:"Ier",name:"Ieremias"},en:{abbr:"Jer",name:"Jeremiah"},de:{abbr:"Jer",name:"Jeremia"},pl:{abbr:"Jr",name:"Księga Jeremiasza"}},{id:"lam",la:{abbr:"Lam",name:"Lamentationes"},en:{abbr:"Lam",name:"Lamentations"},de:{abbr:"Klgl",name:"Klagelieder"},pl:{abbr:"Lm",name:"Lamentacje"}},{id:"bar",la:{abbr:"Bar",name:"Baruch"},en:{abbr:"Bar",name:"Baruch"},de:{abbr:"Bar",name:"Baruch"},pl:{abbr:"Ba",name:"Księga Barucha"}},{id:"ez",la:{abbr:"Ez",name:"Ezechiel"},en:{abbr:"Ezek",name:"Ezekiel"},de:{abbr:"Ez",name:"Ezechiel"},pl:{abbr:"Ez",name:"Księga Ezechiela"}},{id:"dan",la:{abbr:"Dan",name:"Daniel"},en:{abbr:"Dan",name:"Daniel"},de:{abbr:"Dan",name:"Daniel"},pl:{abbr:"Dn",name:"Księga Daniela"}},{id:"hos",la:{abbr:"Hos",name:"Osee"},en:{abbr:"Hos",name:"Hosea"},de:{abbr:"Hos",name:"Hosea"},pl:{abbr:"Oz",name:"Księga Ozeasza"}},{id:"ioel",la:{abbr:"Ioel",name:"Ioel"},en:{abbr:"Joel",name:"Joel"},de:{abbr:"Joel",name:"Joel"},pl:{abbr:"Jl",name:"Księga Joela"}},{id:"amos",la:{abbr:"Amos",name:"Amos"},en:{abbr:"Am",name:"Amos"},de:{abbr:"Am",name:"Amos"},pl:{abbr:"Am",name:"Księga Amosa"}},{id:"abd",la:{abbr:"Abd",name:"Abdias"},en:{abbr:"Obad",name:"Obadiah"},de:{abbr:"Obd",name:"Obadja"},pl:{abbr:"Abd",name:"Księga Abdiasza"}},{id:"ion",la:{abbr:"Ion",name:"Ionas"},en:{abbr:"Jon",name:"Jonah"},de:{abbr:"Jona",name:"Jona"},pl:{abbr:"Jon",name:"Księga Jonasza"}},{id:"mich",la:{abbr:"Mich",name:"Michaeas"},en:{abbr:"Mic",name:"Micah"},de:{abbr:"Mi",name:"Micha"},pl:{abbr:"Mi",name:"Księga Micheasza"}},{id:"nah",la:{abbr:"Nah",name:"Nahum"},en:{abbr:"Nah",name:"Nahum"},de:{abbr:"Nah",name:"Nahum"},pl:{abbr:"Na",name:"Księga Nahuma"}},{id:"hab",la:{abbr:"Hab",name:"Habacuc"},en:{abbr:"Hab",name:"Habakkuk"},de:{abbr:"Hab",name:"Habakuk"},pl:{abbr:"Ha",name:"Księga Habakuka"}},{id:"soph",la:{abbr:"Soph",name:"Sophonias"},en:{abbr:"Zeph",name:"Zephaniah"},de:{abbr:"Zef",name:"Zefanja"},pl:{abbr:"So",name:"Księga Sofoniasza"}},{id:"agg",la:{abbr:"Agg",name:"Aggaeus"},en:{abbr:"Hag",name:"Haggai"},de:{abbr:"Hag",name:"Haggai"},pl:{abbr:"Ag",name:"Księga Aggeusza"}},{id:"zach",la:{abbr:"Zach",name:"Zacharias"},en:{abbr:"Zech",name:"Zechariah"},de:{abbr:"Sach",name:"Sacharja"},pl:{abbr:"Za",name:"Księga Zachariasza"}},{id:"mal",la:{abbr:"Mal",name:"Malachias"},en:{abbr:"Mal",name:"Malachi"},de:{abbr:"Mal",name:"Maleachi"},pl:{abbr:"Ml",name:"Księga Malachiasza"}},{id:"mt",la:{abbr:"Mt",name:"Matthaeus"},en:{abbr:"Matt",name:"Matthew"},de:{abbr:"Mt",name:"Matthäus"},pl:{abbr:"Mt",name:"Ewangelia wg św. Mateusza"}},{id:"mc",la:{abbr:"Mc",name:"Marcus"},en:{abbr:"Mark",name:"Mark"},de:{abbr:"Mk",name:"Markus"},pl:{abbr:"Mk",name:"Ewangelia wg św. Marka"}},{id:"lc",la:{abbr:"Lc",name:"Lucas"},en:{abbr:"Luke",name:"Luke"},de:{abbr:"Lk",name:"Lukas"},pl:{abbr:"Łk",name:"Ewangelia wg św. Łukasza"}},{id:"io",la:{abbr:"Io",name:"Ioannes"},en:{abbr:"John",name:"John"},de:{abbr:"Joh",name:"Johannes"},pl:{abbr:"J",name:"Ewangelia wg św. Jana"}},{id:"act",la:{abbr:"Act",name:"Actus Apostolorum"},en:{abbr:"Acts",name:"Acts"},de:{abbr:"Apg",name:"Apostelgeschichte"},pl:{abbr:"Dz",name:"Dzieje Apostolskie"}},{id:"rom",la:{abbr:"Rom",name:"ad Romanos"},en:{abbr:"Rom",name:"Romans"},de:{abbr:"Röm",name:"Römer"},pl:{abbr:"Rz",name:"List do Rzymian"}},{id:"1cor",la:{abbr:"1 Cor",name:"I ad Corinthios"},en:{abbr:"1 Cor",name:"1 Corinthians"},de:{abbr:"1 Kor",name:"1 Korinther"},pl:{abbr:"1 Kor",name:"1 List do Koryntian"}},{id:"2cor",la:{abbr:"2 Cor",name:"II ad Corinthios"},en:{abbr:"2 Cor",name:"2 Corinthians"},de:{abbr:"2 Kor",name:"2 Korinther"},pl:{abbr:"2 Kor",name:"2 List do Koryntian"}},{id:"gal",la:{abbr:"Gal",name:"ad Galatas"},en:{abbr:"Gal",name:"Galatians"},de:{abbr:"Gal",name:"Galater"},pl:{abbr:"Ga",name:"List do Galatów"}},{id:"eph",la:{abbr:"Eph",name:"ad Ephesios"},en:{abbr:"Eph",name:"Ephesians"},de:{abbr:"Eph",name:"Epheser"},pl:{abbr:"Ef",name:"List do Efezjan"}},{id:"phil",la:{abbr:"Phil",name:"ad Philippenses"},en:{abbr:"Phil",name:"Philippians"},de:{abbr:"Phil",name:"Philipper"},pl:{abbr:"Flp",name:"List do Filipian"}},{id:"col",la:{abbr:"Col",name:"ad Colossenses"},en:{abbr:"Col",name:"Colossians"},de:{abbr:"Kol",name:"Kolosser"},pl:{abbr:"Kol",name:"List do Kolosan"}},{id:"1thess",la:{abbr:"1 Thess",name:"I ad Thessalonicenses"},en:{abbr:"1 Thess",name:"1 Thessalonians"},de:{abbr:"1 Thess",name:"1 Thessalonicher"},pl:{abbr:"1 Tes",name:"1 List do Tesaloniczan"}},{id:"2thess",la:{abbr:"2 Thess",name:"II ad Thessalonicenses"},en:{abbr:"2 Thess",name:"2 Thessalonians"},de:{abbr:"2 Thess",name:"2 Thessalonicher"},pl:{abbr:"2 Tes",name:"2 List do Tesaloniczan"}},{id:"1tim",la:{abbr:"1 Tim",name:"I ad Timotheum"},en:{abbr:"1 Tim",name:"1 Timothy"},de:{abbr:"1 Tim",name:"1 Timotheus"},pl:{abbr:"1 Tm",name:"1 List do Tymoteusza"}},{id:"2tim",la:{abbr:"2 Tim",name:"II ad Timotheum"},en:{abbr:"2 Tim",name:"2 Timothy"},de:{abbr:"2 Tim",name:"2 Timotheus"},pl:{abbr:"2 Tm",name:"2 List do Tymoteusza"}},{id:"tit",la:{abbr:"Tit",name:"ad Titum"},en:{abbr:"Titus",name:"Titus"},de:{abbr:"Tit",name:"Titus"},pl:{abbr:"Tt",name:"List do Tytusa"}},{id:"phlm",la:{abbr:"Phlm",name:"ad Philemonem"},en:{abbr:"Phlm",name:"Philemon"},de:{abbr:"Phlm",name:"Philemon"},pl:{abbr:"Flm",name:"List do Filemona"}},{id:"heb",la:{abbr:"Heb",name:"ad Hebraeos"},en:{abbr:"Heb",name:"Hebrews"},de:{abbr:"Hebr",name:"Hebräer"},pl:{abbr:"Hbr",name:"List do Hebrajczyków"}},{id:"iac",la:{abbr:"Iac",name:"Iacobi"},en:{abbr:"Jas",name:"James"},de:{abbr:"Jak",name:"Jakobus"},pl:{abbr:"Jk",name:"List św. Jakuba"}},{id:"1pet",la:{abbr:"1 Pet",name:"I Petri"},en:{abbr:"1 Pet",name:"1 Peter"},de:{abbr:"1 Petr",name:"1 Petrus"},pl:{abbr:"1 P",name:"1 List św. Piotra"}},{id:"2pet",la:{abbr:"2 Pet",name:"II Petri"},en:{abbr:"2 Pet",name:"2 Peter"},de:{abbr:"2 Petr",name:"2 Petrus"},pl:{abbr:"2 P",name:"2 List św. Piotra"}},{id:"1io",la:{abbr:"1 Io",name:"I Ioannis"},en:{abbr:"1 John",name:"1 John"},de:{abbr:"1 Joh",name:"1 Johannes"},pl:{abbr:"1 J",name:"1 List św. Jana"}},{id:"2io",la:{abbr:"2 Io",name:"II Ioannis"},en:{abbr:"2 John",name:"2 John"},de:{abbr:"2 Joh",name:"2 Johannes"},pl:{abbr:"2 J",name:"2 List św. Jana"}},{id:"3io",la:{abbr:"3 Io",name:"III Ioannis"},en:{abbr:"3 John",name:"3 John"},de:{abbr:"3 Joh",name:"3 Johannes"},pl:{abbr:"3 J",name:"3 List św. Jana"}},{id:"iud",la:{abbr:"Iud",name:"Iudae"},en:{abbr:"Jude",name:"Jude"},de:{abbr:"Jud",name:"Judas"},pl:{abbr:"Jud",name:"List św. Judy"}},{id:"apoc",la:{abbr:"Apoc",name:"Apocalypsis Ioannis"},en:{abbr:"Rev",name:"Revelation"},de:{abbr:"Offb",name:"Offenbarung"},pl:{abbr:"Ap",name:"Apokalipsa św. Jana"}}],js=8;function ws({libraryId:t,copy:n,language:r,sourceKindOptions:s,value:o,onChange:h,labels:c}){const[j,p]=a.useState(!1),[w,i]=a.useState(-1),m=a.useMemo(()=>{const g=r;return vs.map(S=>{var b;const V=(S==null?void 0:S[g])??(S==null?void 0:S.en)??(S==null?void 0:S.la);return{label:`${V.abbr} — ${V.name}`,latin:((b=S==null?void 0:S.la)==null?void 0:b.abbr)??V.abbr}})},[r]),l=(g,S=!1)=>{const V=g.trim().toLowerCase();return V?m.filter(x=>x.label.toLowerCase().includes(V)).slice(0,js):S?m.slice(0,js):[]},d=(g,S)=>{const V=g.trim().toLowerCase();if(!V)return null;const x=vs;for(const b of x){const D=b==null?void 0:b.la,q=(b==null?void 0:b[S])??(b==null?void 0:b.en)??D,y=(q==null?void 0:q.abbr)??"",W=(q==null?void 0:q.name)??"";if(y.toLowerCase()===V||W.toLowerCase()===V||`${y} — ${W}`.toLowerCase()===V)return{book:b,entry:q,la:D}}return null};a.useEffect(()=>{if(o.sourceKind==="bible"&&o.locatorValue&&!j){const g=d(o.locatorValue,r);if(g){const S=`${g.entry.abbr} — ${g.entry.name}`;S!==o.bibleBookDisplay&&h({...o,bibleBookDisplay:S})}}},[r,o,j,h]);const v=g=>h({...o,...g});return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:c.sourceKindLabel}),e.jsx("select",{value:o.sourceKind,onChange:g=>v({sourceKind:g.target.value,churchDocument:null,bookMedia:null,work:null,locatorValue:"",locatorAux:"",bibleBookDisplay:""}),children:s.map(g=>e.jsx("option",{value:g.value,children:g.label},g.value))})]}),o.sourceKind==="bible"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-lookup full",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:c.bibleBookLabel}),e.jsx("input",{type:"text",value:o.bibleBookDisplay,onChange:g=>{const S=g.target.value;v({bibleBookDisplay:S,locatorValue:""}),p(!0),i(-1)},onKeyDown:g=>{var V;const S=l(o.bibleBookDisplay);if(S.length){if(g.key==="ArrowDown")g.preventDefault(),i(x=>Math.min(x+1,S.length-1));else if(g.key==="ArrowUp")g.preventDefault(),i(x=>Math.max(x-1,0));else if((g.key==="Enter"||g.key==="Tab")&&w>=0&&S[w]){const x=S[w],b=d(x.label,r);if(!b)return;v({bibleBookDisplay:x.label,locatorValue:((V=b.la)==null?void 0:V.abbr)??o.locatorValue}),p(!1)}}},onFocus:()=>p(!0),onBlur:()=>window.setTimeout(()=>p(!1),100),placeholder:c.bibleBookPlaceholder})]}),j&&l(o.bibleBookDisplay,!0).length>0&&e.jsx("div",{className:"cogita-lookup-results",children:l(o.bibleBookDisplay,!0).map((g,S)=>e.jsx("button",{type:"button",className:"cogita-lookup-option","data-active":S===w,tabIndex:-1,onMouseDown:()=>{var x;const V=d(g.label,r);V&&v({bibleBookDisplay:g.label,locatorValue:((x=V.la)==null?void 0:x.abbr)??o.locatorValue})},children:e.jsx("strong",{children:g.label})},g.latin))})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:c.bibleRestLabel}),e.jsx("input",{type:"text",value:o.locatorAux,onChange:g=>v({locatorAux:g.target.value}),placeholder:c.bibleRestPlaceholder})]})]}),o.sourceKind==="website"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceUrlLabel}),e.jsx("input",{type:"text",value:o.sourceUrl,onChange:g=>v({sourceUrl:g.target.value}),placeholder:n.cogita.library.add.info.sourceUrlPlaceholder})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceAccessedDateLabel}),e.jsx("input",{type:"text",value:o.sourceAccessedDate,onChange:g=>v({sourceAccessedDate:g.target.value}),placeholder:n.cogita.library.add.info.sourceAccessedDatePlaceholder})]})]}),o.sourceKind==="number_document"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:t,infoType:"work",label:c.churchDocumentLabel,placeholder:c.churchDocumentPlaceholder,value:o.churchDocument,onChange:g=>v({churchDocument:g}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:c.locatorLabel}),e.jsx("input",{type:"text",value:o.locatorValue,onChange:g=>v({locatorValue:g.target.value}),placeholder:c.locatorPlaceholder})]})]}),o.sourceKind==="work"&&e.jsx(Yt,{libraryId:t,infoType:"work",label:c.workLabel,placeholder:c.workPlaceholder,value:o.work,onChange:g=>v({work:g}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),o.sourceKind==="book"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:t,infoType:"media",label:c.bookLabel,placeholder:c.bookPlaceholder,value:o.bookMedia,onChange:g=>v({bookMedia:g}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.media),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:c.locatorLabel}),e.jsx("input",{type:"text",value:o.locatorValue,onChange:g=>v({locatorValue:g.target.value}),placeholder:c.locatorPlaceholder})]})]}),o.sourceKind!=="website"&&o.sourceKind!=="bible"&&o.sourceKind!=="book"&&o.sourceKind!=="number_document"&&e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:c.locatorLabel}),e.jsx("input",{type:"text",value:o.locatorValue,onChange:g=>v({locatorValue:g.target.value}),placeholder:c.locatorPlaceholder})]})]})}const _a=JSON.stringify({type:"selection",title:"Question title",question:"Question text",options:["Option A","Option B","Option C"],answer:[0]},null,2);function Ya(t="selection"){return t==="matching"?{type:t,title:"",question:"",columns:[[""],[""]],answer:{paths:[]},matchingPaths:[["",""]]}:t==="ordering"?{type:t,title:"",question:"",options:[""]}:t==="truefalse"?{type:t,title:"",question:"",answer:!0}:t==="text"||t==="date"?{type:t,title:"",question:"",answer:""}:t==="number"?{type:t,title:"",question:"",answer:""}:{type:t,title:"",question:"",options:[""],answer:[]}}function bi(t){return["selection","truefalse","text","number","date","matching","ordering"].includes(t)}function Da(t){if(!t||typeof t!="object")return null;const n=t,r=typeof n.type=="string"?n.type:typeof n.kind=="string"?n.kind:"selection",s=r==="multi_select"||r==="single_select"?"selection":r==="boolean"?"truefalse":r==="order"?"ordering":r,o=bi(s)?s:"selection",h=typeof n.title=="string"?n.title:"",c=typeof n.question=="string"?n.question:"";if(o==="matching"){let w=[];Array.isArray(n.columns)?w=n.columns.map(g=>Array.isArray(g)?g.map(S=>typeof S=="string"?S:""):[""]):Array.isArray(n.left)&&Array.isArray(n.right)&&(w=[n.left.map(g=>typeof g=="string"?g:""),n.right.map(g=>typeof g=="string"?g:"")]),w.length<2&&(w=[[""],[""]]);const i=n.answer&&typeof n.answer=="object"?n.answer:null,l=(Array.isArray(i==null?void 0:i.paths)?i==null?void 0:i.paths:Array.isArray(n.correctPairs)?n.correctPairs:[]).map(g=>Array.isArray(g)?g.map(S=>Number(S)).filter(S=>Number.isInteger(S)&&S>=0):[]).filter(g=>g.length>0),d=Array.isArray(n.matchingPaths)?n.matchingPaths.map(g=>Array.isArray(g)?Array.from({length:w.length},(S,V)=>String(g[V]??"")):new Array(w.length).fill("")):null,v=d&&d.length>0?d:[...l.map(g=>g.map(String)),new Array(w.length).fill("")];return{type:o,title:h,question:c,columns:w,answer:{paths:l},matchingPaths:v}}if(o==="ordering"){const w=Array.isArray(n.options)?n.options.map(i=>typeof i=="string"?i:""):Array.isArray(n.items)?n.items.map(i=>typeof i=="string"?i:""):[""];return{type:o,title:h,question:c,options:w.length?w:[""]}}if(o==="truefalse"){const w=typeof n.answer=="boolean"?n.answer:typeof n.expected=="boolean"?n.expected:!0;return{type:o,title:h,question:c,answer:w}}if(o==="number")return typeof n.answer=="number"?{type:o,title:h,question:c,answer:n.answer}:typeof n.answer=="string"?{type:o,title:h,question:c,answer:n.answer}:typeof n.expected=="number"?{type:o,title:h,question:c,answer:n.expected}:{type:o,title:h,question:c,answer:""};if(o==="text"||o==="date"){const w=typeof n.answer=="string"?n.answer:typeof n.expected=="string"?n.expected:"";return{type:o,title:h,question:c,answer:w}}const j=Array.isArray(n.options)?n.options.map(w=>typeof w=="string"?w:""):[""],p=Array.isArray(n.answer)?n.answer.map(w=>Number(w)).filter(w=>Number.isInteger(w)&&w>=0):Array.isArray(n.correct)?n.correct.map(w=>Number(w)).filter(w=>Number.isInteger(w)&&w>=0):[];return{type:o,title:h,question:c,options:j.length?j:[""],answer:p}}function yi(t){const n=(t.title??"").trim(),r=(t.question??"").trim();switch(t.type){case"matching":{const s=(t.columns??[[""],[""]]).map(m=>m.map(l=>l.trim()).filter(Boolean)).filter(m=>m.length>0),o=s.length>=2?s:[[""],[""]],h=t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[],c=(t.matchingPaths??[]).map(m=>m.map(l=>String(l??""))),j=o.length,p=c.map(m=>m.slice(0,j).map(l=>l.trim())).filter(m=>m.some(Boolean)).map(m=>m.map(l=>Number(l))).filter(m=>m.length===j&&m.every(l=>Number.isInteger(l)&&l>=0)),w=(Array.isArray(h)?h:[]).map(m=>Array.isArray(m)?m.map(l=>Number(l)).filter(l=>Number.isInteger(l)&&l>=0):[]).filter(m=>m.length===j),i=Array.from(new Set([...w,...p].map(m=>JSON.stringify(m)))).map(m=>JSON.parse(m));return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,columns:o,answer:{paths:i}},null,2)}case"ordering":{const s=(t.options??[]).map(o=>o.trim()).filter(Boolean);return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,options:s},null,2)}case"truefalse":return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,answer:!!t.answer},null,2);case"number":return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,answer:typeof t.answer=="number"||typeof t.answer=="string"?t.answer:""},null,2);case"date":case"text":return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,answer:String(t.answer??"")},null,2);case"selection":default:{const s=(t.options??[]).map(c=>c.trim()).filter(Boolean),o=Array.isArray(t.answer)?t.answer:[],h=Array.from(new Set(o.filter(c=>Number.isInteger(c)&&c>=0&&c<s.length))).sort((c,j)=>c-j);return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,options:s,answer:h},null,2)}}}const ks=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}];function za(){return{sourceKind:"string",locatorValue:"",locatorAux:"",bibleBookDisplay:"",sourceUrl:"",sourceAccessedDate:"",churchDocument:null,bookMedia:null,work:null}}function Ns(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function Ss(t,n){if(!t||typeof t!="object")return n;const r=t,s=r.definition&&typeof r.definition=="object"?r.definition:null,o=[r.label,r.name,r.title,r.text,r.orcid,r.email,r.number];s&&o.unshift(s.title,s.question);for(const h of o)if(typeof h=="string"&&h.trim())return h.trim();return n}function Ts(t,n){var s;if(!(t instanceof Us))return n;const r=(s=t.message)==null?void 0:s.trim();if(!r)return n;try{const o=JSON.parse(r);if(typeof o.error=="string"&&o.error.trim())return o.error.trim()}catch{}return r}function xi(t){const n=t.trim();if(!n)return null;try{const r=JSON.parse(n);return r&&typeof r=="object"&&!Array.isArray(r)?r:null}catch{return null}}function ra(t,n){const r=t==null?void 0:t[n];return typeof r=="string"?r:""}function vi(t,n){return n?t==="book"&&n.infoType==="media"?{bookMedia:n}:t==="work"&&n.infoType==="work"?{work:n}:t==="number_document"&&n.infoType==="work"?{churchDocument:n}:{}:{}}function ji(t,n){const r=za(),s=(t.sourceKind??"").trim()||r.sourceKind,o=t.locator??"",h=xi(o);let c="",j="",p="",w="",i="";return s==="website"?(w=ra(h,"url"),i=ra(h,"accessedDate"),c=ra(h,"value")):s==="bible"?(c=ra(h,"book")||o.trim(),j=ra(h,"passage")||ra(h,"rest"),p=ra(h,"bookDisplay")):h?(c=ra(h,"value")||ra(h,"locator"),j=ra(h,"aux")):c=o,{...r,sourceKind:s,locatorValue:c,locatorAux:j,bibleBookDisplay:p,sourceUrl:w,sourceAccessedDate:i,...vi(s,n)}}function An(t){return t.sourceKind==="book"?t.bookMedia:t.sourceKind==="work"?t.work:t.sourceKind==="number_document"?t.churchDocument:null}function $n(t){const n=t.locatorValue.trim(),r=t.locatorAux.trim(),s=t.sourceUrl.trim(),o=t.sourceAccessedDate.trim();switch(t.sourceKind){case"website":return{url:s,accessedDate:o};case"bible":return{book:n,bookDisplay:t.bibleBookDisplay.trim(),passage:r};case"book":case"work":case"number_document":return r?{value:n,aux:r}:n;default:return r?{value:n,aux:r}:n}}function Cs(t){var o,h,c;const n=t.locatorValue.trim(),r=t.locatorAux.trim(),s=[n,r].filter(Boolean).join(" ");switch(t.sourceKind){case"website":return t.sourceUrl.trim()||"website";case"bible":return s||"bible";case"book":return[(o=t.bookMedia)==null?void 0:o.label,s].filter(Boolean).join(" · ")||"book";case"work":return[(h=t.work)==null?void 0:h.label,s].filter(Boolean).join(" · ")||"work";case"number_document":return[(c=t.churchDocument)==null?void 0:c.label,s].filter(Boolean).join(" · ")||"number_document";default:return s||t.sourceKind||"source"}}function Is(t){return t.sourceKind.trim()?t.sourceKind==="website"?!!t.sourceUrl.trim():t.sourceKind==="bible"?!!(t.locatorValue.trim()&&t.locatorAux.trim()):t.sourceKind==="book"?!!t.bookMedia:t.sourceKind==="work"?!!t.work:t.sourceKind==="number_document"?!!(t.churchDocument&&t.locatorValue.trim()):!!t.locatorValue.trim():!1}function wi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,libraryId:i,editInfoId:m}){var Ie,Be,Xe;const{libraryName:l}=da(i),d=!!m,[v,g]=a.useState([]),[S,V]=a.useState("word"),[x,b]=a.useState({}),[D,q]=a.useState({}),[y,W]=a.useState({}),[N,P]=a.useState({}),[M,T]=a.useState(null),[Q,ge]=a.useState("idle"),[ye,Oe]=a.useState(za),[R,I]=a.useState({}),[Z,_]=a.useState({}),[ae,Y]=a.useState({}),[ve,le]=a.useState(null),[se,Te]=a.useState(()=>Da(JSON.parse(_a))??Ya()),[Ae,Ee]=a.useState(_a),$e=a.useMemo(()=>v.find(K=>K.infoType===S),[S,v]),et=a.useMemo(()=>v.find(K=>K.infoType==="source"),[v]),ct=a.useMemo(()=>v.map(K=>({value:K.infoType,label:nt(t,K.infoType)})),[t,v]),Ce=K=>{const $=Da(K)??Ya(),B=yi($);Te($),b(F=>({...F,definition:B}))};a.useEffect(()=>{let K=!1;return fr({libraryId:i}).then($=>{var B;if(!K&&(g($),!d)){const F=(B=$[0])==null?void 0:B.infoType;F&&V(F)}}).catch(()=>{K||g([])}),()=>{K=!0}},[d,i]),a.useEffect(()=>{if(d||!$e)return;const K={},$={},B={},F={};for(const k of $e.payloadFields)$e.infoType==="question"&&k.key==="definition"&&k.inputType==="json"?K[k.key]=_a:K[k.key]="";for(const k of $e.linkFields)k.multiple?B[k.key]=[]:$[k.key]=null,k.targetTypes.length>0&&(F[k.key]=k.targetTypes[0]);b(K),q($),W(B),P(F)},[$e==null?void 0:$e.infoType,d]),a.useEffect(()=>{if(S!=="question")return;const K=x.definition??"";if(!K.trim()){const $=Da(JSON.parse(_a))??Ya();Te($),Ee(_a);return}try{const $=JSON.parse(K),B=Da($);if(!B)return;Te(B),Ee(JSON.stringify($,null,2))}catch{}},[x.definition,S]),a.useEffect(()=>{if(!d||!m||v.length===0)return;let K=!1;return ge("loading"),T(null),(async()=>{const B=await na({libraryId:i,infoId:m});if(K)return;const F=B.infoType;V(F);const k=v.find(X=>X.infoType===F);if(!k){ge("idle");return}const C=B.payload??{},A={};for(const X of k.payloadFields)A[X.key]=Ns(C[X.key]);b(A);const ue=B.links??{}??{},be={},he={},ee={},E=[];for(const X of k.linkFields){X.targetTypes.length>0&&(ee[X.key]=X.targetTypes[0]);const re=ue[X.key];if(X.multiple){const G=Array.isArray(re)?re.filter(te=>typeof te=="string"):[];he[X.key]=[];for(const te of G)E.push(na({libraryId:i,infoId:te}).then(xe=>{if(K)return;const U={id:te,infoType:xe.infoType,label:Ss(xe.payload,te)};ee[X.key]=U.infoType,he[X.key]=[...he[X.key],U]}).catch(()=>{}))}else{const G=typeof re=="string"?re:null;be[X.key]=null,G&&E.push(na({libraryId:i,infoId:G}).then(te=>{if(K)return;const xe={id:G,infoType:te.infoType,label:Ss(te.payload,G)};ee[X.key]=xe.infoType,be[X.key]=xe}).catch(()=>{}))}}await Promise.all(E),!K&&(q(be),W(he),P(ee),ge("idle"))})().catch(()=>{K||(T("Failed to load info details."),ge("idle"))}),()=>{K=!0}},[m,d,i,v]),a.useEffect(()=>{S==="source"&&Oe(ji(x,D.resource??null))},[S,x.sourceKind,x.locator,(Ie=D.resource)==null?void 0:Ie.id,(Be=D.resource)==null?void 0:Be.infoType,(Xe=D.resource)==null?void 0:Xe.label]);const We=K=>{var k,C;const $=((k=et==null?void 0:et.payloadFields.find(A=>A.key==="sourceKind"))==null?void 0:k.keepOnCreate)??!1,B=((C=et==null?void 0:et.linkFields.find(A=>A.key==="resource"))==null?void 0:C.keepOnCreate)??!1,F=za();return F.sourceKind=$?K.sourceKind:F.sourceKind,B&&(F.work=K.work,F.bookMedia=K.bookMedia,F.churchDocument=K.churchDocument),$&&K.sourceKind==="bible"&&(F.locatorValue=K.locatorValue,F.bibleBookDisplay=K.bibleBookDisplay),$&&K.sourceKind==="website"&&(F.sourceUrl=K.sourceUrl,F.sourceAccessedDate=K.sourceAccessedDate),F},xt=a.useMemo(()=>({sourceKindLabel:t.cogita.library.add.info.sourceKindLabel,bibleBookLabel:t.cogita.library.add.info.sourceBibleBookLabel,bibleBookPlaceholder:t.cogita.library.add.info.sourceBibleBookPlaceholder,bibleRestLabel:t.cogita.library.add.info.sourceBibleRestLabel,bibleRestPlaceholder:t.cogita.library.add.info.sourceBibleRestPlaceholder,churchDocumentLabel:t.cogita.library.add.info.sourceResourceLabel,churchDocumentPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,workLabel:t.cogita.library.add.info.sourceResourceLabel,workPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,bookLabel:t.cogita.library.add.info.sourceResourceLabel,bookPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,locatorLabel:t.cogita.library.list.typeFilterLocator,locatorPlaceholder:t.cogita.library.list.typeFilterLocator}),[t]),Ve=async K=>{const $=Z[K]??za();if(!Is($)){Y(B=>({...B,[K]:t.cogita.library.add.info.referenceMissingSource}));return}le(K),Y(B=>({...B,[K]:null}));try{const B=An($),F=B?{resource:B.id}:{},k={label:Cs($),sourceKind:$.sourceKind.trim(),locator:$n($)},A={id:(await qn({libraryId:i,infoType:"source",payload:k,links:F})).infoId,infoType:"source",label:k.label};if(W(ue=>{const be=ue[K]??[];return be.some(he=>he.id===A.id)?ue:{...ue,[K]:[...be,A]}}),d&&m){const ue=await na({libraryId:i,infoId:m}),be=ue.links&&typeof ue.links=="object"?{...ue.links}:{},he=be[K],ee=Array.isArray(he)?he.filter(E=>typeof E=="string"):typeof he=="string"?[he]:[];ee.includes(A.id)||(be[K]=[...ee,A.id],await cs({libraryId:i,infoId:m,payload:ue.payload,links:be}))}_(ue=>({...ue,[K]:We($)})),Y(ue=>({...ue,[K]:null}))}catch(B){Y(F=>({...F,[K]:Ts(B,t.cogita.library.lookup.createFailed)}))}finally{le(B=>B===K?null:B)}},De=async()=>{var B;if(!$e)return;const K={};for(const F of $e.payloadFields){if(S==="source"&&(F.key==="sourceKind"||F.key==="locator"))continue;const k=(x[F.key]??"").trim();if(!k){if(F.required){T(`Field '${F.label}' is required.`);return}continue}if(F.inputType==="json")try{K[F.key]=JSON.parse(k)}catch{T(`Field '${F.label}' must be valid JSON.`);return}else K[F.key]=k}const $={};for(const F of $e.linkFields)if(!(S==="source"&&F.key==="resource"))if(F.multiple){const k=(y[F.key]??[]).map(C=>C.id);if(F.required&&k.length===0){T(`Link '${F.label}' is required.`);return}k.length>0&&($[F.key]=k)}else{const k=((B=D[F.key])==null?void 0:B.id)??null;if(F.required&&!k){T(`Link '${F.label}' is required.`);return}k&&($[F.key]=k)}if(S==="source"){if(!Is(ye)){T(t.cogita.library.add.info.referenceMissingSource);return}const F=ye.sourceKind.trim();K.sourceKind=F,K.locator=$n(ye),(typeof K.label!="string"||!K.label.trim())&&(K.label=Cs(ye));const k=An(ye);k&&($.resource=k.id)}ge("saving"),T(null);try{if(d&&m)await cs({libraryId:i,infoId:m,payload:K,links:$}),T("Info updated.");else{await qn({libraryId:i,infoType:S,payload:K,links:$}),T("Info saved.");const F={};for(const A of $e.payloadFields)F[A.key]=A.keepOnCreate?x[A.key]??"":"";b(F);const k={},C={};for(const A of $e.linkFields)A.multiple?C[A.key]=A.keepOnCreate?y[A.key]??[]:[]:k[A.key]=A.keepOnCreate?D[A.key]??null:null;q(A=>({...A,...k})),W(A=>({...A,...C})),S==="source"&&Oe(A=>{const ue=We(A),be=An(ue);return b(he=>({...he,sourceKind:ue.sourceKind,locator:Ns($n(ue))})),q(he=>({...he,resource:be})),be&&P(he=>({...he,resource:be.infoType})),ue})}}catch(F){T(Ts(F,"Failed to save info."))}finally{ge("idle")}},tt=K=>{const $=x[K.key]??"";if(S==="question"&&K.key==="definition"&&K.inputType==="json"){const F=se.type,k=E=>{const X=se.title??"",re=se.question??"";Ce({...Ya(E),title:X,question:re})},C=E=>E.length===0?[""]:E[E.length-1].trim()?[...E,""]:E,A=E=>{const X=(E.length?E:[[""],[""]]).map(re=>C(re));return X.length>=2?X:[...X,[""]]},ue=(E,X)=>{const re=E.map(te=>Array.from({length:X},(xe,U)=>te[U]??"")).filter(te=>te.some(xe=>xe.trim())||te===E[E.length-1]);return re.length===0?[new Array(X).fill("")]:re[re.length-1].some(te=>te.trim())?[...re,new Array(X).fill("")]:re},be=Array.isArray(se.answer)?se.answer:[],he=A(se.columns??[[""],[""]]),ee=ue(se.matchingPaths??[[]],he.length);return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:K.label}),e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.8rem"},children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question type"}),e.jsxs("select",{value:F,onChange:E=>k(E.target.value),children:[e.jsx("option",{value:"selection",children:"Selection"}),e.jsx("option",{value:"truefalse",children:"True / false"}),e.jsx("option",{value:"text",children:"Text answer"}),e.jsx("option",{value:"number",children:"Number answer"}),e.jsx("option",{value:"date",children:"Date answer"}),e.jsx("option",{value:"matching",children:"Matching"}),e.jsx("option",{value:"ordering",children:"Right order"})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Title"}),e.jsx("input",{type:"text",value:se.title??"",onChange:E=>Ce({...se,title:E.target.value}),placeholder:"Optional title"})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question"}),e.jsx("textarea",{rows:3,value:se.question??"",onChange:E=>Ce({...se,question:E.target.value}),placeholder:"Question text"})]}),F==="selection"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Options / correct indices"}),C(se.options??[""]).map((E,X,re)=>{const G=new Set(be.filter(xe=>Number.isInteger(xe))),te=X===re.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:G.has(X),disabled:!E.trim(),onChange:xe=>{const U=xe.target.checked?[...G,X]:[...G].filter(ie=>ie!==X);Ce({...se,answer:U})}}),e.jsx("input",{type:"text",value:E,placeholder:`Answer ${X+1}`,onChange:xe=>{const U=[...se.options??[""]];U[X]=xe.target.value;const ie=C(U),Le=ie.length-1,qe=be.filter(Ke=>Ke>=0&&Ke<Le);Ce({...se,options:ie,answer:qe})}}),te?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const U=(se.options??[""]).filter((Le,qe)=>qe!==X),ie=be.filter(Le=>Le!==X).map(Le=>Le>X?Le-1:Le);Ce({...se,options:C(U),answer:ie})},children:"Remove"})]},`question-option:${X}`)})]}):null,F==="text"||F==="date"||F==="number"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsx("input",{type:F==="date"?"date":"text",value:typeof se.answer=="string"||typeof se.answer=="number"?String(se.answer):"",onChange:E=>Ce({...se,answer:E.target.value})})]}):null,F==="truefalse"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsxs("select",{value:String(!!se.answer),onChange:E=>Ce({...se,answer:E.target.value==="true"}),children:[e.jsx("option",{value:"true",children:"True"}),e.jsx("option",{value:"false",children:"False"})]})]}):null,F==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Columns"}),he.map((E,X)=>e.jsxs("div",{style:{display:"grid",gap:"0.35rem",border:"1px solid rgba(120,170,220,0.22)",borderRadius:"0.6rem",padding:"0.55rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"0.5rem"},children:[e.jsxs("span",{style:{fontSize:"0.8rem",color:"rgba(184,209,234,0.85)"},children:["Column ",X+1]}),he.length>2?e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const re=he.filter((te,xe)=>xe!==X),G=ee.map(te=>te.filter((xe,U)=>U!==X));Ce({...se,columns:A(re),matchingPaths:ue(G,Math.max(2,re.length))})},children:"Remove column"}):null]}),E.map((re,G)=>{const te=G===E.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",gap:"0.4rem",alignItems:"center"},children:[e.jsx("input",{type:"text",value:re,placeholder:`Option ${G+1}`,onChange:xe=>{const U=he.map(ie=>[...ie]);U[X][G]=xe.target.value,Ce({...se,columns:A(U),matchingPaths:ue(ee,he.length)})}}),te?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const xe=he.map(U=>[...U]);xe[X]=xe[X].filter((U,ie)=>ie!==G),Ce({...se,columns:A(xe),matchingPaths:ue(ee,he.length)})},children:"Remove"})]},`question-column:${X}:row:${G}`)})]},`question-column:${X}`)),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{const E=[...he.map(re=>[...re]),[""]],X=ee.map(re=>[...re,""]);Ce({...se,columns:A(E),matchingPaths:ue(X,E.length)})},children:"Add column"})}),e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Correct paths (0-based indices)"}),ee.map((E,X)=>{const re=X===ee.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:`repeat(${he.length}, minmax(0,1fr)) auto`,gap:"0.35rem",alignItems:"center"},children:[E.map((G,te)=>e.jsx("input",{type:"number",min:0,step:1,value:G,placeholder:`${te}`,onChange:xe=>{const U=ee.map(qe=>[...qe]);U[X][te]=xe.target.value;const ie=ue(U,he.length),Le=ie.map(qe=>qe.map(Ke=>Ke.trim())).filter(qe=>qe.every(Ke=>Ke!=="")).map(qe=>qe.map(Ke=>Number(Ke))).filter(qe=>qe.every(Ke=>Number.isInteger(Ke)&&Ke>=0));Ce({...se,matchingPaths:ie,answer:{paths:Le}})}},`question-path:${X}:${te}`)),re?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const G=ee.filter((U,ie)=>ie!==X),te=ue(G,he.length),xe=te.map(U=>U.map(ie=>ie.trim())).filter(U=>U.every(ie=>ie!=="")).map(U=>U.map(ie=>Number(ie))).filter(U=>U.every(ie=>Number.isInteger(ie)&&ie>=0));Ce({...se,matchingPaths:te,answer:{paths:xe}})},children:"Remove"})]},`question-path:${X}`)})]}):null,F==="ordering"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Ordered options (correct order = listed order)"}),C(se.options??[""]).map((E,X,re)=>{const G=X===re.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)",minWidth:"1.5rem"},children:[X+1,"."]}),e.jsx("input",{type:"text",value:E,placeholder:`Step ${X+1}`,onChange:te=>{const xe=[...se.options??[""]];xe[X]=te.target.value,Ce({...se,options:C(xe)})}}),G?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ce({...se,options:C((se.options??[]).filter((te,xe)=>xe!==X))}),children:"Remove"})]},`question-order:${X}`)})]}):null,e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"JSON import"}),e.jsx("textarea",{rows:8,value:Ae,onChange:E=>Ee(E.target.value),placeholder:"Paste question JSON"}),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{try{const E=JSON.parse(Ae),X=Da(E);if(!X){T("Question JSON must be an object.");return}Ce(X),T(null)}catch{T("Question JSON is invalid.")}},children:"Interpret JSON"})})]})]})]},`payload:${K.key}`)}const B=K.inputType==="textarea"||K.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:K.label}),B?e.jsx("textarea",{rows:K.inputType==="json"?8:4,value:$,onChange:F=>b(k=>({...k,[K.key]:F.target.value})),placeholder:K.key}):e.jsx("input",{type:"text",value:$,onChange:F=>b(k=>({...k,[K.key]:F.target.value})),placeholder:K.key})]},`payload:${K.key}`)},ot=K=>{const $=N[K.key]??K.targetTypes[0],B=K.key==="references"&&K.multiple&&K.targetTypes.includes("source"),F=Z[K.key]??za(),k=R[K.key]??!1,C=ae[K.key];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:K.label}),K.targetTypes.length>1?e.jsx("select",{value:$,onChange:A=>P(ue=>({...ue,[K.key]:A.target.value})),children:K.targetTypes.map(A=>e.jsx("option",{value:A,children:nt(t,A)},`${K.key}:${A}`))}):null,K.multiple?e.jsx(Yt,{libraryId:i,infoType:$,label:K.label,placeholder:K.key,multiple:!0,values:y[K.key]??[],onChangeMultiple:A=>W(ue=>({...ue,[K.key]:A})),allowCreate:!B,searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(Yt,{libraryId:i,infoType:$,label:K.label,placeholder:K.key,value:D[K.key]??null,onChange:A=>q(ue=>({...ue,[K.key]:A})),searchFailedText:"Search failed",createFailedText:"Create failed"}),B?e.jsxs("div",{children:[e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:k,onChange:A=>I(ue=>({...ue,[K.key]:A.target.checked}))}),e.jsx("span",{children:t.cogita.library.add.info.referenceToggle})]}),k?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(ws,{libraryId:i,copy:t,language:p,sourceKindOptions:[...ks],value:F,onChange:A=>_(ue=>({...ue,[K.key]:A})),labels:xt}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>Ve(K.key),disabled:ve===K.key,children:ve===K.key?t.cogita.library.lookup.saving:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.source)})}),C?e.jsx("p",{className:"cogita-library-subtitle",children:C}):null]}):null]}):null]},`link:${K.key}`)},Ye=()=>e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(ws,{libraryId:i,copy:t,language:p,sourceKindOptions:[...ks],value:ye,onChange:Oe,labels:xt})]});return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:d?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${i}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[d?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:S,onChange:K=>V(K.target.value),children:ct.map(K=>e.jsx("option",{value:K.value,children:K.label},K.value))})]}),Q==="loading"&&d?e.jsx("p",{children:"Loading..."}):null,$e&&!(Q==="loading"&&d)?e.jsxs("div",{className:"cogita-form-grid",children:[$e.payloadFields.filter(K=>!(S==="source"&&(K.key==="sourceKind"||K.key==="locator"))).map(tt),S==="source"?Ye():null,$e.linkFields.filter(K=>!(S==="source"&&K.key==="resource")).map(ot)]}):Q==="loading"&&d?null:e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:De,disabled:Q==="saving"||!$e,children:Q==="saving"?"Saving...":d?"Update info":"Create info"})}),M?e.jsx("p",{className:"cogita-library-subtitle",children:M}):null]})})})]})})}const Ms=t=>/\s/.test(t),sn=t=>/[\p{L}\p{N}]/u.test(t),Ls=(t,n)=>{const r=n>0?t[n-1]:"",s=n<t.length?t[n]:"";if(!r||!s)return 0;const o=Ms(r),h=Ms(s);if(o||h)return 3;const c=sn(r),j=sn(s);return c!==j?2:!c&&!j?1:0},Rn=(t,n,r,s,o)=>{const h=Math.max(s-n,r-s);for(let c=0;c<=h;c+=1){const j=s-c;if(j>=n&&j<=r&&Ls(t,j)>=o)return j;const p=s+c;if(p>=n&&p<=r&&Ls(t,p)>=o)return p}return null},Pn=(t,n)=>{const r=n>0?t[n-1]:"",s=n<t.length?t[n]:"";return!r||!s?!0:sn(r)!==sn(s)},ki=(t,n,r,s)=>{const o=r-n,h=n+s,c=r-s;if(o<=s*2||c<=h)return null;const j=Math.floor((n+r)/2),p=Rn(t,h,c,j,3);if(p!==null&&Pn(t,p))return p;const w=Rn(t,h,c,j,2);if(w!==null&&Pn(t,w))return w;const i=Rn(t,h,c,j,1);return i!==null&&Pn(t,i)?i:null},va=(t,n)=>{const r=Math.max(1,(n==null?void 0:n.minLen)??7),s=Math.max(r,(n==null?void 0:n.maxLen)??13),o={},h=(p,w,i,m,l)=>{const d=String(m),v={id:d,start:p,end:w,text:t.slice(p,w),depth:i,index:m,parentId:l};if(o[d]=v,w-p>s){let S=ki(t,p,w,r);if(S!==null&&S>p&&S<w){const V=h(p,S,i+1,m*2+1,d),x=h(S,w,i+1,m*2+2,d);v.leftId=V.id,v.rightId=x.id}}return v},c=h(0,t.length,0,0),j=Object.values(o).sort((p,w)=>w.depth-p.depth||p.start-w.start).map(p=>p.id);return{text:t,rootId:c.id,nodes:o,order:j}},$a=(t,n,r,s,o,h,c)=>{const j=h==="reverse"?t.order.slice().sort((p,w)=>t.nodes[w].start-t.nodes[p].start||t.nodes[w].depth-t.nodes[p].depth):t.order;for(const p of j){if(c&&p===c||n.has(p))continue;const w=t.nodes[p];if(w){if(o&&(w.leftId||w.rightId)){const i=w.leftId?r[w.leftId]??0:s,m=w.rightId?r[w.rightId]??0:s;if((i+m)/2<s)continue}return w}}return null},xn=(t,n)=>({before:t.slice(0,n.start),fragment:t.slice(n.start,n.end),after:t.slice(n.end)});function Ni({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,libraryId:i}){const m=`/#/cogita/library/${i}`,[l,d,v]=Hn([]),[g,S,V]=Wn([]),[x,b]=a.useState(null),[D,q]=a.useState(null),[y,W]=a.useState(null),[N,P]=a.useState(null),M=a.useMemo(()=>l.find(I=>I.id===x)??null,[l,x]);a.useEffect(()=>{let I=!0;return br({libraryId:i}).then(Z=>{if(!I)return;const _=Z.nodes.map(ae=>{var Y,ve,le;return{id:ae.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:ae.payload&&typeof ae.payload=="object"&&"label"in ae.payload?String(ae.payload.label):"Item",nodeType:ae.nodeType,itemType:((Y=ae.payload)==null?void 0:Y.itemType)??"info",itemId:((ve=ae.payload)==null?void 0:ve.itemId)??null,infoType:((le=ae.payload)==null?void 0:le.infoType)??null}}});d(_),S(Z.edges.map(ae=>({id:ae.edgeId,source:ae.fromNodeId,target:ae.toNodeId})))}).catch(()=>{I&&(d([]),S([]))}),()=>{I=!1}},[i]),a.useEffect(()=>{yr({libraryId:i}).then(q).catch(()=>q(null))},[i,l,g]);const T=a.useCallback(I=>{S(Z=>Qn(I,Z))},[]),Q=()=>{const I=crypto.randomUUID();d(Z=>[...Z,{id:I,type:"default",position:{x:140+Z.length*40,y:120+Z.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},ge=()=>{const I=crypto.randomUUID();d(Z=>[...Z,{id:I,type:"default",position:{x:180+Z.length*40,y:160+Z.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},ye=async()=>{W(null);try{const I=l.map(_=>({nodeId:_.id,nodeType:_.data.nodeType,payload:{itemType:_.data.itemType,itemId:_.data.itemId??null,label:_.data.label,infoType:_.data.infoType??null}})),Z=g.map(_=>({edgeId:_.id,fromNodeId:_.source,toNodeId:_.target}));await xr({libraryId:i,nodes:I,edges:Z}),W(t.cogita.library.graph.saveSuccess)}catch{W(t.cogita.library.graph.saveFail)}},Oe=I=>{M&&d(Z=>Z.map(_=>_.id===M.id?{..._,data:{..._.data,itemId:(I==null?void 0:I.infoId)??null,itemType:"collection",infoType:"collection",label:(I==null?void 0:I.label)??t.cogita.library.infoTypes.collection}}:_))},R=I=>{M&&d(Z=>Z.map(_=>_.id===M.id?{..._,data:{..._.data,itemId:(I==null?void 0:I.infoId)??null,itemType:"info",infoType:(I==null?void 0:I.infoType)??null,label:(I==null?void 0:I.label)??t.cogita.library.infoTypes.any}}:_))};return a.useEffect(()=>{if(!M||M.data.nodeType!=="info"||M.data.infoType!=="citation"||!M.data.itemId){P(null);return}let I=!0;return na({libraryId:i,infoId:M.data.itemId}).then(Z=>{if(!I)return;const _=Z.payload,ae=(_==null?void 0:_.text)??"";if(!ae){P(null);return}const Y=va(ae),ve=Object.values(Y.nodes).sort((le,se)=>le.depth-se.depth||le.start-se.start).map(le=>({id:le.id,text:le.text,depth:le.depth}));P({title:(_==null?void 0:_.title)??M.data.label,fragments:ve})}).catch(()=>P(null)),()=>{I=!1}},[i,M]),e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:m,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:ye,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Q,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ge,children:t.cogita.library.actions.addInfo}),D?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(D.totalCollections))})}):null,y?e.jsx("p",{className:"cogita-help",children:y}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(pn,{nodes:l,edges:g,onNodesChange:v,onEdgesChange:V,onConnect:T,onNodeClick:(I,Z)=>b(Z.id),fitView:!0,children:[e.jsx(fn,{gap:18,size:1}),e.jsx(bn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),M?e.jsxs("div",{className:"cogita-graph-inspector",children:[M.data.nodeType==="collection"?e.jsx(Yt,{libraryId:i,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:M.data.itemId?{id:M.data.itemId,label:M.data.label,infoType:"collection"}:null,onChange:Oe,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(Yt,{libraryId:i,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:M.data.itemId?{id:M.data.itemId,label:M.data.label,infoType:M.data.infoType??void 0}:null,onChange:R,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),N?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:N.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:N.fragments.map(I=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:I.id}),e.jsx("span",{children:I.text})]},I.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function es({children:t,flashState:n,flashTick:r=0,feedbackToken:s,className:o}){const h=s??(n?`${n}-${r}`:"idle");return e.jsx("section",{className:o?`cogita-revision-card ${o}`:"cogita-revision-card","data-feedback":h,children:t})}function ts({copy:t,currentCard:n,currentTypeLabel:r,prompt:s,languages:o,answer:h,onAnswerChange:c,computedExpected:j,computedAnswers:p,onComputedAnswerChange:w,answerTemplate:i,outputVariables:m,variableValues:l,computedFieldFeedback:d,feedback:v,canAdvance:g,quoteContext:S,quotePlaceholder:V,onCheckAnswer:x,onSkip:b,onLanguageSelect:D,onMarkReviewed:q,onAdvance:y,showCorrectAnswer:W,setShowCorrectAnswer:N,onRevealCorrect:P,answerMask:M,expectedAnswer:T,hasExpectedAnswer:Q,handleComputedKeyDown:ge,answerInputRef:ye,computedInputRefs:Oe,scriptMode:R,setScriptMode:I,matchPairs:Z,matchLeftOrder:_,matchRightOrder:ae,matchSelection:Y,matchActiveLeft:ve,matchActiveRight:le,matchFeedback:se,onMatchLeftSelect:Te,onMatchRightSelect:Ae,disableCheckAnswer:Ee=!1,hideSkipAction:$e=!1,allowRevealBeforeCheck:et=!1,autoRevealAfterAnswer:ct=!1,disableCheckAfterAnswer:Ce=!1}){const We=a.useMemo(()=>{var X;const $=!i&&j.length===2?`The {${j[0].key}} is of type {${j[1].key}}`:null,B=i??$;if(!B)return null;const F=new Map(j.map(re=>[re.key,re.expected])),k=new Set,C=[],A=/\{([^}]+)\}/g;let ue=0,be,he=null;for(;(be=A.exec(B))!==null;){const re=B.slice(ue,be.index);re&&C.push({type:"text",value:re});const G=((X=be[1])==null?void 0:X.trim())??"",te=G&&F.has(G)?G:G&&m&&m[G]?m[G]:null;G&&k.add(G),te&&k.add(te),te&&F.has(te)?(C.push({type:"input",value:te}),he||(he=te)):G&&l&&l[G]!==void 0?C.push({type:"text",value:l[G]}):C.push({type:"text",value:be[0]}),ue=be.index+be[0].length}const ee=B.slice(ue);return ee&&C.push({type:"text",value:ee}),j.filter(re=>!k.has(re.key)).length>0?null:{parts:C,expectedByKey:F,firstInputKey:he}},[i,j,m,l]),xt=()=>{if(!We)return null;const{parts:$,expectedByKey:B,firstInputKey:F}=We;return e.jsx("div",{className:"cogita-revision-inline-answer",children:$.map((k,C)=>{var A,ue;return k.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:k.value},`text-${C}`):e.jsx("input",{ref:be=>{Oe.current[k.value]=be},autoFocus:k.value===F,value:p[k.value]??"",onChange:be=>w(k.value,be.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":d[k.value]??(v==="correct"?"correct":v==="incorrect"?"incorrect":void 0),onKeyDown:be=>ot(be)||ge(be),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((A=p[k.value])==null?void 0:A.length)??0,((ue=B.get(k.value))==null?void 0:ue.length)??6)}ch`}},`input-${k.value}-${C}`)})})},Ve=a.useMemo(()=>{const $=new Map;return(Z??[]).forEach(B=>$.set(B.leftId,B)),$},[Z]),De=a.useMemo(()=>{const $=new Map;return(Z??[]).forEach(B=>$.set(B.rightId,B)),$},[Z]);a.useEffect(()=>{var C;if(n.cardType!=="info"||n.infoType!=="computed"||j.length===0)return;const $=typeof document<"u"?document.activeElement:null;if($&&($.tagName==="INPUT"||$.tagName==="TEXTAREA"))return;const B=(We==null?void 0:We.firstInputKey)??((C=j[0])==null?void 0:C.key);if(!B)return;const F=Oe.current[B];if(!F)return;const k=requestAnimationFrame(()=>{F.focus()});return()=>cancelAnimationFrame(k)},[n,j,We]);const tt=(()=>{const $=[T??"",...j.map(k=>k.expected??"")].join(""),B=[h,...Object.values(p)].join(""),F=`${$}${B}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(F)})(),ot=$=>$.ctrlKey&&($.key==="^"||$.key==="6")?($.preventDefault(),I(B=>B==="super"?null:"super"),!0):$.ctrlKey&&($.key==="_"||$.key==="-")?($.preventDefault(),I(B=>B==="sub"?null:"sub"),!0):!1,Ye=()=>{if(!T||!M)return T??"";const $=T.split(""),B=Array.from(M),F=B.length>0?B.reduce((k,C)=>k+C,0)/B.length:127;return $.map((k,C)=>{const A=B[C]??F,ue=Math.max(0,Math.min(255,Math.round(A)));let be=255,he=0;return ue<=127?he=Math.round(ue/127*255):(he=255,be=Math.round(255*(1-(ue-127)/128))),e.jsx("span",{style:{color:`rgb(${be}, ${he}, 0)`},children:k},`mask-${C}`)})},Ie=n.cardType==="info"&&n.infoType==="citation"?(S==null?void 0:S.title)||n.label:n.description,Be=W||ct&&v!==null,Xe=Ee||Ce&&(v!==null||Be),K=Q&&(et||v==="incorrect"||Be);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[r?e.jsx("span",{children:r}):null,e.jsx("strong",{children:Ie})]}),n.cardType==="vocab"&&n.checkType==="translation-match"&&Z?e.jsxs("div",{className:"cogita-revision-body",children:[s?e.jsx("h2",{children:s}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(_??[]).map($=>{const B=Ve.get($);if(!B)return null;const F=(Y==null?void 0:Y[$])??null,k=(se==null?void 0:se[$])??null,C=ve===$;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":C,"data-state":k??void 0,"data-locked":F?"true":void 0,onClick:()=>Te==null?void 0:Te($),children:[e.jsx("span",{children:B.leftLabel}),F&&W?e.jsx("em",{children:"✓"}):null]},$)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(ae??[]).map($=>{const B=De.get($);if(!B)return null;const F=Object.values(Y??{}).includes($),k=le===$;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":F||k,"data-locked":F?"true":void 0,onClick:()=>Ae==null?void 0:Ae($),children:e.jsx("span",{children:B.rightLabel})},$)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:n.checkType==="translation-match"||Xe,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:b,children:t.cogita.library.revision.skip})]})]}):n.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:s}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ye,value:h,onChange:$=>c($.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:$=>{if($.key==="Enter")if($.preventDefault(),$.stopPropagation(),g)y();else{if(Xe)return;x()}}})]}),tt?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":R==="super",onClick:()=>I($=>$==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":R==="sub",onClick:()=>I($=>$==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:Xe,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:b,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[n.label?e.jsx("p",{className:"cogita-revision-hint",children:n.label}):null,i?null:e.jsx(vr,{value:s??"",mode:"auto"}),j.length>0?(()=>{const $=xt();return $?e.jsx("div",{className:"cogita-inline-answer-wrap",children:$}):e.jsx("div",{className:"cogita-form-grid",children:j.map((B,F)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:B.key}),e.jsx("textarea",{ref:k=>{Oe.current[B.key]=k},autoFocus:F===0,value:p[B.key]??"",onChange:k=>w(B.key,k.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":d[B.key]??(v==="correct"?"correct":v==="incorrect"?"incorrect":void 0),onKeyDown:k=>ot(k)||ge(k)})]},B.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:ye,value:h,onChange:$=>c($.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:$=>{if(!ot($)&&$.key==="Enter")if($.preventDefault(),$.stopPropagation(),g)y();else{if(Xe)return;x()}}})]})}),tt?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":R==="super",onClick:()=>I($=>$==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":R==="sub",onClick:()=>I($=>$==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:Xe,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:b,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="citation"&&S?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(S.completed)).replace("{total}",String(S.total))}),e.jsx("p",{className:"cogita-quote-text",children:S.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ye,value:h,onChange:$=>c($.target.value),placeholder:V??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:$=>{if($.key==="Enter")if($.preventDefault(),$.stopPropagation(),g)y();else{if(Xe)return;x()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:S.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:Xe,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:b,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:s}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:o.length?o.map($=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>D($.label),children:$.label},$.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:b,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:s}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:q,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:b,children:t.cogita.library.revision.skip})]})]}),v&&e.jsx("div",{className:"cogita-revision-feedback","data-state":v,children:v==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),K?e.jsxs("div",{className:"cogita-revision-reveal",children:[Be?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>N($=>{const B=!$;return B&&P(),B}),children:t.cogita.library.revision.showAnswer}),Be?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),j.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[j.map($=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:$.key}),e.jsx("span",{children:$.expected})]},$.key)),T?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:T})]}):null]}):e.jsx("p",{children:M?Ye():T})]}):null]}):null,g?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:y,children:t.cogita.library.revision.nextQuestion})}):null]})}const As={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},Si=(t,n)=>{const r=Math.max(t.length,n.length,1),s=Math.abs(t.length-n.length);return Math.max(0,1-s/r)},Ti=(t,n)=>{const r=new Uint8Array(t.length),s=Si(t,n);for(let o=0;o<t.length;o+=1){const h=t[o]===(n[o]??"")?128:0,c=t.length-1-o,j=n.length-1-o,p=t[c]===(n[j]??"")?127:0,w=Math.round((h+p)*s);r[o]=Math.max(0,Math.min(255,w))}return r},Ci=(t,n)=>t===n||(As[t]??[]).includes(n)?!0:(As[n]??[]).includes(t),Xa=(t,n,r)=>r?Ci(t,n):t===n,rn=(t,n,r)=>{const s=new Uint8Array(t.length);if(!t.length)return s;const o=(r==null?void 0:r.allowSimilarChars)??!0,h=[];for(let j=0;j<=t.length-3;j+=1)h.push({index:j,text:t.slice(j,j+3)});let c=!1;return h.forEach(j=>{for(let p=0;p<=n.length-3;p+=1){const w=n.slice(p,p+3);let i=0;for(let g=0;g<3;g+=1)Xa(j.text[g],w[g],o)&&(i+=1);if(i<2)continue;let m=j.index-1,l=p-1;for(;m>=0&&l>=0;){const g=t[m],S=n[l];if(g===S){s[m]=Math.max(s[m],255),m-=1,l-=1,c=!0;continue}if(Xa(g,S,o)&&g!==S){s[m]=Math.max(s[m],127),m-=1,l-=1,c=!0;continue}if(m>0&&t[m-1]===S){s[m]=Math.max(s[m],0),m-=1,c=!0;continue}if(l>0&&t[m]===n[l-1]){l-=1,c=!0;continue}break}for(let g=0;g<3;g+=1){const S=j.index+g,V=j.text[g],x=w[g],b=V===x?255:Xa(V,x,o)?127:0;s[S]=Math.max(s[S],b),c=!0}let d=j.index+3,v=p+3;for(;d<t.length&&v<n.length;){const g=t[d],S=n[v];if(g===S){s[d]=Math.max(s[d],255),d+=1,v+=1,c=!0;continue}if(Xa(g,S,o)&&g!==S){s[d]=Math.max(s[d],127),d+=1,v+=1,c=!0;continue}if(d+1<t.length&&t[d+1]===S){s[d]=Math.max(s[d],0),d+=1,c=!0;continue}if(v+1<n.length&&t[d]===n[v+1]){v+=1,c=!0;continue}break}}}),c?s:Ti(t,n)},En=t=>/[\p{L}\p{N}]/u.test(t),$s=t=>t.trim().toLowerCase(),xa=(t,n)=>{if(t.length===0)return 100;const r=(n==null?void 0:n.treatSimilarCharsAsSame)??!1,s=Array.from(t).reduce((o,h)=>r&&h===127?o+255:o+h,0);return Math.round(s/(t.length*255)*100)},Sa=(t,n,r)=>{const s=Math.max(0,Math.min(100,(r==null?void 0:r.thresholdPercent)??100)),o=(r==null?void 0:r.treatSimilarCharsAsSame)??!0,h=(r==null?void 0:r.ignorePunctuationAndSpacing)??!1,c=$s(t),j=$s(n);if(!h){const x=rn(c,j,{allowSimilarChars:o}),b=xa(x,{treatSimilarCharsAsSame:o});return{mask:x,percent:b,isCorrect:b>=s,normalizedExpected:c,normalizedAnswer:j}}const p=Array.from(c),w=Array.from(j),i=[],m=[],l=[];p.forEach((x,b)=>{En(x)&&(i.push(x),m.push(b))}),w.forEach(x=>{En(x)&&l.push(x)});const d=i.join(""),v=l.join(""),g=rn(d,v,{allowSimilarChars:o}),S=new Uint8Array(p.length);for(let x=0;x<S.length;x+=1)S[x]=En(p[x]??"")?0:255;for(let x=0;x<g.length;x+=1){const b=m[x];b!==void 0&&(S[b]=g[x])}const V=xa(g,{treatSimilarCharsAsSame:o});return{mask:S,percent:V,isCorrect:V>=s,normalizedExpected:d,normalizedAnswer:v}},Ra=(t,n,r)=>{const s=t.trim().toLowerCase(),o=n.trim().toLowerCase();return r==="prefix"||r==="bidirectional"?rn(s,o,{allowSimilarChars:!0}):rn(s,o,{allowSimilarChars:!0})};function Ii(t){if(!t||typeof t!="object")return null;const r=t.definition;if(!r||typeof r!="object")return null;const s=r,o=typeof s.type=="string"?s.type:typeof s.kind=="string"?s.kind:"selection",h=o==="multi_select"||o==="single_select"?"selection":o==="boolean"?"truefalse":o==="order"?"ordering":o;if(!["selection","truefalse","text","number","date","ordering","matching"].includes(h))return null;const c=h,j=typeof s.title=="string"?s.title:void 0,p=typeof s.question=="string"?s.question:"",w=Array.isArray(s.options)?s.options.map(l=>typeof l=="string"?l:"").filter(Boolean):void 0,i=Array.isArray(s.columns)?s.columns.map(l=>Array.isArray(l)?l.map(d=>typeof d=="string"?d:"").filter(Boolean):[]).filter(l=>l.length>0):void 0,m=(()=>{if(h==="selection")return(Array.isArray(s.answer)?s.answer:Array.isArray(s.correct)?s.correct:[]).map(d=>Number(d)).filter(d=>Number.isInteger(d)&&d>=0);if(h==="truefalse")return typeof s.answer=="boolean"?s.answer:typeof s.expected=="boolean"?s.expected:!1;if(h==="matching"){const l=s.answer&&typeof s.answer=="object"?s.answer:null;return{paths:(Array.isArray(l==null?void 0:l.paths)?l==null?void 0:l.paths:Array.isArray(s.correctPairs)?s.correctPairs:[]).map(g=>Array.isArray(g)?g.map(S=>Number(S)).filter(S=>Number.isInteger(S)&&S>=0):[]).filter(g=>g.length>0)}}if(typeof s.answer=="string"||typeof s.answer=="number")return s.answer;if(typeof s.expected=="string"||typeof s.expected=="number")return s.expected})();return{type:c,title:j,question:p,options:w,columns:i,answer:m}}function Mi(t){var o;if(t.type!=="matching")return[[]];const n=Math.max(2,((o=t.columns)==null?void 0:o.length)??2);return[...((t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[])??[]).map(h=>Array.from({length:n},(c,j)=>String(h[j]??""))),new Array(n).fill("")]}function Li(t){const n=[...t];for(let r=n.length-1;r>0;r-=1){const s=Math.floor(Math.random()*(r+1));[n[r],n[s]]=[n[s],n[r]]}return n}function ia(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function Rs(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function Ps(t){const n=t.checkType??"info",r=n.startsWith("question-")?`question / ${n.slice(9)}`:n;return t.direction?`${r} / ${t.direction}`:r}function Ai({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,libraryId:i,infoId:m,selectedReviewerRoleId:l}){const[d,v]=a.useState(m),[g,S]=a.useState([]),[V,x]=a.useState([]),[b,D]=a.useState("loading"),[q,y]=a.useState(null),[W,N]=a.useState(null),[P,M]=a.useState(null),[T,Q]=a.useState(null),[ge,ye]=a.useState(""),[Oe,R]=a.useState(null),[I,Z]=a.useState(1),[_,ae]=a.useState(null),[Y,ve]=a.useState(0),[le,se]=a.useState(!1),[Te,Ae]=a.useState(null),[Ee,$e]=a.useState({}),[et,ct]=a.useState({}),[Ce]=a.useState({}),[We,xt]=a.useState(null),[Ve,De]=a.useState({selection:[],booleanAnswer:null,ordering:[],matchingRows:[[]]}),tt=a.useRef(null),ot=a.useRef({}),Ye=mn();a.useEffect(()=>{let ee=!1;return D("loading"),Promise.all([na({libraryId:i,infoId:m}).catch(()=>null),tn({libraryId:i,infoId:m}),an({libraryId:i,infoId:m})]).then(([E,X,re])=>{if(ee)return;const G=(E==null?void 0:E.payload)??{},te=typeof G.title=="string"&&G.title||typeof G.label=="string"&&G.label||typeof G.name=="string"&&G.name||m;v(te),N(G),M((E==null?void 0:E.infoType)??null),S(X.items),x(re.items),D("ready")}).catch(()=>{ee||(N(null),M(null),S([]),x([]),D("error"))}),()=>{ee=!0}},[i,m]),a.useEffect(()=>{if(P!=="translation"){Q(null);return}qs({libraryId:i,infoId:m,approachKey:"vocab-card"}).then(ee=>Q(ee.projection??null)).catch(()=>Q(null))},[P,m,i]);const Ie=a.useMemo(()=>{var xe;const ee=new Map(g.map(U=>[ia(U),U])),E=new Map,X=new Map;for(const U of g)E.set(ia(U),0),X.set(ia(U),[]);for(const U of V){const ie=Rs({parentItemId:U.parentItemId,parentCheckType:U.parentCheckType,parentDirection:U.parentDirection}),Le=[U.childItemId,U.childCheckType??"",U.childDirection??""].join("|");!ee.has(ie)||!ee.has(Le)||((xe=X.get(ie))==null||xe.push(Le),E.set(Le,(E.get(Le)??0)+1))}const re=Array.from(E.entries()).filter(([,U])=>U===0).map(([U])=>U),G=new Map;for(const U of re)G.set(U,0);for(;re.length;){const U=re.shift(),ie=G.get(U)??0;for(const Le of X.get(U)??[]){const qe=Math.max(G.get(Le)??0,ie+1);G.set(Le,qe),E.set(Le,(E.get(Le)??1)-1),(E.get(Le)??0)<=0&&re.push(Le)}}const te=new Map;for(const U of g){const ie=ia(U),Le=G.get(ie)??0,qe=te.get(Le)??[];qe.push(ie),te.set(Le,qe)}return g.map(U=>{const ie=ia(U),Le=G.get(ie)??0,qe=te.get(Le)??[ie],Ke=Math.max(0,qe.indexOf(ie));return{id:ie,position:{x:40+Ke*290+(Le%2?18:0),y:30+Le*120},draggable:!1,selectable:!0,data:{label:U.label,subtitle:Ps(U),checkType:U.checkType??"info",direction:U.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[g,V]),Be=a.useMemo(()=>new Map(g.map(ee=>[ia(ee),ee])),[g]),Xe=a.useMemo(()=>{const ee=[];for(const E of V){const X=Rs({parentItemId:E.parentItemId,parentCheckType:E.parentCheckType,parentDirection:E.parentDirection}),re=[E.childItemId,E.childCheckType??"",E.childDirection??""].join("|");!Be.has(X)||!Be.has(re)||ee.push({id:`${X}->${re}`,source:X,target:re,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return ee},[Be,V]),K=a.useMemo(()=>q?Be.get(q)??null:null,[Be,q]);a.useEffect(()=>{ye(""),ae(null),ve(0),se(!1),Ae(null),R(null),ct({}),De({selection:[],booleanAnswer:null,ordering:[],matchingRows:[[]]})},[q]);const $=a.useMemo(()=>{var G,te;if(!K)return null;const ee=P??K.infoType??null,E=K.checkType??"info",X=K.direction??null,re=W??{};if(K.cardType==="vocab"&&T&&Array.isArray(T.words)){const xe=T.words,U=((G=xe[0])==null?void 0:G.label)??"?",ie=((te=xe[1])==null?void 0:te.label)??"?";return X==="a-to-b"?{kind:"vocab",prompt:String(U),expected:String(ie)}:X==="b-to-a"?{kind:"vocab",prompt:String(ie),expected:String(U)}:{kind:"generic",prompt:`${U} ↔ ${ie}`,expected:`${U} ↔ ${ie}`}}if(ee==="citation"&&E==="quote-fragment"&&X&&typeof re.text=="string"){const xe=X,U=va(re.text),ie=U.nodes[xe];if(ie){const Le=xn(re.text,ie);return{kind:"citation-fragment",expected:ie.text,quoteContext:{title:d,before:Le.before,after:Le.after,total:Object.keys(U.nodes).length,completed:0},quotePlaceholder:ie.text.length>0?".".repeat(Math.max(4,Math.min(18,ie.text.length))):"..."}}}if(ee==="question"){const xe=Ii(re);if(xe)return{kind:"question",definition:xe}}return{kind:"generic",prompt:K.description||K.label,expected:K.label}},[P,W,K,d,T]);a.useEffect(()=>{if(!$||$.kind!=="question")return;const ee=$.definition;De({selection:[],booleanAnswer:null,ordering:ee.type==="ordering"?Li(ee.options??[]):[],matchingRows:ee.type==="matching"?Mi(ee):[[]]})},[$,q]);const B=async ee=>{if(K&&l)try{await jr({libraryId:i,outcome:{itemType:"info",itemId:K.cardId,checkType:K.checkType??"info",direction:K.direction??null,revisionType:"direct",evalType:"direct-check",correct:ee,clientId:"cogita-info-checkcards",clientSequence:I,personRoleId:l}}),Z(E=>E+1),R(ee?"Saved as correct.":"Saved as incorrect.")}catch{R("Failed to save answer.")}},F=K?ia(K):null,k=F?!!Ee[F]:!1,C=async()=>{var re;if(!K||!$)return;const ee=ia(K);if(Ee[ee]){R("This card was already checked.");return}let E=!1,X=null;if($.kind==="question"){const G=$.definition;if(G.type==="selection"){const te=Array.isArray(G.answer)?[...G.answer].sort((U,ie)=>U-ie):[],xe=[...Ve.selection].sort((U,ie)=>U-ie);E=te.length===xe.length&&te.every((U,ie)=>U===xe[ie])}else if(G.type==="truefalse")E=typeof G.answer=="boolean"&&Ve.booleanAnswer!==null&&G.answer===Ve.booleanAnswer;else if(G.type==="ordering"){const te=(G.options??[]).join(`
`),xe=Ve.ordering.join(`
`),U=Sa(te,xe,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});E=U.isCorrect,X=U.mask}else if(G.type==="matching"){const te=Math.max(2,((re=G.columns)==null?void 0:re.length)??2),xe=Ve.matchingRows.map(qe=>qe.slice(0,te).map(Ke=>Ke.trim())).filter(qe=>qe.every(Ke=>Ke!=="")).map(qe=>qe.map(Ke=>Number(Ke))).filter(qe=>qe.every(Ke=>Number.isInteger(Ke)&&Ke>=0)).map(qe=>JSON.stringify(qe)),U=(G.answer&&typeof G.answer=="object"&&"paths"in G.answer?G.answer.paths:[]).map(qe=>JSON.stringify(qe)),ie=Array.from(new Set(xe)).sort(),Le=Array.from(new Set(U)).sort();E=ie.length===Le.length&&ie.every((qe,Ke)=>qe===Le[Ke])}else{const te=String(G.answer??""),xe=Sa(te,ge,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});E=xe.isCorrect,X=xe.mask}Ae(X),se(!0)}else{const G=$.expected,te=$.kind==="citation-fragment",xe=Sa(G,ge,{thresholdPercent:te?90:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:te});E=xe.isCorrect,Ae(xe.mask),se(!0)}ae(E?"correct":"incorrect"),ve(G=>G+1),R(l?null:"Answer checked locally (not saved: no person selected)."),$e(G=>({...G,[ee]:!0})),l&&await B(E)},A=()=>{if(!K||!$)return;const ee=ia(K);if(Ee[ee]||($e(X=>({...X,[ee]:!0})),R("Answer revealed (not saved).")),$.kind==="question"){Ae(null);return}const E=Sa($.expected,$.expected,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:$.kind==="citation-fragment"});Ae(E.mask)},ue=a.useMemo(()=>K?K.infoType==="question"?{...K,description:K.label}:K.infoType==="citation"?{...K,description:d}:{...K,description:K.label}:null,[K,d]),be=ee=>{const E=ee.definition,X=k||le,re=E.type==="matching"?(()=>{var qe;const xe=Math.max(2,((qe=E.columns)==null?void 0:qe.length)??2),ie=(Ve.matchingRows.length?Ve.matchingRows:[new Array(xe).fill("")]).map(Ke=>Array.from({length:xe},(Je,bt)=>Ke[bt]??""));return ie[ie.length-1].some(Ke=>Ke.trim())?[...ie,new Array(xe).fill("")]:ie})():[],G=Array.isArray(E.answer)?E.answer:[],te=E.answer&&typeof E.answer=="object"&&"paths"in E.answer?E.answer.paths:[];return e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:E.question||(K==null?void 0:K.label)}),E.title?e.jsx("p",{className:"cogita-revision-hint",children:E.title}):null,E.type==="selection"?e.jsx("div",{className:"cogita-choice-grid",style:{gridTemplateColumns:"1fr"},children:(E.options??[]).map((xe,U)=>e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.6rem"},children:[e.jsx("input",{type:"checkbox",checked:Ve.selection.includes(U),disabled:X,onChange:ie=>De(Le=>({...Le,selection:ie.target.checked?Array.from(new Set([...Le.selection,U])):Le.selection.filter(qe=>qe!==U)}))}),e.jsx("span",{children:xe})]},`q-opt:${U}`))}):null,E.type==="truefalse"?e.jsxs("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:[e.jsx("button",{type:"button",className:"ghost","data-active":Ve.booleanAnswer===!0,disabled:X,onClick:()=>De(xe=>({...xe,booleanAnswer:!0})),children:"True"}),e.jsx("button",{type:"button",className:"ghost","data-active":Ve.booleanAnswer===!1,disabled:X,onClick:()=>De(xe=>({...xe,booleanAnswer:!1})),children:"False"})]}):null,E.type==="text"||E.type==="number"||E.type==="date"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:tt,type:E.type==="date"?"date":"text",value:ge,onChange:xe=>ye(xe.target.value),disabled:X,"data-state":_==="correct"?"correct":_==="incorrect"?"incorrect":void 0})]}):null,E.type==="ordering"?e.jsx("div",{style:{display:"grid",gap:"0.45rem"},children:Ve.ordering.map((xe,U)=>e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)"},children:[U+1,"."]}),e.jsx("span",{children:xe}),e.jsx("button",{type:"button",className:"ghost",disabled:X||U===0,onClick:()=>De(ie=>{const Le=[...ie.ordering];return[Le[U-1],Le[U]]=[Le[U],Le[U-1]],{...ie,ordering:Le}}),children:"Up"}),e.jsx("button",{type:"button",className:"ghost",disabled:X||U>=Ve.ordering.length-1,onClick:()=>De(ie=>{const Le=[...ie.ordering];return[Le[U+1],Le[U]]=[Le[U],Le[U+1]],{...ie,ordering:Le}}),children:"Down"})]},`q-order:${U}:${xe}`))}):null,E.type==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.65rem"},children:[(E.columns??[]).map((xe,U)=>e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.35rem",padding:"0.6rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:`Column ${U+1}`}),xe.map((ie,Le)=>e.jsx("div",{className:"cogita-library-hint",children:`${Le}: ${ie}`},`q-col:${U}:${Le}`))]},`q-col:${U}`)),e.jsxs("div",{style:{display:"grid",gap:"0.4rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:"Paths (0-based indices)"}),re.map((xe,U)=>{var Le;const ie=U===re.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:`repeat(${Math.max(2,((Le=E.columns)==null?void 0:Le.length)??2)}, minmax(0, 1fr)) auto`,gap:"0.35rem",alignItems:"center"},children:[xe.map((qe,Ke)=>e.jsx("input",{type:"number",min:0,step:1,value:qe,disabled:X,onChange:Je=>De(bt=>{var Ct;const mt=Math.max(2,((Ct=E.columns)==null?void 0:Ct.length)??2),pt=(bt.matchingRows.length?bt.matchingRows:[new Array(mt).fill("")]).map(Ot=>Array.from({length:mt},(Et,Nt)=>Ot[Nt]??""));return pt[U]=pt[U]??new Array(mt).fill(""),pt[U][Ke]=Je.target.value,pt[pt.length-1].some(Ot=>Ot.trim())&&pt.push(new Array(mt).fill("")),{...bt,matchingRows:pt}})},`q-path:${U}:${Ke}`)),ie?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",disabled:X,onClick:()=>De(qe=>{var mt;const Ke=Math.max(2,((mt=E.columns)==null?void 0:mt.length)??2),Je=qe.matchingRows.filter((pt,wt)=>wt!==U);return Je.length===0&&Je.push(new Array(Ke).fill("")),Je[Je.length-1].some(pt=>pt.trim())&&Je.push(new Array(Ke).fill("")),{...qe,matchingRows:Je}}),children:"Remove"})]},`q-path:${U}`)})]})]}):null,e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>void C(),disabled:X,children:t.cogita.library.revision.checkAnswer})}),le?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),E.type==="selection"?e.jsx("p",{children:G.length?G.map(xe=>{var U;return`${xe}${(U=E.options)!=null&&U[xe]?`: ${E.options[xe]}`:""}`}).join(", "):"-"}):E.type==="truefalse"?e.jsx("p",{children:String(!!E.answer)}):E.type==="ordering"?e.jsx("ol",{children:(E.options??[]).map((xe,U)=>e.jsx("li",{children:xe},`ans-order:${U}`))}):E.type==="matching"?e.jsx("div",{style:{display:"grid",gap:"0.35rem"},children:te.length?te.map((xe,U)=>e.jsx("p",{children:xe.join(" → ")},`ans-path:${U}`)):e.jsx("p",{children:"-"})}):e.jsx("p",{children:String(E.answer??"")})]}):e.jsx("div",{className:"cogita-revision-reveal",children:e.jsx("button",{type:"button",className:"ghost",onClick:()=>{se(!0),A()},children:t.cogita.library.revision.showAnswer})})]})},he=a.useMemo(()=>P?nt(t,P):t.cogita.library.infoTypes.any,[t,P]);return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:he}),e.jsx("h2",{className:"cogita-card-title",children:d}),e.jsx("p",{className:"cogita-card-subtitle",children:m})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${g.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${V.length}`}),e.jsx("button",{type:"button",className:"cta",disabled:g.length===0,onClick:()=>Ye(`/cogita/library/${i}/revision/run?libraryTarget=revisions&scope=info&infoId=${encodeURIComponent(m)}`),children:"Start revision"})]})]}),b==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):b==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(pn,{nodes:Ie,edges:Xe,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:(ee,E)=>y(E.id),panOnDrag:!0,children:[e.jsx(fn,{}),e.jsx(bn,{showInteractive:!1})]})}),K?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[$&&ue?e.jsx(es,{flashState:_,flashTick:Y,children:$.kind==="question"?be($):e.jsx(ts,{copy:t,currentCard:ue,currentTypeLabel:"",prompt:$.kind==="citation-fragment"?null:$.prompt,languages:[],answer:ge,onAnswerChange:ye,computedExpected:[],computedAnswers:et,onComputedAnswerChange:(ee,E)=>ct(X=>({...X,[ee]:E})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:Ce,feedback:_,canAdvance:!1,quoteContext:$.kind==="citation-fragment"?$.quoteContext:null,quotePlaceholder:$.kind==="citation-fragment"?$.quotePlaceholder:null,onCheckAnswer:()=>void C(),onSkip:()=>y(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:le,setShowCorrectAnswer:se,onRevealCorrect:A,answerMask:Te,expectedAnswer:$.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:tt,computedInputRefs:ot,scriptMode:We,setScriptMode:xt,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:k||le,hideSkipAction:!0,allowRevealBeforeCheck:!0,autoRevealAfterAnswer:!0,disableCheckAfterAnswer:!0})}):null,l?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),Oe?e.jsx("p",{className:"cogita-library-hint",children:Oe}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:g.map(ee=>{const E=ia(ee),X=q===E;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${X?"active":""}`,onClick:()=>y(E),children:[e.jsx("span",{children:ee.label}),e.jsx("small",{children:Ps(ee)})]},E)})})]})]})]})})})})})}function Za(t,n){var r,s;return((s=(r=t.fields.find(o=>o.fieldType===n))==null?void 0:r.plainValue)==null?void 0:s.trim())??""}function $i(t){return Za(t,"role_kind").toLowerCase()==="person"}function Ri(t){return Za(t,"label")||Za(t,"display_name")||Za(t,"name")||t.roleId}function Pi({copy:t,onPersonCreated:n}){const[r,s]=a.useState([]),[o,h]=a.useState("loading"),[c,j]=a.useState(null),[p,w]=a.useState(!1),[i,m]=a.useState(""),l=async()=>{h("loading");try{const g=await Js();s(g),h("ready")}catch{s([]),h("error")}};a.useEffect(()=>{l()},[]);const d=a.useMemo(()=>r.filter($i).map(g=>({roleId:g.roleId,label:Ri(g)})).sort((g,S)=>g.label.localeCompare(S.label)),[r]),v=async()=>{const g=i.trim();if(!g){j("Name is required.");return}w(!0),j(null);try{const S=await wr({fields:[{fieldType:"nick",plainValue:g},{fieldType:"role_kind",plainValue:"person"},{fieldType:"label",plainValue:g},{fieldType:"display_name",plainValue:g}]});m(""),j("Person role created."),n==null||n(S.roleId),await l()}catch{j("Failed to create person role.")}finally{w(!1)}};return e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-browser-panel",children:[e.jsx("div",{className:"cogita-info-overview-head",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Cogita"}),e.jsx("h2",{className:"cogita-card-title",children:"Persons"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Select reviewer persons in the header and create new person roles here."})]})}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Create"}),e.jsx("h3",{className:"cogita-detail-title",children:"New person role"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{type:"text",value:i,onChange:g=>m(g.target.value),placeholder:"e.g. Anna Kowalska",disabled:p})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:p,children:p?"Creating...":"Create person"})}),c?e.jsx("p",{className:"cogita-library-hint",children:c}):null]})]}),e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Overview"}),e.jsx("h3",{className:"cogita-detail-title",children:"All person roles"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[o==="loading"?e.jsx("p",{children:"Loading persons..."}):null,o==="error"?e.jsx("p",{children:"Failed to load persons."}):null,o==="ready"&&d.length===0?e.jsx("p",{children:"No person roles found."}):null,o==="ready"&&d.length>0?e.jsxs("div",{className:"cogita-details-grid",children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:"Name"}),e.jsx("span",{children:"Type"}),e.jsx("span",{children:"Role ID"}),e.jsx("span",{})]}),d.map(g=>e.jsxs("div",{className:"cogita-details-row",role:"row",children:[e.jsx("span",{}),e.jsx("span",{title:g.label,children:g.label}),e.jsx("span",{children:"person"}),e.jsx("span",{title:g.roleId,children:g.roleId}),e.jsx("span",{})]},g.roleId))]}):null]})]})]})]})})})})}function Ei({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,libraryId:i,collectionId:m}){const{libraryName:l}=da(i),[d,v]=a.useState([]),[g,S]=a.useState("loading"),[V,x]=a.useState("idle"),b=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),D=`/#/cogita/library/${i}`,q=()=>{S("loading"),Hs({libraryId:i}).then(N=>{v(N),S("idle")}).catch(()=>{v([]),S("error")})};a.useEffect(()=>{q()},[i]);const y=async N=>{try{await Ws({libraryId:i,shareId:N}),q()}catch{q()}},W=async N=>{const P=`${b}/${N}`;try{await navigator.clipboard.writeText(P),x("copied")}catch{x("failed")}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:D,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${D}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[g==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):g==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):d.filter(N=>!m||N.collectionId===m).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:d.filter(N=>!m||N.collectionId===m).map(N=>e.jsxs("div",{className:"cogita-share-row","data-state":N.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:N.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(N.createdUtc).toLocaleString(),N.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),N.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${b}/${N.shareCode}`}):null]}),N.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[N.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>W(N.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>y(N.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},N.shareId))}),V==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):V==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function Fi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,libraryId:i}){const{libraryName:m}=da(i),[l,d]=a.useState(null),[v,g]=a.useState(null),[S,V]=a.useState(null),[x,b]=a.useState(null),[D,q]=a.useState(null),[y,W]=a.useState(null),N=a.useRef(null),P=Q=>{if(!Number.isFinite(Q))return"0 B";if(Q<1024)return`${Q} B`;const ge=Q/1024;if(ge<1024)return`${ge.toFixed(1)} KB`;const ye=ge/1024;return ye<1024?`${ye.toFixed(1)} MB`:`${(ye/1024).toFixed(1)} GB`},M=async()=>{d(null),q({loadedBytes:0,totalBytes:null,percent:null});try{d(t.cogita.library.overview.exporting);const Q=await kr(i,q),ge=URL.createObjectURL(Q),ye=document.createElement("a");ye.href=ge,ye.download=`cogita-library-${m||i}.json`,ye.click(),URL.revokeObjectURL(ge),d(t.cogita.library.overview.exportReady)}catch{d(t.cogita.library.overview.exportFail)}finally{q(Q=>Q??{loadedBytes:0,totalBytes:null,percent:null})}},T=async Q=>{var ye;g(null),V(null),b(null);const ge=(ye=Q.target.files)==null?void 0:ye[0];if(ge)try{g(t.cogita.library.overview.importing),W({loadedBytes:0,totalBytes:ge.size,percent:0});const Oe=await Nr(i,ge,W,R=>{const I=R.stage==="infos"?t.cogita.library.overview.importStageInfos:R.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;b(t.cogita.library.overview.importLiveProgress.replace("{stage}",I).replace("{done}",String(R.processed)).replace("{total}",String(R.total)).replace("{infos}",String(R.infos)).replace("{connections}",String(R.connections)).replace("{collections}",String(R.collections)))});V({infos:Oe.infosImported,connections:Oe.connectionsImported,collections:Oe.collectionsImported}),g(t.cogita.library.overview.importDone)}catch(Oe){const R=Oe instanceof Us&&Oe.message?` ${Oe.message}`:"";g(`${t.cogita.library.overview.importFail}${R}`)}finally{N.current&&(N.current.value="")}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:m}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:M,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:N,type:"file",accept:"application/json",onChange:T})]})]}),D?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:D.percent??void 0,max:D.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",P(D.loadedBytes)).replace("{total}",D.totalBytes?P(D.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,y?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:y.percent??void 0,max:y.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",P(y.loadedBytes)).replace("{total}",y.totalBytes?P(y.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,l?e.jsx("p",{className:"cogita-help",children:l}):null,v?e.jsx("p",{className:"cogita-help",children:v}):null,x?e.jsx("p",{className:"cogita-help",children:x}):null,S?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(S.infos)).replace("{connections}",String(S.connections)).replace("{collections}",String(S.collections))}):null]})]})})})]})})}function Ki({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,libraryId:i}){const{libraryName:m}=da(i),[l,d]=a.useState(""),[v,g]=a.useState([]),S=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:m}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:V=>d(V.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const V=l.trim();V&&(g(x=>[{id:S(),name:V},...x]),d(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[v.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,v.map(V=>e.jsx("button",{type:"button",className:"ghost",children:V.name},V.id))]})]})]})})})]})})}function _i({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,libraryId:i}){const{libraryName:m}=da(i),[l,d]=a.useState(""),[v,g]=a.useState([]),S=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:m}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:V=>d(V.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const V=l.trim();V&&(g(x=>[{id:S(),name:V},...x]),d(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[v.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,v.map(V=>e.jsx("button",{type:"button",className:"ghost",children:V.name},V.id))]})]})]})})})]})})}function Di({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,libraryId:i}){const{libraryName:m}=da(i),l=`/#/cogita/library/${i}`,[d,v]=a.useState(""),[g,S]=a.useState([]),[V,x]=a.useState("idle"),[b,D]=a.useState(0),[q,y]=a.useState(null);a.useEffect(()=>{x("loading");const N=window.setTimeout(()=>{Va({libraryId:i,query:d.trim()||void 0,limit:30}).then(P=>{S(P.items),D(P.total),y(P.nextCursor??null),x("ready")}).catch(()=>{S([]),D(0),y(null),x("ready")})},240);return()=>window.clearTimeout(N)},[i,d]);const W=async()=>{if(q){x("loading");try{const N=await Va({libraryId:i,query:d.trim()||void 0,limit:30,cursor:q});S(P=>[...P,...N.items]),y(N.nextCursor??null),D(N.total),x("ready")}catch{x("ready")}}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:m}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${l}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:d,onChange:N=>v(N.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(g.length)).replace("{total}",String(b||g.length))}),e.jsx("span",{children:V==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:g.length?g.map(N=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${l}/collections/${N.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:N.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(N.itemCount))," ·"," ",N.notes||t.cogita.library.collections.noNotes]})]})},N.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${l}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),q?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:W,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const Ne=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,ea=(t,n,r,s)=>`${t}:${n}:${r??""}:${s??""}`;function Bi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,libraryId:i,collectionId:m}){da(i);const l=`/#/cogita/library/${i}`,[d,v]=a.useState(t.cogita.library.collections.defaultName),[g,S]=a.useState(null),[V,x]=a.useState(0),[b,D]=a.useState([]),[q,y]=a.useState("idle"),[W,N]=a.useState(null),P=a.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(b.length)).replace("{total}",String(V||b.length)),[t,b.length,V]);a.useEffect(()=>{yn(i,m).then(T=>{v(T.name),S(T.notes??null),x(T.itemCount)}).catch(()=>{v(t.cogita.library.collections.defaultName),S(null)})},[i,m]),a.useEffect(()=>{y("loading"),qa({libraryId:i,collectionId:m,limit:40}).then(T=>{D(T.items),N(T.nextCursor??null),x(T.total),y("ready")}).catch(()=>{D([]),N(null),y("ready")})},[i,m]);const M=async()=>{if(W){y("loading");try{const T=await qa({libraryId:i,collectionId:m,limit:40,cursor:W});D(Q=>[...Q,...T.items]),N(T.nextCursor??null),x(T.total),y("ready")}catch{y("ready")}}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:d}),e.jsx("p",{className:"cogita-library-subtitle",children:g||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${l}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${l}/collections/${m}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${l}/collections/${m}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:P}),e.jsx("span",{children:q==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:b.length?b.map(T=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:T.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:T.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:T.label}),e.jsx("p",{className:"cogita-card-subtitle",children:T.description})]})},Ne(T))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),W?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:M,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${l}/collections/${m}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const Es=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],zi={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},Oi=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Vi=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function qi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,libraryId:i,onCreated:m}){const l=Ja(),{libraryName:d}=da(i),v=`/#/cogita/library/${i}`,[g,S]=a.useState(null),[V,x]=a.useState(""),[b,D]=a.useState(""),[q,y,W]=Hn([]),[N,P,M]=Wn([]),[T,Q]=a.useState(null),[ge,ye]=a.useState(null),Oe=a.useRef(null),R=a.useMemo(()=>q.find(Y=>Y.id===T)??null,[q,T]);a.useEffect(()=>{const Y=new URLSearchParams(l.search),ve=(Y.get("draft")??"").trim(),le=(Y.get("draftType")??"").trim();if(!ve||le!=="info-selection"||Oe.current===ve)return;const se=di(i,ve);if(!se||se.infoIds.length===0)return;const Te=crypto.randomUUID(),Ae=se.infoIds.length>1?crypto.randomUUID():null,Ee=se.infoIds.map((Ce,We)=>({id:crypto.randomUUID(),type:"default",position:{x:80,y:80+We*100},data:{nodeType:"source.info",label:"Selected info",params:{infoId:Ce,infoType:"any"}}})),$e=Ae?[{id:Ae,type:"default",position:{x:360,y:120+Math.max(0,(se.infoIds.length-1)*50)},data:{nodeType:"logic.or",label:"Selected infos",params:{}}}]:[],et={id:Te,type:"default",position:{x:660,y:140+Math.max(0,(se.infoIds.length-1)*35)},data:{nodeType:"output.collection",label:"Collection output",params:{}}},ct=Ee.map(Ce=>({id:crypto.randomUUID(),source:Ce.id,target:Ae??Te}));Ae&&ct.push({id:crypto.randomUUID(),source:Ae,target:Te}),y([...Ee,...$e,et]),P(ct),Q(Te),ye(`Draft loaded from ${se.infoIds.length} selected infos. Set name and save to create collection.`),Oe.current=ve},[i,l.search,P,y]);const I=Y=>{var Te;const ve=crypto.randomUUID(),le=((Te=Es.find(Ae=>Ae.type===Y))==null?void 0:Te.label)??Y,se={...zi[Y]};y(Ae=>[...Ae,{id:ve,type:"default",position:{x:120+Ae.length*40,y:120+Ae.length*40},data:{nodeType:Y,label:le,params:se}}]),Q(ve)},Z=a.useCallback(Y=>{P(ve=>Qn({...Y,id:crypto.randomUUID()},ve))},[P]),_=Y=>{R&&y(ve=>ve.map(le=>le.id===R.id?{...le,data:{...le.data,params:Y}}:le))},ae=async()=>{if(ye(null),!V.trim()){ye(t.cogita.library.collections.saveRequiredName);return}try{const Y={nodes:q.map(se=>({nodeId:se.id,nodeType:se.data.nodeType,payload:{position:se.position,params:se.data.params}})),edges:N.map(se=>({edgeId:se.id,fromNodeId:se.source,fromPort:se.sourceHandle??null,toNodeId:se.target,toPort:se.targetHandle??null}))};let ve=g,le=!1;if(ve)await Qs({libraryId:i,collectionId:ve,nodes:Y.nodes,edges:Y.edges});else{const se=await Sr({libraryId:i,name:V.trim(),notes:b.trim()||void 0,items:[],graph:Y});ve=se.collectionId,le=!0,S(se.collectionId)}ye(le?t.cogita.library.collections.saveSuccess:t.cogita.library.graph.saveSuccess),m(ve)}catch{ye(g?t.cogita.library.graph.saveFail:t.cogita.library.collections.saveFail)}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.createKicker}),e.jsx("h1",{className:"cogita-library-title",children:d}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.createSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${v}/collections`,children:t.cogita.library.actions.collections}),e.jsx("button",{type:"button",className:"cta",onClick:ae,children:t.cogita.library.actions.saveCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.collectionInfoTitle}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{value:V,onChange:Y=>x(Y.target.value),placeholder:t.cogita.library.collections.namePlaceholder})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.notesLabel}),e.jsx("textarea",{value:b,onChange:Y=>D(Y.target.value),placeholder:t.cogita.library.collections.notesPlaceholder})]}),ge?e.jsx("p",{className:"cogita-help",children:ge}):null,e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Es.map(Y=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>I(Y.type),children:Y.label},Y.type))})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(pn,{nodes:q,edges:N,onNodesChange:W,onEdgesChange:M,onConnect:Z,onNodeClick:(Y,ve)=>Q(ve.id),fitView:!0,children:[e.jsx(fn,{color:"rgba(120,160,200,0.2)"}),e.jsx(bn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),R?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:R.data.label}),R.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:i,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:R.data.params.tagId?{id:R.data.params.tagId,label:R.data.params.tagLabel??"",infoType:"topic"}:null,onChange:Y=>_({...R.data.params,tagId:(Y==null?void 0:Y.id)??null,tagLabel:(Y==null?void 0:Y.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:R.data.params.scope??"any",onChange:Y=>_({...R.data.params,scope:Y.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),R.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:i,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:R.data.params.languageId?{id:R.data.params.languageId,label:R.data.params.languageLabel??"",infoType:"language"}:null,onChange:Y=>_({...R.data.params,languageId:(Y==null?void 0:Y.id)??null,languageLabel:(Y==null?void 0:Y.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:R.data.params.scope??"any",onChange:Y=>_({...R.data.params,scope:Y.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),R.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:R.data.params.infoType??"word",onChange:Y=>_({...R.data.params,infoType:Y.target.value}),children:Vi.map(Y=>e.jsx("option",{value:Y.value,children:Y.label},Y.value))})]}),e.jsx(Yt,{libraryId:i,infoType:R.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:R.data.params.infoId?{id:R.data.params.infoId,label:R.data.params.infoLabel??"",infoType:R.data.params.infoType??"word"}:null,onChange:Y=>_({...R.data.params,infoId:(Y==null?void 0:Y.id)??null,infoLabel:(Y==null?void 0:Y.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),R.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:R.data.params.connectionType??"translation",onChange:Y=>_({...R.data.params,connectionType:Y.target.value}),children:Oi.map(Y=>e.jsx("option",{value:Y.value,children:Y.label},Y.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:R.data.params.connectionId??"",onChange:Y=>_({...R.data.params,connectionId:Y.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(R.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const la=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const n=t.length,r=t.filter(h=>h.correct).length,s=vn(as(t));return{score:Math.round(Math.max(0,Math.min(100,s.knowness*100))*100)/100,total:n,correct:r,lastReviewedUtc:s.lastReviewedUtc??null}},Ui=t=>{if(t.maskBase64)try{const n=Tr(t.maskBase64);if(!n.length)return t.correct?1:0;const r=n.reduce((s,o)=>s+o,0);return Math.max(0,Math.min(1,r/n.length/255))}catch{return t.correct?1:0}return t.correct?1:0},as=t=>t.map(n=>({correctness:Ui(n),createdUtc:n.createdUtc})),vn=(t,n=Date.now())=>{var V;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const s=t.slice().sort((x,b)=>x.createdUtc.localeCompare(b.createdUtc)).slice(-5),o=s.reduce((x,b)=>x+b.correctness,0)/s.length,h=5,c=2,j=.15;let p=0,w=0;for(let x=0;x<s.length;x+=1){const b=new Date(s[x].createdUtc).getTime(),D=x===s.length-1?n:new Date(s[x+1].createdUtc).getTime(),q=Math.max(0,(D-b)/(1e3*60)),y=1-Math.exp(-q/h);p+=y,s[x].correctness>.5&&(w+=j)}let i=o*p*c+w;const m=((V=s[s.length-1])==null?void 0:V.createdUtc)??null,l=m?Math.max(0,(n-new Date(m).getTime())/(1e3*60)):0,v=1/(1+Math.log1p(l/60));return i*=v,s.length===1&&s[0].correctness>.5&&(i+=5.44*Math.exp(-l/2)),{knowness:i,avgCorrectness:o,lastReviewedUtc:m}},Ua=t=>{const n=t.slice();for(let r=n.length-1;r>0;r-=1){const s=Math.floor(Math.random()*(r+1));[n[r],n[s]]=[n[s],n[r]]}return n},en=t=>t[Math.floor(Math.random()*t.length)],Ji=(t,n)=>{const r=new Map;return t.forEach(s=>r.set(s,Math.random())),t.sort((s,o)=>{const h=n(s)-n(o);return h!==0?h:(r.get(s)??0)-(r.get(o)??0)})},jn=(t,n,r,s,o)=>{if(!t.length)return null;const h=t.filter(j=>!(o!=null&&o.has(Ne(j))));if(h.length===0)return null;const c=h.filter(j=>Ne(j)!==r);return en(c.length?c:h)},Hi=(t,n,r,s,o)=>{if(!t.length)return null;let h=Number.POSITIVE_INFINITY;for(const w of t){const i=Ne(w);if(r.has(i))continue;const m=n[i]??1;m<h&&(h=m)}if(!Number.isFinite(h))return null;const c=t.filter(w=>{const i=Ne(w);return!r.has(i)&&(n[i]??1)===h}),j=c.filter(w=>!o||Ne(w)!==o),p=s?j.filter(w=>!s.has(Ne(w))):j;return p.length>0?en(p):j.length>0?en(j):o&&c.some(w=>Ne(w)===o)?c.find(w=>Ne(w)===o)??null:c.length?en(c):null},tr=(t,n,r,s,o)=>{const h=[],c=t.filter(p=>!o.has(Ne(p))&&!r.has(Ne(p))&&(n[Ne(p)]??0)<1),j=Ji(c,p=>n[Ne(p)]??0);for(const p of j){if(h.length>=s)break;h.push(p),o.add(Ne(p))}if(h.length<s){const p=Ua(t.filter(w=>!o.has(Ne(w))&&r.has(Ne(w))));for(const w of p){if(h.length>=s)break;h.push(w),o.add(Ne(w))}}return h},Wi=(t,n,r,s)=>tr(t,n,r,s,new Set),ns=(t,n,r,s,o,h)=>{const c=Math.max(1,r.stackSize??n),p=Ua(t).filter((v,g,S)=>S.findIndex(V=>Ne(V)===Ne(v))===g),w=Wi(p,s,o,c),i=new Set,m=new Set,l=jn(w,{},null,i,m),d=l?[l]:[];return l&&m.add(Ne(l)),{queue:d,meta:{pool:p,active:w,knownessMap:s,unknownSet:o,outcomesById:h,asked:i,queued:m}}},Jn={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,n)=>{const s=Ua(t).filter((o,h,c)=>c.findIndex(j=>Ne(j)===Ne(o))===h);return{queue:s.slice(0,Math.min(n,s.length)),meta:{}}},applyOutcome:t=>t},ss=(t,n,r,s)=>{const o=Math.max(1,r.stackSize??n),c=Ua(t).filter((g,S,V)=>V.findIndex(x=>Ne(x)===Ne(g))===S),j={},p=new Set,w=new Set,i=new Set,m=Math.max(1,r.levels??1);c.forEach(g=>{const S=Ne(g),V=s==null?void 0:s[S],x=typeof V=="number"&&Number.isFinite(V)?V:1;j[S]=Math.min(m,Math.max(1,Math.round(x)))});const l=[];if(c.length>0){const g=new Map;c.forEach(V=>{var b;const x=j[Ne(V)]??1;g.has(x)||g.set(x,[]),(b=g.get(x))==null||b.push(V)});const S=Array.from(g.keys()).sort((V,x)=>V-x);for(const V of S){if(l.length>=o)break;const x=Ua(g.get(V)??[]);for(const b of x){if(l.length>=o)break;l.push(b)}}}const d=jn(l,j,null,p,w),v=d?[d]:[];return d&&w.add(Ne(d)),{queue:v,meta:{pool:c,active:l,levelMap:j,asked:p,queued:w,wrongSinceCorrect:i}}},Qi={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,r)=>ss(t,n,r),applyOutcome:(t,n,r,s,o)=>{if(!n)return t;const h=Math.max(1,s.levels??1),c=t.meta.pool??[],j=t.meta.active??[],p={...t.meta.levelMap??{}},w=new Set(t.meta.asked??[]),i=new Set(t.meta.queued??[]),m=new Set(t.meta.wrongSinceCorrect??[]),l=Ne(n);i.delete(l),w.add(l);const d=p[l]??1;o.correct?(p[l]=m.has(l)?1:Math.min(d+1,h),m.delete(l)):(p[l]=1,m.add(l));const v=o.correct?j.filter(V=>Ne(V)!==l):j.slice();if(o.correct&&v.length<Math.max(1,s.stackSize??1)){const V=new Set(v.map(b=>Ne(b))),x=Hi(c,p,V,w,l);x&&v.push(x)}const g=t.queue.slice(),S=jn(v,p,l,w,i);return S&&(g.push(S),i.add(Ne(S))),{queue:g,meta:{pool:c,active:v,levelMap:p,asked:w,queued:i,wrongSinceCorrect:m}}}},Gi={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,r)=>ns(t,n,r,{},new Set,{}),applyOutcome:(t,n,r,s,o)=>{if(!n)return t;const h=t.meta.pool??[],c=t.meta.active??[],j={...t.meta.knownessMap??{}},p=new Set(t.meta.unknownSet??[]),w={...t.meta.outcomesById??{}},i=new Set(t.meta.asked??[]),m=new Set(t.meta.queued??[]),l=Ne(n);m.delete(l),i.add(l);const d={correctness:Math.max(0,Math.min(1,o.correctness??(o.correct?1:0))),createdUtc:o.createdUtc??new Date().toISOString()},g=(w[l]??[]).concat(d).sort((q,y)=>q.createdUtc.localeCompare(y.createdUtc)).slice(-5);w[l]=g,p.delete(l);const S=Date.now();h.forEach(q=>{const y=Ne(q),W=w[y]??[];if(W.length===0){j[y]=0,p.add(y);return}const N=vn(W,S);j[y]=N.knowness});const V=c.slice();if((j[l]??0)>=1){const q=V.filter(y=>Ne(y)!==l);V.length=0,V.push(...q)}const b=Math.max(1,s.stackSize??r);if(V.length<b){const q=new Set(V.map(W=>Ne(W))),y=tr(h,j,p,b-V.length,q);V.push(...y)}const D=t.queue.slice();if(D.length===0||Ne(D[D.length-1])===l){const q=jn(V,{},l,i,m);q&&(D.push(q),m.add(Ne(q)))}return{queue:D,meta:{pool:h,active:V,knownessMap:j,unknownSet:p,outcomesById:w,asked:i,queued:m}}}},ar={random:Jn,levels:Qi,temporal:Gi},Yi=Object.values(ar),rs=t=>{if(!t)return Jn;const n=t.trim().toLowerCase();return n==="random"||n==="levels"||n==="temporal"?ar[n]:Jn},wn=(t,n)=>{const r={...t.defaultSettings};return n&&Object.entries(n).forEach(([s,o])=>{typeof o=="number"&&Number.isFinite(o)&&(r[s]=o),typeof o=="string"&&(r[s]=o)}),t.settingsFields.forEach(s=>{var h;const o=r[s.key];if(s.type==="number"){if(typeof o!="number"||Number.isNaN(o)){r[s.key]=t.defaultSettings[s.key]??0;return}s.min!==void 0&&(r[s.key]=Math.max(s.min,r[s.key])),s.max!==void 0&&(r[s.key]=Math.min(s.max,r[s.key]));return}if(s.type==="select"){const c=((h=s.options)==null?void 0:h.map(j=>j.value))??[];(typeof o!="string"||c.length>0&&!c.includes(o))&&(r[s.key]=t.defaultSettings[s.key]??c[0]??"")}}),r},nr=(t,n)=>{const r={};return t.settingsFields.forEach(s=>{const o=n.get(s.key);if(o){if(s.type==="number"){const h=Number(o);Number.isNaN(h)||(r[s.key]=h);return}r[s.key]=o}}),wn(t,r)},Xi=(t,n)=>{const r=new URLSearchParams;return t.settingsFields.forEach(s=>{const o=n[s.key];(typeof o=="number"||typeof o=="string")&&r.set(s.key,String(o))}),r};function Fs({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,libraryId:i,collectionId:m,revisionId:l}){const d=mn(),{libraryName:v}=da(i),g=`/#/cogita/library/${i}`,[S,V]=a.useState(t.cogita.library.collections.defaultName),[x,b]=a.useState([]),[D,q]=a.useState(m??""),[y,W]=a.useState(""),[N,P]=a.useState(20),[M,T]=a.useState("random"),[Q,ge]=a.useState({}),[ye,Oe]=a.useState("exact"),[R,I]=a.useState([]),[Z,_]=a.useState(null),[ae,Y]=a.useState([]),[ve,le]=a.useState([]),[se,Te]=a.useState(""),[Ae,Ee]=a.useState("idle"),[$e,et]=a.useState(null),[ct,Ce]=a.useState("idle"),[We,xt]=a.useState("idle"),[Ve,De]=a.useState("idle"),tt=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),ot=a.useMemo(()=>rs(M),[M]),Ye=a.useMemo(()=>wn(ot,Q),[ot,Q]),Ie=a.useMemo(()=>Xi(ot,Ye).toString(),[ot,Ye]),Be=a.useMemo(()=>{const k=se.trim().toLocaleLowerCase();return k?ve.filter(C=>C.name.toLocaleLowerCase().includes(k)):ve},[se,ve]);a.useEffect(()=>{q(m??"")},[m]),a.useEffect(()=>{if(!D){V(t.cogita.library.collections.defaultName);return}yn(i,D).then(k=>V(k.name)).catch(()=>V(t.cogita.library.collections.defaultName))},[t.cogita.library.collections.defaultName,i,D]),a.useEffect(()=>{Va({libraryId:i,limit:200}).then(k=>b(k.items.map(C=>({collectionId:C.collectionId,name:C.name})))).catch(()=>b([]))},[i]),a.useEffect(()=>{Gn({libraryId:i}).then(k=>le(k)).catch(()=>le([]))},[i]),a.useEffect(()=>{l&&Zn({libraryId:i,revisionId:l}).then(k=>{q(k.collectionId),W(k.name),T(k.mode||"random"),Oe(k.check||"exact"),P(k.limit||20),ge(k.revisionSettings??{})}).catch(()=>{W("")})},[i,l]),a.useEffect(()=>{Gs({libraryId:i}).then(k=>{I(k),!Z&&k.length>0&&_(k[0].roleId)}).catch(()=>{I([])})},[i]);const Xe=()=>{xt("loading"),Hs({libraryId:i}).then(k=>{Y(k),xt("idle")}).catch(()=>{Y([]),xt("error")})};a.useEffect(()=>{Xe()},[i]);const K=async()=>{Ee("working"),Ce("idle");try{if(!D){Ee("error");return}const k=await Ir({libraryId:i,collectionId:D,revisionType:ot.id,revisionSettings:Ye,mode:M,check:ye,limit:N});et(`${tt}/${k.shareCode}${Ie?`?${Ie}`:""}`),Ee("ready"),Xe()}catch{Ee("error")}},$=async()=>{if(l){De("saving");try{await Cr({libraryId:i,collectionId:m??D,revisionId:l,targetCollectionId:D,name:y||S,revisionType:ot.id,revisionSettings:Ye,mode:M,check:ye,limit:N}),De("saved"),D&&d(`/cogita/library/${i}/revisions/${encodeURIComponent(l)}`,{replace:!0})}catch{De("error")}}},B=async()=>{if($e)try{await navigator.clipboard.writeText($e),Ce("copied")}catch{Ce("failed")}},F=async k=>{try{await Ws({libraryId:i,shareId:k}),Xe()}catch{Xe()}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:S}),e.jsx("p",{className:"cogita-library-subtitle",children:v})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:g,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${g}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:D?`${g}/collections/${D}`:`${g}/collections`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${g}${l?`/revisions/${encodeURIComponent(l)}/run`:D?`/collections/${D}/revision/run`:"/revision/run"}?mode=${encodeURIComponent(M)}&check=${encodeURIComponent(ye)}&limit=${N}${Ie?`&${Ie}`:""}${Z?`&reviewer=${encodeURIComponent(Z)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:se,onChange:k=>Te(k.target.value),placeholder:t.cogita.workspace.revisionForm.namePlaceholder})}),e.jsxs("div",{className:"cogita-card-list","data-view":"list",children:[e.jsxs("a",{className:"cogita-card-select",href:`${g}/revisions/new`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:t.cogita.workspace.revisionForm.createAction})]}),Be.map(k=>e.jsxs("a",{className:"cogita-card-select",href:`${g}/revisions/${encodeURIComponent(k.revisionId)}`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:k.name})]},k.revisionId))]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsx("select",{value:D,onChange:k=>q(k.target.value),children:x.map(k=>e.jsx("option",{value:k.collectionId,children:k.name},k.collectionId))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:y,onChange:k=>W(k.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:M,onChange:k=>T(k.target.value),children:Yi.map(k=>e.jsx("option",{value:k.id,children:t.cogita.library.revision[k.labelKey]},k.id))})]}),ot.settingsFields.map(k=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[k.labelKey]}),k.type==="select"?e.jsx("select",{value:String(Ye[k.key]??""),onChange:C=>ge(A=>({...A,[k.key]:C.target.value})),children:(k.options??[]).map(C=>e.jsx("option",{value:C.value,children:t.cogita.library.revision[C.labelKey]},C.value))}):e.jsx("input",{type:"number",min:k.min,max:k.max,step:k.step,value:Ye[k.key]??0,onChange:C=>ge(A=>({...A,[k.key]:Number(C.target.value||0)}))})]},k.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),ot.id!=="levels"&&ot.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:N,onChange:k=>P(Number(k.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:Z??"",onChange:k=>_(k.target.value||null),children:R.map(k=>e.jsx("option",{value:k.roleId,children:k.label},k.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[l?e.jsx("button",{type:"button",className:"cta ghost",onClick:$,disabled:Ve==="saving",children:Ve==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${g}${l?`/revisions/${encodeURIComponent(l)}/run`:D?`/collections/${D}/revision/run`:"/revision/run"}?mode=${encodeURIComponent(M)}&check=${encodeURIComponent(ye)}&limit=${N}${Ie?`&${Ie}`:""}${Z?`&reviewer=${encodeURIComponent(Z)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision}),l?e.jsx("a",{className:"cta ghost",href:`/#/cogita/live-revision-host/${encodeURIComponent(i)}/${encodeURIComponent(l)}`,children:"Live session"}):null]}),Ve==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),$e?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:$e,readOnly:!0})]}):null,Ae==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,ct==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):ct==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:K,disabled:Ae==="working",children:Ae==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),$e?e.jsx("button",{type:"button",className:"cta ghost",onClick:B,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),We==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):ae.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:ae.map(k=>e.jsxs("div",{className:"cogita-share-row","data-state":k.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:k.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(k.createdUtc).toLocaleString(),k.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),k.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>F(k.shareId),children:t.cogita.library.revision.shareRevokeAction})]},k.shareId))})]})]})]})]})})})]})})}const Fn=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function sr(t,n,r){if(!t)return null;const s=new Map(t.nodes.map(q=>[q.id,q])),o=new Map,h=new Set,c=q=>{if(typeof q=="number")return q;if(typeof q=="string"){const y=Number(q);return Number.isFinite(y)?y:0}return 0},j=q=>{if(o.has(q))return o.get(q);if(h.has(q))return 0;const y=s.get(q);if(!y)return 0;h.add(q);const W=P=>{var T,Q;return(P?((T=y.inputsByHandle)==null?void 0:T[P])??[]:y.inputs??((Q=y.inputsByHandle)==null?void 0:Q.in)??[]).map(ge=>j(ge))};let N=0;switch(y.type){case"input.random":{const P=y.min??0,M=y.max??P+10,T=Math.min(P,M),Q=Math.max(P,M);N=Math.floor(Math.random()*(Q-T+1))+T;break}case"input.const":{N=y.value??0;break}case"input.list":{const P=(y.list??[]).filter(Boolean),M=Math.round(c(W("index")[0]));N=P.length?P[Math.max(0,Math.min(P.length-1,M))]:String(M);break}case"compute.add":{N=W("in").map(M=>c(M)).reduce((M,T)=>M+T,0);break}case"compute.sub":{const P=W("add").map(T=>c(T)),M=W("sub").map(T=>c(T));N=P.reduce((T,Q)=>T+Q,0)-M.reduce((T,Q)=>T+Q,0);break}case"compute.mul":{const P=W("in").map(M=>c(M));N=P.length?P.reduce((M,T)=>M*T,1):0;break}case"compute.div":{const P=c(W("num")[0]),M=W("den").map(T=>c(T)).reduce((T,Q)=>T+Q,0);N=Math.abs(M)<Number.EPSILON?0:P/M;break}case"compute.pow":{const P=c(W("base")[0]),M=c(W("exp")[0]);N=Math.pow(P,M);break}case"compute.exp":{const P=c(W("base")[0]),M=c(W("exp")[0]);N=Math.pow(P,M);break}case"compute.log":{const P=c(W("value")[0]),M=c(W("base")[0]),T=Math.max(P,Number.EPSILON);N=Math.abs(M)<Number.EPSILON?Math.log(T):Math.log(T)/Math.log(M);break}case"compute.abs":{N=Math.abs(c(W("in")[0]));break}case"compute.min":{const P=W("in").map(M=>c(M));N=P.length?Math.min(...P):0;break}case"compute.max":{const P=W("in").map(M=>c(M));N=P.length?Math.max(...P):0;break}case"compute.floor":{N=Math.floor(c(W("in")[0]));break}case"compute.ceil":{N=Math.ceil(c(W("in")[0]));break}case"compute.round":{N=Math.round(c(W("in")[0]));break}case"compute.mod":{const P=c(W("a")[0]),M=c(W("b")[0]);N=Math.abs(M)<Number.EPSILON?0:P%M;break}case"compute.concat":{const M=["in1","in2","in3","in4","in5","in6"].flatMap(ye=>W(ye)),T=M.length?M:W("in");N=(T.length?T:W()).map(ye=>ye==null?"":String(ye)).join("");break}case"compute.trim":{const P=W("text")[0]??W("in")[0]??"",M=P==null?"":String(P),T=Math.max(0,Math.round(c(W("start")[0]))),Q=Math.max(0,Math.round(c(W("end")[0])));T+Q>=M.length?N="":N=M.substring(T,M.length-Q);break}case"output":{N=W("in")[0]??0;break}default:N=0}return h.delete(q),o.set(q,N),N},p=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(q=>q.type==="output").map(q=>q.id);t.nodes.forEach(q=>j(q.id)),p.forEach(q=>j(q));const w=q=>Math.abs(q%1)<1e-5?String(Math.round(q)):q.toFixed(3).replace(/\.?0+$/,""),i=q=>typeof q=="number"?w(q):q??"",m=new Map;p.forEach(q=>{var M,T,Q,ge;const y=s.get(q);if(!y)return;const W=(T=(M=y.inputsByHandle)==null?void 0:M.name)==null?void 0:T[0],N=W?i(o.get(W)):"",P=(N==null?void 0:N.toString().trim())||((Q=y.outputLabel)==null?void 0:Q.trim())||((ge=y.name)==null?void 0:ge.trim())||q;m.set(q,P)});const l={},d={},v={};p.forEach(q=>{var N,P;const y=s.get(q);if(!y)return;const W=m.get(q)??(((N=y.outputLabel)==null?void 0:N.trim())||((P=y.name)==null?void 0:P.trim())||q);l[W]=i(o.get(q)),y.name&&(d[y.name.trim()]=W),d[q]=W});const g=(q,y)=>{let W=q;return t.nodes.forEach(N=>{var ge,ye;const P=i(o.get(N.id)),M=p.includes(N.id),T=M?m.get(N.id)??((ge=N.outputLabel)==null?void 0:ge.trim())??((ye=N.name)==null?void 0:ye.trim())??N.id:"",Q=M&&y?T:P;W=W.replace(new RegExp(`\\{\\s*${Fn(N.id)}\\s*\\}`,"gi"),Q),N.name&&(W=W.replace(new RegExp(`\\{\\s*${Fn(N.name)}\\s*\\}`,"gi"),Q)),M&&N.outputLabel&&(W=W.replace(new RegExp(`\\{\\s*${Fn(N.outputLabel)}\\s*\\}`,"gi"),T))}),W},S=n;let V=S.trim().length>0?S:"";V||(V=p.length?`Compute ${p.join(", ")}`:"Compute"),V=g(V,!0);const x=(r==null?void 0:r.trim())??"",b=x?g(x,!1):"",D={};return o.forEach((q,y)=>{D[y]=q,v[y]=i(q);const W=s.get(y);W!=null&&W.name&&(v[W.name.trim()]=i(q))}),{prompt:V,answers:l,values:D,answerText:b,outputVariables:d,variableValues:v}}function rr(t){var r;const n=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((r=n[0])==null?void 0:r[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const Kn=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function ir({outcomes:t}){const[n,r]=a.useState("day"),s=a.useMemo(()=>{const o=Kn.find(j=>j.id===n)??Kn[1],h=Date.now()-o.ms,c=t.filter(j=>new Date(j.createdUtc).getTime()>=h);return la(c)},[t,n]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:Kn.map(o=>e.jsx("button",{type:"button",className:"ghost","data-active":n===o.id,onClick:()=>r(o.id),children:o.label},o.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[s.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[s.correct," / ",s.total]})]})}const Zi="cogita-revision",eo=1,on="outcomes",to=()=>new Promise((t,n)=>{const r=indexedDB.open(Zi,eo);r.onupgradeneeded=()=>{const s=r.result;if(!s.objectStoreNames.contains(on)){const o=s.createObjectStore(on,{keyPath:"id"});o.createIndex("byItem","itemKey",{unique:!1}),o.createIndex("byPending","pending",{unique:!1})}},r.onerror=()=>n(r.error),r.onsuccess=()=>t(r.result)}),Ha=async(t,n)=>{const r=await to();return new Promise((s,o)=>{const h=r.transaction(on,t),c=h.objectStore(on);n(c).then(s).catch(o),h.onerror=()=>o(h.error)})},or=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const n=Array.from(t).map(r=>r.toString(16).padStart(2,"0"));return`${n.slice(0,4).join("")}-${n.slice(4,6).join("")}-${n.slice(6,8).join("")}-${n.slice(8,10).join("")}-${n.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},ao=()=>{const t="cogita_revision_client_id",n=localStorage.getItem(t);if(n)return n;const r=or();return localStorage.setItem(t,r),r},no=()=>{const t="cogita_revision_client_seq",n=Number(localStorage.getItem(t)??"0"),r=Number.isFinite(n)?n+1:1;return localStorage.setItem(t,String(r)),r},lr=(t,n,r,s)=>ea(t,n,r,s),ln=async t=>{const n=ao(),r=no(),s=new Date().toISOString(),o={...t,clientId:n,clientSequence:r,createdUtc:s,id:or(),pending:!0};return await Ha("readwrite",h=>new Promise((c,j)=>{const p={...o,itemKey:lr(o.itemType,o.itemId,o.checkType,o.direction)},w=h.add(p);w.onsuccess=()=>c(),w.onerror=()=>j(w.error)})),o},cn=async(t,n,r,s)=>{if(!n)return[];try{const o=lr(t,n,r,s);return await Ha("readonly",h=>new Promise((c,j)=>{const w=h.index("byItem").getAll(o);w.onsuccess=()=>{const m=(w.result??[]).map(l=>({itemType:l.itemType,itemId:l.itemId,checkType:l.checkType??null,direction:l.direction??null,revisionType:l.revisionType,evalType:l.evalType,correct:l.correct,createdUtc:l.createdUtc,maskBase64:l.maskBase64,payloadBase64:l.payloadBase64,payloadHashBase64:l.payloadHashBase64,clientId:l.clientId,clientSequence:l.clientSequence,personRoleId:l.personRoleId??null})).sort((l,d)=>l.createdUtc.localeCompare(d.createdUtc));c(m)},w.onerror=()=>j(w.error)}))}catch{return[]}},ca=async()=>{try{return await Ha("readonly",t=>new Promise((n,r)=>{const s=t.getAll();s.onsuccess=()=>{const h=(s.result??[]).map(c=>({itemType:c.itemType,itemId:c.itemId,checkType:c.checkType??null,direction:c.direction??null,revisionType:c.revisionType,evalType:c.evalType,correct:c.correct,createdUtc:c.createdUtc,maskBase64:c.maskBase64,payloadBase64:c.payloadBase64,payloadHashBase64:c.payloadHashBase64,clientId:c.clientId,clientSequence:c.clientSequence,personRoleId:c.personRoleId??null}));n(h)},s.onerror=()=>r(s.error)}))}catch{return[]}},so=async(t=100)=>{try{return await Ha("readonly",n=>new Promise((r,s)=>{const h=n.index("byPending").getAll(!0);h.onsuccess=()=>{const c=h.result??[];r(c.slice(0,t))},h.onerror=()=>s(h.error)}))}catch{return[]}},ro=async t=>{if(t.length!==0)try{await Ha("readwrite",n=>new Promise((r,s)=>{let o=t.length;t.forEach(h=>{const c=n.get(h);c.onsuccess=()=>{const j=c.result;if(j){j.pending=!1;const p=n.put(j);p.onsuccess=()=>{o-=1,o===0&&r()},p.onerror=()=>s(p.error)}else o-=1,o===0&&r()},c.onerror=()=>s(c.error)})}))}catch{}},_n=async(t,n)=>{const r=await so(200);if(r.length===0)return;const s=new Map;r.forEach(o=>{var c;const h=o.personRoleId??n??"";s.has(h)||s.set(h,[]),(c=s.get(h))==null||c.push(o)});for(const[o,h]of s.entries()){const c=h.map(j=>({itemType:j.itemType,itemId:j.itemId,checkType:j.checkType??null,direction:j.direction??null,revisionType:j.revisionType,evalType:j.evalType,correct:j.correct,clientId:j.clientId,clientSequence:j.clientSequence,maskBase64:j.maskBase64??null,payloadHashBase64:j.payloadHashBase64??null,payloadBase64:j.payloadBase64??null,personRoleId:o||null}));try{await Mr({libraryId:t,outcomes:c}),await ro(h.map(j=>j.id))}catch{}}},Dt=t=>t.trim().toLowerCase(),Wt=t=>{const n=t==null?void 0:t.trim();return n?{fragmentId:n}:null},dn=(t,n)=>{const r=Wt(n);if(!r)return!0;const s=Wt(t);return(s==null?void 0:s.fragmentId)===r.fragmentId},Tt=t=>{const n=t==null?void 0:t.trim().toLowerCase();return n||null},cr=(t,n)=>{if((Tt(t.childItemType)??"info")!==(n.cardType??"").toLowerCase()||t.childItemId!==n.cardId)return!1;const s=Tt(t.childCheckType),o=Tt(t.childDirection),h=Tt(n.checkType),c=Tt(n.direction);return!(s&&s!==h||o&&o!==c)},io={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},oo={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},un=(t,n,r)=>{if(!r||!n.startsWith(t))return n;const s=n.slice(t.length);if(!s)return n;const o=r==="super"?io:oo,h=s.split("").map(c=>o[c]??c).join("");return t+h},hn=(t,n,r)=>{var c,j,p;if(!t)return((c=n[0])==null?void 0:c.key)??null;const s=new Set(n.map(w=>w.key)),o=/\{([^}]+)\}/g;let h;for(;(h=o.exec(t))!==null;){const w=((j=h[1])==null?void 0:j.trim())??"";if(!w)continue;if(s.has(w))return w;const i=r==null?void 0:r[w];if(i&&s.has(i))return i}return((p=n[0])==null?void 0:p.key)??null},Oa=t=>(()=>{const n=new Set;return t.flatMap(r=>{if(r.cardType!=="info"||r.infoType!=="citation")return[r];const s=r.description??"";if(!s.trim())return[r];const o=va(s),h=Object.keys(o.nodes);return h.length===0?[r]:h.map(c=>({...r,checkType:"quote-fragment",direction:c})).filter(c=>{const j=[c.cardId,c.checkType??"",c.direction??""].join("|");return n.has(j)?!1:(n.add(j),!0)})})})();function Dn({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,libraryId:i,collectionId:m,revisionId:l}){const d=Ja(),v=`/#/cogita/library/${i}`,g=a.useMemo(()=>new URLSearchParams(d.search),[d.search]),S=Math.max(1,Number(g.get("limit")??20)),V=g.get("mode")??"random",x=a.useMemo(()=>rs(V),[V]),b=a.useMemo(()=>wn(x,nr(x,g)),[x,g]),D=g.get("check")??"exact",q=g.get("reviewer"),y=(g.get("scope")??"").trim(),W=y==="info"||y==="info-selection"?y:"collection",N=W==="info"?(g.get("infoId")??"").trim():"",P=W==="info-selection"?(g.get("seed")??"").trim():"",[M,T]=a.useState(null),Q=m??M??void 0,ge=W==="collection"&&!!Q,ye=a.useMemo(()=>t.cogita.library.revision[x.labelKey]??V,[t,V,x]),Oe=a.useMemo(()=>D==="exact"?t.cogita.library.revision.checkValue:D,[t,D]),[R,I]=a.useState(t.cogita.library.collections.defaultName),[Z,_]=a.useState([]),[ae,Y]=a.useState([]),[ve,le]=a.useState("idle"),[se,Te]=a.useState({current:0,total:0}),[Ae,Ee]=a.useState(0),[$e,et]=a.useState(""),[ct,Ce]=a.useState(null),[We,xt]=a.useState(null),[Ve,De]=a.useState(null),[tt,ot]=a.useState(null),[Ye,Ie]=a.useState([]),[Be,Xe]=a.useState({}),[K,$]=a.useState({}),[B,F]=a.useState(null),[k,C]=a.useState(null),[A,ue]=a.useState(null),[be,he]=a.useState(null),[ee,E]=a.useState(null),[X,re]=a.useState({}),G=a.useRef(0),[te,xe]=a.useState(null),U=a.useRef(null),ie=a.useRef(null),[Le,qe]=a.useState(null),[Ke,Je]=a.useState(!1),[bt,mt]=a.useState(null),[pt,wt]=a.useState([]),[Ct,Ot]=a.useState(null),Et=a.useRef(null),Nt=a.useRef(null),[ua,Lt]=a.useState(null),[vt,St]=a.useState(0),kt=a.useRef(null),yt=a.useRef({}),[Kt,st]=a.useState(!1),[Ue,ft]=a.useState({}),[Qt,Vt]=a.useState([]),Bt=a.useRef(new Map),[me,$t]=a.useState(new Set),[Xt,qt]=a.useState(!1),O=a.useRef(null),u=a.useRef(new Set),oe=a.useRef({});a.useEffect(()=>{if(!l||m){T(null);return}Zn({libraryId:i,revisionId:l}).then(f=>T(f.collectionId)).catch(()=>T(null))},[m,i,l]);const H=Z[Ae]??null,Qe=(H==null?void 0:H.checkType)==="translation-match"&&ee,rt=a.useRef(new Map),lt=a.useRef(new Map),It=a.useRef(new Map),Mt=a.useRef(new Map),jt=a.useMemo(()=>H?H.cardType==="vocab"?t.cogita.library.revision.vocabLabel:H.infoType?nt(t,H.infoType):t.cogita.library.revision.infoLabel:"",[t,H]),At=a.useMemo(()=>{var L;return x.id!=="levels"?Z.length:((L=Ue.pool)==null?void 0:L.length)??x.getFetchLimit(S,b)},[Ue,b,x,Z.length,S]),ha=x.getProgressTotal?x.getProgressTotal(Z,Ue,S,b):x.id==="levels"?Math.min(S,At):Z.length,ma=ha?Math.min(Ae+1,ha):0,Ft=Math.max(1,Number(b.tries??1)),ta=b.compare??"anchors",Ta=Math.max(0,Math.min(100,Number(b.minCorrectness??0))),ut=(b.considerDependencies??"on")==="on",_t=Math.max(0,Math.min(100,Number(b.dependencyThreshold??85))),Zt=f=>{const L=f.slice();for(let J=L.length-1;J>0;J-=1){const pe=Math.floor(Math.random()*(J+1));[L[J],L[pe]]=[L[pe],L[J]]}return L},ja=f=>xa(f,{treatSimilarCharsAsSame:!0})>=Ta,Wa=async()=>{const f=await ca(),L=new Map,J=new Map,pe=new Map;f.forEach(ne=>{const Se=`${ne.itemType}:${ne.itemId}`,ze=ea(ne.itemType,ne.itemId,ne.checkType,ne.direction);if(L.has(Se)||L.set(Se,[]),L.get(Se).push(ne),J.has(ze)||J.set(ze,[]),J.get(ze).push(ne),ne.itemType==="info"&&ne.checkType==="quote-fragment"&&ne.direction){const Ze=`${ne.itemId}:${ne.direction}`;pe.has(Ze)||pe.set(Ze,[]),pe.get(Ze).push(ne)}});const fe=new Map,de=new Map,je=new Map;return L.forEach((ne,Se)=>fe.set(Se,la(ne).score)),J.forEach((ne,Se)=>de.set(Se,la(ne).score)),pe.forEach((ne,Se)=>je.set(Se,la(ne).score)),{itemKnowness:fe,cardKnowness:de,fragmentKnowness:je}},Gt=async f=>{const L=[];let J=null;for(;;){const pe=await qa({libraryId:i,collectionId:f,limit:200,cursor:J});if(L.push(...pe.items),!pe.nextCursor)break;J=pe.nextCursor}return Oa(L)},Ca=async(f,L)=>{if(Bt.current.has(f))return Bt.current.get(f)??0;const J=await Gt(f);if(J.length===0)return Bt.current.set(f,0),0;const fe=J.reduce((de,je)=>{const ne=Ne(je);return de+(L.get(ne)??0)},0)/J.length;return Bt.current.set(f,fe),fe},Ia=(f,L)=>{if(!ut||f.cardType!=="info"||f.infoType!=="citation"||f.checkType!=="quote-fragment")return!0;const J=Wt(f.direction);if(!(J!=null&&J.fragmentId))return!0;const pe=f.description??"";if(!pe.trim())return!0;const de=va(pe).nodes[J.fragmentId];if(!de||!de.leftId&&!de.rightId)return!0;const je=[de.leftId,de.rightId].filter(ze=>!!ze);if(je.length===0)return!0;const ne=je.map(ze=>{const Ze=ea("info",f.cardId,"quote-fragment",ze);return L.get(Ze)??0});return ne.reduce((ze,Ze)=>ze+Ze,0)/ne.length>=_t},Pa=async f=>{const L=Ue,J=f.concat(L.active??[]).concat(L.pool??[]).filter((ne,Se,ze)=>ze.findIndex(Ze=>Ne(Ze)===Ne(ne))===Se);if(!ut){$t(new Set(J.map(Ne)));return}const{itemKnowness:pe,cardKnowness:fe}=await Wa(),de=Qt.filter(ne=>Tt(ne.childItemType)==="collection"&&ne.childItemId===m&&!Tt(ne.childCheckType)&&!Tt(ne.childDirection)),je=new Set;for(const ne of J){if(ne.cardType!=="info"){je.add(Ne(ne));continue}if(!Ia(ne,fe))continue;const Se=Qt.filter(He=>cr(He,ne)).concat(de);if(Se.length===0){je.add(Ne(ne));continue}let ze=0;for(const He of Se)if(Tt(He.parentItemType)==="collection")ze+=await Ca(He.parentItemId,fe);else if(Tt(He.parentCheckType)||Tt(He.parentDirection)){const at=Tt(He.parentCheckType),it=Tt(He.parentDirection),dt=ea(He.parentItemType,He.parentItemId,at,it);ze+=fe.get(dt)??0}else{const at=`${He.parentItemType}:${He.parentItemId}`;ze+=pe.get(at)??0}ze/Se.length>=_t&&je.add(Ne(ne))}$t(je)},Qa=f=>{for(let L=f;L<Z.length;L+=1){const J=Z[L];if(J&&(!ut||J.cardType!=="info"||me.has(Ne(J))))return L}return-1},Ea=f=>!ut||f.cardType!=="info"||me.has(Ne(f)),kn=f=>{if(x.id!=="temporal"&&x.id!=="levels")return null;const L=Ue,J=(L.active??[]).concat(L.pool??[]),pe=new Set;for(const fe of J){const de=Ne(fe);if(!(pe.has(de)||f.has(de))&&(pe.add(de),Ea(fe)))return fe}return null},Ut=a.useMemo(()=>{if(x.id!=="levels")return null;const f=Ue,L=f.pool??[],J=f.active??[],pe=f.levelMap??{},fe=Math.max(1,Number(b.levels??1)),de=Array.from({length:fe},()=>0),je=new Set(J.map(Ze=>Ne(Ze)));L.forEach(Ze=>{const He=Math.min(fe,Math.max(1,pe[Ne(Ze)]??1));de[He-1]+=1});const ne=L.length||1,Se=de.map(Ze=>Ze/ne*100),ze=H?pe[Ne(H)]??1:null;return{counts:de,percentages:Se,currentLevel:ze,levelsCount:fe,activeCount:J.length,poolCount:L.length,activeSet:je}},[Ue,b,x,H]),Jt=a.useMemo(()=>{if(x.id!=="temporal")return null;const f=Ue,L=f.pool??[],J=f.active??[],pe=f.knownessMap??{},fe=new Set(f.unknownSet??[]);let de=0;L.forEach(Se=>{(pe[Ne(Se)]??0)>1&&(de+=1)});const je=fe.size,ne=J.map(Se=>({id:Ne(Se),value:fe.has(Ne(Se))?0:Math.max(0,Math.min(1,pe[Ne(Se)]??0))}));return{knownCount:de,unknownCount:je,dots:ne}},[Ue,x]),Nn=a.useMemo(()=>{if(!ut)return 0;const f=Ue;return Z.concat(f.active??[]).concat(f.pool??[]).filter((J,pe,fe)=>fe.findIndex(de=>Ne(de)===Ne(J))===pe).filter(J=>J.cardType==="info"&&!me.has(Ne(J))).length},[ut,Ue,Z,me]);a.useEffect(()=>{if(!ut||ve!=="ready")return;const f=Ue,J=Z.concat(f.active??[]).concat(f.pool??[]).filter((de,je,ne)=>ne.findIndex(Se=>Ne(Se)===Ne(de))===je).filter(de=>de.cardType!=="info"||me.has(Ne(de))).length,pe=Et.current;if(Et.current=J,pe===null||J<=pe)return;const fe=J-pe;Ot(`New card available (+${fe})`),Nt.current&&window.clearTimeout(Nt.current),Nt.current=window.setTimeout(()=>Ot(null),2200)},[ut,ve,Ue,Z,me]),a.useEffect(()=>()=>{Nt.current&&window.clearTimeout(Nt.current)},[]);const zt=(f,L)=>{const J=x.applyOutcome({queue:Z,meta:Ue},H,S,b,{correct:f,correctness:L,createdUtc:new Date().toISOString()});_(J.queue),ft(J.meta);const pe=J.queue[Ae+1];pe&&ga(pe,Ae+1)};a.useEffect(()=>{if(ge&&Q){yn(i,Q).then(f=>I(f.name)).catch(()=>I(t.cogita.library.collections.defaultName));return}if(W==="info"&&N){na({libraryId:i,infoId:N}).then(f=>{const L=f.payload??{};I(L.title||L.label||L.name||N)}).catch(()=>I(N||t.cogita.library.revision.runKicker));return}if(W==="info-selection"){const f=P?ms(i,P):null,L=(f==null?void 0:f.infoIds.length)??0;I(L>0?`Selected infos (${L})`:"Selected infos");return}I(t.cogita.library.collections.defaultName)},[t,Q,ge,i,W,N,P]),a.useEffect(()=>{Xn({libraryId:i,type:"language"}).then(f=>Y(f)).catch(()=>Y([]))},[i]),a.useEffect(()=>{ge&&Yn({libraryId:i}).then(f=>Vt(f.items??[])).catch(()=>Vt([]))},[ge,i]),a.useEffect(()=>{_n(i,q)},[i,q]),a.useEffect(()=>{Pa(Z)},[Z,Qt,ut,_t,Q]),a.useEffect(()=>{if(!H||!ut){qt(!1);return}if(H.cardType!=="info"||me.has(Ne(H))){qt(!1);return}const f=Qa(Ae+1);if(f>=0){qt(!1),Ee(f);return}if(x.id==="temporal"||x.id==="levels"){const L=Z.slice(0,Ae+1),J=Z.slice(Ae+1).filter(Ea),pe=L.concat(J),fe=new Set(pe.map(Ne)),de=kn(fe);if(de){const ne=Ne(de);fe.has(ne)||(pe.push(de),fe.add(ne),ft(Se=>{const ze=Se,Ze=new Set(ze.queued??[]);return Ze.add(ne),{...ze,queued:Ze}}))}const je=pe.findIndex((ne,Se)=>Se!==Ae&&Ea(ne));if(je>=0){_(pe),Ee(je),qt(!1);return}}qt(!0)},[H,me,ut,Ae,Z,Ue,x.id]),a.useEffect(()=>{let f=!0;return(async()=>{le("loading"),Te({current:0,total:x.id==="levels"?0:x.getFetchLimit(S,b)});try{if(!ge){if(Vt([]),W==="info"){if(!N){f&&(_([]),Vt([]),ft({}),Ee(0),le("ready"));return}const[He,at]=await Promise.all([tn({libraryId:i,infoId:N}),an({libraryId:i,infoId:N})]);if(!f)return;const it=Oa(He.items??[]);Vt(at.items??[]);const dt=x.prepare(it,S,b);_(dt.queue),ft(dt.meta),Ee(0),le("ready"),Te({current:it.length,total:it.length});return}if(W==="info-selection"){const He=P?ms(i,P):null,at=(He==null?void 0:He.infoIds)??[];if(!at.length){f&&(_([]),Vt([]),ft({}),Ee(0),le("ready"));return}const it=await Promise.all(at.map(async pa=>{const[Ht,Ga]=await Promise.all([tn({libraryId:i,infoId:pa}),an({libraryId:i,infoId:pa})]);return{cards:Ht.items??[],deps:Ga.items??[]}}));if(!f)return;const dt=new Map;it.forEach(pa=>{Oa(pa.cards).forEach(Ht=>{dt.set(Ne(Ht),Ht)})});const ht=Array.from(dt.values()),gt=new Set(ht.map(Ne)),Rt=new Map;it.forEach(pa=>{(pa.deps??[]).forEach(Ht=>{const Ga=ea(Ht.parentItemType,Ht.parentItemId,Tt(Ht.parentCheckType),Tt(Ht.parentDirection)),is=ea(Ht.childItemType,Ht.childItemId,Tt(Ht.childCheckType),Tt(Ht.childDirection));if(!gt.has(Ga)||!gt.has(is))return;const os=`${Ga}->${is}`;Rt.has(os)||Rt.set(os,Ht)})}),Vt(Array.from(Rt.values()));const ka=x.prepare(ht,S,b);_(ka.queue),ft(ka.meta),Ee(0),le("ready"),Te({current:ht.length,total:ht.length});return}}const J=[];let pe=null,fe=null;do{const He=await qa({libraryId:i,collectionId:Q,limit:300,cursor:pe});if(J.push(...He.items),(x.id==="levels"||x.id==="temporal")&&He.total&&(fe=He.total),Te(at=>({current:J.length,total:at.total||He.total||x.getFetchLimit(S,b)})),pe=He.nextCursor??null,fe!==null&&J.length>=fe||x.id!=="levels"&&x.id!=="temporal"&&J.length>=x.getFetchLimit(S,b))break}while(pe);if(!f)return;const de=Oa(J);let je;if(x.id==="levels"){const He=Math.max(1,Number(b.levels??1)),it=(await ca()).reduce((dt,ht)=>{const gt=ea(ht.itemType,ht.itemId,ht.checkType,ht.direction);return dt[gt]||(dt[gt]=[]),dt[gt].push(ht),dt},{});je={},de.forEach(dt=>{const ht=Ne(dt),gt=it[ht]??[],Rt=gt.length>0?la(gt).score:0,ka=Math.max(1,Math.min(He,Math.ceil(Rt/100*He)));je[ht]=ka})}let ne=null,Se=null,ze=null;if(x.id==="temporal"){const He=await ca(),at=new Set(de.map(ht=>Ne(ht))),it=He.reduce((ht,gt)=>{const Rt=ea(gt.itemType,gt.itemId,gt.checkType,gt.direction);return at.has(Rt)&&(ht[Rt]||(ht[Rt]=[]),ht[Rt].push(gt)),ht},{});ne={},Se=new Set,ze={};const dt=Date.now();de.forEach(ht=>{const gt=Ne(ht),Rt=it[gt]??[];if(Rt.length===0){ne[gt]=0,Se.add(gt),ze[gt]=[];return}const ka=as(Rt);ze[gt]=ka;const pa=vn(ka,dt);ne[gt]=pa.knowness})}const Ze=x.id==="levels"?ss(de,S,b,je):x.id==="temporal"?ns(de,S,b,ne??{},Se??new Set,ze??{}):x.prepare(de,S,b);_(Ze.queue),ft(Ze.meta),Ee(0),le("ready"),Te(He=>({current:Math.min(He.current,He.total),total:He.total}))}catch{f&&le("error")}})(),()=>{f=!1}},[Q,ge,i,S,W,b,x,q,N,P]),a.useEffect(()=>{if(et(""),Ce(null),Lt(null),St(0),Ie([]),Xe({}),$({}),C(null),ue(null),he(null),Je(!1),st(!1),qe(null),E(null),re({}),!H){xt(null),De(null),F(null),mt(null);return}H.cardType==="info"&&H.infoType==="computed"&&xt(t.cogita.library.revision.loadingComputed);let f=!0;return ga(H,Ae).then(L=>{!f||!L||(xt(L.prompt),De(L.expectedAnswer),Ie(L.computedExpected),Xe(L.computedAnswers),F(L.computedValues),C(L.answerTemplate),ue(L.outputVariables),he(L.variableValues))}),()=>{f=!1}},[H,t]),a.useEffect(()=>{if(!H||H.cardType!=="info"||H.infoType!=="citation"){O.current=null,u.current=new Set,ot(null);return}const f=H.description??"",L=(H.label??"").trim(),J=L.replace(/\s+/g," ").trim(),pe=f.replace(/\s+/g," ").trim(),fe=J&&J!==pe?L:t.cogita.library.infoTypes.citation;if(!f){ot(null),De(null);return}const de=va(f);O.current=de,xt(fe);let je=!0;return Wa().then(({fragmentKnowness:ne})=>{if(!je)return;const Se=new Set,ze={};ne.forEach((at,it)=>{const[dt,ht]=it.split(":",2);if(dt!==H.cardId)return;const gt=Wt(ht);if(!gt)return;const{fragmentId:Rt}=gt;ze[Rt]=at,at>=_t&&Se.add(Rt)}),u.current=Se,oe.current=ze;const Ze=Wt(H.direction);if(Ze!=null&&Ze.fragmentId&&de.nodes[Ze.fragmentId]){z(de,Ze.fragmentId,fe);return}const He=$a(de,Se,ze,_t,ut,H.direction);z(de,(He==null?void 0:He.id)??null,fe)}).catch(()=>{u.current=new Set,oe.current={};const ne=Wt(H.direction);if(ne!=null&&ne.fragmentId&&de.nodes[ne.fragmentId]){z(de,ne.fragmentId,fe);return}const Se=$a(de,u.current,{},_t,ut,H.direction);z(de,(Se==null?void 0:Se.id)??null,fe)}),()=>{je=!1}},[H,t,ut,_t]),a.useEffect(()=>{if(!H||H.cardType!=="vocab"||H.checkType!=="translation-match"){E(null),re({});return}const J=(Ue.pool??Ue.active??Z).filter(ne=>ne.cardType==="vocab"&&ne.checkType==="translation-match").filter((ne,Se,ze)=>ze.findIndex(Ze=>Ze.cardId===ne.cardId)===Se);J.some(ne=>ne.cardId===H.cardId)||J.unshift(H);const fe=Zt(J).slice(0,6).map(ne=>{const Se=ne.label.split("↔").map(He=>He.trim()).filter(Boolean);if(Se.length<2)return null;const ze=`${ne.cardId}:L`,Ze=`${ne.cardId}:R`;return{cardId:ne.cardId,leftId:ze,rightId:Ze,leftLabel:Se[0],rightLabel:Se[1]}}).filter(Boolean),de=fe.map(ne=>ne.leftId),je=Zt(fe.map(ne=>ne.rightId));E({pairs:fe,leftOrder:de,rightOrder:je,selection:{},activeLeft:null,activeRight:null,locked:{}})},[H,Z,Ue]),a.useEffect(()=>()=>{U.current&&window.clearTimeout(U.current),ie.current&&window.clearTimeout(ie.current)},[]);const sa=a.useRef(null);a.useEffect(()=>{if(!H)return;const f=Ne(H),L=typeof document<"u"?document.activeElement:null;if(sa.current===f&&L&&(L.tagName==="INPUT"||L.tagName==="TEXTAREA"))return;let J=0;const pe=()=>{if(H){if(H.cardType==="info"&&H.infoType==="computed"){if(Ye.length>0){const de=hn(k,Ye,A),je=de?yt.current[de]:null;if(je&&(je.focus(),document.activeElement===je)){sa.current=f;return}}if(kt.current&&(kt.current.focus(),document.activeElement===kt.current)){sa.current=f;return}}else if(H.cardType==="vocab"&&kt.current&&(kt.current.focus(),document.activeElement===kt.current)){sa.current=f;return}J<6&&(J+=1,window.setTimeout(pe,40))}},fe=window.setTimeout(pe,40);return()=>window.clearTimeout(fe)},[H,Ye,k,A]),a.useEffect(()=>{if(!Kt)return;const f=L=>{L.key==="Enter"&&(L.preventDefault(),La())};return window.addEventListener("keydown",f),()=>window.removeEventListener("keydown",f)},[Kt]);const Ma=f=>{wt(f),mt(la(f))};a.useEffect(()=>{if(!H){mt(null),wt([]);return}const f=H.cardType==="info"?"info":"connection";if(H.cardType==="info"&&H.infoType==="citation"){ca().then(L=>{const J=L.filter(pe=>pe.itemType==="info"&&pe.itemId===H.cardId&&pe.checkType==="quote-fragment"&&dn(pe.direction,H.direction));Ma(J)}).catch(()=>{mt(null),wt([])});return}cn(f,H.cardId,H.checkType,H.direction).then(L=>Ma(L)).catch(()=>{mt(null),wt([])})},[i,H,q]);const wa=(f,L,J,pe)=>{if(f==="info"&&J==="quote-fragment"){ca().then(fe=>{const de=fe.filter(je=>je.itemType==="info"&&je.itemId===L&&je.checkType==="quote-fragment"&&dn(je.direction,pe));Ma(de)}).catch(()=>{mt(null),wt([])});return}cn(f,L,J,pe).then(fe=>Ma(fe)).catch(()=>{mt(null),wt([])})},Fa=(f,L,J)=>{var je;const pe=((je=J.pairs.find(ne=>ne.leftId===f))==null?void 0:je.rightId)??null;if(!pe)return J;const fe=pe===L;re(ne=>({...ne,[f]:fe?"correct":"incorrect"})),U.current&&window.clearTimeout(U.current),ie.current&&window.clearTimeout(ie.current),G.current+=1;const de={kind:fe?"correct":"incorrect",tick:G.current};if(xe(null),U.current=window.setTimeout(()=>xe(de),0),ie.current=window.setTimeout(()=>xe(null),420),fe){const ne={...J.locked,[f]:!0};return Object.keys(ne).length>=J.pairs.length?(Ce("correct"),st(!0)):Ce("correct"),{...J,selection:{...J.selection,[f]:L},activeLeft:null,activeRight:null,locked:ne}}return Ce("incorrect"),{...J,activeLeft:null,activeRight:null}},Sn=f=>{E(L=>!L||L.locked[f]?L:L.activeRight?Fa(f,L.activeRight,L):{...L,activeLeft:L.activeLeft===f?null:f})},Tn=f=>{E(L=>L&&(L.activeLeft?Fa(L.activeLeft,f,L):{...L,activeRight:L.activeRight===f?null:f}))},La=()=>{var f;if(H&&H.cardType==="info"&&H.infoType==="citation"&&O.current&&tt&&!((f=Wt(H.direction))!=null&&f.fragmentId)){const L=$a(O.current,u.current,oe.current,_t,ut,H.direction,tt.fragmentId);if(L){Ce(null),et(""),Je(!1),$({}),st(!1),Lt(null),St(0),z(O.current,L.id,tt.title);return}}Ce(null),et(""),Je(!1),$({}),st(!1),Lt(null),St(0),Ee(L=>Math.min(L+1,Z.length))},aa=f=>{if(!H)return;const L=f.expected??null,J=f.answer??"";let pe=L??"",fe=J;if(!L&&f.expectedMap&&f.answerMap){const He=Object.keys(f.expectedMap).sort((at,it)=>at.localeCompare(it));pe=He.map(at=>{var it;return((it=f.expectedMap)==null?void 0:it[at])??""}).join("|"),fe=He.map(at=>{var it;return((it=f.answerMap)==null?void 0:it[at])??""}).join("|")}const de=pe?Ra(pe,fe,ta):new Uint8Array,je={revisionType:x.id,evalType:f.evalType,direction:f.direction,prompt:We??"",expected:L,answer:J,expectedAnswers:f.expectedMap??null,answers:f.answerMap??null,correct:f.correct,maskBase64:de.length?ya(de):null,values:B??null,checkMode:D,compareMode:ta,minCorrectness:Ta},ne=new TextEncoder().encode(JSON.stringify(je)),Se=H.cardType==="info"?"info":"connection",ze=f.overrideCheckType??H.checkType??null,Ze=f.overrideDirection??H.direction??null;ln({itemType:Se,itemId:H.cardId,checkType:ze,direction:Ze,revisionType:x.id,evalType:f.evalType,correct:f.correct,maskBase64:de.length?ya(de):null,payloadBase64:ya(ne),personRoleId:q??null}).then(()=>{wa(Se,H.cardId,ze,Ze),Pa(Z),_n(i,q)}).catch(()=>{})},Cn=(f,L)=>{const J=rt.current.get(L);if(J)return Promise.resolve(J);const pe=lt.current.get(L);if(pe)return pe;const fe=na({libraryId:i,infoId:f}).then(de=>{var He,at;const je=de.payload,ne=((He=je.definition)==null?void 0:He.graph)??null,Se="",ze=((at=je.definition)==null?void 0:at.answerTemplate)??"",Ze=sr(ne,Se,ze);if(Ze){const dt={sample:rr(Ze),answerTemplate:ze||null};return rt.current.set(L,dt),dt}return Un({libraryId:i,infoId:f}).then(it=>{const dt={sample:it,answerTemplate:null};return rt.current.set(L,dt),dt})}).catch(()=>Un({libraryId:i,infoId:f}).then(de=>{const je={sample:de,answerTemplate:null};return rt.current.set(L,je),je}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{lt.current.delete(L)});return lt.current.set(L,fe),fe},ga=(f,L)=>{var ne;const J=`${Ne(f)}:${L}`,pe=It.current.get(J);if(pe)return Promise.resolve(pe);const fe=Mt.current.get(J);if(fe)return fe;const de=Se=>(It.current.set(J,Se),Se);let je;if(f.cardType==="vocab"){if(f.checkType==="translation-match")return je=Promise.resolve(de({prompt:f.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),je;const Se=f.label.split("↔").map(ze=>ze.trim()).filter(Boolean);if(Se.length>=2){const Ze=(f.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",He=Ze?Se[0]:Se[1],at=Ze?Se[1]:Se[0];je=Promise.resolve(de({prompt:He,expectedAnswer:at,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else je=Promise.resolve(de({prompt:f.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(f.cardType==="info"&&f.infoType==="word"){const Se=(ne=f.description)!=null&&ne.startsWith("Language: ")?f.description.replace("Language: ",""):null;je=Promise.resolve(de({prompt:f.label,expectedAnswer:Se,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else f.cardType==="info"&&f.infoType==="computed"?je=Cn(f.cardId,J).then(Se=>{var it,dt;if(!Se.sample)return de({prompt:f.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const ze=Se.sample,Ze=ze.expectedAnswers?Object.entries(ze.expectedAnswers).map(([ht,gt])=>({key:ht,expected:gt})):[],He=Ze.reduce((ht,gt)=>(ht[gt.key]="",ht),{}),at=ze.expectedAnswerIsSentence&&((it=ze.expectedAnswer)==null?void 0:it.trim())||null;return de({prompt:ze.prompt,expectedAnswer:Ze.length>0?at:((dt=ze.expectedAnswer)==null?void 0:dt.trim())||null,computedExpected:Ze,computedAnswers:He,computedValues:ze.values??null,answerTemplate:Se.answerTemplate,outputVariables:ze.outputVariables??null,variableValues:ze.variableValues??null})}).catch(()=>de({prompt:f.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Mt.current.delete(J)}):je=Promise.resolve(de({prompt:f.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return Mt.current.set(J,je),je},z=(f,L,J)=>{const pe=Object.keys(f.nodes).length,fe=u.current.size;if(!L){ot({title:J,before:f.text,after:"",fragmentId:null,total:pe,completed:fe}),De(null),st(!0);return}const de=f.nodes[L];if(!de)return;const je=xn(f.text,de);ot({title:J,before:je.before,after:je.after,fragmentId:de.id,total:pe,completed:fe}),De(je.fragment),st(!1)},ce=()=>{const f=O.current;f&&ot(L=>L&&{...L,total:Object.keys(f.nodes).length,completed:u.current.size})},we=()=>{const f=Z[Ae+1];f&&ga(f,Ae+1)},Fe=()=>{if(we(),H&&H.cardType==="vocab"&&H.checkType==="translation-match"&&ee){if(ee.pairs.length===0){Ce("incorrect"),st(!0);return}const de=ee.pairs.reduce((at,it)=>(at[it.rightId]=it.rightLabel,at),{});let je=0;const ne={};ee.pairs.forEach(at=>{const dt=ee.selection[at.leftId]===at.rightId;ne[at.leftId]=dt?"correct":"incorrect",dt&&(je+=1)});const Se=ee.pairs.length||1,ze=je/Se,Ze=je===ee.pairs.length;re(at=>({...at,...ne})),Ze?(Ce("correct"),st(!0),St(0)):(Ce("incorrect"),st(!1),St(at=>{const it=at+1;return it>=Ft&&(Je(!0),st(!0),E(dt=>{if(!dt)return dt;const ht=dt.pairs.reduce((gt,Rt)=>(gt[Rt.leftId]=Rt.rightId,gt),{});return{...dt,selection:ht}})),it})),zt(Ze,ze);const He="connection";Promise.all(ee.pairs.map(at=>{const it=ee.selection[at.leftId]??null,dt=it?de[it]:"",ht={left:at.leftLabel,expected:at.rightLabel,answer:dt,checkType:"translation-match"},gt=new TextEncoder().encode(JSON.stringify(ht));return ln({itemType:He,itemId:at.cardId,checkType:"translation-match",direction:null,revisionType:x.id,evalType:"translation-match",correct:it===at.rightId,maskBase64:null,payloadBase64:ya(gt),personRoleId:q??null})})).then(()=>{wa(He,H.cardId,H.checkType,H.direction),_n(i,q)}).catch(()=>{});return}if(Ye.length>0){const de=Ye.reduce((ne,Se)=>{const ze=Be[Se.key]??"";return ne[Se.key]=Dt(ze)===Dt(Se.expected)?"correct":"incorrect",ne},{});Ye.every(({key:ne,expected:Se})=>{const ze=Be[ne]??"";return D==="exact"&&Dt(ze)===Dt(Se)})?(Ce("correct"),$(de),st(!0),St(0),zt(!0,1),aa({correct:!0,direction:We?`${We} -> computed`:"computed",expectedMap:Ye.reduce((ne,Se)=>(ne[Se.key]=Se.expected,ne),{}),answerMap:Be,evalType:"computed"})):(Ce("incorrect"),$(de),st(!1),St(ne=>{const Se=ne+1;return Se>=Ft&&Ge&&(Je(!0),st(!0)),Se}),zt(!1,0),window.setTimeout(()=>{var Se;const ne=hn(k,Ye,A);ne&&yt.current[ne]&&((Se=yt.current[ne])==null||Se.focus())},40),aa({correct:!1,direction:We?`${We} -> computed`:"computed",expectedMap:Ye.reduce((ne,Se)=>(ne[Se.key]=Se.expected,ne),{}),answerMap:Be,evalType:"computed"}));return}if(H&&H.cardType==="info"&&H.infoType==="citation"&&(tt!=null&&tt.fragmentId)){if(!Ve)return;const de=Wt(H.direction),je=(de==null?void 0:de.fragmentId)??tt.fragmentId,ne=Sa(Ve,$e,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Se=ne.mask,ze=ne.isCorrect,Ze=ne.percent;ze?(oe.current[tt.fragmentId]=Math.max(oe.current[tt.fragmentId]??0,Ze),(oe.current[tt.fragmentId]??0)>=_t&&u.current.add(tt.fragmentId),ce(),Ce("correct"),$({}),st(!0),Lt(Se),St(0),Ze<100&&Ft<=1&&Je(!0),zt(!0,Ze/100),aa({correct:!0,direction:`quote:${tt.fragmentId}`,expected:Ve,answer:$e,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:je})):(Ce("incorrect"),$({}),st(!1),Lt(Se),St(He=>{const at=He+1;return at>=Ft&&Ge&&(Je(!0),st(!0)),at}),zt(!1,Ze/100),window.setTimeout(()=>{var He;return(He=kt.current)==null?void 0:He.focus()},40),aa({correct:!1,direction:`quote:${tt.fragmentId}`,expected:Ve,answer:$e,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:je}));return}if(!Ve)return;const f=Ra(Ve,$e,ta),L=D==="exact"&&Dt($e)===Dt(Ve),J=ja(f),pe=L||J,fe=xa(f);pe?(Ce("correct"),$({}),st(!0),Lt(f),St(0),fe<100&&Ft<=1&&Je(!0),zt(!0,fe/100),aa({correct:!0,direction:We?`${We} -> ${Ve}`:null,expected:Ve,answer:$e,evalType:"text"})):(Ce("incorrect"),$({}),st(!1),Lt(f),St(de=>{const je=de+1;return je>=Ft&&Ge&&(Je(!0),st(!0)),je}),zt(!1,fe/100),window.setTimeout(()=>{var de;return(de=kt.current)==null?void 0:de.focus()},40),aa({correct:!1,direction:We?`${We} -> ${Ve}`:null,expected:Ve,answer:$e,evalType:"text"}))},_e=f=>{if(we(),!Ve)return;const L=Ra(Ve,f,ta),J=Dt(f)===Dt(Ve),pe=ja(L),fe=J||pe,de=xa(L);fe?(Ce("correct"),$({}),st(!0),Lt(L),St(0),de<100&&Ft<=1&&Je(!0),zt(!0,de/100),aa({correct:!0,direction:"word->language",expected:Ve,answer:f,evalType:"language-select"})):(Ce("incorrect"),$({}),st(!1),Lt(L),St(je=>{const ne=je+1;return ne>=Ft&&Ge&&(Je(!0),st(!0)),ne}),zt(!1,de/100),aa({correct:!1,direction:"word->language",expected:Ve,answer:f,evalType:"language-select"}))},ke=()=>{we(),Ce("correct"),st(!0),St(0),zt(!0,1),Ve&&aa({correct:!0,direction:"manual",expected:Ve,answer:$e,evalType:"manual"})},Re=()=>{if(zt(!1,0),H&&H.cardType==="info"&&H.infoType==="citation"){Ce(null),et(""),Je(!1),$({}),st(!1),Lt(null),St(0),Ee(f=>Math.min(f+1,Z.length));return}La()};a.useEffect(()=>{we()},[Ae,Z]);const Me=f=>{var J;if(f.key!=="Enter")return;if(f.preventDefault(),f.stopPropagation(),Kt){La();return}const L=Ye.find(pe=>!(Be[pe.key]??"").trim());if(L){(J=yt.current[L.key])==null||J.focus();return}Fe()},Pe=t.cogita.library.revision.revealModeAfterIncorrect,Ge=Ye.length>0||!!Ve;return e.jsxs(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,children:[ve==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${se.total?Math.min(100,Math.max(0,se.current/se.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:se.total?`${Math.min(se.current,se.total)} / ${se.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:R}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",ye).replace("{check}",Oe)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),ge?e.jsxs(e.Fragment,{children:[e.jsx("a",{className:"cta ghost",href:`${v}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${v}/collections/${Q}`,children:t.cogita.library.actions.collectionDetail})]}):e.jsx("a",{className:"cta ghost",href:`${v}/list`,children:t.cogita.library.actions.allCards})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:bt?`${bt.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Ut?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Ut.currentLevel??"-"," / ",Ut.levelsCount]}):null,bt?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(bt.correct)).replace("{total}",String(bt.total))}),bt.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(bt.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(ir,{outcomes:pt})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[Ct?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:Ct})}):null,e.jsx(es,{feedbackToken:te?`${te.kind}-${te.tick}`:Qe?"idle":ct??"idle",children:H?e.jsx(e.Fragment,{children:Xt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(ts,{copy:t,currentCard:H,currentTypeLabel:jt,prompt:We,languages:ae,answer:$e,onAnswerChange:f=>et(L=>un(L,f,Le)),computedExpected:Ye,computedAnswers:Be,onComputedAnswerChange:(f,L)=>Xe(J=>({...J,[f]:un(J[f]??"",L,Le)})),answerTemplate:k,outputVariables:A,variableValues:be,computedFieldFeedback:K,feedback:ct,canAdvance:Kt,quoteContext:tt,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Fe,onSkip:Re,onLanguageSelect:_e,onMarkReviewed:ke,onAdvance:La,showCorrectAnswer:Ke,setShowCorrectAnswer:Je,onRevealCorrect:()=>st(!0),answerMask:ua,expectedAnswer:Ve,hasExpectedAnswer:Ge,handleComputedKeyDown:Me,answerInputRef:kt,computedInputRefs:yt,scriptMode:Le,setScriptMode:qe,matchPairs:ee==null?void 0:ee.pairs,matchLeftOrder:ee==null?void 0:ee.leftOrder,matchRightOrder:ee==null?void 0:ee.rightOrder,matchSelection:ee==null?void 0:ee.selection,matchActiveLeft:ee==null?void 0:ee.activeLeft,matchActiveRight:ee==null?void 0:ee.activeRight,matchFeedback:X,onMatchLeftSelect:Sn,onMatchRightSelect:Tn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:ge?`${v}/collections/${Q}`:`${v}/list`,children:ge?t.cogita.library.actions.collectionDetail:t.cogita.library.actions.allCards})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:ha?`${ma} / ${ha}`:t.cogita.library.revision.progressUnlimited}),ve==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),ve==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),ve==="ready"&&Z.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Pe}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",Ft]})]})]}),Ut?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Ut.activeCount," / ",Ut.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Ut.counts.map((f,L)=>{const J=L+1,pe=Ut.currentLevel===J,fe=Ut.percentages[L]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":pe,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:J}),e.jsx("strong",{children:f})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,fe))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[fe.toFixed(1),"%"]})]},`level-${J}`)})})]}):null,Jt?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:Jt.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:Jt.dots.map(f=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,f.value*100))}%`,background:`rgba(${Math.round(255*(1-f.value))}, ${Math.round(200*f.value)}, 80, 0.9)`}},f.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:Jt.knownCount})]})]}):null,ut?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Nn})]})}):null]})]})]})})})]})]})}const Bn=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],lo={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},co=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],uo=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function ho({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,libraryId:i,collectionId:m}){const[l,d]=a.useState(""),[v,g,S]=Hn([]),[V,x,b]=Wn([]),[D,q]=a.useState(null),[y,W]=a.useState(null),[N,P]=a.useState(null),M=`/#/cogita/library/${i}`;a.useEffect(()=>{yn(i,m).then(I=>d(I.name)).catch(()=>d(t.cogita.library.collections.defaultName))},[i,m,t]),a.useEffect(()=>{Lr({libraryId:i,collectionId:m}).then(I=>{if(!I.graphId||I.graphId==="00000000-0000-0000-0000-000000000000"){g([]),x([]);return}const Z=I.nodes.map(ae=>{var se;const Y=ae.payload??{},ve=Y.position??{x:120,y:120},le=Y.params??{};return{id:ae.nodeId,type:"default",position:ve,data:{nodeType:ae.nodeType,label:((se=Bn.find(Te=>Te.type===ae.nodeType))==null?void 0:se.label)??ae.nodeType,params:le}}}),_=I.edges.map(ae=>({id:ae.edgeId,source:ae.fromNodeId,target:ae.toNodeId,sourceHandle:ae.fromPort??void 0,targetHandle:ae.toPort??void 0}));g(Z),x(_)}).catch(()=>{g([]),x([])})},[i,m,x,g]);const T=a.useMemo(()=>v.find(I=>I.id===D)??null,[v,D]),Q=I=>{var Y;const Z=crypto.randomUUID(),_=((Y=Bn.find(ve=>ve.type===I))==null?void 0:Y.label)??I,ae={...lo[I]};g(ve=>[...ve,{id:Z,type:"default",position:{x:120+ve.length*40,y:120+ve.length*40},data:{nodeType:I,label:_,params:ae}}]),q(Z)},ge=a.useCallback(I=>{x(Z=>Qn({...I,id:crypto.randomUUID()},Z))},[x]),ye=async()=>{W(null);try{await Qs({libraryId:i,collectionId:m,nodes:v.map(I=>({nodeId:I.id,nodeType:I.data.nodeType,payload:{position:I.position,params:I.data.params}})),edges:V.map(I=>({edgeId:I.id,fromNodeId:I.source,fromPort:I.sourceHandle??null,toNodeId:I.target,toPort:I.targetHandle??null}))}),W(t.cogita.library.graph.saveSuccess)}catch{W(t.cogita.library.graph.saveFail)}},Oe=async()=>{try{const I=await Ar({libraryId:i,collectionId:m});P(I)}catch{P(null)}},R=I=>{T&&g(Z=>Z.map(_=>_.id===T.id?{..._,data:{..._.data,params:I}}:_))};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${M}/collections/${m}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Oe,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:ye,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Bn.map(I=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>Q(I.type),children:I.label},I.type))}),y?e.jsx("p",{className:"cogita-help",children:y}):null,N&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(N.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(N.connections)).replace("{infos}",String(N.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(pn,{nodes:v,edges:V,onNodesChange:S,onEdgesChange:b,onConnect:ge,onNodeClick:(I,Z)=>q(Z.id),fitView:!0,children:[e.jsx(fn,{color:"rgba(120,160,200,0.2)"}),e.jsx(bn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),T?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:T.data.label}),T.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:i,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:T.data.params.tagId?{id:T.data.params.tagId,label:T.data.params.tagLabel??"",infoType:"topic"}:null,onChange:I=>R({...T.data.params,tagId:(I==null?void 0:I.id)??null,tagLabel:(I==null?void 0:I.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:T.data.params.scope??"any",onChange:I=>R({...T.data.params,scope:I.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),T.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:i,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:T.data.params.languageId?{id:T.data.params.languageId,label:T.data.params.languageLabel??"",infoType:"language"}:null,onChange:I=>R({...T.data.params,languageId:(I==null?void 0:I.id)??null,languageLabel:(I==null?void 0:I.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:T.data.params.scope??"any",onChange:I=>R({...T.data.params,scope:I.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),T.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:T.data.params.infoType??"word",onChange:I=>R({...T.data.params,infoType:I.target.value}),children:uo.map(I=>e.jsx("option",{value:I.value,children:I.label},I.value))})]}),e.jsx(Yt,{libraryId:i,infoType:T.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:T.data.params.infoId?{id:T.data.params.infoId,label:T.data.params.infoLabel??"",infoType:T.data.params.infoType??"word"}:null,onChange:I=>R({...T.data.params,infoId:(I==null?void 0:I.id)??null,infoLabel:(I==null?void 0:I.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),T.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:T.data.params.connectionType??"translation",onChange:I=>R({...T.data.params,connectionType:I.target.value}),children:co.map(I=>e.jsx("option",{value:I.value,children:I.label},I.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:T.data.params.connectionId??"",onChange:I=>R({...T.data.params,connectionId:I.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(T.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const zn="cogita.preferences",On="cogita.reviewer.preferences",dr=["library_overview","all_cards","all_collections","all_revisions","storyboards","texts","dependencies","transfer"],Vn={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},all_revisions:{requiresCollection:!1,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},go=["settings","run","shared"],Aa=30,Ks=42;function fa(t,n){const r=(t??"").trim();return r.length<=n?r:n<=1?r.slice(0,n):`${r.slice(0,Math.max(1,n-1)).trimEnd()}…`}function mo(t,n=""){const r=t.split("/").filter(Boolean);if(r[0]!=="cogita"||r[1]!=="library")return{};const s=r[2];if(!s)return{};if(!r[3])return{libraryId:s,target:"library_overview"};const o=new URLSearchParams(n),h=o.get("revisionId")??void 0,c=o.get("infoId")??void 0,j=o.get("infoView"),p=j==="cards"?"cards":j==="collections"?"collections":"overview",w=o.get("collectionView")==="overview"?"overview":"infos",i=o.get("collectionAction"),m=o.get("libraryAction"),d=o.get("libraryTarget")==="revisions"?"all_revisions":"all_collections";if(r[3]==="list")return{libraryId:s,target:m==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:h,infoId:c,infoView:p,libraryAction:m==="new-info"?"new-info":void 0};if(r[3]==="detail"||r[3]==="collection")return{libraryId:s,target:"all_cards",cardMode:r[3],revisionId:h,infoId:c,infoView:p};if(r[3]==="new"||r[3]==="add")return{libraryId:s,target:"new_card",revisionId:h,libraryAction:"new-info"};if(r[3]==="edit")return{libraryId:s,target:"new_card",revisionId:h,infoId:r[4]};if(r[3]==="infos"){const g=r[4];return g?r[5]==="checkcards"?{libraryId:s,target:"all_cards",cardMode:"list",revisionId:h,infoId:g,infoView:"cards"}:r[5]==="collections"?{libraryId:s,target:"all_cards",cardMode:"list",revisionId:h,infoId:g,infoView:"collections"}:{libraryId:s,target:"all_cards",cardMode:"list",revisionId:h,infoId:g,infoView:"overview"}:{libraryId:s,target:"all_cards",cardMode:"list",revisionId:h}}if(r[3]==="shared-revisions")return{libraryId:s,target:d,revisionId:h};if(r[3]==="revisions"){const g=r[4];return g?g==="shared-links"?{libraryId:s,target:"all_revisions",revisionView:"shared"}:g==="new"?{libraryId:s,target:"all_revisions",revisionView:"new"}:r[5]==="run"?{libraryId:s,target:"all_revisions",revisionId:g,revisionView:"run"}:r[5]==="shared"?{libraryId:s,target:"all_revisions",revisionId:g,revisionView:"shared"}:{libraryId:s,target:"all_revisions",revisionId:g,revisionView:"settings"}:{libraryId:s,target:"all_revisions"}}if(r[3]==="revision"&&r[4]==="run")return{libraryId:s,target:d,revisionView:"run",revisionId:h,infoId:c,infoView:p};if(r[3]==="dependencies")return{libraryId:s,target:"dependencies"};if(r[3]==="transfer")return{libraryId:s,target:"transfer"};if(r[3]==="storyboards")return r[4]==="new"?{libraryId:s,target:"new_storyboard"}:{libraryId:s,target:"storyboards"};if(r[3]==="texts")return r[4]==="new"?{libraryId:s,target:"new_text"}:{libraryId:s,target:"texts"};if(r[3]!=="collections")return{libraryId:s,target:"library_overview"};if(r[4]==="new")return{libraryId:s,target:"new_collection",revisionId:h};const v=r[4];return v?r[5]==="graph"?{libraryId:s,target:d,collectionId:v,revisionId:h,revisionView:"graph"}:r[5]==="shared-revisions"?{libraryId:s,target:d,collectionId:v,revisionId:h,revisionView:"shared"}:r[5]==="revision"?{libraryId:s,target:d,collectionId:v,revisionId:h,revisionView:r[6]==="run"?"run":"settings",collectionView:w}:i==="new-revision"?{libraryId:s,target:d,collectionId:v,revisionId:h,revisionView:"new"}:{libraryId:s,target:d,collectionId:v,revisionId:h,revisionView:"detail",collectionView:w}:i==="new-collection"?{libraryId:s,target:"new_collection",collectionAction:"new-collection"}:{libraryId:s,target:d}}function _s(t,n="library_overview",r,s,o,h,c="overview",j="infos"){const p=(w,i)=>{const m=new URLSearchParams;i!=null&&i.revisionId&&m.set("revisionId",i.revisionId),i!=null&&i.collectionAction&&m.set("collectionAction",i.collectionAction),i!=null&&i.libraryAction&&m.set("libraryAction",i.libraryAction),i!=null&&i.libraryTarget&&m.set("libraryTarget",i.libraryTarget),i!=null&&i.infoId&&m.set("infoId",i.infoId),i!=null&&i.infoView&&(i!=null&&i.infoId)&&m.set("infoView",i.infoView),i!=null&&i.collectionView&&i.collectionView!=="infos"&&m.set("collectionView",i.collectionView);const l=m.toString();return l?`${w}?${l}`:w};if(!t)return"/cogita";if(n==="library_overview")return p(`/cogita/library/${t}`,{revisionId:o});if(n==="all_cards")return h?c==="cards"?p(`/cogita/library/${t}/infos/${h}/checkcards`,{revisionId:o}):c==="collections"?p(`/cogita/library/${t}/infos/${h}/collections`,{revisionId:o}):p(`/cogita/library/${t}/infos/${h}`,{revisionId:o}):p(`/cogita/library/${t}/list`,{revisionId:o,infoId:h,infoView:c});if(n==="new_card")return h?p(`/cogita/library/${t}/edit/${h}`,{revisionId:o}):p(`/cogita/library/${t}/list`,{revisionId:o,libraryAction:"new-info"});if(n==="all_collections"||n==="all_revisions"){const w=n==="all_revisions"?"revisions":void 0;return n==="all_revisions"&&o?s==="run"?p(`/cogita/library/${t}/revisions/${o}/run`,{revisionId:o}):s==="shared"?p(`/cogita/library/${t}/revisions/${o}/shared`,{revisionId:o}):p(`/cogita/library/${t}/revisions/${o}`,{revisionId:o}):n==="all_revisions"&&s==="new"?p(`/cogita/library/${t}/revisions/new`,{revisionId:o}):n==="all_revisions"?s==="shared"?p(`/cogita/library/${t}/revisions/shared-links`,{revisionId:o}):s==="run"?p(`/cogita/library/${t}/revision/run`,{revisionId:o,libraryTarget:w}):p(`/cogita/library/${t}/revisions`,{revisionId:o}):!r&&s==="run"?p(`/cogita/library/${t}/revision/run`,{revisionId:o,libraryTarget:w}):r?s==="graph"?p(`/cogita/library/${t}/collections/${r}/graph`,{revisionId:o,libraryTarget:w}):s==="settings"?p(`/cogita/library/${t}/collections/${r}/revision`,{revisionId:o,libraryTarget:w}):s==="run"?p(`/cogita/library/${t}/collections/${r}/revision/run`,{revisionId:o,libraryTarget:w}):s==="shared"?p(`/cogita/library/${t}/collections/${r}/shared-revisions`,{revisionId:o,libraryTarget:w}):s==="new"?p(`/cogita/library/${t}/collections/${r}`,{revisionId:o,libraryTarget:w,collectionAction:"new-revision"}):p(`/cogita/library/${t}/collections/${r}`,{revisionId:o,libraryTarget:w,collectionView:j}):p(`/cogita/library/${t}/collections`,{revisionId:o,libraryTarget:w})}return n==="new_collection"?p(`/cogita/library/${t}/collections`,{revisionId:o,collectionAction:"new-collection"}):n==="transfer"?p(`/cogita/library/${t}/transfer`,{revisionId:o}):n==="storyboards"?p(`/cogita/library/${t}/storyboards`,{revisionId:o}):n==="new_storyboard"?p(`/cogita/library/${t}/storyboards/new`,{revisionId:o}):n==="texts"?p(`/cogita/library/${t}/texts`,{revisionId:o}):n==="new_text"?p(`/cogita/library/${t}/texts/new`,{revisionId:o}):n==="dependencies"?p(`/cogita/library/${t}/dependencies`,{revisionId:o}):p(`/cogita/library/${t}`,{revisionId:o})}function ba(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function po(t){return typeof t=="string"&&dr.includes(t)}function fo(t,n){var j;if(!t.length)return null;const r=t.filter(p=>n.has(p.roleId)),s=r.length>0?r:t,o=s.map(p=>{var i,m;const w=((m=(i=p.fields.find(l=>l.fieldType==="role_kind"))==null?void 0:i.plainValue)==null?void 0:m.toLowerCase())??"";return{roleId:p.roleId,roleKind:w}}),h=o.find(p=>p.roleKind.includes("master"));if(h)return h.roleId;const c=o.find(p=>p.roleKind.includes("account")||p.roleKind.includes("user"));return c?c.roleId:((j=s[0])==null?void 0:j.roleId)??null}function bo(t){if(!t)return{version:1,byLibrary:{}};try{const n=JSON.parse(t);return!n||typeof n!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:n.lastLibraryId,byLibrary:n.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function yo({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w}){const i=mn(),m=Ja(),l=a.useMemo(()=>mo(m.pathname,m.search),[m.pathname,m.search]),d=t.cogita.workspace,[v,g]=a.useState([]),[S,V]=a.useState([]),[x,b]=a.useState([]),[D,q]=a.useState([]),[y,W]=a.useState(void 0),[N,P]=a.useState("library_overview"),[M,T]=a.useState(void 0),[Q,ge]=a.useState(void 0),[ye,Oe]=a.useState("detail"),[R,I]=a.useState(void 0),[Z,_]=a.useState(!1),[ae,Y]=a.useState(!0),[ve,le]=a.useState(!1),[se,Te]=a.useState(!1),[Ae,Ee]=a.useState(null),[$e,et]=a.useState(0),[ct,Ce]=a.useState(""),[We,xt]=a.useState(""),[Ve,De]=a.useState(""),[tt,ot]=a.useState([]),[Ye,Ie]=a.useState(""),[Be,Xe]=a.useState(0),[K,$]=a.useState(null),[B,F]=a.useState(null),k=a.useRef({version:1,byLibrary:{}}),C=a.useRef(!1),A=a.useRef(!1),ue=a.useRef(null),be=a.useMemo(()=>v.find(u=>u.libraryId===y)??null,[v,y]),he=a.useMemo(()=>S.find(u=>u.collectionId===M)??null,[S,M]),ee=ba(m.pathname)==="/cogita/persons";a.useEffect(()=>{if(!y){ot([]),Ie("");return}let u=!1;return Gs({libraryId:y}).then(oe=>{if(u)return;const H=oe.filter(Qe=>(Qe.roleKind??"").trim().toLowerCase()==="person");ot(H);try{const Qe=window.localStorage.getItem(On),lt=(Qe?JSON.parse(Qe):{})[y]??"",It=lt&&H.some(Mt=>Mt.roleId===lt)?lt:"";Ie(It)}catch{Ie("")}}).catch(()=>{u||(ot([]),Ie(""))}),()=>{u=!0}},[y,Be]),a.useEffect(()=>{if(y)try{const u=window.localStorage.getItem(On),oe=u?JSON.parse(u):{};Ye?oe[y]=Ye:delete oe[y],window.localStorage.setItem(On,JSON.stringify(oe))}catch{}},[y,Ye]);const E=a.useMemo(()=>D.find(u=>u.revisionId===Q)??null,[D,Q]),X=a.useMemo(()=>({detail:d.revisions.detail,graph:d.revisions.graph,settings:d.revisions.settings,run:d.revisions.run,shared:d.targets.sharedRevisions,new:d.revisionForm.createAction}),[d.revisions.detail,d.revisions.graph,d.revisions.run,d.revisions.settings,d.targets.sharedRevisions,d.revisionForm.createAction]),re=a.useMemo(()=>N==="new_card"?"all_cards":N==="new_collection"?"all_collections":N==="new_storyboard"?"storyboards":N==="new_text"?"texts":N,[N]),G=a.useMemo(()=>ye==="new"?"settings":ye,[ye]),te=N==="all_collections"||N==="all_revisions",xe=a.useMemo(()=>N==="new_collection"?"create":N==="all_collections"&&M?"selected":"search",[M,N]),U=a.useMemo(()=>l.infoId?"selected":N==="new_card"?"create":"search",[l.infoId,N]),ie=a.useMemo(()=>x.find(u=>u.infoId===l.infoId)??null,[x,l.infoId]),Le=a.useMemo(()=>({library_overview:d.targets.libraryOverview,all_cards:d.targets.allCards,new_card:d.targets.newCard,all_collections:d.targets.allCollections,all_revisions:d.targets.allRevisions,new_collection:d.targets.newCollection,transfer:d.targets.transfer,storyboards:d.targets.storyboards,new_storyboard:d.targets.newStoryboard,texts:d.targets.texts,new_text:d.targets.newText,dependencies:d.targets.dependencies}),[d.targets]),qe=a.useMemo(()=>Le[re]??re,[re,Le]),Ke=X[G],Je=!!y,bt=a.useMemo(()=>{const u=p==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":p==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return p==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:u},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:u},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:u},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:u},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:u},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:u},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:u},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:u},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:u},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:u},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:u},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:u},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:u},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:p==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:u},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:u},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:u},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:u},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:u},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:u},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:u},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:u},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:u},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:u},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:u},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:u},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:u},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:u},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:u},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:u},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:u},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:u},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:u},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:u},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:u},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:u},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:u},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:u},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:u},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:u},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[p]),mt=bt.length,pt=Math.max(0,Math.min($e,mt-1)),wt=bt[pt],Ct=!!M,Ot=Je&&N==="all_collections",Et=Ct&&N==="all_collections",Nt=Je&&(N==="all_revisions"||Ct&&N==="all_collections")&&(G==="settings"||G==="run"||G==="shared"||N==="all_revisions"),ua=Nt,Lt=Nt&&!!Q,vt=a.useCallback(u=>{const oe=!!u.libraryId;let H=u.target,Qe=u.collectionId,rt=u.revisionId,lt=u.revisionView,It=u.infoId,Mt=u.infoView??l.infoView??"overview",jt=u.collectionView??l.collectionView??"infos";oe?Vn[H].requiresCollection&&!Qe?(H=H==="all_revisions"?"all_revisions":"all_collections",rt=void 0,lt="detail"):H!=="all_collections"&&H!=="all_revisions"?(Qe=void 0,rt=void 0,H!=="new_card"&&H!=="all_cards"&&(It=void 0,Mt="overview"),H!=="new_collection"&&(jt="infos")):Vn[H].allowsRevision?go.includes(lt)||(rt=void 0):lt="detail":(H="library_overview",Qe=void 0,rt=void 0,lt="detail",It=void 0,Mt="overview",jt="infos"),W(u.libraryId),P(H),T(Qe),ge(rt),Oe(lt),_(!1);const At=ba(_s(u.libraryId,H,Qe,lt,rt,It,Mt,jt));ba(`${m.pathname}${m.search}`)!==At&&(ue.current=At,i(At))},[m.pathname,m.search,i,l.collectionView,l.infoView]),St=a.useMemo(()=>[{key:"library",label:d.layers.library,visible:!0,value:y??"",selectedLabel:(be==null?void 0:be.name)??d.path.noLibrarySelected,disabled:ae||v.length===0,options:v.map(u=>({value:u.libraryId,label:u.name})),emptyOption:d.noLibraryOption,onSelect:u=>{const oe=u||void 0;vt({libraryId:oe,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:d.layers.target,visible:Je,value:re,selectedLabel:qe,disabled:!Je,options:dr.map(u=>({value:u,label:Le[u]})),onSelect:u=>{const oe=u;vt({libraryId:y,target:oe,collectionId:M,revisionId:Q,revisionView:ye,infoId:oe==="new_card"?l.infoId:void 0})}},{key:"info_mode",label:d.layers.target,visible:re==="all_cards",value:U,selectedLabel:U==="create"?d.infoMode.create:U==="selected"?(ie==null?void 0:ie.label)??R??t.cogita.library.list.selectedEmpty:d.infoMode.search,disabled:!Je,options:[{value:"search",label:d.infoMode.search},{value:"create",label:d.infoMode.create},...l.infoId?[{value:"selected",label:(ie==null?void 0:ie.label)??R??t.cogita.library.list.selectedEmpty}]:[]],onSelect:u=>{if(u==="selected"){if(!l.infoId)return;vt({libraryId:y,target:"all_cards",collectionId:M,revisionId:Q,revisionView:ye,infoId:l.infoId,infoView:"overview"});return}if(u==="create"){vt({libraryId:y,target:"new_card",collectionId:M,revisionId:Q,revisionView:ye,infoId:void 0});return}vt({libraryId:y,target:"all_cards",collectionId:M,revisionId:Q,revisionView:ye,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:d.layers.target,visible:re==="all_cards"&&!!l.infoId,value:N==="new_card"&&l.infoId?"edit":l.infoView==="cards"?"cards":l.infoView==="collections"?"collections":"overview",selectedLabel:N==="new_card"&&l.infoId?d.infoActions.edit:l.infoView==="cards"?d.infoActions.seeCards:l.infoView==="collections"?"Kolekcje":d.infoActions.overview,disabled:!Je||!l.infoId,options:[{value:"overview",label:d.infoActions.overview},{value:"edit",label:d.infoActions.edit},{value:"cards",label:d.infoActions.seeCards},{value:"collections",label:"Kolekcje"}],onSelect:u=>{if(l.infoId){if(u==="edit"){vt({libraryId:y,target:"new_card",collectionId:M,revisionId:Q,revisionView:ye,infoId:l.infoId});return}if(u==="cards"){vt({libraryId:y,target:"all_cards",collectionId:M,revisionId:Q,revisionView:ye,infoId:l.infoId,infoView:"cards"});return}vt({libraryId:y,target:"all_cards",collectionId:M,revisionId:Q,revisionView:ye,infoId:l.infoId,infoView:"overview"})}}},{key:"collection_mode",label:d.layers.collection,visible:Je&&(N==="all_collections"||N==="new_collection"),value:xe,selectedLabel:xe==="create"?t.cogita.library.actions.createCollection:xe==="selected"?(he==null?void 0:he.name)??d.path.noCollectionSelected:t.cogita.library.actions.collections,disabled:!Je,options:[{value:"search",label:t.cogita.library.actions.collections},{value:"create",label:t.cogita.library.actions.createCollection},...M&&he?[{value:"selected",label:he.name}]:[]],onSelect:u=>{if(u==="create"){vt({libraryId:y,target:"new_collection",collectionId:void 0,revisionId:void 0,revisionView:"detail"});return}if(u==="selected"&&M){const oe=te?N:"all_collections";vt({libraryId:y,target:oe,collectionId:M,revisionId:Q,revisionView:oe==="all_revisions"?"settings":"detail"});return}if(u==="collections"){vt({libraryId:y,target:"all_cards",collectionId:M,revisionId:Q,revisionView:ye,infoId:l.infoId,infoView:"collections"});return}vt({libraryId:y,target:te?N:"all_collections",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection",label:d.layers.collection,visible:Ot&&xe!=="create",value:M??"",selectedLabel:(he==null?void 0:he.name)??d.path.noCollectionSelected,disabled:!Je||ve||S.length===0,options:S.map(u=>({value:u.collectionId,label:u.name})),emptyOption:d.selectCollectionOption,onSelect:u=>{const oe=u||void 0,H=te?N:"all_collections";vt({libraryId:y,target:H,collectionId:oe,revisionId:void 0,revisionView:H==="all_revisions"?"settings":"detail"})}},{key:"collection_selected_action",label:d.layers.revision,visible:Et,value:N==="all_revisions"?"revisions":G==="graph"?"edit":G==="settings"||G==="run"||G==="shared"?"revisions":(l.collectionView??"infos")==="overview"?"overview":"infos",selectedLabel:N==="all_revisions"?d.targets.allRevisions:G==="graph"?"Edytuj":G==="settings"||G==="run"||G==="shared"?d.targets.allRevisions:(l.collectionView??"infos")==="overview"?"Przegląd":"Informacje",disabled:!M,options:[{value:"overview",label:"Przegląd"},{value:"edit",label:"Edytuj"},{value:"infos",label:"Informacje"},{value:"revisions",label:d.targets.allRevisions}],onSelect:u=>{if(M){if(u==="edit"){vt({libraryId:y,target:te?N:"all_collections",collectionId:M,revisionId:void 0,revisionView:"graph"});return}if(u==="revisions"){vt({libraryId:y,target:te?N:"all_collections",collectionId:M,revisionId:Q,revisionView:"settings"});return}vt({libraryId:y,target:te?N:"all_collections",collectionId:M,revisionId:void 0,revisionView:"detail",infoId:l.infoId,infoView:l.infoView,collectionView:u==="overview"?"overview":"infos"})}}},{key:"revision_mode",label:d.layers.revision,visible:ua,value:ye==="new"?"create":!Q&&G==="shared"?"shared":"search",selectedLabel:ye==="new"?d.revisionForm.createAction:!Q&&G==="shared"?d.targets.sharedRevisions:d.infoActions.search,disabled:N==="all_revisions"?!Je:!Ct,options:[{value:"search",label:d.infoActions.search},{value:"create",label:d.revisionForm.createAction},{value:"shared",label:d.targets.sharedRevisions}],onSelect:u=>{vt({libraryId:y,target:te?N:"all_revisions",collectionId:N==="all_revisions"?void 0:M,revisionId:void 0,revisionView:u==="create"?"new":u==="shared"?"shared":"settings"})}},{key:"revision_entry",label:d.layers.revision,visible:ua,value:Q??"",selectedLabel:(E==null?void 0:E.name)??d.status.noRevisions,disabled:(N==="all_revisions"?!Je:!Ct)||se||D.length===0,options:D.map(u=>({value:u.revisionId,label:u.name})),emptyOption:d.status.noRevisions,onSelect:u=>{vt({libraryId:y,target:te?N:"all_collections",collectionId:M,revisionId:u||void 0,revisionView:G==="settings"||G==="run"||G==="shared"?G:"settings"})}},{key:"revision_selected_action",label:d.layers.revision,visible:Lt,value:G==="run"?"run":G==="shared"?"shared":"settings",selectedLabel:G==="run"?d.revisions.run:G==="shared"?d.targets.sharedRevisions:d.infoActions.edit,disabled:!Q,options:[{value:"settings",label:d.infoActions.edit},{value:"run",label:d.revisions.run},{value:"shared",label:d.targets.sharedRevisions}],onSelect:u=>{Q&&vt({libraryId:y,target:te?N:"all_collections",collectionId:M,revisionId:Q,revisionView:u==="run"?"run":u==="shared"?"shared":"settings"})}}],[S,ve,U,x,v,ae,vt,D,se,he,M,ie,E,Q,R,Ct,Je,be,te,y,Ke,ye,N,G,re,qe,Ot,Et,ua,Lt,Le,t.cogita.library.list.selectedEmpty,l.infoId,l.infoView,l.collectionView,d.infoActions.edit,d.infoActions.overview,d.infoActions.seeCards,d.layers.collection,d.layers.library,d.layers.revision,d.layers.target,d.noLibraryOption,d.path.noCollectionSelected,d.path.noLibrarySelected,d.selectCollectionOption,d.targets.allRevisions,d.infoActions.search,d.revisionForm.createAction,d.revisions.run,d.targets.sharedRevisions,xe]),kt=a.useMemo(()=>St.filter(u=>u.visible),[St]),yt=a.useMemo(()=>kt.filter(u=>u.key!=="library"&&u.key!=="collection"),[kt]),Kt=a.useMemo(()=>yt.find(u=>u.key==="target")??null,[yt]),st=a.useMemo(()=>yt.find(u=>u.key==="info_mode")??null,[yt]),Ue=a.useMemo(()=>yt.find(u=>u.key==="info_selected_action")??null,[yt]),ft=a.useMemo(()=>yt.find(u=>u.key==="collection_mode")??null,[yt]),Qt=a.useMemo(()=>yt.find(u=>u.key==="revision_mode")??null,[yt]),Vt=a.useMemo(()=>yt.find(u=>u.key==="collection_selected_action")??null,[yt]),Bt=a.useMemo(()=>yt.find(u=>u.key==="revision_entry")??null,[yt]),me=a.useMemo(()=>yt.find(u=>u.key==="revision_selected_action")??null,[yt]),$t=a.useCallback((u,oe)=>u?e.jsx("div",{className:"cogita-sidebar-actions",children:u.options.map(H=>e.jsx("button",{type:"button",className:`ghost ${String(u.value)===H.value?"active":""}`,onClick:()=>u.onSelect(H.value),disabled:u.disabled,title:H.label,children:fa(H.label,Aa)},`${oe}:${u.key}:${H.value}`))}):null,[]),Xt=a.useMemo(()=>{const u=l.libraryId;if(!u||!m.pathname.startsWith("/cogita/library/"))return null;const oe={copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,libraryId:u};if(l.target==="library_overview")return e.jsx(ei,{...oe});if(l.target==="all_cards")return l.infoId&&l.infoView==="cards"?e.jsx(Ai,{...oe,infoId:l.infoId,selectedReviewerRoleId:Ye||null}):e.jsx(hi,{...oe,mode:l.cardMode??"list"});if(l.target==="new_card")return e.jsx(wi,{...oe,editInfoId:l.infoId});if(l.target==="dependencies")return e.jsx(Ni,{...oe});if(l.target==="transfer")return e.jsx(Fi,{...oe});if(l.target==="storyboards"||l.target==="new_storyboard")return e.jsx(Ki,{...oe});if(l.target==="texts"||l.target==="new_text")return e.jsx(_i,{...oe});if(l.target==="all_collections"||l.target==="all_revisions"){if(l.target==="all_revisions"&&!l.collectionId)return l.revisionView==="run"?e.jsx(Dn,{...oe,revisionId:l.revisionId}):e.jsx(Fs,{...oe,revisionId:l.revisionId});if(!l.collectionId&&l.revisionView==="run")return e.jsx(Dn,{...oe,revisionId:l.revisionId});if(l.collectionId){const H={...oe,collectionId:l.collectionId};return l.revisionView==="graph"?e.jsx(ho,{...H}):l.revisionView==="shared"?e.jsx(Ei,{...oe,collectionId:l.collectionId}):l.revisionView==="settings"?e.jsx(Fs,{...H,revisionId:l.revisionId}):l.revisionView==="run"?e.jsx(Dn,{...H,revisionId:l.revisionId}):e.jsx(Bi,{...H})}return e.jsx(Di,{...oe})}return l.target==="new_collection"?e.jsx(qi,{...oe,onCreated:H=>{vt({libraryId:u,target:N==="all_revisions"?"all_revisions":"all_collections",collectionId:H,revisionId:void 0,revisionView:"graph"})}}):null},[n,vt,t,p,m.pathname,i,w,h,j,s,o,l.cardMode,l.collectionId,l.infoId,l.libraryId,l.revisionId,l.revisionView,l.target,c,r,N,Ye]);a.useEffect(()=>{let u=!1;return(async()=>{var H,Qe,rt,lt,It;Y(!0);try{await $r();const[Mt,jt,At]=await Promise.all([Vs(),Js(),Rr()]);if(u)return;g(Mt);const ha=new Set(At.nodes.filter(ut=>ut.nodeType==="role"&&ut.canLink).map(ut=>ut.roleId??"")),ma=fo(jt,ha);if($(ma),ma){const ut=At.nodes.find(_t=>_t.nodeType==="data"&&_t.roleId===ma&&(_t.fieldType===zn||_t.label===zn));F((ut==null?void 0:ut.dataKeyId)??null),k.current=bo(ut==null?void 0:ut.value)}const Ft=(H=Mt.find(ut=>ut.libraryId===l.libraryId))==null?void 0:H.libraryId,ta=Ft?(rt=(Qe=k.current.byLibrary)==null?void 0:Qe[Ft])==null?void 0:rt.lastTarget:void 0,Ta=po(ta)?ta:"library_overview";W(Ft),P(l.target??Ta),ge(l.revisionId??(Ft?(It=(lt=k.current.byLibrary)==null?void 0:lt[Ft])==null?void 0:It.lastRevisionId:void 0)),Oe(l.revisionView??"detail"),C.current=!0}catch{u||Ee(d.status.loadFailed)}finally{u||Y(!1)}})(),()=>{u=!0}},[d.status.loadFailed]),a.useLayoutEffect(()=>{if(C.current){if(!l.libraryId){W(void 0),P(l.target??"library_overview"),T(void 0),ge(void 0),Oe("detail");return}l.libraryId&&v.some(u=>u.libraryId===l.libraryId)&&W(l.libraryId),l.target&&P(l.target),T(l.collectionId),ge(l.revisionId),l.revisionView&&Oe(l.revisionView)}},[v,l.collectionId,l.libraryId,l.revisionId,l.revisionView,l.target]),a.useEffect(()=>{if(!y){V([]),T(void 0),b([]),q([]),ge(void 0);return}let u=!1;return le(!0),Va({libraryId:y,limit:200}).then(oe=>{var rt;if(u)return;const H=oe.items;V(H);const Qe=(rt=H.find(lt=>lt.collectionId===l.collectionId))==null?void 0:rt.collectionId;T(Qe)}).catch(()=>{u||(V([]),T(void 0))}).finally(()=>{u||le(!1)}),()=>{u=!0}},[l.collectionId,y]),a.useEffect(()=>{if(!y||re!=="all_cards"&&N!=="new_card"){b([]);return}let u=!1;return Xn({libraryId:y,limit:200}).then(oe=>{u||b(oe)}).catch(()=>{u||b([])}),()=>{u=!0}},[re,y,N]),a.useEffect(()=>{if(!y||N!=="all_revisions"&&!M){q([]),N!=="all_revisions"&&ge(void 0);return}let u=!1;return Te(!0),Gn({libraryId:y,collectionId:N==="all_revisions"?void 0:M}).then(oe=>{var rt,lt,It,Mt;if(u)return;q(oe);const H=(lt=(rt=k.current.byLibrary)==null?void 0:rt[y])==null?void 0:lt.lastRevisionId,Qe=((It=oe.find(jt=>jt.revisionId===l.revisionId))==null?void 0:It.revisionId)??((Mt=oe.find(jt=>jt.revisionId===H))==null?void 0:Mt.revisionId);ge(Qe)}).catch(()=>{u||(q([]),ge(void 0))}).finally(()=>{u||Te(!1)}),()=>{u=!0}},[l.revisionId,M,y,N]),a.useEffect(()=>{const u=l.infoId;if(!y||!u){I(void 0);return}let oe=!1;return na({libraryId:y,infoId:u}).then(H=>{if(oe)return;const Qe=H.payload??{},rt=Qe.definition&&typeof Qe.definition=="object"?Qe.definition:null,lt=typeof(rt==null?void 0:rt.title)=="string"?rt.title:void 0,It=typeof(rt==null?void 0:rt.question)=="string"?rt.question:void 0,Mt=typeof Qe.label=="string"?Qe.label:void 0,jt=typeof Qe.name=="string"?Qe.name:void 0,At=typeof Qe.title=="string"?Qe.title:void 0;I(lt??It??Mt??jt??At??H.infoId)}).catch(()=>{oe||I(u)}),()=>{oe=!0}},[l.infoId,y]),a.useEffect(()=>{if(!C.current||l.libraryId&&v.some(rt=>rt.libraryId===l.libraryId)&&l.libraryId!==y||l.target&&l.target!==N||l.revisionView&&l.revisionView!==ye||l.revisionId&&l.revisionId!==Q||Vn[N].requiresCollection&&!M&&(l.target==="all_collections"||l.target==="all_revisions")&&l.collectionId)return;const u=ba(`${m.pathname}${m.search}`);if(ba(m.pathname)==="/cogita"&&!l.libraryId&&!y){ue.current=null;return}if(ba(m.pathname)==="/cogita/persons"){ue.current=null;return}if(ba(m.pathname)===`/cogita/library/${y}/revision/run`&&l.revisionView==="run"&&!l.collectionId&&(N==="all_collections"||N==="all_revisions")&&ye==="run"&&!M){ue.current=null;return}const Qe=ba(_s(y,N,M,ye,Q,l.infoId,l.infoView??"overview",l.collectionView??"infos"));if(u===Qe){ue.current=null;return}ue.current!==Qe&&(ue.current=Qe,i(Qe,{replace:!0}))},[v,m.pathname,m.search,i,l.collectionId,l.infoId,l.infoView,l.collectionView,l.libraryId,l.revisionId,l.revisionView,l.target,M,y,Q,ye,N]),a.useEffect(()=>{if(typeof window>"u")return;const u=()=>{window.innerWidth>920&&_(!1)};return window.addEventListener("resize",u),()=>window.removeEventListener("resize",u)},[]),a.useEffect(()=>{if(!C.current||!K||!y||A.current)return;const u=k.current,oe={...u.byLibrary??{}},H={...oe[y]??{},lastCollectionId:M,lastRevisionId:Q,lastRevisionView:ye,lastTarget:N},Qe={version:1,lastLibraryId:y,byLibrary:{...oe,[y]:H}},rt=JSON.stringify(u),lt=JSON.stringify(Qe);if(rt===lt)return;k.current=Qe,A.current=!0,(async()=>{try{if(B)await Pr(B,{plainValue:lt});else{const Mt=await Er(K,{itemName:zn,itemType:"data",plainValue:lt});F(Mt.dataItemId)}}catch{Ee(d.status.savePrefsFailed)}finally{A.current=!1}})()},[B,K,M,y,Q,ye,N,d.status.savePrefsFailed]);const qt=async()=>{const u=ct.trim();if(!u){Ee(t.cogita.user.libraryNameRequired);return}Ee(null);try{const oe=await Kr({name:u});g(H=>[oe,...H]),W(oe.libraryId),P("library_overview"),T(void 0),Ce("")}catch{Ee(t.cogita.user.libraryCreateFailed)}},O=async()=>{if(!y||!M){Ee(d.status.selectLibraryFirst);return}const u=Ve.trim();if(!u){Ee(d.revisionForm.nameLabel);return}Ee(null);try{const oe=await Fr({libraryId:y,collectionId:M,name:u,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});q(H=>[oe,...H]),ge(oe.revisionId),P(N==="all_revisions"?"all_revisions":"all_collections"),Oe("settings"),De("")}catch{Ee(d.status.loadFailed)}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,headerExtra:e.jsxs("div",{className:"cogita-header-reviewer-actions",children:[e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:Ye,disabled:!y,onChange:u=>{const oe=u.target.value;if(oe==="__new_person__"){i("/cogita/persons");return}Ie(oe)},children:[e.jsx("option",{value:"",children:y?"No person":"Select library first"}),tt.map(u=>e.jsx("option",{value:u.roleId,children:u.label},u.roleId)),e.jsx("option",{value:"__new_person__",children:"+ Create new person"})]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>i("/cogita/persons"),children:"Persons"})]}),children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${Z?"open":""}`,"aria-label":d.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{title:(be==null?void 0:be.name)??d.path.noLibrarySelected,children:fa((be==null?void 0:be.name)??d.path.noLibrarySelected,Aa)}),e.jsx("p",{className:"cogita-sidebar-note",children:be?d.sidebar.libraryActionsHint:d.status.selectLibraryFirst}),$t(Kt,"sidebar"),N==="all_revisions"&&Bt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.targets.allRevisions}),$t(Qt,"sidebar"),$t(Bt,"sidebar"),me?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(E==null?void 0:E.name)??d.status.noRevisions,children:fa((E==null?void 0:E.name)??d.status.noRevisions,Aa)}),$t(me,"sidebar")]}):null]}):null,st?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.infoActionsHint}),$t(st,"sidebar"),Ue?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(ie==null?void 0:ie.label)??R??t.cogita.library.list.selectedEmpty,children:fa((ie==null?void 0:ie.label)??R??t.cogita.library.list.selectedEmpty,Aa)}),e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.selectedInfoActionsHint}),$t(Ue,"sidebar")]}):null]}):null,ft?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.collectionActionsHint}),$t(ft,"sidebar"),he&&Vt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:he.name,children:fa(he.name,Aa)}),$t(Vt,"sidebar"),N!=="all_revisions"&&Bt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.targets.allRevisions}),$t(Qt,"sidebar"),$t(Bt,"sidebar"),me?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(E==null?void 0:E.name)??d.status.noRevisions,children:fa((E==null?void 0:E.name)??d.status.noRevisions,Aa)}),$t(me,"sidebar")]}):null]}):null]}):null]}):null]}),e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:d.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:s,children:d.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{j("cogita"),_(!1)},children:d.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:o,children:c?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),Z?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":d.sidebar.closeMenu,onClick:()=>_(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":d.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>_(u=>!u),"aria-label":Z?d.sidebar.closeMenu:d.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),kt.map((u,oe)=>e.jsxs("div",{className:"cogita-browser-segment",children:[oe>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,u.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":u.label,title:u.selectedLabel,children:fa(u.selectedLabel,Ks)}):e.jsxs("select",{"aria-label":u.label,value:u.value,onChange:H=>u.onSelect(H.target.value),disabled:u.disabled,children:[u.emptyOption?e.jsx("option",{value:"",children:u.emptyOption}):null,u.options.map(H=>e.jsx("option",{value:H.value,title:H.label,children:fa(H.label,Ks)},`${u.key}:${H.value}`))]})]},`menu:${u.key}`))]}),Xt?e.jsxs(e.Fragment,{children:[(N==="all_collections"||N==="all_revisions")&&ye==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:d.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsxs("select",{value:M??"",onChange:u=>T(u.target.value||void 0),children:[e.jsx("option",{value:"",children:d.selectCollectionOption}),S.map(u=>e.jsx("option",{value:u.collectionId,children:u.name},u.collectionId))]})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:d.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Ve,onChange:u=>De(u.target.value),placeholder:d.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:O,children:d.revisionForm.createAction}),Ae?e.jsx("p",{className:"cogita-form-error",children:Ae}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Ys.Provider,{value:!0,children:Xt})})]}):null,Xt?null:e.jsxs(e.Fragment,{children:[ee?e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Pi,{copy:t,onPersonCreated:u=>{Xe(oe=>oe+1)}})}):null,!y&&!ee?e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:wt.step}),e.jsx("h2",{children:wt.title})]}),e.jsxs("p",{children:[pt+1," / ",mt]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:wt.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:wt.passages.map(u=>e.jsx("p",{children:u},u))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:wt.focus.map(u=>e.jsx("span",{children:u},u))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:wt.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:bt.map((u,oe)=>e.jsx("button",{type:"button",className:`ghost ${oe===pt?"active":""}`,onClick:()=>et(oe),"aria-label":`${oe+1}`,children:oe+1},`tutorial:${u.title}:${oe}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:pt===0,onClick:()=>et(u=>Math.max(0,u-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:pt===mt-1,onClick:()=>et(u=>Math.min(mt-1,u+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:ct,onChange:u=>Ce(u.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:qt,children:t.cogita.user.createLibraryAction}),Ae?e.jsx("p",{className:"cogita-form-error",children:Ae}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),v.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,v.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:v.map(u=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{vt({libraryId:u.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:u.name})]},u.libraryId))}):null]})]})]}):null]})]})]})})}const Lo=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:yo},Symbol.toStringTag,{value:"Module"}));function xo({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,shareId:i}){const[m,l]=a.useState(null),[d,v]=a.useState("loading"),[g,S]=a.useState(t.cogita.library.collections.defaultName),[V,x]=a.useState("Cogita Library"),[b,D]=a.useState([]),[q,y]=a.useState([]),[W,N]=a.useState("idle"),[P,M]=a.useState({current:0,total:0}),[T,Q]=a.useState(0),[ge,ye]=a.useState(""),[Oe,R]=a.useState(null),[I,Z]=a.useState(null),[_,ae]=a.useState(null),[Y,ve]=a.useState(null),[le,se]=a.useState([]),[Te,Ae]=a.useState({}),[Ee,$e]=a.useState({}),[et,ct]=a.useState(null),[Ce,We]=a.useState(null),[xt,Ve]=a.useState(null),[De,tt]=a.useState(null),[ot,Ye]=a.useState({}),Ie=a.useRef(0),[Be,Xe]=a.useState(null),K=a.useRef(null),$=a.useRef(null),[B,F]=a.useState(null),[k,C]=a.useState(!1),[A,ue]=a.useState(null),[be,he]=a.useState([]),[ee,E]=a.useState(null),X=a.useRef(null),re=a.useRef(null),[G,te]=a.useState(null),[xe,U]=a.useState(0),ie=a.useRef(null),Le=a.useRef({}),[qe,Ke]=a.useState(!1),[Je,bt]=a.useState({}),mt=a.useRef(null),pt=a.useRef(new Set),wt=a.useRef({}),[Ct,Ot]=a.useState([]),[Et,Nt]=a.useState(new Set),[ua,Lt]=a.useState(!1),vt=Ja(),St=a.useMemo(()=>new URLSearchParams(vt.search),[vt.search]),kt=a.useMemo(()=>St.get("key")??"",[St]),yt=(m==null?void 0:m.mode)??"random",Kt=(m==null?void 0:m.check)??"exact",st=(m==null?void 0:m.limit)??20,Ue=a.useMemo(()=>rs((m==null?void 0:m.revisionType)??yt),[m,yt]),ft=a.useMemo(()=>{const z=m==null?void 0:m.revisionSettings,ce=nr(Ue,St);return wn(Ue,z??ce)},[m,St,Ue]),Qt=a.useMemo(()=>t.cogita.library.revision[Ue.labelKey]??yt,[t,yt,Ue]),Vt=a.useMemo(()=>Kt==="exact"?t.cogita.library.revision.checkValue:Kt,[t,Kt]),me=d==="ready"?b[T]??null:null,$t=(me==null?void 0:me.checkType)==="translation-match"&&De,Xt=a.useRef(new Map),qt=a.useRef(new Map),O=a.useRef(new Map),u=a.useRef(new Map),oe=a.useMemo(()=>me?me.cardType==="vocab"?t.cogita.library.revision.vocabLabel:me.infoType?nt(t,me.infoType):t.cogita.library.revision.infoLabel:"",[t,me]),H=a.useMemo(()=>{var ce;return Ue.id!=="levels"?b.length:((ce=Je.pool)==null?void 0:ce.length)??Ue.getFetchLimit(st,ft)},[Je,ft,Ue,b.length,st]),Qe=Ue.getProgressTotal?Ue.getProgressTotal(b,Je,st,ft):Ue.id==="levels"?Math.min(st,H):b.length,rt=Qe?Math.min(T+1,Qe):0,lt=Math.max(1,Number(ft.tries??1)),It=ft.compare??"anchors",Mt=Math.max(0,Math.min(100,Number(ft.minCorrectness??0))),jt=(ft.considerDependencies??"on")==="on",At=Math.max(0,Math.min(100,Number(ft.dependencyThreshold??85))),ha=z=>{const ce=z.slice();for(let we=ce.length-1;we>0;we-=1){const Fe=Math.floor(Math.random()*(we+1));[ce[we],ce[Fe]]=[ce[Fe],ce[we]]}return ce},ma=z=>xa(z,{treatSimilarCharsAsSame:!0})>=Mt,Ft=async()=>{const z=await ca(),ce=new Map,we=new Map;z.forEach(ke=>{const Re=`${ke.itemType}:${ke.itemId}`,Me=ea(ke.itemType,ke.itemId,ke.checkType,ke.direction);ce.has(Re)||ce.set(Re,[]),ce.get(Re).push(ke),we.has(Me)||we.set(Me,[]),we.get(Me).push(ke)});const Fe=new Map,_e=new Map;return ce.forEach((ke,Re)=>Fe.set(Re,la(ke).score)),we.forEach((ke,Re)=>_e.set(Re,la(ke).score)),{itemKnowness:Fe,cardKnowness:_e}},ta=async z=>{const ce=Je,we=z.concat(ce.active??[]).concat(ce.pool??[]).filter((f,L,J)=>J.findIndex(pe=>Ne(pe)===Ne(f))===L);if(!jt){Nt(new Set(we.map(Ne)));return}const{itemKnowness:Fe,cardKnowness:_e}=await Ft(),ke=f=>{if(f.cardType!=="info"||f.infoType!=="citation"||f.checkType!=="quote-fragment")return!0;const L=Wt(f.direction);if(!(L!=null&&L.fragmentId))return!0;const J=f.description??"";if(!J.trim())return!0;const fe=va(J).nodes[L.fragmentId];if(!fe||!fe.leftId&&!fe.rightId)return!0;const de=[fe.leftId,fe.rightId].filter(Se=>!!Se);if(de.length===0)return!0;const je=de.map(Se=>{const ze=ea("info",f.cardId,"quote-fragment",Se);return _e.get(ze)??0});return je.reduce((Se,ze)=>Se+ze,0)/je.length>=At},Re=(m==null?void 0:m.collectionId)??null,Me=Re?Ct.filter(f=>Tt(f.childItemType)==="collection"&&f.childItemId===Re&&!Tt(f.childCheckType)&&!Tt(f.childDirection)):[],Pe=Re&&we.length>0?we.reduce((f,L)=>f+(_e.get(Ne(L))??0),0)/we.length:0,Ge=new Set;for(const f of we){if(f.cardType!=="info"){Ge.add(Ne(f));continue}if(!ke(f))continue;const L=Ct.filter(fe=>cr(fe,f)).concat(Me);if(L.length===0){Ge.add(Ne(f));continue}let J=0;for(const fe of L)if(Tt(fe.parentItemType)==="collection")J+=fe.parentItemId===Re?Pe:0;else if(Tt(fe.parentCheckType)||Tt(fe.parentDirection)){const de=Tt(fe.parentCheckType),je=Tt(fe.parentDirection),ne=ea(fe.parentItemType,fe.parentItemId,de,je);J+=_e.get(ne)??0}else{const de=`${fe.parentItemType}:${fe.parentItemId}`;J+=Fe.get(de)??0}J/L.length>=At&&Ge.add(Ne(f))}Nt(Ge)},Ta=z=>{for(let ce=z;ce<b.length;ce+=1){const we=b[ce];if(we&&(!jt||we.cardType!=="info"||Et.has(Ne(we))))return ce}return-1},ut=z=>!jt||z.cardType!=="info"||Et.has(Ne(z)),_t=z=>{if(Ue.id!=="temporal"&&Ue.id!=="levels")return null;const ce=Je,we=(ce.active??[]).concat(ce.pool??[]),Fe=new Set;for(const _e of we){const ke=Ne(_e);if(!(Fe.has(ke)||z.has(ke))&&(Fe.add(ke),ut(_e)))return _e}return null},Zt=a.useMemo(()=>{if(Ue.id!=="levels")return null;const z=Je,ce=z.pool??[],we=z.active??[],Fe=z.levelMap??{},_e=Math.max(1,Number(ft.levels??1)),ke=Array.from({length:_e},()=>0),Re=new Set(we.map(f=>Ne(f)));ce.forEach(f=>{const L=Math.min(_e,Math.max(1,Fe[Ne(f)]??1));ke[L-1]+=1});const Me=ce.length||1,Pe=ke.map(f=>f/Me*100),Ge=me?Fe[Ne(me)]??1:null;return{counts:ke,percentages:Pe,currentLevel:Ge,levelsCount:_e,activeCount:we.length,poolCount:ce.length,activeSet:Re}},[Je,ft,Ue,me]),ja=a.useMemo(()=>{if(Ue.id!=="temporal")return null;const z=Je,ce=z.pool??[],we=z.active??[],Fe=z.knownessMap??{},_e=new Set(z.unknownSet??[]);let ke=0;ce.forEach(Pe=>{(Fe[Ne(Pe)]??0)>1&&(ke+=1)});const Re=_e.size,Me=we.map(Pe=>({id:Ne(Pe),value:_e.has(Ne(Pe))?0:Math.max(0,Math.min(1,Fe[Ne(Pe)]??0))}));return{knownCount:ke,unknownCount:Re,dots:Me}},[Je,Ue]),Wa=a.useMemo(()=>{if(!jt)return 0;const z=Je;return b.concat(z.active??[]).concat(z.pool??[]).filter((we,Fe,_e)=>_e.findIndex(ke=>Ne(ke)===Ne(we))===Fe).filter(we=>we.cardType==="info"&&!Et.has(Ne(we))).length},[jt,Je,b,Et]);a.useEffect(()=>{if(!jt||W!=="ready")return;const z=Je,we=b.concat(z.active??[]).concat(z.pool??[]).filter((ke,Re,Me)=>Me.findIndex(Pe=>Ne(Pe)===Ne(ke))===Re).filter(ke=>ke.cardType!=="info"||Et.has(Ne(ke))).length,Fe=X.current;if(X.current=we,Fe===null||we<=Fe)return;const _e=we-Fe;E(`New card available (+${_e})`),re.current&&window.clearTimeout(re.current),re.current=window.setTimeout(()=>E(null),2200)},[jt,W,Je,b,Et]),a.useEffect(()=>()=>{re.current&&window.clearTimeout(re.current)},[]);const Gt=(z,ce)=>{const we=Ue.applyOutcome({queue:b,meta:Je},me,st,ft,{correct:z,correctness:ce,createdUtc:new Date().toISOString()});D(we.queue),bt(we.meta);const Fe=we.queue[T+1];Fe&&zt(Fe,T+1)};a.useEffect(()=>{if(!i){v("error");return}v("loading"),_r({shareId:i,key:kt}).then(z=>{l(z),S(z.collectionName),x(z.libraryName),v("ready")}).catch(()=>{v("error")})},[i,kt]),a.useEffect(()=>{i&&Dr({shareId:i,key:kt,type:"language"}).then(z=>y(z)).catch(()=>y([]))},[i,kt]),a.useEffect(()=>{!i||d!=="ready"||Br({shareId:i,key:kt}).then(z=>Ot(z.items??[])).catch(()=>Ot([]))},[i,kt,d]),a.useEffect(()=>{if(!i||d!=="ready")return;let z=!0;return(async()=>{N("loading"),M({current:0,total:Ue.id==="levels"?0:Ue.getFetchLimit(st,ft)});try{const we=[];let Fe=null,_e=null;do{const L=await zr({shareId:i,key:kt,limit:300,cursor:Fe});if(we.push(...L.items),(Ue.id==="levels"||Ue.id==="temporal")&&L.total&&(_e=L.total),M(J=>({current:we.length,total:J.total||L.total||Ue.getFetchLimit(st,ft)})),Fe=L.nextCursor??null,_e!==null&&we.length>=_e||Ue.id!=="levels"&&Ue.id!=="temporal"&&we.length>=Ue.getFetchLimit(st,ft))break}while(Fe);if(!z)return;const ke=Oa(we);let Re;if(Ue.id==="levels"){const L=Math.max(1,Number(ft.levels??1));Re={},ke.forEach(J=>{const pe=Ne(J);Re[pe]=Math.max(1,Math.min(L,1))})}let Me=null,Pe=null,Ge=null;if(Ue.id==="temporal"){const L=await ca(),J=new Set(ke.map(de=>Ne(de))),pe=L.reduce((de,je)=>{const ne=ea(je.itemType,je.itemId,je.checkType,je.direction);return J.has(ne)&&(de[ne]||(de[ne]=[]),de[ne].push(je)),de},{});Me={},Pe=new Set,Ge={};const fe=Date.now();ke.forEach(de=>{const je=Ne(de),ne=pe[je]??[];if(ne.length===0){Me[je]=0,Pe.add(je),Ge[je]=[];return}const Se=as(ne);Ge[je]=Se;const ze=vn(Se,fe);Me[je]=ze.knowness})}const f=Ue.id==="levels"?ss(ke,st,ft,Re):Ue.id==="temporal"?ns(ke,st,ft,Me??{},Pe??new Set,Ge??{}):Ue.prepare(ke,st,ft);D(f.queue),bt(f.meta),Q(0),N("ready"),M(L=>({current:Math.min(L.current,L.total),total:L.total}))}catch{z&&N("error")}})(),()=>{z=!1}},[i,kt,st,Ue,ft,d]),a.useEffect(()=>{ta(b)},[b,Ct,jt,At,m==null?void 0:m.collectionId]),a.useEffect(()=>{if(!me||!jt){Lt(!1);return}if(me.cardType!=="info"||Et.has(Ne(me))){Lt(!1);return}const z=Ta(T+1);if(z>=0){Lt(!1),Q(z);return}if(Ue.id==="temporal"||Ue.id==="levels"){const ce=b.slice(0,T+1),we=b.slice(T+1).filter(ut),Fe=ce.concat(we),_e=new Set(Fe.map(Ne)),ke=_t(_e);if(ke){const Me=Ne(ke);_e.has(Me)||(Fe.push(ke),_e.add(Me),bt(Pe=>{const Ge=Pe,f=new Set(Ge.queued??[]);return f.add(Me),{...Ge,queued:f}}))}const Re=Fe.findIndex((Me,Pe)=>Pe!==T&&ut(Me));if(Re>=0){D(Fe),Q(Re),Lt(!1);return}}Lt(!0)},[me,Et,jt,T,b,Je,Ue.id]),a.useEffect(()=>{if(ye(""),R(null),te(null),U(0),se([]),Ae({}),$e({}),ct(null),We(null),Ve(null),C(!1),Ke(!1),F(null),tt(null),Ye({}),!me){Z(null),ae(null);return}me.cardType==="info"&&me.infoType==="computed"&&Z(t.cogita.library.revision.loadingComputed);let z=!0;return zt(me,T).then(ce=>{!z||!ce||(Z(ce.prompt),ae(ce.expectedAnswer),se(ce.computedExpected),Ae(ce.computedAnswers),ct(ce.answerTemplate),We(ce.outputVariables),Ve(ce.variableValues))}),()=>{z=!1}},[me,i,t]),a.useEffect(()=>{if(!me||me.cardType!=="info"||me.infoType!=="citation"){mt.current=null,pt.current=new Set,ve(null);return}const z=me.description??"",ce=(me.label??"").trim(),we=ce.replace(/\s+/g," ").trim(),Fe=z.replace(/\s+/g," ").trim(),_e=we&&we!==Fe?ce:t.cogita.library.infoTypes.citation;if(!z){ve(null),ae(null);return}const ke=va(z);mt.current=ke,Z(_e);let Re=!0;return ca().then(Me=>{if(!Re)return;const Pe=new Map;Me.forEach(pe=>{if(pe.itemType!=="info"||pe.checkType!=="quote-fragment"||!pe.direction)return;const fe=Wt(pe.direction);if(!fe)return;const de=`${pe.itemId}:${fe.fragmentId}`;Pe.has(de)||Pe.set(de,[]),Pe.get(de).push(pe)});const Ge={},f=new Set;Pe.forEach((pe,fe)=>{const[de,je]=fe.split(":",2);if(de!==me.cardId)return;const ne=la(pe).score;Ge[je]=ne,ne>=At&&f.add(je)}),pt.current=f,wt.current=Ge;const L=Wt(me.direction);if(L!=null&&L.fragmentId&&ke.nodes[L.fragmentId]){sa(ke,L.fragmentId,_e);return}const J=$a(ke,f,Ge,At,jt,me.direction);sa(ke,(J==null?void 0:J.id)??null,_e)}).catch(()=>{pt.current=new Set,wt.current={};const Me=Wt(me.direction);if(Me!=null&&Me.fragmentId&&ke.nodes[Me.fragmentId]){sa(ke,Me.fragmentId,_e);return}const Pe=$a(ke,pt.current,{},At,jt,me.direction);sa(ke,(Pe==null?void 0:Pe.id)??null,_e)}),()=>{Re=!1}},[me,t,jt,At]),a.useEffect(()=>{if(!me||me.cardType!=="vocab"||me.checkType!=="translation-match"){tt(null),Ye({});return}const we=(Je.pool??Je.active??b).filter(Me=>Me.cardType==="vocab"&&Me.checkType==="translation-match").filter((Me,Pe,Ge)=>Ge.findIndex(f=>f.cardId===Me.cardId)===Pe);we.some(Me=>Me.cardId===me.cardId)||we.unshift(me);const _e=ha(we).slice(0,6).map(Me=>{const Pe=Me.label.split("↔").map(L=>L.trim()).filter(Boolean);if(Pe.length<2)return null;const Ge=`${Me.cardId}:L`,f=`${Me.cardId}:R`;return{cardId:Me.cardId,leftId:Ge,rightId:f,leftLabel:Pe[0],rightLabel:Pe[1]}}).filter(Boolean),ke=_e.map(Me=>Me.leftId),Re=ha(_e.map(Me=>Me.rightId));tt({pairs:_e,leftOrder:ke,rightOrder:Re,selection:{},activeLeft:null,activeRight:null,locked:{}})},[me,b,Je]),a.useEffect(()=>()=>{K.current&&window.clearTimeout(K.current),$.current&&window.clearTimeout($.current)},[]);const Ca=a.useRef(null);a.useEffect(()=>{if(!me)return;const z=Ne(me),ce=typeof document<"u"?document.activeElement:null;if(Ca.current===z&&ce&&(ce.tagName==="INPUT"||ce.tagName==="TEXTAREA"))return;let we=0;const Fe=()=>{if(me){if(me.cardType==="info"&&me.infoType==="computed"){if(le.length>0){const ke=hn(et,le,Ce),Re=ke?Le.current[ke]:null;if(Re&&(Re.focus(),document.activeElement===Re)){Ca.current=z;return}}if(ie.current&&(ie.current.focus(),document.activeElement===ie.current)){Ca.current=z;return}}else if(me.cardType==="vocab"&&ie.current&&(ie.current.focus(),document.activeElement===ie.current)){Ca.current=z;return}we<6&&(we+=1,window.setTimeout(Fe,40))}},_e=window.setTimeout(Fe,40);return()=>window.clearTimeout(_e)},[me,le,et,Ce]),a.useEffect(()=>{if(!qe)return;const z=ce=>{ce.key==="Enter"&&(ce.preventDefault(),Ut())};return window.addEventListener("keydown",z),()=>window.removeEventListener("keydown",z)},[qe]);const Ia=z=>{he(z),ue(la(z))};a.useEffect(()=>{if(!me){ue(null),he([]);return}const z=me.cardType==="info"?"info":"connection";if(me.cardType==="info"&&me.infoType==="citation"){ca().then(ce=>{const we=ce.filter(Fe=>Fe.itemType==="info"&&Fe.itemId===me.cardId&&Fe.checkType==="quote-fragment"&&dn(Fe.direction,me.direction));Ia(we)}).catch(()=>{ue(null),he([])});return}cn(z,me.cardId,me.checkType,me.direction).then(ce=>Ia(ce)).catch(()=>{ue(null),he([])})},[me]);const Pa=(z,ce,we,Fe)=>{if(z==="info"&&we==="quote-fragment"){ca().then(_e=>{const ke=_e.filter(Re=>Re.itemType==="info"&&Re.itemId===ce&&Re.checkType==="quote-fragment"&&dn(Re.direction,Fe));Ia(ke)}).catch(()=>{ue(null),he([])});return}cn(z,ce,we,Fe).then(_e=>Ia(_e)).catch(()=>{ue(null),he([])})},Qa=(z,ce,we)=>{var Re;const Fe=((Re=we.pairs.find(Me=>Me.leftId===z))==null?void 0:Re.rightId)??null;if(!Fe)return we;const _e=Fe===ce;Ye(Me=>({...Me,[z]:_e?"correct":"incorrect"})),K.current&&window.clearTimeout(K.current),$.current&&window.clearTimeout($.current),Ie.current+=1;const ke={kind:_e?"correct":"incorrect",tick:Ie.current};if(Xe(null),K.current=window.setTimeout(()=>Xe(ke),0),$.current=window.setTimeout(()=>Xe(null),420),_e){const Me={...we.locked,[z]:!0};return Object.keys(Me).length>=we.pairs.length?(R("correct"),Ke(!0)):R("correct"),{...we,selection:{...we.selection,[z]:ce},activeLeft:null,activeRight:null,locked:Me}}return R("incorrect"),{...we,activeLeft:null,activeRight:null}},Ea=z=>{tt(ce=>!ce||ce.locked[z]?ce:ce.activeRight?Qa(z,ce.activeRight,ce):{...ce,activeLeft:ce.activeLeft===z?null:z})},kn=z=>{tt(ce=>ce&&(ce.activeLeft?Qa(ce.activeLeft,z,ce):{...ce,activeRight:ce.activeRight===z?null:z}))},Ut=()=>{var z;if(me&&me.cardType==="info"&&me.infoType==="citation"&&mt.current&&Y&&!((z=Wt(me.direction))!=null&&z.fragmentId)){const ce=$a(mt.current,pt.current,wt.current,At,jt,me.direction,Y.fragmentId);if(ce){R(null),ye(""),C(!1),$e({}),Ke(!1),te(null),U(0),sa(mt.current,ce.id,Y.title);return}}R(null),ye(""),C(!1),$e({}),Ke(!1),te(null),U(0),Q(ce=>Math.min(ce+1,b.length))},Jt=z=>{if(!me)return;const ce=z.expected??null,we=z.answer??"";let Fe=ce??"",_e=we;if(!ce&&z.expectedMap&&z.answerMap){const L=Object.keys(z.expectedMap).sort((J,pe)=>J.localeCompare(pe));Fe=L.map(J=>{var pe;return((pe=z.expectedMap)==null?void 0:pe[J])??""}).join("|"),_e=L.map(J=>{var pe;return((pe=z.answerMap)==null?void 0:pe[J])??""}).join("|")}const ke=Fe?Ra(Fe,_e,It):new Uint8Array,Re={revisionType:Ue.id,evalType:z.evalType,direction:z.direction,prompt:I??"",expected:ce,answer:we,expectedAnswers:z.expectedMap??null,answers:z.answerMap??null,correct:z.correct,maskBase64:ke.length?ya(ke):null,checkMode:Kt,compareMode:It,minCorrectness:Mt},Me=new TextEncoder().encode(JSON.stringify(Re)),Pe=me.cardType==="info"?"info":"connection",Ge=z.overrideCheckType??me.checkType??null,f=z.overrideDirection??me.direction??null;ln({itemType:Pe,itemId:me.cardId,checkType:Ge,direction:f,revisionType:Ue.id,evalType:z.evalType,correct:z.correct,maskBase64:ke.length?ya(ke):null,payloadBase64:ya(Me)}).then(()=>{Pa(Pe,me.cardId,Ge,f),ta(b)}).catch(()=>{})},Nn=(z,ce)=>{const we=Xt.current.get(ce);if(we)return Promise.resolve(we);const Fe=qt.current.get(ce);if(Fe)return Fe;const _e=Or({shareCode:i,infoId:z,key:kt}).then(ke=>{var L,J;const Re=ke.payload,Me=((L=Re.definition)==null?void 0:L.graph)??null,Pe="",Ge=((J=Re.definition)==null?void 0:J.answerTemplate)??"",f=sr(Me,Pe,Ge);if(f){const fe={sample:rr(f),answerTemplate:Ge||null};return Xt.current.set(ce,fe),fe}return ds({shareId:i,infoId:z,key:kt}).then(pe=>{const fe={sample:pe,answerTemplate:null};return Xt.current.set(ce,fe),fe})}).catch(()=>ds({shareId:i,infoId:z,key:kt}).then(ke=>{const Re={sample:ke,answerTemplate:null};return Xt.current.set(ce,Re),Re}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{qt.current.delete(ce)});return qt.current.set(ce,_e),_e},zt=(z,ce)=>{var Me;const we=`${Ne(z)}:${ce}`,Fe=O.current.get(we);if(Fe)return Promise.resolve(Fe);const _e=u.current.get(we);if(_e)return _e;const ke=Pe=>(O.current.set(we,Pe),Pe);let Re;if(z.cardType==="vocab"){if(z.checkType==="translation-match")return Re=Promise.resolve(ke({prompt:z.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),Re;const Pe=z.label.split("↔").map(Ge=>Ge.trim()).filter(Boolean);if(Pe.length>=2){const f=(z.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",L=f?Pe[0]:Pe[1],J=f?Pe[1]:Pe[0];Re=Promise.resolve(ke({prompt:L,expectedAnswer:J,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else Re=Promise.resolve(ke({prompt:z.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(z.cardType==="info"&&z.infoType==="word"){const Pe=(Me=z.description)!=null&&Me.startsWith("Language: ")?z.description.replace("Language: ",""):null;Re=Promise.resolve(ke({prompt:z.label,expectedAnswer:Pe,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else z.cardType==="info"&&z.infoType==="computed"?Re=Nn(z.cardId,we).then(Pe=>{var pe,fe;if(!Pe.sample)return ke({prompt:z.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const Ge=Pe.sample,f=Ge.expectedAnswers?Object.entries(Ge.expectedAnswers).map(([de,je])=>({key:de,expected:je})):[],L=f.reduce((de,je)=>(de[je.key]="",de),{}),J=Ge.expectedAnswerIsSentence&&((pe=Ge.expectedAnswer)==null?void 0:pe.trim())||null;return ke({prompt:Ge.prompt,expectedAnswer:f.length>0?J:((fe=Ge.expectedAnswer)==null?void 0:fe.trim())||null,computedExpected:f,computedAnswers:L,answerTemplate:Pe.answerTemplate,outputVariables:Ge.outputVariables??null,variableValues:Ge.variableValues??null})}).catch(()=>ke({prompt:z.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{u.current.delete(we)}):Re=Promise.resolve(ke({prompt:z.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return u.current.set(we,Re),Re},sa=(z,ce,we)=>{const Fe=Object.keys(z.nodes).length,_e=pt.current.size;if(!ce){ve({title:we,before:z.text,after:"",fragmentId:null,total:Fe,completed:_e}),ae(null),Ke(!0);return}const ke=z.nodes[ce];if(!ke)return;const Re=xn(z.text,ke);ve({title:we,before:Re.before,after:Re.after,fragmentId:ke.id,total:Fe,completed:_e}),ae(Re.fragment),Ke(!1)},Ma=()=>{const z=mt.current;z&&ve(ce=>ce&&{...ce,total:Object.keys(z.nodes).length,completed:pt.current.size})},wa=()=>{const z=b[T+1];z&&zt(z,T+1)},Fa=()=>{if(wa(),me&&me.cardType==="vocab"&&me.checkType==="translation-match"&&De){if(De.pairs.length===0){R("incorrect"),Ke(!0);return}const ke=De.pairs.reduce((J,pe)=>(J[pe.rightId]=pe.rightLabel,J),{});let Re=0;const Me={};De.pairs.forEach(J=>{const fe=De.selection[J.leftId]===J.rightId;Me[J.leftId]=fe?"correct":"incorrect",fe&&(Re+=1)});const Pe=De.pairs.length||1,Ge=Re/Pe,f=Re===De.pairs.length;Ye(J=>({...J,...Me})),f?(R("correct"),Ke(!0),U(0)):(R("incorrect"),Ke(!1),U(J=>{const pe=J+1;return pe>=lt&&(C(!0),Ke(!0),tt(fe=>{if(!fe)return fe;const de=fe.pairs.reduce((je,ne)=>(je[ne.leftId]=ne.rightId,je),{});return{...fe,selection:de}})),pe})),Gt(f,Ge);const L="connection";Promise.all(De.pairs.map(J=>{const pe=De.selection[J.leftId]??null,fe=pe?ke[pe]:"",de={left:J.leftLabel,expected:J.rightLabel,answer:fe,checkType:"translation-match"},je=new TextEncoder().encode(JSON.stringify(de));return ln({itemType:L,itemId:J.cardId,checkType:"translation-match",direction:null,revisionType:Ue.id,evalType:"translation-match",correct:pe===J.rightId,maskBase64:null,payloadBase64:ya(je)})})).then(()=>{Pa(L,me.cardId,me.checkType,me.direction),ta(b)}).catch(()=>{});return}if(le.length>0){const ke=le.reduce((Me,Pe)=>{const Ge=Te[Pe.key]??"";return Me[Pe.key]=Dt(Ge)===Dt(Pe.expected)?"correct":"incorrect",Me},{});le.every(({key:Me,expected:Pe})=>{const Ge=Te[Me]??"";return Kt==="exact"&&Dt(Ge)===Dt(Pe)})?(R("correct"),$e(ke),Ke(!0),U(0),Gt(!0,1),Jt({correct:!0,direction:I?`${I} -> computed`:"computed",expectedMap:le.reduce((Me,Pe)=>(Me[Pe.key]=Pe.expected,Me),{}),answerMap:Te,evalType:"computed"})):(R("incorrect"),$e(ke),Ke(!1),U(Me=>{const Pe=Me+1;return Pe>=lt&&ga&&(C(!0),Ke(!0)),Pe}),Gt(!1,0),window.setTimeout(()=>{var Pe;const Me=hn(et,le,Ce);Me&&Le.current[Me]&&((Pe=Le.current[Me])==null||Pe.focus())},40),Jt({correct:!1,direction:I?`${I} -> computed`:"computed",expectedMap:le.reduce((Me,Pe)=>(Me[Pe.key]=Pe.expected,Me),{}),answerMap:Te,evalType:"computed"}));return}if(me&&me.cardType==="info"&&me.infoType==="citation"&&(Y!=null&&Y.fragmentId)){if(!_)return;const ke=Wt(me.direction),Re=(ke==null?void 0:ke.fragmentId)??Y.fragmentId,Me=Sa(_,ge,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Pe=Me.mask,Ge=Me.isCorrect,f=Me.percent;Ge?(wt.current[Y.fragmentId]=Math.max(wt.current[Y.fragmentId]??0,f),(wt.current[Y.fragmentId]??0)>=At&&pt.current.add(Y.fragmentId),Ma(),R("correct"),$e({}),Ke(!0),te(Pe),U(0),f<100&&lt<=1&&C(!0),Gt(!0,f/100),Jt({correct:!0,direction:`quote:${Y.fragmentId}`,expected:_,answer:ge,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Re})):(R("incorrect"),$e({}),Ke(!1),te(Pe),U(L=>{const J=L+1;return J>=lt&&ga&&(C(!0),Ke(!0)),J}),Gt(!1,f/100),window.setTimeout(()=>{var L;return(L=ie.current)==null?void 0:L.focus()},40),Jt({correct:!1,direction:`quote:${Y.fragmentId}`,expected:_,answer:ge,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Re}));return}if(!_)return;const z=Ra(_,ge,It),ce=Kt==="exact"&&Dt(ge)===Dt(_),we=ma(z),Fe=ce||we,_e=xa(z);Fe?(R("correct"),$e({}),Ke(!0),te(z),U(0),_e<100&&lt<=1&&C(!0),Gt(!0,_e/100),Jt({correct:!0,direction:I?`${I} -> ${_}`:null,expected:_,answer:ge,evalType:"text"})):(R("incorrect"),$e({}),Ke(!1),te(z),U(ke=>{const Re=ke+1;return Re>=lt&&ga&&(C(!0),Ke(!0)),Re}),Gt(!1,_e/100),window.setTimeout(()=>{var ke;return(ke=ie.current)==null?void 0:ke.focus()},40),Jt({correct:!1,direction:I?`${I} -> ${_}`:null,expected:_,answer:ge,evalType:"text"}))},Sn=z=>{if(wa(),!_)return;const ce=Ra(_,z,It),we=Dt(z)===Dt(_),Fe=ma(ce),_e=we||Fe,ke=xa(ce);_e?(R("correct"),$e({}),Ke(!0),te(ce),U(0),ke<100&&lt<=1&&C(!0),Gt(!0,ke/100),Jt({correct:!0,direction:"word->language",expected:_,answer:z,evalType:"language-select"})):(R("incorrect"),$e({}),Ke(!1),te(ce),U(Re=>{const Me=Re+1;return Me>=lt&&ga&&(C(!0),Ke(!0)),Me}),Gt(!1,ke/100),Jt({correct:!1,direction:"word->language",expected:_,answer:z,evalType:"language-select"}))},Tn=z=>{var we;if(z.key!=="Enter")return;if(z.preventDefault(),z.stopPropagation(),qe){Ut();return}const ce=le.find(Fe=>!(Te[Fe.key]??"").trim());if(ce){(we=Le.current[ce.key])==null||we.focus();return}Fa()},La=()=>{wa(),R("correct"),Ke(!0),U(0),Gt(!0,1),_&&Jt({correct:!0,direction:"manual",expected:_,answer:ge,evalType:"manual"})},aa=()=>{if(Gt(!1,0),me&&me.cardType==="info"&&me.infoType==="citation"){R(null),ye(""),C(!1),$e({}),Ke(!1),te(null),U(0),Q(z=>Math.min(z+1,b.length));return}Ut()};a.useEffect(()=>{wa()},[T,b]);const Cn=t.cogita.library.revision.revealModeAfterIncorrect,ga=le.length>0||!!_;return e.jsxs(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:j,language:p,onLanguageChange:w,children:[(d==="loading"||W==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:d==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${P.total?Math.min(100,Math.max(0,P.current/P.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:P.total?`${Math.min(P.current,P.total)} / ${P.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:g}),e.jsx("p",{className:"cogita-library-subtitle",children:V}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",Qt).replace("{check}",Vt)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:A?`${A.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Zt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Zt.currentLevel??"-"," / ",Zt.levelsCount]}):null,A?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(A.correct)).replace("{total}",String(A.total))}),A.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(A.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(ir,{outcomes:be})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[ee?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:ee})}):null,e.jsx(es,{feedbackToken:Be?`${Be.kind}-${Be.tick}`:$t?"idle":Oe??"idle",children:d!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:d==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):me?e.jsx(e.Fragment,{children:ua?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(ts,{copy:t,currentCard:me,currentTypeLabel:oe,prompt:I,languages:q,answer:ge,onAnswerChange:z=>ye(ce=>un(ce,z,B)),computedExpected:le,computedAnswers:Te,onComputedAnswerChange:(z,ce)=>Ae(we=>({...we,[z]:un(we[z]??"",ce,B)})),answerTemplate:et,outputVariables:Ce,variableValues:xt,computedFieldFeedback:Ee,feedback:Oe,canAdvance:qe,quoteContext:Y,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Fa,onSkip:aa,onLanguageSelect:Sn,onMarkReviewed:La,onAdvance:Ut,showCorrectAnswer:k,setShowCorrectAnswer:C,onRevealCorrect:()=>Ke(!0),answerMask:G,expectedAnswer:_,hasExpectedAnswer:ga,handleComputedKeyDown:Tn,answerInputRef:ie,computedInputRefs:Le,scriptMode:B,setScriptMode:F,matchPairs:De==null?void 0:De.pairs,matchLeftOrder:De==null?void 0:De.leftOrder,matchRightOrder:De==null?void 0:De.rightOrder,matchSelection:De==null?void 0:De.selection,matchActiveLeft:De==null?void 0:De.activeLeft,matchActiveRight:De==null?void 0:De.activeRight,matchFeedback:ot,onMatchLeftSelect:Ea,onMatchRightSelect:kn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Qe?`${rt} / ${Qe}`:t.cogita.library.revision.progressUnlimited}),d==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),d==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),d==="ready"&&W==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),d==="ready"&&W==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),d==="ready"&&W==="ready"&&b.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Cn}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",lt]})]})]}),Zt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Zt.activeCount," / ",Zt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Zt.counts.map((z,ce)=>{const we=ce+1,Fe=Zt.currentLevel===we,_e=Zt.percentages[ce]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":Fe,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:we}),e.jsx("strong",{children:z})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,_e))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[_e.toFixed(1),"%"]})]},`level-${we}`)})})]}):null,ja?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:ja.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:ja.dots.map(z=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-z.value))}, ${Math.round(200*z.value)}, 80, 0.9)`}},z.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:ja.knownCount})]})]}):null,jt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Wa})]})}):null]})]})]})})})]})]})}const Ao=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:xo},Symbol.toStringTag,{value:"Module"})),oa=t=>String(t??"").trim().toLocaleLowerCase(),gn=t=>Array.from(new Set(t.map(n=>Number(n)).filter(Number.isFinite))).sort((n,r)=>n-r),Ds=t=>t.map(n=>n.join(",")).sort().join("|");function vo(t){const n=t.split("↔").map(r=>r.trim()).filter(Boolean);return n.length>=2?[n[0],n[1]]:null}function jo(t){if(!t)return null;const n=t.indexOf(":");return n>=0?t.slice(n+1).trim():t.trim()}function wo(t,n,r,s){const o=typeof r.type=="string"?r.type:"",h=typeof r.title=="string"&&r.title.trim()?r.title.trim():n,c=typeof r.question=="string"?r.question:n;if(!o||!c)return null;if(o==="selection"){const j=Array.isArray(r.options)?r.options.filter(w=>typeof w=="string"):[],p=Array.isArray(r.answer)?gn(r.answer):[];return{roundIndex:s,cardKey:`info:${t}:question-selection`,publicPrompt:{kind:"selection",title:h,prompt:c,options:j,multiple:!0,cardLabel:"question"},reveal:{kind:"selection",expected:p,title:h},grade:w=>{const i=Array.isArray(w)?gn(w):[];return JSON.stringify(i)===JSON.stringify(p)}}}if(o==="truefalse"){const j=!!r.answer;return{roundIndex:s,cardKey:`info:${t}:question-truefalse`,publicPrompt:{kind:"boolean",title:h,prompt:c,cardLabel:"question"},reveal:{kind:"boolean",expected:j,title:h},grade:p=>!!p===j}}if(o==="text"||o==="number"||o==="date"){const j=String(r.answer??"");return{roundIndex:s,cardKey:`info:${t}:question-${o}`,publicPrompt:{kind:"text",title:h,prompt:c,inputType:o==="number"?"number":o==="date"?"date":"text",cardLabel:"question"},reveal:{kind:"text",expected:j,title:h},grade:p=>{if(o==="number"){const w=Number(p),i=Number(j);return Number.isFinite(w)&&Number.isFinite(i)&&Math.abs(w-i)<1e-9}return oa(p)===oa(j)}}}if(o==="ordering"){const j=Array.isArray(r.options)?r.options.filter(p=>typeof p=="string"):[];return{roundIndex:s,cardKey:`info:${t}:question-ordering`,publicPrompt:{kind:"ordering",title:h,prompt:c,options:j,cardLabel:"question"},reveal:{kind:"ordering",expected:j,title:h},grade:p=>JSON.stringify(Array.isArray(p)?p.map(String):[])===JSON.stringify(j)}}if(o==="matching"){const j=Array.isArray(r.columns)?r.columns.map(i=>Array.isArray(i)?i.filter(m=>typeof m=="string"):[]):[],p=r.answer??{},w=Array.isArray(p.paths)?p.paths.map(i=>Array.isArray(i)?i.map(m=>Number(m)).filter(Number.isFinite):null).filter(i=>Array.isArray(i)):[];return{roundIndex:s,cardKey:`info:${t}:question-matching`,publicPrompt:{kind:"matching",title:h,prompt:c,columns:j,cardLabel:"question"},reveal:{kind:"matching",expected:{paths:w},title:h},grade:i=>{const m=i??{},l=Array.isArray(m.paths)?m.paths.map(d=>Array.isArray(d)?d.map(v=>Number(v)).filter(Number.isFinite):null).filter(d=>Array.isArray(d)):[];return Ds(l)===Ds(w)}}}return null}async function ko(t){const n=await Zn({libraryId:t.libraryId,revisionId:t.revisionId}),s=(await qa({libraryId:t.libraryId,collectionId:n.collectionId,limit:1e3})).items,o=Array.from(new Set(s.filter(i=>i.cardType==="info").map(i=>i.cardId))),h=new Map;await Promise.all(o.map(async i=>{try{const m=await na({libraryId:t.libraryId,infoId:i});h.set(i,{infoType:m.infoType,payload:m.payload})}catch{}}));const c=new Map;await Promise.all(Array.from(h.entries()).filter(([,i])=>i.infoType==="computed").map(async([i])=>{try{const m=await Un({libraryId:t.libraryId,infoId:i});c.set(i,m)}catch{}}));const j=Array.from(new Set(s.filter(i=>i.cardType==="vocab").map(i=>i.label))).filter(Boolean),p=[],w=new Set;for(const i of s){if(i.cardType==="vocab"){const l=vo(i.label);if(!l)continue;if(i.checkType==="translation"&&i.direction==="a-to-b"){const[d,v]=l;p.push({roundIndex:p.length,cardKey:`connection:${i.cardId}:translation:a-to-b`,publicPrompt:{kind:"text",title:i.label,prompt:d,cardLabel:i.description??void 0},reveal:{kind:"text",expected:v,title:i.label},grade:g=>oa(g)===oa(v)})}else if(i.checkType==="translation"&&i.direction==="b-to-a"){const[d,v]=l;p.push({roundIndex:p.length,cardKey:`connection:${i.cardId}:translation:b-to-a`,publicPrompt:{kind:"text",title:i.label,prompt:v,cardLabel:i.description??void 0},reveal:{kind:"text",expected:d,title:i.label},grade:g=>oa(g)===oa(d)})}else if(i.checkType==="translation-match"){const d=Array.from(new Set([i.label,...j.filter(g=>g!==i.label).slice(0,3)])),v=d.findIndex(g=>g===i.label);p.push({roundIndex:p.length,cardKey:`connection:${i.cardId}:translation-match`,publicPrompt:{kind:"selection",title:i.label,prompt:"Select the matching pair",options:d,multiple:!1,cardLabel:i.description??void 0},reveal:{kind:"selection",expected:[v],title:i.label},grade:g=>{const S=Array.isArray(g)?gn(g):gn([g]);return S.length===1&&S[0]===v}})}continue}if(i.cardType!=="info")continue;const m=h.get(i.cardId);if(m){if(m.infoType==="word"&&i.checkType==="word-language"){const l=jo(i.description);if(!l)continue;p.push({roundIndex:p.length,cardKey:`info:${i.cardId}:word-language:${i.direction??""}`,publicPrompt:{kind:"text",title:i.label,prompt:`Language of: ${i.label}`,cardLabel:"word-language"},reveal:{kind:"text",expected:l,title:i.label},grade:d=>oa(d)===oa(l)});continue}if(m.infoType==="computed"&&i.checkType==="computed"){const l=c.get(i.cardId);if(!l)continue;p.push({roundIndex:p.length,cardKey:`info:${i.cardId}:computed`,publicPrompt:{kind:"text",title:i.label,prompt:l.prompt,multiLine:!1,cardLabel:"computed"},reveal:{kind:"text",expected:l.expectedAnswer,title:i.label},grade:d=>oa(d)===oa(l.expectedAnswer)});continue}if(m.infoType==="question"){const l=m.payload,d=l.definition??l,v=wo(i.cardId,i.label,d,p.length);v&&(v.roundIndex=p.length,p.push(v));continue}if(m.infoType==="citation"&&!w.has(i.cardId)){w.add(i.cardId);const l=m.payload,d=typeof l.text=="string"?l.text:"",v=typeof l.title=="string"&&l.title.trim()?l.title.trim():i.label;if(!d.trim())continue;const g=va(d,{minLen:7,maxLen:13});for(const S of g.order){const V=g.nodes[S];if(!V)continue;const x=xn(d,V);p.push({roundIndex:p.length,cardKey:`info:${i.cardId}:quote-fragment:${S}`,publicPrompt:{kind:"citation-fragment",title:v,before:x.before,after:x.after,fragmentId:S,cardLabel:"quote-fragment"},reveal:{kind:"citation-fragment",expected:x.fragment,title:v},grade:b=>Sa(x.fragment,String(b??""),{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}).isCorrect})}continue}}}return p.map((i,m)=>({...i,roundIndex:m}))}function No(t){const{libraryId:n,revisionId:r}=t,[s,o]=a.useState(null),[h,c]=a.useState([]),[j,p]=a.useState("loading"),[w,i]=a.useState(null),m=`cogita.live.host.${n}.${r}`,l=s?h[s.currentRoundIndex]??null:null,d=s!=null&&s.status&&s.status!=="lobby"?s.currentPrompt??null:null,v=(s==null?void 0:s.currentReveal)??null,g=a.useMemo(()=>s!=null&&s.code&&typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision/${encodeURIComponent(s.code)}`:"",[s==null?void 0:s.code]),S=(s==null?void 0:s.status)==="finished"?"finished":s!=null&&s.status&&s.status!=="lobby"?"active":"lobby",V=(P,M,T)=>({...P,hostSecret:P.hostSecret||(M==null?void 0:M.hostSecret)||(T==null?void 0:T.hostSecret)||"",code:P.code||(M==null?void 0:M.code)||(T==null?void 0:T.code)||""});a.useEffect(()=>{let P=!1;return ko({libraryId:n,revisionId:r}).then(M=>{P||c(M)}).catch(()=>{P||(i("Failed to load revision cards for live session."),p("error"))}),()=>{P=!0}},[n,r]),a.useEffect(()=>{let P=!1;async function M(){try{typeof localStorage<"u"&&localStorage.removeItem(m);const T=await qr({libraryId:n,revisionId:r,title:"Live revision"});if(P)return;o(T),localStorage.setItem(m,JSON.stringify({sessionId:T.sessionId,hostSecret:T.hostSecret,code:T.code})),p("ready")}catch{if(P)return;i("Failed to create live session."),p("error")}}return M(),()=>{P=!0}},[n,r,m]),a.useEffect(()=>{if(!s)return;const P=window.setInterval(async()=>{try{const M=await Vr({libraryId:n,sessionId:s.sessionId,hostSecret:s.hostSecret});o(T=>V(M,T))}catch{}},1200);return()=>window.clearInterval(P)},[n,s]);const x=async P=>{if(!s)return;const M=await Jr({libraryId:n,sessionId:s.sessionId,hostSecret:s.hostSecret,status:P.status??s.status,currentRoundIndex:P.currentRoundIndex??s.currentRoundIndex,revealVersion:P.revealVersion??s.revealVersion,currentPrompt:P.currentPrompt??s.currentPrompt??null,currentReveal:P.currentReveal??s.currentReveal??null});o(T=>V(M,T))},b=async P=>{const M=h[P];!M||!s||await x({status:"running",currentRoundIndex:P,revealVersion:s.revealVersion+1,currentReveal:null,currentPrompt:{...M.publicPrompt,roundIndex:P,cardKey:M.cardKey}})},D=async()=>{h.length&&await b((s==null?void 0:s.currentRoundIndex)??0)},q=async()=>{if(!s||!l)return;const P=new Map(s.currentRoundAnswers.map(Q=>[Q.participantId,Q.answer])),M=s.participants.map(Q=>{const ge=P.get(Q.participantId),ye=l.grade(ge);return{participantId:Q.participantId,isCorrect:ye,pointsAwarded:ye?1:0}}),T=await Ur({libraryId:n,sessionId:s.sessionId,hostSecret:s.hostSecret,scores:M});o(Q=>V(T,Q)),await x({status:"revealed",revealVersion:T.revealVersion+1,currentReveal:l.reveal})},y=async()=>{if(!s)return;const P=s.currentRoundIndex+1;if(P>=h.length){await x({status:"finished",currentReveal:null});return}await b(P)},W=async()=>{if(s){if(s.status==="running"){await q();return}if(s.status==="revealed"){await y();return}s.status==="lobby"&&await D()}},N=(P,M)=>{if(!P)return e.jsx("p",{className:"cogita-help",children:"Waiting for host to publish a question."});const T=String(P.kind??""),Q=typeof M<"u",ge=Array.isArray(M)?M.map(ye=>Number(ye)).filter(Number.isFinite):[];if(T==="citation-fragment")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":Q?"correct":"idle",children:[e.jsxs("p",{children:[e.jsx("span",{style:{opacity:.7},children:String(P.before??"")}),e.jsx("strong",{children:" [ ... ] "}),e.jsx("span",{style:{opacity:.7},children:String(P.after??"")})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:Q?"Correct fragment":"Fragment"}),e.jsx("input",{readOnly:!0,value:Q?String(M??""):"",placeholder:"Participant answer here"})]})]});if(T==="text")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":Q?"correct":"idle",children:[e.jsx("p",{children:String(P.prompt??"")}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:Q?"Correct answer":"Answer"}),e.jsx("input",{readOnly:!0,value:Q?String(M??""):"",placeholder:"Participant answer here"})]})]});if(T==="boolean"){const ye=!!M;return e.jsxs("div",{className:"cogita-live-card-surface","data-state":Q?"correct":"idle",children:[e.jsx("p",{children:String(P.prompt??"")}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:`cta ghost ${Q&&ye?"live-correct-answer":""}`,disabled:!0,children:"True"}),e.jsx("button",{type:"button",className:`cta ghost ${Q&&!ye?"live-correct-answer":""}`,disabled:!0,children:"False"})]})]})}if(T==="selection"){const ye=Array.isArray(P.options)?P.options.map(String):[],Oe=!!P.multiple;return e.jsxs("div",{className:"cogita-live-card-surface","data-state":Q?"correct":"idle",children:[e.jsx("p",{children:String(P.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:ye.map((R,I)=>e.jsxs("label",{className:"cogita-share-row","data-state":Q&&ge.includes(I)?"correct":void 0,children:[e.jsx("span",{children:R}),e.jsx("input",{type:Oe?"checkbox":"radio",disabled:!0,checked:Q?ge.includes(I):!1,readOnly:!0})]},`${I}-${R}`))})]})}if(T==="ordering"){const ye=Array.isArray(Q?M:P.options)?(Q?M:P.options).map(String):[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":Q?"correct":"idle",children:[e.jsx("p",{children:String(P.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:ye.map((Oe,R)=>e.jsxs("div",{className:"cogita-share-row","data-state":Q?"correct":void 0,children:[e.jsx("span",{children:Oe}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:!0,children:"↑"}),e.jsx("button",{type:"button",className:"ghost",disabled:!0,children:"↓"})]})]},`${R}-${Oe}`))})]})}if(T==="matching"){const ye=Array.isArray(P.columns)?P.columns:[],Oe=(M==null?void 0:M.paths)??[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":Q?"correct":"idle",children:[e.jsx("p",{children:String(P.prompt??"")}),Q?e.jsx("div",{className:"cogita-share-list",children:Oe.map((R,I)=>e.jsx("div",{className:"cogita-share-row","data-state":"correct",children:e.jsx("span",{children:R.map((Z,_)=>{const ae=Array.isArray(ye[_])?ye[_]:[],Y=String(ae[Z]??Z);return`${_>0?" → ":""}${Y}`})})},`path-${I}`))}):e.jsx("div",{className:"cogita-form-actions",children:ye.map((R,I)=>e.jsx("select",{disabled:!0,children:(Array.isArray(R)?R:[]).map((Z,_)=>e.jsx("option",{children:String(Z)},`${I}-${_}`))},`host-col-${I}`))})]})}return e.jsx("pre",{className:"cogita-json-preview",children:JSON.stringify(P,null,2)})};return e.jsx(Pt,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":S,children:[e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Live Revision Host"}),e.jsx("h2",{className:"cogita-detail-title",children:"Host session"}),j==="loading"?e.jsx("p",{children:"Loading…"}):null,w?e.jsx("p",{className:"cogita-help",children:w}):null,s?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Join code"}),e.jsx("input",{readOnly:!0,value:s.code})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Join URL"}),e.jsx("input",{readOnly:!0,value:g})]}),g?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"QR"}),e.jsx("div",{style:{display:"inline-flex",padding:"0.75rem",borderRadius:"12px",background:"#fff"},children:e.jsx(ur,{value:g,size:176,marginSize:2})})]}):null,e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Status"}),e.jsx("input",{readOnly:!0,value:s.status})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:D,disabled:!h.length,children:"Publish current round"})}),e.jsxs("p",{className:"cogita-help",children:["Rounds: ",h.length]})]}):null]}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Current round"}),e.jsx("h3",{className:"cogita-detail-title",children:d&&typeof d.title=="string"?d.title:(s==null?void 0:s.status)==="lobby"?"Session not started":"Waiting for published round"}),(s==null?void 0:s.status)==="lobby"?e.jsx("p",{className:"cogita-help",children:"No question is shown before the host starts the session."}):N(d,v==null?void 0:v.expected),S!=="lobby"?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:W,disabled:!h.length||!l||s.status==="finished",children:s.status==="revealed"?"Next question":"Check answer"})}):null,S!=="finished"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Participants"}),e.jsxs("div",{className:"cogita-share-list",children:[s==null?void 0:s.participants.map(P=>{const M=s.currentRoundAnswers.find(T=>T.participantId===P.participantId);return e.jsx("div",{className:"cogita-share-row",children:e.jsxs("div",{children:[e.jsx("strong",{children:P.displayName}),e.jsxs("div",{className:"cogita-share-meta",children:[M?"answered":"waiting",(M==null?void 0:M.isCorrect)===!0?" · correct":"",(M==null?void 0:M.isCorrect)===!1?" · incorrect":""]})]})},P.participantId)}),s&&s.participants.length===0?e.jsx("p",{className:"cogita-help",children:"No participants yet."}):null]})]}):null]}),S!=="lobby"?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:S==="finished"?"Final score":"Points"}),e.jsx("div",{className:"cogita-share-list",children:((s==null?void 0:s.scoreboard)??[]).map(P=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:P.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[P.score," pt"]})]},`score:${P.participantId}`))})]}):null]})})})})})}const $o=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionHostPage:No},Symbol.toStringTag,{value:"Module"}));function Bs(t){return`cogita.live.join.${t}`}function So(t){const{code:n}=t,[r,s]=a.useState(""),[o,h]=a.useState(()=>typeof localStorage>"u"?null:localStorage.getItem(Bs(n))),[c,j]=a.useState(null),[p,w]=a.useState("idle"),[i,m]=a.useState(""),[l,d]=a.useState([]),[v,g]=a.useState(null),[S,V]=a.useState([]),[x,b]=a.useState([]),D=(c==null?void 0:c.currentPrompt)??null,q=(c==null?void 0:c.currentReveal)??null,y=q==null?void 0:q.expected,W=(c==null?void 0:c.status)==="finished"?"finished":c!=null&&c.status&&c.status!=="lobby"?"active":"lobby",N=a.useMemo(()=>`${(c==null?void 0:c.currentRoundIndex)??0}:${(c==null?void 0:c.revealVersion)??0}:${String((D==null?void 0:D.cardKey)??"")}`,[D==null?void 0:D.cardKey,c==null?void 0:c.currentRoundIndex,c==null?void 0:c.revealVersion]);a.useEffect(()=>{m(""),d([]),g(null),V(Array.isArray(D==null?void 0:D.options)?[...D.options??[]]:[]),b([])},[N]),a.useEffect(()=>{let R=!0;const I=async()=>{try{const _=await us({code:n,participantToken:o});if(!R)return;j(_),o&&w("ready")}catch{R&&p!=="joining"&&w("error")}};I();const Z=window.setInterval(I,1200);return()=>{R=!1,window.clearInterval(Z)}},[n,o,p]);const P=async()=>{w("joining");try{const R=await Hr({code:n,name:r});h(R.participantToken),localStorage.setItem(Bs(n),R.participantToken),w("ready")}catch{w("error")}},M=R=>{if(!!(D!=null&&D.multiple)){d(Z=>Z.includes(R)?Z.filter(_=>_!==R):[...Z,R].sort((_,ae)=>_-ae));return}d([R])},T=(R,I)=>{V(Z=>{const _=[...Z],ae=R+I;return ae<0||ae>=_.length?Z:([_[R],_[ae]]=[_[ae],_[R]],_)})},Q=()=>{const R=Array.isArray(D==null?void 0:D.columns)?D.columns:[];b(I=>[...I,R.map(()=>0)])},ge=(R,I,Z)=>{b(_=>_.map((ae,Y)=>Y!==R?ae:ae.map((ve,le)=>le===I?Z:ve)))},ye=async()=>{if(!o||!D||typeof D.cardKey!="string")return;let R=null;switch(D.kind){case"selection":R=l;break;case"boolean":R=v;break;case"ordering":R=S;break;case"matching":R={paths:x};break;case"citation-fragment":case"text":default:R=i;break}try{await Wr({code:n,participantToken:o,roundIndex:Number(D.roundIndex??(c==null?void 0:c.currentRoundIndex)??0),cardKey:D.cardKey,answer:R});const I=await us({code:n,participantToken:o});j(I),w("ready")}catch{w("error")}},Oe=()=>{if(!D)return e.jsx("p",{className:"cogita-help",children:"Waiting for host to publish a question."});const R=!!q,I=Array.isArray(y)?y.map(Z=>Number(Z)).filter(Number.isFinite):[];if(D.kind==="citation-fragment")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":R?"correct":"idle",children:[e.jsxs("p",{children:[e.jsx("span",{style:{opacity:.7},children:String(D.before??"")}),e.jsx("strong",{children:" [ ... ] "}),e.jsx("span",{style:{opacity:.7},children:String(D.after??"")})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:R?"Correct fragment":"Fragment"}),e.jsx("input",{value:R?String(y??""):i,onChange:Z=>m(Z.target.value),readOnly:R})]})]});if(D.kind==="text")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":R?"correct":"idle",children:[e.jsx("p",{children:String(D.prompt??"")}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:R?"Correct answer":"Answer"}),e.jsx("input",{type:D.inputType==="number"?"number":D.inputType==="date"?"date":"text",value:R?String(y??""):i,onChange:Z=>m(Z.target.value),readOnly:R})]})]});if(D.kind==="boolean"){const Z=!!y;return e.jsxs("div",{className:"cogita-live-card-surface","data-state":R?"correct":"idle",children:[e.jsx("p",{children:String(D.prompt??"")}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:`cta ghost ${R&&Z?"live-correct-answer":""}`,onClick:()=>g(!0),disabled:R,children:"True"}),e.jsx("button",{type:"button",className:`cta ghost ${R&&!Z?"live-correct-answer":""}`,onClick:()=>g(!1),disabled:R,children:"False"})]})]})}if(D.kind==="selection")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":R?"correct":"idle",children:[e.jsx("p",{children:String(D.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:(Array.isArray(D.options)?D.options:[]).map((Z,_)=>e.jsxs("label",{className:"cogita-share-row","data-state":R&&I.includes(_)?"correct":void 0,children:[e.jsx("span",{children:Z}),e.jsx("input",{type:D.multiple?"checkbox":"radio",name:"live-selection",checked:R?I.includes(_):l.includes(_),onChange:()=>M(_),disabled:R})]},`${_}-${Z}`))})]});if(D.kind==="ordering"){const Z=Array.isArray(R?y:S)?(R?y:S).map(String):[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":R?"correct":"idle",children:[e.jsx("p",{children:String(D.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:Z.map((_,ae)=>e.jsxs("div",{className:"cogita-share-row","data-state":R?"correct":void 0,children:[e.jsx("span",{children:_}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>T(ae,-1),disabled:R,children:"↑"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>T(ae,1),disabled:R,children:"↓"})]})]},`${ae}-${_}`))})]})}if(D.kind==="matching"){const Z=Array.isArray(D.columns)?D.columns:[],_=(y==null?void 0:y.paths)??[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":R?"correct":"idle",children:[e.jsx("p",{children:String(D.prompt??"")}),R?e.jsx("div",{className:"cogita-share-list",children:_.map((ae,Y)=>e.jsx("div",{className:"cogita-share-row","data-state":"correct",children:e.jsx("span",{children:ae.map((ve,le)=>{const se=Array.isArray(Z[le])?Z[le]:[];return`${le>0?" → ":""}${String(se[ve]??ve)}`})})},`path-${Y}`))}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:Q,children:"Add path"})}),x.map((ae,Y)=>e.jsx("div",{className:"cogita-form-actions",children:Z.map((ve,le)=>e.jsx("select",{value:ae[le]??0,onChange:se=>ge(Y,le,Number(se.target.value)),children:ve.map((se,Te)=>e.jsxs("option",{value:Te,children:[Te,": ",se]},`${le}-${Te}`))},`path-${Y}-col-${le}`))},`path-${Y}`))]})]})}return e.jsx("p",{className:"cogita-help",children:"Unsupported prompt type."})};return e.jsx(Pt,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":W,children:[e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Live Revision"}),e.jsx("h2",{className:"cogita-detail-title",children:"Join session"}),o?e.jsx("p",{className:"cogita-help",children:"Joined. Waiting for host."}):e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{value:r,onChange:R=>s(R.target.value)})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:P,disabled:!r.trim()||p==="joining",children:p==="joining"?"Joining…":"Join"})})]}),p==="error"?e.jsx("p",{className:"cogita-help",children:"Connection error or invalid session."}):null,W==="lobby"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Scoreboard"}),e.jsxs("div",{className:"cogita-share-list",children:[c==null?void 0:c.scoreboard.map(R=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:R.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[R.score," pt"]})]},R.participantId)),c&&c.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:"No participants yet."}):null]})]}):null]}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Question"}),e.jsx("h3",{className:"cogita-detail-title",children:typeof(D==null?void 0:D.title)=="string"?D.title:"Waiting for host"}),D?e.jsxs(e.Fragment,{children:[Oe(),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:ye,disabled:!o||!D.cardKey||(c==null?void 0:c.answerSubmitted),children:c!=null&&c.answerSubmitted?"Submitted":"Submit answer"})})]}):e.jsx("p",{className:"cogita-help",children:"Waiting for host to publish a question."})]}),W!=="lobby"?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:W==="finished"?"Final score":"Points"}),e.jsxs("div",{className:"cogita-share-list",children:[c==null?void 0:c.scoreboard.map(R=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:R.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[R.score," pt"]})]},`score:${R.participantId}`)),c&&c.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:"No participants yet."}):null]})]}):null]})})})})})}const Ro=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionJoinPage:So},Symbol.toStringTag,{value:"Module"}));export{Mo as C,Lo as a,Ao as b,$o as c,Ro as d};
