import{r as a,j as e,u as mn,a as Ja,b as Hn,c as Wn,d as Qn,R as pn,B as fn,C as bn,Q as ur}from"./vendor-CAC2WLor.js";import{L as Bs,A as Os,g as Vs,a as hr,b as Va,c as Gn,s as ls,d as Yn,e as gr,f as In,h as na,i as mr,j as pr,k as tn,l as an,m as qs,n as Xn,o as qn,p as fr,u as cs,q as Us,r as br,t as yr,v as xr,w as vr,x as jr,y as Js,z as wr,B as Hs,C as Ws,D as kr,E as Nr,F as yn,G as qa,H as Sr,I as Qs,J as Tr,K as Zn,M as Gs,N as Cr,O as Ir,P as Mr,Q as Un,R as ya,S as Lr,T as Ar,U as $r,V as Rr,W as Pr,X as Er,Y as Fr,Z as Kr,_ as _r,$ as Dr,a0 as zr,a1 as Br,a2 as Or,a3 as ds,a4 as Vr,a5 as qr,a6 as Ur,a7 as Jr,a8 as us,a9 as Hr,aa as Wr}from"./recreatio-core-B12ledQl.js";import"./vendor-cogita-ui-DTaQ_FiW.js";const za={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},Ka={moveMs:900,pauseMs:220,errorMs:900},Qr=(t=11)=>{let n=t;const r=()=>(n=(n*1664525+1013904223)%4294967296,n/4294967296),{width:s,height:o,paddingX:h,paddingY:u,levels:j}=za,p=(o-u*2)/(j.length-1),k=[],i=[],m=[];j.forEach((x,y)=>{const _=o-u-y*p,V=s-h*2,w=[];for(let C=0;C<x;C+=1){const f=h+(C+1)*V/(x+1),q=(r()-.5)*18,$=Math.max(h,Math.min(s-h,f+q)),R=y===0?3:y<2?2.1:1.4,K=y===0?"root":`l${y}-${C}`;w.push({id:K,x:y===0?s/2:$,y:_,r:R,level:y,role:y===0?"root":void 0})}m.push(w),k.push(...w)});const l=m[m.length-1];if(l!=null&&l.length){const x=l[Math.floor(l.length/2)];x.role="goal",x.r=2}for(let x=1;x<m.length;x+=1){const y=m[x-1];m[x].forEach(V=>{const w=[...y].sort(($,R)=>Math.abs($.x-V.x)-Math.abs(R.x-V.x)),C=w[0],f=w[1]&&r()<.45?w[1]:null;(f?[C,f]:[C]).forEach($=>{i.push({from:$.id,to:V.id,key:`${$.id}-${V.id}`})}),r()<.2&&w[2]&&i.push({from:w[2].id,to:V.id,key:`${w[2].id}-${V.id}`})})}const c=new Map;i.forEach(x=>{const y=c.get(x.to)??[];y.push(x.from),c.set(x.to,y)});const v=new Map,g=new Map,S=new Map;i.forEach(x=>{const y=v.get(x.from)??[];y.push(x.key),v.set(x.from,y);const _=g.get(x.from)??[];_.push(x.to),g.set(x.from,_);const V=S.get(x.from)??[];V.push(x.to),S.set(x.from,V);const w=S.get(x.to)??[];w.push(x.from),S.set(x.to,w)});const O=new Map;return k.forEach(x=>{O.set(x.id,x)}),{nodes:k,links:i,parentsById:c,linksByFrom:v,childrenByFrom:g,neighborsById:S,nodesById:O}};function Gr({slides:t,activeIndex:n,introOpen:r,prefersReducedMotion:s,onNext:o,onPrev:h,onSelect:u,onExit:j,onOpen:p,onRegister:k}){const i=n===t.length-1,m=r&&n===0?"entry":"docked",l=t[t.length-1],[c,v]=a.useState(!1),g=a.useMemo(()=>Array.from({length:20},(D,E)=>({src:`/cogita/logo/Cogita${String(E).padStart(2,"0")}.png`,kind:E<=11?"bubble":E<=17?"text":"recreatio"})),[]),S=r&&n===0;a.useEffect(()=>{if(!r){v(!1);return}n>0&&!c&&v(!0)},[n,r,c]);const O=a.useRef(0),x=a.useRef(null),y=a.useMemo(()=>{const D={x:40,y:160},E={x:260,y:48},N=6,T=E.x-D.x,M=D.y-E.y,le=T/N,be=[.3,.45,.6,.65,1.4,2.2],de=be.reduce((G,Z)=>G+Z,0),X=be.map(G=>M*G/de),P=[D];let Y=D.x,ne=D.y;for(let G=1;G<=N;G+=1){const Z=(Math.random()-.5)*14,xe=(Math.random()-.5)*28;Y=Math.max(D.x+G*14,Math.min(E.x-(N-G)*14,Y+le+Z));const U=X[G-1]??X[X.length-1];ne=ne-U+xe;const se=Math.max(E.y,Math.min(D.y-4,ne));P.push({x:Math.round(Y),y:Math.round(se)})}return P[P.length-1]=E,P},[]),_=a.useMemo(()=>{const M=(de,X,P)=>Math.min(P,Math.max(X,de)),le=y.map(de=>{const X=10+Math.random()*36;return{x:M(de.x,40,260),y:M(de.y-X,40,140)}}),be=y.map((de,X)=>{var ne;const P=12+Math.random()*40,Y=((ne=le[X])==null?void 0:ne.y)??de.y;return{x:M(de.x,40,260),y:M(Math.max(Y+10,de.y+P),60,170)}});return{upper:le,lower:be}},[y]),V=a.useMemo(()=>{var E;const D=((E=y[4])==null?void 0:E.x)??260;return Math.max(0,Math.min(240,D-40))},[y]),w=a.useMemo(()=>{var X,P;const D=(Y,ne,G)=>Math.min(G,Math.max(ne,Y)),E=(Y,ne,G)=>y.map((Z,xe)=>{var bt,mt;const U=((bt=_.upper[xe])==null?void 0:bt.y)??Z.y,se=((mt=_.lower[xe])==null?void 0:mt.y)??Z.y,Le=(Math.random()-.5)*70,qe=Z.y+Y+Le,_e=D(Z.y+ne,U+6,se-6),Je=D(Z.y+G,U+6,se-6);return{x:Z.x,y:D(qe,Math.min(_e,Je),Math.max(_e,Je))}}),N=-14+Math.random()*28,T=14+Math.random()*28,M=E(N,-80,12),le=E(T,-12,80);for(let Y=4;Y<y.length;Y+=1){const ne=y[Y],G=((X=_.upper[Y])==null?void 0:X.y)??ne.y,Z=((P=_.lower[Y])==null?void 0:P.y)??ne.y;M[Y]={x:ne.x,y:D(ne.y-12,G+6,Z-6)},le[Y]={x:ne.x,y:D(ne.y+12,G+6,Z-6)}}const be=_.upper.length?_.upper[_.upper.length-1].y:40,de=_.lower.length?_.lower[_.lower.length-1].y:170;return M[M.length-1]={x:y[y.length-1].x,y:D(y[y.length-1].y-14,be,de)},le[le.length-1]={x:y[y.length-1].x,y:D(y[y.length-1].y+12,be,de)},{higher:M,lower:le}},[y,_]),C=1e4,f=a.useMemo(()=>{let D=17;const E=()=>(D=(D*1664525+1013904223)%4294967296,D/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((T,M)=>{const le=(E()-.5)*240,be=(E()-.5)*180,de=(E()-.5)*24;return{id:`card-${M+1}`,throw:{x:`${le.toFixed(0)}px`,y:`${be.toFixed(0)}px`,rot:`${de.toFixed(1)}deg`},grid:{x:`${T.x}px`,y:`${T.y}px`},delay:`${M*.12}s`}})},[]),q=a.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[$,R]=a.useState([]),K=a.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),Q=a.useMemo(()=>{const E=[],T=(le,be)=>le+Math.random()*(be-le);for(let le=0;le<6;le+=1){let be=!1;for(let de=0;de<80;de+=1){const X=T(14,86),P=T(10,34);if(E.every(ne=>{const G=ne.x-X,Z=ne.y-P;return Math.hypot(G,Z)>=12})){E.push({x:X,y:P}),be=!0;break}}be||E.push({x:T(16,84),y:T(12,32)})}return E.map((le,be)=>({id:`p${be+1}`,x:`${le.x.toFixed(1)}%`,y:`${le.y.toFixed(1)}%`,xNum:le.x,yNum:le.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[me,Ae]=a.useState(0),[ee,L]=a.useState(0),[ye,W]=a.useState([]),pe=1e4,ae=a.useMemo(()=>{if(Q.length<2)return[];const D=be=>{let de=be+1831565813;return de=Math.imul(de^de>>>15,de|1),de^=de+Math.imul(de^de>>>7,de|61),((de^de>>>14)>>>0)/4294967296},E=(be,de)=>Math.floor(D(be)*de),N=new Set,T=[],M=Math.min(3,Q.length);let le=0;for(;T.length<M&&le<30;){le+=1;const be=E(me*13+le*5,Q.length),de=E(me*29+le*7,Q.length);if(be===de)continue;const X=be<de?`${be}-${de}`:`${de}-${be}`;N.has(X)||(N.add(X),T.push({id:`link-${X}`,from:Q[be],to:Q[de],delay:`${(le*.35).toFixed(2)}s`}))}return T},[me,Q]);a.useEffect(()=>{if(!r||n!==2)return;const D=()=>{const N=f.map(T=>T.id);for(let T=N.length-1;T>0;T-=1){const M=Math.floor(Math.random()*(T+1));[N[T],N[M]]=[N[M],N[T]]}return N.slice(0,4)};R(D());const E=window.setInterval(()=>{R(D())},C);return()=>window.clearInterval(E)},[n,r,f,C]),a.useEffect(()=>{if(!r||n!==3)return;const D=()=>{L(Math.floor(Math.random()*K.length)),W(Q.map(()=>Math.random()<.6?"good":"bad")),Ae(N=>N+1)};D();const E=window.setInterval(D,pe);return()=>window.clearInterval(E)},[n,r,K.length,Q,pe]);const ke=a.useMemo(()=>Qr(11),[]),[he,ce]=a.useState(new Set(["root"])),[Ie,$e]=a.useState(new Set),[Fe,Re]=a.useState(new Set),[et,ct]=a.useState({fromId:"root",toId:"root",key:0}),Te=a.useRef(he),We=a.useRef("root"),xt=a.useRef(0),Ve=a.useRef(null),ze=a.useRef(null),tt=a.useRef([]);a.useEffect(()=>{Te.current=he},[he]);const ot=a.useMemo(()=>{const D=new Set;return he.forEach(E=>{const N=ke.linksByFrom.get(E);N&&N.forEach(T=>D.add(T))}),D},[he,ke]),Ye=ke.nodesById.get(et.toId)??ke.nodesById.get("root"),Ce=Ye?`${Ye.x/za.width*100}%`:"50%",Be=Ye?`${Ye.y/za.height*100}%`:"90%";a.useEffect(()=>{if(!r||n!==1||s)return;(()=>{ce(new Set(["root"])),$e(new Set),Re(new Set),ct({fromId:"root",toId:"root",key:0}),ze.current=null,xt.current=0,We.current="root",tt.current=[]})();const E=()=>{const T=We.current,M=Te.current,be=(ke.childrenByFrom.get(T)??[]).filter(Z=>!M.has(Z));if(be.length)return be[Math.floor(Math.random()*be.length)];if(M.size>=ke.nodes.length){const Z=ke.neighborsById.get(T)??[];return Z.length?Z[Math.floor(Math.random()*Z.length)]:null}const de=Z=>(ke.childrenByFrom.get(Z)??[]).some(U=>!M.has(U)),X=[T],P=new Set([T]),Y=new Map;let ne=null;for(;X.length;){const Z=X.shift();if(!Z)break;if(Z!==T&&de(Z)){ne=Z;break}(ke.neighborsById.get(Z)??[]).forEach(U=>{P.has(U)||(P.add(U),Y.set(U,Z),X.push(U))})}if(!ne)return null;let G=ne;for(;Y.get(G)&&Y.get(G)!==T;)G=Y.get(G)??G;return G},N=(T,M)=>{if(T===M){const le=E();le&&N(T,le);return}xt.current+=1,ct({fromId:T,toId:M,key:xt.current}),We.current=M,Ve.current=window.setTimeout(()=>{const le=ke.parentsById.get(M)??[],be=Te.current,de=le.filter(ne=>!be.has(ne));if(!de.length){const ne=new Set(be);ne.add(M),ce(ne),Ve.current=window.setTimeout(()=>{for(;tt.current.length;){const Z=tt.current[tt.current.length-1];if(!ne.has(Z)){if(Z!==M){N(M,Z);return}break}tt.current.pop()}const G=E();G&&N(M,G)},Ka.pauseMs);return}const X=new Set([M,...de]),P=new Set(de.map(ne=>`${ne}-${M}`));$e(X),Re(P),tt.current.includes(M)||tt.current.push(M);const Y=de[Math.floor(Math.random()*de.length)];ze.current={fromId:M,toId:Y},Ve.current=window.setTimeout(()=>{$e(new Set),Re(new Set);const ne=ze.current;ne&&N(ne.fromId,ne.toId)},Ka.errorMs)},Ka.moveMs)};return Ve.current=window.setTimeout(()=>{const T=E();T&&N(We.current,T)},Ka.pauseMs),()=>{Ve.current&&window.clearTimeout(Ve.current)}},[n,r,ke,s]);const Xe=D=>{if(!r)return;const E=Date.now();E-O.current<520||Math.abs(D.deltaY)<10||(O.current=E,D.deltaY>0?o():h(),D.preventDefault())},F=D=>{if(!r)return;const E=D.touches[0];E&&(x.current={x:E.clientX,y:E.clientY})},A=D=>{if(!r)return;const E=x.current;if(x.current=null,!E)return;const N=D.changedTouches[0];if(!N)return;const T=N.clientX-E.x,M=N.clientY-E.y;Math.abs(M)<40||Math.abs(M)<Math.abs(T)||(M<0?o():h())};return e.jsxs("div",{className:`cogita-intro ${r?"is-open":"is-closed"} ${s?"is-reduced":""} ${i?"is-final":""}`,"data-slide":n+1,onWheel:Xe,onTouchStart:F,onTouchEnd:A,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":m,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${S&&!c?"is-entry":""}`,children:g.map((D,E)=>e.jsx("img",{src:D.src,alt:"",className:`cogita-logo-layer ${E===0?"is-base":""} ${D.kind==="text"?"is-text":D.kind==="recreatio"?"is-recreatio":""} ${D.kind==="bubble"?"is-bubble":""}`},D.src))})}),r&&t.map((D,E)=>{const N=E===n;return e.jsxs("section",{className:`cogita-intro-slide slide-${E+1} ${N?"is-active":""}`,"aria-hidden":!N,children:[e.jsxs("div",{className:"cogita-intro-text",children:[D.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:D.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:D.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:D.title}),D.body&&e.jsx("p",{children:D.body.split(`
`).map((T,M)=>e.jsxs("span",{children:[T,M===0&&e.jsx("br",{})]},String(M)))})]}),D.micro&&e.jsx("p",{className:"cogita-intro-micro",children:D.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:i?k:o,children:D.cta}),i&&D.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>u(0),children:D.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[E===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${za.width} ${za.height}`,preserveAspectRatio:"none",children:[ke.links.map(T=>{const M=ke.nodesById.get(T.from),le=ke.nodesById.get(T.to);if(!M||!le)return null;const be=ot.has(T.key),de=Fe.has(T.key);return e.jsx("line",{className:`map-link ${be?"is-active":""} ${de?"is-error":""}`,x1:M.x,y1:M.y,x2:le.x,y2:le.y},T.key)}),ke.nodes.map(T=>{const M=he.has(T.id),le=Ie.has(T.id);return e.jsx("circle",{className:`map-node ${T.role?`is-${T.role}`:""} ${M?"is-active":""} ${le?"is-error":""}`,cx:T.x,cy:T.y,r:T.r},T.id)})]}),Ye&&e.jsx("span",{className:"map-explorer-dot",style:{left:Ce,top:Be,"--move":`${Ka.moveMs}ms`}})]}),E===2&&e.jsx("div",{className:"cogita-index-cards",children:f.map(T=>{const M=$.indexOf(T.id),le=M>=0?q[M]:null,be=(le==null?void 0:le.x)??"140px",de=(le==null?void 0:le.y)??"140px",X=M>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":T.throw.x,"--throw-y":T.throw.y,"--throw-rot":T.throw.rot,"--grid-x":T.grid.x,"--grid-y":T.grid.y,"--stack-x":be,"--stack-y":de,"--stack-opacity":X,"--delay":T.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},T.id)})}),E===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[K.map((T,M)=>e.jsxs("div",{className:`round-card ${M===ee?"is-active":""}`,style:{"--card-x":T.x,"--card-y":T.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},T.id)),K[ee]&&e.jsx("span",{className:"round-ring",style:{"--card-x":K[ee].x,"--card-y":`calc(${K[ee].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:Q.map(T=>e.jsx("span",{className:"player-dot",style:{left:T.x,top:T.y,"--jitter-x":T.jitterX,"--jitter-y":T.jitterY,"--breath-delay":T.delay}},T.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:ae.map(T=>e.jsx("line",{className:"round-link",x1:T.from.xNum,y1:T.from.yNum,x2:T.to.xNum,y2:T.to.yNum,style:{"--delay":T.delay}},T.id))}),e.jsx("div",{className:"round-flows",children:Q.map((T,M)=>{const le=ye[M]??"good",be=K[ee];if(!be)return null;const de=`calc(${be.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":T.x,"--from-y":T.y,"--to-x":be.x,"--to-y":de,"--delay":`${M*.12}s`}}),e.jsx("span",{className:`return-dot is-${le}`,style:{"--from-x":be.x,"--from-y":de,"--to-x":T.x,"--to-y":T.y,"--delay":`${M*.12}s`}}),e.jsx("span",{className:`result-pop is-${le}`,style:{"--at-x":T.x,"--at-y":T.y,"--delay":`${M*.12}s`}})]},`${T.id}-${me}`)})})]},`round-${me}`),E===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${y[0].x} ${y[0].y} L${y[1].x} ${y[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${y[1].x} ${y[1].y} L${y[2].x} ${y[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${y[2].x} ${y[2].y} L${y[3].x} ${y[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${y[3].x} ${y[3].y} L${y[4].x} ${y[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${y[4].x} ${y[4].y} L${y[5].x} ${y[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${y[5].x} ${y[5].y} L${y[6].x} ${y[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${V};${V};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${_.upper.map((T,M)=>`${M===0?"M":"L"}${T.x} ${T.y}`).join(" ")} ${_.lower.slice().reverse().map(T=>`L${T.x} ${T.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${_.upper.map((T,M)=>`${M===0?"M":"L"}${T.x} ${T.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${_.lower.map((T,M)=>`${M===0?"M":"L"}${T.x} ${T.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[w.higher.slice(0,6).map((T,M)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${M+1}`,d:`M${T.x} ${T.y} L${w.higher[M+1].x} ${w.higher[M+1].y}`,pathLength:"100"},`peer-1-${M}`)),w.lower.slice(0,6).map((T,M)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${M+1}`,d:`M${T.x} ${T.y} L${w.lower[M+1].x} ${w.lower[M+1].y}`,pathLength:"100"},`peer-2-${M}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${y[0].x/300*100}%`,"--p0y":`${y[0].y/200*100}%`,"--p1x":`${y[1].x/300*100}%`,"--p1y":`${y[1].y/200*100}%`,"--p2x":`${y[2].x/300*100}%`,"--p2y":`${y[2].y/200*100}%`,"--p3x":`${y[3].x/300*100}%`,"--p3y":`${y[3].y/200*100}%`,"--p4x":`${y[4].x/300*100}%`,"--p4y":`${y[4].y/200*100}%`,"--p5x":`${y[5].x/300*100}%`,"--p5y":`${y[5].y/200*100}%`,"--p6x":`${y[6].x/300*100}%`,"--p6y":`${y[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${w.higher[0].x/300*100}%`,"--q0y":`${w.higher[0].y/200*100}%`,"--q1x":`${w.higher[1].x/300*100}%`,"--q1y":`${w.higher[1].y/200*100}%`,"--q2x":`${w.higher[2].x/300*100}%`,"--q2y":`${w.higher[2].y/200*100}%`,"--q3x":`${w.higher[3].x/300*100}%`,"--q3y":`${w.higher[3].y/200*100}%`,"--q4x":`${w.higher[4].x/300*100}%`,"--q4y":`${w.higher[4].y/200*100}%`,"--q5x":`${w.higher[5].x/300*100}%`,"--q5y":`${w.higher[5].y/200*100}%`,"--q6x":`${w.higher[6].x/300*100}%`,"--q6y":`${w.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${w.lower[0].x/300*100}%`,"--q0y":`${w.lower[0].y/200*100}%`,"--q1x":`${w.lower[1].x/300*100}%`,"--q1y":`${w.lower[1].y/200*100}%`,"--q2x":`${w.lower[2].x/300*100}%`,"--q2y":`${w.lower[2].y/200*100}%`,"--q3x":`${w.lower[3].x/300*100}%`,"--q3y":`${w.lower[3].y/200*100}%`,"--q4x":`${w.lower[4].x/300*100}%`,"--q4y":`${w.lower[4].y/200*100}%`,"--q5x":`${w.lower[5].x/300*100}%`,"--q5y":`${w.lower[5].y/200*100}%`,"--q6x":`${w.lower[6].x/300*100}%`,"--q6y":`${w.lower[6].y/200*100}%`}})]})})}),E===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),E===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},D.id)}),!r&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:l.title}),l.body&&e.jsx("p",{children:l.body}),l.micro&&e.jsx("p",{className:"cogita-intro-micro",children:l.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:k,children:l.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:p,children:"Otwórz pokaz"})]})]})})]}),r&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((D,E)=>e.jsx("button",{type:"button",className:`dot ${n===E?"active":""}`,"aria-label":D.title,onClick:()=>u(E)},D.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:j,children:"Pomiń"})]})]})}const Yr=6,Xr=4;function Zr({copy:t,onAuthAction:n,authLabel:r,showProfileMenu:s,onProfileNavigate:o,onToggleSecureMode:h,onLogout:u,secureMode:j,onNavigate:p,language:k,onLanguageChange:i}){const m=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}p("home")},l=a.useRef(null),c=a.useRef([]),v=a.useMemo(()=>{let W=Date.now()%2147483647;const pe=()=>(W=W*48271%2147483647,W/2147483647);return Array.from({length:Yr},(ae,ke)=>{const he=6+pe()*8,ce=7+pe()*10,Ie=6+pe()*9,$e=-pe()*he,Fe=-pe()*ce,Re=-pe()*Ie,et=.18+pe()*.28,ct=12+pe()*18,Te=4+pe()*8,We=(pe()-.5)*3.2,xt=(pe()-.5)*3.8,Ve=pe()>.5?"alternate":"alternate-reverse",ze=pe()>.5?"alternate":"alternate-reverse",tt=pe()>.5?"alternate":"alternate-reverse",ot=.18+pe()*.42,Ye=30+pe()*60,Ce=-45-pe()*38,Be=188+pe()*32,Xe=.1+pe()*.2;return{id:`wave-${ke+1}`,style:{"--wave-sway-duration":`${he}s`,"--wave-scale-duration":`${ce}s`,"--wave-drift-duration":`${Ie}s`,"--wave-sway-delay":`${$e}s`,"--wave-scale-delay":`${Fe}s`,"--wave-drift-delay":`${Re}s`,"--wave-sway-dir":Ve,"--wave-scale-dir":ze,"--wave-drift-dir":tt,"--wave-scale":`${et}`,"--wave-shift":`${ct}%`,"--wave-xshift":`${Te}%`,"--wave-x0":`${We}%`,"--wave-y0":`${xt}%`,"--wave-opacity":`${ot}`,"--wave-blur":`${Ye}px`,"--wave-bottom":`${Ce}%`,"--wave-hue":`${Be}`,"--wave-glow":`${Xe}`}}})},[]),g=a.useMemo(()=>{let W=Date.now()*3%2147483647;const pe=()=>(W=W*48271%2147483647,W/2147483647);return Array.from({length:Xr},(ae,ke)=>{const he=180+pe()*220,ce=220+pe()*280,Ie=-pe()*he,$e=-pe()*ce,Fe=.12+pe()*.22,Re=3+pe()*7,et=1+pe()*3,ct=(pe()-.5)*2.8,Te=(pe()-.5)*2.2;return{id:`mesh-${ke+1}`,seed:1e3+ke*991+Math.floor(pe()*999),style:{"--mesh-sway-duration":`${he}s`,"--mesh-drift-duration":`${ce}s`,"--mesh-sway-delay":`${Ie}s`,"--mesh-drift-delay":`${$e}s`,"--mesh-scale":`${Fe}`,"--mesh-shift":`${Re}%`,"--mesh-xshift":`${et}%`,"--mesh-x0":`${Te}%`,"--mesh-y0":`${ct}%`}}})},[]),S=a.useMemo(()=>{const W=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],pe=t.cogita.introSlides,ae=new Map(pe.map(ke=>[ke.id,ke]));return W.map(ke=>{var ce;const he=ae.get(ke.id);return{...ke,...he,title:(he==null?void 0:he.title)??"Cogita",cta:(he==null?void 0:he.cta)??((ce=t.cogita.introSlides[0])==null?void 0:ce.cta)??t.cogita.loginCta,secondary:he==null?void 0:he.secondary}})},[t.cogita.introSlides]),[O,x]=a.useState(0),[y,_]=a.useState(!0),[V,w]=a.useState(!1),C=S.length-1,f=a.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),q=a.useCallback(()=>{f(),n()},[f,n]),$=a.useCallback(()=>{_(!0),x(0)},[]),R=a.useCallback(()=>{_(!1),x(C)},[C]),K=a.useCallback(W=>{x(Math.max(0,Math.min(C,W)))},[C]),Q=a.useCallback(()=>{O>=C?q():K(O+1)},[O,K,q,C]),me=a.useCallback(()=>{K(O-1)},[O,K]);a.useEffect(()=>{var ae;const W=(ae=window.matchMedia)==null?void 0:ae.call(window,"(prefers-reduced-motion: reduce)");if(!W)return;const pe=()=>w(W.matches);return pe(),W.addEventListener?(W.addEventListener("change",pe),()=>W.removeEventListener("change",pe)):(W.addListener(pe),()=>W.removeListener(pe))},[]),a.useEffect(()=>{if(!y)return;const W=pe=>{const ae=pe.target;if(!ae)return;const ke=ae.tagName;if(!(ae.isContentEditable||ke==="INPUT"||ke==="TEXTAREA"||ke==="SELECT"||ke==="BUTTON"||ke==="A"||ae.closest('button, a, [role="button"], [role="link"]'))){if(pe.key==="Escape"){R();return}if(pe.key==="ArrowLeft"||pe.key==="ArrowUp"){me();return}(pe.key==="ArrowRight"||pe.key==="ArrowDown"||pe.code==="Space"||pe.key===" ")&&(pe.preventDefault(),Q())}};return window.addEventListener("keydown",W),()=>window.removeEventListener("keydown",W)},[R,Q,me,y]),a.useEffect(()=>{y&&O===C&&f()},[O,y,C,f]),a.useEffect(()=>{const W=l.current;if(!W)return;const pe=c.current.filter(Ce=>!!Ce);if(!pe.length)return;const ae=1,ke=.6,he=.6,ce=Math.max(1,Math.min(ae,window.devicePixelRatio||1));let Ie=0,$e=0,Fe=ke,Re=0,et=0;const ct=Ce=>{let Be=Ce%2147483647;return Be<=0&&(Be+=2147483646),(Xe,F)=>{Be=Be*48271%2147483647;const A=Be/2147483647;return Xe+A*(F-Xe)}},Te={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},We=Ce=>{const Be=Math.sin(Ce*12.9898)*43758.5453;return Be-Math.floor(Be)},xt=Ce=>{const Be=We(Ce+.1)||1e-4,Xe=We(Ce+.7)||1e-4;return Math.sqrt(-2*Math.log(Be))*Math.cos(2*Math.PI*Xe)},Ve=(Ce,Be)=>{const Xe=Math.floor(Ce),F=Xe+1,A=Ce-Xe,D=A*A*(3-2*A),E=We(Xe*12.9898+Be*78.233),N=We(F*12.9898+Be*78.233);return E+(N-E)*D},ze=Ce=>{const Be=ct(Ce),Xe=Math.min(4,Math.max(4,Math.floor(Ie/1200*Te.filamentCount)));return Array.from({length:Xe},(F,A)=>{const D=Math.max(-1,Math.min(1,xt(Ce+A*.37))),E=Math.min(1,Math.max(0,We(Ce+A*1.31))),N=Math.min(Te.depthLayers-1,Math.floor(E*Te.depthLayers));return{seed:Be(0,Math.PI*2)+Ce*.01,offset:D,freqA:Te.freq1*(.75+Be(0,.5)),freqB:Te.freq2*(.75+Be(0,.5)),ampA:Te.amp1*(.6+Be(0,.7)),ampB:Te.amp2*(.6+Be(0,.7)),width:2+A%5*.32,depth:E,layer:N}})},tt=(Ce,Be,Xe)=>{const F=Math.max(30,Math.floor(Ie*$e/14e4));Ce.save(),Ce.globalAlpha=.6;for(let A=0;A<F;A+=1){const D=We(A*9.1+Ie*.11)*Be+Xe,E=We(A*3.7+$e*.23)*$e,N=1.2+We(A*5.9)*2.4,T=Ce.createRadialGradient(D,E,0,D,E,N*2);T.addColorStop(0,"rgba(10, 30, 60, 0.45)"),T.addColorStop(1,"rgba(10, 30, 60, 0)"),Ce.fillStyle=T,Ce.beginPath(),Ce.arc(D,E,N*2,0,Math.PI*2),Ce.fill()}Ce.restore()},ot=(Ce,Be)=>{Ce.clearRect(0,0,Ie,$e);const Xe=$e*Te.waveCenter,F=Te.waveBandPx,A=Te.segments,D=Te.colors.filaments,E=Re||Ie,N=0;tt(Ce,E,N),Ce.strokeStyle=D,Ce.lineCap="round",Ce.lineJoin="round";for(let T=0;T<Be.length;T+=1){const M=Be[T],le=M.offset*F*(.85+We(M.seed)*.4),be=1-Math.min(1,Math.abs(le)/F),de=Math.exp(-Math.pow(le/Te.crestThickness,2)),X=M.layer===0?1.1:M.layer===1?.85:.6,P=.35+(1-M.depth)*.65,Y=be*P*X*(.34+de*.45);Ce.globalAlpha=Y,Ce.lineWidth=M.width*(1+(1-M.depth)*.8);const ne=[];for(let Z=0;Z<=A;Z+=1){const xe=Z/A*E+N,U=(Ve(xe*.012,M.seed)-.5)*Te.xJitter,se=xe+U,Le=(Ve(se*M.freqA,M.seed)-.5)*Te.jitterA,qe=(Ve(se*M.freqB,M.seed*1.7)-.5)*Te.jitterB,_e=Xe+Math.sin(se*M.freqA+M.seed)*M.ampA+Math.sin(se*M.freqB+M.seed*1.3)*M.ampB+le+Le+qe;ne.push({x:se,y:_e})}Ce.beginPath(),Ce.moveTo(ne[0].x,ne[0].y);for(let Z=1;Z<ne.length-1;Z+=1){const xe=(ne[Z].x+ne[Z+1].x)/2,U=(ne[Z].y+ne[Z+1].y)/2;Ce.quadraticCurveTo(ne[Z].x,ne[Z].y,xe,U)}const G=ne[ne.length-1];Ce.quadraticCurveTo(G.x,G.y,G.x,G.y),Ce.stroke()}Ce.save(),Ce.globalCompositeOperation="lighter",Ce.strokeStyle=Te.colors.glow,Ce.lineCap="round",Ce.lineJoin="round";for(let T=0;T<Be.length;T+=1){const M=Be[T];if(Math.abs(M.offset)*F>Te.crestThickness)continue;const le=Te.glowAlpha*(.7+(1-M.depth)*.6);Ce.globalAlpha=le,Ce.lineWidth=1.6+(1-M.depth)*1.2;const be=[];for(let X=0;X<=A;X+=1){const P=X/A*E+N,Y=Math.sin(P*.02+M.seed)*3,ne=Xe+Math.sin(P*M.freqA+M.seed)*M.ampA+Math.sin(P*M.freqB+M.seed*1.3)*M.ampB+M.offset*F*.35+Y;be.push({x:P,y:ne})}Ce.beginPath(),Ce.moveTo(be[0].x,be[0].y);for(let X=1;X<be.length-1;X+=1){const P=(be[X].x+be[X+1].x)/2,Y=(be[X].y+be[X+1].y)/2;Ce.quadraticCurveTo(be[X].x,be[X].y,P,Y)}const de=be[be.length-1];Ce.quadraticCurveTo(de.x,de.y,de.x,de.y),Ce.stroke()}Ce.restore()},Ye=()=>{Ie=Math.floor(W.clientWidth),$e=Math.floor(W.clientHeight),Re=Math.floor(Ie*1.8),et=$e,Fe=Ie<820?he:ke,pe.forEach(Ce=>{const Be=Ce.getContext("2d");if(!Be)return;Ce.width=Math.floor(Re*ce*Fe),Ce.height=Math.floor(et*ce*Fe),Ce.style.width=`${Re}px`,Ce.style.height=`${et}px`,Ce.style.left=`${-(Re-Ie)/2}px`,Be.setTransform(ce*Fe,0,0,ce*Fe,0,0);const Xe=Number(Ce.dataset.seed||1),F=ze(Xe);ot(Be,F)})};return Ye(),window.addEventListener("resize",Ye,{passive:!0}),()=>window.removeEventListener("resize",Ye)},[g]);const Ae=S[Math.min(O,S.length-1)],ee=y?Ae:S[S.length-1],L=(ee==null?void 0:ee.theme)??S[0].theme,ye={"--cogita-bg0":L.bg0,"--cogita-bg1":L.bg1,"--cogita-bg2":L.bg2,"--cogita-bloom":L.bloom,"--cogita-sat":L.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:m,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Bs,{value:k,onChange:i}),e.jsx(Os,{copy:t,label:r,isAuthenticated:s,secureMode:j,onLogin:n,onProfileNavigate:o,onToggleSecureMode:h,onLogout:u,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:l,className:"cogita-section cogita-home",style:ye,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[g.map((W,pe)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:W.style,"data-seed":W.seed,ref:ae=>{c.current[pe]=ae}},W.id)),v.map(W=>e.jsx("div",{className:"cogita-home-wave",style:W.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},W.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(Gr,{slides:S,activeIndex:O,introOpen:y,prefersReducedMotion:V,onNext:Q,onPrev:me,onSelect:K,onExit:R,onOpen:$,onRegister:q})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const Mo=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:Zr},Symbol.toStringTag,{value:"Module"})),Ys=a.createContext(!1);function Pt({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,headerExtra:i,children:m}){if(a.useContext(Ys))return e.jsx(e.Fragment,{children:m});const c=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}j("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:c,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Bs,{value:p,onChange:k}),e.jsxs("div",{className:"cogita-header-right",children:[i,e.jsx(Os,{copy:t,label:n,isAuthenticated:r,secureMode:u,onLogin:()=>j("home"),onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:m}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function da(t){const[n,r]=a.useState("Cogita library"),[s,o]=a.useState(null);return a.useEffect(()=>{let h=!1;return Vs().then(u=>{if(h)return;const j=u.find(p=>p.libraryId===t);j&&r(j.name)}).catch(()=>{h||r("Cogita library")}),()=>{h=!0}},[t]),a.useEffect(()=>{let h=!1;return hr(t).then(u=>{h||o(u)}).catch(()=>{h||o(null)}),()=>{h=!0}},[t]),{libraryName:n,stats:s}}function hs({slices:t}){const n=t.reduce((s,o)=>s+Math.max(0,o.value),0),r=a.useMemo(()=>{if(n<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let s=0;return`conic-gradient(${t.map(h=>{const j=Math.max(0,h.value)/n*360,p=s,k=s+j;return s=k,`${h.color} ${p}deg ${k}deg`}).join(",")})`},[t,n]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:r}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(s=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:s.color}}),e.jsx("strong",{children:s.value}),e.jsx("small",{children:s.label})]},s.label))})]})}function ei({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,libraryId:i}){const{libraryName:m,stats:l}=da(i),[c,v]=a.useState("infos"),[g,S]=a.useState(0),[O,x]=a.useState(0),[y,_]=a.useState(0),V=(l==null?void 0:l.totalInfos)??0,w=(l==null?void 0:l.totalCollections)??0,C=0,f=0,q=0,$=Math.max(0,V-q-O),R=Math.max(0,V-O-y);a.useEffect(()=>{let Q=!1;return(async()=>{try{const Ae=await Va({libraryId:i,limit:200}),ee=await Promise.all(Ae.items.map(L=>Gn({libraryId:i,collectionId:L.collectionId}).catch(()=>[])));if(Q)return;S(ee.reduce((L,ye)=>L+ye.length,0))}catch{Q||S(0)}})(),()=>{Q=!0}},[i]),a.useEffect(()=>{let Q=!1;return(async()=>{try{const[Ae,ee,L]=await Promise.all([ls({libraryId:i,type:"computed",limit:1}).catch(()=>({total:0})),ls({libraryId:i,type:"source",limit:1}).catch(()=>({total:0})),Yn({libraryId:i}).catch(()=>({items:[]}))]);if(Q)return;x((Ae.total??0)+(ee.total??0));const ye=new Set(L.items.filter(W=>W.childItemType.toLowerCase()==="info").map(W=>W.childItemId).filter(Boolean));_(ye.size)}catch{Q||(x(0),_(0))}})(),()=>{Q=!0}},[i]);const K=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:V},{key:"collections",label:t.cogita.library.overview.stats.collections,value:w},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:g},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:C},{key:"texts",label:t.cogita.library.overview.stats.texts,value:f}];return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:m})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:K.map(Q=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${c===Q.key?"active":""}`,onClick:()=>v(Q.key),children:[e.jsx("span",{children:Q.label}),e.jsx("strong",{children:Q.value})]},Q.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),c==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(hs,{slices:[{label:t.cogita.library.overview.known,value:q,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:$,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:O,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(hs,{slices:[{label:t.cogita.library.overview.availableChecks,value:y,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:R,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const nt=(t,n)=>{const r=t.cogita.library.infoTypes,s=t.cogita.library.connectionTypes,o=t.cogita.library.groupTypes;return{any:r.any,vocab:r.vocab,book:o.book,citation:o.citation,language:r.language,word:r.word,sentence:r.sentence,topic:r.topic,collection:r.collection,person:r.person,institution:r.institution,collective:r.collective,orcid:r.orcid,address:r.address,email:r.email,phone:r.phone,media:r.media,work:r.work,geo:r.geo,music_piece:r.musicPiece,music_fragment:r.musicFragment,source:r.source,question:r.question,computed:r.computed,"word-language":s.wordLanguage,"citation-language":s.citationLanguage,"language-sentence":s.languageSentence,translation:s.translation,"word-topic":s.wordTopic,reference:s.reference,"source-resource":s.sourceResource,"work-contributor":s.workContributor,"work-medium":s.workMedium,"orcid-link":s.orcidLink}[n]??String(n)},ti=t=>[{value:"any",label:nt(t,"any")},{value:"language",label:nt(t,"language")},{value:"word",label:nt(t,"word")},{value:"sentence",label:nt(t,"sentence")},{value:"topic",label:nt(t,"topic")},{value:"collection",label:nt(t,"collection")},{value:"person",label:nt(t,"person")},{value:"institution",label:nt(t,"institution")},{value:"collective",label:nt(t,"collective")},{value:"orcid",label:nt(t,"orcid")},{value:"address",label:nt(t,"address")},{value:"email",label:nt(t,"email")},{value:"phone",label:nt(t,"phone")},{value:"media",label:nt(t,"media")},{value:"work",label:nt(t,"work")},{value:"geo",label:nt(t,"geo")},{value:"music_piece",label:nt(t,"music_piece")},{value:"music_fragment",label:nt(t,"music_fragment")},{value:"source",label:nt(t,"source")},{value:"question",label:nt(t,"question")},{value:"citation",label:nt(t,"citation")},{value:"computed",label:nt(t,"computed")},{value:"vocab",label:nt(t,"vocab")},{value:"book",label:nt(t,"book")},{value:"word-language",label:nt(t,"word-language")},{value:"citation-language",label:nt(t,"citation-language")},{value:"language-sentence",label:nt(t,"language-sentence")},{value:"translation",label:nt(t,"translation")},{value:"word-topic",label:nt(t,"word-topic")},{value:"reference",label:nt(t,"reference")},{value:"source-resource",label:nt(t,"source-resource")},{value:"work-contributor",label:nt(t,"work-contributor")},{value:"work-medium",label:nt(t,"work-medium")},{value:"orcid-link",label:nt(t,"orcid-link")}],ai=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Mn={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},ni={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Mn]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Mn]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId"]},filterFields:[Mn,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text"],connections:[{relationType:"citation-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"citationText",kind:"text",path:"text",matcher:"contains"}]},question:{infoType:"question",entityKind:"single",structure:{payloadFields:["definition"]},filterFields:[{key:"questionType",labelKey:"type",kind:"text",path:"definition.type",matcher:"contains"},{key:"questionText",labelKey:"text",kind:"text",path:"definition.question",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},gs={infoType:"default",entityKind:"single",structure:{payloadFields:["label"]},filterFields:[]};function si(t){return t?ni[t]??gs:gs}function ri(t,n){return t.optionsSource==="languages"?n.languages.map(r=>({value:r.infoId,label:r.label})):t.optionsSource==="sourceKinds"?ai:[]}const ii="cogita.revision.seed:";function Xs(t){return`${ii}${t}`}function oi(t,n){if(typeof window>"u")return null;const r=Array.from(new Set(n.map(h=>h.trim()).filter(Boolean)));if(!r.length)return null;const s=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,o={kind:"info-selection",libraryId:t,infoIds:r,createdAt:new Date().toISOString()};return window.localStorage.setItem(Xs(s),JSON.stringify(o)),s}function ms(t,n){if(typeof window>"u")return null;const r=window.localStorage.getItem(Xs(n));if(!r)return null;try{const s=JSON.parse(r);if(s.kind!=="info-selection"||s.libraryId!==t||!Array.isArray(s.infoIds))return null;const o=s.infoIds.map(h=>String(h??"").trim()).filter(Boolean);return o.length?{infoIds:o}:null}catch{return null}}const li="cogita.collection-draft:";function Zs(t){return`${li}${t}`}function ci(t,n){if(typeof window>"u")return null;const r=Array.from(new Set(n.map(h=>h.trim()).filter(Boolean)));if(!r.length)return null;const s=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,o={kind:"info-selection",libraryId:t,infoIds:r,createdAt:new Date().toISOString()};return window.localStorage.setItem(Zs(s),JSON.stringify(o)),s}function di(t,n){if(typeof window>"u")return null;const r=window.localStorage.getItem(Zs(n));if(!r)return null;try{const s=JSON.parse(r);if(s.kind!=="info-selection"||s.libraryId!==t||!Array.isArray(s.infoIds))return null;const o=s.infoIds.map(h=>String(h??"").trim()).filter(Boolean);return o.length?{infoIds:o}:null}catch{return null}}const Ln=60,ui=500;function er(t){return`cogita.info-selection:${t}`}function ps(t){if(typeof window>"u")return{};const n=window.localStorage.getItem(er(t));if(!n)return{};try{const r=JSON.parse(n);return!r||typeof r!="object"?{}:r}catch{return{}}}function hi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,libraryId:i,mode:m}){var qt;const l=mn(),c=Ja(),v=t.cogita.library.list,[g,S]=a.useState("any"),[O,x]=a.useState(""),[y,_]=a.useState("relevance"),[V,w]=a.useState("details"),[C,f]=a.useState(!1),[q,$]=a.useState("idle"),[R,K]=a.useState([]),[Q,me]=a.useState(Ln),[Ae,ee]=a.useState(null),[L,ye]=a.useState(()=>ps(i)),[W,pe]=a.useState({}),[ae,ke]=a.useState([]),[he,ce]=a.useState([]),[Ie,$e]=a.useState(null),[Fe,Re]=a.useState(null),[et,ct]=a.useState(null),[Te,We]=a.useState("idle"),[xt,Ve]=a.useState([]),[ze,tt]=a.useState(""),[ot,Ye]=a.useState(null),[Ce,Be]=a.useState("idle"),[Xe,F]=a.useState(null),[A,D]=a.useState(null),[E,N]=a.useState("idle"),[T,M]=a.useState([]),[le,be]=a.useState("idle"),de=a.useMemo(()=>ti(t),[t]),X=a.useMemo(()=>[{value:"relevance",label:v.sortRelevance},{value:"label_asc",label:v.sortLabelAsc},{value:"label_desc",label:v.sortLabelDesc},{value:"type_asc",label:v.sortTypeAsc},{value:"type_desc",label:v.sortTypeDesc}],[v.sortLabelAsc,v.sortLabelDesc,v.sortRelevance,v.sortTypeAsc,v.sortTypeDesc]);a.useEffect(()=>{ye(ps(i)),pe({}),f(!1)},[i]),a.useEffect(()=>{Yn({libraryId:i}).then(B=>ct(B)).catch(()=>ct({items:[]}))},[i]),a.useEffect(()=>{gr({libraryId:i}).then(B=>Ve(B)).catch(()=>Ve([]))},[i]),a.useEffect(()=>{In({libraryId:i,type:"language",filters:{sourceKind:"info"},limit:200}).then(B=>{const d=B.map(re=>({infoId:re.infoId??"",infoType:re.entityType,label:re.title})).filter(re=>re.infoId.length>0);ke(d)}).catch(()=>ke([]))},[i]),a.useEffect(()=>{In({libraryId:i,type:"source",filters:{sourceKind:"info"},limit:200}).then(B=>{const d=B.map(re=>({infoId:re.infoId??"",infoType:re.entityType,label:re.title})).filter(re=>re.infoId.length>0);ce(d)}).catch(()=>ce([]))},[i]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(er(i),JSON.stringify(L))},[i,L]);const P=a.useMemo(()=>si(g==="any"?null:g),[g]),Y=a.useMemo(()=>new URLSearchParams(c.search),[c.search]),ne=a.useMemo(()=>c.pathname.split("/").filter(Boolean),[c.pathname]),G=ne.findIndex(B=>B==="infos"),Z=G>=0&&(ne[G+1]??"").trim()||null,xe=G>=0?(ne[G+2]??"").trim():"",U=G>=0?xe==="checkcards"?"cards":xe==="collections"?"collections":"overview":"",se=Z??((Y.get("infoId")??"").trim()||null),Le=Z?U:(Y.get("infoView")??"overview").trim(),qe=Le==="overview"&&!!se,_e=Le==="collections"&&!!se,Je=a.useMemo(()=>({language:v.typeFilterLanguage,languageA:v.typeFilterLanguageA,languageB:v.typeFilterLanguageB,originalLanguage:v.typeFilterOriginalLanguage,doi:v.typeFilterDoi,sourceKind:v.typeFilterSourceKind,locator:v.typeFilterLocator,citationText:v.typeFilterCitationText}),[v.typeFilterDoi,v.typeFilterLanguage,v.typeFilterLanguageA,v.typeFilterLanguageB,v.typeFilterLocator,v.typeFilterOriginalLanguage,v.typeFilterCitationText,v.typeFilterSourceKind]),bt=a.useMemo(()=>P.filterFields.map(B=>({...B,label:B.labelKey?Je[B.labelKey]:B.label??B.key,options:ri(B,{languages:ae})})),[Je,ae,P.filterFields]),mt=a.useMemo(()=>bt.some(B=>(W[B.key]??"").trim().length>0),[bt,W]);a.useEffect(()=>{pe({})},[g]),a.useEffect(()=>{const B={sourceKind:"info"};if(mt)for(const H of bt){const Qe=(W[H.key]??"").trim();Qe&&(B[H.path??H.key]=Qe)}const d=(W.__referenceId??"").trim();d&&(B["link.references"]=d),$("loading");const re=window.setTimeout(()=>{In({libraryId:i,type:g==="any"?void 0:g,query:O.trim()||void 0,filters:B,limit:ui}).then(H=>{const Qe=H.map(rt=>({infoId:rt.infoId??"",infoType:rt.entityType,label:rt.title})).filter(rt=>rt.infoId.length>0);K(Qe),$("ready")}).catch(()=>{K([]),$("ready")})},240);return()=>window.clearTimeout(re)},[mt,i,O,g,bt,W]),a.useEffect(()=>{if(!se||Le!=="overview"&&Le!=="collections"){$e(null),Re(null),We("idle");return}let B=!1;return We("loading"),Promise.all([na({libraryId:i,infoId:se}),mr({libraryId:i,itemType:"info",itemId:se}).catch(()=>null)]).then(([d,re])=>{B||($e(d),Re(re),We("ready"))}).catch(()=>{B||($e(null),Re(null),We("error"))}),()=>{B=!0}},[i,se,Le]),a.useEffect(()=>{if(!se||Le!=="collections"){M([]),be("idle");return}let B=!1;return be("loading"),pr({libraryId:i,infoId:se}).then(d=>{B||(M(d),be("ready"))}).catch(()=>{B||(M([]),be("error"))}),()=>{B=!0}},[i,se,Le]),a.useEffect(()=>{if(!se||Le!=="overview"){F(null),D(null),N("idle");return}let B=!1;return N("loading"),Promise.all([tn({libraryId:i,infoId:se}),an({libraryId:i,infoId:se})]).then(([d,re])=>{B||(F(d),D(re),N("ready"))}).catch(()=>{B||(F(null),D(null),N("error"))}),()=>{B=!0}},[i,se,Le]);const pt=a.useMemo(()=>Ie?xt.filter(B=>B.sourceInfoTypes.some(d=>d.toLowerCase()===Ie.infoType.toLowerCase())):[],[xt,Ie]);a.useEffect(()=>{if(!Ie){tt("");return}tt(B=>{var d;return B&&pt.some(re=>re.approachKey===B)?B:((d=pt[0])==null?void 0:d.approachKey)??""})},[pt,Ie]),a.useEffect(()=>{if(!Ie||!ze){Ye(null),Be("idle");return}let B=!1;return Be("loading"),qs({libraryId:i,infoId:Ie.infoId,approachKey:ze}).then(d=>{B||(Ye(d),Be("ready"))}).catch(()=>{B||(Ye(null),Be("error"))}),()=>{B=!0}},[i,ze,Ie]);const wt=a.useMemo(()=>{const B=R.slice(),d=re=>nt(t,re);return y==="relevance"?B:y==="label_asc"?B.sort((re,H)=>re.label.localeCompare(H.label)):y==="label_desc"?B.sort((re,H)=>H.label.localeCompare(re.label)):y==="type_asc"?B.sort((re,H)=>re.infoType===H.infoType?re.label.localeCompare(H.label):d(re.infoType).localeCompare(d(H.infoType))):B.sort((re,H)=>re.infoType===H.infoType?re.label.localeCompare(H.label):d(H.infoType).localeCompare(d(re.infoType)))},[t,R,y]),Ct=a.useMemo(()=>wt.slice(0,Q),[wt,Q]),Ot=Ct.length<wt.length,Et=a.useMemo(()=>new Set(Object.keys(L)),[L]),Nt=a.useMemo(()=>Object.values(L),[L]),ua=a.useMemo(()=>{const B=new Map;for(const d of Nt)B.set(d.infoType,(B.get(d.infoType)??0)+1);return Array.from(B.entries()).sort((d,re)=>re[1]-d[1]||d[0].localeCompare(re[0]))},[Nt]),Lt=a.useMemo(()=>{if(!se||!et)return 0;const B=new Set;for(const d of et.items)d.childItemType!=="info"||d.childItemId!==se||B.add([d.parentItemType,d.parentItemId,d.parentCheckType??"",d.parentDirection??""].join("|"));return B.size},[et,se]);a.useEffect(()=>{me(Ln);const B=new Set(R.map(d=>d.infoId));ee(d=>d&&B.has(d)?d:null)},[R]);const vt=B=>{ye(d=>({...d,[B.infoId]:{infoId:B.infoId,infoType:B.infoType,label:B.label}}))},St=B=>{ye(d=>{if(!d[B])return d;const re={...d};return delete re[B],re})},kt=(B,d)=>{if(d){vt(B);return}St(B.infoId)},yt=B=>{l(`/cogita/library/${i}/infos/${encodeURIComponent(B)}`,{replace:!0})},Kt=()=>{l(`/cogita/library/${i}/list`,{replace:!0})},st=()=>{se&&l(`/cogita/library/${i}/edit/${encodeURIComponent(se)}`,{replace:!0})},Ue=()=>{const B=oi(i,Nt.map(d=>d.infoId));B&&l(`/cogita/library/${i}/revision/run?libraryTarget=revisions&scope=info-selection&seed=${encodeURIComponent(B)}`)},ft=()=>{const B=ci(i,Nt.map(d=>d.infoId));B&&l(`/cogita/library/${i}/collections/new?draft=${encodeURIComponent(B)}&draftType=info-selection`)},Qt=Nt.length===1?((qt=Nt[0])==null?void 0:qt.infoId)??null:null,Vt=v.selectionCount.replace("{count}",String(Nt.length)),zt=m==="collection"?"grid":m==="detail"?"wide":V,ue=mi(p),$t=Fe?Math.max(0,Math.min(100,Math.round((Fe.score??0)*100))):0,Xt=Fe?pi(Fe,ue):ue.noKnownnessData;return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":zt,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[qe?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:ue.kicker}),e.jsx("h2",{className:"cogita-card-title",children:Ie?fs(Ie.payload,Ie.infoType,Ie.infoId):ue.loading}),Ie?e.jsxs("p",{className:"cogita-card-subtitle",children:[nt(t,Ie.infoType)," · ",Ie.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:Kt,children:ue.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:st,disabled:!se||Te!=="ready",children:v.editInfo})]})]}),Te==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:ue.loading})}):Te==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:ue.loadError})}):Ie?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:ue.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[$t,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${$t}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:Xt})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:ue.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(Fe==null?void 0:Fe.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:ue.correct.replace("{correct}",String((Fe==null?void 0:Fe.correctReviews)??0)).replace("{total}",String((Fe==null?void 0:Fe.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:Fe!=null&&Fe.lastReviewedUtc?`${ue.lastReview}: ${gi(Fe.lastReviewedUtc,p)}`:ue.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:ue.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:Lt}),e.jsx("p",{className:"cogita-library-hint",children:ue.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:ue.checkcards}),E==="loading"?e.jsx("p",{className:"cogita-library-hint",children:ue.loadingCheckcards}):E==="error"?e.jsx("p",{className:"cogita-library-hint",children:ue.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:ue.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(Xe==null?void 0:Xe.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:ue.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(A==null?void 0:A.items.length)??0})]})]})]}),pt.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:ue.approach}),e.jsx("select",{value:ze,onChange:B=>tt(B.target.value),"aria-label":ue.approach,children:pt.map(B=>e.jsx("option",{value:B.approachKey,children:B.label},B.approachKey))})]}),Ce==="loading"?e.jsx("p",{className:"cogita-library-hint",children:ue.loadingApproach}):Ce==="error"?e.jsx("p",{className:"cogita-library-hint",children:ue.loadApproachError}):ot?e.jsx(nn,{value:ot.projection,emptyLabel:ue.empty}):e.jsx("p",{className:"cogita-library-hint",children:ue.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:ue.payload}),e.jsx(nn,{value:Ie.payload,emptyLabel:ue.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:ue.links}),e.jsx(fi,{links:Ie.links,emptyLabel:ue.noLinks})]})]})]}):null]})}):null,_e?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Informacja"}),e.jsx("h2",{className:"cogita-card-title",children:Ie?fs(Ie.payload,Ie.infoType,Ie.infoId):se??""}),e.jsx("p",{className:"cogita-card-subtitle",children:"Collections using this info"})]}),e.jsx("div",{className:"cogita-info-overview-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:Kt,children:"Back to search"})})]}),le==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading collections..."})}):null,le==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load collections."})}):null,le==="ready"&&T.length===0?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"This info is not used in any collection yet."})}):null,le==="ready"&&T.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:T.map(B=>e.jsx("article",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`/#/cogita/library/${i}/collections/${B.collectionId}?libraryTarget=collections`,children:[e.jsx("div",{className:"cogita-card-type",children:"Collection"}),e.jsx("h3",{className:"cogita-card-title",children:B.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[B.itemCount," items"]})]})},B.collectionId))}):null]})}):null,!qe&&!_e?e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":v.typeLabel,value:g,onChange:B=>S(B.target.value),children:de.map(B=>e.jsx("option",{value:B.value,children:B.label},B.value))}),e.jsx("input",{type:"text",value:O,onChange:B=>x(B.target.value),placeholder:v.searchPlaceholder}),e.jsx("select",{"aria-label":v.sortLabel,value:y,onChange:B=>_(B.target.value),children:X.map(B=>e.jsx("option",{value:B.value,children:B.label},B.value))}),e.jsxs("select",{"aria-label":v.viewLabel,value:V,onChange:B=>w(B.target.value),children:[e.jsx("option",{value:"details",children:v.viewDetails}),e.jsx("option",{value:"wide",children:v.viewWide}),e.jsx("option",{value:"grid",children:v.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:v.cardCount.replace("{shown}",String(Ct.length)).replace("{total}",String(wt.length))}),e.jsx("span",{children:q==="loading"?v.loading:v.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>f(B=>!B),children:C?v.hideFilters:v.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:v.filtersOptionalHint})]}),C?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsxs("div",{className:"cogita-filter-grid",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:v.typeLabel}),e.jsx("select",{value:g,onChange:B=>S(B.target.value),children:de.map(B=>e.jsx("option",{value:B.value,children:B.label},`advanced-type:${B.value}`))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Reference"}),e.jsxs("select",{value:W.__referenceId??"",onChange:B=>pe(d=>({...d,__referenceId:B.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),he.map(B=>e.jsx("option",{value:B.infoId,children:B.label},`reference:${B.infoId}`))]})]}),bt.map(B=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:B.label}),B.kind==="select"?e.jsxs("select",{value:W[B.key]??"",onChange:d=>pe(re=>({...re,[B.key]:d.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(B.options??[]).map(d=>e.jsx("option",{value:d.value,children:d.label},`${B.key}:${d.value}`))]}):e.jsx("input",{type:"text",value:W[B.key]??"",onChange:d=>pe(re=>({...re,[B.key]:d.target.value}))})]},`type-filter:${B.key}`))]})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:Vt}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{ye(B=>{const d={...B};for(const re of Ct)d[re.infoId]={infoId:re.infoId,infoType:re.infoType,label:re.label};return d})},disabled:Ct.length===0,children:v.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>ye({}),disabled:Nt.length===0,children:v.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Qt&&yt(Qt),disabled:!Qt,title:Qt?void 0:v.openSelectedDisabled,children:v.openSelected})]})]}),zt==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":v.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:v.detailColumnName}),e.jsx("span",{children:v.detailColumnType}),e.jsx("span",{children:v.detailColumnId}),e.jsx("span",{})]}),Ct.length?Ct.map(B=>{const d=nt(t,B.infoType),re=Et.has(B.infoId),H=Ae===B.infoId;return e.jsxs("div",{className:`cogita-details-row ${H||re?"active":""}`,role:"row",onClick:()=>ee(B.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:re,onChange:Qe=>kt(B,Qe.target.checked),onClick:Qe=>Qe.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:B.label,children:B.label}),e.jsx("span",{title:d,children:d}),e.jsx("span",{title:B.infoId,children:B.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:Qe=>{Qe.stopPropagation(),yt(B.infoId)},"aria-label":v.editInfo,children:">"})]},B.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:v.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${zt}`,"data-view":zt,children:Ct.length?Ct.map(B=>{const d=nt(t,B.infoType),re=Et.has(B.infoId),H=Ae===B.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":H||re,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:re,onChange:Qe=>kt(B,Qe.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>ee(B.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:d}),e.jsx("h3",{className:"cogita-card-title",children:B.label}),e.jsx("p",{className:"cogita-card-subtitle",children:B.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>yt(B.infoId),children:v.editInfo})]})},B.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:v.noMatch})})}),Ot?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>me(B=>B+Ln),children:v.loadMore})}):null,Nt.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:v.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:v.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:ua.map(([B,d])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:nt(t,B)}),e.jsx("span",{className:"cogita-tag-count",children:d})]},`stack:type:${B}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:Ue,disabled:Nt.length===0,children:"Start revision"}),e.jsx("button",{type:"button",className:"ghost",onClick:ft,disabled:Nt.length===0,children:"Create collection from selection"})]})]}):null]}):null]})})})})}function fs(t,n,r){if(t&&typeof t=="object"&&!Array.isArray(t)){const s=t,o=["title","name","label","value","text","quote","term"];for(const h of o){const u=s[h];if(typeof u=="string"&&u.trim())return u.trim()}}return`${n} · ${r}`}function gi(t,n){try{const r=n==="pl"?"pl-PL":n==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(r,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function mi(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function pi(t,n){return t.totalReviews<=0?n.noKnownnessData:t.totalReviews<3||t.score<.35?n.developmentStart:t.totalReviews<8||t.score<.65?n.developmentGrowing:t.score<.85?n.developmentStable:n.developmentStrong}function fi({links:t,emptyLabel:n}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([r,s])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(s)?s.length?e.jsx("div",{className:"cogita-selection-overview",children:s.map(o=>e.jsx("span",{className:"cogita-tag-chip",children:o},`${r}:${o}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):s?e.jsx("span",{className:"cogita-tag-chip",children:s}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},r))})}function nn({value:t,emptyLabel:n}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:n});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((r,s)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(nn,{value:r,emptyLabel:n})})]},s))});if(typeof t=="object"){const r=Object.entries(t);return r.length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:r.map(([s,o])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(nn,{value:o,emptyLabel:n})})]},s))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const Na=5,bs=50,ys=2,xs=[];function Yt({libraryId:t,infoType:n,label:r,placeholder:s,value:o,onChange:h,values:u,onChangeMultiple:j,helperText:p,searchFailedText:k,createFailedText:i,createLabel:m,savingLabel:l,loadMoreLabel:c,allowCreate:v=!0,inputRef:g,autoAdvance:S,onCommit:O,multiple:x}){const y=x?u??xs:xs,[_,V]=a.useState(x?"":(o==null?void 0:o.label)??""),[w,C]=a.useState([]),[f,q]=a.useState(Na),[$,R]=a.useState(-1),[K,Q]=a.useState(!1),[me,Ae]=a.useState(!1),[ee,L]=a.useState(null),ye=a.useRef(0),W=a.useRef(new Map),pe=a.useMemo(()=>v?x?_.trim().length>0:_.trim().length>0&&!o:!1,[v,_,o,x]);a.useEffect(()=>{x||V((o==null?void 0:o.label)??"")},[o,x]),a.useEffect(()=>{const he=_.trim();if(!he||he.length<ys){C([]),Q(!1),q(Na),R(-1),Ae(!1),L(null);return}const ce=he.toLowerCase(),Ie=`${t}:${n}:${ce}`,$e=W.current.get(Ie);if($e){if(x&&y.length>0){const Re=new Set(y.map(et=>et.id));C($e.filter(et=>!Re.has(et.id)))}else C($e);q(Na),R(-1),Q($e.length>0),Ae(!1),L(null);return}const Fe=window.setTimeout(async()=>{const Re=Date.now();ye.current=Re,Ae(!0),L(null);try{const et=await Xn({libraryId:t,type:n,query:he,limit:bs});if(ye.current!==Re)return;const ct=et.slice(0,bs).map(Te=>({id:Te.infoId,label:Te.label,infoType:Te.infoType}));if(W.current.set(Ie,ct),x&&y.length>0){const Te=new Set(y.map(We=>We.id));C(ct.filter(We=>!Te.has(We.id)))}else C(ct);q(Na),R(-1),Q(!0)}catch{if(ye.current!==Re)return;L(k??"Search failed.")}finally{ye.current===Re&&Ae(!1)}},250);return()=>window.clearTimeout(Fe)},[t,n,_,y]);const ae=he=>{if(x){const ce=y.some(Ie=>Ie.id===he.id)?y:[...y,he];j==null||j(ce),V(""),Q(!1),R(-1);return}h==null||h(he),V(he.label),Q(!1),R(-1),S&&(O==null||O())},ke=async()=>{const he=_.trim();if(he){Ae(!0),L(null);try{const ce=await qn({libraryId:t,infoType:n,payload:{label:he}}),Ie={id:ce.infoId,label:he,infoType:ce.infoType};if(he.length>=ys){const $e=`${t}:${n}:${he.toLowerCase()}`,Fe=W.current.get($e)??[];W.current.set($e,[Ie,...Fe])}if(x){j==null||j([...y,Ie]),V(""),Q(!1),R(-1);return}h==null||h(Ie),Q(!1),R(-1),S&&(O==null||O())}catch{L(i??"Create failed.")}finally{Ae(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:r}),e.jsx("input",{value:_,placeholder:s,onChange:he=>{V(he.target.value),!x&&o&&(h==null||h(null))},onKeyDown:he=>{if(he.key==="ArrowDown"){if(he.preventDefault(),!w.length)return;Q(!0),R(ce=>{const Ie=Math.min(w.length,f)-1,$e=ce<0?0:Math.min(ce+1,Ie);return $e===Ie&&w.length>f?(q(Fe=>Math.min(Fe+Na,w.length)),Math.min(ce+1,Math.min(w.length,f+Na)-1)):$e});return}if(he.key==="ArrowUp"){if(he.preventDefault(),!w.length)return;Q(!0),R(ce=>ce<=0?0:ce-1);return}if(he.key==="Enter"){if(he.preventDefault(),$>=0&&w[$]){ae(w[$]);return}if(pe){ke();return}}},onFocus:()=>{w.length>0&&Q(!0)},autoComplete:"off",ref:g})]}),x&&y.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:y.map(he=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>j==null?void 0:j(y.filter(ce=>ce.id!==he.id)),children:[he.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},he.id))}),p&&e.jsx("p",{className:"cogita-help",children:p}),ee&&e.jsx("p",{className:"cogita-error",children:ee}),K&&w.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[w.slice(0,f).map((he,ce)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":ce===$,onClick:()=>ae(he),children:[e.jsx("strong",{children:he.label}),e.jsx("span",{children:he.infoType})]},he.id)),f<w.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>q(he=>Math.min(he+Na,w.length)),children:c??"Load more"})]}),pe&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:ke,disabled:me,children:me?l??"Saving...":m??`Create new ${n}`})]})}const vs=[{id:"gen",la:{abbr:"Gen",name:"Genesis"},en:{abbr:"Gen",name:"Genesis"},de:{abbr:"Gen",name:"Genesis"},pl:{abbr:"Rdz",name:"Księga Rodzaju"}},{id:"ex",la:{abbr:"Ex",name:"Exodus"},en:{abbr:"Ex",name:"Exodus"},de:{abbr:"Ex",name:"Exodus"},pl:{abbr:"Wj",name:"Księga Wyjścia"}},{id:"lev",la:{abbr:"Lev",name:"Leviticus"},en:{abbr:"Lev",name:"Leviticus"},de:{abbr:"Lev",name:"Levitikus"},pl:{abbr:"Kpł",name:"Księga Kapłańska"}},{id:"num",la:{abbr:"Num",name:"Numeri"},en:{abbr:"Num",name:"Numbers"},de:{abbr:"Num",name:"Numeri"},pl:{abbr:"Lb",name:"Księga Liczb"}},{id:"deut",la:{abbr:"Deut",name:"Deuteronomium"},en:{abbr:"Deut",name:"Deuteronomy"},de:{abbr:"Dtn",name:"Deuteronomium"},pl:{abbr:"Pwt",name:"Księga Powtórzonego Prawa"}},{id:"ios",la:{abbr:"Ios",name:"Iosue"},en:{abbr:"Josh",name:"Joshua"},de:{abbr:"Jos",name:"Josua"},pl:{abbr:"Joz",name:"Księga Jozuego"}},{id:"iudg",la:{abbr:"Iudg",name:"Iudicum"},en:{abbr:"Judg",name:"Judges"},de:{abbr:"Ri",name:"Richter"},pl:{abbr:"Sdz",name:"Księga Sędziów"}},{id:"ruth",la:{abbr:"Ruth",name:"Ruth"},en:{abbr:"Ruth",name:"Ruth"},de:{abbr:"Rut",name:"Rut"},pl:{abbr:"Rt",name:"Księga Rut"}},{id:"1sam",la:{abbr:"1 Sam",name:"I Samuelis"},en:{abbr:"1 Sam",name:"1 Samuel"},de:{abbr:"1 Sam",name:"1 Samuel"},pl:{abbr:"1 Sm",name:"1 Księga Samuela"}},{id:"2sam",la:{abbr:"2 Sam",name:"II Samuelis"},en:{abbr:"2 Sam",name:"2 Samuel"},de:{abbr:"2 Sam",name:"2 Samuel"},pl:{abbr:"2 Sm",name:"2 Księga Samuela"}},{id:"1reg",la:{abbr:"1 Reg",name:"I Regum"},en:{abbr:"1 Kgs",name:"1 Kings"},de:{abbr:"1 Kön",name:"1 Könige"},pl:{abbr:"1 Krl",name:"1 Księga Królewska"}},{id:"2reg",la:{abbr:"2 Reg",name:"II Regum"},en:{abbr:"2 Kgs",name:"2 Kings"},de:{abbr:"2 Kön",name:"2 Könige"},pl:{abbr:"2 Krl",name:"2 Księga Królewska"}},{id:"1par",la:{abbr:"1 Par",name:"I Paralipomenon"},en:{abbr:"1 Chr",name:"1 Chronicles"},de:{abbr:"1 Chr",name:"1 Chronik"},pl:{abbr:"1 Krn",name:"1 Księga Kronik"}},{id:"2par",la:{abbr:"2 Par",name:"II Paralipomenon"},en:{abbr:"2 Chr",name:"2 Chronicles"},de:{abbr:"2 Chr",name:"2 Chronik"},pl:{abbr:"2 Krn",name:"2 Księga Kronik"}},{id:"esd",la:{abbr:"Esd",name:"Esdrae"},en:{abbr:"Ezra",name:"Ezra"},de:{abbr:"Esra",name:"Esra"},pl:{abbr:"Ezd",name:"Księga Ezdrasza"}},{id:"neh",la:{abbr:"Neh",name:"Nehemiae"},en:{abbr:"Neh",name:"Nehemiah"},de:{abbr:"Neh",name:"Nehemia"},pl:{abbr:"Ne",name:"Księga Nehemiasza"}},{id:"tob",la:{abbr:"Tob",name:"Tobiae"},en:{abbr:"Tob",name:"Tobit"},de:{abbr:"Tob",name:"Tobit"},pl:{abbr:"Tb",name:"Księga Tobiasza"}},{id:"iudt",la:{abbr:"Iudt",name:"Iudith"},en:{abbr:"Jdt",name:"Judith"},de:{abbr:"Jdt",name:"Judit"},pl:{abbr:"Jdt",name:"Księga Judyty"}},{id:"est",la:{abbr:"Est",name:"Esther"},en:{abbr:"Est",name:"Esther"},de:{abbr:"Est",name:"Ester"},pl:{abbr:"Est",name:"Księga Estery"}},{id:"1macc",la:{abbr:"1 Macc",name:"I Maccabaeorum"},en:{abbr:"1 Mc",name:"1 Maccabees"},de:{abbr:"1 Makk",name:"1 Makkabäer"},pl:{abbr:"1 Mch",name:"1 Księga Machabejska"}},{id:"2macc",la:{abbr:"2 Macc",name:"II Maccabaeorum"},en:{abbr:"2 Mc",name:"2 Maccabees"},de:{abbr:"2 Makk",name:"2 Makkabäer"},pl:{abbr:"2 Mch",name:"2 Księga Machabejska"}},{id:"iob",la:{abbr:"Iob",name:"Iob"},en:{abbr:"Job",name:"Job"},de:{abbr:"Ijob",name:"Ijob"},pl:{abbr:"Hi",name:"Księga Hioba"}},{id:"ps",la:{abbr:"Ps",name:"Psalmi"},en:{abbr:"Ps",name:"Psalms"},de:{abbr:"Ps",name:"Psalmen"},pl:{abbr:"Ps",name:"Księga Psalmów"}},{id:"prov",la:{abbr:"Prov",name:"Proverbia"},en:{abbr:"Prov",name:"Proverbs"},de:{abbr:"Spr",name:"Sprichwörter"},pl:{abbr:"Prz",name:"Księga Przysłów"}},{id:"ecc",la:{abbr:"Ecc",name:"Ecclesiastes"},en:{abbr:"Eccl",name:"Ecclesiastes"},de:{abbr:"Koh",name:"Kohelet"},pl:{abbr:"Koh",name:"Księga Koheleta"}},{id:"cant",la:{abbr:"Cant",name:"Canticum Canticorum"},en:{abbr:"Song",name:"Song of Songs"},de:{abbr:"Hld",name:"Hoheslied"},pl:{abbr:"Pnp",name:"Pieśń nad Pieśniami"}},{id:"sap",la:{abbr:"Sap",name:"Sapientia"},en:{abbr:"Wis",name:"Wisdom"},de:{abbr:"Weish",name:"Weisheit"},pl:{abbr:"Mdr",name:"Księga Mądrości"}},{id:"sir",la:{abbr:"Sir",name:"Ecclesiasticus (Sirach)"},en:{abbr:"Sir",name:"Sirach"},de:{abbr:"Sir",name:"Jesus Sirach"},pl:{abbr:"Syr",name:"Mądrość Syracha"}},{id:"isa",la:{abbr:"Isa",name:"Isaias"},en:{abbr:"Isa",name:"Isaiah"},de:{abbr:"Jes",name:"Jesaja"},pl:{abbr:"Iz",name:"Księga Izajasza"}},{id:"ier",la:{abbr:"Ier",name:"Ieremias"},en:{abbr:"Jer",name:"Jeremiah"},de:{abbr:"Jer",name:"Jeremia"},pl:{abbr:"Jr",name:"Księga Jeremiasza"}},{id:"lam",la:{abbr:"Lam",name:"Lamentationes"},en:{abbr:"Lam",name:"Lamentations"},de:{abbr:"Klgl",name:"Klagelieder"},pl:{abbr:"Lm",name:"Lamentacje"}},{id:"bar",la:{abbr:"Bar",name:"Baruch"},en:{abbr:"Bar",name:"Baruch"},de:{abbr:"Bar",name:"Baruch"},pl:{abbr:"Ba",name:"Księga Barucha"}},{id:"ez",la:{abbr:"Ez",name:"Ezechiel"},en:{abbr:"Ezek",name:"Ezekiel"},de:{abbr:"Ez",name:"Ezechiel"},pl:{abbr:"Ez",name:"Księga Ezechiela"}},{id:"dan",la:{abbr:"Dan",name:"Daniel"},en:{abbr:"Dan",name:"Daniel"},de:{abbr:"Dan",name:"Daniel"},pl:{abbr:"Dn",name:"Księga Daniela"}},{id:"hos",la:{abbr:"Hos",name:"Osee"},en:{abbr:"Hos",name:"Hosea"},de:{abbr:"Hos",name:"Hosea"},pl:{abbr:"Oz",name:"Księga Ozeasza"}},{id:"ioel",la:{abbr:"Ioel",name:"Ioel"},en:{abbr:"Joel",name:"Joel"},de:{abbr:"Joel",name:"Joel"},pl:{abbr:"Jl",name:"Księga Joela"}},{id:"amos",la:{abbr:"Amos",name:"Amos"},en:{abbr:"Am",name:"Amos"},de:{abbr:"Am",name:"Amos"},pl:{abbr:"Am",name:"Księga Amosa"}},{id:"abd",la:{abbr:"Abd",name:"Abdias"},en:{abbr:"Obad",name:"Obadiah"},de:{abbr:"Obd",name:"Obadja"},pl:{abbr:"Abd",name:"Księga Abdiasza"}},{id:"ion",la:{abbr:"Ion",name:"Ionas"},en:{abbr:"Jon",name:"Jonah"},de:{abbr:"Jona",name:"Jona"},pl:{abbr:"Jon",name:"Księga Jonasza"}},{id:"mich",la:{abbr:"Mich",name:"Michaeas"},en:{abbr:"Mic",name:"Micah"},de:{abbr:"Mi",name:"Micha"},pl:{abbr:"Mi",name:"Księga Micheasza"}},{id:"nah",la:{abbr:"Nah",name:"Nahum"},en:{abbr:"Nah",name:"Nahum"},de:{abbr:"Nah",name:"Nahum"},pl:{abbr:"Na",name:"Księga Nahuma"}},{id:"hab",la:{abbr:"Hab",name:"Habacuc"},en:{abbr:"Hab",name:"Habakkuk"},de:{abbr:"Hab",name:"Habakuk"},pl:{abbr:"Ha",name:"Księga Habakuka"}},{id:"soph",la:{abbr:"Soph",name:"Sophonias"},en:{abbr:"Zeph",name:"Zephaniah"},de:{abbr:"Zef",name:"Zefanja"},pl:{abbr:"So",name:"Księga Sofoniasza"}},{id:"agg",la:{abbr:"Agg",name:"Aggaeus"},en:{abbr:"Hag",name:"Haggai"},de:{abbr:"Hag",name:"Haggai"},pl:{abbr:"Ag",name:"Księga Aggeusza"}},{id:"zach",la:{abbr:"Zach",name:"Zacharias"},en:{abbr:"Zech",name:"Zechariah"},de:{abbr:"Sach",name:"Sacharja"},pl:{abbr:"Za",name:"Księga Zachariasza"}},{id:"mal",la:{abbr:"Mal",name:"Malachias"},en:{abbr:"Mal",name:"Malachi"},de:{abbr:"Mal",name:"Maleachi"},pl:{abbr:"Ml",name:"Księga Malachiasza"}},{id:"mt",la:{abbr:"Mt",name:"Matthaeus"},en:{abbr:"Matt",name:"Matthew"},de:{abbr:"Mt",name:"Matthäus"},pl:{abbr:"Mt",name:"Ewangelia wg św. Mateusza"}},{id:"mc",la:{abbr:"Mc",name:"Marcus"},en:{abbr:"Mark",name:"Mark"},de:{abbr:"Mk",name:"Markus"},pl:{abbr:"Mk",name:"Ewangelia wg św. Marka"}},{id:"lc",la:{abbr:"Lc",name:"Lucas"},en:{abbr:"Luke",name:"Luke"},de:{abbr:"Lk",name:"Lukas"},pl:{abbr:"Łk",name:"Ewangelia wg św. Łukasza"}},{id:"io",la:{abbr:"Io",name:"Ioannes"},en:{abbr:"John",name:"John"},de:{abbr:"Joh",name:"Johannes"},pl:{abbr:"J",name:"Ewangelia wg św. Jana"}},{id:"act",la:{abbr:"Act",name:"Actus Apostolorum"},en:{abbr:"Acts",name:"Acts"},de:{abbr:"Apg",name:"Apostelgeschichte"},pl:{abbr:"Dz",name:"Dzieje Apostolskie"}},{id:"rom",la:{abbr:"Rom",name:"ad Romanos"},en:{abbr:"Rom",name:"Romans"},de:{abbr:"Röm",name:"Römer"},pl:{abbr:"Rz",name:"List do Rzymian"}},{id:"1cor",la:{abbr:"1 Cor",name:"I ad Corinthios"},en:{abbr:"1 Cor",name:"1 Corinthians"},de:{abbr:"1 Kor",name:"1 Korinther"},pl:{abbr:"1 Kor",name:"1 List do Koryntian"}},{id:"2cor",la:{abbr:"2 Cor",name:"II ad Corinthios"},en:{abbr:"2 Cor",name:"2 Corinthians"},de:{abbr:"2 Kor",name:"2 Korinther"},pl:{abbr:"2 Kor",name:"2 List do Koryntian"}},{id:"gal",la:{abbr:"Gal",name:"ad Galatas"},en:{abbr:"Gal",name:"Galatians"},de:{abbr:"Gal",name:"Galater"},pl:{abbr:"Ga",name:"List do Galatów"}},{id:"eph",la:{abbr:"Eph",name:"ad Ephesios"},en:{abbr:"Eph",name:"Ephesians"},de:{abbr:"Eph",name:"Epheser"},pl:{abbr:"Ef",name:"List do Efezjan"}},{id:"phil",la:{abbr:"Phil",name:"ad Philippenses"},en:{abbr:"Phil",name:"Philippians"},de:{abbr:"Phil",name:"Philipper"},pl:{abbr:"Flp",name:"List do Filipian"}},{id:"col",la:{abbr:"Col",name:"ad Colossenses"},en:{abbr:"Col",name:"Colossians"},de:{abbr:"Kol",name:"Kolosser"},pl:{abbr:"Kol",name:"List do Kolosan"}},{id:"1thess",la:{abbr:"1 Thess",name:"I ad Thessalonicenses"},en:{abbr:"1 Thess",name:"1 Thessalonians"},de:{abbr:"1 Thess",name:"1 Thessalonicher"},pl:{abbr:"1 Tes",name:"1 List do Tesaloniczan"}},{id:"2thess",la:{abbr:"2 Thess",name:"II ad Thessalonicenses"},en:{abbr:"2 Thess",name:"2 Thessalonians"},de:{abbr:"2 Thess",name:"2 Thessalonicher"},pl:{abbr:"2 Tes",name:"2 List do Tesaloniczan"}},{id:"1tim",la:{abbr:"1 Tim",name:"I ad Timotheum"},en:{abbr:"1 Tim",name:"1 Timothy"},de:{abbr:"1 Tim",name:"1 Timotheus"},pl:{abbr:"1 Tm",name:"1 List do Tymoteusza"}},{id:"2tim",la:{abbr:"2 Tim",name:"II ad Timotheum"},en:{abbr:"2 Tim",name:"2 Timothy"},de:{abbr:"2 Tim",name:"2 Timotheus"},pl:{abbr:"2 Tm",name:"2 List do Tymoteusza"}},{id:"tit",la:{abbr:"Tit",name:"ad Titum"},en:{abbr:"Titus",name:"Titus"},de:{abbr:"Tit",name:"Titus"},pl:{abbr:"Tt",name:"List do Tytusa"}},{id:"phlm",la:{abbr:"Phlm",name:"ad Philemonem"},en:{abbr:"Phlm",name:"Philemon"},de:{abbr:"Phlm",name:"Philemon"},pl:{abbr:"Flm",name:"List do Filemona"}},{id:"heb",la:{abbr:"Heb",name:"ad Hebraeos"},en:{abbr:"Heb",name:"Hebrews"},de:{abbr:"Hebr",name:"Hebräer"},pl:{abbr:"Hbr",name:"List do Hebrajczyków"}},{id:"iac",la:{abbr:"Iac",name:"Iacobi"},en:{abbr:"Jas",name:"James"},de:{abbr:"Jak",name:"Jakobus"},pl:{abbr:"Jk",name:"List św. Jakuba"}},{id:"1pet",la:{abbr:"1 Pet",name:"I Petri"},en:{abbr:"1 Pet",name:"1 Peter"},de:{abbr:"1 Petr",name:"1 Petrus"},pl:{abbr:"1 P",name:"1 List św. Piotra"}},{id:"2pet",la:{abbr:"2 Pet",name:"II Petri"},en:{abbr:"2 Pet",name:"2 Peter"},de:{abbr:"2 Petr",name:"2 Petrus"},pl:{abbr:"2 P",name:"2 List św. Piotra"}},{id:"1io",la:{abbr:"1 Io",name:"I Ioannis"},en:{abbr:"1 John",name:"1 John"},de:{abbr:"1 Joh",name:"1 Johannes"},pl:{abbr:"1 J",name:"1 List św. Jana"}},{id:"2io",la:{abbr:"2 Io",name:"II Ioannis"},en:{abbr:"2 John",name:"2 John"},de:{abbr:"2 Joh",name:"2 Johannes"},pl:{abbr:"2 J",name:"2 List św. Jana"}},{id:"3io",la:{abbr:"3 Io",name:"III Ioannis"},en:{abbr:"3 John",name:"3 John"},de:{abbr:"3 Joh",name:"3 Johannes"},pl:{abbr:"3 J",name:"3 List św. Jana"}},{id:"iud",la:{abbr:"Iud",name:"Iudae"},en:{abbr:"Jude",name:"Jude"},de:{abbr:"Jud",name:"Judas"},pl:{abbr:"Jud",name:"List św. Judy"}},{id:"apoc",la:{abbr:"Apoc",name:"Apocalypsis Ioannis"},en:{abbr:"Rev",name:"Revelation"},de:{abbr:"Offb",name:"Offenbarung"},pl:{abbr:"Ap",name:"Apokalipsa św. Jana"}}],js=8;function ws({libraryId:t,copy:n,language:r,sourceKindOptions:s,value:o,onChange:h,labels:u}){const[j,p]=a.useState(!1),[k,i]=a.useState(-1),m=a.useMemo(()=>{const g=r;return vs.map(S=>{var y;const O=(S==null?void 0:S[g])??(S==null?void 0:S.en)??(S==null?void 0:S.la);return{label:`${O.abbr} — ${O.name}`,latin:((y=S==null?void 0:S.la)==null?void 0:y.abbr)??O.abbr}})},[r]),l=(g,S=!1)=>{const O=g.trim().toLowerCase();return O?m.filter(x=>x.label.toLowerCase().includes(O)).slice(0,js):S?m.slice(0,js):[]},c=(g,S)=>{const O=g.trim().toLowerCase();if(!O)return null;const x=vs;for(const y of x){const _=y==null?void 0:y.la,V=(y==null?void 0:y[S])??(y==null?void 0:y.en)??_,w=(V==null?void 0:V.abbr)??"",C=(V==null?void 0:V.name)??"";if(w.toLowerCase()===O||C.toLowerCase()===O||`${w} — ${C}`.toLowerCase()===O)return{book:y,entry:V,la:_}}return null};a.useEffect(()=>{if(o.sourceKind==="bible"&&o.locatorValue&&!j){const g=c(o.locatorValue,r);if(g){const S=`${g.entry.abbr} — ${g.entry.name}`;S!==o.bibleBookDisplay&&h({...o,bibleBookDisplay:S})}}},[r,o,j,h]);const v=g=>h({...o,...g});return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:u.sourceKindLabel}),e.jsx("select",{value:o.sourceKind,onChange:g=>v({sourceKind:g.target.value,churchDocument:null,bookMedia:null,work:null,locatorValue:"",locatorAux:"",bibleBookDisplay:""}),children:s.map(g=>e.jsx("option",{value:g.value,children:g.label},g.value))})]}),o.sourceKind==="bible"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-lookup full",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:u.bibleBookLabel}),e.jsx("input",{type:"text",value:o.bibleBookDisplay,onChange:g=>{const S=g.target.value;v({bibleBookDisplay:S,locatorValue:""}),p(!0),i(-1)},onKeyDown:g=>{var O;const S=l(o.bibleBookDisplay);if(S.length){if(g.key==="ArrowDown")g.preventDefault(),i(x=>Math.min(x+1,S.length-1));else if(g.key==="ArrowUp")g.preventDefault(),i(x=>Math.max(x-1,0));else if((g.key==="Enter"||g.key==="Tab")&&k>=0&&S[k]){const x=S[k],y=c(x.label,r);if(!y)return;v({bibleBookDisplay:x.label,locatorValue:((O=y.la)==null?void 0:O.abbr)??o.locatorValue}),p(!1)}}},onFocus:()=>p(!0),onBlur:()=>window.setTimeout(()=>p(!1),100),placeholder:u.bibleBookPlaceholder})]}),j&&l(o.bibleBookDisplay,!0).length>0&&e.jsx("div",{className:"cogita-lookup-results",children:l(o.bibleBookDisplay,!0).map((g,S)=>e.jsx("button",{type:"button",className:"cogita-lookup-option","data-active":S===k,tabIndex:-1,onMouseDown:()=>{var x;const O=c(g.label,r);O&&v({bibleBookDisplay:g.label,locatorValue:((x=O.la)==null?void 0:x.abbr)??o.locatorValue})},children:e.jsx("strong",{children:g.label})},g.latin))})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:u.bibleRestLabel}),e.jsx("input",{type:"text",value:o.locatorAux,onChange:g=>v({locatorAux:g.target.value}),placeholder:u.bibleRestPlaceholder})]})]}),o.sourceKind==="website"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceUrlLabel}),e.jsx("input",{type:"text",value:o.sourceUrl,onChange:g=>v({sourceUrl:g.target.value}),placeholder:n.cogita.library.add.info.sourceUrlPlaceholder})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceAccessedDateLabel}),e.jsx("input",{type:"text",value:o.sourceAccessedDate,onChange:g=>v({sourceAccessedDate:g.target.value}),placeholder:n.cogita.library.add.info.sourceAccessedDatePlaceholder})]})]}),o.sourceKind==="number_document"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:t,infoType:"work",label:u.churchDocumentLabel,placeholder:u.churchDocumentPlaceholder,value:o.churchDocument,onChange:g=>v({churchDocument:g}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:u.locatorLabel}),e.jsx("input",{type:"text",value:o.locatorValue,onChange:g=>v({locatorValue:g.target.value}),placeholder:u.locatorPlaceholder})]})]}),o.sourceKind==="work"&&e.jsx(Yt,{libraryId:t,infoType:"work",label:u.workLabel,placeholder:u.workPlaceholder,value:o.work,onChange:g=>v({work:g}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),o.sourceKind==="book"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:t,infoType:"media",label:u.bookLabel,placeholder:u.bookPlaceholder,value:o.bookMedia,onChange:g=>v({bookMedia:g}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.media),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:u.locatorLabel}),e.jsx("input",{type:"text",value:o.locatorValue,onChange:g=>v({locatorValue:g.target.value}),placeholder:u.locatorPlaceholder})]})]}),o.sourceKind!=="website"&&o.sourceKind!=="bible"&&o.sourceKind!=="book"&&o.sourceKind!=="number_document"&&e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:u.locatorLabel}),e.jsx("input",{type:"text",value:o.locatorValue,onChange:g=>v({locatorValue:g.target.value}),placeholder:u.locatorPlaceholder})]})]})}const _a=JSON.stringify({type:"selection",title:"Question title",question:"Question text",options:["Option A","Option B","Option C"],answer:[0]},null,2);function Ya(t="selection"){return t==="matching"?{type:t,title:"",question:"",columns:[[""],[""]],answer:{paths:[]},matchingPaths:[["",""]]}:t==="ordering"?{type:t,title:"",question:"",options:[""]}:t==="truefalse"?{type:t,title:"",question:"",answer:!0}:t==="text"||t==="date"?{type:t,title:"",question:"",answer:""}:t==="number"?{type:t,title:"",question:"",answer:""}:{type:t,title:"",question:"",options:[""],answer:[]}}function bi(t){return["selection","truefalse","text","number","date","matching","ordering"].includes(t)}function Da(t){if(!t||typeof t!="object")return null;const n=t,r=typeof n.type=="string"?n.type:typeof n.kind=="string"?n.kind:"selection",s=r==="multi_select"||r==="single_select"?"selection":r==="boolean"?"truefalse":r==="order"?"ordering":r,o=bi(s)?s:"selection",h=typeof n.title=="string"?n.title:"",u=typeof n.question=="string"?n.question:"";if(o==="matching"){let k=[];Array.isArray(n.columns)?k=n.columns.map(g=>Array.isArray(g)?g.map(S=>typeof S=="string"?S:""):[""]):Array.isArray(n.left)&&Array.isArray(n.right)&&(k=[n.left.map(g=>typeof g=="string"?g:""),n.right.map(g=>typeof g=="string"?g:"")]),k.length<2&&(k=[[""],[""]]);const i=n.answer&&typeof n.answer=="object"?n.answer:null,l=(Array.isArray(i==null?void 0:i.paths)?i==null?void 0:i.paths:Array.isArray(n.correctPairs)?n.correctPairs:[]).map(g=>Array.isArray(g)?g.map(S=>Number(S)).filter(S=>Number.isInteger(S)&&S>=0):[]).filter(g=>g.length>0),c=Array.isArray(n.matchingPaths)?n.matchingPaths.map(g=>Array.isArray(g)?Array.from({length:k.length},(S,O)=>String(g[O]??"")):new Array(k.length).fill("")):null,v=c&&c.length>0?c:[...l.map(g=>g.map(String)),new Array(k.length).fill("")];return{type:o,title:h,question:u,columns:k,answer:{paths:l},matchingPaths:v}}if(o==="ordering"){const k=Array.isArray(n.options)?n.options.map(i=>typeof i=="string"?i:""):Array.isArray(n.items)?n.items.map(i=>typeof i=="string"?i:""):[""];return{type:o,title:h,question:u,options:k.length?k:[""]}}if(o==="truefalse"){const k=typeof n.answer=="boolean"?n.answer:typeof n.expected=="boolean"?n.expected:!0;return{type:o,title:h,question:u,answer:k}}if(o==="number")return typeof n.answer=="number"?{type:o,title:h,question:u,answer:n.answer}:typeof n.answer=="string"?{type:o,title:h,question:u,answer:n.answer}:typeof n.expected=="number"?{type:o,title:h,question:u,answer:n.expected}:{type:o,title:h,question:u,answer:""};if(o==="text"||o==="date"){const k=typeof n.answer=="string"?n.answer:typeof n.expected=="string"?n.expected:"";return{type:o,title:h,question:u,answer:k}}const j=Array.isArray(n.options)?n.options.map(k=>typeof k=="string"?k:""):[""],p=Array.isArray(n.answer)?n.answer.map(k=>Number(k)).filter(k=>Number.isInteger(k)&&k>=0):Array.isArray(n.correct)?n.correct.map(k=>Number(k)).filter(k=>Number.isInteger(k)&&k>=0):[];return{type:o,title:h,question:u,options:j.length?j:[""],answer:p}}function yi(t){const n=(t.title??"").trim(),r=(t.question??"").trim();switch(t.type){case"matching":{const s=(t.columns??[[""],[""]]).map(m=>m.map(l=>l.trim()).filter(Boolean)).filter(m=>m.length>0),o=s.length>=2?s:[[""],[""]],h=t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[],u=(t.matchingPaths??[]).map(m=>m.map(l=>String(l??""))),j=o.length,p=u.map(m=>m.slice(0,j).map(l=>l.trim())).filter(m=>m.some(Boolean)).map(m=>m.map(l=>Number(l))).filter(m=>m.length===j&&m.every(l=>Number.isInteger(l)&&l>=0)),k=(Array.isArray(h)?h:[]).map(m=>Array.isArray(m)?m.map(l=>Number(l)).filter(l=>Number.isInteger(l)&&l>=0):[]).filter(m=>m.length===j),i=Array.from(new Set([...k,...p].map(m=>JSON.stringify(m)))).map(m=>JSON.parse(m));return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,columns:o,answer:{paths:i}},null,2)}case"ordering":{const s=(t.options??[]).map(o=>o.trim()).filter(Boolean);return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,options:s},null,2)}case"truefalse":return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,answer:!!t.answer},null,2);case"number":return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,answer:typeof t.answer=="number"||typeof t.answer=="string"?t.answer:""},null,2);case"date":case"text":return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,answer:String(t.answer??"")},null,2);case"selection":default:{const s=(t.options??[]).map(u=>u.trim()).filter(Boolean),o=Array.isArray(t.answer)?t.answer:[],h=Array.from(new Set(o.filter(u=>Number.isInteger(u)&&u>=0&&u<s.length))).sort((u,j)=>u-j);return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,options:s,answer:h},null,2)}}}const ks=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}];function Ba(){return{sourceKind:"string",locatorValue:"",locatorAux:"",bibleBookDisplay:"",sourceUrl:"",sourceAccessedDate:"",churchDocument:null,bookMedia:null,work:null}}function Ns(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function Ss(t,n){if(!t||typeof t!="object")return n;const r=t,s=r.definition&&typeof r.definition=="object"?r.definition:null,o=[r.label,r.name,r.title,r.text,r.orcid,r.email,r.number];s&&o.unshift(s.title,s.question);for(const h of o)if(typeof h=="string"&&h.trim())return h.trim();return n}function Ts(t,n){var s;if(!(t instanceof Us))return n;const r=(s=t.message)==null?void 0:s.trim();if(!r)return n;try{const o=JSON.parse(r);if(typeof o.error=="string"&&o.error.trim())return o.error.trim()}catch{}return r}function xi(t){const n=t.trim();if(!n)return null;try{const r=JSON.parse(n);return r&&typeof r=="object"&&!Array.isArray(r)?r:null}catch{return null}}function ra(t,n){const r=t==null?void 0:t[n];return typeof r=="string"?r:""}function vi(t,n){return n?t==="book"&&n.infoType==="media"?{bookMedia:n}:t==="work"&&n.infoType==="work"?{work:n}:t==="number_document"&&n.infoType==="work"?{churchDocument:n}:{}:{}}function ji(t,n){const r=Ba(),s=(t.sourceKind??"").trim()||r.sourceKind,o=t.locator??"",h=xi(o);let u="",j="",p="",k="",i="";return s==="website"?(k=ra(h,"url"),i=ra(h,"accessedDate"),u=ra(h,"value")):s==="bible"?(u=ra(h,"book")||o.trim(),j=ra(h,"passage")||ra(h,"rest"),p=ra(h,"bookDisplay")):h?(u=ra(h,"value")||ra(h,"locator"),j=ra(h,"aux")):u=o,{...r,sourceKind:s,locatorValue:u,locatorAux:j,bibleBookDisplay:p,sourceUrl:k,sourceAccessedDate:i,...vi(s,n)}}function An(t){return t.sourceKind==="book"?t.bookMedia:t.sourceKind==="work"?t.work:t.sourceKind==="number_document"?t.churchDocument:null}function $n(t){const n=t.locatorValue.trim(),r=t.locatorAux.trim(),s=t.sourceUrl.trim(),o=t.sourceAccessedDate.trim();switch(t.sourceKind){case"website":return{url:s,accessedDate:o};case"bible":return{book:n,bookDisplay:t.bibleBookDisplay.trim(),passage:r};case"book":case"work":case"number_document":return r?{value:n,aux:r}:n;default:return r?{value:n,aux:r}:n}}function Cs(t){var o,h,u;const n=t.locatorValue.trim(),r=t.locatorAux.trim(),s=[n,r].filter(Boolean).join(" ");switch(t.sourceKind){case"website":return t.sourceUrl.trim()||"website";case"bible":return s||"bible";case"book":return[(o=t.bookMedia)==null?void 0:o.label,s].filter(Boolean).join(" · ")||"book";case"work":return[(h=t.work)==null?void 0:h.label,s].filter(Boolean).join(" · ")||"work";case"number_document":return[(u=t.churchDocument)==null?void 0:u.label,s].filter(Boolean).join(" · ")||"number_document";default:return s||t.sourceKind||"source"}}function Is(t){return t.sourceKind.trim()?t.sourceKind==="website"?!!t.sourceUrl.trim():t.sourceKind==="bible"?!!(t.locatorValue.trim()&&t.locatorAux.trim()):t.sourceKind==="book"?!!t.bookMedia:t.sourceKind==="work"?!!t.work:t.sourceKind==="number_document"?!!(t.churchDocument&&t.locatorValue.trim()):!!t.locatorValue.trim():!1}function wi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,libraryId:i,editInfoId:m}){var Ce,Be,Xe;const{libraryName:l}=da(i),c=!!m,[v,g]=a.useState([]),[S,O]=a.useState("word"),[x,y]=a.useState({}),[_,V]=a.useState({}),[w,C]=a.useState({}),[f,q]=a.useState({}),[$,R]=a.useState(null),[K,Q]=a.useState("idle"),[me,Ae]=a.useState(Ba),[ee,L]=a.useState({}),[ye,W]=a.useState({}),[pe,ae]=a.useState({}),[ke,he]=a.useState(null),[ce,Ie]=a.useState(()=>Da(JSON.parse(_a))??Ya()),[$e,Fe]=a.useState(_a),Re=a.useMemo(()=>v.find(F=>F.infoType===S),[S,v]),et=a.useMemo(()=>v.find(F=>F.infoType==="source"),[v]),ct=a.useMemo(()=>v.map(F=>({value:F.infoType,label:nt(t,F.infoType)})),[t,v]),Te=F=>{const A=Da(F)??Ya(),D=yi(A);Ie(A),y(E=>({...E,definition:D}))};a.useEffect(()=>{let F=!1;return fr({libraryId:i}).then(A=>{var D;if(!F&&(g(A),!c)){const E=(D=A[0])==null?void 0:D.infoType;E&&O(E)}}).catch(()=>{F||g([])}),()=>{F=!0}},[c,i]),a.useEffect(()=>{if(c||!Re)return;const F={},A={},D={},E={};for(const N of Re.payloadFields)Re.infoType==="question"&&N.key==="definition"&&N.inputType==="json"?F[N.key]=_a:F[N.key]="";for(const N of Re.linkFields)N.multiple?D[N.key]=[]:A[N.key]=null,N.targetTypes.length>0&&(E[N.key]=N.targetTypes[0]);y(F),V(A),C(D),q(E)},[Re==null?void 0:Re.infoType,c]),a.useEffect(()=>{if(S!=="question")return;const F=x.definition??"";if(!F.trim()){const A=Da(JSON.parse(_a))??Ya();Ie(A),Fe(_a);return}try{const A=JSON.parse(F),D=Da(A);if(!D)return;Ie(D),Fe(JSON.stringify(A,null,2))}catch{}},[x.definition,S]),a.useEffect(()=>{if(!c||!m||v.length===0)return;let F=!1;return Q("loading"),R(null),(async()=>{const D=await na({libraryId:i,infoId:m});if(F)return;const E=D.infoType;O(E);const N=v.find(Y=>Y.infoType===E);if(!N){Q("idle");return}const T=D.payload??{},M={};for(const Y of N.payloadFields)M[Y.key]=Ns(T[Y.key]);y(M);const le=D.links??{}??{},be={},de={},X={},P=[];for(const Y of N.linkFields){Y.targetTypes.length>0&&(X[Y.key]=Y.targetTypes[0]);const ne=le[Y.key];if(Y.multiple){const G=Array.isArray(ne)?ne.filter(Z=>typeof Z=="string"):[];de[Y.key]=[];for(const Z of G)P.push(na({libraryId:i,infoId:Z}).then(xe=>{if(F)return;const U={id:Z,infoType:xe.infoType,label:Ss(xe.payload,Z)};X[Y.key]=U.infoType,de[Y.key]=[...de[Y.key],U]}).catch(()=>{}))}else{const G=typeof ne=="string"?ne:null;be[Y.key]=null,G&&P.push(na({libraryId:i,infoId:G}).then(Z=>{if(F)return;const xe={id:G,infoType:Z.infoType,label:Ss(Z.payload,G)};X[Y.key]=xe.infoType,be[Y.key]=xe}).catch(()=>{}))}}await Promise.all(P),!F&&(V(be),C(de),q(X),Q("idle"))})().catch(()=>{F||(R("Failed to load info details."),Q("idle"))}),()=>{F=!0}},[m,c,i,v]),a.useEffect(()=>{S==="source"&&Ae(ji(x,_.resource??null))},[S,x.sourceKind,x.locator,(Ce=_.resource)==null?void 0:Ce.id,(Be=_.resource)==null?void 0:Be.infoType,(Xe=_.resource)==null?void 0:Xe.label]);const We=F=>{var N,T;const A=((N=et==null?void 0:et.payloadFields.find(M=>M.key==="sourceKind"))==null?void 0:N.keepOnCreate)??!1,D=((T=et==null?void 0:et.linkFields.find(M=>M.key==="resource"))==null?void 0:T.keepOnCreate)??!1,E=Ba();return E.sourceKind=A?F.sourceKind:E.sourceKind,D&&(E.work=F.work,E.bookMedia=F.bookMedia,E.churchDocument=F.churchDocument),A&&F.sourceKind==="bible"&&(E.locatorValue=F.locatorValue,E.bibleBookDisplay=F.bibleBookDisplay),A&&F.sourceKind==="website"&&(E.sourceUrl=F.sourceUrl,E.sourceAccessedDate=F.sourceAccessedDate),E},xt=a.useMemo(()=>({sourceKindLabel:t.cogita.library.add.info.sourceKindLabel,bibleBookLabel:t.cogita.library.add.info.sourceBibleBookLabel,bibleBookPlaceholder:t.cogita.library.add.info.sourceBibleBookPlaceholder,bibleRestLabel:t.cogita.library.add.info.sourceBibleRestLabel,bibleRestPlaceholder:t.cogita.library.add.info.sourceBibleRestPlaceholder,churchDocumentLabel:t.cogita.library.add.info.sourceResourceLabel,churchDocumentPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,workLabel:t.cogita.library.add.info.sourceResourceLabel,workPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,bookLabel:t.cogita.library.add.info.sourceResourceLabel,bookPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,locatorLabel:t.cogita.library.list.typeFilterLocator,locatorPlaceholder:t.cogita.library.list.typeFilterLocator}),[t]),Ve=async F=>{const A=ye[F]??Ba();if(!Is(A)){ae(D=>({...D,[F]:t.cogita.library.add.info.referenceMissingSource}));return}he(F),ae(D=>({...D,[F]:null}));try{const D=An(A),E=D?{resource:D.id}:{},N={label:Cs(A),sourceKind:A.sourceKind.trim(),locator:$n(A)},M={id:(await qn({libraryId:i,infoType:"source",payload:N,links:E})).infoId,infoType:"source",label:N.label};if(C(le=>{const be=le[F]??[];return be.some(de=>de.id===M.id)?le:{...le,[F]:[...be,M]}}),c&&m){const le=await na({libraryId:i,infoId:m}),be=le.links&&typeof le.links=="object"?{...le.links}:{},de=be[F],X=Array.isArray(de)?de.filter(P=>typeof P=="string"):typeof de=="string"?[de]:[];X.includes(M.id)||(be[F]=[...X,M.id],await cs({libraryId:i,infoId:m,payload:le.payload,links:be}))}W(le=>({...le,[F]:We(A)})),ae(le=>({...le,[F]:null}))}catch(D){ae(E=>({...E,[F]:Ts(D,t.cogita.library.lookup.createFailed)}))}finally{he(D=>D===F?null:D)}},ze=async()=>{var D;if(!Re)return;const F={};for(const E of Re.payloadFields){if(S==="source"&&(E.key==="sourceKind"||E.key==="locator"))continue;const N=(x[E.key]??"").trim();if(!N){if(E.required){R(`Field '${E.label}' is required.`);return}continue}if(E.inputType==="json")try{F[E.key]=JSON.parse(N)}catch{R(`Field '${E.label}' must be valid JSON.`);return}else F[E.key]=N}const A={};for(const E of Re.linkFields)if(!(S==="source"&&E.key==="resource"))if(E.multiple){const N=(w[E.key]??[]).map(T=>T.id);if(E.required&&N.length===0){R(`Link '${E.label}' is required.`);return}N.length>0&&(A[E.key]=N)}else{const N=((D=_[E.key])==null?void 0:D.id)??null;if(E.required&&!N){R(`Link '${E.label}' is required.`);return}N&&(A[E.key]=N)}if(S==="source"){if(!Is(me)){R(t.cogita.library.add.info.referenceMissingSource);return}const E=me.sourceKind.trim();F.sourceKind=E,F.locator=$n(me),(typeof F.label!="string"||!F.label.trim())&&(F.label=Cs(me));const N=An(me);N&&(A.resource=N.id)}Q("saving"),R(null);try{if(c&&m)await cs({libraryId:i,infoId:m,payload:F,links:A}),R("Info updated.");else{await qn({libraryId:i,infoType:S,payload:F,links:A}),R("Info saved.");const E={};for(const M of Re.payloadFields)E[M.key]=M.keepOnCreate?x[M.key]??"":"";y(E);const N={},T={};for(const M of Re.linkFields)M.multiple?T[M.key]=M.keepOnCreate?w[M.key]??[]:[]:N[M.key]=M.keepOnCreate?_[M.key]??null:null;V(M=>({...M,...N})),C(M=>({...M,...T})),S==="source"&&Ae(M=>{const le=We(M),be=An(le);return y(de=>({...de,sourceKind:le.sourceKind,locator:Ns($n(le))})),V(de=>({...de,resource:be})),be&&q(de=>({...de,resource:be.infoType})),le})}}catch(E){R(Ts(E,"Failed to save info."))}finally{Q("idle")}},tt=F=>{const A=x[F.key]??"";if(S==="question"&&F.key==="definition"&&F.inputType==="json"){const E=ce.type,N=P=>{const Y=ce.title??"",ne=ce.question??"";Te({...Ya(P),title:Y,question:ne})},T=P=>P.length===0?[""]:P[P.length-1].trim()?[...P,""]:P,M=P=>{const Y=(P.length?P:[[""],[""]]).map(ne=>T(ne));return Y.length>=2?Y:[...Y,[""]]},le=(P,Y)=>{const ne=P.map(Z=>Array.from({length:Y},(xe,U)=>Z[U]??"")).filter(Z=>Z.some(xe=>xe.trim())||Z===P[P.length-1]);return ne.length===0?[new Array(Y).fill("")]:ne[ne.length-1].some(Z=>Z.trim())?[...ne,new Array(Y).fill("")]:ne},be=Array.isArray(ce.answer)?ce.answer:[],de=M(ce.columns??[[""],[""]]),X=le(ce.matchingPaths??[[]],de.length);return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:F.label}),e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.8rem"},children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question type"}),e.jsxs("select",{value:E,onChange:P=>N(P.target.value),children:[e.jsx("option",{value:"selection",children:"Selection"}),e.jsx("option",{value:"truefalse",children:"True / false"}),e.jsx("option",{value:"text",children:"Text answer"}),e.jsx("option",{value:"number",children:"Number answer"}),e.jsx("option",{value:"date",children:"Date answer"}),e.jsx("option",{value:"matching",children:"Matching"}),e.jsx("option",{value:"ordering",children:"Right order"})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Title"}),e.jsx("input",{type:"text",value:ce.title??"",onChange:P=>Te({...ce,title:P.target.value}),placeholder:"Optional title"})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question"}),e.jsx("textarea",{rows:3,value:ce.question??"",onChange:P=>Te({...ce,question:P.target.value}),placeholder:"Question text"})]}),E==="selection"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Options / correct indices"}),T(ce.options??[""]).map((P,Y,ne)=>{const G=new Set(be.filter(xe=>Number.isInteger(xe))),Z=Y===ne.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:G.has(Y),disabled:!P.trim(),onChange:xe=>{const U=xe.target.checked?[...G,Y]:[...G].filter(se=>se!==Y);Te({...ce,answer:U})}}),e.jsx("input",{type:"text",value:P,placeholder:`Answer ${Y+1}`,onChange:xe=>{const U=[...ce.options??[""]];U[Y]=xe.target.value;const se=T(U),Le=se.length-1,qe=be.filter(_e=>_e>=0&&_e<Le);Te({...ce,options:se,answer:qe})}}),Z?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const U=(ce.options??[""]).filter((Le,qe)=>qe!==Y),se=be.filter(Le=>Le!==Y).map(Le=>Le>Y?Le-1:Le);Te({...ce,options:T(U),answer:se})},children:"Remove"})]},`question-option:${Y}`)})]}):null,E==="text"||E==="date"||E==="number"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsx("input",{type:E==="date"?"date":"text",value:typeof ce.answer=="string"||typeof ce.answer=="number"?String(ce.answer):"",onChange:P=>Te({...ce,answer:P.target.value})})]}):null,E==="truefalse"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsxs("select",{value:String(!!ce.answer),onChange:P=>Te({...ce,answer:P.target.value==="true"}),children:[e.jsx("option",{value:"true",children:"True"}),e.jsx("option",{value:"false",children:"False"})]})]}):null,E==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Columns"}),de.map((P,Y)=>e.jsxs("div",{style:{display:"grid",gap:"0.35rem",border:"1px solid rgba(120,170,220,0.22)",borderRadius:"0.6rem",padding:"0.55rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"0.5rem"},children:[e.jsxs("span",{style:{fontSize:"0.8rem",color:"rgba(184,209,234,0.85)"},children:["Column ",Y+1]}),de.length>2?e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const ne=de.filter((Z,xe)=>xe!==Y),G=X.map(Z=>Z.filter((xe,U)=>U!==Y));Te({...ce,columns:M(ne),matchingPaths:le(G,Math.max(2,ne.length))})},children:"Remove column"}):null]}),P.map((ne,G)=>{const Z=G===P.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",gap:"0.4rem",alignItems:"center"},children:[e.jsx("input",{type:"text",value:ne,placeholder:`Option ${G+1}`,onChange:xe=>{const U=de.map(se=>[...se]);U[Y][G]=xe.target.value,Te({...ce,columns:M(U),matchingPaths:le(X,de.length)})}}),Z?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const xe=de.map(U=>[...U]);xe[Y]=xe[Y].filter((U,se)=>se!==G),Te({...ce,columns:M(xe),matchingPaths:le(X,de.length)})},children:"Remove"})]},`question-column:${Y}:row:${G}`)})]},`question-column:${Y}`)),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{const P=[...de.map(ne=>[...ne]),[""]],Y=X.map(ne=>[...ne,""]);Te({...ce,columns:M(P),matchingPaths:le(Y,P.length)})},children:"Add column"})}),e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Correct paths (0-based indices)"}),X.map((P,Y)=>{const ne=Y===X.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:`repeat(${de.length}, minmax(0,1fr)) auto`,gap:"0.35rem",alignItems:"center"},children:[P.map((G,Z)=>e.jsx("input",{type:"number",min:0,step:1,value:G,placeholder:`${Z}`,onChange:xe=>{const U=X.map(qe=>[...qe]);U[Y][Z]=xe.target.value;const se=le(U,de.length),Le=se.map(qe=>qe.map(_e=>_e.trim())).filter(qe=>qe.every(_e=>_e!=="")).map(qe=>qe.map(_e=>Number(_e))).filter(qe=>qe.every(_e=>Number.isInteger(_e)&&_e>=0));Te({...ce,matchingPaths:se,answer:{paths:Le}})}},`question-path:${Y}:${Z}`)),ne?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const G=X.filter((U,se)=>se!==Y),Z=le(G,de.length),xe=Z.map(U=>U.map(se=>se.trim())).filter(U=>U.every(se=>se!=="")).map(U=>U.map(se=>Number(se))).filter(U=>U.every(se=>Number.isInteger(se)&&se>=0));Te({...ce,matchingPaths:Z,answer:{paths:xe}})},children:"Remove"})]},`question-path:${Y}`)})]}):null,E==="ordering"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Ordered options (correct order = listed order)"}),T(ce.options??[""]).map((P,Y,ne)=>{const G=Y===ne.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)",minWidth:"1.5rem"},children:[Y+1,"."]}),e.jsx("input",{type:"text",value:P,placeholder:`Step ${Y+1}`,onChange:Z=>{const xe=[...ce.options??[""]];xe[Y]=Z.target.value,Te({...ce,options:T(xe)})}}),G?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>Te({...ce,options:T((ce.options??[]).filter((Z,xe)=>xe!==Y))}),children:"Remove"})]},`question-order:${Y}`)})]}):null,e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"JSON import"}),e.jsx("textarea",{rows:8,value:$e,onChange:P=>Fe(P.target.value),placeholder:"Paste question JSON"}),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{try{const P=JSON.parse($e),Y=Da(P);if(!Y){R("Question JSON must be an object.");return}Te(Y),R(null)}catch{R("Question JSON is invalid.")}},children:"Interpret JSON"})})]})]})]},`payload:${F.key}`)}const D=F.inputType==="textarea"||F.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:F.label}),D?e.jsx("textarea",{rows:F.inputType==="json"?8:4,value:A,onChange:E=>y(N=>({...N,[F.key]:E.target.value})),placeholder:F.key}):e.jsx("input",{type:"text",value:A,onChange:E=>y(N=>({...N,[F.key]:E.target.value})),placeholder:F.key})]},`payload:${F.key}`)},ot=F=>{const A=f[F.key]??F.targetTypes[0],D=F.key==="references"&&F.multiple&&F.targetTypes.includes("source"),E=ye[F.key]??Ba(),N=ee[F.key]??!1,T=pe[F.key];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:F.label}),F.targetTypes.length>1?e.jsx("select",{value:A,onChange:M=>q(le=>({...le,[F.key]:M.target.value})),children:F.targetTypes.map(M=>e.jsx("option",{value:M,children:nt(t,M)},`${F.key}:${M}`))}):null,F.multiple?e.jsx(Yt,{libraryId:i,infoType:A,label:F.label,placeholder:F.key,multiple:!0,values:w[F.key]??[],onChangeMultiple:M=>C(le=>({...le,[F.key]:M})),allowCreate:!D,searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(Yt,{libraryId:i,infoType:A,label:F.label,placeholder:F.key,value:_[F.key]??null,onChange:M=>V(le=>({...le,[F.key]:M})),searchFailedText:"Search failed",createFailedText:"Create failed"}),D?e.jsxs("div",{children:[e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:N,onChange:M=>L(le=>({...le,[F.key]:M.target.checked}))}),e.jsx("span",{children:t.cogita.library.add.info.referenceToggle})]}),N?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(ws,{libraryId:i,copy:t,language:p,sourceKindOptions:[...ks],value:E,onChange:M=>W(le=>({...le,[F.key]:M})),labels:xt}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>Ve(F.key),disabled:ke===F.key,children:ke===F.key?t.cogita.library.lookup.saving:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.source)})}),T?e.jsx("p",{className:"cogita-library-subtitle",children:T}):null]}):null]}):null]},`link:${F.key}`)},Ye=()=>e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(ws,{libraryId:i,copy:t,language:p,sourceKindOptions:[...ks],value:me,onChange:Ae,labels:xt})]});return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:c?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${i}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[c?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:S,onChange:F=>O(F.target.value),children:ct.map(F=>e.jsx("option",{value:F.value,children:F.label},F.value))})]}),K==="loading"&&c?e.jsx("p",{children:"Loading..."}):null,Re&&!(K==="loading"&&c)?e.jsxs("div",{className:"cogita-form-grid",children:[Re.payloadFields.filter(F=>!(S==="source"&&(F.key==="sourceKind"||F.key==="locator"))).map(tt),S==="source"?Ye():null,Re.linkFields.filter(F=>!(S==="source"&&F.key==="resource")).map(ot)]}):K==="loading"&&c?null:e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:ze,disabled:K==="saving"||!Re,children:K==="saving"?"Saving...":c?"Update info":"Create info"})}),$?e.jsx("p",{className:"cogita-library-subtitle",children:$}):null]})})})]})})}const Ms=t=>/\s/.test(t),sn=t=>/[\p{L}\p{N}]/u.test(t),Ls=(t,n)=>{const r=n>0?t[n-1]:"",s=n<t.length?t[n]:"";if(!r||!s)return 0;const o=Ms(r),h=Ms(s);if(o||h)return 3;const u=sn(r),j=sn(s);return u!==j?2:!u&&!j?1:0},Rn=(t,n,r,s,o)=>{const h=Math.max(s-n,r-s);for(let u=0;u<=h;u+=1){const j=s-u;if(j>=n&&j<=r&&Ls(t,j)>=o)return j;const p=s+u;if(p>=n&&p<=r&&Ls(t,p)>=o)return p}return null},Pn=(t,n)=>{const r=n>0?t[n-1]:"",s=n<t.length?t[n]:"";return!r||!s?!0:sn(r)!==sn(s)},ki=(t,n,r,s)=>{const o=r-n,h=n+s,u=r-s;if(o<=s*2||u<=h)return null;const j=Math.floor((n+r)/2),p=Rn(t,h,u,j,3);if(p!==null&&Pn(t,p))return p;const k=Rn(t,h,u,j,2);if(k!==null&&Pn(t,k))return k;const i=Rn(t,h,u,j,1);return i!==null&&Pn(t,i)?i:null},va=(t,n)=>{const r=Math.max(1,(n==null?void 0:n.minLen)??7),s=Math.max(r,(n==null?void 0:n.maxLen)??13),o={},h=(p,k,i,m,l)=>{const c=String(m),v={id:c,start:p,end:k,text:t.slice(p,k),depth:i,index:m,parentId:l};if(o[c]=v,k-p>s){let S=ki(t,p,k,r);if(S!==null&&S>p&&S<k){const O=h(p,S,i+1,m*2+1,c),x=h(S,k,i+1,m*2+2,c);v.leftId=O.id,v.rightId=x.id}}return v},u=h(0,t.length,0,0),j=Object.values(o).sort((p,k)=>k.depth-p.depth||p.start-k.start).map(p=>p.id);return{text:t,rootId:u.id,nodes:o,order:j}},$a=(t,n,r,s,o,h,u)=>{const j=h==="reverse"?t.order.slice().sort((p,k)=>t.nodes[k].start-t.nodes[p].start||t.nodes[k].depth-t.nodes[p].depth):t.order;for(const p of j){if(u&&p===u||n.has(p))continue;const k=t.nodes[p];if(k){if(o&&(k.leftId||k.rightId)){const i=k.leftId?r[k.leftId]??0:s,m=k.rightId?r[k.rightId]??0:s;if((i+m)/2<s)continue}return k}}return null},xn=(t,n)=>({before:t.slice(0,n.start),fragment:t.slice(n.start,n.end),after:t.slice(n.end)});function Ni({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,libraryId:i}){const m=`/#/cogita/library/${i}`,[l,c,v]=Hn([]),[g,S,O]=Wn([]),[x,y]=a.useState(null),[_,V]=a.useState(null),[w,C]=a.useState(null),[f,q]=a.useState(null),$=a.useMemo(()=>l.find(L=>L.id===x)??null,[l,x]);a.useEffect(()=>{let L=!0;return br({libraryId:i}).then(ye=>{if(!L)return;const W=ye.nodes.map(pe=>{var ae,ke,he;return{id:pe.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:pe.payload&&typeof pe.payload=="object"&&"label"in pe.payload?String(pe.payload.label):"Item",nodeType:pe.nodeType,itemType:((ae=pe.payload)==null?void 0:ae.itemType)??"info",itemId:((ke=pe.payload)==null?void 0:ke.itemId)??null,infoType:((he=pe.payload)==null?void 0:he.infoType)??null}}});c(W),S(ye.edges.map(pe=>({id:pe.edgeId,source:pe.fromNodeId,target:pe.toNodeId})))}).catch(()=>{L&&(c([]),S([]))}),()=>{L=!1}},[i]),a.useEffect(()=>{yr({libraryId:i}).then(V).catch(()=>V(null))},[i,l,g]);const R=a.useCallback(L=>{S(ye=>Qn(L,ye))},[]),K=()=>{const L=crypto.randomUUID();c(ye=>[...ye,{id:L,type:"default",position:{x:140+ye.length*40,y:120+ye.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},Q=()=>{const L=crypto.randomUUID();c(ye=>[...ye,{id:L,type:"default",position:{x:180+ye.length*40,y:160+ye.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},me=async()=>{C(null);try{const L=l.map(W=>({nodeId:W.id,nodeType:W.data.nodeType,payload:{itemType:W.data.itemType,itemId:W.data.itemId??null,label:W.data.label,infoType:W.data.infoType??null}})),ye=g.map(W=>({edgeId:W.id,fromNodeId:W.source,toNodeId:W.target}));await xr({libraryId:i,nodes:L,edges:ye}),C(t.cogita.library.graph.saveSuccess)}catch{C(t.cogita.library.graph.saveFail)}},Ae=L=>{$&&c(ye=>ye.map(W=>W.id===$.id?{...W,data:{...W.data,itemId:(L==null?void 0:L.infoId)??null,itemType:"collection",infoType:"collection",label:(L==null?void 0:L.label)??t.cogita.library.infoTypes.collection}}:W))},ee=L=>{$&&c(ye=>ye.map(W=>W.id===$.id?{...W,data:{...W.data,itemId:(L==null?void 0:L.infoId)??null,itemType:"info",infoType:(L==null?void 0:L.infoType)??null,label:(L==null?void 0:L.label)??t.cogita.library.infoTypes.any}}:W))};return a.useEffect(()=>{if(!$||$.data.nodeType!=="info"||$.data.infoType!=="citation"||!$.data.itemId){q(null);return}let L=!0;return na({libraryId:i,infoId:$.data.itemId}).then(ye=>{if(!L)return;const W=ye.payload,pe=(W==null?void 0:W.text)??"";if(!pe){q(null);return}const ae=va(pe),ke=Object.values(ae.nodes).sort((he,ce)=>he.depth-ce.depth||he.start-ce.start).map(he=>({id:he.id,text:he.text,depth:he.depth}));q({title:(W==null?void 0:W.title)??$.data.label,fragments:ke})}).catch(()=>q(null)),()=>{L=!1}},[i,$]),e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:m,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:me,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:K,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Q,children:t.cogita.library.actions.addInfo}),_?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(_.totalCollections))})}):null,w?e.jsx("p",{className:"cogita-help",children:w}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(pn,{nodes:l,edges:g,onNodesChange:v,onEdgesChange:O,onConnect:R,onNodeClick:(L,ye)=>y(ye.id),fitView:!0,children:[e.jsx(fn,{gap:18,size:1}),e.jsx(bn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),$?e.jsxs("div",{className:"cogita-graph-inspector",children:[$.data.nodeType==="collection"?e.jsx(Yt,{libraryId:i,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:$.data.itemId?{id:$.data.itemId,label:$.data.label,infoType:"collection"}:null,onChange:Ae,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(Yt,{libraryId:i,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:$.data.itemId?{id:$.data.itemId,label:$.data.label,infoType:$.data.infoType??void 0}:null,onChange:ee,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),f?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:f.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:f.fragments.map(L=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:L.id}),e.jsx("span",{children:L.text})]},L.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function es({children:t,flashState:n,flashTick:r=0,feedbackToken:s,className:o}){const h=s??(n?`${n}-${r}`:"idle");return e.jsx("section",{className:o?`cogita-revision-card ${o}`:"cogita-revision-card","data-feedback":h,children:t})}function ts({copy:t,currentCard:n,currentTypeLabel:r,prompt:s,languages:o,answer:h,onAnswerChange:u,computedExpected:j,computedAnswers:p,onComputedAnswerChange:k,answerTemplate:i,outputVariables:m,variableValues:l,computedFieldFeedback:c,feedback:v,canAdvance:g,quoteContext:S,quotePlaceholder:O,onCheckAnswer:x,onSkip:y,onLanguageSelect:_,onMarkReviewed:V,onAdvance:w,showCorrectAnswer:C,setShowCorrectAnswer:f,onRevealCorrect:q,answerMask:$,expectedAnswer:R,hasExpectedAnswer:K,handleComputedKeyDown:Q,answerInputRef:me,computedInputRefs:Ae,scriptMode:ee,setScriptMode:L,matchPairs:ye,matchLeftOrder:W,matchRightOrder:pe,matchSelection:ae,matchActiveLeft:ke,matchActiveRight:he,matchFeedback:ce,onMatchLeftSelect:Ie,onMatchRightSelect:$e,disableCheckAnswer:Fe=!1,hideSkipAction:Re=!1,allowRevealBeforeCheck:et=!1,autoRevealAfterAnswer:ct=!1,disableCheckAfterAnswer:Te=!1}){const We=a.useMemo(()=>{var Y;const A=!i&&j.length===2?`The {${j[0].key}} is of type {${j[1].key}}`:null,D=i??A;if(!D)return null;const E=new Map(j.map(ne=>[ne.key,ne.expected])),N=new Set,T=[],M=/\{([^}]+)\}/g;let le=0,be,de=null;for(;(be=M.exec(D))!==null;){const ne=D.slice(le,be.index);ne&&T.push({type:"text",value:ne});const G=((Y=be[1])==null?void 0:Y.trim())??"",Z=G&&E.has(G)?G:G&&m&&m[G]?m[G]:null;G&&N.add(G),Z&&N.add(Z),Z&&E.has(Z)?(T.push({type:"input",value:Z}),de||(de=Z)):G&&l&&l[G]!==void 0?T.push({type:"text",value:l[G]}):T.push({type:"text",value:be[0]}),le=be.index+be[0].length}const X=D.slice(le);return X&&T.push({type:"text",value:X}),j.filter(ne=>!N.has(ne.key)).length>0?null:{parts:T,expectedByKey:E,firstInputKey:de}},[i,j,m,l]),xt=()=>{if(!We)return null;const{parts:A,expectedByKey:D,firstInputKey:E}=We;return e.jsx("div",{className:"cogita-revision-inline-answer",children:A.map((N,T)=>{var M,le;return N.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:N.value},`text-${T}`):e.jsx("input",{ref:be=>{Ae.current[N.value]=be},autoFocus:N.value===E,value:p[N.value]??"",onChange:be=>k(N.value,be.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":c[N.value]??(v==="correct"?"correct":v==="incorrect"?"incorrect":void 0),onKeyDown:be=>ot(be)||Q(be),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((M=p[N.value])==null?void 0:M.length)??0,((le=D.get(N.value))==null?void 0:le.length)??6)}ch`}},`input-${N.value}-${T}`)})})},Ve=a.useMemo(()=>{const A=new Map;return(ye??[]).forEach(D=>A.set(D.leftId,D)),A},[ye]),ze=a.useMemo(()=>{const A=new Map;return(ye??[]).forEach(D=>A.set(D.rightId,D)),A},[ye]);a.useEffect(()=>{var T;if(n.cardType!=="info"||n.infoType!=="computed"||j.length===0)return;const A=typeof document<"u"?document.activeElement:null;if(A&&(A.tagName==="INPUT"||A.tagName==="TEXTAREA"))return;const D=(We==null?void 0:We.firstInputKey)??((T=j[0])==null?void 0:T.key);if(!D)return;const E=Ae.current[D];if(!E)return;const N=requestAnimationFrame(()=>{E.focus()});return()=>cancelAnimationFrame(N)},[n,j,We]);const tt=(()=>{const A=[R??"",...j.map(N=>N.expected??"")].join(""),D=[h,...Object.values(p)].join(""),E=`${A}${D}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(E)})(),ot=A=>A.ctrlKey&&(A.key==="^"||A.key==="6")?(A.preventDefault(),L(D=>D==="super"?null:"super"),!0):A.ctrlKey&&(A.key==="_"||A.key==="-")?(A.preventDefault(),L(D=>D==="sub"?null:"sub"),!0):!1,Ye=()=>{if(!R||!$)return R??"";const A=R.split(""),D=Array.from($),E=D.length>0?D.reduce((N,T)=>N+T,0)/D.length:127;return A.map((N,T)=>{const M=D[T]??E,le=Math.max(0,Math.min(255,Math.round(M)));let be=255,de=0;return le<=127?de=Math.round(le/127*255):(de=255,be=Math.round(255*(1-(le-127)/128))),e.jsx("span",{style:{color:`rgb(${be}, ${de}, 0)`},children:N},`mask-${T}`)})},Ce=n.cardType==="info"&&n.infoType==="citation"?(S==null?void 0:S.title)||n.label:n.description,Be=C||ct&&v!==null,Xe=Fe||Te&&(v!==null||Be),F=K&&(et||v==="incorrect"||Be);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[r?e.jsx("span",{children:r}):null,e.jsx("strong",{children:Ce})]}),n.cardType==="vocab"&&n.checkType==="translation-match"&&ye?e.jsxs("div",{className:"cogita-revision-body",children:[s?e.jsx("h2",{children:s}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(W??[]).map(A=>{const D=Ve.get(A);if(!D)return null;const E=(ae==null?void 0:ae[A])??null,N=(ce==null?void 0:ce[A])??null,T=ke===A;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":T,"data-state":N??void 0,"data-locked":E?"true":void 0,onClick:()=>Ie==null?void 0:Ie(A),children:[e.jsx("span",{children:D.leftLabel}),E&&C?e.jsx("em",{children:"✓"}):null]},A)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(pe??[]).map(A=>{const D=ze.get(A);if(!D)return null;const E=Object.values(ae??{}).includes(A),N=he===A;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":E||N,"data-locked":E?"true":void 0,onClick:()=>$e==null?void 0:$e(A),children:e.jsx("span",{children:D.rightLabel})},A)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:n.checkType==="translation-match"||Xe,children:t.cogita.library.revision.checkAnswer}),Re?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):n.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:s}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:me,value:h,onChange:A=>u(A.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:A=>{if(A.key==="Enter")if(A.preventDefault(),A.stopPropagation(),g)w();else{if(Xe)return;x()}}})]}),tt?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":ee==="super",onClick:()=>L(A=>A==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":ee==="sub",onClick:()=>L(A=>A==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:Xe,children:t.cogita.library.revision.checkAnswer}),Re?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[n.label?e.jsx("p",{className:"cogita-revision-hint",children:n.label}):null,i?null:e.jsx(vr,{value:s??"",mode:"auto"}),j.length>0?(()=>{const A=xt();return A?e.jsx("div",{className:"cogita-inline-answer-wrap",children:A}):e.jsx("div",{className:"cogita-form-grid",children:j.map((D,E)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:D.key}),e.jsx("textarea",{ref:N=>{Ae.current[D.key]=N},autoFocus:E===0,value:p[D.key]??"",onChange:N=>k(D.key,N.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":c[D.key]??(v==="correct"?"correct":v==="incorrect"?"incorrect":void 0),onKeyDown:N=>ot(N)||Q(N)})]},D.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:me,value:h,onChange:A=>u(A.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:A=>{if(!ot(A)&&A.key==="Enter")if(A.preventDefault(),A.stopPropagation(),g)w();else{if(Xe)return;x()}}})]})}),tt?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":ee==="super",onClick:()=>L(A=>A==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":ee==="sub",onClick:()=>L(A=>A==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:Xe,children:t.cogita.library.revision.checkAnswer}),Re?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="citation"&&S?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(S.completed)).replace("{total}",String(S.total))}),e.jsx("p",{className:"cogita-quote-text",children:S.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:me,value:h,onChange:A=>u(A.target.value),placeholder:O??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:A=>{if(A.key==="Enter")if(A.preventDefault(),A.stopPropagation(),g)w();else{if(Xe)return;x()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:S.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:Xe,children:t.cogita.library.revision.checkAnswer}),Re?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:s}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:o.length?o.map(A=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>_(A.label),children:A.label},A.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:s}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:V,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}),v&&e.jsx("div",{className:"cogita-revision-feedback","data-state":v,children:v==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),F?e.jsxs("div",{className:"cogita-revision-reveal",children:[Be?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>f(A=>{const D=!A;return D&&q(),D}),children:t.cogita.library.revision.showAnswer}),Be?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),j.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[j.map(A=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:A.key}),e.jsx("span",{children:A.expected})]},A.key)),R?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:R})]}):null]}):e.jsx("p",{children:$?Ye():R})]}):null]}):null,g?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:w,children:t.cogita.library.revision.nextQuestion})}):null]})}const As={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},Si=(t,n)=>{const r=Math.max(t.length,n.length,1),s=Math.abs(t.length-n.length);return Math.max(0,1-s/r)},Ti=(t,n)=>{const r=new Uint8Array(t.length),s=Si(t,n);for(let o=0;o<t.length;o+=1){const h=t[o]===(n[o]??"")?128:0,u=t.length-1-o,j=n.length-1-o,p=t[u]===(n[j]??"")?127:0,k=Math.round((h+p)*s);r[o]=Math.max(0,Math.min(255,k))}return r},Ci=(t,n)=>t===n||(As[t]??[]).includes(n)?!0:(As[n]??[]).includes(t),Xa=(t,n,r)=>r?Ci(t,n):t===n,rn=(t,n,r)=>{const s=new Uint8Array(t.length);if(!t.length)return s;const o=(r==null?void 0:r.allowSimilarChars)??!0,h=[];for(let j=0;j<=t.length-3;j+=1)h.push({index:j,text:t.slice(j,j+3)});let u=!1;return h.forEach(j=>{for(let p=0;p<=n.length-3;p+=1){const k=n.slice(p,p+3);let i=0;for(let g=0;g<3;g+=1)Xa(j.text[g],k[g],o)&&(i+=1);if(i<2)continue;let m=j.index-1,l=p-1;for(;m>=0&&l>=0;){const g=t[m],S=n[l];if(g===S){s[m]=Math.max(s[m],255),m-=1,l-=1,u=!0;continue}if(Xa(g,S,o)&&g!==S){s[m]=Math.max(s[m],127),m-=1,l-=1,u=!0;continue}if(m>0&&t[m-1]===S){s[m]=Math.max(s[m],0),m-=1,u=!0;continue}if(l>0&&t[m]===n[l-1]){l-=1,u=!0;continue}break}for(let g=0;g<3;g+=1){const S=j.index+g,O=j.text[g],x=k[g],y=O===x?255:Xa(O,x,o)?127:0;s[S]=Math.max(s[S],y),u=!0}let c=j.index+3,v=p+3;for(;c<t.length&&v<n.length;){const g=t[c],S=n[v];if(g===S){s[c]=Math.max(s[c],255),c+=1,v+=1,u=!0;continue}if(Xa(g,S,o)&&g!==S){s[c]=Math.max(s[c],127),c+=1,v+=1,u=!0;continue}if(c+1<t.length&&t[c+1]===S){s[c]=Math.max(s[c],0),c+=1,u=!0;continue}if(v+1<n.length&&t[c]===n[v+1]){v+=1,u=!0;continue}break}}}),u?s:Ti(t,n)},En=t=>/[\p{L}\p{N}]/u.test(t),$s=t=>t.trim().toLowerCase(),xa=(t,n)=>{if(t.length===0)return 100;const r=(n==null?void 0:n.treatSimilarCharsAsSame)??!1,s=Array.from(t).reduce((o,h)=>r&&h===127?o+255:o+h,0);return Math.round(s/(t.length*255)*100)},Sa=(t,n,r)=>{const s=Math.max(0,Math.min(100,(r==null?void 0:r.thresholdPercent)??100)),o=(r==null?void 0:r.treatSimilarCharsAsSame)??!0,h=(r==null?void 0:r.ignorePunctuationAndSpacing)??!1,u=$s(t),j=$s(n);if(!h){const x=rn(u,j,{allowSimilarChars:o}),y=xa(x,{treatSimilarCharsAsSame:o});return{mask:x,percent:y,isCorrect:y>=s,normalizedExpected:u,normalizedAnswer:j}}const p=Array.from(u),k=Array.from(j),i=[],m=[],l=[];p.forEach((x,y)=>{En(x)&&(i.push(x),m.push(y))}),k.forEach(x=>{En(x)&&l.push(x)});const c=i.join(""),v=l.join(""),g=rn(c,v,{allowSimilarChars:o}),S=new Uint8Array(p.length);for(let x=0;x<S.length;x+=1)S[x]=En(p[x]??"")?0:255;for(let x=0;x<g.length;x+=1){const y=m[x];y!==void 0&&(S[y]=g[x])}const O=xa(g,{treatSimilarCharsAsSame:o});return{mask:S,percent:O,isCorrect:O>=s,normalizedExpected:c,normalizedAnswer:v}},Ra=(t,n,r)=>{const s=t.trim().toLowerCase(),o=n.trim().toLowerCase();return r==="prefix"||r==="bidirectional"?rn(s,o,{allowSimilarChars:!0}):rn(s,o,{allowSimilarChars:!0})};function Ii(t){if(!t||typeof t!="object")return null;const r=t.definition;if(!r||typeof r!="object")return null;const s=r,o=typeof s.type=="string"?s.type:typeof s.kind=="string"?s.kind:"selection",h=o==="multi_select"||o==="single_select"?"selection":o==="boolean"?"truefalse":o==="order"?"ordering":o;if(!["selection","truefalse","text","number","date","ordering","matching"].includes(h))return null;const u=h,j=typeof s.title=="string"?s.title:void 0,p=typeof s.question=="string"?s.question:"",k=Array.isArray(s.options)?s.options.map(l=>typeof l=="string"?l:"").filter(Boolean):void 0,i=Array.isArray(s.columns)?s.columns.map(l=>Array.isArray(l)?l.map(c=>typeof c=="string"?c:"").filter(Boolean):[]).filter(l=>l.length>0):void 0,m=(()=>{if(h==="selection")return(Array.isArray(s.answer)?s.answer:Array.isArray(s.correct)?s.correct:[]).map(c=>Number(c)).filter(c=>Number.isInteger(c)&&c>=0);if(h==="truefalse")return typeof s.answer=="boolean"?s.answer:typeof s.expected=="boolean"?s.expected:!1;if(h==="matching"){const l=s.answer&&typeof s.answer=="object"?s.answer:null;return{paths:(Array.isArray(l==null?void 0:l.paths)?l==null?void 0:l.paths:Array.isArray(s.correctPairs)?s.correctPairs:[]).map(g=>Array.isArray(g)?g.map(S=>Number(S)).filter(S=>Number.isInteger(S)&&S>=0):[]).filter(g=>g.length>0)}}if(typeof s.answer=="string"||typeof s.answer=="number")return s.answer;if(typeof s.expected=="string"||typeof s.expected=="number")return s.expected})();return{type:u,title:j,question:p,options:k,columns:i,answer:m}}function Mi(t){var o;if(t.type!=="matching")return[[]];const n=Math.max(2,((o=t.columns)==null?void 0:o.length)??2);return[...((t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[])??[]).map(h=>Array.from({length:n},(u,j)=>String(h[j]??""))),new Array(n).fill("")]}function Li(t){const n=[...t];for(let r=n.length-1;r>0;r-=1){const s=Math.floor(Math.random()*(r+1));[n[r],n[s]]=[n[s],n[r]]}return n}function ia(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function Rs(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function Ps(t){const n=t.checkType??"info",r=n.startsWith("question-")?`question / ${n.slice(9)}`:n;return t.direction?`${r} / ${t.direction}`:r}function Ai({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,libraryId:i,infoId:m,selectedReviewerRoleId:l}){const[c,v]=a.useState(m),[g,S]=a.useState([]),[O,x]=a.useState([]),[y,_]=a.useState("loading"),[V,w]=a.useState(null),[C,f]=a.useState(null),[q,$]=a.useState(null),[R,K]=a.useState(null),[Q,me]=a.useState(""),[Ae,ee]=a.useState(null),[L,ye]=a.useState(1),[W,pe]=a.useState(null),[ae,ke]=a.useState(0),[he,ce]=a.useState(!1),[Ie,$e]=a.useState(null),[Fe,Re]=a.useState({}),[et,ct]=a.useState({}),[Te]=a.useState({}),[We,xt]=a.useState(null),[Ve,ze]=a.useState({selection:[],booleanAnswer:null,ordering:[],matchingRows:[[]]}),tt=a.useRef(null),ot=a.useRef({}),Ye=mn();a.useEffect(()=>{let X=!1;return _("loading"),Promise.all([na({libraryId:i,infoId:m}).catch(()=>null),tn({libraryId:i,infoId:m}),an({libraryId:i,infoId:m})]).then(([P,Y,ne])=>{if(X)return;const G=(P==null?void 0:P.payload)??{},Z=typeof G.title=="string"&&G.title||typeof G.label=="string"&&G.label||typeof G.name=="string"&&G.name||m;v(Z),f(G),$((P==null?void 0:P.infoType)??null),S(Y.items),x(ne.items),_("ready")}).catch(()=>{X||(f(null),$(null),S([]),x([]),_("error"))}),()=>{X=!0}},[i,m]),a.useEffect(()=>{if(q!=="translation"){K(null);return}qs({libraryId:i,infoId:m,approachKey:"vocab-card"}).then(X=>K(X.projection??null)).catch(()=>K(null))},[q,m,i]);const Ce=a.useMemo(()=>{var xe;const X=new Map(g.map(U=>[ia(U),U])),P=new Map,Y=new Map;for(const U of g)P.set(ia(U),0),Y.set(ia(U),[]);for(const U of O){const se=Rs({parentItemId:U.parentItemId,parentCheckType:U.parentCheckType,parentDirection:U.parentDirection}),Le=[U.childItemId,U.childCheckType??"",U.childDirection??""].join("|");!X.has(se)||!X.has(Le)||((xe=Y.get(se))==null||xe.push(Le),P.set(Le,(P.get(Le)??0)+1))}const ne=Array.from(P.entries()).filter(([,U])=>U===0).map(([U])=>U),G=new Map;for(const U of ne)G.set(U,0);for(;ne.length;){const U=ne.shift(),se=G.get(U)??0;for(const Le of Y.get(U)??[]){const qe=Math.max(G.get(Le)??0,se+1);G.set(Le,qe),P.set(Le,(P.get(Le)??1)-1),(P.get(Le)??0)<=0&&ne.push(Le)}}const Z=new Map;for(const U of g){const se=ia(U),Le=G.get(se)??0,qe=Z.get(Le)??[];qe.push(se),Z.set(Le,qe)}return g.map(U=>{const se=ia(U),Le=G.get(se)??0,qe=Z.get(Le)??[se],_e=Math.max(0,qe.indexOf(se));return{id:se,position:{x:40+_e*290+(Le%2?18:0),y:30+Le*120},draggable:!1,selectable:!0,data:{label:U.label,subtitle:Ps(U),checkType:U.checkType??"info",direction:U.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[g,O]),Be=a.useMemo(()=>new Map(g.map(X=>[ia(X),X])),[g]),Xe=a.useMemo(()=>{const X=[];for(const P of O){const Y=Rs({parentItemId:P.parentItemId,parentCheckType:P.parentCheckType,parentDirection:P.parentDirection}),ne=[P.childItemId,P.childCheckType??"",P.childDirection??""].join("|");!Be.has(Y)||!Be.has(ne)||X.push({id:`${Y}->${ne}`,source:Y,target:ne,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return X},[Be,O]),F=a.useMemo(()=>V?Be.get(V)??null:null,[Be,V]);a.useEffect(()=>{me(""),pe(null),ke(0),ce(!1),$e(null),ee(null),ct({}),ze({selection:[],booleanAnswer:null,ordering:[],matchingRows:[[]]})},[V]);const A=a.useMemo(()=>{var G,Z;if(!F)return null;const X=q??F.infoType??null,P=F.checkType??"info",Y=F.direction??null,ne=C??{};if(F.cardType==="vocab"&&R&&Array.isArray(R.words)){const xe=R.words,U=((G=xe[0])==null?void 0:G.label)??"?",se=((Z=xe[1])==null?void 0:Z.label)??"?";return Y==="a-to-b"?{kind:"vocab",prompt:String(U),expected:String(se)}:Y==="b-to-a"?{kind:"vocab",prompt:String(se),expected:String(U)}:{kind:"generic",prompt:`${U} ↔ ${se}`,expected:`${U} ↔ ${se}`}}if(X==="citation"&&P==="quote-fragment"&&Y&&typeof ne.text=="string"){const xe=Y,U=va(ne.text),se=U.nodes[xe];if(se){const Le=xn(ne.text,se);return{kind:"citation-fragment",expected:se.text,quoteContext:{title:c,before:Le.before,after:Le.after,total:Object.keys(U.nodes).length,completed:0},quotePlaceholder:se.text.length>0?".".repeat(Math.max(4,Math.min(18,se.text.length))):"..."}}}if(X==="question"){const xe=Ii(ne);if(xe)return{kind:"question",definition:xe}}return{kind:"generic",prompt:F.description||F.label,expected:F.label}},[q,C,F,c,R]);a.useEffect(()=>{if(!A||A.kind!=="question")return;const X=A.definition;ze({selection:[],booleanAnswer:null,ordering:X.type==="ordering"?Li(X.options??[]):[],matchingRows:X.type==="matching"?Mi(X):[[]]})},[A,V]);const D=async X=>{if(F&&l)try{await jr({libraryId:i,outcome:{itemType:"info",itemId:F.cardId,checkType:F.checkType??"info",direction:F.direction??null,revisionType:"direct",evalType:"direct-check",correct:X,clientId:"cogita-info-checkcards",clientSequence:L,personRoleId:l}}),ye(P=>P+1),ee(X?"Saved as correct.":"Saved as incorrect.")}catch{ee("Failed to save answer.")}},E=F?ia(F):null,N=E?!!Fe[E]:!1,T=async()=>{var ne;if(!F||!A)return;const X=ia(F);if(Fe[X]){ee("This card was already checked.");return}let P=!1,Y=null;if(A.kind==="question"){const G=A.definition;if(G.type==="selection"){const Z=Array.isArray(G.answer)?[...G.answer].sort((U,se)=>U-se):[],xe=[...Ve.selection].sort((U,se)=>U-se);P=Z.length===xe.length&&Z.every((U,se)=>U===xe[se])}else if(G.type==="truefalse")P=typeof G.answer=="boolean"&&Ve.booleanAnswer!==null&&G.answer===Ve.booleanAnswer;else if(G.type==="ordering"){const Z=(G.options??[]).join(`
`),xe=Ve.ordering.join(`
`),U=Sa(Z,xe,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});P=U.isCorrect,Y=U.mask}else if(G.type==="matching"){const Z=Math.max(2,((ne=G.columns)==null?void 0:ne.length)??2),xe=Ve.matchingRows.map(qe=>qe.slice(0,Z).map(_e=>_e.trim())).filter(qe=>qe.every(_e=>_e!=="")).map(qe=>qe.map(_e=>Number(_e))).filter(qe=>qe.every(_e=>Number.isInteger(_e)&&_e>=0)).map(qe=>JSON.stringify(qe)),U=(G.answer&&typeof G.answer=="object"&&"paths"in G.answer?G.answer.paths:[]).map(qe=>JSON.stringify(qe)),se=Array.from(new Set(xe)).sort(),Le=Array.from(new Set(U)).sort();P=se.length===Le.length&&se.every((qe,_e)=>qe===Le[_e])}else{const Z=String(G.answer??""),xe=Sa(Z,Q,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});P=xe.isCorrect,Y=xe.mask}$e(Y),ce(!0)}else{const G=A.expected,Z=A.kind==="citation-fragment",xe=Sa(G,Q,{thresholdPercent:Z?90:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:Z});P=xe.isCorrect,$e(xe.mask),ce(!0)}pe(P?"correct":"incorrect"),ke(G=>G+1),ee(l?null:"Answer checked locally (not saved: no person selected)."),Re(G=>({...G,[X]:!0})),l&&await D(P)},M=()=>{if(!F||!A)return;const X=ia(F);if(Fe[X]||(Re(Y=>({...Y,[X]:!0})),ee("Answer revealed (not saved).")),A.kind==="question"){$e(null);return}const P=Sa(A.expected,A.expected,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:A.kind==="citation-fragment"});$e(P.mask)},le=a.useMemo(()=>F?F.infoType==="question"?{...F,description:F.label}:F.infoType==="citation"?{...F,description:c}:{...F,description:F.label}:null,[F,c]),be=X=>{const P=X.definition,Y=N||he,ne=P.type==="matching"?(()=>{var qe;const xe=Math.max(2,((qe=P.columns)==null?void 0:qe.length)??2),se=(Ve.matchingRows.length?Ve.matchingRows:[new Array(xe).fill("")]).map(_e=>Array.from({length:xe},(Je,bt)=>_e[bt]??""));return se[se.length-1].some(_e=>_e.trim())?[...se,new Array(xe).fill("")]:se})():[],G=Array.isArray(P.answer)?P.answer:[],Z=P.answer&&typeof P.answer=="object"&&"paths"in P.answer?P.answer.paths:[];return e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:P.question||(F==null?void 0:F.label)}),P.title?e.jsx("p",{className:"cogita-revision-hint",children:P.title}):null,P.type==="selection"?e.jsx("div",{className:"cogita-choice-grid",style:{gridTemplateColumns:"1fr"},children:(P.options??[]).map((xe,U)=>e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.6rem"},children:[e.jsx("input",{type:"checkbox",checked:Ve.selection.includes(U),disabled:Y,onChange:se=>ze(Le=>({...Le,selection:se.target.checked?Array.from(new Set([...Le.selection,U])):Le.selection.filter(qe=>qe!==U)}))}),e.jsx("span",{children:xe})]},`q-opt:${U}`))}):null,P.type==="truefalse"?e.jsxs("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:[e.jsx("button",{type:"button",className:"ghost","data-active":Ve.booleanAnswer===!0,disabled:Y,onClick:()=>ze(xe=>({...xe,booleanAnswer:!0})),children:"True"}),e.jsx("button",{type:"button",className:"ghost","data-active":Ve.booleanAnswer===!1,disabled:Y,onClick:()=>ze(xe=>({...xe,booleanAnswer:!1})),children:"False"})]}):null,P.type==="text"||P.type==="number"||P.type==="date"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:tt,type:P.type==="date"?"date":"text",value:Q,onChange:xe=>me(xe.target.value),disabled:Y,"data-state":W==="correct"?"correct":W==="incorrect"?"incorrect":void 0})]}):null,P.type==="ordering"?e.jsx("div",{style:{display:"grid",gap:"0.45rem"},children:Ve.ordering.map((xe,U)=>e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)"},children:[U+1,"."]}),e.jsx("span",{children:xe}),e.jsx("button",{type:"button",className:"ghost",disabled:Y||U===0,onClick:()=>ze(se=>{const Le=[...se.ordering];return[Le[U-1],Le[U]]=[Le[U],Le[U-1]],{...se,ordering:Le}}),children:"Up"}),e.jsx("button",{type:"button",className:"ghost",disabled:Y||U>=Ve.ordering.length-1,onClick:()=>ze(se=>{const Le=[...se.ordering];return[Le[U+1],Le[U]]=[Le[U],Le[U+1]],{...se,ordering:Le}}),children:"Down"})]},`q-order:${U}:${xe}`))}):null,P.type==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.65rem"},children:[(P.columns??[]).map((xe,U)=>e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.35rem",padding:"0.6rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:`Column ${U+1}`}),xe.map((se,Le)=>e.jsx("div",{className:"cogita-library-hint",children:`${Le}: ${se}`},`q-col:${U}:${Le}`))]},`q-col:${U}`)),e.jsxs("div",{style:{display:"grid",gap:"0.4rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:"Paths (0-based indices)"}),ne.map((xe,U)=>{var Le;const se=U===ne.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:`repeat(${Math.max(2,((Le=P.columns)==null?void 0:Le.length)??2)}, minmax(0, 1fr)) auto`,gap:"0.35rem",alignItems:"center"},children:[xe.map((qe,_e)=>e.jsx("input",{type:"number",min:0,step:1,value:qe,disabled:Y,onChange:Je=>ze(bt=>{var Ct;const mt=Math.max(2,((Ct=P.columns)==null?void 0:Ct.length)??2),pt=(bt.matchingRows.length?bt.matchingRows:[new Array(mt).fill("")]).map(Ot=>Array.from({length:mt},(Et,Nt)=>Ot[Nt]??""));return pt[U]=pt[U]??new Array(mt).fill(""),pt[U][_e]=Je.target.value,pt[pt.length-1].some(Ot=>Ot.trim())&&pt.push(new Array(mt).fill("")),{...bt,matchingRows:pt}})},`q-path:${U}:${_e}`)),se?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",disabled:Y,onClick:()=>ze(qe=>{var mt;const _e=Math.max(2,((mt=P.columns)==null?void 0:mt.length)??2),Je=qe.matchingRows.filter((pt,wt)=>wt!==U);return Je.length===0&&Je.push(new Array(_e).fill("")),Je[Je.length-1].some(pt=>pt.trim())&&Je.push(new Array(_e).fill("")),{...qe,matchingRows:Je}}),children:"Remove"})]},`q-path:${U}`)})]})]}):null,e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>void T(),disabled:Y,children:t.cogita.library.revision.checkAnswer})}),he?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),P.type==="selection"?e.jsx("p",{children:G.length?G.map(xe=>{var U;return`${xe}${(U=P.options)!=null&&U[xe]?`: ${P.options[xe]}`:""}`}).join(", "):"-"}):P.type==="truefalse"?e.jsx("p",{children:String(!!P.answer)}):P.type==="ordering"?e.jsx("ol",{children:(P.options??[]).map((xe,U)=>e.jsx("li",{children:xe},`ans-order:${U}`))}):P.type==="matching"?e.jsx("div",{style:{display:"grid",gap:"0.35rem"},children:Z.length?Z.map((xe,U)=>e.jsx("p",{children:xe.join(" → ")},`ans-path:${U}`)):e.jsx("p",{children:"-"})}):e.jsx("p",{children:String(P.answer??"")})]}):e.jsx("div",{className:"cogita-revision-reveal",children:e.jsx("button",{type:"button",className:"ghost",onClick:()=>{ce(!0),M()},children:t.cogita.library.revision.showAnswer})})]})},de=a.useMemo(()=>q?nt(t,q):t.cogita.library.infoTypes.any,[t,q]);return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:de}),e.jsx("h2",{className:"cogita-card-title",children:c}),e.jsx("p",{className:"cogita-card-subtitle",children:m})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${g.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${O.length}`}),e.jsx("button",{type:"button",className:"cta",disabled:g.length===0,onClick:()=>Ye(`/cogita/library/${i}/revision/run?libraryTarget=revisions&scope=info&infoId=${encodeURIComponent(m)}`),children:"Start revision"})]})]}),y==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):y==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(pn,{nodes:Ce,edges:Xe,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:(X,P)=>w(P.id),panOnDrag:!0,children:[e.jsx(fn,{}),e.jsx(bn,{showInteractive:!1})]})}),F?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[A&&le?e.jsx(es,{flashState:W,flashTick:ae,children:A.kind==="question"?be(A):e.jsx(ts,{copy:t,currentCard:le,currentTypeLabel:"",prompt:A.kind==="citation-fragment"?null:A.prompt,languages:[],answer:Q,onAnswerChange:me,computedExpected:[],computedAnswers:et,onComputedAnswerChange:(X,P)=>ct(Y=>({...Y,[X]:P})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:Te,feedback:W,canAdvance:!1,quoteContext:A.kind==="citation-fragment"?A.quoteContext:null,quotePlaceholder:A.kind==="citation-fragment"?A.quotePlaceholder:null,onCheckAnswer:()=>void T(),onSkip:()=>w(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:he,setShowCorrectAnswer:ce,onRevealCorrect:M,answerMask:Ie,expectedAnswer:A.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:tt,computedInputRefs:ot,scriptMode:We,setScriptMode:xt,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:N||he,hideSkipAction:!0,allowRevealBeforeCheck:!0,autoRevealAfterAnswer:!0,disableCheckAfterAnswer:!0})}):null,l?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),Ae?e.jsx("p",{className:"cogita-library-hint",children:Ae}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:g.map(X=>{const P=ia(X),Y=V===P;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${Y?"active":""}`,onClick:()=>w(P),children:[e.jsx("span",{children:X.label}),e.jsx("small",{children:Ps(X)})]},P)})})]})]})]})})})})})}function Za(t,n){var r,s;return((s=(r=t.fields.find(o=>o.fieldType===n))==null?void 0:r.plainValue)==null?void 0:s.trim())??""}function $i(t){return Za(t,"role_kind").toLowerCase()==="person"}function Ri(t){return Za(t,"label")||Za(t,"display_name")||Za(t,"name")||t.roleId}function Pi({copy:t,onPersonCreated:n}){const[r,s]=a.useState([]),[o,h]=a.useState("loading"),[u,j]=a.useState(null),[p,k]=a.useState(!1),[i,m]=a.useState(""),l=async()=>{h("loading");try{const g=await Js();s(g),h("ready")}catch{s([]),h("error")}};a.useEffect(()=>{l()},[]);const c=a.useMemo(()=>r.filter($i).map(g=>({roleId:g.roleId,label:Ri(g)})).sort((g,S)=>g.label.localeCompare(S.label)),[r]),v=async()=>{const g=i.trim();if(!g){j("Name is required.");return}k(!0),j(null);try{const S=await wr({fields:[{fieldType:"nick",plainValue:g},{fieldType:"role_kind",plainValue:"person"},{fieldType:"label",plainValue:g},{fieldType:"display_name",plainValue:g}]});m(""),j("Person role created."),n==null||n(S.roleId),await l()}catch{j("Failed to create person role.")}finally{k(!1)}};return e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-browser-panel",children:[e.jsx("div",{className:"cogita-info-overview-head",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Cogita"}),e.jsx("h2",{className:"cogita-card-title",children:"Persons"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Select reviewer persons in the header and create new person roles here."})]})}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Create"}),e.jsx("h3",{className:"cogita-detail-title",children:"New person role"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{type:"text",value:i,onChange:g=>m(g.target.value),placeholder:"e.g. Anna Kowalska",disabled:p})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:p,children:p?"Creating...":"Create person"})}),u?e.jsx("p",{className:"cogita-library-hint",children:u}):null]})]}),e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Overview"}),e.jsx("h3",{className:"cogita-detail-title",children:"All person roles"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[o==="loading"?e.jsx("p",{children:"Loading persons..."}):null,o==="error"?e.jsx("p",{children:"Failed to load persons."}):null,o==="ready"&&c.length===0?e.jsx("p",{children:"No person roles found."}):null,o==="ready"&&c.length>0?e.jsxs("div",{className:"cogita-details-grid",children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:"Name"}),e.jsx("span",{children:"Type"}),e.jsx("span",{children:"Role ID"}),e.jsx("span",{})]}),c.map(g=>e.jsxs("div",{className:"cogita-details-row",role:"row",children:[e.jsx("span",{}),e.jsx("span",{title:g.label,children:g.label}),e.jsx("span",{children:"person"}),e.jsx("span",{title:g.roleId,children:g.roleId}),e.jsx("span",{})]},g.roleId))]}):null]})]})]})]})})})})}function Ei({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,libraryId:i,collectionId:m}){const{libraryName:l}=da(i),[c,v]=a.useState([]),[g,S]=a.useState("loading"),[O,x]=a.useState("idle"),y=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),_=`/#/cogita/library/${i}`,V=()=>{S("loading"),Hs({libraryId:i}).then(f=>{v(f),S("idle")}).catch(()=>{v([]),S("error")})};a.useEffect(()=>{V()},[i]);const w=async f=>{try{await Ws({libraryId:i,shareId:f}),V()}catch{V()}},C=async f=>{const q=`${y}/${f}`;try{await navigator.clipboard.writeText(q),x("copied")}catch{x("failed")}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:_,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${_}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[g==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):g==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):c.filter(f=>!m||f.collectionId===m).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:c.filter(f=>!m||f.collectionId===m).map(f=>e.jsxs("div",{className:"cogita-share-row","data-state":f.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:f.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(f.createdUtc).toLocaleString(),f.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),f.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${y}/${f.shareCode}`}):null]}),f.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[f.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>C(f.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>w(f.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},f.shareId))}),O==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):O==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function Fi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,libraryId:i}){const{libraryName:m}=da(i),[l,c]=a.useState(null),[v,g]=a.useState(null),[S,O]=a.useState(null),[x,y]=a.useState(null),[_,V]=a.useState(null),[w,C]=a.useState(null),f=a.useRef(null),q=K=>{if(!Number.isFinite(K))return"0 B";if(K<1024)return`${K} B`;const Q=K/1024;if(Q<1024)return`${Q.toFixed(1)} KB`;const me=Q/1024;return me<1024?`${me.toFixed(1)} MB`:`${(me/1024).toFixed(1)} GB`},$=async()=>{c(null),V({loadedBytes:0,totalBytes:null,percent:null});try{c(t.cogita.library.overview.exporting);const K=await kr(i,V),Q=URL.createObjectURL(K),me=document.createElement("a");me.href=Q,me.download=`cogita-library-${m||i}.json`,me.click(),URL.revokeObjectURL(Q),c(t.cogita.library.overview.exportReady)}catch{c(t.cogita.library.overview.exportFail)}finally{V(K=>K??{loadedBytes:0,totalBytes:null,percent:null})}},R=async K=>{var me;g(null),O(null),y(null);const Q=(me=K.target.files)==null?void 0:me[0];if(Q)try{g(t.cogita.library.overview.importing),C({loadedBytes:0,totalBytes:Q.size,percent:0});const Ae=await Nr(i,Q,C,ee=>{const L=ee.stage==="infos"?t.cogita.library.overview.importStageInfos:ee.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;y(t.cogita.library.overview.importLiveProgress.replace("{stage}",L).replace("{done}",String(ee.processed)).replace("{total}",String(ee.total)).replace("{infos}",String(ee.infos)).replace("{connections}",String(ee.connections)).replace("{collections}",String(ee.collections)))});O({infos:Ae.infosImported,connections:Ae.connectionsImported,collections:Ae.collectionsImported}),g(t.cogita.library.overview.importDone)}catch(Ae){const ee=Ae instanceof Us&&Ae.message?` ${Ae.message}`:"";g(`${t.cogita.library.overview.importFail}${ee}`)}finally{f.current&&(f.current.value="")}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:m}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:$,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:f,type:"file",accept:"application/json",onChange:R})]})]}),_?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:_.percent??void 0,max:_.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",q(_.loadedBytes)).replace("{total}",_.totalBytes?q(_.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,w?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:w.percent??void 0,max:w.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",q(w.loadedBytes)).replace("{total}",w.totalBytes?q(w.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,l?e.jsx("p",{className:"cogita-help",children:l}):null,v?e.jsx("p",{className:"cogita-help",children:v}):null,x?e.jsx("p",{className:"cogita-help",children:x}):null,S?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(S.infos)).replace("{connections}",String(S.connections)).replace("{collections}",String(S.collections))}):null]})]})})})]})})}function Ki({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,libraryId:i}){const{libraryName:m}=da(i),[l,c]=a.useState(""),[v,g]=a.useState([]),S=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:m}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:O=>c(O.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const O=l.trim();O&&(g(x=>[{id:S(),name:O},...x]),c(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[v.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,v.map(O=>e.jsx("button",{type:"button",className:"ghost",children:O.name},O.id))]})]})]})})})]})})}function _i({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,libraryId:i}){const{libraryName:m}=da(i),[l,c]=a.useState(""),[v,g]=a.useState([]),S=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:m}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:O=>c(O.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const O=l.trim();O&&(g(x=>[{id:S(),name:O},...x]),c(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[v.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,v.map(O=>e.jsx("button",{type:"button",className:"ghost",children:O.name},O.id))]})]})]})})})]})})}function Di({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,libraryId:i}){const{libraryName:m}=da(i),l=`/#/cogita/library/${i}`,[c,v]=a.useState(""),[g,S]=a.useState([]),[O,x]=a.useState("idle"),[y,_]=a.useState(0),[V,w]=a.useState(null);a.useEffect(()=>{x("loading");const f=window.setTimeout(()=>{Va({libraryId:i,query:c.trim()||void 0,limit:30}).then(q=>{S(q.items),_(q.total),w(q.nextCursor??null),x("ready")}).catch(()=>{S([]),_(0),w(null),x("ready")})},240);return()=>window.clearTimeout(f)},[i,c]);const C=async()=>{if(V){x("loading");try{const f=await Va({libraryId:i,query:c.trim()||void 0,limit:30,cursor:V});S(q=>[...q,...f.items]),w(f.nextCursor??null),_(f.total),x("ready")}catch{x("ready")}}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:m}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${l}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:c,onChange:f=>v(f.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(g.length)).replace("{total}",String(y||g.length))}),e.jsx("span",{children:O==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:g.length?g.map(f=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${l}/collections/${f.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:f.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(f.itemCount))," ·"," ",f.notes||t.cogita.library.collections.noNotes]})]})},f.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${l}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),V?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:C,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const Ne=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,ea=(t,n,r,s)=>`${t}:${n}:${r??""}:${s??""}`;function zi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,libraryId:i,collectionId:m}){da(i);const l=`/#/cogita/library/${i}`,[c,v]=a.useState(t.cogita.library.collections.defaultName),[g,S]=a.useState(null),[O,x]=a.useState(0),[y,_]=a.useState([]),[V,w]=a.useState("idle"),[C,f]=a.useState(null),q=a.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(y.length)).replace("{total}",String(O||y.length)),[t,y.length,O]);a.useEffect(()=>{yn(i,m).then(R=>{v(R.name),S(R.notes??null),x(R.itemCount)}).catch(()=>{v(t.cogita.library.collections.defaultName),S(null)})},[i,m]),a.useEffect(()=>{w("loading"),qa({libraryId:i,collectionId:m,limit:40}).then(R=>{_(R.items),f(R.nextCursor??null),x(R.total),w("ready")}).catch(()=>{_([]),f(null),w("ready")})},[i,m]);const $=async()=>{if(C){w("loading");try{const R=await qa({libraryId:i,collectionId:m,limit:40,cursor:C});_(K=>[...K,...R.items]),f(R.nextCursor??null),x(R.total),w("ready")}catch{w("ready")}}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:g||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${l}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${l}/collections/${m}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${l}/collections/${m}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:q}),e.jsx("span",{children:V==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:y.length?y.map(R=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:R.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:R.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:R.label}),e.jsx("p",{className:"cogita-card-subtitle",children:R.description})]})},Ne(R))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),C?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:$,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${l}/collections/${m}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const Es=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],Bi={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},Oi=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Vi=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function qi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,libraryId:i,onCreated:m}){const l=Ja(),{libraryName:c}=da(i),v=`/#/cogita/library/${i}`,[g,S]=a.useState(null),[O,x]=a.useState(""),[y,_]=a.useState(""),[V,w,C]=Hn([]),[f,q,$]=Wn([]),[R,K]=a.useState(null),[Q,me]=a.useState(null),Ae=a.useRef(null),ee=a.useMemo(()=>V.find(ae=>ae.id===R)??null,[V,R]);a.useEffect(()=>{const ae=new URLSearchParams(l.search),ke=(ae.get("draft")??"").trim(),he=(ae.get("draftType")??"").trim();if(!ke||he!=="info-selection"||Ae.current===ke)return;const ce=di(i,ke);if(!ce||ce.infoIds.length===0)return;const Ie=crypto.randomUUID(),$e=ce.infoIds.length>1?crypto.randomUUID():null,Fe=ce.infoIds.map((Te,We)=>({id:crypto.randomUUID(),type:"default",position:{x:80,y:80+We*100},data:{nodeType:"source.info",label:"Selected info",params:{infoId:Te,infoType:"any"}}})),Re=$e?[{id:$e,type:"default",position:{x:360,y:120+Math.max(0,(ce.infoIds.length-1)*50)},data:{nodeType:"logic.or",label:"Selected infos",params:{}}}]:[],et={id:Ie,type:"default",position:{x:660,y:140+Math.max(0,(ce.infoIds.length-1)*35)},data:{nodeType:"output.collection",label:"Collection output",params:{}}},ct=Fe.map(Te=>({id:crypto.randomUUID(),source:Te.id,target:$e??Ie}));$e&&ct.push({id:crypto.randomUUID(),source:$e,target:Ie}),w([...Fe,...Re,et]),q(ct),K(Ie),me(`Draft loaded from ${ce.infoIds.length} selected infos. Set name and save to create collection.`),Ae.current=ke},[i,l.search,q,w]);const L=ae=>{var Ie;const ke=crypto.randomUUID(),he=((Ie=Es.find($e=>$e.type===ae))==null?void 0:Ie.label)??ae,ce={...Bi[ae]};w($e=>[...$e,{id:ke,type:"default",position:{x:120+$e.length*40,y:120+$e.length*40},data:{nodeType:ae,label:he,params:ce}}]),K(ke)},ye=a.useCallback(ae=>{q(ke=>Qn({...ae,id:crypto.randomUUID()},ke))},[q]),W=ae=>{ee&&w(ke=>ke.map(he=>he.id===ee.id?{...he,data:{...he.data,params:ae}}:he))},pe=async()=>{if(me(null),!O.trim()){me(t.cogita.library.collections.saveRequiredName);return}try{const ae={nodes:V.map(ce=>({nodeId:ce.id,nodeType:ce.data.nodeType,payload:{position:ce.position,params:ce.data.params}})),edges:f.map(ce=>({edgeId:ce.id,fromNodeId:ce.source,fromPort:ce.sourceHandle??null,toNodeId:ce.target,toPort:ce.targetHandle??null}))};let ke=g,he=!1;if(ke)await Qs({libraryId:i,collectionId:ke,nodes:ae.nodes,edges:ae.edges});else{const ce=await Sr({libraryId:i,name:O.trim(),notes:y.trim()||void 0,items:[],graph:ae});ke=ce.collectionId,he=!0,S(ce.collectionId)}me(he?t.cogita.library.collections.saveSuccess:t.cogita.library.graph.saveSuccess),m(ke)}catch{me(g?t.cogita.library.graph.saveFail:t.cogita.library.collections.saveFail)}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.createKicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.createSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${v}/collections`,children:t.cogita.library.actions.collections}),e.jsx("button",{type:"button",className:"cta",onClick:pe,children:t.cogita.library.actions.saveCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.collectionInfoTitle}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{value:O,onChange:ae=>x(ae.target.value),placeholder:t.cogita.library.collections.namePlaceholder})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.notesLabel}),e.jsx("textarea",{value:y,onChange:ae=>_(ae.target.value),placeholder:t.cogita.library.collections.notesPlaceholder})]}),Q?e.jsx("p",{className:"cogita-help",children:Q}):null,e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Es.map(ae=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>L(ae.type),children:ae.label},ae.type))})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(pn,{nodes:V,edges:f,onNodesChange:C,onEdgesChange:$,onConnect:ye,onNodeClick:(ae,ke)=>K(ke.id),fitView:!0,children:[e.jsx(fn,{color:"rgba(120,160,200,0.2)"}),e.jsx(bn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),ee?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:ee.data.label}),ee.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:i,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:ee.data.params.tagId?{id:ee.data.params.tagId,label:ee.data.params.tagLabel??"",infoType:"topic"}:null,onChange:ae=>W({...ee.data.params,tagId:(ae==null?void 0:ae.id)??null,tagLabel:(ae==null?void 0:ae.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:ee.data.params.scope??"any",onChange:ae=>W({...ee.data.params,scope:ae.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),ee.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:i,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:ee.data.params.languageId?{id:ee.data.params.languageId,label:ee.data.params.languageLabel??"",infoType:"language"}:null,onChange:ae=>W({...ee.data.params,languageId:(ae==null?void 0:ae.id)??null,languageLabel:(ae==null?void 0:ae.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:ee.data.params.scope??"any",onChange:ae=>W({...ee.data.params,scope:ae.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),ee.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:ee.data.params.infoType??"word",onChange:ae=>W({...ee.data.params,infoType:ae.target.value}),children:Vi.map(ae=>e.jsx("option",{value:ae.value,children:ae.label},ae.value))})]}),e.jsx(Yt,{libraryId:i,infoType:ee.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:ee.data.params.infoId?{id:ee.data.params.infoId,label:ee.data.params.infoLabel??"",infoType:ee.data.params.infoType??"word"}:null,onChange:ae=>W({...ee.data.params,infoId:(ae==null?void 0:ae.id)??null,infoLabel:(ae==null?void 0:ae.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),ee.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:ee.data.params.connectionType??"translation",onChange:ae=>W({...ee.data.params,connectionType:ae.target.value}),children:Oi.map(ae=>e.jsx("option",{value:ae.value,children:ae.label},ae.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:ee.data.params.connectionId??"",onChange:ae=>W({...ee.data.params,connectionId:ae.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(ee.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const la=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const n=t.length,r=t.filter(h=>h.correct).length,s=vn(as(t));return{score:Math.round(Math.max(0,Math.min(100,s.knowness*100))*100)/100,total:n,correct:r,lastReviewedUtc:s.lastReviewedUtc??null}},Ui=t=>{if(t.maskBase64)try{const n=Tr(t.maskBase64);if(!n.length)return t.correct?1:0;const r=n.reduce((s,o)=>s+o,0);return Math.max(0,Math.min(1,r/n.length/255))}catch{return t.correct?1:0}return t.correct?1:0},as=t=>t.map(n=>({correctness:Ui(n),createdUtc:n.createdUtc})),vn=(t,n=Date.now())=>{var O;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const s=t.slice().sort((x,y)=>x.createdUtc.localeCompare(y.createdUtc)).slice(-5),o=s.reduce((x,y)=>x+y.correctness,0)/s.length,h=5,u=2,j=.15;let p=0,k=0;for(let x=0;x<s.length;x+=1){const y=new Date(s[x].createdUtc).getTime(),_=x===s.length-1?n:new Date(s[x+1].createdUtc).getTime(),V=Math.max(0,(_-y)/(1e3*60)),w=1-Math.exp(-V/h);p+=w,s[x].correctness>.5&&(k+=j)}let i=o*p*u+k;const m=((O=s[s.length-1])==null?void 0:O.createdUtc)??null,l=m?Math.max(0,(n-new Date(m).getTime())/(1e3*60)):0,v=1/(1+Math.log1p(l/60));return i*=v,s.length===1&&s[0].correctness>.5&&(i+=5.44*Math.exp(-l/2)),{knowness:i,avgCorrectness:o,lastReviewedUtc:m}},Ua=t=>{const n=t.slice();for(let r=n.length-1;r>0;r-=1){const s=Math.floor(Math.random()*(r+1));[n[r],n[s]]=[n[s],n[r]]}return n},en=t=>t[Math.floor(Math.random()*t.length)],Ji=(t,n)=>{const r=new Map;return t.forEach(s=>r.set(s,Math.random())),t.sort((s,o)=>{const h=n(s)-n(o);return h!==0?h:(r.get(s)??0)-(r.get(o)??0)})},jn=(t,n,r,s,o)=>{if(!t.length)return null;const h=t.filter(j=>!(o!=null&&o.has(Ne(j))));if(h.length===0)return null;const u=h.filter(j=>Ne(j)!==r);return en(u.length?u:h)},Hi=(t,n,r,s,o)=>{if(!t.length)return null;let h=Number.POSITIVE_INFINITY;for(const k of t){const i=Ne(k);if(r.has(i))continue;const m=n[i]??1;m<h&&(h=m)}if(!Number.isFinite(h))return null;const u=t.filter(k=>{const i=Ne(k);return!r.has(i)&&(n[i]??1)===h}),j=u.filter(k=>!o||Ne(k)!==o),p=s?j.filter(k=>!s.has(Ne(k))):j;return p.length>0?en(p):j.length>0?en(j):o&&u.some(k=>Ne(k)===o)?u.find(k=>Ne(k)===o)??null:u.length?en(u):null},tr=(t,n,r,s,o)=>{const h=[],u=t.filter(p=>!o.has(Ne(p))&&!r.has(Ne(p))&&(n[Ne(p)]??0)<1),j=Ji(u,p=>n[Ne(p)]??0);for(const p of j){if(h.length>=s)break;h.push(p),o.add(Ne(p))}if(h.length<s){const p=Ua(t.filter(k=>!o.has(Ne(k))&&r.has(Ne(k))));for(const k of p){if(h.length>=s)break;h.push(k),o.add(Ne(k))}}return h},Wi=(t,n,r,s)=>tr(t,n,r,s,new Set),ns=(t,n,r,s,o,h)=>{const u=Math.max(1,r.stackSize??n),p=Ua(t).filter((v,g,S)=>S.findIndex(O=>Ne(O)===Ne(v))===g),k=Wi(p,s,o,u),i=new Set,m=new Set,l=jn(k,{},null,i,m),c=l?[l]:[];return l&&m.add(Ne(l)),{queue:c,meta:{pool:p,active:k,knownessMap:s,unknownSet:o,outcomesById:h,asked:i,queued:m}}},Jn={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,n)=>{const s=Ua(t).filter((o,h,u)=>u.findIndex(j=>Ne(j)===Ne(o))===h);return{queue:s.slice(0,Math.min(n,s.length)),meta:{}}},applyOutcome:t=>t},ss=(t,n,r,s)=>{const o=Math.max(1,r.stackSize??n),u=Ua(t).filter((g,S,O)=>O.findIndex(x=>Ne(x)===Ne(g))===S),j={},p=new Set,k=new Set,i=new Set,m=Math.max(1,r.levels??1);u.forEach(g=>{const S=Ne(g),O=s==null?void 0:s[S],x=typeof O=="number"&&Number.isFinite(O)?O:1;j[S]=Math.min(m,Math.max(1,Math.round(x)))});const l=[];if(u.length>0){const g=new Map;u.forEach(O=>{var y;const x=j[Ne(O)]??1;g.has(x)||g.set(x,[]),(y=g.get(x))==null||y.push(O)});const S=Array.from(g.keys()).sort((O,x)=>O-x);for(const O of S){if(l.length>=o)break;const x=Ua(g.get(O)??[]);for(const y of x){if(l.length>=o)break;l.push(y)}}}const c=jn(l,j,null,p,k),v=c?[c]:[];return c&&k.add(Ne(c)),{queue:v,meta:{pool:u,active:l,levelMap:j,asked:p,queued:k,wrongSinceCorrect:i}}},Qi={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,r)=>ss(t,n,r),applyOutcome:(t,n,r,s,o)=>{if(!n)return t;const h=Math.max(1,s.levels??1),u=t.meta.pool??[],j=t.meta.active??[],p={...t.meta.levelMap??{}},k=new Set(t.meta.asked??[]),i=new Set(t.meta.queued??[]),m=new Set(t.meta.wrongSinceCorrect??[]),l=Ne(n);i.delete(l),k.add(l);const c=p[l]??1;o.correct?(p[l]=m.has(l)?1:Math.min(c+1,h),m.delete(l)):(p[l]=1,m.add(l));const v=o.correct?j.filter(O=>Ne(O)!==l):j.slice();if(o.correct&&v.length<Math.max(1,s.stackSize??1)){const O=new Set(v.map(y=>Ne(y))),x=Hi(u,p,O,k,l);x&&v.push(x)}const g=t.queue.slice(),S=jn(v,p,l,k,i);return S&&(g.push(S),i.add(Ne(S))),{queue:g,meta:{pool:u,active:v,levelMap:p,asked:k,queued:i,wrongSinceCorrect:m}}}},Gi={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,r)=>ns(t,n,r,{},new Set,{}),applyOutcome:(t,n,r,s,o)=>{if(!n)return t;const h=t.meta.pool??[],u=t.meta.active??[],j={...t.meta.knownessMap??{}},p=new Set(t.meta.unknownSet??[]),k={...t.meta.outcomesById??{}},i=new Set(t.meta.asked??[]),m=new Set(t.meta.queued??[]),l=Ne(n);m.delete(l),i.add(l);const c={correctness:Math.max(0,Math.min(1,o.correctness??(o.correct?1:0))),createdUtc:o.createdUtc??new Date().toISOString()},g=(k[l]??[]).concat(c).sort((V,w)=>V.createdUtc.localeCompare(w.createdUtc)).slice(-5);k[l]=g,p.delete(l);const S=Date.now();h.forEach(V=>{const w=Ne(V),C=k[w]??[];if(C.length===0){j[w]=0,p.add(w);return}const f=vn(C,S);j[w]=f.knowness});const O=u.slice();if((j[l]??0)>=1){const V=O.filter(w=>Ne(w)!==l);O.length=0,O.push(...V)}const y=Math.max(1,s.stackSize??r);if(O.length<y){const V=new Set(O.map(C=>Ne(C))),w=tr(h,j,p,y-O.length,V);O.push(...w)}const _=t.queue.slice();if(_.length===0||Ne(_[_.length-1])===l){const V=jn(O,{},l,i,m);V&&(_.push(V),m.add(Ne(V)))}return{queue:_,meta:{pool:h,active:O,knownessMap:j,unknownSet:p,outcomesById:k,asked:i,queued:m}}}},ar={random:Jn,levels:Qi,temporal:Gi},Yi=Object.values(ar),rs=t=>{if(!t)return Jn;const n=t.trim().toLowerCase();return n==="random"||n==="levels"||n==="temporal"?ar[n]:Jn},wn=(t,n)=>{const r={...t.defaultSettings};return n&&Object.entries(n).forEach(([s,o])=>{typeof o=="number"&&Number.isFinite(o)&&(r[s]=o),typeof o=="string"&&(r[s]=o)}),t.settingsFields.forEach(s=>{var h;const o=r[s.key];if(s.type==="number"){if(typeof o!="number"||Number.isNaN(o)){r[s.key]=t.defaultSettings[s.key]??0;return}s.min!==void 0&&(r[s.key]=Math.max(s.min,r[s.key])),s.max!==void 0&&(r[s.key]=Math.min(s.max,r[s.key]));return}if(s.type==="select"){const u=((h=s.options)==null?void 0:h.map(j=>j.value))??[];(typeof o!="string"||u.length>0&&!u.includes(o))&&(r[s.key]=t.defaultSettings[s.key]??u[0]??"")}}),r},nr=(t,n)=>{const r={};return t.settingsFields.forEach(s=>{const o=n.get(s.key);if(o){if(s.type==="number"){const h=Number(o);Number.isNaN(h)||(r[s.key]=h);return}r[s.key]=o}}),wn(t,r)},Xi=(t,n)=>{const r=new URLSearchParams;return t.settingsFields.forEach(s=>{const o=n[s.key];(typeof o=="number"||typeof o=="string")&&r.set(s.key,String(o))}),r};function Fs({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,libraryId:i,collectionId:m,revisionId:l}){const c=mn(),{libraryName:v}=da(i),g=`/#/cogita/library/${i}`,[S,O]=a.useState(t.cogita.library.collections.defaultName),[x,y]=a.useState([]),[_,V]=a.useState(m??""),[w,C]=a.useState(""),[f,q]=a.useState(20),[$,R]=a.useState("random"),[K,Q]=a.useState({}),[me,Ae]=a.useState("exact"),[ee,L]=a.useState([]),[ye,W]=a.useState(null),[pe,ae]=a.useState([]),[ke,he]=a.useState([]),[ce,Ie]=a.useState(""),[$e,Fe]=a.useState("idle"),[Re,et]=a.useState(null),[ct,Te]=a.useState("idle"),[We,xt]=a.useState("idle"),[Ve,ze]=a.useState("idle"),tt=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),ot=a.useMemo(()=>rs($),[$]),Ye=a.useMemo(()=>wn(ot,K),[ot,K]),Ce=a.useMemo(()=>Xi(ot,Ye).toString(),[ot,Ye]),Be=a.useMemo(()=>{const N=ce.trim().toLocaleLowerCase();return N?ke.filter(T=>T.name.toLocaleLowerCase().includes(N)):ke},[ce,ke]);a.useEffect(()=>{V(m??"")},[m]),a.useEffect(()=>{if(!_){O(t.cogita.library.collections.defaultName);return}yn(i,_).then(N=>O(N.name)).catch(()=>O(t.cogita.library.collections.defaultName))},[t.cogita.library.collections.defaultName,i,_]),a.useEffect(()=>{Va({libraryId:i,limit:200}).then(N=>y(N.items.map(T=>({collectionId:T.collectionId,name:T.name})))).catch(()=>y([]))},[i]),a.useEffect(()=>{Gn({libraryId:i}).then(N=>he(N)).catch(()=>he([]))},[i]),a.useEffect(()=>{l&&Zn({libraryId:i,revisionId:l}).then(N=>{V(N.collectionId),C(N.name),R(N.mode||"random"),Ae(N.check||"exact"),q(N.limit||20),Q(N.revisionSettings??{})}).catch(()=>{C("")})},[i,l]),a.useEffect(()=>{Gs({libraryId:i}).then(N=>{L(N),!ye&&N.length>0&&W(N[0].roleId)}).catch(()=>{L([])})},[i]);const Xe=()=>{xt("loading"),Hs({libraryId:i}).then(N=>{ae(N),xt("idle")}).catch(()=>{ae([]),xt("error")})};a.useEffect(()=>{Xe()},[i]);const F=async()=>{Fe("working"),Te("idle");try{if(!_){Fe("error");return}const N=await Ir({libraryId:i,collectionId:_,revisionType:ot.id,revisionSettings:Ye,mode:$,check:me,limit:f});et(`${tt}/${N.shareCode}${Ce?`?${Ce}`:""}`),Fe("ready"),Xe()}catch{Fe("error")}},A=async()=>{if(l){ze("saving");try{await Cr({libraryId:i,collectionId:m??_,revisionId:l,targetCollectionId:_,name:w||S,revisionType:ot.id,revisionSettings:Ye,mode:$,check:me,limit:f}),ze("saved"),_&&c(`/cogita/library/${i}/revisions/${encodeURIComponent(l)}`,{replace:!0})}catch{ze("error")}}},D=async()=>{if(Re)try{await navigator.clipboard.writeText(Re),Te("copied")}catch{Te("failed")}},E=async N=>{try{await Ws({libraryId:i,shareId:N}),Xe()}catch{Xe()}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:S}),e.jsx("p",{className:"cogita-library-subtitle",children:v})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:g,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${g}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:_?`${g}/collections/${_}`:`${g}/collections`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${g}${l?`/revisions/${encodeURIComponent(l)}/run`:_?`/collections/${_}/revision/run`:"/revision/run"}?mode=${encodeURIComponent($)}&check=${encodeURIComponent(me)}&limit=${f}${Ce?`&${Ce}`:""}${ye?`&reviewer=${encodeURIComponent(ye)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:ce,onChange:N=>Ie(N.target.value),placeholder:t.cogita.workspace.revisionForm.namePlaceholder})}),e.jsxs("div",{className:"cogita-card-list","data-view":"list",children:[e.jsxs("a",{className:"cogita-card-select",href:`${g}/revisions/new`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:t.cogita.workspace.revisionForm.createAction})]}),Be.map(N=>e.jsxs("a",{className:"cogita-card-select",href:`${g}/revisions/${encodeURIComponent(N.revisionId)}`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:N.name})]},N.revisionId))]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsx("select",{value:_,onChange:N=>V(N.target.value),children:x.map(N=>e.jsx("option",{value:N.collectionId,children:N.name},N.collectionId))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:w,onChange:N=>C(N.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:$,onChange:N=>R(N.target.value),children:Yi.map(N=>e.jsx("option",{value:N.id,children:t.cogita.library.revision[N.labelKey]},N.id))})]}),ot.settingsFields.map(N=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[N.labelKey]}),N.type==="select"?e.jsx("select",{value:String(Ye[N.key]??""),onChange:T=>Q(M=>({...M,[N.key]:T.target.value})),children:(N.options??[]).map(T=>e.jsx("option",{value:T.value,children:t.cogita.library.revision[T.labelKey]},T.value))}):e.jsx("input",{type:"number",min:N.min,max:N.max,step:N.step,value:Ye[N.key]??0,onChange:T=>Q(M=>({...M,[N.key]:Number(T.target.value||0)}))})]},N.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),ot.id!=="levels"&&ot.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:f,onChange:N=>q(Number(N.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:ye??"",onChange:N=>W(N.target.value||null),children:ee.map(N=>e.jsx("option",{value:N.roleId,children:N.label},N.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[l?e.jsx("button",{type:"button",className:"cta ghost",onClick:A,disabled:Ve==="saving",children:Ve==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${g}${l?`/revisions/${encodeURIComponent(l)}/run`:_?`/collections/${_}/revision/run`:"/revision/run"}?mode=${encodeURIComponent($)}&check=${encodeURIComponent(me)}&limit=${f}${Ce?`&${Ce}`:""}${ye?`&reviewer=${encodeURIComponent(ye)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision}),l?e.jsx("a",{className:"cta ghost",href:`/#/cogita/live-revision-host/${encodeURIComponent(i)}/${encodeURIComponent(l)}`,children:"Live session"}):null]}),Ve==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),Re?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:Re,readOnly:!0})]}):null,$e==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,ct==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):ct==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:F,disabled:$e==="working",children:$e==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),Re?e.jsx("button",{type:"button",className:"cta ghost",onClick:D,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),We==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):pe.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:pe.map(N=>e.jsxs("div",{className:"cogita-share-row","data-state":N.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:N.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(N.createdUtc).toLocaleString(),N.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),N.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>E(N.shareId),children:t.cogita.library.revision.shareRevokeAction})]},N.shareId))})]})]})]})]})})})]})})}const Fn=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function sr(t,n,r){if(!t)return null;const s=new Map(t.nodes.map(V=>[V.id,V])),o=new Map,h=new Set,u=V=>{if(typeof V=="number")return V;if(typeof V=="string"){const w=Number(V);return Number.isFinite(w)?w:0}return 0},j=V=>{if(o.has(V))return o.get(V);if(h.has(V))return 0;const w=s.get(V);if(!w)return 0;h.add(V);const C=q=>{var R,K;return(q?((R=w.inputsByHandle)==null?void 0:R[q])??[]:w.inputs??((K=w.inputsByHandle)==null?void 0:K.in)??[]).map(Q=>j(Q))};let f=0;switch(w.type){case"input.random":{const q=w.min??0,$=w.max??q+10,R=Math.min(q,$),K=Math.max(q,$);f=Math.floor(Math.random()*(K-R+1))+R;break}case"input.const":{f=w.value??0;break}case"input.list":{const q=(w.list??[]).filter(Boolean),$=Math.round(u(C("index")[0]));f=q.length?q[Math.max(0,Math.min(q.length-1,$))]:String($);break}case"compute.add":{f=C("in").map($=>u($)).reduce(($,R)=>$+R,0);break}case"compute.sub":{const q=C("add").map(R=>u(R)),$=C("sub").map(R=>u(R));f=q.reduce((R,K)=>R+K,0)-$.reduce((R,K)=>R+K,0);break}case"compute.mul":{const q=C("in").map($=>u($));f=q.length?q.reduce(($,R)=>$*R,1):0;break}case"compute.div":{const q=u(C("num")[0]),$=C("den").map(R=>u(R)).reduce((R,K)=>R+K,0);f=Math.abs($)<Number.EPSILON?0:q/$;break}case"compute.pow":{const q=u(C("base")[0]),$=u(C("exp")[0]);f=Math.pow(q,$);break}case"compute.exp":{const q=u(C("base")[0]),$=u(C("exp")[0]);f=Math.pow(q,$);break}case"compute.log":{const q=u(C("value")[0]),$=u(C("base")[0]),R=Math.max(q,Number.EPSILON);f=Math.abs($)<Number.EPSILON?Math.log(R):Math.log(R)/Math.log($);break}case"compute.abs":{f=Math.abs(u(C("in")[0]));break}case"compute.min":{const q=C("in").map($=>u($));f=q.length?Math.min(...q):0;break}case"compute.max":{const q=C("in").map($=>u($));f=q.length?Math.max(...q):0;break}case"compute.floor":{f=Math.floor(u(C("in")[0]));break}case"compute.ceil":{f=Math.ceil(u(C("in")[0]));break}case"compute.round":{f=Math.round(u(C("in")[0]));break}case"compute.mod":{const q=u(C("a")[0]),$=u(C("b")[0]);f=Math.abs($)<Number.EPSILON?0:q%$;break}case"compute.concat":{const $=["in1","in2","in3","in4","in5","in6"].flatMap(me=>C(me)),R=$.length?$:C("in");f=(R.length?R:C()).map(me=>me==null?"":String(me)).join("");break}case"compute.trim":{const q=C("text")[0]??C("in")[0]??"",$=q==null?"":String(q),R=Math.max(0,Math.round(u(C("start")[0]))),K=Math.max(0,Math.round(u(C("end")[0])));R+K>=$.length?f="":f=$.substring(R,$.length-K);break}case"output":{f=C("in")[0]??0;break}default:f=0}return h.delete(V),o.set(V,f),f},p=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(V=>V.type==="output").map(V=>V.id);t.nodes.forEach(V=>j(V.id)),p.forEach(V=>j(V));const k=V=>Math.abs(V%1)<1e-5?String(Math.round(V)):V.toFixed(3).replace(/\.?0+$/,""),i=V=>typeof V=="number"?k(V):V??"",m=new Map;p.forEach(V=>{var $,R,K,Q;const w=s.get(V);if(!w)return;const C=(R=($=w.inputsByHandle)==null?void 0:$.name)==null?void 0:R[0],f=C?i(o.get(C)):"",q=(f==null?void 0:f.toString().trim())||((K=w.outputLabel)==null?void 0:K.trim())||((Q=w.name)==null?void 0:Q.trim())||V;m.set(V,q)});const l={},c={},v={};p.forEach(V=>{var f,q;const w=s.get(V);if(!w)return;const C=m.get(V)??(((f=w.outputLabel)==null?void 0:f.trim())||((q=w.name)==null?void 0:q.trim())||V);l[C]=i(o.get(V)),w.name&&(c[w.name.trim()]=C),c[V]=C});const g=(V,w)=>{let C=V;return t.nodes.forEach(f=>{var Q,me;const q=i(o.get(f.id)),$=p.includes(f.id),R=$?m.get(f.id)??((Q=f.outputLabel)==null?void 0:Q.trim())??((me=f.name)==null?void 0:me.trim())??f.id:"",K=$&&w?R:q;C=C.replace(new RegExp(`\\{\\s*${Fn(f.id)}\\s*\\}`,"gi"),K),f.name&&(C=C.replace(new RegExp(`\\{\\s*${Fn(f.name)}\\s*\\}`,"gi"),K)),$&&f.outputLabel&&(C=C.replace(new RegExp(`\\{\\s*${Fn(f.outputLabel)}\\s*\\}`,"gi"),R))}),C},S=n;let O=S.trim().length>0?S:"";O||(O=p.length?`Compute ${p.join(", ")}`:"Compute"),O=g(O,!0);const x=(r==null?void 0:r.trim())??"",y=x?g(x,!1):"",_={};return o.forEach((V,w)=>{_[w]=V,v[w]=i(V);const C=s.get(w);C!=null&&C.name&&(v[C.name.trim()]=i(V))}),{prompt:O,answers:l,values:_,answerText:y,outputVariables:c,variableValues:v}}function rr(t){var r;const n=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((r=n[0])==null?void 0:r[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const Kn=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function ir({outcomes:t}){const[n,r]=a.useState("day"),s=a.useMemo(()=>{const o=Kn.find(j=>j.id===n)??Kn[1],h=Date.now()-o.ms,u=t.filter(j=>new Date(j.createdUtc).getTime()>=h);return la(u)},[t,n]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:Kn.map(o=>e.jsx("button",{type:"button",className:"ghost","data-active":n===o.id,onClick:()=>r(o.id),children:o.label},o.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[s.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[s.correct," / ",s.total]})]})}const Zi="cogita-revision",eo=1,on="outcomes",to=()=>new Promise((t,n)=>{const r=indexedDB.open(Zi,eo);r.onupgradeneeded=()=>{const s=r.result;if(!s.objectStoreNames.contains(on)){const o=s.createObjectStore(on,{keyPath:"id"});o.createIndex("byItem","itemKey",{unique:!1}),o.createIndex("byPending","pending",{unique:!1})}},r.onerror=()=>n(r.error),r.onsuccess=()=>t(r.result)}),Ha=async(t,n)=>{const r=await to();return new Promise((s,o)=>{const h=r.transaction(on,t),u=h.objectStore(on);n(u).then(s).catch(o),h.onerror=()=>o(h.error)})},or=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const n=Array.from(t).map(r=>r.toString(16).padStart(2,"0"));return`${n.slice(0,4).join("")}-${n.slice(4,6).join("")}-${n.slice(6,8).join("")}-${n.slice(8,10).join("")}-${n.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},ao=()=>{const t="cogita_revision_client_id",n=localStorage.getItem(t);if(n)return n;const r=or();return localStorage.setItem(t,r),r},no=()=>{const t="cogita_revision_client_seq",n=Number(localStorage.getItem(t)??"0"),r=Number.isFinite(n)?n+1:1;return localStorage.setItem(t,String(r)),r},lr=(t,n,r,s)=>ea(t,n,r,s),ln=async t=>{const n=ao(),r=no(),s=new Date().toISOString(),o={...t,clientId:n,clientSequence:r,createdUtc:s,id:or(),pending:!0};return await Ha("readwrite",h=>new Promise((u,j)=>{const p={...o,itemKey:lr(o.itemType,o.itemId,o.checkType,o.direction)},k=h.add(p);k.onsuccess=()=>u(),k.onerror=()=>j(k.error)})),o},cn=async(t,n,r,s)=>{if(!n)return[];try{const o=lr(t,n,r,s);return await Ha("readonly",h=>new Promise((u,j)=>{const k=h.index("byItem").getAll(o);k.onsuccess=()=>{const m=(k.result??[]).map(l=>({itemType:l.itemType,itemId:l.itemId,checkType:l.checkType??null,direction:l.direction??null,revisionType:l.revisionType,evalType:l.evalType,correct:l.correct,createdUtc:l.createdUtc,maskBase64:l.maskBase64,payloadBase64:l.payloadBase64,payloadHashBase64:l.payloadHashBase64,clientId:l.clientId,clientSequence:l.clientSequence,personRoleId:l.personRoleId??null})).sort((l,c)=>l.createdUtc.localeCompare(c.createdUtc));u(m)},k.onerror=()=>j(k.error)}))}catch{return[]}},ca=async()=>{try{return await Ha("readonly",t=>new Promise((n,r)=>{const s=t.getAll();s.onsuccess=()=>{const h=(s.result??[]).map(u=>({itemType:u.itemType,itemId:u.itemId,checkType:u.checkType??null,direction:u.direction??null,revisionType:u.revisionType,evalType:u.evalType,correct:u.correct,createdUtc:u.createdUtc,maskBase64:u.maskBase64,payloadBase64:u.payloadBase64,payloadHashBase64:u.payloadHashBase64,clientId:u.clientId,clientSequence:u.clientSequence,personRoleId:u.personRoleId??null}));n(h)},s.onerror=()=>r(s.error)}))}catch{return[]}},so=async(t=100)=>{try{return await Ha("readonly",n=>new Promise((r,s)=>{const h=n.index("byPending").getAll(!0);h.onsuccess=()=>{const u=h.result??[];r(u.slice(0,t))},h.onerror=()=>s(h.error)}))}catch{return[]}},ro=async t=>{if(t.length!==0)try{await Ha("readwrite",n=>new Promise((r,s)=>{let o=t.length;t.forEach(h=>{const u=n.get(h);u.onsuccess=()=>{const j=u.result;if(j){j.pending=!1;const p=n.put(j);p.onsuccess=()=>{o-=1,o===0&&r()},p.onerror=()=>s(p.error)}else o-=1,o===0&&r()},u.onerror=()=>s(u.error)})}))}catch{}},_n=async(t,n)=>{const r=await so(200);if(r.length===0)return;const s=new Map;r.forEach(o=>{var u;const h=o.personRoleId??n??"";s.has(h)||s.set(h,[]),(u=s.get(h))==null||u.push(o)});for(const[o,h]of s.entries()){const u=h.map(j=>({itemType:j.itemType,itemId:j.itemId,checkType:j.checkType??null,direction:j.direction??null,revisionType:j.revisionType,evalType:j.evalType,correct:j.correct,clientId:j.clientId,clientSequence:j.clientSequence,maskBase64:j.maskBase64??null,payloadHashBase64:j.payloadHashBase64??null,payloadBase64:j.payloadBase64??null,personRoleId:o||null}));try{await Mr({libraryId:t,outcomes:u}),await ro(h.map(j=>j.id))}catch{}}},Dt=t=>t.trim().toLowerCase(),Wt=t=>{const n=t==null?void 0:t.trim();return n?{fragmentId:n}:null},dn=(t,n)=>{const r=Wt(n);if(!r)return!0;const s=Wt(t);return(s==null?void 0:s.fragmentId)===r.fragmentId},Tt=t=>{const n=t==null?void 0:t.trim().toLowerCase();return n||null},cr=(t,n)=>{if((Tt(t.childItemType)??"info")!==(n.cardType??"").toLowerCase()||t.childItemId!==n.cardId)return!1;const s=Tt(t.childCheckType),o=Tt(t.childDirection),h=Tt(n.checkType),u=Tt(n.direction);return!(s&&s!==h||o&&o!==u)},io={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},oo={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},un=(t,n,r)=>{if(!r||!n.startsWith(t))return n;const s=n.slice(t.length);if(!s)return n;const o=r==="super"?io:oo,h=s.split("").map(u=>o[u]??u).join("");return t+h},hn=(t,n,r)=>{var u,j,p;if(!t)return((u=n[0])==null?void 0:u.key)??null;const s=new Set(n.map(k=>k.key)),o=/\{([^}]+)\}/g;let h;for(;(h=o.exec(t))!==null;){const k=((j=h[1])==null?void 0:j.trim())??"";if(!k)continue;if(s.has(k))return k;const i=r==null?void 0:r[k];if(i&&s.has(i))return i}return((p=n[0])==null?void 0:p.key)??null},Oa=t=>(()=>{const n=new Set;return t.flatMap(r=>{if(r.cardType!=="info"||r.infoType!=="citation")return[r];const s=r.description??"";if(!s.trim())return[r];const o=va(s),h=Object.keys(o.nodes);return h.length===0?[r]:h.map(u=>({...r,checkType:"quote-fragment",direction:u})).filter(u=>{const j=[u.cardId,u.checkType??"",u.direction??""].join("|");return n.has(j)?!1:(n.add(j),!0)})})})();function Dn({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,libraryId:i,collectionId:m,revisionId:l}){const c=Ja(),v=`/#/cogita/library/${i}`,g=a.useMemo(()=>new URLSearchParams(c.search),[c.search]),S=Math.max(1,Number(g.get("limit")??20)),O=g.get("mode")??"random",x=a.useMemo(()=>rs(O),[O]),y=a.useMemo(()=>wn(x,nr(x,g)),[x,g]),_=g.get("check")??"exact",V=g.get("reviewer"),w=(g.get("scope")??"").trim(),C=w==="info"||w==="info-selection"?w:"collection",f=C==="info"?(g.get("infoId")??"").trim():"",q=C==="info-selection"?(g.get("seed")??"").trim():"",[$,R]=a.useState(null),K=m??$??void 0,Q=C==="collection"&&!!K,me=a.useMemo(()=>t.cogita.library.revision[x.labelKey]??O,[t,O,x]),Ae=a.useMemo(()=>_==="exact"?t.cogita.library.revision.checkValue:_,[t,_]),[ee,L]=a.useState(t.cogita.library.collections.defaultName),[ye,W]=a.useState([]),[pe,ae]=a.useState([]),[ke,he]=a.useState("idle"),[ce,Ie]=a.useState({current:0,total:0}),[$e,Fe]=a.useState(0),[Re,et]=a.useState(""),[ct,Te]=a.useState(null),[We,xt]=a.useState(null),[Ve,ze]=a.useState(null),[tt,ot]=a.useState(null),[Ye,Ce]=a.useState([]),[Be,Xe]=a.useState({}),[F,A]=a.useState({}),[D,E]=a.useState(null),[N,T]=a.useState(null),[M,le]=a.useState(null),[be,de]=a.useState(null),[X,P]=a.useState(null),[Y,ne]=a.useState({}),G=a.useRef(0),[Z,xe]=a.useState(null),U=a.useRef(null),se=a.useRef(null),[Le,qe]=a.useState(null),[_e,Je]=a.useState(!1),[bt,mt]=a.useState(null),[pt,wt]=a.useState([]),[Ct,Ot]=a.useState(null),Et=a.useRef(null),Nt=a.useRef(null),[ua,Lt]=a.useState(null),[vt,St]=a.useState(0),kt=a.useRef(null),yt=a.useRef({}),[Kt,st]=a.useState(!1),[Ue,ft]=a.useState({}),[Qt,Vt]=a.useState([]),zt=a.useRef(new Map),[ue,$t]=a.useState(new Set),[Xt,qt]=a.useState(!1),B=a.useRef(null),d=a.useRef(new Set),re=a.useRef({});a.useEffect(()=>{if(!l||m){R(null);return}Zn({libraryId:i,revisionId:l}).then(b=>R(b.collectionId)).catch(()=>R(null))},[m,i,l]);const H=ye[$e]??null,Qe=(H==null?void 0:H.checkType)==="translation-match"&&X,rt=a.useRef(new Map),lt=a.useRef(new Map),It=a.useRef(new Map),Mt=a.useRef(new Map),jt=a.useMemo(()=>H?H.cardType==="vocab"?t.cogita.library.revision.vocabLabel:H.infoType?nt(t,H.infoType):t.cogita.library.revision.infoLabel:"",[t,H]),At=a.useMemo(()=>{var I;return x.id!=="levels"?ye.length:((I=Ue.pool)==null?void 0:I.length)??x.getFetchLimit(S,y)},[Ue,y,x,ye.length,S]),ha=x.getProgressTotal?x.getProgressTotal(ye,Ue,S,y):x.id==="levels"?Math.min(S,At):ye.length,ma=ha?Math.min($e+1,ha):0,Ft=Math.max(1,Number(y.tries??1)),ta=y.compare??"anchors",Ta=Math.max(0,Math.min(100,Number(y.minCorrectness??0))),ut=(y.considerDependencies??"on")==="on",_t=Math.max(0,Math.min(100,Number(y.dependencyThreshold??85))),Zt=b=>{const I=b.slice();for(let J=I.length-1;J>0;J-=1){const ge=Math.floor(Math.random()*(J+1));[I[J],I[ge]]=[I[ge],I[J]]}return I},ja=b=>xa(b,{treatSimilarCharsAsSame:!0})>=Ta,Wa=async()=>{const b=await ca(),I=new Map,J=new Map,ge=new Map;b.forEach(te=>{const Se=`${te.itemType}:${te.itemId}`,Oe=ea(te.itemType,te.itemId,te.checkType,te.direction);if(I.has(Se)||I.set(Se,[]),I.get(Se).push(te),J.has(Oe)||J.set(Oe,[]),J.get(Oe).push(te),te.itemType==="info"&&te.checkType==="quote-fragment"&&te.direction){const Ze=`${te.itemId}:${te.direction}`;ge.has(Ze)||ge.set(Ze,[]),ge.get(Ze).push(te)}});const fe=new Map,oe=new Map,ve=new Map;return I.forEach((te,Se)=>fe.set(Se,la(te).score)),J.forEach((te,Se)=>oe.set(Se,la(te).score)),ge.forEach((te,Se)=>ve.set(Se,la(te).score)),{itemKnowness:fe,cardKnowness:oe,fragmentKnowness:ve}},Gt=async b=>{const I=[];let J=null;for(;;){const ge=await qa({libraryId:i,collectionId:b,limit:200,cursor:J});if(I.push(...ge.items),!ge.nextCursor)break;J=ge.nextCursor}return Oa(I)},Ca=async(b,I)=>{if(zt.current.has(b))return zt.current.get(b)??0;const J=await Gt(b);if(J.length===0)return zt.current.set(b,0),0;const fe=J.reduce((oe,ve)=>{const te=Ne(ve);return oe+(I.get(te)??0)},0)/J.length;return zt.current.set(b,fe),fe},Ia=(b,I)=>{if(!ut||b.cardType!=="info"||b.infoType!=="citation"||b.checkType!=="quote-fragment")return!0;const J=Wt(b.direction);if(!(J!=null&&J.fragmentId))return!0;const ge=b.description??"";if(!ge.trim())return!0;const oe=va(ge).nodes[J.fragmentId];if(!oe||!oe.leftId&&!oe.rightId)return!0;const ve=[oe.leftId,oe.rightId].filter(Oe=>!!Oe);if(ve.length===0)return!0;const te=ve.map(Oe=>{const Ze=ea("info",b.cardId,"quote-fragment",Oe);return I.get(Ze)??0});return te.reduce((Oe,Ze)=>Oe+Ze,0)/te.length>=_t},Pa=async b=>{const I=Ue,J=b.concat(I.active??[]).concat(I.pool??[]).filter((te,Se,Oe)=>Oe.findIndex(Ze=>Ne(Ze)===Ne(te))===Se);if(!ut){$t(new Set(J.map(Ne)));return}const{itemKnowness:ge,cardKnowness:fe}=await Wa(),oe=Qt.filter(te=>Tt(te.childItemType)==="collection"&&te.childItemId===m&&!Tt(te.childCheckType)&&!Tt(te.childDirection)),ve=new Set;for(const te of J){if(te.cardType!=="info"){ve.add(Ne(te));continue}if(!Ia(te,fe))continue;const Se=Qt.filter(He=>cr(He,te)).concat(oe);if(Se.length===0){ve.add(Ne(te));continue}let Oe=0;for(const He of Se)if(Tt(He.parentItemType)==="collection")Oe+=await Ca(He.parentItemId,fe);else if(Tt(He.parentCheckType)||Tt(He.parentDirection)){const at=Tt(He.parentCheckType),it=Tt(He.parentDirection),dt=ea(He.parentItemType,He.parentItemId,at,it);Oe+=fe.get(dt)??0}else{const at=`${He.parentItemType}:${He.parentItemId}`;Oe+=ge.get(at)??0}Oe/Se.length>=_t&&ve.add(Ne(te))}$t(ve)},Qa=b=>{for(let I=b;I<ye.length;I+=1){const J=ye[I];if(J&&(!ut||J.cardType!=="info"||ue.has(Ne(J))))return I}return-1},Ea=b=>!ut||b.cardType!=="info"||ue.has(Ne(b)),kn=b=>{if(x.id!=="temporal"&&x.id!=="levels")return null;const I=Ue,J=(I.active??[]).concat(I.pool??[]),ge=new Set;for(const fe of J){const oe=Ne(fe);if(!(ge.has(oe)||b.has(oe))&&(ge.add(oe),Ea(fe)))return fe}return null},Ut=a.useMemo(()=>{if(x.id!=="levels")return null;const b=Ue,I=b.pool??[],J=b.active??[],ge=b.levelMap??{},fe=Math.max(1,Number(y.levels??1)),oe=Array.from({length:fe},()=>0),ve=new Set(J.map(Ze=>Ne(Ze)));I.forEach(Ze=>{const He=Math.min(fe,Math.max(1,ge[Ne(Ze)]??1));oe[He-1]+=1});const te=I.length||1,Se=oe.map(Ze=>Ze/te*100),Oe=H?ge[Ne(H)]??1:null;return{counts:oe,percentages:Se,currentLevel:Oe,levelsCount:fe,activeCount:J.length,poolCount:I.length,activeSet:ve}},[Ue,y,x,H]),Jt=a.useMemo(()=>{if(x.id!=="temporal")return null;const b=Ue,I=b.pool??[],J=b.active??[],ge=b.knownessMap??{},fe=new Set(b.unknownSet??[]);let oe=0;I.forEach(Se=>{(ge[Ne(Se)]??0)>1&&(oe+=1)});const ve=fe.size,te=J.map(Se=>({id:Ne(Se),value:fe.has(Ne(Se))?0:Math.max(0,Math.min(1,ge[Ne(Se)]??0))}));return{knownCount:oe,unknownCount:ve,dots:te}},[Ue,x]),Nn=a.useMemo(()=>{if(!ut)return 0;const b=Ue;return ye.concat(b.active??[]).concat(b.pool??[]).filter((J,ge,fe)=>fe.findIndex(oe=>Ne(oe)===Ne(J))===ge).filter(J=>J.cardType==="info"&&!ue.has(Ne(J))).length},[ut,Ue,ye,ue]);a.useEffect(()=>{if(!ut||ke!=="ready")return;const b=Ue,J=ye.concat(b.active??[]).concat(b.pool??[]).filter((oe,ve,te)=>te.findIndex(Se=>Ne(Se)===Ne(oe))===ve).filter(oe=>oe.cardType!=="info"||ue.has(Ne(oe))).length,ge=Et.current;if(Et.current=J,ge===null||J<=ge)return;const fe=J-ge;Ot(`New card available (+${fe})`),Nt.current&&window.clearTimeout(Nt.current),Nt.current=window.setTimeout(()=>Ot(null),2200)},[ut,ke,Ue,ye,ue]),a.useEffect(()=>()=>{Nt.current&&window.clearTimeout(Nt.current)},[]);const Bt=(b,I)=>{const J=x.applyOutcome({queue:ye,meta:Ue},H,S,y,{correct:b,correctness:I,createdUtc:new Date().toISOString()});W(J.queue),ft(J.meta);const ge=J.queue[$e+1];ge&&ga(ge,$e+1)};a.useEffect(()=>{if(Q&&K){yn(i,K).then(b=>L(b.name)).catch(()=>L(t.cogita.library.collections.defaultName));return}if(C==="info"&&f){na({libraryId:i,infoId:f}).then(b=>{const I=b.payload??{};L(I.title||I.label||I.name||f)}).catch(()=>L(f||t.cogita.library.revision.runKicker));return}if(C==="info-selection"){const b=q?ms(i,q):null,I=(b==null?void 0:b.infoIds.length)??0;L(I>0?`Selected infos (${I})`:"Selected infos");return}L(t.cogita.library.collections.defaultName)},[t,K,Q,i,C,f,q]),a.useEffect(()=>{Xn({libraryId:i,type:"language"}).then(b=>ae(b)).catch(()=>ae([]))},[i]),a.useEffect(()=>{Q&&Yn({libraryId:i}).then(b=>Vt(b.items??[])).catch(()=>Vt([]))},[Q,i]),a.useEffect(()=>{_n(i,V)},[i,V]),a.useEffect(()=>{Pa(ye)},[ye,Qt,ut,_t,K]),a.useEffect(()=>{if(!H||!ut){qt(!1);return}if(H.cardType!=="info"||ue.has(Ne(H))){qt(!1);return}const b=Qa($e+1);if(b>=0){qt(!1),Fe(b);return}if(x.id==="temporal"||x.id==="levels"){const I=ye.slice(0,$e+1),J=ye.slice($e+1).filter(Ea),ge=I.concat(J),fe=new Set(ge.map(Ne)),oe=kn(fe);if(oe){const te=Ne(oe);fe.has(te)||(ge.push(oe),fe.add(te),ft(Se=>{const Oe=Se,Ze=new Set(Oe.queued??[]);return Ze.add(te),{...Oe,queued:Ze}}))}const ve=ge.findIndex((te,Se)=>Se!==$e&&Ea(te));if(ve>=0){W(ge),Fe(ve),qt(!1);return}}qt(!0)},[H,ue,ut,$e,ye,Ue,x.id]),a.useEffect(()=>{let b=!0;return(async()=>{he("loading"),Ie({current:0,total:x.id==="levels"?0:x.getFetchLimit(S,y)});try{if(!Q){if(Vt([]),C==="info"){if(!f){b&&(W([]),Vt([]),ft({}),Fe(0),he("ready"));return}const[He,at]=await Promise.all([tn({libraryId:i,infoId:f}),an({libraryId:i,infoId:f})]);if(!b)return;const it=Oa(He.items??[]);Vt(at.items??[]);const dt=x.prepare(it,S,y);W(dt.queue),ft(dt.meta),Fe(0),he("ready"),Ie({current:it.length,total:it.length});return}if(C==="info-selection"){const He=q?ms(i,q):null,at=(He==null?void 0:He.infoIds)??[];if(!at.length){b&&(W([]),Vt([]),ft({}),Fe(0),he("ready"));return}const it=await Promise.all(at.map(async pa=>{const[Ht,Ga]=await Promise.all([tn({libraryId:i,infoId:pa}),an({libraryId:i,infoId:pa})]);return{cards:Ht.items??[],deps:Ga.items??[]}}));if(!b)return;const dt=new Map;it.forEach(pa=>{Oa(pa.cards).forEach(Ht=>{dt.set(Ne(Ht),Ht)})});const ht=Array.from(dt.values()),gt=new Set(ht.map(Ne)),Rt=new Map;it.forEach(pa=>{(pa.deps??[]).forEach(Ht=>{const Ga=ea(Ht.parentItemType,Ht.parentItemId,Tt(Ht.parentCheckType),Tt(Ht.parentDirection)),is=ea(Ht.childItemType,Ht.childItemId,Tt(Ht.childCheckType),Tt(Ht.childDirection));if(!gt.has(Ga)||!gt.has(is))return;const os=`${Ga}->${is}`;Rt.has(os)||Rt.set(os,Ht)})}),Vt(Array.from(Rt.values()));const ka=x.prepare(ht,S,y);W(ka.queue),ft(ka.meta),Fe(0),he("ready"),Ie({current:ht.length,total:ht.length});return}}const J=[];let ge=null,fe=null;do{const He=await qa({libraryId:i,collectionId:K,limit:300,cursor:ge});if(J.push(...He.items),(x.id==="levels"||x.id==="temporal")&&He.total&&(fe=He.total),Ie(at=>({current:J.length,total:at.total||He.total||x.getFetchLimit(S,y)})),ge=He.nextCursor??null,fe!==null&&J.length>=fe||x.id!=="levels"&&x.id!=="temporal"&&J.length>=x.getFetchLimit(S,y))break}while(ge);if(!b)return;const oe=Oa(J);let ve;if(x.id==="levels"){const He=Math.max(1,Number(y.levels??1)),it=(await ca()).reduce((dt,ht)=>{const gt=ea(ht.itemType,ht.itemId,ht.checkType,ht.direction);return dt[gt]||(dt[gt]=[]),dt[gt].push(ht),dt},{});ve={},oe.forEach(dt=>{const ht=Ne(dt),gt=it[ht]??[],Rt=gt.length>0?la(gt).score:0,ka=Math.max(1,Math.min(He,Math.ceil(Rt/100*He)));ve[ht]=ka})}let te=null,Se=null,Oe=null;if(x.id==="temporal"){const He=await ca(),at=new Set(oe.map(ht=>Ne(ht))),it=He.reduce((ht,gt)=>{const Rt=ea(gt.itemType,gt.itemId,gt.checkType,gt.direction);return at.has(Rt)&&(ht[Rt]||(ht[Rt]=[]),ht[Rt].push(gt)),ht},{});te={},Se=new Set,Oe={};const dt=Date.now();oe.forEach(ht=>{const gt=Ne(ht),Rt=it[gt]??[];if(Rt.length===0){te[gt]=0,Se.add(gt),Oe[gt]=[];return}const ka=as(Rt);Oe[gt]=ka;const pa=vn(ka,dt);te[gt]=pa.knowness})}const Ze=x.id==="levels"?ss(oe,S,y,ve):x.id==="temporal"?ns(oe,S,y,te??{},Se??new Set,Oe??{}):x.prepare(oe,S,y);W(Ze.queue),ft(Ze.meta),Fe(0),he("ready"),Ie(He=>({current:Math.min(He.current,He.total),total:He.total}))}catch{b&&he("error")}})(),()=>{b=!1}},[K,Q,i,S,C,y,x,V,f,q]),a.useEffect(()=>{if(et(""),Te(null),Lt(null),St(0),Ce([]),Xe({}),A({}),T(null),le(null),de(null),Je(!1),st(!1),qe(null),P(null),ne({}),!H){xt(null),ze(null),E(null),mt(null);return}H.cardType==="info"&&H.infoType==="computed"&&xt(t.cogita.library.revision.loadingComputed);let b=!0;return ga(H,$e).then(I=>{!b||!I||(xt(I.prompt),ze(I.expectedAnswer),Ce(I.computedExpected),Xe(I.computedAnswers),E(I.computedValues),T(I.answerTemplate),le(I.outputVariables),de(I.variableValues))}),()=>{b=!1}},[H,t]),a.useEffect(()=>{if(!H||H.cardType!=="info"||H.infoType!=="citation"){B.current=null,d.current=new Set,ot(null);return}const b=H.description??"",I=(H.label??"").trim(),J=I.replace(/\s+/g," ").trim(),ge=b.replace(/\s+/g," ").trim(),fe=J&&J!==ge?I:t.cogita.library.infoTypes.citation;if(!b){ot(null),ze(null);return}const oe=va(b);B.current=oe,xt(fe);let ve=!0;return Wa().then(({fragmentKnowness:te})=>{if(!ve)return;const Se=new Set,Oe={};te.forEach((at,it)=>{const[dt,ht]=it.split(":",2);if(dt!==H.cardId)return;const gt=Wt(ht);if(!gt)return;const{fragmentId:Rt}=gt;Oe[Rt]=at,at>=_t&&Se.add(Rt)}),d.current=Se,re.current=Oe;const Ze=Wt(H.direction);if(Ze!=null&&Ze.fragmentId&&oe.nodes[Ze.fragmentId]){z(oe,Ze.fragmentId,fe);return}const He=$a(oe,Se,Oe,_t,ut,H.direction);z(oe,(He==null?void 0:He.id)??null,fe)}).catch(()=>{d.current=new Set,re.current={};const te=Wt(H.direction);if(te!=null&&te.fragmentId&&oe.nodes[te.fragmentId]){z(oe,te.fragmentId,fe);return}const Se=$a(oe,d.current,{},_t,ut,H.direction);z(oe,(Se==null?void 0:Se.id)??null,fe)}),()=>{ve=!1}},[H,t,ut,_t]),a.useEffect(()=>{if(!H||H.cardType!=="vocab"||H.checkType!=="translation-match"){P(null),ne({});return}const J=(Ue.pool??Ue.active??ye).filter(te=>te.cardType==="vocab"&&te.checkType==="translation-match").filter((te,Se,Oe)=>Oe.findIndex(Ze=>Ze.cardId===te.cardId)===Se);J.some(te=>te.cardId===H.cardId)||J.unshift(H);const fe=Zt(J).slice(0,6).map(te=>{const Se=te.label.split("↔").map(He=>He.trim()).filter(Boolean);if(Se.length<2)return null;const Oe=`${te.cardId}:L`,Ze=`${te.cardId}:R`;return{cardId:te.cardId,leftId:Oe,rightId:Ze,leftLabel:Se[0],rightLabel:Se[1]}}).filter(Boolean),oe=fe.map(te=>te.leftId),ve=Zt(fe.map(te=>te.rightId));P({pairs:fe,leftOrder:oe,rightOrder:ve,selection:{},activeLeft:null,activeRight:null,locked:{}})},[H,ye,Ue]),a.useEffect(()=>()=>{U.current&&window.clearTimeout(U.current),se.current&&window.clearTimeout(se.current)},[]);const sa=a.useRef(null);a.useEffect(()=>{if(!H)return;const b=Ne(H),I=typeof document<"u"?document.activeElement:null;if(sa.current===b&&I&&(I.tagName==="INPUT"||I.tagName==="TEXTAREA"))return;let J=0;const ge=()=>{if(H){if(H.cardType==="info"&&H.infoType==="computed"){if(Ye.length>0){const oe=hn(N,Ye,M),ve=oe?yt.current[oe]:null;if(ve&&(ve.focus(),document.activeElement===ve)){sa.current=b;return}}if(kt.current&&(kt.current.focus(),document.activeElement===kt.current)){sa.current=b;return}}else if(H.cardType==="vocab"&&kt.current&&(kt.current.focus(),document.activeElement===kt.current)){sa.current=b;return}J<6&&(J+=1,window.setTimeout(ge,40))}},fe=window.setTimeout(ge,40);return()=>window.clearTimeout(fe)},[H,Ye,N,M]),a.useEffect(()=>{if(!Kt)return;const b=I=>{I.key==="Enter"&&(I.preventDefault(),La())};return window.addEventListener("keydown",b),()=>window.removeEventListener("keydown",b)},[Kt]);const Ma=b=>{wt(b),mt(la(b))};a.useEffect(()=>{if(!H){mt(null),wt([]);return}const b=H.cardType==="info"?"info":"connection";if(H.cardType==="info"&&H.infoType==="citation"){ca().then(I=>{const J=I.filter(ge=>ge.itemType==="info"&&ge.itemId===H.cardId&&ge.checkType==="quote-fragment"&&dn(ge.direction,H.direction));Ma(J)}).catch(()=>{mt(null),wt([])});return}cn(b,H.cardId,H.checkType,H.direction).then(I=>Ma(I)).catch(()=>{mt(null),wt([])})},[i,H,V]);const wa=(b,I,J,ge)=>{if(b==="info"&&J==="quote-fragment"){ca().then(fe=>{const oe=fe.filter(ve=>ve.itemType==="info"&&ve.itemId===I&&ve.checkType==="quote-fragment"&&dn(ve.direction,ge));Ma(oe)}).catch(()=>{mt(null),wt([])});return}cn(b,I,J,ge).then(fe=>Ma(fe)).catch(()=>{mt(null),wt([])})},Fa=(b,I,J)=>{var ve;const ge=((ve=J.pairs.find(te=>te.leftId===b))==null?void 0:ve.rightId)??null;if(!ge)return J;const fe=ge===I;ne(te=>({...te,[b]:fe?"correct":"incorrect"})),U.current&&window.clearTimeout(U.current),se.current&&window.clearTimeout(se.current),G.current+=1;const oe={kind:fe?"correct":"incorrect",tick:G.current};if(xe(null),U.current=window.setTimeout(()=>xe(oe),0),se.current=window.setTimeout(()=>xe(null),420),fe){const te={...J.locked,[b]:!0};return Object.keys(te).length>=J.pairs.length?(Te("correct"),st(!0)):Te("correct"),{...J,selection:{...J.selection,[b]:I},activeLeft:null,activeRight:null,locked:te}}return Te("incorrect"),{...J,activeLeft:null,activeRight:null}},Sn=b=>{P(I=>!I||I.locked[b]?I:I.activeRight?Fa(b,I.activeRight,I):{...I,activeLeft:I.activeLeft===b?null:b})},Tn=b=>{P(I=>I&&(I.activeLeft?Fa(I.activeLeft,b,I):{...I,activeRight:I.activeRight===b?null:b}))},La=()=>{var b;if(H&&H.cardType==="info"&&H.infoType==="citation"&&B.current&&tt&&!((b=Wt(H.direction))!=null&&b.fragmentId)){const I=$a(B.current,d.current,re.current,_t,ut,H.direction,tt.fragmentId);if(I){Te(null),et(""),Je(!1),A({}),st(!1),Lt(null),St(0),z(B.current,I.id,tt.title);return}}Te(null),et(""),Je(!1),A({}),st(!1),Lt(null),St(0),Fe(I=>Math.min(I+1,ye.length))},aa=b=>{if(!H)return;const I=b.expected??null,J=b.answer??"";let ge=I??"",fe=J;if(!I&&b.expectedMap&&b.answerMap){const He=Object.keys(b.expectedMap).sort((at,it)=>at.localeCompare(it));ge=He.map(at=>{var it;return((it=b.expectedMap)==null?void 0:it[at])??""}).join("|"),fe=He.map(at=>{var it;return((it=b.answerMap)==null?void 0:it[at])??""}).join("|")}const oe=ge?Ra(ge,fe,ta):new Uint8Array,ve={revisionType:x.id,evalType:b.evalType,direction:b.direction,prompt:We??"",expected:I,answer:J,expectedAnswers:b.expectedMap??null,answers:b.answerMap??null,correct:b.correct,maskBase64:oe.length?ya(oe):null,values:D??null,checkMode:_,compareMode:ta,minCorrectness:Ta},te=new TextEncoder().encode(JSON.stringify(ve)),Se=H.cardType==="info"?"info":"connection",Oe=b.overrideCheckType??H.checkType??null,Ze=b.overrideDirection??H.direction??null;ln({itemType:Se,itemId:H.cardId,checkType:Oe,direction:Ze,revisionType:x.id,evalType:b.evalType,correct:b.correct,maskBase64:oe.length?ya(oe):null,payloadBase64:ya(te),personRoleId:V??null}).then(()=>{wa(Se,H.cardId,Oe,Ze),Pa(ye),_n(i,V)}).catch(()=>{})},Cn=(b,I)=>{const J=rt.current.get(I);if(J)return Promise.resolve(J);const ge=lt.current.get(I);if(ge)return ge;const fe=na({libraryId:i,infoId:b}).then(oe=>{var He,at;const ve=oe.payload,te=((He=ve.definition)==null?void 0:He.graph)??null,Se="",Oe=((at=ve.definition)==null?void 0:at.answerTemplate)??"",Ze=sr(te,Se,Oe);if(Ze){const dt={sample:rr(Ze),answerTemplate:Oe||null};return rt.current.set(I,dt),dt}return Un({libraryId:i,infoId:b}).then(it=>{const dt={sample:it,answerTemplate:null};return rt.current.set(I,dt),dt})}).catch(()=>Un({libraryId:i,infoId:b}).then(oe=>{const ve={sample:oe,answerTemplate:null};return rt.current.set(I,ve),ve}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{lt.current.delete(I)});return lt.current.set(I,fe),fe},ga=(b,I)=>{var te;const J=`${Ne(b)}:${I}`,ge=It.current.get(J);if(ge)return Promise.resolve(ge);const fe=Mt.current.get(J);if(fe)return fe;const oe=Se=>(It.current.set(J,Se),Se);let ve;if(b.cardType==="vocab"){if(b.checkType==="translation-match")return ve=Promise.resolve(oe({prompt:b.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),ve;const Se=b.label.split("↔").map(Oe=>Oe.trim()).filter(Boolean);if(Se.length>=2){const Ze=(b.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",He=Ze?Se[0]:Se[1],at=Ze?Se[1]:Se[0];ve=Promise.resolve(oe({prompt:He,expectedAnswer:at,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else ve=Promise.resolve(oe({prompt:b.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(b.cardType==="info"&&b.infoType==="word"){const Se=(te=b.description)!=null&&te.startsWith("Language: ")?b.description.replace("Language: ",""):null;ve=Promise.resolve(oe({prompt:b.label,expectedAnswer:Se,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else b.cardType==="info"&&b.infoType==="computed"?ve=Cn(b.cardId,J).then(Se=>{var it,dt;if(!Se.sample)return oe({prompt:b.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const Oe=Se.sample,Ze=Oe.expectedAnswers?Object.entries(Oe.expectedAnswers).map(([ht,gt])=>({key:ht,expected:gt})):[],He=Ze.reduce((ht,gt)=>(ht[gt.key]="",ht),{}),at=Oe.expectedAnswerIsSentence&&((it=Oe.expectedAnswer)==null?void 0:it.trim())||null;return oe({prompt:Oe.prompt,expectedAnswer:Ze.length>0?at:((dt=Oe.expectedAnswer)==null?void 0:dt.trim())||null,computedExpected:Ze,computedAnswers:He,computedValues:Oe.values??null,answerTemplate:Se.answerTemplate,outputVariables:Oe.outputVariables??null,variableValues:Oe.variableValues??null})}).catch(()=>oe({prompt:b.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Mt.current.delete(J)}):ve=Promise.resolve(oe({prompt:b.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return Mt.current.set(J,ve),ve},z=(b,I,J)=>{const ge=Object.keys(b.nodes).length,fe=d.current.size;if(!I){ot({title:J,before:b.text,after:"",fragmentId:null,total:ge,completed:fe}),ze(null),st(!0);return}const oe=b.nodes[I];if(!oe)return;const ve=xn(b.text,oe);ot({title:J,before:ve.before,after:ve.after,fragmentId:oe.id,total:ge,completed:fe}),ze(ve.fragment),st(!1)},ie=()=>{const b=B.current;b&&ot(I=>I&&{...I,total:Object.keys(b.nodes).length,completed:d.current.size})},je=()=>{const b=ye[$e+1];b&&ga(b,$e+1)},Ke=()=>{if(je(),H&&H.cardType==="vocab"&&H.checkType==="translation-match"&&X){if(X.pairs.length===0){Te("incorrect"),st(!0);return}const oe=X.pairs.reduce((at,it)=>(at[it.rightId]=it.rightLabel,at),{});let ve=0;const te={};X.pairs.forEach(at=>{const dt=X.selection[at.leftId]===at.rightId;te[at.leftId]=dt?"correct":"incorrect",dt&&(ve+=1)});const Se=X.pairs.length||1,Oe=ve/Se,Ze=ve===X.pairs.length;ne(at=>({...at,...te})),Ze?(Te("correct"),st(!0),St(0)):(Te("incorrect"),st(!1),St(at=>{const it=at+1;return it>=Ft&&(Je(!0),st(!0),P(dt=>{if(!dt)return dt;const ht=dt.pairs.reduce((gt,Rt)=>(gt[Rt.leftId]=Rt.rightId,gt),{});return{...dt,selection:ht}})),it})),Bt(Ze,Oe);const He="connection";Promise.all(X.pairs.map(at=>{const it=X.selection[at.leftId]??null,dt=it?oe[it]:"",ht={left:at.leftLabel,expected:at.rightLabel,answer:dt,checkType:"translation-match"},gt=new TextEncoder().encode(JSON.stringify(ht));return ln({itemType:He,itemId:at.cardId,checkType:"translation-match",direction:null,revisionType:x.id,evalType:"translation-match",correct:it===at.rightId,maskBase64:null,payloadBase64:ya(gt),personRoleId:V??null})})).then(()=>{wa(He,H.cardId,H.checkType,H.direction),_n(i,V)}).catch(()=>{});return}if(Ye.length>0){const oe=Ye.reduce((te,Se)=>{const Oe=Be[Se.key]??"";return te[Se.key]=Dt(Oe)===Dt(Se.expected)?"correct":"incorrect",te},{});Ye.every(({key:te,expected:Se})=>{const Oe=Be[te]??"";return _==="exact"&&Dt(Oe)===Dt(Se)})?(Te("correct"),A(oe),st(!0),St(0),Bt(!0,1),aa({correct:!0,direction:We?`${We} -> computed`:"computed",expectedMap:Ye.reduce((te,Se)=>(te[Se.key]=Se.expected,te),{}),answerMap:Be,evalType:"computed"})):(Te("incorrect"),A(oe),st(!1),St(te=>{const Se=te+1;return Se>=Ft&&Ge&&(Je(!0),st(!0)),Se}),Bt(!1,0),window.setTimeout(()=>{var Se;const te=hn(N,Ye,M);te&&yt.current[te]&&((Se=yt.current[te])==null||Se.focus())},40),aa({correct:!1,direction:We?`${We} -> computed`:"computed",expectedMap:Ye.reduce((te,Se)=>(te[Se.key]=Se.expected,te),{}),answerMap:Be,evalType:"computed"}));return}if(H&&H.cardType==="info"&&H.infoType==="citation"&&(tt!=null&&tt.fragmentId)){if(!Ve)return;const oe=Wt(H.direction),ve=(oe==null?void 0:oe.fragmentId)??tt.fragmentId,te=Sa(Ve,Re,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Se=te.mask,Oe=te.isCorrect,Ze=te.percent;Oe?(re.current[tt.fragmentId]=Math.max(re.current[tt.fragmentId]??0,Ze),(re.current[tt.fragmentId]??0)>=_t&&d.current.add(tt.fragmentId),ie(),Te("correct"),A({}),st(!0),Lt(Se),St(0),Ze<100&&Ft<=1&&Je(!0),Bt(!0,Ze/100),aa({correct:!0,direction:`quote:${tt.fragmentId}`,expected:Ve,answer:Re,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:ve})):(Te("incorrect"),A({}),st(!1),Lt(Se),St(He=>{const at=He+1;return at>=Ft&&Ge&&(Je(!0),st(!0)),at}),Bt(!1,Ze/100),window.setTimeout(()=>{var He;return(He=kt.current)==null?void 0:He.focus()},40),aa({correct:!1,direction:`quote:${tt.fragmentId}`,expected:Ve,answer:Re,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:ve}));return}if(!Ve)return;const b=Ra(Ve,Re,ta),I=_==="exact"&&Dt(Re)===Dt(Ve),J=ja(b),ge=I||J,fe=xa(b);ge?(Te("correct"),A({}),st(!0),Lt(b),St(0),fe<100&&Ft<=1&&Je(!0),Bt(!0,fe/100),aa({correct:!0,direction:We?`${We} -> ${Ve}`:null,expected:Ve,answer:Re,evalType:"text"})):(Te("incorrect"),A({}),st(!1),Lt(b),St(oe=>{const ve=oe+1;return ve>=Ft&&Ge&&(Je(!0),st(!0)),ve}),Bt(!1,fe/100),window.setTimeout(()=>{var oe;return(oe=kt.current)==null?void 0:oe.focus()},40),aa({correct:!1,direction:We?`${We} -> ${Ve}`:null,expected:Ve,answer:Re,evalType:"text"}))},De=b=>{if(je(),!Ve)return;const I=Ra(Ve,b,ta),J=Dt(b)===Dt(Ve),ge=ja(I),fe=J||ge,oe=xa(I);fe?(Te("correct"),A({}),st(!0),Lt(I),St(0),oe<100&&Ft<=1&&Je(!0),Bt(!0,oe/100),aa({correct:!0,direction:"word->language",expected:Ve,answer:b,evalType:"language-select"})):(Te("incorrect"),A({}),st(!1),Lt(I),St(ve=>{const te=ve+1;return te>=Ft&&Ge&&(Je(!0),st(!0)),te}),Bt(!1,oe/100),aa({correct:!1,direction:"word->language",expected:Ve,answer:b,evalType:"language-select"}))},we=()=>{je(),Te("correct"),st(!0),St(0),Bt(!0,1),Ve&&aa({correct:!0,direction:"manual",expected:Ve,answer:Re,evalType:"manual"})},Pe=()=>{if(Bt(!1,0),H&&H.cardType==="info"&&H.infoType==="citation"){Te(null),et(""),Je(!1),A({}),st(!1),Lt(null),St(0),Fe(b=>Math.min(b+1,ye.length));return}La()};a.useEffect(()=>{je()},[$e,ye]);const Me=b=>{var J;if(b.key!=="Enter")return;if(b.preventDefault(),b.stopPropagation(),Kt){La();return}const I=Ye.find(ge=>!(Be[ge.key]??"").trim());if(I){(J=yt.current[I.key])==null||J.focus();return}Ke()},Ee=t.cogita.library.revision.revealModeAfterIncorrect,Ge=Ye.length>0||!!Ve;return e.jsxs(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,children:[ke==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${ce.total?Math.min(100,Math.max(0,ce.current/ce.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:ce.total?`${Math.min(ce.current,ce.total)} / ${ce.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:ee}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",me).replace("{check}",Ae)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),Q?e.jsxs(e.Fragment,{children:[e.jsx("a",{className:"cta ghost",href:`${v}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${v}/collections/${K}`,children:t.cogita.library.actions.collectionDetail})]}):e.jsx("a",{className:"cta ghost",href:`${v}/list`,children:t.cogita.library.actions.allCards})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:bt?`${bt.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Ut?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Ut.currentLevel??"-"," / ",Ut.levelsCount]}):null,bt?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(bt.correct)).replace("{total}",String(bt.total))}),bt.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(bt.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(ir,{outcomes:pt})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[Ct?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:Ct})}):null,e.jsx(es,{feedbackToken:Z?`${Z.kind}-${Z.tick}`:Qe?"idle":ct??"idle",children:H?e.jsx(e.Fragment,{children:Xt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(ts,{copy:t,currentCard:H,currentTypeLabel:jt,prompt:We,languages:pe,answer:Re,onAnswerChange:b=>et(I=>un(I,b,Le)),computedExpected:Ye,computedAnswers:Be,onComputedAnswerChange:(b,I)=>Xe(J=>({...J,[b]:un(J[b]??"",I,Le)})),answerTemplate:N,outputVariables:M,variableValues:be,computedFieldFeedback:F,feedback:ct,canAdvance:Kt,quoteContext:tt,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Ke,onSkip:Pe,onLanguageSelect:De,onMarkReviewed:we,onAdvance:La,showCorrectAnswer:_e,setShowCorrectAnswer:Je,onRevealCorrect:()=>st(!0),answerMask:ua,expectedAnswer:Ve,hasExpectedAnswer:Ge,handleComputedKeyDown:Me,answerInputRef:kt,computedInputRefs:yt,scriptMode:Le,setScriptMode:qe,matchPairs:X==null?void 0:X.pairs,matchLeftOrder:X==null?void 0:X.leftOrder,matchRightOrder:X==null?void 0:X.rightOrder,matchSelection:X==null?void 0:X.selection,matchActiveLeft:X==null?void 0:X.activeLeft,matchActiveRight:X==null?void 0:X.activeRight,matchFeedback:Y,onMatchLeftSelect:Sn,onMatchRightSelect:Tn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:Q?`${v}/collections/${K}`:`${v}/list`,children:Q?t.cogita.library.actions.collectionDetail:t.cogita.library.actions.allCards})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:ha?`${ma} / ${ha}`:t.cogita.library.revision.progressUnlimited}),ke==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),ke==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),ke==="ready"&&ye.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Ee}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",Ft]})]})]}),Ut?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Ut.activeCount," / ",Ut.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Ut.counts.map((b,I)=>{const J=I+1,ge=Ut.currentLevel===J,fe=Ut.percentages[I]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":ge,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:J}),e.jsx("strong",{children:b})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,fe))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[fe.toFixed(1),"%"]})]},`level-${J}`)})})]}):null,Jt?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:Jt.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:Jt.dots.map(b=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,b.value*100))}%`,background:`rgba(${Math.round(255*(1-b.value))}, ${Math.round(200*b.value)}, 80, 0.9)`}},b.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:Jt.knownCount})]})]}):null,ut?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Nn})]})}):null]})]})]})})})]})]})}const zn=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],lo={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},co=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],uo=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function ho({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,libraryId:i,collectionId:m}){const[l,c]=a.useState(""),[v,g,S]=Hn([]),[O,x,y]=Wn([]),[_,V]=a.useState(null),[w,C]=a.useState(null),[f,q]=a.useState(null),$=`/#/cogita/library/${i}`;a.useEffect(()=>{yn(i,m).then(L=>c(L.name)).catch(()=>c(t.cogita.library.collections.defaultName))},[i,m,t]),a.useEffect(()=>{Lr({libraryId:i,collectionId:m}).then(L=>{if(!L.graphId||L.graphId==="00000000-0000-0000-0000-000000000000"){g([]),x([]);return}const ye=L.nodes.map(pe=>{var ce;const ae=pe.payload??{},ke=ae.position??{x:120,y:120},he=ae.params??{};return{id:pe.nodeId,type:"default",position:ke,data:{nodeType:pe.nodeType,label:((ce=zn.find(Ie=>Ie.type===pe.nodeType))==null?void 0:ce.label)??pe.nodeType,params:he}}}),W=L.edges.map(pe=>({id:pe.edgeId,source:pe.fromNodeId,target:pe.toNodeId,sourceHandle:pe.fromPort??void 0,targetHandle:pe.toPort??void 0}));g(ye),x(W)}).catch(()=>{g([]),x([])})},[i,m,x,g]);const R=a.useMemo(()=>v.find(L=>L.id===_)??null,[v,_]),K=L=>{var ae;const ye=crypto.randomUUID(),W=((ae=zn.find(ke=>ke.type===L))==null?void 0:ae.label)??L,pe={...lo[L]};g(ke=>[...ke,{id:ye,type:"default",position:{x:120+ke.length*40,y:120+ke.length*40},data:{nodeType:L,label:W,params:pe}}]),V(ye)},Q=a.useCallback(L=>{x(ye=>Qn({...L,id:crypto.randomUUID()},ye))},[x]),me=async()=>{C(null);try{await Qs({libraryId:i,collectionId:m,nodes:v.map(L=>({nodeId:L.id,nodeType:L.data.nodeType,payload:{position:L.position,params:L.data.params}})),edges:O.map(L=>({edgeId:L.id,fromNodeId:L.source,fromPort:L.sourceHandle??null,toNodeId:L.target,toPort:L.targetHandle??null}))}),C(t.cogita.library.graph.saveSuccess)}catch{C(t.cogita.library.graph.saveFail)}},Ae=async()=>{try{const L=await Ar({libraryId:i,collectionId:m});q(L)}catch{q(null)}},ee=L=>{R&&g(ye=>ye.map(W=>W.id===R.id?{...W,data:{...W.data,params:L}}:W))};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${$}/collections/${m}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Ae,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:me,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:zn.map(L=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>K(L.type),children:L.label},L.type))}),w?e.jsx("p",{className:"cogita-help",children:w}):null,f&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(f.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(f.connections)).replace("{infos}",String(f.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(pn,{nodes:v,edges:O,onNodesChange:S,onEdgesChange:y,onConnect:Q,onNodeClick:(L,ye)=>V(ye.id),fitView:!0,children:[e.jsx(fn,{color:"rgba(120,160,200,0.2)"}),e.jsx(bn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),R?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:R.data.label}),R.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:i,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:R.data.params.tagId?{id:R.data.params.tagId,label:R.data.params.tagLabel??"",infoType:"topic"}:null,onChange:L=>ee({...R.data.params,tagId:(L==null?void 0:L.id)??null,tagLabel:(L==null?void 0:L.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:R.data.params.scope??"any",onChange:L=>ee({...R.data.params,scope:L.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),R.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:i,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:R.data.params.languageId?{id:R.data.params.languageId,label:R.data.params.languageLabel??"",infoType:"language"}:null,onChange:L=>ee({...R.data.params,languageId:(L==null?void 0:L.id)??null,languageLabel:(L==null?void 0:L.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:R.data.params.scope??"any",onChange:L=>ee({...R.data.params,scope:L.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),R.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:R.data.params.infoType??"word",onChange:L=>ee({...R.data.params,infoType:L.target.value}),children:uo.map(L=>e.jsx("option",{value:L.value,children:L.label},L.value))})]}),e.jsx(Yt,{libraryId:i,infoType:R.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:R.data.params.infoId?{id:R.data.params.infoId,label:R.data.params.infoLabel??"",infoType:R.data.params.infoType??"word"}:null,onChange:L=>ee({...R.data.params,infoId:(L==null?void 0:L.id)??null,infoLabel:(L==null?void 0:L.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),R.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:R.data.params.connectionType??"translation",onChange:L=>ee({...R.data.params,connectionType:L.target.value}),children:co.map(L=>e.jsx("option",{value:L.value,children:L.label},L.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:R.data.params.connectionId??"",onChange:L=>ee({...R.data.params,connectionId:L.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(R.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const Bn="cogita.preferences",On="cogita.reviewer.preferences",dr=["library_overview","all_cards","all_collections","all_revisions","storyboards","texts","dependencies","transfer"],Vn={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},all_revisions:{requiresCollection:!1,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},go=["settings","run","shared"],Aa=30,Ks=42;function fa(t,n){const r=(t??"").trim();return r.length<=n?r:n<=1?r.slice(0,n):`${r.slice(0,Math.max(1,n-1)).trimEnd()}…`}function mo(t,n=""){const r=t.split("/").filter(Boolean);if(r[0]!=="cogita"||r[1]!=="library")return{};const s=r[2];if(!s)return{};if(!r[3])return{libraryId:s,target:"library_overview"};const o=new URLSearchParams(n),h=o.get("revisionId")??void 0,u=o.get("infoId")??void 0,j=o.get("infoView"),p=j==="cards"?"cards":j==="collections"?"collections":"overview",k=o.get("collectionView")==="overview"?"overview":"infos",i=o.get("collectionAction"),m=o.get("libraryAction"),c=o.get("libraryTarget")==="revisions"?"all_revisions":"all_collections";if(r[3]==="list")return{libraryId:s,target:m==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:h,infoId:u,infoView:p,libraryAction:m==="new-info"?"new-info":void 0};if(r[3]==="detail"||r[3]==="collection")return{libraryId:s,target:"all_cards",cardMode:r[3],revisionId:h,infoId:u,infoView:p};if(r[3]==="new"||r[3]==="add")return{libraryId:s,target:"new_card",revisionId:h,libraryAction:"new-info"};if(r[3]==="edit")return{libraryId:s,target:"new_card",revisionId:h,infoId:r[4]};if(r[3]==="infos"){const g=r[4];return g?r[5]==="checkcards"?{libraryId:s,target:"all_cards",cardMode:"list",revisionId:h,infoId:g,infoView:"cards"}:r[5]==="collections"?{libraryId:s,target:"all_cards",cardMode:"list",revisionId:h,infoId:g,infoView:"collections"}:{libraryId:s,target:"all_cards",cardMode:"list",revisionId:h,infoId:g,infoView:"overview"}:{libraryId:s,target:"all_cards",cardMode:"list",revisionId:h}}if(r[3]==="shared-revisions")return{libraryId:s,target:c,revisionId:h};if(r[3]==="revisions"){const g=r[4];return g?g==="shared-links"?{libraryId:s,target:"all_revisions",revisionView:"shared"}:g==="new"?{libraryId:s,target:"all_revisions",revisionView:"new"}:r[5]==="run"?{libraryId:s,target:"all_revisions",revisionId:g,revisionView:"run"}:r[5]==="shared"?{libraryId:s,target:"all_revisions",revisionId:g,revisionView:"shared"}:{libraryId:s,target:"all_revisions",revisionId:g,revisionView:"settings"}:{libraryId:s,target:"all_revisions"}}if(r[3]==="revision"&&r[4]==="run")return{libraryId:s,target:c,revisionView:"run",revisionId:h,infoId:u,infoView:p};if(r[3]==="dependencies")return{libraryId:s,target:"dependencies"};if(r[3]==="transfer")return{libraryId:s,target:"transfer"};if(r[3]==="storyboards")return r[4]==="new"?{libraryId:s,target:"new_storyboard"}:{libraryId:s,target:"storyboards"};if(r[3]==="texts")return r[4]==="new"?{libraryId:s,target:"new_text"}:{libraryId:s,target:"texts"};if(r[3]!=="collections")return{libraryId:s,target:"library_overview"};if(r[4]==="new")return{libraryId:s,target:"new_collection",revisionId:h};const v=r[4];return v?r[5]==="graph"?{libraryId:s,target:c,collectionId:v,revisionId:h,revisionView:"graph"}:r[5]==="shared-revisions"?{libraryId:s,target:c,collectionId:v,revisionId:h,revisionView:"shared"}:r[5]==="revision"?{libraryId:s,target:c,collectionId:v,revisionId:h,revisionView:r[6]==="run"?"run":"settings",collectionView:k}:i==="new-revision"?{libraryId:s,target:c,collectionId:v,revisionId:h,revisionView:"new"}:{libraryId:s,target:c,collectionId:v,revisionId:h,revisionView:"detail",collectionView:k}:i==="new-collection"?{libraryId:s,target:"new_collection",collectionAction:"new-collection"}:{libraryId:s,target:c}}function _s(t,n="library_overview",r,s,o,h,u="overview",j="infos"){const p=(k,i)=>{const m=new URLSearchParams;i!=null&&i.revisionId&&m.set("revisionId",i.revisionId),i!=null&&i.collectionAction&&m.set("collectionAction",i.collectionAction),i!=null&&i.libraryAction&&m.set("libraryAction",i.libraryAction),i!=null&&i.libraryTarget&&m.set("libraryTarget",i.libraryTarget),i!=null&&i.infoId&&m.set("infoId",i.infoId),i!=null&&i.infoView&&(i!=null&&i.infoId)&&m.set("infoView",i.infoView),i!=null&&i.collectionView&&i.collectionView!=="infos"&&m.set("collectionView",i.collectionView);const l=m.toString();return l?`${k}?${l}`:k};if(!t)return"/cogita";if(n==="library_overview")return p(`/cogita/library/${t}`,{revisionId:o});if(n==="all_cards")return h?u==="cards"?p(`/cogita/library/${t}/infos/${h}/checkcards`,{revisionId:o}):u==="collections"?p(`/cogita/library/${t}/infos/${h}/collections`,{revisionId:o}):p(`/cogita/library/${t}/infos/${h}`,{revisionId:o}):p(`/cogita/library/${t}/list`,{revisionId:o,infoId:h,infoView:u});if(n==="new_card")return h?p(`/cogita/library/${t}/edit/${h}`,{revisionId:o}):p(`/cogita/library/${t}/list`,{revisionId:o,libraryAction:"new-info"});if(n==="all_collections"||n==="all_revisions"){const k=n==="all_revisions"?"revisions":void 0;return n==="all_revisions"&&o?s==="run"?p(`/cogita/library/${t}/revisions/${o}/run`,{revisionId:o}):s==="shared"?p(`/cogita/library/${t}/revisions/${o}/shared`,{revisionId:o}):p(`/cogita/library/${t}/revisions/${o}`,{revisionId:o}):n==="all_revisions"&&s==="new"?p(`/cogita/library/${t}/revisions/new`,{revisionId:o}):n==="all_revisions"?s==="shared"?p(`/cogita/library/${t}/revisions/shared-links`,{revisionId:o}):s==="run"?p(`/cogita/library/${t}/revision/run`,{revisionId:o,libraryTarget:k}):p(`/cogita/library/${t}/revisions`,{revisionId:o}):!r&&s==="run"?p(`/cogita/library/${t}/revision/run`,{revisionId:o,libraryTarget:k}):r?s==="graph"?p(`/cogita/library/${t}/collections/${r}/graph`,{revisionId:o,libraryTarget:k}):s==="settings"?p(`/cogita/library/${t}/collections/${r}/revision`,{revisionId:o,libraryTarget:k}):s==="run"?p(`/cogita/library/${t}/collections/${r}/revision/run`,{revisionId:o,libraryTarget:k}):s==="shared"?p(`/cogita/library/${t}/collections/${r}/shared-revisions`,{revisionId:o,libraryTarget:k}):s==="new"?p(`/cogita/library/${t}/collections/${r}`,{revisionId:o,libraryTarget:k,collectionAction:"new-revision"}):p(`/cogita/library/${t}/collections/${r}`,{revisionId:o,libraryTarget:k,collectionView:j}):p(`/cogita/library/${t}/collections`,{revisionId:o,libraryTarget:k})}return n==="new_collection"?p(`/cogita/library/${t}/collections`,{revisionId:o,collectionAction:"new-collection"}):n==="transfer"?p(`/cogita/library/${t}/transfer`,{revisionId:o}):n==="storyboards"?p(`/cogita/library/${t}/storyboards`,{revisionId:o}):n==="new_storyboard"?p(`/cogita/library/${t}/storyboards/new`,{revisionId:o}):n==="texts"?p(`/cogita/library/${t}/texts`,{revisionId:o}):n==="new_text"?p(`/cogita/library/${t}/texts/new`,{revisionId:o}):n==="dependencies"?p(`/cogita/library/${t}/dependencies`,{revisionId:o}):p(`/cogita/library/${t}`,{revisionId:o})}function ba(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function po(t){return typeof t=="string"&&dr.includes(t)}function fo(t,n){var j;if(!t.length)return null;const r=t.filter(p=>n.has(p.roleId)),s=r.length>0?r:t,o=s.map(p=>{var i,m;const k=((m=(i=p.fields.find(l=>l.fieldType==="role_kind"))==null?void 0:i.plainValue)==null?void 0:m.toLowerCase())??"";return{roleId:p.roleId,roleKind:k}}),h=o.find(p=>p.roleKind.includes("master"));if(h)return h.roleId;const u=o.find(p=>p.roleKind.includes("account")||p.roleKind.includes("user"));return u?u.roleId:((j=s[0])==null?void 0:j.roleId)??null}function bo(t){if(!t)return{version:1,byLibrary:{}};try{const n=JSON.parse(t);return!n||typeof n!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:n.lastLibraryId,byLibrary:n.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function yo({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k}){const i=mn(),m=Ja(),l=a.useMemo(()=>mo(m.pathname,m.search),[m.pathname,m.search]),c=t.cogita.workspace,[v,g]=a.useState([]),[S,O]=a.useState([]),[x,y]=a.useState([]),[_,V]=a.useState([]),[w,C]=a.useState(void 0),[f,q]=a.useState("library_overview"),[$,R]=a.useState(void 0),[K,Q]=a.useState(void 0),[me,Ae]=a.useState("detail"),[ee,L]=a.useState(void 0),[ye,W]=a.useState(!1),[pe,ae]=a.useState(!0),[ke,he]=a.useState(!1),[ce,Ie]=a.useState(!1),[$e,Fe]=a.useState(null),[Re,et]=a.useState(0),[ct,Te]=a.useState(""),[We,xt]=a.useState(""),[Ve,ze]=a.useState(""),[tt,ot]=a.useState([]),[Ye,Ce]=a.useState(""),[Be,Xe]=a.useState(0),[F,A]=a.useState(null),[D,E]=a.useState(null),N=a.useRef({version:1,byLibrary:{}}),T=a.useRef(!1),M=a.useRef(!1),le=a.useRef(null),be=a.useMemo(()=>v.find(d=>d.libraryId===w)??null,[v,w]),de=a.useMemo(()=>S.find(d=>d.collectionId===$)??null,[S,$]),X=ba(m.pathname)==="/cogita/persons";a.useEffect(()=>{if(!w){ot([]),Ce("");return}let d=!1;return Gs({libraryId:w}).then(re=>{if(d)return;const H=re.filter(Qe=>(Qe.roleKind??"").trim().toLowerCase()==="person");ot(H);try{const Qe=window.localStorage.getItem(On),lt=(Qe?JSON.parse(Qe):{})[w]??"",It=lt&&H.some(Mt=>Mt.roleId===lt)?lt:"";Ce(It)}catch{Ce("")}}).catch(()=>{d||(ot([]),Ce(""))}),()=>{d=!0}},[w,Be]),a.useEffect(()=>{if(w)try{const d=window.localStorage.getItem(On),re=d?JSON.parse(d):{};Ye?re[w]=Ye:delete re[w],window.localStorage.setItem(On,JSON.stringify(re))}catch{}},[w,Ye]);const P=a.useMemo(()=>_.find(d=>d.revisionId===K)??null,[_,K]),Y=a.useMemo(()=>({detail:c.revisions.detail,graph:c.revisions.graph,settings:c.revisions.settings,run:c.revisions.run,shared:c.targets.sharedRevisions,new:c.revisionForm.createAction}),[c.revisions.detail,c.revisions.graph,c.revisions.run,c.revisions.settings,c.targets.sharedRevisions,c.revisionForm.createAction]),ne=a.useMemo(()=>f==="new_card"?"all_cards":f==="new_collection"?"all_collections":f==="new_storyboard"?"storyboards":f==="new_text"?"texts":f,[f]),G=a.useMemo(()=>me==="new"?"settings":me,[me]),Z=f==="all_collections"||f==="all_revisions",xe=a.useMemo(()=>f==="new_collection"?"create":f==="all_collections"&&$?"selected":"search",[$,f]),U=a.useMemo(()=>l.infoId?"selected":f==="new_card"?"create":"search",[l.infoId,f]),se=a.useMemo(()=>x.find(d=>d.infoId===l.infoId)??null,[x,l.infoId]),Le=a.useMemo(()=>({library_overview:c.targets.libraryOverview,all_cards:c.targets.allCards,new_card:c.targets.newCard,all_collections:c.targets.allCollections,all_revisions:c.targets.allRevisions,new_collection:c.targets.newCollection,transfer:c.targets.transfer,storyboards:c.targets.storyboards,new_storyboard:c.targets.newStoryboard,texts:c.targets.texts,new_text:c.targets.newText,dependencies:c.targets.dependencies}),[c.targets]),qe=a.useMemo(()=>Le[ne]??ne,[ne,Le]),_e=Y[G],Je=!!w,bt=a.useMemo(()=>{const d=p==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":p==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return p==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:d},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:d},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:d},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:d},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:d},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:d},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:d},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:d},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:d},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:d},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:d},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:d},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:d},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:p==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:d},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:d},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:d},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:d},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:d},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:d},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:d},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:d},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:d},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:d},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:d},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:d},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:d},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:d},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:d},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:d},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:d},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:d},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:d},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:d},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:d},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:d},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:d},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:d},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:d},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:d},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[p]),mt=bt.length,pt=Math.max(0,Math.min(Re,mt-1)),wt=bt[pt],Ct=!!$,Ot=Je&&f==="all_collections",Et=Ct&&f==="all_collections",Nt=Je&&(f==="all_revisions"||Ct&&f==="all_collections")&&(G==="settings"||G==="run"||G==="shared"||f==="all_revisions"),ua=Nt,Lt=Nt&&!!K,vt=a.useCallback(d=>{const re=!!d.libraryId;let H=d.target,Qe=d.collectionId,rt=d.revisionId,lt=d.revisionView,It=d.infoId,Mt=d.infoView??l.infoView??"overview",jt=d.collectionView??l.collectionView??"infos";re?Vn[H].requiresCollection&&!Qe?(H=H==="all_revisions"?"all_revisions":"all_collections",rt=void 0,lt="detail"):H!=="all_collections"&&H!=="all_revisions"?(Qe=void 0,rt=void 0,H!=="new_card"&&H!=="all_cards"&&(It=void 0,Mt="overview"),H!=="new_collection"&&(jt="infos")):Vn[H].allowsRevision?go.includes(lt)||(rt=void 0):lt="detail":(H="library_overview",Qe=void 0,rt=void 0,lt="detail",It=void 0,Mt="overview",jt="infos"),C(d.libraryId),q(H),R(Qe),Q(rt),Ae(lt),W(!1);const At=ba(_s(d.libraryId,H,Qe,lt,rt,It,Mt,jt));ba(`${m.pathname}${m.search}`)!==At&&(le.current=At,i(At))},[m.pathname,m.search,i,l.collectionView,l.infoView]),St=a.useMemo(()=>[{key:"library",label:c.layers.library,visible:!0,value:w??"",selectedLabel:(be==null?void 0:be.name)??c.path.noLibrarySelected,disabled:pe||v.length===0,options:v.map(d=>({value:d.libraryId,label:d.name})),emptyOption:c.noLibraryOption,onSelect:d=>{const re=d||void 0;vt({libraryId:re,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:c.layers.target,visible:Je,value:ne,selectedLabel:qe,disabled:!Je,options:dr.map(d=>({value:d,label:Le[d]})),onSelect:d=>{const re=d;vt({libraryId:w,target:re,collectionId:$,revisionId:K,revisionView:me,infoId:re==="new_card"?l.infoId:void 0})}},{key:"info_mode",label:c.layers.target,visible:ne==="all_cards",value:U,selectedLabel:U==="create"?c.infoMode.create:U==="selected"?(se==null?void 0:se.label)??ee??t.cogita.library.list.selectedEmpty:c.infoMode.search,disabled:!Je,options:[{value:"search",label:c.infoMode.search},{value:"create",label:c.infoMode.create},...l.infoId?[{value:"selected",label:(se==null?void 0:se.label)??ee??t.cogita.library.list.selectedEmpty}]:[]],onSelect:d=>{if(d==="selected"){if(!l.infoId)return;vt({libraryId:w,target:"all_cards",collectionId:$,revisionId:K,revisionView:me,infoId:l.infoId,infoView:"overview"});return}if(d==="create"){vt({libraryId:w,target:"new_card",collectionId:$,revisionId:K,revisionView:me,infoId:void 0});return}vt({libraryId:w,target:"all_cards",collectionId:$,revisionId:K,revisionView:me,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:c.layers.target,visible:ne==="all_cards"&&!!l.infoId,value:f==="new_card"&&l.infoId?"edit":l.infoView==="cards"?"cards":l.infoView==="collections"?"collections":"overview",selectedLabel:f==="new_card"&&l.infoId?c.infoActions.edit:l.infoView==="cards"?c.infoActions.seeCards:l.infoView==="collections"?"Kolekcje":c.infoActions.overview,disabled:!Je||!l.infoId,options:[{value:"overview",label:c.infoActions.overview},{value:"edit",label:c.infoActions.edit},{value:"cards",label:c.infoActions.seeCards},{value:"collections",label:"Kolekcje"}],onSelect:d=>{if(l.infoId){if(d==="edit"){vt({libraryId:w,target:"new_card",collectionId:$,revisionId:K,revisionView:me,infoId:l.infoId});return}if(d==="cards"){vt({libraryId:w,target:"all_cards",collectionId:$,revisionId:K,revisionView:me,infoId:l.infoId,infoView:"cards"});return}vt({libraryId:w,target:"all_cards",collectionId:$,revisionId:K,revisionView:me,infoId:l.infoId,infoView:"overview"})}}},{key:"collection_mode",label:c.layers.collection,visible:Je&&(f==="all_collections"||f==="new_collection"),value:xe,selectedLabel:xe==="create"?t.cogita.library.actions.createCollection:xe==="selected"?(de==null?void 0:de.name)??c.path.noCollectionSelected:t.cogita.library.actions.collections,disabled:!Je,options:[{value:"search",label:t.cogita.library.actions.collections},{value:"create",label:t.cogita.library.actions.createCollection},...$&&de?[{value:"selected",label:de.name}]:[]],onSelect:d=>{if(d==="create"){vt({libraryId:w,target:"new_collection",collectionId:void 0,revisionId:void 0,revisionView:"detail"});return}if(d==="selected"&&$){const re=Z?f:"all_collections";vt({libraryId:w,target:re,collectionId:$,revisionId:K,revisionView:re==="all_revisions"?"settings":"detail"});return}if(d==="collections"){vt({libraryId:w,target:"all_cards",collectionId:$,revisionId:K,revisionView:me,infoId:l.infoId,infoView:"collections"});return}vt({libraryId:w,target:Z?f:"all_collections",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection",label:c.layers.collection,visible:Ot&&xe!=="create",value:$??"",selectedLabel:(de==null?void 0:de.name)??c.path.noCollectionSelected,disabled:!Je||ke||S.length===0,options:S.map(d=>({value:d.collectionId,label:d.name})),emptyOption:c.selectCollectionOption,onSelect:d=>{const re=d||void 0,H=Z?f:"all_collections";vt({libraryId:w,target:H,collectionId:re,revisionId:void 0,revisionView:H==="all_revisions"?"settings":"detail"})}},{key:"collection_selected_action",label:c.layers.revision,visible:Et,value:f==="all_revisions"?"revisions":G==="graph"?"edit":G==="settings"||G==="run"||G==="shared"?"revisions":(l.collectionView??"infos")==="overview"?"overview":"infos",selectedLabel:f==="all_revisions"?c.targets.allRevisions:G==="graph"?"Edytuj":G==="settings"||G==="run"||G==="shared"?c.targets.allRevisions:(l.collectionView??"infos")==="overview"?"Przegląd":"Informacje",disabled:!$,options:[{value:"overview",label:"Przegląd"},{value:"edit",label:"Edytuj"},{value:"infos",label:"Informacje"},{value:"revisions",label:c.targets.allRevisions}],onSelect:d=>{if($){if(d==="edit"){vt({libraryId:w,target:Z?f:"all_collections",collectionId:$,revisionId:void 0,revisionView:"graph"});return}if(d==="revisions"){vt({libraryId:w,target:Z?f:"all_collections",collectionId:$,revisionId:K,revisionView:"settings"});return}vt({libraryId:w,target:Z?f:"all_collections",collectionId:$,revisionId:void 0,revisionView:"detail",infoId:l.infoId,infoView:l.infoView,collectionView:d==="overview"?"overview":"infos"})}}},{key:"revision_mode",label:c.layers.revision,visible:ua,value:me==="new"?"create":!K&&G==="shared"?"shared":"search",selectedLabel:me==="new"?c.revisionForm.createAction:!K&&G==="shared"?c.targets.sharedRevisions:c.infoActions.search,disabled:f==="all_revisions"?!Je:!Ct,options:[{value:"search",label:c.infoActions.search},{value:"create",label:c.revisionForm.createAction},{value:"shared",label:c.targets.sharedRevisions}],onSelect:d=>{vt({libraryId:w,target:Z?f:"all_revisions",collectionId:f==="all_revisions"?void 0:$,revisionId:void 0,revisionView:d==="create"?"new":d==="shared"?"shared":"settings"})}},{key:"revision_entry",label:c.layers.revision,visible:ua,value:K??"",selectedLabel:(P==null?void 0:P.name)??c.status.noRevisions,disabled:(f==="all_revisions"?!Je:!Ct)||ce||_.length===0,options:_.map(d=>({value:d.revisionId,label:d.name})),emptyOption:c.status.noRevisions,onSelect:d=>{vt({libraryId:w,target:Z?f:"all_collections",collectionId:$,revisionId:d||void 0,revisionView:G==="settings"||G==="run"||G==="shared"?G:"settings"})}},{key:"revision_selected_action",label:c.layers.revision,visible:Lt,value:G==="run"?"run":G==="shared"?"shared":"settings",selectedLabel:G==="run"?c.revisions.run:G==="shared"?c.targets.sharedRevisions:c.infoActions.edit,disabled:!K,options:[{value:"settings",label:c.infoActions.edit},{value:"run",label:c.revisions.run},{value:"shared",label:c.targets.sharedRevisions}],onSelect:d=>{K&&vt({libraryId:w,target:Z?f:"all_collections",collectionId:$,revisionId:K,revisionView:d==="run"?"run":d==="shared"?"shared":"settings"})}}],[S,ke,U,x,v,pe,vt,_,ce,de,$,se,P,K,ee,Ct,Je,be,Z,w,_e,me,f,G,ne,qe,Ot,Et,ua,Lt,Le,t.cogita.library.list.selectedEmpty,l.infoId,l.infoView,l.collectionView,c.infoActions.edit,c.infoActions.overview,c.infoActions.seeCards,c.layers.collection,c.layers.library,c.layers.revision,c.layers.target,c.noLibraryOption,c.path.noCollectionSelected,c.path.noLibrarySelected,c.selectCollectionOption,c.targets.allRevisions,c.infoActions.search,c.revisionForm.createAction,c.revisions.run,c.targets.sharedRevisions,xe]),kt=a.useMemo(()=>St.filter(d=>d.visible),[St]),yt=a.useMemo(()=>kt.filter(d=>d.key!=="library"&&d.key!=="collection"),[kt]),Kt=a.useMemo(()=>yt.find(d=>d.key==="target")??null,[yt]),st=a.useMemo(()=>yt.find(d=>d.key==="info_mode")??null,[yt]),Ue=a.useMemo(()=>yt.find(d=>d.key==="info_selected_action")??null,[yt]),ft=a.useMemo(()=>yt.find(d=>d.key==="collection_mode")??null,[yt]),Qt=a.useMemo(()=>yt.find(d=>d.key==="revision_mode")??null,[yt]),Vt=a.useMemo(()=>yt.find(d=>d.key==="collection_selected_action")??null,[yt]),zt=a.useMemo(()=>yt.find(d=>d.key==="revision_entry")??null,[yt]),ue=a.useMemo(()=>yt.find(d=>d.key==="revision_selected_action")??null,[yt]),$t=a.useCallback((d,re)=>d?e.jsx("div",{className:"cogita-sidebar-actions",children:d.options.map(H=>e.jsx("button",{type:"button",className:`ghost ${String(d.value)===H.value?"active":""}`,onClick:()=>d.onSelect(H.value),disabled:d.disabled,title:H.label,children:fa(H.label,Aa)},`${re}:${d.key}:${H.value}`))}):null,[]),Xt=a.useMemo(()=>{const d=l.libraryId;if(!d||!m.pathname.startsWith("/cogita/library/"))return null;const re={copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,libraryId:d};if(l.target==="library_overview")return e.jsx(ei,{...re});if(l.target==="all_cards")return l.infoId&&l.infoView==="cards"?e.jsx(Ai,{...re,infoId:l.infoId,selectedReviewerRoleId:Ye||null}):e.jsx(hi,{...re,mode:l.cardMode??"list"});if(l.target==="new_card")return e.jsx(wi,{...re,editInfoId:l.infoId});if(l.target==="dependencies")return e.jsx(Ni,{...re});if(l.target==="transfer")return e.jsx(Fi,{...re});if(l.target==="storyboards"||l.target==="new_storyboard")return e.jsx(Ki,{...re});if(l.target==="texts"||l.target==="new_text")return e.jsx(_i,{...re});if(l.target==="all_collections"||l.target==="all_revisions"){if(l.target==="all_revisions"&&!l.collectionId)return l.revisionView==="run"?e.jsx(Dn,{...re,revisionId:l.revisionId}):e.jsx(Fs,{...re,revisionId:l.revisionId});if(!l.collectionId&&l.revisionView==="run")return e.jsx(Dn,{...re,revisionId:l.revisionId});if(l.collectionId){const H={...re,collectionId:l.collectionId};return l.revisionView==="graph"?e.jsx(ho,{...H}):l.revisionView==="shared"?e.jsx(Ei,{...re,collectionId:l.collectionId}):l.revisionView==="settings"?e.jsx(Fs,{...H,revisionId:l.revisionId}):l.revisionView==="run"?e.jsx(Dn,{...H,revisionId:l.revisionId}):e.jsx(zi,{...H})}return e.jsx(Di,{...re})}return l.target==="new_collection"?e.jsx(qi,{...re,onCreated:H=>{vt({libraryId:d,target:f==="all_revisions"?"all_revisions":"all_collections",collectionId:H,revisionId:void 0,revisionView:"graph"})}}):null},[n,vt,t,p,m.pathname,i,k,h,j,s,o,l.cardMode,l.collectionId,l.infoId,l.libraryId,l.revisionId,l.revisionView,l.target,u,r,f,Ye]);a.useEffect(()=>{let d=!1;return(async()=>{var H,Qe,rt,lt,It;ae(!0);try{await $r();const[Mt,jt,At]=await Promise.all([Vs(),Js(),Rr()]);if(d)return;g(Mt);const ha=new Set(At.nodes.filter(ut=>ut.nodeType==="role"&&ut.canLink).map(ut=>ut.roleId??"")),ma=fo(jt,ha);if(A(ma),ma){const ut=At.nodes.find(_t=>_t.nodeType==="data"&&_t.roleId===ma&&(_t.fieldType===Bn||_t.label===Bn));E((ut==null?void 0:ut.dataKeyId)??null),N.current=bo(ut==null?void 0:ut.value)}const Ft=(H=Mt.find(ut=>ut.libraryId===l.libraryId))==null?void 0:H.libraryId,ta=Ft?(rt=(Qe=N.current.byLibrary)==null?void 0:Qe[Ft])==null?void 0:rt.lastTarget:void 0,Ta=po(ta)?ta:"library_overview";C(Ft),q(l.target??Ta),Q(l.revisionId??(Ft?(It=(lt=N.current.byLibrary)==null?void 0:lt[Ft])==null?void 0:It.lastRevisionId:void 0)),Ae(l.revisionView??"detail"),T.current=!0}catch{d||Fe(c.status.loadFailed)}finally{d||ae(!1)}})(),()=>{d=!0}},[c.status.loadFailed]),a.useLayoutEffect(()=>{if(T.current){if(!l.libraryId){C(void 0),q(l.target??"library_overview"),R(void 0),Q(void 0),Ae("detail");return}l.libraryId&&v.some(d=>d.libraryId===l.libraryId)&&C(l.libraryId),l.target&&q(l.target),R(l.collectionId),Q(l.revisionId),l.revisionView&&Ae(l.revisionView)}},[v,l.collectionId,l.libraryId,l.revisionId,l.revisionView,l.target]),a.useEffect(()=>{if(!w){O([]),R(void 0),y([]),V([]),Q(void 0);return}let d=!1;return he(!0),Va({libraryId:w,limit:200}).then(re=>{var rt;if(d)return;const H=re.items;O(H);const Qe=(rt=H.find(lt=>lt.collectionId===l.collectionId))==null?void 0:rt.collectionId;R(Qe)}).catch(()=>{d||(O([]),R(void 0))}).finally(()=>{d||he(!1)}),()=>{d=!0}},[l.collectionId,w]),a.useEffect(()=>{if(!w||ne!=="all_cards"&&f!=="new_card"){y([]);return}let d=!1;return Xn({libraryId:w,limit:200}).then(re=>{d||y(re)}).catch(()=>{d||y([])}),()=>{d=!0}},[ne,w,f]),a.useEffect(()=>{if(!w||f!=="all_revisions"&&!$){V([]),f!=="all_revisions"&&Q(void 0);return}let d=!1;return Ie(!0),Gn({libraryId:w,collectionId:f==="all_revisions"?void 0:$}).then(re=>{var rt,lt,It,Mt;if(d)return;V(re);const H=(lt=(rt=N.current.byLibrary)==null?void 0:rt[w])==null?void 0:lt.lastRevisionId,Qe=((It=re.find(jt=>jt.revisionId===l.revisionId))==null?void 0:It.revisionId)??((Mt=re.find(jt=>jt.revisionId===H))==null?void 0:Mt.revisionId);Q(Qe)}).catch(()=>{d||(V([]),Q(void 0))}).finally(()=>{d||Ie(!1)}),()=>{d=!0}},[l.revisionId,$,w,f]),a.useEffect(()=>{const d=l.infoId;if(!w||!d){L(void 0);return}let re=!1;return na({libraryId:w,infoId:d}).then(H=>{if(re)return;const Qe=H.payload??{},rt=Qe.definition&&typeof Qe.definition=="object"?Qe.definition:null,lt=typeof(rt==null?void 0:rt.title)=="string"?rt.title:void 0,It=typeof(rt==null?void 0:rt.question)=="string"?rt.question:void 0,Mt=typeof Qe.label=="string"?Qe.label:void 0,jt=typeof Qe.name=="string"?Qe.name:void 0,At=typeof Qe.title=="string"?Qe.title:void 0;L(lt??It??Mt??jt??At??H.infoId)}).catch(()=>{re||L(d)}),()=>{re=!0}},[l.infoId,w]),a.useEffect(()=>{if(!T.current||l.libraryId&&v.some(rt=>rt.libraryId===l.libraryId)&&l.libraryId!==w||l.target&&l.target!==f||l.revisionView&&l.revisionView!==me||l.revisionId&&l.revisionId!==K||Vn[f].requiresCollection&&!$&&(l.target==="all_collections"||l.target==="all_revisions")&&l.collectionId)return;const d=ba(`${m.pathname}${m.search}`);if(ba(m.pathname)==="/cogita"&&!l.libraryId&&!w){le.current=null;return}if(ba(m.pathname)==="/cogita/persons"){le.current=null;return}if(ba(m.pathname)===`/cogita/library/${w}/revision/run`&&l.revisionView==="run"&&!l.collectionId&&(f==="all_collections"||f==="all_revisions")&&me==="run"&&!$){le.current=null;return}const Qe=ba(_s(w,f,$,me,K,l.infoId,l.infoView??"overview",l.collectionView??"infos"));if(d===Qe){le.current=null;return}le.current!==Qe&&(le.current=Qe,i(Qe,{replace:!0}))},[v,m.pathname,m.search,i,l.collectionId,l.infoId,l.infoView,l.collectionView,l.libraryId,l.revisionId,l.revisionView,l.target,$,w,K,me,f]),a.useEffect(()=>{if(typeof window>"u")return;const d=()=>{window.innerWidth>920&&W(!1)};return window.addEventListener("resize",d),()=>window.removeEventListener("resize",d)},[]),a.useEffect(()=>{if(!T.current||!F||!w||M.current)return;const d=N.current,re={...d.byLibrary??{}},H={...re[w]??{},lastCollectionId:$,lastRevisionId:K,lastRevisionView:me,lastTarget:f},Qe={version:1,lastLibraryId:w,byLibrary:{...re,[w]:H}},rt=JSON.stringify(d),lt=JSON.stringify(Qe);if(rt===lt)return;N.current=Qe,M.current=!0,(async()=>{try{if(D)await Pr(D,{plainValue:lt});else{const Mt=await Er(F,{itemName:Bn,itemType:"data",plainValue:lt});E(Mt.dataItemId)}}catch{Fe(c.status.savePrefsFailed)}finally{M.current=!1}})()},[D,F,$,w,K,me,f,c.status.savePrefsFailed]);const qt=async()=>{const d=ct.trim();if(!d){Fe(t.cogita.user.libraryNameRequired);return}Fe(null);try{const re=await Kr({name:d});g(H=>[re,...H]),C(re.libraryId),q("library_overview"),R(void 0),Te("")}catch{Fe(t.cogita.user.libraryCreateFailed)}},B=async()=>{if(!w||!$){Fe(c.status.selectLibraryFirst);return}const d=Ve.trim();if(!d){Fe(c.revisionForm.nameLabel);return}Fe(null);try{const re=await Fr({libraryId:w,collectionId:$,name:d,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});V(H=>[re,...H]),Q(re.revisionId),q(f==="all_revisions"?"all_revisions":"all_collections"),Ae("settings"),ze("")}catch{Fe(c.status.loadFailed)}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,headerExtra:e.jsxs("div",{className:"cogita-header-reviewer-actions",children:[e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:Ye,disabled:!w,onChange:d=>{const re=d.target.value;if(re==="__new_person__"){i("/cogita/persons");return}Ce(re)},children:[e.jsx("option",{value:"",children:w?"No person":"Select library first"}),tt.map(d=>e.jsx("option",{value:d.roleId,children:d.label},d.roleId)),e.jsx("option",{value:"__new_person__",children:"+ Create new person"})]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>i("/cogita/persons"),children:"Persons"})]}),children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${ye?"open":""}`,"aria-label":c.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{title:(be==null?void 0:be.name)??c.path.noLibrarySelected,children:fa((be==null?void 0:be.name)??c.path.noLibrarySelected,Aa)}),e.jsx("p",{className:"cogita-sidebar-note",children:be?c.sidebar.libraryActionsHint:c.status.selectLibraryFirst}),$t(Kt,"sidebar"),f==="all_revisions"&&zt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.targets.allRevisions}),$t(Qt,"sidebar"),$t(zt,"sidebar"),ue?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(P==null?void 0:P.name)??c.status.noRevisions,children:fa((P==null?void 0:P.name)??c.status.noRevisions,Aa)}),$t(ue,"sidebar")]}):null]}):null,st?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.sidebar.infoActionsHint}),$t(st,"sidebar"),Ue?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(se==null?void 0:se.label)??ee??t.cogita.library.list.selectedEmpty,children:fa((se==null?void 0:se.label)??ee??t.cogita.library.list.selectedEmpty,Aa)}),e.jsx("p",{className:"cogita-sidebar-note",children:c.sidebar.selectedInfoActionsHint}),$t(Ue,"sidebar")]}):null]}):null,ft?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.sidebar.collectionActionsHint}),$t(ft,"sidebar"),de&&Vt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:de.name,children:fa(de.name,Aa)}),$t(Vt,"sidebar"),f!=="all_revisions"&&zt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.targets.allRevisions}),$t(Qt,"sidebar"),$t(zt,"sidebar"),ue?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(P==null?void 0:P.name)??c.status.noRevisions,children:fa((P==null?void 0:P.name)??c.status.noRevisions,Aa)}),$t(ue,"sidebar")]}):null]}):null]}):null]}):null]}),e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:c.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:s,children:c.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{j("cogita"),W(!1)},children:c.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:o,children:u?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),ye?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":c.sidebar.closeMenu,onClick:()=>W(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":c.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>W(d=>!d),"aria-label":ye?c.sidebar.closeMenu:c.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),kt.map((d,re)=>e.jsxs("div",{className:"cogita-browser-segment",children:[re>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,d.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":d.label,title:d.selectedLabel,children:fa(d.selectedLabel,Ks)}):e.jsxs("select",{"aria-label":d.label,value:d.value,onChange:H=>d.onSelect(H.target.value),disabled:d.disabled,children:[d.emptyOption?e.jsx("option",{value:"",children:d.emptyOption}):null,d.options.map(H=>e.jsx("option",{value:H.value,title:H.label,children:fa(H.label,Ks)},`${d.key}:${H.value}`))]})]},`menu:${d.key}`))]}),Xt?e.jsxs(e.Fragment,{children:[(f==="all_collections"||f==="all_revisions")&&me==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:c.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsxs("select",{value:$??"",onChange:d=>R(d.target.value||void 0),children:[e.jsx("option",{value:"",children:c.selectCollectionOption}),S.map(d=>e.jsx("option",{value:d.collectionId,children:d.name},d.collectionId))]})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:c.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Ve,onChange:d=>ze(d.target.value),placeholder:c.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:B,children:c.revisionForm.createAction}),$e?e.jsx("p",{className:"cogita-form-error",children:$e}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Ys.Provider,{value:!0,children:Xt})})]}):null,Xt?null:e.jsxs(e.Fragment,{children:[X?e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Pi,{copy:t,onPersonCreated:d=>{Xe(re=>re+1)}})}):null,!w&&!X?e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:wt.step}),e.jsx("h2",{children:wt.title})]}),e.jsxs("p",{children:[pt+1," / ",mt]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:wt.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:wt.passages.map(d=>e.jsx("p",{children:d},d))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:wt.focus.map(d=>e.jsx("span",{children:d},d))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:wt.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:bt.map((d,re)=>e.jsx("button",{type:"button",className:`ghost ${re===pt?"active":""}`,onClick:()=>et(re),"aria-label":`${re+1}`,children:re+1},`tutorial:${d.title}:${re}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:pt===0,onClick:()=>et(d=>Math.max(0,d-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:pt===mt-1,onClick:()=>et(d=>Math.min(mt-1,d+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:ct,onChange:d=>Te(d.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:qt,children:t.cogita.user.createLibraryAction}),$e?e.jsx("p",{className:"cogita-form-error",children:$e}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),v.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,v.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:v.map(d=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{vt({libraryId:d.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:d.name})]},d.libraryId))}):null]})]})]}):null]})]})]})})}const Lo=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:yo},Symbol.toStringTag,{value:"Module"}));function xo({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,shareId:i}){const[m,l]=a.useState(null),[c,v]=a.useState("loading"),[g,S]=a.useState(t.cogita.library.collections.defaultName),[O,x]=a.useState("Cogita Library"),[y,_]=a.useState([]),[V,w]=a.useState([]),[C,f]=a.useState("idle"),[q,$]=a.useState({current:0,total:0}),[R,K]=a.useState(0),[Q,me]=a.useState(""),[Ae,ee]=a.useState(null),[L,ye]=a.useState(null),[W,pe]=a.useState(null),[ae,ke]=a.useState(null),[he,ce]=a.useState([]),[Ie,$e]=a.useState({}),[Fe,Re]=a.useState({}),[et,ct]=a.useState(null),[Te,We]=a.useState(null),[xt,Ve]=a.useState(null),[ze,tt]=a.useState(null),[ot,Ye]=a.useState({}),Ce=a.useRef(0),[Be,Xe]=a.useState(null),F=a.useRef(null),A=a.useRef(null),[D,E]=a.useState(null),[N,T]=a.useState(!1),[M,le]=a.useState(null),[be,de]=a.useState([]),[X,P]=a.useState(null),Y=a.useRef(null),ne=a.useRef(null),[G,Z]=a.useState(null),[xe,U]=a.useState(0),se=a.useRef(null),Le=a.useRef({}),[qe,_e]=a.useState(!1),[Je,bt]=a.useState({}),mt=a.useRef(null),pt=a.useRef(new Set),wt=a.useRef({}),[Ct,Ot]=a.useState([]),[Et,Nt]=a.useState(new Set),[ua,Lt]=a.useState(!1),vt=Ja(),St=a.useMemo(()=>new URLSearchParams(vt.search),[vt.search]),kt=a.useMemo(()=>St.get("key")??"",[St]),yt=(m==null?void 0:m.mode)??"random",Kt=(m==null?void 0:m.check)??"exact",st=(m==null?void 0:m.limit)??20,Ue=a.useMemo(()=>rs((m==null?void 0:m.revisionType)??yt),[m,yt]),ft=a.useMemo(()=>{const z=m==null?void 0:m.revisionSettings,ie=nr(Ue,St);return wn(Ue,z??ie)},[m,St,Ue]),Qt=a.useMemo(()=>t.cogita.library.revision[Ue.labelKey]??yt,[t,yt,Ue]),Vt=a.useMemo(()=>Kt==="exact"?t.cogita.library.revision.checkValue:Kt,[t,Kt]),ue=c==="ready"?y[R]??null:null,$t=(ue==null?void 0:ue.checkType)==="translation-match"&&ze,Xt=a.useRef(new Map),qt=a.useRef(new Map),B=a.useRef(new Map),d=a.useRef(new Map),re=a.useMemo(()=>ue?ue.cardType==="vocab"?t.cogita.library.revision.vocabLabel:ue.infoType?nt(t,ue.infoType):t.cogita.library.revision.infoLabel:"",[t,ue]),H=a.useMemo(()=>{var ie;return Ue.id!=="levels"?y.length:((ie=Je.pool)==null?void 0:ie.length)??Ue.getFetchLimit(st,ft)},[Je,ft,Ue,y.length,st]),Qe=Ue.getProgressTotal?Ue.getProgressTotal(y,Je,st,ft):Ue.id==="levels"?Math.min(st,H):y.length,rt=Qe?Math.min(R+1,Qe):0,lt=Math.max(1,Number(ft.tries??1)),It=ft.compare??"anchors",Mt=Math.max(0,Math.min(100,Number(ft.minCorrectness??0))),jt=(ft.considerDependencies??"on")==="on",At=Math.max(0,Math.min(100,Number(ft.dependencyThreshold??85))),ha=z=>{const ie=z.slice();for(let je=ie.length-1;je>0;je-=1){const Ke=Math.floor(Math.random()*(je+1));[ie[je],ie[Ke]]=[ie[Ke],ie[je]]}return ie},ma=z=>xa(z,{treatSimilarCharsAsSame:!0})>=Mt,Ft=async()=>{const z=await ca(),ie=new Map,je=new Map;z.forEach(we=>{const Pe=`${we.itemType}:${we.itemId}`,Me=ea(we.itemType,we.itemId,we.checkType,we.direction);ie.has(Pe)||ie.set(Pe,[]),ie.get(Pe).push(we),je.has(Me)||je.set(Me,[]),je.get(Me).push(we)});const Ke=new Map,De=new Map;return ie.forEach((we,Pe)=>Ke.set(Pe,la(we).score)),je.forEach((we,Pe)=>De.set(Pe,la(we).score)),{itemKnowness:Ke,cardKnowness:De}},ta=async z=>{const ie=Je,je=z.concat(ie.active??[]).concat(ie.pool??[]).filter((b,I,J)=>J.findIndex(ge=>Ne(ge)===Ne(b))===I);if(!jt){Nt(new Set(je.map(Ne)));return}const{itemKnowness:Ke,cardKnowness:De}=await Ft(),we=b=>{if(b.cardType!=="info"||b.infoType!=="citation"||b.checkType!=="quote-fragment")return!0;const I=Wt(b.direction);if(!(I!=null&&I.fragmentId))return!0;const J=b.description??"";if(!J.trim())return!0;const fe=va(J).nodes[I.fragmentId];if(!fe||!fe.leftId&&!fe.rightId)return!0;const oe=[fe.leftId,fe.rightId].filter(Se=>!!Se);if(oe.length===0)return!0;const ve=oe.map(Se=>{const Oe=ea("info",b.cardId,"quote-fragment",Se);return De.get(Oe)??0});return ve.reduce((Se,Oe)=>Se+Oe,0)/ve.length>=At},Pe=(m==null?void 0:m.collectionId)??null,Me=Pe?Ct.filter(b=>Tt(b.childItemType)==="collection"&&b.childItemId===Pe&&!Tt(b.childCheckType)&&!Tt(b.childDirection)):[],Ee=Pe&&je.length>0?je.reduce((b,I)=>b+(De.get(Ne(I))??0),0)/je.length:0,Ge=new Set;for(const b of je){if(b.cardType!=="info"){Ge.add(Ne(b));continue}if(!we(b))continue;const I=Ct.filter(fe=>cr(fe,b)).concat(Me);if(I.length===0){Ge.add(Ne(b));continue}let J=0;for(const fe of I)if(Tt(fe.parentItemType)==="collection")J+=fe.parentItemId===Pe?Ee:0;else if(Tt(fe.parentCheckType)||Tt(fe.parentDirection)){const oe=Tt(fe.parentCheckType),ve=Tt(fe.parentDirection),te=ea(fe.parentItemType,fe.parentItemId,oe,ve);J+=De.get(te)??0}else{const oe=`${fe.parentItemType}:${fe.parentItemId}`;J+=Ke.get(oe)??0}J/I.length>=At&&Ge.add(Ne(b))}Nt(Ge)},Ta=z=>{for(let ie=z;ie<y.length;ie+=1){const je=y[ie];if(je&&(!jt||je.cardType!=="info"||Et.has(Ne(je))))return ie}return-1},ut=z=>!jt||z.cardType!=="info"||Et.has(Ne(z)),_t=z=>{if(Ue.id!=="temporal"&&Ue.id!=="levels")return null;const ie=Je,je=(ie.active??[]).concat(ie.pool??[]),Ke=new Set;for(const De of je){const we=Ne(De);if(!(Ke.has(we)||z.has(we))&&(Ke.add(we),ut(De)))return De}return null},Zt=a.useMemo(()=>{if(Ue.id!=="levels")return null;const z=Je,ie=z.pool??[],je=z.active??[],Ke=z.levelMap??{},De=Math.max(1,Number(ft.levels??1)),we=Array.from({length:De},()=>0),Pe=new Set(je.map(b=>Ne(b)));ie.forEach(b=>{const I=Math.min(De,Math.max(1,Ke[Ne(b)]??1));we[I-1]+=1});const Me=ie.length||1,Ee=we.map(b=>b/Me*100),Ge=ue?Ke[Ne(ue)]??1:null;return{counts:we,percentages:Ee,currentLevel:Ge,levelsCount:De,activeCount:je.length,poolCount:ie.length,activeSet:Pe}},[Je,ft,Ue,ue]),ja=a.useMemo(()=>{if(Ue.id!=="temporal")return null;const z=Je,ie=z.pool??[],je=z.active??[],Ke=z.knownessMap??{},De=new Set(z.unknownSet??[]);let we=0;ie.forEach(Ee=>{(Ke[Ne(Ee)]??0)>1&&(we+=1)});const Pe=De.size,Me=je.map(Ee=>({id:Ne(Ee),value:De.has(Ne(Ee))?0:Math.max(0,Math.min(1,Ke[Ne(Ee)]??0))}));return{knownCount:we,unknownCount:Pe,dots:Me}},[Je,Ue]),Wa=a.useMemo(()=>{if(!jt)return 0;const z=Je;return y.concat(z.active??[]).concat(z.pool??[]).filter((je,Ke,De)=>De.findIndex(we=>Ne(we)===Ne(je))===Ke).filter(je=>je.cardType==="info"&&!Et.has(Ne(je))).length},[jt,Je,y,Et]);a.useEffect(()=>{if(!jt||C!=="ready")return;const z=Je,je=y.concat(z.active??[]).concat(z.pool??[]).filter((we,Pe,Me)=>Me.findIndex(Ee=>Ne(Ee)===Ne(we))===Pe).filter(we=>we.cardType!=="info"||Et.has(Ne(we))).length,Ke=Y.current;if(Y.current=je,Ke===null||je<=Ke)return;const De=je-Ke;P(`New card available (+${De})`),ne.current&&window.clearTimeout(ne.current),ne.current=window.setTimeout(()=>P(null),2200)},[jt,C,Je,y,Et]),a.useEffect(()=>()=>{ne.current&&window.clearTimeout(ne.current)},[]);const Gt=(z,ie)=>{const je=Ue.applyOutcome({queue:y,meta:Je},ue,st,ft,{correct:z,correctness:ie,createdUtc:new Date().toISOString()});_(je.queue),bt(je.meta);const Ke=je.queue[R+1];Ke&&Bt(Ke,R+1)};a.useEffect(()=>{if(!i){v("error");return}v("loading"),_r({shareId:i,key:kt}).then(z=>{l(z),S(z.collectionName),x(z.libraryName),v("ready")}).catch(()=>{v("error")})},[i,kt]),a.useEffect(()=>{i&&Dr({shareId:i,key:kt,type:"language"}).then(z=>w(z)).catch(()=>w([]))},[i,kt]),a.useEffect(()=>{!i||c!=="ready"||zr({shareId:i,key:kt}).then(z=>Ot(z.items??[])).catch(()=>Ot([]))},[i,kt,c]),a.useEffect(()=>{if(!i||c!=="ready")return;let z=!0;return(async()=>{f("loading"),$({current:0,total:Ue.id==="levels"?0:Ue.getFetchLimit(st,ft)});try{const je=[];let Ke=null,De=null;do{const I=await Br({shareId:i,key:kt,limit:300,cursor:Ke});if(je.push(...I.items),(Ue.id==="levels"||Ue.id==="temporal")&&I.total&&(De=I.total),$(J=>({current:je.length,total:J.total||I.total||Ue.getFetchLimit(st,ft)})),Ke=I.nextCursor??null,De!==null&&je.length>=De||Ue.id!=="levels"&&Ue.id!=="temporal"&&je.length>=Ue.getFetchLimit(st,ft))break}while(Ke);if(!z)return;const we=Oa(je);let Pe;if(Ue.id==="levels"){const I=Math.max(1,Number(ft.levels??1));Pe={},we.forEach(J=>{const ge=Ne(J);Pe[ge]=Math.max(1,Math.min(I,1))})}let Me=null,Ee=null,Ge=null;if(Ue.id==="temporal"){const I=await ca(),J=new Set(we.map(oe=>Ne(oe))),ge=I.reduce((oe,ve)=>{const te=ea(ve.itemType,ve.itemId,ve.checkType,ve.direction);return J.has(te)&&(oe[te]||(oe[te]=[]),oe[te].push(ve)),oe},{});Me={},Ee=new Set,Ge={};const fe=Date.now();we.forEach(oe=>{const ve=Ne(oe),te=ge[ve]??[];if(te.length===0){Me[ve]=0,Ee.add(ve),Ge[ve]=[];return}const Se=as(te);Ge[ve]=Se;const Oe=vn(Se,fe);Me[ve]=Oe.knowness})}const b=Ue.id==="levels"?ss(we,st,ft,Pe):Ue.id==="temporal"?ns(we,st,ft,Me??{},Ee??new Set,Ge??{}):Ue.prepare(we,st,ft);_(b.queue),bt(b.meta),K(0),f("ready"),$(I=>({current:Math.min(I.current,I.total),total:I.total}))}catch{z&&f("error")}})(),()=>{z=!1}},[i,kt,st,Ue,ft,c]),a.useEffect(()=>{ta(y)},[y,Ct,jt,At,m==null?void 0:m.collectionId]),a.useEffect(()=>{if(!ue||!jt){Lt(!1);return}if(ue.cardType!=="info"||Et.has(Ne(ue))){Lt(!1);return}const z=Ta(R+1);if(z>=0){Lt(!1),K(z);return}if(Ue.id==="temporal"||Ue.id==="levels"){const ie=y.slice(0,R+1),je=y.slice(R+1).filter(ut),Ke=ie.concat(je),De=new Set(Ke.map(Ne)),we=_t(De);if(we){const Me=Ne(we);De.has(Me)||(Ke.push(we),De.add(Me),bt(Ee=>{const Ge=Ee,b=new Set(Ge.queued??[]);return b.add(Me),{...Ge,queued:b}}))}const Pe=Ke.findIndex((Me,Ee)=>Ee!==R&&ut(Me));if(Pe>=0){_(Ke),K(Pe),Lt(!1);return}}Lt(!0)},[ue,Et,jt,R,y,Je,Ue.id]),a.useEffect(()=>{if(me(""),ee(null),Z(null),U(0),ce([]),$e({}),Re({}),ct(null),We(null),Ve(null),T(!1),_e(!1),E(null),tt(null),Ye({}),!ue){ye(null),pe(null);return}ue.cardType==="info"&&ue.infoType==="computed"&&ye(t.cogita.library.revision.loadingComputed);let z=!0;return Bt(ue,R).then(ie=>{!z||!ie||(ye(ie.prompt),pe(ie.expectedAnswer),ce(ie.computedExpected),$e(ie.computedAnswers),ct(ie.answerTemplate),We(ie.outputVariables),Ve(ie.variableValues))}),()=>{z=!1}},[ue,i,t]),a.useEffect(()=>{if(!ue||ue.cardType!=="info"||ue.infoType!=="citation"){mt.current=null,pt.current=new Set,ke(null);return}const z=ue.description??"",ie=(ue.label??"").trim(),je=ie.replace(/\s+/g," ").trim(),Ke=z.replace(/\s+/g," ").trim(),De=je&&je!==Ke?ie:t.cogita.library.infoTypes.citation;if(!z){ke(null),pe(null);return}const we=va(z);mt.current=we,ye(De);let Pe=!0;return ca().then(Me=>{if(!Pe)return;const Ee=new Map;Me.forEach(ge=>{if(ge.itemType!=="info"||ge.checkType!=="quote-fragment"||!ge.direction)return;const fe=Wt(ge.direction);if(!fe)return;const oe=`${ge.itemId}:${fe.fragmentId}`;Ee.has(oe)||Ee.set(oe,[]),Ee.get(oe).push(ge)});const Ge={},b=new Set;Ee.forEach((ge,fe)=>{const[oe,ve]=fe.split(":",2);if(oe!==ue.cardId)return;const te=la(ge).score;Ge[ve]=te,te>=At&&b.add(ve)}),pt.current=b,wt.current=Ge;const I=Wt(ue.direction);if(I!=null&&I.fragmentId&&we.nodes[I.fragmentId]){sa(we,I.fragmentId,De);return}const J=$a(we,b,Ge,At,jt,ue.direction);sa(we,(J==null?void 0:J.id)??null,De)}).catch(()=>{pt.current=new Set,wt.current={};const Me=Wt(ue.direction);if(Me!=null&&Me.fragmentId&&we.nodes[Me.fragmentId]){sa(we,Me.fragmentId,De);return}const Ee=$a(we,pt.current,{},At,jt,ue.direction);sa(we,(Ee==null?void 0:Ee.id)??null,De)}),()=>{Pe=!1}},[ue,t,jt,At]),a.useEffect(()=>{if(!ue||ue.cardType!=="vocab"||ue.checkType!=="translation-match"){tt(null),Ye({});return}const je=(Je.pool??Je.active??y).filter(Me=>Me.cardType==="vocab"&&Me.checkType==="translation-match").filter((Me,Ee,Ge)=>Ge.findIndex(b=>b.cardId===Me.cardId)===Ee);je.some(Me=>Me.cardId===ue.cardId)||je.unshift(ue);const De=ha(je).slice(0,6).map(Me=>{const Ee=Me.label.split("↔").map(I=>I.trim()).filter(Boolean);if(Ee.length<2)return null;const Ge=`${Me.cardId}:L`,b=`${Me.cardId}:R`;return{cardId:Me.cardId,leftId:Ge,rightId:b,leftLabel:Ee[0],rightLabel:Ee[1]}}).filter(Boolean),we=De.map(Me=>Me.leftId),Pe=ha(De.map(Me=>Me.rightId));tt({pairs:De,leftOrder:we,rightOrder:Pe,selection:{},activeLeft:null,activeRight:null,locked:{}})},[ue,y,Je]),a.useEffect(()=>()=>{F.current&&window.clearTimeout(F.current),A.current&&window.clearTimeout(A.current)},[]);const Ca=a.useRef(null);a.useEffect(()=>{if(!ue)return;const z=Ne(ue),ie=typeof document<"u"?document.activeElement:null;if(Ca.current===z&&ie&&(ie.tagName==="INPUT"||ie.tagName==="TEXTAREA"))return;let je=0;const Ke=()=>{if(ue){if(ue.cardType==="info"&&ue.infoType==="computed"){if(he.length>0){const we=hn(et,he,Te),Pe=we?Le.current[we]:null;if(Pe&&(Pe.focus(),document.activeElement===Pe)){Ca.current=z;return}}if(se.current&&(se.current.focus(),document.activeElement===se.current)){Ca.current=z;return}}else if(ue.cardType==="vocab"&&se.current&&(se.current.focus(),document.activeElement===se.current)){Ca.current=z;return}je<6&&(je+=1,window.setTimeout(Ke,40))}},De=window.setTimeout(Ke,40);return()=>window.clearTimeout(De)},[ue,he,et,Te]),a.useEffect(()=>{if(!qe)return;const z=ie=>{ie.key==="Enter"&&(ie.preventDefault(),Ut())};return window.addEventListener("keydown",z),()=>window.removeEventListener("keydown",z)},[qe]);const Ia=z=>{de(z),le(la(z))};a.useEffect(()=>{if(!ue){le(null),de([]);return}const z=ue.cardType==="info"?"info":"connection";if(ue.cardType==="info"&&ue.infoType==="citation"){ca().then(ie=>{const je=ie.filter(Ke=>Ke.itemType==="info"&&Ke.itemId===ue.cardId&&Ke.checkType==="quote-fragment"&&dn(Ke.direction,ue.direction));Ia(je)}).catch(()=>{le(null),de([])});return}cn(z,ue.cardId,ue.checkType,ue.direction).then(ie=>Ia(ie)).catch(()=>{le(null),de([])})},[ue]);const Pa=(z,ie,je,Ke)=>{if(z==="info"&&je==="quote-fragment"){ca().then(De=>{const we=De.filter(Pe=>Pe.itemType==="info"&&Pe.itemId===ie&&Pe.checkType==="quote-fragment"&&dn(Pe.direction,Ke));Ia(we)}).catch(()=>{le(null),de([])});return}cn(z,ie,je,Ke).then(De=>Ia(De)).catch(()=>{le(null),de([])})},Qa=(z,ie,je)=>{var Pe;const Ke=((Pe=je.pairs.find(Me=>Me.leftId===z))==null?void 0:Pe.rightId)??null;if(!Ke)return je;const De=Ke===ie;Ye(Me=>({...Me,[z]:De?"correct":"incorrect"})),F.current&&window.clearTimeout(F.current),A.current&&window.clearTimeout(A.current),Ce.current+=1;const we={kind:De?"correct":"incorrect",tick:Ce.current};if(Xe(null),F.current=window.setTimeout(()=>Xe(we),0),A.current=window.setTimeout(()=>Xe(null),420),De){const Me={...je.locked,[z]:!0};return Object.keys(Me).length>=je.pairs.length?(ee("correct"),_e(!0)):ee("correct"),{...je,selection:{...je.selection,[z]:ie},activeLeft:null,activeRight:null,locked:Me}}return ee("incorrect"),{...je,activeLeft:null,activeRight:null}},Ea=z=>{tt(ie=>!ie||ie.locked[z]?ie:ie.activeRight?Qa(z,ie.activeRight,ie):{...ie,activeLeft:ie.activeLeft===z?null:z})},kn=z=>{tt(ie=>ie&&(ie.activeLeft?Qa(ie.activeLeft,z,ie):{...ie,activeRight:ie.activeRight===z?null:z}))},Ut=()=>{var z;if(ue&&ue.cardType==="info"&&ue.infoType==="citation"&&mt.current&&ae&&!((z=Wt(ue.direction))!=null&&z.fragmentId)){const ie=$a(mt.current,pt.current,wt.current,At,jt,ue.direction,ae.fragmentId);if(ie){ee(null),me(""),T(!1),Re({}),_e(!1),Z(null),U(0),sa(mt.current,ie.id,ae.title);return}}ee(null),me(""),T(!1),Re({}),_e(!1),Z(null),U(0),K(ie=>Math.min(ie+1,y.length))},Jt=z=>{if(!ue)return;const ie=z.expected??null,je=z.answer??"";let Ke=ie??"",De=je;if(!ie&&z.expectedMap&&z.answerMap){const I=Object.keys(z.expectedMap).sort((J,ge)=>J.localeCompare(ge));Ke=I.map(J=>{var ge;return((ge=z.expectedMap)==null?void 0:ge[J])??""}).join("|"),De=I.map(J=>{var ge;return((ge=z.answerMap)==null?void 0:ge[J])??""}).join("|")}const we=Ke?Ra(Ke,De,It):new Uint8Array,Pe={revisionType:Ue.id,evalType:z.evalType,direction:z.direction,prompt:L??"",expected:ie,answer:je,expectedAnswers:z.expectedMap??null,answers:z.answerMap??null,correct:z.correct,maskBase64:we.length?ya(we):null,checkMode:Kt,compareMode:It,minCorrectness:Mt},Me=new TextEncoder().encode(JSON.stringify(Pe)),Ee=ue.cardType==="info"?"info":"connection",Ge=z.overrideCheckType??ue.checkType??null,b=z.overrideDirection??ue.direction??null;ln({itemType:Ee,itemId:ue.cardId,checkType:Ge,direction:b,revisionType:Ue.id,evalType:z.evalType,correct:z.correct,maskBase64:we.length?ya(we):null,payloadBase64:ya(Me)}).then(()=>{Pa(Ee,ue.cardId,Ge,b),ta(y)}).catch(()=>{})},Nn=(z,ie)=>{const je=Xt.current.get(ie);if(je)return Promise.resolve(je);const Ke=qt.current.get(ie);if(Ke)return Ke;const De=Or({shareCode:i,infoId:z,key:kt}).then(we=>{var I,J;const Pe=we.payload,Me=((I=Pe.definition)==null?void 0:I.graph)??null,Ee="",Ge=((J=Pe.definition)==null?void 0:J.answerTemplate)??"",b=sr(Me,Ee,Ge);if(b){const fe={sample:rr(b),answerTemplate:Ge||null};return Xt.current.set(ie,fe),fe}return ds({shareId:i,infoId:z,key:kt}).then(ge=>{const fe={sample:ge,answerTemplate:null};return Xt.current.set(ie,fe),fe})}).catch(()=>ds({shareId:i,infoId:z,key:kt}).then(we=>{const Pe={sample:we,answerTemplate:null};return Xt.current.set(ie,Pe),Pe}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{qt.current.delete(ie)});return qt.current.set(ie,De),De},Bt=(z,ie)=>{var Me;const je=`${Ne(z)}:${ie}`,Ke=B.current.get(je);if(Ke)return Promise.resolve(Ke);const De=d.current.get(je);if(De)return De;const we=Ee=>(B.current.set(je,Ee),Ee);let Pe;if(z.cardType==="vocab"){if(z.checkType==="translation-match")return Pe=Promise.resolve(we({prompt:z.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),Pe;const Ee=z.label.split("↔").map(Ge=>Ge.trim()).filter(Boolean);if(Ee.length>=2){const b=(z.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",I=b?Ee[0]:Ee[1],J=b?Ee[1]:Ee[0];Pe=Promise.resolve(we({prompt:I,expectedAnswer:J,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else Pe=Promise.resolve(we({prompt:z.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(z.cardType==="info"&&z.infoType==="word"){const Ee=(Me=z.description)!=null&&Me.startsWith("Language: ")?z.description.replace("Language: ",""):null;Pe=Promise.resolve(we({prompt:z.label,expectedAnswer:Ee,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else z.cardType==="info"&&z.infoType==="computed"?Pe=Nn(z.cardId,je).then(Ee=>{var ge,fe;if(!Ee.sample)return we({prompt:z.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const Ge=Ee.sample,b=Ge.expectedAnswers?Object.entries(Ge.expectedAnswers).map(([oe,ve])=>({key:oe,expected:ve})):[],I=b.reduce((oe,ve)=>(oe[ve.key]="",oe),{}),J=Ge.expectedAnswerIsSentence&&((ge=Ge.expectedAnswer)==null?void 0:ge.trim())||null;return we({prompt:Ge.prompt,expectedAnswer:b.length>0?J:((fe=Ge.expectedAnswer)==null?void 0:fe.trim())||null,computedExpected:b,computedAnswers:I,answerTemplate:Ee.answerTemplate,outputVariables:Ge.outputVariables??null,variableValues:Ge.variableValues??null})}).catch(()=>we({prompt:z.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{d.current.delete(je)}):Pe=Promise.resolve(we({prompt:z.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return d.current.set(je,Pe),Pe},sa=(z,ie,je)=>{const Ke=Object.keys(z.nodes).length,De=pt.current.size;if(!ie){ke({title:je,before:z.text,after:"",fragmentId:null,total:Ke,completed:De}),pe(null),_e(!0);return}const we=z.nodes[ie];if(!we)return;const Pe=xn(z.text,we);ke({title:je,before:Pe.before,after:Pe.after,fragmentId:we.id,total:Ke,completed:De}),pe(Pe.fragment),_e(!1)},Ma=()=>{const z=mt.current;z&&ke(ie=>ie&&{...ie,total:Object.keys(z.nodes).length,completed:pt.current.size})},wa=()=>{const z=y[R+1];z&&Bt(z,R+1)},Fa=()=>{if(wa(),ue&&ue.cardType==="vocab"&&ue.checkType==="translation-match"&&ze){if(ze.pairs.length===0){ee("incorrect"),_e(!0);return}const we=ze.pairs.reduce((J,ge)=>(J[ge.rightId]=ge.rightLabel,J),{});let Pe=0;const Me={};ze.pairs.forEach(J=>{const fe=ze.selection[J.leftId]===J.rightId;Me[J.leftId]=fe?"correct":"incorrect",fe&&(Pe+=1)});const Ee=ze.pairs.length||1,Ge=Pe/Ee,b=Pe===ze.pairs.length;Ye(J=>({...J,...Me})),b?(ee("correct"),_e(!0),U(0)):(ee("incorrect"),_e(!1),U(J=>{const ge=J+1;return ge>=lt&&(T(!0),_e(!0),tt(fe=>{if(!fe)return fe;const oe=fe.pairs.reduce((ve,te)=>(ve[te.leftId]=te.rightId,ve),{});return{...fe,selection:oe}})),ge})),Gt(b,Ge);const I="connection";Promise.all(ze.pairs.map(J=>{const ge=ze.selection[J.leftId]??null,fe=ge?we[ge]:"",oe={left:J.leftLabel,expected:J.rightLabel,answer:fe,checkType:"translation-match"},ve=new TextEncoder().encode(JSON.stringify(oe));return ln({itemType:I,itemId:J.cardId,checkType:"translation-match",direction:null,revisionType:Ue.id,evalType:"translation-match",correct:ge===J.rightId,maskBase64:null,payloadBase64:ya(ve)})})).then(()=>{Pa(I,ue.cardId,ue.checkType,ue.direction),ta(y)}).catch(()=>{});return}if(he.length>0){const we=he.reduce((Me,Ee)=>{const Ge=Ie[Ee.key]??"";return Me[Ee.key]=Dt(Ge)===Dt(Ee.expected)?"correct":"incorrect",Me},{});he.every(({key:Me,expected:Ee})=>{const Ge=Ie[Me]??"";return Kt==="exact"&&Dt(Ge)===Dt(Ee)})?(ee("correct"),Re(we),_e(!0),U(0),Gt(!0,1),Jt({correct:!0,direction:L?`${L} -> computed`:"computed",expectedMap:he.reduce((Me,Ee)=>(Me[Ee.key]=Ee.expected,Me),{}),answerMap:Ie,evalType:"computed"})):(ee("incorrect"),Re(we),_e(!1),U(Me=>{const Ee=Me+1;return Ee>=lt&&ga&&(T(!0),_e(!0)),Ee}),Gt(!1,0),window.setTimeout(()=>{var Ee;const Me=hn(et,he,Te);Me&&Le.current[Me]&&((Ee=Le.current[Me])==null||Ee.focus())},40),Jt({correct:!1,direction:L?`${L} -> computed`:"computed",expectedMap:he.reduce((Me,Ee)=>(Me[Ee.key]=Ee.expected,Me),{}),answerMap:Ie,evalType:"computed"}));return}if(ue&&ue.cardType==="info"&&ue.infoType==="citation"&&(ae!=null&&ae.fragmentId)){if(!W)return;const we=Wt(ue.direction),Pe=(we==null?void 0:we.fragmentId)??ae.fragmentId,Me=Sa(W,Q,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Ee=Me.mask,Ge=Me.isCorrect,b=Me.percent;Ge?(wt.current[ae.fragmentId]=Math.max(wt.current[ae.fragmentId]??0,b),(wt.current[ae.fragmentId]??0)>=At&&pt.current.add(ae.fragmentId),Ma(),ee("correct"),Re({}),_e(!0),Z(Ee),U(0),b<100&&lt<=1&&T(!0),Gt(!0,b/100),Jt({correct:!0,direction:`quote:${ae.fragmentId}`,expected:W,answer:Q,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Pe})):(ee("incorrect"),Re({}),_e(!1),Z(Ee),U(I=>{const J=I+1;return J>=lt&&ga&&(T(!0),_e(!0)),J}),Gt(!1,b/100),window.setTimeout(()=>{var I;return(I=se.current)==null?void 0:I.focus()},40),Jt({correct:!1,direction:`quote:${ae.fragmentId}`,expected:W,answer:Q,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Pe}));return}if(!W)return;const z=Ra(W,Q,It),ie=Kt==="exact"&&Dt(Q)===Dt(W),je=ma(z),Ke=ie||je,De=xa(z);Ke?(ee("correct"),Re({}),_e(!0),Z(z),U(0),De<100&&lt<=1&&T(!0),Gt(!0,De/100),Jt({correct:!0,direction:L?`${L} -> ${W}`:null,expected:W,answer:Q,evalType:"text"})):(ee("incorrect"),Re({}),_e(!1),Z(z),U(we=>{const Pe=we+1;return Pe>=lt&&ga&&(T(!0),_e(!0)),Pe}),Gt(!1,De/100),window.setTimeout(()=>{var we;return(we=se.current)==null?void 0:we.focus()},40),Jt({correct:!1,direction:L?`${L} -> ${W}`:null,expected:W,answer:Q,evalType:"text"}))},Sn=z=>{if(wa(),!W)return;const ie=Ra(W,z,It),je=Dt(z)===Dt(W),Ke=ma(ie),De=je||Ke,we=xa(ie);De?(ee("correct"),Re({}),_e(!0),Z(ie),U(0),we<100&&lt<=1&&T(!0),Gt(!0,we/100),Jt({correct:!0,direction:"word->language",expected:W,answer:z,evalType:"language-select"})):(ee("incorrect"),Re({}),_e(!1),Z(ie),U(Pe=>{const Me=Pe+1;return Me>=lt&&ga&&(T(!0),_e(!0)),Me}),Gt(!1,we/100),Jt({correct:!1,direction:"word->language",expected:W,answer:z,evalType:"language-select"}))},Tn=z=>{var je;if(z.key!=="Enter")return;if(z.preventDefault(),z.stopPropagation(),qe){Ut();return}const ie=he.find(Ke=>!(Ie[Ke.key]??"").trim());if(ie){(je=Le.current[ie.key])==null||je.focus();return}Fa()},La=()=>{wa(),ee("correct"),_e(!0),U(0),Gt(!0,1),W&&Jt({correct:!0,direction:"manual",expected:W,answer:Q,evalType:"manual"})},aa=()=>{if(Gt(!1,0),ue&&ue.cardType==="info"&&ue.infoType==="citation"){ee(null),me(""),T(!1),Re({}),_e(!1),Z(null),U(0),K(z=>Math.min(z+1,y.length));return}Ut()};a.useEffect(()=>{wa()},[R,y]);const Cn=t.cogita.library.revision.revealModeAfterIncorrect,ga=he.length>0||!!W;return e.jsxs(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:u,onNavigate:j,language:p,onLanguageChange:k,children:[(c==="loading"||C==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:c==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${q.total?Math.min(100,Math.max(0,q.current/q.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:q.total?`${Math.min(q.current,q.total)} / ${q.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:g}),e.jsx("p",{className:"cogita-library-subtitle",children:O}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",Qt).replace("{check}",Vt)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:M?`${M.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Zt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Zt.currentLevel??"-"," / ",Zt.levelsCount]}):null,M?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(M.correct)).replace("{total}",String(M.total))}),M.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(M.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(ir,{outcomes:be})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[X?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:X})}):null,e.jsx(es,{feedbackToken:Be?`${Be.kind}-${Be.tick}`:$t?"idle":Ae??"idle",children:c!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:c==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):ue?e.jsx(e.Fragment,{children:ua?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(ts,{copy:t,currentCard:ue,currentTypeLabel:re,prompt:L,languages:V,answer:Q,onAnswerChange:z=>me(ie=>un(ie,z,D)),computedExpected:he,computedAnswers:Ie,onComputedAnswerChange:(z,ie)=>$e(je=>({...je,[z]:un(je[z]??"",ie,D)})),answerTemplate:et,outputVariables:Te,variableValues:xt,computedFieldFeedback:Fe,feedback:Ae,canAdvance:qe,quoteContext:ae,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Fa,onSkip:aa,onLanguageSelect:Sn,onMarkReviewed:La,onAdvance:Ut,showCorrectAnswer:N,setShowCorrectAnswer:T,onRevealCorrect:()=>_e(!0),answerMask:G,expectedAnswer:W,hasExpectedAnswer:ga,handleComputedKeyDown:Tn,answerInputRef:se,computedInputRefs:Le,scriptMode:D,setScriptMode:E,matchPairs:ze==null?void 0:ze.pairs,matchLeftOrder:ze==null?void 0:ze.leftOrder,matchRightOrder:ze==null?void 0:ze.rightOrder,matchSelection:ze==null?void 0:ze.selection,matchActiveLeft:ze==null?void 0:ze.activeLeft,matchActiveRight:ze==null?void 0:ze.activeRight,matchFeedback:ot,onMatchLeftSelect:Ea,onMatchRightSelect:kn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Qe?`${rt} / ${Qe}`:t.cogita.library.revision.progressUnlimited}),c==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),c==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),c==="ready"&&C==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),c==="ready"&&C==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),c==="ready"&&C==="ready"&&y.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Cn}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",lt]})]})]}),Zt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Zt.activeCount," / ",Zt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Zt.counts.map((z,ie)=>{const je=ie+1,Ke=Zt.currentLevel===je,De=Zt.percentages[ie]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":Ke,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:je}),e.jsx("strong",{children:z})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,De))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[De.toFixed(1),"%"]})]},`level-${je}`)})})]}):null,ja?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:ja.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:ja.dots.map(z=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-z.value))}, ${Math.round(200*z.value)}, 80, 0.9)`}},z.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:ja.knownCount})]})]}):null,jt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Wa})]})}):null]})]})]})})})]})]})}const Ao=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:xo},Symbol.toStringTag,{value:"Module"})),oa=t=>String(t??"").trim().toLocaleLowerCase(),gn=t=>Array.from(new Set(t.map(n=>Number(n)).filter(Number.isFinite))).sort((n,r)=>n-r),Ds=t=>t.map(n=>n.join(",")).sort().join("|");function vo(t){const n=t.split("↔").map(r=>r.trim()).filter(Boolean);return n.length>=2?[n[0],n[1]]:null}function jo(t){if(!t)return null;const n=t.indexOf(":");return n>=0?t.slice(n+1).trim():t.trim()}function wo(t,n,r,s){const o=typeof r.type=="string"?r.type:"",h=typeof r.title=="string"&&r.title.trim()?r.title.trim():n,u=typeof r.question=="string"?r.question:n;if(!o||!u)return null;if(o==="selection"){const j=Array.isArray(r.options)?r.options.filter(k=>typeof k=="string"):[],p=Array.isArray(r.answer)?gn(r.answer):[];return{roundIndex:s,cardKey:`info:${t}:question-selection`,publicPrompt:{kind:"selection",title:h,prompt:u,options:j,multiple:!0,cardLabel:"question"},reveal:{kind:"selection",expected:p,title:h},grade:k=>{const i=Array.isArray(k)?gn(k):[];return JSON.stringify(i)===JSON.stringify(p)}}}if(o==="truefalse"){const j=!!r.answer;return{roundIndex:s,cardKey:`info:${t}:question-truefalse`,publicPrompt:{kind:"boolean",title:h,prompt:u,cardLabel:"question"},reveal:{kind:"boolean",expected:j,title:h},grade:p=>!!p===j}}if(o==="text"||o==="number"||o==="date"){const j=String(r.answer??"");return{roundIndex:s,cardKey:`info:${t}:question-${o}`,publicPrompt:{kind:"text",title:h,prompt:u,inputType:o==="number"?"number":o==="date"?"date":"text",cardLabel:"question"},reveal:{kind:"text",expected:j,title:h},grade:p=>{if(o==="number"){const k=Number(p),i=Number(j);return Number.isFinite(k)&&Number.isFinite(i)&&Math.abs(k-i)<1e-9}return oa(p)===oa(j)}}}if(o==="ordering"){const j=Array.isArray(r.options)?r.options.filter(p=>typeof p=="string"):[];return{roundIndex:s,cardKey:`info:${t}:question-ordering`,publicPrompt:{kind:"ordering",title:h,prompt:u,options:j,cardLabel:"question"},reveal:{kind:"ordering",expected:j,title:h},grade:p=>JSON.stringify(Array.isArray(p)?p.map(String):[])===JSON.stringify(j)}}if(o==="matching"){const j=Array.isArray(r.columns)?r.columns.map(i=>Array.isArray(i)?i.filter(m=>typeof m=="string"):[]):[],p=r.answer??{},k=Array.isArray(p.paths)?p.paths.map(i=>Array.isArray(i)?i.map(m=>Number(m)).filter(Number.isFinite):null).filter(i=>Array.isArray(i)):[];return{roundIndex:s,cardKey:`info:${t}:question-matching`,publicPrompt:{kind:"matching",title:h,prompt:u,columns:j,cardLabel:"question"},reveal:{kind:"matching",expected:{paths:k},title:h},grade:i=>{const m=i??{},l=Array.isArray(m.paths)?m.paths.map(c=>Array.isArray(c)?c.map(v=>Number(v)).filter(Number.isFinite):null).filter(c=>Array.isArray(c)):[];return Ds(l)===Ds(k)}}}return null}async function ko(t){const n=await Zn({libraryId:t.libraryId,revisionId:t.revisionId}),s=(await qa({libraryId:t.libraryId,collectionId:n.collectionId,limit:1e3})).items,o=Array.from(new Set(s.filter(i=>i.cardType==="info").map(i=>i.cardId))),h=new Map;await Promise.all(o.map(async i=>{try{const m=await na({libraryId:t.libraryId,infoId:i});h.set(i,{infoType:m.infoType,payload:m.payload})}catch{}}));const u=new Map;await Promise.all(Array.from(h.entries()).filter(([,i])=>i.infoType==="computed").map(async([i])=>{try{const m=await Un({libraryId:t.libraryId,infoId:i});u.set(i,m)}catch{}}));const j=Array.from(new Set(s.filter(i=>i.cardType==="vocab").map(i=>i.label))).filter(Boolean),p=[],k=new Set;for(const i of s){if(i.cardType==="vocab"){const l=vo(i.label);if(!l)continue;if(i.checkType==="translation"&&i.direction==="a-to-b"){const[c,v]=l;p.push({roundIndex:p.length,cardKey:`connection:${i.cardId}:translation:a-to-b`,publicPrompt:{kind:"text",title:i.label,prompt:c,cardLabel:i.description??void 0},reveal:{kind:"text",expected:v,title:i.label},grade:g=>oa(g)===oa(v)})}else if(i.checkType==="translation"&&i.direction==="b-to-a"){const[c,v]=l;p.push({roundIndex:p.length,cardKey:`connection:${i.cardId}:translation:b-to-a`,publicPrompt:{kind:"text",title:i.label,prompt:v,cardLabel:i.description??void 0},reveal:{kind:"text",expected:c,title:i.label},grade:g=>oa(g)===oa(c)})}else if(i.checkType==="translation-match"){const c=Array.from(new Set([i.label,...j.filter(g=>g!==i.label).slice(0,3)])),v=c.findIndex(g=>g===i.label);p.push({roundIndex:p.length,cardKey:`connection:${i.cardId}:translation-match`,publicPrompt:{kind:"selection",title:i.label,prompt:"Select the matching pair",options:c,multiple:!1,cardLabel:i.description??void 0},reveal:{kind:"selection",expected:[v],title:i.label},grade:g=>{const S=Array.isArray(g)?gn(g):gn([g]);return S.length===1&&S[0]===v}})}continue}if(i.cardType!=="info")continue;const m=h.get(i.cardId);if(m){if(m.infoType==="word"&&i.checkType==="word-language"){const l=jo(i.description);if(!l)continue;p.push({roundIndex:p.length,cardKey:`info:${i.cardId}:word-language:${i.direction??""}`,publicPrompt:{kind:"text",title:i.label,prompt:`Language of: ${i.label}`,cardLabel:"word-language"},reveal:{kind:"text",expected:l,title:i.label},grade:c=>oa(c)===oa(l)});continue}if(m.infoType==="computed"&&i.checkType==="computed"){const l=u.get(i.cardId);if(!l)continue;p.push({roundIndex:p.length,cardKey:`info:${i.cardId}:computed`,publicPrompt:{kind:"text",title:i.label,prompt:l.prompt,multiLine:!1,cardLabel:"computed"},reveal:{kind:"text",expected:l.expectedAnswer,title:i.label},grade:c=>oa(c)===oa(l.expectedAnswer)});continue}if(m.infoType==="question"){const l=m.payload,c=l.definition??l,v=wo(i.cardId,i.label,c,p.length);v&&(v.roundIndex=p.length,p.push(v));continue}if(m.infoType==="citation"&&!k.has(i.cardId)){k.add(i.cardId);const l=m.payload,c=typeof l.text=="string"?l.text:"",v=typeof l.title=="string"&&l.title.trim()?l.title.trim():i.label;if(!c.trim())continue;const g=va(c,{minLen:7,maxLen:13});for(const S of g.order){const O=g.nodes[S];if(!O)continue;const x=xn(c,O);p.push({roundIndex:p.length,cardKey:`info:${i.cardId}:quote-fragment:${S}`,publicPrompt:{kind:"citation-fragment",title:v,before:x.before,after:x.after,fragmentId:S,cardLabel:"quote-fragment"},reveal:{kind:"citation-fragment",expected:x.fragment,title:v},grade:y=>Sa(x.fragment,String(y??""),{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}).isCorrect})}continue}}}return p.map((i,m)=>({...i,roundIndex:m}))}function No(t){const{libraryId:n,revisionId:r}=t,[s,o]=a.useState(null),[h,u]=a.useState([]),[j,p]=a.useState("loading"),[k,i]=a.useState(null),m=`cogita.live.host.${n}.${r}`,l=s?h[s.currentRoundIndex]??null:null,c=s!=null&&s.status&&s.status!=="lobby"?s.currentPrompt??null:null,v=(s==null?void 0:s.currentReveal)??null,g=a.useMemo(()=>s!=null&&s.code&&typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision/${encodeURIComponent(s.code)}`:"",[s==null?void 0:s.code]),S=(C,f,q)=>({...C,hostSecret:C.hostSecret||(f==null?void 0:f.hostSecret)||(q==null?void 0:q.hostSecret)||"",code:C.code||(f==null?void 0:f.code)||(q==null?void 0:q.code)||""});a.useEffect(()=>{let C=!1;return ko({libraryId:n,revisionId:r}).then(f=>{C||u(f)}).catch(()=>{C||(i("Failed to load revision cards for live session."),p("error"))}),()=>{C=!0}},[n,r]),a.useEffect(()=>{let C=!1;async function f(){try{typeof localStorage<"u"&&localStorage.removeItem(m);const q=await qr({libraryId:n,revisionId:r,title:"Live revision"});if(C)return;o(q),localStorage.setItem(m,JSON.stringify({sessionId:q.sessionId,hostSecret:q.hostSecret,code:q.code})),p("ready")}catch{if(C)return;i("Failed to create live session."),p("error")}}return f(),()=>{C=!0}},[n,r,m]),a.useEffect(()=>{if(!s)return;const C=window.setInterval(async()=>{try{const f=await Vr({libraryId:n,sessionId:s.sessionId,hostSecret:s.hostSecret});o(q=>S(f,q))}catch{}},1200);return()=>window.clearInterval(C)},[n,s]);const O=async C=>{if(!s)return;const f=await Jr({libraryId:n,sessionId:s.sessionId,hostSecret:s.hostSecret,status:C.status??s.status,currentRoundIndex:C.currentRoundIndex??s.currentRoundIndex,revealVersion:C.revealVersion??s.revealVersion,currentPrompt:C.currentPrompt??s.currentPrompt??null,currentReveal:C.currentReveal??s.currentReveal??null});o(q=>S(f,q))},x=async C=>{const f=h[C];!f||!s||await O({status:"running",currentRoundIndex:C,revealVersion:s.revealVersion+1,currentReveal:null,currentPrompt:{...f.publicPrompt,roundIndex:C,cardKey:f.cardKey}})},y=async()=>{h.length&&await x((s==null?void 0:s.currentRoundIndex)??0)},_=async()=>{if(!s||!l)return;const C=new Map(s.currentRoundAnswers.map($=>[$.participantId,$.answer])),f=s.participants.map($=>{const R=C.get($.participantId),K=l.grade(R);return{participantId:$.participantId,isCorrect:K,pointsAwarded:K?1:0}}),q=await Ur({libraryId:n,sessionId:s.sessionId,hostSecret:s.hostSecret,scores:f});o($=>S(q,$)),await O({status:"revealed",revealVersion:q.revealVersion+1,currentReveal:l.reveal})},V=async()=>{if(!s)return;const C=s.currentRoundIndex+1;if(C>=h.length){await O({status:"finished",currentReveal:null});return}await x(C)},w=(C,f)=>{if(!C)return e.jsx("p",{className:"cogita-help",children:"Waiting for host to publish a question."});const q=String(C.kind??""),$=typeof f<"u",R=Array.isArray(f)?f.map(K=>Number(K)).filter(Number.isFinite):[];if(q==="citation-fragment")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":$?"correct":"idle",children:[e.jsxs("p",{children:[e.jsx("span",{style:{opacity:.7},children:String(C.before??"")}),e.jsx("strong",{children:" [ ... ] "}),e.jsx("span",{style:{opacity:.7},children:String(C.after??"")})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:$?"Correct fragment":"Fragment"}),e.jsx("input",{readOnly:!0,value:$?String(f??""):"",placeholder:"Participant answer here"})]})]});if(q==="text")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":$?"correct":"idle",children:[e.jsx("p",{children:String(C.prompt??"")}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:$?"Correct answer":"Answer"}),e.jsx("input",{readOnly:!0,value:$?String(f??""):"",placeholder:"Participant answer here"})]})]});if(q==="boolean"){const K=!!f;return e.jsxs("div",{className:"cogita-live-card-surface","data-state":$?"correct":"idle",children:[e.jsx("p",{children:String(C.prompt??"")}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:`cta ghost ${$&&K?"live-correct-answer":""}`,disabled:!0,children:"True"}),e.jsx("button",{type:"button",className:`cta ghost ${$&&!K?"live-correct-answer":""}`,disabled:!0,children:"False"})]})]})}if(q==="selection"){const K=Array.isArray(C.options)?C.options.map(String):[],Q=!!C.multiple;return e.jsxs("div",{className:"cogita-live-card-surface","data-state":$?"correct":"idle",children:[e.jsx("p",{children:String(C.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:K.map((me,Ae)=>e.jsxs("label",{className:"cogita-share-row","data-state":$&&R.includes(Ae)?"correct":void 0,children:[e.jsx("span",{children:me}),e.jsx("input",{type:Q?"checkbox":"radio",disabled:!0,checked:$?R.includes(Ae):!1,readOnly:!0})]},`${Ae}-${me}`))})]})}if(q==="ordering"){const K=Array.isArray($?f:C.options)?($?f:C.options).map(String):[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":$?"correct":"idle",children:[e.jsx("p",{children:String(C.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:K.map((Q,me)=>e.jsxs("div",{className:"cogita-share-row","data-state":$?"correct":void 0,children:[e.jsx("span",{children:Q}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:!0,children:"↑"}),e.jsx("button",{type:"button",className:"ghost",disabled:!0,children:"↓"})]})]},`${me}-${Q}`))})]})}if(q==="matching"){const K=Array.isArray(C.columns)?C.columns:[],Q=(f==null?void 0:f.paths)??[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":$?"correct":"idle",children:[e.jsx("p",{children:String(C.prompt??"")}),$?e.jsx("div",{className:"cogita-share-list",children:Q.map((me,Ae)=>e.jsx("div",{className:"cogita-share-row","data-state":"correct",children:e.jsx("span",{children:me.map((ee,L)=>{const ye=Array.isArray(K[L])?K[L]:[],W=String(ye[ee]??ee);return`${L>0?" → ":""}${W}`})})},`path-${Ae}`))}):e.jsx("div",{className:"cogita-form-actions",children:K.map((me,Ae)=>e.jsx("select",{disabled:!0,children:(Array.isArray(me)?me:[]).map((ee,L)=>e.jsx("option",{children:String(ee)},`${Ae}-${L}`))},`host-col-${Ae}`))})]})}return e.jsx("pre",{className:"cogita-json-preview",children:JSON.stringify(C,null,2)})};return e.jsx(Pt,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Live Revision Host"}),e.jsx("h2",{className:"cogita-detail-title",children:"Host session"}),j==="loading"?e.jsx("p",{children:"Loading…"}):null,k?e.jsx("p",{className:"cogita-help",children:k}):null,s?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Join code"}),e.jsx("input",{readOnly:!0,value:s.code})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Join URL"}),e.jsx("input",{readOnly:!0,value:g})]}),g?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"QR"}),e.jsx("div",{style:{display:"inline-flex",padding:"0.75rem",borderRadius:"12px",background:"#fff"},children:e.jsx(ur,{value:g,size:176,marginSize:2})})]}):null,e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Status"}),e.jsx("input",{readOnly:!0,value:s.status})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:y,disabled:!h.length,children:"Publish current round"}),e.jsx("button",{type:"button",className:"cta ghost",onClick:_,disabled:!l,children:"Reveal + score"}),e.jsx("button",{type:"button",className:"cta ghost",onClick:V,disabled:!h.length,children:"Next"})]}),e.jsxs("p",{className:"cogita-help",children:["Rounds: ",h.length]})]}):null]}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Current round"}),e.jsx("h3",{className:"cogita-detail-title",children:c&&typeof c.title=="string"?c.title:(s==null?void 0:s.status)==="lobby"?"Session not started":"Waiting for published round"}),(s==null?void 0:s.status)==="lobby"?e.jsx("p",{className:"cogita-help",children:"No question is shown before the host starts the session."}):w(c,v==null?void 0:v.expected),e.jsx("p",{className:"cogita-user-kicker",children:"Participants"}),e.jsxs("div",{className:"cogita-share-list",children:[s==null?void 0:s.participants.map(C=>{const f=s.currentRoundAnswers.find(q=>q.participantId===C.participantId);return e.jsx("div",{className:"cogita-share-row",children:e.jsxs("div",{children:[e.jsx("strong",{children:C.displayName}),e.jsxs("div",{className:"cogita-share-meta",children:[C.score," pt · ",f?"answered":"waiting",(f==null?void 0:f.isCorrect)===!0?" · correct":"",(f==null?void 0:f.isCorrect)===!1?" · incorrect":""]})]})},C.participantId)}),s&&s.participants.length===0?e.jsx("p",{className:"cogita-help",children:"No participants yet."}):null]})]})]})})})})})}const $o=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionHostPage:No},Symbol.toStringTag,{value:"Module"}));function zs(t){return`cogita.live.join.${t}`}function So(t){const{code:n}=t,[r,s]=a.useState(""),[o,h]=a.useState(()=>typeof localStorage>"u"?null:localStorage.getItem(zs(n))),[u,j]=a.useState(null),[p,k]=a.useState("idle"),[i,m]=a.useState(""),[l,c]=a.useState([]),[v,g]=a.useState(null),[S,O]=a.useState([]),[x,y]=a.useState([]),_=(u==null?void 0:u.currentPrompt)??null,V=a.useMemo(()=>`${(u==null?void 0:u.currentRoundIndex)??0}:${(u==null?void 0:u.revealVersion)??0}:${String((_==null?void 0:_.cardKey)??"")}`,[_==null?void 0:_.cardKey,u==null?void 0:u.currentRoundIndex,u==null?void 0:u.revealVersion]);a.useEffect(()=>{m(""),c([]),g(null),O(Array.isArray(_==null?void 0:_.options)?[..._.options??[]]:[]),y([])},[V]),a.useEffect(()=>{let K=!0;const Q=async()=>{try{const Ae=await us({code:n,participantToken:o});if(!K)return;j(Ae),o&&k("ready")}catch{K&&p!=="joining"&&k("error")}};Q();const me=window.setInterval(Q,1200);return()=>{K=!1,window.clearInterval(me)}},[n,o,p]);const w=async()=>{k("joining");try{const K=await Hr({code:n,name:r});h(K.participantToken),localStorage.setItem(zs(n),K.participantToken),k("ready")}catch{k("error")}},C=K=>{if(!!(_!=null&&_.multiple)){c(me=>me.includes(K)?me.filter(Ae=>Ae!==K):[...me,K].sort((Ae,ee)=>Ae-ee));return}c([K])},f=(K,Q)=>{O(me=>{const Ae=[...me],ee=K+Q;return ee<0||ee>=Ae.length?me:([Ae[K],Ae[ee]]=[Ae[ee],Ae[K]],Ae)})},q=()=>{const K=Array.isArray(_==null?void 0:_.columns)?_.columns:[];y(Q=>[...Q,K.map(()=>0)])},$=(K,Q,me)=>{y(Ae=>Ae.map((ee,L)=>L!==K?ee:ee.map((ye,W)=>W===Q?me:ye)))},R=async()=>{if(!o||!_||typeof _.cardKey!="string")return;let K=null;switch(_.kind){case"selection":K=l;break;case"boolean":K=v;break;case"ordering":K=S;break;case"matching":K={paths:x};break;case"citation-fragment":case"text":default:K=i;break}try{await Wr({code:n,participantToken:o,roundIndex:Number(_.roundIndex??(u==null?void 0:u.currentRoundIndex)??0),cardKey:_.cardKey,answer:K});const Q=await us({code:n,participantToken:o});j(Q),k("ready")}catch{k("error")}};return e.jsx(Pt,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Live Revision"}),e.jsx("h2",{className:"cogita-detail-title",children:"Join session"}),o?e.jsx("p",{className:"cogita-help",children:"Joined. Waiting for host."}):e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{value:r,onChange:K=>s(K.target.value)})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:w,disabled:!r.trim()||p==="joining",children:p==="joining"?"Joining…":"Join"})})]}),p==="error"?e.jsx("p",{className:"cogita-help",children:"Connection error or invalid session."}):null,e.jsx("p",{className:"cogita-user-kicker",children:"Scoreboard"}),e.jsxs("div",{className:"cogita-share-list",children:[u==null?void 0:u.scoreboard.map(K=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:K.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[K.score," pt"]})]},K.participantId)),u&&u.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:"No participants yet."}):null]})]}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Question"}),e.jsx("h3",{className:"cogita-detail-title",children:typeof(_==null?void 0:_.title)=="string"?_.title:"Waiting for host"}),_?e.jsxs(e.Fragment,{children:[_.kind==="citation-fragment"?e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("span",{style:{opacity:.7},children:String(_.before??"")}),e.jsx("strong",{children:" [ ... ] "}),e.jsx("span",{style:{opacity:.7},children:String(_.after??"")})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Fragment"}),e.jsx("input",{value:i,onChange:K=>m(K.target.value)})]})]}):null,_.kind==="text"?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(_.prompt??"")}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsx("input",{type:_.inputType==="number"?"number":_.inputType==="date"?"date":"text",value:i,onChange:K=>m(K.target.value)})]})]}):null,_.kind==="boolean"?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(_.prompt??"")}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>g(!0),children:"True"}),e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>g(!1),children:"False"})]})]}):null,_.kind==="selection"?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(_.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:(Array.isArray(_.options)?_.options:[]).map((K,Q)=>e.jsxs("label",{className:"cogita-share-row",children:[e.jsx("span",{children:K}),e.jsx("input",{type:_.multiple?"checkbox":"radio",name:"live-selection",checked:l.includes(Q),onChange:()=>C(Q)})]},`${Q}-${K}`))})]}):null,_.kind==="ordering"?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(_.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:S.map((K,Q)=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("span",{children:K}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>f(Q,-1),children:"↑"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>f(Q,1),children:"↓"})]})]},`${Q}-${K}`))})]}):null,_.kind==="matching"?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(_.prompt??"")}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:q,children:"Add path"})}),x.map((K,Q)=>e.jsx("div",{className:"cogita-form-actions",children:(Array.isArray(_.columns)?_.columns:[]).map((me,Ae)=>e.jsx("select",{value:K[Ae]??0,onChange:ee=>$(Q,Ae,Number(ee.target.value)),children:me.map((ee,L)=>e.jsxs("option",{value:L,children:[L,": ",ee]},`${Ae}-${L}`))},`path-${Q}-col-${Ae}`))},`path-${Q}`))]}):null,e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:R,disabled:!o||!_.cardKey||(u==null?void 0:u.answerSubmitted),children:u!=null&&u.answerSubmitted?"Submitted":"Submit answer"})})]}):e.jsx("p",{className:"cogita-help",children:"Waiting for host to publish a question."}),u!=null&&u.currentReveal?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Reveal"}),e.jsx("pre",{className:"cogita-json-preview",children:JSON.stringify(u.currentReveal,null,2)})]}):null]})]})})})})})}const Ro=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionJoinPage:So},Symbol.toStringTag,{value:"Module"}));export{Mo as C,Lo as a,Ao as b,$o as c,Ro as d};
