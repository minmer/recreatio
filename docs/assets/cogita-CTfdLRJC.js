import{r as a,j as e,u as $s,a as Rs,b as Es,c as As,R as Fs,B as Ps,C as _s,d as ds}from"./vendor-B-s_ukyJ.js";import{L as Bs,A as Ks,g as qs,a as dn,b as va,c as Ds,s as ps,d as Vs,e as bs,f as us,h as Os,i as un,j as ua,u as hn,k as gn,p as mn,l as fn,m as Us,r as zs,n as pn,o as bn,q as yn,t as qa,v as $a,w as xn,x as vn,y as jn,z as wn,B as Nn,C as kn,D as Tn,E as ys,F as Qt,G as Sn,H as Cn,I as Mn,J as In,K as Ln,M as $n,N as Rn,O as En,P as An,Q as Fn,R as Pn,S as _n,T as Bn,U as Kn,V as qn,W as Dn,X as xs}from"./recreatio-core-B7V_U7t3.js";import"./vendor-cogita-ui-BuvhRVJJ.js";const xa={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},ya={moveMs:900,pauseMs:220,errorMs:900},Vn=(t=11)=>{let s=t;const n=()=>(s=(s*1664525+1013904223)%4294967296,s/4294967296),{width:o,height:c,paddingX:g,paddingY:b,levels:y}=xa,E=(c-b*2)/(y.length-1),w=[],d=[],N=[];y.forEach((v,m)=>{const te=c-b-m*E,_=o-g*2,h=[];for(let z=0;z<v;z+=1){const I=g+(z+1)*_/(v+1),G=(n()-.5)*18,k=Math.max(g,Math.min(o-g,I+G)),P=m===0?3:m<2?2.1:1.4,Z=m===0?"root":`l${m}-${z}`;h.push({id:Z,x:m===0?o/2:k,y:te,r:P,level:m,role:m===0?"root":void 0})}N.push(h),w.push(...h)});const l=N[N.length-1];if(l!=null&&l.length){const v=l[Math.floor(l.length/2)];v.role="goal",v.r=2}for(let v=1;v<N.length;v+=1){const m=N[v-1];N[v].forEach(_=>{const h=[...m].sort((k,P)=>Math.abs(k.x-_.x)-Math.abs(P.x-_.x)),z=h[0],I=h[1]&&n()<.45?h[1]:null;(I?[z,I]:[z]).forEach(k=>{d.push({from:k.id,to:_.id,key:`${k.id}-${_.id}`})}),n()<.2&&h[2]&&d.push({from:h[2].id,to:_.id,key:`${h[2].id}-${_.id}`})})}const r=new Map;d.forEach(v=>{const m=r.get(v.to)??[];m.push(v.from),r.set(v.to,m)});const Y=new Map,ie=new Map,W=new Map;d.forEach(v=>{const m=Y.get(v.from)??[];m.push(v.key),Y.set(v.from,m);const te=ie.get(v.from)??[];te.push(v.to),ie.set(v.from,te);const _=W.get(v.from)??[];_.push(v.to),W.set(v.from,_);const h=W.get(v.to)??[];h.push(v.from),W.set(v.to,h)});const U=new Map;return w.forEach(v=>{U.set(v.id,v)}),{nodes:w,links:d,parentsById:r,linksByFrom:Y,childrenByFrom:ie,neighborsById:W,nodesById:U}};function On({slides:t,activeIndex:s,introOpen:n,prefersReducedMotion:o,onNext:c,onPrev:g,onSelect:b,onExit:y,onOpen:E,onRegister:w}){const d=s===t.length-1,N=n&&s===0?"entry":"docked",l=t[t.length-1],[r,Y]=a.useState(!1),ie=a.useMemo(()=>Array.from({length:20},(L,X)=>({src:`/cogita/logo/Cogita${String(X).padStart(2,"0")}.png`,kind:X<=11?"bubble":X<=17?"text":"recreatio"})),[]),W=n&&s===0;a.useEffect(()=>{if(!n){Y(!1);return}s>0&&!r&&Y(!0)},[s,n,r]);const U=a.useRef(0),v=a.useRef(null),m=a.useMemo(()=>{const L={x:40,y:160},X={x:260,y:48},ve=6,$=X.x-L.x,O=L.y-X.y,fe=$/ve,be=[.3,.45,.6,.65,1.4,2.2],pe=be.reduce((Fe,Te)=>Fe+Te,0),Ae=be.map(Fe=>O*Fe/pe),Qe=[L];let Oe=L.x,Le=L.y;for(let Fe=1;Fe<=ve;Fe+=1){const Te=(Math.random()-.5)*14,ot=(Math.random()-.5)*28;Oe=Math.max(L.x+Fe*14,Math.min(X.x-(ve-Fe)*14,Oe+fe+Te));const Ue=Ae[Fe-1]??Ae[Ae.length-1];Le=Le-Ue+ot;const tt=Math.max(X.y,Math.min(L.y-4,Le));Qe.push({x:Math.round(Oe),y:Math.round(tt)})}return Qe[Qe.length-1]=X,Qe},[]),te=a.useMemo(()=>{const O=(pe,Ae,Qe)=>Math.min(Qe,Math.max(Ae,pe)),fe=m.map(pe=>{const Ae=10+Math.random()*36;return{x:O(pe.x,40,260),y:O(pe.y-Ae,40,140)}}),be=m.map((pe,Ae)=>{var Le;const Qe=12+Math.random()*40,Oe=((Le=fe[Ae])==null?void 0:Le.y)??pe.y;return{x:O(pe.x,40,260),y:O(Math.max(Oe+10,pe.y+Qe),60,170)}});return{upper:fe,lower:be}},[m]),_=a.useMemo(()=>{var X;const L=((X=m[4])==null?void 0:X.x)??260;return Math.max(0,Math.min(240,L-40))},[m]),h=a.useMemo(()=>{var Ae,Qe;const L=(Oe,Le,Fe)=>Math.min(Fe,Math.max(Le,Oe)),X=(Oe,Le,Fe)=>m.map((Te,ot)=>{var It,lt;const Ue=((It=te.upper[ot])==null?void 0:It.y)??Te.y,tt=((lt=te.lower[ot])==null?void 0:lt.y)??Te.y,vt=(Math.random()-.5)*70,ft=Te.y+Oe+vt,ze=L(Te.y+Le,Ue+6,tt-6),at=L(Te.y+Fe,Ue+6,tt-6);return{x:Te.x,y:L(ft,Math.min(ze,at),Math.max(ze,at))}}),ve=-14+Math.random()*28,$=14+Math.random()*28,O=X(ve,-80,12),fe=X($,-12,80);for(let Oe=4;Oe<m.length;Oe+=1){const Le=m[Oe],Fe=((Ae=te.upper[Oe])==null?void 0:Ae.y)??Le.y,Te=((Qe=te.lower[Oe])==null?void 0:Qe.y)??Le.y;O[Oe]={x:Le.x,y:L(Le.y-12,Fe+6,Te-6)},fe[Oe]={x:Le.x,y:L(Le.y+12,Fe+6,Te-6)}}const be=te.upper.length?te.upper[te.upper.length-1].y:40,pe=te.lower.length?te.lower[te.lower.length-1].y:170;return O[O.length-1]={x:m[m.length-1].x,y:L(m[m.length-1].y-14,be,pe)},fe[fe.length-1]={x:m[m.length-1].x,y:L(m[m.length-1].y+12,be,pe)},{higher:O,lower:fe}},[m,te]),z=1e4,I=a.useMemo(()=>{let L=17;const X=()=>(L=(L*1664525+1013904223)%4294967296,L/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map(($,O)=>{const fe=(X()-.5)*240,be=(X()-.5)*180,pe=(X()-.5)*24;return{id:`card-${O+1}`,throw:{x:`${fe.toFixed(0)}px`,y:`${be.toFixed(0)}px`,rot:`${pe.toFixed(1)}deg`},grid:{x:`${$.x}px`,y:`${$.y}px`},delay:`${O*.12}s`}})},[]),G=a.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[k,P]=a.useState([]),Z=a.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),ne=a.useMemo(()=>{const X=[],$=(fe,be)=>fe+Math.random()*(be-fe);for(let fe=0;fe<6;fe+=1){let be=!1;for(let pe=0;pe<80;pe+=1){const Ae=$(14,86),Qe=$(10,34);if(X.every(Le=>{const Fe=Le.x-Ae,Te=Le.y-Qe;return Math.hypot(Fe,Te)>=12})){X.push({x:Ae,y:Qe}),be=!0;break}}be||X.push({x:$(16,84),y:$(12,32)})}return X.map((fe,be)=>({id:`p${be+1}`,x:`${fe.x.toFixed(1)}%`,y:`${fe.y.toFixed(1)}%`,xNum:fe.x,yNum:fe.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[ce,Ie]=a.useState(0),[de,S]=a.useState(0),[ge,x]=a.useState([]),V=1e4,ue=a.useMemo(()=>{if(ne.length<2)return[];const L=be=>{let pe=be+1831565813;return pe=Math.imul(pe^pe>>>15,pe|1),pe^=pe+Math.imul(pe^pe>>>7,pe|61),((pe^pe>>>14)>>>0)/4294967296},X=(be,pe)=>Math.floor(L(be)*pe),ve=new Set,$=[],O=Math.min(3,ne.length);let fe=0;for(;$.length<O&&fe<30;){fe+=1;const be=X(ce*13+fe*5,ne.length),pe=X(ce*29+fe*7,ne.length);if(be===pe)continue;const Ae=be<pe?`${be}-${pe}`:`${pe}-${be}`;ve.has(Ae)||(ve.add(Ae),$.push({id:`link-${Ae}`,from:ne[be],to:ne[pe],delay:`${(fe*.35).toFixed(2)}s`}))}return $},[ce,ne]);a.useEffect(()=>{if(!n||s!==2)return;const L=()=>{const ve=I.map($=>$.id);for(let $=ve.length-1;$>0;$-=1){const O=Math.floor(Math.random()*($+1));[ve[$],ve[O]]=[ve[O],ve[$]]}return ve.slice(0,4)};P(L());const X=window.setInterval(()=>{P(L())},z);return()=>window.clearInterval(X)},[s,n,I,z]),a.useEffect(()=>{if(!n||s!==3)return;const L=()=>{S(Math.floor(Math.random()*Z.length)),x(ne.map(()=>Math.random()<.6?"good":"bad")),Ie(ve=>ve+1)};L();const X=window.setInterval(L,V);return()=>window.clearInterval(X)},[s,n,Z.length,ne,V]);const B=a.useMemo(()=>Vn(11),[]),[H,Ne]=a.useState(new Set(["root"])),[Se,je]=a.useState(new Set),[Re,ye]=a.useState(new Set),[Ke,_e]=a.useState({fromId:"root",toId:"root",key:0}),we=a.useRef(H),Be=a.useRef("root"),et=a.useRef(0),We=a.useRef(null),q=a.useRef(null),Q=a.useRef([]);a.useEffect(()=>{we.current=H},[H]);const De=a.useMemo(()=>{const L=new Set;return H.forEach(X=>{const ve=B.linksByFrom.get(X);ve&&ve.forEach($=>L.add($))}),L},[H,B]),xe=B.nodesById.get(Ke.toId)??B.nodesById.get("root"),re=xe?`${xe.x/xa.width*100}%`:"50%",$e=xe?`${xe.y/xa.height*100}%`:"90%";a.useEffect(()=>{if(!n||s!==1||o)return;(()=>{Ne(new Set(["root"])),je(new Set),ye(new Set),_e({fromId:"root",toId:"root",key:0}),q.current=null,et.current=0,Be.current="root",Q.current=[]})();const X=()=>{const $=Be.current,O=we.current,be=(B.childrenByFrom.get($)??[]).filter(Te=>!O.has(Te));if(be.length)return be[Math.floor(Math.random()*be.length)];if(O.size>=B.nodes.length){const Te=B.neighborsById.get($)??[];return Te.length?Te[Math.floor(Math.random()*Te.length)]:null}const pe=Te=>(B.childrenByFrom.get(Te)??[]).some(Ue=>!O.has(Ue)),Ae=[$],Qe=new Set([$]),Oe=new Map;let Le=null;for(;Ae.length;){const Te=Ae.shift();if(!Te)break;if(Te!==$&&pe(Te)){Le=Te;break}(B.neighborsById.get(Te)??[]).forEach(Ue=>{Qe.has(Ue)||(Qe.add(Ue),Oe.set(Ue,Te),Ae.push(Ue))})}if(!Le)return null;let Fe=Le;for(;Oe.get(Fe)&&Oe.get(Fe)!==$;)Fe=Oe.get(Fe)??Fe;return Fe},ve=($,O)=>{if($===O){const fe=X();fe&&ve($,fe);return}et.current+=1,_e({fromId:$,toId:O,key:et.current}),Be.current=O,We.current=window.setTimeout(()=>{const fe=B.parentsById.get(O)??[],be=we.current,pe=fe.filter(Le=>!be.has(Le));if(!pe.length){const Le=new Set(be);Le.add(O),Ne(Le),We.current=window.setTimeout(()=>{for(;Q.current.length;){const Te=Q.current[Q.current.length-1];if(!Le.has(Te)){if(Te!==O){ve(O,Te);return}break}Q.current.pop()}const Fe=X();Fe&&ve(O,Fe)},ya.pauseMs);return}const Ae=new Set([O,...pe]),Qe=new Set(pe.map(Le=>`${Le}-${O}`));je(Ae),ye(Qe),Q.current.includes(O)||Q.current.push(O);const Oe=pe[Math.floor(Math.random()*pe.length)];q.current={fromId:O,toId:Oe},We.current=window.setTimeout(()=>{je(new Set),ye(new Set);const Le=q.current;Le&&ve(Le.fromId,Le.toId)},ya.errorMs)},ya.moveMs)};return We.current=window.setTimeout(()=>{const $=X();$&&ve(Be.current,$)},ya.pauseMs),()=>{We.current&&window.clearTimeout(We.current)}},[s,n,B,o]);const qe=L=>{if(!n)return;const X=Date.now();X-U.current<520||Math.abs(L.deltaY)<10||(U.current=X,L.deltaY>0?c():g(),L.preventDefault())},K=L=>{if(!n)return;const X=L.touches[0];X&&(v.current={x:X.clientX,y:X.clientY})},le=L=>{if(!n)return;const X=v.current;if(v.current=null,!X)return;const ve=L.changedTouches[0];if(!ve)return;const $=ve.clientX-X.x,O=ve.clientY-X.y;Math.abs(O)<40||Math.abs(O)<Math.abs($)||(O<0?c():g())};return e.jsxs("div",{className:`cogita-intro ${n?"is-open":"is-closed"} ${o?"is-reduced":""} ${d?"is-final":""}`,"data-slide":s+1,onWheel:qe,onTouchStart:K,onTouchEnd:le,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":N,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${W&&!r?"is-entry":""}`,children:ie.map((L,X)=>e.jsx("img",{src:L.src,alt:"",className:`cogita-logo-layer ${X===0?"is-base":""} ${L.kind==="text"?"is-text":L.kind==="recreatio"?"is-recreatio":""} ${L.kind==="bubble"?"is-bubble":""}`},L.src))})}),n&&t.map((L,X)=>{const ve=X===s;return e.jsxs("section",{className:`cogita-intro-slide slide-${X+1} ${ve?"is-active":""}`,"aria-hidden":!ve,children:[e.jsxs("div",{className:"cogita-intro-text",children:[L.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:L.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:L.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:L.title}),L.body&&e.jsx("p",{children:L.body.split(`
`).map(($,O)=>e.jsxs("span",{children:[$,O===0&&e.jsx("br",{})]},String(O)))})]}),L.micro&&e.jsx("p",{className:"cogita-intro-micro",children:L.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:d?w:c,children:L.cta}),d&&L.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>b(0),children:L.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[X===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${xa.width} ${xa.height}`,preserveAspectRatio:"none",children:[B.links.map($=>{const O=B.nodesById.get($.from),fe=B.nodesById.get($.to);if(!O||!fe)return null;const be=De.has($.key),pe=Re.has($.key);return e.jsx("line",{className:`map-link ${be?"is-active":""} ${pe?"is-error":""}`,x1:O.x,y1:O.y,x2:fe.x,y2:fe.y},$.key)}),B.nodes.map($=>{const O=H.has($.id),fe=Se.has($.id);return e.jsx("circle",{className:`map-node ${$.role?`is-${$.role}`:""} ${O?"is-active":""} ${fe?"is-error":""}`,cx:$.x,cy:$.y,r:$.r},$.id)})]}),xe&&e.jsx("span",{className:"map-explorer-dot",style:{left:re,top:$e,"--move":`${ya.moveMs}ms`}})]}),X===2&&e.jsx("div",{className:"cogita-index-cards",children:I.map($=>{const O=k.indexOf($.id),fe=O>=0?G[O]:null,be=(fe==null?void 0:fe.x)??"140px",pe=(fe==null?void 0:fe.y)??"140px",Ae=O>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":$.throw.x,"--throw-y":$.throw.y,"--throw-rot":$.throw.rot,"--grid-x":$.grid.x,"--grid-y":$.grid.y,"--stack-x":be,"--stack-y":pe,"--stack-opacity":Ae,"--delay":$.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},$.id)})}),X===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[Z.map(($,O)=>e.jsxs("div",{className:`round-card ${O===de?"is-active":""}`,style:{"--card-x":$.x,"--card-y":$.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},$.id)),Z[de]&&e.jsx("span",{className:"round-ring",style:{"--card-x":Z[de].x,"--card-y":`calc(${Z[de].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:ne.map($=>e.jsx("span",{className:"player-dot",style:{left:$.x,top:$.y,"--jitter-x":$.jitterX,"--jitter-y":$.jitterY,"--breath-delay":$.delay}},$.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:ue.map($=>e.jsx("line",{className:"round-link",x1:$.from.xNum,y1:$.from.yNum,x2:$.to.xNum,y2:$.to.yNum,style:{"--delay":$.delay}},$.id))}),e.jsx("div",{className:"round-flows",children:ne.map(($,O)=>{const fe=ge[O]??"good",be=Z[de];if(!be)return null;const pe=`calc(${be.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":$.x,"--from-y":$.y,"--to-x":be.x,"--to-y":pe,"--delay":`${O*.12}s`}}),e.jsx("span",{className:`return-dot is-${fe}`,style:{"--from-x":be.x,"--from-y":pe,"--to-x":$.x,"--to-y":$.y,"--delay":`${O*.12}s`}}),e.jsx("span",{className:`result-pop is-${fe}`,style:{"--at-x":$.x,"--at-y":$.y,"--delay":`${O*.12}s`}})]},`${$.id}-${ce}`)})})]},`round-${ce}`),X===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${m[0].x} ${m[0].y} L${m[1].x} ${m[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${m[1].x} ${m[1].y} L${m[2].x} ${m[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${m[2].x} ${m[2].y} L${m[3].x} ${m[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${m[3].x} ${m[3].y} L${m[4].x} ${m[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${m[4].x} ${m[4].y} L${m[5].x} ${m[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${m[5].x} ${m[5].y} L${m[6].x} ${m[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${_};${_};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${te.upper.map(($,O)=>`${O===0?"M":"L"}${$.x} ${$.y}`).join(" ")} ${te.lower.slice().reverse().map($=>`L${$.x} ${$.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${te.upper.map(($,O)=>`${O===0?"M":"L"}${$.x} ${$.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${te.lower.map(($,O)=>`${O===0?"M":"L"}${$.x} ${$.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[h.higher.slice(0,6).map(($,O)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${O+1}`,d:`M${$.x} ${$.y} L${h.higher[O+1].x} ${h.higher[O+1].y}`,pathLength:"100"},`peer-1-${O}`)),h.lower.slice(0,6).map(($,O)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${O+1}`,d:`M${$.x} ${$.y} L${h.lower[O+1].x} ${h.lower[O+1].y}`,pathLength:"100"},`peer-2-${O}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${m[0].x/300*100}%`,"--p0y":`${m[0].y/200*100}%`,"--p1x":`${m[1].x/300*100}%`,"--p1y":`${m[1].y/200*100}%`,"--p2x":`${m[2].x/300*100}%`,"--p2y":`${m[2].y/200*100}%`,"--p3x":`${m[3].x/300*100}%`,"--p3y":`${m[3].y/200*100}%`,"--p4x":`${m[4].x/300*100}%`,"--p4y":`${m[4].y/200*100}%`,"--p5x":`${m[5].x/300*100}%`,"--p5y":`${m[5].y/200*100}%`,"--p6x":`${m[6].x/300*100}%`,"--p6y":`${m[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${h.higher[0].x/300*100}%`,"--q0y":`${h.higher[0].y/200*100}%`,"--q1x":`${h.higher[1].x/300*100}%`,"--q1y":`${h.higher[1].y/200*100}%`,"--q2x":`${h.higher[2].x/300*100}%`,"--q2y":`${h.higher[2].y/200*100}%`,"--q3x":`${h.higher[3].x/300*100}%`,"--q3y":`${h.higher[3].y/200*100}%`,"--q4x":`${h.higher[4].x/300*100}%`,"--q4y":`${h.higher[4].y/200*100}%`,"--q5x":`${h.higher[5].x/300*100}%`,"--q5y":`${h.higher[5].y/200*100}%`,"--q6x":`${h.higher[6].x/300*100}%`,"--q6y":`${h.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${h.lower[0].x/300*100}%`,"--q0y":`${h.lower[0].y/200*100}%`,"--q1x":`${h.lower[1].x/300*100}%`,"--q1y":`${h.lower[1].y/200*100}%`,"--q2x":`${h.lower[2].x/300*100}%`,"--q2y":`${h.lower[2].y/200*100}%`,"--q3x":`${h.lower[3].x/300*100}%`,"--q3y":`${h.lower[3].y/200*100}%`,"--q4x":`${h.lower[4].x/300*100}%`,"--q4y":`${h.lower[4].y/200*100}%`,"--q5x":`${h.lower[5].x/300*100}%`,"--q5y":`${h.lower[5].y/200*100}%`,"--q6x":`${h.lower[6].x/300*100}%`,"--q6y":`${h.lower[6].y/200*100}%`}})]})})}),X===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),X===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},L.id)}),!n&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:l.title}),l.body&&e.jsx("p",{children:l.body}),l.micro&&e.jsx("p",{className:"cogita-intro-micro",children:l.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:w,children:l.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:E,children:"Otwórz pokaz"})]})]})})]}),n&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((L,X)=>e.jsx("button",{type:"button",className:`dot ${s===X?"active":""}`,"aria-label":L.title,onClick:()=>b(X)},L.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:y,children:"Pomiń"})]})]})}const Un=6,zn=4;function Hn({copy:t,onAuthAction:s,authLabel:n,showProfileMenu:o,onProfileNavigate:c,onToggleSecureMode:g,onLogout:b,secureMode:y,onNavigate:E,language:w,onLanguageChange:d}){const N=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}E("home")},l=a.useRef(null),r=a.useRef([]),Y=a.useMemo(()=>{let x=Date.now()%2147483647;const V=()=>(x=x*48271%2147483647,x/2147483647);return Array.from({length:Un},(ue,B)=>{const H=6+V()*8,Ne=7+V()*10,Se=6+V()*9,je=-V()*H,Re=-V()*Ne,ye=-V()*Se,Ke=.18+V()*.28,_e=12+V()*18,we=4+V()*8,Be=(V()-.5)*3.2,et=(V()-.5)*3.8,We=V()>.5?"alternate":"alternate-reverse",q=V()>.5?"alternate":"alternate-reverse",Q=V()>.5?"alternate":"alternate-reverse",De=.18+V()*.42,xe=30+V()*60,re=-45-V()*38,$e=188+V()*32,qe=.1+V()*.2;return{id:`wave-${B+1}`,style:{"--wave-sway-duration":`${H}s`,"--wave-scale-duration":`${Ne}s`,"--wave-drift-duration":`${Se}s`,"--wave-sway-delay":`${je}s`,"--wave-scale-delay":`${Re}s`,"--wave-drift-delay":`${ye}s`,"--wave-sway-dir":We,"--wave-scale-dir":q,"--wave-drift-dir":Q,"--wave-scale":`${Ke}`,"--wave-shift":`${_e}%`,"--wave-xshift":`${we}%`,"--wave-x0":`${Be}%`,"--wave-y0":`${et}%`,"--wave-opacity":`${De}`,"--wave-blur":`${xe}px`,"--wave-bottom":`${re}%`,"--wave-hue":`${$e}`,"--wave-glow":`${qe}`}}})},[]),ie=a.useMemo(()=>{let x=Date.now()*3%2147483647;const V=()=>(x=x*48271%2147483647,x/2147483647);return Array.from({length:zn},(ue,B)=>{const H=180+V()*220,Ne=220+V()*280,Se=-V()*H,je=-V()*Ne,Re=.12+V()*.22,ye=3+V()*7,Ke=1+V()*3,_e=(V()-.5)*2.8,we=(V()-.5)*2.2;return{id:`mesh-${B+1}`,seed:1e3+B*991+Math.floor(V()*999),style:{"--mesh-sway-duration":`${H}s`,"--mesh-drift-duration":`${Ne}s`,"--mesh-sway-delay":`${Se}s`,"--mesh-drift-delay":`${je}s`,"--mesh-scale":`${Re}`,"--mesh-shift":`${ye}%`,"--mesh-xshift":`${Ke}%`,"--mesh-x0":`${we}%`,"--mesh-y0":`${_e}%`}}})},[]),W=a.useMemo(()=>{const x=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],V=t.cogita.introSlides,ue=new Map(V.map(B=>[B.id,B]));return x.map(B=>{var Ne;const H=ue.get(B.id);return{...B,...H,title:(H==null?void 0:H.title)??"Cogita",cta:(H==null?void 0:H.cta)??((Ne=t.cogita.introSlides[0])==null?void 0:Ne.cta)??t.cogita.loginCta,secondary:H==null?void 0:H.secondary}})},[t.cogita.introSlides]),[U,v]=a.useState(0),[m,te]=a.useState(!0),[_,h]=a.useState(!1),z=W.length-1,I=a.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),G=a.useCallback(()=>{I(),s()},[I,s]),k=a.useCallback(()=>{te(!0),v(0)},[]),P=a.useCallback(()=>{te(!1),v(z)},[z]),Z=a.useCallback(x=>{v(Math.max(0,Math.min(z,x)))},[z]),ne=a.useCallback(()=>{U>=z?G():Z(U+1)},[U,Z,G,z]),ce=a.useCallback(()=>{Z(U-1)},[U,Z]);a.useEffect(()=>{var ue;const x=(ue=window.matchMedia)==null?void 0:ue.call(window,"(prefers-reduced-motion: reduce)");if(!x)return;const V=()=>h(x.matches);return V(),x.addEventListener?(x.addEventListener("change",V),()=>x.removeEventListener("change",V)):(x.addListener(V),()=>x.removeListener(V))},[]),a.useEffect(()=>{if(!m)return;const x=V=>{const ue=V.target;if(!ue)return;const B=ue.tagName;if(!(ue.isContentEditable||B==="INPUT"||B==="TEXTAREA"||B==="SELECT"||B==="BUTTON"||B==="A"||ue.closest('button, a, [role="button"], [role="link"]'))){if(V.key==="Escape"){P();return}if(V.key==="ArrowLeft"||V.key==="ArrowUp"){ce();return}(V.key==="ArrowRight"||V.key==="ArrowDown"||V.code==="Space"||V.key===" ")&&(V.preventDefault(),ne())}};return window.addEventListener("keydown",x),()=>window.removeEventListener("keydown",x)},[P,ne,ce,m]),a.useEffect(()=>{m&&U===z&&I()},[U,m,z,I]),a.useEffect(()=>{const x=l.current;if(!x)return;const V=r.current.filter(re=>!!re);if(!V.length)return;const ue=1,B=.6,H=.6,Ne=Math.max(1,Math.min(ue,window.devicePixelRatio||1));let Se=0,je=0,Re=B,ye=0,Ke=0;const _e=re=>{let $e=re%2147483647;return $e<=0&&($e+=2147483646),(qe,K)=>{$e=$e*48271%2147483647;const le=$e/2147483647;return qe+le*(K-qe)}},we={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},Be=re=>{const $e=Math.sin(re*12.9898)*43758.5453;return $e-Math.floor($e)},et=re=>{const $e=Be(re+.1)||1e-4,qe=Be(re+.7)||1e-4;return Math.sqrt(-2*Math.log($e))*Math.cos(2*Math.PI*qe)},We=(re,$e)=>{const qe=Math.floor(re),K=qe+1,le=re-qe,L=le*le*(3-2*le),X=Be(qe*12.9898+$e*78.233),ve=Be(K*12.9898+$e*78.233);return X+(ve-X)*L},q=re=>{const $e=_e(re),qe=Math.min(4,Math.max(4,Math.floor(Se/1200*we.filamentCount)));return Array.from({length:qe},(K,le)=>{const L=Math.max(-1,Math.min(1,et(re+le*.37))),X=Math.min(1,Math.max(0,Be(re+le*1.31))),ve=Math.min(we.depthLayers-1,Math.floor(X*we.depthLayers));return{seed:$e(0,Math.PI*2)+re*.01,offset:L,freqA:we.freq1*(.75+$e(0,.5)),freqB:we.freq2*(.75+$e(0,.5)),ampA:we.amp1*(.6+$e(0,.7)),ampB:we.amp2*(.6+$e(0,.7)),width:2+le%5*.32,depth:X,layer:ve}})},Q=(re,$e,qe)=>{const K=Math.max(30,Math.floor(Se*je/14e4));re.save(),re.globalAlpha=.6;for(let le=0;le<K;le+=1){const L=Be(le*9.1+Se*.11)*$e+qe,X=Be(le*3.7+je*.23)*je,ve=1.2+Be(le*5.9)*2.4,$=re.createRadialGradient(L,X,0,L,X,ve*2);$.addColorStop(0,"rgba(10, 30, 60, 0.45)"),$.addColorStop(1,"rgba(10, 30, 60, 0)"),re.fillStyle=$,re.beginPath(),re.arc(L,X,ve*2,0,Math.PI*2),re.fill()}re.restore()},De=(re,$e)=>{re.clearRect(0,0,Se,je);const qe=je*we.waveCenter,K=we.waveBandPx,le=we.segments,L=we.colors.filaments,X=ye||Se,ve=0;Q(re,X,ve),re.strokeStyle=L,re.lineCap="round",re.lineJoin="round";for(let $=0;$<$e.length;$+=1){const O=$e[$],fe=O.offset*K*(.85+Be(O.seed)*.4),be=1-Math.min(1,Math.abs(fe)/K),pe=Math.exp(-Math.pow(fe/we.crestThickness,2)),Ae=O.layer===0?1.1:O.layer===1?.85:.6,Qe=.35+(1-O.depth)*.65,Oe=be*Qe*Ae*(.34+pe*.45);re.globalAlpha=Oe,re.lineWidth=O.width*(1+(1-O.depth)*.8);const Le=[];for(let Te=0;Te<=le;Te+=1){const ot=Te/le*X+ve,Ue=(We(ot*.012,O.seed)-.5)*we.xJitter,tt=ot+Ue,vt=(We(tt*O.freqA,O.seed)-.5)*we.jitterA,ft=(We(tt*O.freqB,O.seed*1.7)-.5)*we.jitterB,ze=qe+Math.sin(tt*O.freqA+O.seed)*O.ampA+Math.sin(tt*O.freqB+O.seed*1.3)*O.ampB+fe+vt+ft;Le.push({x:tt,y:ze})}re.beginPath(),re.moveTo(Le[0].x,Le[0].y);for(let Te=1;Te<Le.length-1;Te+=1){const ot=(Le[Te].x+Le[Te+1].x)/2,Ue=(Le[Te].y+Le[Te+1].y)/2;re.quadraticCurveTo(Le[Te].x,Le[Te].y,ot,Ue)}const Fe=Le[Le.length-1];re.quadraticCurveTo(Fe.x,Fe.y,Fe.x,Fe.y),re.stroke()}re.save(),re.globalCompositeOperation="lighter",re.strokeStyle=we.colors.glow,re.lineCap="round",re.lineJoin="round";for(let $=0;$<$e.length;$+=1){const O=$e[$];if(Math.abs(O.offset)*K>we.crestThickness)continue;const fe=we.glowAlpha*(.7+(1-O.depth)*.6);re.globalAlpha=fe,re.lineWidth=1.6+(1-O.depth)*1.2;const be=[];for(let Ae=0;Ae<=le;Ae+=1){const Qe=Ae/le*X+ve,Oe=Math.sin(Qe*.02+O.seed)*3,Le=qe+Math.sin(Qe*O.freqA+O.seed)*O.ampA+Math.sin(Qe*O.freqB+O.seed*1.3)*O.ampB+O.offset*K*.35+Oe;be.push({x:Qe,y:Le})}re.beginPath(),re.moveTo(be[0].x,be[0].y);for(let Ae=1;Ae<be.length-1;Ae+=1){const Qe=(be[Ae].x+be[Ae+1].x)/2,Oe=(be[Ae].y+be[Ae+1].y)/2;re.quadraticCurveTo(be[Ae].x,be[Ae].y,Qe,Oe)}const pe=be[be.length-1];re.quadraticCurveTo(pe.x,pe.y,pe.x,pe.y),re.stroke()}re.restore()},xe=()=>{Se=Math.floor(x.clientWidth),je=Math.floor(x.clientHeight),ye=Math.floor(Se*1.8),Ke=je,Re=Se<820?H:B,V.forEach(re=>{const $e=re.getContext("2d");if(!$e)return;re.width=Math.floor(ye*Ne*Re),re.height=Math.floor(Ke*Ne*Re),re.style.width=`${ye}px`,re.style.height=`${Ke}px`,re.style.left=`${-(ye-Se)/2}px`,$e.setTransform(Ne*Re,0,0,Ne*Re,0,0);const qe=Number(re.dataset.seed||1),K=q(qe);De($e,K)})};return xe(),window.addEventListener("resize",xe,{passive:!0}),()=>window.removeEventListener("resize",xe)},[ie]);const Ie=W[Math.min(U,W.length-1)],de=m?Ie:W[W.length-1],S=(de==null?void 0:de.theme)??W[0].theme,ge={"--cogita-bg0":S.bg0,"--cogita-bg1":S.bg1,"--cogita-bg2":S.bg2,"--cogita-bloom":S.bloom,"--cogita-sat":S.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:N,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Bs,{value:w,onChange:d}),e.jsx(Ks,{copy:t,label:n,isAuthenticated:o,secureMode:y,onLogin:s,onProfileNavigate:c,onToggleSecureMode:g,onLogout:b,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:l,className:"cogita-section cogita-home",style:ge,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[ie.map((x,V)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:x.style,"data-seed":x.seed,ref:ue=>{r.current[V]=ue}},x.id)),Y.map(x=>e.jsx("div",{className:"cogita-home-wave",style:x.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},x.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(On,{slides:W,activeIndex:U,introOpen:m,prefersReducedMotion:_,onNext:ne,onPrev:ce,onSelect:Z,onExit:P,onOpen:k,onRegister:G})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const Ui=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:Hn},Symbol.toStringTag,{value:"Module"})),Hs=a.createContext(!1);function Nt({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,children:d}){if(a.useContext(Hs))return e.jsx(e.Fragment,{children:d});const l=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}y("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:l,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Bs,{value:E,onChange:w}),e.jsx(Ks,{copy:t,label:s,isAuthenticated:n,secureMode:b,onLogin:()=>y("home"),onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:d}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function Dt(t){const[s,n]=a.useState("Cogita library"),[o,c]=a.useState(null);return a.useEffect(()=>{let g=!1;return qs().then(b=>{if(g)return;const y=b.find(E=>E.libraryId===t);y&&n(y.name)}).catch(()=>{g||n("Cogita library")}),()=>{g=!0}},[t]),a.useEffect(()=>{let g=!1;return dn(t).then(b=>{g||c(b)}).catch(()=>{g||c(null)}),()=>{g=!0}},[t]),{libraryName:s,stats:o}}function vs({slices:t}){const s=t.reduce((o,c)=>o+Math.max(0,c.value),0),n=a.useMemo(()=>{if(s<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let o=0;return`conic-gradient(${t.map(g=>{const y=Math.max(0,g.value)/s*360,E=o,w=o+y;return o=w,`${g.color} ${E}deg ${w}deg`}).join(",")})`},[t,s]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:n}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(o=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:o.color}}),e.jsx("strong",{children:o.value}),e.jsx("small",{children:o.label})]},o.label))})]})}function Qn({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,libraryId:d}){const{libraryName:N,stats:l}=Dt(d),[r,Y]=a.useState("infos"),[ie,W]=a.useState(0),[U,v]=a.useState(0),[m,te]=a.useState(0),_=(l==null?void 0:l.totalInfos)??0,h=(l==null?void 0:l.totalCollections)??0,z=0,I=0,G=0,k=Math.max(0,_-G-U),P=Math.max(0,_-U-m);a.useEffect(()=>{let ne=!1;return(async()=>{try{const Ie=await va({libraryId:d,limit:200}),de=await Promise.all(Ie.items.map(S=>Ds({libraryId:d,collectionId:S.collectionId}).catch(()=>[])));if(ne)return;W(de.reduce((S,ge)=>S+ge.length,0))}catch{ne||W(0)}})(),()=>{ne=!0}},[d]),a.useEffect(()=>{let ne=!1;return(async()=>{try{const[Ie,de,S]=await Promise.all([ps({libraryId:d,type:"computed",limit:1}).catch(()=>({total:0})),ps({libraryId:d,type:"source",limit:1}).catch(()=>({total:0})),Vs({libraryId:d}).catch(()=>({items:[]}))]);if(ne)return;v((Ie.total??0)+(de.total??0));const ge=new Set(S.items.filter(x=>x.childItemType.toLowerCase()==="info").map(x=>x.childItemId).filter(Boolean));te(ge.size)}catch{ne||(v(0),te(0))}})(),()=>{ne=!0}},[d]);const Z=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:_},{key:"collections",label:t.cogita.library.overview.stats.collections,value:h},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:ie},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:z},{key:"texts",label:t.cogita.library.overview.stats.texts,value:I}];return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:N})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:Z.map(ne=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${r===ne.key?"active":""}`,onClick:()=>Y(ne.key),children:[e.jsx("span",{children:ne.label}),e.jsx("strong",{children:ne.value})]},ne.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),r==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(vs,{slices:[{label:t.cogita.library.overview.known,value:G,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:k,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:U,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(vs,{slices:[{label:t.cogita.library.overview.availableChecks,value:m,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:P,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const st=(t,s)=>{const n=t.cogita.library.infoTypes;return{any:n.any,vocab:n.vocab,language:n.language,word:n.word,sentence:n.sentence,topic:n.topic,collection:n.collection,person:n.person,institution:n.institution,collective:n.collective,orcid:n.orcid,address:n.address,email:n.email,phone:n.phone,media:n.media,work:n.work,geo:n.geo,music_piece:n.musicPiece,music_fragment:n.musicFragment,source:n.source,quote:n.quote,computed:n.computed}[s]??String(s)},Qs=t=>[{value:"any",label:st(t,"any")},{value:"language",label:st(t,"language")},{value:"word",label:st(t,"word")},{value:"sentence",label:st(t,"sentence")},{value:"topic",label:st(t,"topic")},{value:"collection",label:st(t,"collection")},{value:"person",label:st(t,"person")},{value:"institution",label:st(t,"institution")},{value:"collective",label:st(t,"collective")},{value:"orcid",label:st(t,"orcid")},{value:"address",label:st(t,"address")},{value:"email",label:st(t,"email")},{value:"phone",label:st(t,"phone")},{value:"media",label:st(t,"media")},{value:"work",label:st(t,"work")},{value:"geo",label:st(t,"geo")},{value:"music_piece",label:st(t,"music_piece")},{value:"music_fragment",label:st(t,"music_fragment")},{value:"source",label:st(t,"source")},{value:"quote",label:st(t,"quote")},{value:"computed",label:st(t,"computed")}],Wn=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Xa={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},Yn={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code","notes"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","notes","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Xa]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","notes","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Xa]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name","notes"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid","notes"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country","notes"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address","notes"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number","notes"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind","notes"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId","notes"]},filterFields:[Xa,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city","notes"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer","notes"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text","notes"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator","notes"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},quote:{infoType:"quote",entityKind:"single",structure:{payloadFields:["title","text","notes"],connections:[{relationType:"quote-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"quote",kind:"text",path:"text",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition","notes"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},js={infoType:"default",entityKind:"single",structure:{payloadFields:["label","notes"]},filterFields:[]};function Xn(t){return t?Yn[t]??js:js}function Gn(t,s){return t.optionsSource==="languages"?s.languages.map(n=>({value:n.infoId,label:n.label})):t.optionsSource==="sourceKinds"?Wn:[]}const Ga=60,Jn=500;function Ws(t){return`cogita.info-selection:${t}`}function ws(t){if(typeof window>"u")return{};const s=window.localStorage.getItem(Ws(t));if(!s)return{};try{const n=JSON.parse(s);return!n||typeof n!="object"?{}:n}catch{return{}}}function Zn({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,libraryId:d,mode:N}){var qe;const l=$s(),r=t.cogita.library.list,[Y,ie]=a.useState("any"),[W,U]=a.useState(""),[v,m]=a.useState("relevance"),[te,_]=a.useState("details"),[h,z]=a.useState(!1),[I,G]=a.useState("idle"),[k,P]=a.useState([]),[Z,ne]=a.useState(Ga),[ce,Ie]=a.useState(null),[de,S]=a.useState(()=>ws(d)),[ge,x]=a.useState({}),[V,ue]=a.useState([]),B=a.useMemo(()=>Qs(t),[t]),H=a.useMemo(()=>[{value:"relevance",label:r.sortRelevance},{value:"label_asc",label:r.sortLabelAsc},{value:"label_desc",label:r.sortLabelDesc},{value:"type_asc",label:r.sortTypeAsc},{value:"type_desc",label:r.sortTypeDesc}],[r.sortLabelAsc,r.sortLabelDesc,r.sortRelevance,r.sortTypeAsc,r.sortTypeDesc]);a.useEffect(()=>{S(ws(d)),x({}),z(!1)},[d]),a.useEffect(()=>{bs({libraryId:d,type:"language",filters:{sourceKind:"info"},limit:200}).then(K=>{const le=K.map(L=>({infoId:L.infoId??"",infoType:L.entityType,label:L.title})).filter(L=>L.infoId.length>0);ue(le)}).catch(()=>ue([]))},[d]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(Ws(d),JSON.stringify(de))},[d,de]);const Ne=a.useMemo(()=>Xn(Y==="any"?null:Y),[Y]),Se=a.useMemo(()=>({language:r.typeFilterLanguage,languageA:r.typeFilterLanguageA,languageB:r.typeFilterLanguageB,originalLanguage:r.typeFilterOriginalLanguage,doi:r.typeFilterDoi,sourceKind:r.typeFilterSourceKind,locator:r.typeFilterLocator,quote:r.typeFilterQuote}),[r.typeFilterDoi,r.typeFilterLanguage,r.typeFilterLanguageA,r.typeFilterLanguageB,r.typeFilterLocator,r.typeFilterOriginalLanguage,r.typeFilterQuote,r.typeFilterSourceKind]),je=a.useMemo(()=>Ne.filterFields.map(K=>({...K,label:K.labelKey?Se[K.labelKey]:K.label??K.key,options:Gn(K,{languages:V})})),[Se,V,Ne.filterFields]),Re=a.useMemo(()=>je.some(K=>(ge[K.key]??"").trim().length>0),[je,ge]);a.useEffect(()=>{x({})},[Y]),a.useEffect(()=>{const K={sourceKind:"info"};if(Re)for(const L of je){const X=(ge[L.key]??"").trim();X&&(K[L.path??L.key]=X)}G("loading");const le=window.setTimeout(()=>{bs({libraryId:d,type:Y==="any"?void 0:Y,query:W.trim()||void 0,filters:K,limit:Jn}).then(L=>{const X=L.map(ve=>({infoId:ve.infoId??"",infoType:ve.entityType,label:ve.title})).filter(ve=>ve.infoId.length>0);P(X),G("ready")}).catch(()=>{P([]),G("ready")})},240);return()=>window.clearTimeout(le)},[Re,d,W,Y,je,ge]);const ye=a.useMemo(()=>{const K=k.slice(),le=L=>st(t,L);return v==="relevance"?K:v==="label_asc"?K.sort((L,X)=>L.label.localeCompare(X.label)):v==="label_desc"?K.sort((L,X)=>X.label.localeCompare(L.label)):v==="type_asc"?K.sort((L,X)=>L.infoType===X.infoType?L.label.localeCompare(X.label):le(L.infoType).localeCompare(le(X.infoType))):K.sort((L,X)=>L.infoType===X.infoType?L.label.localeCompare(X.label):le(X.infoType).localeCompare(le(L.infoType)))},[t,k,v]),Ke=a.useMemo(()=>ye.slice(0,Z),[ye,Z]),_e=Ke.length<ye.length,we=a.useMemo(()=>new Set(Object.keys(de)),[de]),Be=a.useMemo(()=>Object.values(de),[de]),et=a.useMemo(()=>{const K=new Map;for(const le of Be)K.set(le.infoType,(K.get(le.infoType)??0)+1);return Array.from(K.entries()).sort((le,L)=>L[1]-le[1]||le[0].localeCompare(L[0]))},[Be]);a.useEffect(()=>{ne(Ga);const K=new Set(k.map(le=>le.infoId));Ie(le=>le&&K.has(le)?le:null)},[k]);const We=K=>{S(le=>({...le,[K.infoId]:{infoId:K.infoId,infoType:K.infoType,label:K.label}}))},q=K=>{S(le=>{if(!le[K])return le;const L={...le};return delete L[K],L})},Q=(K,le)=>{if(le){We(K);return}q(K.infoId)},De=K=>{l(`/cogita/library/${d}/list?infoId=${encodeURIComponent(K)}&infoView=overview`,{replace:!0})},xe=Be.length===1?((qe=Be[0])==null?void 0:qe.infoId)??null:null,re=r.selectionCount.replace("{count}",String(Be.length)),$e=N==="collection"?"grid":N==="detail"?"wide":te;return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":$e,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":r.typeLabel,value:Y,onChange:K=>ie(K.target.value),children:B.map(K=>e.jsx("option",{value:K.value,children:K.label},K.value))}),e.jsx("input",{type:"text",value:W,onChange:K=>U(K.target.value),placeholder:r.searchPlaceholder}),e.jsx("select",{"aria-label":r.sortLabel,value:v,onChange:K=>m(K.target.value),children:H.map(K=>e.jsx("option",{value:K.value,children:K.label},K.value))}),e.jsxs("select",{"aria-label":r.viewLabel,value:te,onChange:K=>_(K.target.value),children:[e.jsx("option",{value:"details",children:r.viewDetails}),e.jsx("option",{value:"wide",children:r.viewWide}),e.jsx("option",{value:"grid",children:r.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:r.cardCount.replace("{shown}",String(Ke.length)).replace("{total}",String(ye.length))}),e.jsx("span",{children:I==="loading"?r.loading:r.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>z(K=>!K),children:h?r.hideFilters:r.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:r.filtersOptionalHint})]}),h&&je.length>0?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsx("div",{className:"cogita-filter-grid",children:je.map(K=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:K.label}),K.kind==="select"?e.jsxs("select",{value:ge[K.key]??"",onChange:le=>x(L=>({...L,[K.key]:le.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(K.options??[]).map(le=>e.jsx("option",{value:le.value,children:le.label},`${K.key}:${le.value}`))]}):e.jsx("input",{type:"text",value:ge[K.key]??"",onChange:le=>x(L=>({...L,[K.key]:le.target.value}))})]},`type-filter:${K.key}`))})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:re}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{S(K=>{const le={...K};for(const L of Ke)le[L.infoId]={infoId:L.infoId,infoType:L.infoType,label:L.label};return le})},disabled:Ke.length===0,children:r.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>S({}),disabled:Be.length===0,children:r.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>xe&&De(xe),disabled:!xe,title:xe?void 0:r.openSelectedDisabled,children:r.openSelected})]})]}),Be.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:r.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:r.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:et.map(([K,le])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:st(t,K)}),e.jsx("span",{className:"cogita-tag-count",children:le})]},`stack:type:${K}`))})]}):null,$e==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":r.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:r.detailColumnName}),e.jsx("span",{children:r.detailColumnType}),e.jsx("span",{children:r.detailColumnId}),e.jsx("span",{})]}),Ke.length?Ke.map(K=>{const le=st(t,K.infoType),L=we.has(K.infoId),X=ce===K.infoId;return e.jsxs("div",{className:`cogita-details-row ${X||L?"active":""}`,role:"row",onClick:()=>Ie(K.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:L,onChange:ve=>Q(K,ve.target.checked),onClick:ve=>ve.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:K.label,children:K.label}),e.jsx("span",{title:le,children:le}),e.jsx("span",{title:K.infoId,children:K.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:ve=>{ve.stopPropagation(),De(K.infoId)},"aria-label":r.editInfo,children:">"})]},K.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:r.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${$e}`,"data-view":$e,children:Ke.length?Ke.map(K=>{const le=st(t,K.infoType),L=we.has(K.infoId),X=ce===K.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":X||L,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:L,onChange:ve=>Q(K,ve.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>Ie(K.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:le}),e.jsx("h3",{className:"cogita-card-title",children:K.label}),e.jsx("p",{className:"cogita-card-subtitle",children:K.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>De(K.infoId),children:r.editInfo})]})},K.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:r.noMatch})})}),_e?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>ne(K=>K+Ga),children:r.loadMore})}):null]})})})})})}const ea=5,Ns=50,ks=2,Ts=[];function ta({libraryId:t,infoType:s,label:n,placeholder:o,value:c,onChange:g,values:b,onChangeMultiple:y,helperText:E,searchFailedText:w,createFailedText:d,createLabel:N,savingLabel:l,loadMoreLabel:r,inputRef:Y,autoAdvance:ie,onCommit:W,multiple:U}){const v=U?b??Ts:Ts,[m,te]=a.useState(U?"":(c==null?void 0:c.label)??""),[_,h]=a.useState([]),[z,I]=a.useState(ea),[G,k]=a.useState(-1),[P,Z]=a.useState(!1),[ne,ce]=a.useState(!1),[Ie,de]=a.useState(null),S=a.useRef(0),ge=a.useRef(new Map),x=a.useMemo(()=>U?m.trim().length>0:m.trim().length>0&&!c,[m,c,U]);a.useEffect(()=>{U||te((c==null?void 0:c.label)??"")},[c,U]),a.useEffect(()=>{const B=m.trim();if(!B||B.length<ks){h([]),Z(!1),I(ea),k(-1),ce(!1),de(null);return}const H=B.toLowerCase(),Ne=`${t}:${s}:${H}`,Se=ge.current.get(Ne);if(Se){if(U&&v.length>0){const Re=new Set(v.map(ye=>ye.id));h(Se.filter(ye=>!Re.has(ye.id)))}else h(Se);I(ea),k(-1),Z(Se.length>0),ce(!1),de(null);return}const je=window.setTimeout(async()=>{const Re=Date.now();S.current=Re,ce(!0),de(null);try{const ye=await us({libraryId:t,type:s,query:B,limit:Ns});if(S.current!==Re)return;const Ke=ye.slice(0,Ns).map(_e=>({id:_e.infoId,label:_e.label,infoType:_e.infoType}));if(ge.current.set(Ne,Ke),U&&v.length>0){const _e=new Set(v.map(we=>we.id));h(Ke.filter(we=>!_e.has(we.id)))}else h(Ke);I(ea),k(-1),Z(!0)}catch{if(S.current!==Re)return;de(w??"Search failed.")}finally{S.current===Re&&ce(!1)}},250);return()=>window.clearTimeout(je)},[t,s,m,v]);const V=B=>{if(U){const H=v.some(Ne=>Ne.id===B.id)?v:[...v,B];y==null||y(H),te(""),Z(!1),k(-1);return}g==null||g(B),te(B.label),Z(!1),k(-1),ie&&(W==null||W())},ue=async()=>{const B=m.trim();if(B){ce(!0),de(null);try{const H=await Os({libraryId:t,infoType:s,payload:{label:B}}),Ne={id:H.infoId,label:B,infoType:H.infoType};if(B.length>=ks){const Se=`${t}:${s}:${B.toLowerCase()}`,je=ge.current.get(Se)??[];ge.current.set(Se,[Ne,...je])}if(U){y==null||y([...v,Ne]),te(""),Z(!1),k(-1);return}g==null||g(Ne),Z(!1),k(-1),ie&&(W==null||W())}catch{de(d??"Create failed.")}finally{ce(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:n}),e.jsx("input",{value:m,placeholder:o,onChange:B=>{te(B.target.value),!U&&c&&(g==null||g(null))},onKeyDown:B=>{if(B.key==="ArrowDown"){if(B.preventDefault(),!_.length)return;Z(!0),k(H=>{const Ne=Math.min(_.length,z)-1,Se=H<0?0:Math.min(H+1,Ne);return Se===Ne&&_.length>z?(I(je=>Math.min(je+ea,_.length)),Math.min(H+1,Math.min(_.length,z+ea)-1)):Se});return}if(B.key==="ArrowUp"){if(B.preventDefault(),!_.length)return;Z(!0),k(H=>H<=0?0:H-1);return}if(B.key==="Enter"){if(B.preventDefault(),G>=0&&_[G]){V(_[G]);return}if(x){ue();return}}},onFocus:()=>{_.length>0&&Z(!0)},autoComplete:"off",ref:Y})]}),U&&v.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:v.map(B=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>y==null?void 0:y(v.filter(H=>H.id!==B.id)),children:[B.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},B.id))}),E&&e.jsx("p",{className:"cogita-help",children:E}),Ie&&e.jsx("p",{className:"cogita-error",children:Ie}),P&&_.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[_.slice(0,z).map((B,H)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":H===G,onClick:()=>V(B),children:[e.jsx("strong",{children:B.label}),e.jsx("span",{children:B.infoType})]},B.id)),z<_.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>I(B=>Math.min(B+ea,_.length)),children:r??"Load more"})]}),x&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:ue,disabled:ne,children:ne?l??"Saving...":N??`Create new ${s}`})]})}function ei(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function Ss(t,s){if(!t||typeof t!="object")return s;const n=t,o=[n.label,n.name,n.title,n.text,n.orcid,n.email,n.number];for(const c of o)if(typeof c=="string"&&c.trim())return c.trim();return s}function ti({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,libraryId:d,editInfoId:N}){const{libraryName:l}=Dt(d),r=!!N,Y=a.useMemo(()=>Qs(t).filter(x=>x.value!=="any"),[t]),[ie,W]=a.useState([]),[U,v]=a.useState("word"),[m,te]=a.useState({}),[_,h]=a.useState({}),[z,I]=a.useState({}),[G,k]=a.useState({}),[P,Z]=a.useState(null),[ne,ce]=a.useState("idle"),Ie=a.useMemo(()=>ie.find(x=>x.infoType===U),[U,ie]);a.useEffect(()=>{let x=!1;return un({libraryId:d}).then(V=>{var ue;if(!x&&(W(V),!r)){const B=(ue=V[0])==null?void 0:ue.infoType;B&&v(B)}}).catch(()=>{x||W([])}),()=>{x=!0}},[r,d]),a.useEffect(()=>{if(!Ie)return;const x={},V={},ue={},B={};for(const H of Ie.payloadFields)x[H.key]="";for(const H of Ie.linkFields)H.multiple?ue[H.key]=[]:V[H.key]=null,H.targetTypes.length>0&&(B[H.key]=H.targetTypes[0]);te(x),h(V),I(ue),k(B)},[Ie==null?void 0:Ie.infoType]),a.useEffect(()=>{if(!r||!N||ie.length===0)return;let x=!1;return ce("loading"),Z(null),(async()=>{const ue=await ua({libraryId:d,infoId:N});if(x)return;const B=ue.infoType;v(B);const H=ie.find(we=>we.infoType===B);if(!H){ce("idle");return}const Ne=ue.payload??{},Se={};for(const we of H.payloadFields)Se[we.key]=ei(Ne[we.key]);te(Se);const je=ue.links??{}??{},Re={},ye={},Ke={},_e=[];for(const we of H.linkFields){we.targetTypes.length>0&&(Ke[we.key]=we.targetTypes[0]);const Be=je[we.key];if(we.multiple){const et=Array.isArray(Be)?Be.filter(We=>typeof We=="string"):[];ye[we.key]=[];for(const We of et)_e.push(ua({libraryId:d,infoId:We}).then(q=>{if(x)return;const Q={id:We,infoType:q.infoType,label:Ss(q.payload,We)};ye[we.key]=[...ye[we.key],Q]}).catch(()=>{}))}else{const et=typeof Be=="string"?Be:null;Re[we.key]=null,et&&_e.push(ua({libraryId:d,infoId:et}).then(We=>{x||(Re[we.key]={id:et,infoType:We.infoType,label:Ss(We.payload,et)})}).catch(()=>{}))}}await Promise.all(_e),!x&&(h(Re),I(ye),k(we=>({...we,...Ke})),ce("idle"))})().catch(()=>{x||(Z("Failed to load info details."),ce("idle"))}),()=>{x=!0}},[N,r,d,ie]);const de=async()=>{var ue;if(!Ie)return;const x={};for(const B of Ie.payloadFields){const H=(m[B.key]??"").trim();if(!H){if(B.required){Z(`Field '${B.label}' is required.`);return}continue}if(B.inputType==="json")try{x[B.key]=JSON.parse(H)}catch{Z(`Field '${B.label}' must be valid JSON.`);return}else x[B.key]=H}const V={};for(const B of Ie.linkFields)if(B.multiple){const H=(z[B.key]??[]).map(Ne=>Ne.id);if(B.required&&H.length===0){Z(`Link '${B.label}' is required.`);return}V[B.key]=H}else{const H=((ue=_[B.key])==null?void 0:ue.id)??null;if(B.required&&!H){Z(`Link '${B.label}' is required.`);return}V[B.key]=H}ce("saving"),Z(null);try{if(r&&N)await hn({libraryId:d,infoId:N,payload:x,links:V}),Z("Info updated.");else{await Os({libraryId:d,infoType:U,payload:x,links:V}),Z("Info saved.");const B={};for(const Se of Ie.payloadFields)B[Se.key]="";te(B);const H={},Ne={};for(const Se of Ie.linkFields)Se.multiple?Ne[Se.key]=[]:H[Se.key]=null;h(Se=>({...Se,...H})),I(Se=>({...Se,...Ne}))}}catch{Z("Failed to save info.")}finally{ce("idle")}},S=x=>{const V=m[x.key]??"",ue=x.inputType==="textarea"||x.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:x.label}),ue?e.jsx("textarea",{rows:x.inputType==="json"?8:4,value:V,onChange:B=>te(H=>({...H,[x.key]:B.target.value})),placeholder:x.key}):e.jsx("input",{type:"text",value:V,onChange:B=>te(H=>({...H,[x.key]:B.target.value})),placeholder:x.key})]},`payload:${x.key}`)},ge=x=>{const V=G[x.key]??x.targetTypes[0];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:x.label}),x.targetTypes.length>1?e.jsx("select",{value:V,onChange:ue=>k(B=>({...B,[x.key]:ue.target.value})),children:x.targetTypes.map(ue=>e.jsx("option",{value:ue,children:st(t,ue)},`${x.key}:${ue}`))}):null,x.multiple?e.jsx(ta,{libraryId:d,infoType:V,label:x.label,placeholder:x.key,multiple:!0,values:z[x.key]??[],onChangeMultiple:ue=>I(B=>({...B,[x.key]:ue})),searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(ta,{libraryId:d,infoType:V,label:x.label,placeholder:x.key,value:_[x.key]??null,onChange:ue=>h(B=>({...B,[x.key]:ue})),searchFailedText:"Search failed",createFailedText:"Create failed"})]},`link:${x.key}`)};return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:r?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${d}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[r?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:U,onChange:x=>v(x.target.value),children:Y.map(x=>e.jsx("option",{value:x.value,children:x.label},x.value))})]}),ne==="loading"?e.jsx("p",{children:"Loading..."}):null,Ie?e.jsxs("div",{className:"cogita-form-grid",children:[Ie.payloadFields.map(S),Ie.linkFields.map(ge)]}):e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:de,disabled:ne==="saving"||!Ie,children:ne==="saving"?"Saving...":r?"Update info":"Create info"})}),P?e.jsx("p",{className:"cogita-library-subtitle",children:P}):null]})})})]})})}const Cs=t=>/\s/.test(t),Ra=t=>/[\p{L}\p{N}]/u.test(t),Ms=(t,s)=>{const n=s>0?t[s-1]:"",o=s<t.length?t[s]:"";if(!n||!o)return 0;const c=Cs(n),g=Cs(o);if(c||g)return 3;const b=Ra(n),y=Ra(o);return b!==y?2:!b&&!y?1:0},Ja=(t,s,n,o,c)=>{const g=Math.max(o-s,n-o);for(let b=0;b<=g;b+=1){const y=o-b;if(y>=s&&y<=n&&Ms(t,y)>=c)return y;const E=o+b;if(E>=s&&E<=n&&Ms(t,E)>=c)return E}return null},Za=(t,s)=>{const n=s>0?t[s-1]:"",o=s<t.length?t[s]:"";return!n||!o?!0:Ra(n)!==Ra(o)},ai=(t,s,n,o)=>{const c=n-s,g=s+o,b=n-o;if(c<=o*2||b<=g)return null;const y=Math.floor((s+n)/2),E=Ja(t,g,b,y,3);if(E!==null&&Za(t,E))return E;const w=Ja(t,g,b,y,2);if(w!==null&&Za(t,w))return w;const d=Ja(t,g,b,y,1);return d!==null&&Za(t,d)?d:null},ma=(t,s)=>{const n=Math.max(1,7),o=Math.max(n,13),c={},g=(E,w,d,N,l)=>{const r=String(N),Y={id:r,start:E,end:w,text:t.slice(E,w),depth:d,index:N,parentId:l};if(c[r]=Y,w-E>o){let W=ai(t,E,w,n);if(W!==null&&W>E&&W<w){const U=g(E,W,d+1,N*2+1,r),v=g(W,w,d+1,N*2+2,r);Y.leftId=U.id,Y.rightId=v.id}}return Y},b=g(0,t.length,0,0),y=Object.values(c).sort((E,w)=>w.depth-E.depth||E.start-w.start).map(E=>E.id);return{text:t,rootId:b.id,nodes:c,order:y}},ha=(t,s,n,o,c,g,b)=>{const y=g==="reverse"?t.order.slice().sort((E,w)=>t.nodes[w].start-t.nodes[E].start||t.nodes[w].depth-t.nodes[E].depth):t.order;for(const E of y){if(b&&E===b||s.has(E))continue;const w=t.nodes[E];if(w){if(c&&(w.leftId||w.rightId)){const d=w.leftId?n[w.leftId]??0:o,N=w.rightId?n[w.rightId]??0:o;if((d+N)/2<o)continue}return w}}return null},Ys=(t,s)=>({before:t.slice(0,s.start),fragment:t.slice(s.start,s.end),after:t.slice(s.end)});function si({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,libraryId:d}){const N=`/#/cogita/library/${d}`,[l,r,Y]=Rs([]),[ie,W,U]=Es([]),[v,m]=a.useState(null),[te,_]=a.useState(null),[h,z]=a.useState(null),[I,G]=a.useState(null),k=a.useMemo(()=>l.find(S=>S.id===v)??null,[l,v]);a.useEffect(()=>{let S=!0;return gn({libraryId:d}).then(ge=>{if(!S)return;const x=ge.nodes.map(V=>{var ue,B,H;return{id:V.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:V.payload&&typeof V.payload=="object"&&"label"in V.payload?String(V.payload.label):"Item",nodeType:V.nodeType,itemType:((ue=V.payload)==null?void 0:ue.itemType)??"info",itemId:((B=V.payload)==null?void 0:B.itemId)??null,infoType:((H=V.payload)==null?void 0:H.infoType)??null}}});r(x),W(ge.edges.map(V=>({id:V.edgeId,source:V.fromNodeId,target:V.toNodeId})))}).catch(()=>{S&&(r([]),W([]))}),()=>{S=!1}},[d]),a.useEffect(()=>{mn({libraryId:d}).then(_).catch(()=>_(null))},[d,l,ie]);const P=a.useCallback(S=>{W(ge=>As(S,ge))},[]),Z=()=>{const S=crypto.randomUUID();r(ge=>[...ge,{id:S,type:"default",position:{x:140+ge.length*40,y:120+ge.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},ne=()=>{const S=crypto.randomUUID();r(ge=>[...ge,{id:S,type:"default",position:{x:180+ge.length*40,y:160+ge.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},ce=async()=>{z(null);try{const S=l.map(x=>({nodeId:x.id,nodeType:x.data.nodeType,payload:{itemType:x.data.itemType,itemId:x.data.itemId??null,label:x.data.label,infoType:x.data.infoType??null}})),ge=ie.map(x=>({edgeId:x.id,fromNodeId:x.source,toNodeId:x.target}));await fn({libraryId:d,nodes:S,edges:ge}),z(t.cogita.library.graph.saveSuccess)}catch{z(t.cogita.library.graph.saveFail)}},Ie=S=>{k&&r(ge=>ge.map(x=>x.id===k.id?{...x,data:{...x.data,itemId:(S==null?void 0:S.infoId)??null,itemType:"collection",infoType:"collection",label:(S==null?void 0:S.label)??t.cogita.library.infoTypes.collection}}:x))},de=S=>{k&&r(ge=>ge.map(x=>x.id===k.id?{...x,data:{...x.data,itemId:(S==null?void 0:S.infoId)??null,itemType:"info",infoType:(S==null?void 0:S.infoType)??null,label:(S==null?void 0:S.label)??t.cogita.library.infoTypes.any}}:x))};return a.useEffect(()=>{if(!k||k.data.nodeType!=="info"||k.data.infoType!=="quote"||!k.data.itemId){G(null);return}let S=!0;return ua({libraryId:d,infoId:k.data.itemId}).then(ge=>{if(!S)return;const x=ge.payload,V=(x==null?void 0:x.text)??"";if(!V){G(null);return}const ue=ma(V),B=Object.values(ue.nodes).sort((H,Ne)=>H.depth-Ne.depth||H.start-Ne.start).map(H=>({id:H.id,text:H.text,depth:H.depth}));G({title:(x==null?void 0:x.title)??k.data.label,fragments:B})}).catch(()=>G(null)),()=>{S=!1}},[d,k]),e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:N,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:ce,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Z,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ne,children:t.cogita.library.actions.addInfo}),te?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(te.totalCollections))})}):null,h?e.jsx("p",{className:"cogita-help",children:h}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(Fs,{nodes:l,edges:ie,onNodesChange:Y,onEdgesChange:U,onConnect:P,onNodeClick:(S,ge)=>m(ge.id),fitView:!0,children:[e.jsx(Ps,{gap:18,size:1}),e.jsx(_s,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),k?e.jsxs("div",{className:"cogita-graph-inspector",children:[k.data.nodeType==="collection"?e.jsx(ta,{libraryId:d,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:k.data.itemId?{id:k.data.itemId,label:k.data.label,infoType:"collection"}:null,onChange:Ie,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(ta,{libraryId:d,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:k.data.itemId?{id:k.data.itemId,label:k.data.label,infoType:k.data.infoType??void 0}:null,onChange:de,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),I?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:I.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:I.fragments.map(S=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:S.id}),e.jsx("span",{children:S.text})]},S.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function ni({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,libraryId:d,collectionId:N}){const{libraryName:l}=Dt(d),[r,Y]=a.useState([]),[ie,W]=a.useState("loading"),[U,v]=a.useState("idle"),m=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),te=`/#/cogita/library/${d}`,_=()=>{W("loading"),Us({libraryId:d}).then(I=>{Y(I),W("idle")}).catch(()=>{Y([]),W("error")})};a.useEffect(()=>{_()},[d]);const h=async I=>{try{await zs({libraryId:d,shareId:I}),_()}catch{_()}},z=async I=>{const G=`${m}/${I}`;try{await navigator.clipboard.writeText(G),v("copied")}catch{v("failed")}};return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:te,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${te}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[ie==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):ie==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):r.filter(I=>!N||I.collectionId===N).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:r.filter(I=>!N||I.collectionId===N).map(I=>e.jsxs("div",{className:"cogita-share-row","data-state":I.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:I.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(I.createdUtc).toLocaleString(),I.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),I.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${m}/${I.shareCode}`}):null]}),I.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[I.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>z(I.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>h(I.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},I.shareId))}),U==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):U==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function ii({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,libraryId:d}){const{libraryName:N}=Dt(d),[l,r]=a.useState(null),[Y,ie]=a.useState(null),[W,U]=a.useState(null),[v,m]=a.useState(null),[te,_]=a.useState(null),[h,z]=a.useState(null),I=a.useRef(null),G=Z=>{if(!Number.isFinite(Z))return"0 B";if(Z<1024)return`${Z} B`;const ne=Z/1024;if(ne<1024)return`${ne.toFixed(1)} KB`;const ce=ne/1024;return ce<1024?`${ce.toFixed(1)} MB`:`${(ce/1024).toFixed(1)} GB`},k=async()=>{r(null),_({loadedBytes:0,totalBytes:null,percent:null});try{r(t.cogita.library.overview.exporting);const Z=await pn(d,_),ne=URL.createObjectURL(Z),ce=document.createElement("a");ce.href=ne,ce.download=`cogita-library-${N||d}.json`,ce.click(),URL.revokeObjectURL(ne),r(t.cogita.library.overview.exportReady)}catch{r(t.cogita.library.overview.exportFail)}finally{_(Z=>Z??{loadedBytes:0,totalBytes:null,percent:null})}},P=async Z=>{var ce;ie(null),U(null),m(null);const ne=(ce=Z.target.files)==null?void 0:ce[0];if(ne)try{ie(t.cogita.library.overview.importing),z({loadedBytes:0,totalBytes:ne.size,percent:0});const Ie=await bn(d,ne,z,de=>{const S=de.stage==="infos"?t.cogita.library.overview.importStageInfos:de.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;m(t.cogita.library.overview.importLiveProgress.replace("{stage}",S).replace("{done}",String(de.processed)).replace("{total}",String(de.total)).replace("{infos}",String(de.infos)).replace("{connections}",String(de.connections)).replace("{collections}",String(de.collections)))});U({infos:Ie.infosImported,connections:Ie.connectionsImported,collections:Ie.collectionsImported}),ie(t.cogita.library.overview.importDone)}catch(Ie){const de=Ie instanceof yn&&Ie.message?` ${Ie.message}`:"";ie(`${t.cogita.library.overview.importFail}${de}`)}finally{I.current&&(I.current.value="")}};return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:N}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:k,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:I,type:"file",accept:"application/json",onChange:P})]})]}),te?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:te.percent??void 0,max:te.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",G(te.loadedBytes)).replace("{total}",te.totalBytes?G(te.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,h?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:h.percent??void 0,max:h.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",G(h.loadedBytes)).replace("{total}",h.totalBytes?G(h.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,l?e.jsx("p",{className:"cogita-help",children:l}):null,Y?e.jsx("p",{className:"cogita-help",children:Y}):null,v?e.jsx("p",{className:"cogita-help",children:v}):null,W?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(W.infos)).replace("{connections}",String(W.connections)).replace("{collections}",String(W.collections))}):null]})]})})})]})})}function ri({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,libraryId:d}){const{libraryName:N}=Dt(d),[l,r]=a.useState(""),[Y,ie]=a.useState([]),W=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:N}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:U=>r(U.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const U=l.trim();U&&(ie(v=>[{id:W(),name:U},...v]),r(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[Y.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,Y.map(U=>e.jsx("button",{type:"button",className:"ghost",children:U.name},U.id))]})]})]})})})]})})}function oi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,libraryId:d}){const{libraryName:N}=Dt(d),[l,r]=a.useState(""),[Y,ie]=a.useState([]),W=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:N}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:U=>r(U.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const U=l.trim();U&&(ie(v=>[{id:W(),name:U},...v]),r(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[Y.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,Y.map(U=>e.jsx("button",{type:"button",className:"ghost",children:U.name},U.id))]})]})]})})})]})})}function Is({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,libraryId:d}){const{libraryName:N}=Dt(d),l=`/#/cogita/library/${d}`,[r,Y]=a.useState(""),[ie,W]=a.useState([]),[U,v]=a.useState("idle"),[m,te]=a.useState(0),[_,h]=a.useState(null);a.useEffect(()=>{v("loading");const I=window.setTimeout(()=>{va({libraryId:d,query:r.trim()||void 0,limit:30}).then(G=>{W(G.items),te(G.total),h(G.nextCursor??null),v("ready")}).catch(()=>{W([]),te(0),h(null),v("ready")})},240);return()=>window.clearTimeout(I)},[d,r]);const z=async()=>{if(_){v("loading");try{const I=await va({libraryId:d,query:r.trim()||void 0,limit:30,cursor:_});W(G=>[...G,...I.items]),h(I.nextCursor??null),te(I.total),v("ready")}catch{v("ready")}}};return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:N}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${l}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:r,onChange:I=>Y(I.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(ie.length)).replace("{total}",String(m||ie.length))}),e.jsx("span",{children:U==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:ie.length?ie.map(I=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${l}/collections/${I.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:I.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(I.itemCount))," ·"," ",I.notes||t.cogita.library.collections.noNotes]})]})},I.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${l}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),_?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:z,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const se=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,_t=(t,s,n,o)=>`${t}:${s}:${n??""}:${o??""}`;function li({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,libraryId:d,collectionId:N}){Dt(d);const l=`/#/cogita/library/${d}`,[r,Y]=a.useState(t.cogita.library.collections.defaultName),[ie,W]=a.useState(null),[U,v]=a.useState(0),[m,te]=a.useState([]),[_,h]=a.useState("idle"),[z,I]=a.useState(null),G=a.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(m.length)).replace("{total}",String(U||m.length)),[t,m.length,U]);a.useEffect(()=>{qa(d,N).then(P=>{Y(P.name),W(P.notes??null),v(P.itemCount)}).catch(()=>{Y(t.cogita.library.collections.defaultName),W(null)})},[d,N]),a.useEffect(()=>{h("loading"),$a({libraryId:d,collectionId:N,limit:40}).then(P=>{te(P.items),I(P.nextCursor??null),v(P.total),h("ready")}).catch(()=>{te([]),I(null),h("ready")})},[d,N]);const k=async()=>{if(z){h("loading");try{const P=await $a({libraryId:d,collectionId:N,limit:40,cursor:z});te(Z=>[...Z,...P.items]),I(P.nextCursor??null),v(P.total),h("ready")}catch{h("ready")}}};return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:r}),e.jsx("p",{className:"cogita-library-subtitle",children:ie||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${l}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${l}/collections/${N}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${l}/collections/${N}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:G}),e.jsx("span",{children:_==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:m.length?m.map(P=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:P.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:P.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:P.label}),e.jsx("p",{className:"cogita-card-subtitle",children:P.description})]})},se(P))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),z?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:k,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${l}/collections/${N}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const Bt=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const s=t.length,n=t.filter(g=>g.correct).length,o=Da(hs(t));return{score:Math.round(Math.max(0,Math.min(100,o.knowness*100))*100)/100,total:s,correct:n,lastReviewedUtc:o.lastReviewedUtc??null}},ci=t=>{if(t.maskBase64)try{const s=xn(t.maskBase64);if(!s.length)return t.correct?1:0;const n=s.reduce((o,c)=>o+c,0);return Math.max(0,Math.min(1,n/s.length/255))}catch{return t.correct?1:0}return t.correct?1:0},hs=t=>t.map(s=>({correctness:ci(s),createdUtc:s.createdUtc})),Da=(t,s=Date.now())=>{var U;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const o=t.slice().sort((v,m)=>v.createdUtc.localeCompare(m.createdUtc)).slice(-5),c=o.reduce((v,m)=>v+m.correctness,0)/o.length,g=5,b=2,y=.15;let E=0,w=0;for(let v=0;v<o.length;v+=1){const m=new Date(o[v].createdUtc).getTime(),te=v===o.length-1?s:new Date(o[v+1].createdUtc).getTime(),_=Math.max(0,(te-m)/(1e3*60)),h=1-Math.exp(-_/g);E+=h,o[v].correctness>.5&&(w+=y)}let d=c*E*b+w;const N=((U=o[o.length-1])==null?void 0:U.createdUtc)??null,l=N?Math.max(0,(s-new Date(N).getTime())/(1e3*60)):0,Y=1/(1+Math.log1p(l/60));return d*=Y,o.length===1&&o[0].correctness>.5&&(d+=5.44*Math.exp(-l/2)),{knowness:d,avgCorrectness:c,lastReviewedUtc:N}},ja=t=>{const s=t.slice();for(let n=s.length-1;n>0;n-=1){const o=Math.floor(Math.random()*(n+1));[s[n],s[o]]=[s[o],s[n]]}return s},La=t=>t[Math.floor(Math.random()*t.length)],di=(t,s)=>{const n=new Map;return t.forEach(o=>n.set(o,Math.random())),t.sort((o,c)=>{const g=s(o)-s(c);return g!==0?g:(n.get(o)??0)-(n.get(c)??0)})},Va=(t,s,n,o,c)=>{if(!t.length)return null;const g=t.filter(y=>!(c!=null&&c.has(se(y))));if(g.length===0)return null;const b=g.filter(y=>se(y)!==n);return La(b.length?b:g)},ui=(t,s,n,o,c)=>{if(!t.length)return null;let g=Number.POSITIVE_INFINITY;for(const w of t){const d=se(w);if(n.has(d))continue;const N=s[d]??1;N<g&&(g=N)}if(!Number.isFinite(g))return null;const b=t.filter(w=>{const d=se(w);return!n.has(d)&&(s[d]??1)===g}),y=b.filter(w=>!c||se(w)!==c),E=o?y.filter(w=>!o.has(se(w))):y;return E.length>0?La(E):y.length>0?La(y):c&&b.some(w=>se(w)===c)?b.find(w=>se(w)===c)??null:b.length?La(b):null},Xs=(t,s,n,o,c)=>{const g=[],b=t.filter(E=>!c.has(se(E))&&!n.has(se(E))&&(s[se(E)]??0)<1),y=di(b,E=>s[se(E)]??0);for(const E of y){if(g.length>=o)break;g.push(E),c.add(se(E))}if(g.length<o){const E=ja(t.filter(w=>!c.has(se(w))&&n.has(se(w))));for(const w of E){if(g.length>=o)break;g.push(w),c.add(se(w))}}return g},hi=(t,s,n,o)=>Xs(t,s,n,o,new Set),gs=(t,s,n,o,c,g)=>{const b=Math.max(1,n.stackSize??s),E=ja(t).filter((Y,ie,W)=>W.findIndex(U=>se(U)===se(Y))===ie),w=hi(E,o,c,b),d=new Set,N=new Set,l=Va(w,{},null,d,N),r=l?[l]:[];return l&&N.add(se(l)),{queue:r,meta:{pool:E,active:w,knownessMap:o,unknownSet:c,outcomesById:g,asked:d,queued:N}}},ls={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,s)=>{const o=ja(t).filter((c,g,b)=>b.findIndex(y=>se(y)===se(c))===g);return{queue:o.slice(0,Math.min(s,o.length)),meta:{}}},applyOutcome:t=>t},ms=(t,s,n,o)=>{const c=Math.max(1,n.stackSize??s),b=ja(t).filter((ie,W,U)=>U.findIndex(v=>se(v)===se(ie))===W),y={},E=new Set,w=new Set,d=new Set,N=Math.max(1,n.levels??1);b.forEach(ie=>{const W=se(ie),U=o==null?void 0:o[W],v=typeof U=="number"&&Number.isFinite(U)?U:1;y[W]=Math.min(N,Math.max(1,Math.round(v)))});const l=[];if(b.length>0){const ie=new Map;b.forEach(U=>{var m;const v=y[se(U)]??1;ie.has(v)||ie.set(v,[]),(m=ie.get(v))==null||m.push(U)});const W=Array.from(ie.keys()).sort((U,v)=>U-v);for(const U of W){if(l.length>=c)break;const v=ja(ie.get(U)??[]);for(const m of v){if(l.length>=c)break;l.push(m)}}}const r=Va(l,y,null,E,w),Y=r?[r]:[];return r&&w.add(se(r)),{queue:Y,meta:{pool:b,active:l,levelMap:y,asked:E,queued:w,wrongSinceCorrect:d}}},gi={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,s)=>Math.max(1,s.stackSize??t),getProgressTotal:()=>null,prepare:(t,s,n)=>ms(t,s,n),applyOutcome:(t,s,n,o,c)=>{if(!s)return t;const g=Math.max(1,o.levels??1),b=t.meta.pool??[],y=t.meta.active??[],E={...t.meta.levelMap??{}},w=new Set(t.meta.asked??[]),d=new Set(t.meta.queued??[]),N=new Set(t.meta.wrongSinceCorrect??[]),l=se(s);d.delete(l),w.add(l);const r=E[l]??1;c.correct?(E[l]=N.has(l)?1:Math.min(r+1,g),N.delete(l)):(E[l]=1,N.add(l));const Y=c.correct?y.filter(U=>se(U)!==l):y.slice();if(c.correct&&Y.length<Math.max(1,o.stackSize??1)){const U=new Set(Y.map(m=>se(m))),v=ui(b,E,U,w,l);v&&Y.push(v)}const ie=t.queue.slice(),W=Va(Y,E,l,w,d);return W&&(ie.push(W),d.add(se(W))),{queue:ie,meta:{pool:b,active:Y,levelMap:E,asked:w,queued:d,wrongSinceCorrect:N}}}},mi={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,s)=>Math.max(1,s.stackSize??t),getProgressTotal:()=>null,prepare:(t,s,n)=>gs(t,s,n,{},new Set,{}),applyOutcome:(t,s,n,o,c)=>{if(!s)return t;const g=t.meta.pool??[],b=t.meta.active??[],y={...t.meta.knownessMap??{}},E=new Set(t.meta.unknownSet??[]),w={...t.meta.outcomesById??{}},d=new Set(t.meta.asked??[]),N=new Set(t.meta.queued??[]),l=se(s);N.delete(l),d.add(l);const r={correctness:Math.max(0,Math.min(1,c.correctness??(c.correct?1:0))),createdUtc:c.createdUtc??new Date().toISOString()},ie=(w[l]??[]).concat(r).sort((_,h)=>_.createdUtc.localeCompare(h.createdUtc)).slice(-5);w[l]=ie,E.delete(l);const W=Date.now();g.forEach(_=>{const h=se(_),z=w[h]??[];if(z.length===0){y[h]=0,E.add(h);return}const I=Da(z,W);y[h]=I.knowness});const U=b.slice();if((y[l]??0)>=1){const _=U.filter(h=>se(h)!==l);U.length=0,U.push(..._)}const m=Math.max(1,o.stackSize??n);if(U.length<m){const _=new Set(U.map(z=>se(z))),h=Xs(g,y,E,m-U.length,_);U.push(...h)}const te=t.queue.slice();if(te.length===0||se(te[te.length-1])===l){const _=Va(U,{},l,d,N);_&&(te.push(_),N.add(se(_)))}return{queue:te,meta:{pool:g,active:U,knownessMap:y,unknownSet:E,outcomesById:w,asked:d,queued:N}}}},Gs={random:ls,levels:gi,temporal:mi},fi=Object.values(Gs),fs=t=>{if(!t)return ls;const s=t.trim().toLowerCase();return s==="random"||s==="levels"||s==="temporal"?Gs[s]:ls},Oa=(t,s)=>{const n={...t.defaultSettings};return s&&Object.entries(s).forEach(([o,c])=>{typeof c=="number"&&Number.isFinite(c)&&(n[o]=c),typeof c=="string"&&(n[o]=c)}),t.settingsFields.forEach(o=>{var g;const c=n[o.key];if(o.type==="number"){if(typeof c!="number"||Number.isNaN(c)){n[o.key]=t.defaultSettings[o.key]??0;return}o.min!==void 0&&(n[o.key]=Math.max(o.min,n[o.key])),o.max!==void 0&&(n[o.key]=Math.min(o.max,n[o.key]));return}if(o.type==="select"){const b=((g=o.options)==null?void 0:g.map(y=>y.value))??[];(typeof c!="string"||b.length>0&&!b.includes(c))&&(n[o.key]=t.defaultSettings[o.key]??b[0]??"")}}),n},Js=(t,s)=>{const n={};return t.settingsFields.forEach(o=>{const c=s.get(o.key);if(c){if(o.type==="number"){const g=Number(c);Number.isNaN(g)||(n[o.key]=g);return}n[o.key]=c}}),Oa(t,n)},pi=(t,s)=>{const n=new URLSearchParams;return t.settingsFields.forEach(o=>{const c=s[o.key];(typeof c=="number"||typeof c=="string")&&n.set(o.key,String(c))}),n};function bi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,libraryId:d,collectionId:N,revisionId:l}){const{libraryName:r}=Dt(d),Y=`/#/cogita/library/${d}`,[ie,W]=a.useState(t.cogita.library.collections.defaultName),[U,v]=a.useState(""),[m,te]=a.useState(20),[_,h]=a.useState("random"),[z,I]=a.useState({}),[G,k]=a.useState("exact"),[P,Z]=a.useState([]),[ne,ce]=a.useState(null),[Ie,de]=a.useState([]),[S,ge]=a.useState("idle"),[x,V]=a.useState(null),[ue,B]=a.useState("idle"),[H,Ne]=a.useState("idle"),[Se,je]=a.useState("idle"),Re=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),ye=a.useMemo(()=>fs(_),[_]),Ke=a.useMemo(()=>Oa(ye,z),[ye,z]),_e=a.useMemo(()=>pi(ye,Ke).toString(),[ye,Ke]);a.useEffect(()=>{qa(d,N).then(Q=>W(Q.name)).catch(()=>W(t.cogita.library.collections.defaultName))},[d,N]),a.useEffect(()=>{l&&vn({libraryId:d,collectionId:N,revisionId:l}).then(Q=>{v(Q.name),h(Q.mode||"random"),k(Q.check||"exact"),te(Q.limit||20),I(Q.revisionSettings??{})}).catch(()=>{v("")})},[N,d,l]),a.useEffect(()=>{jn({libraryId:d}).then(Q=>{Z(Q),!ne&&Q.length>0&&ce(Q[0].roleId)}).catch(()=>{Z([])})},[d]);const we=()=>{Ne("loading"),Us({libraryId:d}).then(Q=>{de(Q),Ne("idle")}).catch(()=>{de([]),Ne("error")})};a.useEffect(()=>{we()},[d]);const Be=async()=>{ge("working"),B("idle");try{const Q=await Nn({libraryId:d,collectionId:N,revisionType:ye.id,revisionSettings:Ke,mode:_,check:G,limit:m});V(`${Re}/${Q.shareCode}${_e?`?${_e}`:""}`),ge("ready"),we()}catch{ge("error")}},et=async()=>{if(l){je("saving");try{await wn({libraryId:d,collectionId:N,revisionId:l,name:U||ie,revisionType:ye.id,revisionSettings:Ke,mode:_,check:G,limit:m}),je("saved")}catch{je("error")}}},We=async()=>{if(x)try{await navigator.clipboard.writeText(x),B("copied")}catch{B("failed")}},q=async Q=>{try{await zs({libraryId:d,shareId:Q}),we()}catch{we()}};return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:ie}),e.jsx("p",{className:"cogita-library-subtitle",children:r})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:Y,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${Y}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${Y}/collections/${N}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${Y}/collections/${N}/revision/run?mode=${encodeURIComponent(_)}&check=${encodeURIComponent(G)}&limit=${m}${_e?`&${_e}`:""}${ne?`&reviewer=${encodeURIComponent(ne)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:U,onChange:Q=>v(Q.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:_,onChange:Q=>h(Q.target.value),children:fi.map(Q=>e.jsx("option",{value:Q.id,children:t.cogita.library.revision[Q.labelKey]},Q.id))})]}),ye.settingsFields.map(Q=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[Q.labelKey]}),Q.type==="select"?e.jsx("select",{value:String(Ke[Q.key]??""),onChange:De=>I(xe=>({...xe,[Q.key]:De.target.value})),children:(Q.options??[]).map(De=>e.jsx("option",{value:De.value,children:t.cogita.library.revision[De.labelKey]},De.value))}):e.jsx("input",{type:"number",min:Q.min,max:Q.max,step:Q.step,value:Ke[Q.key]??0,onChange:De=>I(xe=>({...xe,[Q.key]:Number(De.target.value||0)}))})]},Q.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),ye.id!=="levels"&&ye.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:m,onChange:Q=>te(Number(Q.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:ne??"",onChange:Q=>ce(Q.target.value||null),children:P.map(Q=>e.jsx("option",{value:Q.roleId,children:Q.label},Q.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[l?e.jsx("button",{type:"button",className:"cta ghost",onClick:et,disabled:Se==="saving",children:Se==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${Y}/collections/${N}/revision/run?mode=${encodeURIComponent(_)}&check=${encodeURIComponent(G)}&limit=${m}${_e?`&${_e}`:""}${ne?`&reviewer=${encodeURIComponent(ne)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]}),Se==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),x?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:x,readOnly:!0})]}):null,S==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,ue==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):ue==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:Be,disabled:S==="working",children:S==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),x?e.jsx("button",{type:"button",className:"cta ghost",onClick:We,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),H==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):Ie.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:Ie.map(Q=>e.jsxs("div",{className:"cogita-share-row","data-state":Q.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:Q.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(Q.createdUtc).toLocaleString(),Q.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),Q.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>q(Q.shareId),children:t.cogita.library.revision.shareRevokeAction})]},Q.shareId))})]})]})]})]})})})]})})}const es=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function Zs(t,s,n){if(!t)return null;const o=new Map(t.nodes.map(_=>[_.id,_])),c=new Map,g=new Set,b=_=>{if(typeof _=="number")return _;if(typeof _=="string"){const h=Number(_);return Number.isFinite(h)?h:0}return 0},y=_=>{if(c.has(_))return c.get(_);if(g.has(_))return 0;const h=o.get(_);if(!h)return 0;g.add(_);const z=G=>{var P,Z;return(G?((P=h.inputsByHandle)==null?void 0:P[G])??[]:h.inputs??((Z=h.inputsByHandle)==null?void 0:Z.in)??[]).map(ne=>y(ne))};let I=0;switch(h.type){case"input.random":{const G=h.min??0,k=h.max??G+10,P=Math.min(G,k),Z=Math.max(G,k);I=Math.floor(Math.random()*(Z-P+1))+P;break}case"input.const":{I=h.value??0;break}case"input.list":{const G=(h.list??[]).filter(Boolean),k=Math.round(b(z("index")[0]));I=G.length?G[Math.max(0,Math.min(G.length-1,k))]:String(k);break}case"compute.add":{I=z("in").map(k=>b(k)).reduce((k,P)=>k+P,0);break}case"compute.sub":{const G=z("add").map(P=>b(P)),k=z("sub").map(P=>b(P));I=G.reduce((P,Z)=>P+Z,0)-k.reduce((P,Z)=>P+Z,0);break}case"compute.mul":{const G=z("in").map(k=>b(k));I=G.length?G.reduce((k,P)=>k*P,1):0;break}case"compute.div":{const G=b(z("num")[0]),k=z("den").map(P=>b(P)).reduce((P,Z)=>P+Z,0);I=Math.abs(k)<Number.EPSILON?0:G/k;break}case"compute.pow":{const G=b(z("base")[0]),k=b(z("exp")[0]);I=Math.pow(G,k);break}case"compute.exp":{const G=b(z("base")[0]),k=b(z("exp")[0]);I=Math.pow(G,k);break}case"compute.log":{const G=b(z("value")[0]),k=b(z("base")[0]),P=Math.max(G,Number.EPSILON);I=Math.abs(k)<Number.EPSILON?Math.log(P):Math.log(P)/Math.log(k);break}case"compute.abs":{I=Math.abs(b(z("in")[0]));break}case"compute.min":{const G=z("in").map(k=>b(k));I=G.length?Math.min(...G):0;break}case"compute.max":{const G=z("in").map(k=>b(k));I=G.length?Math.max(...G):0;break}case"compute.floor":{I=Math.floor(b(z("in")[0]));break}case"compute.ceil":{I=Math.ceil(b(z("in")[0]));break}case"compute.round":{I=Math.round(b(z("in")[0]));break}case"compute.mod":{const G=b(z("a")[0]),k=b(z("b")[0]);I=Math.abs(k)<Number.EPSILON?0:G%k;break}case"compute.concat":{const k=["in1","in2","in3","in4","in5","in6"].flatMap(ce=>z(ce)),P=k.length?k:z("in");I=(P.length?P:z()).map(ce=>ce==null?"":String(ce)).join("");break}case"compute.trim":{const G=z("text")[0]??z("in")[0]??"",k=G==null?"":String(G),P=Math.max(0,Math.round(b(z("start")[0]))),Z=Math.max(0,Math.round(b(z("end")[0])));P+Z>=k.length?I="":I=k.substring(P,k.length-Z);break}case"output":{I=z("in")[0]??0;break}default:I=0}return g.delete(_),c.set(_,I),I},E=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(_=>_.type==="output").map(_=>_.id);t.nodes.forEach(_=>y(_.id)),E.forEach(_=>y(_));const w=_=>Math.abs(_%1)<1e-5?String(Math.round(_)):_.toFixed(3).replace(/\.?0+$/,""),d=_=>typeof _=="number"?w(_):_??"",N=new Map;E.forEach(_=>{var k,P,Z,ne;const h=o.get(_);if(!h)return;const z=(P=(k=h.inputsByHandle)==null?void 0:k.name)==null?void 0:P[0],I=z?d(c.get(z)):"",G=(I==null?void 0:I.toString().trim())||((Z=h.outputLabel)==null?void 0:Z.trim())||((ne=h.name)==null?void 0:ne.trim())||_;N.set(_,G)});const l={},r={},Y={};E.forEach(_=>{var I,G;const h=o.get(_);if(!h)return;const z=N.get(_)??(((I=h.outputLabel)==null?void 0:I.trim())||((G=h.name)==null?void 0:G.trim())||_);l[z]=d(c.get(_)),h.name&&(r[h.name.trim()]=z),r[_]=z});const ie=(_,h)=>{let z=_;return t.nodes.forEach(I=>{var ne,ce;const G=d(c.get(I.id)),k=E.includes(I.id),P=k?N.get(I.id)??((ne=I.outputLabel)==null?void 0:ne.trim())??((ce=I.name)==null?void 0:ce.trim())??I.id:"",Z=k&&h?P:G;z=z.replace(new RegExp(`\\{\\s*${es(I.id)}\\s*\\}`,"gi"),Z),I.name&&(z=z.replace(new RegExp(`\\{\\s*${es(I.name)}\\s*\\}`,"gi"),Z)),k&&I.outputLabel&&(z=z.replace(new RegExp(`\\{\\s*${es(I.outputLabel)}\\s*\\}`,"gi"),P))}),z},W=s;let U=W.trim().length>0?W:"";U||(U=E.length?`Compute ${E.join(", ")}`:"Compute"),U=ie(U,!0);const v=(n==null?void 0:n.trim())??"",m=v?ie(v,!1):"",te={};return c.forEach((_,h)=>{te[h]=_,Y[h]=d(_);const z=o.get(h);z!=null&&z.name&&(Y[z.name.trim()]=d(_))}),{prompt:U,answers:l,values:te,answerText:m,outputVariables:r,variableValues:Y}}function en(t){var n;const s=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((n=s[0])==null?void 0:n[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}function tn({copy:t,currentCard:s,currentTypeLabel:n,prompt:o,languages:c,answer:g,onAnswerChange:b,computedExpected:y,computedAnswers:E,onComputedAnswerChange:w,answerTemplate:d,outputVariables:N,variableValues:l,computedFieldFeedback:r,feedback:Y,canAdvance:ie,quoteContext:W,quotePlaceholder:U,onCheckAnswer:v,onSkip:m,onLanguageSelect:te,onMarkReviewed:_,onAdvance:h,showCorrectAnswer:z,setShowCorrectAnswer:I,onRevealCorrect:G,answerMask:k,expectedAnswer:P,hasExpectedAnswer:Z,handleComputedKeyDown:ne,answerInputRef:ce,computedInputRefs:Ie,scriptMode:de,setScriptMode:S,matchPairs:ge,matchLeftOrder:x,matchRightOrder:V,matchSelection:ue,matchActiveLeft:B,matchActiveRight:H,matchFeedback:Ne,onMatchLeftSelect:Se,onMatchRightSelect:je}){const Re=a.useMemo(()=>{var ve;const q=!d&&y.length===2?`The {${y[0].key}} is of type {${y[1].key}}`:null,Q=d??q;if(!Q)return null;const De=new Map(y.map($=>[$.key,$.expected])),xe=new Set,re=[],$e=/\{([^}]+)\}/g;let qe=0,K,le=null;for(;(K=$e.exec(Q))!==null;){const $=Q.slice(qe,K.index);$&&re.push({type:"text",value:$});const O=((ve=K[1])==null?void 0:ve.trim())??"",fe=O&&De.has(O)?O:O&&N&&N[O]?N[O]:null;O&&xe.add(O),fe&&xe.add(fe),fe&&De.has(fe)?(re.push({type:"input",value:fe}),le||(le=fe)):O&&l&&l[O]!==void 0?re.push({type:"text",value:l[O]}):re.push({type:"text",value:K[0]}),qe=K.index+K[0].length}const L=Q.slice(qe);return L&&re.push({type:"text",value:L}),y.filter($=>!xe.has($.key)).length>0?null:{parts:re,expectedByKey:De,firstInputKey:le}},[d,y,N,l]),ye=()=>{if(!Re)return null;const{parts:q,expectedByKey:Q,firstInputKey:De}=Re;return e.jsx("div",{className:"cogita-revision-inline-answer",children:q.map((xe,re)=>{var $e,qe;return xe.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:xe.value},`text-${re}`):e.jsx("input",{ref:K=>{Ie.current[xe.value]=K},autoFocus:xe.value===De,value:E[xe.value]??"",onChange:K=>w(xe.value,K.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":r[xe.value]??(Y==="correct"?"correct":Y==="incorrect"?"incorrect":void 0),onKeyDown:K=>Be(K)||ne(K),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,(($e=E[xe.value])==null?void 0:$e.length)??0,((qe=Q.get(xe.value))==null?void 0:qe.length)??6)}ch`}},`input-${xe.value}-${re}`)})})},Ke=a.useMemo(()=>{const q=new Map;return(ge??[]).forEach(Q=>q.set(Q.leftId,Q)),q},[ge]),_e=a.useMemo(()=>{const q=new Map;return(ge??[]).forEach(Q=>q.set(Q.rightId,Q)),q},[ge]);a.useEffect(()=>{var re;if(s.cardType!=="info"||s.infoType!=="computed"||y.length===0)return;const q=typeof document<"u"?document.activeElement:null;if(q&&(q.tagName==="INPUT"||q.tagName==="TEXTAREA"))return;const Q=(Re==null?void 0:Re.firstInputKey)??((re=y[0])==null?void 0:re.key);if(!Q)return;const De=Ie.current[Q];if(!De)return;const xe=requestAnimationFrame(()=>{De.focus()});return()=>cancelAnimationFrame(xe)},[s,y,Re]);const we=(()=>{const q=[P??"",...y.map(xe=>xe.expected??"")].join(""),Q=[g,...Object.values(E)].join(""),De=`${q}${Q}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(De)})(),Be=q=>q.ctrlKey&&(q.key==="^"||q.key==="6")?(q.preventDefault(),S(Q=>Q==="super"?null:"super"),!0):q.ctrlKey&&(q.key==="_"||q.key==="-")?(q.preventDefault(),S(Q=>Q==="sub"?null:"sub"),!0):!1,et=()=>{if(!P||!k)return P??"";const q=P.split(""),Q=Array.from(k),De=Q.length>0?Q.reduce((xe,re)=>xe+re,0)/Q.length:127;return q.map((xe,re)=>{const $e=Q[re]??De,qe=Math.max(0,Math.min(255,Math.round($e)));let K=255,le=0;return qe<=127?le=Math.round(qe/127*255):(le=255,K=Math.round(255*(1-(qe-127)/128))),e.jsx("span",{style:{color:`rgb(${K}, ${le}, 0)`},children:xe},`mask-${re}`)})},We=s.cardType==="info"&&s.infoType==="quote"?(W==null?void 0:W.title)||s.label:s.description;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[e.jsx("span",{children:n}),e.jsx("strong",{children:We})]}),s.cardType==="vocab"&&s.checkType==="translation-match"&&ge?e.jsxs("div",{className:"cogita-revision-body",children:[o?e.jsx("h2",{children:o}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(x??[]).map(q=>{const Q=Ke.get(q);if(!Q)return null;const De=(ue==null?void 0:ue[q])??null,xe=(Ne==null?void 0:Ne[q])??null,re=B===q;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":re,"data-state":xe??void 0,"data-locked":De?"true":void 0,onClick:()=>Se==null?void 0:Se(q),children:[e.jsx("span",{children:Q.leftLabel}),De&&z?e.jsx("em",{children:"✓"}):null]},q)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(V??[]).map(q=>{const Q=_e.get(q);if(!Q)return null;const De=Object.values(ue??{}).includes(q),xe=H===q;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":De||xe,"data-locked":De?"true":void 0,onClick:()=>je==null?void 0:je(q),children:e.jsx("span",{children:Q.rightLabel})},q)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:s.checkType==="translation-match",children:t.cogita.library.revision.checkAnswer}),e.jsx("button",{type:"button",className:"ghost",onClick:m,children:t.cogita.library.revision.skip})]})]}):s.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:o}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ce,value:g,onChange:q=>b(q.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":Y==="correct"?"correct":Y==="incorrect"?"incorrect":void 0,onKeyDown:q=>{q.key==="Enter"&&(q.preventDefault(),q.stopPropagation(),ie?h():v())}})]}),we?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":de==="super",onClick:()=>S(q=>q==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":de==="sub",onClick:()=>S(q=>q==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,children:t.cogita.library.revision.checkAnswer}),e.jsx("button",{type:"button",className:"ghost",onClick:m,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[s.label?e.jsx("p",{className:"cogita-revision-hint",children:s.label}):null,d?null:e.jsx(kn,{value:o??"",mode:"auto"}),y.length>0?(()=>{const q=ye();return q?e.jsx("div",{className:"cogita-inline-answer-wrap",children:q}):e.jsx("div",{className:"cogita-form-grid",children:y.map((Q,De)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:Q.key}),e.jsx("textarea",{ref:xe=>{Ie.current[Q.key]=xe},autoFocus:De===0,value:E[Q.key]??"",onChange:xe=>w(Q.key,xe.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":r[Q.key]??(Y==="correct"?"correct":Y==="incorrect"?"incorrect":void 0),onKeyDown:xe=>Be(xe)||ne(xe)})]},Q.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:ce,value:g,onChange:q=>b(q.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":Y==="correct"?"correct":Y==="incorrect"?"incorrect":void 0,onKeyDown:q=>{Be(q)||q.key==="Enter"&&(q.preventDefault(),q.stopPropagation(),ie?h():v())}})]})}),we?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":de==="super",onClick:()=>S(q=>q==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":de==="sub",onClick:()=>S(q=>q==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,children:t.cogita.library.revision.checkAnswer}),e.jsx("button",{type:"button",className:"ghost",onClick:m,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="quote"&&W?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(W.completed)).replace("{total}",String(W.total))}),e.jsx("p",{className:"cogita-quote-text",children:W.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ce,value:g,onChange:q=>b(q.target.value),placeholder:U??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":Y==="correct"?"correct":Y==="incorrect"?"incorrect":void 0,onKeyDown:q=>{q.key==="Enter"&&(q.preventDefault(),q.stopPropagation(),ie?h():v())}})]}),e.jsx("p",{className:"cogita-quote-text",children:W.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,children:t.cogita.library.revision.checkAnswer}),e.jsx("button",{type:"button",className:"ghost",onClick:m,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:o}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:c.length?c.map(q=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>te(q.label),children:q.label},q.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:m,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:o}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:_,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:m,children:t.cogita.library.revision.skip})]})]}),Y&&e.jsx("div",{className:"cogita-revision-feedback","data-state":Y,children:Y==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),Y==="incorrect"&&Z?e.jsxs("div",{className:"cogita-revision-reveal",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>I(q=>{const Q=!q;return Q&&G(),Q}),children:t.cogita.library.revision.showAnswer}),z?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),y.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[y.map(q=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:q.key}),e.jsx("span",{children:q.expected})]},q.key)),P?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:P})]}):null]}):e.jsx("p",{children:k?et():P})]}):null]}):null,ie?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:h,children:t.cogita.library.revision.nextQuestion})}):null]})}const ts=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function an({outcomes:t}){const[s,n]=a.useState("day"),o=a.useMemo(()=>{const c=ts.find(y=>y.id===s)??ts[1],g=Date.now()-c.ms,b=t.filter(y=>new Date(y.createdUtc).getTime()>=g);return Bt(b)},[t,s]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:ts.map(c=>e.jsx("button",{type:"button",className:"ghost","data-active":s===c.id,onClick:()=>n(c.id),children:c.label},c.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[o.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[o.correct," / ",o.total]})]})}const yi="cogita-revision",xi=1,Ea="outcomes",vi=()=>new Promise((t,s)=>{const n=indexedDB.open(yi,xi);n.onupgradeneeded=()=>{const o=n.result;if(!o.objectStoreNames.contains(Ea)){const c=o.createObjectStore(Ea,{keyPath:"id"});c.createIndex("byItem","itemKey",{unique:!1}),c.createIndex("byPending","pending",{unique:!1})}},n.onerror=()=>s(n.error),n.onsuccess=()=>t(n.result)}),Na=async(t,s)=>{const n=await vi();return new Promise((o,c)=>{const g=n.transaction(Ea,t),b=g.objectStore(Ea);s(b).then(o).catch(c),g.onerror=()=>c(g.error)})},sn=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const s=Array.from(t).map(n=>n.toString(16).padStart(2,"0"));return`${s.slice(0,4).join("")}-${s.slice(4,6).join("")}-${s.slice(6,8).join("")}-${s.slice(8,10).join("")}-${s.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},ji=()=>{const t="cogita_revision_client_id",s=localStorage.getItem(t);if(s)return s;const n=sn();return localStorage.setItem(t,n),n},wi=()=>{const t="cogita_revision_client_seq",s=Number(localStorage.getItem(t)??"0"),n=Number.isFinite(s)?s+1:1;return localStorage.setItem(t,String(n)),n},nn=(t,s,n,o)=>_t(t,s,n,o),Aa=async t=>{const s=ji(),n=wi(),o=new Date().toISOString(),c={...t,clientId:s,clientSequence:n,createdUtc:o,id:sn(),pending:!0};return await Na("readwrite",g=>new Promise((b,y)=>{const E={...c,itemKey:nn(c.itemType,c.itemId,c.checkType,c.direction)},w=g.add(E);w.onsuccess=()=>b(),w.onerror=()=>y(w.error)})),c},Fa=async(t,s,n,o)=>{if(!s)return[];try{const c=nn(t,s,n,o);return await Na("readonly",g=>new Promise((b,y)=>{const w=g.index("byItem").getAll(c);w.onsuccess=()=>{const N=(w.result??[]).map(l=>({itemType:l.itemType,itemId:l.itemId,checkType:l.checkType??null,direction:l.direction??null,revisionType:l.revisionType,evalType:l.evalType,correct:l.correct,createdUtc:l.createdUtc,maskBase64:l.maskBase64,payloadBase64:l.payloadBase64,payloadHashBase64:l.payloadHashBase64,clientId:l.clientId,clientSequence:l.clientSequence,personRoleId:l.personRoleId??null})).sort((l,r)=>l.createdUtc.localeCompare(r.createdUtc));b(N)},w.onerror=()=>y(w.error)}))}catch{return[]}},Kt=async()=>{try{return await Na("readonly",t=>new Promise((s,n)=>{const o=t.getAll();o.onsuccess=()=>{const g=(o.result??[]).map(b=>({itemType:b.itemType,itemId:b.itemId,checkType:b.checkType??null,direction:b.direction??null,revisionType:b.revisionType,evalType:b.evalType,correct:b.correct,createdUtc:b.createdUtc,maskBase64:b.maskBase64,payloadBase64:b.payloadBase64,payloadHashBase64:b.payloadHashBase64,clientId:b.clientId,clientSequence:b.clientSequence,personRoleId:b.personRoleId??null}));s(g)},o.onerror=()=>n(o.error)}))}catch{return[]}},Ni=async(t=100)=>{try{return await Na("readonly",s=>new Promise((n,o)=>{const g=s.index("byPending").getAll(!0);g.onsuccess=()=>{const b=g.result??[];n(b.slice(0,t))},g.onerror=()=>o(g.error)}))}catch{return[]}},ki=async t=>{if(t.length!==0)try{await Na("readwrite",s=>new Promise((n,o)=>{let c=t.length;t.forEach(g=>{const b=s.get(g);b.onsuccess=()=>{const y=b.result;if(y){y.pending=!1;const E=s.put(y);E.onsuccess=()=>{c-=1,c===0&&n()},E.onerror=()=>o(E.error)}else c-=1,c===0&&n()},b.onerror=()=>o(b.error)})}))}catch{}},as=async(t,s)=>{const n=await Ni(200);if(n.length===0)return;const o=new Map;n.forEach(c=>{var b;const g=c.personRoleId??s??"";o.has(g)||o.set(g,[]),(b=o.get(g))==null||b.push(c)});for(const[c,g]of o.entries()){const b=g.map(y=>({itemType:y.itemType,itemId:y.itemId,checkType:y.checkType??null,direction:y.direction??null,revisionType:y.revisionType,evalType:y.evalType,correct:y.correct,clientId:y.clientId,clientSequence:y.clientSequence,maskBase64:y.maskBase64??null,payloadHashBase64:y.payloadHashBase64??null,payloadBase64:y.payloadBase64??null,personRoleId:c||null}));try{await Tn({libraryId:t,outcomes:b}),await ki(g.map(y=>y.id))}catch{}}},Ls={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},Ti=(t,s)=>{const n=Math.max(t.length,s.length,1),o=Math.abs(t.length-s.length);return Math.max(0,1-o/n)},Si=(t,s)=>{const n=new Uint8Array(t.length),o=Ti(t,s);for(let c=0;c<t.length;c+=1){const g=t[c]===(s[c]??"")?128:0,b=t.length-1-c,y=s.length-1-c,E=t[b]===(s[y]??"")?127:0,w=Math.round((g+E)*o);n[c]=Math.max(0,Math.min(255,w))}return n},Ma=(t,s)=>t===s||(Ls[t]??[]).includes(s)?!0:(Ls[s]??[]).includes(t),Pa=(t,s)=>{const n=new Uint8Array(t.length);if(!t.length)return n;const o=[];for(let g=0;g<=t.length-3;g+=1)o.push({index:g,text:t.slice(g,g+3)});let c=!1;return o.forEach(g=>{for(let b=0;b<=s.length-3;b+=1){const y=s.slice(b,b+3);let E=0;for(let r=0;r<3;r+=1)Ma(g.text[r],y[r])&&(E+=1);if(E<2)continue;let w=g.index-1,d=b-1;for(;w>=0&&d>=0;){const r=t[w],Y=s[d];if(r===Y){n[w]=Math.max(n[w],255),w-=1,d-=1,c=!0;continue}if(Ma(r,Y)){n[w]=Math.max(n[w],127),w-=1,d-=1,c=!0;continue}if(w>0&&t[w-1]===Y){n[w]=Math.max(n[w],0),w-=1,c=!0;continue}if(d>0&&t[w]===s[d-1]){d-=1,c=!0;continue}break}for(let r=0;r<3;r+=1){const Y=g.index+r,ie=g.text[r],W=y[r],U=ie===W?255:Ma(ie,W)?127:0;n[Y]=Math.max(n[Y],U),c=!0}let N=g.index+3,l=b+3;for(;N<t.length&&l<s.length;){const r=t[N],Y=s[l];if(r===Y){n[N]=Math.max(n[N],255),N+=1,l+=1,c=!0;continue}if(Ma(r,Y)){n[N]=Math.max(n[N],127),N+=1,l+=1,c=!0;continue}if(N+1<t.length&&t[N+1]===Y){n[N]=Math.max(n[N],0),N+=1,c=!0;continue}if(l+1<s.length&&t[N]===s[l+1]){l+=1,c=!0;continue}break}}}),c?n:Si(t,s)},ga=(t,s,n)=>{const o=t.trim().toLowerCase(),c=s.trim().toLowerCase();return Pa(o,c)},fa=t=>t.trim().toLowerCase().replace(/[^\p{L}\p{N}]+/gu,""),rn=(t,s,n)=>{const o=fa(t),c=fa(s);return Pa(o,c)},xt=t=>t.trim().toLowerCase(),Ci=t=>t==="reverse"?"reverse":"forward",wa=(t,s)=>`${t}|${s}`,wt=t=>{if(!t)return null;const[s,n]=t.split("|",2);return(s==="forward"||s==="reverse")&&n?{mode:s,fragmentId:n}:{mode:"forward",fragmentId:t}},_a=(t,s)=>{var o;const n=wt(s);return n?n.fragmentId&&s?(t??null)===s:(((o=wt(t))==null?void 0:o.mode)??"forward")===n.mode:!0},ht=t=>{const s=t==null?void 0:t.trim().toLowerCase();return s||null},on=(t,s)=>{if((ht(t.childItemType)??"info")!==(s.cardType??"").toLowerCase()||t.childItemId!==s.cardId)return!1;const o=ht(t.childCheckType),c=ht(t.childDirection),g=ht(s.checkType),b=ht(s.direction);return!(o&&o!==g||c&&c!==b)},Mi={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},Ii={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},Ba=(t,s,n)=>{if(!n||!s.startsWith(t))return s;const o=s.slice(t.length);if(!o)return s;const c=n==="super"?Mi:Ii,g=o.split("").map(b=>c[b]??b).join("");return t+g},Ka=(t,s,n)=>{var b,y,E;if(!t)return((b=s[0])==null?void 0:b.key)??null;const o=new Set(s.map(w=>w.key)),c=/\{([^}]+)\}/g;let g;for(;(g=c.exec(t))!==null;){const w=((y=g[1])==null?void 0:y.trim())??"";if(!w)continue;if(o.has(w))return w;const d=n==null?void 0:n[w];if(d&&o.has(d))return d}return((E=s[0])==null?void 0:E.key)??null},cs=t=>t.flatMap(s=>{if(s.cardType!=="info"||s.infoType!=="quote")return[s];const n=s.description??"";if(!n.trim())return[s];const o=wt(s.direction),c=(o==null?void 0:o.mode)??Ci(s.direction),g=ma(n),b=Object.keys(g.nodes);return b.length===0?[s]:b.map(y=>({...s,checkType:"quote-fragment",direction:wa(c,y)}))});function Li({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,libraryId:d,collectionId:N,revisionId:l}){const r=ds(),Y=`/#/cogita/library/${d}`,ie=a.useMemo(()=>new URLSearchParams(r.search),[r.search]),W=Math.max(1,Number(ie.get("limit")??20)),U=ie.get("mode")??"random",v=a.useMemo(()=>fs(U),[U]),m=a.useMemo(()=>Oa(v,Js(v,ie)),[v,ie]),te=ie.get("check")??"exact",_=ie.get("reviewer"),h=a.useMemo(()=>t.cogita.library.revision[v.labelKey]??U,[t,U,v]),z=a.useMemo(()=>te==="exact"?t.cogita.library.revision.checkValue:te,[t,te]),[I,G]=a.useState(t.cogita.library.collections.defaultName),[k,P]=a.useState([]),[Z,ne]=a.useState([]),[ce,Ie]=a.useState("idle"),[de,S]=a.useState({current:0,total:0}),[ge,x]=a.useState(0),[V,ue]=a.useState(""),[B,H]=a.useState(null),[Ne,Se]=a.useState(null),[je,Re]=a.useState(null),[ye,Ke]=a.useState(null),[_e,we]=a.useState([]),[Be,et]=a.useState({}),[We,q]=a.useState({}),[Q,De]=a.useState(null),[xe,re]=a.useState(null),[$e,qe]=a.useState(null),[K,le]=a.useState(null),[L,X]=a.useState(null),[ve,$]=a.useState({}),O=a.useRef(0),[fe,be]=a.useState(null),pe=a.useRef(null),Ae=a.useRef(null),[Qe,Oe]=a.useState(null),[Le,Fe]=a.useState(!1),[Te,ot]=a.useState(null),[Ue,tt]=a.useState([]),[vt,ft]=a.useState(null),ze=a.useRef(null),at=a.useRef(null),[It,lt]=a.useState(null),[Lt,nt]=a.useState(0),mt=a.useRef(null),Ft=a.useRef({}),[pt,Ze]=a.useState(!1),[C,Me]=a.useState({}),[Pe,Xe]=a.useState([]),Ye=a.useRef(new Map),[Je,dt]=a.useState(new Set),[it,Ee]=a.useState(!1),Ge=a.useRef(null),Ct=a.useRef(new Set),$t=a.useRef({}),me=k[ge]??null,he=(me==null?void 0:me.checkType)==="translation-match"&&L,Vt=a.useRef(new Map),kt=a.useRef(new Map),qt=a.useRef(new Map),Ot=a.useRef(new Map),ut=a.useMemo(()=>me?me.cardType==="vocab"?t.cogita.library.revision.vocabLabel:me.infoType?st(t,me.infoType):t.cogita.library.revision.infoLabel:"",[t,me]),Ut=a.useMemo(()=>{var u;return v.id!=="levels"?k.length:((u=C.pool)==null?void 0:u.length)??v.getFetchLimit(W,m)},[C,m,v,k.length,W]),aa=v.getProgressTotal?v.getProgressTotal(k,C,W,m):v.id==="levels"?Math.min(W,Ut):k.length,sa=aa?Math.min(ge+1,aa):0,Rt=Math.max(1,Number(m.tries??1)),jt=m.compare??"anchors",zt=Math.max(0,Math.min(100,Number(m.minCorrectness??0))),gt=(m.considerDependencies??"on")==="on",rt=Math.max(0,Math.min(100,Number(m.dependencyThreshold??85))),Mt=i=>{const u=i.slice();for(let j=u.length-1;j>0;j-=1){const f=Math.floor(Math.random()*(j+1));[u[j],u[f]]=[u[f],u[j]]}return u},Wt=i=>i.length?i.reduce((j,f)=>j+f,0)/i.length/255*100:0,Ht=i=>Wt(i)>=zt,na=async()=>{const i=await Kt(),u=new Map,j=new Map,f=new Map;i.forEach(M=>{const A=`${M.itemType}:${M.itemId}`,J=_t(M.itemType,M.itemId,M.checkType,M.direction);if(u.has(A)||u.set(A,[]),u.get(A).push(M),j.has(J)||j.set(J,[]),j.get(J).push(M),M.itemType==="info"&&M.checkType==="quote-fragment"&&M.direction){const ee=`${M.itemId}:${M.direction}`;f.has(ee)||f.set(ee,[]),f.get(ee).push(M)}});const F=new Map,p=new Map,R=new Map;return u.forEach((M,A)=>F.set(A,Bt(M).score)),j.forEach((M,A)=>p.set(A,Bt(M).score)),f.forEach((M,A)=>R.set(A,Bt(M).score)),{itemKnowness:F,cardKnowness:p,fragmentKnowness:R}},Ua=async i=>{const u=[];let j=null;for(;;){const f=await $a({libraryId:d,collectionId:i,limit:200,cursor:j});if(u.push(...f.items),!f.nextCursor)break;j=f.nextCursor}return cs(u)},pa=async(i,u)=>{if(Ye.current.has(i))return Ye.current.get(i)??0;const j=await Ua(i);if(j.length===0)return Ye.current.set(i,0),0;const F=j.reduce((p,R)=>{const M=se(R);return p+(u.get(M)??0)},0)/j.length;return Ye.current.set(i,F),F},za=(i,u)=>{if(!gt||i.cardType!=="info"||i.infoType!=="quote"||i.checkType!=="quote-fragment")return!0;const j=wt(i.direction);if(!(j!=null&&j.fragmentId))return!0;const f=i.description??"";if(!f.trim())return!0;const p=ma(f).nodes[j.fragmentId];if(!p||!p.leftId&&!p.rightId)return!0;const R=[p.leftId,p.rightId].filter(J=>!!J);if(R.length===0)return!0;const M=R.map(J=>{const ee=_t("info",i.cardId,"quote-fragment",wa(j.mode,J));return u.get(ee)??0});return M.reduce((J,ee)=>J+ee,0)/M.length>=rt},ia=async i=>{const u=C,j=i.concat(u.active??[]).concat(u.pool??[]).filter((M,A,J)=>J.findIndex(ee=>se(ee)===se(M))===A);if(!gt){dt(new Set(j.map(se)));return}const{itemKnowness:f,cardKnowness:F}=await na(),p=Pe.filter(M=>ht(M.childItemType)==="collection"&&M.childItemId===N&&!ht(M.childCheckType)&&!ht(M.childDirection)),R=new Set;for(const M of j){if(M.cardType!=="info"){R.add(se(M));continue}if(!za(M,F))continue;const A=Pe.filter(oe=>on(oe,M)).concat(p);if(A.length===0){R.add(se(M));continue}let J=0;for(const oe of A)if(ht(oe.parentItemType)==="collection")J+=await pa(oe.parentItemId,F);else if(ht(oe.parentCheckType)||ht(oe.parentDirection)){const ae=ht(oe.parentCheckType),ke=ht(oe.parentDirection),Ce=_t(oe.parentItemType,oe.parentItemId,ae,ke);J+=F.get(Ce)??0}else{const ae=`${oe.parentItemType}:${oe.parentItemId}`;J+=f.get(ae)??0}J/A.length>=rt&&R.add(se(M))}dt(R)},Ha=i=>{for(let u=i;u<k.length;u+=1){const j=k[u];if(j&&(!gt||j.cardType!=="info"||Je.has(se(j))))return u}return-1},Tt=i=>!gt||i.cardType!=="info"||Je.has(se(i)),ra=i=>{if(v.id!=="temporal"&&v.id!=="levels")return null;const u=C,j=(u.active??[]).concat(u.pool??[]),f=new Set;for(const F of j){const p=se(F);if(!(f.has(p)||i.has(p))&&(f.add(p),Tt(F)))return F}return null},Et=a.useMemo(()=>{if(v.id!=="levels")return null;const i=C,u=i.pool??[],j=i.active??[],f=i.levelMap??{},F=Math.max(1,Number(m.levels??1)),p=Array.from({length:F},()=>0),R=new Set(j.map(ee=>se(ee)));u.forEach(ee=>{const oe=Math.min(F,Math.max(1,f[se(ee)]??1));p[oe-1]+=1});const M=u.length||1,A=p.map(ee=>ee/M*100),J=me?f[se(me)]??1:null;return{counts:p,percentages:A,currentLevel:J,levelsCount:F,activeCount:j.length,poolCount:u.length,activeSet:R}},[C,m,v,me]),bt=a.useMemo(()=>{if(v.id!=="temporal")return null;const i=C,u=i.pool??[],j=i.active??[],f=i.knownessMap??{},F=new Set(i.unknownSet??[]);let p=0;u.forEach(A=>{(f[se(A)]??0)>1&&(p+=1)});const R=F.size,M=j.map(A=>({id:se(A),value:F.has(se(A))?0:Math.max(0,Math.min(1,f[se(A)]??0))}));return{knownCount:p,unknownCount:R,dots:M}},[C,v]),oa=a.useMemo(()=>{if(!gt)return 0;const i=C;return k.concat(i.active??[]).concat(i.pool??[]).filter((j,f,F)=>F.findIndex(p=>se(p)===se(j))===f).filter(j=>j.cardType==="info"&&!Je.has(se(j))).length},[gt,C,k,Je]);a.useEffect(()=>{if(!gt||ce!=="ready")return;const i=C,j=k.concat(i.active??[]).concat(i.pool??[]).filter((p,R,M)=>M.findIndex(A=>se(A)===se(p))===R).filter(p=>p.cardType!=="info"||Je.has(se(p))).length,f=ze.current;if(ze.current=j,f===null||j<=f)return;const F=j-f;ft(`New card available (+${F})`),at.current&&window.clearTimeout(at.current),at.current=window.setTimeout(()=>ft(null),2200)},[gt,ce,C,k,Je]),a.useEffect(()=>()=>{at.current&&window.clearTimeout(at.current)},[]);const yt=(i,u)=>{const j=v.applyOutcome({queue:k,meta:C},me,W,m,{correct:i,correctness:u,createdUtc:new Date().toISOString()});P(j.queue),Me(j.meta);const f=j.queue[ge+1];f&&ba(f,ge+1)};a.useEffect(()=>{qa(d,N).then(i=>G(i.name)).catch(()=>G(t.cogita.library.collections.defaultName))},[d,N]),a.useEffect(()=>{us({libraryId:d,type:"language"}).then(i=>ne(i)).catch(()=>ne([]))},[d]),a.useEffect(()=>{Vs({libraryId:d}).then(i=>Xe(i.items??[])).catch(()=>Xe([]))},[d]),a.useEffect(()=>{as(d,_)},[d,_]),a.useEffect(()=>{ia(k)},[k,Pe,gt,rt,N]),a.useEffect(()=>{if(!me||!gt){Ee(!1);return}if(me.cardType!=="info"||Je.has(se(me))){Ee(!1);return}const i=Ha(ge+1);if(i>=0){Ee(!1),x(i);return}if(v.id==="temporal"||v.id==="levels"){const u=k.slice(0,ge+1),j=k.slice(ge+1).filter(Tt),f=u.concat(j),F=new Set(f.map(se)),p=ra(F);if(p){const M=se(p);F.has(M)||(f.push(p),F.add(M),Me(A=>{const J=A,ee=new Set(J.queued??[]);return ee.add(M),{...J,queued:ee}}))}const R=f.findIndex((M,A)=>A!==ge&&Tt(M));if(R>=0){P(f),x(R),Ee(!1);return}}Ee(!0)},[me,Je,gt,ge,k,C,v.id]),a.useEffect(()=>{let i=!0;return(async()=>{Ie("loading"),S({current:0,total:v.id==="levels"?0:v.getFetchLimit(W,m)});try{const j=[];let f=null,F=null;do{const oe=await $a({libraryId:d,collectionId:N,limit:300,cursor:f});if(j.push(...oe.items),(v.id==="levels"||v.id==="temporal")&&oe.total&&(F=oe.total),S(ae=>({current:j.length,total:ae.total||oe.total||v.getFetchLimit(W,m)})),f=oe.nextCursor??null,F!==null&&j.length>=F||v.id!=="levels"&&v.id!=="temporal"&&j.length>=v.getFetchLimit(W,m))break}while(f);if(!i)return;const p=cs(j);let R;if(v.id==="levels"){const oe=Math.max(1,Number(m.levels??1)),ke=(await Kt()).reduce((Ce,Ve)=>{const He=_t(Ve.itemType,Ve.itemId,Ve.checkType,Ve.direction);return Ce[He]||(Ce[He]=[]),Ce[He].push(Ve),Ce},{});R={},p.forEach(Ce=>{const Ve=se(Ce),He=ke[Ve]??[],ct=He.length>0?Bt(He).score:0,Zt=Math.max(1,Math.min(oe,Math.ceil(ct/100*oe)));R[Ve]=Zt})}let M=null,A=null,J=null;if(v.id==="temporal"){const oe=await Kt(),ae=new Set(p.map(Ve=>se(Ve))),ke=oe.reduce((Ve,He)=>{const ct=_t(He.itemType,He.itemId,He.checkType,He.direction);return ae.has(ct)&&(Ve[ct]||(Ve[ct]=[]),Ve[ct].push(He)),Ve},{});M={},A=new Set,J={};const Ce=Date.now();p.forEach(Ve=>{const He=se(Ve),ct=ke[He]??[];if(ct.length===0){M[He]=0,A.add(He),J[He]=[];return}const Zt=hs(ct);J[He]=Zt;const cn=Da(Zt,Ce);M[He]=cn.knowness})}const ee=v.id==="levels"?ms(p,W,m,R):v.id==="temporal"?gs(p,W,m,M??{},A??new Set,J??{}):v.prepare(p,W,m);P(ee.queue),Me(ee.meta),x(0),Ie("ready"),S(oe=>({current:Math.min(oe.current,oe.total),total:oe.total}))}catch{i&&Ie("error")}})(),()=>{i=!1}},[d,N,W,m,v,_]),a.useEffect(()=>{if(ue(""),H(null),lt(null),nt(0),we([]),et({}),q({}),re(null),qe(null),le(null),Fe(!1),Ze(!1),Oe(null),X(null),$({}),!me){Se(null),Re(null),De(null),ot(null);return}me.cardType==="info"&&me.infoType==="computed"&&Se(t.cogita.library.revision.loadingComputed);let i=!0;return ba(me,ge).then(u=>{!i||!u||(Se(u.prompt),Re(u.expectedAnswer),we(u.computedExpected),et(u.computedAnswers),De(u.computedValues),re(u.answerTemplate),qe(u.outputVariables),le(u.variableValues))}),()=>{i=!1}},[me,t]),a.useEffect(()=>{if(!me||me.cardType!=="info"||me.infoType!=="quote"){Ge.current=null,Ct.current=new Set,Ke(null);return}const i=me.description??"",u=(me.label??"").trim(),j=u.replace(/\s+/g," ").trim(),f=i.replace(/\s+/g," ").trim(),F=j&&j!==f?u:t.cogita.library.infoTypes.quote;if(!i){Ke(null),Re(null);return}const p=ma(i);Ge.current=p,Se(F);let R=!0;return na().then(({fragmentKnowness:M})=>{if(!R)return;const A=getQuoteMode(me.direction),J=new Set,ee={};M.forEach((ke,Ce)=>{const[Ve,He]=Ce.split(":",2);if(Ve!==me.cardId)return;const ct=wt(He);if(!ct||ct.mode!==A)return;const Zt=ct.fragmentId;ee[Zt]=ke,ke>=rt&&J.add(Zt)}),Ct.current=J,$t.current=ee;const oe=wt(me.direction);if(oe!=null&&oe.fragmentId&&p.nodes[oe.fragmentId]){Pt(p,oe.fragmentId,F);return}const ae=ha(p,J,ee,rt,gt,me.direction);Pt(p,(ae==null?void 0:ae.id)??null,F)}).catch(()=>{Ct.current=new Set,$t.current={};const M=wt(me.direction);if(M!=null&&M.fragmentId&&p.nodes[M.fragmentId]){Pt(p,M.fragmentId,F);return}const A=ha(p,Ct.current,{},rt,gt,me.direction);Pt(p,(A==null?void 0:A.id)??null,F)}),()=>{R=!1}},[me,t,gt,rt]),a.useEffect(()=>{if(!me||me.cardType!=="vocab"||me.checkType!=="translation-match"){X(null),$({});return}const j=(C.pool??C.active??k).filter(M=>M.cardType==="vocab"&&M.checkType==="translation-match").filter((M,A,J)=>J.findIndex(ee=>ee.cardId===M.cardId)===A);j.some(M=>M.cardId===me.cardId)||j.unshift(me);const F=Mt(j).slice(0,6).map(M=>{const A=M.label.split("↔").map(oe=>oe.trim()).filter(Boolean);if(A.length<2)return null;const J=`${M.cardId}:L`,ee=`${M.cardId}:R`;return{cardId:M.cardId,leftId:J,rightId:ee,leftLabel:A[0],rightLabel:A[1]}}).filter(Boolean),p=F.map(M=>M.leftId),R=Mt(F.map(M=>M.rightId));X({pairs:F,leftOrder:p,rightOrder:R,selection:{},activeLeft:null,activeRight:null,locked:{}})},[me,k,C]),a.useEffect(()=>()=>{pe.current&&window.clearTimeout(pe.current),Ae.current&&window.clearTimeout(Ae.current)},[]);const Yt=a.useRef(null);a.useEffect(()=>{if(!me)return;const i=se(me),u=typeof document<"u"?document.activeElement:null;if(Yt.current===i&&u&&(u.tagName==="INPUT"||u.tagName==="TEXTAREA"))return;let j=0;const f=()=>{if(me){if(me.cardType==="info"&&me.infoType==="computed"){if(_e.length>0){const p=Ka(xe,_e,$e),R=p?Ft.current[p]:null;if(R&&(R.focus(),document.activeElement===R)){Yt.current=i;return}}if(mt.current&&(mt.current.focus(),document.activeElement===mt.current)){Yt.current=i;return}}else if(me.cardType==="vocab"&&mt.current&&(mt.current.focus(),document.activeElement===mt.current)){Yt.current=i;return}j<6&&(j+=1,window.setTimeout(f,40))}},F=window.setTimeout(f,40);return()=>window.clearTimeout(F)},[me,_e,xe,$e]),a.useEffect(()=>{if(!pt)return;const i=u=>{u.key==="Enter"&&(u.preventDefault(),ca())};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[pt]);const Xt=i=>{tt(i),ot(Bt(i))};a.useEffect(()=>{if(!me){ot(null),tt([]);return}const i=me.cardType==="info"?"info":"connection";if(me.cardType==="info"&&me.infoType==="quote"){Kt().then(u=>{const j=u.filter(f=>f.itemType==="info"&&f.itemId===me.cardId&&f.checkType==="quote-fragment"&&_a(f.direction,me.direction));Xt(j)}).catch(()=>{ot(null),tt([])});return}Fa(i,me.cardId,me.checkType,me.direction).then(u=>Xt(u)).catch(()=>{ot(null),tt([])})},[d,me,_]);const ka=(i,u,j,f)=>{if(i==="info"&&j==="quote-fragment"){Kt().then(F=>{const p=F.filter(R=>R.itemType==="info"&&R.itemId===u&&R.checkType==="quote-fragment"&&_a(R.direction,f));Xt(p)}).catch(()=>{ot(null),tt([])});return}Fa(i,u,j,f).then(F=>Xt(F)).catch(()=>{ot(null),tt([])})},Ta=(i,u,j)=>{var R;const f=((R=j.pairs.find(M=>M.leftId===i))==null?void 0:R.rightId)??null;if(!f)return j;const F=f===u;$(M=>({...M,[i]:F?"correct":"incorrect"})),pe.current&&window.clearTimeout(pe.current),Ae.current&&window.clearTimeout(Ae.current),O.current+=1;const p={kind:F?"correct":"incorrect",tick:O.current};if(be(null),pe.current=window.setTimeout(()=>be(p),0),Ae.current=window.setTimeout(()=>be(null),420),F){const M={...j.locked,[i]:!0};return Object.keys(M).length>=j.pairs.length?(H("correct"),Ze(!0)):H("correct"),{...j,selection:{...j.selection,[i]:u},activeLeft:null,activeRight:null,locked:M}}return H("incorrect"),{...j,activeLeft:null,activeRight:null}},la=i=>{X(u=>!u||u.locked[i]?u:u.activeRight?Ta(i,u.activeRight,u):{...u,activeLeft:u.activeLeft===i?null:i})},At=i=>{X(u=>u&&(u.activeLeft?Ta(u.activeLeft,i,u):{...u,activeRight:u.activeRight===i?null:i}))},ca=()=>{var i;if(me&&me.cardType==="info"&&me.infoType==="quote"&&Ge.current&&ye&&!((i=wt(me.direction))!=null&&i.fragmentId)){const u=ha(Ge.current,Ct.current,$t.current,rt,gt,me.direction,ye.fragmentId);if(u){H(null),ue(""),Fe(!1),q({}),Ze(!1),lt(null),nt(0),Pt(Ge.current,u.id,ye.title);return}}H(null),ue(""),Fe(!1),q({}),Ze(!1),lt(null),nt(0),x(u=>Math.min(u+1,k.length))},St=i=>{if(!me)return;const u=i.expected??null,j=i.answer??"";let f=u??"",F=j;if(!u&&i.expectedMap&&i.answerMap){const oe=Object.keys(i.expectedMap).sort((ae,ke)=>ae.localeCompare(ke));f=oe.map(ae=>{var ke;return((ke=i.expectedMap)==null?void 0:ke[ae])??""}).join("|"),F=oe.map(ae=>{var ke;return((ke=i.answerMap)==null?void 0:ke[ae])??""}).join("|")}const p=f?ga(f,F,jt):new Uint8Array,R={revisionType:v.id,evalType:i.evalType,direction:i.direction,prompt:Ne??"",expected:u,answer:j,expectedAnswers:i.expectedMap??null,answers:i.answerMap??null,correct:i.correct,maskBase64:p.length?Qt(p):null,values:Q??null,checkMode:te,compareMode:jt,minCorrectness:zt},M=new TextEncoder().encode(JSON.stringify(R)),A=me.cardType==="info"?"info":"connection",J=i.overrideCheckType??me.checkType??null,ee=i.overrideDirection??me.direction??null;Aa({itemType:A,itemId:me.cardId,checkType:J,direction:ee,revisionType:v.id,evalType:i.evalType,correct:i.correct,maskBase64:p.length?Qt(p):null,payloadBase64:Qt(M),personRoleId:_??null}).then(()=>{ka(A,me.cardId,J,ee),ia(k),as(d,_)}).catch(()=>{})},Gt=(i,u)=>{const j=Vt.current.get(u);if(j)return Promise.resolve(j);const f=kt.current.get(u);if(f)return f;const F=ua({libraryId:d,infoId:i}).then(p=>{var oe,ae;const R=p.payload,M=((oe=R.definition)==null?void 0:oe.graph)??null,A="",J=((ae=R.definition)==null?void 0:ae.answerTemplate)??"",ee=Zs(M,A,J);if(ee){const Ce={sample:en(ee),answerTemplate:J||null};return Vt.current.set(u,Ce),Ce}return ys({libraryId:d,infoId:i}).then(ke=>{const Ce={sample:ke,answerTemplate:null};return Vt.current.set(u,Ce),Ce})}).catch(()=>ys({libraryId:d,infoId:i}).then(p=>{const R={sample:p,answerTemplate:null};return Vt.current.set(u,R),R}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{kt.current.delete(u)});return kt.current.set(u,F),F},ba=(i,u)=>{var M;const j=`${se(i)}:${u}`,f=qt.current.get(j);if(f)return Promise.resolve(f);const F=Ot.current.get(j);if(F)return F;const p=A=>(qt.current.set(j,A),A);let R;if(i.cardType==="vocab"){if(i.checkType==="translation-match")return R=Promise.resolve(p({prompt:i.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),R;const A=i.label.split("↔").map(J=>J.trim()).filter(Boolean);if(A.length>=2){const ee=(i.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",oe=ee?A[0]:A[1],ae=ee?A[1]:A[0];R=Promise.resolve(p({prompt:oe,expectedAnswer:ae,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else R=Promise.resolve(p({prompt:i.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(i.cardType==="info"&&i.infoType==="word"){const A=(M=i.description)!=null&&M.startsWith("Language: ")?i.description.replace("Language: ",""):null;R=Promise.resolve(p({prompt:i.label,expectedAnswer:A,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else i.cardType==="info"&&i.infoType==="computed"?R=Gt(i.cardId,j).then(A=>{var ke,Ce;if(!A.sample)return p({prompt:i.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const J=A.sample,ee=J.expectedAnswers?Object.entries(J.expectedAnswers).map(([Ve,He])=>({key:Ve,expected:He})):[],oe=ee.reduce((Ve,He)=>(Ve[He.key]="",Ve),{}),ae=J.expectedAnswerIsSentence&&((ke=J.expectedAnswer)==null?void 0:ke.trim())||null;return p({prompt:J.prompt,expectedAnswer:ee.length>0?ae:((Ce=J.expectedAnswer)==null?void 0:Ce.trim())||null,computedExpected:ee,computedAnswers:oe,computedValues:J.values??null,answerTemplate:A.answerTemplate,outputVariables:J.outputVariables??null,variableValues:J.variableValues??null})}).catch(()=>p({prompt:i.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Ot.current.delete(j)}):R=Promise.resolve(p({prompt:i.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return Ot.current.set(j,R),R},Pt=(i,u,j)=>{const f=Object.keys(i.nodes).length,F=Ct.current.size;if(!u){Ke({title:j,before:i.text,after:"",fragmentId:null,total:f,completed:F}),Re(null),Ze(!0);return}const p=i.nodes[u];if(!p)return;const R=Ys(i.text,p);Ke({title:j,before:R.before,after:R.after,fragmentId:p.id,total:f,completed:F}),Re(R.fragment),Ze(!1)},Sa=()=>{const i=Ge.current;i&&Ke(u=>u&&{...u,total:Object.keys(i.nodes).length,completed:Ct.current.size})},da=()=>{const i=k[ge+1];i&&ba(i,ge+1)},Ca=()=>{if(da(),me&&me.cardType==="vocab"&&me.checkType==="translation-match"&&L){if(L.pairs.length===0){H("incorrect"),Ze(!0);return}const p=L.pairs.reduce((ae,ke)=>(ae[ke.rightId]=ke.rightLabel,ae),{});let R=0;const M={};L.pairs.forEach(ae=>{const Ce=L.selection[ae.leftId]===ae.rightId;M[ae.leftId]=Ce?"correct":"incorrect",Ce&&(R+=1)});const A=L.pairs.length||1,J=R/A,ee=R===L.pairs.length;$(ae=>({...ae,...M})),ee?(H("correct"),Ze(!0),nt(0)):(H("incorrect"),Ze(!1),nt(ae=>{const ke=ae+1;return ke>=Rt&&(Fe(!0),Ze(!0),X(Ce=>{if(!Ce)return Ce;const Ve=Ce.pairs.reduce((He,ct)=>(He[ct.leftId]=ct.rightId,He),{});return{...Ce,selection:Ve}})),ke})),yt(ee,J);const oe="connection";Promise.all(L.pairs.map(ae=>{const ke=L.selection[ae.leftId]??null,Ce=ke?p[ke]:"",Ve={left:ae.leftLabel,expected:ae.rightLabel,answer:Ce,checkType:"translation-match"},He=new TextEncoder().encode(JSON.stringify(Ve));return Aa({itemType:oe,itemId:ae.cardId,checkType:"translation-match",direction:null,revisionType:v.id,evalType:"translation-match",correct:ke===ae.rightId,maskBase64:null,payloadBase64:Qt(He),personRoleId:_??null})})).then(()=>{ka(oe,me.cardId,me.checkType,me.direction),as(d,_)}).catch(()=>{});return}if(_e.length>0){const p=_e.reduce((M,A)=>{const J=Be[A.key]??"";return M[A.key]=xt(J)===xt(A.expected)?"correct":"incorrect",M},{});_e.every(({key:M,expected:A})=>{const J=Be[M]??"";return te==="exact"&&xt(J)===xt(A)})?(H("correct"),q(p),Ze(!0),nt(0),yt(!0,1),St({correct:!0,direction:Ne?`${Ne} -> computed`:"computed",expectedMap:_e.reduce((M,A)=>(M[A.key]=A.expected,M),{}),answerMap:Be,evalType:"computed"})):(H("incorrect"),q(p),Ze(!1),nt(M=>{const A=M+1;return A>=Rt&&D&&(Fe(!0),Ze(!0)),A}),yt(!1,0),window.setTimeout(()=>{var A;const M=Ka(xe,_e,$e);M&&Ft.current[M]&&((A=Ft.current[M])==null||A.focus())},40),St({correct:!1,direction:Ne?`${Ne} -> computed`:"computed",expectedMap:_e.reduce((M,A)=>(M[A.key]=A.expected,M),{}),answerMap:Be,evalType:"computed"}));return}if(me&&me.cardType==="info"&&me.infoType==="quote"&&(ye!=null&&ye.fragmentId)){if(!je)return;const p=wt(me.direction),R=(p==null?void 0:p.mode)??getQuoteMode(me.direction),M=p!=null&&p.fragmentId&&me.direction?me.direction:wa(R,ye.fragmentId),A=rn(je,V,jt),J=te==="exact"&&fa(V)===fa(je),ee=Ht(A),oe=J||ee,ae=Wt(A);oe?($t.current[ye.fragmentId]=Math.max($t.current[ye.fragmentId]??0,ae),($t.current[ye.fragmentId]??0)>=rt&&Ct.current.add(ye.fragmentId),Sa(),H("correct"),q({}),Ze(!0),lt(A),nt(0),ae<100&&Rt<=1&&Fe(!0),yt(!0,ae/100),St({correct:!0,direction:`quote:${ye.fragmentId}`,expected:je,answer:V,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:M})):(H("incorrect"),q({}),Ze(!1),lt(A),nt(ke=>{const Ce=ke+1;return Ce>=Rt&&D&&(Fe(!0),Ze(!0)),Ce}),yt(!1,ae/100),window.setTimeout(()=>{var ke;return(ke=mt.current)==null?void 0:ke.focus()},40),St({correct:!1,direction:`quote:${ye.fragmentId}`,expected:je,answer:V,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:M}));return}if(!je)return;const i=ga(je,V,jt),u=te==="exact"&&xt(V)===xt(je),j=Ht(i),f=u||j,F=Wt(i);f?(H("correct"),q({}),Ze(!0),lt(i),nt(0),F<100&&Rt<=1&&Fe(!0),yt(!0,F/100),St({correct:!0,direction:Ne?`${Ne} -> ${je}`:null,expected:je,answer:V,evalType:"text"})):(H("incorrect"),q({}),Ze(!1),lt(i),nt(p=>{const R=p+1;return R>=Rt&&D&&(Fe(!0),Ze(!0)),R}),yt(!1,F/100),window.setTimeout(()=>{var p;return(p=mt.current)==null?void 0:p.focus()},40),St({correct:!1,direction:Ne?`${Ne} -> ${je}`:null,expected:je,answer:V,evalType:"text"}))},Qa=i=>{if(da(),!je)return;const u=ga(je,i,jt),j=xt(i)===xt(je),f=Ht(u),F=j||f,p=Wt(u);F?(H("correct"),q({}),Ze(!0),lt(u),nt(0),p<100&&Rt<=1&&Fe(!0),yt(!0,p/100),St({correct:!0,direction:"word->language",expected:je,answer:i,evalType:"language-select"})):(H("incorrect"),q({}),Ze(!1),lt(u),nt(R=>{const M=R+1;return M>=Rt&&D&&(Fe(!0),Ze(!0)),M}),yt(!1,p/100),St({correct:!1,direction:"word->language",expected:je,answer:i,evalType:"language-select"}))},Wa=()=>{da(),H("correct"),Ze(!0),nt(0),yt(!0,1),je&&St({correct:!0,direction:"manual",expected:je,answer:V,evalType:"manual"})},Ya=()=>{if(yt(!1,0),me&&me.cardType==="info"&&me.infoType==="quote"){H(null),ue(""),Fe(!1),q({}),Ze(!1),lt(null),nt(0),x(i=>Math.min(i+1,k.length));return}ca()};a.useEffect(()=>{da()},[ge,k]);const Jt=i=>{var j;if(i.key!=="Enter")return;if(i.preventDefault(),i.stopPropagation(),pt){ca();return}const u=_e.find(f=>!(Be[f.key]??"").trim());if(u){(j=Ft.current[u.key])==null||j.focus();return}Ca()},T=t.cogita.library.revision.revealModeAfterIncorrect,D=_e.length>0||!!je;return e.jsxs(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,children:[ce==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${de.total?Math.min(100,Math.max(0,de.current/de.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:de.total?`${Math.min(de.current,de.total)} / ${de.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:I}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",h).replace("{check}",z)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:Y,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${Y}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${Y}/collections/${N}`,children:t.cogita.library.actions.collectionDetail})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Te?`${Te.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Et?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Et.currentLevel??"-"," / ",Et.levelsCount]}):null,Te?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(Te.correct)).replace("{total}",String(Te.total))}),Te.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(Te.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(an,{outcomes:Ue})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[vt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:vt})}):null,e.jsx("section",{className:"cogita-revision-card","data-feedback":fe?`${fe.kind}-${fe.tick}`:he?"idle":B??"idle",children:me?e.jsx(e.Fragment,{children:it?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(tn,{copy:t,currentCard:me,currentTypeLabel:ut,prompt:Ne,languages:Z,answer:V,onAnswerChange:i=>ue(u=>Ba(u,i,Qe)),computedExpected:_e,computedAnswers:Be,onComputedAnswerChange:(i,u)=>et(j=>({...j,[i]:Ba(j[i]??"",u,Qe)})),answerTemplate:xe,outputVariables:$e,variableValues:K,computedFieldFeedback:We,feedback:B,canAdvance:pt,quoteContext:ye,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Ca,onSkip:Ya,onLanguageSelect:Qa,onMarkReviewed:Wa,onAdvance:ca,showCorrectAnswer:Le,setShowCorrectAnswer:Fe,onRevealCorrect:()=>Ze(!0),answerMask:It,expectedAnswer:je,hasExpectedAnswer:D,handleComputedKeyDown:Jt,answerInputRef:mt,computedInputRefs:Ft,scriptMode:Qe,setScriptMode:Oe,matchPairs:L==null?void 0:L.pairs,matchLeftOrder:L==null?void 0:L.leftOrder,matchRightOrder:L==null?void 0:L.rightOrder,matchSelection:L==null?void 0:L.selection,matchActiveLeft:L==null?void 0:L.activeLeft,matchActiveRight:L==null?void 0:L.activeRight,matchFeedback:ve,onMatchLeftSelect:la,onMatchRightSelect:At})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${Y}/collections/${N}`,children:t.cogita.library.actions.collectionDetail})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:aa?`${sa} / ${aa}`:t.cogita.library.revision.progressUnlimited}),ce==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),ce==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),ce==="ready"&&k.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:T}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",Rt]})]})]}),Et?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Et.activeCount," / ",Et.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Et.counts.map((i,u)=>{const j=u+1,f=Et.currentLevel===j,F=Et.percentages[u]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":f,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:j}),e.jsx("strong",{children:i})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,F))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[F.toFixed(1),"%"]})]},`level-${j}`)})})]}):null,bt?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:bt.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:bt.dots.map(i=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,i.value*100))}%`,background:`rgba(${Math.round(255*(1-i.value))}, ${Math.round(200*i.value)}, 80, 0.9)`}},i.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:bt.knownCount})]})]}):null,gt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:oa})]})}):null]})]})]})})})]})]})}const ss=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],$i={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},Ri=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Ei=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function Ai({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,libraryId:d,collectionId:N}){const[l,r]=a.useState(""),[Y,ie,W]=Rs([]),[U,v,m]=Es([]),[te,_]=a.useState(null),[h,z]=a.useState(null),[I,G]=a.useState(null),k=`/#/cogita/library/${d}`;a.useEffect(()=>{qa(d,N).then(S=>r(S.name)).catch(()=>r(t.cogita.library.collections.defaultName))},[d,N,t]),a.useEffect(()=>{Sn({libraryId:d,collectionId:N}).then(S=>{if(!S.graphId||S.graphId==="00000000-0000-0000-0000-000000000000"){ie([]),v([]);return}const ge=S.nodes.map(V=>{var Ne;const ue=V.payload??{},B=ue.position??{x:120,y:120},H=ue.params??{};return{id:V.nodeId,type:"default",position:B,data:{nodeType:V.nodeType,label:((Ne=ss.find(Se=>Se.type===V.nodeType))==null?void 0:Ne.label)??V.nodeType,params:H}}}),x=S.edges.map(V=>({id:V.edgeId,source:V.fromNodeId,target:V.toNodeId,sourceHandle:V.fromPort??void 0,targetHandle:V.toPort??void 0}));ie(ge),v(x)}).catch(()=>{ie([]),v([])})},[d,N,v,ie]);const P=a.useMemo(()=>Y.find(S=>S.id===te)??null,[Y,te]),Z=S=>{var ue;const ge=crypto.randomUUID(),x=((ue=ss.find(B=>B.type===S))==null?void 0:ue.label)??S,V={...$i[S]};ie(B=>[...B,{id:ge,type:"default",position:{x:120+B.length*40,y:120+B.length*40},data:{nodeType:S,label:x,params:V}}]),_(ge)},ne=a.useCallback(S=>{v(ge=>As({...S,id:crypto.randomUUID()},ge))},[v]),ce=async()=>{z(null);try{await Mn({libraryId:d,collectionId:N,nodes:Y.map(S=>({nodeId:S.id,nodeType:S.data.nodeType,payload:{position:S.position,params:S.data.params}})),edges:U.map(S=>({edgeId:S.id,fromNodeId:S.source,fromPort:S.sourceHandle??null,toNodeId:S.target,toPort:S.targetHandle??null}))}),z(t.cogita.library.graph.saveSuccess)}catch{z(t.cogita.library.graph.saveFail)}},Ie=async()=>{try{const S=await Cn({libraryId:d,collectionId:N});G(S)}catch{G(null)}},de=S=>{P&&ie(ge=>ge.map(x=>x.id===P.id?{...x,data:{...x.data,params:S}}:x))};return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${k}/collections/${N}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Ie,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:ce,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:ss.map(S=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>Z(S.type),children:S.label},S.type))}),h?e.jsx("p",{className:"cogita-help",children:h}):null,I&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(I.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(I.connections)).replace("{infos}",String(I.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(Fs,{nodes:Y,edges:U,onNodesChange:W,onEdgesChange:m,onConnect:ne,onNodeClick:(S,ge)=>_(ge.id),fitView:!0,children:[e.jsx(Ps,{color:"rgba(120,160,200,0.2)"}),e.jsx(_s,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),P?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:P.data.label}),P.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(ta,{libraryId:d,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:P.data.params.tagId?{id:P.data.params.tagId,label:P.data.params.tagLabel??"",infoType:"topic"}:null,onChange:S=>de({...P.data.params,tagId:(S==null?void 0:S.id)??null,tagLabel:(S==null?void 0:S.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:P.data.params.scope??"any",onChange:S=>de({...P.data.params,scope:S.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),P.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(ta,{libraryId:d,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:P.data.params.languageId?{id:P.data.params.languageId,label:P.data.params.languageLabel??"",infoType:"language"}:null,onChange:S=>de({...P.data.params,languageId:(S==null?void 0:S.id)??null,languageLabel:(S==null?void 0:S.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:P.data.params.scope??"any",onChange:S=>de({...P.data.params,scope:S.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),P.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:P.data.params.infoType??"word",onChange:S=>de({...P.data.params,infoType:S.target.value}),children:Ei.map(S=>e.jsx("option",{value:S.value,children:S.label},S.value))})]}),e.jsx(ta,{libraryId:d,infoType:P.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:P.data.params.infoId?{id:P.data.params.infoId,label:P.data.params.infoLabel??"",infoType:P.data.params.infoType??"word"}:null,onChange:S=>de({...P.data.params,infoId:(S==null?void 0:S.id)??null,infoLabel:(S==null?void 0:S.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),P.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:P.data.params.connectionType??"translation",onChange:S=>de({...P.data.params,connectionType:S.target.value}),children:Ri.map(S=>e.jsx("option",{value:S.value,children:S.label},S.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:P.data.params.connectionId??"",onChange:S=>de({...P.data.params,connectionId:S.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(P.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const ns="cogita.preferences",ln=["library_overview","all_cards","all_collections","storyboards","texts","dependencies","transfer"],is={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},rs=["settings","run","shared"];function Fi(t,s=""){const n=t.split("/").filter(Boolean);if(n[0]!=="cogita"||n[1]!=="library")return{};const o=n[2];if(!o)return{};if(!n[3])return{libraryId:o,target:"library_overview"};const c=new URLSearchParams(s),g=c.get("revisionId")??void 0,b=c.get("infoId")??void 0,y=c.get("infoView")==="cards"?"cards":"overview",E=c.get("collectionAction"),w=c.get("libraryAction");if(n[3]==="list")return{libraryId:o,target:w==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:g,infoId:b,infoView:y,libraryAction:w==="new-info"?"new-info":void 0};if(n[3]==="detail"||n[3]==="collection")return{libraryId:o,target:"all_cards",cardMode:n[3],revisionId:g,infoId:b,infoView:y};if(n[3]==="new"||n[3]==="add")return{libraryId:o,target:"new_card",revisionId:g,libraryAction:"new-info"};if(n[3]==="edit")return{libraryId:o,target:"new_card",revisionId:g,infoId:n[4]};if(n[3]==="shared-revisions")return{libraryId:o,target:"all_collections",revisionId:g};if(n[3]==="dependencies")return{libraryId:o,target:"dependencies"};if(n[3]==="transfer")return{libraryId:o,target:"transfer"};if(n[3]==="storyboards")return n[4]==="new"?{libraryId:o,target:"new_storyboard"}:{libraryId:o,target:"storyboards"};if(n[3]==="texts")return n[4]==="new"?{libraryId:o,target:"new_text"}:{libraryId:o,target:"texts"};if(n[3]!=="collections")return{libraryId:o,target:"library_overview"};if(n[4]==="new")return{libraryId:o,target:"new_collection",revisionId:g};const d=n[4];return d?n[5]==="graph"?{libraryId:o,target:"all_collections",collectionId:d,revisionId:g,revisionView:"graph"}:n[5]==="shared-revisions"?{libraryId:o,target:"all_collections",collectionId:d,revisionId:g,revisionView:"shared"}:n[5]==="revision"?{libraryId:o,target:"all_collections",collectionId:d,revisionId:g,revisionView:n[6]==="run"?"run":"settings"}:E==="new-revision"?{libraryId:o,target:"all_collections",collectionId:d,revisionId:g,revisionView:"new"}:{libraryId:o,target:"all_collections",collectionId:d,revisionId:g,revisionView:"detail"}:E==="new-collection"?{libraryId:o,target:"new_collection",collectionAction:"new-collection"}:{libraryId:o,target:"all_collections"}}function os(t,s="library_overview",n,o,c,g,b="overview"){const y=(E,w)=>{const d=new URLSearchParams;w!=null&&w.revisionId&&d.set("revisionId",w.revisionId),w!=null&&w.collectionAction&&d.set("collectionAction",w.collectionAction),w!=null&&w.libraryAction&&d.set("libraryAction",w.libraryAction),w!=null&&w.infoId&&d.set("infoId",w.infoId),w!=null&&w.infoView&&(w!=null&&w.infoId)&&d.set("infoView",w.infoView);const N=d.toString();return N?`${E}?${N}`:E};return t?s==="library_overview"?y(`/cogita/library/${t}`,{revisionId:c}):s==="all_cards"?y(`/cogita/library/${t}/list`,{revisionId:c,infoId:g,infoView:b}):s==="new_card"?g?y(`/cogita/library/${t}/edit/${g}`,{revisionId:c}):y(`/cogita/library/${t}/list`,{revisionId:c,libraryAction:"new-info"}):s==="all_collections"?n?o==="graph"?y(`/cogita/library/${t}/collections/${n}/graph`,{revisionId:c}):o==="settings"?y(`/cogita/library/${t}/collections/${n}/revision`,{revisionId:c}):o==="run"?y(`/cogita/library/${t}/collections/${n}/revision/run`,{revisionId:c}):o==="shared"?y(`/cogita/library/${t}/collections/${n}/shared-revisions`,{revisionId:c}):o==="new"?y(`/cogita/library/${t}/collections/${n}`,{revisionId:c,collectionAction:"new-revision"}):y(`/cogita/library/${t}/collections/${n}`,{revisionId:c}):y(`/cogita/library/${t}/collections`,{revisionId:c}):s==="new_collection"?y(`/cogita/library/${t}/collections`,{revisionId:c,collectionAction:"new-collection"}):s==="transfer"?y(`/cogita/library/${t}/transfer`,{revisionId:c}):s==="storyboards"?y(`/cogita/library/${t}/storyboards`,{revisionId:c}):s==="new_storyboard"?y(`/cogita/library/${t}/storyboards/new`,{revisionId:c}):s==="texts"?y(`/cogita/library/${t}/texts`,{revisionId:c}):s==="new_text"?y(`/cogita/library/${t}/texts/new`,{revisionId:c}):s==="dependencies"?y(`/cogita/library/${t}/dependencies`,{revisionId:c}):y(`/cogita/library/${t}`,{revisionId:c}):"/cogita"}function Ia(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function Pi(t){return typeof t=="string"&&ln.includes(t)}function _i(t,s){var y;if(!t.length)return null;const n=t.filter(E=>s.has(E.roleId)),o=n.length>0?n:t,c=o.map(E=>{var d,N;const w=((N=(d=E.fields.find(l=>l.fieldType==="role_kind"))==null?void 0:d.plainValue)==null?void 0:N.toLowerCase())??"";return{roleId:E.roleId,roleKind:w}}),g=c.find(E=>E.roleKind.includes("master"));if(g)return g.roleId;const b=c.find(E=>E.roleKind.includes("account")||E.roleKind.includes("user"));return b?b.roleId:((y=o[0])==null?void 0:y.roleId)??null}function Bi(t){if(!t)return{version:1,byLibrary:{}};try{const s=JSON.parse(t);return!s||typeof s!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:s.lastLibraryId,byLibrary:s.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function Ki({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w}){const d=$s(),N=ds(),l=a.useMemo(()=>Fi(N.pathname,N.search),[N.pathname,N.search]),r=t.cogita.workspace,[Y,ie]=a.useState([]),[W,U]=a.useState([]),[v,m]=a.useState([]),[te,_]=a.useState([]),[h,z]=a.useState(void 0),[I,G]=a.useState("library_overview"),[k,P]=a.useState(void 0),[Z,ne]=a.useState(void 0),[ce,Ie]=a.useState("detail"),[de,S]=a.useState(void 0),[ge,x]=a.useState(!1),[V,ue]=a.useState(!0),[B,H]=a.useState(!1),[Ne,Se]=a.useState(!1),[je,Re]=a.useState(null),[ye,Ke]=a.useState(""),[_e,we]=a.useState(""),[Be,et]=a.useState(""),[We,q]=a.useState(null),[Q,De]=a.useState(null),xe=a.useRef({version:1,byLibrary:{}}),re=a.useRef(!1),$e=a.useRef(!1),qe=a.useRef(null),K=a.useMemo(()=>Y.find(C=>C.libraryId===h)??null,[Y,h]),le=a.useMemo(()=>W.find(C=>C.collectionId===k)??null,[W,k]),L=a.useMemo(()=>te.find(C=>C.revisionId===Z)??null,[te,Z]),X=a.useMemo(()=>({detail:r.revisions.detail,graph:r.revisions.graph,settings:r.revisions.settings,run:r.revisions.run,shared:r.targets.sharedRevisions,new:r.revisionForm.createAction}),[r.revisions.detail,r.revisions.graph,r.revisions.run,r.revisions.settings,r.targets.sharedRevisions,r.revisionForm.createAction]),ve=a.useMemo(()=>[{value:"detail",label:X.detail},{value:"graph",label:X.graph},{value:"settings",label:r.targets.allRevisions},{value:"run",label:X.run},{value:"shared",label:X.shared}],[X.detail,X.graph,X.run,X.shared,r.targets.allRevisions]),$=a.useMemo(()=>I==="new_card"?"all_cards":I==="new_collection"?"all_collections":I==="new_storyboard"?"storyboards":I==="new_text"?"texts":I,[I]),O=a.useMemo(()=>ce==="new"?"settings":ce,[ce]),fe=a.useMemo(()=>l.infoId?"selected":I==="new_card"?"create":"search",[l.infoId,I]),be=a.useMemo(()=>v.find(C=>C.infoId===l.infoId)??null,[v,l.infoId]),pe=a.useMemo(()=>({library_overview:r.targets.libraryOverview,all_cards:r.targets.allCards,new_card:r.targets.newCard,all_collections:r.targets.allCollections,new_collection:r.targets.newCollection,transfer:r.targets.transfer,storyboards:r.targets.storyboards,new_storyboard:r.targets.newStoryboard,texts:r.targets.texts,new_text:r.targets.newText,dependencies:r.targets.dependencies}),[r.targets]),Ae=a.useMemo(()=>pe[$]??$,[$,pe]),Qe=X[O],Oe=!!h,Le=!!k,Fe=Oe&&I==="all_collections",Te=Le&&I==="all_collections",ot=Le&&I==="all_collections"&&rs.includes(ce),Ue=a.useCallback(C=>{const Me=!!C.libraryId;let Pe=C.target,Xe=C.collectionId,Ye=C.revisionId,Je=C.revisionView,dt=C.infoId,it=C.infoView??l.infoView??"overview";Me?is[Pe].requiresCollection&&!Xe?(Pe="all_collections",Ye=void 0,Je="detail"):Pe!=="all_collections"?(Xe=void 0,Ye=void 0,Pe!=="new_card"&&Pe!=="all_cards"&&(dt=void 0,it="overview")):is[Pe].allowsRevision?rs.includes(Je)||(Ye=void 0):Je="detail":(Pe="library_overview",Xe=void 0,Ye=void 0,Je="detail",dt=void 0,it="overview"),z(C.libraryId),G(Pe),P(Xe),ne(Ye),Ie(Je),x(!1);const Ee=Ia(os(C.libraryId,Pe,Xe,Je,Ye,dt,it));Ia(`${N.pathname}${N.search}`)!==Ee&&(qe.current=Ee,d(Ee))},[N.pathname,N.search,d,l.infoView]),tt=C=>{Ue({libraryId:h,target:"all_collections",collectionId:k,revisionId:rs.includes(C)?Z:void 0,revisionView:C})},vt=a.useMemo(()=>[{key:"library",label:r.layers.library,visible:!0,value:h??"",selectedLabel:(K==null?void 0:K.name)??r.path.noLibrarySelected,disabled:V||Y.length===0,options:Y.map(C=>({value:C.libraryId,label:C.name})),emptyOption:r.noLibraryOption,onSelect:C=>{const Me=C||void 0;Ue({libraryId:Me,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:r.layers.target,visible:Oe,value:$,selectedLabel:Ae,disabled:!Oe,options:ln.map(C=>({value:C,label:pe[C]})),onSelect:C=>{const Me=C;Ue({libraryId:h,target:Me,collectionId:k,revisionId:Z,revisionView:ce,infoId:Me==="new_card"?l.infoId:void 0})}},{key:"info_mode",label:r.layers.target,visible:$==="all_cards",value:fe,selectedLabel:fe==="create"?r.infoMode.create:fe==="selected"?(be==null?void 0:be.label)??de??t.cogita.library.list.selectedEmpty:r.infoMode.search,disabled:!Oe,options:[{value:"search",label:r.infoMode.search},{value:"create",label:r.infoMode.create},...l.infoId?[{value:"selected",label:(be==null?void 0:be.label)??de??t.cogita.library.list.selectedEmpty}]:[]],onSelect:C=>{if(C!=="selected"){if(C==="create"){Ue({libraryId:h,target:"new_card",collectionId:k,revisionId:Z,revisionView:ce,infoId:void 0});return}Ue({libraryId:h,target:"all_cards",collectionId:k,revisionId:Z,revisionView:ce,infoId:void 0,infoView:"overview"})}}},{key:"info_selected_action",label:r.layers.target,visible:$==="all_cards"&&!!l.infoId,value:I==="new_card"&&l.infoId?"edit":l.infoView==="cards"?"cards":"overview",selectedLabel:I==="new_card"&&l.infoId?r.infoActions.edit:l.infoView==="cards"?r.infoActions.seeCards:r.infoActions.overview,disabled:!Oe||!l.infoId,options:[{value:"overview",label:r.infoActions.overview},{value:"edit",label:r.infoActions.edit},{value:"cards",label:r.infoActions.seeCards}],onSelect:C=>{if(l.infoId){if(C==="edit"){Ue({libraryId:h,target:"new_card",collectionId:k,revisionId:Z,revisionView:ce,infoId:l.infoId});return}if(C==="cards"){Ue({libraryId:h,target:"all_cards",collectionId:k,revisionId:Z,revisionView:ce,infoId:l.infoId,infoView:"cards"});return}Ue({libraryId:h,target:"all_cards",collectionId:k,revisionId:Z,revisionView:ce,infoId:l.infoId,infoView:"overview"})}}},{key:"collection",label:r.layers.collection,visible:Fe,value:k??"",selectedLabel:(le==null?void 0:le.name)??r.path.noCollectionSelected,disabled:!Oe||B||W.length===0,options:W.map(C=>({value:C.collectionId,label:C.name})),emptyOption:r.selectCollectionOption,onSelect:C=>{Ue({libraryId:h,target:"all_collections",collectionId:C||void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection_action",label:r.layers.revision,visible:Te,value:O,selectedLabel:Qe,disabled:!k,options:ve.map(C=>({value:C.value,label:C.label})),onSelect:C=>{tt(C)}},{key:"revision_entry",label:r.layers.revision,visible:ot,value:Z??"",selectedLabel:(L==null?void 0:L.name)??r.status.noRevisions,disabled:!Le||Ne||te.length===0,options:te.map(C=>({value:C.revisionId,label:C.name})),emptyOption:r.status.noRevisions,onSelect:C=>{Ue({libraryId:h,target:"all_collections",collectionId:k,revisionId:C||void 0,revisionView:ce})}}],[ve,W,B,fe,v,Y,V,Ue,te,Ne,le,k,be,L,Z,de,Le,Oe,K,h,Qe,ce,I,O,$,Ae,Fe,Te,ot,pe,t.cogita.library.list.selectedEmpty,l.infoId,l.infoView,r.infoActions.edit,r.infoActions.overview,r.infoActions.seeCards,r.layers.collection,r.layers.library,r.layers.revision,r.layers.target,r.noLibraryOption,r.path.noCollectionSelected,r.path.noLibrarySelected,r.selectCollectionOption]),ft=a.useMemo(()=>vt.filter(C=>C.visible),[vt]),ze=a.useMemo(()=>ft.filter(C=>C.key!=="library"&&C.key!=="collection"&&C.key!=="revision_entry"),[ft]),at=a.useMemo(()=>ze.find(C=>C.key==="target")??null,[ze]),It=a.useMemo(()=>ze.find(C=>C.key==="info_mode")??null,[ze]),lt=a.useMemo(()=>ze.find(C=>C.key==="info_selected_action")??null,[ze]),Lt=a.useMemo(()=>ze.find(C=>C.key==="collection_action")??null,[ze]),nt=a.useCallback((C,Me)=>C?e.jsx("div",{className:"cogita-sidebar-actions",children:C.options.map(Pe=>e.jsx("button",{type:"button",className:`ghost ${String(C.value)===Pe.value?"active":""}`,onClick:()=>C.onSelect(Pe.value),disabled:C.disabled,children:Pe.label},`${Me}:${C.key}:${Pe.value}`))}):null,[]),mt=a.useMemo(()=>{const C=l.libraryId;if(!C||!N.pathname.startsWith("/cogita/library/"))return null;const Me={copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,libraryId:C};if(l.target==="library_overview")return e.jsx(Qn,{...Me});if(l.target==="all_cards")return e.jsx(Zn,{...Me,mode:l.cardMode??"list"});if(l.target==="new_card")return e.jsx(ti,{...Me,editInfoId:l.infoId});if(l.target==="dependencies")return e.jsx(si,{...Me});if(l.target==="transfer")return e.jsx(ii,{...Me});if(l.target==="storyboards"||l.target==="new_storyboard")return e.jsx(ri,{...Me});if(l.target==="texts"||l.target==="new_text")return e.jsx(oi,{...Me});if(l.target==="all_collections"){if(l.collectionId){const Pe={...Me,collectionId:l.collectionId};return l.revisionView==="graph"?e.jsx(Ai,{...Pe}):l.revisionView==="shared"?e.jsx(ni,{...Me,collectionId:l.collectionId}):l.revisionView==="settings"?e.jsx(bi,{...Pe,revisionId:l.revisionId}):l.revisionView==="run"?e.jsx(Li,{...Pe,revisionId:l.revisionId}):e.jsx(li,{...Pe})}return e.jsx(Is,{...Me})}return l.target==="new_collection"?e.jsx(Is,{...Me}):null},[s,t,E,N.pathname,d,w,g,y,o,c,l.cardMode,l.collectionId,l.infoId,l.libraryId,l.revisionId,l.revisionView,l.target,b,n]);a.useEffect(()=>{let C=!1;return(async()=>{var Pe,Xe,Ye,Je,dt,it,Ee;ue(!0);try{await In();const[Ge,Ct,$t]=await Promise.all([qs(),Ln(),$n()]);if(C)return;ie(Ge);const me=new Set($t.nodes.filter(ut=>ut.nodeType==="role"&&ut.canLink).map(ut=>ut.roleId??"")),he=_i(Ct,me);if(q(he),he){const ut=$t.nodes.find(Ut=>Ut.nodeType==="data"&&Ut.roleId===he&&(Ut.fieldType===ns||Ut.label===ns));De((ut==null?void 0:ut.dataKeyId)??null),xe.current=Bi(ut==null?void 0:ut.value)}const Vt=xe.current.lastLibraryId,kt=((Pe=Ge.find(ut=>ut.libraryId===l.libraryId))==null?void 0:Pe.libraryId)??(Ge.length===1?Ge[0].libraryId:void 0)??((Xe=Ge.find(ut=>ut.libraryId===Vt))==null?void 0:Xe.libraryId)??((Ye=Ge[0])==null?void 0:Ye.libraryId),qt=kt?(dt=(Je=xe.current.byLibrary)==null?void 0:Je[kt])==null?void 0:dt.lastTarget:void 0,Ot=Pi(qt)?qt:"library_overview";z(kt),G(l.target??Ot),ne(l.revisionId??(kt?(Ee=(it=xe.current.byLibrary)==null?void 0:it[kt])==null?void 0:Ee.lastRevisionId:void 0)),Ie(l.revisionView??"detail"),re.current=!0}catch{C||Re(r.status.loadFailed)}finally{C||ue(!1)}})(),()=>{C=!0}},[r.status.loadFailed]),a.useLayoutEffect(()=>{re.current&&(l.libraryId&&Y.some(C=>C.libraryId===l.libraryId)&&z(l.libraryId),l.target&&G(l.target),P(l.collectionId),ne(l.revisionId),l.revisionView&&Ie(l.revisionView))},[Y,l.collectionId,l.libraryId,l.revisionId,l.revisionView,l.target]),a.useEffect(()=>{if(!h){U([]),P(void 0),m([]),_([]),ne(void 0);return}let C=!1;return H(!0),va({libraryId:h,limit:200}).then(Me=>{var Ye;if(C)return;const Pe=Me.items;U(Pe);const Xe=(Ye=Pe.find(Je=>Je.collectionId===l.collectionId))==null?void 0:Ye.collectionId;P(Xe)}).catch(()=>{C||(U([]),P(void 0))}).finally(()=>{C||H(!1)}),()=>{C=!0}},[l.collectionId,h]),a.useEffect(()=>{if(!h||$!=="all_cards"&&I!=="new_card"){m([]);return}let C=!1;return us({libraryId:h,limit:200}).then(Me=>{C||m(Me)}).catch(()=>{C||m([])}),()=>{C=!0}},[$,h,I]),a.useEffect(()=>{if(!h||!k){_([]),ne(void 0);return}let C=!1;return Se(!0),Ds({libraryId:h,collectionId:k}).then(Me=>{var Ye,Je,dt,it;if(C)return;_(Me);const Pe=(Je=(Ye=xe.current.byLibrary)==null?void 0:Ye[h])==null?void 0:Je.lastRevisionId,Xe=((dt=Me.find(Ee=>Ee.revisionId===l.revisionId))==null?void 0:dt.revisionId)??((it=Me.find(Ee=>Ee.revisionId===Pe))==null?void 0:it.revisionId);ne(Xe)}).catch(()=>{C||(_([]),ne(void 0))}).finally(()=>{C||Se(!1)}),()=>{C=!0}},[l.revisionId,k,h]),a.useEffect(()=>{const C=l.infoId;if(!h||!C){S(void 0);return}let Me=!1;return ua({libraryId:h,infoId:C}).then(Pe=>{if(Me)return;const Xe=Pe.payload;S((Xe==null?void 0:Xe.label)??(Xe==null?void 0:Xe.name)??(Xe==null?void 0:Xe.title)??Pe.infoId)}).catch(()=>{Me||S(C)}),()=>{Me=!0}},[l.infoId,h]),a.useEffect(()=>{if(!re.current||l.libraryId&&Y.some(Pe=>Pe.libraryId===l.libraryId)&&l.libraryId!==h||l.target&&l.target!==I||l.revisionView&&l.revisionView!==ce||l.revisionId&&l.revisionId!==Z||is[I].requiresCollection&&!k&&l.target==="all_collections"&&l.collectionId)return;const C=Ia(`${N.pathname}${N.search}`),Me=Ia(os(h,I,k,ce,Z,l.infoId,l.infoView??"overview"));if(C===Me){qe.current=null;return}qe.current!==Me&&(qe.current=Me,d(Me,{replace:!0}))},[Y,N.pathname,N.search,d,l.collectionId,l.infoId,l.infoView,l.libraryId,l.revisionId,l.revisionView,l.target,k,h,Z,ce,I]),a.useEffect(()=>{if(typeof window>"u")return;const C=()=>{window.innerWidth>920&&x(!1)};return window.addEventListener("resize",C),()=>window.removeEventListener("resize",C)},[]),a.useEffect(()=>{if(!re.current||!We||!h||$e.current)return;const C=xe.current,Me={...C.byLibrary??{}},Pe={...Me[h]??{},lastCollectionId:k,lastRevisionId:Z,lastRevisionView:ce,lastTarget:I},Xe={version:1,lastLibraryId:h,byLibrary:{...Me,[h]:Pe}},Ye=JSON.stringify(C),Je=JSON.stringify(Xe);if(Ye===Je)return;xe.current=Xe,$e.current=!0,(async()=>{try{if(Q)await Rn(Q,{plainValue:Je});else{const it=await En(We,{itemName:ns,itemType:"data",plainValue:Je});De(it.dataItemId)}}catch{Re(r.status.savePrefsFailed)}finally{$e.current=!1}})()},[Q,We,k,h,Z,ce,I,r.status.savePrefsFailed]);const Ft=async()=>{const C=ye.trim();if(!C){Re(t.cogita.user.libraryNameRequired);return}Re(null);try{const Me=await Pn({name:C});ie(Pe=>[Me,...Pe]),z(Me.libraryId),G("library_overview"),P(void 0),Ke("")}catch{Re(t.cogita.user.libraryCreateFailed)}},pt=async()=>{if(!h){Re(r.status.selectLibraryFirst);return}const C=_e.trim();if(!C){Re(t.cogita.library.collections.saveRequiredName);return}Re(null);try{const Me=await An({libraryId:h,name:C,items:[]}),Pe=await va({libraryId:h,limit:200});U(Pe.items),P(Me.collectionId),ne(void 0),G("all_collections"),Ie("detail"),we("")}catch{Re(t.cogita.library.collections.saveFail)}},Ze=async()=>{if(!h||!k){Re(r.status.selectLibraryFirst);return}const C=Be.trim();if(!C){Re(r.revisionForm.nameLabel);return}Re(null);try{const Me=await Fn({libraryId:h,collectionId:k,name:C,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});_(Pe=>[Me,...Pe]),ne(Me.revisionId),G("all_collections"),Ie("settings"),et("")}catch{Re(r.status.loadFailed)}};return e.jsx(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${ge?"open":""}`,"aria-label":r.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{children:(K==null?void 0:K.name)??r.path.noLibrarySelected}),e.jsx("p",{className:"cogita-sidebar-note",children:K?r.sidebar.libraryActionsHint:r.status.selectLibraryFirst}),nt(at,"sidebar")]}),It?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:r.sidebar.infoActionsHint}),nt(It,"sidebar"),lt?e.jsxs("div",{className:"cogita-sidebar-actions-nested",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(be==null?void 0:be.label)??de??t.cogita.library.list.selectedEmpty}),e.jsx("p",{className:"cogita-sidebar-note",children:r.sidebar.selectedInfoActionsHint}),nt(lt,"sidebar")]}):null]}):null,le?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:le.name}),e.jsx("p",{className:"cogita-sidebar-note",children:r.sidebar.collectionActionsHint}),nt(Lt,"sidebar")]}):null,e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:r.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:o,children:r.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{y("cogita"),x(!1)},children:r.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:c,children:b?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),ge?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":r.sidebar.closeMenu,onClick:()=>x(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":r.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>x(C=>!C),"aria-label":ge?r.sidebar.closeMenu:r.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),ft.map((C,Me)=>e.jsxs("div",{className:"cogita-browser-segment",children:[Me>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,C.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":C.label,children:C.selectedLabel}):e.jsxs("select",{"aria-label":C.label,value:C.value,onChange:Pe=>C.onSelect(Pe.target.value),disabled:C.disabled,children:[C.emptyOption?e.jsx("option",{value:"",children:C.emptyOption}):null,C.options.map(Pe=>e.jsx("option",{value:Pe.value,children:Pe.label},`${C.key}:${Pe.value}`))]})]},`menu:${C.key}`))]}),mt?e.jsxs(e.Fragment,{children:[I==="new_collection"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.library.actions.createCollection}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{type:"text",value:_e,onChange:C=>we(C.target.value),placeholder:t.cogita.library.collections.namePlaceholder,disabled:!h})]}),e.jsx("button",{type:"button",className:"cta",onClick:pt,disabled:!h,children:t.cogita.library.actions.createCollection}),je?e.jsx("p",{className:"cogita-form-error",children:je}):null]}):null,I==="all_collections"&&k&&ce==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:r.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:r.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Be,onChange:C=>et(C.target.value),placeholder:r.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Ze,children:r.revisionForm.createAction}),je?e.jsx("p",{className:"cogita-form-error",children:je}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Hs.Provider,{value:!0,children:mt})})]}):null,mt?null:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-browser-layout",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:r.panels.currentPosition}),e.jsxs("p",{className:"cogita-browser-path",children:[ft.map((C,Me)=>e.jsxs("span",{children:[Me>0?e.jsx("span",{children:" / "}):null,e.jsx("strong",{children:C.selectedLabel})]},`path:${C.key}`)),Fe?null:e.jsxs("span",{children:[e.jsx("span",{children:" / "}),e.jsx("strong",{children:r.path.noCollectionLayer})]})]}),e.jsxs("p",{className:"cogita-browser-note",children:[r.path.currentRoute," ",e.jsx("code",{children:os(h,I,k,ce,Z,l.infoId,l.infoView??"overview")})]}),h?e.jsxs("div",{className:"cogita-browser-links",children:[e.jsx("a",{className:"ghost",href:`/#/cogita/library/${h}`,children:r.links.libraryOverview}),e.jsx("a",{className:"ghost",href:`/#/cogita/library/${h}/list`,children:r.links.allCards}),k?e.jsx("a",{className:"ghost",href:`/#/cogita/library/${h}/collections/${k}/shared-revisions`,children:r.links.sharedRevisions}):null]}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:r.panels.quickCreate}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:ye,onChange:C=>Ke(C.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Ft,children:t.cogita.user.createLibraryAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{type:"text",value:_e,onChange:C=>we(C.target.value),placeholder:t.cogita.library.collections.namePlaceholder,disabled:!h})]}),e.jsx("button",{type:"button",className:"cta",onClick:pt,disabled:!h,children:t.cogita.library.actions.createCollection}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:r.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Be,onChange:C=>et(C.target.value),placeholder:r.revisionForm.namePlaceholder,disabled:!k})]}),e.jsx("button",{type:"button",className:"cta",onClick:Ze,disabled:!k,children:r.revisionForm.createAction}),je?e.jsx("p",{className:"cogita-form-error",children:je}):null]})]}),e.jsxs("section",{className:"cogita-browser-collections",children:[e.jsx("h2",{children:r.panels.collections}),B?e.jsx("p",{className:"cogita-library-subtitle",children:r.status.loadingCollections}):null,!B&&W.length===0?e.jsx("p",{className:"cogita-library-subtitle",children:r.status.noCollections}):null,W.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:W.map(C=>e.jsxs("button",{type:"button",className:`cogita-card-item ${C.collectionId===k?"active":""}`,onClick:()=>{P(C.collectionId),ne(void 0),Ie("detail")},children:[e.jsx("div",{className:"cogita-card-type",children:r.cards.collectionType}),e.jsx("h3",{className:"cogita-card-title",children:C.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[C.itemCount," ",r.cards.itemsSuffix]})]},C.collectionId))}):null]})]})]})]})})}const zi=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:Ki},Symbol.toStringTag,{value:"Module"}));function qi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,shareId:d}){const[N,l]=a.useState(null),[r,Y]=a.useState("loading"),[ie,W]=a.useState(t.cogita.library.collections.defaultName),[U,v]=a.useState("Cogita Library"),[m,te]=a.useState([]),[_,h]=a.useState([]),[z,I]=a.useState("idle"),[G,k]=a.useState({current:0,total:0}),[P,Z]=a.useState(0),[ne,ce]=a.useState(""),[Ie,de]=a.useState(null),[S,ge]=a.useState(null),[x,V]=a.useState(null),[ue,B]=a.useState(null),[H,Ne]=a.useState([]),[Se,je]=a.useState({}),[Re,ye]=a.useState({}),[Ke,_e]=a.useState(null),[we,Be]=a.useState(null),[et,We]=a.useState(null),[q,Q]=a.useState(null),[De,xe]=a.useState({}),re=a.useRef(0),[$e,qe]=a.useState(null),K=a.useRef(null),le=a.useRef(null),[L,X]=a.useState(null),[ve,$]=a.useState(!1),[O,fe]=a.useState(null),[be,pe]=a.useState([]),[Ae,Qe]=a.useState(null),Oe=a.useRef(null),Le=a.useRef(null),[Fe,Te]=a.useState(null),[ot,Ue]=a.useState(0),tt=a.useRef(null),vt=a.useRef({}),[ft,ze]=a.useState(!1),[at,It]=a.useState({}),lt=a.useRef(null),Lt=a.useRef(new Set),nt=a.useRef({}),[mt,Ft]=a.useState([]),[pt,Ze]=a.useState(new Set),[C,Me]=a.useState(!1),Pe=ds(),Xe=a.useMemo(()=>new URLSearchParams(Pe.search),[Pe.search]),Ye=a.useMemo(()=>Xe.get("key")??"",[Xe]),Je=(N==null?void 0:N.mode)??"random",dt=(N==null?void 0:N.check)??"exact",it=(N==null?void 0:N.limit)??20,Ee=a.useMemo(()=>fs((N==null?void 0:N.revisionType)??Je),[N,Je]),Ge=a.useMemo(()=>{const T=N==null?void 0:N.revisionSettings,D=Js(Ee,Xe);return Oa(Ee,T??D)},[N,Xe,Ee]),Ct=a.useMemo(()=>t.cogita.library.revision[Ee.labelKey]??Je,[t,Je,Ee]),$t=a.useMemo(()=>dt==="exact"?t.cogita.library.revision.checkValue:dt,[t,dt]),he=r==="ready"?m[P]??null:null,Vt=(he==null?void 0:he.checkType)==="translation-match"&&q,kt=a.useRef(new Map),qt=a.useRef(new Map),Ot=a.useRef(new Map),ut=a.useRef(new Map),Ut=a.useMemo(()=>he?he.cardType==="vocab"?t.cogita.library.revision.vocabLabel:he.infoType?st(t,he.infoType):t.cogita.library.revision.infoLabel:"",[t,he]),aa=a.useMemo(()=>{var D;return Ee.id!=="levels"?m.length:((D=at.pool)==null?void 0:D.length)??Ee.getFetchLimit(it,Ge)},[at,Ge,Ee,m.length,it]),sa=Ee.getProgressTotal?Ee.getProgressTotal(m,at,it,Ge):Ee.id==="levels"?Math.min(it,aa):m.length,Rt=sa?Math.min(P+1,sa):0,jt=Math.max(1,Number(Ge.tries??1)),zt=Ge.compare??"anchors",gt=Math.max(0,Math.min(100,Number(Ge.minCorrectness??0))),rt=(Ge.considerDependencies??"on")==="on",Mt=Math.max(0,Math.min(100,Number(Ge.dependencyThreshold??85))),Wt=T=>{const D=T.slice();for(let i=D.length-1;i>0;i-=1){const u=Math.floor(Math.random()*(i+1));[D[i],D[u]]=[D[u],D[i]]}return D},Ht=T=>T.length?T.reduce((i,u)=>i+u,0)/T.length/255*100:0,na=T=>Ht(T)>=gt,Ua=async()=>{const T=await Kt(),D=new Map,i=new Map;T.forEach(f=>{const F=`${f.itemType}:${f.itemId}`,p=_t(f.itemType,f.itemId,f.checkType,f.direction);D.has(F)||D.set(F,[]),D.get(F).push(f),i.has(p)||i.set(p,[]),i.get(p).push(f)});const u=new Map,j=new Map;return D.forEach((f,F)=>u.set(F,Bt(f).score)),i.forEach((f,F)=>j.set(F,Bt(f).score)),{itemKnowness:u,cardKnowness:j}},pa=async T=>{const D=at,i=T.concat(D.active??[]).concat(D.pool??[]).filter((A,J,ee)=>ee.findIndex(oe=>se(oe)===se(A))===J);if(!rt){Ze(new Set(i.map(se)));return}const{itemKnowness:u,cardKnowness:j}=await Ua(),f=A=>{if(A.cardType!=="info"||A.infoType!=="quote"||A.checkType!=="quote-fragment")return!0;const J=wt(A.direction);if(!(J!=null&&J.fragmentId))return!0;const ee=A.description??"";if(!ee.trim())return!0;const ae=ma(ee).nodes[J.fragmentId];if(!ae||!ae.leftId&&!ae.rightId)return!0;const ke=[ae.leftId,ae.rightId].filter(He=>!!He);if(ke.length===0)return!0;const Ce=ke.map(He=>{const ct=_t("info",A.cardId,"quote-fragment",wa(J.mode,He));return j.get(ct)??0});return Ce.reduce((He,ct)=>He+ct,0)/Ce.length>=Mt},F=(N==null?void 0:N.collectionId)??null,p=F?mt.filter(A=>ht(A.childItemType)==="collection"&&A.childItemId===F&&!ht(A.childCheckType)&&!ht(A.childDirection)):[],R=F&&i.length>0?i.reduce((A,J)=>A+(j.get(se(J))??0),0)/i.length:0,M=new Set;for(const A of i){if(A.cardType!=="info"){M.add(se(A));continue}if(!f(A))continue;const J=mt.filter(ae=>on(ae,A)).concat(p);if(J.length===0){M.add(se(A));continue}let ee=0;for(const ae of J)if(ht(ae.parentItemType)==="collection")ee+=ae.parentItemId===F?R:0;else if(ht(ae.parentCheckType)||ht(ae.parentDirection)){const ke=ht(ae.parentCheckType),Ce=ht(ae.parentDirection),Ve=_t(ae.parentItemType,ae.parentItemId,ke,Ce);ee+=j.get(Ve)??0}else{const ke=`${ae.parentItemType}:${ae.parentItemId}`;ee+=u.get(ke)??0}ee/J.length>=Mt&&M.add(se(A))}Ze(M)},za=T=>{for(let D=T;D<m.length;D+=1){const i=m[D];if(i&&(!rt||i.cardType!=="info"||pt.has(se(i))))return D}return-1},ia=T=>!rt||T.cardType!=="info"||pt.has(se(T)),Ha=T=>{if(Ee.id!=="temporal"&&Ee.id!=="levels")return null;const D=at,i=(D.active??[]).concat(D.pool??[]),u=new Set;for(const j of i){const f=se(j);if(!(u.has(f)||T.has(f))&&(u.add(f),ia(j)))return j}return null},Tt=a.useMemo(()=>{if(Ee.id!=="levels")return null;const T=at,D=T.pool??[],i=T.active??[],u=T.levelMap??{},j=Math.max(1,Number(Ge.levels??1)),f=Array.from({length:j},()=>0),F=new Set(i.map(A=>se(A)));D.forEach(A=>{const J=Math.min(j,Math.max(1,u[se(A)]??1));f[J-1]+=1});const p=D.length||1,R=f.map(A=>A/p*100),M=he?u[se(he)]??1:null;return{counts:f,percentages:R,currentLevel:M,levelsCount:j,activeCount:i.length,poolCount:D.length,activeSet:F}},[at,Ge,Ee,he]),ra=a.useMemo(()=>{if(Ee.id!=="temporal")return null;const T=at,D=T.pool??[],i=T.active??[],u=T.knownessMap??{},j=new Set(T.unknownSet??[]);let f=0;D.forEach(R=>{(u[se(R)]??0)>1&&(f+=1)});const F=j.size,p=i.map(R=>({id:se(R),value:j.has(se(R))?0:Math.max(0,Math.min(1,u[se(R)]??0))}));return{knownCount:f,unknownCount:F,dots:p}},[at,Ee]),Et=a.useMemo(()=>{if(!rt)return 0;const T=at;return m.concat(T.active??[]).concat(T.pool??[]).filter((i,u,j)=>j.findIndex(f=>se(f)===se(i))===u).filter(i=>i.cardType==="info"&&!pt.has(se(i))).length},[rt,at,m,pt]);a.useEffect(()=>{if(!rt||z!=="ready")return;const T=at,i=m.concat(T.active??[]).concat(T.pool??[]).filter((f,F,p)=>p.findIndex(R=>se(R)===se(f))===F).filter(f=>f.cardType!=="info"||pt.has(se(f))).length,u=Oe.current;if(Oe.current=i,u===null||i<=u)return;const j=i-u;Qe(`New card available (+${j})`),Le.current&&window.clearTimeout(Le.current),Le.current=window.setTimeout(()=>Qe(null),2200)},[rt,z,at,m,pt]),a.useEffect(()=>()=>{Le.current&&window.clearTimeout(Le.current)},[]);const bt=(T,D)=>{const i=Ee.applyOutcome({queue:m,meta:at},he,it,Ge,{correct:T,correctness:D,createdUtc:new Date().toISOString()});te(i.queue),It(i.meta);const u=i.queue[P+1];u&&St(u,P+1)};a.useEffect(()=>{if(!d){Y("error");return}Y("loading"),_n({shareId:d,key:Ye}).then(T=>{l(T),W(T.collectionName),v(T.libraryName),Y("ready")}).catch(()=>{Y("error")})},[d,Ye]),a.useEffect(()=>{d&&Bn({shareId:d,key:Ye,type:"language"}).then(T=>h(T)).catch(()=>h([]))},[d,Ye]),a.useEffect(()=>{!d||r!=="ready"||Kn({shareId:d,key:Ye}).then(T=>Ft(T.items??[])).catch(()=>Ft([]))},[d,Ye,r]),a.useEffect(()=>{if(!d||r!=="ready")return;let T=!0;return(async()=>{I("loading"),k({current:0,total:Ee.id==="levels"?0:Ee.getFetchLimit(it,Ge)});try{const i=[];let u=null,j=null;do{const J=await qn({shareId:d,key:Ye,limit:300,cursor:u});if(i.push(...J.items),(Ee.id==="levels"||Ee.id==="temporal")&&J.total&&(j=J.total),k(ee=>({current:i.length,total:ee.total||J.total||Ee.getFetchLimit(it,Ge)})),u=J.nextCursor??null,j!==null&&i.length>=j||Ee.id!=="levels"&&Ee.id!=="temporal"&&i.length>=Ee.getFetchLimit(it,Ge))break}while(u);if(!T)return;const f=cs(i);let F;if(Ee.id==="levels"){const J=Math.max(1,Number(Ge.levels??1));F={},f.forEach(ee=>{const oe=se(ee);F[oe]=Math.max(1,Math.min(J,1))})}let p=null,R=null,M=null;if(Ee.id==="temporal"){const J=await Kt(),ee=new Set(f.map(ke=>se(ke))),oe=J.reduce((ke,Ce)=>{const Ve=_t(Ce.itemType,Ce.itemId,Ce.checkType,Ce.direction);return ee.has(Ve)&&(ke[Ve]||(ke[Ve]=[]),ke[Ve].push(Ce)),ke},{});p={},R=new Set,M={};const ae=Date.now();f.forEach(ke=>{const Ce=se(ke),Ve=oe[Ce]??[];if(Ve.length===0){p[Ce]=0,R.add(Ce),M[Ce]=[];return}const He=hs(Ve);M[Ce]=He;const ct=Da(He,ae);p[Ce]=ct.knowness})}const A=Ee.id==="levels"?ms(f,it,Ge,F):Ee.id==="temporal"?gs(f,it,Ge,p??{},R??new Set,M??{}):Ee.prepare(f,it,Ge);te(A.queue),It(A.meta),Z(0),I("ready"),k(J=>({current:Math.min(J.current,J.total),total:J.total}))}catch{T&&I("error")}})(),()=>{T=!1}},[d,Ye,it,Ee,Ge,r]),a.useEffect(()=>{pa(m)},[m,mt,rt,Mt,N==null?void 0:N.collectionId]),a.useEffect(()=>{if(!he||!rt){Me(!1);return}if(he.cardType!=="info"||pt.has(se(he))){Me(!1);return}const T=za(P+1);if(T>=0){Me(!1),Z(T);return}if(Ee.id==="temporal"||Ee.id==="levels"){const D=m.slice(0,P+1),i=m.slice(P+1).filter(ia),u=D.concat(i),j=new Set(u.map(se)),f=Ha(j);if(f){const p=se(f);j.has(p)||(u.push(f),j.add(p),It(R=>{const M=R,A=new Set(M.queued??[]);return A.add(p),{...M,queued:A}}))}const F=u.findIndex((p,R)=>R!==P&&ia(p));if(F>=0){te(u),Z(F),Me(!1);return}}Me(!0)},[he,pt,rt,P,m,at,Ee.id]),a.useEffect(()=>{if(ce(""),de(null),Te(null),Ue(0),Ne([]),je({}),ye({}),_e(null),Be(null),We(null),$(!1),ze(!1),X(null),Q(null),xe({}),!he){ge(null),V(null);return}he.cardType==="info"&&he.infoType==="computed"&&ge(t.cogita.library.revision.loadingComputed);let T=!0;return St(he,P).then(D=>{!T||!D||(ge(D.prompt),V(D.expectedAnswer),Ne(D.computedExpected),je(D.computedAnswers),_e(D.answerTemplate),Be(D.outputVariables),We(D.variableValues))}),()=>{T=!1}},[he,d,t]),a.useEffect(()=>{if(!he||he.cardType!=="info"||he.infoType!=="quote"){lt.current=null,Lt.current=new Set,B(null);return}const T=he.description??"",D=(he.label??"").trim(),i=D.replace(/\s+/g," ").trim(),u=T.replace(/\s+/g," ").trim(),j=i&&i!==u?D:t.cogita.library.infoTypes.quote;if(!T){B(null),V(null);return}const f=ma(T);lt.current=f,ge(j);let F=!0;return Kt().then(p=>{if(!F)return;const R=getQuoteMode(he.direction),M=new Map;p.forEach(ae=>{if(ae.itemType!=="info"||ae.checkType!=="quote-fragment"||!ae.direction)return;const ke=wt(ae.direction);if(!ke||ke.mode!==R)return;const Ce=`${ae.itemId}:${ke.fragmentId}`;M.has(Ce)||M.set(Ce,[]),M.get(Ce).push(ae)});const A={},J=new Set;M.forEach((ae,ke)=>{const[Ce,Ve]=ke.split(":",2);if(Ce!==he.cardId)return;const He=Bt(ae).score;A[Ve]=He,He>=Mt&&J.add(Ve)}),Lt.current=J,nt.current=A;const ee=wt(he.direction);if(ee!=null&&ee.fragmentId&&f.nodes[ee.fragmentId]){Gt(f,ee.fragmentId,j);return}const oe=ha(f,J,A,Mt,rt,he.direction);Gt(f,(oe==null?void 0:oe.id)??null,j)}).catch(()=>{Lt.current=new Set,nt.current={};const p=wt(he.direction);if(p!=null&&p.fragmentId&&f.nodes[p.fragmentId]){Gt(f,p.fragmentId,j);return}const R=ha(f,Lt.current,{},Mt,rt,he.direction);Gt(f,(R==null?void 0:R.id)??null,j)}),()=>{F=!1}},[he,t,rt,Mt]),a.useEffect(()=>{if(!he||he.cardType!=="vocab"||he.checkType!=="translation-match"){Q(null),xe({});return}const i=(at.pool??at.active??m).filter(p=>p.cardType==="vocab"&&p.checkType==="translation-match").filter((p,R,M)=>M.findIndex(A=>A.cardId===p.cardId)===R);i.some(p=>p.cardId===he.cardId)||i.unshift(he);const j=Wt(i).slice(0,6).map(p=>{const R=p.label.split("↔").map(J=>J.trim()).filter(Boolean);if(R.length<2)return null;const M=`${p.cardId}:L`,A=`${p.cardId}:R`;return{cardId:p.cardId,leftId:M,rightId:A,leftLabel:R[0],rightLabel:R[1]}}).filter(Boolean),f=j.map(p=>p.leftId),F=Wt(j.map(p=>p.rightId));Q({pairs:j,leftOrder:f,rightOrder:F,selection:{},activeLeft:null,activeRight:null,locked:{}})},[he,m,at]),a.useEffect(()=>()=>{K.current&&window.clearTimeout(K.current),le.current&&window.clearTimeout(le.current)},[]);const oa=a.useRef(null);a.useEffect(()=>{if(!he)return;const T=se(he),D=typeof document<"u"?document.activeElement:null;if(oa.current===T&&D&&(D.tagName==="INPUT"||D.tagName==="TEXTAREA"))return;let i=0;const u=()=>{if(he){if(he.cardType==="info"&&he.infoType==="computed"){if(H.length>0){const f=Ka(Ke,H,we),F=f?vt.current[f]:null;if(F&&(F.focus(),document.activeElement===F)){oa.current=T;return}}if(tt.current&&(tt.current.focus(),document.activeElement===tt.current)){oa.current=T;return}}else if(he.cardType==="vocab"&&tt.current&&(tt.current.focus(),document.activeElement===tt.current)){oa.current=T;return}i<6&&(i+=1,window.setTimeout(u,40))}},j=window.setTimeout(u,40);return()=>window.clearTimeout(j)},[he,H,Ke,we]),a.useEffect(()=>{if(!ft)return;const T=D=>{D.key==="Enter"&&(D.preventDefault(),la())};return window.addEventListener("keydown",T),()=>window.removeEventListener("keydown",T)},[ft]);const yt=T=>{pe(T),fe(Bt(T))};a.useEffect(()=>{if(!he){fe(null),pe([]);return}const T=he.cardType==="info"?"info":"connection";if(he.cardType==="info"&&he.infoType==="quote"){Kt().then(D=>{const i=D.filter(u=>u.itemType==="info"&&u.itemId===he.cardId&&u.checkType==="quote-fragment"&&_a(u.direction,he.direction));yt(i)}).catch(()=>{fe(null),pe([])});return}Fa(T,he.cardId,he.checkType,he.direction).then(D=>yt(D)).catch(()=>{fe(null),pe([])})},[he]);const Yt=(T,D,i,u)=>{if(T==="info"&&i==="quote-fragment"){Kt().then(j=>{const f=j.filter(F=>F.itemType==="info"&&F.itemId===D&&F.checkType==="quote-fragment"&&_a(F.direction,u));yt(f)}).catch(()=>{fe(null),pe([])});return}Fa(T,D,i,u).then(j=>yt(j)).catch(()=>{fe(null),pe([])})},Xt=(T,D,i)=>{var F;const u=((F=i.pairs.find(p=>p.leftId===T))==null?void 0:F.rightId)??null;if(!u)return i;const j=u===D;xe(p=>({...p,[T]:j?"correct":"incorrect"})),K.current&&window.clearTimeout(K.current),le.current&&window.clearTimeout(le.current),re.current+=1;const f={kind:j?"correct":"incorrect",tick:re.current};if(qe(null),K.current=window.setTimeout(()=>qe(f),0),le.current=window.setTimeout(()=>qe(null),420),j){const p={...i.locked,[T]:!0};return Object.keys(p).length>=i.pairs.length?(de("correct"),ze(!0)):de("correct"),{...i,selection:{...i.selection,[T]:D},activeLeft:null,activeRight:null,locked:p}}return de("incorrect"),{...i,activeLeft:null,activeRight:null}},ka=T=>{Q(D=>!D||D.locked[T]?D:D.activeRight?Xt(T,D.activeRight,D):{...D,activeLeft:D.activeLeft===T?null:T})},Ta=T=>{Q(D=>D&&(D.activeLeft?Xt(D.activeLeft,T,D):{...D,activeRight:D.activeRight===T?null:T}))},la=()=>{var T;if(he&&he.cardType==="info"&&he.infoType==="quote"&&lt.current&&ue&&!((T=wt(he.direction))!=null&&T.fragmentId)){const D=ha(lt.current,Lt.current,nt.current,Mt,rt,he.direction,ue.fragmentId);if(D){de(null),ce(""),$(!1),ye({}),ze(!1),Te(null),Ue(0),Gt(lt.current,D.id,ue.title);return}}de(null),ce(""),$(!1),ye({}),ze(!1),Te(null),Ue(0),Z(D=>Math.min(D+1,m.length))},At=T=>{if(!he)return;const D=T.expected??null,i=T.answer??"";let u=D??"",j=i;if(!D&&T.expectedMap&&T.answerMap){const J=Object.keys(T.expectedMap).sort((ee,oe)=>ee.localeCompare(oe));u=J.map(ee=>{var oe;return((oe=T.expectedMap)==null?void 0:oe[ee])??""}).join("|"),j=J.map(ee=>{var oe;return((oe=T.answerMap)==null?void 0:oe[ee])??""}).join("|")}const f=u?ga(u,j,zt):new Uint8Array,F={revisionType:Ee.id,evalType:T.evalType,direction:T.direction,prompt:S??"",expected:D,answer:i,expectedAnswers:T.expectedMap??null,answers:T.answerMap??null,correct:T.correct,maskBase64:f.length?Qt(f):null,checkMode:dt,compareMode:zt,minCorrectness:gt},p=new TextEncoder().encode(JSON.stringify(F)),R=he.cardType==="info"?"info":"connection",M=T.overrideCheckType??he.checkType??null,A=T.overrideDirection??he.direction??null;Aa({itemType:R,itemId:he.cardId,checkType:M,direction:A,revisionType:Ee.id,evalType:T.evalType,correct:T.correct,maskBase64:f.length?Qt(f):null,payloadBase64:Qt(p)}).then(()=>{Yt(R,he.cardId,M,A),pa(m)}).catch(()=>{})},ca=(T,D)=>{const i=kt.current.get(D);if(i)return Promise.resolve(i);const u=qt.current.get(D);if(u)return u;const j=Dn({shareCode:d,infoId:T,key:Ye}).then(f=>{var J,ee;const F=f.payload,p=((J=F.definition)==null?void 0:J.graph)??null,R="",M=((ee=F.definition)==null?void 0:ee.answerTemplate)??"",A=Zs(p,R,M);if(A){const ae={sample:en(A),answerTemplate:M||null};return kt.current.set(D,ae),ae}return xs({shareId:d,infoId:T,key:Ye}).then(oe=>{const ae={sample:oe,answerTemplate:null};return kt.current.set(D,ae),ae})}).catch(()=>xs({shareId:d,infoId:T,key:Ye}).then(f=>{const F={sample:f,answerTemplate:null};return kt.current.set(D,F),F}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{qt.current.delete(D)});return qt.current.set(D,j),j},St=(T,D)=>{var p;const i=`${se(T)}:${D}`,u=Ot.current.get(i);if(u)return Promise.resolve(u);const j=ut.current.get(i);if(j)return j;const f=R=>(Ot.current.set(i,R),R);let F;if(T.cardType==="vocab"){if(T.checkType==="translation-match")return F=Promise.resolve(f({prompt:T.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),F;const R=T.label.split("↔").map(M=>M.trim()).filter(Boolean);if(R.length>=2){const A=(T.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",J=A?R[0]:R[1],ee=A?R[1]:R[0];F=Promise.resolve(f({prompt:J,expectedAnswer:ee,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else F=Promise.resolve(f({prompt:T.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(T.cardType==="info"&&T.infoType==="word"){const R=(p=T.description)!=null&&p.startsWith("Language: ")?T.description.replace("Language: ",""):null;F=Promise.resolve(f({prompt:T.label,expectedAnswer:R,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else T.cardType==="info"&&T.infoType==="computed"?F=ca(T.cardId,i).then(R=>{var oe,ae;if(!R.sample)return f({prompt:T.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const M=R.sample,A=M.expectedAnswers?Object.entries(M.expectedAnswers).map(([ke,Ce])=>({key:ke,expected:Ce})):[],J=A.reduce((ke,Ce)=>(ke[Ce.key]="",ke),{}),ee=M.expectedAnswerIsSentence&&((oe=M.expectedAnswer)==null?void 0:oe.trim())||null;return f({prompt:M.prompt,expectedAnswer:A.length>0?ee:((ae=M.expectedAnswer)==null?void 0:ae.trim())||null,computedExpected:A,computedAnswers:J,answerTemplate:R.answerTemplate,outputVariables:M.outputVariables??null,variableValues:M.variableValues??null})}).catch(()=>f({prompt:T.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{ut.current.delete(i)}):F=Promise.resolve(f({prompt:T.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return ut.current.set(i,F),F},Gt=(T,D,i)=>{const u=Object.keys(T.nodes).length,j=Lt.current.size;if(!D){B({title:i,before:T.text,after:"",fragmentId:null,total:u,completed:j}),V(null),ze(!0);return}const f=T.nodes[D];if(!f)return;const F=Ys(T.text,f);B({title:i,before:F.before,after:F.after,fragmentId:f.id,total:u,completed:j}),V(F.fragment),ze(!1)},ba=()=>{const T=lt.current;T&&B(D=>D&&{...D,total:Object.keys(T.nodes).length,completed:Lt.current.size})},Pt=()=>{const T=m[P+1];T&&St(T,P+1)},Sa=()=>{if(Pt(),he&&he.cardType==="vocab"&&he.checkType==="translation-match"&&q){if(q.pairs.length===0){de("incorrect"),ze(!0);return}const f=q.pairs.reduce((ee,oe)=>(ee[oe.rightId]=oe.rightLabel,ee),{});let F=0;const p={};q.pairs.forEach(ee=>{const ae=q.selection[ee.leftId]===ee.rightId;p[ee.leftId]=ae?"correct":"incorrect",ae&&(F+=1)});const R=q.pairs.length||1,M=F/R,A=F===q.pairs.length;xe(ee=>({...ee,...p})),A?(de("correct"),ze(!0),Ue(0)):(de("incorrect"),ze(!1),Ue(ee=>{const oe=ee+1;return oe>=jt&&($(!0),ze(!0),Q(ae=>{if(!ae)return ae;const ke=ae.pairs.reduce((Ce,Ve)=>(Ce[Ve.leftId]=Ve.rightId,Ce),{});return{...ae,selection:ke}})),oe})),bt(A,M);const J="connection";Promise.all(q.pairs.map(ee=>{const oe=q.selection[ee.leftId]??null,ae=oe?f[oe]:"",ke={left:ee.leftLabel,expected:ee.rightLabel,answer:ae,checkType:"translation-match"},Ce=new TextEncoder().encode(JSON.stringify(ke));return Aa({itemType:J,itemId:ee.cardId,checkType:"translation-match",direction:null,revisionType:Ee.id,evalType:"translation-match",correct:oe===ee.rightId,maskBase64:null,payloadBase64:Qt(Ce)})})).then(()=>{Yt(J,he.cardId,he.checkType,he.direction),pa(m)}).catch(()=>{});return}if(H.length>0){const f=H.reduce((p,R)=>{const M=Se[R.key]??"";return p[R.key]=xt(M)===xt(R.expected)?"correct":"incorrect",p},{});H.every(({key:p,expected:R})=>{const M=Se[p]??"";return dt==="exact"&&xt(M)===xt(R)})?(de("correct"),ye(f),ze(!0),Ue(0),bt(!0,1),At({correct:!0,direction:S?`${S} -> computed`:"computed",expectedMap:H.reduce((p,R)=>(p[R.key]=R.expected,p),{}),answerMap:Se,evalType:"computed"})):(de("incorrect"),ye(f),ze(!1),Ue(p=>{const R=p+1;return R>=jt&&Jt&&($(!0),ze(!0)),R}),bt(!1,0),window.setTimeout(()=>{var R;const p=Ka(Ke,H,we);p&&vt.current[p]&&((R=vt.current[p])==null||R.focus())},40),At({correct:!1,direction:S?`${S} -> computed`:"computed",expectedMap:H.reduce((p,R)=>(p[R.key]=R.expected,p),{}),answerMap:Se,evalType:"computed"}));return}if(he&&he.cardType==="info"&&he.infoType==="quote"&&(ue!=null&&ue.fragmentId)){if(!x)return;const f=wt(he.direction),F=(f==null?void 0:f.mode)??getQuoteMode(he.direction),p=f!=null&&f.fragmentId&&he.direction?he.direction:wa(F,ue.fragmentId),R=rn(x,ne,zt),M=dt==="exact"&&fa(ne)===fa(x),A=na(R),J=M||A,ee=Ht(R);J?(nt.current[ue.fragmentId]=Math.max(nt.current[ue.fragmentId]??0,ee),(nt.current[ue.fragmentId]??0)>=Mt&&Lt.current.add(ue.fragmentId),ba(),de("correct"),ye({}),ze(!0),Te(R),Ue(0),ee<100&&jt<=1&&$(!0),bt(!0,ee/100),At({correct:!0,direction:`quote:${ue.fragmentId}`,expected:x,answer:ne,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:p})):(de("incorrect"),ye({}),ze(!1),Te(R),Ue(oe=>{const ae=oe+1;return ae>=jt&&Jt&&($(!0),ze(!0)),ae}),bt(!1,ee/100),window.setTimeout(()=>{var oe;return(oe=tt.current)==null?void 0:oe.focus()},40),At({correct:!1,direction:`quote:${ue.fragmentId}`,expected:x,answer:ne,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:p}));return}if(!x)return;const T=ga(x,ne,zt),D=dt==="exact"&&xt(ne)===xt(x),i=na(T),u=D||i,j=Ht(T);u?(de("correct"),ye({}),ze(!0),Te(T),Ue(0),j<100&&jt<=1&&$(!0),bt(!0,j/100),At({correct:!0,direction:S?`${S} -> ${x}`:null,expected:x,answer:ne,evalType:"text"})):(de("incorrect"),ye({}),ze(!1),Te(T),Ue(f=>{const F=f+1;return F>=jt&&Jt&&($(!0),ze(!0)),F}),bt(!1,j/100),window.setTimeout(()=>{var f;return(f=tt.current)==null?void 0:f.focus()},40),At({correct:!1,direction:S?`${S} -> ${x}`:null,expected:x,answer:ne,evalType:"text"}))},da=T=>{if(Pt(),!x)return;const D=ga(x,T,zt),i=xt(T)===xt(x),u=na(D),j=i||u,f=Ht(D);j?(de("correct"),ye({}),ze(!0),Te(D),Ue(0),f<100&&jt<=1&&$(!0),bt(!0,f/100),At({correct:!0,direction:"word->language",expected:x,answer:T,evalType:"language-select"})):(de("incorrect"),ye({}),ze(!1),Te(D),Ue(F=>{const p=F+1;return p>=jt&&Jt&&($(!0),ze(!0)),p}),bt(!1,f/100),At({correct:!1,direction:"word->language",expected:x,answer:T,evalType:"language-select"}))},Ca=T=>{var i;if(T.key!=="Enter")return;if(T.preventDefault(),T.stopPropagation(),ft){la();return}const D=H.find(u=>!(Se[u.key]??"").trim());if(D){(i=vt.current[D.key])==null||i.focus();return}Sa()},Qa=()=>{Pt(),de("correct"),ze(!0),Ue(0),bt(!0,1),x&&At({correct:!0,direction:"manual",expected:x,answer:ne,evalType:"manual"})},Wa=()=>{if(bt(!1,0),he&&he.cardType==="info"&&he.infoType==="quote"){de(null),ce(""),$(!1),ye({}),ze(!1),Te(null),Ue(0),Z(T=>Math.min(T+1,m.length));return}la()};a.useEffect(()=>{Pt()},[P,m]);const Ya=t.cogita.library.revision.revealModeAfterIncorrect,Jt=H.length>0||!!x;return e.jsxs(Nt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:o,onToggleSecureMode:c,onLogout:g,secureMode:b,onNavigate:y,language:E,onLanguageChange:w,children:[(r==="loading"||z==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:r==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${G.total?Math.min(100,Math.max(0,G.current/G.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:G.total?`${Math.min(G.current,G.total)} / ${G.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:ie}),e.jsx("p",{className:"cogita-library-subtitle",children:U}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",Ct).replace("{check}",$t)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:O?`${O.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Tt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Tt.currentLevel??"-"," / ",Tt.levelsCount]}):null,O?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(O.correct)).replace("{total}",String(O.total))}),O.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(O.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(an,{outcomes:be})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[Ae?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:Ae})}):null,e.jsx("section",{className:"cogita-revision-card","data-feedback":$e?`${$e.kind}-${$e.tick}`:Vt?"idle":Ie??"idle",children:r!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:r==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):he?e.jsx(e.Fragment,{children:C?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(tn,{copy:t,currentCard:he,currentTypeLabel:Ut,prompt:S,languages:_,answer:ne,onAnswerChange:T=>ce(D=>Ba(D,T,L)),computedExpected:H,computedAnswers:Se,onComputedAnswerChange:(T,D)=>je(i=>({...i,[T]:Ba(i[T]??"",D,L)})),answerTemplate:Ke,outputVariables:we,variableValues:et,computedFieldFeedback:Re,feedback:Ie,canAdvance:ft,quoteContext:ue,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Sa,onSkip:Wa,onLanguageSelect:da,onMarkReviewed:Qa,onAdvance:la,showCorrectAnswer:ve,setShowCorrectAnswer:$,onRevealCorrect:()=>ze(!0),answerMask:Fe,expectedAnswer:x,hasExpectedAnswer:Jt,handleComputedKeyDown:Ca,answerInputRef:tt,computedInputRefs:vt,scriptMode:L,setScriptMode:X,matchPairs:q==null?void 0:q.pairs,matchLeftOrder:q==null?void 0:q.leftOrder,matchRightOrder:q==null?void 0:q.rightOrder,matchSelection:q==null?void 0:q.selection,matchActiveLeft:q==null?void 0:q.activeLeft,matchActiveRight:q==null?void 0:q.activeRight,matchFeedback:De,onMatchLeftSelect:ka,onMatchRightSelect:Ta})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:sa?`${Rt} / ${sa}`:t.cogita.library.revision.progressUnlimited}),r==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),r==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),r==="ready"&&z==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),r==="ready"&&z==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),r==="ready"&&z==="ready"&&m.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Ya}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",jt]})]})]}),Tt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Tt.activeCount," / ",Tt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Tt.counts.map((T,D)=>{const i=D+1,u=Tt.currentLevel===i,j=Tt.percentages[D]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":u,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:i}),e.jsx("strong",{children:T})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,j))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[j.toFixed(1),"%"]})]},`level-${i}`)})})]}):null,ra?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:ra.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:ra.dots.map(T=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-T.value))}, ${Math.round(200*T.value)}, 80, 0.9)`}},T.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:ra.knownCount})]})]}):null,rt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Et})]})}):null]})]})]})})})]})]})}const Hi=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:qi},Symbol.toStringTag,{value:"Module"}));export{Ui as C,zi as a,Hi as b};
