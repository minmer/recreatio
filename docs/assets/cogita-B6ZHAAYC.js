import{r as a,j as e,u as mn,a as Ja,b as Hn,c as Wn,d as Qn,R as pn,B as fn,C as bn,Q as ur}from"./vendor-CAC2WLor.js";import{L as zs,A as Os,g as Vs,a as hr,b as Va,c as Gn,s as ls,d as Yn,e as gr,f as In,h as na,i as mr,j as pr,k as tn,l as an,m as qs,n as Xn,o as qn,p as fr,u as cs,q as Us,r as br,t as yr,v as xr,w as vr,x as jr,y as Js,z as wr,B as Hs,C as Ws,D as kr,E as Nr,F as yn,G as qa,H as Sr,I as Qs,J as Tr,K as Zn,M as Gs,N as Cr,O as Ir,P as Mr,Q as Un,R as ya,S as Lr,T as Ar,U as $r,V as Rr,W as Pr,X as Er,Y as Fr,Z as Kr,_ as _r,$ as Dr,a0 as Br,a1 as zr,a2 as Or,a3 as ds,a4 as Vr,a5 as qr,a6 as Ur,a7 as Jr,a8 as us,a9 as Hr,aa as Wr}from"./recreatio-core-B12ledQl.js";import"./vendor-cogita-ui-DTaQ_FiW.js";const Ba={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},Ka={moveMs:900,pauseMs:220,errorMs:900},Qr=(t=11)=>{let n=t;const r=()=>(n=(n*1664525+1013904223)%4294967296,n/4294967296),{width:s,height:o,paddingX:h,paddingY:c,levels:w}=Ba,f=(o-c*2)/(w.length-1),k=[],i=[],p=[];w.forEach((v,y)=>{const K=o-c-y*f,q=s-h*2,x=[];for(let W=0;W<v;W+=1){const m=h+(W+1)*q/(v+1),D=(r()-.5)*18,$=Math.max(h,Math.min(s-h,m+D)),T=y===0?3:y<2?2.1:1.4,he=y===0?"root":`l${y}-${W}`;x.push({id:he,x:y===0?s/2:$,y:K,r:T,level:y,role:y===0?"root":void 0})}p.push(x),k.push(...x)});const l=p[p.length-1];if(l!=null&&l.length){const v=l[Math.floor(l.length/2)];v.role="goal",v.r=2}for(let v=1;v<p.length;v+=1){const y=p[v-1];p[v].forEach(q=>{const x=[...y].sort(($,T)=>Math.abs($.x-q.x)-Math.abs(T.x-q.x)),W=x[0],m=x[1]&&r()<.45?x[1]:null;(m?[W,m]:[W]).forEach($=>{i.push({from:$.id,to:q.id,key:`${$.id}-${q.id}`})}),r()<.2&&x[2]&&i.push({from:x[2].id,to:q.id,key:`${x[2].id}-${q.id}`})})}const d=new Map;i.forEach(v=>{const y=d.get(v.to)??[];y.push(v.from),d.set(v.to,y)});const j=new Map,g=new Map,S=new Map;i.forEach(v=>{const y=j.get(v.from)??[];y.push(v.key),j.set(v.from,y);const K=g.get(v.from)??[];K.push(v.to),g.set(v.from,K);const q=S.get(v.from)??[];q.push(v.to),S.set(v.from,q);const x=S.get(v.to)??[];x.push(v.from),S.set(v.to,x)});const V=new Map;return k.forEach(v=>{V.set(v.id,v)}),{nodes:k,links:i,parentsById:d,linksByFrom:j,childrenByFrom:g,neighborsById:S,nodesById:V}};function Gr({slides:t,activeIndex:n,introOpen:r,prefersReducedMotion:s,onNext:o,onPrev:h,onSelect:c,onExit:w,onOpen:f,onRegister:k}){const i=n===t.length-1,p=r&&n===0?"entry":"docked",l=t[t.length-1],[d,j]=a.useState(!1),g=a.useMemo(()=>Array.from({length:20},(B,E)=>({src:`/cogita/logo/Cogita${String(E).padStart(2,"0")}.png`,kind:E<=11?"bubble":E<=17?"text":"recreatio"})),[]),S=r&&n===0;a.useEffect(()=>{if(!r){j(!1);return}n>0&&!d&&j(!0)},[n,r,d]);const V=a.useRef(0),v=a.useRef(null),y=a.useMemo(()=>{const B={x:40,y:160},E={x:260,y:48},N=6,C=E.x-B.x,L=B.y-E.y,ue=C/N,be=[.3,.45,.6,.65,1.4,2.2],ge=be.reduce((Q,ee)=>Q+ee,0),Z=be.map(Q=>L*Q/ge),P=[B];let G=B.x,re=B.y;for(let Q=1;Q<=N;Q+=1){const ee=(Math.random()-.5)*14,ye=(Math.random()-.5)*28;G=Math.max(B.x+Q*14,Math.min(E.x-(N-Q)*14,G+ue+ee));const U=Z[Q-1]??Z[Z.length-1];re=re-U+ye;const ie=Math.max(E.y,Math.min(B.y-4,re));P.push({x:Math.round(G),y:Math.round(ie)})}return P[P.length-1]=E,P},[]),K=a.useMemo(()=>{const L=(ge,Z,P)=>Math.min(P,Math.max(Z,ge)),ue=y.map(ge=>{const Z=10+Math.random()*36;return{x:L(ge.x,40,260),y:L(ge.y-Z,40,140)}}),be=y.map((ge,Z)=>{var re;const P=12+Math.random()*40,G=((re=ue[Z])==null?void 0:re.y)??ge.y;return{x:L(ge.x,40,260),y:L(Math.max(G+10,ge.y+P),60,170)}});return{upper:ue,lower:be}},[y]),q=a.useMemo(()=>{var E;const B=((E=y[4])==null?void 0:E.x)??260;return Math.max(0,Math.min(240,B-40))},[y]),x=a.useMemo(()=>{var Z,P;const B=(G,re,Q)=>Math.min(Q,Math.max(re,G)),E=(G,re,Q)=>y.map((ee,ye)=>{var bt,mt;const U=((bt=K.upper[ye])==null?void 0:bt.y)??ee.y,ie=((mt=K.lower[ye])==null?void 0:mt.y)??ee.y,Le=(Math.random()-.5)*70,qe=ee.y+G+Le,Ke=B(ee.y+re,U+6,ie-6),Je=B(ee.y+Q,U+6,ie-6);return{x:ee.x,y:B(qe,Math.min(Ke,Je),Math.max(Ke,Je))}}),N=-14+Math.random()*28,C=14+Math.random()*28,L=E(N,-80,12),ue=E(C,-12,80);for(let G=4;G<y.length;G+=1){const re=y[G],Q=((Z=K.upper[G])==null?void 0:Z.y)??re.y,ee=((P=K.lower[G])==null?void 0:P.y)??re.y;L[G]={x:re.x,y:B(re.y-12,Q+6,ee-6)},ue[G]={x:re.x,y:B(re.y+12,Q+6,ee-6)}}const be=K.upper.length?K.upper[K.upper.length-1].y:40,ge=K.lower.length?K.lower[K.lower.length-1].y:170;return L[L.length-1]={x:y[y.length-1].x,y:B(y[y.length-1].y-14,be,ge)},ue[ue.length-1]={x:y[y.length-1].x,y:B(y[y.length-1].y+12,be,ge)},{higher:L,lower:ue}},[y,K]),W=1e4,m=a.useMemo(()=>{let B=17;const E=()=>(B=(B*1664525+1013904223)%4294967296,B/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((C,L)=>{const ue=(E()-.5)*240,be=(E()-.5)*180,ge=(E()-.5)*24;return{id:`card-${L+1}`,throw:{x:`${ue.toFixed(0)}px`,y:`${be.toFixed(0)}px`,rot:`${ge.toFixed(1)}deg`},grid:{x:`${C.x}px`,y:`${C.y}px`},delay:`${L*.12}s`}})},[]),D=a.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[$,T]=a.useState([]),he=a.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),ne=a.useMemo(()=>{const E=[],C=(ue,be)=>ue+Math.random()*(be-ue);for(let ue=0;ue<6;ue+=1){let be=!1;for(let ge=0;ge<80;ge+=1){const Z=C(14,86),P=C(10,34);if(E.every(re=>{const Q=re.x-Z,ee=re.y-P;return Math.hypot(Q,ee)>=12})){E.push({x:Z,y:P}),be=!0;break}}be||E.push({x:C(16,84),y:C(12,32)})}return E.map((ue,be)=>({id:`p${be+1}`,x:`${ue.x.toFixed(1)}%`,y:`${ue.y.toFixed(1)}%`,xNum:ue.x,yNum:ue.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[je,De]=a.useState(0),[R,I]=a.useState(0),[X,_]=a.useState([]),te=1e4,Y=a.useMemo(()=>{if(ne.length<2)return[];const B=be=>{let ge=be+1831565813;return ge=Math.imul(ge^ge>>>15,ge|1),ge^=ge+Math.imul(ge^ge>>>7,ge|61),((ge^ge>>>14)>>>0)/4294967296},E=(be,ge)=>Math.floor(B(be)*ge),N=new Set,C=[],L=Math.min(3,ne.length);let ue=0;for(;C.length<L&&ue<30;){ue+=1;const be=E(je*13+ue*5,ne.length),ge=E(je*29+ue*7,ne.length);if(be===ge)continue;const Z=be<ge?`${be}-${ge}`:`${ge}-${be}`;N.has(Z)||(N.add(Z),C.push({id:`link-${Z}`,from:ne[be],to:ne[ge],delay:`${(ue*.35).toFixed(2)}s`}))}return C},[je,ne]);a.useEffect(()=>{if(!r||n!==2)return;const B=()=>{const N=m.map(C=>C.id);for(let C=N.length-1;C>0;C-=1){const L=Math.floor(Math.random()*(C+1));[N[C],N[L]]=[N[L],N[C]]}return N.slice(0,4)};T(B());const E=window.setInterval(()=>{T(B())},W);return()=>window.clearInterval(E)},[n,r,m,W]),a.useEffect(()=>{if(!r||n!==3)return;const B=()=>{I(Math.floor(Math.random()*he.length)),_(ne.map(()=>Math.random()<.6?"good":"bad")),De(N=>N+1)};B();const E=window.setInterval(B,te);return()=>window.clearInterval(E)},[n,r,he.length,ne,te]);const xe=a.useMemo(()=>Qr(11),[]),[le,se]=a.useState(new Set(["root"])),[Te,Ae]=a.useState(new Set),[Ee,$e]=a.useState(new Set),[et,ct]=a.useState({fromId:"root",toId:"root",key:0}),Ce=a.useRef(le),We=a.useRef("root"),xt=a.useRef(0),Ve=a.useRef(null),Be=a.useRef(null),tt=a.useRef([]);a.useEffect(()=>{Ce.current=le},[le]);const ot=a.useMemo(()=>{const B=new Set;return le.forEach(E=>{const N=xe.linksByFrom.get(E);N&&N.forEach(C=>B.add(C))}),B},[le,xe]),Ye=xe.nodesById.get(et.toId)??xe.nodesById.get("root"),Ie=Ye?`${Ye.x/Ba.width*100}%`:"50%",ze=Ye?`${Ye.y/Ba.height*100}%`:"90%";a.useEffect(()=>{if(!r||n!==1||s)return;(()=>{se(new Set(["root"])),Ae(new Set),$e(new Set),ct({fromId:"root",toId:"root",key:0}),Be.current=null,xt.current=0,We.current="root",tt.current=[]})();const E=()=>{const C=We.current,L=Ce.current,be=(xe.childrenByFrom.get(C)??[]).filter(ee=>!L.has(ee));if(be.length)return be[Math.floor(Math.random()*be.length)];if(L.size>=xe.nodes.length){const ee=xe.neighborsById.get(C)??[];return ee.length?ee[Math.floor(Math.random()*ee.length)]:null}const ge=ee=>(xe.childrenByFrom.get(ee)??[]).some(U=>!L.has(U)),Z=[C],P=new Set([C]),G=new Map;let re=null;for(;Z.length;){const ee=Z.shift();if(!ee)break;if(ee!==C&&ge(ee)){re=ee;break}(xe.neighborsById.get(ee)??[]).forEach(U=>{P.has(U)||(P.add(U),G.set(U,ee),Z.push(U))})}if(!re)return null;let Q=re;for(;G.get(Q)&&G.get(Q)!==C;)Q=G.get(Q)??Q;return Q},N=(C,L)=>{if(C===L){const ue=E();ue&&N(C,ue);return}xt.current+=1,ct({fromId:C,toId:L,key:xt.current}),We.current=L,Ve.current=window.setTimeout(()=>{const ue=xe.parentsById.get(L)??[],be=Ce.current,ge=ue.filter(re=>!be.has(re));if(!ge.length){const re=new Set(be);re.add(L),se(re),Ve.current=window.setTimeout(()=>{for(;tt.current.length;){const ee=tt.current[tt.current.length-1];if(!re.has(ee)){if(ee!==L){N(L,ee);return}break}tt.current.pop()}const Q=E();Q&&N(L,Q)},Ka.pauseMs);return}const Z=new Set([L,...ge]),P=new Set(ge.map(re=>`${re}-${L}`));Ae(Z),$e(P),tt.current.includes(L)||tt.current.push(L);const G=ge[Math.floor(Math.random()*ge.length)];Be.current={fromId:L,toId:G},Ve.current=window.setTimeout(()=>{Ae(new Set),$e(new Set);const re=Be.current;re&&N(re.fromId,re.toId)},Ka.errorMs)},Ka.moveMs)};return Ve.current=window.setTimeout(()=>{const C=E();C&&N(We.current,C)},Ka.pauseMs),()=>{Ve.current&&window.clearTimeout(Ve.current)}},[n,r,xe,s]);const Xe=B=>{if(!r)return;const E=Date.now();E-V.current<520||Math.abs(B.deltaY)<10||(V.current=E,B.deltaY>0?o():h(),B.preventDefault())},F=B=>{if(!r)return;const E=B.touches[0];E&&(v.current={x:E.clientX,y:E.clientY})},A=B=>{if(!r)return;const E=v.current;if(v.current=null,!E)return;const N=B.changedTouches[0];if(!N)return;const C=N.clientX-E.x,L=N.clientY-E.y;Math.abs(L)<40||Math.abs(L)<Math.abs(C)||(L<0?o():h())};return e.jsxs("div",{className:`cogita-intro ${r?"is-open":"is-closed"} ${s?"is-reduced":""} ${i?"is-final":""}`,"data-slide":n+1,onWheel:Xe,onTouchStart:F,onTouchEnd:A,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":p,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${S&&!d?"is-entry":""}`,children:g.map((B,E)=>e.jsx("img",{src:B.src,alt:"",className:`cogita-logo-layer ${E===0?"is-base":""} ${B.kind==="text"?"is-text":B.kind==="recreatio"?"is-recreatio":""} ${B.kind==="bubble"?"is-bubble":""}`},B.src))})}),r&&t.map((B,E)=>{const N=E===n;return e.jsxs("section",{className:`cogita-intro-slide slide-${E+1} ${N?"is-active":""}`,"aria-hidden":!N,children:[e.jsxs("div",{className:"cogita-intro-text",children:[B.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:B.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:B.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:B.title}),B.body&&e.jsx("p",{children:B.body.split(`
`).map((C,L)=>e.jsxs("span",{children:[C,L===0&&e.jsx("br",{})]},String(L)))})]}),B.micro&&e.jsx("p",{className:"cogita-intro-micro",children:B.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:i?k:o,children:B.cta}),i&&B.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>c(0),children:B.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[E===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${Ba.width} ${Ba.height}`,preserveAspectRatio:"none",children:[xe.links.map(C=>{const L=xe.nodesById.get(C.from),ue=xe.nodesById.get(C.to);if(!L||!ue)return null;const be=ot.has(C.key),ge=Ee.has(C.key);return e.jsx("line",{className:`map-link ${be?"is-active":""} ${ge?"is-error":""}`,x1:L.x,y1:L.y,x2:ue.x,y2:ue.y},C.key)}),xe.nodes.map(C=>{const L=le.has(C.id),ue=Te.has(C.id);return e.jsx("circle",{className:`map-node ${C.role?`is-${C.role}`:""} ${L?"is-active":""} ${ue?"is-error":""}`,cx:C.x,cy:C.y,r:C.r},C.id)})]}),Ye&&e.jsx("span",{className:"map-explorer-dot",style:{left:Ie,top:ze,"--move":`${Ka.moveMs}ms`}})]}),E===2&&e.jsx("div",{className:"cogita-index-cards",children:m.map(C=>{const L=$.indexOf(C.id),ue=L>=0?D[L]:null,be=(ue==null?void 0:ue.x)??"140px",ge=(ue==null?void 0:ue.y)??"140px",Z=L>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":C.throw.x,"--throw-y":C.throw.y,"--throw-rot":C.throw.rot,"--grid-x":C.grid.x,"--grid-y":C.grid.y,"--stack-x":be,"--stack-y":ge,"--stack-opacity":Z,"--delay":C.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},C.id)})}),E===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[he.map((C,L)=>e.jsxs("div",{className:`round-card ${L===R?"is-active":""}`,style:{"--card-x":C.x,"--card-y":C.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},C.id)),he[R]&&e.jsx("span",{className:"round-ring",style:{"--card-x":he[R].x,"--card-y":`calc(${he[R].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:ne.map(C=>e.jsx("span",{className:"player-dot",style:{left:C.x,top:C.y,"--jitter-x":C.jitterX,"--jitter-y":C.jitterY,"--breath-delay":C.delay}},C.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:Y.map(C=>e.jsx("line",{className:"round-link",x1:C.from.xNum,y1:C.from.yNum,x2:C.to.xNum,y2:C.to.yNum,style:{"--delay":C.delay}},C.id))}),e.jsx("div",{className:"round-flows",children:ne.map((C,L)=>{const ue=X[L]??"good",be=he[R];if(!be)return null;const ge=`calc(${be.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":C.x,"--from-y":C.y,"--to-x":be.x,"--to-y":ge,"--delay":`${L*.12}s`}}),e.jsx("span",{className:`return-dot is-${ue}`,style:{"--from-x":be.x,"--from-y":ge,"--to-x":C.x,"--to-y":C.y,"--delay":`${L*.12}s`}}),e.jsx("span",{className:`result-pop is-${ue}`,style:{"--at-x":C.x,"--at-y":C.y,"--delay":`${L*.12}s`}})]},`${C.id}-${je}`)})})]},`round-${je}`),E===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${y[0].x} ${y[0].y} L${y[1].x} ${y[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${y[1].x} ${y[1].y} L${y[2].x} ${y[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${y[2].x} ${y[2].y} L${y[3].x} ${y[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${y[3].x} ${y[3].y} L${y[4].x} ${y[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${y[4].x} ${y[4].y} L${y[5].x} ${y[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${y[5].x} ${y[5].y} L${y[6].x} ${y[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${q};${q};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${K.upper.map((C,L)=>`${L===0?"M":"L"}${C.x} ${C.y}`).join(" ")} ${K.lower.slice().reverse().map(C=>`L${C.x} ${C.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${K.upper.map((C,L)=>`${L===0?"M":"L"}${C.x} ${C.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${K.lower.map((C,L)=>`${L===0?"M":"L"}${C.x} ${C.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[x.higher.slice(0,6).map((C,L)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${L+1}`,d:`M${C.x} ${C.y} L${x.higher[L+1].x} ${x.higher[L+1].y}`,pathLength:"100"},`peer-1-${L}`)),x.lower.slice(0,6).map((C,L)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${L+1}`,d:`M${C.x} ${C.y} L${x.lower[L+1].x} ${x.lower[L+1].y}`,pathLength:"100"},`peer-2-${L}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${y[0].x/300*100}%`,"--p0y":`${y[0].y/200*100}%`,"--p1x":`${y[1].x/300*100}%`,"--p1y":`${y[1].y/200*100}%`,"--p2x":`${y[2].x/300*100}%`,"--p2y":`${y[2].y/200*100}%`,"--p3x":`${y[3].x/300*100}%`,"--p3y":`${y[3].y/200*100}%`,"--p4x":`${y[4].x/300*100}%`,"--p4y":`${y[4].y/200*100}%`,"--p5x":`${y[5].x/300*100}%`,"--p5y":`${y[5].y/200*100}%`,"--p6x":`${y[6].x/300*100}%`,"--p6y":`${y[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${x.higher[0].x/300*100}%`,"--q0y":`${x.higher[0].y/200*100}%`,"--q1x":`${x.higher[1].x/300*100}%`,"--q1y":`${x.higher[1].y/200*100}%`,"--q2x":`${x.higher[2].x/300*100}%`,"--q2y":`${x.higher[2].y/200*100}%`,"--q3x":`${x.higher[3].x/300*100}%`,"--q3y":`${x.higher[3].y/200*100}%`,"--q4x":`${x.higher[4].x/300*100}%`,"--q4y":`${x.higher[4].y/200*100}%`,"--q5x":`${x.higher[5].x/300*100}%`,"--q5y":`${x.higher[5].y/200*100}%`,"--q6x":`${x.higher[6].x/300*100}%`,"--q6y":`${x.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${x.lower[0].x/300*100}%`,"--q0y":`${x.lower[0].y/200*100}%`,"--q1x":`${x.lower[1].x/300*100}%`,"--q1y":`${x.lower[1].y/200*100}%`,"--q2x":`${x.lower[2].x/300*100}%`,"--q2y":`${x.lower[2].y/200*100}%`,"--q3x":`${x.lower[3].x/300*100}%`,"--q3y":`${x.lower[3].y/200*100}%`,"--q4x":`${x.lower[4].x/300*100}%`,"--q4y":`${x.lower[4].y/200*100}%`,"--q5x":`${x.lower[5].x/300*100}%`,"--q5y":`${x.lower[5].y/200*100}%`,"--q6x":`${x.lower[6].x/300*100}%`,"--q6y":`${x.lower[6].y/200*100}%`}})]})})}),E===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),E===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},B.id)}),!r&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:l.title}),l.body&&e.jsx("p",{children:l.body}),l.micro&&e.jsx("p",{className:"cogita-intro-micro",children:l.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:k,children:l.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:f,children:"Otwórz pokaz"})]})]})})]}),r&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((B,E)=>e.jsx("button",{type:"button",className:`dot ${n===E?"active":""}`,"aria-label":B.title,onClick:()=>c(E)},B.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:w,children:"Pomiń"})]})]})}const Yr=6,Xr=4;function Zr({copy:t,onAuthAction:n,authLabel:r,showProfileMenu:s,onProfileNavigate:o,onToggleSecureMode:h,onLogout:c,secureMode:w,onNavigate:f,language:k,onLanguageChange:i}){const p=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}f("home")},l=a.useRef(null),d=a.useRef([]),j=a.useMemo(()=>{let _=Date.now()%2147483647;const te=()=>(_=_*48271%2147483647,_/2147483647);return Array.from({length:Yr},(Y,xe)=>{const le=6+te()*8,se=7+te()*10,Te=6+te()*9,Ae=-te()*le,Ee=-te()*se,$e=-te()*Te,et=.18+te()*.28,ct=12+te()*18,Ce=4+te()*8,We=(te()-.5)*3.2,xt=(te()-.5)*3.8,Ve=te()>.5?"alternate":"alternate-reverse",Be=te()>.5?"alternate":"alternate-reverse",tt=te()>.5?"alternate":"alternate-reverse",ot=.18+te()*.42,Ye=30+te()*60,Ie=-45-te()*38,ze=188+te()*32,Xe=.1+te()*.2;return{id:`wave-${xe+1}`,style:{"--wave-sway-duration":`${le}s`,"--wave-scale-duration":`${se}s`,"--wave-drift-duration":`${Te}s`,"--wave-sway-delay":`${Ae}s`,"--wave-scale-delay":`${Ee}s`,"--wave-drift-delay":`${$e}s`,"--wave-sway-dir":Ve,"--wave-scale-dir":Be,"--wave-drift-dir":tt,"--wave-scale":`${et}`,"--wave-shift":`${ct}%`,"--wave-xshift":`${Ce}%`,"--wave-x0":`${We}%`,"--wave-y0":`${xt}%`,"--wave-opacity":`${ot}`,"--wave-blur":`${Ye}px`,"--wave-bottom":`${Ie}%`,"--wave-hue":`${ze}`,"--wave-glow":`${Xe}`}}})},[]),g=a.useMemo(()=>{let _=Date.now()*3%2147483647;const te=()=>(_=_*48271%2147483647,_/2147483647);return Array.from({length:Xr},(Y,xe)=>{const le=180+te()*220,se=220+te()*280,Te=-te()*le,Ae=-te()*se,Ee=.12+te()*.22,$e=3+te()*7,et=1+te()*3,ct=(te()-.5)*2.8,Ce=(te()-.5)*2.2;return{id:`mesh-${xe+1}`,seed:1e3+xe*991+Math.floor(te()*999),style:{"--mesh-sway-duration":`${le}s`,"--mesh-drift-duration":`${se}s`,"--mesh-sway-delay":`${Te}s`,"--mesh-drift-delay":`${Ae}s`,"--mesh-scale":`${Ee}`,"--mesh-shift":`${$e}%`,"--mesh-xshift":`${et}%`,"--mesh-x0":`${Ce}%`,"--mesh-y0":`${ct}%`}}})},[]),S=a.useMemo(()=>{const _=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],te=t.cogita.introSlides,Y=new Map(te.map(xe=>[xe.id,xe]));return _.map(xe=>{var se;const le=Y.get(xe.id);return{...xe,...le,title:(le==null?void 0:le.title)??"Cogita",cta:(le==null?void 0:le.cta)??((se=t.cogita.introSlides[0])==null?void 0:se.cta)??t.cogita.loginCta,secondary:le==null?void 0:le.secondary}})},[t.cogita.introSlides]),[V,v]=a.useState(0),[y,K]=a.useState(!0),[q,x]=a.useState(!1),W=S.length-1,m=a.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),D=a.useCallback(()=>{m(),n()},[m,n]),$=a.useCallback(()=>{K(!0),v(0)},[]),T=a.useCallback(()=>{K(!1),v(W)},[W]),he=a.useCallback(_=>{v(Math.max(0,Math.min(W,_)))},[W]),ne=a.useCallback(()=>{V>=W?D():he(V+1)},[V,he,D,W]),je=a.useCallback(()=>{he(V-1)},[V,he]);a.useEffect(()=>{var Y;const _=(Y=window.matchMedia)==null?void 0:Y.call(window,"(prefers-reduced-motion: reduce)");if(!_)return;const te=()=>x(_.matches);return te(),_.addEventListener?(_.addEventListener("change",te),()=>_.removeEventListener("change",te)):(_.addListener(te),()=>_.removeListener(te))},[]),a.useEffect(()=>{if(!y)return;const _=te=>{const Y=te.target;if(!Y)return;const xe=Y.tagName;if(!(Y.isContentEditable||xe==="INPUT"||xe==="TEXTAREA"||xe==="SELECT"||xe==="BUTTON"||xe==="A"||Y.closest('button, a, [role="button"], [role="link"]'))){if(te.key==="Escape"){T();return}if(te.key==="ArrowLeft"||te.key==="ArrowUp"){je();return}(te.key==="ArrowRight"||te.key==="ArrowDown"||te.code==="Space"||te.key===" ")&&(te.preventDefault(),ne())}};return window.addEventListener("keydown",_),()=>window.removeEventListener("keydown",_)},[T,ne,je,y]),a.useEffect(()=>{y&&V===W&&m()},[V,y,W,m]),a.useEffect(()=>{const _=l.current;if(!_)return;const te=d.current.filter(Ie=>!!Ie);if(!te.length)return;const Y=1,xe=.6,le=.6,se=Math.max(1,Math.min(Y,window.devicePixelRatio||1));let Te=0,Ae=0,Ee=xe,$e=0,et=0;const ct=Ie=>{let ze=Ie%2147483647;return ze<=0&&(ze+=2147483646),(Xe,F)=>{ze=ze*48271%2147483647;const A=ze/2147483647;return Xe+A*(F-Xe)}},Ce={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},We=Ie=>{const ze=Math.sin(Ie*12.9898)*43758.5453;return ze-Math.floor(ze)},xt=Ie=>{const ze=We(Ie+.1)||1e-4,Xe=We(Ie+.7)||1e-4;return Math.sqrt(-2*Math.log(ze))*Math.cos(2*Math.PI*Xe)},Ve=(Ie,ze)=>{const Xe=Math.floor(Ie),F=Xe+1,A=Ie-Xe,B=A*A*(3-2*A),E=We(Xe*12.9898+ze*78.233),N=We(F*12.9898+ze*78.233);return E+(N-E)*B},Be=Ie=>{const ze=ct(Ie),Xe=Math.min(4,Math.max(4,Math.floor(Te/1200*Ce.filamentCount)));return Array.from({length:Xe},(F,A)=>{const B=Math.max(-1,Math.min(1,xt(Ie+A*.37))),E=Math.min(1,Math.max(0,We(Ie+A*1.31))),N=Math.min(Ce.depthLayers-1,Math.floor(E*Ce.depthLayers));return{seed:ze(0,Math.PI*2)+Ie*.01,offset:B,freqA:Ce.freq1*(.75+ze(0,.5)),freqB:Ce.freq2*(.75+ze(0,.5)),ampA:Ce.amp1*(.6+ze(0,.7)),ampB:Ce.amp2*(.6+ze(0,.7)),width:2+A%5*.32,depth:E,layer:N}})},tt=(Ie,ze,Xe)=>{const F=Math.max(30,Math.floor(Te*Ae/14e4));Ie.save(),Ie.globalAlpha=.6;for(let A=0;A<F;A+=1){const B=We(A*9.1+Te*.11)*ze+Xe,E=We(A*3.7+Ae*.23)*Ae,N=1.2+We(A*5.9)*2.4,C=Ie.createRadialGradient(B,E,0,B,E,N*2);C.addColorStop(0,"rgba(10, 30, 60, 0.45)"),C.addColorStop(1,"rgba(10, 30, 60, 0)"),Ie.fillStyle=C,Ie.beginPath(),Ie.arc(B,E,N*2,0,Math.PI*2),Ie.fill()}Ie.restore()},ot=(Ie,ze)=>{Ie.clearRect(0,0,Te,Ae);const Xe=Ae*Ce.waveCenter,F=Ce.waveBandPx,A=Ce.segments,B=Ce.colors.filaments,E=$e||Te,N=0;tt(Ie,E,N),Ie.strokeStyle=B,Ie.lineCap="round",Ie.lineJoin="round";for(let C=0;C<ze.length;C+=1){const L=ze[C],ue=L.offset*F*(.85+We(L.seed)*.4),be=1-Math.min(1,Math.abs(ue)/F),ge=Math.exp(-Math.pow(ue/Ce.crestThickness,2)),Z=L.layer===0?1.1:L.layer===1?.85:.6,P=.35+(1-L.depth)*.65,G=be*P*Z*(.34+ge*.45);Ie.globalAlpha=G,Ie.lineWidth=L.width*(1+(1-L.depth)*.8);const re=[];for(let ee=0;ee<=A;ee+=1){const ye=ee/A*E+N,U=(Ve(ye*.012,L.seed)-.5)*Ce.xJitter,ie=ye+U,Le=(Ve(ie*L.freqA,L.seed)-.5)*Ce.jitterA,qe=(Ve(ie*L.freqB,L.seed*1.7)-.5)*Ce.jitterB,Ke=Xe+Math.sin(ie*L.freqA+L.seed)*L.ampA+Math.sin(ie*L.freqB+L.seed*1.3)*L.ampB+ue+Le+qe;re.push({x:ie,y:Ke})}Ie.beginPath(),Ie.moveTo(re[0].x,re[0].y);for(let ee=1;ee<re.length-1;ee+=1){const ye=(re[ee].x+re[ee+1].x)/2,U=(re[ee].y+re[ee+1].y)/2;Ie.quadraticCurveTo(re[ee].x,re[ee].y,ye,U)}const Q=re[re.length-1];Ie.quadraticCurveTo(Q.x,Q.y,Q.x,Q.y),Ie.stroke()}Ie.save(),Ie.globalCompositeOperation="lighter",Ie.strokeStyle=Ce.colors.glow,Ie.lineCap="round",Ie.lineJoin="round";for(let C=0;C<ze.length;C+=1){const L=ze[C];if(Math.abs(L.offset)*F>Ce.crestThickness)continue;const ue=Ce.glowAlpha*(.7+(1-L.depth)*.6);Ie.globalAlpha=ue,Ie.lineWidth=1.6+(1-L.depth)*1.2;const be=[];for(let Z=0;Z<=A;Z+=1){const P=Z/A*E+N,G=Math.sin(P*.02+L.seed)*3,re=Xe+Math.sin(P*L.freqA+L.seed)*L.ampA+Math.sin(P*L.freqB+L.seed*1.3)*L.ampB+L.offset*F*.35+G;be.push({x:P,y:re})}Ie.beginPath(),Ie.moveTo(be[0].x,be[0].y);for(let Z=1;Z<be.length-1;Z+=1){const P=(be[Z].x+be[Z+1].x)/2,G=(be[Z].y+be[Z+1].y)/2;Ie.quadraticCurveTo(be[Z].x,be[Z].y,P,G)}const ge=be[be.length-1];Ie.quadraticCurveTo(ge.x,ge.y,ge.x,ge.y),Ie.stroke()}Ie.restore()},Ye=()=>{Te=Math.floor(_.clientWidth),Ae=Math.floor(_.clientHeight),$e=Math.floor(Te*1.8),et=Ae,Ee=Te<820?le:xe,te.forEach(Ie=>{const ze=Ie.getContext("2d");if(!ze)return;Ie.width=Math.floor($e*se*Ee),Ie.height=Math.floor(et*se*Ee),Ie.style.width=`${$e}px`,Ie.style.height=`${et}px`,Ie.style.left=`${-($e-Te)/2}px`,ze.setTransform(se*Ee,0,0,se*Ee,0,0);const Xe=Number(Ie.dataset.seed||1),F=Be(Xe);ot(ze,F)})};return Ye(),window.addEventListener("resize",Ye,{passive:!0}),()=>window.removeEventListener("resize",Ye)},[g]);const De=S[Math.min(V,S.length-1)],R=y?De:S[S.length-1],I=(R==null?void 0:R.theme)??S[0].theme,X={"--cogita-bg0":I.bg0,"--cogita-bg1":I.bg1,"--cogita-bg2":I.bg2,"--cogita-bloom":I.bloom,"--cogita-sat":I.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:p,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(zs,{value:k,onChange:i}),e.jsx(Os,{copy:t,label:r,isAuthenticated:s,secureMode:w,onLogin:n,onProfileNavigate:o,onToggleSecureMode:h,onLogout:c,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:l,className:"cogita-section cogita-home",style:X,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[g.map((_,te)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:_.style,"data-seed":_.seed,ref:Y=>{d.current[te]=Y}},_.id)),j.map(_=>e.jsx("div",{className:"cogita-home-wave",style:_.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},_.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(Gr,{slides:S,activeIndex:V,introOpen:y,prefersReducedMotion:q,onNext:ne,onPrev:je,onSelect:he,onExit:T,onOpen:$,onRegister:D})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const Mo=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:Zr},Symbol.toStringTag,{value:"Module"})),Ys=a.createContext(!1);function Pt({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,headerExtra:i,children:p}){if(a.useContext(Ys))return e.jsx(e.Fragment,{children:p});const d=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}w("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:d,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(zs,{value:f,onChange:k}),e.jsxs("div",{className:"cogita-header-right",children:[i,e.jsx(Os,{copy:t,label:n,isAuthenticated:r,secureMode:c,onLogin:()=>w("home"),onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:p}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function da(t){const[n,r]=a.useState("Cogita library"),[s,o]=a.useState(null);return a.useEffect(()=>{let h=!1;return Vs().then(c=>{if(h)return;const w=c.find(f=>f.libraryId===t);w&&r(w.name)}).catch(()=>{h||r("Cogita library")}),()=>{h=!0}},[t]),a.useEffect(()=>{let h=!1;return hr(t).then(c=>{h||o(c)}).catch(()=>{h||o(null)}),()=>{h=!0}},[t]),{libraryName:n,stats:s}}function hs({slices:t}){const n=t.reduce((s,o)=>s+Math.max(0,o.value),0),r=a.useMemo(()=>{if(n<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let s=0;return`conic-gradient(${t.map(h=>{const w=Math.max(0,h.value)/n*360,f=s,k=s+w;return s=k,`${h.color} ${f}deg ${k}deg`}).join(",")})`},[t,n]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:r}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(s=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:s.color}}),e.jsx("strong",{children:s.value}),e.jsx("small",{children:s.label})]},s.label))})]})}function ei({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,libraryId:i}){const{libraryName:p,stats:l}=da(i),[d,j]=a.useState("infos"),[g,S]=a.useState(0),[V,v]=a.useState(0),[y,K]=a.useState(0),q=(l==null?void 0:l.totalInfos)??0,x=(l==null?void 0:l.totalCollections)??0,W=0,m=0,D=0,$=Math.max(0,q-D-V),T=Math.max(0,q-V-y);a.useEffect(()=>{let ne=!1;return(async()=>{try{const De=await Va({libraryId:i,limit:200}),R=await Promise.all(De.items.map(I=>Gn({libraryId:i,collectionId:I.collectionId}).catch(()=>[])));if(ne)return;S(R.reduce((I,X)=>I+X.length,0))}catch{ne||S(0)}})(),()=>{ne=!0}},[i]),a.useEffect(()=>{let ne=!1;return(async()=>{try{const[De,R,I]=await Promise.all([ls({libraryId:i,type:"computed",limit:1}).catch(()=>({total:0})),ls({libraryId:i,type:"source",limit:1}).catch(()=>({total:0})),Yn({libraryId:i}).catch(()=>({items:[]}))]);if(ne)return;v((De.total??0)+(R.total??0));const X=new Set(I.items.filter(_=>_.childItemType.toLowerCase()==="info").map(_=>_.childItemId).filter(Boolean));K(X.size)}catch{ne||(v(0),K(0))}})(),()=>{ne=!0}},[i]);const he=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:q},{key:"collections",label:t.cogita.library.overview.stats.collections,value:x},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:g},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:W},{key:"texts",label:t.cogita.library.overview.stats.texts,value:m}];return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:p})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:he.map(ne=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${d===ne.key?"active":""}`,onClick:()=>j(ne.key),children:[e.jsx("span",{children:ne.label}),e.jsx("strong",{children:ne.value})]},ne.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),d==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(hs,{slices:[{label:t.cogita.library.overview.known,value:D,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:$,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:V,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(hs,{slices:[{label:t.cogita.library.overview.availableChecks,value:y,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:T,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const nt=(t,n)=>{const r=t.cogita.library.infoTypes,s=t.cogita.library.connectionTypes,o=t.cogita.library.groupTypes;return{any:r.any,vocab:r.vocab,book:o.book,citation:o.citation,language:r.language,word:r.word,sentence:r.sentence,topic:r.topic,collection:r.collection,person:r.person,institution:r.institution,collective:r.collective,orcid:r.orcid,address:r.address,email:r.email,phone:r.phone,media:r.media,work:r.work,geo:r.geo,music_piece:r.musicPiece,music_fragment:r.musicFragment,source:r.source,question:r.question,computed:r.computed,"word-language":s.wordLanguage,"citation-language":s.citationLanguage,"language-sentence":s.languageSentence,translation:s.translation,"word-topic":s.wordTopic,reference:s.reference,"source-resource":s.sourceResource,"work-contributor":s.workContributor,"work-medium":s.workMedium,"orcid-link":s.orcidLink}[n]??String(n)},ti=t=>[{value:"any",label:nt(t,"any")},{value:"language",label:nt(t,"language")},{value:"word",label:nt(t,"word")},{value:"sentence",label:nt(t,"sentence")},{value:"topic",label:nt(t,"topic")},{value:"collection",label:nt(t,"collection")},{value:"person",label:nt(t,"person")},{value:"institution",label:nt(t,"institution")},{value:"collective",label:nt(t,"collective")},{value:"orcid",label:nt(t,"orcid")},{value:"address",label:nt(t,"address")},{value:"email",label:nt(t,"email")},{value:"phone",label:nt(t,"phone")},{value:"media",label:nt(t,"media")},{value:"work",label:nt(t,"work")},{value:"geo",label:nt(t,"geo")},{value:"music_piece",label:nt(t,"music_piece")},{value:"music_fragment",label:nt(t,"music_fragment")},{value:"source",label:nt(t,"source")},{value:"question",label:nt(t,"question")},{value:"citation",label:nt(t,"citation")},{value:"computed",label:nt(t,"computed")},{value:"vocab",label:nt(t,"vocab")},{value:"book",label:nt(t,"book")},{value:"word-language",label:nt(t,"word-language")},{value:"citation-language",label:nt(t,"citation-language")},{value:"language-sentence",label:nt(t,"language-sentence")},{value:"translation",label:nt(t,"translation")},{value:"word-topic",label:nt(t,"word-topic")},{value:"reference",label:nt(t,"reference")},{value:"source-resource",label:nt(t,"source-resource")},{value:"work-contributor",label:nt(t,"work-contributor")},{value:"work-medium",label:nt(t,"work-medium")},{value:"orcid-link",label:nt(t,"orcid-link")}],ai=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Mn={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},ni={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Mn]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Mn]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId"]},filterFields:[Mn,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text"],connections:[{relationType:"citation-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"citationText",kind:"text",path:"text",matcher:"contains"}]},question:{infoType:"question",entityKind:"single",structure:{payloadFields:["definition"]},filterFields:[{key:"questionType",labelKey:"type",kind:"text",path:"definition.type",matcher:"contains"},{key:"questionText",labelKey:"text",kind:"text",path:"definition.question",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},gs={infoType:"default",entityKind:"single",structure:{payloadFields:["label"]},filterFields:[]};function si(t){return t?ni[t]??gs:gs}function ri(t,n){return t.optionsSource==="languages"?n.languages.map(r=>({value:r.infoId,label:r.label})):t.optionsSource==="sourceKinds"?ai:[]}const ii="cogita.revision.seed:";function Xs(t){return`${ii}${t}`}function oi(t,n){if(typeof window>"u")return null;const r=Array.from(new Set(n.map(h=>h.trim()).filter(Boolean)));if(!r.length)return null;const s=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,o={kind:"info-selection",libraryId:t,infoIds:r,createdAt:new Date().toISOString()};return window.localStorage.setItem(Xs(s),JSON.stringify(o)),s}function ms(t,n){if(typeof window>"u")return null;const r=window.localStorage.getItem(Xs(n));if(!r)return null;try{const s=JSON.parse(r);if(s.kind!=="info-selection"||s.libraryId!==t||!Array.isArray(s.infoIds))return null;const o=s.infoIds.map(h=>String(h??"").trim()).filter(Boolean);return o.length?{infoIds:o}:null}catch{return null}}const li="cogita.collection-draft:";function Zs(t){return`${li}${t}`}function ci(t,n){if(typeof window>"u")return null;const r=Array.from(new Set(n.map(h=>h.trim()).filter(Boolean)));if(!r.length)return null;const s=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,o={kind:"info-selection",libraryId:t,infoIds:r,createdAt:new Date().toISOString()};return window.localStorage.setItem(Zs(s),JSON.stringify(o)),s}function di(t,n){if(typeof window>"u")return null;const r=window.localStorage.getItem(Zs(n));if(!r)return null;try{const s=JSON.parse(r);if(s.kind!=="info-selection"||s.libraryId!==t||!Array.isArray(s.infoIds))return null;const o=s.infoIds.map(h=>String(h??"").trim()).filter(Boolean);return o.length?{infoIds:o}:null}catch{return null}}const Ln=60,ui=500;function er(t){return`cogita.info-selection:${t}`}function ps(t){if(typeof window>"u")return{};const n=window.localStorage.getItem(er(t));if(!n)return{};try{const r=JSON.parse(n);return!r||typeof r!="object"?{}:r}catch{return{}}}function hi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,libraryId:i,mode:p}){var qt;const l=mn(),d=Ja(),j=t.cogita.library.list,[g,S]=a.useState("any"),[V,v]=a.useState(""),[y,K]=a.useState("relevance"),[q,x]=a.useState("details"),[W,m]=a.useState(!1),[D,$]=a.useState("idle"),[T,he]=a.useState([]),[ne,je]=a.useState(Ln),[De,R]=a.useState(null),[I,X]=a.useState(()=>ps(i)),[_,te]=a.useState({}),[Y,xe]=a.useState([]),[le,se]=a.useState([]),[Te,Ae]=a.useState(null),[Ee,$e]=a.useState(null),[et,ct]=a.useState(null),[Ce,We]=a.useState("idle"),[xt,Ve]=a.useState([]),[Be,tt]=a.useState(""),[ot,Ye]=a.useState(null),[Ie,ze]=a.useState("idle"),[Xe,F]=a.useState(null),[A,B]=a.useState(null),[E,N]=a.useState("idle"),[C,L]=a.useState([]),[ue,be]=a.useState("idle"),ge=a.useMemo(()=>ti(t),[t]),Z=a.useMemo(()=>[{value:"relevance",label:j.sortRelevance},{value:"label_asc",label:j.sortLabelAsc},{value:"label_desc",label:j.sortLabelDesc},{value:"type_asc",label:j.sortTypeAsc},{value:"type_desc",label:j.sortTypeDesc}],[j.sortLabelAsc,j.sortLabelDesc,j.sortRelevance,j.sortTypeAsc,j.sortTypeDesc]);a.useEffect(()=>{X(ps(i)),te({}),m(!1)},[i]),a.useEffect(()=>{Yn({libraryId:i}).then(O=>ct(O)).catch(()=>ct({items:[]}))},[i]),a.useEffect(()=>{gr({libraryId:i}).then(O=>Ve(O)).catch(()=>Ve([]))},[i]),a.useEffect(()=>{In({libraryId:i,type:"language",filters:{sourceKind:"info"},limit:200}).then(O=>{const u=O.map(oe=>({infoId:oe.infoId??"",infoType:oe.entityType,label:oe.title})).filter(oe=>oe.infoId.length>0);xe(u)}).catch(()=>xe([]))},[i]),a.useEffect(()=>{In({libraryId:i,type:"source",filters:{sourceKind:"info"},limit:200}).then(O=>{const u=O.map(oe=>({infoId:oe.infoId??"",infoType:oe.entityType,label:oe.title})).filter(oe=>oe.infoId.length>0);se(u)}).catch(()=>se([]))},[i]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(er(i),JSON.stringify(I))},[i,I]);const P=a.useMemo(()=>si(g==="any"?null:g),[g]),G=a.useMemo(()=>new URLSearchParams(d.search),[d.search]),re=a.useMemo(()=>d.pathname.split("/").filter(Boolean),[d.pathname]),Q=re.findIndex(O=>O==="infos"),ee=Q>=0&&(re[Q+1]??"").trim()||null,ye=Q>=0?(re[Q+2]??"").trim():"",U=Q>=0?ye==="checkcards"?"cards":ye==="collections"?"collections":"overview":"",ie=ee??((G.get("infoId")??"").trim()||null),Le=ee?U:(G.get("infoView")??"overview").trim(),qe=Le==="overview"&&!!ie,Ke=Le==="collections"&&!!ie,Je=a.useMemo(()=>({language:j.typeFilterLanguage,languageA:j.typeFilterLanguageA,languageB:j.typeFilterLanguageB,originalLanguage:j.typeFilterOriginalLanguage,doi:j.typeFilterDoi,sourceKind:j.typeFilterSourceKind,locator:j.typeFilterLocator,citationText:j.typeFilterCitationText}),[j.typeFilterDoi,j.typeFilterLanguage,j.typeFilterLanguageA,j.typeFilterLanguageB,j.typeFilterLocator,j.typeFilterOriginalLanguage,j.typeFilterCitationText,j.typeFilterSourceKind]),bt=a.useMemo(()=>P.filterFields.map(O=>({...O,label:O.labelKey?Je[O.labelKey]:O.label??O.key,options:ri(O,{languages:Y})})),[Je,Y,P.filterFields]),mt=a.useMemo(()=>bt.some(O=>(_[O.key]??"").trim().length>0),[bt,_]);a.useEffect(()=>{te({})},[g]),a.useEffect(()=>{const O={sourceKind:"info"};if(mt)for(const H of bt){const Qe=(_[H.key]??"").trim();Qe&&(O[H.path??H.key]=Qe)}const u=(_.__referenceId??"").trim();u&&(O["link.references"]=u),$("loading");const oe=window.setTimeout(()=>{In({libraryId:i,type:g==="any"?void 0:g,query:V.trim()||void 0,filters:O,limit:ui}).then(H=>{const Qe=H.map(rt=>({infoId:rt.infoId??"",infoType:rt.entityType,label:rt.title})).filter(rt=>rt.infoId.length>0);he(Qe),$("ready")}).catch(()=>{he([]),$("ready")})},240);return()=>window.clearTimeout(oe)},[mt,i,V,g,bt,_]),a.useEffect(()=>{if(!ie||Le!=="overview"&&Le!=="collections"){Ae(null),$e(null),We("idle");return}let O=!1;return We("loading"),Promise.all([na({libraryId:i,infoId:ie}),mr({libraryId:i,itemType:"info",itemId:ie}).catch(()=>null)]).then(([u,oe])=>{O||(Ae(u),$e(oe),We("ready"))}).catch(()=>{O||(Ae(null),$e(null),We("error"))}),()=>{O=!0}},[i,ie,Le]),a.useEffect(()=>{if(!ie||Le!=="collections"){L([]),be("idle");return}let O=!1;return be("loading"),pr({libraryId:i,infoId:ie}).then(u=>{O||(L(u),be("ready"))}).catch(()=>{O||(L([]),be("error"))}),()=>{O=!0}},[i,ie,Le]),a.useEffect(()=>{if(!ie||Le!=="overview"){F(null),B(null),N("idle");return}let O=!1;return N("loading"),Promise.all([tn({libraryId:i,infoId:ie}),an({libraryId:i,infoId:ie})]).then(([u,oe])=>{O||(F(u),B(oe),N("ready"))}).catch(()=>{O||(F(null),B(null),N("error"))}),()=>{O=!0}},[i,ie,Le]);const pt=a.useMemo(()=>Te?xt.filter(O=>O.sourceInfoTypes.some(u=>u.toLowerCase()===Te.infoType.toLowerCase())):[],[xt,Te]);a.useEffect(()=>{if(!Te){tt("");return}tt(O=>{var u;return O&&pt.some(oe=>oe.approachKey===O)?O:((u=pt[0])==null?void 0:u.approachKey)??""})},[pt,Te]),a.useEffect(()=>{if(!Te||!Be){Ye(null),ze("idle");return}let O=!1;return ze("loading"),qs({libraryId:i,infoId:Te.infoId,approachKey:Be}).then(u=>{O||(Ye(u),ze("ready"))}).catch(()=>{O||(Ye(null),ze("error"))}),()=>{O=!0}},[i,Be,Te]);const wt=a.useMemo(()=>{const O=T.slice(),u=oe=>nt(t,oe);return y==="relevance"?O:y==="label_asc"?O.sort((oe,H)=>oe.label.localeCompare(H.label)):y==="label_desc"?O.sort((oe,H)=>H.label.localeCompare(oe.label)):y==="type_asc"?O.sort((oe,H)=>oe.infoType===H.infoType?oe.label.localeCompare(H.label):u(oe.infoType).localeCompare(u(H.infoType))):O.sort((oe,H)=>oe.infoType===H.infoType?oe.label.localeCompare(H.label):u(H.infoType).localeCompare(u(oe.infoType)))},[t,T,y]),Ct=a.useMemo(()=>wt.slice(0,ne),[wt,ne]),Ot=Ct.length<wt.length,Et=a.useMemo(()=>new Set(Object.keys(I)),[I]),Nt=a.useMemo(()=>Object.values(I),[I]),ua=a.useMemo(()=>{const O=new Map;for(const u of Nt)O.set(u.infoType,(O.get(u.infoType)??0)+1);return Array.from(O.entries()).sort((u,oe)=>oe[1]-u[1]||u[0].localeCompare(oe[0]))},[Nt]),Lt=a.useMemo(()=>{if(!ie||!et)return 0;const O=new Set;for(const u of et.items)u.childItemType!=="info"||u.childItemId!==ie||O.add([u.parentItemType,u.parentItemId,u.parentCheckType??"",u.parentDirection??""].join("|"));return O.size},[et,ie]);a.useEffect(()=>{je(Ln);const O=new Set(T.map(u=>u.infoId));R(u=>u&&O.has(u)?u:null)},[T]);const vt=O=>{X(u=>({...u,[O.infoId]:{infoId:O.infoId,infoType:O.infoType,label:O.label}}))},St=O=>{X(u=>{if(!u[O])return u;const oe={...u};return delete oe[O],oe})},kt=(O,u)=>{if(u){vt(O);return}St(O.infoId)},yt=O=>{l(`/cogita/library/${i}/infos/${encodeURIComponent(O)}`,{replace:!0})},Kt=()=>{l(`/cogita/library/${i}/list`,{replace:!0})},st=()=>{ie&&l(`/cogita/library/${i}/edit/${encodeURIComponent(ie)}`,{replace:!0})},Ue=()=>{const O=oi(i,Nt.map(u=>u.infoId));O&&l(`/cogita/library/${i}/revision/run?libraryTarget=revisions&scope=info-selection&seed=${encodeURIComponent(O)}`)},ft=()=>{const O=ci(i,Nt.map(u=>u.infoId));O&&l(`/cogita/library/${i}/collections/new?draft=${encodeURIComponent(O)}&draftType=info-selection`)},Qt=Nt.length===1?((qt=Nt[0])==null?void 0:qt.infoId)??null:null,Vt=j.selectionCount.replace("{count}",String(Nt.length)),Bt=p==="collection"?"grid":p==="detail"?"wide":q,me=mi(f),$t=Ee?Math.max(0,Math.min(100,Math.round((Ee.score??0)*100))):0,Xt=Ee?pi(Ee,me):me.noKnownnessData;return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":Bt,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[qe?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:me.kicker}),e.jsx("h2",{className:"cogita-card-title",children:Te?fs(Te.payload,Te.infoType,Te.infoId):me.loading}),Te?e.jsxs("p",{className:"cogita-card-subtitle",children:[nt(t,Te.infoType)," · ",Te.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:Kt,children:me.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:st,disabled:!ie||Ce!=="ready",children:j.editInfo})]})]}),Ce==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:me.loading})}):Ce==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:me.loadError})}):Te?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:me.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[$t,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${$t}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:Xt})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:me.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(Ee==null?void 0:Ee.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:me.correct.replace("{correct}",String((Ee==null?void 0:Ee.correctReviews)??0)).replace("{total}",String((Ee==null?void 0:Ee.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:Ee!=null&&Ee.lastReviewedUtc?`${me.lastReview}: ${gi(Ee.lastReviewedUtc,f)}`:me.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:me.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:Lt}),e.jsx("p",{className:"cogita-library-hint",children:me.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:me.checkcards}),E==="loading"?e.jsx("p",{className:"cogita-library-hint",children:me.loadingCheckcards}):E==="error"?e.jsx("p",{className:"cogita-library-hint",children:me.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:me.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(Xe==null?void 0:Xe.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:me.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(A==null?void 0:A.items.length)??0})]})]})]}),pt.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:me.approach}),e.jsx("select",{value:Be,onChange:O=>tt(O.target.value),"aria-label":me.approach,children:pt.map(O=>e.jsx("option",{value:O.approachKey,children:O.label},O.approachKey))})]}),Ie==="loading"?e.jsx("p",{className:"cogita-library-hint",children:me.loadingApproach}):Ie==="error"?e.jsx("p",{className:"cogita-library-hint",children:me.loadApproachError}):ot?e.jsx(nn,{value:ot.projection,emptyLabel:me.empty}):e.jsx("p",{className:"cogita-library-hint",children:me.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:me.payload}),e.jsx(nn,{value:Te.payload,emptyLabel:me.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:me.links}),e.jsx(fi,{links:Te.links,emptyLabel:me.noLinks})]})]})]}):null]})}):null,Ke?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Informacja"}),e.jsx("h2",{className:"cogita-card-title",children:Te?fs(Te.payload,Te.infoType,Te.infoId):ie??""}),e.jsx("p",{className:"cogita-card-subtitle",children:"Collections using this info"})]}),e.jsx("div",{className:"cogita-info-overview-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:Kt,children:"Back to search"})})]}),ue==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading collections..."})}):null,ue==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load collections."})}):null,ue==="ready"&&C.length===0?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"This info is not used in any collection yet."})}):null,ue==="ready"&&C.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:C.map(O=>e.jsx("article",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`/#/cogita/library/${i}/collections/${O.collectionId}?libraryTarget=collections`,children:[e.jsx("div",{className:"cogita-card-type",children:"Collection"}),e.jsx("h3",{className:"cogita-card-title",children:O.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[O.itemCount," items"]})]})},O.collectionId))}):null]})}):null,!qe&&!Ke?e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":j.typeLabel,value:g,onChange:O=>S(O.target.value),children:ge.map(O=>e.jsx("option",{value:O.value,children:O.label},O.value))}),e.jsx("input",{type:"text",value:V,onChange:O=>v(O.target.value),placeholder:j.searchPlaceholder}),e.jsx("select",{"aria-label":j.sortLabel,value:y,onChange:O=>K(O.target.value),children:Z.map(O=>e.jsx("option",{value:O.value,children:O.label},O.value))}),e.jsxs("select",{"aria-label":j.viewLabel,value:q,onChange:O=>x(O.target.value),children:[e.jsx("option",{value:"details",children:j.viewDetails}),e.jsx("option",{value:"wide",children:j.viewWide}),e.jsx("option",{value:"grid",children:j.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:j.cardCount.replace("{shown}",String(Ct.length)).replace("{total}",String(wt.length))}),e.jsx("span",{children:D==="loading"?j.loading:j.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>m(O=>!O),children:W?j.hideFilters:j.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:j.filtersOptionalHint})]}),W?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsxs("div",{className:"cogita-filter-grid",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:j.typeLabel}),e.jsx("select",{value:g,onChange:O=>S(O.target.value),children:ge.map(O=>e.jsx("option",{value:O.value,children:O.label},`advanced-type:${O.value}`))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Reference"}),e.jsxs("select",{value:_.__referenceId??"",onChange:O=>te(u=>({...u,__referenceId:O.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),le.map(O=>e.jsx("option",{value:O.infoId,children:O.label},`reference:${O.infoId}`))]})]}),bt.map(O=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:O.label}),O.kind==="select"?e.jsxs("select",{value:_[O.key]??"",onChange:u=>te(oe=>({...oe,[O.key]:u.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(O.options??[]).map(u=>e.jsx("option",{value:u.value,children:u.label},`${O.key}:${u.value}`))]}):e.jsx("input",{type:"text",value:_[O.key]??"",onChange:u=>te(oe=>({...oe,[O.key]:u.target.value}))})]},`type-filter:${O.key}`))]})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:Vt}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{X(O=>{const u={...O};for(const oe of Ct)u[oe.infoId]={infoId:oe.infoId,infoType:oe.infoType,label:oe.label};return u})},disabled:Ct.length===0,children:j.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>X({}),disabled:Nt.length===0,children:j.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Qt&&yt(Qt),disabled:!Qt,title:Qt?void 0:j.openSelectedDisabled,children:j.openSelected})]})]}),Bt==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":j.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:j.detailColumnName}),e.jsx("span",{children:j.detailColumnType}),e.jsx("span",{children:j.detailColumnId}),e.jsx("span",{})]}),Ct.length?Ct.map(O=>{const u=nt(t,O.infoType),oe=Et.has(O.infoId),H=De===O.infoId;return e.jsxs("div",{className:`cogita-details-row ${H||oe?"active":""}`,role:"row",onClick:()=>R(O.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:oe,onChange:Qe=>kt(O,Qe.target.checked),onClick:Qe=>Qe.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:O.label,children:O.label}),e.jsx("span",{title:u,children:u}),e.jsx("span",{title:O.infoId,children:O.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:Qe=>{Qe.stopPropagation(),yt(O.infoId)},"aria-label":j.editInfo,children:">"})]},O.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:j.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${Bt}`,"data-view":Bt,children:Ct.length?Ct.map(O=>{const u=nt(t,O.infoType),oe=Et.has(O.infoId),H=De===O.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":H||oe,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:oe,onChange:Qe=>kt(O,Qe.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>R(O.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:u}),e.jsx("h3",{className:"cogita-card-title",children:O.label}),e.jsx("p",{className:"cogita-card-subtitle",children:O.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>yt(O.infoId),children:j.editInfo})]})},O.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:j.noMatch})})}),Ot?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>je(O=>O+Ln),children:j.loadMore})}):null,Nt.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:j.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:j.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:ua.map(([O,u])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:nt(t,O)}),e.jsx("span",{className:"cogita-tag-count",children:u})]},`stack:type:${O}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:Ue,disabled:Nt.length===0,children:"Start revision"}),e.jsx("button",{type:"button",className:"ghost",onClick:ft,disabled:Nt.length===0,children:"Create collection from selection"})]})]}):null]}):null]})})})})}function fs(t,n,r){if(t&&typeof t=="object"&&!Array.isArray(t)){const s=t,o=["title","name","label","value","text","quote","term"];for(const h of o){const c=s[h];if(typeof c=="string"&&c.trim())return c.trim()}}return`${n} · ${r}`}function gi(t,n){try{const r=n==="pl"?"pl-PL":n==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(r,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function mi(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function pi(t,n){return t.totalReviews<=0?n.noKnownnessData:t.totalReviews<3||t.score<.35?n.developmentStart:t.totalReviews<8||t.score<.65?n.developmentGrowing:t.score<.85?n.developmentStable:n.developmentStrong}function fi({links:t,emptyLabel:n}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([r,s])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(s)?s.length?e.jsx("div",{className:"cogita-selection-overview",children:s.map(o=>e.jsx("span",{className:"cogita-tag-chip",children:o},`${r}:${o}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):s?e.jsx("span",{className:"cogita-tag-chip",children:s}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},r))})}function nn({value:t,emptyLabel:n}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:n});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((r,s)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(nn,{value:r,emptyLabel:n})})]},s))});if(typeof t=="object"){const r=Object.entries(t);return r.length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:r.map(([s,o])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(nn,{value:o,emptyLabel:n})})]},s))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const Na=5,bs=50,ys=2,xs=[];function Yt({libraryId:t,infoType:n,label:r,placeholder:s,value:o,onChange:h,values:c,onChangeMultiple:w,helperText:f,searchFailedText:k,createFailedText:i,createLabel:p,savingLabel:l,loadMoreLabel:d,allowCreate:j=!0,inputRef:g,autoAdvance:S,onCommit:V,multiple:v}){const y=v?c??xs:xs,[K,q]=a.useState(v?"":(o==null?void 0:o.label)??""),[x,W]=a.useState([]),[m,D]=a.useState(Na),[$,T]=a.useState(-1),[he,ne]=a.useState(!1),[je,De]=a.useState(!1),[R,I]=a.useState(null),X=a.useRef(0),_=a.useRef(new Map),te=a.useMemo(()=>j?v?K.trim().length>0:K.trim().length>0&&!o:!1,[j,K,o,v]);a.useEffect(()=>{v||q((o==null?void 0:o.label)??"")},[o,v]),a.useEffect(()=>{const le=K.trim();if(!le||le.length<ys){W([]),ne(!1),D(Na),T(-1),De(!1),I(null);return}const se=le.toLowerCase(),Te=`${t}:${n}:${se}`,Ae=_.current.get(Te);if(Ae){if(v&&y.length>0){const $e=new Set(y.map(et=>et.id));W(Ae.filter(et=>!$e.has(et.id)))}else W(Ae);D(Na),T(-1),ne(Ae.length>0),De(!1),I(null);return}const Ee=window.setTimeout(async()=>{const $e=Date.now();X.current=$e,De(!0),I(null);try{const et=await Xn({libraryId:t,type:n,query:le,limit:bs});if(X.current!==$e)return;const ct=et.slice(0,bs).map(Ce=>({id:Ce.infoId,label:Ce.label,infoType:Ce.infoType}));if(_.current.set(Te,ct),v&&y.length>0){const Ce=new Set(y.map(We=>We.id));W(ct.filter(We=>!Ce.has(We.id)))}else W(ct);D(Na),T(-1),ne(!0)}catch{if(X.current!==$e)return;I(k??"Search failed.")}finally{X.current===$e&&De(!1)}},250);return()=>window.clearTimeout(Ee)},[t,n,K,y]);const Y=le=>{if(v){const se=y.some(Te=>Te.id===le.id)?y:[...y,le];w==null||w(se),q(""),ne(!1),T(-1);return}h==null||h(le),q(le.label),ne(!1),T(-1),S&&(V==null||V())},xe=async()=>{const le=K.trim();if(le){De(!0),I(null);try{const se=await qn({libraryId:t,infoType:n,payload:{label:le}}),Te={id:se.infoId,label:le,infoType:se.infoType};if(le.length>=ys){const Ae=`${t}:${n}:${le.toLowerCase()}`,Ee=_.current.get(Ae)??[];_.current.set(Ae,[Te,...Ee])}if(v){w==null||w([...y,Te]),q(""),ne(!1),T(-1);return}h==null||h(Te),ne(!1),T(-1),S&&(V==null||V())}catch{I(i??"Create failed.")}finally{De(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:r}),e.jsx("input",{value:K,placeholder:s,onChange:le=>{q(le.target.value),!v&&o&&(h==null||h(null))},onKeyDown:le=>{if(le.key==="ArrowDown"){if(le.preventDefault(),!x.length)return;ne(!0),T(se=>{const Te=Math.min(x.length,m)-1,Ae=se<0?0:Math.min(se+1,Te);return Ae===Te&&x.length>m?(D(Ee=>Math.min(Ee+Na,x.length)),Math.min(se+1,Math.min(x.length,m+Na)-1)):Ae});return}if(le.key==="ArrowUp"){if(le.preventDefault(),!x.length)return;ne(!0),T(se=>se<=0?0:se-1);return}if(le.key==="Enter"){if(le.preventDefault(),$>=0&&x[$]){Y(x[$]);return}if(te){xe();return}}},onFocus:()=>{x.length>0&&ne(!0)},autoComplete:"off",ref:g})]}),v&&y.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:y.map(le=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>w==null?void 0:w(y.filter(se=>se.id!==le.id)),children:[le.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},le.id))}),f&&e.jsx("p",{className:"cogita-help",children:f}),R&&e.jsx("p",{className:"cogita-error",children:R}),he&&x.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[x.slice(0,m).map((le,se)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":se===$,onClick:()=>Y(le),children:[e.jsx("strong",{children:le.label}),e.jsx("span",{children:le.infoType})]},le.id)),m<x.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>D(le=>Math.min(le+Na,x.length)),children:d??"Load more"})]}),te&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:xe,disabled:je,children:je?l??"Saving...":p??`Create new ${n}`})]})}const vs=[{id:"gen",la:{abbr:"Gen",name:"Genesis"},en:{abbr:"Gen",name:"Genesis"},de:{abbr:"Gen",name:"Genesis"},pl:{abbr:"Rdz",name:"Księga Rodzaju"}},{id:"ex",la:{abbr:"Ex",name:"Exodus"},en:{abbr:"Ex",name:"Exodus"},de:{abbr:"Ex",name:"Exodus"},pl:{abbr:"Wj",name:"Księga Wyjścia"}},{id:"lev",la:{abbr:"Lev",name:"Leviticus"},en:{abbr:"Lev",name:"Leviticus"},de:{abbr:"Lev",name:"Levitikus"},pl:{abbr:"Kpł",name:"Księga Kapłańska"}},{id:"num",la:{abbr:"Num",name:"Numeri"},en:{abbr:"Num",name:"Numbers"},de:{abbr:"Num",name:"Numeri"},pl:{abbr:"Lb",name:"Księga Liczb"}},{id:"deut",la:{abbr:"Deut",name:"Deuteronomium"},en:{abbr:"Deut",name:"Deuteronomy"},de:{abbr:"Dtn",name:"Deuteronomium"},pl:{abbr:"Pwt",name:"Księga Powtórzonego Prawa"}},{id:"ios",la:{abbr:"Ios",name:"Iosue"},en:{abbr:"Josh",name:"Joshua"},de:{abbr:"Jos",name:"Josua"},pl:{abbr:"Joz",name:"Księga Jozuego"}},{id:"iudg",la:{abbr:"Iudg",name:"Iudicum"},en:{abbr:"Judg",name:"Judges"},de:{abbr:"Ri",name:"Richter"},pl:{abbr:"Sdz",name:"Księga Sędziów"}},{id:"ruth",la:{abbr:"Ruth",name:"Ruth"},en:{abbr:"Ruth",name:"Ruth"},de:{abbr:"Rut",name:"Rut"},pl:{abbr:"Rt",name:"Księga Rut"}},{id:"1sam",la:{abbr:"1 Sam",name:"I Samuelis"},en:{abbr:"1 Sam",name:"1 Samuel"},de:{abbr:"1 Sam",name:"1 Samuel"},pl:{abbr:"1 Sm",name:"1 Księga Samuela"}},{id:"2sam",la:{abbr:"2 Sam",name:"II Samuelis"},en:{abbr:"2 Sam",name:"2 Samuel"},de:{abbr:"2 Sam",name:"2 Samuel"},pl:{abbr:"2 Sm",name:"2 Księga Samuela"}},{id:"1reg",la:{abbr:"1 Reg",name:"I Regum"},en:{abbr:"1 Kgs",name:"1 Kings"},de:{abbr:"1 Kön",name:"1 Könige"},pl:{abbr:"1 Krl",name:"1 Księga Królewska"}},{id:"2reg",la:{abbr:"2 Reg",name:"II Regum"},en:{abbr:"2 Kgs",name:"2 Kings"},de:{abbr:"2 Kön",name:"2 Könige"},pl:{abbr:"2 Krl",name:"2 Księga Królewska"}},{id:"1par",la:{abbr:"1 Par",name:"I Paralipomenon"},en:{abbr:"1 Chr",name:"1 Chronicles"},de:{abbr:"1 Chr",name:"1 Chronik"},pl:{abbr:"1 Krn",name:"1 Księga Kronik"}},{id:"2par",la:{abbr:"2 Par",name:"II Paralipomenon"},en:{abbr:"2 Chr",name:"2 Chronicles"},de:{abbr:"2 Chr",name:"2 Chronik"},pl:{abbr:"2 Krn",name:"2 Księga Kronik"}},{id:"esd",la:{abbr:"Esd",name:"Esdrae"},en:{abbr:"Ezra",name:"Ezra"},de:{abbr:"Esra",name:"Esra"},pl:{abbr:"Ezd",name:"Księga Ezdrasza"}},{id:"neh",la:{abbr:"Neh",name:"Nehemiae"},en:{abbr:"Neh",name:"Nehemiah"},de:{abbr:"Neh",name:"Nehemia"},pl:{abbr:"Ne",name:"Księga Nehemiasza"}},{id:"tob",la:{abbr:"Tob",name:"Tobiae"},en:{abbr:"Tob",name:"Tobit"},de:{abbr:"Tob",name:"Tobit"},pl:{abbr:"Tb",name:"Księga Tobiasza"}},{id:"iudt",la:{abbr:"Iudt",name:"Iudith"},en:{abbr:"Jdt",name:"Judith"},de:{abbr:"Jdt",name:"Judit"},pl:{abbr:"Jdt",name:"Księga Judyty"}},{id:"est",la:{abbr:"Est",name:"Esther"},en:{abbr:"Est",name:"Esther"},de:{abbr:"Est",name:"Ester"},pl:{abbr:"Est",name:"Księga Estery"}},{id:"1macc",la:{abbr:"1 Macc",name:"I Maccabaeorum"},en:{abbr:"1 Mc",name:"1 Maccabees"},de:{abbr:"1 Makk",name:"1 Makkabäer"},pl:{abbr:"1 Mch",name:"1 Księga Machabejska"}},{id:"2macc",la:{abbr:"2 Macc",name:"II Maccabaeorum"},en:{abbr:"2 Mc",name:"2 Maccabees"},de:{abbr:"2 Makk",name:"2 Makkabäer"},pl:{abbr:"2 Mch",name:"2 Księga Machabejska"}},{id:"iob",la:{abbr:"Iob",name:"Iob"},en:{abbr:"Job",name:"Job"},de:{abbr:"Ijob",name:"Ijob"},pl:{abbr:"Hi",name:"Księga Hioba"}},{id:"ps",la:{abbr:"Ps",name:"Psalmi"},en:{abbr:"Ps",name:"Psalms"},de:{abbr:"Ps",name:"Psalmen"},pl:{abbr:"Ps",name:"Księga Psalmów"}},{id:"prov",la:{abbr:"Prov",name:"Proverbia"},en:{abbr:"Prov",name:"Proverbs"},de:{abbr:"Spr",name:"Sprichwörter"},pl:{abbr:"Prz",name:"Księga Przysłów"}},{id:"ecc",la:{abbr:"Ecc",name:"Ecclesiastes"},en:{abbr:"Eccl",name:"Ecclesiastes"},de:{abbr:"Koh",name:"Kohelet"},pl:{abbr:"Koh",name:"Księga Koheleta"}},{id:"cant",la:{abbr:"Cant",name:"Canticum Canticorum"},en:{abbr:"Song",name:"Song of Songs"},de:{abbr:"Hld",name:"Hoheslied"},pl:{abbr:"Pnp",name:"Pieśń nad Pieśniami"}},{id:"sap",la:{abbr:"Sap",name:"Sapientia"},en:{abbr:"Wis",name:"Wisdom"},de:{abbr:"Weish",name:"Weisheit"},pl:{abbr:"Mdr",name:"Księga Mądrości"}},{id:"sir",la:{abbr:"Sir",name:"Ecclesiasticus (Sirach)"},en:{abbr:"Sir",name:"Sirach"},de:{abbr:"Sir",name:"Jesus Sirach"},pl:{abbr:"Syr",name:"Mądrość Syracha"}},{id:"isa",la:{abbr:"Isa",name:"Isaias"},en:{abbr:"Isa",name:"Isaiah"},de:{abbr:"Jes",name:"Jesaja"},pl:{abbr:"Iz",name:"Księga Izajasza"}},{id:"ier",la:{abbr:"Ier",name:"Ieremias"},en:{abbr:"Jer",name:"Jeremiah"},de:{abbr:"Jer",name:"Jeremia"},pl:{abbr:"Jr",name:"Księga Jeremiasza"}},{id:"lam",la:{abbr:"Lam",name:"Lamentationes"},en:{abbr:"Lam",name:"Lamentations"},de:{abbr:"Klgl",name:"Klagelieder"},pl:{abbr:"Lm",name:"Lamentacje"}},{id:"bar",la:{abbr:"Bar",name:"Baruch"},en:{abbr:"Bar",name:"Baruch"},de:{abbr:"Bar",name:"Baruch"},pl:{abbr:"Ba",name:"Księga Barucha"}},{id:"ez",la:{abbr:"Ez",name:"Ezechiel"},en:{abbr:"Ezek",name:"Ezekiel"},de:{abbr:"Ez",name:"Ezechiel"},pl:{abbr:"Ez",name:"Księga Ezechiela"}},{id:"dan",la:{abbr:"Dan",name:"Daniel"},en:{abbr:"Dan",name:"Daniel"},de:{abbr:"Dan",name:"Daniel"},pl:{abbr:"Dn",name:"Księga Daniela"}},{id:"hos",la:{abbr:"Hos",name:"Osee"},en:{abbr:"Hos",name:"Hosea"},de:{abbr:"Hos",name:"Hosea"},pl:{abbr:"Oz",name:"Księga Ozeasza"}},{id:"ioel",la:{abbr:"Ioel",name:"Ioel"},en:{abbr:"Joel",name:"Joel"},de:{abbr:"Joel",name:"Joel"},pl:{abbr:"Jl",name:"Księga Joela"}},{id:"amos",la:{abbr:"Amos",name:"Amos"},en:{abbr:"Am",name:"Amos"},de:{abbr:"Am",name:"Amos"},pl:{abbr:"Am",name:"Księga Amosa"}},{id:"abd",la:{abbr:"Abd",name:"Abdias"},en:{abbr:"Obad",name:"Obadiah"},de:{abbr:"Obd",name:"Obadja"},pl:{abbr:"Abd",name:"Księga Abdiasza"}},{id:"ion",la:{abbr:"Ion",name:"Ionas"},en:{abbr:"Jon",name:"Jonah"},de:{abbr:"Jona",name:"Jona"},pl:{abbr:"Jon",name:"Księga Jonasza"}},{id:"mich",la:{abbr:"Mich",name:"Michaeas"},en:{abbr:"Mic",name:"Micah"},de:{abbr:"Mi",name:"Micha"},pl:{abbr:"Mi",name:"Księga Micheasza"}},{id:"nah",la:{abbr:"Nah",name:"Nahum"},en:{abbr:"Nah",name:"Nahum"},de:{abbr:"Nah",name:"Nahum"},pl:{abbr:"Na",name:"Księga Nahuma"}},{id:"hab",la:{abbr:"Hab",name:"Habacuc"},en:{abbr:"Hab",name:"Habakkuk"},de:{abbr:"Hab",name:"Habakuk"},pl:{abbr:"Ha",name:"Księga Habakuka"}},{id:"soph",la:{abbr:"Soph",name:"Sophonias"},en:{abbr:"Zeph",name:"Zephaniah"},de:{abbr:"Zef",name:"Zefanja"},pl:{abbr:"So",name:"Księga Sofoniasza"}},{id:"agg",la:{abbr:"Agg",name:"Aggaeus"},en:{abbr:"Hag",name:"Haggai"},de:{abbr:"Hag",name:"Haggai"},pl:{abbr:"Ag",name:"Księga Aggeusza"}},{id:"zach",la:{abbr:"Zach",name:"Zacharias"},en:{abbr:"Zech",name:"Zechariah"},de:{abbr:"Sach",name:"Sacharja"},pl:{abbr:"Za",name:"Księga Zachariasza"}},{id:"mal",la:{abbr:"Mal",name:"Malachias"},en:{abbr:"Mal",name:"Malachi"},de:{abbr:"Mal",name:"Maleachi"},pl:{abbr:"Ml",name:"Księga Malachiasza"}},{id:"mt",la:{abbr:"Mt",name:"Matthaeus"},en:{abbr:"Matt",name:"Matthew"},de:{abbr:"Mt",name:"Matthäus"},pl:{abbr:"Mt",name:"Ewangelia wg św. Mateusza"}},{id:"mc",la:{abbr:"Mc",name:"Marcus"},en:{abbr:"Mark",name:"Mark"},de:{abbr:"Mk",name:"Markus"},pl:{abbr:"Mk",name:"Ewangelia wg św. Marka"}},{id:"lc",la:{abbr:"Lc",name:"Lucas"},en:{abbr:"Luke",name:"Luke"},de:{abbr:"Lk",name:"Lukas"},pl:{abbr:"Łk",name:"Ewangelia wg św. Łukasza"}},{id:"io",la:{abbr:"Io",name:"Ioannes"},en:{abbr:"John",name:"John"},de:{abbr:"Joh",name:"Johannes"},pl:{abbr:"J",name:"Ewangelia wg św. Jana"}},{id:"act",la:{abbr:"Act",name:"Actus Apostolorum"},en:{abbr:"Acts",name:"Acts"},de:{abbr:"Apg",name:"Apostelgeschichte"},pl:{abbr:"Dz",name:"Dzieje Apostolskie"}},{id:"rom",la:{abbr:"Rom",name:"ad Romanos"},en:{abbr:"Rom",name:"Romans"},de:{abbr:"Röm",name:"Römer"},pl:{abbr:"Rz",name:"List do Rzymian"}},{id:"1cor",la:{abbr:"1 Cor",name:"I ad Corinthios"},en:{abbr:"1 Cor",name:"1 Corinthians"},de:{abbr:"1 Kor",name:"1 Korinther"},pl:{abbr:"1 Kor",name:"1 List do Koryntian"}},{id:"2cor",la:{abbr:"2 Cor",name:"II ad Corinthios"},en:{abbr:"2 Cor",name:"2 Corinthians"},de:{abbr:"2 Kor",name:"2 Korinther"},pl:{abbr:"2 Kor",name:"2 List do Koryntian"}},{id:"gal",la:{abbr:"Gal",name:"ad Galatas"},en:{abbr:"Gal",name:"Galatians"},de:{abbr:"Gal",name:"Galater"},pl:{abbr:"Ga",name:"List do Galatów"}},{id:"eph",la:{abbr:"Eph",name:"ad Ephesios"},en:{abbr:"Eph",name:"Ephesians"},de:{abbr:"Eph",name:"Epheser"},pl:{abbr:"Ef",name:"List do Efezjan"}},{id:"phil",la:{abbr:"Phil",name:"ad Philippenses"},en:{abbr:"Phil",name:"Philippians"},de:{abbr:"Phil",name:"Philipper"},pl:{abbr:"Flp",name:"List do Filipian"}},{id:"col",la:{abbr:"Col",name:"ad Colossenses"},en:{abbr:"Col",name:"Colossians"},de:{abbr:"Kol",name:"Kolosser"},pl:{abbr:"Kol",name:"List do Kolosan"}},{id:"1thess",la:{abbr:"1 Thess",name:"I ad Thessalonicenses"},en:{abbr:"1 Thess",name:"1 Thessalonians"},de:{abbr:"1 Thess",name:"1 Thessalonicher"},pl:{abbr:"1 Tes",name:"1 List do Tesaloniczan"}},{id:"2thess",la:{abbr:"2 Thess",name:"II ad Thessalonicenses"},en:{abbr:"2 Thess",name:"2 Thessalonians"},de:{abbr:"2 Thess",name:"2 Thessalonicher"},pl:{abbr:"2 Tes",name:"2 List do Tesaloniczan"}},{id:"1tim",la:{abbr:"1 Tim",name:"I ad Timotheum"},en:{abbr:"1 Tim",name:"1 Timothy"},de:{abbr:"1 Tim",name:"1 Timotheus"},pl:{abbr:"1 Tm",name:"1 List do Tymoteusza"}},{id:"2tim",la:{abbr:"2 Tim",name:"II ad Timotheum"},en:{abbr:"2 Tim",name:"2 Timothy"},de:{abbr:"2 Tim",name:"2 Timotheus"},pl:{abbr:"2 Tm",name:"2 List do Tymoteusza"}},{id:"tit",la:{abbr:"Tit",name:"ad Titum"},en:{abbr:"Titus",name:"Titus"},de:{abbr:"Tit",name:"Titus"},pl:{abbr:"Tt",name:"List do Tytusa"}},{id:"phlm",la:{abbr:"Phlm",name:"ad Philemonem"},en:{abbr:"Phlm",name:"Philemon"},de:{abbr:"Phlm",name:"Philemon"},pl:{abbr:"Flm",name:"List do Filemona"}},{id:"heb",la:{abbr:"Heb",name:"ad Hebraeos"},en:{abbr:"Heb",name:"Hebrews"},de:{abbr:"Hebr",name:"Hebräer"},pl:{abbr:"Hbr",name:"List do Hebrajczyków"}},{id:"iac",la:{abbr:"Iac",name:"Iacobi"},en:{abbr:"Jas",name:"James"},de:{abbr:"Jak",name:"Jakobus"},pl:{abbr:"Jk",name:"List św. Jakuba"}},{id:"1pet",la:{abbr:"1 Pet",name:"I Petri"},en:{abbr:"1 Pet",name:"1 Peter"},de:{abbr:"1 Petr",name:"1 Petrus"},pl:{abbr:"1 P",name:"1 List św. Piotra"}},{id:"2pet",la:{abbr:"2 Pet",name:"II Petri"},en:{abbr:"2 Pet",name:"2 Peter"},de:{abbr:"2 Petr",name:"2 Petrus"},pl:{abbr:"2 P",name:"2 List św. Piotra"}},{id:"1io",la:{abbr:"1 Io",name:"I Ioannis"},en:{abbr:"1 John",name:"1 John"},de:{abbr:"1 Joh",name:"1 Johannes"},pl:{abbr:"1 J",name:"1 List św. Jana"}},{id:"2io",la:{abbr:"2 Io",name:"II Ioannis"},en:{abbr:"2 John",name:"2 John"},de:{abbr:"2 Joh",name:"2 Johannes"},pl:{abbr:"2 J",name:"2 List św. Jana"}},{id:"3io",la:{abbr:"3 Io",name:"III Ioannis"},en:{abbr:"3 John",name:"3 John"},de:{abbr:"3 Joh",name:"3 Johannes"},pl:{abbr:"3 J",name:"3 List św. Jana"}},{id:"iud",la:{abbr:"Iud",name:"Iudae"},en:{abbr:"Jude",name:"Jude"},de:{abbr:"Jud",name:"Judas"},pl:{abbr:"Jud",name:"List św. Judy"}},{id:"apoc",la:{abbr:"Apoc",name:"Apocalypsis Ioannis"},en:{abbr:"Rev",name:"Revelation"},de:{abbr:"Offb",name:"Offenbarung"},pl:{abbr:"Ap",name:"Apokalipsa św. Jana"}}],js=8;function ws({libraryId:t,copy:n,language:r,sourceKindOptions:s,value:o,onChange:h,labels:c}){const[w,f]=a.useState(!1),[k,i]=a.useState(-1),p=a.useMemo(()=>{const g=r;return vs.map(S=>{var y;const V=(S==null?void 0:S[g])??(S==null?void 0:S.en)??(S==null?void 0:S.la);return{label:`${V.abbr} — ${V.name}`,latin:((y=S==null?void 0:S.la)==null?void 0:y.abbr)??V.abbr}})},[r]),l=(g,S=!1)=>{const V=g.trim().toLowerCase();return V?p.filter(v=>v.label.toLowerCase().includes(V)).slice(0,js):S?p.slice(0,js):[]},d=(g,S)=>{const V=g.trim().toLowerCase();if(!V)return null;const v=vs;for(const y of v){const K=y==null?void 0:y.la,q=(y==null?void 0:y[S])??(y==null?void 0:y.en)??K,x=(q==null?void 0:q.abbr)??"",W=(q==null?void 0:q.name)??"";if(x.toLowerCase()===V||W.toLowerCase()===V||`${x} — ${W}`.toLowerCase()===V)return{book:y,entry:q,la:K}}return null};a.useEffect(()=>{if(o.sourceKind==="bible"&&o.locatorValue&&!w){const g=d(o.locatorValue,r);if(g){const S=`${g.entry.abbr} — ${g.entry.name}`;S!==o.bibleBookDisplay&&h({...o,bibleBookDisplay:S})}}},[r,o,w,h]);const j=g=>h({...o,...g});return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:c.sourceKindLabel}),e.jsx("select",{value:o.sourceKind,onChange:g=>j({sourceKind:g.target.value,churchDocument:null,bookMedia:null,work:null,locatorValue:"",locatorAux:"",bibleBookDisplay:""}),children:s.map(g=>e.jsx("option",{value:g.value,children:g.label},g.value))})]}),o.sourceKind==="bible"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-lookup full",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:c.bibleBookLabel}),e.jsx("input",{type:"text",value:o.bibleBookDisplay,onChange:g=>{const S=g.target.value;j({bibleBookDisplay:S,locatorValue:""}),f(!0),i(-1)},onKeyDown:g=>{var V;const S=l(o.bibleBookDisplay);if(S.length){if(g.key==="ArrowDown")g.preventDefault(),i(v=>Math.min(v+1,S.length-1));else if(g.key==="ArrowUp")g.preventDefault(),i(v=>Math.max(v-1,0));else if((g.key==="Enter"||g.key==="Tab")&&k>=0&&S[k]){const v=S[k],y=d(v.label,r);if(!y)return;j({bibleBookDisplay:v.label,locatorValue:((V=y.la)==null?void 0:V.abbr)??o.locatorValue}),f(!1)}}},onFocus:()=>f(!0),onBlur:()=>window.setTimeout(()=>f(!1),100),placeholder:c.bibleBookPlaceholder})]}),w&&l(o.bibleBookDisplay,!0).length>0&&e.jsx("div",{className:"cogita-lookup-results",children:l(o.bibleBookDisplay,!0).map((g,S)=>e.jsx("button",{type:"button",className:"cogita-lookup-option","data-active":S===k,tabIndex:-1,onMouseDown:()=>{var v;const V=d(g.label,r);V&&j({bibleBookDisplay:g.label,locatorValue:((v=V.la)==null?void 0:v.abbr)??o.locatorValue})},children:e.jsx("strong",{children:g.label})},g.latin))})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:c.bibleRestLabel}),e.jsx("input",{type:"text",value:o.locatorAux,onChange:g=>j({locatorAux:g.target.value}),placeholder:c.bibleRestPlaceholder})]})]}),o.sourceKind==="website"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceUrlLabel}),e.jsx("input",{type:"text",value:o.sourceUrl,onChange:g=>j({sourceUrl:g.target.value}),placeholder:n.cogita.library.add.info.sourceUrlPlaceholder})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceAccessedDateLabel}),e.jsx("input",{type:"text",value:o.sourceAccessedDate,onChange:g=>j({sourceAccessedDate:g.target.value}),placeholder:n.cogita.library.add.info.sourceAccessedDatePlaceholder})]})]}),o.sourceKind==="number_document"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:t,infoType:"work",label:c.churchDocumentLabel,placeholder:c.churchDocumentPlaceholder,value:o.churchDocument,onChange:g=>j({churchDocument:g}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:c.locatorLabel}),e.jsx("input",{type:"text",value:o.locatorValue,onChange:g=>j({locatorValue:g.target.value}),placeholder:c.locatorPlaceholder})]})]}),o.sourceKind==="work"&&e.jsx(Yt,{libraryId:t,infoType:"work",label:c.workLabel,placeholder:c.workPlaceholder,value:o.work,onChange:g=>j({work:g}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),o.sourceKind==="book"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:t,infoType:"media",label:c.bookLabel,placeholder:c.bookPlaceholder,value:o.bookMedia,onChange:g=>j({bookMedia:g}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.media),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:c.locatorLabel}),e.jsx("input",{type:"text",value:o.locatorValue,onChange:g=>j({locatorValue:g.target.value}),placeholder:c.locatorPlaceholder})]})]}),o.sourceKind!=="website"&&o.sourceKind!=="bible"&&o.sourceKind!=="book"&&o.sourceKind!=="number_document"&&e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:c.locatorLabel}),e.jsx("input",{type:"text",value:o.locatorValue,onChange:g=>j({locatorValue:g.target.value}),placeholder:c.locatorPlaceholder})]})]})}const _a=JSON.stringify({type:"selection",title:"Question title",question:"Question text",options:["Option A","Option B","Option C"],answer:[0]},null,2);function Ya(t="selection"){return t==="matching"?{type:t,title:"",question:"",columns:[[""],[""]],answer:{paths:[]},matchingPaths:[["",""]]}:t==="ordering"?{type:t,title:"",question:"",options:[""]}:t==="truefalse"?{type:t,title:"",question:"",answer:!0}:t==="text"||t==="date"?{type:t,title:"",question:"",answer:""}:t==="number"?{type:t,title:"",question:"",answer:""}:{type:t,title:"",question:"",options:[""],answer:[]}}function bi(t){return["selection","truefalse","text","number","date","matching","ordering"].includes(t)}function Da(t){if(!t||typeof t!="object")return null;const n=t,r=typeof n.type=="string"?n.type:typeof n.kind=="string"?n.kind:"selection",s=r==="multi_select"||r==="single_select"?"selection":r==="boolean"?"truefalse":r==="order"?"ordering":r,o=bi(s)?s:"selection",h=typeof n.title=="string"?n.title:"",c=typeof n.question=="string"?n.question:"";if(o==="matching"){let k=[];Array.isArray(n.columns)?k=n.columns.map(g=>Array.isArray(g)?g.map(S=>typeof S=="string"?S:""):[""]):Array.isArray(n.left)&&Array.isArray(n.right)&&(k=[n.left.map(g=>typeof g=="string"?g:""),n.right.map(g=>typeof g=="string"?g:"")]),k.length<2&&(k=[[""],[""]]);const i=n.answer&&typeof n.answer=="object"?n.answer:null,l=(Array.isArray(i==null?void 0:i.paths)?i==null?void 0:i.paths:Array.isArray(n.correctPairs)?n.correctPairs:[]).map(g=>Array.isArray(g)?g.map(S=>Number(S)).filter(S=>Number.isInteger(S)&&S>=0):[]).filter(g=>g.length>0),d=Array.isArray(n.matchingPaths)?n.matchingPaths.map(g=>Array.isArray(g)?Array.from({length:k.length},(S,V)=>String(g[V]??"")):new Array(k.length).fill("")):null,j=d&&d.length>0?d:[...l.map(g=>g.map(String)),new Array(k.length).fill("")];return{type:o,title:h,question:c,columns:k,answer:{paths:l},matchingPaths:j}}if(o==="ordering"){const k=Array.isArray(n.options)?n.options.map(i=>typeof i=="string"?i:""):Array.isArray(n.items)?n.items.map(i=>typeof i=="string"?i:""):[""];return{type:o,title:h,question:c,options:k.length?k:[""]}}if(o==="truefalse"){const k=typeof n.answer=="boolean"?n.answer:typeof n.expected=="boolean"?n.expected:!0;return{type:o,title:h,question:c,answer:k}}if(o==="number")return typeof n.answer=="number"?{type:o,title:h,question:c,answer:n.answer}:typeof n.answer=="string"?{type:o,title:h,question:c,answer:n.answer}:typeof n.expected=="number"?{type:o,title:h,question:c,answer:n.expected}:{type:o,title:h,question:c,answer:""};if(o==="text"||o==="date"){const k=typeof n.answer=="string"?n.answer:typeof n.expected=="string"?n.expected:"";return{type:o,title:h,question:c,answer:k}}const w=Array.isArray(n.options)?n.options.map(k=>typeof k=="string"?k:""):[""],f=Array.isArray(n.answer)?n.answer.map(k=>Number(k)).filter(k=>Number.isInteger(k)&&k>=0):Array.isArray(n.correct)?n.correct.map(k=>Number(k)).filter(k=>Number.isInteger(k)&&k>=0):[];return{type:o,title:h,question:c,options:w.length?w:[""],answer:f}}function yi(t){const n=(t.title??"").trim(),r=(t.question??"").trim();switch(t.type){case"matching":{const s=(t.columns??[[""],[""]]).map(p=>p.map(l=>l.trim()).filter(Boolean)).filter(p=>p.length>0),o=s.length>=2?s:[[""],[""]],h=t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[],c=(t.matchingPaths??[]).map(p=>p.map(l=>String(l??""))),w=o.length,f=c.map(p=>p.slice(0,w).map(l=>l.trim())).filter(p=>p.some(Boolean)).map(p=>p.map(l=>Number(l))).filter(p=>p.length===w&&p.every(l=>Number.isInteger(l)&&l>=0)),k=(Array.isArray(h)?h:[]).map(p=>Array.isArray(p)?p.map(l=>Number(l)).filter(l=>Number.isInteger(l)&&l>=0):[]).filter(p=>p.length===w),i=Array.from(new Set([...k,...f].map(p=>JSON.stringify(p)))).map(p=>JSON.parse(p));return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,columns:o,answer:{paths:i}},null,2)}case"ordering":{const s=(t.options??[]).map(o=>o.trim()).filter(Boolean);return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,options:s},null,2)}case"truefalse":return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,answer:!!t.answer},null,2);case"number":return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,answer:typeof t.answer=="number"||typeof t.answer=="string"?t.answer:""},null,2);case"date":case"text":return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,answer:String(t.answer??"")},null,2);case"selection":default:{const s=(t.options??[]).map(c=>c.trim()).filter(Boolean),o=Array.isArray(t.answer)?t.answer:[],h=Array.from(new Set(o.filter(c=>Number.isInteger(c)&&c>=0&&c<s.length))).sort((c,w)=>c-w);return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,options:s,answer:h},null,2)}}}const ks=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}];function za(){return{sourceKind:"string",locatorValue:"",locatorAux:"",bibleBookDisplay:"",sourceUrl:"",sourceAccessedDate:"",churchDocument:null,bookMedia:null,work:null}}function Ns(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function Ss(t,n){if(!t||typeof t!="object")return n;const r=t,s=r.definition&&typeof r.definition=="object"?r.definition:null,o=[r.label,r.name,r.title,r.text,r.orcid,r.email,r.number];s&&o.unshift(s.title,s.question);for(const h of o)if(typeof h=="string"&&h.trim())return h.trim();return n}function Ts(t,n){var s;if(!(t instanceof Us))return n;const r=(s=t.message)==null?void 0:s.trim();if(!r)return n;try{const o=JSON.parse(r);if(typeof o.error=="string"&&o.error.trim())return o.error.trim()}catch{}return r}function xi(t){const n=t.trim();if(!n)return null;try{const r=JSON.parse(n);return r&&typeof r=="object"&&!Array.isArray(r)?r:null}catch{return null}}function ra(t,n){const r=t==null?void 0:t[n];return typeof r=="string"?r:""}function vi(t,n){return n?t==="book"&&n.infoType==="media"?{bookMedia:n}:t==="work"&&n.infoType==="work"?{work:n}:t==="number_document"&&n.infoType==="work"?{churchDocument:n}:{}:{}}function ji(t,n){const r=za(),s=(t.sourceKind??"").trim()||r.sourceKind,o=t.locator??"",h=xi(o);let c="",w="",f="",k="",i="";return s==="website"?(k=ra(h,"url"),i=ra(h,"accessedDate"),c=ra(h,"value")):s==="bible"?(c=ra(h,"book")||o.trim(),w=ra(h,"passage")||ra(h,"rest"),f=ra(h,"bookDisplay")):h?(c=ra(h,"value")||ra(h,"locator"),w=ra(h,"aux")):c=o,{...r,sourceKind:s,locatorValue:c,locatorAux:w,bibleBookDisplay:f,sourceUrl:k,sourceAccessedDate:i,...vi(s,n)}}function An(t){return t.sourceKind==="book"?t.bookMedia:t.sourceKind==="work"?t.work:t.sourceKind==="number_document"?t.churchDocument:null}function $n(t){const n=t.locatorValue.trim(),r=t.locatorAux.trim(),s=t.sourceUrl.trim(),o=t.sourceAccessedDate.trim();switch(t.sourceKind){case"website":return{url:s,accessedDate:o};case"bible":return{book:n,bookDisplay:t.bibleBookDisplay.trim(),passage:r};case"book":case"work":case"number_document":return r?{value:n,aux:r}:n;default:return r?{value:n,aux:r}:n}}function Cs(t){var o,h,c;const n=t.locatorValue.trim(),r=t.locatorAux.trim(),s=[n,r].filter(Boolean).join(" ");switch(t.sourceKind){case"website":return t.sourceUrl.trim()||"website";case"bible":return s||"bible";case"book":return[(o=t.bookMedia)==null?void 0:o.label,s].filter(Boolean).join(" · ")||"book";case"work":return[(h=t.work)==null?void 0:h.label,s].filter(Boolean).join(" · ")||"work";case"number_document":return[(c=t.churchDocument)==null?void 0:c.label,s].filter(Boolean).join(" · ")||"number_document";default:return s||t.sourceKind||"source"}}function Is(t){return t.sourceKind.trim()?t.sourceKind==="website"?!!t.sourceUrl.trim():t.sourceKind==="bible"?!!(t.locatorValue.trim()&&t.locatorAux.trim()):t.sourceKind==="book"?!!t.bookMedia:t.sourceKind==="work"?!!t.work:t.sourceKind==="number_document"?!!(t.churchDocument&&t.locatorValue.trim()):!!t.locatorValue.trim():!1}function wi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,libraryId:i,editInfoId:p}){var Ie,ze,Xe;const{libraryName:l}=da(i),d=!!p,[j,g]=a.useState([]),[S,V]=a.useState("word"),[v,y]=a.useState({}),[K,q]=a.useState({}),[x,W]=a.useState({}),[m,D]=a.useState({}),[$,T]=a.useState(null),[he,ne]=a.useState("idle"),[je,De]=a.useState(za),[R,I]=a.useState({}),[X,_]=a.useState({}),[te,Y]=a.useState({}),[xe,le]=a.useState(null),[se,Te]=a.useState(()=>Da(JSON.parse(_a))??Ya()),[Ae,Ee]=a.useState(_a),$e=a.useMemo(()=>j.find(F=>F.infoType===S),[S,j]),et=a.useMemo(()=>j.find(F=>F.infoType==="source"),[j]),ct=a.useMemo(()=>j.map(F=>({value:F.infoType,label:nt(t,F.infoType)})),[t,j]),Ce=F=>{const A=Da(F)??Ya(),B=yi(A);Te(A),y(E=>({...E,definition:B}))};a.useEffect(()=>{let F=!1;return fr({libraryId:i}).then(A=>{var B;if(!F&&(g(A),!d)){const E=(B=A[0])==null?void 0:B.infoType;E&&V(E)}}).catch(()=>{F||g([])}),()=>{F=!0}},[d,i]),a.useEffect(()=>{if(d||!$e)return;const F={},A={},B={},E={};for(const N of $e.payloadFields)$e.infoType==="question"&&N.key==="definition"&&N.inputType==="json"?F[N.key]=_a:F[N.key]="";for(const N of $e.linkFields)N.multiple?B[N.key]=[]:A[N.key]=null,N.targetTypes.length>0&&(E[N.key]=N.targetTypes[0]);y(F),q(A),W(B),D(E)},[$e==null?void 0:$e.infoType,d]),a.useEffect(()=>{if(S!=="question")return;const F=v.definition??"";if(!F.trim()){const A=Da(JSON.parse(_a))??Ya();Te(A),Ee(_a);return}try{const A=JSON.parse(F),B=Da(A);if(!B)return;Te(B),Ee(JSON.stringify(A,null,2))}catch{}},[v.definition,S]),a.useEffect(()=>{if(!d||!p||j.length===0)return;let F=!1;return ne("loading"),T(null),(async()=>{const B=await na({libraryId:i,infoId:p});if(F)return;const E=B.infoType;V(E);const N=j.find(G=>G.infoType===E);if(!N){ne("idle");return}const C=B.payload??{},L={};for(const G of N.payloadFields)L[G.key]=Ns(C[G.key]);y(L);const ue=B.links??{}??{},be={},ge={},Z={},P=[];for(const G of N.linkFields){G.targetTypes.length>0&&(Z[G.key]=G.targetTypes[0]);const re=ue[G.key];if(G.multiple){const Q=Array.isArray(re)?re.filter(ee=>typeof ee=="string"):[];ge[G.key]=[];for(const ee of Q)P.push(na({libraryId:i,infoId:ee}).then(ye=>{if(F)return;const U={id:ee,infoType:ye.infoType,label:Ss(ye.payload,ee)};Z[G.key]=U.infoType,ge[G.key]=[...ge[G.key],U]}).catch(()=>{}))}else{const Q=typeof re=="string"?re:null;be[G.key]=null,Q&&P.push(na({libraryId:i,infoId:Q}).then(ee=>{if(F)return;const ye={id:Q,infoType:ee.infoType,label:Ss(ee.payload,Q)};Z[G.key]=ye.infoType,be[G.key]=ye}).catch(()=>{}))}}await Promise.all(P),!F&&(q(be),W(ge),D(Z),ne("idle"))})().catch(()=>{F||(T("Failed to load info details."),ne("idle"))}),()=>{F=!0}},[p,d,i,j]),a.useEffect(()=>{S==="source"&&De(ji(v,K.resource??null))},[S,v.sourceKind,v.locator,(Ie=K.resource)==null?void 0:Ie.id,(ze=K.resource)==null?void 0:ze.infoType,(Xe=K.resource)==null?void 0:Xe.label]);const We=F=>{var N,C;const A=((N=et==null?void 0:et.payloadFields.find(L=>L.key==="sourceKind"))==null?void 0:N.keepOnCreate)??!1,B=((C=et==null?void 0:et.linkFields.find(L=>L.key==="resource"))==null?void 0:C.keepOnCreate)??!1,E=za();return E.sourceKind=A?F.sourceKind:E.sourceKind,B&&(E.work=F.work,E.bookMedia=F.bookMedia,E.churchDocument=F.churchDocument),A&&F.sourceKind==="bible"&&(E.locatorValue=F.locatorValue,E.bibleBookDisplay=F.bibleBookDisplay),A&&F.sourceKind==="website"&&(E.sourceUrl=F.sourceUrl,E.sourceAccessedDate=F.sourceAccessedDate),E},xt=a.useMemo(()=>({sourceKindLabel:t.cogita.library.add.info.sourceKindLabel,bibleBookLabel:t.cogita.library.add.info.sourceBibleBookLabel,bibleBookPlaceholder:t.cogita.library.add.info.sourceBibleBookPlaceholder,bibleRestLabel:t.cogita.library.add.info.sourceBibleRestLabel,bibleRestPlaceholder:t.cogita.library.add.info.sourceBibleRestPlaceholder,churchDocumentLabel:t.cogita.library.add.info.sourceResourceLabel,churchDocumentPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,workLabel:t.cogita.library.add.info.sourceResourceLabel,workPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,bookLabel:t.cogita.library.add.info.sourceResourceLabel,bookPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,locatorLabel:t.cogita.library.list.typeFilterLocator,locatorPlaceholder:t.cogita.library.list.typeFilterLocator}),[t]),Ve=async F=>{const A=X[F]??za();if(!Is(A)){Y(B=>({...B,[F]:t.cogita.library.add.info.referenceMissingSource}));return}le(F),Y(B=>({...B,[F]:null}));try{const B=An(A),E=B?{resource:B.id}:{},N={label:Cs(A),sourceKind:A.sourceKind.trim(),locator:$n(A)},L={id:(await qn({libraryId:i,infoType:"source",payload:N,links:E})).infoId,infoType:"source",label:N.label};if(W(ue=>{const be=ue[F]??[];return be.some(ge=>ge.id===L.id)?ue:{...ue,[F]:[...be,L]}}),d&&p){const ue=await na({libraryId:i,infoId:p}),be=ue.links&&typeof ue.links=="object"?{...ue.links}:{},ge=be[F],Z=Array.isArray(ge)?ge.filter(P=>typeof P=="string"):typeof ge=="string"?[ge]:[];Z.includes(L.id)||(be[F]=[...Z,L.id],await cs({libraryId:i,infoId:p,payload:ue.payload,links:be}))}_(ue=>({...ue,[F]:We(A)})),Y(ue=>({...ue,[F]:null}))}catch(B){Y(E=>({...E,[F]:Ts(B,t.cogita.library.lookup.createFailed)}))}finally{le(B=>B===F?null:B)}},Be=async()=>{var B;if(!$e)return;const F={};for(const E of $e.payloadFields){if(S==="source"&&(E.key==="sourceKind"||E.key==="locator"))continue;const N=(v[E.key]??"").trim();if(!N){if(E.required){T(`Field '${E.label}' is required.`);return}continue}if(E.inputType==="json")try{F[E.key]=JSON.parse(N)}catch{T(`Field '${E.label}' must be valid JSON.`);return}else F[E.key]=N}const A={};for(const E of $e.linkFields)if(!(S==="source"&&E.key==="resource"))if(E.multiple){const N=(x[E.key]??[]).map(C=>C.id);if(E.required&&N.length===0){T(`Link '${E.label}' is required.`);return}N.length>0&&(A[E.key]=N)}else{const N=((B=K[E.key])==null?void 0:B.id)??null;if(E.required&&!N){T(`Link '${E.label}' is required.`);return}N&&(A[E.key]=N)}if(S==="source"){if(!Is(je)){T(t.cogita.library.add.info.referenceMissingSource);return}const E=je.sourceKind.trim();F.sourceKind=E,F.locator=$n(je),(typeof F.label!="string"||!F.label.trim())&&(F.label=Cs(je));const N=An(je);N&&(A.resource=N.id)}ne("saving"),T(null);try{if(d&&p)await cs({libraryId:i,infoId:p,payload:F,links:A}),T("Info updated.");else{await qn({libraryId:i,infoType:S,payload:F,links:A}),T("Info saved.");const E={};for(const L of $e.payloadFields)E[L.key]=L.keepOnCreate?v[L.key]??"":"";y(E);const N={},C={};for(const L of $e.linkFields)L.multiple?C[L.key]=L.keepOnCreate?x[L.key]??[]:[]:N[L.key]=L.keepOnCreate?K[L.key]??null:null;q(L=>({...L,...N})),W(L=>({...L,...C})),S==="source"&&De(L=>{const ue=We(L),be=An(ue);return y(ge=>({...ge,sourceKind:ue.sourceKind,locator:Ns($n(ue))})),q(ge=>({...ge,resource:be})),be&&D(ge=>({...ge,resource:be.infoType})),ue})}}catch(E){T(Ts(E,"Failed to save info."))}finally{ne("idle")}},tt=F=>{const A=v[F.key]??"";if(S==="question"&&F.key==="definition"&&F.inputType==="json"){const E=se.type,N=P=>{const G=se.title??"",re=se.question??"";Ce({...Ya(P),title:G,question:re})},C=P=>P.length===0?[""]:P[P.length-1].trim()?[...P,""]:P,L=P=>{const G=(P.length?P:[[""],[""]]).map(re=>C(re));return G.length>=2?G:[...G,[""]]},ue=(P,G)=>{const re=P.map(ee=>Array.from({length:G},(ye,U)=>ee[U]??"")).filter(ee=>ee.some(ye=>ye.trim())||ee===P[P.length-1]);return re.length===0?[new Array(G).fill("")]:re[re.length-1].some(ee=>ee.trim())?[...re,new Array(G).fill("")]:re},be=Array.isArray(se.answer)?se.answer:[],ge=L(se.columns??[[""],[""]]),Z=ue(se.matchingPaths??[[]],ge.length);return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:F.label}),e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.8rem"},children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question type"}),e.jsxs("select",{value:E,onChange:P=>N(P.target.value),children:[e.jsx("option",{value:"selection",children:"Selection"}),e.jsx("option",{value:"truefalse",children:"True / false"}),e.jsx("option",{value:"text",children:"Text answer"}),e.jsx("option",{value:"number",children:"Number answer"}),e.jsx("option",{value:"date",children:"Date answer"}),e.jsx("option",{value:"matching",children:"Matching"}),e.jsx("option",{value:"ordering",children:"Right order"})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Title"}),e.jsx("input",{type:"text",value:se.title??"",onChange:P=>Ce({...se,title:P.target.value}),placeholder:"Optional title"})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question"}),e.jsx("textarea",{rows:3,value:se.question??"",onChange:P=>Ce({...se,question:P.target.value}),placeholder:"Question text"})]}),E==="selection"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Options / correct indices"}),C(se.options??[""]).map((P,G,re)=>{const Q=new Set(be.filter(ye=>Number.isInteger(ye))),ee=G===re.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:Q.has(G),disabled:!P.trim(),onChange:ye=>{const U=ye.target.checked?[...Q,G]:[...Q].filter(ie=>ie!==G);Ce({...se,answer:U})}}),e.jsx("input",{type:"text",value:P,placeholder:`Answer ${G+1}`,onChange:ye=>{const U=[...se.options??[""]];U[G]=ye.target.value;const ie=C(U),Le=ie.length-1,qe=be.filter(Ke=>Ke>=0&&Ke<Le);Ce({...se,options:ie,answer:qe})}}),ee?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const U=(se.options??[""]).filter((Le,qe)=>qe!==G),ie=be.filter(Le=>Le!==G).map(Le=>Le>G?Le-1:Le);Ce({...se,options:C(U),answer:ie})},children:"Remove"})]},`question-option:${G}`)})]}):null,E==="text"||E==="date"||E==="number"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsx("input",{type:E==="date"?"date":"text",value:typeof se.answer=="string"||typeof se.answer=="number"?String(se.answer):"",onChange:P=>Ce({...se,answer:P.target.value})})]}):null,E==="truefalse"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsxs("select",{value:String(!!se.answer),onChange:P=>Ce({...se,answer:P.target.value==="true"}),children:[e.jsx("option",{value:"true",children:"True"}),e.jsx("option",{value:"false",children:"False"})]})]}):null,E==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Columns"}),ge.map((P,G)=>e.jsxs("div",{style:{display:"grid",gap:"0.35rem",border:"1px solid rgba(120,170,220,0.22)",borderRadius:"0.6rem",padding:"0.55rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"0.5rem"},children:[e.jsxs("span",{style:{fontSize:"0.8rem",color:"rgba(184,209,234,0.85)"},children:["Column ",G+1]}),ge.length>2?e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const re=ge.filter((ee,ye)=>ye!==G),Q=Z.map(ee=>ee.filter((ye,U)=>U!==G));Ce({...se,columns:L(re),matchingPaths:ue(Q,Math.max(2,re.length))})},children:"Remove column"}):null]}),P.map((re,Q)=>{const ee=Q===P.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",gap:"0.4rem",alignItems:"center"},children:[e.jsx("input",{type:"text",value:re,placeholder:`Option ${Q+1}`,onChange:ye=>{const U=ge.map(ie=>[...ie]);U[G][Q]=ye.target.value,Ce({...se,columns:L(U),matchingPaths:ue(Z,ge.length)})}}),ee?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const ye=ge.map(U=>[...U]);ye[G]=ye[G].filter((U,ie)=>ie!==Q),Ce({...se,columns:L(ye),matchingPaths:ue(Z,ge.length)})},children:"Remove"})]},`question-column:${G}:row:${Q}`)})]},`question-column:${G}`)),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{const P=[...ge.map(re=>[...re]),[""]],G=Z.map(re=>[...re,""]);Ce({...se,columns:L(P),matchingPaths:ue(G,P.length)})},children:"Add column"})}),e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Correct paths (0-based indices)"}),Z.map((P,G)=>{const re=G===Z.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:`repeat(${ge.length}, minmax(0,1fr)) auto`,gap:"0.35rem",alignItems:"center"},children:[P.map((Q,ee)=>e.jsx("input",{type:"number",min:0,step:1,value:Q,placeholder:`${ee}`,onChange:ye=>{const U=Z.map(qe=>[...qe]);U[G][ee]=ye.target.value;const ie=ue(U,ge.length),Le=ie.map(qe=>qe.map(Ke=>Ke.trim())).filter(qe=>qe.every(Ke=>Ke!=="")).map(qe=>qe.map(Ke=>Number(Ke))).filter(qe=>qe.every(Ke=>Number.isInteger(Ke)&&Ke>=0));Ce({...se,matchingPaths:ie,answer:{paths:Le}})}},`question-path:${G}:${ee}`)),re?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const Q=Z.filter((U,ie)=>ie!==G),ee=ue(Q,ge.length),ye=ee.map(U=>U.map(ie=>ie.trim())).filter(U=>U.every(ie=>ie!=="")).map(U=>U.map(ie=>Number(ie))).filter(U=>U.every(ie=>Number.isInteger(ie)&&ie>=0));Ce({...se,matchingPaths:ee,answer:{paths:ye}})},children:"Remove"})]},`question-path:${G}`)})]}):null,E==="ordering"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Ordered options (correct order = listed order)"}),C(se.options??[""]).map((P,G,re)=>{const Q=G===re.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)",minWidth:"1.5rem"},children:[G+1,"."]}),e.jsx("input",{type:"text",value:P,placeholder:`Step ${G+1}`,onChange:ee=>{const ye=[...se.options??[""]];ye[G]=ee.target.value,Ce({...se,options:C(ye)})}}),Q?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ce({...se,options:C((se.options??[]).filter((ee,ye)=>ye!==G))}),children:"Remove"})]},`question-order:${G}`)})]}):null,e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"JSON import"}),e.jsx("textarea",{rows:8,value:Ae,onChange:P=>Ee(P.target.value),placeholder:"Paste question JSON"}),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{try{const P=JSON.parse(Ae),G=Da(P);if(!G){T("Question JSON must be an object.");return}Ce(G),T(null)}catch{T("Question JSON is invalid.")}},children:"Interpret JSON"})})]})]})]},`payload:${F.key}`)}const B=F.inputType==="textarea"||F.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:F.label}),B?e.jsx("textarea",{rows:F.inputType==="json"?8:4,value:A,onChange:E=>y(N=>({...N,[F.key]:E.target.value})),placeholder:F.key}):e.jsx("input",{type:"text",value:A,onChange:E=>y(N=>({...N,[F.key]:E.target.value})),placeholder:F.key})]},`payload:${F.key}`)},ot=F=>{const A=m[F.key]??F.targetTypes[0],B=F.key==="references"&&F.multiple&&F.targetTypes.includes("source"),E=X[F.key]??za(),N=R[F.key]??!1,C=te[F.key];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:F.label}),F.targetTypes.length>1?e.jsx("select",{value:A,onChange:L=>D(ue=>({...ue,[F.key]:L.target.value})),children:F.targetTypes.map(L=>e.jsx("option",{value:L,children:nt(t,L)},`${F.key}:${L}`))}):null,F.multiple?e.jsx(Yt,{libraryId:i,infoType:A,label:F.label,placeholder:F.key,multiple:!0,values:x[F.key]??[],onChangeMultiple:L=>W(ue=>({...ue,[F.key]:L})),allowCreate:!B,searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(Yt,{libraryId:i,infoType:A,label:F.label,placeholder:F.key,value:K[F.key]??null,onChange:L=>q(ue=>({...ue,[F.key]:L})),searchFailedText:"Search failed",createFailedText:"Create failed"}),B?e.jsxs("div",{children:[e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:N,onChange:L=>I(ue=>({...ue,[F.key]:L.target.checked}))}),e.jsx("span",{children:t.cogita.library.add.info.referenceToggle})]}),N?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(ws,{libraryId:i,copy:t,language:f,sourceKindOptions:[...ks],value:E,onChange:L=>_(ue=>({...ue,[F.key]:L})),labels:xt}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>Ve(F.key),disabled:xe===F.key,children:xe===F.key?t.cogita.library.lookup.saving:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.source)})}),C?e.jsx("p",{className:"cogita-library-subtitle",children:C}):null]}):null]}):null]},`link:${F.key}`)},Ye=()=>e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(ws,{libraryId:i,copy:t,language:f,sourceKindOptions:[...ks],value:je,onChange:De,labels:xt})]});return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:d?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${i}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[d?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:S,onChange:F=>V(F.target.value),children:ct.map(F=>e.jsx("option",{value:F.value,children:F.label},F.value))})]}),he==="loading"&&d?e.jsx("p",{children:"Loading..."}):null,$e&&!(he==="loading"&&d)?e.jsxs("div",{className:"cogita-form-grid",children:[$e.payloadFields.filter(F=>!(S==="source"&&(F.key==="sourceKind"||F.key==="locator"))).map(tt),S==="source"?Ye():null,$e.linkFields.filter(F=>!(S==="source"&&F.key==="resource")).map(ot)]}):he==="loading"&&d?null:e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:Be,disabled:he==="saving"||!$e,children:he==="saving"?"Saving...":d?"Update info":"Create info"})}),$?e.jsx("p",{className:"cogita-library-subtitle",children:$}):null]})})})]})})}const Ms=t=>/\s/.test(t),sn=t=>/[\p{L}\p{N}]/u.test(t),Ls=(t,n)=>{const r=n>0?t[n-1]:"",s=n<t.length?t[n]:"";if(!r||!s)return 0;const o=Ms(r),h=Ms(s);if(o||h)return 3;const c=sn(r),w=sn(s);return c!==w?2:!c&&!w?1:0},Rn=(t,n,r,s,o)=>{const h=Math.max(s-n,r-s);for(let c=0;c<=h;c+=1){const w=s-c;if(w>=n&&w<=r&&Ls(t,w)>=o)return w;const f=s+c;if(f>=n&&f<=r&&Ls(t,f)>=o)return f}return null},Pn=(t,n)=>{const r=n>0?t[n-1]:"",s=n<t.length?t[n]:"";return!r||!s?!0:sn(r)!==sn(s)},ki=(t,n,r,s)=>{const o=r-n,h=n+s,c=r-s;if(o<=s*2||c<=h)return null;const w=Math.floor((n+r)/2),f=Rn(t,h,c,w,3);if(f!==null&&Pn(t,f))return f;const k=Rn(t,h,c,w,2);if(k!==null&&Pn(t,k))return k;const i=Rn(t,h,c,w,1);return i!==null&&Pn(t,i)?i:null},va=(t,n)=>{const r=Math.max(1,(n==null?void 0:n.minLen)??7),s=Math.max(r,(n==null?void 0:n.maxLen)??13),o={},h=(f,k,i,p,l)=>{const d=String(p),j={id:d,start:f,end:k,text:t.slice(f,k),depth:i,index:p,parentId:l};if(o[d]=j,k-f>s){let S=ki(t,f,k,r);if(S!==null&&S>f&&S<k){const V=h(f,S,i+1,p*2+1,d),v=h(S,k,i+1,p*2+2,d);j.leftId=V.id,j.rightId=v.id}}return j},c=h(0,t.length,0,0),w=Object.values(o).sort((f,k)=>k.depth-f.depth||f.start-k.start).map(f=>f.id);return{text:t,rootId:c.id,nodes:o,order:w}},$a=(t,n,r,s,o,h,c)=>{const w=h==="reverse"?t.order.slice().sort((f,k)=>t.nodes[k].start-t.nodes[f].start||t.nodes[k].depth-t.nodes[f].depth):t.order;for(const f of w){if(c&&f===c||n.has(f))continue;const k=t.nodes[f];if(k){if(o&&(k.leftId||k.rightId)){const i=k.leftId?r[k.leftId]??0:s,p=k.rightId?r[k.rightId]??0:s;if((i+p)/2<s)continue}return k}}return null},xn=(t,n)=>({before:t.slice(0,n.start),fragment:t.slice(n.start,n.end),after:t.slice(n.end)});function Ni({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,libraryId:i}){const p=`/#/cogita/library/${i}`,[l,d,j]=Hn([]),[g,S,V]=Wn([]),[v,y]=a.useState(null),[K,q]=a.useState(null),[x,W]=a.useState(null),[m,D]=a.useState(null),$=a.useMemo(()=>l.find(I=>I.id===v)??null,[l,v]);a.useEffect(()=>{let I=!0;return br({libraryId:i}).then(X=>{if(!I)return;const _=X.nodes.map(te=>{var Y,xe,le;return{id:te.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:te.payload&&typeof te.payload=="object"&&"label"in te.payload?String(te.payload.label):"Item",nodeType:te.nodeType,itemType:((Y=te.payload)==null?void 0:Y.itemType)??"info",itemId:((xe=te.payload)==null?void 0:xe.itemId)??null,infoType:((le=te.payload)==null?void 0:le.infoType)??null}}});d(_),S(X.edges.map(te=>({id:te.edgeId,source:te.fromNodeId,target:te.toNodeId})))}).catch(()=>{I&&(d([]),S([]))}),()=>{I=!1}},[i]),a.useEffect(()=>{yr({libraryId:i}).then(q).catch(()=>q(null))},[i,l,g]);const T=a.useCallback(I=>{S(X=>Qn(I,X))},[]),he=()=>{const I=crypto.randomUUID();d(X=>[...X,{id:I,type:"default",position:{x:140+X.length*40,y:120+X.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},ne=()=>{const I=crypto.randomUUID();d(X=>[...X,{id:I,type:"default",position:{x:180+X.length*40,y:160+X.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},je=async()=>{W(null);try{const I=l.map(_=>({nodeId:_.id,nodeType:_.data.nodeType,payload:{itemType:_.data.itemType,itemId:_.data.itemId??null,label:_.data.label,infoType:_.data.infoType??null}})),X=g.map(_=>({edgeId:_.id,fromNodeId:_.source,toNodeId:_.target}));await xr({libraryId:i,nodes:I,edges:X}),W(t.cogita.library.graph.saveSuccess)}catch{W(t.cogita.library.graph.saveFail)}},De=I=>{$&&d(X=>X.map(_=>_.id===$.id?{..._,data:{..._.data,itemId:(I==null?void 0:I.infoId)??null,itemType:"collection",infoType:"collection",label:(I==null?void 0:I.label)??t.cogita.library.infoTypes.collection}}:_))},R=I=>{$&&d(X=>X.map(_=>_.id===$.id?{..._,data:{..._.data,itemId:(I==null?void 0:I.infoId)??null,itemType:"info",infoType:(I==null?void 0:I.infoType)??null,label:(I==null?void 0:I.label)??t.cogita.library.infoTypes.any}}:_))};return a.useEffect(()=>{if(!$||$.data.nodeType!=="info"||$.data.infoType!=="citation"||!$.data.itemId){D(null);return}let I=!0;return na({libraryId:i,infoId:$.data.itemId}).then(X=>{if(!I)return;const _=X.payload,te=(_==null?void 0:_.text)??"";if(!te){D(null);return}const Y=va(te),xe=Object.values(Y.nodes).sort((le,se)=>le.depth-se.depth||le.start-se.start).map(le=>({id:le.id,text:le.text,depth:le.depth}));D({title:(_==null?void 0:_.title)??$.data.label,fragments:xe})}).catch(()=>D(null)),()=>{I=!1}},[i,$]),e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:p,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:je,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:he,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ne,children:t.cogita.library.actions.addInfo}),K?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(K.totalCollections))})}):null,x?e.jsx("p",{className:"cogita-help",children:x}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(pn,{nodes:l,edges:g,onNodesChange:j,onEdgesChange:V,onConnect:T,onNodeClick:(I,X)=>y(X.id),fitView:!0,children:[e.jsx(fn,{gap:18,size:1}),e.jsx(bn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),$?e.jsxs("div",{className:"cogita-graph-inspector",children:[$.data.nodeType==="collection"?e.jsx(Yt,{libraryId:i,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:$.data.itemId?{id:$.data.itemId,label:$.data.label,infoType:"collection"}:null,onChange:De,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(Yt,{libraryId:i,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:$.data.itemId?{id:$.data.itemId,label:$.data.label,infoType:$.data.infoType??void 0}:null,onChange:R,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),m?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:m.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:m.fragments.map(I=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:I.id}),e.jsx("span",{children:I.text})]},I.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function es({children:t,flashState:n,flashTick:r=0,feedbackToken:s,className:o}){const h=s??(n?`${n}-${r}`:"idle");return e.jsx("section",{className:o?`cogita-revision-card ${o}`:"cogita-revision-card","data-feedback":h,children:t})}function ts({copy:t,currentCard:n,currentTypeLabel:r,prompt:s,languages:o,answer:h,onAnswerChange:c,computedExpected:w,computedAnswers:f,onComputedAnswerChange:k,answerTemplate:i,outputVariables:p,variableValues:l,computedFieldFeedback:d,feedback:j,canAdvance:g,quoteContext:S,quotePlaceholder:V,onCheckAnswer:v,onSkip:y,onLanguageSelect:K,onMarkReviewed:q,onAdvance:x,showCorrectAnswer:W,setShowCorrectAnswer:m,onRevealCorrect:D,answerMask:$,expectedAnswer:T,hasExpectedAnswer:he,handleComputedKeyDown:ne,answerInputRef:je,computedInputRefs:De,scriptMode:R,setScriptMode:I,matchPairs:X,matchLeftOrder:_,matchRightOrder:te,matchSelection:Y,matchActiveLeft:xe,matchActiveRight:le,matchFeedback:se,onMatchLeftSelect:Te,onMatchRightSelect:Ae,disableCheckAnswer:Ee=!1,hideSkipAction:$e=!1,allowRevealBeforeCheck:et=!1,autoRevealAfterAnswer:ct=!1,disableCheckAfterAnswer:Ce=!1}){const We=a.useMemo(()=>{var G;const A=!i&&w.length===2?`The {${w[0].key}} is of type {${w[1].key}}`:null,B=i??A;if(!B)return null;const E=new Map(w.map(re=>[re.key,re.expected])),N=new Set,C=[],L=/\{([^}]+)\}/g;let ue=0,be,ge=null;for(;(be=L.exec(B))!==null;){const re=B.slice(ue,be.index);re&&C.push({type:"text",value:re});const Q=((G=be[1])==null?void 0:G.trim())??"",ee=Q&&E.has(Q)?Q:Q&&p&&p[Q]?p[Q]:null;Q&&N.add(Q),ee&&N.add(ee),ee&&E.has(ee)?(C.push({type:"input",value:ee}),ge||(ge=ee)):Q&&l&&l[Q]!==void 0?C.push({type:"text",value:l[Q]}):C.push({type:"text",value:be[0]}),ue=be.index+be[0].length}const Z=B.slice(ue);return Z&&C.push({type:"text",value:Z}),w.filter(re=>!N.has(re.key)).length>0?null:{parts:C,expectedByKey:E,firstInputKey:ge}},[i,w,p,l]),xt=()=>{if(!We)return null;const{parts:A,expectedByKey:B,firstInputKey:E}=We;return e.jsx("div",{className:"cogita-revision-inline-answer",children:A.map((N,C)=>{var L,ue;return N.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:N.value},`text-${C}`):e.jsx("input",{ref:be=>{De.current[N.value]=be},autoFocus:N.value===E,value:f[N.value]??"",onChange:be=>k(N.value,be.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":d[N.value]??(j==="correct"?"correct":j==="incorrect"?"incorrect":void 0),onKeyDown:be=>ot(be)||ne(be),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((L=f[N.value])==null?void 0:L.length)??0,((ue=B.get(N.value))==null?void 0:ue.length)??6)}ch`}},`input-${N.value}-${C}`)})})},Ve=a.useMemo(()=>{const A=new Map;return(X??[]).forEach(B=>A.set(B.leftId,B)),A},[X]),Be=a.useMemo(()=>{const A=new Map;return(X??[]).forEach(B=>A.set(B.rightId,B)),A},[X]);a.useEffect(()=>{var C;if(n.cardType!=="info"||n.infoType!=="computed"||w.length===0)return;const A=typeof document<"u"?document.activeElement:null;if(A&&(A.tagName==="INPUT"||A.tagName==="TEXTAREA"))return;const B=(We==null?void 0:We.firstInputKey)??((C=w[0])==null?void 0:C.key);if(!B)return;const E=De.current[B];if(!E)return;const N=requestAnimationFrame(()=>{E.focus()});return()=>cancelAnimationFrame(N)},[n,w,We]);const tt=(()=>{const A=[T??"",...w.map(N=>N.expected??"")].join(""),B=[h,...Object.values(f)].join(""),E=`${A}${B}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(E)})(),ot=A=>A.ctrlKey&&(A.key==="^"||A.key==="6")?(A.preventDefault(),I(B=>B==="super"?null:"super"),!0):A.ctrlKey&&(A.key==="_"||A.key==="-")?(A.preventDefault(),I(B=>B==="sub"?null:"sub"),!0):!1,Ye=()=>{if(!T||!$)return T??"";const A=T.split(""),B=Array.from($),E=B.length>0?B.reduce((N,C)=>N+C,0)/B.length:127;return A.map((N,C)=>{const L=B[C]??E,ue=Math.max(0,Math.min(255,Math.round(L)));let be=255,ge=0;return ue<=127?ge=Math.round(ue/127*255):(ge=255,be=Math.round(255*(1-(ue-127)/128))),e.jsx("span",{style:{color:`rgb(${be}, ${ge}, 0)`},children:N},`mask-${C}`)})},Ie=n.cardType==="info"&&n.infoType==="citation"?(S==null?void 0:S.title)||n.label:n.description,ze=W||ct&&j!==null,Xe=Ee||Ce&&(j!==null||ze),F=he&&(et||j==="incorrect"||ze);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[r?e.jsx("span",{children:r}):null,e.jsx("strong",{children:Ie})]}),n.cardType==="vocab"&&n.checkType==="translation-match"&&X?e.jsxs("div",{className:"cogita-revision-body",children:[s?e.jsx("h2",{children:s}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(_??[]).map(A=>{const B=Ve.get(A);if(!B)return null;const E=(Y==null?void 0:Y[A])??null,N=(se==null?void 0:se[A])??null,C=xe===A;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":C,"data-state":N??void 0,"data-locked":E?"true":void 0,onClick:()=>Te==null?void 0:Te(A),children:[e.jsx("span",{children:B.leftLabel}),E&&W?e.jsx("em",{children:"✓"}):null]},A)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(te??[]).map(A=>{const B=Be.get(A);if(!B)return null;const E=Object.values(Y??{}).includes(A),N=le===A;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":E||N,"data-locked":E?"true":void 0,onClick:()=>Ae==null?void 0:Ae(A),children:e.jsx("span",{children:B.rightLabel})},A)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:n.checkType==="translation-match"||Xe,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):n.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:s}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:je,value:h,onChange:A=>c(A.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":j==="correct"?"correct":j==="incorrect"?"incorrect":void 0,onKeyDown:A=>{if(A.key==="Enter")if(A.preventDefault(),A.stopPropagation(),g)x();else{if(Xe)return;v()}}})]}),tt?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":R==="super",onClick:()=>I(A=>A==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":R==="sub",onClick:()=>I(A=>A==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:Xe,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[n.label?e.jsx("p",{className:"cogita-revision-hint",children:n.label}):null,i?null:e.jsx(vr,{value:s??"",mode:"auto"}),w.length>0?(()=>{const A=xt();return A?e.jsx("div",{className:"cogita-inline-answer-wrap",children:A}):e.jsx("div",{className:"cogita-form-grid",children:w.map((B,E)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:B.key}),e.jsx("textarea",{ref:N=>{De.current[B.key]=N},autoFocus:E===0,value:f[B.key]??"",onChange:N=>k(B.key,N.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":d[B.key]??(j==="correct"?"correct":j==="incorrect"?"incorrect":void 0),onKeyDown:N=>ot(N)||ne(N)})]},B.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:je,value:h,onChange:A=>c(A.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":j==="correct"?"correct":j==="incorrect"?"incorrect":void 0,onKeyDown:A=>{if(!ot(A)&&A.key==="Enter")if(A.preventDefault(),A.stopPropagation(),g)x();else{if(Xe)return;v()}}})]})}),tt?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":R==="super",onClick:()=>I(A=>A==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":R==="sub",onClick:()=>I(A=>A==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:Xe,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="citation"&&S?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(S.completed)).replace("{total}",String(S.total))}),e.jsx("p",{className:"cogita-quote-text",children:S.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:je,value:h,onChange:A=>c(A.target.value),placeholder:V??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":j==="correct"?"correct":j==="incorrect"?"incorrect":void 0,onKeyDown:A=>{if(A.key==="Enter")if(A.preventDefault(),A.stopPropagation(),g)x();else{if(Xe)return;v()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:S.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:Xe,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:s}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:o.length?o.map(A=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>K(A.label),children:A.label},A.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:s}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:q,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}),j&&e.jsx("div",{className:"cogita-revision-feedback","data-state":j,children:j==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),F?e.jsxs("div",{className:"cogita-revision-reveal",children:[ze?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>m(A=>{const B=!A;return B&&D(),B}),children:t.cogita.library.revision.showAnswer}),ze?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),w.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[w.map(A=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:A.key}),e.jsx("span",{children:A.expected})]},A.key)),T?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:T})]}):null]}):e.jsx("p",{children:$?Ye():T})]}):null]}):null,g?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:x,children:t.cogita.library.revision.nextQuestion})}):null]})}const As={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},Si=(t,n)=>{const r=Math.max(t.length,n.length,1),s=Math.abs(t.length-n.length);return Math.max(0,1-s/r)},Ti=(t,n)=>{const r=new Uint8Array(t.length),s=Si(t,n);for(let o=0;o<t.length;o+=1){const h=t[o]===(n[o]??"")?128:0,c=t.length-1-o,w=n.length-1-o,f=t[c]===(n[w]??"")?127:0,k=Math.round((h+f)*s);r[o]=Math.max(0,Math.min(255,k))}return r},Ci=(t,n)=>t===n||(As[t]??[]).includes(n)?!0:(As[n]??[]).includes(t),Xa=(t,n,r)=>r?Ci(t,n):t===n,rn=(t,n,r)=>{const s=new Uint8Array(t.length);if(!t.length)return s;const o=(r==null?void 0:r.allowSimilarChars)??!0,h=[];for(let w=0;w<=t.length-3;w+=1)h.push({index:w,text:t.slice(w,w+3)});let c=!1;return h.forEach(w=>{for(let f=0;f<=n.length-3;f+=1){const k=n.slice(f,f+3);let i=0;for(let g=0;g<3;g+=1)Xa(w.text[g],k[g],o)&&(i+=1);if(i<2)continue;let p=w.index-1,l=f-1;for(;p>=0&&l>=0;){const g=t[p],S=n[l];if(g===S){s[p]=Math.max(s[p],255),p-=1,l-=1,c=!0;continue}if(Xa(g,S,o)&&g!==S){s[p]=Math.max(s[p],127),p-=1,l-=1,c=!0;continue}if(p>0&&t[p-1]===S){s[p]=Math.max(s[p],0),p-=1,c=!0;continue}if(l>0&&t[p]===n[l-1]){l-=1,c=!0;continue}break}for(let g=0;g<3;g+=1){const S=w.index+g,V=w.text[g],v=k[g],y=V===v?255:Xa(V,v,o)?127:0;s[S]=Math.max(s[S],y),c=!0}let d=w.index+3,j=f+3;for(;d<t.length&&j<n.length;){const g=t[d],S=n[j];if(g===S){s[d]=Math.max(s[d],255),d+=1,j+=1,c=!0;continue}if(Xa(g,S,o)&&g!==S){s[d]=Math.max(s[d],127),d+=1,j+=1,c=!0;continue}if(d+1<t.length&&t[d+1]===S){s[d]=Math.max(s[d],0),d+=1,c=!0;continue}if(j+1<n.length&&t[d]===n[j+1]){j+=1,c=!0;continue}break}}}),c?s:Ti(t,n)},En=t=>/[\p{L}\p{N}]/u.test(t),$s=t=>t.trim().toLowerCase(),xa=(t,n)=>{if(t.length===0)return 100;const r=(n==null?void 0:n.treatSimilarCharsAsSame)??!1,s=Array.from(t).reduce((o,h)=>r&&h===127?o+255:o+h,0);return Math.round(s/(t.length*255)*100)},Sa=(t,n,r)=>{const s=Math.max(0,Math.min(100,(r==null?void 0:r.thresholdPercent)??100)),o=(r==null?void 0:r.treatSimilarCharsAsSame)??!0,h=(r==null?void 0:r.ignorePunctuationAndSpacing)??!1,c=$s(t),w=$s(n);if(!h){const v=rn(c,w,{allowSimilarChars:o}),y=xa(v,{treatSimilarCharsAsSame:o});return{mask:v,percent:y,isCorrect:y>=s,normalizedExpected:c,normalizedAnswer:w}}const f=Array.from(c),k=Array.from(w),i=[],p=[],l=[];f.forEach((v,y)=>{En(v)&&(i.push(v),p.push(y))}),k.forEach(v=>{En(v)&&l.push(v)});const d=i.join(""),j=l.join(""),g=rn(d,j,{allowSimilarChars:o}),S=new Uint8Array(f.length);for(let v=0;v<S.length;v+=1)S[v]=En(f[v]??"")?0:255;for(let v=0;v<g.length;v+=1){const y=p[v];y!==void 0&&(S[y]=g[v])}const V=xa(g,{treatSimilarCharsAsSame:o});return{mask:S,percent:V,isCorrect:V>=s,normalizedExpected:d,normalizedAnswer:j}},Ra=(t,n,r)=>{const s=t.trim().toLowerCase(),o=n.trim().toLowerCase();return r==="prefix"||r==="bidirectional"?rn(s,o,{allowSimilarChars:!0}):rn(s,o,{allowSimilarChars:!0})};function Ii(t){if(!t||typeof t!="object")return null;const r=t.definition;if(!r||typeof r!="object")return null;const s=r,o=typeof s.type=="string"?s.type:typeof s.kind=="string"?s.kind:"selection",h=o==="multi_select"||o==="single_select"?"selection":o==="boolean"?"truefalse":o==="order"?"ordering":o;if(!["selection","truefalse","text","number","date","ordering","matching"].includes(h))return null;const c=h,w=typeof s.title=="string"?s.title:void 0,f=typeof s.question=="string"?s.question:"",k=Array.isArray(s.options)?s.options.map(l=>typeof l=="string"?l:"").filter(Boolean):void 0,i=Array.isArray(s.columns)?s.columns.map(l=>Array.isArray(l)?l.map(d=>typeof d=="string"?d:"").filter(Boolean):[]).filter(l=>l.length>0):void 0,p=(()=>{if(h==="selection")return(Array.isArray(s.answer)?s.answer:Array.isArray(s.correct)?s.correct:[]).map(d=>Number(d)).filter(d=>Number.isInteger(d)&&d>=0);if(h==="truefalse")return typeof s.answer=="boolean"?s.answer:typeof s.expected=="boolean"?s.expected:!1;if(h==="matching"){const l=s.answer&&typeof s.answer=="object"?s.answer:null;return{paths:(Array.isArray(l==null?void 0:l.paths)?l==null?void 0:l.paths:Array.isArray(s.correctPairs)?s.correctPairs:[]).map(g=>Array.isArray(g)?g.map(S=>Number(S)).filter(S=>Number.isInteger(S)&&S>=0):[]).filter(g=>g.length>0)}}if(typeof s.answer=="string"||typeof s.answer=="number")return s.answer;if(typeof s.expected=="string"||typeof s.expected=="number")return s.expected})();return{type:c,title:w,question:f,options:k,columns:i,answer:p}}function Mi(t){var o;if(t.type!=="matching")return[[]];const n=Math.max(2,((o=t.columns)==null?void 0:o.length)??2);return[...((t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[])??[]).map(h=>Array.from({length:n},(c,w)=>String(h[w]??""))),new Array(n).fill("")]}function Li(t){const n=[...t];for(let r=n.length-1;r>0;r-=1){const s=Math.floor(Math.random()*(r+1));[n[r],n[s]]=[n[s],n[r]]}return n}function ia(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function Rs(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function Ps(t){const n=t.checkType??"info",r=n.startsWith("question-")?`question / ${n.slice(9)}`:n;return t.direction?`${r} / ${t.direction}`:r}function Ai({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,libraryId:i,infoId:p,selectedReviewerRoleId:l}){const[d,j]=a.useState(p),[g,S]=a.useState([]),[V,v]=a.useState([]),[y,K]=a.useState("loading"),[q,x]=a.useState(null),[W,m]=a.useState(null),[D,$]=a.useState(null),[T,he]=a.useState(null),[ne,je]=a.useState(""),[De,R]=a.useState(null),[I,X]=a.useState(1),[_,te]=a.useState(null),[Y,xe]=a.useState(0),[le,se]=a.useState(!1),[Te,Ae]=a.useState(null),[Ee,$e]=a.useState({}),[et,ct]=a.useState({}),[Ce]=a.useState({}),[We,xt]=a.useState(null),[Ve,Be]=a.useState({selection:[],booleanAnswer:null,ordering:[],matchingRows:[[]]}),tt=a.useRef(null),ot=a.useRef({}),Ye=mn();a.useEffect(()=>{let Z=!1;return K("loading"),Promise.all([na({libraryId:i,infoId:p}).catch(()=>null),tn({libraryId:i,infoId:p}),an({libraryId:i,infoId:p})]).then(([P,G,re])=>{if(Z)return;const Q=(P==null?void 0:P.payload)??{},ee=typeof Q.title=="string"&&Q.title||typeof Q.label=="string"&&Q.label||typeof Q.name=="string"&&Q.name||p;j(ee),m(Q),$((P==null?void 0:P.infoType)??null),S(G.items),v(re.items),K("ready")}).catch(()=>{Z||(m(null),$(null),S([]),v([]),K("error"))}),()=>{Z=!0}},[i,p]),a.useEffect(()=>{if(D!=="translation"){he(null);return}qs({libraryId:i,infoId:p,approachKey:"vocab-card"}).then(Z=>he(Z.projection??null)).catch(()=>he(null))},[D,p,i]);const Ie=a.useMemo(()=>{var ye;const Z=new Map(g.map(U=>[ia(U),U])),P=new Map,G=new Map;for(const U of g)P.set(ia(U),0),G.set(ia(U),[]);for(const U of V){const ie=Rs({parentItemId:U.parentItemId,parentCheckType:U.parentCheckType,parentDirection:U.parentDirection}),Le=[U.childItemId,U.childCheckType??"",U.childDirection??""].join("|");!Z.has(ie)||!Z.has(Le)||((ye=G.get(ie))==null||ye.push(Le),P.set(Le,(P.get(Le)??0)+1))}const re=Array.from(P.entries()).filter(([,U])=>U===0).map(([U])=>U),Q=new Map;for(const U of re)Q.set(U,0);for(;re.length;){const U=re.shift(),ie=Q.get(U)??0;for(const Le of G.get(U)??[]){const qe=Math.max(Q.get(Le)??0,ie+1);Q.set(Le,qe),P.set(Le,(P.get(Le)??1)-1),(P.get(Le)??0)<=0&&re.push(Le)}}const ee=new Map;for(const U of g){const ie=ia(U),Le=Q.get(ie)??0,qe=ee.get(Le)??[];qe.push(ie),ee.set(Le,qe)}return g.map(U=>{const ie=ia(U),Le=Q.get(ie)??0,qe=ee.get(Le)??[ie],Ke=Math.max(0,qe.indexOf(ie));return{id:ie,position:{x:40+Ke*290+(Le%2?18:0),y:30+Le*120},draggable:!1,selectable:!0,data:{label:U.label,subtitle:Ps(U),checkType:U.checkType??"info",direction:U.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[g,V]),ze=a.useMemo(()=>new Map(g.map(Z=>[ia(Z),Z])),[g]),Xe=a.useMemo(()=>{const Z=[];for(const P of V){const G=Rs({parentItemId:P.parentItemId,parentCheckType:P.parentCheckType,parentDirection:P.parentDirection}),re=[P.childItemId,P.childCheckType??"",P.childDirection??""].join("|");!ze.has(G)||!ze.has(re)||Z.push({id:`${G}->${re}`,source:G,target:re,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return Z},[ze,V]),F=a.useMemo(()=>q?ze.get(q)??null:null,[ze,q]);a.useEffect(()=>{je(""),te(null),xe(0),se(!1),Ae(null),R(null),ct({}),Be({selection:[],booleanAnswer:null,ordering:[],matchingRows:[[]]})},[q]);const A=a.useMemo(()=>{var Q,ee;if(!F)return null;const Z=D??F.infoType??null,P=F.checkType??"info",G=F.direction??null,re=W??{};if(F.cardType==="vocab"&&T&&Array.isArray(T.words)){const ye=T.words,U=((Q=ye[0])==null?void 0:Q.label)??"?",ie=((ee=ye[1])==null?void 0:ee.label)??"?";return G==="a-to-b"?{kind:"vocab",prompt:String(U),expected:String(ie)}:G==="b-to-a"?{kind:"vocab",prompt:String(ie),expected:String(U)}:{kind:"generic",prompt:`${U} ↔ ${ie}`,expected:`${U} ↔ ${ie}`}}if(Z==="citation"&&P==="quote-fragment"&&G&&typeof re.text=="string"){const ye=G,U=va(re.text),ie=U.nodes[ye];if(ie){const Le=xn(re.text,ie);return{kind:"citation-fragment",expected:ie.text,quoteContext:{title:d,before:Le.before,after:Le.after,total:Object.keys(U.nodes).length,completed:0},quotePlaceholder:ie.text.length>0?".".repeat(Math.max(4,Math.min(18,ie.text.length))):"..."}}}if(Z==="question"){const ye=Ii(re);if(ye)return{kind:"question",definition:ye}}return{kind:"generic",prompt:F.description||F.label,expected:F.label}},[D,W,F,d,T]);a.useEffect(()=>{if(!A||A.kind!=="question")return;const Z=A.definition;Be({selection:[],booleanAnswer:null,ordering:Z.type==="ordering"?Li(Z.options??[]):[],matchingRows:Z.type==="matching"?Mi(Z):[[]]})},[A,q]);const B=async Z=>{if(F&&l)try{await jr({libraryId:i,outcome:{itemType:"info",itemId:F.cardId,checkType:F.checkType??"info",direction:F.direction??null,revisionType:"direct",evalType:"direct-check",correct:Z,clientId:"cogita-info-checkcards",clientSequence:I,personRoleId:l}}),X(P=>P+1),R(Z?"Saved as correct.":"Saved as incorrect.")}catch{R("Failed to save answer.")}},E=F?ia(F):null,N=E?!!Ee[E]:!1,C=async()=>{var re;if(!F||!A)return;const Z=ia(F);if(Ee[Z]){R("This card was already checked.");return}let P=!1,G=null;if(A.kind==="question"){const Q=A.definition;if(Q.type==="selection"){const ee=Array.isArray(Q.answer)?[...Q.answer].sort((U,ie)=>U-ie):[],ye=[...Ve.selection].sort((U,ie)=>U-ie);P=ee.length===ye.length&&ee.every((U,ie)=>U===ye[ie])}else if(Q.type==="truefalse")P=typeof Q.answer=="boolean"&&Ve.booleanAnswer!==null&&Q.answer===Ve.booleanAnswer;else if(Q.type==="ordering"){const ee=(Q.options??[]).join(`
`),ye=Ve.ordering.join(`
`),U=Sa(ee,ye,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});P=U.isCorrect,G=U.mask}else if(Q.type==="matching"){const ee=Math.max(2,((re=Q.columns)==null?void 0:re.length)??2),ye=Ve.matchingRows.map(qe=>qe.slice(0,ee).map(Ke=>Ke.trim())).filter(qe=>qe.every(Ke=>Ke!=="")).map(qe=>qe.map(Ke=>Number(Ke))).filter(qe=>qe.every(Ke=>Number.isInteger(Ke)&&Ke>=0)).map(qe=>JSON.stringify(qe)),U=(Q.answer&&typeof Q.answer=="object"&&"paths"in Q.answer?Q.answer.paths:[]).map(qe=>JSON.stringify(qe)),ie=Array.from(new Set(ye)).sort(),Le=Array.from(new Set(U)).sort();P=ie.length===Le.length&&ie.every((qe,Ke)=>qe===Le[Ke])}else{const ee=String(Q.answer??""),ye=Sa(ee,ne,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});P=ye.isCorrect,G=ye.mask}Ae(G),se(!0)}else{const Q=A.expected,ee=A.kind==="citation-fragment",ye=Sa(Q,ne,{thresholdPercent:ee?90:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:ee});P=ye.isCorrect,Ae(ye.mask),se(!0)}te(P?"correct":"incorrect"),xe(Q=>Q+1),R(l?null:"Answer checked locally (not saved: no person selected)."),$e(Q=>({...Q,[Z]:!0})),l&&await B(P)},L=()=>{if(!F||!A)return;const Z=ia(F);if(Ee[Z]||($e(G=>({...G,[Z]:!0})),R("Answer revealed (not saved).")),A.kind==="question"){Ae(null);return}const P=Sa(A.expected,A.expected,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:A.kind==="citation-fragment"});Ae(P.mask)},ue=a.useMemo(()=>F?F.infoType==="question"?{...F,description:F.label}:F.infoType==="citation"?{...F,description:d}:{...F,description:F.label}:null,[F,d]),be=Z=>{const P=Z.definition,G=N||le,re=P.type==="matching"?(()=>{var qe;const ye=Math.max(2,((qe=P.columns)==null?void 0:qe.length)??2),ie=(Ve.matchingRows.length?Ve.matchingRows:[new Array(ye).fill("")]).map(Ke=>Array.from({length:ye},(Je,bt)=>Ke[bt]??""));return ie[ie.length-1].some(Ke=>Ke.trim())?[...ie,new Array(ye).fill("")]:ie})():[],Q=Array.isArray(P.answer)?P.answer:[],ee=P.answer&&typeof P.answer=="object"&&"paths"in P.answer?P.answer.paths:[];return e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:P.question||(F==null?void 0:F.label)}),P.title?e.jsx("p",{className:"cogita-revision-hint",children:P.title}):null,P.type==="selection"?e.jsx("div",{className:"cogita-choice-grid",style:{gridTemplateColumns:"1fr"},children:(P.options??[]).map((ye,U)=>e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.6rem"},children:[e.jsx("input",{type:"checkbox",checked:Ve.selection.includes(U),disabled:G,onChange:ie=>Be(Le=>({...Le,selection:ie.target.checked?Array.from(new Set([...Le.selection,U])):Le.selection.filter(qe=>qe!==U)}))}),e.jsx("span",{children:ye})]},`q-opt:${U}`))}):null,P.type==="truefalse"?e.jsxs("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:[e.jsx("button",{type:"button",className:"ghost","data-active":Ve.booleanAnswer===!0,disabled:G,onClick:()=>Be(ye=>({...ye,booleanAnswer:!0})),children:"True"}),e.jsx("button",{type:"button",className:"ghost","data-active":Ve.booleanAnswer===!1,disabled:G,onClick:()=>Be(ye=>({...ye,booleanAnswer:!1})),children:"False"})]}):null,P.type==="text"||P.type==="number"||P.type==="date"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:tt,type:P.type==="date"?"date":"text",value:ne,onChange:ye=>je(ye.target.value),disabled:G,"data-state":_==="correct"?"correct":_==="incorrect"?"incorrect":void 0})]}):null,P.type==="ordering"?e.jsx("div",{style:{display:"grid",gap:"0.45rem"},children:Ve.ordering.map((ye,U)=>e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)"},children:[U+1,"."]}),e.jsx("span",{children:ye}),e.jsx("button",{type:"button",className:"ghost",disabled:G||U===0,onClick:()=>Be(ie=>{const Le=[...ie.ordering];return[Le[U-1],Le[U]]=[Le[U],Le[U-1]],{...ie,ordering:Le}}),children:"Up"}),e.jsx("button",{type:"button",className:"ghost",disabled:G||U>=Ve.ordering.length-1,onClick:()=>Be(ie=>{const Le=[...ie.ordering];return[Le[U+1],Le[U]]=[Le[U],Le[U+1]],{...ie,ordering:Le}}),children:"Down"})]},`q-order:${U}:${ye}`))}):null,P.type==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.65rem"},children:[(P.columns??[]).map((ye,U)=>e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.35rem",padding:"0.6rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:`Column ${U+1}`}),ye.map((ie,Le)=>e.jsx("div",{className:"cogita-library-hint",children:`${Le}: ${ie}`},`q-col:${U}:${Le}`))]},`q-col:${U}`)),e.jsxs("div",{style:{display:"grid",gap:"0.4rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:"Paths (0-based indices)"}),re.map((ye,U)=>{var Le;const ie=U===re.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:`repeat(${Math.max(2,((Le=P.columns)==null?void 0:Le.length)??2)}, minmax(0, 1fr)) auto`,gap:"0.35rem",alignItems:"center"},children:[ye.map((qe,Ke)=>e.jsx("input",{type:"number",min:0,step:1,value:qe,disabled:G,onChange:Je=>Be(bt=>{var Ct;const mt=Math.max(2,((Ct=P.columns)==null?void 0:Ct.length)??2),pt=(bt.matchingRows.length?bt.matchingRows:[new Array(mt).fill("")]).map(Ot=>Array.from({length:mt},(Et,Nt)=>Ot[Nt]??""));return pt[U]=pt[U]??new Array(mt).fill(""),pt[U][Ke]=Je.target.value,pt[pt.length-1].some(Ot=>Ot.trim())&&pt.push(new Array(mt).fill("")),{...bt,matchingRows:pt}})},`q-path:${U}:${Ke}`)),ie?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",disabled:G,onClick:()=>Be(qe=>{var mt;const Ke=Math.max(2,((mt=P.columns)==null?void 0:mt.length)??2),Je=qe.matchingRows.filter((pt,wt)=>wt!==U);return Je.length===0&&Je.push(new Array(Ke).fill("")),Je[Je.length-1].some(pt=>pt.trim())&&Je.push(new Array(Ke).fill("")),{...qe,matchingRows:Je}}),children:"Remove"})]},`q-path:${U}`)})]})]}):null,e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>void C(),disabled:G,children:t.cogita.library.revision.checkAnswer})}),le?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),P.type==="selection"?e.jsx("p",{children:Q.length?Q.map(ye=>{var U;return`${ye}${(U=P.options)!=null&&U[ye]?`: ${P.options[ye]}`:""}`}).join(", "):"-"}):P.type==="truefalse"?e.jsx("p",{children:String(!!P.answer)}):P.type==="ordering"?e.jsx("ol",{children:(P.options??[]).map((ye,U)=>e.jsx("li",{children:ye},`ans-order:${U}`))}):P.type==="matching"?e.jsx("div",{style:{display:"grid",gap:"0.35rem"},children:ee.length?ee.map((ye,U)=>e.jsx("p",{children:ye.join(" → ")},`ans-path:${U}`)):e.jsx("p",{children:"-"})}):e.jsx("p",{children:String(P.answer??"")})]}):e.jsx("div",{className:"cogita-revision-reveal",children:e.jsx("button",{type:"button",className:"ghost",onClick:()=>{se(!0),L()},children:t.cogita.library.revision.showAnswer})})]})},ge=a.useMemo(()=>D?nt(t,D):t.cogita.library.infoTypes.any,[t,D]);return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:ge}),e.jsx("h2",{className:"cogita-card-title",children:d}),e.jsx("p",{className:"cogita-card-subtitle",children:p})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${g.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${V.length}`}),e.jsx("button",{type:"button",className:"cta",disabled:g.length===0,onClick:()=>Ye(`/cogita/library/${i}/revision/run?libraryTarget=revisions&scope=info&infoId=${encodeURIComponent(p)}`),children:"Start revision"})]})]}),y==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):y==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(pn,{nodes:Ie,edges:Xe,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:(Z,P)=>x(P.id),panOnDrag:!0,children:[e.jsx(fn,{}),e.jsx(bn,{showInteractive:!1})]})}),F?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[A&&ue?e.jsx(es,{flashState:_,flashTick:Y,children:A.kind==="question"?be(A):e.jsx(ts,{copy:t,currentCard:ue,currentTypeLabel:"",prompt:A.kind==="citation-fragment"?null:A.prompt,languages:[],answer:ne,onAnswerChange:je,computedExpected:[],computedAnswers:et,onComputedAnswerChange:(Z,P)=>ct(G=>({...G,[Z]:P})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:Ce,feedback:_,canAdvance:!1,quoteContext:A.kind==="citation-fragment"?A.quoteContext:null,quotePlaceholder:A.kind==="citation-fragment"?A.quotePlaceholder:null,onCheckAnswer:()=>void C(),onSkip:()=>x(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:le,setShowCorrectAnswer:se,onRevealCorrect:L,answerMask:Te,expectedAnswer:A.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:tt,computedInputRefs:ot,scriptMode:We,setScriptMode:xt,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:N||le,hideSkipAction:!0,allowRevealBeforeCheck:!0,autoRevealAfterAnswer:!0,disableCheckAfterAnswer:!0})}):null,l?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),De?e.jsx("p",{className:"cogita-library-hint",children:De}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:g.map(Z=>{const P=ia(Z),G=q===P;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${G?"active":""}`,onClick:()=>x(P),children:[e.jsx("span",{children:Z.label}),e.jsx("small",{children:Ps(Z)})]},P)})})]})]})]})})})})})}function Za(t,n){var r,s;return((s=(r=t.fields.find(o=>o.fieldType===n))==null?void 0:r.plainValue)==null?void 0:s.trim())??""}function $i(t){return Za(t,"role_kind").toLowerCase()==="person"}function Ri(t){return Za(t,"label")||Za(t,"display_name")||Za(t,"name")||t.roleId}function Pi({copy:t,onPersonCreated:n}){const[r,s]=a.useState([]),[o,h]=a.useState("loading"),[c,w]=a.useState(null),[f,k]=a.useState(!1),[i,p]=a.useState(""),l=async()=>{h("loading");try{const g=await Js();s(g),h("ready")}catch{s([]),h("error")}};a.useEffect(()=>{l()},[]);const d=a.useMemo(()=>r.filter($i).map(g=>({roleId:g.roleId,label:Ri(g)})).sort((g,S)=>g.label.localeCompare(S.label)),[r]),j=async()=>{const g=i.trim();if(!g){w("Name is required.");return}k(!0),w(null);try{const S=await wr({fields:[{fieldType:"nick",plainValue:g},{fieldType:"role_kind",plainValue:"person"},{fieldType:"label",plainValue:g},{fieldType:"display_name",plainValue:g}]});p(""),w("Person role created."),n==null||n(S.roleId),await l()}catch{w("Failed to create person role.")}finally{k(!1)}};return e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-browser-panel",children:[e.jsx("div",{className:"cogita-info-overview-head",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Cogita"}),e.jsx("h2",{className:"cogita-card-title",children:"Persons"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Select reviewer persons in the header and create new person roles here."})]})}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Create"}),e.jsx("h3",{className:"cogita-detail-title",children:"New person role"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{type:"text",value:i,onChange:g=>p(g.target.value),placeholder:"e.g. Anna Kowalska",disabled:f})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:j,disabled:f,children:f?"Creating...":"Create person"})}),c?e.jsx("p",{className:"cogita-library-hint",children:c}):null]})]}),e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Overview"}),e.jsx("h3",{className:"cogita-detail-title",children:"All person roles"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[o==="loading"?e.jsx("p",{children:"Loading persons..."}):null,o==="error"?e.jsx("p",{children:"Failed to load persons."}):null,o==="ready"&&d.length===0?e.jsx("p",{children:"No person roles found."}):null,o==="ready"&&d.length>0?e.jsxs("div",{className:"cogita-details-grid",children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:"Name"}),e.jsx("span",{children:"Type"}),e.jsx("span",{children:"Role ID"}),e.jsx("span",{})]}),d.map(g=>e.jsxs("div",{className:"cogita-details-row",role:"row",children:[e.jsx("span",{}),e.jsx("span",{title:g.label,children:g.label}),e.jsx("span",{children:"person"}),e.jsx("span",{title:g.roleId,children:g.roleId}),e.jsx("span",{})]},g.roleId))]}):null]})]})]})]})})})})}function Ei({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,libraryId:i,collectionId:p}){const{libraryName:l}=da(i),[d,j]=a.useState([]),[g,S]=a.useState("loading"),[V,v]=a.useState("idle"),y=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),K=`/#/cogita/library/${i}`,q=()=>{S("loading"),Hs({libraryId:i}).then(m=>{j(m),S("idle")}).catch(()=>{j([]),S("error")})};a.useEffect(()=>{q()},[i]);const x=async m=>{try{await Ws({libraryId:i,shareId:m}),q()}catch{q()}},W=async m=>{const D=`${y}/${m}`;try{await navigator.clipboard.writeText(D),v("copied")}catch{v("failed")}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:K,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${K}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[g==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):g==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):d.filter(m=>!p||m.collectionId===p).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:d.filter(m=>!p||m.collectionId===p).map(m=>e.jsxs("div",{className:"cogita-share-row","data-state":m.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:m.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(m.createdUtc).toLocaleString(),m.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),m.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${y}/${m.shareCode}`}):null]}),m.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[m.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>W(m.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>x(m.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},m.shareId))}),V==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):V==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function Fi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,libraryId:i}){const{libraryName:p}=da(i),[l,d]=a.useState(null),[j,g]=a.useState(null),[S,V]=a.useState(null),[v,y]=a.useState(null),[K,q]=a.useState(null),[x,W]=a.useState(null),m=a.useRef(null),D=he=>{if(!Number.isFinite(he))return"0 B";if(he<1024)return`${he} B`;const ne=he/1024;if(ne<1024)return`${ne.toFixed(1)} KB`;const je=ne/1024;return je<1024?`${je.toFixed(1)} MB`:`${(je/1024).toFixed(1)} GB`},$=async()=>{d(null),q({loadedBytes:0,totalBytes:null,percent:null});try{d(t.cogita.library.overview.exporting);const he=await kr(i,q),ne=URL.createObjectURL(he),je=document.createElement("a");je.href=ne,je.download=`cogita-library-${p||i}.json`,je.click(),URL.revokeObjectURL(ne),d(t.cogita.library.overview.exportReady)}catch{d(t.cogita.library.overview.exportFail)}finally{q(he=>he??{loadedBytes:0,totalBytes:null,percent:null})}},T=async he=>{var je;g(null),V(null),y(null);const ne=(je=he.target.files)==null?void 0:je[0];if(ne)try{g(t.cogita.library.overview.importing),W({loadedBytes:0,totalBytes:ne.size,percent:0});const De=await Nr(i,ne,W,R=>{const I=R.stage==="infos"?t.cogita.library.overview.importStageInfos:R.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;y(t.cogita.library.overview.importLiveProgress.replace("{stage}",I).replace("{done}",String(R.processed)).replace("{total}",String(R.total)).replace("{infos}",String(R.infos)).replace("{connections}",String(R.connections)).replace("{collections}",String(R.collections)))});V({infos:De.infosImported,connections:De.connectionsImported,collections:De.collectionsImported}),g(t.cogita.library.overview.importDone)}catch(De){const R=De instanceof Us&&De.message?` ${De.message}`:"";g(`${t.cogita.library.overview.importFail}${R}`)}finally{m.current&&(m.current.value="")}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:$,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:m,type:"file",accept:"application/json",onChange:T})]})]}),K?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:K.percent??void 0,max:K.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",D(K.loadedBytes)).replace("{total}",K.totalBytes?D(K.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,x?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:x.percent??void 0,max:x.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",D(x.loadedBytes)).replace("{total}",x.totalBytes?D(x.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,l?e.jsx("p",{className:"cogita-help",children:l}):null,j?e.jsx("p",{className:"cogita-help",children:j}):null,v?e.jsx("p",{className:"cogita-help",children:v}):null,S?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(S.infos)).replace("{connections}",String(S.connections)).replace("{collections}",String(S.collections))}):null]})]})})})]})})}function Ki({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,libraryId:i}){const{libraryName:p}=da(i),[l,d]=a.useState(""),[j,g]=a.useState([]),S=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:V=>d(V.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const V=l.trim();V&&(g(v=>[{id:S(),name:V},...v]),d(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[j.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,j.map(V=>e.jsx("button",{type:"button",className:"ghost",children:V.name},V.id))]})]})]})})})]})})}function _i({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,libraryId:i}){const{libraryName:p}=da(i),[l,d]=a.useState(""),[j,g]=a.useState([]),S=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:V=>d(V.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const V=l.trim();V&&(g(v=>[{id:S(),name:V},...v]),d(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[j.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,j.map(V=>e.jsx("button",{type:"button",className:"ghost",children:V.name},V.id))]})]})]})})})]})})}function Di({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,libraryId:i}){const{libraryName:p}=da(i),l=`/#/cogita/library/${i}`,[d,j]=a.useState(""),[g,S]=a.useState([]),[V,v]=a.useState("idle"),[y,K]=a.useState(0),[q,x]=a.useState(null);a.useEffect(()=>{v("loading");const m=window.setTimeout(()=>{Va({libraryId:i,query:d.trim()||void 0,limit:30}).then(D=>{S(D.items),K(D.total),x(D.nextCursor??null),v("ready")}).catch(()=>{S([]),K(0),x(null),v("ready")})},240);return()=>window.clearTimeout(m)},[i,d]);const W=async()=>{if(q){v("loading");try{const m=await Va({libraryId:i,query:d.trim()||void 0,limit:30,cursor:q});S(D=>[...D,...m.items]),x(m.nextCursor??null),K(m.total),v("ready")}catch{v("ready")}}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${l}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:d,onChange:m=>j(m.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(g.length)).replace("{total}",String(y||g.length))}),e.jsx("span",{children:V==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:g.length?g.map(m=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${l}/collections/${m.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:m.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(m.itemCount))," ·"," ",m.notes||t.cogita.library.collections.noNotes]})]})},m.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${l}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),q?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:W,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const Ne=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,ea=(t,n,r,s)=>`${t}:${n}:${r??""}:${s??""}`;function Bi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,libraryId:i,collectionId:p}){da(i);const l=`/#/cogita/library/${i}`,[d,j]=a.useState(t.cogita.library.collections.defaultName),[g,S]=a.useState(null),[V,v]=a.useState(0),[y,K]=a.useState([]),[q,x]=a.useState("idle"),[W,m]=a.useState(null),D=a.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(y.length)).replace("{total}",String(V||y.length)),[t,y.length,V]);a.useEffect(()=>{yn(i,p).then(T=>{j(T.name),S(T.notes??null),v(T.itemCount)}).catch(()=>{j(t.cogita.library.collections.defaultName),S(null)})},[i,p]),a.useEffect(()=>{x("loading"),qa({libraryId:i,collectionId:p,limit:40}).then(T=>{K(T.items),m(T.nextCursor??null),v(T.total),x("ready")}).catch(()=>{K([]),m(null),x("ready")})},[i,p]);const $=async()=>{if(W){x("loading");try{const T=await qa({libraryId:i,collectionId:p,limit:40,cursor:W});K(he=>[...he,...T.items]),m(T.nextCursor??null),v(T.total),x("ready")}catch{x("ready")}}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:d}),e.jsx("p",{className:"cogita-library-subtitle",children:g||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${l}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${l}/collections/${p}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${l}/collections/${p}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:D}),e.jsx("span",{children:q==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:y.length?y.map(T=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:T.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:T.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:T.label}),e.jsx("p",{className:"cogita-card-subtitle",children:T.description})]})},Ne(T))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),W?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:$,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${l}/collections/${p}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const Es=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],zi={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},Oi=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Vi=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function qi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,libraryId:i,onCreated:p}){const l=Ja(),{libraryName:d}=da(i),j=`/#/cogita/library/${i}`,[g,S]=a.useState(null),[V,v]=a.useState(""),[y,K]=a.useState(""),[q,x,W]=Hn([]),[m,D,$]=Wn([]),[T,he]=a.useState(null),[ne,je]=a.useState(null),De=a.useRef(null),R=a.useMemo(()=>q.find(Y=>Y.id===T)??null,[q,T]);a.useEffect(()=>{const Y=new URLSearchParams(l.search),xe=(Y.get("draft")??"").trim(),le=(Y.get("draftType")??"").trim();if(!xe||le!=="info-selection"||De.current===xe)return;const se=di(i,xe);if(!se||se.infoIds.length===0)return;const Te=crypto.randomUUID(),Ae=se.infoIds.length>1?crypto.randomUUID():null,Ee=se.infoIds.map((Ce,We)=>({id:crypto.randomUUID(),type:"default",position:{x:80,y:80+We*100},data:{nodeType:"source.info",label:"Selected info",params:{infoId:Ce,infoType:"any"}}})),$e=Ae?[{id:Ae,type:"default",position:{x:360,y:120+Math.max(0,(se.infoIds.length-1)*50)},data:{nodeType:"logic.or",label:"Selected infos",params:{}}}]:[],et={id:Te,type:"default",position:{x:660,y:140+Math.max(0,(se.infoIds.length-1)*35)},data:{nodeType:"output.collection",label:"Collection output",params:{}}},ct=Ee.map(Ce=>({id:crypto.randomUUID(),source:Ce.id,target:Ae??Te}));Ae&&ct.push({id:crypto.randomUUID(),source:Ae,target:Te}),x([...Ee,...$e,et]),D(ct),he(Te),je(`Draft loaded from ${se.infoIds.length} selected infos. Set name and save to create collection.`),De.current=xe},[i,l.search,D,x]);const I=Y=>{var Te;const xe=crypto.randomUUID(),le=((Te=Es.find(Ae=>Ae.type===Y))==null?void 0:Te.label)??Y,se={...zi[Y]};x(Ae=>[...Ae,{id:xe,type:"default",position:{x:120+Ae.length*40,y:120+Ae.length*40},data:{nodeType:Y,label:le,params:se}}]),he(xe)},X=a.useCallback(Y=>{D(xe=>Qn({...Y,id:crypto.randomUUID()},xe))},[D]),_=Y=>{R&&x(xe=>xe.map(le=>le.id===R.id?{...le,data:{...le.data,params:Y}}:le))},te=async()=>{if(je(null),!V.trim()){je(t.cogita.library.collections.saveRequiredName);return}try{const Y={nodes:q.map(se=>({nodeId:se.id,nodeType:se.data.nodeType,payload:{position:se.position,params:se.data.params}})),edges:m.map(se=>({edgeId:se.id,fromNodeId:se.source,fromPort:se.sourceHandle??null,toNodeId:se.target,toPort:se.targetHandle??null}))};let xe=g,le=!1;if(xe)await Qs({libraryId:i,collectionId:xe,nodes:Y.nodes,edges:Y.edges});else{const se=await Sr({libraryId:i,name:V.trim(),notes:y.trim()||void 0,items:[],graph:Y});xe=se.collectionId,le=!0,S(se.collectionId)}je(le?t.cogita.library.collections.saveSuccess:t.cogita.library.graph.saveSuccess),p(xe)}catch{je(g?t.cogita.library.graph.saveFail:t.cogita.library.collections.saveFail)}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.createKicker}),e.jsx("h1",{className:"cogita-library-title",children:d}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.createSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:j,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${j}/collections`,children:t.cogita.library.actions.collections}),e.jsx("button",{type:"button",className:"cta",onClick:te,children:t.cogita.library.actions.saveCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.collectionInfoTitle}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{value:V,onChange:Y=>v(Y.target.value),placeholder:t.cogita.library.collections.namePlaceholder})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.notesLabel}),e.jsx("textarea",{value:y,onChange:Y=>K(Y.target.value),placeholder:t.cogita.library.collections.notesPlaceholder})]}),ne?e.jsx("p",{className:"cogita-help",children:ne}):null,e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Es.map(Y=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>I(Y.type),children:Y.label},Y.type))})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(pn,{nodes:q,edges:m,onNodesChange:W,onEdgesChange:$,onConnect:X,onNodeClick:(Y,xe)=>he(xe.id),fitView:!0,children:[e.jsx(fn,{color:"rgba(120,160,200,0.2)"}),e.jsx(bn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),R?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:R.data.label}),R.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:i,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:R.data.params.tagId?{id:R.data.params.tagId,label:R.data.params.tagLabel??"",infoType:"topic"}:null,onChange:Y=>_({...R.data.params,tagId:(Y==null?void 0:Y.id)??null,tagLabel:(Y==null?void 0:Y.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:R.data.params.scope??"any",onChange:Y=>_({...R.data.params,scope:Y.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),R.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:i,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:R.data.params.languageId?{id:R.data.params.languageId,label:R.data.params.languageLabel??"",infoType:"language"}:null,onChange:Y=>_({...R.data.params,languageId:(Y==null?void 0:Y.id)??null,languageLabel:(Y==null?void 0:Y.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:R.data.params.scope??"any",onChange:Y=>_({...R.data.params,scope:Y.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),R.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:R.data.params.infoType??"word",onChange:Y=>_({...R.data.params,infoType:Y.target.value}),children:Vi.map(Y=>e.jsx("option",{value:Y.value,children:Y.label},Y.value))})]}),e.jsx(Yt,{libraryId:i,infoType:R.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:R.data.params.infoId?{id:R.data.params.infoId,label:R.data.params.infoLabel??"",infoType:R.data.params.infoType??"word"}:null,onChange:Y=>_({...R.data.params,infoId:(Y==null?void 0:Y.id)??null,infoLabel:(Y==null?void 0:Y.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),R.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:R.data.params.connectionType??"translation",onChange:Y=>_({...R.data.params,connectionType:Y.target.value}),children:Oi.map(Y=>e.jsx("option",{value:Y.value,children:Y.label},Y.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:R.data.params.connectionId??"",onChange:Y=>_({...R.data.params,connectionId:Y.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(R.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const la=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const n=t.length,r=t.filter(h=>h.correct).length,s=vn(as(t));return{score:Math.round(Math.max(0,Math.min(100,s.knowness*100))*100)/100,total:n,correct:r,lastReviewedUtc:s.lastReviewedUtc??null}},Ui=t=>{if(t.maskBase64)try{const n=Tr(t.maskBase64);if(!n.length)return t.correct?1:0;const r=n.reduce((s,o)=>s+o,0);return Math.max(0,Math.min(1,r/n.length/255))}catch{return t.correct?1:0}return t.correct?1:0},as=t=>t.map(n=>({correctness:Ui(n),createdUtc:n.createdUtc})),vn=(t,n=Date.now())=>{var V;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const s=t.slice().sort((v,y)=>v.createdUtc.localeCompare(y.createdUtc)).slice(-5),o=s.reduce((v,y)=>v+y.correctness,0)/s.length,h=5,c=2,w=.15;let f=0,k=0;for(let v=0;v<s.length;v+=1){const y=new Date(s[v].createdUtc).getTime(),K=v===s.length-1?n:new Date(s[v+1].createdUtc).getTime(),q=Math.max(0,(K-y)/(1e3*60)),x=1-Math.exp(-q/h);f+=x,s[v].correctness>.5&&(k+=w)}let i=o*f*c+k;const p=((V=s[s.length-1])==null?void 0:V.createdUtc)??null,l=p?Math.max(0,(n-new Date(p).getTime())/(1e3*60)):0,j=1/(1+Math.log1p(l/60));return i*=j,s.length===1&&s[0].correctness>.5&&(i+=5.44*Math.exp(-l/2)),{knowness:i,avgCorrectness:o,lastReviewedUtc:p}},Ua=t=>{const n=t.slice();for(let r=n.length-1;r>0;r-=1){const s=Math.floor(Math.random()*(r+1));[n[r],n[s]]=[n[s],n[r]]}return n},en=t=>t[Math.floor(Math.random()*t.length)],Ji=(t,n)=>{const r=new Map;return t.forEach(s=>r.set(s,Math.random())),t.sort((s,o)=>{const h=n(s)-n(o);return h!==0?h:(r.get(s)??0)-(r.get(o)??0)})},jn=(t,n,r,s,o)=>{if(!t.length)return null;const h=t.filter(w=>!(o!=null&&o.has(Ne(w))));if(h.length===0)return null;const c=h.filter(w=>Ne(w)!==r);return en(c.length?c:h)},Hi=(t,n,r,s,o)=>{if(!t.length)return null;let h=Number.POSITIVE_INFINITY;for(const k of t){const i=Ne(k);if(r.has(i))continue;const p=n[i]??1;p<h&&(h=p)}if(!Number.isFinite(h))return null;const c=t.filter(k=>{const i=Ne(k);return!r.has(i)&&(n[i]??1)===h}),w=c.filter(k=>!o||Ne(k)!==o),f=s?w.filter(k=>!s.has(Ne(k))):w;return f.length>0?en(f):w.length>0?en(w):o&&c.some(k=>Ne(k)===o)?c.find(k=>Ne(k)===o)??null:c.length?en(c):null},tr=(t,n,r,s,o)=>{const h=[],c=t.filter(f=>!o.has(Ne(f))&&!r.has(Ne(f))&&(n[Ne(f)]??0)<1),w=Ji(c,f=>n[Ne(f)]??0);for(const f of w){if(h.length>=s)break;h.push(f),o.add(Ne(f))}if(h.length<s){const f=Ua(t.filter(k=>!o.has(Ne(k))&&r.has(Ne(k))));for(const k of f){if(h.length>=s)break;h.push(k),o.add(Ne(k))}}return h},Wi=(t,n,r,s)=>tr(t,n,r,s,new Set),ns=(t,n,r,s,o,h)=>{const c=Math.max(1,r.stackSize??n),f=Ua(t).filter((j,g,S)=>S.findIndex(V=>Ne(V)===Ne(j))===g),k=Wi(f,s,o,c),i=new Set,p=new Set,l=jn(k,{},null,i,p),d=l?[l]:[];return l&&p.add(Ne(l)),{queue:d,meta:{pool:f,active:k,knownessMap:s,unknownSet:o,outcomesById:h,asked:i,queued:p}}},Jn={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,n)=>{const s=Ua(t).filter((o,h,c)=>c.findIndex(w=>Ne(w)===Ne(o))===h);return{queue:s.slice(0,Math.min(n,s.length)),meta:{}}},applyOutcome:t=>t},ss=(t,n,r,s)=>{const o=Math.max(1,r.stackSize??n),c=Ua(t).filter((g,S,V)=>V.findIndex(v=>Ne(v)===Ne(g))===S),w={},f=new Set,k=new Set,i=new Set,p=Math.max(1,r.levels??1);c.forEach(g=>{const S=Ne(g),V=s==null?void 0:s[S],v=typeof V=="number"&&Number.isFinite(V)?V:1;w[S]=Math.min(p,Math.max(1,Math.round(v)))});const l=[];if(c.length>0){const g=new Map;c.forEach(V=>{var y;const v=w[Ne(V)]??1;g.has(v)||g.set(v,[]),(y=g.get(v))==null||y.push(V)});const S=Array.from(g.keys()).sort((V,v)=>V-v);for(const V of S){if(l.length>=o)break;const v=Ua(g.get(V)??[]);for(const y of v){if(l.length>=o)break;l.push(y)}}}const d=jn(l,w,null,f,k),j=d?[d]:[];return d&&k.add(Ne(d)),{queue:j,meta:{pool:c,active:l,levelMap:w,asked:f,queued:k,wrongSinceCorrect:i}}},Qi={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,r)=>ss(t,n,r),applyOutcome:(t,n,r,s,o)=>{if(!n)return t;const h=Math.max(1,s.levels??1),c=t.meta.pool??[],w=t.meta.active??[],f={...t.meta.levelMap??{}},k=new Set(t.meta.asked??[]),i=new Set(t.meta.queued??[]),p=new Set(t.meta.wrongSinceCorrect??[]),l=Ne(n);i.delete(l),k.add(l);const d=f[l]??1;o.correct?(f[l]=p.has(l)?1:Math.min(d+1,h),p.delete(l)):(f[l]=1,p.add(l));const j=o.correct?w.filter(V=>Ne(V)!==l):w.slice();if(o.correct&&j.length<Math.max(1,s.stackSize??1)){const V=new Set(j.map(y=>Ne(y))),v=Hi(c,f,V,k,l);v&&j.push(v)}const g=t.queue.slice(),S=jn(j,f,l,k,i);return S&&(g.push(S),i.add(Ne(S))),{queue:g,meta:{pool:c,active:j,levelMap:f,asked:k,queued:i,wrongSinceCorrect:p}}}},Gi={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,r)=>ns(t,n,r,{},new Set,{}),applyOutcome:(t,n,r,s,o)=>{if(!n)return t;const h=t.meta.pool??[],c=t.meta.active??[],w={...t.meta.knownessMap??{}},f=new Set(t.meta.unknownSet??[]),k={...t.meta.outcomesById??{}},i=new Set(t.meta.asked??[]),p=new Set(t.meta.queued??[]),l=Ne(n);p.delete(l),i.add(l);const d={correctness:Math.max(0,Math.min(1,o.correctness??(o.correct?1:0))),createdUtc:o.createdUtc??new Date().toISOString()},g=(k[l]??[]).concat(d).sort((q,x)=>q.createdUtc.localeCompare(x.createdUtc)).slice(-5);k[l]=g,f.delete(l);const S=Date.now();h.forEach(q=>{const x=Ne(q),W=k[x]??[];if(W.length===0){w[x]=0,f.add(x);return}const m=vn(W,S);w[x]=m.knowness});const V=c.slice();if((w[l]??0)>=1){const q=V.filter(x=>Ne(x)!==l);V.length=0,V.push(...q)}const y=Math.max(1,s.stackSize??r);if(V.length<y){const q=new Set(V.map(W=>Ne(W))),x=tr(h,w,f,y-V.length,q);V.push(...x)}const K=t.queue.slice();if(K.length===0||Ne(K[K.length-1])===l){const q=jn(V,{},l,i,p);q&&(K.push(q),p.add(Ne(q)))}return{queue:K,meta:{pool:h,active:V,knownessMap:w,unknownSet:f,outcomesById:k,asked:i,queued:p}}}},ar={random:Jn,levels:Qi,temporal:Gi},Yi=Object.values(ar),rs=t=>{if(!t)return Jn;const n=t.trim().toLowerCase();return n==="random"||n==="levels"||n==="temporal"?ar[n]:Jn},wn=(t,n)=>{const r={...t.defaultSettings};return n&&Object.entries(n).forEach(([s,o])=>{typeof o=="number"&&Number.isFinite(o)&&(r[s]=o),typeof o=="string"&&(r[s]=o)}),t.settingsFields.forEach(s=>{var h;const o=r[s.key];if(s.type==="number"){if(typeof o!="number"||Number.isNaN(o)){r[s.key]=t.defaultSettings[s.key]??0;return}s.min!==void 0&&(r[s.key]=Math.max(s.min,r[s.key])),s.max!==void 0&&(r[s.key]=Math.min(s.max,r[s.key]));return}if(s.type==="select"){const c=((h=s.options)==null?void 0:h.map(w=>w.value))??[];(typeof o!="string"||c.length>0&&!c.includes(o))&&(r[s.key]=t.defaultSettings[s.key]??c[0]??"")}}),r},nr=(t,n)=>{const r={};return t.settingsFields.forEach(s=>{const o=n.get(s.key);if(o){if(s.type==="number"){const h=Number(o);Number.isNaN(h)||(r[s.key]=h);return}r[s.key]=o}}),wn(t,r)},Xi=(t,n)=>{const r=new URLSearchParams;return t.settingsFields.forEach(s=>{const o=n[s.key];(typeof o=="number"||typeof o=="string")&&r.set(s.key,String(o))}),r};function Fs({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,libraryId:i,collectionId:p,revisionId:l}){const d=mn(),{libraryName:j}=da(i),g=`/#/cogita/library/${i}`,[S,V]=a.useState(t.cogita.library.collections.defaultName),[v,y]=a.useState([]),[K,q]=a.useState(p??""),[x,W]=a.useState(""),[m,D]=a.useState(20),[$,T]=a.useState("random"),[he,ne]=a.useState({}),[je,De]=a.useState("exact"),[R,I]=a.useState([]),[X,_]=a.useState(null),[te,Y]=a.useState([]),[xe,le]=a.useState([]),[se,Te]=a.useState(""),[Ae,Ee]=a.useState("idle"),[$e,et]=a.useState(null),[ct,Ce]=a.useState("idle"),[We,xt]=a.useState("idle"),[Ve,Be]=a.useState("idle"),tt=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),ot=a.useMemo(()=>rs($),[$]),Ye=a.useMemo(()=>wn(ot,he),[ot,he]),Ie=a.useMemo(()=>Xi(ot,Ye).toString(),[ot,Ye]),ze=a.useMemo(()=>{const N=se.trim().toLocaleLowerCase();return N?xe.filter(C=>C.name.toLocaleLowerCase().includes(N)):xe},[se,xe]);a.useEffect(()=>{q(p??"")},[p]),a.useEffect(()=>{if(!K){V(t.cogita.library.collections.defaultName);return}yn(i,K).then(N=>V(N.name)).catch(()=>V(t.cogita.library.collections.defaultName))},[t.cogita.library.collections.defaultName,i,K]),a.useEffect(()=>{Va({libraryId:i,limit:200}).then(N=>y(N.items.map(C=>({collectionId:C.collectionId,name:C.name})))).catch(()=>y([]))},[i]),a.useEffect(()=>{Gn({libraryId:i}).then(N=>le(N)).catch(()=>le([]))},[i]),a.useEffect(()=>{l&&Zn({libraryId:i,revisionId:l}).then(N=>{q(N.collectionId),W(N.name),T(N.mode||"random"),De(N.check||"exact"),D(N.limit||20),ne(N.revisionSettings??{})}).catch(()=>{W("")})},[i,l]),a.useEffect(()=>{Gs({libraryId:i}).then(N=>{I(N),!X&&N.length>0&&_(N[0].roleId)}).catch(()=>{I([])})},[i]);const Xe=()=>{xt("loading"),Hs({libraryId:i}).then(N=>{Y(N),xt("idle")}).catch(()=>{Y([]),xt("error")})};a.useEffect(()=>{Xe()},[i]);const F=async()=>{Ee("working"),Ce("idle");try{if(!K){Ee("error");return}const N=await Ir({libraryId:i,collectionId:K,revisionType:ot.id,revisionSettings:Ye,mode:$,check:je,limit:m});et(`${tt}/${N.shareCode}${Ie?`?${Ie}`:""}`),Ee("ready"),Xe()}catch{Ee("error")}},A=async()=>{if(l){Be("saving");try{await Cr({libraryId:i,collectionId:p??K,revisionId:l,targetCollectionId:K,name:x||S,revisionType:ot.id,revisionSettings:Ye,mode:$,check:je,limit:m}),Be("saved"),K&&d(`/cogita/library/${i}/revisions/${encodeURIComponent(l)}`,{replace:!0})}catch{Be("error")}}},B=async()=>{if($e)try{await navigator.clipboard.writeText($e),Ce("copied")}catch{Ce("failed")}},E=async N=>{try{await Ws({libraryId:i,shareId:N}),Xe()}catch{Xe()}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:S}),e.jsx("p",{className:"cogita-library-subtitle",children:j})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:g,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${g}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:K?`${g}/collections/${K}`:`${g}/collections`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${g}${l?`/revisions/${encodeURIComponent(l)}/run`:K?`/collections/${K}/revision/run`:"/revision/run"}?mode=${encodeURIComponent($)}&check=${encodeURIComponent(je)}&limit=${m}${Ie?`&${Ie}`:""}${X?`&reviewer=${encodeURIComponent(X)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:se,onChange:N=>Te(N.target.value),placeholder:t.cogita.workspace.revisionForm.namePlaceholder})}),e.jsxs("div",{className:"cogita-card-list","data-view":"list",children:[e.jsxs("a",{className:"cogita-card-select",href:`${g}/revisions/new`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:t.cogita.workspace.revisionForm.createAction})]}),ze.map(N=>e.jsxs("a",{className:"cogita-card-select",href:`${g}/revisions/${encodeURIComponent(N.revisionId)}`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:N.name})]},N.revisionId))]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsx("select",{value:K,onChange:N=>q(N.target.value),children:v.map(N=>e.jsx("option",{value:N.collectionId,children:N.name},N.collectionId))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:x,onChange:N=>W(N.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:$,onChange:N=>T(N.target.value),children:Yi.map(N=>e.jsx("option",{value:N.id,children:t.cogita.library.revision[N.labelKey]},N.id))})]}),ot.settingsFields.map(N=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[N.labelKey]}),N.type==="select"?e.jsx("select",{value:String(Ye[N.key]??""),onChange:C=>ne(L=>({...L,[N.key]:C.target.value})),children:(N.options??[]).map(C=>e.jsx("option",{value:C.value,children:t.cogita.library.revision[C.labelKey]},C.value))}):e.jsx("input",{type:"number",min:N.min,max:N.max,step:N.step,value:Ye[N.key]??0,onChange:C=>ne(L=>({...L,[N.key]:Number(C.target.value||0)}))})]},N.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),ot.id!=="levels"&&ot.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:m,onChange:N=>D(Number(N.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:X??"",onChange:N=>_(N.target.value||null),children:R.map(N=>e.jsx("option",{value:N.roleId,children:N.label},N.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[l?e.jsx("button",{type:"button",className:"cta ghost",onClick:A,disabled:Ve==="saving",children:Ve==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${g}${l?`/revisions/${encodeURIComponent(l)}/run`:K?`/collections/${K}/revision/run`:"/revision/run"}?mode=${encodeURIComponent($)}&check=${encodeURIComponent(je)}&limit=${m}${Ie?`&${Ie}`:""}${X?`&reviewer=${encodeURIComponent(X)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision}),l?e.jsx("a",{className:"cta ghost",href:`/#/cogita/live-revision-host/${encodeURIComponent(i)}/${encodeURIComponent(l)}`,children:"Live session"}):null]}),Ve==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),$e?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:$e,readOnly:!0})]}):null,Ae==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,ct==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):ct==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:F,disabled:Ae==="working",children:Ae==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),$e?e.jsx("button",{type:"button",className:"cta ghost",onClick:B,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),We==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):te.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:te.map(N=>e.jsxs("div",{className:"cogita-share-row","data-state":N.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:N.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(N.createdUtc).toLocaleString(),N.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),N.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>E(N.shareId),children:t.cogita.library.revision.shareRevokeAction})]},N.shareId))})]})]})]})]})})})]})})}const Fn=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function sr(t,n,r){if(!t)return null;const s=new Map(t.nodes.map(q=>[q.id,q])),o=new Map,h=new Set,c=q=>{if(typeof q=="number")return q;if(typeof q=="string"){const x=Number(q);return Number.isFinite(x)?x:0}return 0},w=q=>{if(o.has(q))return o.get(q);if(h.has(q))return 0;const x=s.get(q);if(!x)return 0;h.add(q);const W=D=>{var T,he;return(D?((T=x.inputsByHandle)==null?void 0:T[D])??[]:x.inputs??((he=x.inputsByHandle)==null?void 0:he.in)??[]).map(ne=>w(ne))};let m=0;switch(x.type){case"input.random":{const D=x.min??0,$=x.max??D+10,T=Math.min(D,$),he=Math.max(D,$);m=Math.floor(Math.random()*(he-T+1))+T;break}case"input.const":{m=x.value??0;break}case"input.list":{const D=(x.list??[]).filter(Boolean),$=Math.round(c(W("index")[0]));m=D.length?D[Math.max(0,Math.min(D.length-1,$))]:String($);break}case"compute.add":{m=W("in").map($=>c($)).reduce(($,T)=>$+T,0);break}case"compute.sub":{const D=W("add").map(T=>c(T)),$=W("sub").map(T=>c(T));m=D.reduce((T,he)=>T+he,0)-$.reduce((T,he)=>T+he,0);break}case"compute.mul":{const D=W("in").map($=>c($));m=D.length?D.reduce(($,T)=>$*T,1):0;break}case"compute.div":{const D=c(W("num")[0]),$=W("den").map(T=>c(T)).reduce((T,he)=>T+he,0);m=Math.abs($)<Number.EPSILON?0:D/$;break}case"compute.pow":{const D=c(W("base")[0]),$=c(W("exp")[0]);m=Math.pow(D,$);break}case"compute.exp":{const D=c(W("base")[0]),$=c(W("exp")[0]);m=Math.pow(D,$);break}case"compute.log":{const D=c(W("value")[0]),$=c(W("base")[0]),T=Math.max(D,Number.EPSILON);m=Math.abs($)<Number.EPSILON?Math.log(T):Math.log(T)/Math.log($);break}case"compute.abs":{m=Math.abs(c(W("in")[0]));break}case"compute.min":{const D=W("in").map($=>c($));m=D.length?Math.min(...D):0;break}case"compute.max":{const D=W("in").map($=>c($));m=D.length?Math.max(...D):0;break}case"compute.floor":{m=Math.floor(c(W("in")[0]));break}case"compute.ceil":{m=Math.ceil(c(W("in")[0]));break}case"compute.round":{m=Math.round(c(W("in")[0]));break}case"compute.mod":{const D=c(W("a")[0]),$=c(W("b")[0]);m=Math.abs($)<Number.EPSILON?0:D%$;break}case"compute.concat":{const $=["in1","in2","in3","in4","in5","in6"].flatMap(je=>W(je)),T=$.length?$:W("in");m=(T.length?T:W()).map(je=>je==null?"":String(je)).join("");break}case"compute.trim":{const D=W("text")[0]??W("in")[0]??"",$=D==null?"":String(D),T=Math.max(0,Math.round(c(W("start")[0]))),he=Math.max(0,Math.round(c(W("end")[0])));T+he>=$.length?m="":m=$.substring(T,$.length-he);break}case"output":{m=W("in")[0]??0;break}default:m=0}return h.delete(q),o.set(q,m),m},f=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(q=>q.type==="output").map(q=>q.id);t.nodes.forEach(q=>w(q.id)),f.forEach(q=>w(q));const k=q=>Math.abs(q%1)<1e-5?String(Math.round(q)):q.toFixed(3).replace(/\.?0+$/,""),i=q=>typeof q=="number"?k(q):q??"",p=new Map;f.forEach(q=>{var $,T,he,ne;const x=s.get(q);if(!x)return;const W=(T=($=x.inputsByHandle)==null?void 0:$.name)==null?void 0:T[0],m=W?i(o.get(W)):"",D=(m==null?void 0:m.toString().trim())||((he=x.outputLabel)==null?void 0:he.trim())||((ne=x.name)==null?void 0:ne.trim())||q;p.set(q,D)});const l={},d={},j={};f.forEach(q=>{var m,D;const x=s.get(q);if(!x)return;const W=p.get(q)??(((m=x.outputLabel)==null?void 0:m.trim())||((D=x.name)==null?void 0:D.trim())||q);l[W]=i(o.get(q)),x.name&&(d[x.name.trim()]=W),d[q]=W});const g=(q,x)=>{let W=q;return t.nodes.forEach(m=>{var ne,je;const D=i(o.get(m.id)),$=f.includes(m.id),T=$?p.get(m.id)??((ne=m.outputLabel)==null?void 0:ne.trim())??((je=m.name)==null?void 0:je.trim())??m.id:"",he=$&&x?T:D;W=W.replace(new RegExp(`\\{\\s*${Fn(m.id)}\\s*\\}`,"gi"),he),m.name&&(W=W.replace(new RegExp(`\\{\\s*${Fn(m.name)}\\s*\\}`,"gi"),he)),$&&m.outputLabel&&(W=W.replace(new RegExp(`\\{\\s*${Fn(m.outputLabel)}\\s*\\}`,"gi"),T))}),W},S=n;let V=S.trim().length>0?S:"";V||(V=f.length?`Compute ${f.join(", ")}`:"Compute"),V=g(V,!0);const v=(r==null?void 0:r.trim())??"",y=v?g(v,!1):"",K={};return o.forEach((q,x)=>{K[x]=q,j[x]=i(q);const W=s.get(x);W!=null&&W.name&&(j[W.name.trim()]=i(q))}),{prompt:V,answers:l,values:K,answerText:y,outputVariables:d,variableValues:j}}function rr(t){var r;const n=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((r=n[0])==null?void 0:r[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const Kn=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function ir({outcomes:t}){const[n,r]=a.useState("day"),s=a.useMemo(()=>{const o=Kn.find(w=>w.id===n)??Kn[1],h=Date.now()-o.ms,c=t.filter(w=>new Date(w.createdUtc).getTime()>=h);return la(c)},[t,n]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:Kn.map(o=>e.jsx("button",{type:"button",className:"ghost","data-active":n===o.id,onClick:()=>r(o.id),children:o.label},o.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[s.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[s.correct," / ",s.total]})]})}const Zi="cogita-revision",eo=1,on="outcomes",to=()=>new Promise((t,n)=>{const r=indexedDB.open(Zi,eo);r.onupgradeneeded=()=>{const s=r.result;if(!s.objectStoreNames.contains(on)){const o=s.createObjectStore(on,{keyPath:"id"});o.createIndex("byItem","itemKey",{unique:!1}),o.createIndex("byPending","pending",{unique:!1})}},r.onerror=()=>n(r.error),r.onsuccess=()=>t(r.result)}),Ha=async(t,n)=>{const r=await to();return new Promise((s,o)=>{const h=r.transaction(on,t),c=h.objectStore(on);n(c).then(s).catch(o),h.onerror=()=>o(h.error)})},or=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const n=Array.from(t).map(r=>r.toString(16).padStart(2,"0"));return`${n.slice(0,4).join("")}-${n.slice(4,6).join("")}-${n.slice(6,8).join("")}-${n.slice(8,10).join("")}-${n.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},ao=()=>{const t="cogita_revision_client_id",n=localStorage.getItem(t);if(n)return n;const r=or();return localStorage.setItem(t,r),r},no=()=>{const t="cogita_revision_client_seq",n=Number(localStorage.getItem(t)??"0"),r=Number.isFinite(n)?n+1:1;return localStorage.setItem(t,String(r)),r},lr=(t,n,r,s)=>ea(t,n,r,s),ln=async t=>{const n=ao(),r=no(),s=new Date().toISOString(),o={...t,clientId:n,clientSequence:r,createdUtc:s,id:or(),pending:!0};return await Ha("readwrite",h=>new Promise((c,w)=>{const f={...o,itemKey:lr(o.itemType,o.itemId,o.checkType,o.direction)},k=h.add(f);k.onsuccess=()=>c(),k.onerror=()=>w(k.error)})),o},cn=async(t,n,r,s)=>{if(!n)return[];try{const o=lr(t,n,r,s);return await Ha("readonly",h=>new Promise((c,w)=>{const k=h.index("byItem").getAll(o);k.onsuccess=()=>{const p=(k.result??[]).map(l=>({itemType:l.itemType,itemId:l.itemId,checkType:l.checkType??null,direction:l.direction??null,revisionType:l.revisionType,evalType:l.evalType,correct:l.correct,createdUtc:l.createdUtc,maskBase64:l.maskBase64,payloadBase64:l.payloadBase64,payloadHashBase64:l.payloadHashBase64,clientId:l.clientId,clientSequence:l.clientSequence,personRoleId:l.personRoleId??null})).sort((l,d)=>l.createdUtc.localeCompare(d.createdUtc));c(p)},k.onerror=()=>w(k.error)}))}catch{return[]}},ca=async()=>{try{return await Ha("readonly",t=>new Promise((n,r)=>{const s=t.getAll();s.onsuccess=()=>{const h=(s.result??[]).map(c=>({itemType:c.itemType,itemId:c.itemId,checkType:c.checkType??null,direction:c.direction??null,revisionType:c.revisionType,evalType:c.evalType,correct:c.correct,createdUtc:c.createdUtc,maskBase64:c.maskBase64,payloadBase64:c.payloadBase64,payloadHashBase64:c.payloadHashBase64,clientId:c.clientId,clientSequence:c.clientSequence,personRoleId:c.personRoleId??null}));n(h)},s.onerror=()=>r(s.error)}))}catch{return[]}},so=async(t=100)=>{try{return await Ha("readonly",n=>new Promise((r,s)=>{const h=n.index("byPending").getAll(!0);h.onsuccess=()=>{const c=h.result??[];r(c.slice(0,t))},h.onerror=()=>s(h.error)}))}catch{return[]}},ro=async t=>{if(t.length!==0)try{await Ha("readwrite",n=>new Promise((r,s)=>{let o=t.length;t.forEach(h=>{const c=n.get(h);c.onsuccess=()=>{const w=c.result;if(w){w.pending=!1;const f=n.put(w);f.onsuccess=()=>{o-=1,o===0&&r()},f.onerror=()=>s(f.error)}else o-=1,o===0&&r()},c.onerror=()=>s(c.error)})}))}catch{}},_n=async(t,n)=>{const r=await so(200);if(r.length===0)return;const s=new Map;r.forEach(o=>{var c;const h=o.personRoleId??n??"";s.has(h)||s.set(h,[]),(c=s.get(h))==null||c.push(o)});for(const[o,h]of s.entries()){const c=h.map(w=>({itemType:w.itemType,itemId:w.itemId,checkType:w.checkType??null,direction:w.direction??null,revisionType:w.revisionType,evalType:w.evalType,correct:w.correct,clientId:w.clientId,clientSequence:w.clientSequence,maskBase64:w.maskBase64??null,payloadHashBase64:w.payloadHashBase64??null,payloadBase64:w.payloadBase64??null,personRoleId:o||null}));try{await Mr({libraryId:t,outcomes:c}),await ro(h.map(w=>w.id))}catch{}}},Dt=t=>t.trim().toLowerCase(),Wt=t=>{const n=t==null?void 0:t.trim();return n?{fragmentId:n}:null},dn=(t,n)=>{const r=Wt(n);if(!r)return!0;const s=Wt(t);return(s==null?void 0:s.fragmentId)===r.fragmentId},Tt=t=>{const n=t==null?void 0:t.trim().toLowerCase();return n||null},cr=(t,n)=>{if((Tt(t.childItemType)??"info")!==(n.cardType??"").toLowerCase()||t.childItemId!==n.cardId)return!1;const s=Tt(t.childCheckType),o=Tt(t.childDirection),h=Tt(n.checkType),c=Tt(n.direction);return!(s&&s!==h||o&&o!==c)},io={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},oo={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},un=(t,n,r)=>{if(!r||!n.startsWith(t))return n;const s=n.slice(t.length);if(!s)return n;const o=r==="super"?io:oo,h=s.split("").map(c=>o[c]??c).join("");return t+h},hn=(t,n,r)=>{var c,w,f;if(!t)return((c=n[0])==null?void 0:c.key)??null;const s=new Set(n.map(k=>k.key)),o=/\{([^}]+)\}/g;let h;for(;(h=o.exec(t))!==null;){const k=((w=h[1])==null?void 0:w.trim())??"";if(!k)continue;if(s.has(k))return k;const i=r==null?void 0:r[k];if(i&&s.has(i))return i}return((f=n[0])==null?void 0:f.key)??null},Oa=t=>(()=>{const n=new Set;return t.flatMap(r=>{if(r.cardType!=="info"||r.infoType!=="citation")return[r];const s=r.description??"";if(!s.trim())return[r];const o=va(s),h=Object.keys(o.nodes);return h.length===0?[r]:h.map(c=>({...r,checkType:"quote-fragment",direction:c})).filter(c=>{const w=[c.cardId,c.checkType??"",c.direction??""].join("|");return n.has(w)?!1:(n.add(w),!0)})})})();function Dn({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,libraryId:i,collectionId:p,revisionId:l}){const d=Ja(),j=`/#/cogita/library/${i}`,g=a.useMemo(()=>new URLSearchParams(d.search),[d.search]),S=Math.max(1,Number(g.get("limit")??20)),V=g.get("mode")??"random",v=a.useMemo(()=>rs(V),[V]),y=a.useMemo(()=>wn(v,nr(v,g)),[v,g]),K=g.get("check")??"exact",q=g.get("reviewer"),x=(g.get("scope")??"").trim(),W=x==="info"||x==="info-selection"?x:"collection",m=W==="info"?(g.get("infoId")??"").trim():"",D=W==="info-selection"?(g.get("seed")??"").trim():"",[$,T]=a.useState(null),he=p??$??void 0,ne=W==="collection"&&!!he,je=a.useMemo(()=>t.cogita.library.revision[v.labelKey]??V,[t,V,v]),De=a.useMemo(()=>K==="exact"?t.cogita.library.revision.checkValue:K,[t,K]),[R,I]=a.useState(t.cogita.library.collections.defaultName),[X,_]=a.useState([]),[te,Y]=a.useState([]),[xe,le]=a.useState("idle"),[se,Te]=a.useState({current:0,total:0}),[Ae,Ee]=a.useState(0),[$e,et]=a.useState(""),[ct,Ce]=a.useState(null),[We,xt]=a.useState(null),[Ve,Be]=a.useState(null),[tt,ot]=a.useState(null),[Ye,Ie]=a.useState([]),[ze,Xe]=a.useState({}),[F,A]=a.useState({}),[B,E]=a.useState(null),[N,C]=a.useState(null),[L,ue]=a.useState(null),[be,ge]=a.useState(null),[Z,P]=a.useState(null),[G,re]=a.useState({}),Q=a.useRef(0),[ee,ye]=a.useState(null),U=a.useRef(null),ie=a.useRef(null),[Le,qe]=a.useState(null),[Ke,Je]=a.useState(!1),[bt,mt]=a.useState(null),[pt,wt]=a.useState([]),[Ct,Ot]=a.useState(null),Et=a.useRef(null),Nt=a.useRef(null),[ua,Lt]=a.useState(null),[vt,St]=a.useState(0),kt=a.useRef(null),yt=a.useRef({}),[Kt,st]=a.useState(!1),[Ue,ft]=a.useState({}),[Qt,Vt]=a.useState([]),Bt=a.useRef(new Map),[me,$t]=a.useState(new Set),[Xt,qt]=a.useState(!1),O=a.useRef(null),u=a.useRef(new Set),oe=a.useRef({});a.useEffect(()=>{if(!l||p){T(null);return}Zn({libraryId:i,revisionId:l}).then(b=>T(b.collectionId)).catch(()=>T(null))},[p,i,l]);const H=X[Ae]??null,Qe=(H==null?void 0:H.checkType)==="translation-match"&&Z,rt=a.useRef(new Map),lt=a.useRef(new Map),It=a.useRef(new Map),Mt=a.useRef(new Map),jt=a.useMemo(()=>H?H.cardType==="vocab"?t.cogita.library.revision.vocabLabel:H.infoType?nt(t,H.infoType):t.cogita.library.revision.infoLabel:"",[t,H]),At=a.useMemo(()=>{var M;return v.id!=="levels"?X.length:((M=Ue.pool)==null?void 0:M.length)??v.getFetchLimit(S,y)},[Ue,y,v,X.length,S]),ha=v.getProgressTotal?v.getProgressTotal(X,Ue,S,y):v.id==="levels"?Math.min(S,At):X.length,ma=ha?Math.min(Ae+1,ha):0,Ft=Math.max(1,Number(y.tries??1)),ta=y.compare??"anchors",Ta=Math.max(0,Math.min(100,Number(y.minCorrectness??0))),ut=(y.considerDependencies??"on")==="on",_t=Math.max(0,Math.min(100,Number(y.dependencyThreshold??85))),Zt=b=>{const M=b.slice();for(let J=M.length-1;J>0;J-=1){const pe=Math.floor(Math.random()*(J+1));[M[J],M[pe]]=[M[pe],M[J]]}return M},ja=b=>xa(b,{treatSimilarCharsAsSame:!0})>=Ta,Wa=async()=>{const b=await ca(),M=new Map,J=new Map,pe=new Map;b.forEach(ae=>{const Se=`${ae.itemType}:${ae.itemId}`,Oe=ea(ae.itemType,ae.itemId,ae.checkType,ae.direction);if(M.has(Se)||M.set(Se,[]),M.get(Se).push(ae),J.has(Oe)||J.set(Oe,[]),J.get(Oe).push(ae),ae.itemType==="info"&&ae.checkType==="quote-fragment"&&ae.direction){const Ze=`${ae.itemId}:${ae.direction}`;pe.has(Ze)||pe.set(Ze,[]),pe.get(Ze).push(ae)}});const fe=new Map,de=new Map,ve=new Map;return M.forEach((ae,Se)=>fe.set(Se,la(ae).score)),J.forEach((ae,Se)=>de.set(Se,la(ae).score)),pe.forEach((ae,Se)=>ve.set(Se,la(ae).score)),{itemKnowness:fe,cardKnowness:de,fragmentKnowness:ve}},Gt=async b=>{const M=[];let J=null;for(;;){const pe=await qa({libraryId:i,collectionId:b,limit:200,cursor:J});if(M.push(...pe.items),!pe.nextCursor)break;J=pe.nextCursor}return Oa(M)},Ca=async(b,M)=>{if(Bt.current.has(b))return Bt.current.get(b)??0;const J=await Gt(b);if(J.length===0)return Bt.current.set(b,0),0;const fe=J.reduce((de,ve)=>{const ae=Ne(ve);return de+(M.get(ae)??0)},0)/J.length;return Bt.current.set(b,fe),fe},Ia=(b,M)=>{if(!ut||b.cardType!=="info"||b.infoType!=="citation"||b.checkType!=="quote-fragment")return!0;const J=Wt(b.direction);if(!(J!=null&&J.fragmentId))return!0;const pe=b.description??"";if(!pe.trim())return!0;const de=va(pe).nodes[J.fragmentId];if(!de||!de.leftId&&!de.rightId)return!0;const ve=[de.leftId,de.rightId].filter(Oe=>!!Oe);if(ve.length===0)return!0;const ae=ve.map(Oe=>{const Ze=ea("info",b.cardId,"quote-fragment",Oe);return M.get(Ze)??0});return ae.reduce((Oe,Ze)=>Oe+Ze,0)/ae.length>=_t},Pa=async b=>{const M=Ue,J=b.concat(M.active??[]).concat(M.pool??[]).filter((ae,Se,Oe)=>Oe.findIndex(Ze=>Ne(Ze)===Ne(ae))===Se);if(!ut){$t(new Set(J.map(Ne)));return}const{itemKnowness:pe,cardKnowness:fe}=await Wa(),de=Qt.filter(ae=>Tt(ae.childItemType)==="collection"&&ae.childItemId===p&&!Tt(ae.childCheckType)&&!Tt(ae.childDirection)),ve=new Set;for(const ae of J){if(ae.cardType!=="info"){ve.add(Ne(ae));continue}if(!Ia(ae,fe))continue;const Se=Qt.filter(He=>cr(He,ae)).concat(de);if(Se.length===0){ve.add(Ne(ae));continue}let Oe=0;for(const He of Se)if(Tt(He.parentItemType)==="collection")Oe+=await Ca(He.parentItemId,fe);else if(Tt(He.parentCheckType)||Tt(He.parentDirection)){const at=Tt(He.parentCheckType),it=Tt(He.parentDirection),dt=ea(He.parentItemType,He.parentItemId,at,it);Oe+=fe.get(dt)??0}else{const at=`${He.parentItemType}:${He.parentItemId}`;Oe+=pe.get(at)??0}Oe/Se.length>=_t&&ve.add(Ne(ae))}$t(ve)},Qa=b=>{for(let M=b;M<X.length;M+=1){const J=X[M];if(J&&(!ut||J.cardType!=="info"||me.has(Ne(J))))return M}return-1},Ea=b=>!ut||b.cardType!=="info"||me.has(Ne(b)),kn=b=>{if(v.id!=="temporal"&&v.id!=="levels")return null;const M=Ue,J=(M.active??[]).concat(M.pool??[]),pe=new Set;for(const fe of J){const de=Ne(fe);if(!(pe.has(de)||b.has(de))&&(pe.add(de),Ea(fe)))return fe}return null},Ut=a.useMemo(()=>{if(v.id!=="levels")return null;const b=Ue,M=b.pool??[],J=b.active??[],pe=b.levelMap??{},fe=Math.max(1,Number(y.levels??1)),de=Array.from({length:fe},()=>0),ve=new Set(J.map(Ze=>Ne(Ze)));M.forEach(Ze=>{const He=Math.min(fe,Math.max(1,pe[Ne(Ze)]??1));de[He-1]+=1});const ae=M.length||1,Se=de.map(Ze=>Ze/ae*100),Oe=H?pe[Ne(H)]??1:null;return{counts:de,percentages:Se,currentLevel:Oe,levelsCount:fe,activeCount:J.length,poolCount:M.length,activeSet:ve}},[Ue,y,v,H]),Jt=a.useMemo(()=>{if(v.id!=="temporal")return null;const b=Ue,M=b.pool??[],J=b.active??[],pe=b.knownessMap??{},fe=new Set(b.unknownSet??[]);let de=0;M.forEach(Se=>{(pe[Ne(Se)]??0)>1&&(de+=1)});const ve=fe.size,ae=J.map(Se=>({id:Ne(Se),value:fe.has(Ne(Se))?0:Math.max(0,Math.min(1,pe[Ne(Se)]??0))}));return{knownCount:de,unknownCount:ve,dots:ae}},[Ue,v]),Nn=a.useMemo(()=>{if(!ut)return 0;const b=Ue;return X.concat(b.active??[]).concat(b.pool??[]).filter((J,pe,fe)=>fe.findIndex(de=>Ne(de)===Ne(J))===pe).filter(J=>J.cardType==="info"&&!me.has(Ne(J))).length},[ut,Ue,X,me]);a.useEffect(()=>{if(!ut||xe!=="ready")return;const b=Ue,J=X.concat(b.active??[]).concat(b.pool??[]).filter((de,ve,ae)=>ae.findIndex(Se=>Ne(Se)===Ne(de))===ve).filter(de=>de.cardType!=="info"||me.has(Ne(de))).length,pe=Et.current;if(Et.current=J,pe===null||J<=pe)return;const fe=J-pe;Ot(`New card available (+${fe})`),Nt.current&&window.clearTimeout(Nt.current),Nt.current=window.setTimeout(()=>Ot(null),2200)},[ut,xe,Ue,X,me]),a.useEffect(()=>()=>{Nt.current&&window.clearTimeout(Nt.current)},[]);const zt=(b,M)=>{const J=v.applyOutcome({queue:X,meta:Ue},H,S,y,{correct:b,correctness:M,createdUtc:new Date().toISOString()});_(J.queue),ft(J.meta);const pe=J.queue[Ae+1];pe&&ga(pe,Ae+1)};a.useEffect(()=>{if(ne&&he){yn(i,he).then(b=>I(b.name)).catch(()=>I(t.cogita.library.collections.defaultName));return}if(W==="info"&&m){na({libraryId:i,infoId:m}).then(b=>{const M=b.payload??{};I(M.title||M.label||M.name||m)}).catch(()=>I(m||t.cogita.library.revision.runKicker));return}if(W==="info-selection"){const b=D?ms(i,D):null,M=(b==null?void 0:b.infoIds.length)??0;I(M>0?`Selected infos (${M})`:"Selected infos");return}I(t.cogita.library.collections.defaultName)},[t,he,ne,i,W,m,D]),a.useEffect(()=>{Xn({libraryId:i,type:"language"}).then(b=>Y(b)).catch(()=>Y([]))},[i]),a.useEffect(()=>{ne&&Yn({libraryId:i}).then(b=>Vt(b.items??[])).catch(()=>Vt([]))},[ne,i]),a.useEffect(()=>{_n(i,q)},[i,q]),a.useEffect(()=>{Pa(X)},[X,Qt,ut,_t,he]),a.useEffect(()=>{if(!H||!ut){qt(!1);return}if(H.cardType!=="info"||me.has(Ne(H))){qt(!1);return}const b=Qa(Ae+1);if(b>=0){qt(!1),Ee(b);return}if(v.id==="temporal"||v.id==="levels"){const M=X.slice(0,Ae+1),J=X.slice(Ae+1).filter(Ea),pe=M.concat(J),fe=new Set(pe.map(Ne)),de=kn(fe);if(de){const ae=Ne(de);fe.has(ae)||(pe.push(de),fe.add(ae),ft(Se=>{const Oe=Se,Ze=new Set(Oe.queued??[]);return Ze.add(ae),{...Oe,queued:Ze}}))}const ve=pe.findIndex((ae,Se)=>Se!==Ae&&Ea(ae));if(ve>=0){_(pe),Ee(ve),qt(!1);return}}qt(!0)},[H,me,ut,Ae,X,Ue,v.id]),a.useEffect(()=>{let b=!0;return(async()=>{le("loading"),Te({current:0,total:v.id==="levels"?0:v.getFetchLimit(S,y)});try{if(!ne){if(Vt([]),W==="info"){if(!m){b&&(_([]),Vt([]),ft({}),Ee(0),le("ready"));return}const[He,at]=await Promise.all([tn({libraryId:i,infoId:m}),an({libraryId:i,infoId:m})]);if(!b)return;const it=Oa(He.items??[]);Vt(at.items??[]);const dt=v.prepare(it,S,y);_(dt.queue),ft(dt.meta),Ee(0),le("ready"),Te({current:it.length,total:it.length});return}if(W==="info-selection"){const He=D?ms(i,D):null,at=(He==null?void 0:He.infoIds)??[];if(!at.length){b&&(_([]),Vt([]),ft({}),Ee(0),le("ready"));return}const it=await Promise.all(at.map(async pa=>{const[Ht,Ga]=await Promise.all([tn({libraryId:i,infoId:pa}),an({libraryId:i,infoId:pa})]);return{cards:Ht.items??[],deps:Ga.items??[]}}));if(!b)return;const dt=new Map;it.forEach(pa=>{Oa(pa.cards).forEach(Ht=>{dt.set(Ne(Ht),Ht)})});const ht=Array.from(dt.values()),gt=new Set(ht.map(Ne)),Rt=new Map;it.forEach(pa=>{(pa.deps??[]).forEach(Ht=>{const Ga=ea(Ht.parentItemType,Ht.parentItemId,Tt(Ht.parentCheckType),Tt(Ht.parentDirection)),is=ea(Ht.childItemType,Ht.childItemId,Tt(Ht.childCheckType),Tt(Ht.childDirection));if(!gt.has(Ga)||!gt.has(is))return;const os=`${Ga}->${is}`;Rt.has(os)||Rt.set(os,Ht)})}),Vt(Array.from(Rt.values()));const ka=v.prepare(ht,S,y);_(ka.queue),ft(ka.meta),Ee(0),le("ready"),Te({current:ht.length,total:ht.length});return}}const J=[];let pe=null,fe=null;do{const He=await qa({libraryId:i,collectionId:he,limit:300,cursor:pe});if(J.push(...He.items),(v.id==="levels"||v.id==="temporal")&&He.total&&(fe=He.total),Te(at=>({current:J.length,total:at.total||He.total||v.getFetchLimit(S,y)})),pe=He.nextCursor??null,fe!==null&&J.length>=fe||v.id!=="levels"&&v.id!=="temporal"&&J.length>=v.getFetchLimit(S,y))break}while(pe);if(!b)return;const de=Oa(J);let ve;if(v.id==="levels"){const He=Math.max(1,Number(y.levels??1)),it=(await ca()).reduce((dt,ht)=>{const gt=ea(ht.itemType,ht.itemId,ht.checkType,ht.direction);return dt[gt]||(dt[gt]=[]),dt[gt].push(ht),dt},{});ve={},de.forEach(dt=>{const ht=Ne(dt),gt=it[ht]??[],Rt=gt.length>0?la(gt).score:0,ka=Math.max(1,Math.min(He,Math.ceil(Rt/100*He)));ve[ht]=ka})}let ae=null,Se=null,Oe=null;if(v.id==="temporal"){const He=await ca(),at=new Set(de.map(ht=>Ne(ht))),it=He.reduce((ht,gt)=>{const Rt=ea(gt.itemType,gt.itemId,gt.checkType,gt.direction);return at.has(Rt)&&(ht[Rt]||(ht[Rt]=[]),ht[Rt].push(gt)),ht},{});ae={},Se=new Set,Oe={};const dt=Date.now();de.forEach(ht=>{const gt=Ne(ht),Rt=it[gt]??[];if(Rt.length===0){ae[gt]=0,Se.add(gt),Oe[gt]=[];return}const ka=as(Rt);Oe[gt]=ka;const pa=vn(ka,dt);ae[gt]=pa.knowness})}const Ze=v.id==="levels"?ss(de,S,y,ve):v.id==="temporal"?ns(de,S,y,ae??{},Se??new Set,Oe??{}):v.prepare(de,S,y);_(Ze.queue),ft(Ze.meta),Ee(0),le("ready"),Te(He=>({current:Math.min(He.current,He.total),total:He.total}))}catch{b&&le("error")}})(),()=>{b=!1}},[he,ne,i,S,W,y,v,q,m,D]),a.useEffect(()=>{if(et(""),Ce(null),Lt(null),St(0),Ie([]),Xe({}),A({}),C(null),ue(null),ge(null),Je(!1),st(!1),qe(null),P(null),re({}),!H){xt(null),Be(null),E(null),mt(null);return}H.cardType==="info"&&H.infoType==="computed"&&xt(t.cogita.library.revision.loadingComputed);let b=!0;return ga(H,Ae).then(M=>{!b||!M||(xt(M.prompt),Be(M.expectedAnswer),Ie(M.computedExpected),Xe(M.computedAnswers),E(M.computedValues),C(M.answerTemplate),ue(M.outputVariables),ge(M.variableValues))}),()=>{b=!1}},[H,t]),a.useEffect(()=>{if(!H||H.cardType!=="info"||H.infoType!=="citation"){O.current=null,u.current=new Set,ot(null);return}const b=H.description??"",M=(H.label??"").trim(),J=M.replace(/\s+/g," ").trim(),pe=b.replace(/\s+/g," ").trim(),fe=J&&J!==pe?M:t.cogita.library.infoTypes.citation;if(!b){ot(null),Be(null);return}const de=va(b);O.current=de,xt(fe);let ve=!0;return Wa().then(({fragmentKnowness:ae})=>{if(!ve)return;const Se=new Set,Oe={};ae.forEach((at,it)=>{const[dt,ht]=it.split(":",2);if(dt!==H.cardId)return;const gt=Wt(ht);if(!gt)return;const{fragmentId:Rt}=gt;Oe[Rt]=at,at>=_t&&Se.add(Rt)}),u.current=Se,oe.current=Oe;const Ze=Wt(H.direction);if(Ze!=null&&Ze.fragmentId&&de.nodes[Ze.fragmentId]){z(de,Ze.fragmentId,fe);return}const He=$a(de,Se,Oe,_t,ut,H.direction);z(de,(He==null?void 0:He.id)??null,fe)}).catch(()=>{u.current=new Set,oe.current={};const ae=Wt(H.direction);if(ae!=null&&ae.fragmentId&&de.nodes[ae.fragmentId]){z(de,ae.fragmentId,fe);return}const Se=$a(de,u.current,{},_t,ut,H.direction);z(de,(Se==null?void 0:Se.id)??null,fe)}),()=>{ve=!1}},[H,t,ut,_t]),a.useEffect(()=>{if(!H||H.cardType!=="vocab"||H.checkType!=="translation-match"){P(null),re({});return}const J=(Ue.pool??Ue.active??X).filter(ae=>ae.cardType==="vocab"&&ae.checkType==="translation-match").filter((ae,Se,Oe)=>Oe.findIndex(Ze=>Ze.cardId===ae.cardId)===Se);J.some(ae=>ae.cardId===H.cardId)||J.unshift(H);const fe=Zt(J).slice(0,6).map(ae=>{const Se=ae.label.split("↔").map(He=>He.trim()).filter(Boolean);if(Se.length<2)return null;const Oe=`${ae.cardId}:L`,Ze=`${ae.cardId}:R`;return{cardId:ae.cardId,leftId:Oe,rightId:Ze,leftLabel:Se[0],rightLabel:Se[1]}}).filter(Boolean),de=fe.map(ae=>ae.leftId),ve=Zt(fe.map(ae=>ae.rightId));P({pairs:fe,leftOrder:de,rightOrder:ve,selection:{},activeLeft:null,activeRight:null,locked:{}})},[H,X,Ue]),a.useEffect(()=>()=>{U.current&&window.clearTimeout(U.current),ie.current&&window.clearTimeout(ie.current)},[]);const sa=a.useRef(null);a.useEffect(()=>{if(!H)return;const b=Ne(H),M=typeof document<"u"?document.activeElement:null;if(sa.current===b&&M&&(M.tagName==="INPUT"||M.tagName==="TEXTAREA"))return;let J=0;const pe=()=>{if(H){if(H.cardType==="info"&&H.infoType==="computed"){if(Ye.length>0){const de=hn(N,Ye,L),ve=de?yt.current[de]:null;if(ve&&(ve.focus(),document.activeElement===ve)){sa.current=b;return}}if(kt.current&&(kt.current.focus(),document.activeElement===kt.current)){sa.current=b;return}}else if(H.cardType==="vocab"&&kt.current&&(kt.current.focus(),document.activeElement===kt.current)){sa.current=b;return}J<6&&(J+=1,window.setTimeout(pe,40))}},fe=window.setTimeout(pe,40);return()=>window.clearTimeout(fe)},[H,Ye,N,L]),a.useEffect(()=>{if(!Kt)return;const b=M=>{M.key==="Enter"&&(M.preventDefault(),La())};return window.addEventListener("keydown",b),()=>window.removeEventListener("keydown",b)},[Kt]);const Ma=b=>{wt(b),mt(la(b))};a.useEffect(()=>{if(!H){mt(null),wt([]);return}const b=H.cardType==="info"?"info":"connection";if(H.cardType==="info"&&H.infoType==="citation"){ca().then(M=>{const J=M.filter(pe=>pe.itemType==="info"&&pe.itemId===H.cardId&&pe.checkType==="quote-fragment"&&dn(pe.direction,H.direction));Ma(J)}).catch(()=>{mt(null),wt([])});return}cn(b,H.cardId,H.checkType,H.direction).then(M=>Ma(M)).catch(()=>{mt(null),wt([])})},[i,H,q]);const wa=(b,M,J,pe)=>{if(b==="info"&&J==="quote-fragment"){ca().then(fe=>{const de=fe.filter(ve=>ve.itemType==="info"&&ve.itemId===M&&ve.checkType==="quote-fragment"&&dn(ve.direction,pe));Ma(de)}).catch(()=>{mt(null),wt([])});return}cn(b,M,J,pe).then(fe=>Ma(fe)).catch(()=>{mt(null),wt([])})},Fa=(b,M,J)=>{var ve;const pe=((ve=J.pairs.find(ae=>ae.leftId===b))==null?void 0:ve.rightId)??null;if(!pe)return J;const fe=pe===M;re(ae=>({...ae,[b]:fe?"correct":"incorrect"})),U.current&&window.clearTimeout(U.current),ie.current&&window.clearTimeout(ie.current),Q.current+=1;const de={kind:fe?"correct":"incorrect",tick:Q.current};if(ye(null),U.current=window.setTimeout(()=>ye(de),0),ie.current=window.setTimeout(()=>ye(null),420),fe){const ae={...J.locked,[b]:!0};return Object.keys(ae).length>=J.pairs.length?(Ce("correct"),st(!0)):Ce("correct"),{...J,selection:{...J.selection,[b]:M},activeLeft:null,activeRight:null,locked:ae}}return Ce("incorrect"),{...J,activeLeft:null,activeRight:null}},Sn=b=>{P(M=>!M||M.locked[b]?M:M.activeRight?Fa(b,M.activeRight,M):{...M,activeLeft:M.activeLeft===b?null:b})},Tn=b=>{P(M=>M&&(M.activeLeft?Fa(M.activeLeft,b,M):{...M,activeRight:M.activeRight===b?null:b}))},La=()=>{var b;if(H&&H.cardType==="info"&&H.infoType==="citation"&&O.current&&tt&&!((b=Wt(H.direction))!=null&&b.fragmentId)){const M=$a(O.current,u.current,oe.current,_t,ut,H.direction,tt.fragmentId);if(M){Ce(null),et(""),Je(!1),A({}),st(!1),Lt(null),St(0),z(O.current,M.id,tt.title);return}}Ce(null),et(""),Je(!1),A({}),st(!1),Lt(null),St(0),Ee(M=>Math.min(M+1,X.length))},aa=b=>{if(!H)return;const M=b.expected??null,J=b.answer??"";let pe=M??"",fe=J;if(!M&&b.expectedMap&&b.answerMap){const He=Object.keys(b.expectedMap).sort((at,it)=>at.localeCompare(it));pe=He.map(at=>{var it;return((it=b.expectedMap)==null?void 0:it[at])??""}).join("|"),fe=He.map(at=>{var it;return((it=b.answerMap)==null?void 0:it[at])??""}).join("|")}const de=pe?Ra(pe,fe,ta):new Uint8Array,ve={revisionType:v.id,evalType:b.evalType,direction:b.direction,prompt:We??"",expected:M,answer:J,expectedAnswers:b.expectedMap??null,answers:b.answerMap??null,correct:b.correct,maskBase64:de.length?ya(de):null,values:B??null,checkMode:K,compareMode:ta,minCorrectness:Ta},ae=new TextEncoder().encode(JSON.stringify(ve)),Se=H.cardType==="info"?"info":"connection",Oe=b.overrideCheckType??H.checkType??null,Ze=b.overrideDirection??H.direction??null;ln({itemType:Se,itemId:H.cardId,checkType:Oe,direction:Ze,revisionType:v.id,evalType:b.evalType,correct:b.correct,maskBase64:de.length?ya(de):null,payloadBase64:ya(ae),personRoleId:q??null}).then(()=>{wa(Se,H.cardId,Oe,Ze),Pa(X),_n(i,q)}).catch(()=>{})},Cn=(b,M)=>{const J=rt.current.get(M);if(J)return Promise.resolve(J);const pe=lt.current.get(M);if(pe)return pe;const fe=na({libraryId:i,infoId:b}).then(de=>{var He,at;const ve=de.payload,ae=((He=ve.definition)==null?void 0:He.graph)??null,Se="",Oe=((at=ve.definition)==null?void 0:at.answerTemplate)??"",Ze=sr(ae,Se,Oe);if(Ze){const dt={sample:rr(Ze),answerTemplate:Oe||null};return rt.current.set(M,dt),dt}return Un({libraryId:i,infoId:b}).then(it=>{const dt={sample:it,answerTemplate:null};return rt.current.set(M,dt),dt})}).catch(()=>Un({libraryId:i,infoId:b}).then(de=>{const ve={sample:de,answerTemplate:null};return rt.current.set(M,ve),ve}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{lt.current.delete(M)});return lt.current.set(M,fe),fe},ga=(b,M)=>{var ae;const J=`${Ne(b)}:${M}`,pe=It.current.get(J);if(pe)return Promise.resolve(pe);const fe=Mt.current.get(J);if(fe)return fe;const de=Se=>(It.current.set(J,Se),Se);let ve;if(b.cardType==="vocab"){if(b.checkType==="translation-match")return ve=Promise.resolve(de({prompt:b.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),ve;const Se=b.label.split("↔").map(Oe=>Oe.trim()).filter(Boolean);if(Se.length>=2){const Ze=(b.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",He=Ze?Se[0]:Se[1],at=Ze?Se[1]:Se[0];ve=Promise.resolve(de({prompt:He,expectedAnswer:at,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else ve=Promise.resolve(de({prompt:b.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(b.cardType==="info"&&b.infoType==="word"){const Se=(ae=b.description)!=null&&ae.startsWith("Language: ")?b.description.replace("Language: ",""):null;ve=Promise.resolve(de({prompt:b.label,expectedAnswer:Se,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else b.cardType==="info"&&b.infoType==="computed"?ve=Cn(b.cardId,J).then(Se=>{var it,dt;if(!Se.sample)return de({prompt:b.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const Oe=Se.sample,Ze=Oe.expectedAnswers?Object.entries(Oe.expectedAnswers).map(([ht,gt])=>({key:ht,expected:gt})):[],He=Ze.reduce((ht,gt)=>(ht[gt.key]="",ht),{}),at=Oe.expectedAnswerIsSentence&&((it=Oe.expectedAnswer)==null?void 0:it.trim())||null;return de({prompt:Oe.prompt,expectedAnswer:Ze.length>0?at:((dt=Oe.expectedAnswer)==null?void 0:dt.trim())||null,computedExpected:Ze,computedAnswers:He,computedValues:Oe.values??null,answerTemplate:Se.answerTemplate,outputVariables:Oe.outputVariables??null,variableValues:Oe.variableValues??null})}).catch(()=>de({prompt:b.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Mt.current.delete(J)}):ve=Promise.resolve(de({prompt:b.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return Mt.current.set(J,ve),ve},z=(b,M,J)=>{const pe=Object.keys(b.nodes).length,fe=u.current.size;if(!M){ot({title:J,before:b.text,after:"",fragmentId:null,total:pe,completed:fe}),Be(null),st(!0);return}const de=b.nodes[M];if(!de)return;const ve=xn(b.text,de);ot({title:J,before:ve.before,after:ve.after,fragmentId:de.id,total:pe,completed:fe}),Be(ve.fragment),st(!1)},ce=()=>{const b=O.current;b&&ot(M=>M&&{...M,total:Object.keys(b.nodes).length,completed:u.current.size})},we=()=>{const b=X[Ae+1];b&&ga(b,Ae+1)},Fe=()=>{if(we(),H&&H.cardType==="vocab"&&H.checkType==="translation-match"&&Z){if(Z.pairs.length===0){Ce("incorrect"),st(!0);return}const de=Z.pairs.reduce((at,it)=>(at[it.rightId]=it.rightLabel,at),{});let ve=0;const ae={};Z.pairs.forEach(at=>{const dt=Z.selection[at.leftId]===at.rightId;ae[at.leftId]=dt?"correct":"incorrect",dt&&(ve+=1)});const Se=Z.pairs.length||1,Oe=ve/Se,Ze=ve===Z.pairs.length;re(at=>({...at,...ae})),Ze?(Ce("correct"),st(!0),St(0)):(Ce("incorrect"),st(!1),St(at=>{const it=at+1;return it>=Ft&&(Je(!0),st(!0),P(dt=>{if(!dt)return dt;const ht=dt.pairs.reduce((gt,Rt)=>(gt[Rt.leftId]=Rt.rightId,gt),{});return{...dt,selection:ht}})),it})),zt(Ze,Oe);const He="connection";Promise.all(Z.pairs.map(at=>{const it=Z.selection[at.leftId]??null,dt=it?de[it]:"",ht={left:at.leftLabel,expected:at.rightLabel,answer:dt,checkType:"translation-match"},gt=new TextEncoder().encode(JSON.stringify(ht));return ln({itemType:He,itemId:at.cardId,checkType:"translation-match",direction:null,revisionType:v.id,evalType:"translation-match",correct:it===at.rightId,maskBase64:null,payloadBase64:ya(gt),personRoleId:q??null})})).then(()=>{wa(He,H.cardId,H.checkType,H.direction),_n(i,q)}).catch(()=>{});return}if(Ye.length>0){const de=Ye.reduce((ae,Se)=>{const Oe=ze[Se.key]??"";return ae[Se.key]=Dt(Oe)===Dt(Se.expected)?"correct":"incorrect",ae},{});Ye.every(({key:ae,expected:Se})=>{const Oe=ze[ae]??"";return K==="exact"&&Dt(Oe)===Dt(Se)})?(Ce("correct"),A(de),st(!0),St(0),zt(!0,1),aa({correct:!0,direction:We?`${We} -> computed`:"computed",expectedMap:Ye.reduce((ae,Se)=>(ae[Se.key]=Se.expected,ae),{}),answerMap:ze,evalType:"computed"})):(Ce("incorrect"),A(de),st(!1),St(ae=>{const Se=ae+1;return Se>=Ft&&Ge&&(Je(!0),st(!0)),Se}),zt(!1,0),window.setTimeout(()=>{var Se;const ae=hn(N,Ye,L);ae&&yt.current[ae]&&((Se=yt.current[ae])==null||Se.focus())},40),aa({correct:!1,direction:We?`${We} -> computed`:"computed",expectedMap:Ye.reduce((ae,Se)=>(ae[Se.key]=Se.expected,ae),{}),answerMap:ze,evalType:"computed"}));return}if(H&&H.cardType==="info"&&H.infoType==="citation"&&(tt!=null&&tt.fragmentId)){if(!Ve)return;const de=Wt(H.direction),ve=(de==null?void 0:de.fragmentId)??tt.fragmentId,ae=Sa(Ve,$e,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Se=ae.mask,Oe=ae.isCorrect,Ze=ae.percent;Oe?(oe.current[tt.fragmentId]=Math.max(oe.current[tt.fragmentId]??0,Ze),(oe.current[tt.fragmentId]??0)>=_t&&u.current.add(tt.fragmentId),ce(),Ce("correct"),A({}),st(!0),Lt(Se),St(0),Ze<100&&Ft<=1&&Je(!0),zt(!0,Ze/100),aa({correct:!0,direction:`quote:${tt.fragmentId}`,expected:Ve,answer:$e,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:ve})):(Ce("incorrect"),A({}),st(!1),Lt(Se),St(He=>{const at=He+1;return at>=Ft&&Ge&&(Je(!0),st(!0)),at}),zt(!1,Ze/100),window.setTimeout(()=>{var He;return(He=kt.current)==null?void 0:He.focus()},40),aa({correct:!1,direction:`quote:${tt.fragmentId}`,expected:Ve,answer:$e,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:ve}));return}if(!Ve)return;const b=Ra(Ve,$e,ta),M=K==="exact"&&Dt($e)===Dt(Ve),J=ja(b),pe=M||J,fe=xa(b);pe?(Ce("correct"),A({}),st(!0),Lt(b),St(0),fe<100&&Ft<=1&&Je(!0),zt(!0,fe/100),aa({correct:!0,direction:We?`${We} -> ${Ve}`:null,expected:Ve,answer:$e,evalType:"text"})):(Ce("incorrect"),A({}),st(!1),Lt(b),St(de=>{const ve=de+1;return ve>=Ft&&Ge&&(Je(!0),st(!0)),ve}),zt(!1,fe/100),window.setTimeout(()=>{var de;return(de=kt.current)==null?void 0:de.focus()},40),aa({correct:!1,direction:We?`${We} -> ${Ve}`:null,expected:Ve,answer:$e,evalType:"text"}))},_e=b=>{if(we(),!Ve)return;const M=Ra(Ve,b,ta),J=Dt(b)===Dt(Ve),pe=ja(M),fe=J||pe,de=xa(M);fe?(Ce("correct"),A({}),st(!0),Lt(M),St(0),de<100&&Ft<=1&&Je(!0),zt(!0,de/100),aa({correct:!0,direction:"word->language",expected:Ve,answer:b,evalType:"language-select"})):(Ce("incorrect"),A({}),st(!1),Lt(M),St(ve=>{const ae=ve+1;return ae>=Ft&&Ge&&(Je(!0),st(!0)),ae}),zt(!1,de/100),aa({correct:!1,direction:"word->language",expected:Ve,answer:b,evalType:"language-select"}))},ke=()=>{we(),Ce("correct"),st(!0),St(0),zt(!0,1),Ve&&aa({correct:!0,direction:"manual",expected:Ve,answer:$e,evalType:"manual"})},Re=()=>{if(zt(!1,0),H&&H.cardType==="info"&&H.infoType==="citation"){Ce(null),et(""),Je(!1),A({}),st(!1),Lt(null),St(0),Ee(b=>Math.min(b+1,X.length));return}La()};a.useEffect(()=>{we()},[Ae,X]);const Me=b=>{var J;if(b.key!=="Enter")return;if(b.preventDefault(),b.stopPropagation(),Kt){La();return}const M=Ye.find(pe=>!(ze[pe.key]??"").trim());if(M){(J=yt.current[M.key])==null||J.focus();return}Fe()},Pe=t.cogita.library.revision.revealModeAfterIncorrect,Ge=Ye.length>0||!!Ve;return e.jsxs(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,children:[xe==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${se.total?Math.min(100,Math.max(0,se.current/se.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:se.total?`${Math.min(se.current,se.total)} / ${se.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:R}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",je).replace("{check}",De)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:j,children:t.cogita.library.actions.libraryOverview}),ne?e.jsxs(e.Fragment,{children:[e.jsx("a",{className:"cta ghost",href:`${j}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${j}/collections/${he}`,children:t.cogita.library.actions.collectionDetail})]}):e.jsx("a",{className:"cta ghost",href:`${j}/list`,children:t.cogita.library.actions.allCards})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:bt?`${bt.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Ut?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Ut.currentLevel??"-"," / ",Ut.levelsCount]}):null,bt?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(bt.correct)).replace("{total}",String(bt.total))}),bt.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(bt.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(ir,{outcomes:pt})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[Ct?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:Ct})}):null,e.jsx(es,{feedbackToken:ee?`${ee.kind}-${ee.tick}`:Qe?"idle":ct??"idle",children:H?e.jsx(e.Fragment,{children:Xt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(ts,{copy:t,currentCard:H,currentTypeLabel:jt,prompt:We,languages:te,answer:$e,onAnswerChange:b=>et(M=>un(M,b,Le)),computedExpected:Ye,computedAnswers:ze,onComputedAnswerChange:(b,M)=>Xe(J=>({...J,[b]:un(J[b]??"",M,Le)})),answerTemplate:N,outputVariables:L,variableValues:be,computedFieldFeedback:F,feedback:ct,canAdvance:Kt,quoteContext:tt,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Fe,onSkip:Re,onLanguageSelect:_e,onMarkReviewed:ke,onAdvance:La,showCorrectAnswer:Ke,setShowCorrectAnswer:Je,onRevealCorrect:()=>st(!0),answerMask:ua,expectedAnswer:Ve,hasExpectedAnswer:Ge,handleComputedKeyDown:Me,answerInputRef:kt,computedInputRefs:yt,scriptMode:Le,setScriptMode:qe,matchPairs:Z==null?void 0:Z.pairs,matchLeftOrder:Z==null?void 0:Z.leftOrder,matchRightOrder:Z==null?void 0:Z.rightOrder,matchSelection:Z==null?void 0:Z.selection,matchActiveLeft:Z==null?void 0:Z.activeLeft,matchActiveRight:Z==null?void 0:Z.activeRight,matchFeedback:G,onMatchLeftSelect:Sn,onMatchRightSelect:Tn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:ne?`${j}/collections/${he}`:`${j}/list`,children:ne?t.cogita.library.actions.collectionDetail:t.cogita.library.actions.allCards})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:ha?`${ma} / ${ha}`:t.cogita.library.revision.progressUnlimited}),xe==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),xe==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),xe==="ready"&&X.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Pe}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",Ft]})]})]}),Ut?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Ut.activeCount," / ",Ut.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Ut.counts.map((b,M)=>{const J=M+1,pe=Ut.currentLevel===J,fe=Ut.percentages[M]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":pe,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:J}),e.jsx("strong",{children:b})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,fe))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[fe.toFixed(1),"%"]})]},`level-${J}`)})})]}):null,Jt?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:Jt.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:Jt.dots.map(b=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,b.value*100))}%`,background:`rgba(${Math.round(255*(1-b.value))}, ${Math.round(200*b.value)}, 80, 0.9)`}},b.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:Jt.knownCount})]})]}):null,ut?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Nn})]})}):null]})]})]})})})]})]})}const Bn=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],lo={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},co=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],uo=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function ho({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,libraryId:i,collectionId:p}){const[l,d]=a.useState(""),[j,g,S]=Hn([]),[V,v,y]=Wn([]),[K,q]=a.useState(null),[x,W]=a.useState(null),[m,D]=a.useState(null),$=`/#/cogita/library/${i}`;a.useEffect(()=>{yn(i,p).then(I=>d(I.name)).catch(()=>d(t.cogita.library.collections.defaultName))},[i,p,t]),a.useEffect(()=>{Lr({libraryId:i,collectionId:p}).then(I=>{if(!I.graphId||I.graphId==="00000000-0000-0000-0000-000000000000"){g([]),v([]);return}const X=I.nodes.map(te=>{var se;const Y=te.payload??{},xe=Y.position??{x:120,y:120},le=Y.params??{};return{id:te.nodeId,type:"default",position:xe,data:{nodeType:te.nodeType,label:((se=Bn.find(Te=>Te.type===te.nodeType))==null?void 0:se.label)??te.nodeType,params:le}}}),_=I.edges.map(te=>({id:te.edgeId,source:te.fromNodeId,target:te.toNodeId,sourceHandle:te.fromPort??void 0,targetHandle:te.toPort??void 0}));g(X),v(_)}).catch(()=>{g([]),v([])})},[i,p,v,g]);const T=a.useMemo(()=>j.find(I=>I.id===K)??null,[j,K]),he=I=>{var Y;const X=crypto.randomUUID(),_=((Y=Bn.find(xe=>xe.type===I))==null?void 0:Y.label)??I,te={...lo[I]};g(xe=>[...xe,{id:X,type:"default",position:{x:120+xe.length*40,y:120+xe.length*40},data:{nodeType:I,label:_,params:te}}]),q(X)},ne=a.useCallback(I=>{v(X=>Qn({...I,id:crypto.randomUUID()},X))},[v]),je=async()=>{W(null);try{await Qs({libraryId:i,collectionId:p,nodes:j.map(I=>({nodeId:I.id,nodeType:I.data.nodeType,payload:{position:I.position,params:I.data.params}})),edges:V.map(I=>({edgeId:I.id,fromNodeId:I.source,fromPort:I.sourceHandle??null,toNodeId:I.target,toPort:I.targetHandle??null}))}),W(t.cogita.library.graph.saveSuccess)}catch{W(t.cogita.library.graph.saveFail)}},De=async()=>{try{const I=await Ar({libraryId:i,collectionId:p});D(I)}catch{D(null)}},R=I=>{T&&g(X=>X.map(_=>_.id===T.id?{..._,data:{..._.data,params:I}}:_))};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${$}/collections/${p}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:De,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:je,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Bn.map(I=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>he(I.type),children:I.label},I.type))}),x?e.jsx("p",{className:"cogita-help",children:x}):null,m&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(m.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(m.connections)).replace("{infos}",String(m.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(pn,{nodes:j,edges:V,onNodesChange:S,onEdgesChange:y,onConnect:ne,onNodeClick:(I,X)=>q(X.id),fitView:!0,children:[e.jsx(fn,{color:"rgba(120,160,200,0.2)"}),e.jsx(bn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),T?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:T.data.label}),T.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:i,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:T.data.params.tagId?{id:T.data.params.tagId,label:T.data.params.tagLabel??"",infoType:"topic"}:null,onChange:I=>R({...T.data.params,tagId:(I==null?void 0:I.id)??null,tagLabel:(I==null?void 0:I.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:T.data.params.scope??"any",onChange:I=>R({...T.data.params,scope:I.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),T.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:i,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:T.data.params.languageId?{id:T.data.params.languageId,label:T.data.params.languageLabel??"",infoType:"language"}:null,onChange:I=>R({...T.data.params,languageId:(I==null?void 0:I.id)??null,languageLabel:(I==null?void 0:I.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:T.data.params.scope??"any",onChange:I=>R({...T.data.params,scope:I.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),T.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:T.data.params.infoType??"word",onChange:I=>R({...T.data.params,infoType:I.target.value}),children:uo.map(I=>e.jsx("option",{value:I.value,children:I.label},I.value))})]}),e.jsx(Yt,{libraryId:i,infoType:T.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:T.data.params.infoId?{id:T.data.params.infoId,label:T.data.params.infoLabel??"",infoType:T.data.params.infoType??"word"}:null,onChange:I=>R({...T.data.params,infoId:(I==null?void 0:I.id)??null,infoLabel:(I==null?void 0:I.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),T.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:T.data.params.connectionType??"translation",onChange:I=>R({...T.data.params,connectionType:I.target.value}),children:co.map(I=>e.jsx("option",{value:I.value,children:I.label},I.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:T.data.params.connectionId??"",onChange:I=>R({...T.data.params,connectionId:I.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(T.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const zn="cogita.preferences",On="cogita.reviewer.preferences",dr=["library_overview","all_cards","all_collections","all_revisions","storyboards","texts","dependencies","transfer"],Vn={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},all_revisions:{requiresCollection:!1,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},go=["settings","run","shared"],Aa=30,Ks=42;function fa(t,n){const r=(t??"").trim();return r.length<=n?r:n<=1?r.slice(0,n):`${r.slice(0,Math.max(1,n-1)).trimEnd()}…`}function mo(t,n=""){const r=t.split("/").filter(Boolean);if(r[0]!=="cogita"||r[1]!=="library")return{};const s=r[2];if(!s)return{};if(!r[3])return{libraryId:s,target:"library_overview"};const o=new URLSearchParams(n),h=o.get("revisionId")??void 0,c=o.get("infoId")??void 0,w=o.get("infoView"),f=w==="cards"?"cards":w==="collections"?"collections":"overview",k=o.get("collectionView")==="overview"?"overview":"infos",i=o.get("collectionAction"),p=o.get("libraryAction"),d=o.get("libraryTarget")==="revisions"?"all_revisions":"all_collections";if(r[3]==="list")return{libraryId:s,target:p==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:h,infoId:c,infoView:f,libraryAction:p==="new-info"?"new-info":void 0};if(r[3]==="detail"||r[3]==="collection")return{libraryId:s,target:"all_cards",cardMode:r[3],revisionId:h,infoId:c,infoView:f};if(r[3]==="new"||r[3]==="add")return{libraryId:s,target:"new_card",revisionId:h,libraryAction:"new-info"};if(r[3]==="edit")return{libraryId:s,target:"new_card",revisionId:h,infoId:r[4]};if(r[3]==="infos"){const g=r[4];return g?r[5]==="checkcards"?{libraryId:s,target:"all_cards",cardMode:"list",revisionId:h,infoId:g,infoView:"cards"}:r[5]==="collections"?{libraryId:s,target:"all_cards",cardMode:"list",revisionId:h,infoId:g,infoView:"collections"}:{libraryId:s,target:"all_cards",cardMode:"list",revisionId:h,infoId:g,infoView:"overview"}:{libraryId:s,target:"all_cards",cardMode:"list",revisionId:h}}if(r[3]==="shared-revisions")return{libraryId:s,target:d,revisionId:h};if(r[3]==="revisions"){const g=r[4];return g?g==="shared-links"?{libraryId:s,target:"all_revisions",revisionView:"shared"}:g==="new"?{libraryId:s,target:"all_revisions",revisionView:"new"}:r[5]==="run"?{libraryId:s,target:"all_revisions",revisionId:g,revisionView:"run"}:r[5]==="shared"?{libraryId:s,target:"all_revisions",revisionId:g,revisionView:"shared"}:{libraryId:s,target:"all_revisions",revisionId:g,revisionView:"settings"}:{libraryId:s,target:"all_revisions"}}if(r[3]==="revision"&&r[4]==="run")return{libraryId:s,target:d,revisionView:"run",revisionId:h,infoId:c,infoView:f};if(r[3]==="dependencies")return{libraryId:s,target:"dependencies"};if(r[3]==="transfer")return{libraryId:s,target:"transfer"};if(r[3]==="storyboards")return r[4]==="new"?{libraryId:s,target:"new_storyboard"}:{libraryId:s,target:"storyboards"};if(r[3]==="texts")return r[4]==="new"?{libraryId:s,target:"new_text"}:{libraryId:s,target:"texts"};if(r[3]!=="collections")return{libraryId:s,target:"library_overview"};if(r[4]==="new")return{libraryId:s,target:"new_collection",revisionId:h};const j=r[4];return j?r[5]==="graph"?{libraryId:s,target:d,collectionId:j,revisionId:h,revisionView:"graph"}:r[5]==="shared-revisions"?{libraryId:s,target:d,collectionId:j,revisionId:h,revisionView:"shared"}:r[5]==="revision"?{libraryId:s,target:d,collectionId:j,revisionId:h,revisionView:r[6]==="run"?"run":"settings",collectionView:k}:i==="new-revision"?{libraryId:s,target:d,collectionId:j,revisionId:h,revisionView:"new"}:{libraryId:s,target:d,collectionId:j,revisionId:h,revisionView:"detail",collectionView:k}:i==="new-collection"?{libraryId:s,target:"new_collection",collectionAction:"new-collection"}:{libraryId:s,target:d}}function _s(t,n="library_overview",r,s,o,h,c="overview",w="infos"){const f=(k,i)=>{const p=new URLSearchParams;i!=null&&i.revisionId&&p.set("revisionId",i.revisionId),i!=null&&i.collectionAction&&p.set("collectionAction",i.collectionAction),i!=null&&i.libraryAction&&p.set("libraryAction",i.libraryAction),i!=null&&i.libraryTarget&&p.set("libraryTarget",i.libraryTarget),i!=null&&i.infoId&&p.set("infoId",i.infoId),i!=null&&i.infoView&&(i!=null&&i.infoId)&&p.set("infoView",i.infoView),i!=null&&i.collectionView&&i.collectionView!=="infos"&&p.set("collectionView",i.collectionView);const l=p.toString();return l?`${k}?${l}`:k};if(!t)return"/cogita";if(n==="library_overview")return f(`/cogita/library/${t}`,{revisionId:o});if(n==="all_cards")return h?c==="cards"?f(`/cogita/library/${t}/infos/${h}/checkcards`,{revisionId:o}):c==="collections"?f(`/cogita/library/${t}/infos/${h}/collections`,{revisionId:o}):f(`/cogita/library/${t}/infos/${h}`,{revisionId:o}):f(`/cogita/library/${t}/list`,{revisionId:o,infoId:h,infoView:c});if(n==="new_card")return h?f(`/cogita/library/${t}/edit/${h}`,{revisionId:o}):f(`/cogita/library/${t}/list`,{revisionId:o,libraryAction:"new-info"});if(n==="all_collections"||n==="all_revisions"){const k=n==="all_revisions"?"revisions":void 0;return n==="all_revisions"&&o?s==="run"?f(`/cogita/library/${t}/revisions/${o}/run`,{revisionId:o}):s==="shared"?f(`/cogita/library/${t}/revisions/${o}/shared`,{revisionId:o}):f(`/cogita/library/${t}/revisions/${o}`,{revisionId:o}):n==="all_revisions"&&s==="new"?f(`/cogita/library/${t}/revisions/new`,{revisionId:o}):n==="all_revisions"?s==="shared"?f(`/cogita/library/${t}/revisions/shared-links`,{revisionId:o}):s==="run"?f(`/cogita/library/${t}/revision/run`,{revisionId:o,libraryTarget:k}):f(`/cogita/library/${t}/revisions`,{revisionId:o}):!r&&s==="run"?f(`/cogita/library/${t}/revision/run`,{revisionId:o,libraryTarget:k}):r?s==="graph"?f(`/cogita/library/${t}/collections/${r}/graph`,{revisionId:o,libraryTarget:k}):s==="settings"?f(`/cogita/library/${t}/collections/${r}/revision`,{revisionId:o,libraryTarget:k}):s==="run"?f(`/cogita/library/${t}/collections/${r}/revision/run`,{revisionId:o,libraryTarget:k}):s==="shared"?f(`/cogita/library/${t}/collections/${r}/shared-revisions`,{revisionId:o,libraryTarget:k}):s==="new"?f(`/cogita/library/${t}/collections/${r}`,{revisionId:o,libraryTarget:k,collectionAction:"new-revision"}):f(`/cogita/library/${t}/collections/${r}`,{revisionId:o,libraryTarget:k,collectionView:w}):f(`/cogita/library/${t}/collections`,{revisionId:o,libraryTarget:k})}return n==="new_collection"?f(`/cogita/library/${t}/collections`,{revisionId:o,collectionAction:"new-collection"}):n==="transfer"?f(`/cogita/library/${t}/transfer`,{revisionId:o}):n==="storyboards"?f(`/cogita/library/${t}/storyboards`,{revisionId:o}):n==="new_storyboard"?f(`/cogita/library/${t}/storyboards/new`,{revisionId:o}):n==="texts"?f(`/cogita/library/${t}/texts`,{revisionId:o}):n==="new_text"?f(`/cogita/library/${t}/texts/new`,{revisionId:o}):n==="dependencies"?f(`/cogita/library/${t}/dependencies`,{revisionId:o}):f(`/cogita/library/${t}`,{revisionId:o})}function ba(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function po(t){return typeof t=="string"&&dr.includes(t)}function fo(t,n){var w;if(!t.length)return null;const r=t.filter(f=>n.has(f.roleId)),s=r.length>0?r:t,o=s.map(f=>{var i,p;const k=((p=(i=f.fields.find(l=>l.fieldType==="role_kind"))==null?void 0:i.plainValue)==null?void 0:p.toLowerCase())??"";return{roleId:f.roleId,roleKind:k}}),h=o.find(f=>f.roleKind.includes("master"));if(h)return h.roleId;const c=o.find(f=>f.roleKind.includes("account")||f.roleKind.includes("user"));return c?c.roleId:((w=s[0])==null?void 0:w.roleId)??null}function bo(t){if(!t)return{version:1,byLibrary:{}};try{const n=JSON.parse(t);return!n||typeof n!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:n.lastLibraryId,byLibrary:n.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function yo({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k}){const i=mn(),p=Ja(),l=a.useMemo(()=>mo(p.pathname,p.search),[p.pathname,p.search]),d=t.cogita.workspace,[j,g]=a.useState([]),[S,V]=a.useState([]),[v,y]=a.useState([]),[K,q]=a.useState([]),[x,W]=a.useState(void 0),[m,D]=a.useState("library_overview"),[$,T]=a.useState(void 0),[he,ne]=a.useState(void 0),[je,De]=a.useState("detail"),[R,I]=a.useState(void 0),[X,_]=a.useState(!1),[te,Y]=a.useState(!0),[xe,le]=a.useState(!1),[se,Te]=a.useState(!1),[Ae,Ee]=a.useState(null),[$e,et]=a.useState(0),[ct,Ce]=a.useState(""),[We,xt]=a.useState(""),[Ve,Be]=a.useState(""),[tt,ot]=a.useState([]),[Ye,Ie]=a.useState(""),[ze,Xe]=a.useState(0),[F,A]=a.useState(null),[B,E]=a.useState(null),N=a.useRef({version:1,byLibrary:{}}),C=a.useRef(!1),L=a.useRef(!1),ue=a.useRef(null),be=a.useMemo(()=>j.find(u=>u.libraryId===x)??null,[j,x]),ge=a.useMemo(()=>S.find(u=>u.collectionId===$)??null,[S,$]),Z=ba(p.pathname)==="/cogita/persons";a.useEffect(()=>{if(!x){ot([]),Ie("");return}let u=!1;return Gs({libraryId:x}).then(oe=>{if(u)return;const H=oe.filter(Qe=>(Qe.roleKind??"").trim().toLowerCase()==="person");ot(H);try{const Qe=window.localStorage.getItem(On),lt=(Qe?JSON.parse(Qe):{})[x]??"",It=lt&&H.some(Mt=>Mt.roleId===lt)?lt:"";Ie(It)}catch{Ie("")}}).catch(()=>{u||(ot([]),Ie(""))}),()=>{u=!0}},[x,ze]),a.useEffect(()=>{if(x)try{const u=window.localStorage.getItem(On),oe=u?JSON.parse(u):{};Ye?oe[x]=Ye:delete oe[x],window.localStorage.setItem(On,JSON.stringify(oe))}catch{}},[x,Ye]);const P=a.useMemo(()=>K.find(u=>u.revisionId===he)??null,[K,he]),G=a.useMemo(()=>({detail:d.revisions.detail,graph:d.revisions.graph,settings:d.revisions.settings,run:d.revisions.run,shared:d.targets.sharedRevisions,new:d.revisionForm.createAction}),[d.revisions.detail,d.revisions.graph,d.revisions.run,d.revisions.settings,d.targets.sharedRevisions,d.revisionForm.createAction]),re=a.useMemo(()=>m==="new_card"?"all_cards":m==="new_collection"?"all_collections":m==="new_storyboard"?"storyboards":m==="new_text"?"texts":m,[m]),Q=a.useMemo(()=>je==="new"?"settings":je,[je]),ee=m==="all_collections"||m==="all_revisions",ye=a.useMemo(()=>m==="new_collection"?"create":m==="all_collections"&&$?"selected":"search",[$,m]),U=a.useMemo(()=>l.infoId?"selected":m==="new_card"?"create":"search",[l.infoId,m]),ie=a.useMemo(()=>v.find(u=>u.infoId===l.infoId)??null,[v,l.infoId]),Le=a.useMemo(()=>({library_overview:d.targets.libraryOverview,all_cards:d.targets.allCards,new_card:d.targets.newCard,all_collections:d.targets.allCollections,all_revisions:d.targets.allRevisions,new_collection:d.targets.newCollection,transfer:d.targets.transfer,storyboards:d.targets.storyboards,new_storyboard:d.targets.newStoryboard,texts:d.targets.texts,new_text:d.targets.newText,dependencies:d.targets.dependencies}),[d.targets]),qe=a.useMemo(()=>Le[re]??re,[re,Le]),Ke=G[Q],Je=!!x,bt=a.useMemo(()=>{const u=f==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":f==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return f==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:u},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:u},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:u},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:u},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:u},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:u},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:u},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:u},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:u},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:u},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:u},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:u},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:u},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:f==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:u},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:u},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:u},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:u},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:u},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:u},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:u},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:u},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:u},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:u},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:u},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:u},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:u},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:u},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:u},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:u},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:u},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:u},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:u},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:u},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:u},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:u},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:u},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:u},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:u},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:u},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[f]),mt=bt.length,pt=Math.max(0,Math.min($e,mt-1)),wt=bt[pt],Ct=!!$,Ot=Je&&m==="all_collections",Et=Ct&&m==="all_collections",Nt=Je&&(m==="all_revisions"||Ct&&m==="all_collections")&&(Q==="settings"||Q==="run"||Q==="shared"||m==="all_revisions"),ua=Nt,Lt=Nt&&!!he,vt=a.useCallback(u=>{const oe=!!u.libraryId;let H=u.target,Qe=u.collectionId,rt=u.revisionId,lt=u.revisionView,It=u.infoId,Mt=u.infoView??l.infoView??"overview",jt=u.collectionView??l.collectionView??"infos";oe?Vn[H].requiresCollection&&!Qe?(H=H==="all_revisions"?"all_revisions":"all_collections",rt=void 0,lt="detail"):H!=="all_collections"&&H!=="all_revisions"?(Qe=void 0,rt=void 0,H!=="new_card"&&H!=="all_cards"&&(It=void 0,Mt="overview"),H!=="new_collection"&&(jt="infos")):Vn[H].allowsRevision?go.includes(lt)||(rt=void 0):lt="detail":(H="library_overview",Qe=void 0,rt=void 0,lt="detail",It=void 0,Mt="overview",jt="infos"),W(u.libraryId),D(H),T(Qe),ne(rt),De(lt),_(!1);const At=ba(_s(u.libraryId,H,Qe,lt,rt,It,Mt,jt));ba(`${p.pathname}${p.search}`)!==At&&(ue.current=At,i(At))},[p.pathname,p.search,i,l.collectionView,l.infoView]),St=a.useMemo(()=>[{key:"library",label:d.layers.library,visible:!0,value:x??"",selectedLabel:(be==null?void 0:be.name)??d.path.noLibrarySelected,disabled:te||j.length===0,options:j.map(u=>({value:u.libraryId,label:u.name})),emptyOption:d.noLibraryOption,onSelect:u=>{const oe=u||void 0;vt({libraryId:oe,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:d.layers.target,visible:Je,value:re,selectedLabel:qe,disabled:!Je,options:dr.map(u=>({value:u,label:Le[u]})),onSelect:u=>{const oe=u;vt({libraryId:x,target:oe,collectionId:$,revisionId:he,revisionView:je,infoId:oe==="new_card"?l.infoId:void 0})}},{key:"info_mode",label:d.layers.target,visible:re==="all_cards",value:U,selectedLabel:U==="create"?d.infoMode.create:U==="selected"?(ie==null?void 0:ie.label)??R??t.cogita.library.list.selectedEmpty:d.infoMode.search,disabled:!Je,options:[{value:"search",label:d.infoMode.search},{value:"create",label:d.infoMode.create},...l.infoId?[{value:"selected",label:(ie==null?void 0:ie.label)??R??t.cogita.library.list.selectedEmpty}]:[]],onSelect:u=>{if(u==="selected"){if(!l.infoId)return;vt({libraryId:x,target:"all_cards",collectionId:$,revisionId:he,revisionView:je,infoId:l.infoId,infoView:"overview"});return}if(u==="create"){vt({libraryId:x,target:"new_card",collectionId:$,revisionId:he,revisionView:je,infoId:void 0});return}vt({libraryId:x,target:"all_cards",collectionId:$,revisionId:he,revisionView:je,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:d.layers.target,visible:re==="all_cards"&&!!l.infoId,value:m==="new_card"&&l.infoId?"edit":l.infoView==="cards"?"cards":l.infoView==="collections"?"collections":"overview",selectedLabel:m==="new_card"&&l.infoId?d.infoActions.edit:l.infoView==="cards"?d.infoActions.seeCards:l.infoView==="collections"?"Kolekcje":d.infoActions.overview,disabled:!Je||!l.infoId,options:[{value:"overview",label:d.infoActions.overview},{value:"edit",label:d.infoActions.edit},{value:"cards",label:d.infoActions.seeCards},{value:"collections",label:"Kolekcje"}],onSelect:u=>{if(l.infoId){if(u==="edit"){vt({libraryId:x,target:"new_card",collectionId:$,revisionId:he,revisionView:je,infoId:l.infoId});return}if(u==="cards"){vt({libraryId:x,target:"all_cards",collectionId:$,revisionId:he,revisionView:je,infoId:l.infoId,infoView:"cards"});return}vt({libraryId:x,target:"all_cards",collectionId:$,revisionId:he,revisionView:je,infoId:l.infoId,infoView:"overview"})}}},{key:"collection_mode",label:d.layers.collection,visible:Je&&(m==="all_collections"||m==="new_collection"),value:ye,selectedLabel:ye==="create"?t.cogita.library.actions.createCollection:ye==="selected"?(ge==null?void 0:ge.name)??d.path.noCollectionSelected:t.cogita.library.actions.collections,disabled:!Je,options:[{value:"search",label:t.cogita.library.actions.collections},{value:"create",label:t.cogita.library.actions.createCollection},...$&&ge?[{value:"selected",label:ge.name}]:[]],onSelect:u=>{if(u==="create"){vt({libraryId:x,target:"new_collection",collectionId:void 0,revisionId:void 0,revisionView:"detail"});return}if(u==="selected"&&$){const oe=ee?m:"all_collections";vt({libraryId:x,target:oe,collectionId:$,revisionId:he,revisionView:oe==="all_revisions"?"settings":"detail"});return}if(u==="collections"){vt({libraryId:x,target:"all_cards",collectionId:$,revisionId:he,revisionView:je,infoId:l.infoId,infoView:"collections"});return}vt({libraryId:x,target:ee?m:"all_collections",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection",label:d.layers.collection,visible:Ot&&ye!=="create",value:$??"",selectedLabel:(ge==null?void 0:ge.name)??d.path.noCollectionSelected,disabled:!Je||xe||S.length===0,options:S.map(u=>({value:u.collectionId,label:u.name})),emptyOption:d.selectCollectionOption,onSelect:u=>{const oe=u||void 0,H=ee?m:"all_collections";vt({libraryId:x,target:H,collectionId:oe,revisionId:void 0,revisionView:H==="all_revisions"?"settings":"detail"})}},{key:"collection_selected_action",label:d.layers.revision,visible:Et,value:m==="all_revisions"?"revisions":Q==="graph"?"edit":Q==="settings"||Q==="run"||Q==="shared"?"revisions":(l.collectionView??"infos")==="overview"?"overview":"infos",selectedLabel:m==="all_revisions"?d.targets.allRevisions:Q==="graph"?"Edytuj":Q==="settings"||Q==="run"||Q==="shared"?d.targets.allRevisions:(l.collectionView??"infos")==="overview"?"Przegląd":"Informacje",disabled:!$,options:[{value:"overview",label:"Przegląd"},{value:"edit",label:"Edytuj"},{value:"infos",label:"Informacje"},{value:"revisions",label:d.targets.allRevisions}],onSelect:u=>{if($){if(u==="edit"){vt({libraryId:x,target:ee?m:"all_collections",collectionId:$,revisionId:void 0,revisionView:"graph"});return}if(u==="revisions"){vt({libraryId:x,target:ee?m:"all_collections",collectionId:$,revisionId:he,revisionView:"settings"});return}vt({libraryId:x,target:ee?m:"all_collections",collectionId:$,revisionId:void 0,revisionView:"detail",infoId:l.infoId,infoView:l.infoView,collectionView:u==="overview"?"overview":"infos"})}}},{key:"revision_mode",label:d.layers.revision,visible:ua,value:je==="new"?"create":!he&&Q==="shared"?"shared":"search",selectedLabel:je==="new"?d.revisionForm.createAction:!he&&Q==="shared"?d.targets.sharedRevisions:d.infoActions.search,disabled:m==="all_revisions"?!Je:!Ct,options:[{value:"search",label:d.infoActions.search},{value:"create",label:d.revisionForm.createAction},{value:"shared",label:d.targets.sharedRevisions}],onSelect:u=>{vt({libraryId:x,target:ee?m:"all_revisions",collectionId:m==="all_revisions"?void 0:$,revisionId:void 0,revisionView:u==="create"?"new":u==="shared"?"shared":"settings"})}},{key:"revision_entry",label:d.layers.revision,visible:ua,value:he??"",selectedLabel:(P==null?void 0:P.name)??d.status.noRevisions,disabled:(m==="all_revisions"?!Je:!Ct)||se||K.length===0,options:K.map(u=>({value:u.revisionId,label:u.name})),emptyOption:d.status.noRevisions,onSelect:u=>{vt({libraryId:x,target:ee?m:"all_collections",collectionId:$,revisionId:u||void 0,revisionView:Q==="settings"||Q==="run"||Q==="shared"?Q:"settings"})}},{key:"revision_selected_action",label:d.layers.revision,visible:Lt,value:Q==="run"?"run":Q==="shared"?"shared":"settings",selectedLabel:Q==="run"?d.revisions.run:Q==="shared"?d.targets.sharedRevisions:d.infoActions.edit,disabled:!he,options:[{value:"settings",label:d.infoActions.edit},{value:"run",label:d.revisions.run},{value:"shared",label:d.targets.sharedRevisions}],onSelect:u=>{he&&vt({libraryId:x,target:ee?m:"all_collections",collectionId:$,revisionId:he,revisionView:u==="run"?"run":u==="shared"?"shared":"settings"})}}],[S,xe,U,v,j,te,vt,K,se,ge,$,ie,P,he,R,Ct,Je,be,ee,x,Ke,je,m,Q,re,qe,Ot,Et,ua,Lt,Le,t.cogita.library.list.selectedEmpty,l.infoId,l.infoView,l.collectionView,d.infoActions.edit,d.infoActions.overview,d.infoActions.seeCards,d.layers.collection,d.layers.library,d.layers.revision,d.layers.target,d.noLibraryOption,d.path.noCollectionSelected,d.path.noLibrarySelected,d.selectCollectionOption,d.targets.allRevisions,d.infoActions.search,d.revisionForm.createAction,d.revisions.run,d.targets.sharedRevisions,ye]),kt=a.useMemo(()=>St.filter(u=>u.visible),[St]),yt=a.useMemo(()=>kt.filter(u=>u.key!=="library"&&u.key!=="collection"),[kt]),Kt=a.useMemo(()=>yt.find(u=>u.key==="target")??null,[yt]),st=a.useMemo(()=>yt.find(u=>u.key==="info_mode")??null,[yt]),Ue=a.useMemo(()=>yt.find(u=>u.key==="info_selected_action")??null,[yt]),ft=a.useMemo(()=>yt.find(u=>u.key==="collection_mode")??null,[yt]),Qt=a.useMemo(()=>yt.find(u=>u.key==="revision_mode")??null,[yt]),Vt=a.useMemo(()=>yt.find(u=>u.key==="collection_selected_action")??null,[yt]),Bt=a.useMemo(()=>yt.find(u=>u.key==="revision_entry")??null,[yt]),me=a.useMemo(()=>yt.find(u=>u.key==="revision_selected_action")??null,[yt]),$t=a.useCallback((u,oe)=>u?e.jsx("div",{className:"cogita-sidebar-actions",children:u.options.map(H=>e.jsx("button",{type:"button",className:`ghost ${String(u.value)===H.value?"active":""}`,onClick:()=>u.onSelect(H.value),disabled:u.disabled,title:H.label,children:fa(H.label,Aa)},`${oe}:${u.key}:${H.value}`))}):null,[]),Xt=a.useMemo(()=>{const u=l.libraryId;if(!u||!p.pathname.startsWith("/cogita/library/"))return null;const oe={copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,libraryId:u};if(l.target==="library_overview")return e.jsx(ei,{...oe});if(l.target==="all_cards")return l.infoId&&l.infoView==="cards"?e.jsx(Ai,{...oe,infoId:l.infoId,selectedReviewerRoleId:Ye||null}):e.jsx(hi,{...oe,mode:l.cardMode??"list"});if(l.target==="new_card")return e.jsx(wi,{...oe,editInfoId:l.infoId});if(l.target==="dependencies")return e.jsx(Ni,{...oe});if(l.target==="transfer")return e.jsx(Fi,{...oe});if(l.target==="storyboards"||l.target==="new_storyboard")return e.jsx(Ki,{...oe});if(l.target==="texts"||l.target==="new_text")return e.jsx(_i,{...oe});if(l.target==="all_collections"||l.target==="all_revisions"){if(l.target==="all_revisions"&&!l.collectionId)return l.revisionView==="run"?e.jsx(Dn,{...oe,revisionId:l.revisionId}):e.jsx(Fs,{...oe,revisionId:l.revisionId});if(!l.collectionId&&l.revisionView==="run")return e.jsx(Dn,{...oe,revisionId:l.revisionId});if(l.collectionId){const H={...oe,collectionId:l.collectionId};return l.revisionView==="graph"?e.jsx(ho,{...H}):l.revisionView==="shared"?e.jsx(Ei,{...oe,collectionId:l.collectionId}):l.revisionView==="settings"?e.jsx(Fs,{...H,revisionId:l.revisionId}):l.revisionView==="run"?e.jsx(Dn,{...H,revisionId:l.revisionId}):e.jsx(Bi,{...H})}return e.jsx(Di,{...oe})}return l.target==="new_collection"?e.jsx(qi,{...oe,onCreated:H=>{vt({libraryId:u,target:m==="all_revisions"?"all_revisions":"all_collections",collectionId:H,revisionId:void 0,revisionView:"graph"})}}):null},[n,vt,t,f,p.pathname,i,k,h,w,s,o,l.cardMode,l.collectionId,l.infoId,l.libraryId,l.revisionId,l.revisionView,l.target,c,r,m,Ye]);a.useEffect(()=>{let u=!1;return(async()=>{var H,Qe,rt,lt,It;Y(!0);try{await $r();const[Mt,jt,At]=await Promise.all([Vs(),Js(),Rr()]);if(u)return;g(Mt);const ha=new Set(At.nodes.filter(ut=>ut.nodeType==="role"&&ut.canLink).map(ut=>ut.roleId??"")),ma=fo(jt,ha);if(A(ma),ma){const ut=At.nodes.find(_t=>_t.nodeType==="data"&&_t.roleId===ma&&(_t.fieldType===zn||_t.label===zn));E((ut==null?void 0:ut.dataKeyId)??null),N.current=bo(ut==null?void 0:ut.value)}const Ft=(H=Mt.find(ut=>ut.libraryId===l.libraryId))==null?void 0:H.libraryId,ta=Ft?(rt=(Qe=N.current.byLibrary)==null?void 0:Qe[Ft])==null?void 0:rt.lastTarget:void 0,Ta=po(ta)?ta:"library_overview";W(Ft),D(l.target??Ta),ne(l.revisionId??(Ft?(It=(lt=N.current.byLibrary)==null?void 0:lt[Ft])==null?void 0:It.lastRevisionId:void 0)),De(l.revisionView??"detail"),C.current=!0}catch{u||Ee(d.status.loadFailed)}finally{u||Y(!1)}})(),()=>{u=!0}},[d.status.loadFailed]),a.useLayoutEffect(()=>{if(C.current){if(!l.libraryId){W(void 0),D(l.target??"library_overview"),T(void 0),ne(void 0),De("detail");return}l.libraryId&&j.some(u=>u.libraryId===l.libraryId)&&W(l.libraryId),l.target&&D(l.target),T(l.collectionId),ne(l.revisionId),l.revisionView&&De(l.revisionView)}},[j,l.collectionId,l.libraryId,l.revisionId,l.revisionView,l.target]),a.useEffect(()=>{if(!x){V([]),T(void 0),y([]),q([]),ne(void 0);return}let u=!1;return le(!0),Va({libraryId:x,limit:200}).then(oe=>{var rt;if(u)return;const H=oe.items;V(H);const Qe=(rt=H.find(lt=>lt.collectionId===l.collectionId))==null?void 0:rt.collectionId;T(Qe)}).catch(()=>{u||(V([]),T(void 0))}).finally(()=>{u||le(!1)}),()=>{u=!0}},[l.collectionId,x]),a.useEffect(()=>{if(!x||re!=="all_cards"&&m!=="new_card"){y([]);return}let u=!1;return Xn({libraryId:x,limit:200}).then(oe=>{u||y(oe)}).catch(()=>{u||y([])}),()=>{u=!0}},[re,x,m]),a.useEffect(()=>{if(!x||m!=="all_revisions"&&!$){q([]),m!=="all_revisions"&&ne(void 0);return}let u=!1;return Te(!0),Gn({libraryId:x,collectionId:m==="all_revisions"?void 0:$}).then(oe=>{var rt,lt,It,Mt;if(u)return;q(oe);const H=(lt=(rt=N.current.byLibrary)==null?void 0:rt[x])==null?void 0:lt.lastRevisionId,Qe=((It=oe.find(jt=>jt.revisionId===l.revisionId))==null?void 0:It.revisionId)??((Mt=oe.find(jt=>jt.revisionId===H))==null?void 0:Mt.revisionId);ne(Qe)}).catch(()=>{u||(q([]),ne(void 0))}).finally(()=>{u||Te(!1)}),()=>{u=!0}},[l.revisionId,$,x,m]),a.useEffect(()=>{const u=l.infoId;if(!x||!u){I(void 0);return}let oe=!1;return na({libraryId:x,infoId:u}).then(H=>{if(oe)return;const Qe=H.payload??{},rt=Qe.definition&&typeof Qe.definition=="object"?Qe.definition:null,lt=typeof(rt==null?void 0:rt.title)=="string"?rt.title:void 0,It=typeof(rt==null?void 0:rt.question)=="string"?rt.question:void 0,Mt=typeof Qe.label=="string"?Qe.label:void 0,jt=typeof Qe.name=="string"?Qe.name:void 0,At=typeof Qe.title=="string"?Qe.title:void 0;I(lt??It??Mt??jt??At??H.infoId)}).catch(()=>{oe||I(u)}),()=>{oe=!0}},[l.infoId,x]),a.useEffect(()=>{if(!C.current||l.libraryId&&j.some(rt=>rt.libraryId===l.libraryId)&&l.libraryId!==x||l.target&&l.target!==m||l.revisionView&&l.revisionView!==je||l.revisionId&&l.revisionId!==he||Vn[m].requiresCollection&&!$&&(l.target==="all_collections"||l.target==="all_revisions")&&l.collectionId)return;const u=ba(`${p.pathname}${p.search}`);if(ba(p.pathname)==="/cogita"&&!l.libraryId&&!x){ue.current=null;return}if(ba(p.pathname)==="/cogita/persons"){ue.current=null;return}if(ba(p.pathname)===`/cogita/library/${x}/revision/run`&&l.revisionView==="run"&&!l.collectionId&&(m==="all_collections"||m==="all_revisions")&&je==="run"&&!$){ue.current=null;return}const Qe=ba(_s(x,m,$,je,he,l.infoId,l.infoView??"overview",l.collectionView??"infos"));if(u===Qe){ue.current=null;return}ue.current!==Qe&&(ue.current=Qe,i(Qe,{replace:!0}))},[j,p.pathname,p.search,i,l.collectionId,l.infoId,l.infoView,l.collectionView,l.libraryId,l.revisionId,l.revisionView,l.target,$,x,he,je,m]),a.useEffect(()=>{if(typeof window>"u")return;const u=()=>{window.innerWidth>920&&_(!1)};return window.addEventListener("resize",u),()=>window.removeEventListener("resize",u)},[]),a.useEffect(()=>{if(!C.current||!F||!x||L.current)return;const u=N.current,oe={...u.byLibrary??{}},H={...oe[x]??{},lastCollectionId:$,lastRevisionId:he,lastRevisionView:je,lastTarget:m},Qe={version:1,lastLibraryId:x,byLibrary:{...oe,[x]:H}},rt=JSON.stringify(u),lt=JSON.stringify(Qe);if(rt===lt)return;N.current=Qe,L.current=!0,(async()=>{try{if(B)await Pr(B,{plainValue:lt});else{const Mt=await Er(F,{itemName:zn,itemType:"data",plainValue:lt});E(Mt.dataItemId)}}catch{Ee(d.status.savePrefsFailed)}finally{L.current=!1}})()},[B,F,$,x,he,je,m,d.status.savePrefsFailed]);const qt=async()=>{const u=ct.trim();if(!u){Ee(t.cogita.user.libraryNameRequired);return}Ee(null);try{const oe=await Kr({name:u});g(H=>[oe,...H]),W(oe.libraryId),D("library_overview"),T(void 0),Ce("")}catch{Ee(t.cogita.user.libraryCreateFailed)}},O=async()=>{if(!x||!$){Ee(d.status.selectLibraryFirst);return}const u=Ve.trim();if(!u){Ee(d.revisionForm.nameLabel);return}Ee(null);try{const oe=await Fr({libraryId:x,collectionId:$,name:u,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});q(H=>[oe,...H]),ne(oe.revisionId),D(m==="all_revisions"?"all_revisions":"all_collections"),De("settings"),Be("")}catch{Ee(d.status.loadFailed)}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,headerExtra:e.jsxs("div",{className:"cogita-header-reviewer-actions",children:[e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:Ye,disabled:!x,onChange:u=>{const oe=u.target.value;if(oe==="__new_person__"){i("/cogita/persons");return}Ie(oe)},children:[e.jsx("option",{value:"",children:x?"No person":"Select library first"}),tt.map(u=>e.jsx("option",{value:u.roleId,children:u.label},u.roleId)),e.jsx("option",{value:"__new_person__",children:"+ Create new person"})]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>i("/cogita/persons"),children:"Persons"})]}),children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${X?"open":""}`,"aria-label":d.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{title:(be==null?void 0:be.name)??d.path.noLibrarySelected,children:fa((be==null?void 0:be.name)??d.path.noLibrarySelected,Aa)}),e.jsx("p",{className:"cogita-sidebar-note",children:be?d.sidebar.libraryActionsHint:d.status.selectLibraryFirst}),$t(Kt,"sidebar"),m==="all_revisions"&&Bt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.targets.allRevisions}),$t(Qt,"sidebar"),$t(Bt,"sidebar"),me?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(P==null?void 0:P.name)??d.status.noRevisions,children:fa((P==null?void 0:P.name)??d.status.noRevisions,Aa)}),$t(me,"sidebar")]}):null]}):null,st?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.infoActionsHint}),$t(st,"sidebar"),Ue?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(ie==null?void 0:ie.label)??R??t.cogita.library.list.selectedEmpty,children:fa((ie==null?void 0:ie.label)??R??t.cogita.library.list.selectedEmpty,Aa)}),e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.selectedInfoActionsHint}),$t(Ue,"sidebar")]}):null]}):null,ft?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.collectionActionsHint}),$t(ft,"sidebar"),ge&&Vt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:ge.name,children:fa(ge.name,Aa)}),$t(Vt,"sidebar"),m!=="all_revisions"&&Bt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.targets.allRevisions}),$t(Qt,"sidebar"),$t(Bt,"sidebar"),me?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(P==null?void 0:P.name)??d.status.noRevisions,children:fa((P==null?void 0:P.name)??d.status.noRevisions,Aa)}),$t(me,"sidebar")]}):null]}):null]}):null]}):null]}),e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:d.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:s,children:d.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{w("cogita"),_(!1)},children:d.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:o,children:c?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),X?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":d.sidebar.closeMenu,onClick:()=>_(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":d.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>_(u=>!u),"aria-label":X?d.sidebar.closeMenu:d.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),kt.map((u,oe)=>e.jsxs("div",{className:"cogita-browser-segment",children:[oe>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,u.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":u.label,title:u.selectedLabel,children:fa(u.selectedLabel,Ks)}):e.jsxs("select",{"aria-label":u.label,value:u.value,onChange:H=>u.onSelect(H.target.value),disabled:u.disabled,children:[u.emptyOption?e.jsx("option",{value:"",children:u.emptyOption}):null,u.options.map(H=>e.jsx("option",{value:H.value,title:H.label,children:fa(H.label,Ks)},`${u.key}:${H.value}`))]})]},`menu:${u.key}`))]}),Xt?e.jsxs(e.Fragment,{children:[(m==="all_collections"||m==="all_revisions")&&je==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:d.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsxs("select",{value:$??"",onChange:u=>T(u.target.value||void 0),children:[e.jsx("option",{value:"",children:d.selectCollectionOption}),S.map(u=>e.jsx("option",{value:u.collectionId,children:u.name},u.collectionId))]})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:d.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Ve,onChange:u=>Be(u.target.value),placeholder:d.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:O,children:d.revisionForm.createAction}),Ae?e.jsx("p",{className:"cogita-form-error",children:Ae}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Ys.Provider,{value:!0,children:Xt})})]}):null,Xt?null:e.jsxs(e.Fragment,{children:[Z?e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Pi,{copy:t,onPersonCreated:u=>{Xe(oe=>oe+1)}})}):null,!x&&!Z?e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:wt.step}),e.jsx("h2",{children:wt.title})]}),e.jsxs("p",{children:[pt+1," / ",mt]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:wt.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:wt.passages.map(u=>e.jsx("p",{children:u},u))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:wt.focus.map(u=>e.jsx("span",{children:u},u))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:wt.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:bt.map((u,oe)=>e.jsx("button",{type:"button",className:`ghost ${oe===pt?"active":""}`,onClick:()=>et(oe),"aria-label":`${oe+1}`,children:oe+1},`tutorial:${u.title}:${oe}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:pt===0,onClick:()=>et(u=>Math.max(0,u-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:pt===mt-1,onClick:()=>et(u=>Math.min(mt-1,u+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:ct,onChange:u=>Ce(u.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:qt,children:t.cogita.user.createLibraryAction}),Ae?e.jsx("p",{className:"cogita-form-error",children:Ae}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),j.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,j.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:j.map(u=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{vt({libraryId:u.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:u.name})]},u.libraryId))}):null]})]})]}):null]})]})]})})}const Lo=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:yo},Symbol.toStringTag,{value:"Module"}));function xo({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,shareId:i}){const[p,l]=a.useState(null),[d,j]=a.useState("loading"),[g,S]=a.useState(t.cogita.library.collections.defaultName),[V,v]=a.useState("Cogita Library"),[y,K]=a.useState([]),[q,x]=a.useState([]),[W,m]=a.useState("idle"),[D,$]=a.useState({current:0,total:0}),[T,he]=a.useState(0),[ne,je]=a.useState(""),[De,R]=a.useState(null),[I,X]=a.useState(null),[_,te]=a.useState(null),[Y,xe]=a.useState(null),[le,se]=a.useState([]),[Te,Ae]=a.useState({}),[Ee,$e]=a.useState({}),[et,ct]=a.useState(null),[Ce,We]=a.useState(null),[xt,Ve]=a.useState(null),[Be,tt]=a.useState(null),[ot,Ye]=a.useState({}),Ie=a.useRef(0),[ze,Xe]=a.useState(null),F=a.useRef(null),A=a.useRef(null),[B,E]=a.useState(null),[N,C]=a.useState(!1),[L,ue]=a.useState(null),[be,ge]=a.useState([]),[Z,P]=a.useState(null),G=a.useRef(null),re=a.useRef(null),[Q,ee]=a.useState(null),[ye,U]=a.useState(0),ie=a.useRef(null),Le=a.useRef({}),[qe,Ke]=a.useState(!1),[Je,bt]=a.useState({}),mt=a.useRef(null),pt=a.useRef(new Set),wt=a.useRef({}),[Ct,Ot]=a.useState([]),[Et,Nt]=a.useState(new Set),[ua,Lt]=a.useState(!1),vt=Ja(),St=a.useMemo(()=>new URLSearchParams(vt.search),[vt.search]),kt=a.useMemo(()=>St.get("key")??"",[St]),yt=(p==null?void 0:p.mode)??"random",Kt=(p==null?void 0:p.check)??"exact",st=(p==null?void 0:p.limit)??20,Ue=a.useMemo(()=>rs((p==null?void 0:p.revisionType)??yt),[p,yt]),ft=a.useMemo(()=>{const z=p==null?void 0:p.revisionSettings,ce=nr(Ue,St);return wn(Ue,z??ce)},[p,St,Ue]),Qt=a.useMemo(()=>t.cogita.library.revision[Ue.labelKey]??yt,[t,yt,Ue]),Vt=a.useMemo(()=>Kt==="exact"?t.cogita.library.revision.checkValue:Kt,[t,Kt]),me=d==="ready"?y[T]??null:null,$t=(me==null?void 0:me.checkType)==="translation-match"&&Be,Xt=a.useRef(new Map),qt=a.useRef(new Map),O=a.useRef(new Map),u=a.useRef(new Map),oe=a.useMemo(()=>me?me.cardType==="vocab"?t.cogita.library.revision.vocabLabel:me.infoType?nt(t,me.infoType):t.cogita.library.revision.infoLabel:"",[t,me]),H=a.useMemo(()=>{var ce;return Ue.id!=="levels"?y.length:((ce=Je.pool)==null?void 0:ce.length)??Ue.getFetchLimit(st,ft)},[Je,ft,Ue,y.length,st]),Qe=Ue.getProgressTotal?Ue.getProgressTotal(y,Je,st,ft):Ue.id==="levels"?Math.min(st,H):y.length,rt=Qe?Math.min(T+1,Qe):0,lt=Math.max(1,Number(ft.tries??1)),It=ft.compare??"anchors",Mt=Math.max(0,Math.min(100,Number(ft.minCorrectness??0))),jt=(ft.considerDependencies??"on")==="on",At=Math.max(0,Math.min(100,Number(ft.dependencyThreshold??85))),ha=z=>{const ce=z.slice();for(let we=ce.length-1;we>0;we-=1){const Fe=Math.floor(Math.random()*(we+1));[ce[we],ce[Fe]]=[ce[Fe],ce[we]]}return ce},ma=z=>xa(z,{treatSimilarCharsAsSame:!0})>=Mt,Ft=async()=>{const z=await ca(),ce=new Map,we=new Map;z.forEach(ke=>{const Re=`${ke.itemType}:${ke.itemId}`,Me=ea(ke.itemType,ke.itemId,ke.checkType,ke.direction);ce.has(Re)||ce.set(Re,[]),ce.get(Re).push(ke),we.has(Me)||we.set(Me,[]),we.get(Me).push(ke)});const Fe=new Map,_e=new Map;return ce.forEach((ke,Re)=>Fe.set(Re,la(ke).score)),we.forEach((ke,Re)=>_e.set(Re,la(ke).score)),{itemKnowness:Fe,cardKnowness:_e}},ta=async z=>{const ce=Je,we=z.concat(ce.active??[]).concat(ce.pool??[]).filter((b,M,J)=>J.findIndex(pe=>Ne(pe)===Ne(b))===M);if(!jt){Nt(new Set(we.map(Ne)));return}const{itemKnowness:Fe,cardKnowness:_e}=await Ft(),ke=b=>{if(b.cardType!=="info"||b.infoType!=="citation"||b.checkType!=="quote-fragment")return!0;const M=Wt(b.direction);if(!(M!=null&&M.fragmentId))return!0;const J=b.description??"";if(!J.trim())return!0;const fe=va(J).nodes[M.fragmentId];if(!fe||!fe.leftId&&!fe.rightId)return!0;const de=[fe.leftId,fe.rightId].filter(Se=>!!Se);if(de.length===0)return!0;const ve=de.map(Se=>{const Oe=ea("info",b.cardId,"quote-fragment",Se);return _e.get(Oe)??0});return ve.reduce((Se,Oe)=>Se+Oe,0)/ve.length>=At},Re=(p==null?void 0:p.collectionId)??null,Me=Re?Ct.filter(b=>Tt(b.childItemType)==="collection"&&b.childItemId===Re&&!Tt(b.childCheckType)&&!Tt(b.childDirection)):[],Pe=Re&&we.length>0?we.reduce((b,M)=>b+(_e.get(Ne(M))??0),0)/we.length:0,Ge=new Set;for(const b of we){if(b.cardType!=="info"){Ge.add(Ne(b));continue}if(!ke(b))continue;const M=Ct.filter(fe=>cr(fe,b)).concat(Me);if(M.length===0){Ge.add(Ne(b));continue}let J=0;for(const fe of M)if(Tt(fe.parentItemType)==="collection")J+=fe.parentItemId===Re?Pe:0;else if(Tt(fe.parentCheckType)||Tt(fe.parentDirection)){const de=Tt(fe.parentCheckType),ve=Tt(fe.parentDirection),ae=ea(fe.parentItemType,fe.parentItemId,de,ve);J+=_e.get(ae)??0}else{const de=`${fe.parentItemType}:${fe.parentItemId}`;J+=Fe.get(de)??0}J/M.length>=At&&Ge.add(Ne(b))}Nt(Ge)},Ta=z=>{for(let ce=z;ce<y.length;ce+=1){const we=y[ce];if(we&&(!jt||we.cardType!=="info"||Et.has(Ne(we))))return ce}return-1},ut=z=>!jt||z.cardType!=="info"||Et.has(Ne(z)),_t=z=>{if(Ue.id!=="temporal"&&Ue.id!=="levels")return null;const ce=Je,we=(ce.active??[]).concat(ce.pool??[]),Fe=new Set;for(const _e of we){const ke=Ne(_e);if(!(Fe.has(ke)||z.has(ke))&&(Fe.add(ke),ut(_e)))return _e}return null},Zt=a.useMemo(()=>{if(Ue.id!=="levels")return null;const z=Je,ce=z.pool??[],we=z.active??[],Fe=z.levelMap??{},_e=Math.max(1,Number(ft.levels??1)),ke=Array.from({length:_e},()=>0),Re=new Set(we.map(b=>Ne(b)));ce.forEach(b=>{const M=Math.min(_e,Math.max(1,Fe[Ne(b)]??1));ke[M-1]+=1});const Me=ce.length||1,Pe=ke.map(b=>b/Me*100),Ge=me?Fe[Ne(me)]??1:null;return{counts:ke,percentages:Pe,currentLevel:Ge,levelsCount:_e,activeCount:we.length,poolCount:ce.length,activeSet:Re}},[Je,ft,Ue,me]),ja=a.useMemo(()=>{if(Ue.id!=="temporal")return null;const z=Je,ce=z.pool??[],we=z.active??[],Fe=z.knownessMap??{},_e=new Set(z.unknownSet??[]);let ke=0;ce.forEach(Pe=>{(Fe[Ne(Pe)]??0)>1&&(ke+=1)});const Re=_e.size,Me=we.map(Pe=>({id:Ne(Pe),value:_e.has(Ne(Pe))?0:Math.max(0,Math.min(1,Fe[Ne(Pe)]??0))}));return{knownCount:ke,unknownCount:Re,dots:Me}},[Je,Ue]),Wa=a.useMemo(()=>{if(!jt)return 0;const z=Je;return y.concat(z.active??[]).concat(z.pool??[]).filter((we,Fe,_e)=>_e.findIndex(ke=>Ne(ke)===Ne(we))===Fe).filter(we=>we.cardType==="info"&&!Et.has(Ne(we))).length},[jt,Je,y,Et]);a.useEffect(()=>{if(!jt||W!=="ready")return;const z=Je,we=y.concat(z.active??[]).concat(z.pool??[]).filter((ke,Re,Me)=>Me.findIndex(Pe=>Ne(Pe)===Ne(ke))===Re).filter(ke=>ke.cardType!=="info"||Et.has(Ne(ke))).length,Fe=G.current;if(G.current=we,Fe===null||we<=Fe)return;const _e=we-Fe;P(`New card available (+${_e})`),re.current&&window.clearTimeout(re.current),re.current=window.setTimeout(()=>P(null),2200)},[jt,W,Je,y,Et]),a.useEffect(()=>()=>{re.current&&window.clearTimeout(re.current)},[]);const Gt=(z,ce)=>{const we=Ue.applyOutcome({queue:y,meta:Je},me,st,ft,{correct:z,correctness:ce,createdUtc:new Date().toISOString()});K(we.queue),bt(we.meta);const Fe=we.queue[T+1];Fe&&zt(Fe,T+1)};a.useEffect(()=>{if(!i){j("error");return}j("loading"),_r({shareId:i,key:kt}).then(z=>{l(z),S(z.collectionName),v(z.libraryName),j("ready")}).catch(()=>{j("error")})},[i,kt]),a.useEffect(()=>{i&&Dr({shareId:i,key:kt,type:"language"}).then(z=>x(z)).catch(()=>x([]))},[i,kt]),a.useEffect(()=>{!i||d!=="ready"||Br({shareId:i,key:kt}).then(z=>Ot(z.items??[])).catch(()=>Ot([]))},[i,kt,d]),a.useEffect(()=>{if(!i||d!=="ready")return;let z=!0;return(async()=>{m("loading"),$({current:0,total:Ue.id==="levels"?0:Ue.getFetchLimit(st,ft)});try{const we=[];let Fe=null,_e=null;do{const M=await zr({shareId:i,key:kt,limit:300,cursor:Fe});if(we.push(...M.items),(Ue.id==="levels"||Ue.id==="temporal")&&M.total&&(_e=M.total),$(J=>({current:we.length,total:J.total||M.total||Ue.getFetchLimit(st,ft)})),Fe=M.nextCursor??null,_e!==null&&we.length>=_e||Ue.id!=="levels"&&Ue.id!=="temporal"&&we.length>=Ue.getFetchLimit(st,ft))break}while(Fe);if(!z)return;const ke=Oa(we);let Re;if(Ue.id==="levels"){const M=Math.max(1,Number(ft.levels??1));Re={},ke.forEach(J=>{const pe=Ne(J);Re[pe]=Math.max(1,Math.min(M,1))})}let Me=null,Pe=null,Ge=null;if(Ue.id==="temporal"){const M=await ca(),J=new Set(ke.map(de=>Ne(de))),pe=M.reduce((de,ve)=>{const ae=ea(ve.itemType,ve.itemId,ve.checkType,ve.direction);return J.has(ae)&&(de[ae]||(de[ae]=[]),de[ae].push(ve)),de},{});Me={},Pe=new Set,Ge={};const fe=Date.now();ke.forEach(de=>{const ve=Ne(de),ae=pe[ve]??[];if(ae.length===0){Me[ve]=0,Pe.add(ve),Ge[ve]=[];return}const Se=as(ae);Ge[ve]=Se;const Oe=vn(Se,fe);Me[ve]=Oe.knowness})}const b=Ue.id==="levels"?ss(ke,st,ft,Re):Ue.id==="temporal"?ns(ke,st,ft,Me??{},Pe??new Set,Ge??{}):Ue.prepare(ke,st,ft);K(b.queue),bt(b.meta),he(0),m("ready"),$(M=>({current:Math.min(M.current,M.total),total:M.total}))}catch{z&&m("error")}})(),()=>{z=!1}},[i,kt,st,Ue,ft,d]),a.useEffect(()=>{ta(y)},[y,Ct,jt,At,p==null?void 0:p.collectionId]),a.useEffect(()=>{if(!me||!jt){Lt(!1);return}if(me.cardType!=="info"||Et.has(Ne(me))){Lt(!1);return}const z=Ta(T+1);if(z>=0){Lt(!1),he(z);return}if(Ue.id==="temporal"||Ue.id==="levels"){const ce=y.slice(0,T+1),we=y.slice(T+1).filter(ut),Fe=ce.concat(we),_e=new Set(Fe.map(Ne)),ke=_t(_e);if(ke){const Me=Ne(ke);_e.has(Me)||(Fe.push(ke),_e.add(Me),bt(Pe=>{const Ge=Pe,b=new Set(Ge.queued??[]);return b.add(Me),{...Ge,queued:b}}))}const Re=Fe.findIndex((Me,Pe)=>Pe!==T&&ut(Me));if(Re>=0){K(Fe),he(Re),Lt(!1);return}}Lt(!0)},[me,Et,jt,T,y,Je,Ue.id]),a.useEffect(()=>{if(je(""),R(null),ee(null),U(0),se([]),Ae({}),$e({}),ct(null),We(null),Ve(null),C(!1),Ke(!1),E(null),tt(null),Ye({}),!me){X(null),te(null);return}me.cardType==="info"&&me.infoType==="computed"&&X(t.cogita.library.revision.loadingComputed);let z=!0;return zt(me,T).then(ce=>{!z||!ce||(X(ce.prompt),te(ce.expectedAnswer),se(ce.computedExpected),Ae(ce.computedAnswers),ct(ce.answerTemplate),We(ce.outputVariables),Ve(ce.variableValues))}),()=>{z=!1}},[me,i,t]),a.useEffect(()=>{if(!me||me.cardType!=="info"||me.infoType!=="citation"){mt.current=null,pt.current=new Set,xe(null);return}const z=me.description??"",ce=(me.label??"").trim(),we=ce.replace(/\s+/g," ").trim(),Fe=z.replace(/\s+/g," ").trim(),_e=we&&we!==Fe?ce:t.cogita.library.infoTypes.citation;if(!z){xe(null),te(null);return}const ke=va(z);mt.current=ke,X(_e);let Re=!0;return ca().then(Me=>{if(!Re)return;const Pe=new Map;Me.forEach(pe=>{if(pe.itemType!=="info"||pe.checkType!=="quote-fragment"||!pe.direction)return;const fe=Wt(pe.direction);if(!fe)return;const de=`${pe.itemId}:${fe.fragmentId}`;Pe.has(de)||Pe.set(de,[]),Pe.get(de).push(pe)});const Ge={},b=new Set;Pe.forEach((pe,fe)=>{const[de,ve]=fe.split(":",2);if(de!==me.cardId)return;const ae=la(pe).score;Ge[ve]=ae,ae>=At&&b.add(ve)}),pt.current=b,wt.current=Ge;const M=Wt(me.direction);if(M!=null&&M.fragmentId&&ke.nodes[M.fragmentId]){sa(ke,M.fragmentId,_e);return}const J=$a(ke,b,Ge,At,jt,me.direction);sa(ke,(J==null?void 0:J.id)??null,_e)}).catch(()=>{pt.current=new Set,wt.current={};const Me=Wt(me.direction);if(Me!=null&&Me.fragmentId&&ke.nodes[Me.fragmentId]){sa(ke,Me.fragmentId,_e);return}const Pe=$a(ke,pt.current,{},At,jt,me.direction);sa(ke,(Pe==null?void 0:Pe.id)??null,_e)}),()=>{Re=!1}},[me,t,jt,At]),a.useEffect(()=>{if(!me||me.cardType!=="vocab"||me.checkType!=="translation-match"){tt(null),Ye({});return}const we=(Je.pool??Je.active??y).filter(Me=>Me.cardType==="vocab"&&Me.checkType==="translation-match").filter((Me,Pe,Ge)=>Ge.findIndex(b=>b.cardId===Me.cardId)===Pe);we.some(Me=>Me.cardId===me.cardId)||we.unshift(me);const _e=ha(we).slice(0,6).map(Me=>{const Pe=Me.label.split("↔").map(M=>M.trim()).filter(Boolean);if(Pe.length<2)return null;const Ge=`${Me.cardId}:L`,b=`${Me.cardId}:R`;return{cardId:Me.cardId,leftId:Ge,rightId:b,leftLabel:Pe[0],rightLabel:Pe[1]}}).filter(Boolean),ke=_e.map(Me=>Me.leftId),Re=ha(_e.map(Me=>Me.rightId));tt({pairs:_e,leftOrder:ke,rightOrder:Re,selection:{},activeLeft:null,activeRight:null,locked:{}})},[me,y,Je]),a.useEffect(()=>()=>{F.current&&window.clearTimeout(F.current),A.current&&window.clearTimeout(A.current)},[]);const Ca=a.useRef(null);a.useEffect(()=>{if(!me)return;const z=Ne(me),ce=typeof document<"u"?document.activeElement:null;if(Ca.current===z&&ce&&(ce.tagName==="INPUT"||ce.tagName==="TEXTAREA"))return;let we=0;const Fe=()=>{if(me){if(me.cardType==="info"&&me.infoType==="computed"){if(le.length>0){const ke=hn(et,le,Ce),Re=ke?Le.current[ke]:null;if(Re&&(Re.focus(),document.activeElement===Re)){Ca.current=z;return}}if(ie.current&&(ie.current.focus(),document.activeElement===ie.current)){Ca.current=z;return}}else if(me.cardType==="vocab"&&ie.current&&(ie.current.focus(),document.activeElement===ie.current)){Ca.current=z;return}we<6&&(we+=1,window.setTimeout(Fe,40))}},_e=window.setTimeout(Fe,40);return()=>window.clearTimeout(_e)},[me,le,et,Ce]),a.useEffect(()=>{if(!qe)return;const z=ce=>{ce.key==="Enter"&&(ce.preventDefault(),Ut())};return window.addEventListener("keydown",z),()=>window.removeEventListener("keydown",z)},[qe]);const Ia=z=>{ge(z),ue(la(z))};a.useEffect(()=>{if(!me){ue(null),ge([]);return}const z=me.cardType==="info"?"info":"connection";if(me.cardType==="info"&&me.infoType==="citation"){ca().then(ce=>{const we=ce.filter(Fe=>Fe.itemType==="info"&&Fe.itemId===me.cardId&&Fe.checkType==="quote-fragment"&&dn(Fe.direction,me.direction));Ia(we)}).catch(()=>{ue(null),ge([])});return}cn(z,me.cardId,me.checkType,me.direction).then(ce=>Ia(ce)).catch(()=>{ue(null),ge([])})},[me]);const Pa=(z,ce,we,Fe)=>{if(z==="info"&&we==="quote-fragment"){ca().then(_e=>{const ke=_e.filter(Re=>Re.itemType==="info"&&Re.itemId===ce&&Re.checkType==="quote-fragment"&&dn(Re.direction,Fe));Ia(ke)}).catch(()=>{ue(null),ge([])});return}cn(z,ce,we,Fe).then(_e=>Ia(_e)).catch(()=>{ue(null),ge([])})},Qa=(z,ce,we)=>{var Re;const Fe=((Re=we.pairs.find(Me=>Me.leftId===z))==null?void 0:Re.rightId)??null;if(!Fe)return we;const _e=Fe===ce;Ye(Me=>({...Me,[z]:_e?"correct":"incorrect"})),F.current&&window.clearTimeout(F.current),A.current&&window.clearTimeout(A.current),Ie.current+=1;const ke={kind:_e?"correct":"incorrect",tick:Ie.current};if(Xe(null),F.current=window.setTimeout(()=>Xe(ke),0),A.current=window.setTimeout(()=>Xe(null),420),_e){const Me={...we.locked,[z]:!0};return Object.keys(Me).length>=we.pairs.length?(R("correct"),Ke(!0)):R("correct"),{...we,selection:{...we.selection,[z]:ce},activeLeft:null,activeRight:null,locked:Me}}return R("incorrect"),{...we,activeLeft:null,activeRight:null}},Ea=z=>{tt(ce=>!ce||ce.locked[z]?ce:ce.activeRight?Qa(z,ce.activeRight,ce):{...ce,activeLeft:ce.activeLeft===z?null:z})},kn=z=>{tt(ce=>ce&&(ce.activeLeft?Qa(ce.activeLeft,z,ce):{...ce,activeRight:ce.activeRight===z?null:z}))},Ut=()=>{var z;if(me&&me.cardType==="info"&&me.infoType==="citation"&&mt.current&&Y&&!((z=Wt(me.direction))!=null&&z.fragmentId)){const ce=$a(mt.current,pt.current,wt.current,At,jt,me.direction,Y.fragmentId);if(ce){R(null),je(""),C(!1),$e({}),Ke(!1),ee(null),U(0),sa(mt.current,ce.id,Y.title);return}}R(null),je(""),C(!1),$e({}),Ke(!1),ee(null),U(0),he(ce=>Math.min(ce+1,y.length))},Jt=z=>{if(!me)return;const ce=z.expected??null,we=z.answer??"";let Fe=ce??"",_e=we;if(!ce&&z.expectedMap&&z.answerMap){const M=Object.keys(z.expectedMap).sort((J,pe)=>J.localeCompare(pe));Fe=M.map(J=>{var pe;return((pe=z.expectedMap)==null?void 0:pe[J])??""}).join("|"),_e=M.map(J=>{var pe;return((pe=z.answerMap)==null?void 0:pe[J])??""}).join("|")}const ke=Fe?Ra(Fe,_e,It):new Uint8Array,Re={revisionType:Ue.id,evalType:z.evalType,direction:z.direction,prompt:I??"",expected:ce,answer:we,expectedAnswers:z.expectedMap??null,answers:z.answerMap??null,correct:z.correct,maskBase64:ke.length?ya(ke):null,checkMode:Kt,compareMode:It,minCorrectness:Mt},Me=new TextEncoder().encode(JSON.stringify(Re)),Pe=me.cardType==="info"?"info":"connection",Ge=z.overrideCheckType??me.checkType??null,b=z.overrideDirection??me.direction??null;ln({itemType:Pe,itemId:me.cardId,checkType:Ge,direction:b,revisionType:Ue.id,evalType:z.evalType,correct:z.correct,maskBase64:ke.length?ya(ke):null,payloadBase64:ya(Me)}).then(()=>{Pa(Pe,me.cardId,Ge,b),ta(y)}).catch(()=>{})},Nn=(z,ce)=>{const we=Xt.current.get(ce);if(we)return Promise.resolve(we);const Fe=qt.current.get(ce);if(Fe)return Fe;const _e=Or({shareCode:i,infoId:z,key:kt}).then(ke=>{var M,J;const Re=ke.payload,Me=((M=Re.definition)==null?void 0:M.graph)??null,Pe="",Ge=((J=Re.definition)==null?void 0:J.answerTemplate)??"",b=sr(Me,Pe,Ge);if(b){const fe={sample:rr(b),answerTemplate:Ge||null};return Xt.current.set(ce,fe),fe}return ds({shareId:i,infoId:z,key:kt}).then(pe=>{const fe={sample:pe,answerTemplate:null};return Xt.current.set(ce,fe),fe})}).catch(()=>ds({shareId:i,infoId:z,key:kt}).then(ke=>{const Re={sample:ke,answerTemplate:null};return Xt.current.set(ce,Re),Re}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{qt.current.delete(ce)});return qt.current.set(ce,_e),_e},zt=(z,ce)=>{var Me;const we=`${Ne(z)}:${ce}`,Fe=O.current.get(we);if(Fe)return Promise.resolve(Fe);const _e=u.current.get(we);if(_e)return _e;const ke=Pe=>(O.current.set(we,Pe),Pe);let Re;if(z.cardType==="vocab"){if(z.checkType==="translation-match")return Re=Promise.resolve(ke({prompt:z.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),Re;const Pe=z.label.split("↔").map(Ge=>Ge.trim()).filter(Boolean);if(Pe.length>=2){const b=(z.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",M=b?Pe[0]:Pe[1],J=b?Pe[1]:Pe[0];Re=Promise.resolve(ke({prompt:M,expectedAnswer:J,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else Re=Promise.resolve(ke({prompt:z.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(z.cardType==="info"&&z.infoType==="word"){const Pe=(Me=z.description)!=null&&Me.startsWith("Language: ")?z.description.replace("Language: ",""):null;Re=Promise.resolve(ke({prompt:z.label,expectedAnswer:Pe,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else z.cardType==="info"&&z.infoType==="computed"?Re=Nn(z.cardId,we).then(Pe=>{var pe,fe;if(!Pe.sample)return ke({prompt:z.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const Ge=Pe.sample,b=Ge.expectedAnswers?Object.entries(Ge.expectedAnswers).map(([de,ve])=>({key:de,expected:ve})):[],M=b.reduce((de,ve)=>(de[ve.key]="",de),{}),J=Ge.expectedAnswerIsSentence&&((pe=Ge.expectedAnswer)==null?void 0:pe.trim())||null;return ke({prompt:Ge.prompt,expectedAnswer:b.length>0?J:((fe=Ge.expectedAnswer)==null?void 0:fe.trim())||null,computedExpected:b,computedAnswers:M,answerTemplate:Pe.answerTemplate,outputVariables:Ge.outputVariables??null,variableValues:Ge.variableValues??null})}).catch(()=>ke({prompt:z.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{u.current.delete(we)}):Re=Promise.resolve(ke({prompt:z.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return u.current.set(we,Re),Re},sa=(z,ce,we)=>{const Fe=Object.keys(z.nodes).length,_e=pt.current.size;if(!ce){xe({title:we,before:z.text,after:"",fragmentId:null,total:Fe,completed:_e}),te(null),Ke(!0);return}const ke=z.nodes[ce];if(!ke)return;const Re=xn(z.text,ke);xe({title:we,before:Re.before,after:Re.after,fragmentId:ke.id,total:Fe,completed:_e}),te(Re.fragment),Ke(!1)},Ma=()=>{const z=mt.current;z&&xe(ce=>ce&&{...ce,total:Object.keys(z.nodes).length,completed:pt.current.size})},wa=()=>{const z=y[T+1];z&&zt(z,T+1)},Fa=()=>{if(wa(),me&&me.cardType==="vocab"&&me.checkType==="translation-match"&&Be){if(Be.pairs.length===0){R("incorrect"),Ke(!0);return}const ke=Be.pairs.reduce((J,pe)=>(J[pe.rightId]=pe.rightLabel,J),{});let Re=0;const Me={};Be.pairs.forEach(J=>{const fe=Be.selection[J.leftId]===J.rightId;Me[J.leftId]=fe?"correct":"incorrect",fe&&(Re+=1)});const Pe=Be.pairs.length||1,Ge=Re/Pe,b=Re===Be.pairs.length;Ye(J=>({...J,...Me})),b?(R("correct"),Ke(!0),U(0)):(R("incorrect"),Ke(!1),U(J=>{const pe=J+1;return pe>=lt&&(C(!0),Ke(!0),tt(fe=>{if(!fe)return fe;const de=fe.pairs.reduce((ve,ae)=>(ve[ae.leftId]=ae.rightId,ve),{});return{...fe,selection:de}})),pe})),Gt(b,Ge);const M="connection";Promise.all(Be.pairs.map(J=>{const pe=Be.selection[J.leftId]??null,fe=pe?ke[pe]:"",de={left:J.leftLabel,expected:J.rightLabel,answer:fe,checkType:"translation-match"},ve=new TextEncoder().encode(JSON.stringify(de));return ln({itemType:M,itemId:J.cardId,checkType:"translation-match",direction:null,revisionType:Ue.id,evalType:"translation-match",correct:pe===J.rightId,maskBase64:null,payloadBase64:ya(ve)})})).then(()=>{Pa(M,me.cardId,me.checkType,me.direction),ta(y)}).catch(()=>{});return}if(le.length>0){const ke=le.reduce((Me,Pe)=>{const Ge=Te[Pe.key]??"";return Me[Pe.key]=Dt(Ge)===Dt(Pe.expected)?"correct":"incorrect",Me},{});le.every(({key:Me,expected:Pe})=>{const Ge=Te[Me]??"";return Kt==="exact"&&Dt(Ge)===Dt(Pe)})?(R("correct"),$e(ke),Ke(!0),U(0),Gt(!0,1),Jt({correct:!0,direction:I?`${I} -> computed`:"computed",expectedMap:le.reduce((Me,Pe)=>(Me[Pe.key]=Pe.expected,Me),{}),answerMap:Te,evalType:"computed"})):(R("incorrect"),$e(ke),Ke(!1),U(Me=>{const Pe=Me+1;return Pe>=lt&&ga&&(C(!0),Ke(!0)),Pe}),Gt(!1,0),window.setTimeout(()=>{var Pe;const Me=hn(et,le,Ce);Me&&Le.current[Me]&&((Pe=Le.current[Me])==null||Pe.focus())},40),Jt({correct:!1,direction:I?`${I} -> computed`:"computed",expectedMap:le.reduce((Me,Pe)=>(Me[Pe.key]=Pe.expected,Me),{}),answerMap:Te,evalType:"computed"}));return}if(me&&me.cardType==="info"&&me.infoType==="citation"&&(Y!=null&&Y.fragmentId)){if(!_)return;const ke=Wt(me.direction),Re=(ke==null?void 0:ke.fragmentId)??Y.fragmentId,Me=Sa(_,ne,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Pe=Me.mask,Ge=Me.isCorrect,b=Me.percent;Ge?(wt.current[Y.fragmentId]=Math.max(wt.current[Y.fragmentId]??0,b),(wt.current[Y.fragmentId]??0)>=At&&pt.current.add(Y.fragmentId),Ma(),R("correct"),$e({}),Ke(!0),ee(Pe),U(0),b<100&&lt<=1&&C(!0),Gt(!0,b/100),Jt({correct:!0,direction:`quote:${Y.fragmentId}`,expected:_,answer:ne,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Re})):(R("incorrect"),$e({}),Ke(!1),ee(Pe),U(M=>{const J=M+1;return J>=lt&&ga&&(C(!0),Ke(!0)),J}),Gt(!1,b/100),window.setTimeout(()=>{var M;return(M=ie.current)==null?void 0:M.focus()},40),Jt({correct:!1,direction:`quote:${Y.fragmentId}`,expected:_,answer:ne,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Re}));return}if(!_)return;const z=Ra(_,ne,It),ce=Kt==="exact"&&Dt(ne)===Dt(_),we=ma(z),Fe=ce||we,_e=xa(z);Fe?(R("correct"),$e({}),Ke(!0),ee(z),U(0),_e<100&&lt<=1&&C(!0),Gt(!0,_e/100),Jt({correct:!0,direction:I?`${I} -> ${_}`:null,expected:_,answer:ne,evalType:"text"})):(R("incorrect"),$e({}),Ke(!1),ee(z),U(ke=>{const Re=ke+1;return Re>=lt&&ga&&(C(!0),Ke(!0)),Re}),Gt(!1,_e/100),window.setTimeout(()=>{var ke;return(ke=ie.current)==null?void 0:ke.focus()},40),Jt({correct:!1,direction:I?`${I} -> ${_}`:null,expected:_,answer:ne,evalType:"text"}))},Sn=z=>{if(wa(),!_)return;const ce=Ra(_,z,It),we=Dt(z)===Dt(_),Fe=ma(ce),_e=we||Fe,ke=xa(ce);_e?(R("correct"),$e({}),Ke(!0),ee(ce),U(0),ke<100&&lt<=1&&C(!0),Gt(!0,ke/100),Jt({correct:!0,direction:"word->language",expected:_,answer:z,evalType:"language-select"})):(R("incorrect"),$e({}),Ke(!1),ee(ce),U(Re=>{const Me=Re+1;return Me>=lt&&ga&&(C(!0),Ke(!0)),Me}),Gt(!1,ke/100),Jt({correct:!1,direction:"word->language",expected:_,answer:z,evalType:"language-select"}))},Tn=z=>{var we;if(z.key!=="Enter")return;if(z.preventDefault(),z.stopPropagation(),qe){Ut();return}const ce=le.find(Fe=>!(Te[Fe.key]??"").trim());if(ce){(we=Le.current[ce.key])==null||we.focus();return}Fa()},La=()=>{wa(),R("correct"),Ke(!0),U(0),Gt(!0,1),_&&Jt({correct:!0,direction:"manual",expected:_,answer:ne,evalType:"manual"})},aa=()=>{if(Gt(!1,0),me&&me.cardType==="info"&&me.infoType==="citation"){R(null),je(""),C(!1),$e({}),Ke(!1),ee(null),U(0),he(z=>Math.min(z+1,y.length));return}Ut()};a.useEffect(()=>{wa()},[T,y]);const Cn=t.cogita.library.revision.revealModeAfterIncorrect,ga=le.length>0||!!_;return e.jsxs(Pt,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:c,onNavigate:w,language:f,onLanguageChange:k,children:[(d==="loading"||W==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:d==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${D.total?Math.min(100,Math.max(0,D.current/D.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:D.total?`${Math.min(D.current,D.total)} / ${D.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:g}),e.jsx("p",{className:"cogita-library-subtitle",children:V}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",Qt).replace("{check}",Vt)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:L?`${L.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Zt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Zt.currentLevel??"-"," / ",Zt.levelsCount]}):null,L?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(L.correct)).replace("{total}",String(L.total))}),L.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(L.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(ir,{outcomes:be})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[Z?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:Z})}):null,e.jsx(es,{feedbackToken:ze?`${ze.kind}-${ze.tick}`:$t?"idle":De??"idle",children:d!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:d==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):me?e.jsx(e.Fragment,{children:ua?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(ts,{copy:t,currentCard:me,currentTypeLabel:oe,prompt:I,languages:q,answer:ne,onAnswerChange:z=>je(ce=>un(ce,z,B)),computedExpected:le,computedAnswers:Te,onComputedAnswerChange:(z,ce)=>Ae(we=>({...we,[z]:un(we[z]??"",ce,B)})),answerTemplate:et,outputVariables:Ce,variableValues:xt,computedFieldFeedback:Ee,feedback:De,canAdvance:qe,quoteContext:Y,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Fa,onSkip:aa,onLanguageSelect:Sn,onMarkReviewed:La,onAdvance:Ut,showCorrectAnswer:N,setShowCorrectAnswer:C,onRevealCorrect:()=>Ke(!0),answerMask:Q,expectedAnswer:_,hasExpectedAnswer:ga,handleComputedKeyDown:Tn,answerInputRef:ie,computedInputRefs:Le,scriptMode:B,setScriptMode:E,matchPairs:Be==null?void 0:Be.pairs,matchLeftOrder:Be==null?void 0:Be.leftOrder,matchRightOrder:Be==null?void 0:Be.rightOrder,matchSelection:Be==null?void 0:Be.selection,matchActiveLeft:Be==null?void 0:Be.activeLeft,matchActiveRight:Be==null?void 0:Be.activeRight,matchFeedback:ot,onMatchLeftSelect:Ea,onMatchRightSelect:kn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Qe?`${rt} / ${Qe}`:t.cogita.library.revision.progressUnlimited}),d==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),d==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),d==="ready"&&W==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),d==="ready"&&W==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),d==="ready"&&W==="ready"&&y.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Cn}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",lt]})]})]}),Zt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Zt.activeCount," / ",Zt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Zt.counts.map((z,ce)=>{const we=ce+1,Fe=Zt.currentLevel===we,_e=Zt.percentages[ce]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":Fe,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:we}),e.jsx("strong",{children:z})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,_e))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[_e.toFixed(1),"%"]})]},`level-${we}`)})})]}):null,ja?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:ja.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:ja.dots.map(z=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-z.value))}, ${Math.round(200*z.value)}, 80, 0.9)`}},z.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:ja.knownCount})]})]}):null,jt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Wa})]})}):null]})]})]})})})]})]})}const Ao=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:xo},Symbol.toStringTag,{value:"Module"})),oa=t=>String(t??"").trim().toLocaleLowerCase(),gn=t=>Array.from(new Set(t.map(n=>Number(n)).filter(Number.isFinite))).sort((n,r)=>n-r),Ds=t=>t.map(n=>n.join(",")).sort().join("|");function vo(t){const n=t.split("↔").map(r=>r.trim()).filter(Boolean);return n.length>=2?[n[0],n[1]]:null}function jo(t){if(!t)return null;const n=t.indexOf(":");return n>=0?t.slice(n+1).trim():t.trim()}function wo(t,n,r,s){const o=typeof r.type=="string"?r.type:"",h=typeof r.title=="string"&&r.title.trim()?r.title.trim():n,c=typeof r.question=="string"?r.question:n;if(!o||!c)return null;if(o==="selection"){const w=Array.isArray(r.options)?r.options.filter(k=>typeof k=="string"):[],f=Array.isArray(r.answer)?gn(r.answer):[];return{roundIndex:s,cardKey:`info:${t}:question-selection`,publicPrompt:{kind:"selection",title:h,prompt:c,options:w,multiple:!0,cardLabel:"question"},reveal:{kind:"selection",expected:f,title:h},grade:k=>{const i=Array.isArray(k)?gn(k):[];return JSON.stringify(i)===JSON.stringify(f)}}}if(o==="truefalse"){const w=!!r.answer;return{roundIndex:s,cardKey:`info:${t}:question-truefalse`,publicPrompt:{kind:"boolean",title:h,prompt:c,cardLabel:"question"},reveal:{kind:"boolean",expected:w,title:h},grade:f=>!!f===w}}if(o==="text"||o==="number"||o==="date"){const w=String(r.answer??"");return{roundIndex:s,cardKey:`info:${t}:question-${o}`,publicPrompt:{kind:"text",title:h,prompt:c,inputType:o==="number"?"number":o==="date"?"date":"text",cardLabel:"question"},reveal:{kind:"text",expected:w,title:h},grade:f=>{if(o==="number"){const k=Number(f),i=Number(w);return Number.isFinite(k)&&Number.isFinite(i)&&Math.abs(k-i)<1e-9}return oa(f)===oa(w)}}}if(o==="ordering"){const w=Array.isArray(r.options)?r.options.filter(f=>typeof f=="string"):[];return{roundIndex:s,cardKey:`info:${t}:question-ordering`,publicPrompt:{kind:"ordering",title:h,prompt:c,options:w,cardLabel:"question"},reveal:{kind:"ordering",expected:w,title:h},grade:f=>JSON.stringify(Array.isArray(f)?f.map(String):[])===JSON.stringify(w)}}if(o==="matching"){const w=Array.isArray(r.columns)?r.columns.map(i=>Array.isArray(i)?i.filter(p=>typeof p=="string"):[]):[],f=r.answer??{},k=Array.isArray(f.paths)?f.paths.map(i=>Array.isArray(i)?i.map(p=>Number(p)).filter(Number.isFinite):null).filter(i=>Array.isArray(i)):[];return{roundIndex:s,cardKey:`info:${t}:question-matching`,publicPrompt:{kind:"matching",title:h,prompt:c,columns:w,cardLabel:"question"},reveal:{kind:"matching",expected:{paths:k},title:h},grade:i=>{const p=i??{},l=Array.isArray(p.paths)?p.paths.map(d=>Array.isArray(d)?d.map(j=>Number(j)).filter(Number.isFinite):null).filter(d=>Array.isArray(d)):[];return Ds(l)===Ds(k)}}}return null}async function ko(t){const n=await Zn({libraryId:t.libraryId,revisionId:t.revisionId}),s=(await qa({libraryId:t.libraryId,collectionId:n.collectionId,limit:1e3})).items,o=Array.from(new Set(s.filter(i=>i.cardType==="info").map(i=>i.cardId))),h=new Map;await Promise.all(o.map(async i=>{try{const p=await na({libraryId:t.libraryId,infoId:i});h.set(i,{infoType:p.infoType,payload:p.payload})}catch{}}));const c=new Map;await Promise.all(Array.from(h.entries()).filter(([,i])=>i.infoType==="computed").map(async([i])=>{try{const p=await Un({libraryId:t.libraryId,infoId:i});c.set(i,p)}catch{}}));const w=Array.from(new Set(s.filter(i=>i.cardType==="vocab").map(i=>i.label))).filter(Boolean),f=[],k=new Set;for(const i of s){if(i.cardType==="vocab"){const l=vo(i.label);if(!l)continue;if(i.checkType==="translation"&&i.direction==="a-to-b"){const[d,j]=l;f.push({roundIndex:f.length,cardKey:`connection:${i.cardId}:translation:a-to-b`,publicPrompt:{kind:"text",title:i.label,prompt:d,cardLabel:i.description??void 0},reveal:{kind:"text",expected:j,title:i.label},grade:g=>oa(g)===oa(j)})}else if(i.checkType==="translation"&&i.direction==="b-to-a"){const[d,j]=l;f.push({roundIndex:f.length,cardKey:`connection:${i.cardId}:translation:b-to-a`,publicPrompt:{kind:"text",title:i.label,prompt:j,cardLabel:i.description??void 0},reveal:{kind:"text",expected:d,title:i.label},grade:g=>oa(g)===oa(d)})}else if(i.checkType==="translation-match"){const d=Array.from(new Set([i.label,...w.filter(g=>g!==i.label).slice(0,3)])),j=d.findIndex(g=>g===i.label);f.push({roundIndex:f.length,cardKey:`connection:${i.cardId}:translation-match`,publicPrompt:{kind:"selection",title:i.label,prompt:"Select the matching pair",options:d,multiple:!1,cardLabel:i.description??void 0},reveal:{kind:"selection",expected:[j],title:i.label},grade:g=>{const S=Array.isArray(g)?gn(g):gn([g]);return S.length===1&&S[0]===j}})}continue}if(i.cardType!=="info")continue;const p=h.get(i.cardId);if(p){if(p.infoType==="word"&&i.checkType==="word-language"){const l=jo(i.description);if(!l)continue;f.push({roundIndex:f.length,cardKey:`info:${i.cardId}:word-language:${i.direction??""}`,publicPrompt:{kind:"text",title:i.label,prompt:`Language of: ${i.label}`,cardLabel:"word-language"},reveal:{kind:"text",expected:l,title:i.label},grade:d=>oa(d)===oa(l)});continue}if(p.infoType==="computed"&&i.checkType==="computed"){const l=c.get(i.cardId);if(!l)continue;f.push({roundIndex:f.length,cardKey:`info:${i.cardId}:computed`,publicPrompt:{kind:"text",title:i.label,prompt:l.prompt,multiLine:!1,cardLabel:"computed"},reveal:{kind:"text",expected:l.expectedAnswer,title:i.label},grade:d=>oa(d)===oa(l.expectedAnswer)});continue}if(p.infoType==="question"){const l=p.payload,d=l.definition??l,j=wo(i.cardId,i.label,d,f.length);j&&(j.roundIndex=f.length,f.push(j));continue}if(p.infoType==="citation"&&!k.has(i.cardId)){k.add(i.cardId);const l=p.payload,d=typeof l.text=="string"?l.text:"",j=typeof l.title=="string"&&l.title.trim()?l.title.trim():i.label;if(!d.trim())continue;const g=va(d,{minLen:7,maxLen:13});for(const S of g.order){const V=g.nodes[S];if(!V)continue;const v=xn(d,V);f.push({roundIndex:f.length,cardKey:`info:${i.cardId}:quote-fragment:${S}`,publicPrompt:{kind:"citation-fragment",title:j,before:v.before,after:v.after,fragmentId:S,cardLabel:"quote-fragment"},reveal:{kind:"citation-fragment",expected:v.fragment,title:j},grade:y=>Sa(v.fragment,String(y??""),{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}).isCorrect})}continue}}}return f.map((i,p)=>({...i,roundIndex:p}))}function No(t){const{libraryId:n,revisionId:r}=t,[s,o]=a.useState(null),[h,c]=a.useState([]),[w,f]=a.useState("loading"),[k,i]=a.useState(null),p=`cogita.live.host.${n}.${r}`,l=s?h[s.currentRoundIndex]??null:null,d=s!=null&&s.status&&s.status!=="lobby"?s.currentPrompt??null:null,j=(s==null?void 0:s.currentReveal)??null,g=a.useMemo(()=>s!=null&&s.code&&typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision/${encodeURIComponent(s.code)}`:"",[s==null?void 0:s.code]),S=(s==null?void 0:s.status)==="finished"?"finished":s!=null&&s.status&&s.status!=="lobby"?"active":"lobby",V=(m,D,$)=>({...m,hostSecret:m.hostSecret||(D==null?void 0:D.hostSecret)||($==null?void 0:$.hostSecret)||"",code:m.code||(D==null?void 0:D.code)||($==null?void 0:$.code)||""});a.useEffect(()=>{let m=!1;return ko({libraryId:n,revisionId:r}).then(D=>{m||c(D)}).catch(()=>{m||(i("Failed to load revision cards for live session."),f("error"))}),()=>{m=!0}},[n,r]),a.useEffect(()=>{let m=!1;async function D(){try{typeof localStorage<"u"&&localStorage.removeItem(p);const $=await qr({libraryId:n,revisionId:r,title:"Live revision"});if(m)return;o($),localStorage.setItem(p,JSON.stringify({sessionId:$.sessionId,hostSecret:$.hostSecret,code:$.code})),f("ready")}catch{if(m)return;i("Failed to create live session."),f("error")}}return D(),()=>{m=!0}},[n,r,p]),a.useEffect(()=>{if(!s)return;const m=window.setInterval(async()=>{try{const D=await Vr({libraryId:n,sessionId:s.sessionId,hostSecret:s.hostSecret});o($=>V(D,$))}catch{}},1200);return()=>window.clearInterval(m)},[n,s]);const v=async m=>{if(!s)return;const D=await Jr({libraryId:n,sessionId:s.sessionId,hostSecret:s.hostSecret,status:m.status??s.status,currentRoundIndex:m.currentRoundIndex??s.currentRoundIndex,revealVersion:m.revealVersion??s.revealVersion,currentPrompt:m.currentPrompt??s.currentPrompt??null,currentReveal:m.currentReveal??s.currentReveal??null});o($=>V(D,$))},y=async m=>{const D=h[m];!D||!s||await v({status:"running",currentRoundIndex:m,revealVersion:s.revealVersion+1,currentReveal:null,currentPrompt:{...D.publicPrompt,roundIndex:m,cardKey:D.cardKey}})},K=async()=>{h.length&&await y((s==null?void 0:s.currentRoundIndex)??0)},q=async()=>{if(!s||!l)return;const m=new Map(s.currentRoundAnswers.map(T=>[T.participantId,T.answer])),D=s.participants.map(T=>{const he=m.get(T.participantId),ne=l.grade(he);return{participantId:T.participantId,isCorrect:ne,pointsAwarded:ne?1:0}}),$=await Ur({libraryId:n,sessionId:s.sessionId,hostSecret:s.hostSecret,scores:D});o(T=>V($,T)),await v({status:"revealed",revealVersion:$.revealVersion+1,currentReveal:l.reveal})},x=async()=>{if(!s)return;const m=s.currentRoundIndex+1;if(m>=h.length){await v({status:"finished",currentReveal:null});return}await y(m)},W=(m,D)=>{if(!m)return e.jsx("p",{className:"cogita-help",children:"Waiting for host to publish a question."});const $=String(m.kind??""),T=typeof D<"u",he=Array.isArray(D)?D.map(ne=>Number(ne)).filter(Number.isFinite):[];if($==="citation-fragment")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":T?"correct":"idle",children:[e.jsxs("p",{children:[e.jsx("span",{style:{opacity:.7},children:String(m.before??"")}),e.jsx("strong",{children:" [ ... ] "}),e.jsx("span",{style:{opacity:.7},children:String(m.after??"")})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:T?"Correct fragment":"Fragment"}),e.jsx("input",{readOnly:!0,value:T?String(D??""):"",placeholder:"Participant answer here"})]})]});if($==="text")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":T?"correct":"idle",children:[e.jsx("p",{children:String(m.prompt??"")}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:T?"Correct answer":"Answer"}),e.jsx("input",{readOnly:!0,value:T?String(D??""):"",placeholder:"Participant answer here"})]})]});if($==="boolean"){const ne=!!D;return e.jsxs("div",{className:"cogita-live-card-surface","data-state":T?"correct":"idle",children:[e.jsx("p",{children:String(m.prompt??"")}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:`cta ghost ${T&&ne?"live-correct-answer":""}`,disabled:!0,children:"True"}),e.jsx("button",{type:"button",className:`cta ghost ${T&&!ne?"live-correct-answer":""}`,disabled:!0,children:"False"})]})]})}if($==="selection"){const ne=Array.isArray(m.options)?m.options.map(String):[],je=!!m.multiple;return e.jsxs("div",{className:"cogita-live-card-surface","data-state":T?"correct":"idle",children:[e.jsx("p",{children:String(m.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:ne.map((De,R)=>e.jsxs("label",{className:"cogita-share-row","data-state":T&&he.includes(R)?"correct":void 0,children:[e.jsx("span",{children:De}),e.jsx("input",{type:je?"checkbox":"radio",disabled:!0,checked:T?he.includes(R):!1,readOnly:!0})]},`${R}-${De}`))})]})}if($==="ordering"){const ne=Array.isArray(T?D:m.options)?(T?D:m.options).map(String):[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":T?"correct":"idle",children:[e.jsx("p",{children:String(m.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:ne.map((je,De)=>e.jsxs("div",{className:"cogita-share-row","data-state":T?"correct":void 0,children:[e.jsx("span",{children:je}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:!0,children:"↑"}),e.jsx("button",{type:"button",className:"ghost",disabled:!0,children:"↓"})]})]},`${De}-${je}`))})]})}if($==="matching"){const ne=Array.isArray(m.columns)?m.columns:[],je=(D==null?void 0:D.paths)??[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":T?"correct":"idle",children:[e.jsx("p",{children:String(m.prompt??"")}),T?e.jsx("div",{className:"cogita-share-list",children:je.map((De,R)=>e.jsx("div",{className:"cogita-share-row","data-state":"correct",children:e.jsx("span",{children:De.map((I,X)=>{const _=Array.isArray(ne[X])?ne[X]:[],te=String(_[I]??I);return`${X>0?" → ":""}${te}`})})},`path-${R}`))}):e.jsx("div",{className:"cogita-form-actions",children:ne.map((De,R)=>e.jsx("select",{disabled:!0,children:(Array.isArray(De)?De:[]).map((I,X)=>e.jsx("option",{children:String(I)},`${R}-${X}`))},`host-col-${R}`))})]})}return e.jsx("pre",{className:"cogita-json-preview",children:JSON.stringify(m,null,2)})};return e.jsx(Pt,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":S,children:[e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Live Revision Host"}),e.jsx("h2",{className:"cogita-detail-title",children:"Host session"}),w==="loading"?e.jsx("p",{children:"Loading…"}):null,k?e.jsx("p",{className:"cogita-help",children:k}):null,s?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Join code"}),e.jsx("input",{readOnly:!0,value:s.code})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Join URL"}),e.jsx("input",{readOnly:!0,value:g})]}),g?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"QR"}),e.jsx("div",{style:{display:"inline-flex",padding:"0.75rem",borderRadius:"12px",background:"#fff"},children:e.jsx(ur,{value:g,size:176,marginSize:2})})]}):null,e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Status"}),e.jsx("input",{readOnly:!0,value:s.status})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:K,disabled:!h.length,children:"Publish current round"}),e.jsx("button",{type:"button",className:"cta ghost",onClick:q,disabled:!l,children:"Reveal + score"}),e.jsx("button",{type:"button",className:"cta ghost",onClick:x,disabled:!h.length,children:"Next"})]}),e.jsxs("p",{className:"cogita-help",children:["Rounds: ",h.length]})]}):null]}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Current round"}),e.jsx("h3",{className:"cogita-detail-title",children:d&&typeof d.title=="string"?d.title:(s==null?void 0:s.status)==="lobby"?"Session not started":"Waiting for published round"}),(s==null?void 0:s.status)==="lobby"?e.jsx("p",{className:"cogita-help",children:"No question is shown before the host starts the session."}):W(d,j==null?void 0:j.expected),S!=="finished"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Participants"}),e.jsxs("div",{className:"cogita-share-list",children:[s==null?void 0:s.participants.map(m=>{const D=s.currentRoundAnswers.find($=>$.participantId===m.participantId);return e.jsx("div",{className:"cogita-share-row",children:e.jsxs("div",{children:[e.jsx("strong",{children:m.displayName}),e.jsxs("div",{className:"cogita-share-meta",children:[D?"answered":"waiting",(D==null?void 0:D.isCorrect)===!0?" · correct":"",(D==null?void 0:D.isCorrect)===!1?" · incorrect":""]})]})},m.participantId)}),s&&s.participants.length===0?e.jsx("p",{className:"cogita-help",children:"No participants yet."}):null]})]}):null]}),S!=="lobby"?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:S==="finished"?"Final score":"Points"}),e.jsx("div",{className:"cogita-share-list",children:((s==null?void 0:s.scoreboard)??[]).map(m=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:m.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[m.score," pt"]})]},`score:${m.participantId}`))})]}):null]})})})})})}const $o=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionHostPage:No},Symbol.toStringTag,{value:"Module"}));function Bs(t){return`cogita.live.join.${t}`}function So(t){const{code:n}=t,[r,s]=a.useState(""),[o,h]=a.useState(()=>typeof localStorage>"u"?null:localStorage.getItem(Bs(n))),[c,w]=a.useState(null),[f,k]=a.useState("idle"),[i,p]=a.useState(""),[l,d]=a.useState([]),[j,g]=a.useState(null),[S,V]=a.useState([]),[v,y]=a.useState([]),K=(c==null?void 0:c.currentPrompt)??null,q=(c==null?void 0:c.currentReveal)??null,x=q==null?void 0:q.expected,W=(c==null?void 0:c.status)==="finished"?"finished":c!=null&&c.status&&c.status!=="lobby"?"active":"lobby",m=a.useMemo(()=>`${(c==null?void 0:c.currentRoundIndex)??0}:${(c==null?void 0:c.revealVersion)??0}:${String((K==null?void 0:K.cardKey)??"")}`,[K==null?void 0:K.cardKey,c==null?void 0:c.currentRoundIndex,c==null?void 0:c.revealVersion]);a.useEffect(()=>{p(""),d([]),g(null),V(Array.isArray(K==null?void 0:K.options)?[...K.options??[]]:[]),y([])},[m]),a.useEffect(()=>{let R=!0;const I=async()=>{try{const _=await us({code:n,participantToken:o});if(!R)return;w(_),o&&k("ready")}catch{R&&f!=="joining"&&k("error")}};I();const X=window.setInterval(I,1200);return()=>{R=!1,window.clearInterval(X)}},[n,o,f]);const D=async()=>{k("joining");try{const R=await Hr({code:n,name:r});h(R.participantToken),localStorage.setItem(Bs(n),R.participantToken),k("ready")}catch{k("error")}},$=R=>{if(!!(K!=null&&K.multiple)){d(X=>X.includes(R)?X.filter(_=>_!==R):[...X,R].sort((_,te)=>_-te));return}d([R])},T=(R,I)=>{V(X=>{const _=[...X],te=R+I;return te<0||te>=_.length?X:([_[R],_[te]]=[_[te],_[R]],_)})},he=()=>{const R=Array.isArray(K==null?void 0:K.columns)?K.columns:[];y(I=>[...I,R.map(()=>0)])},ne=(R,I,X)=>{y(_=>_.map((te,Y)=>Y!==R?te:te.map((xe,le)=>le===I?X:xe)))},je=async()=>{if(!o||!K||typeof K.cardKey!="string")return;let R=null;switch(K.kind){case"selection":R=l;break;case"boolean":R=j;break;case"ordering":R=S;break;case"matching":R={paths:v};break;case"citation-fragment":case"text":default:R=i;break}try{await Wr({code:n,participantToken:o,roundIndex:Number(K.roundIndex??(c==null?void 0:c.currentRoundIndex)??0),cardKey:K.cardKey,answer:R});const I=await us({code:n,participantToken:o});w(I),k("ready")}catch{k("error")}},De=()=>{if(!K)return e.jsx("p",{className:"cogita-help",children:"Waiting for host to publish a question."});const R=!!q,I=Array.isArray(x)?x.map(X=>Number(X)).filter(Number.isFinite):[];if(K.kind==="citation-fragment")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":R?"correct":"idle",children:[e.jsxs("p",{children:[e.jsx("span",{style:{opacity:.7},children:String(K.before??"")}),e.jsx("strong",{children:" [ ... ] "}),e.jsx("span",{style:{opacity:.7},children:String(K.after??"")})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:R?"Correct fragment":"Fragment"}),e.jsx("input",{value:R?String(x??""):i,onChange:X=>p(X.target.value),readOnly:R})]})]});if(K.kind==="text")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":R?"correct":"idle",children:[e.jsx("p",{children:String(K.prompt??"")}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:R?"Correct answer":"Answer"}),e.jsx("input",{type:K.inputType==="number"?"number":K.inputType==="date"?"date":"text",value:R?String(x??""):i,onChange:X=>p(X.target.value),readOnly:R})]})]});if(K.kind==="boolean"){const X=!!x;return e.jsxs("div",{className:"cogita-live-card-surface","data-state":R?"correct":"idle",children:[e.jsx("p",{children:String(K.prompt??"")}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:`cta ghost ${R&&X?"live-correct-answer":""}`,onClick:()=>g(!0),disabled:R,children:"True"}),e.jsx("button",{type:"button",className:`cta ghost ${R&&!X?"live-correct-answer":""}`,onClick:()=>g(!1),disabled:R,children:"False"})]})]})}if(K.kind==="selection")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":R?"correct":"idle",children:[e.jsx("p",{children:String(K.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:(Array.isArray(K.options)?K.options:[]).map((X,_)=>e.jsxs("label",{className:"cogita-share-row","data-state":R&&I.includes(_)?"correct":void 0,children:[e.jsx("span",{children:X}),e.jsx("input",{type:K.multiple?"checkbox":"radio",name:"live-selection",checked:R?I.includes(_):l.includes(_),onChange:()=>$(_),disabled:R})]},`${_}-${X}`))})]});if(K.kind==="ordering"){const X=Array.isArray(R?x:S)?(R?x:S).map(String):[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":R?"correct":"idle",children:[e.jsx("p",{children:String(K.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:X.map((_,te)=>e.jsxs("div",{className:"cogita-share-row","data-state":R?"correct":void 0,children:[e.jsx("span",{children:_}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>T(te,-1),disabled:R,children:"↑"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>T(te,1),disabled:R,children:"↓"})]})]},`${te}-${_}`))})]})}if(K.kind==="matching"){const X=Array.isArray(K.columns)?K.columns:[],_=(x==null?void 0:x.paths)??[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":R?"correct":"idle",children:[e.jsx("p",{children:String(K.prompt??"")}),R?e.jsx("div",{className:"cogita-share-list",children:_.map((te,Y)=>e.jsx("div",{className:"cogita-share-row","data-state":"correct",children:e.jsx("span",{children:te.map((xe,le)=>{const se=Array.isArray(X[le])?X[le]:[];return`${le>0?" → ":""}${String(se[xe]??xe)}`})})},`path-${Y}`))}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:he,children:"Add path"})}),v.map((te,Y)=>e.jsx("div",{className:"cogita-form-actions",children:X.map((xe,le)=>e.jsx("select",{value:te[le]??0,onChange:se=>ne(Y,le,Number(se.target.value)),children:xe.map((se,Te)=>e.jsxs("option",{value:Te,children:[Te,": ",se]},`${le}-${Te}`))},`path-${Y}-col-${le}`))},`path-${Y}`))]})]})}return e.jsx("p",{className:"cogita-help",children:"Unsupported prompt type."})};return e.jsx(Pt,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":W,children:[e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Live Revision"}),e.jsx("h2",{className:"cogita-detail-title",children:"Join session"}),o?e.jsx("p",{className:"cogita-help",children:"Joined. Waiting for host."}):e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{value:r,onChange:R=>s(R.target.value)})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:D,disabled:!r.trim()||f==="joining",children:f==="joining"?"Joining…":"Join"})})]}),f==="error"?e.jsx("p",{className:"cogita-help",children:"Connection error or invalid session."}):null,W==="lobby"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Scoreboard"}),e.jsxs("div",{className:"cogita-share-list",children:[c==null?void 0:c.scoreboard.map(R=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:R.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[R.score," pt"]})]},R.participantId)),c&&c.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:"No participants yet."}):null]})]}):null]}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Question"}),e.jsx("h3",{className:"cogita-detail-title",children:typeof(K==null?void 0:K.title)=="string"?K.title:"Waiting for host"}),K?e.jsxs(e.Fragment,{children:[De(),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:je,disabled:!o||!K.cardKey||(c==null?void 0:c.answerSubmitted),children:c!=null&&c.answerSubmitted?"Submitted":"Submit answer"})})]}):e.jsx("p",{className:"cogita-help",children:"Waiting for host to publish a question."})]}),W!=="lobby"?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:W==="finished"?"Final score":"Points"}),e.jsxs("div",{className:"cogita-share-list",children:[c==null?void 0:c.scoreboard.map(R=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:R.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[R.score," pt"]})]},`score:${R.participantId}`)),c&&c.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:"No participants yet."}):null]})]}):null]})})})})})}const Ro=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionJoinPage:So},Symbol.toStringTag,{value:"Module"}));export{Mo as C,Lo as a,Ao as b,$o as c,Ro as d};
