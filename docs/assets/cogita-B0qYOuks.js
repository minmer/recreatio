import{r as a,j as e,u as In,a as an,b as ws,c as js,d as ks,R as Ln,B as Rn,C as $n}from"./vendor-CL5v9b84.js";import{L as Ns,A as Ss,g as Ts,a as Hs,b as Aa,c as Cs,s as qn,d as An,e as Ws,f as Un,h as ta,i as Gs,j as Oa,k as qa,l as Ms,m as En,n as Cn,o as Ys,u as Jn,p as Is,q as Qs,r as Xs,t as Zs,v as er,w as tr,x as Ls,y as ar,z as Rs,B as $s,C as nr,D as sr,E as nn,F as Ua,G as rr,H as ir,I as As,J as or,K as lr,M as cr,N as Hn,O as ua,P as dr,Q as ur,R as hr,S as mr,T as gr,U as pr,V as fr,W as br,X as yr,Y as xr,Z as vr,_ as wr,$ as jr,a0 as kr,a1 as Nr,a2 as Wn}from"./recreatio-core-DVMfabW8.js";import"./vendor-cogita-ui-mbCyoqV0.js";const La={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},Ia={moveMs:900,pauseMs:220,errorMs:900},Sr=(t=11)=>{let n=t;const s=()=>(n=(n*1664525+1013904223)%4294967296,n/4294967296),{width:r,height:i,paddingX:m,paddingY:h,levels:b}=La,j=(i-h*2)/(b.length-1),k=[],c=[],x=[];b.forEach((g,d)=>{const ie=i-h-d*j,K=r-m*2,y=[];for(let V=0;V<g;V+=1){const N=m+(V+1)*K/(g+1),Y=(s()-.5)*18,z=Math.max(m,Math.min(r-m,N+Y)),I=d===0?3:d<2?2.1:1.4,ue=d===0?"root":`l${d}-${V}`;y.push({id:ue,x:d===0?r/2:z,y:ie,r:I,level:d,role:d===0?"root":void 0})}x.push(y),k.push(...y)});const o=x[x.length-1];if(o!=null&&o.length){const g=o[Math.floor(o.length/2)];g.role="goal",g.r=2}for(let g=1;g<x.length;g+=1){const d=x[g-1];x[g].forEach(K=>{const y=[...d].sort((z,I)=>Math.abs(z.x-K.x)-Math.abs(I.x-K.x)),V=y[0],N=y[1]&&s()<.45?y[1]:null;(N?[V,N]:[V]).forEach(z=>{c.push({from:z.id,to:K.id,key:`${z.id}-${K.id}`})}),s()<.2&&y[2]&&c.push({from:y[2].id,to:K.id,key:`${y[2].id}-${K.id}`})})}const u=new Map;c.forEach(g=>{const d=u.get(g.to)??[];d.push(g.from),u.set(g.to,d)});const v=new Map,w=new Map,C=new Map;c.forEach(g=>{const d=v.get(g.from)??[];d.push(g.key),v.set(g.from,d);const ie=w.get(g.from)??[];ie.push(g.to),w.set(g.from,ie);const K=C.get(g.from)??[];K.push(g.to),C.set(g.from,K);const y=C.get(g.to)??[];y.push(g.from),C.set(g.to,y)});const F=new Map;return k.forEach(g=>{F.set(g.id,g)}),{nodes:k,links:c,parentsById:u,linksByFrom:v,childrenByFrom:w,neighborsById:C,nodesById:F}};function Tr({slides:t,activeIndex:n,introOpen:s,prefersReducedMotion:r,onNext:i,onPrev:m,onSelect:h,onExit:b,onOpen:j,onRegister:k}){const c=n===t.length-1,x=s&&n===0?"entry":"docked",o=t[t.length-1],[u,v]=a.useState(!1),w=a.useMemo(()=>Array.from({length:20},(R,X)=>({src:`/cogita/logo/Cogita${String(X).padStart(2,"0")}.png`,kind:X<=11?"bubble":X<=17?"text":"recreatio"})),[]),C=s&&n===0;a.useEffect(()=>{if(!s){v(!1);return}n>0&&!u&&v(!0)},[n,s,u]);const F=a.useRef(0),g=a.useRef(null),d=a.useMemo(()=>{const R={x:40,y:160},X={x:260,y:48},ne=6,S=X.x-R.x,O=R.y-X.y,$=S/ne,U=[.3,.45,.6,.65,1.4,2.2],ae=U.reduce((le,oe)=>le+oe,0),ke=U.map(le=>O*le/ae),je=[R];let Ke=R.x,Ne=R.y;for(let le=1;le<=ne;le+=1){const oe=(Math.random()-.5)*14,We=(Math.random()-.5)*28;Ke=Math.max(R.x+le*14,Math.min(X.x-(ne-le)*14,Ke+$+oe));const Ue=ke[le-1]??ke[ke.length-1];Ne=Ne-Ue+We;const at=Math.max(X.y,Math.min(R.y-4,Ne));je.push({x:Math.round(Ke),y:Math.round(at)})}return je[je.length-1]=X,je},[]),ie=a.useMemo(()=>{const O=(ae,ke,je)=>Math.min(je,Math.max(ke,ae)),$=d.map(ae=>{const ke=10+Math.random()*36;return{x:O(ae.x,40,260),y:O(ae.y-ke,40,140)}}),U=d.map((ae,ke)=>{var Ne;const je=12+Math.random()*40,Ke=((Ne=$[ke])==null?void 0:Ne.y)??ae.y;return{x:O(ae.x,40,260),y:O(Math.max(Ke+10,ae.y+je),60,170)}});return{upper:$,lower:U}},[d]),K=a.useMemo(()=>{var X;const R=((X=d[4])==null?void 0:X.x)??260;return Math.max(0,Math.min(240,R-40))},[d]),y=a.useMemo(()=>{var ke,je;const R=(Ke,Ne,le)=>Math.min(le,Math.max(Ne,Ke)),X=(Ke,Ne,le)=>d.map((oe,We)=>{var Nt,St;const Ue=((Nt=ie.upper[We])==null?void 0:Nt.y)??oe.y,at=((St=ie.lower[We])==null?void 0:St.y)??oe.y,rt=(Math.random()-.5)*70,vt=oe.y+Ke+rt,Ye=R(oe.y+Ne,Ue+6,at-6),Ze=R(oe.y+le,Ue+6,at-6);return{x:oe.x,y:R(vt,Math.min(Ye,Ze),Math.max(Ye,Ze))}}),ne=-14+Math.random()*28,S=14+Math.random()*28,O=X(ne,-80,12),$=X(S,-12,80);for(let Ke=4;Ke<d.length;Ke+=1){const Ne=d[Ke],le=((ke=ie.upper[Ke])==null?void 0:ke.y)??Ne.y,oe=((je=ie.lower[Ke])==null?void 0:je.y)??Ne.y;O[Ke]={x:Ne.x,y:R(Ne.y-12,le+6,oe-6)},$[Ke]={x:Ne.x,y:R(Ne.y+12,le+6,oe-6)}}const U=ie.upper.length?ie.upper[ie.upper.length-1].y:40,ae=ie.lower.length?ie.lower[ie.lower.length-1].y:170;return O[O.length-1]={x:d[d.length-1].x,y:R(d[d.length-1].y-14,U,ae)},$[$.length-1]={x:d[d.length-1].x,y:R(d[d.length-1].y+12,U,ae)},{higher:O,lower:$}},[d,ie]),V=1e4,N=a.useMemo(()=>{let R=17;const X=()=>(R=(R*1664525+1013904223)%4294967296,R/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((S,O)=>{const $=(X()-.5)*240,U=(X()-.5)*180,ae=(X()-.5)*24;return{id:`card-${O+1}`,throw:{x:`${$.toFixed(0)}px`,y:`${U.toFixed(0)}px`,rot:`${ae.toFixed(1)}deg`},grid:{x:`${S.x}px`,y:`${S.y}px`},delay:`${O*.12}s`}})},[]),Y=a.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[z,I]=a.useState([]),ue=a.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),re=a.useMemo(()=>{const X=[],S=($,U)=>$+Math.random()*(U-$);for(let $=0;$<6;$+=1){let U=!1;for(let ae=0;ae<80;ae+=1){const ke=S(14,86),je=S(10,34);if(X.every(Ne=>{const le=Ne.x-ke,oe=Ne.y-je;return Math.hypot(le,oe)>=12})){X.push({x:ke,y:je}),U=!0;break}}U||X.push({x:S(16,84),y:S(12,32)})}return X.map(($,U)=>({id:`p${U+1}`,x:`${$.x.toFixed(1)}%`,y:`${$.y.toFixed(1)}%`,xNum:$.x,yNum:$.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[fe,Ce]=a.useState(0),[be,M]=a.useState(0),[Me,J]=a.useState([]),ee=1e4,$e=a.useMemo(()=>{if(re.length<2)return[];const R=U=>{let ae=U+1831565813;return ae=Math.imul(ae^ae>>>15,ae|1),ae^=ae+Math.imul(ae^ae>>>7,ae|61),((ae^ae>>>14)>>>0)/4294967296},X=(U,ae)=>Math.floor(R(U)*ae),ne=new Set,S=[],O=Math.min(3,re.length);let $=0;for(;S.length<O&&$<30;){$+=1;const U=X(fe*13+$*5,re.length),ae=X(fe*29+$*7,re.length);if(U===ae)continue;const ke=U<ae?`${U}-${ae}`:`${ae}-${U}`;ne.has(ke)||(ne.add(ke),S.push({id:`link-${ke}`,from:re[U],to:re[ae],delay:`${($*.35).toFixed(2)}s`}))}return S},[fe,re]);a.useEffect(()=>{if(!s||n!==2)return;const R=()=>{const ne=N.map(S=>S.id);for(let S=ne.length-1;S>0;S-=1){const O=Math.floor(Math.random()*(S+1));[ne[S],ne[O]]=[ne[O],ne[S]]}return ne.slice(0,4)};I(R());const X=window.setInterval(()=>{I(R())},V);return()=>window.clearInterval(X)},[n,s,N,V]),a.useEffect(()=>{if(!s||n!==3)return;const R=()=>{M(Math.floor(Math.random()*ue.length)),J(re.map(()=>Math.random()<.6?"good":"bad")),Ce(ne=>ne+1)};R();const X=window.setInterval(R,ee);return()=>window.clearInterval(X)},[n,s,ue.length,re,ee]);const Te=a.useMemo(()=>Sr(11),[]),[G,ve]=a.useState(new Set(["root"])),[we,Ve]=a.useState(new Set),[Je,Ie]=a.useState(new Set),[qe,Xe]=a.useState({fromId:"root",toId:"root",key:0}),Ae=a.useRef(G),Ge=a.useRef("root"),tt=a.useRef(0),st=a.useRef(null),_e=a.useRef(null),ye=a.useRef([]);a.useEffect(()=>{Ae.current=G},[G]);const q=a.useMemo(()=>{const R=new Set;return G.forEach(X=>{const ne=Te.linksByFrom.get(X);ne&&ne.forEach(S=>R.add(S))}),R},[G,Te]),Ee=Te.nodesById.get(qe.toId)??Te.nodesById.get("root"),se=Ee?`${Ee.x/La.width*100}%`:"50%",B=Ee?`${Ee.y/La.height*100}%`:"90%";a.useEffect(()=>{if(!s||n!==1||r)return;(()=>{ve(new Set(["root"])),Ve(new Set),Ie(new Set),Xe({fromId:"root",toId:"root",key:0}),_e.current=null,tt.current=0,Ge.current="root",ye.current=[]})();const X=()=>{const S=Ge.current,O=Ae.current,U=(Te.childrenByFrom.get(S)??[]).filter(oe=>!O.has(oe));if(U.length)return U[Math.floor(Math.random()*U.length)];if(O.size>=Te.nodes.length){const oe=Te.neighborsById.get(S)??[];return oe.length?oe[Math.floor(Math.random()*oe.length)]:null}const ae=oe=>(Te.childrenByFrom.get(oe)??[]).some(Ue=>!O.has(Ue)),ke=[S],je=new Set([S]),Ke=new Map;let Ne=null;for(;ke.length;){const oe=ke.shift();if(!oe)break;if(oe!==S&&ae(oe)){Ne=oe;break}(Te.neighborsById.get(oe)??[]).forEach(Ue=>{je.has(Ue)||(je.add(Ue),Ke.set(Ue,oe),ke.push(Ue))})}if(!Ne)return null;let le=Ne;for(;Ke.get(le)&&Ke.get(le)!==S;)le=Ke.get(le)??le;return le},ne=(S,O)=>{if(S===O){const $=X();$&&ne(S,$);return}tt.current+=1,Xe({fromId:S,toId:O,key:tt.current}),Ge.current=O,st.current=window.setTimeout(()=>{const $=Te.parentsById.get(O)??[],U=Ae.current,ae=$.filter(Ne=>!U.has(Ne));if(!ae.length){const Ne=new Set(U);Ne.add(O),ve(Ne),st.current=window.setTimeout(()=>{for(;ye.current.length;){const oe=ye.current[ye.current.length-1];if(!Ne.has(oe)){if(oe!==O){ne(O,oe);return}break}ye.current.pop()}const le=X();le&&ne(O,le)},Ia.pauseMs);return}const ke=new Set([O,...ae]),je=new Set(ae.map(Ne=>`${Ne}-${O}`));Ve(ke),Ie(je),ye.current.includes(O)||ye.current.push(O);const Ke=ae[Math.floor(Math.random()*ae.length)];_e.current={fromId:O,toId:Ke},st.current=window.setTimeout(()=>{Ve(new Set),Ie(new Set);const Ne=_e.current;Ne&&ne(Ne.fromId,Ne.toId)},Ia.errorMs)},Ia.moveMs)};return st.current=window.setTimeout(()=>{const S=X();S&&ne(Ge.current,S)},Ia.pauseMs),()=>{st.current&&window.clearTimeout(st.current)}},[n,s,Te,r]);const he=R=>{if(!s)return;const X=Date.now();X-F.current<520||Math.abs(R.deltaY)<10||(F.current=X,R.deltaY>0?i():m(),R.preventDefault())},He=R=>{if(!s)return;const X=R.touches[0];X&&(g.current={x:X.clientX,y:X.clientY})},E=R=>{if(!s)return;const X=g.current;if(g.current=null,!X)return;const ne=R.changedTouches[0];if(!ne)return;const S=ne.clientX-X.x,O=ne.clientY-X.y;Math.abs(O)<40||Math.abs(O)<Math.abs(S)||(O<0?i():m())};return e.jsxs("div",{className:`cogita-intro ${s?"is-open":"is-closed"} ${r?"is-reduced":""} ${c?"is-final":""}`,"data-slide":n+1,onWheel:he,onTouchStart:He,onTouchEnd:E,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":x,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${C&&!u?"is-entry":""}`,children:w.map((R,X)=>e.jsx("img",{src:R.src,alt:"",className:`cogita-logo-layer ${X===0?"is-base":""} ${R.kind==="text"?"is-text":R.kind==="recreatio"?"is-recreatio":""} ${R.kind==="bubble"?"is-bubble":""}`},R.src))})}),s&&t.map((R,X)=>{const ne=X===n;return e.jsxs("section",{className:`cogita-intro-slide slide-${X+1} ${ne?"is-active":""}`,"aria-hidden":!ne,children:[e.jsxs("div",{className:"cogita-intro-text",children:[R.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:R.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:R.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:R.title}),R.body&&e.jsx("p",{children:R.body.split(`
`).map((S,O)=>e.jsxs("span",{children:[S,O===0&&e.jsx("br",{})]},String(O)))})]}),R.micro&&e.jsx("p",{className:"cogita-intro-micro",children:R.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:c?k:i,children:R.cta}),c&&R.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>h(0),children:R.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[X===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${La.width} ${La.height}`,preserveAspectRatio:"none",children:[Te.links.map(S=>{const O=Te.nodesById.get(S.from),$=Te.nodesById.get(S.to);if(!O||!$)return null;const U=q.has(S.key),ae=Je.has(S.key);return e.jsx("line",{className:`map-link ${U?"is-active":""} ${ae?"is-error":""}`,x1:O.x,y1:O.y,x2:$.x,y2:$.y},S.key)}),Te.nodes.map(S=>{const O=G.has(S.id),$=we.has(S.id);return e.jsx("circle",{className:`map-node ${S.role?`is-${S.role}`:""} ${O?"is-active":""} ${$?"is-error":""}`,cx:S.x,cy:S.y,r:S.r},S.id)})]}),Ee&&e.jsx("span",{className:"map-explorer-dot",style:{left:se,top:B,"--move":`${Ia.moveMs}ms`}})]}),X===2&&e.jsx("div",{className:"cogita-index-cards",children:N.map(S=>{const O=z.indexOf(S.id),$=O>=0?Y[O]:null,U=($==null?void 0:$.x)??"140px",ae=($==null?void 0:$.y)??"140px",ke=O>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":S.throw.x,"--throw-y":S.throw.y,"--throw-rot":S.throw.rot,"--grid-x":S.grid.x,"--grid-y":S.grid.y,"--stack-x":U,"--stack-y":ae,"--stack-opacity":ke,"--delay":S.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},S.id)})}),X===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[ue.map((S,O)=>e.jsxs("div",{className:`round-card ${O===be?"is-active":""}`,style:{"--card-x":S.x,"--card-y":S.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},S.id)),ue[be]&&e.jsx("span",{className:"round-ring",style:{"--card-x":ue[be].x,"--card-y":`calc(${ue[be].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:re.map(S=>e.jsx("span",{className:"player-dot",style:{left:S.x,top:S.y,"--jitter-x":S.jitterX,"--jitter-y":S.jitterY,"--breath-delay":S.delay}},S.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:$e.map(S=>e.jsx("line",{className:"round-link",x1:S.from.xNum,y1:S.from.yNum,x2:S.to.xNum,y2:S.to.yNum,style:{"--delay":S.delay}},S.id))}),e.jsx("div",{className:"round-flows",children:re.map((S,O)=>{const $=Me[O]??"good",U=ue[be];if(!U)return null;const ae=`calc(${U.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":S.x,"--from-y":S.y,"--to-x":U.x,"--to-y":ae,"--delay":`${O*.12}s`}}),e.jsx("span",{className:`return-dot is-${$}`,style:{"--from-x":U.x,"--from-y":ae,"--to-x":S.x,"--to-y":S.y,"--delay":`${O*.12}s`}}),e.jsx("span",{className:`result-pop is-${$}`,style:{"--at-x":S.x,"--at-y":S.y,"--delay":`${O*.12}s`}})]},`${S.id}-${fe}`)})})]},`round-${fe}`),X===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${d[0].x} ${d[0].y} L${d[1].x} ${d[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${d[1].x} ${d[1].y} L${d[2].x} ${d[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${d[2].x} ${d[2].y} L${d[3].x} ${d[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${d[3].x} ${d[3].y} L${d[4].x} ${d[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${d[4].x} ${d[4].y} L${d[5].x} ${d[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${d[5].x} ${d[5].y} L${d[6].x} ${d[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${K};${K};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${ie.upper.map((S,O)=>`${O===0?"M":"L"}${S.x} ${S.y}`).join(" ")} ${ie.lower.slice().reverse().map(S=>`L${S.x} ${S.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${ie.upper.map((S,O)=>`${O===0?"M":"L"}${S.x} ${S.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${ie.lower.map((S,O)=>`${O===0?"M":"L"}${S.x} ${S.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[y.higher.slice(0,6).map((S,O)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${O+1}`,d:`M${S.x} ${S.y} L${y.higher[O+1].x} ${y.higher[O+1].y}`,pathLength:"100"},`peer-1-${O}`)),y.lower.slice(0,6).map((S,O)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${O+1}`,d:`M${S.x} ${S.y} L${y.lower[O+1].x} ${y.lower[O+1].y}`,pathLength:"100"},`peer-2-${O}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${d[0].x/300*100}%`,"--p0y":`${d[0].y/200*100}%`,"--p1x":`${d[1].x/300*100}%`,"--p1y":`${d[1].y/200*100}%`,"--p2x":`${d[2].x/300*100}%`,"--p2y":`${d[2].y/200*100}%`,"--p3x":`${d[3].x/300*100}%`,"--p3y":`${d[3].y/200*100}%`,"--p4x":`${d[4].x/300*100}%`,"--p4y":`${d[4].y/200*100}%`,"--p5x":`${d[5].x/300*100}%`,"--p5y":`${d[5].y/200*100}%`,"--p6x":`${d[6].x/300*100}%`,"--p6y":`${d[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${y.higher[0].x/300*100}%`,"--q0y":`${y.higher[0].y/200*100}%`,"--q1x":`${y.higher[1].x/300*100}%`,"--q1y":`${y.higher[1].y/200*100}%`,"--q2x":`${y.higher[2].x/300*100}%`,"--q2y":`${y.higher[2].y/200*100}%`,"--q3x":`${y.higher[3].x/300*100}%`,"--q3y":`${y.higher[3].y/200*100}%`,"--q4x":`${y.higher[4].x/300*100}%`,"--q4y":`${y.higher[4].y/200*100}%`,"--q5x":`${y.higher[5].x/300*100}%`,"--q5y":`${y.higher[5].y/200*100}%`,"--q6x":`${y.higher[6].x/300*100}%`,"--q6y":`${y.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${y.lower[0].x/300*100}%`,"--q0y":`${y.lower[0].y/200*100}%`,"--q1x":`${y.lower[1].x/300*100}%`,"--q1y":`${y.lower[1].y/200*100}%`,"--q2x":`${y.lower[2].x/300*100}%`,"--q2y":`${y.lower[2].y/200*100}%`,"--q3x":`${y.lower[3].x/300*100}%`,"--q3y":`${y.lower[3].y/200*100}%`,"--q4x":`${y.lower[4].x/300*100}%`,"--q4y":`${y.lower[4].y/200*100}%`,"--q5x":`${y.lower[5].x/300*100}%`,"--q5y":`${y.lower[5].y/200*100}%`,"--q6x":`${y.lower[6].x/300*100}%`,"--q6y":`${y.lower[6].y/200*100}%`}})]})})}),X===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),X===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},R.id)}),!s&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:o.title}),o.body&&e.jsx("p",{children:o.body}),o.micro&&e.jsx("p",{className:"cogita-intro-micro",children:o.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:k,children:o.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:j,children:"Otwórz pokaz"})]})]})})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((R,X)=>e.jsx("button",{type:"button",className:`dot ${n===X?"active":""}`,"aria-label":R.title,onClick:()=>h(X)},R.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:b,children:"Pomiń"})]})]})}const Cr=6,Mr=4;function Ir({copy:t,onAuthAction:n,authLabel:s,showProfileMenu:r,onProfileNavigate:i,onToggleSecureMode:m,onLogout:h,secureMode:b,onNavigate:j,language:k,onLanguageChange:c}){const x=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}j("home")},o=a.useRef(null),u=a.useRef([]),v=a.useMemo(()=>{let J=Date.now()%2147483647;const ee=()=>(J=J*48271%2147483647,J/2147483647);return Array.from({length:Cr},($e,Te)=>{const G=6+ee()*8,ve=7+ee()*10,we=6+ee()*9,Ve=-ee()*G,Je=-ee()*ve,Ie=-ee()*we,qe=.18+ee()*.28,Xe=12+ee()*18,Ae=4+ee()*8,Ge=(ee()-.5)*3.2,tt=(ee()-.5)*3.8,st=ee()>.5?"alternate":"alternate-reverse",_e=ee()>.5?"alternate":"alternate-reverse",ye=ee()>.5?"alternate":"alternate-reverse",q=.18+ee()*.42,Ee=30+ee()*60,se=-45-ee()*38,B=188+ee()*32,he=.1+ee()*.2;return{id:`wave-${Te+1}`,style:{"--wave-sway-duration":`${G}s`,"--wave-scale-duration":`${ve}s`,"--wave-drift-duration":`${we}s`,"--wave-sway-delay":`${Ve}s`,"--wave-scale-delay":`${Je}s`,"--wave-drift-delay":`${Ie}s`,"--wave-sway-dir":st,"--wave-scale-dir":_e,"--wave-drift-dir":ye,"--wave-scale":`${qe}`,"--wave-shift":`${Xe}%`,"--wave-xshift":`${Ae}%`,"--wave-x0":`${Ge}%`,"--wave-y0":`${tt}%`,"--wave-opacity":`${q}`,"--wave-blur":`${Ee}px`,"--wave-bottom":`${se}%`,"--wave-hue":`${B}`,"--wave-glow":`${he}`}}})},[]),w=a.useMemo(()=>{let J=Date.now()*3%2147483647;const ee=()=>(J=J*48271%2147483647,J/2147483647);return Array.from({length:Mr},($e,Te)=>{const G=180+ee()*220,ve=220+ee()*280,we=-ee()*G,Ve=-ee()*ve,Je=.12+ee()*.22,Ie=3+ee()*7,qe=1+ee()*3,Xe=(ee()-.5)*2.8,Ae=(ee()-.5)*2.2;return{id:`mesh-${Te+1}`,seed:1e3+Te*991+Math.floor(ee()*999),style:{"--mesh-sway-duration":`${G}s`,"--mesh-drift-duration":`${ve}s`,"--mesh-sway-delay":`${we}s`,"--mesh-drift-delay":`${Ve}s`,"--mesh-scale":`${Je}`,"--mesh-shift":`${Ie}%`,"--mesh-xshift":`${qe}%`,"--mesh-x0":`${Ae}%`,"--mesh-y0":`${Xe}%`}}})},[]),C=a.useMemo(()=>{const J=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],ee=t.cogita.introSlides,$e=new Map(ee.map(Te=>[Te.id,Te]));return J.map(Te=>{var ve;const G=$e.get(Te.id);return{...Te,...G,title:(G==null?void 0:G.title)??"Cogita",cta:(G==null?void 0:G.cta)??((ve=t.cogita.introSlides[0])==null?void 0:ve.cta)??t.cogita.loginCta,secondary:G==null?void 0:G.secondary}})},[t.cogita.introSlides]),[F,g]=a.useState(0),[d,ie]=a.useState(!0),[K,y]=a.useState(!1),V=C.length-1,N=a.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),Y=a.useCallback(()=>{N(),n()},[N,n]),z=a.useCallback(()=>{ie(!0),g(0)},[]),I=a.useCallback(()=>{ie(!1),g(V)},[V]),ue=a.useCallback(J=>{g(Math.max(0,Math.min(V,J)))},[V]),re=a.useCallback(()=>{F>=V?Y():ue(F+1)},[F,ue,Y,V]),fe=a.useCallback(()=>{ue(F-1)},[F,ue]);a.useEffect(()=>{var $e;const J=($e=window.matchMedia)==null?void 0:$e.call(window,"(prefers-reduced-motion: reduce)");if(!J)return;const ee=()=>y(J.matches);return ee(),J.addEventListener?(J.addEventListener("change",ee),()=>J.removeEventListener("change",ee)):(J.addListener(ee),()=>J.removeListener(ee))},[]),a.useEffect(()=>{if(!d)return;const J=ee=>{const $e=ee.target;if(!$e)return;const Te=$e.tagName;if(!($e.isContentEditable||Te==="INPUT"||Te==="TEXTAREA"||Te==="SELECT"||Te==="BUTTON"||Te==="A"||$e.closest('button, a, [role="button"], [role="link"]'))){if(ee.key==="Escape"){I();return}if(ee.key==="ArrowLeft"||ee.key==="ArrowUp"){fe();return}(ee.key==="ArrowRight"||ee.key==="ArrowDown"||ee.code==="Space"||ee.key===" ")&&(ee.preventDefault(),re())}};return window.addEventListener("keydown",J),()=>window.removeEventListener("keydown",J)},[I,re,fe,d]),a.useEffect(()=>{d&&F===V&&N()},[F,d,V,N]),a.useEffect(()=>{const J=o.current;if(!J)return;const ee=u.current.filter(se=>!!se);if(!ee.length)return;const $e=1,Te=.6,G=.6,ve=Math.max(1,Math.min($e,window.devicePixelRatio||1));let we=0,Ve=0,Je=Te,Ie=0,qe=0;const Xe=se=>{let B=se%2147483647;return B<=0&&(B+=2147483646),(he,He)=>{B=B*48271%2147483647;const E=B/2147483647;return he+E*(He-he)}},Ae={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},Ge=se=>{const B=Math.sin(se*12.9898)*43758.5453;return B-Math.floor(B)},tt=se=>{const B=Ge(se+.1)||1e-4,he=Ge(se+.7)||1e-4;return Math.sqrt(-2*Math.log(B))*Math.cos(2*Math.PI*he)},st=(se,B)=>{const he=Math.floor(se),He=he+1,E=se-he,R=E*E*(3-2*E),X=Ge(he*12.9898+B*78.233),ne=Ge(He*12.9898+B*78.233);return X+(ne-X)*R},_e=se=>{const B=Xe(se),he=Math.min(4,Math.max(4,Math.floor(we/1200*Ae.filamentCount)));return Array.from({length:he},(He,E)=>{const R=Math.max(-1,Math.min(1,tt(se+E*.37))),X=Math.min(1,Math.max(0,Ge(se+E*1.31))),ne=Math.min(Ae.depthLayers-1,Math.floor(X*Ae.depthLayers));return{seed:B(0,Math.PI*2)+se*.01,offset:R,freqA:Ae.freq1*(.75+B(0,.5)),freqB:Ae.freq2*(.75+B(0,.5)),ampA:Ae.amp1*(.6+B(0,.7)),ampB:Ae.amp2*(.6+B(0,.7)),width:2+E%5*.32,depth:X,layer:ne}})},ye=(se,B,he)=>{const He=Math.max(30,Math.floor(we*Ve/14e4));se.save(),se.globalAlpha=.6;for(let E=0;E<He;E+=1){const R=Ge(E*9.1+we*.11)*B+he,X=Ge(E*3.7+Ve*.23)*Ve,ne=1.2+Ge(E*5.9)*2.4,S=se.createRadialGradient(R,X,0,R,X,ne*2);S.addColorStop(0,"rgba(10, 30, 60, 0.45)"),S.addColorStop(1,"rgba(10, 30, 60, 0)"),se.fillStyle=S,se.beginPath(),se.arc(R,X,ne*2,0,Math.PI*2),se.fill()}se.restore()},q=(se,B)=>{se.clearRect(0,0,we,Ve);const he=Ve*Ae.waveCenter,He=Ae.waveBandPx,E=Ae.segments,R=Ae.colors.filaments,X=Ie||we,ne=0;ye(se,X,ne),se.strokeStyle=R,se.lineCap="round",se.lineJoin="round";for(let S=0;S<B.length;S+=1){const O=B[S],$=O.offset*He*(.85+Ge(O.seed)*.4),U=1-Math.min(1,Math.abs($)/He),ae=Math.exp(-Math.pow($/Ae.crestThickness,2)),ke=O.layer===0?1.1:O.layer===1?.85:.6,je=.35+(1-O.depth)*.65,Ke=U*je*ke*(.34+ae*.45);se.globalAlpha=Ke,se.lineWidth=O.width*(1+(1-O.depth)*.8);const Ne=[];for(let oe=0;oe<=E;oe+=1){const We=oe/E*X+ne,Ue=(st(We*.012,O.seed)-.5)*Ae.xJitter,at=We+Ue,rt=(st(at*O.freqA,O.seed)-.5)*Ae.jitterA,vt=(st(at*O.freqB,O.seed*1.7)-.5)*Ae.jitterB,Ye=he+Math.sin(at*O.freqA+O.seed)*O.ampA+Math.sin(at*O.freqB+O.seed*1.3)*O.ampB+$+rt+vt;Ne.push({x:at,y:Ye})}se.beginPath(),se.moveTo(Ne[0].x,Ne[0].y);for(let oe=1;oe<Ne.length-1;oe+=1){const We=(Ne[oe].x+Ne[oe+1].x)/2,Ue=(Ne[oe].y+Ne[oe+1].y)/2;se.quadraticCurveTo(Ne[oe].x,Ne[oe].y,We,Ue)}const le=Ne[Ne.length-1];se.quadraticCurveTo(le.x,le.y,le.x,le.y),se.stroke()}se.save(),se.globalCompositeOperation="lighter",se.strokeStyle=Ae.colors.glow,se.lineCap="round",se.lineJoin="round";for(let S=0;S<B.length;S+=1){const O=B[S];if(Math.abs(O.offset)*He>Ae.crestThickness)continue;const $=Ae.glowAlpha*(.7+(1-O.depth)*.6);se.globalAlpha=$,se.lineWidth=1.6+(1-O.depth)*1.2;const U=[];for(let ke=0;ke<=E;ke+=1){const je=ke/E*X+ne,Ke=Math.sin(je*.02+O.seed)*3,Ne=he+Math.sin(je*O.freqA+O.seed)*O.ampA+Math.sin(je*O.freqB+O.seed*1.3)*O.ampB+O.offset*He*.35+Ke;U.push({x:je,y:Ne})}se.beginPath(),se.moveTo(U[0].x,U[0].y);for(let ke=1;ke<U.length-1;ke+=1){const je=(U[ke].x+U[ke+1].x)/2,Ke=(U[ke].y+U[ke+1].y)/2;se.quadraticCurveTo(U[ke].x,U[ke].y,je,Ke)}const ae=U[U.length-1];se.quadraticCurveTo(ae.x,ae.y,ae.x,ae.y),se.stroke()}se.restore()},Ee=()=>{we=Math.floor(J.clientWidth),Ve=Math.floor(J.clientHeight),Ie=Math.floor(we*1.8),qe=Ve,Je=we<820?G:Te,ee.forEach(se=>{const B=se.getContext("2d");if(!B)return;se.width=Math.floor(Ie*ve*Je),se.height=Math.floor(qe*ve*Je),se.style.width=`${Ie}px`,se.style.height=`${qe}px`,se.style.left=`${-(Ie-we)/2}px`,B.setTransform(ve*Je,0,0,ve*Je,0,0);const he=Number(se.dataset.seed||1),He=_e(he);q(B,He)})};return Ee(),window.addEventListener("resize",Ee,{passive:!0}),()=>window.removeEventListener("resize",Ee)},[w]);const Ce=C[Math.min(F,C.length-1)],be=d?Ce:C[C.length-1],M=(be==null?void 0:be.theme)??C[0].theme,Me={"--cogita-bg0":M.bg0,"--cogita-bg1":M.bg1,"--cogita-bg2":M.bg2,"--cogita-bloom":M.bloom,"--cogita-sat":M.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:x,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Ns,{value:k,onChange:c}),e.jsx(Ss,{copy:t,label:s,isAuthenticated:r,secureMode:b,onLogin:n,onProfileNavigate:i,onToggleSecureMode:m,onLogout:h,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:o,className:"cogita-section cogita-home",style:Me,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[w.map((J,ee)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:J.style,"data-seed":J.seed,ref:$e=>{u.current[ee]=$e}},J.id)),v.map(J=>e.jsx("div",{className:"cogita-home-wave",style:J.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},J.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(Tr,{slides:C,activeIndex:F,introOpen:d,prefersReducedMotion:K,onNext:re,onPrev:fe,onSelect:ue,onExit:I,onOpen:z,onRegister:Y})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const Bi=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:Ir},Symbol.toStringTag,{value:"Module"})),Es=a.createContext(!1);function Ft({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,headerExtra:c,children:x}){if(a.useContext(Es))return e.jsx(e.Fragment,{children:x});const u=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}b("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:u,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Ns,{value:j,onChange:k}),e.jsxs("div",{className:"cogita-header-right",children:[c,e.jsx(Ss,{copy:t,label:n,isAuthenticated:s,secureMode:h,onLogin:()=>b("home"),onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:x}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function ra(t){const[n,s]=a.useState("Cogita library"),[r,i]=a.useState(null);return a.useEffect(()=>{let m=!1;return Ts().then(h=>{if(m)return;const b=h.find(j=>j.libraryId===t);b&&s(b.name)}).catch(()=>{m||s("Cogita library")}),()=>{m=!0}},[t]),a.useEffect(()=>{let m=!1;return Hs(t).then(h=>{m||i(h)}).catch(()=>{m||i(null)}),()=>{m=!0}},[t]),{libraryName:n,stats:r}}function Gn({slices:t}){const n=t.reduce((r,i)=>r+Math.max(0,i.value),0),s=a.useMemo(()=>{if(n<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let r=0;return`conic-gradient(${t.map(m=>{const b=Math.max(0,m.value)/n*360,j=r,k=r+b;return r=k,`${m.color} ${j}deg ${k}deg`}).join(",")})`},[t,n]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:s}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(r=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:r.color}}),e.jsx("strong",{children:r.value}),e.jsx("small",{children:r.label})]},r.label))})]})}function Lr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,libraryId:c}){const{libraryName:x,stats:o}=ra(c),[u,v]=a.useState("infos"),[w,C]=a.useState(0),[F,g]=a.useState(0),[d,ie]=a.useState(0),K=(o==null?void 0:o.totalInfos)??0,y=(o==null?void 0:o.totalCollections)??0,V=0,N=0,Y=0,z=Math.max(0,K-Y-F),I=Math.max(0,K-F-d);a.useEffect(()=>{let re=!1;return(async()=>{try{const Ce=await Aa({libraryId:c,limit:200}),be=await Promise.all(Ce.items.map(M=>Cs({libraryId:c,collectionId:M.collectionId}).catch(()=>[])));if(re)return;C(be.reduce((M,Me)=>M+Me.length,0))}catch{re||C(0)}})(),()=>{re=!0}},[c]),a.useEffect(()=>{let re=!1;return(async()=>{try{const[Ce,be,M]=await Promise.all([qn({libraryId:c,type:"computed",limit:1}).catch(()=>({total:0})),qn({libraryId:c,type:"source",limit:1}).catch(()=>({total:0})),An({libraryId:c}).catch(()=>({items:[]}))]);if(re)return;g((Ce.total??0)+(be.total??0));const Me=new Set(M.items.filter(J=>J.childItemType.toLowerCase()==="info").map(J=>J.childItemId).filter(Boolean));ie(Me.size)}catch{re||(g(0),ie(0))}})(),()=>{re=!0}},[c]);const ue=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:K},{key:"collections",label:t.cogita.library.overview.stats.collections,value:y},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:w},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:V},{key:"texts",label:t.cogita.library.overview.stats.texts,value:N}];return e.jsx(Ft,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:x})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:ue.map(re=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${u===re.key?"active":""}`,onClick:()=>v(re.key),children:[e.jsx("span",{children:re.label}),e.jsx("strong",{children:re.value})]},re.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),u==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(Gn,{slices:[{label:t.cogita.library.overview.known,value:Y,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:z,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:F,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(Gn,{slices:[{label:t.cogita.library.overview.availableChecks,value:d,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:I,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const Qe=(t,n)=>{const s=t.cogita.library.infoTypes,r=t.cogita.library.connectionTypes,i=t.cogita.library.groupTypes;return{any:s.any,vocab:s.vocab,book:i.book,citation:i.citation,language:s.language,word:s.word,sentence:s.sentence,topic:s.topic,collection:s.collection,person:s.person,institution:s.institution,collective:s.collective,orcid:s.orcid,address:s.address,email:s.email,phone:s.phone,media:s.media,work:s.work,geo:s.geo,music_piece:s.musicPiece,music_fragment:s.musicFragment,source:s.source,computed:s.computed,"word-language":r.wordLanguage,"citation-language":r.citationLanguage,"language-sentence":r.languageSentence,translation:r.translation,"word-topic":r.wordTopic,reference:r.reference,"source-resource":r.sourceResource,"work-contributor":r.workContributor,"work-medium":r.workMedium,"orcid-link":r.orcidLink}[n]??String(n)},Rr=t=>[{value:"any",label:Qe(t,"any")},{value:"language",label:Qe(t,"language")},{value:"word",label:Qe(t,"word")},{value:"sentence",label:Qe(t,"sentence")},{value:"topic",label:Qe(t,"topic")},{value:"collection",label:Qe(t,"collection")},{value:"person",label:Qe(t,"person")},{value:"institution",label:Qe(t,"institution")},{value:"collective",label:Qe(t,"collective")},{value:"orcid",label:Qe(t,"orcid")},{value:"address",label:Qe(t,"address")},{value:"email",label:Qe(t,"email")},{value:"phone",label:Qe(t,"phone")},{value:"media",label:Qe(t,"media")},{value:"work",label:Qe(t,"work")},{value:"geo",label:Qe(t,"geo")},{value:"music_piece",label:Qe(t,"music_piece")},{value:"music_fragment",label:Qe(t,"music_fragment")},{value:"source",label:Qe(t,"source")},{value:"citation",label:Qe(t,"citation")},{value:"computed",label:Qe(t,"computed")},{value:"vocab",label:Qe(t,"vocab")},{value:"book",label:Qe(t,"book")},{value:"word-language",label:Qe(t,"word-language")},{value:"citation-language",label:Qe(t,"citation-language")},{value:"language-sentence",label:Qe(t,"language-sentence")},{value:"translation",label:Qe(t,"translation")},{value:"word-topic",label:Qe(t,"word-topic")},{value:"reference",label:Qe(t,"reference")},{value:"source-resource",label:Qe(t,"source-resource")},{value:"work-contributor",label:Qe(t,"work-contributor")},{value:"work-medium",label:Qe(t,"work-medium")},{value:"orcid-link",label:Qe(t,"orcid-link")}],$r=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],mn={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},Ar={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[mn]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[mn]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId"]},filterFields:[mn,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text"],connections:[{relationType:"citation-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"citationText",kind:"text",path:"text",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},Yn={infoType:"default",entityKind:"single",structure:{payloadFields:["label"]},filterFields:[]};function Er(t){return t?Ar[t]??Yn:Yn}function Pr(t,n){return t.optionsSource==="languages"?n.languages.map(s=>({value:s.infoId,label:s.label})):t.optionsSource==="sourceKinds"?$r:[]}const Kr="cogita.revision.seed:";function Ps(t){return`${Kr}${t}`}function Fr(t,n){if(typeof window>"u")return null;const s=Array.from(new Set(n.map(m=>m.trim()).filter(Boolean)));if(!s.length)return null;const r=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,i={kind:"info-selection",libraryId:t,infoIds:s,createdAt:new Date().toISOString()};return window.localStorage.setItem(Ps(r),JSON.stringify(i)),r}function Qn(t,n){if(typeof window>"u")return null;const s=window.localStorage.getItem(Ps(n));if(!s)return null;try{const r=JSON.parse(s);if(r.kind!=="info-selection"||r.libraryId!==t||!Array.isArray(r.infoIds))return null;const i=r.infoIds.map(m=>String(m??"").trim()).filter(Boolean);return i.length?{infoIds:i}:null}catch{return null}}const gn=60,Dr=500;function Ks(t){return`cogita.info-selection:${t}`}function Xn(t){if(typeof window>"u")return{};const n=window.localStorage.getItem(Ks(t));if(!n)return{};try{const s=JSON.parse(n);return!s||typeof s!="object"?{}:s}catch{return{}}}function zr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,libraryId:c,mode:x}){var xt;const o=In(),u=an(),v=t.cogita.library.list,[w,C]=a.useState("any"),[F,g]=a.useState(""),[d,ie]=a.useState("relevance"),[K,y]=a.useState("details"),[V,N]=a.useState(!1),[Y,z]=a.useState("idle"),[I,ue]=a.useState([]),[re,fe]=a.useState(gn),[Ce,be]=a.useState(null),[M,Me]=a.useState(()=>Xn(c)),[J,ee]=a.useState({}),[$e,Te]=a.useState([]),[G,ve]=a.useState(null),[we,Ve]=a.useState(null),[Je,Ie]=a.useState(null),[qe,Xe]=a.useState("idle"),[Ae,Ge]=a.useState([]),[tt,st]=a.useState(""),[_e,ye]=a.useState(null),[q,Ee]=a.useState("idle"),[se,B]=a.useState(null),[he,He]=a.useState(null),[E,R]=a.useState("idle"),X=a.useMemo(()=>Rr(t),[t]),ne=a.useMemo(()=>[{value:"relevance",label:v.sortRelevance},{value:"label_asc",label:v.sortLabelAsc},{value:"label_desc",label:v.sortLabelDesc},{value:"type_asc",label:v.sortTypeAsc},{value:"type_desc",label:v.sortTypeDesc}],[v.sortLabelAsc,v.sortLabelDesc,v.sortRelevance,v.sortTypeAsc,v.sortTypeDesc]);a.useEffect(()=>{Me(Xn(c)),ee({}),N(!1)},[c]),a.useEffect(()=>{An({libraryId:c}).then(T=>Ie(T)).catch(()=>Ie({items:[]}))},[c]),a.useEffect(()=>{Ws({libraryId:c}).then(T=>Ge(T)).catch(()=>Ge([]))},[c]),a.useEffect(()=>{Un({libraryId:c,type:"language",filters:{sourceKind:"info"},limit:200}).then(T=>{const ge=T.map(ze=>({infoId:ze.infoId??"",infoType:ze.entityType,label:ze.title})).filter(ze=>ze.infoId.length>0);Te(ge)}).catch(()=>Te([]))},[c]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(Ks(c),JSON.stringify(M))},[c,M]);const S=a.useMemo(()=>Er(w==="any"?null:w),[w]),O=a.useMemo(()=>new URLSearchParams(u.search),[u.search]),$=a.useMemo(()=>u.pathname.split("/").filter(Boolean),[u.pathname]),U=$.findIndex(T=>T==="infos"),ae=U>=0&&($[U+1]??"").trim()||null,ke=U>=0?($[U+2]??"").trim()==="checkcards"?"cards":"overview":"",je=ae??((O.get("infoId")??"").trim()||null),Ke=ae?ke:(O.get("infoView")??"overview").trim(),Ne=Ke==="overview"&&!!je,le=a.useMemo(()=>({language:v.typeFilterLanguage,languageA:v.typeFilterLanguageA,languageB:v.typeFilterLanguageB,originalLanguage:v.typeFilterOriginalLanguage,doi:v.typeFilterDoi,sourceKind:v.typeFilterSourceKind,locator:v.typeFilterLocator,citationText:v.typeFilterCitationText}),[v.typeFilterDoi,v.typeFilterLanguage,v.typeFilterLanguageA,v.typeFilterLanguageB,v.typeFilterLocator,v.typeFilterOriginalLanguage,v.typeFilterCitationText,v.typeFilterSourceKind]),oe=a.useMemo(()=>S.filterFields.map(T=>({...T,label:T.labelKey?le[T.labelKey]:T.label??T.key,options:Pr(T,{languages:$e})})),[le,$e,S.filterFields]),We=a.useMemo(()=>oe.some(T=>(J[T.key]??"").trim().length>0),[oe,J]);a.useEffect(()=>{ee({})},[w]),a.useEffect(()=>{const T={sourceKind:"info"};if(We)for(const ze of oe){const ut=(J[ze.key]??"").trim();ut&&(T[ze.path??ze.key]=ut)}z("loading");const ge=window.setTimeout(()=>{Un({libraryId:c,type:w==="any"?void 0:w,query:F.trim()||void 0,filters:T,limit:Dr}).then(ze=>{const ut=ze.map($t=>({infoId:$t.infoId??"",infoType:$t.entityType,label:$t.title})).filter($t=>$t.infoId.length>0);ue(ut),z("ready")}).catch(()=>{ue([]),z("ready")})},240);return()=>window.clearTimeout(ge)},[We,c,F,w,oe,J]),a.useEffect(()=>{if(!je||Ke!=="overview"){ve(null),Ve(null),Xe("idle");return}let T=!1;return Xe("loading"),Promise.all([ta({libraryId:c,infoId:je}),Gs({libraryId:c,itemType:"info",itemId:je}).catch(()=>null)]).then(([ge,ze])=>{T||(ve(ge),Ve(ze),Xe("ready"))}).catch(()=>{T||(ve(null),Ve(null),Xe("error"))}),()=>{T=!0}},[c,je,Ke]),a.useEffect(()=>{if(!je||Ke!=="overview"){B(null),He(null),R("idle");return}let T=!1;return R("loading"),Promise.all([Oa({libraryId:c,infoId:je}),qa({libraryId:c,infoId:je})]).then(([ge,ze])=>{T||(B(ge),He(ze),R("ready"))}).catch(()=>{T||(B(null),He(null),R("error"))}),()=>{T=!0}},[c,je,Ke]);const Ue=a.useMemo(()=>G?Ae.filter(T=>T.sourceInfoTypes.some(ge=>ge.toLowerCase()===G.infoType.toLowerCase())):[],[Ae,G]);a.useEffect(()=>{if(!G){st("");return}st(T=>{var ge;return T&&Ue.some(ze=>ze.approachKey===T)?T:((ge=Ue[0])==null?void 0:ge.approachKey)??""})},[Ue,G]),a.useEffect(()=>{if(!G||!tt){ye(null),Ee("idle");return}let T=!1;return Ee("loading"),Ms({libraryId:c,infoId:G.infoId,approachKey:tt}).then(ge=>{T||(ye(ge),Ee("ready"))}).catch(()=>{T||(ye(null),Ee("error"))}),()=>{T=!0}},[c,tt,G]);const at=a.useMemo(()=>{const T=I.slice(),ge=ze=>Qe(t,ze);return d==="relevance"?T:d==="label_asc"?T.sort((ze,ut)=>ze.label.localeCompare(ut.label)):d==="label_desc"?T.sort((ze,ut)=>ut.label.localeCompare(ze.label)):d==="type_asc"?T.sort((ze,ut)=>ze.infoType===ut.infoType?ze.label.localeCompare(ut.label):ge(ze.infoType).localeCompare(ge(ut.infoType))):T.sort((ze,ut)=>ze.infoType===ut.infoType?ze.label.localeCompare(ut.label):ge(ut.infoType).localeCompare(ge(ze.infoType)))},[t,I,d]),rt=a.useMemo(()=>at.slice(0,re),[at,re]),vt=rt.length<at.length,Ye=a.useMemo(()=>new Set(Object.keys(M)),[M]),Ze=a.useMemo(()=>Object.values(M),[M]),Nt=a.useMemo(()=>{const T=new Map;for(const ge of Ze)T.set(ge.infoType,(T.get(ge.infoType)??0)+1);return Array.from(T.entries()).sort((ge,ze)=>ze[1]-ge[1]||ge[0].localeCompare(ze[0]))},[Ze]),St=a.useMemo(()=>{if(!je||!Je)return 0;const T=new Set;for(const ge of Je.items)ge.childItemType!=="info"||ge.childItemId!==je||T.add([ge.parentItemType,ge.parentItemId,ge.parentCheckType??"",ge.parentDirection??""].join("|"));return T.size},[Je,je]);a.useEffect(()=>{fe(gn);const T=new Set(I.map(ge=>ge.infoId));be(ge=>ge&&T.has(ge)?ge:null)},[I]);const Tt=T=>{Me(ge=>({...ge,[T.infoId]:{infoId:T.infoId,infoType:T.infoType,label:T.label}}))},Lt=T=>{Me(ge=>{if(!ge[T])return ge;const ze={...ge};return delete ze[T],ze})},Et=(T,ge)=>{if(ge){Tt(T);return}Lt(T.infoId)},Ut=T=>{o(`/cogita/library/${c}/infos/${encodeURIComponent(T)}`,{replace:!0})},bt=()=>{o(`/cogita/library/${c}/list`,{replace:!0})},ia=()=>{je&&o(`/cogita/library/${c}/edit/${encodeURIComponent(je)}`,{replace:!0})},ct=()=>{const T=Fr(c,Ze.map(ge=>ge.infoId));T&&o(`/cogita/library/${c}/revision/run?libraryTarget=revisions&scope=info-selection&seed=${encodeURIComponent(T)}`)},yt=Ze.length===1?((xt=Ze[0])==null?void 0:xt.infoId)??null:null,Vt=v.selectionCount.replace("{count}",String(Ze.length)),Rt=x==="collection"?"grid":x==="detail"?"wide":K,Re=Vr(j),ht=we?Math.max(0,Math.min(100,Math.round((we.score??0)*100))):0,Ct=we?Or(we,Re):Re.noKnownnessData;return e.jsx(Ft,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":Rt,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[Ne?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:Re.kicker}),e.jsx("h2",{className:"cogita-card-title",children:G?Br(G.payload,G.infoType,G.infoId):Re.loading}),G?e.jsxs("p",{className:"cogita-card-subtitle",children:[Qe(t,G.infoType)," · ",G.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:bt,children:Re.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:ia,disabled:!je||qe!=="ready",children:v.editInfo})]})]}),qe==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:Re.loading})}):qe==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:Re.loadError})}):G?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Re.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[ht,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${ht}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:Ct})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Re.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(we==null?void 0:we.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:Re.correct.replace("{correct}",String((we==null?void 0:we.correctReviews)??0)).replace("{total}",String((we==null?void 0:we.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:we!=null&&we.lastReviewedUtc?`${Re.lastReview}: ${_r(we.lastReviewedUtc,j)}`:Re.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Re.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:St}),e.jsx("p",{className:"cogita-library-hint",children:Re.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Re.checkcards}),E==="loading"?e.jsx("p",{className:"cogita-library-hint",children:Re.loadingCheckcards}):E==="error"?e.jsx("p",{className:"cogita-library-hint",children:Re.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:Re.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(se==null?void 0:se.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:Re.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(he==null?void 0:he.items.length)??0})]})]})]}),Ue.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:Re.approach}),e.jsx("select",{value:tt,onChange:T=>st(T.target.value),"aria-label":Re.approach,children:Ue.map(T=>e.jsx("option",{value:T.approachKey,children:T.label},T.approachKey))})]}),q==="loading"?e.jsx("p",{className:"cogita-library-hint",children:Re.loadingApproach}):q==="error"?e.jsx("p",{className:"cogita-library-hint",children:Re.loadApproachError}):_e?e.jsx(Ja,{value:_e.projection,emptyLabel:Re.empty}):e.jsx("p",{className:"cogita-library-hint",children:Re.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Re.payload}),e.jsx(Ja,{value:G.payload,emptyLabel:Re.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Re.links}),e.jsx(qr,{links:G.links,emptyLabel:Re.noLinks})]})]})]}):null]})}):null,Ne?null:e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":v.typeLabel,value:w,onChange:T=>C(T.target.value),children:X.map(T=>e.jsx("option",{value:T.value,children:T.label},T.value))}),e.jsx("input",{type:"text",value:F,onChange:T=>g(T.target.value),placeholder:v.searchPlaceholder}),e.jsx("select",{"aria-label":v.sortLabel,value:d,onChange:T=>ie(T.target.value),children:ne.map(T=>e.jsx("option",{value:T.value,children:T.label},T.value))}),e.jsxs("select",{"aria-label":v.viewLabel,value:K,onChange:T=>y(T.target.value),children:[e.jsx("option",{value:"details",children:v.viewDetails}),e.jsx("option",{value:"wide",children:v.viewWide}),e.jsx("option",{value:"grid",children:v.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:v.cardCount.replace("{shown}",String(rt.length)).replace("{total}",String(at.length))}),e.jsx("span",{children:Y==="loading"?v.loading:v.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>N(T=>!T),children:V?v.hideFilters:v.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:v.filtersOptionalHint})]}),V&&oe.length>0?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsx("div",{className:"cogita-filter-grid",children:oe.map(T=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:T.label}),T.kind==="select"?e.jsxs("select",{value:J[T.key]??"",onChange:ge=>ee(ze=>({...ze,[T.key]:ge.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(T.options??[]).map(ge=>e.jsx("option",{value:ge.value,children:ge.label},`${T.key}:${ge.value}`))]}):e.jsx("input",{type:"text",value:J[T.key]??"",onChange:ge=>ee(ze=>({...ze,[T.key]:ge.target.value}))})]},`type-filter:${T.key}`))})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:Vt}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{Me(T=>{const ge={...T};for(const ze of rt)ge[ze.infoId]={infoId:ze.infoId,infoType:ze.infoType,label:ze.label};return ge})},disabled:rt.length===0,children:v.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Me({}),disabled:Ze.length===0,children:v.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>yt&&Ut(yt),disabled:!yt,title:yt?void 0:v.openSelectedDisabled,children:v.openSelected}),e.jsx("button",{type:"button",className:"cta",onClick:ct,disabled:Ze.length===0,children:"Start revision"})]})]}),Ze.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:v.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:v.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:Nt.map(([T,ge])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:Qe(t,T)}),e.jsx("span",{className:"cogita-tag-count",children:ge})]},`stack:type:${T}`))})]}):null,Rt==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":v.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:v.detailColumnName}),e.jsx("span",{children:v.detailColumnType}),e.jsx("span",{children:v.detailColumnId}),e.jsx("span",{})]}),rt.length?rt.map(T=>{const ge=Qe(t,T.infoType),ze=Ye.has(T.infoId),ut=Ce===T.infoId;return e.jsxs("div",{className:`cogita-details-row ${ut||ze?"active":""}`,role:"row",onClick:()=>be(T.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:ze,onChange:$t=>Et(T,$t.target.checked),onClick:$t=>$t.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:T.label,children:T.label}),e.jsx("span",{title:ge,children:ge}),e.jsx("span",{title:T.infoId,children:T.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:$t=>{$t.stopPropagation(),Ut(T.infoId)},"aria-label":v.editInfo,children:">"})]},T.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:v.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${Rt}`,"data-view":Rt,children:rt.length?rt.map(T=>{const ge=Qe(t,T.infoType),ze=Ye.has(T.infoId),ut=Ce===T.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":ut||ze,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:ze,onChange:$t=>Et(T,$t.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>be(T.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:ge}),e.jsx("h3",{className:"cogita-card-title",children:T.label}),e.jsx("p",{className:"cogita-card-subtitle",children:T.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ut(T.infoId),children:v.editInfo})]})},T.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:v.noMatch})})}),vt?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>fe(T=>T+gn),children:v.loadMore})}):null]})]})})})})}function Br(t,n,s){if(t&&typeof t=="object"&&!Array.isArray(t)){const r=t,i=["title","name","label","value","text","quote","term"];for(const m of i){const h=r[m];if(typeof h=="string"&&h.trim())return h.trim()}}return`${n} · ${s}`}function _r(t,n){try{const s=n==="pl"?"pl-PL":n==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(s,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function Vr(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function Or(t,n){return t.totalReviews<=0?n.noKnownnessData:t.totalReviews<3||t.score<.35?n.developmentStart:t.totalReviews<8||t.score<.65?n.developmentGrowing:t.score<.85?n.developmentStable:n.developmentStrong}function qr({links:t,emptyLabel:n}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([s,r])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(r)?r.length?e.jsx("div",{className:"cogita-selection-overview",children:r.map(i=>e.jsx("span",{className:"cogita-tag-chip",children:i},`${s}:${i}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):r?e.jsx("span",{className:"cogita-tag-chip",children:r}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},s))})}function Ja({value:t,emptyLabel:n}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:n});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((s,r)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(Ja,{value:s,emptyLabel:n})})]},r))});if(typeof t=="object"){const s=Object.entries(t);return s.length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:s.map(([r,i])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(Ja,{value:i,emptyLabel:n})})]},r))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const ba=5,Zn=50,es=2,ts=[];function aa({libraryId:t,infoType:n,label:s,placeholder:r,value:i,onChange:m,values:h,onChangeMultiple:b,helperText:j,searchFailedText:k,createFailedText:c,createLabel:x,savingLabel:o,loadMoreLabel:u,allowCreate:v=!0,inputRef:w,autoAdvance:C,onCommit:F,multiple:g}){const d=g?h??ts:ts,[ie,K]=a.useState(g?"":(i==null?void 0:i.label)??""),[y,V]=a.useState([]),[N,Y]=a.useState(ba),[z,I]=a.useState(-1),[ue,re]=a.useState(!1),[fe,Ce]=a.useState(!1),[be,M]=a.useState(null),Me=a.useRef(0),J=a.useRef(new Map),ee=a.useMemo(()=>v?g?ie.trim().length>0:ie.trim().length>0&&!i:!1,[v,ie,i,g]);a.useEffect(()=>{g||K((i==null?void 0:i.label)??"")},[i,g]),a.useEffect(()=>{const G=ie.trim();if(!G||G.length<es){V([]),re(!1),Y(ba),I(-1),Ce(!1),M(null);return}const ve=G.toLowerCase(),we=`${t}:${n}:${ve}`,Ve=J.current.get(we);if(Ve){if(g&&d.length>0){const Ie=new Set(d.map(qe=>qe.id));V(Ve.filter(qe=>!Ie.has(qe.id)))}else V(Ve);Y(ba),I(-1),re(Ve.length>0),Ce(!1),M(null);return}const Je=window.setTimeout(async()=>{const Ie=Date.now();Me.current=Ie,Ce(!0),M(null);try{const qe=await En({libraryId:t,type:n,query:G,limit:Zn});if(Me.current!==Ie)return;const Xe=qe.slice(0,Zn).map(Ae=>({id:Ae.infoId,label:Ae.label,infoType:Ae.infoType}));if(J.current.set(we,Xe),g&&d.length>0){const Ae=new Set(d.map(Ge=>Ge.id));V(Xe.filter(Ge=>!Ae.has(Ge.id)))}else V(Xe);Y(ba),I(-1),re(!0)}catch{if(Me.current!==Ie)return;M(k??"Search failed.")}finally{Me.current===Ie&&Ce(!1)}},250);return()=>window.clearTimeout(Je)},[t,n,ie,d]);const $e=G=>{if(g){const ve=d.some(we=>we.id===G.id)?d:[...d,G];b==null||b(ve),K(""),re(!1),I(-1);return}m==null||m(G),K(G.label),re(!1),I(-1),C&&(F==null||F())},Te=async()=>{const G=ie.trim();if(G){Ce(!0),M(null);try{const ve=await Cn({libraryId:t,infoType:n,payload:{label:G}}),we={id:ve.infoId,label:G,infoType:ve.infoType};if(G.length>=es){const Ve=`${t}:${n}:${G.toLowerCase()}`,Je=J.current.get(Ve)??[];J.current.set(Ve,[we,...Je])}if(g){b==null||b([...d,we]),K(""),re(!1),I(-1);return}m==null||m(we),re(!1),I(-1),C&&(F==null||F())}catch{M(c??"Create failed.")}finally{Ce(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:s}),e.jsx("input",{value:ie,placeholder:r,onChange:G=>{K(G.target.value),!g&&i&&(m==null||m(null))},onKeyDown:G=>{if(G.key==="ArrowDown"){if(G.preventDefault(),!y.length)return;re(!0),I(ve=>{const we=Math.min(y.length,N)-1,Ve=ve<0?0:Math.min(ve+1,we);return Ve===we&&y.length>N?(Y(Je=>Math.min(Je+ba,y.length)),Math.min(ve+1,Math.min(y.length,N+ba)-1)):Ve});return}if(G.key==="ArrowUp"){if(G.preventDefault(),!y.length)return;re(!0),I(ve=>ve<=0?0:ve-1);return}if(G.key==="Enter"){if(G.preventDefault(),z>=0&&y[z]){$e(y[z]);return}if(ee){Te();return}}},onFocus:()=>{y.length>0&&re(!0)},autoComplete:"off",ref:w})]}),g&&d.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:d.map(G=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>b==null?void 0:b(d.filter(ve=>ve.id!==G.id)),children:[G.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},G.id))}),j&&e.jsx("p",{className:"cogita-help",children:j}),be&&e.jsx("p",{className:"cogita-error",children:be}),ue&&y.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[y.slice(0,N).map((G,ve)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":ve===z,onClick:()=>$e(G),children:[e.jsx("strong",{children:G.label}),e.jsx("span",{children:G.infoType})]},G.id)),N<y.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>Y(G=>Math.min(G+ba,y.length)),children:u??"Load more"})]}),ee&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:Te,disabled:fe,children:fe?o??"Saving...":x??`Create new ${n}`})]})}const as=[{id:"gen",la:{abbr:"Gen",name:"Genesis"},en:{abbr:"Gen",name:"Genesis"},de:{abbr:"Gen",name:"Genesis"},pl:{abbr:"Rdz",name:"Księga Rodzaju"}},{id:"ex",la:{abbr:"Ex",name:"Exodus"},en:{abbr:"Ex",name:"Exodus"},de:{abbr:"Ex",name:"Exodus"},pl:{abbr:"Wj",name:"Księga Wyjścia"}},{id:"lev",la:{abbr:"Lev",name:"Leviticus"},en:{abbr:"Lev",name:"Leviticus"},de:{abbr:"Lev",name:"Levitikus"},pl:{abbr:"Kpł",name:"Księga Kapłańska"}},{id:"num",la:{abbr:"Num",name:"Numeri"},en:{abbr:"Num",name:"Numbers"},de:{abbr:"Num",name:"Numeri"},pl:{abbr:"Lb",name:"Księga Liczb"}},{id:"deut",la:{abbr:"Deut",name:"Deuteronomium"},en:{abbr:"Deut",name:"Deuteronomy"},de:{abbr:"Dtn",name:"Deuteronomium"},pl:{abbr:"Pwt",name:"Księga Powtórzonego Prawa"}},{id:"ios",la:{abbr:"Ios",name:"Iosue"},en:{abbr:"Josh",name:"Joshua"},de:{abbr:"Jos",name:"Josua"},pl:{abbr:"Joz",name:"Księga Jozuego"}},{id:"iudg",la:{abbr:"Iudg",name:"Iudicum"},en:{abbr:"Judg",name:"Judges"},de:{abbr:"Ri",name:"Richter"},pl:{abbr:"Sdz",name:"Księga Sędziów"}},{id:"ruth",la:{abbr:"Ruth",name:"Ruth"},en:{abbr:"Ruth",name:"Ruth"},de:{abbr:"Rut",name:"Rut"},pl:{abbr:"Rt",name:"Księga Rut"}},{id:"1sam",la:{abbr:"1 Sam",name:"I Samuelis"},en:{abbr:"1 Sam",name:"1 Samuel"},de:{abbr:"1 Sam",name:"1 Samuel"},pl:{abbr:"1 Sm",name:"1 Księga Samuela"}},{id:"2sam",la:{abbr:"2 Sam",name:"II Samuelis"},en:{abbr:"2 Sam",name:"2 Samuel"},de:{abbr:"2 Sam",name:"2 Samuel"},pl:{abbr:"2 Sm",name:"2 Księga Samuela"}},{id:"1reg",la:{abbr:"1 Reg",name:"I Regum"},en:{abbr:"1 Kgs",name:"1 Kings"},de:{abbr:"1 Kön",name:"1 Könige"},pl:{abbr:"1 Krl",name:"1 Księga Królewska"}},{id:"2reg",la:{abbr:"2 Reg",name:"II Regum"},en:{abbr:"2 Kgs",name:"2 Kings"},de:{abbr:"2 Kön",name:"2 Könige"},pl:{abbr:"2 Krl",name:"2 Księga Królewska"}},{id:"1par",la:{abbr:"1 Par",name:"I Paralipomenon"},en:{abbr:"1 Chr",name:"1 Chronicles"},de:{abbr:"1 Chr",name:"1 Chronik"},pl:{abbr:"1 Krn",name:"1 Księga Kronik"}},{id:"2par",la:{abbr:"2 Par",name:"II Paralipomenon"},en:{abbr:"2 Chr",name:"2 Chronicles"},de:{abbr:"2 Chr",name:"2 Chronik"},pl:{abbr:"2 Krn",name:"2 Księga Kronik"}},{id:"esd",la:{abbr:"Esd",name:"Esdrae"},en:{abbr:"Ezra",name:"Ezra"},de:{abbr:"Esra",name:"Esra"},pl:{abbr:"Ezd",name:"Księga Ezdrasza"}},{id:"neh",la:{abbr:"Neh",name:"Nehemiae"},en:{abbr:"Neh",name:"Nehemiah"},de:{abbr:"Neh",name:"Nehemia"},pl:{abbr:"Ne",name:"Księga Nehemiasza"}},{id:"tob",la:{abbr:"Tob",name:"Tobiae"},en:{abbr:"Tob",name:"Tobit"},de:{abbr:"Tob",name:"Tobit"},pl:{abbr:"Tb",name:"Księga Tobiasza"}},{id:"iudt",la:{abbr:"Iudt",name:"Iudith"},en:{abbr:"Jdt",name:"Judith"},de:{abbr:"Jdt",name:"Judit"},pl:{abbr:"Jdt",name:"Księga Judyty"}},{id:"est",la:{abbr:"Est",name:"Esther"},en:{abbr:"Est",name:"Esther"},de:{abbr:"Est",name:"Ester"},pl:{abbr:"Est",name:"Księga Estery"}},{id:"1macc",la:{abbr:"1 Macc",name:"I Maccabaeorum"},en:{abbr:"1 Mc",name:"1 Maccabees"},de:{abbr:"1 Makk",name:"1 Makkabäer"},pl:{abbr:"1 Mch",name:"1 Księga Machabejska"}},{id:"2macc",la:{abbr:"2 Macc",name:"II Maccabaeorum"},en:{abbr:"2 Mc",name:"2 Maccabees"},de:{abbr:"2 Makk",name:"2 Makkabäer"},pl:{abbr:"2 Mch",name:"2 Księga Machabejska"}},{id:"iob",la:{abbr:"Iob",name:"Iob"},en:{abbr:"Job",name:"Job"},de:{abbr:"Ijob",name:"Ijob"},pl:{abbr:"Hi",name:"Księga Hioba"}},{id:"ps",la:{abbr:"Ps",name:"Psalmi"},en:{abbr:"Ps",name:"Psalms"},de:{abbr:"Ps",name:"Psalmen"},pl:{abbr:"Ps",name:"Księga Psalmów"}},{id:"prov",la:{abbr:"Prov",name:"Proverbia"},en:{abbr:"Prov",name:"Proverbs"},de:{abbr:"Spr",name:"Sprichwörter"},pl:{abbr:"Prz",name:"Księga Przysłów"}},{id:"ecc",la:{abbr:"Ecc",name:"Ecclesiastes"},en:{abbr:"Eccl",name:"Ecclesiastes"},de:{abbr:"Koh",name:"Kohelet"},pl:{abbr:"Koh",name:"Księga Koheleta"}},{id:"cant",la:{abbr:"Cant",name:"Canticum Canticorum"},en:{abbr:"Song",name:"Song of Songs"},de:{abbr:"Hld",name:"Hoheslied"},pl:{abbr:"Pnp",name:"Pieśń nad Pieśniami"}},{id:"sap",la:{abbr:"Sap",name:"Sapientia"},en:{abbr:"Wis",name:"Wisdom"},de:{abbr:"Weish",name:"Weisheit"},pl:{abbr:"Mdr",name:"Księga Mądrości"}},{id:"sir",la:{abbr:"Sir",name:"Ecclesiasticus (Sirach)"},en:{abbr:"Sir",name:"Sirach"},de:{abbr:"Sir",name:"Jesus Sirach"},pl:{abbr:"Syr",name:"Mądrość Syracha"}},{id:"isa",la:{abbr:"Isa",name:"Isaias"},en:{abbr:"Isa",name:"Isaiah"},de:{abbr:"Jes",name:"Jesaja"},pl:{abbr:"Iz",name:"Księga Izajasza"}},{id:"ier",la:{abbr:"Ier",name:"Ieremias"},en:{abbr:"Jer",name:"Jeremiah"},de:{abbr:"Jer",name:"Jeremia"},pl:{abbr:"Jr",name:"Księga Jeremiasza"}},{id:"lam",la:{abbr:"Lam",name:"Lamentationes"},en:{abbr:"Lam",name:"Lamentations"},de:{abbr:"Klgl",name:"Klagelieder"},pl:{abbr:"Lm",name:"Lamentacje"}},{id:"bar",la:{abbr:"Bar",name:"Baruch"},en:{abbr:"Bar",name:"Baruch"},de:{abbr:"Bar",name:"Baruch"},pl:{abbr:"Ba",name:"Księga Barucha"}},{id:"ez",la:{abbr:"Ez",name:"Ezechiel"},en:{abbr:"Ezek",name:"Ezekiel"},de:{abbr:"Ez",name:"Ezechiel"},pl:{abbr:"Ez",name:"Księga Ezechiela"}},{id:"dan",la:{abbr:"Dan",name:"Daniel"},en:{abbr:"Dan",name:"Daniel"},de:{abbr:"Dan",name:"Daniel"},pl:{abbr:"Dn",name:"Księga Daniela"}},{id:"hos",la:{abbr:"Hos",name:"Osee"},en:{abbr:"Hos",name:"Hosea"},de:{abbr:"Hos",name:"Hosea"},pl:{abbr:"Oz",name:"Księga Ozeasza"}},{id:"ioel",la:{abbr:"Ioel",name:"Ioel"},en:{abbr:"Joel",name:"Joel"},de:{abbr:"Joel",name:"Joel"},pl:{abbr:"Jl",name:"Księga Joela"}},{id:"amos",la:{abbr:"Amos",name:"Amos"},en:{abbr:"Am",name:"Amos"},de:{abbr:"Am",name:"Amos"},pl:{abbr:"Am",name:"Księga Amosa"}},{id:"abd",la:{abbr:"Abd",name:"Abdias"},en:{abbr:"Obad",name:"Obadiah"},de:{abbr:"Obd",name:"Obadja"},pl:{abbr:"Abd",name:"Księga Abdiasza"}},{id:"ion",la:{abbr:"Ion",name:"Ionas"},en:{abbr:"Jon",name:"Jonah"},de:{abbr:"Jona",name:"Jona"},pl:{abbr:"Jon",name:"Księga Jonasza"}},{id:"mich",la:{abbr:"Mich",name:"Michaeas"},en:{abbr:"Mic",name:"Micah"},de:{abbr:"Mi",name:"Micha"},pl:{abbr:"Mi",name:"Księga Micheasza"}},{id:"nah",la:{abbr:"Nah",name:"Nahum"},en:{abbr:"Nah",name:"Nahum"},de:{abbr:"Nah",name:"Nahum"},pl:{abbr:"Na",name:"Księga Nahuma"}},{id:"hab",la:{abbr:"Hab",name:"Habacuc"},en:{abbr:"Hab",name:"Habakkuk"},de:{abbr:"Hab",name:"Habakuk"},pl:{abbr:"Ha",name:"Księga Habakuka"}},{id:"soph",la:{abbr:"Soph",name:"Sophonias"},en:{abbr:"Zeph",name:"Zephaniah"},de:{abbr:"Zef",name:"Zefanja"},pl:{abbr:"So",name:"Księga Sofoniasza"}},{id:"agg",la:{abbr:"Agg",name:"Aggaeus"},en:{abbr:"Hag",name:"Haggai"},de:{abbr:"Hag",name:"Haggai"},pl:{abbr:"Ag",name:"Księga Aggeusza"}},{id:"zach",la:{abbr:"Zach",name:"Zacharias"},en:{abbr:"Zech",name:"Zechariah"},de:{abbr:"Sach",name:"Sacharja"},pl:{abbr:"Za",name:"Księga Zachariasza"}},{id:"mal",la:{abbr:"Mal",name:"Malachias"},en:{abbr:"Mal",name:"Malachi"},de:{abbr:"Mal",name:"Maleachi"},pl:{abbr:"Ml",name:"Księga Malachiasza"}},{id:"mt",la:{abbr:"Mt",name:"Matthaeus"},en:{abbr:"Matt",name:"Matthew"},de:{abbr:"Mt",name:"Matthäus"},pl:{abbr:"Mt",name:"Ewangelia wg św. Mateusza"}},{id:"mc",la:{abbr:"Mc",name:"Marcus"},en:{abbr:"Mark",name:"Mark"},de:{abbr:"Mk",name:"Markus"},pl:{abbr:"Mk",name:"Ewangelia wg św. Marka"}},{id:"lc",la:{abbr:"Lc",name:"Lucas"},en:{abbr:"Luke",name:"Luke"},de:{abbr:"Lk",name:"Lukas"},pl:{abbr:"Łk",name:"Ewangelia wg św. Łukasza"}},{id:"io",la:{abbr:"Io",name:"Ioannes"},en:{abbr:"John",name:"John"},de:{abbr:"Joh",name:"Johannes"},pl:{abbr:"J",name:"Ewangelia wg św. Jana"}},{id:"act",la:{abbr:"Act",name:"Actus Apostolorum"},en:{abbr:"Acts",name:"Acts"},de:{abbr:"Apg",name:"Apostelgeschichte"},pl:{abbr:"Dz",name:"Dzieje Apostolskie"}},{id:"rom",la:{abbr:"Rom",name:"ad Romanos"},en:{abbr:"Rom",name:"Romans"},de:{abbr:"Röm",name:"Römer"},pl:{abbr:"Rz",name:"List do Rzymian"}},{id:"1cor",la:{abbr:"1 Cor",name:"I ad Corinthios"},en:{abbr:"1 Cor",name:"1 Corinthians"},de:{abbr:"1 Kor",name:"1 Korinther"},pl:{abbr:"1 Kor",name:"1 List do Koryntian"}},{id:"2cor",la:{abbr:"2 Cor",name:"II ad Corinthios"},en:{abbr:"2 Cor",name:"2 Corinthians"},de:{abbr:"2 Kor",name:"2 Korinther"},pl:{abbr:"2 Kor",name:"2 List do Koryntian"}},{id:"gal",la:{abbr:"Gal",name:"ad Galatas"},en:{abbr:"Gal",name:"Galatians"},de:{abbr:"Gal",name:"Galater"},pl:{abbr:"Ga",name:"List do Galatów"}},{id:"eph",la:{abbr:"Eph",name:"ad Ephesios"},en:{abbr:"Eph",name:"Ephesians"},de:{abbr:"Eph",name:"Epheser"},pl:{abbr:"Ef",name:"List do Efezjan"}},{id:"phil",la:{abbr:"Phil",name:"ad Philippenses"},en:{abbr:"Phil",name:"Philippians"},de:{abbr:"Phil",name:"Philipper"},pl:{abbr:"Flp",name:"List do Filipian"}},{id:"col",la:{abbr:"Col",name:"ad Colossenses"},en:{abbr:"Col",name:"Colossians"},de:{abbr:"Kol",name:"Kolosser"},pl:{abbr:"Kol",name:"List do Kolosan"}},{id:"1thess",la:{abbr:"1 Thess",name:"I ad Thessalonicenses"},en:{abbr:"1 Thess",name:"1 Thessalonians"},de:{abbr:"1 Thess",name:"1 Thessalonicher"},pl:{abbr:"1 Tes",name:"1 List do Tesaloniczan"}},{id:"2thess",la:{abbr:"2 Thess",name:"II ad Thessalonicenses"},en:{abbr:"2 Thess",name:"2 Thessalonians"},de:{abbr:"2 Thess",name:"2 Thessalonicher"},pl:{abbr:"2 Tes",name:"2 List do Tesaloniczan"}},{id:"1tim",la:{abbr:"1 Tim",name:"I ad Timotheum"},en:{abbr:"1 Tim",name:"1 Timothy"},de:{abbr:"1 Tim",name:"1 Timotheus"},pl:{abbr:"1 Tm",name:"1 List do Tymoteusza"}},{id:"2tim",la:{abbr:"2 Tim",name:"II ad Timotheum"},en:{abbr:"2 Tim",name:"2 Timothy"},de:{abbr:"2 Tim",name:"2 Timotheus"},pl:{abbr:"2 Tm",name:"2 List do Tymoteusza"}},{id:"tit",la:{abbr:"Tit",name:"ad Titum"},en:{abbr:"Titus",name:"Titus"},de:{abbr:"Tit",name:"Titus"},pl:{abbr:"Tt",name:"List do Tytusa"}},{id:"phlm",la:{abbr:"Phlm",name:"ad Philemonem"},en:{abbr:"Phlm",name:"Philemon"},de:{abbr:"Phlm",name:"Philemon"},pl:{abbr:"Flm",name:"List do Filemona"}},{id:"heb",la:{abbr:"Heb",name:"ad Hebraeos"},en:{abbr:"Heb",name:"Hebrews"},de:{abbr:"Hebr",name:"Hebräer"},pl:{abbr:"Hbr",name:"List do Hebrajczyków"}},{id:"iac",la:{abbr:"Iac",name:"Iacobi"},en:{abbr:"Jas",name:"James"},de:{abbr:"Jak",name:"Jakobus"},pl:{abbr:"Jk",name:"List św. Jakuba"}},{id:"1pet",la:{abbr:"1 Pet",name:"I Petri"},en:{abbr:"1 Pet",name:"1 Peter"},de:{abbr:"1 Petr",name:"1 Petrus"},pl:{abbr:"1 P",name:"1 List św. Piotra"}},{id:"2pet",la:{abbr:"2 Pet",name:"II Petri"},en:{abbr:"2 Pet",name:"2 Peter"},de:{abbr:"2 Petr",name:"2 Petrus"},pl:{abbr:"2 P",name:"2 List św. Piotra"}},{id:"1io",la:{abbr:"1 Io",name:"I Ioannis"},en:{abbr:"1 John",name:"1 John"},de:{abbr:"1 Joh",name:"1 Johannes"},pl:{abbr:"1 J",name:"1 List św. Jana"}},{id:"2io",la:{abbr:"2 Io",name:"II Ioannis"},en:{abbr:"2 John",name:"2 John"},de:{abbr:"2 Joh",name:"2 Johannes"},pl:{abbr:"2 J",name:"2 List św. Jana"}},{id:"3io",la:{abbr:"3 Io",name:"III Ioannis"},en:{abbr:"3 John",name:"3 John"},de:{abbr:"3 Joh",name:"3 Johannes"},pl:{abbr:"3 J",name:"3 List św. Jana"}},{id:"iud",la:{abbr:"Iud",name:"Iudae"},en:{abbr:"Jude",name:"Jude"},de:{abbr:"Jud",name:"Judas"},pl:{abbr:"Jud",name:"List św. Judy"}},{id:"apoc",la:{abbr:"Apoc",name:"Apocalypsis Ioannis"},en:{abbr:"Rev",name:"Revelation"},de:{abbr:"Offb",name:"Offenbarung"},pl:{abbr:"Ap",name:"Apokalipsa św. Jana"}}],ns=8;function ss({libraryId:t,copy:n,language:s,sourceKindOptions:r,value:i,onChange:m,labels:h}){const[b,j]=a.useState(!1),[k,c]=a.useState(-1),x=a.useMemo(()=>{const w=s;return as.map(C=>{var d;const F=(C==null?void 0:C[w])??(C==null?void 0:C.en)??(C==null?void 0:C.la);return{label:`${F.abbr} — ${F.name}`,latin:((d=C==null?void 0:C.la)==null?void 0:d.abbr)??F.abbr}})},[s]),o=(w,C=!1)=>{const F=w.trim().toLowerCase();return F?x.filter(g=>g.label.toLowerCase().includes(F)).slice(0,ns):C?x.slice(0,ns):[]},u=(w,C)=>{const F=w.trim().toLowerCase();if(!F)return null;const g=as;for(const d of g){const ie=d==null?void 0:d.la,K=(d==null?void 0:d[C])??(d==null?void 0:d.en)??ie,y=(K==null?void 0:K.abbr)??"",V=(K==null?void 0:K.name)??"";if(y.toLowerCase()===F||V.toLowerCase()===F||`${y} — ${V}`.toLowerCase()===F)return{book:d,entry:K,la:ie}}return null};a.useEffect(()=>{if(i.sourceKind==="bible"&&i.locatorValue&&!b){const w=u(i.locatorValue,s);if(w){const C=`${w.entry.abbr} — ${w.entry.name}`;C!==i.bibleBookDisplay&&m({...i,bibleBookDisplay:C})}}},[s,i,b,m]);const v=w=>m({...i,...w});return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.sourceKindLabel}),e.jsx("select",{value:i.sourceKind,onChange:w=>v({sourceKind:w.target.value,churchDocument:null,bookMedia:null,work:null,locatorValue:"",locatorAux:"",bibleBookDisplay:""}),children:r.map(w=>e.jsx("option",{value:w.value,children:w.label},w.value))})]}),i.sourceKind==="bible"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-lookup full",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.bibleBookLabel}),e.jsx("input",{type:"text",value:i.bibleBookDisplay,onChange:w=>{const C=w.target.value;v({bibleBookDisplay:C,locatorValue:""}),j(!0),c(-1)},onKeyDown:w=>{var F;const C=o(i.bibleBookDisplay);if(C.length){if(w.key==="ArrowDown")w.preventDefault(),c(g=>Math.min(g+1,C.length-1));else if(w.key==="ArrowUp")w.preventDefault(),c(g=>Math.max(g-1,0));else if((w.key==="Enter"||w.key==="Tab")&&k>=0&&C[k]){const g=C[k],d=u(g.label,s);if(!d)return;v({bibleBookDisplay:g.label,locatorValue:((F=d.la)==null?void 0:F.abbr)??i.locatorValue}),j(!1)}}},onFocus:()=>j(!0),onBlur:()=>window.setTimeout(()=>j(!1),100),placeholder:h.bibleBookPlaceholder})]}),b&&o(i.bibleBookDisplay,!0).length>0&&e.jsx("div",{className:"cogita-lookup-results",children:o(i.bibleBookDisplay,!0).map((w,C)=>e.jsx("button",{type:"button",className:"cogita-lookup-option","data-active":C===k,tabIndex:-1,onMouseDown:()=>{var g;const F=u(w.label,s);F&&v({bibleBookDisplay:w.label,locatorValue:((g=F.la)==null?void 0:g.abbr)??i.locatorValue})},children:e.jsx("strong",{children:w.label})},w.latin))})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.bibleRestLabel}),e.jsx("input",{type:"text",value:i.locatorAux,onChange:w=>v({locatorAux:w.target.value}),placeholder:h.bibleRestPlaceholder})]})]}),i.sourceKind==="website"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceUrlLabel}),e.jsx("input",{type:"text",value:i.sourceUrl,onChange:w=>v({sourceUrl:w.target.value}),placeholder:n.cogita.library.add.info.sourceUrlPlaceholder})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceAccessedDateLabel}),e.jsx("input",{type:"text",value:i.sourceAccessedDate,onChange:w=>v({sourceAccessedDate:w.target.value}),placeholder:n.cogita.library.add.info.sourceAccessedDatePlaceholder})]})]}),i.sourceKind==="number_document"&&e.jsxs(e.Fragment,{children:[e.jsx(aa,{libraryId:t,infoType:"work",label:h.churchDocumentLabel,placeholder:h.churchDocumentPlaceholder,value:i.churchDocument,onChange:w=>v({churchDocument:w}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:w=>v({locatorValue:w.target.value}),placeholder:h.locatorPlaceholder})]})]}),i.sourceKind==="work"&&e.jsx(aa,{libraryId:t,infoType:"work",label:h.workLabel,placeholder:h.workPlaceholder,value:i.work,onChange:w=>v({work:w}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),i.sourceKind==="book"&&e.jsxs(e.Fragment,{children:[e.jsx(aa,{libraryId:t,infoType:"media",label:h.bookLabel,placeholder:h.bookPlaceholder,value:i.bookMedia,onChange:w=>v({bookMedia:w}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.media),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:w=>v({locatorValue:w.target.value}),placeholder:h.locatorPlaceholder})]})]}),i.sourceKind!=="website"&&i.sourceKind!=="bible"&&i.sourceKind!=="book"&&i.sourceKind!=="number_document"&&e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:w=>v({locatorValue:w.target.value}),placeholder:h.locatorPlaceholder})]})]})}const rs=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}];function Ra(){return{sourceKind:"string",locatorValue:"",locatorAux:"",bibleBookDisplay:"",sourceUrl:"",sourceAccessedDate:"",churchDocument:null,bookMedia:null,work:null}}function is(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function os(t,n){if(!t||typeof t!="object")return n;const s=t,r=[s.label,s.name,s.title,s.text,s.orcid,s.email,s.number];for(const i of r)if(typeof i=="string"&&i.trim())return i.trim();return n}function ls(t,n){var r;if(!(t instanceof Is))return n;const s=(r=t.message)==null?void 0:r.trim();if(!s)return n;try{const i=JSON.parse(s);if(typeof i.error=="string"&&i.error.trim())return i.error.trim()}catch{}return s}function Ur(t){const n=t.trim();if(!n)return null;try{const s=JSON.parse(n);return s&&typeof s=="object"&&!Array.isArray(s)?s:null}catch{return null}}function Qt(t,n){const s=t==null?void 0:t[n];return typeof s=="string"?s:""}function Jr(t,n){return n?t==="book"&&n.infoType==="media"?{bookMedia:n}:t==="work"&&n.infoType==="work"?{work:n}:t==="number_document"&&n.infoType==="work"?{churchDocument:n}:{}:{}}function Hr(t,n){const s=Ra(),r=(t.sourceKind??"").trim()||s.sourceKind,i=t.locator??"",m=Ur(i);let h="",b="",j="",k="",c="";return r==="website"?(k=Qt(m,"url"),c=Qt(m,"accessedDate"),h=Qt(m,"value")):r==="bible"?(h=Qt(m,"book")||i.trim(),b=Qt(m,"passage")||Qt(m,"rest"),j=Qt(m,"bookDisplay")):m?(h=Qt(m,"value")||Qt(m,"locator"),b=Qt(m,"aux")):h=i,{...s,sourceKind:r,locatorValue:h,locatorAux:b,bibleBookDisplay:j,sourceUrl:k,sourceAccessedDate:c,...Jr(r,n)}}function pn(t){return t.sourceKind==="book"?t.bookMedia:t.sourceKind==="work"?t.work:t.sourceKind==="number_document"?t.churchDocument:null}function fn(t){const n=t.locatorValue.trim(),s=t.locatorAux.trim(),r=t.sourceUrl.trim(),i=t.sourceAccessedDate.trim();switch(t.sourceKind){case"website":return{url:r,accessedDate:i};case"bible":return{book:n,bookDisplay:t.bibleBookDisplay.trim(),passage:s};case"book":case"work":case"number_document":return s?{value:n,aux:s}:n;default:return s?{value:n,aux:s}:n}}function cs(t){var i,m,h;const n=t.locatorValue.trim(),s=t.locatorAux.trim(),r=[n,s].filter(Boolean).join(" ");switch(t.sourceKind){case"website":return t.sourceUrl.trim()||"website";case"bible":return r||"bible";case"book":return[(i=t.bookMedia)==null?void 0:i.label,r].filter(Boolean).join(" · ")||"book";case"work":return[(m=t.work)==null?void 0:m.label,r].filter(Boolean).join(" · ")||"work";case"number_document":return[(h=t.churchDocument)==null?void 0:h.label,r].filter(Boolean).join(" · ")||"number_document";default:return r||t.sourceKind||"source"}}function ds(t){return t.sourceKind.trim()?t.sourceKind==="website"?!!t.sourceUrl.trim():t.sourceKind==="bible"?!!(t.locatorValue.trim()&&t.locatorAux.trim()):t.sourceKind==="book"?!!t.bookMedia:t.sourceKind==="work"?!!t.work:t.sourceKind==="number_document"?!!(t.churchDocument&&t.locatorValue.trim()):!!t.locatorValue.trim():!1}function Wr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,libraryId:c,editInfoId:x}){var st,_e,ye;const{libraryName:o}=ra(c),u=!!x,[v,w]=a.useState([]),[C,F]=a.useState("word"),[g,d]=a.useState({}),[ie,K]=a.useState({}),[y,V]=a.useState({}),[N,Y]=a.useState({}),[z,I]=a.useState(null),[ue,re]=a.useState("idle"),[fe,Ce]=a.useState(Ra),[be,M]=a.useState({}),[Me,J]=a.useState({}),[ee,$e]=a.useState({}),[Te,G]=a.useState(null),ve=a.useMemo(()=>v.find(q=>q.infoType===C),[C,v]),we=a.useMemo(()=>v.find(q=>q.infoType==="source"),[v]),Ve=a.useMemo(()=>v.map(q=>({value:q.infoType,label:Qe(t,q.infoType)})),[t,v]);a.useEffect(()=>{let q=!1;return Ys({libraryId:c}).then(Ee=>{var se;if(!q&&(w(Ee),!u)){const B=(se=Ee[0])==null?void 0:se.infoType;B&&F(B)}}).catch(()=>{q||w([])}),()=>{q=!0}},[u,c]),a.useEffect(()=>{if(u||!ve)return;const q={},Ee={},se={},B={};for(const he of ve.payloadFields)q[he.key]="";for(const he of ve.linkFields)he.multiple?se[he.key]=[]:Ee[he.key]=null,he.targetTypes.length>0&&(B[he.key]=he.targetTypes[0]);d(q),K(Ee),V(se),Y(B)},[ve==null?void 0:ve.infoType,u]),a.useEffect(()=>{if(!u||!x||v.length===0)return;let q=!1;return re("loading"),I(null),(async()=>{const se=await ta({libraryId:c,infoId:x});if(q)return;const B=se.infoType;F(B);const he=v.find($=>$.infoType===B);if(!he){re("idle");return}const He=se.payload??{},E={};for(const $ of he.payloadFields)E[$.key]=is(He[$.key]);d(E);const R=se.links??{}??{},X={},ne={},S={},O=[];for(const $ of he.linkFields){$.targetTypes.length>0&&(S[$.key]=$.targetTypes[0]);const U=R[$.key];if($.multiple){const ae=Array.isArray(U)?U.filter(ke=>typeof ke=="string"):[];ne[$.key]=[];for(const ke of ae)O.push(ta({libraryId:c,infoId:ke}).then(je=>{if(q)return;const Ke={id:ke,infoType:je.infoType,label:os(je.payload,ke)};S[$.key]=Ke.infoType,ne[$.key]=[...ne[$.key],Ke]}).catch(()=>{}))}else{const ae=typeof U=="string"?U:null;X[$.key]=null,ae&&O.push(ta({libraryId:c,infoId:ae}).then(ke=>{if(q)return;const je={id:ae,infoType:ke.infoType,label:os(ke.payload,ae)};S[$.key]=je.infoType,X[$.key]=je}).catch(()=>{}))}}await Promise.all(O),!q&&(K(X),V(ne),Y(S),re("idle"))})().catch(()=>{q||(I("Failed to load info details."),re("idle"))}),()=>{q=!0}},[x,u,c,v]),a.useEffect(()=>{C==="source"&&Ce(Hr(g,ie.resource??null))},[C,g.sourceKind,g.locator,(st=ie.resource)==null?void 0:st.id,(_e=ie.resource)==null?void 0:_e.infoType,(ye=ie.resource)==null?void 0:ye.label]);const Je=q=>{var he,He;const Ee=((he=we==null?void 0:we.payloadFields.find(E=>E.key==="sourceKind"))==null?void 0:he.keepOnCreate)??!1,se=((He=we==null?void 0:we.linkFields.find(E=>E.key==="resource"))==null?void 0:He.keepOnCreate)??!1,B=Ra();return B.sourceKind=Ee?q.sourceKind:B.sourceKind,se&&(B.work=q.work,B.bookMedia=q.bookMedia,B.churchDocument=q.churchDocument),Ee&&q.sourceKind==="bible"&&(B.locatorValue=q.locatorValue,B.bibleBookDisplay=q.bibleBookDisplay),Ee&&q.sourceKind==="website"&&(B.sourceUrl=q.sourceUrl,B.sourceAccessedDate=q.sourceAccessedDate),B},Ie=a.useMemo(()=>({sourceKindLabel:t.cogita.library.add.info.sourceKindLabel,bibleBookLabel:t.cogita.library.add.info.sourceBibleBookLabel,bibleBookPlaceholder:t.cogita.library.add.info.sourceBibleBookPlaceholder,bibleRestLabel:t.cogita.library.add.info.sourceBibleRestLabel,bibleRestPlaceholder:t.cogita.library.add.info.sourceBibleRestPlaceholder,churchDocumentLabel:t.cogita.library.add.info.sourceResourceLabel,churchDocumentPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,workLabel:t.cogita.library.add.info.sourceResourceLabel,workPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,bookLabel:t.cogita.library.add.info.sourceResourceLabel,bookPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,locatorLabel:t.cogita.library.list.typeFilterLocator,locatorPlaceholder:t.cogita.library.list.typeFilterLocator}),[t]),qe=async q=>{const Ee=Me[q]??Ra();if(!ds(Ee)){$e(se=>({...se,[q]:t.cogita.library.add.info.referenceMissingSource}));return}G(q),$e(se=>({...se,[q]:null}));try{const se=pn(Ee),B=se?{resource:se.id}:{},he={label:cs(Ee),sourceKind:Ee.sourceKind.trim(),locator:fn(Ee)},E={id:(await Cn({libraryId:c,infoType:"source",payload:he,links:B})).infoId,infoType:"source",label:he.label};if(V(R=>{const X=R[q]??[];return X.some(ne=>ne.id===E.id)?R:{...R,[q]:[...X,E]}}),u&&x){const R=await ta({libraryId:c,infoId:x}),X=R.links&&typeof R.links=="object"?{...R.links}:{},ne=X[q],S=Array.isArray(ne)?ne.filter(O=>typeof O=="string"):typeof ne=="string"?[ne]:[];S.includes(E.id)||(X[q]=[...S,E.id],await Jn({libraryId:c,infoId:x,payload:R.payload,links:X}))}J(R=>({...R,[q]:Je(Ee)})),$e(R=>({...R,[q]:null}))}catch(se){$e(B=>({...B,[q]:ls(se,t.cogita.library.lookup.createFailed)}))}finally{G(se=>se===q?null:se)}},Xe=async()=>{var se;if(!ve)return;const q={};for(const B of ve.payloadFields){if(C==="source"&&(B.key==="sourceKind"||B.key==="locator"))continue;const he=(g[B.key]??"").trim();if(!he){if(B.required){I(`Field '${B.label}' is required.`);return}continue}if(B.inputType==="json")try{q[B.key]=JSON.parse(he)}catch{I(`Field '${B.label}' must be valid JSON.`);return}else q[B.key]=he}const Ee={};for(const B of ve.linkFields)if(!(C==="source"&&B.key==="resource"))if(B.multiple){const he=(y[B.key]??[]).map(He=>He.id);if(B.required&&he.length===0){I(`Link '${B.label}' is required.`);return}he.length>0&&(Ee[B.key]=he)}else{const he=((se=ie[B.key])==null?void 0:se.id)??null;if(B.required&&!he){I(`Link '${B.label}' is required.`);return}he&&(Ee[B.key]=he)}if(C==="source"){if(!ds(fe)){I(t.cogita.library.add.info.referenceMissingSource);return}const B=fe.sourceKind.trim();q.sourceKind=B,q.locator=fn(fe),(typeof q.label!="string"||!q.label.trim())&&(q.label=cs(fe));const he=pn(fe);he&&(Ee.resource=he.id)}re("saving"),I(null);try{if(u&&x)await Jn({libraryId:c,infoId:x,payload:q,links:Ee}),I("Info updated.");else{await Cn({libraryId:c,infoType:C,payload:q,links:Ee}),I("Info saved.");const B={};for(const E of ve.payloadFields)B[E.key]=E.keepOnCreate?g[E.key]??"":"";d(B);const he={},He={};for(const E of ve.linkFields)E.multiple?He[E.key]=E.keepOnCreate?y[E.key]??[]:[]:he[E.key]=E.keepOnCreate?ie[E.key]??null:null;K(E=>({...E,...he})),V(E=>({...E,...He})),C==="source"&&Ce(E=>{const R=Je(E),X=pn(R);return d(ne=>({...ne,sourceKind:R.sourceKind,locator:is(fn(R))})),K(ne=>({...ne,resource:X})),X&&Y(ne=>({...ne,resource:X.infoType})),R})}}catch(B){I(ls(B,"Failed to save info."))}finally{re("idle")}},Ae=q=>{const Ee=g[q.key]??"",se=q.inputType==="textarea"||q.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:q.label}),se?e.jsx("textarea",{rows:q.inputType==="json"?8:4,value:Ee,onChange:B=>d(he=>({...he,[q.key]:B.target.value})),placeholder:q.key}):e.jsx("input",{type:"text",value:Ee,onChange:B=>d(he=>({...he,[q.key]:B.target.value})),placeholder:q.key})]},`payload:${q.key}`)},Ge=q=>{const Ee=N[q.key]??q.targetTypes[0],se=q.key==="references"&&q.multiple&&q.targetTypes.includes("source"),B=Me[q.key]??Ra(),he=be[q.key]??!1,He=ee[q.key];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:q.label}),q.targetTypes.length>1?e.jsx("select",{value:Ee,onChange:E=>Y(R=>({...R,[q.key]:E.target.value})),children:q.targetTypes.map(E=>e.jsx("option",{value:E,children:Qe(t,E)},`${q.key}:${E}`))}):null,q.multiple?e.jsx(aa,{libraryId:c,infoType:Ee,label:q.label,placeholder:q.key,multiple:!0,values:y[q.key]??[],onChangeMultiple:E=>V(R=>({...R,[q.key]:E})),allowCreate:!se,searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(aa,{libraryId:c,infoType:Ee,label:q.label,placeholder:q.key,value:ie[q.key]??null,onChange:E=>K(R=>({...R,[q.key]:E})),searchFailedText:"Search failed",createFailedText:"Create failed"}),se?e.jsxs("div",{children:[e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:he,onChange:E=>M(R=>({...R,[q.key]:E.target.checked}))}),e.jsx("span",{children:t.cogita.library.add.info.referenceToggle})]}),he?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(ss,{libraryId:c,copy:t,language:j,sourceKindOptions:[...rs],value:B,onChange:E=>J(R=>({...R,[q.key]:E})),labels:Ie}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>qe(q.key),disabled:Te===q.key,children:Te===q.key?t.cogita.library.lookup.saving:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.source)})}),He?e.jsx("p",{className:"cogita-library-subtitle",children:He}):null]}):null]}):null]},`link:${q.key}`)},tt=()=>e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(ss,{libraryId:c,copy:t,language:j,sourceKindOptions:[...rs],value:fe,onChange:Ce,labels:Ie})]});return e.jsx(Ft,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:u?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:o}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${c}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[u?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:C,onChange:q=>F(q.target.value),children:Ve.map(q=>e.jsx("option",{value:q.value,children:q.label},q.value))})]}),ue==="loading"&&u?e.jsx("p",{children:"Loading..."}):null,ve&&!(ue==="loading"&&u)?e.jsxs("div",{className:"cogita-form-grid",children:[ve.payloadFields.filter(q=>!(C==="source"&&(q.key==="sourceKind"||q.key==="locator"))).map(Ae),C==="source"?tt():null,ve.linkFields.filter(q=>!(C==="source"&&q.key==="resource")).map(Ge)]}):ue==="loading"&&u?null:e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:Xe,disabled:ue==="saving"||!ve,children:ue==="saving"?"Saving...":u?"Update info":"Create info"})}),z?e.jsx("p",{className:"cogita-library-subtitle",children:z}):null]})})})]})})}const us=t=>/\s/.test(t),Ha=t=>/[\p{L}\p{N}]/u.test(t),hs=(t,n)=>{const s=n>0?t[n-1]:"",r=n<t.length?t[n]:"";if(!s||!r)return 0;const i=us(s),m=us(r);if(i||m)return 3;const h=Ha(s),b=Ha(r);return h!==b?2:!h&&!b?1:0},bn=(t,n,s,r,i)=>{const m=Math.max(r-n,s-r);for(let h=0;h<=m;h+=1){const b=r-h;if(b>=n&&b<=s&&hs(t,b)>=i)return b;const j=r+h;if(j>=n&&j<=s&&hs(t,j)>=i)return j}return null},yn=(t,n)=>{const s=n>0?t[n-1]:"",r=n<t.length?t[n]:"";return!s||!r?!0:Ha(s)!==Ha(r)},Gr=(t,n,s,r)=>{const i=s-n,m=n+r,h=s-r;if(i<=r*2||h<=m)return null;const b=Math.floor((n+s)/2),j=bn(t,m,h,b,3);if(j!==null&&yn(t,j))return j;const k=bn(t,m,h,b,2);if(k!==null&&yn(t,k))return k;const c=bn(t,m,h,b,1);return c!==null&&yn(t,c)?c:null},ya=(t,n)=>{const s=Math.max(1,7),r=Math.max(s,13),i={},m=(j,k,c,x,o)=>{const u=String(x),v={id:u,start:j,end:k,text:t.slice(j,k),depth:c,index:x,parentId:o};if(i[u]=v,k-j>r){let C=Gr(t,j,k,s);if(C!==null&&C>j&&C<k){const F=m(j,C,c+1,x*2+1,u),g=m(C,k,c+1,x*2+2,u);v.leftId=F.id,v.rightId=g.id}}return v},h=m(0,t.length,0,0),b=Object.values(i).sort((j,k)=>k.depth-j.depth||j.start-k.start).map(j=>j.id);return{text:t,rootId:h.id,nodes:i,order:b}},Ta=(t,n,s,r,i,m,h)=>{const b=m==="reverse"?t.order.slice().sort((j,k)=>t.nodes[k].start-t.nodes[j].start||t.nodes[k].depth-t.nodes[j].depth):t.order;for(const j of b){if(h&&j===h||n.has(j))continue;const k=t.nodes[j];if(k){if(i&&(k.leftId||k.rightId)){const c=k.leftId?s[k.leftId]??0:r,x=k.rightId?s[k.rightId]??0:r;if((c+x)/2<r)continue}return k}}return null},Pn=(t,n)=>({before:t.slice(0,n.start),fragment:t.slice(n.start,n.end),after:t.slice(n.end)});function Yr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,libraryId:c}){const x=`/#/cogita/library/${c}`,[o,u,v]=ws([]),[w,C,F]=js([]),[g,d]=a.useState(null),[ie,K]=a.useState(null),[y,V]=a.useState(null),[N,Y]=a.useState(null),z=a.useMemo(()=>o.find(M=>M.id===g)??null,[o,g]);a.useEffect(()=>{let M=!0;return Qs({libraryId:c}).then(Me=>{if(!M)return;const J=Me.nodes.map(ee=>{var $e,Te,G;return{id:ee.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:ee.payload&&typeof ee.payload=="object"&&"label"in ee.payload?String(ee.payload.label):"Item",nodeType:ee.nodeType,itemType:(($e=ee.payload)==null?void 0:$e.itemType)??"info",itemId:((Te=ee.payload)==null?void 0:Te.itemId)??null,infoType:((G=ee.payload)==null?void 0:G.infoType)??null}}});u(J),C(Me.edges.map(ee=>({id:ee.edgeId,source:ee.fromNodeId,target:ee.toNodeId})))}).catch(()=>{M&&(u([]),C([]))}),()=>{M=!1}},[c]),a.useEffect(()=>{Xs({libraryId:c}).then(K).catch(()=>K(null))},[c,o,w]);const I=a.useCallback(M=>{C(Me=>ks(M,Me))},[]),ue=()=>{const M=crypto.randomUUID();u(Me=>[...Me,{id:M,type:"default",position:{x:140+Me.length*40,y:120+Me.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},re=()=>{const M=crypto.randomUUID();u(Me=>[...Me,{id:M,type:"default",position:{x:180+Me.length*40,y:160+Me.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},fe=async()=>{V(null);try{const M=o.map(J=>({nodeId:J.id,nodeType:J.data.nodeType,payload:{itemType:J.data.itemType,itemId:J.data.itemId??null,label:J.data.label,infoType:J.data.infoType??null}})),Me=w.map(J=>({edgeId:J.id,fromNodeId:J.source,toNodeId:J.target}));await Zs({libraryId:c,nodes:M,edges:Me}),V(t.cogita.library.graph.saveSuccess)}catch{V(t.cogita.library.graph.saveFail)}},Ce=M=>{z&&u(Me=>Me.map(J=>J.id===z.id?{...J,data:{...J.data,itemId:(M==null?void 0:M.infoId)??null,itemType:"collection",infoType:"collection",label:(M==null?void 0:M.label)??t.cogita.library.infoTypes.collection}}:J))},be=M=>{z&&u(Me=>Me.map(J=>J.id===z.id?{...J,data:{...J.data,itemId:(M==null?void 0:M.infoId)??null,itemType:"info",infoType:(M==null?void 0:M.infoType)??null,label:(M==null?void 0:M.label)??t.cogita.library.infoTypes.any}}:J))};return a.useEffect(()=>{if(!z||z.data.nodeType!=="info"||z.data.infoType!=="citation"||!z.data.itemId){Y(null);return}let M=!0;return ta({libraryId:c,infoId:z.data.itemId}).then(Me=>{if(!M)return;const J=Me.payload,ee=(J==null?void 0:J.text)??"";if(!ee){Y(null);return}const $e=ya(ee),Te=Object.values($e.nodes).sort((G,ve)=>G.depth-ve.depth||G.start-ve.start).map(G=>({id:G.id,text:G.text,depth:G.depth}));Y({title:(J==null?void 0:J.title)??z.data.label,fragments:Te})}).catch(()=>Y(null)),()=>{M=!1}},[c,z]),e.jsx(Ft,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:x,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:fe,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ue,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:re,children:t.cogita.library.actions.addInfo}),ie?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(ie.totalCollections))})}):null,y?e.jsx("p",{className:"cogita-help",children:y}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(Ln,{nodes:o,edges:w,onNodesChange:v,onEdgesChange:F,onConnect:I,onNodeClick:(M,Me)=>d(Me.id),fitView:!0,children:[e.jsx(Rn,{gap:18,size:1}),e.jsx($n,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),z?e.jsxs("div",{className:"cogita-graph-inspector",children:[z.data.nodeType==="collection"?e.jsx(aa,{libraryId:c,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:z.data.itemId?{id:z.data.itemId,label:z.data.label,infoType:"collection"}:null,onChange:Ce,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(aa,{libraryId:c,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:z.data.itemId?{id:z.data.itemId,label:z.data.label,infoType:z.data.infoType??void 0}:null,onChange:be,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),N?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:N.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:N.fragments.map(M=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:M.id}),e.jsx("span",{children:M.text})]},M.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function Kn({children:t,flashState:n,flashTick:s=0,feedbackToken:r,className:i}){const m=r??(n?`${n}-${s}`:"idle");return e.jsx("section",{className:i?`cogita-revision-card ${i}`:"cogita-revision-card","data-feedback":m,children:t})}function Fn({copy:t,currentCard:n,currentTypeLabel:s,prompt:r,languages:i,answer:m,onAnswerChange:h,computedExpected:b,computedAnswers:j,onComputedAnswerChange:k,answerTemplate:c,outputVariables:x,variableValues:o,computedFieldFeedback:u,feedback:v,canAdvance:w,quoteContext:C,quotePlaceholder:F,onCheckAnswer:g,onSkip:d,onLanguageSelect:ie,onMarkReviewed:K,onAdvance:y,showCorrectAnswer:V,setShowCorrectAnswer:N,onRevealCorrect:Y,answerMask:z,expectedAnswer:I,hasExpectedAnswer:ue,handleComputedKeyDown:re,answerInputRef:fe,computedInputRefs:Ce,scriptMode:be,setScriptMode:M,matchPairs:Me,matchLeftOrder:J,matchRightOrder:ee,matchSelection:$e,matchActiveLeft:Te,matchActiveRight:G,matchFeedback:ve,onMatchLeftSelect:we,onMatchRightSelect:Ve,disableCheckAnswer:Je=!1,hideSkipAction:Ie=!1,allowRevealBeforeCheck:qe=!1,autoRevealAfterAnswer:Xe=!1,disableCheckAfterAnswer:Ae=!1}){const Ge=a.useMemo(()=>{var Ke;const E=!c&&b.length===2?`The {${b[0].key}} is of type {${b[1].key}}`:null,R=c??E;if(!R)return null;const X=new Map(b.map(Ne=>[Ne.key,Ne.expected])),ne=new Set,S=[],O=/\{([^}]+)\}/g;let $=0,U,ae=null;for(;(U=O.exec(R))!==null;){const Ne=R.slice($,U.index);Ne&&S.push({type:"text",value:Ne});const le=((Ke=U[1])==null?void 0:Ke.trim())??"",oe=le&&X.has(le)?le:le&&x&&x[le]?x[le]:null;le&&ne.add(le),oe&&ne.add(oe),oe&&X.has(oe)?(S.push({type:"input",value:oe}),ae||(ae=oe)):le&&o&&o[le]!==void 0?S.push({type:"text",value:o[le]}):S.push({type:"text",value:U[0]}),$=U.index+U[0].length}const ke=R.slice($);return ke&&S.push({type:"text",value:ke}),b.filter(Ne=>!ne.has(Ne.key)).length>0?null:{parts:S,expectedByKey:X,firstInputKey:ae}},[c,b,x,o]),tt=()=>{if(!Ge)return null;const{parts:E,expectedByKey:R,firstInputKey:X}=Ge;return e.jsx("div",{className:"cogita-revision-inline-answer",children:E.map((ne,S)=>{var O,$;return ne.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:ne.value},`text-${S}`):e.jsx("input",{ref:U=>{Ce.current[ne.value]=U},autoFocus:ne.value===X,value:j[ne.value]??"",onChange:U=>k(ne.value,U.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":u[ne.value]??(v==="correct"?"correct":v==="incorrect"?"incorrect":void 0),onKeyDown:U=>q(U)||re(U),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((O=j[ne.value])==null?void 0:O.length)??0,(($=R.get(ne.value))==null?void 0:$.length)??6)}ch`}},`input-${ne.value}-${S}`)})})},st=a.useMemo(()=>{const E=new Map;return(Me??[]).forEach(R=>E.set(R.leftId,R)),E},[Me]),_e=a.useMemo(()=>{const E=new Map;return(Me??[]).forEach(R=>E.set(R.rightId,R)),E},[Me]);a.useEffect(()=>{var S;if(n.cardType!=="info"||n.infoType!=="computed"||b.length===0)return;const E=typeof document<"u"?document.activeElement:null;if(E&&(E.tagName==="INPUT"||E.tagName==="TEXTAREA"))return;const R=(Ge==null?void 0:Ge.firstInputKey)??((S=b[0])==null?void 0:S.key);if(!R)return;const X=Ce.current[R];if(!X)return;const ne=requestAnimationFrame(()=>{X.focus()});return()=>cancelAnimationFrame(ne)},[n,b,Ge]);const ye=(()=>{const E=[I??"",...b.map(ne=>ne.expected??"")].join(""),R=[m,...Object.values(j)].join(""),X=`${E}${R}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(X)})(),q=E=>E.ctrlKey&&(E.key==="^"||E.key==="6")?(E.preventDefault(),M(R=>R==="super"?null:"super"),!0):E.ctrlKey&&(E.key==="_"||E.key==="-")?(E.preventDefault(),M(R=>R==="sub"?null:"sub"),!0):!1,Ee=()=>{if(!I||!z)return I??"";const E=I.split(""),R=Array.from(z),X=R.length>0?R.reduce((ne,S)=>ne+S,0)/R.length:127;return E.map((ne,S)=>{const O=R[S]??X,$=Math.max(0,Math.min(255,Math.round(O)));let U=255,ae=0;return $<=127?ae=Math.round($/127*255):(ae=255,U=Math.round(255*(1-($-127)/128))),e.jsx("span",{style:{color:`rgb(${U}, ${ae}, 0)`},children:ne},`mask-${S}`)})},se=n.cardType==="info"&&n.infoType==="citation"?(C==null?void 0:C.title)||n.label:n.description,B=V||Xe&&v!==null,he=Je||Ae&&(v!==null||B),He=ue&&(qe||v==="incorrect"||B);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[s?e.jsx("span",{children:s}):null,e.jsx("strong",{children:se})]}),n.cardType==="vocab"&&n.checkType==="translation-match"&&Me?e.jsxs("div",{className:"cogita-revision-body",children:[r?e.jsx("h2",{children:r}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(J??[]).map(E=>{const R=st.get(E);if(!R)return null;const X=($e==null?void 0:$e[E])??null,ne=(ve==null?void 0:ve[E])??null,S=Te===E;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":S,"data-state":ne??void 0,"data-locked":X?"true":void 0,onClick:()=>we==null?void 0:we(E),children:[e.jsx("span",{children:R.leftLabel}),X&&V?e.jsx("em",{children:"✓"}):null]},E)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(ee??[]).map(E=>{const R=_e.get(E);if(!R)return null;const X=Object.values($e??{}).includes(E),ne=G===E;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":X||ne,"data-locked":X?"true":void 0,onClick:()=>Ve==null?void 0:Ve(E),children:e.jsx("span",{children:R.rightLabel})},E)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:g,disabled:n.checkType==="translation-match"||he,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:d,children:t.cogita.library.revision.skip})]})]}):n.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:fe,value:m,onChange:E=>h(E.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:E=>{if(E.key==="Enter")if(E.preventDefault(),E.stopPropagation(),w)y();else{if(he)return;g()}}})]}),ye?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":be==="super",onClick:()=>M(E=>E==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":be==="sub",onClick:()=>M(E=>E==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:g,disabled:he,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:d,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[n.label?e.jsx("p",{className:"cogita-revision-hint",children:n.label}):null,c?null:e.jsx(er,{value:r??"",mode:"auto"}),b.length>0?(()=>{const E=tt();return E?e.jsx("div",{className:"cogita-inline-answer-wrap",children:E}):e.jsx("div",{className:"cogita-form-grid",children:b.map((R,X)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:R.key}),e.jsx("textarea",{ref:ne=>{Ce.current[R.key]=ne},autoFocus:X===0,value:j[R.key]??"",onChange:ne=>k(R.key,ne.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":u[R.key]??(v==="correct"?"correct":v==="incorrect"?"incorrect":void 0),onKeyDown:ne=>q(ne)||re(ne)})]},R.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:fe,value:m,onChange:E=>h(E.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:E=>{if(!q(E)&&E.key==="Enter")if(E.preventDefault(),E.stopPropagation(),w)y();else{if(he)return;g()}}})]})}),ye?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":be==="super",onClick:()=>M(E=>E==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":be==="sub",onClick:()=>M(E=>E==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:g,disabled:he,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:d,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="citation"&&C?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(C.completed)).replace("{total}",String(C.total))}),e.jsx("p",{className:"cogita-quote-text",children:C.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:fe,value:m,onChange:E=>h(E.target.value),placeholder:F??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:E=>{if(E.key==="Enter")if(E.preventDefault(),E.stopPropagation(),w)y();else{if(he)return;g()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:C.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:g,disabled:he,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:d,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:i.length?i.map(E=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>ie(E.label),children:E.label},E.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:d,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:K,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:d,children:t.cogita.library.revision.skip})]})]}),v&&e.jsx("div",{className:"cogita-revision-feedback","data-state":v,children:v==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),He?e.jsxs("div",{className:"cogita-revision-reveal",children:[B?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>N(E=>{const R=!E;return R&&Y(),R}),children:t.cogita.library.revision.showAnswer}),B?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),b.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[b.map(E=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:E.key}),e.jsx("span",{children:E.expected})]},E.key)),I?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:I})]}):null]}):e.jsx("p",{children:z?Ee():I})]}):null]}):null,w?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:y,children:t.cogita.library.revision.nextQuestion})}):null]})}const ms={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},Qr=(t,n)=>{const s=Math.max(t.length,n.length,1),r=Math.abs(t.length-n.length);return Math.max(0,1-r/s)},Xr=(t,n)=>{const s=new Uint8Array(t.length),r=Qr(t,n);for(let i=0;i<t.length;i+=1){const m=t[i]===(n[i]??"")?128:0,h=t.length-1-i,b=n.length-1-i,j=t[h]===(n[b]??"")?127:0,k=Math.round((m+j)*r);s[i]=Math.max(0,Math.min(255,k))}return s},Zr=(t,n)=>t===n||(ms[t]??[]).includes(n)?!0:(ms[n]??[]).includes(t),Ba=(t,n,s)=>s?Zr(t,n):t===n,Wa=(t,n,s)=>{const r=new Uint8Array(t.length);if(!t.length)return r;const i=(s==null?void 0:s.allowSimilarChars)??!0,m=[];for(let b=0;b<=t.length-3;b+=1)m.push({index:b,text:t.slice(b,b+3)});let h=!1;return m.forEach(b=>{for(let j=0;j<=n.length-3;j+=1){const k=n.slice(j,j+3);let c=0;for(let w=0;w<3;w+=1)Ba(b.text[w],k[w],i)&&(c+=1);if(c<2)continue;let x=b.index-1,o=j-1;for(;x>=0&&o>=0;){const w=t[x],C=n[o];if(w===C){r[x]=Math.max(r[x],255),x-=1,o-=1,h=!0;continue}if(Ba(w,C,i)&&w!==C){r[x]=Math.max(r[x],127),x-=1,o-=1,h=!0;continue}if(x>0&&t[x-1]===C){r[x]=Math.max(r[x],0),x-=1,h=!0;continue}if(o>0&&t[x]===n[o-1]){o-=1,h=!0;continue}break}for(let w=0;w<3;w+=1){const C=b.index+w,F=b.text[w],g=k[w],d=F===g?255:Ba(F,g,i)?127:0;r[C]=Math.max(r[C],d),h=!0}let u=b.index+3,v=j+3;for(;u<t.length&&v<n.length;){const w=t[u],C=n[v];if(w===C){r[u]=Math.max(r[u],255),u+=1,v+=1,h=!0;continue}if(Ba(w,C,i)&&w!==C){r[u]=Math.max(r[u],127),u+=1,v+=1,h=!0;continue}if(u+1<t.length&&t[u+1]===C){r[u]=Math.max(r[u],0),u+=1,h=!0;continue}if(v+1<n.length&&t[u]===n[v+1]){v+=1,h=!0;continue}break}}}),h?r:Xr(t,n)},xn=t=>/[\p{L}\p{N}]/u.test(t),gs=t=>t.trim().toLowerCase(),ha=(t,n)=>{if(t.length===0)return 100;const s=(n==null?void 0:n.treatSimilarCharsAsSame)??!1,r=Array.from(t).reduce((i,m)=>s&&m===127?i+255:i+m,0);return Math.round(r/(t.length*255)*100)},Ga=(t,n,s)=>{const r=Math.max(0,Math.min(100,(s==null?void 0:s.thresholdPercent)??100)),i=(s==null?void 0:s.treatSimilarCharsAsSame)??!0,m=(s==null?void 0:s.ignorePunctuationAndSpacing)??!1,h=gs(t),b=gs(n);if(!m){const g=Wa(h,b,{allowSimilarChars:i}),d=ha(g,{treatSimilarCharsAsSame:i});return{mask:g,percent:d,isCorrect:d>=r,normalizedExpected:h,normalizedAnswer:b}}const j=Array.from(h),k=Array.from(b),c=[],x=[],o=[];j.forEach((g,d)=>{xn(g)&&(c.push(g),x.push(d))}),k.forEach(g=>{xn(g)&&o.push(g)});const u=c.join(""),v=o.join(""),w=Wa(u,v,{allowSimilarChars:i}),C=new Uint8Array(j.length);for(let g=0;g<C.length;g+=1)C[g]=xn(j[g]??"")?0:255;for(let g=0;g<w.length;g+=1){const d=x[g];d!==void 0&&(C[d]=w[g])}const F=ha(w,{treatSimilarCharsAsSame:i});return{mask:C,percent:F,isCorrect:F>=r,normalizedExpected:u,normalizedAnswer:v}},Ca=(t,n,s)=>{const r=t.trim().toLowerCase(),i=n.trim().toLowerCase();return s==="prefix"||s==="bidirectional"?Wa(r,i,{allowSimilarChars:!0}):Wa(r,i,{allowSimilarChars:!0})};function Xt(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function ps(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function fs(t){const n=t.checkType??"info";return t.direction?`${n} / ${t.direction}`:n}function ei({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,libraryId:c,infoId:x,selectedReviewerRoleId:o}){const[u,v]=a.useState(x),[w,C]=a.useState([]),[F,g]=a.useState([]),[d,ie]=a.useState("loading"),[K,y]=a.useState(null),[V,N]=a.useState(null),[Y,z]=a.useState(null),[I,ue]=a.useState(null),[re,fe]=a.useState(""),[Ce,be]=a.useState(null),[M,Me]=a.useState(1),[J,ee]=a.useState(null),[$e,Te]=a.useState(0),[G,ve]=a.useState(!1),[we,Ve]=a.useState(null),[Je,Ie]=a.useState({}),[qe,Xe]=a.useState({}),[Ae]=a.useState({}),[Ge,tt]=a.useState(null),st=a.useRef(null),_e=a.useRef({}),ye=In();a.useEffect(()=>{let $=!1;return ie("loading"),Promise.all([ta({libraryId:c,infoId:x}).catch(()=>null),Oa({libraryId:c,infoId:x}),qa({libraryId:c,infoId:x})]).then(([U,ae,ke])=>{if($)return;const je=(U==null?void 0:U.payload)??{},Ke=typeof je.title=="string"&&je.title||typeof je.label=="string"&&je.label||typeof je.name=="string"&&je.name||x;v(Ke),N(je),z((U==null?void 0:U.infoType)??null),C(ae.items),g(ke.items),ie("ready")}).catch(()=>{$||(N(null),z(null),C([]),g([]),ie("error"))}),()=>{$=!0}},[c,x]),a.useEffect(()=>{if(Y!=="translation"){ue(null);return}Ms({libraryId:c,infoId:x,approachKey:"vocab-card"}).then($=>ue($.projection??null)).catch(()=>ue(null))},[Y,x,c]);const q=a.useMemo(()=>{var Ne;const $=new Map(w.map(le=>[Xt(le),le])),U=new Map,ae=new Map;for(const le of w)U.set(Xt(le),0),ae.set(Xt(le),[]);for(const le of F){const oe=ps({parentItemId:le.parentItemId,parentCheckType:le.parentCheckType,parentDirection:le.parentDirection}),We=[le.childItemId,le.childCheckType??"",le.childDirection??""].join("|");!$.has(oe)||!$.has(We)||((Ne=ae.get(oe))==null||Ne.push(We),U.set(We,(U.get(We)??0)+1))}const ke=Array.from(U.entries()).filter(([,le])=>le===0).map(([le])=>le),je=new Map;for(const le of ke)je.set(le,0);for(;ke.length;){const le=ke.shift(),oe=je.get(le)??0;for(const We of ae.get(le)??[]){const Ue=Math.max(je.get(We)??0,oe+1);je.set(We,Ue),U.set(We,(U.get(We)??1)-1),(U.get(We)??0)<=0&&ke.push(We)}}const Ke=new Map;for(const le of w){const oe=Xt(le),We=je.get(oe)??0,Ue=Ke.get(We)??[];Ue.push(oe),Ke.set(We,Ue)}return w.map(le=>{const oe=Xt(le),We=je.get(oe)??0,Ue=Ke.get(We)??[oe],at=Math.max(0,Ue.indexOf(oe));return{id:oe,position:{x:40+at*290+(We%2?18:0),y:30+We*120},draggable:!1,selectable:!0,data:{label:le.label,subtitle:fs(le),checkType:le.checkType??"info",direction:le.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[w,F]),Ee=a.useMemo(()=>new Map(w.map($=>[Xt($),$])),[w]),se=a.useMemo(()=>{const $=[];for(const U of F){const ae=ps({parentItemId:U.parentItemId,parentCheckType:U.parentCheckType,parentDirection:U.parentDirection}),ke=[U.childItemId,U.childCheckType??"",U.childDirection??""].join("|");!Ee.has(ae)||!Ee.has(ke)||$.push({id:`${ae}->${ke}`,source:ae,target:ke,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return $},[Ee,F]),B=a.useMemo(()=>K?Ee.get(K)??null:null,[Ee,K]);a.useEffect(()=>{fe(""),ee(null),Te(0),ve(!1),Ve(null),be(null),Xe({})},[K]);const he=a.useMemo(()=>{var je,Ke;if(!B)return null;const $=Y??B.infoType??null,U=B.checkType??"info",ae=B.direction??null,ke=V??{};if(B.cardType==="vocab"&&I&&Array.isArray(I.words)){const Ne=I.words,le=((je=Ne[0])==null?void 0:je.label)??"?",oe=((Ke=Ne[1])==null?void 0:Ke.label)??"?";return ae==="a-to-b"?{kind:"vocab",prompt:String(le),expected:String(oe)}:ae==="b-to-a"?{kind:"vocab",prompt:String(oe),expected:String(le)}:{kind:"generic",prompt:`${le} ↔ ${oe}`,expected:`${le} ↔ ${oe}`}}if($==="citation"&&U==="quote-fragment"&&ae&&typeof ke.text=="string"){const Ne=ae,le=ya(ke.text),oe=le.nodes[Ne];if(oe){const We=Pn(ke.text,oe);return{kind:"citation-fragment",expected:oe.text,quoteContext:{title:u,before:We.before,after:We.after,total:Object.keys(le.nodes).length,completed:0},quotePlaceholder:oe.text.length>0?".".repeat(Math.max(4,Math.min(18,oe.text.length))):"..."}}}return{kind:"generic",prompt:B.description||B.label,expected:B.label}},[Y,V,B,u,I]),He=async $=>{if(B&&o)try{await tr({libraryId:c,outcome:{itemType:"info",itemId:B.cardId,checkType:B.checkType??"info",direction:B.direction??null,revisionType:"direct",evalType:"direct-check",correct:$,clientId:"cogita-info-checkcards",clientSequence:M,personRoleId:o}}),Me(U=>U+1),be($?"Saved as correct.":"Saved as incorrect.")}catch{be("Failed to save answer.")}},E=B?Xt(B):null,R=E?!!Je[E]:!1,X=async()=>{if(!B||!he)return;const $=Xt(B);if(Je[$]){be("This card was already checked.");return}const U=he.expected,ae=he.kind==="citation-fragment",ke=Ga(U,re,{thresholdPercent:ae?90:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:ae}),je=ke.isCorrect;ee(je?"correct":"incorrect"),Te(Ke=>Ke+1),Ve(ke.mask),ve(!0),be(o?null:"Answer checked locally (not saved: no person selected)."),Ie(Ke=>({...Ke,[$]:!0})),o&&await He(je)},ne=()=>{if(!B||!he)return;const $=Xt(B);Je[$]||(Ie(ae=>({...ae,[$]:!0})),be("Answer revealed (not saved)."));const U=Ga(he.expected,he.expected,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:he.kind==="citation-fragment"});Ve(U.mask)},S=a.useMemo(()=>B?B.infoType==="citation"?{...B,description:u}:{...B,description:B.label}:null,[B,u]),O=a.useMemo(()=>Y?Qe(t,Y):t.cogita.library.infoTypes.any,[t,Y]);return e.jsx(Ft,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:O}),e.jsx("h2",{className:"cogita-card-title",children:u}),e.jsx("p",{className:"cogita-card-subtitle",children:x})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${w.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${F.length}`}),e.jsx("button",{type:"button",className:"cta",disabled:w.length===0,onClick:()=>ye(`/cogita/library/${c}/revision/run?libraryTarget=revisions&scope=info&infoId=${encodeURIComponent(x)}`),children:"Start revision"})]})]}),d==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):d==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(Ln,{nodes:q,edges:se,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:($,U)=>y(U.id),panOnDrag:!0,children:[e.jsx(Rn,{}),e.jsx($n,{showInteractive:!1})]})}),B?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[he&&S?e.jsx(Kn,{flashState:J,flashTick:$e,children:e.jsx(Fn,{copy:t,currentCard:S,currentTypeLabel:"",prompt:he.kind==="citation-fragment"?null:he.prompt,languages:[],answer:re,onAnswerChange:fe,computedExpected:[],computedAnswers:qe,onComputedAnswerChange:($,U)=>Xe(ae=>({...ae,[$]:U})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:Ae,feedback:J,canAdvance:!1,quoteContext:he.kind==="citation-fragment"?he.quoteContext:null,quotePlaceholder:he.kind==="citation-fragment"?he.quotePlaceholder:null,onCheckAnswer:()=>void X(),onSkip:()=>y(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:G,setShowCorrectAnswer:ve,onRevealCorrect:ne,answerMask:we,expectedAnswer:he.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:st,computedInputRefs:_e,scriptMode:Ge,setScriptMode:tt,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:R||G,hideSkipAction:!0,allowRevealBeforeCheck:!0,autoRevealAfterAnswer:!0,disableCheckAfterAnswer:!0})}):null,o?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),Ce?e.jsx("p",{className:"cogita-library-hint",children:Ce}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:w.map($=>{const U=Xt($),ae=K===U;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${ae?"active":""}`,onClick:()=>y(U),children:[e.jsx("span",{children:$.label}),e.jsx("small",{children:fs($)})]},U)})})]})]})]})})})})})}function _a(t,n){var s,r;return((r=(s=t.fields.find(i=>i.fieldType===n))==null?void 0:s.plainValue)==null?void 0:r.trim())??""}function ti(t){return _a(t,"role_kind").toLowerCase()==="person"}function ai(t){return _a(t,"label")||_a(t,"display_name")||_a(t,"name")||t.roleId}function ni({copy:t,onPersonCreated:n}){const[s,r]=a.useState([]),[i,m]=a.useState("loading"),[h,b]=a.useState(null),[j,k]=a.useState(!1),[c,x]=a.useState(""),o=async()=>{m("loading");try{const w=await Ls();r(w),m("ready")}catch{r([]),m("error")}};a.useEffect(()=>{o()},[]);const u=a.useMemo(()=>s.filter(ti).map(w=>({roleId:w.roleId,label:ai(w)})).sort((w,C)=>w.label.localeCompare(C.label)),[s]),v=async()=>{const w=c.trim();if(!w){b("Name is required.");return}k(!0),b(null);try{const C=await ar({fields:[{fieldType:"role_kind",plainValue:"person"},{fieldType:"label",plainValue:w},{fieldType:"display_name",plainValue:w}]});x(""),b("Person role created."),n==null||n(C.roleId),await o()}catch{b("Failed to create person role.")}finally{k(!1)}};return e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-browser-panel",children:[e.jsx("div",{className:"cogita-info-overview-head",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Cogita"}),e.jsx("h2",{className:"cogita-card-title",children:"Persons"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Select reviewer persons in the header and create new person roles here."})]})}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Create"}),e.jsx("h3",{className:"cogita-detail-title",children:"New person role"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{type:"text",value:c,onChange:w=>x(w.target.value),placeholder:"e.g. Anna Kowalska",disabled:j})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:j,children:j?"Creating...":"Create person"})}),h?e.jsx("p",{className:"cogita-library-hint",children:h}):null]})]}),e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Overview"}),e.jsx("h3",{className:"cogita-detail-title",children:"All person roles"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[i==="loading"?e.jsx("p",{children:"Loading persons..."}):null,i==="error"?e.jsx("p",{children:"Failed to load persons."}):null,i==="ready"&&u.length===0?e.jsx("p",{children:"No person roles found."}):null,i==="ready"&&u.length>0?e.jsxs("div",{className:"cogita-details-grid",children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:"Name"}),e.jsx("span",{children:"Type"}),e.jsx("span",{children:"Role ID"}),e.jsx("span",{})]}),u.map(w=>e.jsxs("div",{className:"cogita-details-row",role:"row",children:[e.jsx("span",{}),e.jsx("span",{title:w.label,children:w.label}),e.jsx("span",{children:"person"}),e.jsx("span",{title:w.roleId,children:w.roleId}),e.jsx("span",{})]},w.roleId))]}):null]})]})]})]})})})})}function si({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,libraryId:c,collectionId:x}){const{libraryName:o}=ra(c),[u,v]=a.useState([]),[w,C]=a.useState("loading"),[F,g]=a.useState("idle"),d=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),ie=`/#/cogita/library/${c}`,K=()=>{C("loading"),Rs({libraryId:c}).then(N=>{v(N),C("idle")}).catch(()=>{v([]),C("error")})};a.useEffect(()=>{K()},[c]);const y=async N=>{try{await $s({libraryId:c,shareId:N}),K()}catch{K()}},V=async N=>{const Y=`${d}/${N}`;try{await navigator.clipboard.writeText(Y),g("copied")}catch{g("failed")}};return e.jsx(Ft,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:o}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:ie,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${ie}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[w==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):w==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):u.filter(N=>!x||N.collectionId===x).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:u.filter(N=>!x||N.collectionId===x).map(N=>e.jsxs("div",{className:"cogita-share-row","data-state":N.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:N.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(N.createdUtc).toLocaleString(),N.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),N.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${d}/${N.shareCode}`}):null]}),N.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[N.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>V(N.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>y(N.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},N.shareId))}),F==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):F==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function ri({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,libraryId:c}){const{libraryName:x}=ra(c),[o,u]=a.useState(null),[v,w]=a.useState(null),[C,F]=a.useState(null),[g,d]=a.useState(null),[ie,K]=a.useState(null),[y,V]=a.useState(null),N=a.useRef(null),Y=ue=>{if(!Number.isFinite(ue))return"0 B";if(ue<1024)return`${ue} B`;const re=ue/1024;if(re<1024)return`${re.toFixed(1)} KB`;const fe=re/1024;return fe<1024?`${fe.toFixed(1)} MB`:`${(fe/1024).toFixed(1)} GB`},z=async()=>{u(null),K({loadedBytes:0,totalBytes:null,percent:null});try{u(t.cogita.library.overview.exporting);const ue=await nr(c,K),re=URL.createObjectURL(ue),fe=document.createElement("a");fe.href=re,fe.download=`cogita-library-${x||c}.json`,fe.click(),URL.revokeObjectURL(re),u(t.cogita.library.overview.exportReady)}catch{u(t.cogita.library.overview.exportFail)}finally{K(ue=>ue??{loadedBytes:0,totalBytes:null,percent:null})}},I=async ue=>{var fe;w(null),F(null),d(null);const re=(fe=ue.target.files)==null?void 0:fe[0];if(re)try{w(t.cogita.library.overview.importing),V({loadedBytes:0,totalBytes:re.size,percent:0});const Ce=await sr(c,re,V,be=>{const M=be.stage==="infos"?t.cogita.library.overview.importStageInfos:be.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;d(t.cogita.library.overview.importLiveProgress.replace("{stage}",M).replace("{done}",String(be.processed)).replace("{total}",String(be.total)).replace("{infos}",String(be.infos)).replace("{connections}",String(be.connections)).replace("{collections}",String(be.collections)))});F({infos:Ce.infosImported,connections:Ce.connectionsImported,collections:Ce.collectionsImported}),w(t.cogita.library.overview.importDone)}catch(Ce){const be=Ce instanceof Is&&Ce.message?` ${Ce.message}`:"";w(`${t.cogita.library.overview.importFail}${be}`)}finally{N.current&&(N.current.value="")}};return e.jsx(Ft,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:z,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:N,type:"file",accept:"application/json",onChange:I})]})]}),ie?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:ie.percent??void 0,max:ie.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",Y(ie.loadedBytes)).replace("{total}",ie.totalBytes?Y(ie.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,y?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:y.percent??void 0,max:y.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",Y(y.loadedBytes)).replace("{total}",y.totalBytes?Y(y.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,o?e.jsx("p",{className:"cogita-help",children:o}):null,v?e.jsx("p",{className:"cogita-help",children:v}):null,g?e.jsx("p",{className:"cogita-help",children:g}):null,C?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(C.infos)).replace("{connections}",String(C.connections)).replace("{collections}",String(C.collections))}):null]})]})})})]})})}function ii({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,libraryId:c}){const{libraryName:x}=ra(c),[o,u]=a.useState(""),[v,w]=a.useState([]),C=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Ft,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:o,onChange:F=>u(F.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const F=o.trim();F&&(w(g=>[{id:C(),name:F},...g]),u(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[v.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,v.map(F=>e.jsx("button",{type:"button",className:"ghost",children:F.name},F.id))]})]})]})})})]})})}function oi({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,libraryId:c}){const{libraryName:x}=ra(c),[o,u]=a.useState(""),[v,w]=a.useState([]),C=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Ft,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:o,onChange:F=>u(F.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const F=o.trim();F&&(w(g=>[{id:C(),name:F},...g]),u(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[v.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,v.map(F=>e.jsx("button",{type:"button",className:"ghost",children:F.name},F.id))]})]})]})})})]})})}function bs({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,libraryId:c}){const{libraryName:x}=ra(c),o=`/#/cogita/library/${c}`,[u,v]=a.useState(""),[w,C]=a.useState([]),[F,g]=a.useState("idle"),[d,ie]=a.useState(0),[K,y]=a.useState(null);a.useEffect(()=>{g("loading");const N=window.setTimeout(()=>{Aa({libraryId:c,query:u.trim()||void 0,limit:30}).then(Y=>{C(Y.items),ie(Y.total),y(Y.nextCursor??null),g("ready")}).catch(()=>{C([]),ie(0),y(null),g("ready")})},240);return()=>window.clearTimeout(N)},[c,u]);const V=async()=>{if(K){g("loading");try{const N=await Aa({libraryId:c,query:u.trim()||void 0,limit:30,cursor:K});C(Y=>[...Y,...N.items]),y(N.nextCursor??null),ie(N.total),g("ready")}catch{g("ready")}}};return e.jsx(Ft,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:o,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${o}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:u,onChange:N=>v(N.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(w.length)).replace("{total}",String(d||w.length))}),e.jsx("span",{children:F==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:w.length?w.map(N=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${o}/collections/${N.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:N.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(N.itemCount))," ·"," ",N.notes||t.cogita.library.collections.noNotes]})]})},N.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${o}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),K?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:V,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const me=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,qt=(t,n,s,r)=>`${t}:${n}:${s??""}:${r??""}`;function li({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,libraryId:c,collectionId:x}){ra(c);const o=`/#/cogita/library/${c}`,[u,v]=a.useState(t.cogita.library.collections.defaultName),[w,C]=a.useState(null),[F,g]=a.useState(0),[d,ie]=a.useState([]),[K,y]=a.useState("idle"),[V,N]=a.useState(null),Y=a.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(d.length)).replace("{total}",String(F||d.length)),[t,d.length,F]);a.useEffect(()=>{nn(c,x).then(I=>{v(I.name),C(I.notes??null),g(I.itemCount)}).catch(()=>{v(t.cogita.library.collections.defaultName),C(null)})},[c,x]),a.useEffect(()=>{y("loading"),Ua({libraryId:c,collectionId:x,limit:40}).then(I=>{ie(I.items),N(I.nextCursor??null),g(I.total),y("ready")}).catch(()=>{ie([]),N(null),y("ready")})},[c,x]);const z=async()=>{if(V){y("loading");try{const I=await Ua({libraryId:c,collectionId:x,limit:40,cursor:V});ie(ue=>[...ue,...I.items]),N(I.nextCursor??null),g(I.total),y("ready")}catch{y("ready")}}};return e.jsx(Ft,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:u}),e.jsx("p",{className:"cogita-library-subtitle",children:w||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:o,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${o}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${o}/collections/${x}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${o}/collections/${x}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:Y}),e.jsx("span",{children:K==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:d.length?d.map(I=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:I.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:I.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:I.label}),e.jsx("p",{className:"cogita-card-subtitle",children:I.description})]})},me(I))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),V?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:z,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${o}/collections/${x}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const Zt=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const n=t.length,s=t.filter(m=>m.correct).length,r=sn(Dn(t));return{score:Math.round(Math.max(0,Math.min(100,r.knowness*100))*100)/100,total:n,correct:s,lastReviewedUtc:r.lastReviewedUtc??null}},ci=t=>{if(t.maskBase64)try{const n=rr(t.maskBase64);if(!n.length)return t.correct?1:0;const s=n.reduce((r,i)=>r+i,0);return Math.max(0,Math.min(1,s/n.length/255))}catch{return t.correct?1:0}return t.correct?1:0},Dn=t=>t.map(n=>({correctness:ci(n),createdUtc:n.createdUtc})),sn=(t,n=Date.now())=>{var F;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const r=t.slice().sort((g,d)=>g.createdUtc.localeCompare(d.createdUtc)).slice(-5),i=r.reduce((g,d)=>g+d.correctness,0)/r.length,m=5,h=2,b=.15;let j=0,k=0;for(let g=0;g<r.length;g+=1){const d=new Date(r[g].createdUtc).getTime(),ie=g===r.length-1?n:new Date(r[g+1].createdUtc).getTime(),K=Math.max(0,(ie-d)/(1e3*60)),y=1-Math.exp(-K/m);j+=y,r[g].correctness>.5&&(k+=b)}let c=i*j*h+k;const x=((F=r[r.length-1])==null?void 0:F.createdUtc)??null,o=x?Math.max(0,(n-new Date(x).getTime())/(1e3*60)):0,v=1/(1+Math.log1p(o/60));return c*=v,r.length===1&&r[0].correctness>.5&&(c+=5.44*Math.exp(-o/2)),{knowness:c,avgCorrectness:i,lastReviewedUtc:x}},Ea=t=>{const n=t.slice();for(let s=n.length-1;s>0;s-=1){const r=Math.floor(Math.random()*(s+1));[n[s],n[r]]=[n[r],n[s]]}return n},Va=t=>t[Math.floor(Math.random()*t.length)],di=(t,n)=>{const s=new Map;return t.forEach(r=>s.set(r,Math.random())),t.sort((r,i)=>{const m=n(r)-n(i);return m!==0?m:(s.get(r)??0)-(s.get(i)??0)})},rn=(t,n,s,r,i)=>{if(!t.length)return null;const m=t.filter(b=>!(i!=null&&i.has(me(b))));if(m.length===0)return null;const h=m.filter(b=>me(b)!==s);return Va(h.length?h:m)},ui=(t,n,s,r,i)=>{if(!t.length)return null;let m=Number.POSITIVE_INFINITY;for(const k of t){const c=me(k);if(s.has(c))continue;const x=n[c]??1;x<m&&(m=x)}if(!Number.isFinite(m))return null;const h=t.filter(k=>{const c=me(k);return!s.has(c)&&(n[c]??1)===m}),b=h.filter(k=>!i||me(k)!==i),j=r?b.filter(k=>!r.has(me(k))):b;return j.length>0?Va(j):b.length>0?Va(b):i&&h.some(k=>me(k)===i)?h.find(k=>me(k)===i)??null:h.length?Va(h):null},Fs=(t,n,s,r,i)=>{const m=[],h=t.filter(j=>!i.has(me(j))&&!s.has(me(j))&&(n[me(j)]??0)<1),b=di(h,j=>n[me(j)]??0);for(const j of b){if(m.length>=r)break;m.push(j),i.add(me(j))}if(m.length<r){const j=Ea(t.filter(k=>!i.has(me(k))&&s.has(me(k))));for(const k of j){if(m.length>=r)break;m.push(k),i.add(me(k))}}return m},hi=(t,n,s,r)=>Fs(t,n,s,r,new Set),zn=(t,n,s,r,i,m)=>{const h=Math.max(1,s.stackSize??n),j=Ea(t).filter((v,w,C)=>C.findIndex(F=>me(F)===me(v))===w),k=hi(j,r,i,h),c=new Set,x=new Set,o=rn(k,{},null,c,x),u=o?[o]:[];return o&&x.add(me(o)),{queue:u,meta:{pool:j,active:k,knownessMap:r,unknownSet:i,outcomesById:m,asked:c,queued:x}}},Mn={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,n)=>{const r=Ea(t).filter((i,m,h)=>h.findIndex(b=>me(b)===me(i))===m);return{queue:r.slice(0,Math.min(n,r.length)),meta:{}}},applyOutcome:t=>t},Bn=(t,n,s,r)=>{const i=Math.max(1,s.stackSize??n),h=Ea(t).filter((w,C,F)=>F.findIndex(g=>me(g)===me(w))===C),b={},j=new Set,k=new Set,c=new Set,x=Math.max(1,s.levels??1);h.forEach(w=>{const C=me(w),F=r==null?void 0:r[C],g=typeof F=="number"&&Number.isFinite(F)?F:1;b[C]=Math.min(x,Math.max(1,Math.round(g)))});const o=[];if(h.length>0){const w=new Map;h.forEach(F=>{var d;const g=b[me(F)]??1;w.has(g)||w.set(g,[]),(d=w.get(g))==null||d.push(F)});const C=Array.from(w.keys()).sort((F,g)=>F-g);for(const F of C){if(o.length>=i)break;const g=Ea(w.get(F)??[]);for(const d of g){if(o.length>=i)break;o.push(d)}}}const u=rn(o,b,null,j,k),v=u?[u]:[];return u&&k.add(me(u)),{queue:v,meta:{pool:h,active:o,levelMap:b,asked:j,queued:k,wrongSinceCorrect:c}}},mi={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,s)=>Bn(t,n,s),applyOutcome:(t,n,s,r,i)=>{if(!n)return t;const m=Math.max(1,r.levels??1),h=t.meta.pool??[],b=t.meta.active??[],j={...t.meta.levelMap??{}},k=new Set(t.meta.asked??[]),c=new Set(t.meta.queued??[]),x=new Set(t.meta.wrongSinceCorrect??[]),o=me(n);c.delete(o),k.add(o);const u=j[o]??1;i.correct?(j[o]=x.has(o)?1:Math.min(u+1,m),x.delete(o)):(j[o]=1,x.add(o));const v=i.correct?b.filter(F=>me(F)!==o):b.slice();if(i.correct&&v.length<Math.max(1,r.stackSize??1)){const F=new Set(v.map(d=>me(d))),g=ui(h,j,F,k,o);g&&v.push(g)}const w=t.queue.slice(),C=rn(v,j,o,k,c);return C&&(w.push(C),c.add(me(C))),{queue:w,meta:{pool:h,active:v,levelMap:j,asked:k,queued:c,wrongSinceCorrect:x}}}},gi={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,s)=>zn(t,n,s,{},new Set,{}),applyOutcome:(t,n,s,r,i)=>{if(!n)return t;const m=t.meta.pool??[],h=t.meta.active??[],b={...t.meta.knownessMap??{}},j=new Set(t.meta.unknownSet??[]),k={...t.meta.outcomesById??{}},c=new Set(t.meta.asked??[]),x=new Set(t.meta.queued??[]),o=me(n);x.delete(o),c.add(o);const u={correctness:Math.max(0,Math.min(1,i.correctness??(i.correct?1:0))),createdUtc:i.createdUtc??new Date().toISOString()},w=(k[o]??[]).concat(u).sort((K,y)=>K.createdUtc.localeCompare(y.createdUtc)).slice(-5);k[o]=w,j.delete(o);const C=Date.now();m.forEach(K=>{const y=me(K),V=k[y]??[];if(V.length===0){b[y]=0,j.add(y);return}const N=sn(V,C);b[y]=N.knowness});const F=h.slice();if((b[o]??0)>=1){const K=F.filter(y=>me(y)!==o);F.length=0,F.push(...K)}const d=Math.max(1,r.stackSize??s);if(F.length<d){const K=new Set(F.map(V=>me(V))),y=Fs(m,b,j,d-F.length,K);F.push(...y)}const ie=t.queue.slice();if(ie.length===0||me(ie[ie.length-1])===o){const K=rn(F,{},o,c,x);K&&(ie.push(K),x.add(me(K)))}return{queue:ie,meta:{pool:m,active:F,knownessMap:b,unknownSet:j,outcomesById:k,asked:c,queued:x}}}},Ds={random:Mn,levels:mi,temporal:gi},pi=Object.values(Ds),_n=t=>{if(!t)return Mn;const n=t.trim().toLowerCase();return n==="random"||n==="levels"||n==="temporal"?Ds[n]:Mn},on=(t,n)=>{const s={...t.defaultSettings};return n&&Object.entries(n).forEach(([r,i])=>{typeof i=="number"&&Number.isFinite(i)&&(s[r]=i),typeof i=="string"&&(s[r]=i)}),t.settingsFields.forEach(r=>{var m;const i=s[r.key];if(r.type==="number"){if(typeof i!="number"||Number.isNaN(i)){s[r.key]=t.defaultSettings[r.key]??0;return}r.min!==void 0&&(s[r.key]=Math.max(r.min,s[r.key])),r.max!==void 0&&(s[r.key]=Math.min(r.max,s[r.key]));return}if(r.type==="select"){const h=((m=r.options)==null?void 0:m.map(b=>b.value))??[];(typeof i!="string"||h.length>0&&!h.includes(i))&&(s[r.key]=t.defaultSettings[r.key]??h[0]??"")}}),s},zs=(t,n)=>{const s={};return t.settingsFields.forEach(r=>{const i=n.get(r.key);if(i){if(r.type==="number"){const m=Number(i);Number.isNaN(m)||(s[r.key]=m);return}s[r.key]=i}}),on(t,s)},fi=(t,n)=>{const s=new URLSearchParams;return t.settingsFields.forEach(r=>{const i=n[r.key];(typeof i=="number"||typeof i=="string")&&s.set(r.key,String(i))}),s};function bi({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,libraryId:c,collectionId:x,revisionId:o}){const{libraryName:u}=ra(c),v=`/#/cogita/library/${c}`,[w,C]=a.useState(t.cogita.library.collections.defaultName),[F,g]=a.useState(""),[d,ie]=a.useState(20),[K,y]=a.useState("random"),[V,N]=a.useState({}),[Y,z]=a.useState("exact"),[I,ue]=a.useState([]),[re,fe]=a.useState(null),[Ce,be]=a.useState([]),[M,Me]=a.useState("idle"),[J,ee]=a.useState(null),[$e,Te]=a.useState("idle"),[G,ve]=a.useState("idle"),[we,Ve]=a.useState("idle"),Je=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),Ie=a.useMemo(()=>_n(K),[K]),qe=a.useMemo(()=>on(Ie,V),[Ie,V]),Xe=a.useMemo(()=>fi(Ie,qe).toString(),[Ie,qe]);a.useEffect(()=>{nn(c,x).then(ye=>C(ye.name)).catch(()=>C(t.cogita.library.collections.defaultName))},[c,x]),a.useEffect(()=>{o&&ir({libraryId:c,collectionId:x,revisionId:o}).then(ye=>{g(ye.name),y(ye.mode||"random"),z(ye.check||"exact"),ie(ye.limit||20),N(ye.revisionSettings??{})}).catch(()=>{g("")})},[x,c,o]),a.useEffect(()=>{As({libraryId:c}).then(ye=>{ue(ye),!re&&ye.length>0&&fe(ye[0].roleId)}).catch(()=>{ue([])})},[c]);const Ae=()=>{ve("loading"),Rs({libraryId:c}).then(ye=>{be(ye),ve("idle")}).catch(()=>{be([]),ve("error")})};a.useEffect(()=>{Ae()},[c]);const Ge=async()=>{Me("working"),Te("idle");try{const ye=await lr({libraryId:c,collectionId:x,revisionType:Ie.id,revisionSettings:qe,mode:K,check:Y,limit:d});ee(`${Je}/${ye.shareCode}${Xe?`?${Xe}`:""}`),Me("ready"),Ae()}catch{Me("error")}},tt=async()=>{if(o){Ve("saving");try{await or({libraryId:c,collectionId:x,revisionId:o,name:F||w,revisionType:Ie.id,revisionSettings:qe,mode:K,check:Y,limit:d}),Ve("saved")}catch{Ve("error")}}},st=async()=>{if(J)try{await navigator.clipboard.writeText(J),Te("copied")}catch{Te("failed")}},_e=async ye=>{try{await $s({libraryId:c,shareId:ye}),Ae()}catch{Ae()}};return e.jsx(Ft,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:w}),e.jsx("p",{className:"cogita-library-subtitle",children:u})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${v}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${v}/collections/${x}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${v}/collections/${x}/revision/run?mode=${encodeURIComponent(K)}&check=${encodeURIComponent(Y)}&limit=${d}${Xe?`&${Xe}`:""}${re?`&reviewer=${encodeURIComponent(re)}`:""}${o?`&revisionId=${encodeURIComponent(o)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:F,onChange:ye=>g(ye.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:K,onChange:ye=>y(ye.target.value),children:pi.map(ye=>e.jsx("option",{value:ye.id,children:t.cogita.library.revision[ye.labelKey]},ye.id))})]}),Ie.settingsFields.map(ye=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[ye.labelKey]}),ye.type==="select"?e.jsx("select",{value:String(qe[ye.key]??""),onChange:q=>N(Ee=>({...Ee,[ye.key]:q.target.value})),children:(ye.options??[]).map(q=>e.jsx("option",{value:q.value,children:t.cogita.library.revision[q.labelKey]},q.value))}):e.jsx("input",{type:"number",min:ye.min,max:ye.max,step:ye.step,value:qe[ye.key]??0,onChange:q=>N(Ee=>({...Ee,[ye.key]:Number(q.target.value||0)}))})]},ye.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),Ie.id!=="levels"&&Ie.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:d,onChange:ye=>ie(Number(ye.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:re??"",onChange:ye=>fe(ye.target.value||null),children:I.map(ye=>e.jsx("option",{value:ye.roleId,children:ye.label},ye.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[o?e.jsx("button",{type:"button",className:"cta ghost",onClick:tt,disabled:we==="saving",children:we==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${v}/collections/${x}/revision/run?mode=${encodeURIComponent(K)}&check=${encodeURIComponent(Y)}&limit=${d}${Xe?`&${Xe}`:""}${re?`&reviewer=${encodeURIComponent(re)}`:""}${o?`&revisionId=${encodeURIComponent(o)}`:""}`,children:t.cogita.library.actions.startRevision})]}),we==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),J?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:J,readOnly:!0})]}):null,M==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,$e==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):$e==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:Ge,disabled:M==="working",children:M==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),J?e.jsx("button",{type:"button",className:"cta ghost",onClick:st,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),G==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):Ce.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:Ce.map(ye=>e.jsxs("div",{className:"cogita-share-row","data-state":ye.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:ye.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(ye.createdUtc).toLocaleString(),ye.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),ye.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>_e(ye.shareId),children:t.cogita.library.revision.shareRevokeAction})]},ye.shareId))})]})]})]})]})})})]})})}const vn=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function Bs(t,n,s){if(!t)return null;const r=new Map(t.nodes.map(K=>[K.id,K])),i=new Map,m=new Set,h=K=>{if(typeof K=="number")return K;if(typeof K=="string"){const y=Number(K);return Number.isFinite(y)?y:0}return 0},b=K=>{if(i.has(K))return i.get(K);if(m.has(K))return 0;const y=r.get(K);if(!y)return 0;m.add(K);const V=Y=>{var I,ue;return(Y?((I=y.inputsByHandle)==null?void 0:I[Y])??[]:y.inputs??((ue=y.inputsByHandle)==null?void 0:ue.in)??[]).map(re=>b(re))};let N=0;switch(y.type){case"input.random":{const Y=y.min??0,z=y.max??Y+10,I=Math.min(Y,z),ue=Math.max(Y,z);N=Math.floor(Math.random()*(ue-I+1))+I;break}case"input.const":{N=y.value??0;break}case"input.list":{const Y=(y.list??[]).filter(Boolean),z=Math.round(h(V("index")[0]));N=Y.length?Y[Math.max(0,Math.min(Y.length-1,z))]:String(z);break}case"compute.add":{N=V("in").map(z=>h(z)).reduce((z,I)=>z+I,0);break}case"compute.sub":{const Y=V("add").map(I=>h(I)),z=V("sub").map(I=>h(I));N=Y.reduce((I,ue)=>I+ue,0)-z.reduce((I,ue)=>I+ue,0);break}case"compute.mul":{const Y=V("in").map(z=>h(z));N=Y.length?Y.reduce((z,I)=>z*I,1):0;break}case"compute.div":{const Y=h(V("num")[0]),z=V("den").map(I=>h(I)).reduce((I,ue)=>I+ue,0);N=Math.abs(z)<Number.EPSILON?0:Y/z;break}case"compute.pow":{const Y=h(V("base")[0]),z=h(V("exp")[0]);N=Math.pow(Y,z);break}case"compute.exp":{const Y=h(V("base")[0]),z=h(V("exp")[0]);N=Math.pow(Y,z);break}case"compute.log":{const Y=h(V("value")[0]),z=h(V("base")[0]),I=Math.max(Y,Number.EPSILON);N=Math.abs(z)<Number.EPSILON?Math.log(I):Math.log(I)/Math.log(z);break}case"compute.abs":{N=Math.abs(h(V("in")[0]));break}case"compute.min":{const Y=V("in").map(z=>h(z));N=Y.length?Math.min(...Y):0;break}case"compute.max":{const Y=V("in").map(z=>h(z));N=Y.length?Math.max(...Y):0;break}case"compute.floor":{N=Math.floor(h(V("in")[0]));break}case"compute.ceil":{N=Math.ceil(h(V("in")[0]));break}case"compute.round":{N=Math.round(h(V("in")[0]));break}case"compute.mod":{const Y=h(V("a")[0]),z=h(V("b")[0]);N=Math.abs(z)<Number.EPSILON?0:Y%z;break}case"compute.concat":{const z=["in1","in2","in3","in4","in5","in6"].flatMap(fe=>V(fe)),I=z.length?z:V("in");N=(I.length?I:V()).map(fe=>fe==null?"":String(fe)).join("");break}case"compute.trim":{const Y=V("text")[0]??V("in")[0]??"",z=Y==null?"":String(Y),I=Math.max(0,Math.round(h(V("start")[0]))),ue=Math.max(0,Math.round(h(V("end")[0])));I+ue>=z.length?N="":N=z.substring(I,z.length-ue);break}case"output":{N=V("in")[0]??0;break}default:N=0}return m.delete(K),i.set(K,N),N},j=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(K=>K.type==="output").map(K=>K.id);t.nodes.forEach(K=>b(K.id)),j.forEach(K=>b(K));const k=K=>Math.abs(K%1)<1e-5?String(Math.round(K)):K.toFixed(3).replace(/\.?0+$/,""),c=K=>typeof K=="number"?k(K):K??"",x=new Map;j.forEach(K=>{var z,I,ue,re;const y=r.get(K);if(!y)return;const V=(I=(z=y.inputsByHandle)==null?void 0:z.name)==null?void 0:I[0],N=V?c(i.get(V)):"",Y=(N==null?void 0:N.toString().trim())||((ue=y.outputLabel)==null?void 0:ue.trim())||((re=y.name)==null?void 0:re.trim())||K;x.set(K,Y)});const o={},u={},v={};j.forEach(K=>{var N,Y;const y=r.get(K);if(!y)return;const V=x.get(K)??(((N=y.outputLabel)==null?void 0:N.trim())||((Y=y.name)==null?void 0:Y.trim())||K);o[V]=c(i.get(K)),y.name&&(u[y.name.trim()]=V),u[K]=V});const w=(K,y)=>{let V=K;return t.nodes.forEach(N=>{var re,fe;const Y=c(i.get(N.id)),z=j.includes(N.id),I=z?x.get(N.id)??((re=N.outputLabel)==null?void 0:re.trim())??((fe=N.name)==null?void 0:fe.trim())??N.id:"",ue=z&&y?I:Y;V=V.replace(new RegExp(`\\{\\s*${vn(N.id)}\\s*\\}`,"gi"),ue),N.name&&(V=V.replace(new RegExp(`\\{\\s*${vn(N.name)}\\s*\\}`,"gi"),ue)),z&&N.outputLabel&&(V=V.replace(new RegExp(`\\{\\s*${vn(N.outputLabel)}\\s*\\}`,"gi"),I))}),V},C=n;let F=C.trim().length>0?C:"";F||(F=j.length?`Compute ${j.join(", ")}`:"Compute"),F=w(F,!0);const g=(s==null?void 0:s.trim())??"",d=g?w(g,!1):"",ie={};return i.forEach((K,y)=>{ie[y]=K,v[y]=c(K);const V=r.get(y);V!=null&&V.name&&(v[V.name.trim()]=c(K))}),{prompt:F,answers:o,values:ie,answerText:d,outputVariables:u,variableValues:v}}function _s(t){var s;const n=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((s=n[0])==null?void 0:s[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const wn=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function Vs({outcomes:t}){const[n,s]=a.useState("day"),r=a.useMemo(()=>{const i=wn.find(b=>b.id===n)??wn[1],m=Date.now()-i.ms,h=t.filter(b=>new Date(b.createdUtc).getTime()>=m);return Zt(h)},[t,n]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:wn.map(i=>e.jsx("button",{type:"button",className:"ghost","data-active":n===i.id,onClick:()=>s(i.id),children:i.label},i.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[r.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[r.correct," / ",r.total]})]})}const yi="cogita-revision",xi=1,Ya="outcomes",vi=()=>new Promise((t,n)=>{const s=indexedDB.open(yi,xi);s.onupgradeneeded=()=>{const r=s.result;if(!r.objectStoreNames.contains(Ya)){const i=r.createObjectStore(Ya,{keyPath:"id"});i.createIndex("byItem","itemKey",{unique:!1}),i.createIndex("byPending","pending",{unique:!1})}},s.onerror=()=>n(s.error),s.onsuccess=()=>t(s.result)}),Pa=async(t,n)=>{const s=await vi();return new Promise((r,i)=>{const m=s.transaction(Ya,t),h=m.objectStore(Ya);n(h).then(r).catch(i),m.onerror=()=>i(m.error)})},Os=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const n=Array.from(t).map(s=>s.toString(16).padStart(2,"0"));return`${n.slice(0,4).join("")}-${n.slice(4,6).join("")}-${n.slice(6,8).join("")}-${n.slice(8,10).join("")}-${n.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},wi=()=>{const t="cogita_revision_client_id",n=localStorage.getItem(t);if(n)return n;const s=Os();return localStorage.setItem(t,s),s},ji=()=>{const t="cogita_revision_client_seq",n=Number(localStorage.getItem(t)??"0"),s=Number.isFinite(n)?n+1:1;return localStorage.setItem(t,String(s)),s},qs=(t,n,s,r)=>qt(t,n,s,r),Qa=async t=>{const n=wi(),s=ji(),r=new Date().toISOString(),i={...t,clientId:n,clientSequence:s,createdUtc:r,id:Os(),pending:!0};return await Pa("readwrite",m=>new Promise((h,b)=>{const j={...i,itemKey:qs(i.itemType,i.itemId,i.checkType,i.direction)},k=m.add(j);k.onsuccess=()=>h(),k.onerror=()=>b(k.error)})),i},Xa=async(t,n,s,r)=>{if(!n)return[];try{const i=qs(t,n,s,r);return await Pa("readonly",m=>new Promise((h,b)=>{const k=m.index("byItem").getAll(i);k.onsuccess=()=>{const x=(k.result??[]).map(o=>({itemType:o.itemType,itemId:o.itemId,checkType:o.checkType??null,direction:o.direction??null,revisionType:o.revisionType,evalType:o.evalType,correct:o.correct,createdUtc:o.createdUtc,maskBase64:o.maskBase64,payloadBase64:o.payloadBase64,payloadHashBase64:o.payloadHashBase64,clientId:o.clientId,clientSequence:o.clientSequence,personRoleId:o.personRoleId??null})).sort((o,u)=>o.createdUtc.localeCompare(u.createdUtc));h(x)},k.onerror=()=>b(k.error)}))}catch{return[]}},ea=async()=>{try{return await Pa("readonly",t=>new Promise((n,s)=>{const r=t.getAll();r.onsuccess=()=>{const m=(r.result??[]).map(h=>({itemType:h.itemType,itemId:h.itemId,checkType:h.checkType??null,direction:h.direction??null,revisionType:h.revisionType,evalType:h.evalType,correct:h.correct,createdUtc:h.createdUtc,maskBase64:h.maskBase64,payloadBase64:h.payloadBase64,payloadHashBase64:h.payloadHashBase64,clientId:h.clientId,clientSequence:h.clientSequence,personRoleId:h.personRoleId??null}));n(m)},r.onerror=()=>s(r.error)}))}catch{return[]}},ki=async(t=100)=>{try{return await Pa("readonly",n=>new Promise((s,r)=>{const m=n.index("byPending").getAll(!0);m.onsuccess=()=>{const h=m.result??[];s(h.slice(0,t))},m.onerror=()=>r(m.error)}))}catch{return[]}},Ni=async t=>{if(t.length!==0)try{await Pa("readwrite",n=>new Promise((s,r)=>{let i=t.length;t.forEach(m=>{const h=n.get(m);h.onsuccess=()=>{const b=h.result;if(b){b.pending=!1;const j=n.put(b);j.onsuccess=()=>{i-=1,i===0&&s()},j.onerror=()=>r(j.error)}else i-=1,i===0&&s()},h.onerror=()=>r(h.error)})}))}catch{}},jn=async(t,n)=>{const s=await ki(200);if(s.length===0)return;const r=new Map;s.forEach(i=>{var h;const m=i.personRoleId??n??"";r.has(m)||r.set(m,[]),(h=r.get(m))==null||h.push(i)});for(const[i,m]of r.entries()){const h=m.map(b=>({itemType:b.itemType,itemId:b.itemId,checkType:b.checkType??null,direction:b.direction??null,revisionType:b.revisionType,evalType:b.evalType,correct:b.correct,clientId:b.clientId,clientSequence:b.clientSequence,maskBase64:b.maskBase64??null,payloadHashBase64:b.payloadHashBase64??null,payloadBase64:b.payloadBase64??null,personRoleId:i||null}));try{await cr({libraryId:t,outcomes:h}),await Ni(m.map(b=>b.id))}catch{}}},Kt=t=>t.trim().toLowerCase(),_t=t=>{const n=t==null?void 0:t.trim();return n?{fragmentId:n}:null},Za=(t,n)=>{const s=_t(n);if(!s)return!0;const r=_t(t);return(r==null?void 0:r.fragmentId)===s.fragmentId},ft=t=>{const n=t==null?void 0:t.trim().toLowerCase();return n||null},Us=(t,n)=>{if((ft(t.childItemType)??"info")!==(n.cardType??"").toLowerCase()||t.childItemId!==n.cardId)return!1;const r=ft(t.childCheckType),i=ft(t.childDirection),m=ft(n.checkType),h=ft(n.direction);return!(r&&r!==m||i&&i!==h)},Si={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},Ti={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},en=(t,n,s)=>{if(!s||!n.startsWith(t))return n;const r=n.slice(t.length);if(!r)return n;const i=s==="super"?Si:Ti,m=r.split("").map(h=>i[h]??h).join("");return t+m},tn=(t,n,s)=>{var h,b,j;if(!t)return((h=n[0])==null?void 0:h.key)??null;const r=new Set(n.map(k=>k.key)),i=/\{([^}]+)\}/g;let m;for(;(m=i.exec(t))!==null;){const k=((b=m[1])==null?void 0:b.trim())??"";if(!k)continue;if(r.has(k))return k;const c=s==null?void 0:s[k];if(c&&r.has(c))return c}return((j=n[0])==null?void 0:j.key)??null},$a=t=>(()=>{const n=new Set;return t.flatMap(s=>{if(s.cardType!=="info"||s.infoType!=="citation")return[s];const r=s.description??"";if(!r.trim())return[s];const i=ya(r),m=Object.keys(i.nodes);return m.length===0?[s]:m.map(h=>({...s,checkType:"quote-fragment",direction:h})).filter(h=>{const b=[h.cardId,h.checkType??"",h.direction??""].join("|");return n.has(b)?!1:(n.add(b),!0)})})})();function ys({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,libraryId:c,collectionId:x,revisionId:o}){const u=an(),v=`/#/cogita/library/${c}`,w=a.useMemo(()=>new URLSearchParams(u.search),[u.search]),C=Math.max(1,Number(w.get("limit")??20)),F=w.get("mode")??"random",g=a.useMemo(()=>_n(F),[F]),d=a.useMemo(()=>on(g,zs(g,w)),[g,w]),ie=w.get("check")??"exact",K=w.get("reviewer"),y=(w.get("scope")??"").trim(),V=y==="info"||y==="info-selection"?y:"collection",N=V==="info"?(w.get("infoId")??"").trim():"",Y=V==="info-selection"?(w.get("seed")??"").trim():"",z=V==="collection"&&!!x,I=a.useMemo(()=>t.cogita.library.revision[g.labelKey]??F,[t,F,g]),ue=a.useMemo(()=>ie==="exact"?t.cogita.library.revision.checkValue:ie,[t,ie]),[re,fe]=a.useState(t.cogita.library.collections.defaultName),[Ce,be]=a.useState([]),[M,Me]=a.useState([]),[J,ee]=a.useState("idle"),[$e,Te]=a.useState({current:0,total:0}),[G,ve]=a.useState(0),[we,Ve]=a.useState(""),[Je,Ie]=a.useState(null),[qe,Xe]=a.useState(null),[Ae,Ge]=a.useState(null),[tt,st]=a.useState(null),[_e,ye]=a.useState([]),[q,Ee]=a.useState({}),[se,B]=a.useState({}),[he,He]=a.useState(null),[E,R]=a.useState(null),[X,ne]=a.useState(null),[S,O]=a.useState(null),[$,U]=a.useState(null),[ae,ke]=a.useState({}),je=a.useRef(0),[Ke,Ne]=a.useState(null),le=a.useRef(null),oe=a.useRef(null),[We,Ue]=a.useState(null),[at,rt]=a.useState(!1),[vt,Ye]=a.useState(null),[Ze,Nt]=a.useState([]),[St,Tt]=a.useState(null),Lt=a.useRef(null),Et=a.useRef(null),[Ut,bt]=a.useState(null),[ia,ct]=a.useState(0),yt=a.useRef(null),Vt=a.useRef({}),[Rt,Re]=a.useState(!1),[ht,Ct]=a.useState({}),[xt,T]=a.useState([]),ge=a.useRef(new Map),[ze,ut]=a.useState(new Set),[$t,xe]=a.useState(!1),Wt=a.useRef(null),p=a.useRef(new Set),Le=a.useRef({}),H=Ce[G]??null,et=(H==null?void 0:H.checkType)==="translation-match"&&$,gt=a.useRef(new Map),mt=a.useRef(new Map),kt=a.useRef(new Map),Mt=a.useRef(new Map),wt=a.useMemo(()=>H?H.cardType==="vocab"?t.cogita.library.revision.vocabLabel:H.infoType?Qe(t,H.infoType):t.cogita.library.revision.infoLabel:"",[t,H]),na=a.useMemo(()=>{var f;return g.id!=="levels"?Ce.length:((f=ht.pool)==null?void 0:f.length)??g.getFetchLimit(C,d)},[ht,d,g,Ce.length,C]),sa=g.getProgressTotal?g.getProgressTotal(Ce,ht,C,d):g.id==="levels"?Math.min(C,na):Ce.length,jt=sa?Math.min(G+1,sa):0,pt=Math.max(1,Number(d.tries??1)),Gt=d.compare??"anchors",ma=Math.max(0,Math.min(100,Number(d.minCorrectness??0))),dt=(d.considerDependencies??"on")==="on",At=Math.max(0,Math.min(100,Number(d.dependencyThreshold??85))),Ka=l=>{const f=l.slice();for(let P=f.length-1;P>0;P-=1){const _=Math.floor(Math.random()*(P+1));[f[P],f[_]]=[f[_],f[P]]}return f},xa=l=>ha(l,{treatSimilarCharsAsSame:!0})>=ma,Fa=async()=>{const l=await ea(),f=new Map,P=new Map,_=new Map;l.forEach(A=>{const Z=`${A.itemType}:${A.itemId}`,pe=qt(A.itemType,A.itemId,A.checkType,A.direction);if(f.has(Z)||f.set(Z,[]),f.get(Z).push(A),P.has(pe)||P.set(pe,[]),P.get(pe).push(A),A.itemType==="info"&&A.checkType==="quote-fragment"&&A.direction){const De=`${A.itemId}:${A.direction}`;_.has(De)||_.set(De,[]),_.get(De).push(A)}});const Q=new Map,D=new Map,te=new Map;return f.forEach((A,Z)=>Q.set(Z,Zt(A).score)),P.forEach((A,Z)=>D.set(Z,Zt(A).score)),_.forEach((A,Z)=>te.set(Z,Zt(A).score)),{itemKnowness:Q,cardKnowness:D,fragmentKnowness:te}},Jt=async l=>{const f=[];let P=null;for(;;){const _=await Ua({libraryId:c,collectionId:l,limit:200,cursor:P});if(f.push(..._.items),!_.nextCursor)break;P=_.nextCursor}return $a(f)},va=async(l,f)=>{if(ge.current.has(l))return ge.current.get(l)??0;const P=await Jt(l);if(P.length===0)return ge.current.set(l,0),0;const Q=P.reduce((D,te)=>{const A=me(te);return D+(f.get(A)??0)},0)/P.length;return ge.current.set(l,Q),Q},ln=(l,f)=>{if(!dt||l.cardType!=="info"||l.infoType!=="citation"||l.checkType!=="quote-fragment")return!0;const P=_t(l.direction);if(!(P!=null&&P.fragmentId))return!0;const _=l.description??"";if(!_.trim())return!0;const D=ya(_).nodes[P.fragmentId];if(!D||!D.leftId&&!D.rightId)return!0;const te=[D.leftId,D.rightId].filter(pe=>!!pe);if(te.length===0)return!0;const A=te.map(pe=>{const De=qt("info",l.cardId,"quote-fragment",pe);return f.get(De)??0});return A.reduce((pe,De)=>pe+De,0)/A.length>=At},Dt=async l=>{const f=ht,P=l.concat(f.active??[]).concat(f.pool??[]).filter((A,Z,pe)=>pe.findIndex(De=>me(De)===me(A))===Z);if(!dt){ut(new Set(P.map(me)));return}const{itemKnowness:_,cardKnowness:Q}=await Fa(),D=xt.filter(A=>ft(A.childItemType)==="collection"&&A.childItemId===x&&!ft(A.childCheckType)&&!ft(A.childDirection)),te=new Set;for(const A of P){if(A.cardType!=="info"){te.add(me(A));continue}if(!ln(A,Q))continue;const Z=xt.filter(Be=>Us(Be,A)).concat(D);if(Z.length===0){te.add(me(A));continue}let pe=0;for(const Be of Z)if(ft(Be.parentItemType)==="collection")pe+=await va(Be.parentItemId,Q);else if(ft(Be.parentCheckType)||ft(Be.parentDirection)){const Oe=ft(Be.parentCheckType),nt=ft(Be.parentDirection),it=qt(Be.parentItemType,Be.parentItemId,Oe,nt);pe+=Q.get(it)??0}else{const Oe=`${Be.parentItemType}:${Be.parentItemId}`;pe+=_.get(Oe)??0}pe/Z.length>=At&&te.add(me(A))}ut(te)},wa=l=>{for(let f=l;f<Ce.length;f+=1){const P=Ce[f];if(P&&(!dt||P.cardType!=="info"||ze.has(me(P))))return f}return-1},oa=l=>!dt||l.cardType!=="info"||ze.has(me(l)),Da=l=>{if(g.id!=="temporal"&&g.id!=="levels")return null;const f=ht,P=(f.active??[]).concat(f.pool??[]),_=new Set;for(const Q of P){const D=me(Q);if(!(_.has(D)||l.has(D))&&(_.add(D),oa(Q)))return Q}return null},Ot=a.useMemo(()=>{if(g.id!=="levels")return null;const l=ht,f=l.pool??[],P=l.active??[],_=l.levelMap??{},Q=Math.max(1,Number(d.levels??1)),D=Array.from({length:Q},()=>0),te=new Set(P.map(De=>me(De)));f.forEach(De=>{const Be=Math.min(Q,Math.max(1,_[me(De)]??1));D[Be-1]+=1});const A=f.length||1,Z=D.map(De=>De/A*100),pe=H?_[me(H)]??1:null;return{counts:D,percentages:Z,currentLevel:pe,levelsCount:Q,activeCount:P.length,poolCount:f.length,activeSet:te}},[ht,d,g,H]),ja=a.useMemo(()=>{if(g.id!=="temporal")return null;const l=ht,f=l.pool??[],P=l.active??[],_=l.knownessMap??{},Q=new Set(l.unknownSet??[]);let D=0;f.forEach(Z=>{(_[me(Z)]??0)>1&&(D+=1)});const te=Q.size,A=P.map(Z=>({id:me(Z),value:Q.has(me(Z))?0:Math.max(0,Math.min(1,_[me(Z)]??0))}));return{knownCount:D,unknownCount:te,dots:A}},[ht,g]),cn=a.useMemo(()=>{if(!dt)return 0;const l=ht;return Ce.concat(l.active??[]).concat(l.pool??[]).filter((P,_,Q)=>Q.findIndex(D=>me(D)===me(P))===_).filter(P=>P.cardType==="info"&&!ze.has(me(P))).length},[dt,ht,Ce,ze]);a.useEffect(()=>{if(!dt||J!=="ready")return;const l=ht,P=Ce.concat(l.active??[]).concat(l.pool??[]).filter((D,te,A)=>A.findIndex(Z=>me(Z)===me(D))===te).filter(D=>D.cardType!=="info"||ze.has(me(D))).length,_=Lt.current;if(Lt.current=P,_===null||P<=_)return;const Q=P-_;Tt(`New card available (+${Q})`),Et.current&&window.clearTimeout(Et.current),Et.current=window.setTimeout(()=>Tt(null),2200)},[dt,J,ht,Ce,ze]),a.useEffect(()=>()=>{Et.current&&window.clearTimeout(Et.current)},[]);const Pt=(l,f)=>{const P=g.applyOutcome({queue:Ce,meta:ht},H,C,d,{correct:l,correctness:f,createdUtc:new Date().toISOString()});be(P.queue),Ct(P.meta);const _=P.queue[G+1];_&&Ma(_,G+1)};a.useEffect(()=>{if(z&&x){nn(c,x).then(l=>fe(l.name)).catch(()=>fe(t.cogita.library.collections.defaultName));return}if(V==="info"&&N){ta({libraryId:c,infoId:N}).then(l=>{const f=l.payload??{};fe(f.title||f.label||f.name||N)}).catch(()=>fe(N||t.cogita.library.revision.runKicker));return}if(V==="info-selection"){const l=Y?Qn(c,Y):null,f=(l==null?void 0:l.infoIds.length)??0;fe(f>0?`Selected infos (${f})`:"Selected infos");return}fe(t.cogita.library.collections.defaultName)},[t,z,x,c,V,N,Y]),a.useEffect(()=>{En({libraryId:c,type:"language"}).then(l=>Me(l)).catch(()=>Me([]))},[c]),a.useEffect(()=>{z&&An({libraryId:c}).then(l=>T(l.items??[])).catch(()=>T([]))},[z,c]),a.useEffect(()=>{jn(c,K)},[c,K]),a.useEffect(()=>{Dt(Ce)},[Ce,xt,dt,At,x]),a.useEffect(()=>{if(!H||!dt){xe(!1);return}if(H.cardType!=="info"||ze.has(me(H))){xe(!1);return}const l=wa(G+1);if(l>=0){xe(!1),ve(l);return}if(g.id==="temporal"||g.id==="levels"){const f=Ce.slice(0,G+1),P=Ce.slice(G+1).filter(oa),_=f.concat(P),Q=new Set(_.map(me)),D=Da(Q);if(D){const A=me(D);Q.has(A)||(_.push(D),Q.add(A),Ct(Z=>{const pe=Z,De=new Set(pe.queued??[]);return De.add(A),{...pe,queued:De}}))}const te=_.findIndex((A,Z)=>Z!==G&&oa(A));if(te>=0){be(_),ve(te),xe(!1);return}}xe(!0)},[H,ze,dt,G,Ce,ht,g.id]),a.useEffect(()=>{let l=!0;return(async()=>{ee("loading"),Te({current:0,total:g.id==="levels"?0:g.getFetchLimit(C,d)});try{if(!z){if(T([]),V==="info"){if(!N){l&&(be([]),T([]),Ct({}),ve(0),ee("ready"));return}const[Be,Oe]=await Promise.all([Oa({libraryId:c,infoId:N}),qa({libraryId:c,infoId:N})]);if(!l)return;const nt=$a(Be.items??[]);T(Oe.items??[]);const it=g.prepare(nt,C,d);be(it.queue),Ct(it.meta),ve(0),ee("ready"),Te({current:nt.length,total:nt.length});return}if(V==="info-selection"){const Be=Y?Qn(c,Y):null,Oe=(Be==null?void 0:Be.infoIds)??[];if(!Oe.length){l&&(be([]),T([]),Ct({}),ve(0),ee("ready"));return}const nt=await Promise.all(Oe.map(async ca=>{const[Bt,za]=await Promise.all([Oa({libraryId:c,infoId:ca}),qa({libraryId:c,infoId:ca})]);return{cards:Bt.items??[],deps:za.items??[]}}));if(!l)return;const it=new Map;nt.forEach(ca=>{$a(ca.cards).forEach(Bt=>{it.set(me(Bt),Bt)})});const ot=Array.from(it.values()),lt=new Set(ot.map(me)),It=new Map;nt.forEach(ca=>{(ca.deps??[]).forEach(Bt=>{const za=qt(Bt.parentItemType,Bt.parentItemId,ft(Bt.parentCheckType),ft(Bt.parentDirection)),Vn=qt(Bt.childItemType,Bt.childItemId,ft(Bt.childCheckType),ft(Bt.childDirection));if(!lt.has(za)||!lt.has(Vn))return;const On=`${za}->${Vn}`;It.has(On)||It.set(On,Bt)})}),T(Array.from(It.values()));const fa=g.prepare(ot,C,d);be(fa.queue),Ct(fa.meta),ve(0),ee("ready"),Te({current:ot.length,total:ot.length});return}}const P=[];let _=null,Q=null;do{const Be=await Ua({libraryId:c,collectionId:x,limit:300,cursor:_});if(P.push(...Be.items),(g.id==="levels"||g.id==="temporal")&&Be.total&&(Q=Be.total),Te(Oe=>({current:P.length,total:Oe.total||Be.total||g.getFetchLimit(C,d)})),_=Be.nextCursor??null,Q!==null&&P.length>=Q||g.id!=="levels"&&g.id!=="temporal"&&P.length>=g.getFetchLimit(C,d))break}while(_);if(!l)return;const D=$a(P);let te;if(g.id==="levels"){const Be=Math.max(1,Number(d.levels??1)),nt=(await ea()).reduce((it,ot)=>{const lt=qt(ot.itemType,ot.itemId,ot.checkType,ot.direction);return it[lt]||(it[lt]=[]),it[lt].push(ot),it},{});te={},D.forEach(it=>{const ot=me(it),lt=nt[ot]??[],It=lt.length>0?Zt(lt).score:0,fa=Math.max(1,Math.min(Be,Math.ceil(It/100*Be)));te[ot]=fa})}let A=null,Z=null,pe=null;if(g.id==="temporal"){const Be=await ea(),Oe=new Set(D.map(ot=>me(ot))),nt=Be.reduce((ot,lt)=>{const It=qt(lt.itemType,lt.itemId,lt.checkType,lt.direction);return Oe.has(It)&&(ot[It]||(ot[It]=[]),ot[It].push(lt)),ot},{});A={},Z=new Set,pe={};const it=Date.now();D.forEach(ot=>{const lt=me(ot),It=nt[lt]??[];if(It.length===0){A[lt]=0,Z.add(lt),pe[lt]=[];return}const fa=Dn(It);pe[lt]=fa;const ca=sn(fa,it);A[lt]=ca.knowness})}const De=g.id==="levels"?Bn(D,C,d,te):g.id==="temporal"?zn(D,C,d,A??{},Z??new Set,pe??{}):g.prepare(D,C,d);be(De.queue),Ct(De.meta),ve(0),ee("ready"),Te(Be=>({current:Math.min(Be.current,Be.total),total:Be.total}))}catch{l&&ee("error")}})(),()=>{l=!1}},[x,z,c,C,V,d,g,K,N,Y]),a.useEffect(()=>{if(Ve(""),Ie(null),bt(null),ct(0),ye([]),Ee({}),B({}),R(null),ne(null),O(null),rt(!1),Re(!1),Ue(null),U(null),ke({}),!H){Xe(null),Ge(null),He(null),Ye(null);return}H.cardType==="info"&&H.infoType==="computed"&&Xe(t.cogita.library.revision.loadingComputed);let l=!0;return Ma(H,G).then(f=>{!l||!f||(Xe(f.prompt),Ge(f.expectedAnswer),ye(f.computedExpected),Ee(f.computedAnswers),He(f.computedValues),R(f.answerTemplate),ne(f.outputVariables),O(f.variableValues))}),()=>{l=!1}},[H,t]),a.useEffect(()=>{if(!H||H.cardType!=="info"||H.infoType!=="citation"){Wt.current=null,p.current=new Set,st(null);return}const l=H.description??"",f=(H.label??"").trim(),P=f.replace(/\s+/g," ").trim(),_=l.replace(/\s+/g," ").trim(),Q=P&&P!==_?f:t.cogita.library.infoTypes.citation;if(!l){st(null),Ge(null);return}const D=ya(l);Wt.current=D,Xe(Q);let te=!0;return Fa().then(({fragmentKnowness:A})=>{if(!te)return;const Z=new Set,pe={};A.forEach((Oe,nt)=>{const[it,ot]=nt.split(":",2);if(it!==H.cardId)return;const lt=_t(ot);if(!lt)return;const{fragmentId:It}=lt;pe[It]=Oe,Oe>=At&&Z.add(It)}),p.current=Z,Le.current=pe;const De=_t(H.direction);if(De!=null&&De.fragmentId&&D.nodes[De.fragmentId]){pa(D,De.fragmentId,Q);return}const Be=Ta(D,Z,pe,At,dt,H.direction);pa(D,(Be==null?void 0:Be.id)??null,Q)}).catch(()=>{p.current=new Set,Le.current={};const A=_t(H.direction);if(A!=null&&A.fragmentId&&D.nodes[A.fragmentId]){pa(D,A.fragmentId,Q);return}const Z=Ta(D,p.current,{},At,dt,H.direction);pa(D,(Z==null?void 0:Z.id)??null,Q)}),()=>{te=!1}},[H,t,dt,At]),a.useEffect(()=>{if(!H||H.cardType!=="vocab"||H.checkType!=="translation-match"){U(null),ke({});return}const P=(ht.pool??ht.active??Ce).filter(A=>A.cardType==="vocab"&&A.checkType==="translation-match").filter((A,Z,pe)=>pe.findIndex(De=>De.cardId===A.cardId)===Z);P.some(A=>A.cardId===H.cardId)||P.unshift(H);const Q=Ka(P).slice(0,6).map(A=>{const Z=A.label.split("↔").map(Be=>Be.trim()).filter(Boolean);if(Z.length<2)return null;const pe=`${A.cardId}:L`,De=`${A.cardId}:R`;return{cardId:A.cardId,leftId:pe,rightId:De,leftLabel:Z[0],rightLabel:Z[1]}}).filter(Boolean),D=Q.map(A=>A.leftId),te=Ka(Q.map(A=>A.rightId));U({pairs:Q,leftOrder:D,rightOrder:te,selection:{},activeLeft:null,activeRight:null,locked:{}})},[H,Ce,ht]),a.useEffect(()=>()=>{le.current&&window.clearTimeout(le.current),oe.current&&window.clearTimeout(oe.current)},[]);const zt=a.useRef(null);a.useEffect(()=>{if(!H)return;const l=me(H),f=typeof document<"u"?document.activeElement:null;if(zt.current===l&&f&&(f.tagName==="INPUT"||f.tagName==="TEXTAREA"))return;let P=0;const _=()=>{if(H){if(H.cardType==="info"&&H.infoType==="computed"){if(_e.length>0){const D=tn(E,_e,X),te=D?Vt.current[D]:null;if(te&&(te.focus(),document.activeElement===te)){zt.current=l;return}}if(yt.current&&(yt.current.focus(),document.activeElement===yt.current)){zt.current=l;return}}else if(H.cardType==="vocab"&&yt.current&&(yt.current.focus(),document.activeElement===yt.current)){zt.current=l;return}P<6&&(P+=1,window.setTimeout(_,40))}},Q=window.setTimeout(_,40);return()=>window.clearTimeout(Q)},[H,_e,E,X]),a.useEffect(()=>{if(!Rt)return;const l=f=>{f.key==="Enter"&&(f.preventDefault(),ga())};return window.addEventListener("keydown",l),()=>window.removeEventListener("keydown",l)},[Rt]);const ka=l=>{Nt(l),Ye(Zt(l))};a.useEffect(()=>{if(!H){Ye(null),Nt([]);return}const l=H.cardType==="info"?"info":"connection";if(H.cardType==="info"&&H.infoType==="citation"){ea().then(f=>{const P=f.filter(_=>_.itemType==="info"&&_.itemId===H.cardId&&_.checkType==="quote-fragment"&&Za(_.direction,H.direction));ka(P)}).catch(()=>{Ye(null),Nt([])});return}Xa(l,H.cardId,H.checkType,H.direction).then(f=>ka(f)).catch(()=>{Ye(null),Nt([])})},[c,H,K]);const Na=(l,f,P,_)=>{if(l==="info"&&P==="quote-fragment"){ea().then(Q=>{const D=Q.filter(te=>te.itemType==="info"&&te.itemId===f&&te.checkType==="quote-fragment"&&Za(te.direction,_));ka(D)}).catch(()=>{Ye(null),Nt([])});return}Xa(l,f,P,_).then(Q=>ka(Q)).catch(()=>{Ye(null),Nt([])})},la=(l,f,P)=>{var te;const _=((te=P.pairs.find(A=>A.leftId===l))==null?void 0:te.rightId)??null;if(!_)return P;const Q=_===f;ke(A=>({...A,[l]:Q?"correct":"incorrect"})),le.current&&window.clearTimeout(le.current),oe.current&&window.clearTimeout(oe.current),je.current+=1;const D={kind:Q?"correct":"incorrect",tick:je.current};if(Ne(null),le.current=window.setTimeout(()=>Ne(D),0),oe.current=window.setTimeout(()=>Ne(null),420),Q){const A={...P.locked,[l]:!0};return Object.keys(A).length>=P.pairs.length?(Ie("correct"),Re(!0)):Ie("correct"),{...P,selection:{...P.selection,[l]:f},activeLeft:null,activeRight:null,locked:A}}return Ie("incorrect"),{...P,activeLeft:null,activeRight:null}},dn=l=>{U(f=>!f||f.locked[l]?f:f.activeRight?la(l,f.activeRight,f):{...f,activeLeft:f.activeLeft===l?null:l})},Sa=l=>{U(f=>f&&(f.activeLeft?la(f.activeLeft,l,f):{...f,activeRight:f.activeRight===l?null:l}))},ga=()=>{var l;if(H&&H.cardType==="info"&&H.infoType==="citation"&&Wt.current&&tt&&!((l=_t(H.direction))!=null&&l.fragmentId)){const f=Ta(Wt.current,p.current,Le.current,At,dt,H.direction,tt.fragmentId);if(f){Ie(null),Ve(""),rt(!1),B({}),Re(!1),bt(null),ct(0),pa(Wt.current,f.id,tt.title);return}}Ie(null),Ve(""),rt(!1),B({}),Re(!1),bt(null),ct(0),ve(f=>Math.min(f+1,Ce.length))},Ht=l=>{if(!H)return;const f=l.expected??null,P=l.answer??"";let _=f??"",Q=P;if(!f&&l.expectedMap&&l.answerMap){const Be=Object.keys(l.expectedMap).sort((Oe,nt)=>Oe.localeCompare(nt));_=Be.map(Oe=>{var nt;return((nt=l.expectedMap)==null?void 0:nt[Oe])??""}).join("|"),Q=Be.map(Oe=>{var nt;return((nt=l.answerMap)==null?void 0:nt[Oe])??""}).join("|")}const D=_?Ca(_,Q,Gt):new Uint8Array,te={revisionType:g.id,evalType:l.evalType,direction:l.direction,prompt:qe??"",expected:f,answer:P,expectedAnswers:l.expectedMap??null,answers:l.answerMap??null,correct:l.correct,maskBase64:D.length?ua(D):null,values:he??null,checkMode:ie,compareMode:Gt,minCorrectness:ma},A=new TextEncoder().encode(JSON.stringify(te)),Z=H.cardType==="info"?"info":"connection",pe=l.overrideCheckType??H.checkType??null,De=l.overrideDirection??H.direction??null;Qa({itemType:Z,itemId:H.cardId,checkType:pe,direction:De,revisionType:g.id,evalType:l.evalType,correct:l.correct,maskBase64:D.length?ua(D):null,payloadBase64:ua(A),personRoleId:K??null}).then(()=>{Na(Z,H.cardId,pe,De),Dt(Ce),jn(c,K)}).catch(()=>{})},un=(l,f)=>{const P=gt.current.get(f);if(P)return Promise.resolve(P);const _=mt.current.get(f);if(_)return _;const Q=ta({libraryId:c,infoId:l}).then(D=>{var Be,Oe;const te=D.payload,A=((Be=te.definition)==null?void 0:Be.graph)??null,Z="",pe=((Oe=te.definition)==null?void 0:Oe.answerTemplate)??"",De=Bs(A,Z,pe);if(De){const it={sample:_s(De),answerTemplate:pe||null};return gt.current.set(f,it),it}return Hn({libraryId:c,infoId:l}).then(nt=>{const it={sample:nt,answerTemplate:null};return gt.current.set(f,it),it})}).catch(()=>Hn({libraryId:c,infoId:l}).then(D=>{const te={sample:D,answerTemplate:null};return gt.current.set(f,te),te}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{mt.current.delete(f)});return mt.current.set(f,Q),Q},Ma=(l,f)=>{var A;const P=`${me(l)}:${f}`,_=kt.current.get(P);if(_)return Promise.resolve(_);const Q=Mt.current.get(P);if(Q)return Q;const D=Z=>(kt.current.set(P,Z),Z);let te;if(l.cardType==="vocab"){if(l.checkType==="translation-match")return te=Promise.resolve(D({prompt:l.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),te;const Z=l.label.split("↔").map(pe=>pe.trim()).filter(Boolean);if(Z.length>=2){const De=(l.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",Be=De?Z[0]:Z[1],Oe=De?Z[1]:Z[0];te=Promise.resolve(D({prompt:Be,expectedAnswer:Oe,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else te=Promise.resolve(D({prompt:l.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(l.cardType==="info"&&l.infoType==="word"){const Z=(A=l.description)!=null&&A.startsWith("Language: ")?l.description.replace("Language: ",""):null;te=Promise.resolve(D({prompt:l.label,expectedAnswer:Z,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else l.cardType==="info"&&l.infoType==="computed"?te=un(l.cardId,P).then(Z=>{var nt,it;if(!Z.sample)return D({prompt:l.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const pe=Z.sample,De=pe.expectedAnswers?Object.entries(pe.expectedAnswers).map(([ot,lt])=>({key:ot,expected:lt})):[],Be=De.reduce((ot,lt)=>(ot[lt.key]="",ot),{}),Oe=pe.expectedAnswerIsSentence&&((nt=pe.expectedAnswer)==null?void 0:nt.trim())||null;return D({prompt:pe.prompt,expectedAnswer:De.length>0?Oe:((it=pe.expectedAnswer)==null?void 0:it.trim())||null,computedExpected:De,computedAnswers:Be,computedValues:pe.values??null,answerTemplate:Z.answerTemplate,outputVariables:pe.outputVariables??null,variableValues:pe.variableValues??null})}).catch(()=>D({prompt:l.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Mt.current.delete(P)}):te=Promise.resolve(D({prompt:l.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return Mt.current.set(P,te),te},pa=(l,f,P)=>{const _=Object.keys(l.nodes).length,Q=p.current.size;if(!f){st({title:P,before:l.text,after:"",fragmentId:null,total:_,completed:Q}),Ge(null),Re(!0);return}const D=l.nodes[f];if(!D)return;const te=Pn(l.text,D);st({title:P,before:te.before,after:te.after,fragmentId:D.id,total:_,completed:Q}),Ge(te.fragment),Re(!1)},hn=()=>{const l=Wt.current;l&&st(f=>f&&{...f,total:Object.keys(l.nodes).length,completed:p.current.size})},Yt=()=>{const l=Ce[G+1];l&&Ma(l,G+1)},L=()=>{if(Yt(),H&&H.cardType==="vocab"&&H.checkType==="translation-match"&&$){if($.pairs.length===0){Ie("incorrect"),Re(!0);return}const D=$.pairs.reduce((Oe,nt)=>(Oe[nt.rightId]=nt.rightLabel,Oe),{});let te=0;const A={};$.pairs.forEach(Oe=>{const it=$.selection[Oe.leftId]===Oe.rightId;A[Oe.leftId]=it?"correct":"incorrect",it&&(te+=1)});const Z=$.pairs.length||1,pe=te/Z,De=te===$.pairs.length;ke(Oe=>({...Oe,...A})),De?(Ie("correct"),Re(!0),ct(0)):(Ie("incorrect"),Re(!1),ct(Oe=>{const nt=Oe+1;return nt>=pt&&(rt(!0),Re(!0),U(it=>{if(!it)return it;const ot=it.pairs.reduce((lt,It)=>(lt[It.leftId]=It.rightId,lt),{});return{...it,selection:ot}})),nt})),Pt(De,pe);const Be="connection";Promise.all($.pairs.map(Oe=>{const nt=$.selection[Oe.leftId]??null,it=nt?D[nt]:"",ot={left:Oe.leftLabel,expected:Oe.rightLabel,answer:it,checkType:"translation-match"},lt=new TextEncoder().encode(JSON.stringify(ot));return Qa({itemType:Be,itemId:Oe.cardId,checkType:"translation-match",direction:null,revisionType:g.id,evalType:"translation-match",correct:nt===Oe.rightId,maskBase64:null,payloadBase64:ua(lt),personRoleId:K??null})})).then(()=>{Na(Be,H.cardId,H.checkType,H.direction),jn(c,K)}).catch(()=>{});return}if(_e.length>0){const D=_e.reduce((A,Z)=>{const pe=q[Z.key]??"";return A[Z.key]=Kt(pe)===Kt(Z.expected)?"correct":"incorrect",A},{});_e.every(({key:A,expected:Z})=>{const pe=q[A]??"";return ie==="exact"&&Kt(pe)===Kt(Z)})?(Ie("correct"),B(D),Re(!0),ct(0),Pt(!0,1),Ht({correct:!0,direction:qe?`${qe} -> computed`:"computed",expectedMap:_e.reduce((A,Z)=>(A[Z.key]=Z.expected,A),{}),answerMap:q,evalType:"computed"})):(Ie("incorrect"),B(D),Re(!1),ct(A=>{const Z=A+1;return Z>=pt&&Se&&(rt(!0),Re(!0)),Z}),Pt(!1,0),window.setTimeout(()=>{var Z;const A=tn(E,_e,X);A&&Vt.current[A]&&((Z=Vt.current[A])==null||Z.focus())},40),Ht({correct:!1,direction:qe?`${qe} -> computed`:"computed",expectedMap:_e.reduce((A,Z)=>(A[Z.key]=Z.expected,A),{}),answerMap:q,evalType:"computed"}));return}if(H&&H.cardType==="info"&&H.infoType==="citation"&&(tt!=null&&tt.fragmentId)){if(!Ae)return;const D=_t(H.direction),te=(D==null?void 0:D.fragmentId)??tt.fragmentId,A=Ga(Ae,we,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Z=A.mask,pe=A.isCorrect,De=A.percent;pe?(Le.current[tt.fragmentId]=Math.max(Le.current[tt.fragmentId]??0,De),(Le.current[tt.fragmentId]??0)>=At&&p.current.add(tt.fragmentId),hn(),Ie("correct"),B({}),Re(!0),bt(Z),ct(0),De<100&&pt<=1&&rt(!0),Pt(!0,De/100),Ht({correct:!0,direction:`quote:${tt.fragmentId}`,expected:Ae,answer:we,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:te})):(Ie("incorrect"),B({}),Re(!1),bt(Z),ct(Be=>{const Oe=Be+1;return Oe>=pt&&Se&&(rt(!0),Re(!0)),Oe}),Pt(!1,De/100),window.setTimeout(()=>{var Be;return(Be=yt.current)==null?void 0:Be.focus()},40),Ht({correct:!1,direction:`quote:${tt.fragmentId}`,expected:Ae,answer:we,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:te}));return}if(!Ae)return;const l=Ca(Ae,we,Gt),f=ie==="exact"&&Kt(we)===Kt(Ae),P=xa(l),_=f||P,Q=ha(l);_?(Ie("correct"),B({}),Re(!0),bt(l),ct(0),Q<100&&pt<=1&&rt(!0),Pt(!0,Q/100),Ht({correct:!0,direction:qe?`${qe} -> ${Ae}`:null,expected:Ae,answer:we,evalType:"text"})):(Ie("incorrect"),B({}),Re(!1),bt(l),ct(D=>{const te=D+1;return te>=pt&&Se&&(rt(!0),Re(!0)),te}),Pt(!1,Q/100),window.setTimeout(()=>{var D;return(D=yt.current)==null?void 0:D.focus()},40),Ht({correct:!1,direction:qe?`${qe} -> ${Ae}`:null,expected:Ae,answer:we,evalType:"text"}))},W=l=>{if(Yt(),!Ae)return;const f=Ca(Ae,l,Gt),P=Kt(l)===Kt(Ae),_=xa(f),Q=P||_,D=ha(f);Q?(Ie("correct"),B({}),Re(!0),bt(f),ct(0),D<100&&pt<=1&&rt(!0),Pt(!0,D/100),Ht({correct:!0,direction:"word->language",expected:Ae,answer:l,evalType:"language-select"})):(Ie("incorrect"),B({}),Re(!1),bt(f),ct(te=>{const A=te+1;return A>=pt&&Se&&(rt(!0),Re(!0)),A}),Pt(!1,D/100),Ht({correct:!1,direction:"word->language",expected:Ae,answer:l,evalType:"language-select"}))},de=()=>{Yt(),Ie("correct"),Re(!0),ct(0),Pt(!0,1),Ae&&Ht({correct:!0,direction:"manual",expected:Ae,answer:we,evalType:"manual"})},Pe=()=>{if(Pt(!1,0),H&&H.cardType==="info"&&H.infoType==="citation"){Ie(null),Ve(""),rt(!1),B({}),Re(!1),bt(null),ct(0),ve(l=>Math.min(l+1,Ce.length));return}ga()};a.useEffect(()=>{Yt()},[G,Ce]);const Fe=l=>{var P;if(l.key!=="Enter")return;if(l.preventDefault(),l.stopPropagation(),Rt){ga();return}const f=_e.find(_=>!(q[_.key]??"").trim());if(f){(P=Vt.current[f.key])==null||P.focus();return}L()},ce=t.cogita.library.revision.revealModeAfterIncorrect,Se=_e.length>0||!!Ae;return e.jsxs(Ft,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,children:[J==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${$e.total?Math.min(100,Math.max(0,$e.current/$e.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:$e.total?`${Math.min($e.current,$e.total)} / ${$e.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:re}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",I).replace("{check}",ue)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),z?e.jsxs(e.Fragment,{children:[e.jsx("a",{className:"cta ghost",href:`${v}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${v}/collections/${x}`,children:t.cogita.library.actions.collectionDetail})]}):e.jsx("a",{className:"cta ghost",href:`${v}/list`,children:t.cogita.library.actions.allCards})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:vt?`${vt.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Ot?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Ot.currentLevel??"-"," / ",Ot.levelsCount]}):null,vt?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(vt.correct)).replace("{total}",String(vt.total))}),vt.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(vt.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(Vs,{outcomes:Ze})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[St?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:St})}):null,e.jsx(Kn,{feedbackToken:Ke?`${Ke.kind}-${Ke.tick}`:et?"idle":Je??"idle",children:H?e.jsx(e.Fragment,{children:$t?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(Fn,{copy:t,currentCard:H,currentTypeLabel:wt,prompt:qe,languages:M,answer:we,onAnswerChange:l=>Ve(f=>en(f,l,We)),computedExpected:_e,computedAnswers:q,onComputedAnswerChange:(l,f)=>Ee(P=>({...P,[l]:en(P[l]??"",f,We)})),answerTemplate:E,outputVariables:X,variableValues:S,computedFieldFeedback:se,feedback:Je,canAdvance:Rt,quoteContext:tt,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:L,onSkip:Pe,onLanguageSelect:W,onMarkReviewed:de,onAdvance:ga,showCorrectAnswer:at,setShowCorrectAnswer:rt,onRevealCorrect:()=>Re(!0),answerMask:Ut,expectedAnswer:Ae,hasExpectedAnswer:Se,handleComputedKeyDown:Fe,answerInputRef:yt,computedInputRefs:Vt,scriptMode:We,setScriptMode:Ue,matchPairs:$==null?void 0:$.pairs,matchLeftOrder:$==null?void 0:$.leftOrder,matchRightOrder:$==null?void 0:$.rightOrder,matchSelection:$==null?void 0:$.selection,matchActiveLeft:$==null?void 0:$.activeLeft,matchActiveRight:$==null?void 0:$.activeRight,matchFeedback:ae,onMatchLeftSelect:dn,onMatchRightSelect:Sa})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:z?`${v}/collections/${x}`:`${v}/list`,children:z?t.cogita.library.actions.collectionDetail:t.cogita.library.actions.allCards})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:sa?`${jt} / ${sa}`:t.cogita.library.revision.progressUnlimited}),J==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),J==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),J==="ready"&&Ce.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:ce}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",pt]})]})]}),Ot?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Ot.activeCount," / ",Ot.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Ot.counts.map((l,f)=>{const P=f+1,_=Ot.currentLevel===P,Q=Ot.percentages[f]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":_,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:P}),e.jsx("strong",{children:l})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,Q))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[Q.toFixed(1),"%"]})]},`level-${P}`)})})]}):null,ja?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:ja.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:ja.dots.map(l=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,l.value*100))}%`,background:`rgba(${Math.round(255*(1-l.value))}, ${Math.round(200*l.value)}, 80, 0.9)`}},l.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:ja.knownCount})]})]}):null,dt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:cn})]})}):null]})]})]})})})]})]})}const kn=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],Ci={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},Mi=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Ii=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function Li({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,libraryId:c,collectionId:x}){const[o,u]=a.useState(""),[v,w,C]=ws([]),[F,g,d]=js([]),[ie,K]=a.useState(null),[y,V]=a.useState(null),[N,Y]=a.useState(null),z=`/#/cogita/library/${c}`;a.useEffect(()=>{nn(c,x).then(M=>u(M.name)).catch(()=>u(t.cogita.library.collections.defaultName))},[c,x,t]),a.useEffect(()=>{dr({libraryId:c,collectionId:x}).then(M=>{if(!M.graphId||M.graphId==="00000000-0000-0000-0000-000000000000"){w([]),g([]);return}const Me=M.nodes.map(ee=>{var ve;const $e=ee.payload??{},Te=$e.position??{x:120,y:120},G=$e.params??{};return{id:ee.nodeId,type:"default",position:Te,data:{nodeType:ee.nodeType,label:((ve=kn.find(we=>we.type===ee.nodeType))==null?void 0:ve.label)??ee.nodeType,params:G}}}),J=M.edges.map(ee=>({id:ee.edgeId,source:ee.fromNodeId,target:ee.toNodeId,sourceHandle:ee.fromPort??void 0,targetHandle:ee.toPort??void 0}));w(Me),g(J)}).catch(()=>{w([]),g([])})},[c,x,g,w]);const I=a.useMemo(()=>v.find(M=>M.id===ie)??null,[v,ie]),ue=M=>{var $e;const Me=crypto.randomUUID(),J=(($e=kn.find(Te=>Te.type===M))==null?void 0:$e.label)??M,ee={...Ci[M]};w(Te=>[...Te,{id:Me,type:"default",position:{x:120+Te.length*40,y:120+Te.length*40},data:{nodeType:M,label:J,params:ee}}]),K(Me)},re=a.useCallback(M=>{g(Me=>ks({...M,id:crypto.randomUUID()},Me))},[g]),fe=async()=>{V(null);try{await hr({libraryId:c,collectionId:x,nodes:v.map(M=>({nodeId:M.id,nodeType:M.data.nodeType,payload:{position:M.position,params:M.data.params}})),edges:F.map(M=>({edgeId:M.id,fromNodeId:M.source,fromPort:M.sourceHandle??null,toNodeId:M.target,toPort:M.targetHandle??null}))}),V(t.cogita.library.graph.saveSuccess)}catch{V(t.cogita.library.graph.saveFail)}},Ce=async()=>{try{const M=await ur({libraryId:c,collectionId:x});Y(M)}catch{Y(null)}},be=M=>{I&&w(Me=>Me.map(J=>J.id===I.id?{...J,data:{...J.data,params:M}}:J))};return e.jsx(Ft,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:o}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${z}/collections/${x}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Ce,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:fe,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:kn.map(M=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>ue(M.type),children:M.label},M.type))}),y?e.jsx("p",{className:"cogita-help",children:y}):null,N&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(N.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(N.connections)).replace("{infos}",String(N.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(Ln,{nodes:v,edges:F,onNodesChange:C,onEdgesChange:d,onConnect:re,onNodeClick:(M,Me)=>K(Me.id),fitView:!0,children:[e.jsx(Rn,{color:"rgba(120,160,200,0.2)"}),e.jsx($n,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),I?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:I.data.label}),I.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(aa,{libraryId:c,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:I.data.params.tagId?{id:I.data.params.tagId,label:I.data.params.tagLabel??"",infoType:"topic"}:null,onChange:M=>be({...I.data.params,tagId:(M==null?void 0:M.id)??null,tagLabel:(M==null?void 0:M.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:I.data.params.scope??"any",onChange:M=>be({...I.data.params,scope:M.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),I.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(aa,{libraryId:c,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:I.data.params.languageId?{id:I.data.params.languageId,label:I.data.params.languageLabel??"",infoType:"language"}:null,onChange:M=>be({...I.data.params,languageId:(M==null?void 0:M.id)??null,languageLabel:(M==null?void 0:M.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:I.data.params.scope??"any",onChange:M=>be({...I.data.params,scope:M.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),I.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:I.data.params.infoType??"word",onChange:M=>be({...I.data.params,infoType:M.target.value}),children:Ii.map(M=>e.jsx("option",{value:M.value,children:M.label},M.value))})]}),e.jsx(aa,{libraryId:c,infoType:I.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:I.data.params.infoId?{id:I.data.params.infoId,label:I.data.params.infoLabel??"",infoType:I.data.params.infoType??"word"}:null,onChange:M=>be({...I.data.params,infoId:(M==null?void 0:M.id)??null,infoLabel:(M==null?void 0:M.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),I.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:I.data.params.connectionType??"translation",onChange:M=>be({...I.data.params,connectionType:M.target.value}),children:Mi.map(M=>e.jsx("option",{value:M.value,children:M.label},M.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:I.data.params.connectionId??"",onChange:M=>be({...I.data.params,connectionId:M.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(I.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const Nn="cogita.preferences",Sn="cogita.reviewer.preferences",Js=["library_overview","all_cards","all_collections","all_revisions","storyboards","texts","dependencies","transfer"],Tn={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},all_revisions:{requiresCollection:!0,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},xs=["settings","run","shared"];function Ri(t,n=""){const s=t.split("/").filter(Boolean);if(s[0]!=="cogita"||s[1]!=="library")return{};const r=s[2];if(!r)return{};if(!s[3])return{libraryId:r,target:"library_overview"};const i=new URLSearchParams(n),m=i.get("revisionId")??void 0,h=i.get("infoId")??void 0,b=i.get("infoView")==="cards"?"cards":"overview",j=i.get("collectionAction"),k=i.get("libraryAction"),x=i.get("libraryTarget")==="revisions"?"all_revisions":"all_collections";if(s[3]==="list")return{libraryId:r,target:k==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:m,infoId:h,infoView:b,libraryAction:k==="new-info"?"new-info":void 0};if(s[3]==="detail"||s[3]==="collection")return{libraryId:r,target:"all_cards",cardMode:s[3],revisionId:m,infoId:h,infoView:b};if(s[3]==="new"||s[3]==="add")return{libraryId:r,target:"new_card",revisionId:m,libraryAction:"new-info"};if(s[3]==="edit")return{libraryId:r,target:"new_card",revisionId:m,infoId:s[4]};if(s[3]==="infos"){const u=s[4];return u?s[5]==="checkcards"?{libraryId:r,target:"all_cards",cardMode:"list",revisionId:m,infoId:u,infoView:"cards"}:{libraryId:r,target:"all_cards",cardMode:"list",revisionId:m,infoId:u,infoView:"overview"}:{libraryId:r,target:"all_cards",cardMode:"list",revisionId:m}}if(s[3]==="shared-revisions")return{libraryId:r,target:x,revisionId:m};if(s[3]==="revision"&&s[4]==="run")return{libraryId:r,target:x,revisionView:"run",revisionId:m,infoId:h,infoView:b};if(s[3]==="dependencies")return{libraryId:r,target:"dependencies"};if(s[3]==="transfer")return{libraryId:r,target:"transfer"};if(s[3]==="storyboards")return s[4]==="new"?{libraryId:r,target:"new_storyboard"}:{libraryId:r,target:"storyboards"};if(s[3]==="texts")return s[4]==="new"?{libraryId:r,target:"new_text"}:{libraryId:r,target:"texts"};if(s[3]!=="collections")return{libraryId:r,target:"library_overview"};if(s[4]==="new")return{libraryId:r,target:"new_collection",revisionId:m};const o=s[4];return o?s[5]==="graph"?{libraryId:r,target:x,collectionId:o,revisionId:m,revisionView:"graph"}:s[5]==="shared-revisions"?{libraryId:r,target:x,collectionId:o,revisionId:m,revisionView:"shared"}:s[5]==="revision"?{libraryId:r,target:x,collectionId:o,revisionId:m,revisionView:s[6]==="run"?"run":"settings"}:j==="new-revision"?{libraryId:r,target:x,collectionId:o,revisionId:m,revisionView:"new"}:{libraryId:r,target:x,collectionId:o,revisionId:m,revisionView:"detail"}:j==="new-collection"?{libraryId:r,target:"new_collection",collectionAction:"new-collection"}:{libraryId:r,target:x}}function vs(t,n="library_overview",s,r,i,m,h="overview"){const b=(j,k)=>{const c=new URLSearchParams;k!=null&&k.revisionId&&c.set("revisionId",k.revisionId),k!=null&&k.collectionAction&&c.set("collectionAction",k.collectionAction),k!=null&&k.libraryAction&&c.set("libraryAction",k.libraryAction),k!=null&&k.libraryTarget&&c.set("libraryTarget",k.libraryTarget),k!=null&&k.infoId&&c.set("infoId",k.infoId),k!=null&&k.infoView&&(k!=null&&k.infoId)&&c.set("infoView",k.infoView);const x=c.toString();return x?`${j}?${x}`:j};if(!t)return"/cogita";if(n==="library_overview")return b(`/cogita/library/${t}`,{revisionId:i});if(n==="all_cards")return m?h==="cards"?b(`/cogita/library/${t}/infos/${m}/checkcards`,{revisionId:i}):b(`/cogita/library/${t}/infos/${m}`,{revisionId:i}):b(`/cogita/library/${t}/list`,{revisionId:i,infoId:m,infoView:h});if(n==="new_card")return m?b(`/cogita/library/${t}/edit/${m}`,{revisionId:i}):b(`/cogita/library/${t}/list`,{revisionId:i,libraryAction:"new-info"});if(n==="all_collections"||n==="all_revisions"){const j=n==="all_revisions"?"revisions":void 0;return!s&&r==="run"?b(`/cogita/library/${t}/revision/run`,{revisionId:i,libraryTarget:j}):s?r==="graph"?b(`/cogita/library/${t}/collections/${s}/graph`,{revisionId:i,libraryTarget:j}):r==="settings"?b(`/cogita/library/${t}/collections/${s}/revision`,{revisionId:i,libraryTarget:j}):r==="run"?b(`/cogita/library/${t}/collections/${s}/revision/run`,{revisionId:i,libraryTarget:j}):r==="shared"?b(`/cogita/library/${t}/collections/${s}/shared-revisions`,{revisionId:i,libraryTarget:j}):r==="new"?b(`/cogita/library/${t}/collections/${s}`,{revisionId:i,libraryTarget:j,collectionAction:"new-revision"}):b(`/cogita/library/${t}/collections/${s}`,{revisionId:i,libraryTarget:j}):b(`/cogita/library/${t}/collections`,{revisionId:i,libraryTarget:j})}return n==="new_collection"?b(`/cogita/library/${t}/collections`,{revisionId:i,collectionAction:"new-collection"}):n==="transfer"?b(`/cogita/library/${t}/transfer`,{revisionId:i}):n==="storyboards"?b(`/cogita/library/${t}/storyboards`,{revisionId:i}):n==="new_storyboard"?b(`/cogita/library/${t}/storyboards/new`,{revisionId:i}):n==="texts"?b(`/cogita/library/${t}/texts`,{revisionId:i}):n==="new_text"?b(`/cogita/library/${t}/texts/new`,{revisionId:i}):n==="dependencies"?b(`/cogita/library/${t}/dependencies`,{revisionId:i}):b(`/cogita/library/${t}`,{revisionId:i})}function da(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function $i(t){return typeof t=="string"&&Js.includes(t)}function Ai(t,n){var b;if(!t.length)return null;const s=t.filter(j=>n.has(j.roleId)),r=s.length>0?s:t,i=r.map(j=>{var c,x;const k=((x=(c=j.fields.find(o=>o.fieldType==="role_kind"))==null?void 0:c.plainValue)==null?void 0:x.toLowerCase())??"";return{roleId:j.roleId,roleKind:k}}),m=i.find(j=>j.roleKind.includes("master"));if(m)return m.roleId;const h=i.find(j=>j.roleKind.includes("account")||j.roleKind.includes("user"));return h?h.roleId:((b=r[0])==null?void 0:b.roleId)??null}function Ei(t){if(!t)return{version:1,byLibrary:{}};try{const n=JSON.parse(t);return!n||typeof n!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:n.lastLibraryId,byLibrary:n.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function Pi({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k}){const c=In(),x=an(),o=a.useMemo(()=>Ri(x.pathname,x.search),[x.pathname,x.search]),u=t.cogita.workspace,[v,w]=a.useState([]),[C,F]=a.useState([]),[g,d]=a.useState([]),[ie,K]=a.useState([]),[y,V]=a.useState(void 0),[N,Y]=a.useState("library_overview"),[z,I]=a.useState(void 0),[ue,re]=a.useState(void 0),[fe,Ce]=a.useState("detail"),[be,M]=a.useState(void 0),[Me,J]=a.useState(!1),[ee,$e]=a.useState(!0),[Te,G]=a.useState(!1),[ve,we]=a.useState(!1),[Ve,Je]=a.useState(null),[Ie,qe]=a.useState(0),[Xe,Ae]=a.useState(""),[Ge,tt]=a.useState(""),[st,_e]=a.useState(""),[ye,q]=a.useState([]),[Ee,se]=a.useState(""),[B,he]=a.useState(0),[He,E]=a.useState(null),[R,X]=a.useState(null),ne=a.useRef({version:1,byLibrary:{}}),S=a.useRef(!1),O=a.useRef(!1),$=a.useRef(null),U=a.useMemo(()=>v.find(p=>p.libraryId===y)??null,[v,y]),ae=a.useMemo(()=>C.find(p=>p.collectionId===z)??null,[C,z]),ke=da(x.pathname)==="/cogita/persons";a.useEffect(()=>{if(!y){q([]),se("");return}let p=!1;return As({libraryId:y}).then(Le=>{if(p)return;const H=Le.filter(et=>(et.roleKind??"").trim().toLowerCase()==="person");q(H);try{const et=window.localStorage.getItem(Sn),mt=(et?JSON.parse(et):{})[y]??"",kt=mt&&H.some(Mt=>Mt.roleId===mt)?mt:"";se(kt)}catch{se("")}}).catch(()=>{p||(q([]),se(""))}),()=>{p=!0}},[y,B]),a.useEffect(()=>{if(y)try{const p=window.localStorage.getItem(Sn),Le=p?JSON.parse(p):{};Ee?Le[y]=Ee:delete Le[y],window.localStorage.setItem(Sn,JSON.stringify(Le))}catch{}},[y,Ee]);const je=a.useMemo(()=>ie.find(p=>p.revisionId===ue)??null,[ie,ue]),Ke=a.useMemo(()=>({detail:u.revisions.detail,graph:u.revisions.graph,settings:u.revisions.settings,run:u.revisions.run,shared:u.targets.sharedRevisions,new:u.revisionForm.createAction}),[u.revisions.detail,u.revisions.graph,u.revisions.run,u.revisions.settings,u.targets.sharedRevisions,u.revisionForm.createAction]),Ne=a.useMemo(()=>[{value:"detail",label:Ke.detail},{value:"graph",label:Ke.graph},{value:"settings",label:u.targets.allRevisions},{value:"run",label:Ke.run},{value:"shared",label:Ke.shared}],[Ke.detail,Ke.graph,Ke.run,Ke.shared,u.targets.allRevisions]),le=a.useMemo(()=>N==="new_card"?"all_cards":N==="new_collection"?"all_collections":N==="new_storyboard"?"storyboards":N==="new_text"?"texts":N,[N]),oe=a.useMemo(()=>fe==="new"?"settings":fe,[fe]),We=N==="all_collections"||N==="all_revisions",Ue=a.useMemo(()=>o.infoId?"selected":N==="new_card"?"create":"search",[o.infoId,N]),at=a.useMemo(()=>g.find(p=>p.infoId===o.infoId)??null,[g,o.infoId]),rt=a.useMemo(()=>({library_overview:u.targets.libraryOverview,all_cards:u.targets.allCards,new_card:u.targets.newCard,all_collections:u.targets.allCollections,all_revisions:u.targets.allRevisions,new_collection:u.targets.newCollection,transfer:u.targets.transfer,storyboards:u.targets.storyboards,new_storyboard:u.targets.newStoryboard,texts:u.targets.texts,new_text:u.targets.newText,dependencies:u.targets.dependencies}),[u.targets]),vt=a.useMemo(()=>rt[le]??le,[le,rt]),Ye=Ke[oe],Ze=!!y,Nt=a.useMemo(()=>{const p=j==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":j==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return j==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:p},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:p},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:p},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:p},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:p},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:p},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:p},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:p},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:p},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:p},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:p},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:p},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:p},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:j==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:p},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:p},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:p},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:p},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:p},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:p},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:p},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:p},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:p},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:p},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:p},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:p},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:p},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:p},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:p},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:p},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:p},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:p},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:p},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:p},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:p},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:p},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:p},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:p},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:p},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:p},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[j]),St=Nt.length,Tt=Math.max(0,Math.min(Ie,St-1)),Lt=Nt[Tt],Et=!!z,Ut=Ze&&We,bt=Et&&We,ia=Et&&We,ct=a.useCallback(p=>{const Le=!!p.libraryId;let H=p.target,et=p.collectionId,gt=p.revisionId,mt=p.revisionView,kt=p.infoId,Mt=p.infoView??o.infoView??"overview";Le?Tn[H].requiresCollection&&!et?(H=H==="all_revisions"?"all_revisions":"all_collections",gt=void 0,mt="detail"):H!=="all_collections"&&H!=="all_revisions"?(et=void 0,gt=void 0,H!=="new_card"&&H!=="all_cards"&&(kt=void 0,Mt="overview")):Tn[H].allowsRevision?xs.includes(mt)||(gt=void 0):mt="detail":(H="library_overview",et=void 0,gt=void 0,mt="detail",kt=void 0,Mt="overview"),V(p.libraryId),Y(H),I(et),re(gt),Ce(mt),J(!1);const wt=da(vs(p.libraryId,H,et,mt,gt,kt,Mt));da(`${x.pathname}${x.search}`)!==wt&&($.current=wt,c(wt))},[x.pathname,x.search,c,o.infoView]),yt=p=>{ct({libraryId:y,target:We?N:"all_collections",collectionId:z,revisionId:xs.includes(p)?ue:void 0,revisionView:p})},Vt=a.useMemo(()=>[{key:"library",label:u.layers.library,visible:!0,value:y??"",selectedLabel:(U==null?void 0:U.name)??u.path.noLibrarySelected,disabled:ee||v.length===0,options:v.map(p=>({value:p.libraryId,label:p.name})),emptyOption:u.noLibraryOption,onSelect:p=>{const Le=p||void 0;ct({libraryId:Le,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:u.layers.target,visible:Ze,value:le,selectedLabel:vt,disabled:!Ze,options:Js.map(p=>({value:p,label:rt[p]})),onSelect:p=>{const Le=p;ct({libraryId:y,target:Le,collectionId:z,revisionId:ue,revisionView:fe,infoId:Le==="new_card"?o.infoId:void 0})}},{key:"info_mode",label:u.layers.target,visible:le==="all_cards",value:Ue,selectedLabel:Ue==="create"?u.infoMode.create:Ue==="selected"?(at==null?void 0:at.label)??be??t.cogita.library.list.selectedEmpty:u.infoMode.search,disabled:!Ze,options:[{value:"search",label:u.infoMode.search},{value:"create",label:u.infoMode.create},...o.infoId?[{value:"selected",label:(at==null?void 0:at.label)??be??t.cogita.library.list.selectedEmpty}]:[]],onSelect:p=>{if(p==="selected"){if(!o.infoId)return;ct({libraryId:y,target:"all_cards",collectionId:z,revisionId:ue,revisionView:fe,infoId:o.infoId,infoView:"overview"});return}if(p==="create"){ct({libraryId:y,target:"new_card",collectionId:z,revisionId:ue,revisionView:fe,infoId:void 0});return}ct({libraryId:y,target:"all_cards",collectionId:z,revisionId:ue,revisionView:fe,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:u.layers.target,visible:le==="all_cards"&&!!o.infoId,value:N==="new_card"&&o.infoId?"edit":o.infoView==="cards"?"cards":"overview",selectedLabel:N==="new_card"&&o.infoId?u.infoActions.edit:o.infoView==="cards"?u.infoActions.seeCards:u.infoActions.overview,disabled:!Ze||!o.infoId,options:[{value:"overview",label:u.infoActions.overview},{value:"edit",label:u.infoActions.edit},{value:"cards",label:u.infoActions.seeCards}],onSelect:p=>{if(o.infoId){if(p==="edit"){ct({libraryId:y,target:"new_card",collectionId:z,revisionId:ue,revisionView:fe,infoId:o.infoId});return}if(p==="cards"){ct({libraryId:y,target:"all_cards",collectionId:z,revisionId:ue,revisionView:fe,infoId:o.infoId,infoView:"cards"});return}ct({libraryId:y,target:"all_cards",collectionId:z,revisionId:ue,revisionView:fe,infoId:o.infoId,infoView:"overview"})}}},{key:"collection",label:u.layers.collection,visible:Ut,value:z??"",selectedLabel:(ae==null?void 0:ae.name)??u.path.noCollectionSelected,disabled:!Ze||Te||C.length===0,options:C.map(p=>({value:p.collectionId,label:p.name})),emptyOption:u.selectCollectionOption,onSelect:p=>{ct({libraryId:y,target:We?N:"all_collections",collectionId:p||void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection_action",label:u.layers.revision,visible:bt,value:oe,selectedLabel:Ye,disabled:!z,options:Ne.map(p=>({value:p.value,label:p.label})),onSelect:p=>{yt(p)}},{key:"revision_entry",label:u.layers.revision,visible:ia,value:ue??"",selectedLabel:(je==null?void 0:je.name)??u.status.noRevisions,disabled:!Et||ve||ie.length===0,options:ie.map(p=>({value:p.revisionId,label:p.name})),emptyOption:u.status.noRevisions,onSelect:p=>{ct({libraryId:y,target:We?N:"all_collections",collectionId:z,revisionId:p||void 0,revisionView:fe})}}],[Ne,C,Te,Ue,g,v,ee,ct,ie,ve,ae,z,at,je,ue,be,Et,Ze,U,We,y,Ye,fe,N,oe,le,vt,Ut,bt,ia,rt,t.cogita.library.list.selectedEmpty,o.infoId,o.infoView,u.infoActions.edit,u.infoActions.overview,u.infoActions.seeCards,u.layers.collection,u.layers.library,u.layers.revision,u.layers.target,u.noLibraryOption,u.path.noCollectionSelected,u.path.noLibrarySelected,u.selectCollectionOption]),Rt=a.useMemo(()=>Vt.filter(p=>p.visible),[Vt]),Re=a.useMemo(()=>Rt.filter(p=>p.key!=="library"&&p.key!=="collection"),[Rt]),ht=a.useMemo(()=>Re.find(p=>p.key==="target")??null,[Re]),Ct=a.useMemo(()=>Re.find(p=>p.key==="info_mode")??null,[Re]),xt=a.useMemo(()=>Re.find(p=>p.key==="info_selected_action")??null,[Re]),T=a.useMemo(()=>Re.find(p=>p.key==="collection_action")??null,[Re]),ge=a.useMemo(()=>Re.find(p=>p.key==="revision_entry")??null,[Re]),ze=a.useCallback((p,Le)=>p?e.jsx("div",{className:"cogita-sidebar-actions",children:p.options.map(H=>e.jsx("button",{type:"button",className:`ghost ${String(p.value)===H.value?"active":""}`,onClick:()=>p.onSelect(H.value),disabled:p.disabled,children:H.label},`${Le}:${p.key}:${H.value}`))}):null,[]),ut=a.useMemo(()=>{const p=o.libraryId;if(!p||!x.pathname.startsWith("/cogita/library/"))return null;const Le={copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,libraryId:p};if(o.target==="library_overview")return e.jsx(Lr,{...Le});if(o.target==="all_cards")return o.infoId&&o.infoView==="cards"?e.jsx(ei,{...Le,infoId:o.infoId,selectedReviewerRoleId:Ee||null}):e.jsx(zr,{...Le,mode:o.cardMode??"list"});if(o.target==="new_card")return e.jsx(Wr,{...Le,editInfoId:o.infoId});if(o.target==="dependencies")return e.jsx(Yr,{...Le});if(o.target==="transfer")return e.jsx(ri,{...Le});if(o.target==="storyboards"||o.target==="new_storyboard")return e.jsx(ii,{...Le});if(o.target==="texts"||o.target==="new_text")return e.jsx(oi,{...Le});if(o.target==="all_collections"||o.target==="all_revisions"){if(!o.collectionId&&o.revisionView==="run")return e.jsx(ys,{...Le,revisionId:o.revisionId});if(o.collectionId){const H={...Le,collectionId:o.collectionId};return o.revisionView==="graph"?e.jsx(Li,{...H}):o.revisionView==="shared"?e.jsx(si,{...Le,collectionId:o.collectionId}):o.revisionView==="settings"?e.jsx(bi,{...H,revisionId:o.revisionId}):o.revisionView==="run"?e.jsx(ys,{...H,revisionId:o.revisionId}):e.jsx(li,{...H})}return e.jsx(bs,{...Le})}return o.target==="new_collection"?e.jsx(bs,{...Le}):null},[n,t,j,x.pathname,c,k,m,b,r,i,o.cardMode,o.collectionId,o.infoId,o.libraryId,o.revisionId,o.revisionView,o.target,h,s,Ee]);a.useEffect(()=>{let p=!1;return(async()=>{var H,et,gt,mt,kt;$e(!0);try{await mr();const[Mt,wt,na]=await Promise.all([Ts(),Ls(),gr()]);if(p)return;w(Mt);const sa=new Set(na.nodes.filter(dt=>dt.nodeType==="role"&&dt.canLink).map(dt=>dt.roleId??"")),jt=Ai(wt,sa);if(E(jt),jt){const dt=na.nodes.find(At=>At.nodeType==="data"&&At.roleId===jt&&(At.fieldType===Nn||At.label===Nn));X((dt==null?void 0:dt.dataKeyId)??null),ne.current=Ei(dt==null?void 0:dt.value)}const pt=(H=Mt.find(dt=>dt.libraryId===o.libraryId))==null?void 0:H.libraryId,Gt=pt?(gt=(et=ne.current.byLibrary)==null?void 0:et[pt])==null?void 0:gt.lastTarget:void 0,ma=$i(Gt)?Gt:"library_overview";V(pt),Y(o.target??ma),re(o.revisionId??(pt?(kt=(mt=ne.current.byLibrary)==null?void 0:mt[pt])==null?void 0:kt.lastRevisionId:void 0)),Ce(o.revisionView??"detail"),S.current=!0}catch{p||Je(u.status.loadFailed)}finally{p||$e(!1)}})(),()=>{p=!0}},[u.status.loadFailed]),a.useLayoutEffect(()=>{if(S.current){if(!o.libraryId){V(void 0),Y(o.target??"library_overview"),I(void 0),re(void 0),Ce("detail");return}o.libraryId&&v.some(p=>p.libraryId===o.libraryId)&&V(o.libraryId),o.target&&Y(o.target),I(o.collectionId),re(o.revisionId),o.revisionView&&Ce(o.revisionView)}},[v,o.collectionId,o.libraryId,o.revisionId,o.revisionView,o.target]),a.useEffect(()=>{if(!y){F([]),I(void 0),d([]),K([]),re(void 0);return}let p=!1;return G(!0),Aa({libraryId:y,limit:200}).then(Le=>{var gt;if(p)return;const H=Le.items;F(H);const et=(gt=H.find(mt=>mt.collectionId===o.collectionId))==null?void 0:gt.collectionId;I(et)}).catch(()=>{p||(F([]),I(void 0))}).finally(()=>{p||G(!1)}),()=>{p=!0}},[o.collectionId,y]),a.useEffect(()=>{if(!y||le!=="all_cards"&&N!=="new_card"){d([]);return}let p=!1;return En({libraryId:y,limit:200}).then(Le=>{p||d(Le)}).catch(()=>{p||d([])}),()=>{p=!0}},[le,y,N]),a.useEffect(()=>{if(!y||!z){K([]),re(void 0);return}let p=!1;return we(!0),Cs({libraryId:y,collectionId:z}).then(Le=>{var gt,mt,kt,Mt;if(p)return;K(Le);const H=(mt=(gt=ne.current.byLibrary)==null?void 0:gt[y])==null?void 0:mt.lastRevisionId,et=((kt=Le.find(wt=>wt.revisionId===o.revisionId))==null?void 0:kt.revisionId)??((Mt=Le.find(wt=>wt.revisionId===H))==null?void 0:Mt.revisionId);re(et)}).catch(()=>{p||(K([]),re(void 0))}).finally(()=>{p||we(!1)}),()=>{p=!0}},[o.revisionId,z,y]),a.useEffect(()=>{const p=o.infoId;if(!y||!p){M(void 0);return}let Le=!1;return ta({libraryId:y,infoId:p}).then(H=>{if(Le)return;const et=H.payload;M((et==null?void 0:et.label)??(et==null?void 0:et.name)??(et==null?void 0:et.title)??H.infoId)}).catch(()=>{Le||M(p)}),()=>{Le=!0}},[o.infoId,y]),a.useEffect(()=>{if(!S.current||o.libraryId&&v.some(gt=>gt.libraryId===o.libraryId)&&o.libraryId!==y||o.target&&o.target!==N||o.revisionView&&o.revisionView!==fe||o.revisionId&&o.revisionId!==ue||Tn[N].requiresCollection&&!z&&(o.target==="all_collections"||o.target==="all_revisions")&&o.collectionId)return;const p=da(`${x.pathname}${x.search}`);if(da(x.pathname)==="/cogita"&&!o.libraryId&&!y){$.current=null;return}if(da(x.pathname)==="/cogita/persons"){$.current=null;return}if(da(x.pathname)===`/cogita/library/${y}/revision/run`&&o.revisionView==="run"&&!o.collectionId&&(N==="all_collections"||N==="all_revisions")&&fe==="run"&&!z){$.current=null;return}const et=da(vs(y,N,z,fe,ue,o.infoId,o.infoView??"overview"));if(p===et){$.current=null;return}$.current!==et&&($.current=et,c(et,{replace:!0}))},[v,x.pathname,x.search,c,o.collectionId,o.infoId,o.infoView,o.libraryId,o.revisionId,o.revisionView,o.target,z,y,ue,fe,N]),a.useEffect(()=>{if(typeof window>"u")return;const p=()=>{window.innerWidth>920&&J(!1)};return window.addEventListener("resize",p),()=>window.removeEventListener("resize",p)},[]),a.useEffect(()=>{if(!S.current||!He||!y||O.current)return;const p=ne.current,Le={...p.byLibrary??{}},H={...Le[y]??{},lastCollectionId:z,lastRevisionId:ue,lastRevisionView:fe,lastTarget:N},et={version:1,lastLibraryId:y,byLibrary:{...Le,[y]:H}},gt=JSON.stringify(p),mt=JSON.stringify(et);if(gt===mt)return;ne.current=et,O.current=!0,(async()=>{try{if(R)await pr(R,{plainValue:mt});else{const Mt=await fr(He,{itemName:Nn,itemType:"data",plainValue:mt});X(Mt.dataItemId)}}catch{Je(u.status.savePrefsFailed)}finally{O.current=!1}})()},[R,He,z,y,ue,fe,N,u.status.savePrefsFailed]);const $t=async()=>{const p=Xe.trim();if(!p){Je(t.cogita.user.libraryNameRequired);return}Je(null);try{const Le=await xr({name:p});w(H=>[Le,...H]),V(Le.libraryId),Y("library_overview"),I(void 0),Ae("")}catch{Je(t.cogita.user.libraryCreateFailed)}},xe=async()=>{if(!y){Je(u.status.selectLibraryFirst);return}const p=Ge.trim();if(!p){Je(t.cogita.library.collections.saveRequiredName);return}Je(null);try{const Le=await br({libraryId:y,name:p,items:[]}),H=await Aa({libraryId:y,limit:200});F(H.items),I(Le.collectionId),re(void 0),Y(N==="all_revisions"?"all_revisions":"all_collections"),Ce("detail"),tt("")}catch{Je(t.cogita.library.collections.saveFail)}},Wt=async()=>{if(!y||!z){Je(u.status.selectLibraryFirst);return}const p=st.trim();if(!p){Je(u.revisionForm.nameLabel);return}Je(null);try{const Le=await yr({libraryId:y,collectionId:z,name:p,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});K(H=>[Le,...H]),re(Le.revisionId),Y(N==="all_revisions"?"all_revisions":"all_collections"),Ce("settings"),_e("")}catch{Je(u.status.loadFailed)}};return e.jsx(Ft,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,headerExtra:e.jsxs("div",{className:"cogita-header-reviewer-actions",children:[e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:Ee,disabled:!y,onChange:p=>{const Le=p.target.value;if(Le==="__new_person__"){c("/cogita/persons");return}se(Le)},children:[e.jsx("option",{value:"",children:y?"No person":"Select library first"}),ye.map(p=>e.jsx("option",{value:p.roleId,children:p.label},p.roleId)),e.jsx("option",{value:"__new_person__",children:"+ Create new person"})]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>c("/cogita/persons"),children:"Persons"})]}),children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${Me?"open":""}`,"aria-label":u.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{children:(U==null?void 0:U.name)??u.path.noLibrarySelected}),e.jsx("p",{className:"cogita-sidebar-note",children:U?u.sidebar.libraryActionsHint:u.status.selectLibraryFirst}),ze(ht,"sidebar")]}),Ct?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:u.sidebar.infoActionsHint}),ze(Ct,"sidebar"),xt?e.jsxs("div",{className:"cogita-sidebar-actions-nested",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(at==null?void 0:at.label)??be??t.cogita.library.list.selectedEmpty}),e.jsx("p",{className:"cogita-sidebar-note",children:u.sidebar.selectedInfoActionsHint}),ze(xt,"sidebar")]}):null]}):null,ae?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:ae.name}),e.jsx("p",{className:"cogita-sidebar-note",children:u.sidebar.collectionActionsHint}),ze(T,"sidebar"),ge?e.jsxs("div",{className:"cogita-sidebar-actions-nested",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(je==null?void 0:je.name)??u.status.noRevisions}),ze(ge,"sidebar")]}):null]}):null,e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:u.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:r,children:u.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{b("cogita"),J(!1)},children:u.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:i,children:h?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),Me?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":u.sidebar.closeMenu,onClick:()=>J(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":u.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>J(p=>!p),"aria-label":Me?u.sidebar.closeMenu:u.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),Rt.map((p,Le)=>e.jsxs("div",{className:"cogita-browser-segment",children:[Le>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,p.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":p.label,children:p.selectedLabel}):e.jsxs("select",{"aria-label":p.label,value:p.value,onChange:H=>p.onSelect(H.target.value),disabled:p.disabled,children:[p.emptyOption?e.jsx("option",{value:"",children:p.emptyOption}):null,p.options.map(H=>e.jsx("option",{value:H.value,children:H.label},`${p.key}:${H.value}`))]})]},`menu:${p.key}`))]}),ut?e.jsxs(e.Fragment,{children:[N==="new_collection"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.library.actions.createCollection}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{type:"text",value:Ge,onChange:p=>tt(p.target.value),placeholder:t.cogita.library.collections.namePlaceholder,disabled:!y})]}),e.jsx("button",{type:"button",className:"cta",onClick:xe,disabled:!y,children:t.cogita.library.actions.createCollection}),Ve?e.jsx("p",{className:"cogita-form-error",children:Ve}):null]}):null,(N==="all_collections"||N==="all_revisions")&&z&&fe==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:u.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:u.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:st,onChange:p=>_e(p.target.value),placeholder:u.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Wt,children:u.revisionForm.createAction}),Ve?e.jsx("p",{className:"cogita-form-error",children:Ve}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Es.Provider,{value:!0,children:ut})})]}):null,ut?null:e.jsxs(e.Fragment,{children:[ke?e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(ni,{copy:t,onPersonCreated:p=>{he(Le=>Le+1)}})}):null,!y&&!ke?e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:Lt.step}),e.jsx("h2",{children:Lt.title})]}),e.jsxs("p",{children:[Tt+1," / ",St]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:Lt.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:Lt.passages.map(p=>e.jsx("p",{children:p},p))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:Lt.focus.map(p=>e.jsx("span",{children:p},p))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:Lt.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:Nt.map((p,Le)=>e.jsx("button",{type:"button",className:`ghost ${Le===Tt?"active":""}`,onClick:()=>qe(Le),"aria-label":`${Le+1}`,children:Le+1},`tutorial:${p.title}:${Le}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:Tt===0,onClick:()=>qe(p=>Math.max(0,p-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:Tt===St-1,onClick:()=>qe(p=>Math.min(St-1,p+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:Xe,onChange:p=>Ae(p.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:$t,children:t.cogita.user.createLibraryAction}),Ve?e.jsx("p",{className:"cogita-form-error",children:Ve}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),v.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,v.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:v.map(p=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{ct({libraryId:p.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:p.name})]},p.libraryId))}):null]})]})]}):null]})]})]})})}const _i=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:Pi},Symbol.toStringTag,{value:"Module"}));function Ki({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,shareId:c}){const[x,o]=a.useState(null),[u,v]=a.useState("loading"),[w,C]=a.useState(t.cogita.library.collections.defaultName),[F,g]=a.useState("Cogita Library"),[d,ie]=a.useState([]),[K,y]=a.useState([]),[V,N]=a.useState("idle"),[Y,z]=a.useState({current:0,total:0}),[I,ue]=a.useState(0),[re,fe]=a.useState(""),[Ce,be]=a.useState(null),[M,Me]=a.useState(null),[J,ee]=a.useState(null),[$e,Te]=a.useState(null),[G,ve]=a.useState([]),[we,Ve]=a.useState({}),[Je,Ie]=a.useState({}),[qe,Xe]=a.useState(null),[Ae,Ge]=a.useState(null),[tt,st]=a.useState(null),[_e,ye]=a.useState(null),[q,Ee]=a.useState({}),se=a.useRef(0),[B,he]=a.useState(null),He=a.useRef(null),E=a.useRef(null),[R,X]=a.useState(null),[ne,S]=a.useState(!1),[O,$]=a.useState(null),[U,ae]=a.useState([]),[ke,je]=a.useState(null),Ke=a.useRef(null),Ne=a.useRef(null),[le,oe]=a.useState(null),[We,Ue]=a.useState(0),at=a.useRef(null),rt=a.useRef({}),[vt,Ye]=a.useState(!1),[Ze,Nt]=a.useState({}),St=a.useRef(null),Tt=a.useRef(new Set),Lt=a.useRef({}),[Et,Ut]=a.useState([]),[bt,ia]=a.useState(new Set),[ct,yt]=a.useState(!1),Vt=an(),Rt=a.useMemo(()=>new URLSearchParams(Vt.search),[Vt.search]),Re=a.useMemo(()=>Rt.get("key")??"",[Rt]),ht=(x==null?void 0:x.mode)??"random",Ct=(x==null?void 0:x.check)??"exact",xt=(x==null?void 0:x.limit)??20,T=a.useMemo(()=>_n((x==null?void 0:x.revisionType)??ht),[x,ht]),ge=a.useMemo(()=>{const L=x==null?void 0:x.revisionSettings,W=zs(T,Rt);return on(T,L??W)},[x,Rt,T]),ze=a.useMemo(()=>t.cogita.library.revision[T.labelKey]??ht,[t,ht,T]),ut=a.useMemo(()=>Ct==="exact"?t.cogita.library.revision.checkValue:Ct,[t,Ct]),xe=u==="ready"?d[I]??null:null,Wt=(xe==null?void 0:xe.checkType)==="translation-match"&&_e,p=a.useRef(new Map),Le=a.useRef(new Map),H=a.useRef(new Map),et=a.useRef(new Map),gt=a.useMemo(()=>xe?xe.cardType==="vocab"?t.cogita.library.revision.vocabLabel:xe.infoType?Qe(t,xe.infoType):t.cogita.library.revision.infoLabel:"",[t,xe]),mt=a.useMemo(()=>{var W;return T.id!=="levels"?d.length:((W=Ze.pool)==null?void 0:W.length)??T.getFetchLimit(xt,ge)},[Ze,ge,T,d.length,xt]),kt=T.getProgressTotal?T.getProgressTotal(d,Ze,xt,ge):T.id==="levels"?Math.min(xt,mt):d.length,Mt=kt?Math.min(I+1,kt):0,wt=Math.max(1,Number(ge.tries??1)),na=ge.compare??"anchors",sa=Math.max(0,Math.min(100,Number(ge.minCorrectness??0))),jt=(ge.considerDependencies??"on")==="on",pt=Math.max(0,Math.min(100,Number(ge.dependencyThreshold??85))),Gt=L=>{const W=L.slice();for(let de=W.length-1;de>0;de-=1){const Pe=Math.floor(Math.random()*(de+1));[W[de],W[Pe]]=[W[Pe],W[de]]}return W},ma=L=>ha(L,{treatSimilarCharsAsSame:!0})>=sa,dt=async()=>{const L=await ea(),W=new Map,de=new Map;L.forEach(ce=>{const Se=`${ce.itemType}:${ce.itemId}`,l=qt(ce.itemType,ce.itemId,ce.checkType,ce.direction);W.has(Se)||W.set(Se,[]),W.get(Se).push(ce),de.has(l)||de.set(l,[]),de.get(l).push(ce)});const Pe=new Map,Fe=new Map;return W.forEach((ce,Se)=>Pe.set(Se,Zt(ce).score)),de.forEach((ce,Se)=>Fe.set(Se,Zt(ce).score)),{itemKnowness:Pe,cardKnowness:Fe}},At=async L=>{const W=Ze,de=L.concat(W.active??[]).concat(W.pool??[]).filter((_,Q,D)=>D.findIndex(te=>me(te)===me(_))===Q);if(!jt){ia(new Set(de.map(me)));return}const{itemKnowness:Pe,cardKnowness:Fe}=await dt(),ce=_=>{if(_.cardType!=="info"||_.infoType!=="citation"||_.checkType!=="quote-fragment")return!0;const Q=_t(_.direction);if(!(Q!=null&&Q.fragmentId))return!0;const D=_.description??"";if(!D.trim())return!0;const A=ya(D).nodes[Q.fragmentId];if(!A||!A.leftId&&!A.rightId)return!0;const Z=[A.leftId,A.rightId].filter(Be=>!!Be);if(Z.length===0)return!0;const pe=Z.map(Be=>{const Oe=qt("info",_.cardId,"quote-fragment",Be);return Fe.get(Oe)??0});return pe.reduce((Be,Oe)=>Be+Oe,0)/pe.length>=pt},Se=(x==null?void 0:x.collectionId)??null,l=Se?Et.filter(_=>ft(_.childItemType)==="collection"&&_.childItemId===Se&&!ft(_.childCheckType)&&!ft(_.childDirection)):[],f=Se&&de.length>0?de.reduce((_,Q)=>_+(Fe.get(me(Q))??0),0)/de.length:0,P=new Set;for(const _ of de){if(_.cardType!=="info"){P.add(me(_));continue}if(!ce(_))continue;const Q=Et.filter(A=>Us(A,_)).concat(l);if(Q.length===0){P.add(me(_));continue}let D=0;for(const A of Q)if(ft(A.parentItemType)==="collection")D+=A.parentItemId===Se?f:0;else if(ft(A.parentCheckType)||ft(A.parentDirection)){const Z=ft(A.parentCheckType),pe=ft(A.parentDirection),De=qt(A.parentItemType,A.parentItemId,Z,pe);D+=Fe.get(De)??0}else{const Z=`${A.parentItemType}:${A.parentItemId}`;D+=Pe.get(Z)??0}D/Q.length>=pt&&P.add(me(_))}ia(P)},Ka=L=>{for(let W=L;W<d.length;W+=1){const de=d[W];if(de&&(!jt||de.cardType!=="info"||bt.has(me(de))))return W}return-1},xa=L=>!jt||L.cardType!=="info"||bt.has(me(L)),Fa=L=>{if(T.id!=="temporal"&&T.id!=="levels")return null;const W=Ze,de=(W.active??[]).concat(W.pool??[]),Pe=new Set;for(const Fe of de){const ce=me(Fe);if(!(Pe.has(ce)||L.has(ce))&&(Pe.add(ce),xa(Fe)))return Fe}return null},Jt=a.useMemo(()=>{if(T.id!=="levels")return null;const L=Ze,W=L.pool??[],de=L.active??[],Pe=L.levelMap??{},Fe=Math.max(1,Number(ge.levels??1)),ce=Array.from({length:Fe},()=>0),Se=new Set(de.map(_=>me(_)));W.forEach(_=>{const Q=Math.min(Fe,Math.max(1,Pe[me(_)]??1));ce[Q-1]+=1});const l=W.length||1,f=ce.map(_=>_/l*100),P=xe?Pe[me(xe)]??1:null;return{counts:ce,percentages:f,currentLevel:P,levelsCount:Fe,activeCount:de.length,poolCount:W.length,activeSet:Se}},[Ze,ge,T,xe]),va=a.useMemo(()=>{if(T.id!=="temporal")return null;const L=Ze,W=L.pool??[],de=L.active??[],Pe=L.knownessMap??{},Fe=new Set(L.unknownSet??[]);let ce=0;W.forEach(f=>{(Pe[me(f)]??0)>1&&(ce+=1)});const Se=Fe.size,l=de.map(f=>({id:me(f),value:Fe.has(me(f))?0:Math.max(0,Math.min(1,Pe[me(f)]??0))}));return{knownCount:ce,unknownCount:Se,dots:l}},[Ze,T]),ln=a.useMemo(()=>{if(!jt)return 0;const L=Ze;return d.concat(L.active??[]).concat(L.pool??[]).filter((de,Pe,Fe)=>Fe.findIndex(ce=>me(ce)===me(de))===Pe).filter(de=>de.cardType==="info"&&!bt.has(me(de))).length},[jt,Ze,d,bt]);a.useEffect(()=>{if(!jt||V!=="ready")return;const L=Ze,de=d.concat(L.active??[]).concat(L.pool??[]).filter((ce,Se,l)=>l.findIndex(f=>me(f)===me(ce))===Se).filter(ce=>ce.cardType!=="info"||bt.has(me(ce))).length,Pe=Ke.current;if(Ke.current=de,Pe===null||de<=Pe)return;const Fe=de-Pe;je(`New card available (+${Fe})`),Ne.current&&window.clearTimeout(Ne.current),Ne.current=window.setTimeout(()=>je(null),2200)},[jt,V,Ze,d,bt]),a.useEffect(()=>()=>{Ne.current&&window.clearTimeout(Ne.current)},[]);const Dt=(L,W)=>{const de=T.applyOutcome({queue:d,meta:Ze},xe,xt,ge,{correct:L,correctness:W,createdUtc:new Date().toISOString()});ie(de.queue),Nt(de.meta);const Pe=de.queue[I+1];Pe&&Na(Pe,I+1)};a.useEffect(()=>{if(!c){v("error");return}v("loading"),vr({shareId:c,key:Re}).then(L=>{o(L),C(L.collectionName),g(L.libraryName),v("ready")}).catch(()=>{v("error")})},[c,Re]),a.useEffect(()=>{c&&wr({shareId:c,key:Re,type:"language"}).then(L=>y(L)).catch(()=>y([]))},[c,Re]),a.useEffect(()=>{!c||u!=="ready"||jr({shareId:c,key:Re}).then(L=>Ut(L.items??[])).catch(()=>Ut([]))},[c,Re,u]),a.useEffect(()=>{if(!c||u!=="ready")return;let L=!0;return(async()=>{N("loading"),z({current:0,total:T.id==="levels"?0:T.getFetchLimit(xt,ge)});try{const de=[];let Pe=null,Fe=null;do{const Q=await kr({shareId:c,key:Re,limit:300,cursor:Pe});if(de.push(...Q.items),(T.id==="levels"||T.id==="temporal")&&Q.total&&(Fe=Q.total),z(D=>({current:de.length,total:D.total||Q.total||T.getFetchLimit(xt,ge)})),Pe=Q.nextCursor??null,Fe!==null&&de.length>=Fe||T.id!=="levels"&&T.id!=="temporal"&&de.length>=T.getFetchLimit(xt,ge))break}while(Pe);if(!L)return;const ce=$a(de);let Se;if(T.id==="levels"){const Q=Math.max(1,Number(ge.levels??1));Se={},ce.forEach(D=>{const te=me(D);Se[te]=Math.max(1,Math.min(Q,1))})}let l=null,f=null,P=null;if(T.id==="temporal"){const Q=await ea(),D=new Set(ce.map(Z=>me(Z))),te=Q.reduce((Z,pe)=>{const De=qt(pe.itemType,pe.itemId,pe.checkType,pe.direction);return D.has(De)&&(Z[De]||(Z[De]=[]),Z[De].push(pe)),Z},{});l={},f=new Set,P={};const A=Date.now();ce.forEach(Z=>{const pe=me(Z),De=te[pe]??[];if(De.length===0){l[pe]=0,f.add(pe),P[pe]=[];return}const Be=Dn(De);P[pe]=Be;const Oe=sn(Be,A);l[pe]=Oe.knowness})}const _=T.id==="levels"?Bn(ce,xt,ge,Se):T.id==="temporal"?zn(ce,xt,ge,l??{},f??new Set,P??{}):T.prepare(ce,xt,ge);ie(_.queue),Nt(_.meta),ue(0),N("ready"),z(Q=>({current:Math.min(Q.current,Q.total),total:Q.total}))}catch{L&&N("error")}})(),()=>{L=!1}},[c,Re,xt,T,ge,u]),a.useEffect(()=>{At(d)},[d,Et,jt,pt,x==null?void 0:x.collectionId]),a.useEffect(()=>{if(!xe||!jt){yt(!1);return}if(xe.cardType!=="info"||bt.has(me(xe))){yt(!1);return}const L=Ka(I+1);if(L>=0){yt(!1),ue(L);return}if(T.id==="temporal"||T.id==="levels"){const W=d.slice(0,I+1),de=d.slice(I+1).filter(xa),Pe=W.concat(de),Fe=new Set(Pe.map(me)),ce=Fa(Fe);if(ce){const l=me(ce);Fe.has(l)||(Pe.push(ce),Fe.add(l),Nt(f=>{const P=f,_=new Set(P.queued??[]);return _.add(l),{...P,queued:_}}))}const Se=Pe.findIndex((l,f)=>f!==I&&xa(l));if(Se>=0){ie(Pe),ue(Se),yt(!1);return}}yt(!0)},[xe,bt,jt,I,d,Ze,T.id]),a.useEffect(()=>{if(fe(""),be(null),oe(null),Ue(0),ve([]),Ve({}),Ie({}),Xe(null),Ge(null),st(null),S(!1),Ye(!1),X(null),ye(null),Ee({}),!xe){Me(null),ee(null);return}xe.cardType==="info"&&xe.infoType==="computed"&&Me(t.cogita.library.revision.loadingComputed);let L=!0;return Na(xe,I).then(W=>{!L||!W||(Me(W.prompt),ee(W.expectedAnswer),ve(W.computedExpected),Ve(W.computedAnswers),Xe(W.answerTemplate),Ge(W.outputVariables),st(W.variableValues))}),()=>{L=!1}},[xe,c,t]),a.useEffect(()=>{if(!xe||xe.cardType!=="info"||xe.infoType!=="citation"){St.current=null,Tt.current=new Set,Te(null);return}const L=xe.description??"",W=(xe.label??"").trim(),de=W.replace(/\s+/g," ").trim(),Pe=L.replace(/\s+/g," ").trim(),Fe=de&&de!==Pe?W:t.cogita.library.infoTypes.citation;if(!L){Te(null),ee(null);return}const ce=ya(L);St.current=ce,Me(Fe);let Se=!0;return ea().then(l=>{if(!Se)return;const f=new Map;l.forEach(te=>{if(te.itemType!=="info"||te.checkType!=="quote-fragment"||!te.direction)return;const A=_t(te.direction);if(!A)return;const Z=`${te.itemId}:${A.fragmentId}`;f.has(Z)||f.set(Z,[]),f.get(Z).push(te)});const P={},_=new Set;f.forEach((te,A)=>{const[Z,pe]=A.split(":",2);if(Z!==xe.cardId)return;const De=Zt(te).score;P[pe]=De,De>=pt&&_.add(pe)}),Tt.current=_,Lt.current=P;const Q=_t(xe.direction);if(Q!=null&&Q.fragmentId&&ce.nodes[Q.fragmentId]){la(ce,Q.fragmentId,Fe);return}const D=Ta(ce,_,P,pt,jt,xe.direction);la(ce,(D==null?void 0:D.id)??null,Fe)}).catch(()=>{Tt.current=new Set,Lt.current={};const l=_t(xe.direction);if(l!=null&&l.fragmentId&&ce.nodes[l.fragmentId]){la(ce,l.fragmentId,Fe);return}const f=Ta(ce,Tt.current,{},pt,jt,xe.direction);la(ce,(f==null?void 0:f.id)??null,Fe)}),()=>{Se=!1}},[xe,t,jt,pt]),a.useEffect(()=>{if(!xe||xe.cardType!=="vocab"||xe.checkType!=="translation-match"){ye(null),Ee({});return}const de=(Ze.pool??Ze.active??d).filter(l=>l.cardType==="vocab"&&l.checkType==="translation-match").filter((l,f,P)=>P.findIndex(_=>_.cardId===l.cardId)===f);de.some(l=>l.cardId===xe.cardId)||de.unshift(xe);const Fe=Gt(de).slice(0,6).map(l=>{const f=l.label.split("↔").map(Q=>Q.trim()).filter(Boolean);if(f.length<2)return null;const P=`${l.cardId}:L`,_=`${l.cardId}:R`;return{cardId:l.cardId,leftId:P,rightId:_,leftLabel:f[0],rightLabel:f[1]}}).filter(Boolean),ce=Fe.map(l=>l.leftId),Se=Gt(Fe.map(l=>l.rightId));ye({pairs:Fe,leftOrder:ce,rightOrder:Se,selection:{},activeLeft:null,activeRight:null,locked:{}})},[xe,d,Ze]),a.useEffect(()=>()=>{He.current&&window.clearTimeout(He.current),E.current&&window.clearTimeout(E.current)},[]);const wa=a.useRef(null);a.useEffect(()=>{if(!xe)return;const L=me(xe),W=typeof document<"u"?document.activeElement:null;if(wa.current===L&&W&&(W.tagName==="INPUT"||W.tagName==="TEXTAREA"))return;let de=0;const Pe=()=>{if(xe){if(xe.cardType==="info"&&xe.infoType==="computed"){if(G.length>0){const ce=tn(qe,G,Ae),Se=ce?rt.current[ce]:null;if(Se&&(Se.focus(),document.activeElement===Se)){wa.current=L;return}}if(at.current&&(at.current.focus(),document.activeElement===at.current)){wa.current=L;return}}else if(xe.cardType==="vocab"&&at.current&&(at.current.focus(),document.activeElement===at.current)){wa.current=L;return}de<6&&(de+=1,window.setTimeout(Pe,40))}},Fe=window.setTimeout(Pe,40);return()=>window.clearTimeout(Fe)},[xe,G,qe,Ae]),a.useEffect(()=>{if(!vt)return;const L=W=>{W.key==="Enter"&&(W.preventDefault(),Pt())};return window.addEventListener("keydown",L),()=>window.removeEventListener("keydown",L)},[vt]);const oa=L=>{ae(L),$(Zt(L))};a.useEffect(()=>{if(!xe){$(null),ae([]);return}const L=xe.cardType==="info"?"info":"connection";if(xe.cardType==="info"&&xe.infoType==="citation"){ea().then(W=>{const de=W.filter(Pe=>Pe.itemType==="info"&&Pe.itemId===xe.cardId&&Pe.checkType==="quote-fragment"&&Za(Pe.direction,xe.direction));oa(de)}).catch(()=>{$(null),ae([])});return}Xa(L,xe.cardId,xe.checkType,xe.direction).then(W=>oa(W)).catch(()=>{$(null),ae([])})},[xe]);const Da=(L,W,de,Pe)=>{if(L==="info"&&de==="quote-fragment"){ea().then(Fe=>{const ce=Fe.filter(Se=>Se.itemType==="info"&&Se.itemId===W&&Se.checkType==="quote-fragment"&&Za(Se.direction,Pe));oa(ce)}).catch(()=>{$(null),ae([])});return}Xa(L,W,de,Pe).then(Fe=>oa(Fe)).catch(()=>{$(null),ae([])})},Ot=(L,W,de)=>{var Se;const Pe=((Se=de.pairs.find(l=>l.leftId===L))==null?void 0:Se.rightId)??null;if(!Pe)return de;const Fe=Pe===W;Ee(l=>({...l,[L]:Fe?"correct":"incorrect"})),He.current&&window.clearTimeout(He.current),E.current&&window.clearTimeout(E.current),se.current+=1;const ce={kind:Fe?"correct":"incorrect",tick:se.current};if(he(null),He.current=window.setTimeout(()=>he(ce),0),E.current=window.setTimeout(()=>he(null),420),Fe){const l={...de.locked,[L]:!0};return Object.keys(l).length>=de.pairs.length?(be("correct"),Ye(!0)):be("correct"),{...de,selection:{...de.selection,[L]:W},activeLeft:null,activeRight:null,locked:l}}return be("incorrect"),{...de,activeLeft:null,activeRight:null}},ja=L=>{ye(W=>!W||W.locked[L]?W:W.activeRight?Ot(L,W.activeRight,W):{...W,activeLeft:W.activeLeft===L?null:L})},cn=L=>{ye(W=>W&&(W.activeLeft?Ot(W.activeLeft,L,W):{...W,activeRight:W.activeRight===L?null:L}))},Pt=()=>{var L;if(xe&&xe.cardType==="info"&&xe.infoType==="citation"&&St.current&&$e&&!((L=_t(xe.direction))!=null&&L.fragmentId)){const W=Ta(St.current,Tt.current,Lt.current,pt,jt,xe.direction,$e.fragmentId);if(W){be(null),fe(""),S(!1),Ie({}),Ye(!1),oe(null),Ue(0),la(St.current,W.id,$e.title);return}}be(null),fe(""),S(!1),Ie({}),Ye(!1),oe(null),Ue(0),ue(W=>Math.min(W+1,d.length))},zt=L=>{if(!xe)return;const W=L.expected??null,de=L.answer??"";let Pe=W??"",Fe=de;if(!W&&L.expectedMap&&L.answerMap){const Q=Object.keys(L.expectedMap).sort((D,te)=>D.localeCompare(te));Pe=Q.map(D=>{var te;return((te=L.expectedMap)==null?void 0:te[D])??""}).join("|"),Fe=Q.map(D=>{var te;return((te=L.answerMap)==null?void 0:te[D])??""}).join("|")}const ce=Pe?Ca(Pe,Fe,na):new Uint8Array,Se={revisionType:T.id,evalType:L.evalType,direction:L.direction,prompt:M??"",expected:W,answer:de,expectedAnswers:L.expectedMap??null,answers:L.answerMap??null,correct:L.correct,maskBase64:ce.length?ua(ce):null,checkMode:Ct,compareMode:na,minCorrectness:sa},l=new TextEncoder().encode(JSON.stringify(Se)),f=xe.cardType==="info"?"info":"connection",P=L.overrideCheckType??xe.checkType??null,_=L.overrideDirection??xe.direction??null;Qa({itemType:f,itemId:xe.cardId,checkType:P,direction:_,revisionType:T.id,evalType:L.evalType,correct:L.correct,maskBase64:ce.length?ua(ce):null,payloadBase64:ua(l)}).then(()=>{Da(f,xe.cardId,P,_),At(d)}).catch(()=>{})},ka=(L,W)=>{const de=p.current.get(W);if(de)return Promise.resolve(de);const Pe=Le.current.get(W);if(Pe)return Pe;const Fe=Nr({shareCode:c,infoId:L,key:Re}).then(ce=>{var Q,D;const Se=ce.payload,l=((Q=Se.definition)==null?void 0:Q.graph)??null,f="",P=((D=Se.definition)==null?void 0:D.answerTemplate)??"",_=Bs(l,f,P);if(_){const A={sample:_s(_),answerTemplate:P||null};return p.current.set(W,A),A}return Wn({shareId:c,infoId:L,key:Re}).then(te=>{const A={sample:te,answerTemplate:null};return p.current.set(W,A),A})}).catch(()=>Wn({shareId:c,infoId:L,key:Re}).then(ce=>{const Se={sample:ce,answerTemplate:null};return p.current.set(W,Se),Se}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{Le.current.delete(W)});return Le.current.set(W,Fe),Fe},Na=(L,W)=>{var l;const de=`${me(L)}:${W}`,Pe=H.current.get(de);if(Pe)return Promise.resolve(Pe);const Fe=et.current.get(de);if(Fe)return Fe;const ce=f=>(H.current.set(de,f),f);let Se;if(L.cardType==="vocab"){if(L.checkType==="translation-match")return Se=Promise.resolve(ce({prompt:L.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),Se;const f=L.label.split("↔").map(P=>P.trim()).filter(Boolean);if(f.length>=2){const _=(L.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",Q=_?f[0]:f[1],D=_?f[1]:f[0];Se=Promise.resolve(ce({prompt:Q,expectedAnswer:D,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else Se=Promise.resolve(ce({prompt:L.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(L.cardType==="info"&&L.infoType==="word"){const f=(l=L.description)!=null&&l.startsWith("Language: ")?L.description.replace("Language: ",""):null;Se=Promise.resolve(ce({prompt:L.label,expectedAnswer:f,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else L.cardType==="info"&&L.infoType==="computed"?Se=ka(L.cardId,de).then(f=>{var te,A;if(!f.sample)return ce({prompt:L.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const P=f.sample,_=P.expectedAnswers?Object.entries(P.expectedAnswers).map(([Z,pe])=>({key:Z,expected:pe})):[],Q=_.reduce((Z,pe)=>(Z[pe.key]="",Z),{}),D=P.expectedAnswerIsSentence&&((te=P.expectedAnswer)==null?void 0:te.trim())||null;return ce({prompt:P.prompt,expectedAnswer:_.length>0?D:((A=P.expectedAnswer)==null?void 0:A.trim())||null,computedExpected:_,computedAnswers:Q,answerTemplate:f.answerTemplate,outputVariables:P.outputVariables??null,variableValues:P.variableValues??null})}).catch(()=>ce({prompt:L.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{et.current.delete(de)}):Se=Promise.resolve(ce({prompt:L.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return et.current.set(de,Se),Se},la=(L,W,de)=>{const Pe=Object.keys(L.nodes).length,Fe=Tt.current.size;if(!W){Te({title:de,before:L.text,after:"",fragmentId:null,total:Pe,completed:Fe}),ee(null),Ye(!0);return}const ce=L.nodes[W];if(!ce)return;const Se=Pn(L.text,ce);Te({title:de,before:Se.before,after:Se.after,fragmentId:ce.id,total:Pe,completed:Fe}),ee(Se.fragment),Ye(!1)},dn=()=>{const L=St.current;L&&Te(W=>W&&{...W,total:Object.keys(L.nodes).length,completed:Tt.current.size})},Sa=()=>{const L=d[I+1];L&&Na(L,I+1)},ga=()=>{if(Sa(),xe&&xe.cardType==="vocab"&&xe.checkType==="translation-match"&&_e){if(_e.pairs.length===0){be("incorrect"),Ye(!0);return}const ce=_e.pairs.reduce((D,te)=>(D[te.rightId]=te.rightLabel,D),{});let Se=0;const l={};_e.pairs.forEach(D=>{const A=_e.selection[D.leftId]===D.rightId;l[D.leftId]=A?"correct":"incorrect",A&&(Se+=1)});const f=_e.pairs.length||1,P=Se/f,_=Se===_e.pairs.length;Ee(D=>({...D,...l})),_?(be("correct"),Ye(!0),Ue(0)):(be("incorrect"),Ye(!1),Ue(D=>{const te=D+1;return te>=wt&&(S(!0),Ye(!0),ye(A=>{if(!A)return A;const Z=A.pairs.reduce((pe,De)=>(pe[De.leftId]=De.rightId,pe),{});return{...A,selection:Z}})),te})),Dt(_,P);const Q="connection";Promise.all(_e.pairs.map(D=>{const te=_e.selection[D.leftId]??null,A=te?ce[te]:"",Z={left:D.leftLabel,expected:D.rightLabel,answer:A,checkType:"translation-match"},pe=new TextEncoder().encode(JSON.stringify(Z));return Qa({itemType:Q,itemId:D.cardId,checkType:"translation-match",direction:null,revisionType:T.id,evalType:"translation-match",correct:te===D.rightId,maskBase64:null,payloadBase64:ua(pe)})})).then(()=>{Da(Q,xe.cardId,xe.checkType,xe.direction),At(d)}).catch(()=>{});return}if(G.length>0){const ce=G.reduce((l,f)=>{const P=we[f.key]??"";return l[f.key]=Kt(P)===Kt(f.expected)?"correct":"incorrect",l},{});G.every(({key:l,expected:f})=>{const P=we[l]??"";return Ct==="exact"&&Kt(P)===Kt(f)})?(be("correct"),Ie(ce),Ye(!0),Ue(0),Dt(!0,1),zt({correct:!0,direction:M?`${M} -> computed`:"computed",expectedMap:G.reduce((l,f)=>(l[f.key]=f.expected,l),{}),answerMap:we,evalType:"computed"})):(be("incorrect"),Ie(ce),Ye(!1),Ue(l=>{const f=l+1;return f>=wt&&Yt&&(S(!0),Ye(!0)),f}),Dt(!1,0),window.setTimeout(()=>{var f;const l=tn(qe,G,Ae);l&&rt.current[l]&&((f=rt.current[l])==null||f.focus())},40),zt({correct:!1,direction:M?`${M} -> computed`:"computed",expectedMap:G.reduce((l,f)=>(l[f.key]=f.expected,l),{}),answerMap:we,evalType:"computed"}));return}if(xe&&xe.cardType==="info"&&xe.infoType==="citation"&&($e!=null&&$e.fragmentId)){if(!J)return;const ce=_t(xe.direction),Se=(ce==null?void 0:ce.fragmentId)??$e.fragmentId,l=Ga(J,re,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),f=l.mask,P=l.isCorrect,_=l.percent;P?(Lt.current[$e.fragmentId]=Math.max(Lt.current[$e.fragmentId]??0,_),(Lt.current[$e.fragmentId]??0)>=pt&&Tt.current.add($e.fragmentId),dn(),be("correct"),Ie({}),Ye(!0),oe(f),Ue(0),_<100&&wt<=1&&S(!0),Dt(!0,_/100),zt({correct:!0,direction:`quote:${$e.fragmentId}`,expected:J,answer:re,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Se})):(be("incorrect"),Ie({}),Ye(!1),oe(f),Ue(Q=>{const D=Q+1;return D>=wt&&Yt&&(S(!0),Ye(!0)),D}),Dt(!1,_/100),window.setTimeout(()=>{var Q;return(Q=at.current)==null?void 0:Q.focus()},40),zt({correct:!1,direction:`quote:${$e.fragmentId}`,expected:J,answer:re,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Se}));return}if(!J)return;const L=Ca(J,re,na),W=Ct==="exact"&&Kt(re)===Kt(J),de=ma(L),Pe=W||de,Fe=ha(L);Pe?(be("correct"),Ie({}),Ye(!0),oe(L),Ue(0),Fe<100&&wt<=1&&S(!0),Dt(!0,Fe/100),zt({correct:!0,direction:M?`${M} -> ${J}`:null,expected:J,answer:re,evalType:"text"})):(be("incorrect"),Ie({}),Ye(!1),oe(L),Ue(ce=>{const Se=ce+1;return Se>=wt&&Yt&&(S(!0),Ye(!0)),Se}),Dt(!1,Fe/100),window.setTimeout(()=>{var ce;return(ce=at.current)==null?void 0:ce.focus()},40),zt({correct:!1,direction:M?`${M} -> ${J}`:null,expected:J,answer:re,evalType:"text"}))},Ht=L=>{if(Sa(),!J)return;const W=Ca(J,L,na),de=Kt(L)===Kt(J),Pe=ma(W),Fe=de||Pe,ce=ha(W);Fe?(be("correct"),Ie({}),Ye(!0),oe(W),Ue(0),ce<100&&wt<=1&&S(!0),Dt(!0,ce/100),zt({correct:!0,direction:"word->language",expected:J,answer:L,evalType:"language-select"})):(be("incorrect"),Ie({}),Ye(!1),oe(W),Ue(Se=>{const l=Se+1;return l>=wt&&Yt&&(S(!0),Ye(!0)),l}),Dt(!1,ce/100),zt({correct:!1,direction:"word->language",expected:J,answer:L,evalType:"language-select"}))},un=L=>{var de;if(L.key!=="Enter")return;if(L.preventDefault(),L.stopPropagation(),vt){Pt();return}const W=G.find(Pe=>!(we[Pe.key]??"").trim());if(W){(de=rt.current[W.key])==null||de.focus();return}ga()},Ma=()=>{Sa(),be("correct"),Ye(!0),Ue(0),Dt(!0,1),J&&zt({correct:!0,direction:"manual",expected:J,answer:re,evalType:"manual"})},pa=()=>{if(Dt(!1,0),xe&&xe.cardType==="info"&&xe.infoType==="citation"){be(null),fe(""),S(!1),Ie({}),Ye(!1),oe(null),Ue(0),ue(L=>Math.min(L+1,d.length));return}Pt()};a.useEffect(()=>{Sa()},[I,d]);const hn=t.cogita.library.revision.revealModeAfterIncorrect,Yt=G.length>0||!!J;return e.jsxs(Ft,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:m,secureMode:h,onNavigate:b,language:j,onLanguageChange:k,children:[(u==="loading"||V==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:u==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${Y.total?Math.min(100,Math.max(0,Y.current/Y.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:Y.total?`${Math.min(Y.current,Y.total)} / ${Y.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:w}),e.jsx("p",{className:"cogita-library-subtitle",children:F}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",ze).replace("{check}",ut)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:O?`${O.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Jt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Jt.currentLevel??"-"," / ",Jt.levelsCount]}):null,O?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(O.correct)).replace("{total}",String(O.total))}),O.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(O.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(Vs,{outcomes:U})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[ke?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:ke})}):null,e.jsx(Kn,{feedbackToken:B?`${B.kind}-${B.tick}`:Wt?"idle":Ce??"idle",children:u!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:u==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):xe?e.jsx(e.Fragment,{children:ct?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(Fn,{copy:t,currentCard:xe,currentTypeLabel:gt,prompt:M,languages:K,answer:re,onAnswerChange:L=>fe(W=>en(W,L,R)),computedExpected:G,computedAnswers:we,onComputedAnswerChange:(L,W)=>Ve(de=>({...de,[L]:en(de[L]??"",W,R)})),answerTemplate:qe,outputVariables:Ae,variableValues:tt,computedFieldFeedback:Je,feedback:Ce,canAdvance:vt,quoteContext:$e,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:ga,onSkip:pa,onLanguageSelect:Ht,onMarkReviewed:Ma,onAdvance:Pt,showCorrectAnswer:ne,setShowCorrectAnswer:S,onRevealCorrect:()=>Ye(!0),answerMask:le,expectedAnswer:J,hasExpectedAnswer:Yt,handleComputedKeyDown:un,answerInputRef:at,computedInputRefs:rt,scriptMode:R,setScriptMode:X,matchPairs:_e==null?void 0:_e.pairs,matchLeftOrder:_e==null?void 0:_e.leftOrder,matchRightOrder:_e==null?void 0:_e.rightOrder,matchSelection:_e==null?void 0:_e.selection,matchActiveLeft:_e==null?void 0:_e.activeLeft,matchActiveRight:_e==null?void 0:_e.activeRight,matchFeedback:q,onMatchLeftSelect:ja,onMatchRightSelect:cn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:kt?`${Mt} / ${kt}`:t.cogita.library.revision.progressUnlimited}),u==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),u==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),u==="ready"&&V==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),u==="ready"&&V==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),u==="ready"&&V==="ready"&&d.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:hn}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",wt]})]})]}),Jt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Jt.activeCount," / ",Jt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Jt.counts.map((L,W)=>{const de=W+1,Pe=Jt.currentLevel===de,Fe=Jt.percentages[W]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":Pe,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:de}),e.jsx("strong",{children:L})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,Fe))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[Fe.toFixed(1),"%"]})]},`level-${de}`)})})]}):null,va?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:va.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:va.dots.map(L=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-L.value))}, ${Math.round(200*L.value)}, 80, 0.9)`}},L.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:va.knownCount})]})]}):null,jt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:ln})]})}):null]})]})]})})})]})]})}const Vi=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:Ki},Symbol.toStringTag,{value:"Module"}));export{Bi as C,_i as a,Vi as b};
