import{r as n,j as e,u as Wa,a as Pa,b as Qn,c as Gn,d as Yn,R as fn,B as bn,C as yn,Q as Js}from"./vendor-CAC2WLor.js";import{L as Hs,A as Ws,g as Qs,a as br,b as Ua,c as Xn,s as ds,d as Zn,e as yr,f as Mn,h as aa,i as xr,j as vr,k as nn,l as sn,m as Gs,n as es,o as Un,p as jr,u as us,q as ts,r as wr,t as kr,v as Nr,w as Sr,x as Tr,y as Ys,z as Cr,B as Xs,C as Zs,D as Ir,E as Mr,F as xn,G as Ja,H as Lr,I as er,J as Ar,K as as,M as tr,N as Rr,O as $r,P as Pr,Q as Jn,R as ya,S as Er,T as Fr,U as Kr,V as _r,W as Dr,X as Br,Y as zr,Z as Vr,_ as Or,$ as qr,a0 as Ur,a1 as hs,a2 as Jr,a3 as gs,a4 as ms,a5 as Hr,a6 as ar,a7 as Wr,a8 as Qr,a9 as Gr,aa as Yr,ab as Hn,ac as Xr,ad as Zr,ae as ei,af as ti}from"./recreatio-core-R1dGNl-U.js";import"./vendor-cogita-ui-DTaQ_FiW.js";const Va={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},Da={moveMs:900,pauseMs:220,errorMs:900},ai=(t=11)=>{let a=t;const s=()=>(a=(a*1664525+1013904223)%4294967296,a/4294967296),{width:r,height:i,paddingX:u,paddingY:l,levels:b}=Va,m=(i-l*2)/(b.length-1),x=[],d=[],p=[];b.forEach((v,y)=>{const Z=i-l-y*m,V=r-u*2,w=[];for(let Q=0;Q<v;Q+=1){const S=u+(Q+1)*V/(v+1),te=(s()-.5)*18,T=Math.max(u,Math.min(r-u,S+te)),$=y===0?3:y<2?2.1:1.4,oe=y===0?"root":`l${y}-${Q}`;w.push({id:oe,x:y===0?r/2:T,y:Z,r:$,level:y,role:y===0?"root":void 0})}p.push(w),x.push(...w)});const o=p[p.length-1];if(o!=null&&o.length){const v=o[Math.floor(o.length/2)];v.role="goal",v.r=2}for(let v=1;v<p.length;v+=1){const y=p[v-1];p[v].forEach(V=>{const w=[...y].sort((T,$)=>Math.abs(T.x-V.x)-Math.abs($.x-V.x)),Q=w[0],S=w[1]&&s()<.45?w[1]:null;(S?[Q,S]:[Q]).forEach(T=>{d.push({from:T.id,to:V.id,key:`${T.id}-${V.id}`})}),s()<.2&&w[2]&&d.push({from:w[2].id,to:V.id,key:`${w[2].id}-${V.id}`})})}const c=new Map;d.forEach(v=>{const y=c.get(v.to)??[];y.push(v.from),c.set(v.to,y)});const j=new Map,h=new Map,k=new Map;d.forEach(v=>{const y=j.get(v.from)??[];y.push(v.key),j.set(v.from,y);const Z=h.get(v.from)??[];Z.push(v.to),h.set(v.from,Z);const V=k.get(v.from)??[];V.push(v.to),k.set(v.from,V);const w=k.get(v.to)??[];w.push(v.from),k.set(v.to,w)});const L=new Map;return x.forEach(v=>{L.set(v.id,v)}),{nodes:x,links:d,parentsById:c,linksByFrom:j,childrenByFrom:h,neighborsById:k,nodesById:L}};function ni({slides:t,activeIndex:a,introOpen:s,prefersReducedMotion:r,onNext:i,onPrev:u,onSelect:l,onExit:b,onOpen:m,onRegister:x}){const d=a===t.length-1,p=s&&a===0?"entry":"docked",o=t[t.length-1],[c,j]=n.useState(!1),h=n.useMemo(()=>Array.from({length:20},(z,F)=>({src:`/cogita/logo/Cogita${String(F).padStart(2,"0")}.png`,kind:F<=11?"bubble":F<=17?"text":"recreatio"})),[]),k=s&&a===0;n.useEffect(()=>{if(!s){j(!1);return}a>0&&!c&&j(!0)},[a,s,c]);const L=n.useRef(0),v=n.useRef(null),y=n.useMemo(()=>{const z={x:40,y:160},F={x:260,y:48},N=6,C=F.x-z.x,A=z.y-F.y,de=C/N,xe=[.3,.45,.6,.65,1.4,2.2],ge=xe.reduce((Y,ee)=>Y+ee,0),ae=xe.map(Y=>A*Y/ge),P=[z];let X=z.x,se=z.y;for(let Y=1;Y<=N;Y+=1){const ee=(Math.random()-.5)*14,Re=(Math.random()-.5)*28;X=Math.max(z.x+Y*14,Math.min(F.x-(N-Y)*14,X+de+ee));const ue=ae[Y-1]??ae[ae.length-1];se=se-ue+Re;const fe=Math.max(F.y,Math.min(z.y-4,se));P.push({x:Math.round(X),y:Math.round(fe)})}return P[P.length-1]=F,P},[]),Z=n.useMemo(()=>{const A=(ge,ae,P)=>Math.min(P,Math.max(ae,ge)),de=y.map(ge=>{const ae=10+Math.random()*36;return{x:A(ge.x,40,260),y:A(ge.y-ae,40,140)}}),xe=y.map((ge,ae)=>{var se;const P=12+Math.random()*40,X=((se=de[ae])==null?void 0:se.y)??ge.y;return{x:A(ge.x,40,260),y:A(Math.max(X+10,ge.y+P),60,170)}});return{upper:de,lower:xe}},[y]),V=n.useMemo(()=>{var F;const z=((F=y[4])==null?void 0:F.x)??260;return Math.max(0,Math.min(240,z-40))},[y]),w=n.useMemo(()=>{var ae,P;const z=(X,se,Y)=>Math.min(Y,Math.max(se,X)),F=(X,se,Y)=>y.map((ee,Re)=>{var Ct,St;const ue=((Ct=Z.upper[Re])==null?void 0:Ct.y)??ee.y,fe=((St=Z.lower[Re])==null?void 0:St.y)??ee.y,ze=(Math.random()-.5)*70,et=ee.y+X+ze,Qe=z(ee.y+se,ue+6,fe-6),Xe=z(ee.y+Y,ue+6,fe-6);return{x:ee.x,y:z(et,Math.min(Qe,Xe),Math.max(Qe,Xe))}}),N=-14+Math.random()*28,C=14+Math.random()*28,A=F(N,-80,12),de=F(C,-12,80);for(let X=4;X<y.length;X+=1){const se=y[X],Y=((ae=Z.upper[X])==null?void 0:ae.y)??se.y,ee=((P=Z.lower[X])==null?void 0:P.y)??se.y;A[X]={x:se.x,y:z(se.y-12,Y+6,ee-6)},de[X]={x:se.x,y:z(se.y+12,Y+6,ee-6)}}const xe=Z.upper.length?Z.upper[Z.upper.length-1].y:40,ge=Z.lower.length?Z.lower[Z.lower.length-1].y:170;return A[A.length-1]={x:y[y.length-1].x,y:z(y[y.length-1].y-14,xe,ge)},de[de.length-1]={x:y[y.length-1].x,y:z(y[y.length-1].y+12,xe,ge)},{higher:A,lower:de}},[y,Z]),Q=1e4,S=n.useMemo(()=>{let z=17;const F=()=>(z=(z*1664525+1013904223)%4294967296,z/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((C,A)=>{const de=(F()-.5)*240,xe=(F()-.5)*180,ge=(F()-.5)*24;return{id:`card-${A+1}`,throw:{x:`${de.toFixed(0)}px`,y:`${xe.toFixed(0)}px`,rot:`${ge.toFixed(1)}deg`},grid:{x:`${C.x}px`,y:`${C.y}px`},delay:`${A*.12}s`}})},[]),te=n.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[T,$]=n.useState([]),oe=n.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),me=n.useMemo(()=>{const F=[],C=(de,xe)=>de+Math.random()*(xe-de);for(let de=0;de<6;de+=1){let xe=!1;for(let ge=0;ge<80;ge+=1){const ae=C(14,86),P=C(10,34);if(F.every(se=>{const Y=se.x-ae,ee=se.y-P;return Math.hypot(Y,ee)>=12})){F.push({x:ae,y:P}),xe=!0;break}}xe||F.push({x:C(16,84),y:C(12,32)})}return F.map((de,xe)=>({id:`p${xe+1}`,x:`${de.x.toFixed(1)}%`,y:`${de.y.toFixed(1)}%`,xNum:de.x,yNum:de.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[Se,Je]=n.useState(0),[pe,E]=n.useState(0),[D,M]=n.useState([]),G=1e4,O=n.useMemo(()=>{if(me.length<2)return[];const z=xe=>{let ge=xe+1831565813;return ge=Math.imul(ge^ge>>>15,ge|1),ge^=ge+Math.imul(ge^ge>>>7,ge|61),((ge^ge>>>14)>>>0)/4294967296},F=(xe,ge)=>Math.floor(z(xe)*ge),N=new Set,C=[],A=Math.min(3,me.length);let de=0;for(;C.length<A&&de<30;){de+=1;const xe=F(Se*13+de*5,me.length),ge=F(Se*29+de*7,me.length);if(xe===ge)continue;const ae=xe<ge?`${xe}-${ge}`:`${ge}-${xe}`;N.has(ae)||(N.add(ae),C.push({id:`link-${ae}`,from:me[xe],to:me[ge],delay:`${(de*.35).toFixed(2)}s`}))}return C},[Se,me]);n.useEffect(()=>{if(!s||a!==2)return;const z=()=>{const N=S.map(C=>C.id);for(let C=N.length-1;C>0;C-=1){const A=Math.floor(Math.random()*(C+1));[N[C],N[A]]=[N[A],N[C]]}return N.slice(0,4)};$(z());const F=window.setInterval(()=>{$(z())},Q);return()=>window.clearInterval(F)},[a,s,S,Q]),n.useEffect(()=>{if(!s||a!==3)return;const z=()=>{E(Math.floor(Math.random()*oe.length)),M(me.map(()=>Math.random()<.6?"good":"bad")),Je(N=>N+1)};z();const F=window.setInterval(z,G);return()=>window.clearInterval(F)},[a,s,oe.length,me,G]);const K=n.useMemo(()=>ai(11),[]),[W,U]=n.useState(new Set(["root"])),[ce,ve]=n.useState(new Set),[Me,Ie]=n.useState(new Set),[He,it]=n.useState({fromId:"root",toId:"root",key:0}),Ce=n.useRef(W),Ye=n.useRef("root"),kt=n.useRef(0),Oe=n.useRef(null),De=n.useRef(null),rt=n.useRef([]);n.useEffect(()=>{Ce.current=W},[W]);const gt=n.useMemo(()=>{const z=new Set;return W.forEach(F=>{const N=K.linksByFrom.get(F);N&&N.forEach(C=>z.add(C))}),z},[W,K]),tt=K.nodesById.get(He.toId)??K.nodesById.get("root"),Le=tt?`${tt.x/Va.width*100}%`:"50%",Be=tt?`${tt.y/Va.height*100}%`:"90%";n.useEffect(()=>{if(!s||a!==1||r)return;(()=>{U(new Set(["root"])),ve(new Set),Ie(new Set),it({fromId:"root",toId:"root",key:0}),De.current=null,kt.current=0,Ye.current="root",rt.current=[]})();const F=()=>{const C=Ye.current,A=Ce.current,xe=(K.childrenByFrom.get(C)??[]).filter(ee=>!A.has(ee));if(xe.length)return xe[Math.floor(Math.random()*xe.length)];if(A.size>=K.nodes.length){const ee=K.neighborsById.get(C)??[];return ee.length?ee[Math.floor(Math.random()*ee.length)]:null}const ge=ee=>(K.childrenByFrom.get(ee)??[]).some(ue=>!A.has(ue)),ae=[C],P=new Set([C]),X=new Map;let se=null;for(;ae.length;){const ee=ae.shift();if(!ee)break;if(ee!==C&&ge(ee)){se=ee;break}(K.neighborsById.get(ee)??[]).forEach(ue=>{P.has(ue)||(P.add(ue),X.set(ue,ee),ae.push(ue))})}if(!se)return null;let Y=se;for(;X.get(Y)&&X.get(Y)!==C;)Y=X.get(Y)??Y;return Y},N=(C,A)=>{if(C===A){const de=F();de&&N(C,de);return}kt.current+=1,it({fromId:C,toId:A,key:kt.current}),Ye.current=A,Oe.current=window.setTimeout(()=>{const de=K.parentsById.get(A)??[],xe=Ce.current,ge=de.filter(se=>!xe.has(se));if(!ge.length){const se=new Set(xe);se.add(A),U(se),Oe.current=window.setTimeout(()=>{for(;rt.current.length;){const ee=rt.current[rt.current.length-1];if(!se.has(ee)){if(ee!==A){N(A,ee);return}break}rt.current.pop()}const Y=F();Y&&N(A,Y)},Da.pauseMs);return}const ae=new Set([A,...ge]),P=new Set(ge.map(se=>`${se}-${A}`));ve(ae),Ie(P),rt.current.includes(A)||rt.current.push(A);const X=ge[Math.floor(Math.random()*ge.length)];De.current={fromId:A,toId:X},Oe.current=window.setTimeout(()=>{ve(new Set),Ie(new Set);const se=De.current;se&&N(se.fromId,se.toId)},Da.errorMs)},Da.moveMs)};return Oe.current=window.setTimeout(()=>{const C=F();C&&N(Ye.current,C)},Da.pauseMs),()=>{Oe.current&&window.clearTimeout(Oe.current)}},[a,s,K,r]);const at=z=>{if(!s)return;const F=Date.now();F-L.current<520||Math.abs(z.deltaY)<10||(L.current=F,z.deltaY>0?i():u(),z.preventDefault())},_=z=>{if(!s)return;const F=z.touches[0];F&&(v.current={x:F.clientX,y:F.clientY})},R=z=>{if(!s)return;const F=v.current;if(v.current=null,!F)return;const N=z.changedTouches[0];if(!N)return;const C=N.clientX-F.x,A=N.clientY-F.y;Math.abs(A)<40||Math.abs(A)<Math.abs(C)||(A<0?i():u())};return e.jsxs("div",{className:`cogita-intro ${s?"is-open":"is-closed"} ${r?"is-reduced":""} ${d?"is-final":""}`,"data-slide":a+1,onWheel:at,onTouchStart:_,onTouchEnd:R,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":p,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${k&&!c?"is-entry":""}`,children:h.map((z,F)=>e.jsx("img",{src:z.src,alt:"",className:`cogita-logo-layer ${F===0?"is-base":""} ${z.kind==="text"?"is-text":z.kind==="recreatio"?"is-recreatio":""} ${z.kind==="bubble"?"is-bubble":""}`},z.src))})}),s&&t.map((z,F)=>{const N=F===a;return e.jsxs("section",{className:`cogita-intro-slide slide-${F+1} ${N?"is-active":""}`,"aria-hidden":!N,children:[e.jsxs("div",{className:"cogita-intro-text",children:[z.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:z.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:z.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:z.title}),z.body&&e.jsx("p",{children:z.body.split(`
`).map((C,A)=>e.jsxs("span",{children:[C,A===0&&e.jsx("br",{})]},String(A)))})]}),z.micro&&e.jsx("p",{className:"cogita-intro-micro",children:z.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:d?x:i,children:z.cta}),d&&z.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>l(0),children:z.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[F===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${Va.width} ${Va.height}`,preserveAspectRatio:"none",children:[K.links.map(C=>{const A=K.nodesById.get(C.from),de=K.nodesById.get(C.to);if(!A||!de)return null;const xe=gt.has(C.key),ge=Me.has(C.key);return e.jsx("line",{className:`map-link ${xe?"is-active":""} ${ge?"is-error":""}`,x1:A.x,y1:A.y,x2:de.x,y2:de.y},C.key)}),K.nodes.map(C=>{const A=W.has(C.id),de=ce.has(C.id);return e.jsx("circle",{className:`map-node ${C.role?`is-${C.role}`:""} ${A?"is-active":""} ${de?"is-error":""}`,cx:C.x,cy:C.y,r:C.r},C.id)})]}),tt&&e.jsx("span",{className:"map-explorer-dot",style:{left:Le,top:Be,"--move":`${Da.moveMs}ms`}})]}),F===2&&e.jsx("div",{className:"cogita-index-cards",children:S.map(C=>{const A=T.indexOf(C.id),de=A>=0?te[A]:null,xe=(de==null?void 0:de.x)??"140px",ge=(de==null?void 0:de.y)??"140px",ae=A>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":C.throw.x,"--throw-y":C.throw.y,"--throw-rot":C.throw.rot,"--grid-x":C.grid.x,"--grid-y":C.grid.y,"--stack-x":xe,"--stack-y":ge,"--stack-opacity":ae,"--delay":C.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},C.id)})}),F===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[oe.map((C,A)=>e.jsxs("div",{className:`round-card ${A===pe?"is-active":""}`,style:{"--card-x":C.x,"--card-y":C.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},C.id)),oe[pe]&&e.jsx("span",{className:"round-ring",style:{"--card-x":oe[pe].x,"--card-y":`calc(${oe[pe].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:me.map(C=>e.jsx("span",{className:"player-dot",style:{left:C.x,top:C.y,"--jitter-x":C.jitterX,"--jitter-y":C.jitterY,"--breath-delay":C.delay}},C.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:O.map(C=>e.jsx("line",{className:"round-link",x1:C.from.xNum,y1:C.from.yNum,x2:C.to.xNum,y2:C.to.yNum,style:{"--delay":C.delay}},C.id))}),e.jsx("div",{className:"round-flows",children:me.map((C,A)=>{const de=D[A]??"good",xe=oe[pe];if(!xe)return null;const ge=`calc(${xe.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":C.x,"--from-y":C.y,"--to-x":xe.x,"--to-y":ge,"--delay":`${A*.12}s`}}),e.jsx("span",{className:`return-dot is-${de}`,style:{"--from-x":xe.x,"--from-y":ge,"--to-x":C.x,"--to-y":C.y,"--delay":`${A*.12}s`}}),e.jsx("span",{className:`result-pop is-${de}`,style:{"--at-x":C.x,"--at-y":C.y,"--delay":`${A*.12}s`}})]},`${C.id}-${Se}`)})})]},`round-${Se}`),F===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${y[0].x} ${y[0].y} L${y[1].x} ${y[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${y[1].x} ${y[1].y} L${y[2].x} ${y[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${y[2].x} ${y[2].y} L${y[3].x} ${y[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${y[3].x} ${y[3].y} L${y[4].x} ${y[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${y[4].x} ${y[4].y} L${y[5].x} ${y[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${y[5].x} ${y[5].y} L${y[6].x} ${y[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${V};${V};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${Z.upper.map((C,A)=>`${A===0?"M":"L"}${C.x} ${C.y}`).join(" ")} ${Z.lower.slice().reverse().map(C=>`L${C.x} ${C.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${Z.upper.map((C,A)=>`${A===0?"M":"L"}${C.x} ${C.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${Z.lower.map((C,A)=>`${A===0?"M":"L"}${C.x} ${C.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[w.higher.slice(0,6).map((C,A)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${A+1}`,d:`M${C.x} ${C.y} L${w.higher[A+1].x} ${w.higher[A+1].y}`,pathLength:"100"},`peer-1-${A}`)),w.lower.slice(0,6).map((C,A)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${A+1}`,d:`M${C.x} ${C.y} L${w.lower[A+1].x} ${w.lower[A+1].y}`,pathLength:"100"},`peer-2-${A}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${y[0].x/300*100}%`,"--p0y":`${y[0].y/200*100}%`,"--p1x":`${y[1].x/300*100}%`,"--p1y":`${y[1].y/200*100}%`,"--p2x":`${y[2].x/300*100}%`,"--p2y":`${y[2].y/200*100}%`,"--p3x":`${y[3].x/300*100}%`,"--p3y":`${y[3].y/200*100}%`,"--p4x":`${y[4].x/300*100}%`,"--p4y":`${y[4].y/200*100}%`,"--p5x":`${y[5].x/300*100}%`,"--p5y":`${y[5].y/200*100}%`,"--p6x":`${y[6].x/300*100}%`,"--p6y":`${y[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${w.higher[0].x/300*100}%`,"--q0y":`${w.higher[0].y/200*100}%`,"--q1x":`${w.higher[1].x/300*100}%`,"--q1y":`${w.higher[1].y/200*100}%`,"--q2x":`${w.higher[2].x/300*100}%`,"--q2y":`${w.higher[2].y/200*100}%`,"--q3x":`${w.higher[3].x/300*100}%`,"--q3y":`${w.higher[3].y/200*100}%`,"--q4x":`${w.higher[4].x/300*100}%`,"--q4y":`${w.higher[4].y/200*100}%`,"--q5x":`${w.higher[5].x/300*100}%`,"--q5y":`${w.higher[5].y/200*100}%`,"--q6x":`${w.higher[6].x/300*100}%`,"--q6y":`${w.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${w.lower[0].x/300*100}%`,"--q0y":`${w.lower[0].y/200*100}%`,"--q1x":`${w.lower[1].x/300*100}%`,"--q1y":`${w.lower[1].y/200*100}%`,"--q2x":`${w.lower[2].x/300*100}%`,"--q2y":`${w.lower[2].y/200*100}%`,"--q3x":`${w.lower[3].x/300*100}%`,"--q3y":`${w.lower[3].y/200*100}%`,"--q4x":`${w.lower[4].x/300*100}%`,"--q4y":`${w.lower[4].y/200*100}%`,"--q5x":`${w.lower[5].x/300*100}%`,"--q5y":`${w.lower[5].y/200*100}%`,"--q6x":`${w.lower[6].x/300*100}%`,"--q6y":`${w.lower[6].y/200*100}%`}})]})})}),F===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),F===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},z.id)}),!s&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:o.title}),o.body&&e.jsx("p",{children:o.body}),o.micro&&e.jsx("p",{className:"cogita-intro-micro",children:o.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,children:o.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:m,children:"Otwórz pokaz"})]})]})})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((z,F)=>e.jsx("button",{type:"button",className:`dot ${a===F?"active":""}`,"aria-label":z.title,onClick:()=>l(F)},z.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:b,children:"Pomiń"})]})]})}const si=6,ri=4;function ii({copy:t,onAuthAction:a,authLabel:s,showProfileMenu:r,onProfileNavigate:i,onToggleSecureMode:u,onLogout:l,secureMode:b,onNavigate:m,language:x,onLanguageChange:d}){const p=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}m("home")},o=n.useRef(null),c=n.useRef([]),j=n.useMemo(()=>{let M=Date.now()%2147483647;const G=()=>(M=M*48271%2147483647,M/2147483647);return Array.from({length:si},(O,K)=>{const W=6+G()*8,U=7+G()*10,ce=6+G()*9,ve=-G()*W,Me=-G()*U,Ie=-G()*ce,He=.18+G()*.28,it=12+G()*18,Ce=4+G()*8,Ye=(G()-.5)*3.2,kt=(G()-.5)*3.8,Oe=G()>.5?"alternate":"alternate-reverse",De=G()>.5?"alternate":"alternate-reverse",rt=G()>.5?"alternate":"alternate-reverse",gt=.18+G()*.42,tt=30+G()*60,Le=-45-G()*38,Be=188+G()*32,at=.1+G()*.2;return{id:`wave-${K+1}`,style:{"--wave-sway-duration":`${W}s`,"--wave-scale-duration":`${U}s`,"--wave-drift-duration":`${ce}s`,"--wave-sway-delay":`${ve}s`,"--wave-scale-delay":`${Me}s`,"--wave-drift-delay":`${Ie}s`,"--wave-sway-dir":Oe,"--wave-scale-dir":De,"--wave-drift-dir":rt,"--wave-scale":`${He}`,"--wave-shift":`${it}%`,"--wave-xshift":`${Ce}%`,"--wave-x0":`${Ye}%`,"--wave-y0":`${kt}%`,"--wave-opacity":`${gt}`,"--wave-blur":`${tt}px`,"--wave-bottom":`${Le}%`,"--wave-hue":`${Be}`,"--wave-glow":`${at}`}}})},[]),h=n.useMemo(()=>{let M=Date.now()*3%2147483647;const G=()=>(M=M*48271%2147483647,M/2147483647);return Array.from({length:ri},(O,K)=>{const W=180+G()*220,U=220+G()*280,ce=-G()*W,ve=-G()*U,Me=.12+G()*.22,Ie=3+G()*7,He=1+G()*3,it=(G()-.5)*2.8,Ce=(G()-.5)*2.2;return{id:`mesh-${K+1}`,seed:1e3+K*991+Math.floor(G()*999),style:{"--mesh-sway-duration":`${W}s`,"--mesh-drift-duration":`${U}s`,"--mesh-sway-delay":`${ce}s`,"--mesh-drift-delay":`${ve}s`,"--mesh-scale":`${Me}`,"--mesh-shift":`${Ie}%`,"--mesh-xshift":`${He}%`,"--mesh-x0":`${Ce}%`,"--mesh-y0":`${it}%`}}})},[]),k=n.useMemo(()=>{const M=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],G=t.cogita.introSlides,O=new Map(G.map(K=>[K.id,K]));return M.map(K=>{var U;const W=O.get(K.id);return{...K,...W,title:(W==null?void 0:W.title)??"Cogita",cta:(W==null?void 0:W.cta)??((U=t.cogita.introSlides[0])==null?void 0:U.cta)??t.cogita.loginCta,secondary:W==null?void 0:W.secondary}})},[t.cogita.introSlides]),[L,v]=n.useState(0),[y,Z]=n.useState(!0),[V,w]=n.useState(!1),Q=k.length-1,S=n.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),te=n.useCallback(()=>{S(),a()},[S,a]),T=n.useCallback(()=>{Z(!0),v(0)},[]),$=n.useCallback(()=>{Z(!1),v(Q)},[Q]),oe=n.useCallback(M=>{v(Math.max(0,Math.min(Q,M)))},[Q]),me=n.useCallback(()=>{L>=Q?te():oe(L+1)},[L,oe,te,Q]),Se=n.useCallback(()=>{oe(L-1)},[L,oe]);n.useEffect(()=>{var O;const M=(O=window.matchMedia)==null?void 0:O.call(window,"(prefers-reduced-motion: reduce)");if(!M)return;const G=()=>w(M.matches);return G(),M.addEventListener?(M.addEventListener("change",G),()=>M.removeEventListener("change",G)):(M.addListener(G),()=>M.removeListener(G))},[]),n.useEffect(()=>{if(!y)return;const M=G=>{const O=G.target;if(!O)return;const K=O.tagName;if(!(O.isContentEditable||K==="INPUT"||K==="TEXTAREA"||K==="SELECT"||K==="BUTTON"||K==="A"||O.closest('button, a, [role="button"], [role="link"]'))){if(G.key==="Escape"){$();return}if(G.key==="ArrowLeft"||G.key==="ArrowUp"){Se();return}(G.key==="ArrowRight"||G.key==="ArrowDown"||G.code==="Space"||G.key===" ")&&(G.preventDefault(),me())}};return window.addEventListener("keydown",M),()=>window.removeEventListener("keydown",M)},[$,me,Se,y]),n.useEffect(()=>{y&&L===Q&&S()},[L,y,Q,S]),n.useEffect(()=>{const M=o.current;if(!M)return;const G=c.current.filter(Le=>!!Le);if(!G.length)return;const O=1,K=.6,W=.6,U=Math.max(1,Math.min(O,window.devicePixelRatio||1));let ce=0,ve=0,Me=K,Ie=0,He=0;const it=Le=>{let Be=Le%2147483647;return Be<=0&&(Be+=2147483646),(at,_)=>{Be=Be*48271%2147483647;const R=Be/2147483647;return at+R*(_-at)}},Ce={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},Ye=Le=>{const Be=Math.sin(Le*12.9898)*43758.5453;return Be-Math.floor(Be)},kt=Le=>{const Be=Ye(Le+.1)||1e-4,at=Ye(Le+.7)||1e-4;return Math.sqrt(-2*Math.log(Be))*Math.cos(2*Math.PI*at)},Oe=(Le,Be)=>{const at=Math.floor(Le),_=at+1,R=Le-at,z=R*R*(3-2*R),F=Ye(at*12.9898+Be*78.233),N=Ye(_*12.9898+Be*78.233);return F+(N-F)*z},De=Le=>{const Be=it(Le),at=Math.min(4,Math.max(4,Math.floor(ce/1200*Ce.filamentCount)));return Array.from({length:at},(_,R)=>{const z=Math.max(-1,Math.min(1,kt(Le+R*.37))),F=Math.min(1,Math.max(0,Ye(Le+R*1.31))),N=Math.min(Ce.depthLayers-1,Math.floor(F*Ce.depthLayers));return{seed:Be(0,Math.PI*2)+Le*.01,offset:z,freqA:Ce.freq1*(.75+Be(0,.5)),freqB:Ce.freq2*(.75+Be(0,.5)),ampA:Ce.amp1*(.6+Be(0,.7)),ampB:Ce.amp2*(.6+Be(0,.7)),width:2+R%5*.32,depth:F,layer:N}})},rt=(Le,Be,at)=>{const _=Math.max(30,Math.floor(ce*ve/14e4));Le.save(),Le.globalAlpha=.6;for(let R=0;R<_;R+=1){const z=Ye(R*9.1+ce*.11)*Be+at,F=Ye(R*3.7+ve*.23)*ve,N=1.2+Ye(R*5.9)*2.4,C=Le.createRadialGradient(z,F,0,z,F,N*2);C.addColorStop(0,"rgba(10, 30, 60, 0.45)"),C.addColorStop(1,"rgba(10, 30, 60, 0)"),Le.fillStyle=C,Le.beginPath(),Le.arc(z,F,N*2,0,Math.PI*2),Le.fill()}Le.restore()},gt=(Le,Be)=>{Le.clearRect(0,0,ce,ve);const at=ve*Ce.waveCenter,_=Ce.waveBandPx,R=Ce.segments,z=Ce.colors.filaments,F=Ie||ce,N=0;rt(Le,F,N),Le.strokeStyle=z,Le.lineCap="round",Le.lineJoin="round";for(let C=0;C<Be.length;C+=1){const A=Be[C],de=A.offset*_*(.85+Ye(A.seed)*.4),xe=1-Math.min(1,Math.abs(de)/_),ge=Math.exp(-Math.pow(de/Ce.crestThickness,2)),ae=A.layer===0?1.1:A.layer===1?.85:.6,P=.35+(1-A.depth)*.65,X=xe*P*ae*(.34+ge*.45);Le.globalAlpha=X,Le.lineWidth=A.width*(1+(1-A.depth)*.8);const se=[];for(let ee=0;ee<=R;ee+=1){const Re=ee/R*F+N,ue=(Oe(Re*.012,A.seed)-.5)*Ce.xJitter,fe=Re+ue,ze=(Oe(fe*A.freqA,A.seed)-.5)*Ce.jitterA,et=(Oe(fe*A.freqB,A.seed*1.7)-.5)*Ce.jitterB,Qe=at+Math.sin(fe*A.freqA+A.seed)*A.ampA+Math.sin(fe*A.freqB+A.seed*1.3)*A.ampB+de+ze+et;se.push({x:fe,y:Qe})}Le.beginPath(),Le.moveTo(se[0].x,se[0].y);for(let ee=1;ee<se.length-1;ee+=1){const Re=(se[ee].x+se[ee+1].x)/2,ue=(se[ee].y+se[ee+1].y)/2;Le.quadraticCurveTo(se[ee].x,se[ee].y,Re,ue)}const Y=se[se.length-1];Le.quadraticCurveTo(Y.x,Y.y,Y.x,Y.y),Le.stroke()}Le.save(),Le.globalCompositeOperation="lighter",Le.strokeStyle=Ce.colors.glow,Le.lineCap="round",Le.lineJoin="round";for(let C=0;C<Be.length;C+=1){const A=Be[C];if(Math.abs(A.offset)*_>Ce.crestThickness)continue;const de=Ce.glowAlpha*(.7+(1-A.depth)*.6);Le.globalAlpha=de,Le.lineWidth=1.6+(1-A.depth)*1.2;const xe=[];for(let ae=0;ae<=R;ae+=1){const P=ae/R*F+N,X=Math.sin(P*.02+A.seed)*3,se=at+Math.sin(P*A.freqA+A.seed)*A.ampA+Math.sin(P*A.freqB+A.seed*1.3)*A.ampB+A.offset*_*.35+X;xe.push({x:P,y:se})}Le.beginPath(),Le.moveTo(xe[0].x,xe[0].y);for(let ae=1;ae<xe.length-1;ae+=1){const P=(xe[ae].x+xe[ae+1].x)/2,X=(xe[ae].y+xe[ae+1].y)/2;Le.quadraticCurveTo(xe[ae].x,xe[ae].y,P,X)}const ge=xe[xe.length-1];Le.quadraticCurveTo(ge.x,ge.y,ge.x,ge.y),Le.stroke()}Le.restore()},tt=()=>{ce=Math.floor(M.clientWidth),ve=Math.floor(M.clientHeight),Ie=Math.floor(ce*1.8),He=ve,Me=ce<820?W:K,G.forEach(Le=>{const Be=Le.getContext("2d");if(!Be)return;Le.width=Math.floor(Ie*U*Me),Le.height=Math.floor(He*U*Me),Le.style.width=`${Ie}px`,Le.style.height=`${He}px`,Le.style.left=`${-(Ie-ce)/2}px`,Be.setTransform(U*Me,0,0,U*Me,0,0);const at=Number(Le.dataset.seed||1),_=De(at);gt(Be,_)})};return tt(),window.addEventListener("resize",tt,{passive:!0}),()=>window.removeEventListener("resize",tt)},[h]);const Je=k[Math.min(L,k.length-1)],pe=y?Je:k[k.length-1],E=(pe==null?void 0:pe.theme)??k[0].theme,D={"--cogita-bg0":E.bg0,"--cogita-bg1":E.bg1,"--cogita-bg2":E.bg2,"--cogita-bloom":E.bloom,"--cogita-sat":E.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:p,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Hs,{value:x,onChange:d}),e.jsx(Ws,{copy:t,label:s,isAuthenticated:r,secureMode:b,onLogin:a,onProfileNavigate:i,onToggleSecureMode:u,onLogout:l,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:o,className:"cogita-section cogita-home",style:D,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[h.map((M,G)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:M.style,"data-seed":M.seed,ref:O=>{c.current[G]=O}},M.id)),j.map(M=>e.jsx("div",{className:"cogita-home-wave",style:M.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},M.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(ni,{slides:k,activeIndex:L,introOpen:y,prefersReducedMotion:V,onNext:me,onPrev:Se,onSelect:oe,onExit:$,onOpen:T,onRegister:te})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const Do=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:ii},Symbol.toStringTag,{value:"Module"})),nr=n.createContext(!1);function $t({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,headerExtra:d,children:p}){if(n.useContext(nr))return e.jsx(e.Fragment,{children:p});const c=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}b("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:c,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Hs,{value:m,onChange:x}),e.jsxs("div",{className:"cogita-header-right",children:[d,e.jsx(Ws,{copy:t,label:a,isAuthenticated:s,secureMode:l,onLogin:()=>b("home"),onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:p}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function ua(t){const[a,s]=n.useState("Cogita library"),[r,i]=n.useState(null);return n.useEffect(()=>{let u=!1;return Qs().then(l=>{if(u)return;const b=l.find(m=>m.libraryId===t);b&&s(b.name)}).catch(()=>{u||s("Cogita library")}),()=>{u=!0}},[t]),n.useEffect(()=>{let u=!1;return br(t).then(l=>{u||i(l)}).catch(()=>{u||i(null)}),()=>{u=!0}},[t]),{libraryName:a,stats:r}}function ps({slices:t}){const a=t.reduce((r,i)=>r+Math.max(0,i.value),0),s=n.useMemo(()=>{if(a<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let r=0;return`conic-gradient(${t.map(u=>{const b=Math.max(0,u.value)/a*360,m=r,x=r+b;return r=x,`${u.color} ${m}deg ${x}deg`}).join(",")})`},[t,a]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:s}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(r=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:r.color}}),e.jsx("strong",{children:r.value}),e.jsx("small",{children:r.label})]},r.label))})]})}function oi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,libraryId:d}){const{libraryName:p,stats:o}=ua(d),[c,j]=n.useState("infos"),[h,k]=n.useState(0),[L,v]=n.useState(0),[y,Z]=n.useState(0),V=(o==null?void 0:o.totalInfos)??0,w=(o==null?void 0:o.totalCollections)??0,Q=0,S=0,te=0,T=Math.max(0,V-te-L),$=Math.max(0,V-L-y);n.useEffect(()=>{let me=!1;return(async()=>{try{const Je=await Ua({libraryId:d,limit:200}),pe=await Promise.all(Je.items.map(E=>Xn({libraryId:d,collectionId:E.collectionId}).catch(()=>[])));if(me)return;k(pe.reduce((E,D)=>E+D.length,0))}catch{me||k(0)}})(),()=>{me=!0}},[d]),n.useEffect(()=>{let me=!1;return(async()=>{try{const[Je,pe,E]=await Promise.all([ds({libraryId:d,type:"computed",limit:1}).catch(()=>({total:0})),ds({libraryId:d,type:"source",limit:1}).catch(()=>({total:0})),Zn({libraryId:d}).catch(()=>({items:[]}))]);if(me)return;v((Je.total??0)+(pe.total??0));const D=new Set(E.items.filter(M=>M.childItemType.toLowerCase()==="info").map(M=>M.childItemId).filter(Boolean));Z(D.size)}catch{me||(v(0),Z(0))}})(),()=>{me=!0}},[d]);const oe=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:V},{key:"collections",label:t.cogita.library.overview.stats.collections,value:w},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:h},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:Q},{key:"texts",label:t.cogita.library.overview.stats.texts,value:S}];return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:p})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:oe.map(me=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${c===me.key?"active":""}`,onClick:()=>j(me.key),children:[e.jsx("span",{children:me.label}),e.jsx("strong",{children:me.value})]},me.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),c==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(ps,{slices:[{label:t.cogita.library.overview.known,value:te,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:T,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:L,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(ps,{slices:[{label:t.cogita.library.overview.availableChecks,value:y,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:$,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const ot=(t,a)=>{const s=t.cogita.library.infoTypes,r=t.cogita.library.connectionTypes,i=t.cogita.library.groupTypes;return{any:s.any,vocab:s.vocab,book:i.book,citation:i.citation,language:s.language,word:s.word,sentence:s.sentence,topic:s.topic,collection:s.collection,person:s.person,institution:s.institution,collective:s.collective,orcid:s.orcid,address:s.address,email:s.email,phone:s.phone,media:s.media,work:s.work,geo:s.geo,music_piece:s.musicPiece,music_fragment:s.musicFragment,source:s.source,question:s.question,computed:s.computed,"word-language":r.wordLanguage,"citation-language":r.citationLanguage,"language-sentence":r.languageSentence,translation:r.translation,"word-topic":r.wordTopic,reference:r.reference,"source-resource":r.sourceResource,"work-contributor":r.workContributor,"work-medium":r.workMedium,"orcid-link":r.orcidLink}[a]??String(a)},li=t=>[{value:"any",label:ot(t,"any")},{value:"language",label:ot(t,"language")},{value:"word",label:ot(t,"word")},{value:"sentence",label:ot(t,"sentence")},{value:"topic",label:ot(t,"topic")},{value:"collection",label:ot(t,"collection")},{value:"person",label:ot(t,"person")},{value:"institution",label:ot(t,"institution")},{value:"collective",label:ot(t,"collective")},{value:"orcid",label:ot(t,"orcid")},{value:"address",label:ot(t,"address")},{value:"email",label:ot(t,"email")},{value:"phone",label:ot(t,"phone")},{value:"media",label:ot(t,"media")},{value:"work",label:ot(t,"work")},{value:"geo",label:ot(t,"geo")},{value:"music_piece",label:ot(t,"music_piece")},{value:"music_fragment",label:ot(t,"music_fragment")},{value:"source",label:ot(t,"source")},{value:"question",label:ot(t,"question")},{value:"citation",label:ot(t,"citation")},{value:"computed",label:ot(t,"computed")},{value:"vocab",label:ot(t,"vocab")},{value:"book",label:ot(t,"book")},{value:"word-language",label:ot(t,"word-language")},{value:"citation-language",label:ot(t,"citation-language")},{value:"language-sentence",label:ot(t,"language-sentence")},{value:"translation",label:ot(t,"translation")},{value:"word-topic",label:ot(t,"word-topic")},{value:"reference",label:ot(t,"reference")},{value:"source-resource",label:ot(t,"source-resource")},{value:"work-contributor",label:ot(t,"work-contributor")},{value:"work-medium",label:ot(t,"work-medium")},{value:"orcid-link",label:ot(t,"orcid-link")}],ci=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Ln={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},di={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Ln]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Ln]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId"]},filterFields:[Ln,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text"],connections:[{relationType:"citation-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"citationText",kind:"text",path:"text",matcher:"contains"}]},question:{infoType:"question",entityKind:"single",structure:{payloadFields:["definition"]},filterFields:[{key:"questionType",labelKey:"type",kind:"text",path:"definition.type",matcher:"contains"},{key:"questionText",labelKey:"text",kind:"text",path:"definition.question",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},fs={infoType:"default",entityKind:"single",structure:{payloadFields:["label"]},filterFields:[]};function ui(t){return t?di[t]??fs:fs}function hi(t,a){return t.optionsSource==="languages"?a.languages.map(s=>({value:s.infoId,label:s.label})):t.optionsSource==="sourceKinds"?ci:[]}const gi="cogita.revision.seed:";function sr(t){return`${gi}${t}`}function mi(t,a){if(typeof window>"u")return null;const s=Array.from(new Set(a.map(u=>u.trim()).filter(Boolean)));if(!s.length)return null;const r=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,i={kind:"info-selection",libraryId:t,infoIds:s,createdAt:new Date().toISOString()};return window.localStorage.setItem(sr(r),JSON.stringify(i)),r}function bs(t,a){if(typeof window>"u")return null;const s=window.localStorage.getItem(sr(a));if(!s)return null;try{const r=JSON.parse(s);if(r.kind!=="info-selection"||r.libraryId!==t||!Array.isArray(r.infoIds))return null;const i=r.infoIds.map(u=>String(u??"").trim()).filter(Boolean);return i.length?{infoIds:i}:null}catch{return null}}const pi="cogita.collection-draft:";function rr(t){return`${pi}${t}`}function fi(t,a){if(typeof window>"u")return null;const s=Array.from(new Set(a.map(u=>u.trim()).filter(Boolean)));if(!s.length)return null;const r=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,i={kind:"info-selection",libraryId:t,infoIds:s,createdAt:new Date().toISOString()};return window.localStorage.setItem(rr(r),JSON.stringify(i)),r}function bi(t,a){if(typeof window>"u")return null;const s=window.localStorage.getItem(rr(a));if(!s)return null;try{const r=JSON.parse(s);if(r.kind!=="info-selection"||r.libraryId!==t||!Array.isArray(r.infoIds))return null;const i=r.infoIds.map(u=>String(u??"").trim()).filter(Boolean);return i.length?{infoIds:i}:null}catch{return null}}const An=60,yi=500;function ir(t){return`cogita.info-selection:${t}`}function ys(t){if(typeof window>"u")return{};const a=window.localStorage.getItem(ir(t));if(!a)return{};try{const s=JSON.parse(a);return!s||typeof s!="object"?{}:s}catch{return{}}}function xi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,libraryId:d,mode:p}){var Ut;const o=Wa(),c=Pa(),j=t.cogita.library.list,[h,k]=n.useState("any"),[L,v]=n.useState(""),[y,Z]=n.useState("relevance"),[V,w]=n.useState("details"),[Q,S]=n.useState(!1),[te,T]=n.useState("idle"),[$,oe]=n.useState([]),[me,Se]=n.useState(An),[Je,pe]=n.useState(null),[E,D]=n.useState(()=>ys(d)),[M,G]=n.useState({}),[O,K]=n.useState([]),[W,U]=n.useState([]),[ce,ve]=n.useState(null),[Me,Ie]=n.useState(null),[He,it]=n.useState(null),[Ce,Ye]=n.useState("idle"),[kt,Oe]=n.useState([]),[De,rt]=n.useState(""),[gt,tt]=n.useState(null),[Le,Be]=n.useState("idle"),[at,_]=n.useState(null),[R,z]=n.useState(null),[F,N]=n.useState("idle"),[C,A]=n.useState([]),[de,xe]=n.useState("idle"),ge=n.useMemo(()=>li(t),[t]),ae=n.useMemo(()=>[{value:"relevance",label:j.sortRelevance},{value:"label_asc",label:j.sortLabelAsc},{value:"label_desc",label:j.sortLabelDesc},{value:"type_asc",label:j.sortTypeAsc},{value:"type_desc",label:j.sortTypeDesc}],[j.sortLabelAsc,j.sortLabelDesc,j.sortRelevance,j.sortTypeAsc,j.sortTypeDesc]);n.useEffect(()=>{D(ys(d)),G({}),S(!1)},[d]),n.useEffect(()=>{Zn({libraryId:d}).then(q=>it(q)).catch(()=>it({items:[]}))},[d]),n.useEffect(()=>{yr({libraryId:d}).then(q=>Oe(q)).catch(()=>Oe([]))},[d]),n.useEffect(()=>{Mn({libraryId:d,type:"language",filters:{sourceKind:"info"},limit:200}).then(q=>{const g=q.map(re=>({infoId:re.infoId??"",infoType:re.entityType,label:re.title})).filter(re=>re.infoId.length>0);K(g)}).catch(()=>K([]))},[d]),n.useEffect(()=>{Mn({libraryId:d,type:"source",filters:{sourceKind:"info"},limit:200}).then(q=>{const g=q.map(re=>({infoId:re.infoId??"",infoType:re.entityType,label:re.title})).filter(re=>re.infoId.length>0);U(g)}).catch(()=>U([]))},[d]),n.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(ir(d),JSON.stringify(E))},[d,E]);const P=n.useMemo(()=>ui(h==="any"?null:h),[h]),X=n.useMemo(()=>new URLSearchParams(c.search),[c.search]),se=n.useMemo(()=>c.pathname.split("/").filter(Boolean),[c.pathname]),Y=se.findIndex(q=>q==="infos"),ee=Y>=0&&(se[Y+1]??"").trim()||null,Re=Y>=0?(se[Y+2]??"").trim():"",ue=Y>=0?Re==="checkcards"?"cards":Re==="collections"?"collections":"overview":"",fe=ee??((X.get("infoId")??"").trim()||null),ze=ee?ue:(X.get("infoView")??"overview").trim(),et=ze==="overview"&&!!fe,Qe=ze==="collections"&&!!fe,Xe=n.useMemo(()=>({language:j.typeFilterLanguage,languageA:j.typeFilterLanguageA,languageB:j.typeFilterLanguageB,originalLanguage:j.typeFilterOriginalLanguage,doi:j.typeFilterDoi,sourceKind:j.typeFilterSourceKind,locator:j.typeFilterLocator,citationText:j.typeFilterCitationText}),[j.typeFilterDoi,j.typeFilterLanguage,j.typeFilterLanguageA,j.typeFilterLanguageB,j.typeFilterLocator,j.typeFilterOriginalLanguage,j.typeFilterCitationText,j.typeFilterSourceKind]),Ct=n.useMemo(()=>P.filterFields.map(q=>({...q,label:q.labelKey?Xe[q.labelKey]:q.label??q.key,options:hi(q,{languages:O})})),[Xe,O,P.filterFields]),St=n.useMemo(()=>Ct.some(q=>(M[q.key]??"").trim().length>0),[Ct,M]);n.useEffect(()=>{G({})},[h]),n.useEffect(()=>{const q={sourceKind:"info"};if(St)for(const H of Ct){const Ze=(M[H.key]??"").trim();Ze&&(q[H.path??H.key]=Ze)}const g=(M.__referenceId??"").trim();g&&(q["link.references"]=g),T("loading");const re=window.setTimeout(()=>{Mn({libraryId:d,type:h==="any"?void 0:h,query:L.trim()||void 0,filters:q,limit:yi}).then(H=>{const Ze=H.map(ut=>({infoId:ut.infoId??"",infoType:ut.entityType,label:ut.title})).filter(ut=>ut.infoId.length>0);oe(Ze),T("ready")}).catch(()=>{oe([]),T("ready")})},240);return()=>window.clearTimeout(re)},[St,d,L,h,Ct,M]),n.useEffect(()=>{if(!fe||ze!=="overview"&&ze!=="collections"){ve(null),Ie(null),Ye("idle");return}let q=!1;return Ye("loading"),Promise.all([aa({libraryId:d,infoId:fe}),xr({libraryId:d,itemType:"info",itemId:fe}).catch(()=>null)]).then(([g,re])=>{q||(ve(g),Ie(re),Ye("ready"))}).catch(()=>{q||(ve(null),Ie(null),Ye("error"))}),()=>{q=!0}},[d,fe,ze]),n.useEffect(()=>{if(!fe||ze!=="collections"){A([]),xe("idle");return}let q=!1;return xe("loading"),vr({libraryId:d,infoId:fe}).then(g=>{q||(A(g),xe("ready"))}).catch(()=>{q||(A([]),xe("error"))}),()=>{q=!0}},[d,fe,ze]),n.useEffect(()=>{if(!fe||ze!=="overview"){_(null),z(null),N("idle");return}let q=!1;return N("loading"),Promise.all([nn({libraryId:d,infoId:fe}),sn({libraryId:d,infoId:fe})]).then(([g,re])=>{q||(_(g),z(re),N("ready"))}).catch(()=>{q||(_(null),z(null),N("error"))}),()=>{q=!0}},[d,fe,ze]);const Mt=n.useMemo(()=>ce?kt.filter(q=>q.sourceInfoTypes.some(g=>g.toLowerCase()===ce.infoType.toLowerCase())):[],[kt,ce]);n.useEffect(()=>{if(!ce){rt("");return}rt(q=>{var g;return q&&Mt.some(re=>re.approachKey===q)?q:((g=Mt[0])==null?void 0:g.approachKey)??""})},[Mt,ce]),n.useEffect(()=>{if(!ce||!De){tt(null),Be("idle");return}let q=!1;return Be("loading"),Gs({libraryId:d,infoId:ce.infoId,approachKey:De}).then(g=>{q||(tt(g),Be("ready"))}).catch(()=>{q||(tt(null),Be("error"))}),()=>{q=!0}},[d,De,ce]);const Ve=n.useMemo(()=>{const q=$.slice(),g=re=>ot(t,re);return y==="relevance"?q:y==="label_asc"?q.sort((re,H)=>re.label.localeCompare(H.label)):y==="label_desc"?q.sort((re,H)=>H.label.localeCompare(re.label)):y==="type_asc"?q.sort((re,H)=>re.infoType===H.infoType?re.label.localeCompare(H.label):g(re.infoType).localeCompare(g(H.infoType))):q.sort((re,H)=>re.infoType===H.infoType?re.label.localeCompare(H.label):g(H.infoType).localeCompare(g(re.infoType)))},[t,$,y]),Ee=n.useMemo(()=>Ve.slice(0,me),[Ve,me]),ht=Ee.length<Ve.length,nt=n.useMemo(()=>new Set(Object.keys(E)),[E]),mt=n.useMemo(()=>Object.values(E),[E]),zt=n.useMemo(()=>{const q=new Map;for(const g of mt)q.set(g.infoType,(q.get(g.infoType)??0)+1);return Array.from(q.entries()).sort((g,re)=>re[1]-g[1]||g[0].localeCompare(re[0]))},[mt]),Tt=n.useMemo(()=>{if(!fe||!He)return 0;const q=new Set;for(const g of He.items)g.childItemType!=="info"||g.childItemId!==fe||q.add([g.parentItemType,g.parentItemId,g.parentCheckType??"",g.parentDirection??""].join("|"));return q.size},[He,fe]);n.useEffect(()=>{Se(An);const q=new Set($.map(g=>g.infoId));pe(g=>g&&q.has(g)?g:null)},[$]);const vt=q=>{D(g=>({...g,[q.infoId]:{infoId:q.infoId,infoType:q.infoType,label:q.label}}))},It=q=>{D(g=>{if(!g[q])return g;const re={...g};return delete re[q],re})},jt=(q,g)=>{if(g){vt(q);return}It(q.infoId)},dt=q=>{o(`/cogita/library/${d}/infos/${encodeURIComponent(q)}`,{replace:!0})},Kt=()=>{o(`/cogita/library/${d}/list`,{replace:!0})},lt=()=>{fe&&o(`/cogita/library/${d}/edit/${encodeURIComponent(fe)}`,{replace:!0})},We=()=>{const q=mi(d,mt.map(g=>g.infoId));q&&o(`/cogita/library/${d}/revision/run?libraryTarget=revisions&scope=info-selection&seed=${encodeURIComponent(q)}`)},wt=()=>{const q=fi(d,mt.map(g=>g.infoId));q&&o(`/cogita/library/${d}/collections/new?draft=${encodeURIComponent(q)}&draftType=info-selection`)},Gt=mt.length===1?((Ut=mt[0])==null?void 0:Ut.infoId)??null:null,qt=j.selectionCount.replace("{count}",String(mt.length)),Vt=p==="collection"?"grid":p==="detail"?"wide":V,be=ji(m),Et=Me?Math.max(0,Math.min(100,Math.round((Me.score??0)*100))):0,Zt=Me?wi(Me,be):be.noKnownnessData;return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":Vt,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[et?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:be.kicker}),e.jsx("h2",{className:"cogita-card-title",children:ce?xs(ce.payload,ce.infoType,ce.infoId):be.loading}),ce?e.jsxs("p",{className:"cogita-card-subtitle",children:[ot(t,ce.infoType)," · ",ce.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:Kt,children:be.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:lt,disabled:!fe||Ce!=="ready",children:j.editInfo})]})]}),Ce==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:be.loading})}):Ce==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:be.loadError})}):ce?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:be.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[Et,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${Et}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:Zt})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:be.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(Me==null?void 0:Me.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:be.correct.replace("{correct}",String((Me==null?void 0:Me.correctReviews)??0)).replace("{total}",String((Me==null?void 0:Me.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:Me!=null&&Me.lastReviewedUtc?`${be.lastReview}: ${vi(Me.lastReviewedUtc,m)}`:be.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:be.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:Tt}),e.jsx("p",{className:"cogita-library-hint",children:be.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:be.checkcards}),F==="loading"?e.jsx("p",{className:"cogita-library-hint",children:be.loadingCheckcards}):F==="error"?e.jsx("p",{className:"cogita-library-hint",children:be.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:be.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(at==null?void 0:at.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:be.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(R==null?void 0:R.items.length)??0})]})]})]}),Mt.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:be.approach}),e.jsx("select",{value:De,onChange:q=>rt(q.target.value),"aria-label":be.approach,children:Mt.map(q=>e.jsx("option",{value:q.approachKey,children:q.label},q.approachKey))})]}),Le==="loading"?e.jsx("p",{className:"cogita-library-hint",children:be.loadingApproach}):Le==="error"?e.jsx("p",{className:"cogita-library-hint",children:be.loadApproachError}):gt?e.jsx(rn,{value:gt.projection,emptyLabel:be.empty}):e.jsx("p",{className:"cogita-library-hint",children:be.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:be.payload}),e.jsx(rn,{value:ce.payload,emptyLabel:be.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:be.links}),e.jsx(ki,{links:ce.links,emptyLabel:be.noLinks})]})]})]}):null]})}):null,Qe?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Informacja"}),e.jsx("h2",{className:"cogita-card-title",children:ce?xs(ce.payload,ce.infoType,ce.infoId):fe??""}),e.jsx("p",{className:"cogita-card-subtitle",children:"Collections using this info"})]}),e.jsx("div",{className:"cogita-info-overview-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:Kt,children:"Back to search"})})]}),de==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading collections..."})}):null,de==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load collections."})}):null,de==="ready"&&C.length===0?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"This info is not used in any collection yet."})}):null,de==="ready"&&C.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:C.map(q=>e.jsx("article",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`/#/cogita/library/${d}/collections/${q.collectionId}?libraryTarget=collections`,children:[e.jsx("div",{className:"cogita-card-type",children:"Collection"}),e.jsx("h3",{className:"cogita-card-title",children:q.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[q.itemCount," items"]})]})},q.collectionId))}):null]})}):null,!et&&!Qe?e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":j.typeLabel,value:h,onChange:q=>k(q.target.value),children:ge.map(q=>e.jsx("option",{value:q.value,children:q.label},q.value))}),e.jsx("input",{type:"text",value:L,onChange:q=>v(q.target.value),placeholder:j.searchPlaceholder}),e.jsx("select",{"aria-label":j.sortLabel,value:y,onChange:q=>Z(q.target.value),children:ae.map(q=>e.jsx("option",{value:q.value,children:q.label},q.value))}),e.jsxs("select",{"aria-label":j.viewLabel,value:V,onChange:q=>w(q.target.value),children:[e.jsx("option",{value:"details",children:j.viewDetails}),e.jsx("option",{value:"wide",children:j.viewWide}),e.jsx("option",{value:"grid",children:j.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:j.cardCount.replace("{shown}",String(Ee.length)).replace("{total}",String(Ve.length))}),e.jsx("span",{children:te==="loading"?j.loading:j.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>S(q=>!q),children:Q?j.hideFilters:j.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:j.filtersOptionalHint})]}),Q?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsxs("div",{className:"cogita-filter-grid",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:j.typeLabel}),e.jsx("select",{value:h,onChange:q=>k(q.target.value),children:ge.map(q=>e.jsx("option",{value:q.value,children:q.label},`advanced-type:${q.value}`))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Reference"}),e.jsxs("select",{value:M.__referenceId??"",onChange:q=>G(g=>({...g,__referenceId:q.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),W.map(q=>e.jsx("option",{value:q.infoId,children:q.label},`reference:${q.infoId}`))]})]}),Ct.map(q=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:q.label}),q.kind==="select"?e.jsxs("select",{value:M[q.key]??"",onChange:g=>G(re=>({...re,[q.key]:g.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(q.options??[]).map(g=>e.jsx("option",{value:g.value,children:g.label},`${q.key}:${g.value}`))]}):e.jsx("input",{type:"text",value:M[q.key]??"",onChange:g=>G(re=>({...re,[q.key]:g.target.value}))})]},`type-filter:${q.key}`))]})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:qt}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{D(q=>{const g={...q};for(const re of Ee)g[re.infoId]={infoId:re.infoId,infoType:re.infoType,label:re.label};return g})},disabled:Ee.length===0,children:j.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>D({}),disabled:mt.length===0,children:j.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Gt&&dt(Gt),disabled:!Gt,title:Gt?void 0:j.openSelectedDisabled,children:j.openSelected})]})]}),Vt==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":j.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:j.detailColumnName}),e.jsx("span",{children:j.detailColumnType}),e.jsx("span",{children:j.detailColumnId}),e.jsx("span",{})]}),Ee.length?Ee.map(q=>{const g=ot(t,q.infoType),re=nt.has(q.infoId),H=Je===q.infoId;return e.jsxs("div",{className:`cogita-details-row ${H||re?"active":""}`,role:"row",onClick:()=>pe(q.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:re,onChange:Ze=>jt(q,Ze.target.checked),onClick:Ze=>Ze.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:q.label,children:q.label}),e.jsx("span",{title:g,children:g}),e.jsx("span",{title:q.infoId,children:q.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:Ze=>{Ze.stopPropagation(),dt(q.infoId)},"aria-label":j.editInfo,children:">"})]},q.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:j.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${Vt}`,"data-view":Vt,children:Ee.length?Ee.map(q=>{const g=ot(t,q.infoType),re=nt.has(q.infoId),H=Je===q.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":H||re,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:re,onChange:Ze=>jt(q,Ze.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>pe(q.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:g}),e.jsx("h3",{className:"cogita-card-title",children:q.label}),e.jsx("p",{className:"cogita-card-subtitle",children:q.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>dt(q.infoId),children:j.editInfo})]})},q.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:j.noMatch})})}),ht?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>Se(q=>q+An),children:j.loadMore})}):null,mt.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:j.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:j.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:zt.map(([q,g])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:ot(t,q)}),e.jsx("span",{className:"cogita-tag-count",children:g})]},`stack:type:${q}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:We,disabled:mt.length===0,children:"Start revision"}),e.jsx("button",{type:"button",className:"ghost",onClick:wt,disabled:mt.length===0,children:"Create collection from selection"})]})]}):null]}):null]})})})})}function xs(t,a,s){if(t&&typeof t=="object"&&!Array.isArray(t)){const r=t,i=["title","name","label","value","text","quote","term"];for(const u of i){const l=r[u];if(typeof l=="string"&&l.trim())return l.trim()}}return`${a} · ${s}`}function vi(t,a){try{const s=a==="pl"?"pl-PL":a==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(s,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function ji(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function wi(t,a){return t.totalReviews<=0?a.noKnownnessData:t.totalReviews<3||t.score<.35?a.developmentStart:t.totalReviews<8||t.score<.65?a.developmentGrowing:t.score<.85?a.developmentStable:a.developmentStrong}function ki({links:t,emptyLabel:a}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:a}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([s,r])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(r)?r.length?e.jsx("div",{className:"cogita-selection-overview",children:r.map(i=>e.jsx("span",{className:"cogita-tag-chip",children:i},`${s}:${i}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):r?e.jsx("span",{className:"cogita-tag-chip",children:r}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},s))})}function rn({value:t,emptyLabel:a}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:a});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((s,r)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(rn,{value:s,emptyLabel:a})})]},r))});if(typeof t=="object"){const s=Object.entries(t);return s.length===0?e.jsx("p",{className:"cogita-library-hint",children:a}):e.jsx("div",{className:"cogita-info-tree",children:s.map(([r,i])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(rn,{value:i,emptyLabel:a})})]},r))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const Na=5,vs=50,js=2,ws=[];function Xt({libraryId:t,infoType:a,label:s,placeholder:r,value:i,onChange:u,values:l,onChangeMultiple:b,helperText:m,searchFailedText:x,createFailedText:d,createLabel:p,savingLabel:o,loadMoreLabel:c,allowCreate:j=!0,inputRef:h,autoAdvance:k,onCommit:L,multiple:v}){const y=v?l??ws:ws,[Z,V]=n.useState(v?"":(i==null?void 0:i.label)??""),[w,Q]=n.useState([]),[S,te]=n.useState(Na),[T,$]=n.useState(-1),[oe,me]=n.useState(!1),[Se,Je]=n.useState(!1),[pe,E]=n.useState(null),D=n.useRef(0),M=n.useRef(new Map),G=n.useMemo(()=>j?v?Z.trim().length>0:Z.trim().length>0&&!i:!1,[j,Z,i,v]);n.useEffect(()=>{v||V((i==null?void 0:i.label)??"")},[i,v]),n.useEffect(()=>{const W=Z.trim();if(!W||W.length<js){Q([]),me(!1),te(Na),$(-1),Je(!1),E(null);return}const U=W.toLowerCase(),ce=`${t}:${a}:${U}`,ve=M.current.get(ce);if(ve){if(v&&y.length>0){const Ie=new Set(y.map(He=>He.id));Q(ve.filter(He=>!Ie.has(He.id)))}else Q(ve);te(Na),$(-1),me(ve.length>0),Je(!1),E(null);return}const Me=window.setTimeout(async()=>{const Ie=Date.now();D.current=Ie,Je(!0),E(null);try{const He=await es({libraryId:t,type:a,query:W,limit:vs});if(D.current!==Ie)return;const it=He.slice(0,vs).map(Ce=>({id:Ce.infoId,label:Ce.label,infoType:Ce.infoType}));if(M.current.set(ce,it),v&&y.length>0){const Ce=new Set(y.map(Ye=>Ye.id));Q(it.filter(Ye=>!Ce.has(Ye.id)))}else Q(it);te(Na),$(-1),me(!0)}catch{if(D.current!==Ie)return;E(x??"Search failed.")}finally{D.current===Ie&&Je(!1)}},250);return()=>window.clearTimeout(Me)},[t,a,Z,y]);const O=W=>{if(v){const U=y.some(ce=>ce.id===W.id)?y:[...y,W];b==null||b(U),V(""),me(!1),$(-1);return}u==null||u(W),V(W.label),me(!1),$(-1),k&&(L==null||L())},K=async()=>{const W=Z.trim();if(W){Je(!0),E(null);try{const U=await Un({libraryId:t,infoType:a,payload:{label:W}}),ce={id:U.infoId,label:W,infoType:U.infoType};if(W.length>=js){const ve=`${t}:${a}:${W.toLowerCase()}`,Me=M.current.get(ve)??[];M.current.set(ve,[ce,...Me])}if(v){b==null||b([...y,ce]),V(""),me(!1),$(-1);return}u==null||u(ce),me(!1),$(-1),k&&(L==null||L())}catch{E(d??"Create failed.")}finally{Je(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:s}),e.jsx("input",{value:Z,placeholder:r,onChange:W=>{V(W.target.value),!v&&i&&(u==null||u(null))},onKeyDown:W=>{if(W.key==="ArrowDown"){if(W.preventDefault(),!w.length)return;me(!0),$(U=>{const ce=Math.min(w.length,S)-1,ve=U<0?0:Math.min(U+1,ce);return ve===ce&&w.length>S?(te(Me=>Math.min(Me+Na,w.length)),Math.min(U+1,Math.min(w.length,S+Na)-1)):ve});return}if(W.key==="ArrowUp"){if(W.preventDefault(),!w.length)return;me(!0),$(U=>U<=0?0:U-1);return}if(W.key==="Enter"){if(W.preventDefault(),T>=0&&w[T]){O(w[T]);return}if(G){K();return}}},onFocus:()=>{w.length>0&&me(!0)},autoComplete:"off",ref:h})]}),v&&y.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:y.map(W=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>b==null?void 0:b(y.filter(U=>U.id!==W.id)),children:[W.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},W.id))}),m&&e.jsx("p",{className:"cogita-help",children:m}),pe&&e.jsx("p",{className:"cogita-error",children:pe}),oe&&w.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[w.slice(0,S).map((W,U)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":U===T,onClick:()=>O(W),children:[e.jsx("strong",{children:W.label}),e.jsx("span",{children:W.infoType})]},W.id)),S<w.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>te(W=>Math.min(W+Na,w.length)),children:c??"Load more"})]}),G&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:K,disabled:Se,children:Se?o??"Saving...":p??`Create new ${a}`})]})}const ks=[{id:"gen",la:{abbr:"Gen",name:"Genesis"},en:{abbr:"Gen",name:"Genesis"},de:{abbr:"Gen",name:"Genesis"},pl:{abbr:"Rdz",name:"Księga Rodzaju"}},{id:"ex",la:{abbr:"Ex",name:"Exodus"},en:{abbr:"Ex",name:"Exodus"},de:{abbr:"Ex",name:"Exodus"},pl:{abbr:"Wj",name:"Księga Wyjścia"}},{id:"lev",la:{abbr:"Lev",name:"Leviticus"},en:{abbr:"Lev",name:"Leviticus"},de:{abbr:"Lev",name:"Levitikus"},pl:{abbr:"Kpł",name:"Księga Kapłańska"}},{id:"num",la:{abbr:"Num",name:"Numeri"},en:{abbr:"Num",name:"Numbers"},de:{abbr:"Num",name:"Numeri"},pl:{abbr:"Lb",name:"Księga Liczb"}},{id:"deut",la:{abbr:"Deut",name:"Deuteronomium"},en:{abbr:"Deut",name:"Deuteronomy"},de:{abbr:"Dtn",name:"Deuteronomium"},pl:{abbr:"Pwt",name:"Księga Powtórzonego Prawa"}},{id:"ios",la:{abbr:"Ios",name:"Iosue"},en:{abbr:"Josh",name:"Joshua"},de:{abbr:"Jos",name:"Josua"},pl:{abbr:"Joz",name:"Księga Jozuego"}},{id:"iudg",la:{abbr:"Iudg",name:"Iudicum"},en:{abbr:"Judg",name:"Judges"},de:{abbr:"Ri",name:"Richter"},pl:{abbr:"Sdz",name:"Księga Sędziów"}},{id:"ruth",la:{abbr:"Ruth",name:"Ruth"},en:{abbr:"Ruth",name:"Ruth"},de:{abbr:"Rut",name:"Rut"},pl:{abbr:"Rt",name:"Księga Rut"}},{id:"1sam",la:{abbr:"1 Sam",name:"I Samuelis"},en:{abbr:"1 Sam",name:"1 Samuel"},de:{abbr:"1 Sam",name:"1 Samuel"},pl:{abbr:"1 Sm",name:"1 Księga Samuela"}},{id:"2sam",la:{abbr:"2 Sam",name:"II Samuelis"},en:{abbr:"2 Sam",name:"2 Samuel"},de:{abbr:"2 Sam",name:"2 Samuel"},pl:{abbr:"2 Sm",name:"2 Księga Samuela"}},{id:"1reg",la:{abbr:"1 Reg",name:"I Regum"},en:{abbr:"1 Kgs",name:"1 Kings"},de:{abbr:"1 Kön",name:"1 Könige"},pl:{abbr:"1 Krl",name:"1 Księga Królewska"}},{id:"2reg",la:{abbr:"2 Reg",name:"II Regum"},en:{abbr:"2 Kgs",name:"2 Kings"},de:{abbr:"2 Kön",name:"2 Könige"},pl:{abbr:"2 Krl",name:"2 Księga Królewska"}},{id:"1par",la:{abbr:"1 Par",name:"I Paralipomenon"},en:{abbr:"1 Chr",name:"1 Chronicles"},de:{abbr:"1 Chr",name:"1 Chronik"},pl:{abbr:"1 Krn",name:"1 Księga Kronik"}},{id:"2par",la:{abbr:"2 Par",name:"II Paralipomenon"},en:{abbr:"2 Chr",name:"2 Chronicles"},de:{abbr:"2 Chr",name:"2 Chronik"},pl:{abbr:"2 Krn",name:"2 Księga Kronik"}},{id:"esd",la:{abbr:"Esd",name:"Esdrae"},en:{abbr:"Ezra",name:"Ezra"},de:{abbr:"Esra",name:"Esra"},pl:{abbr:"Ezd",name:"Księga Ezdrasza"}},{id:"neh",la:{abbr:"Neh",name:"Nehemiae"},en:{abbr:"Neh",name:"Nehemiah"},de:{abbr:"Neh",name:"Nehemia"},pl:{abbr:"Ne",name:"Księga Nehemiasza"}},{id:"tob",la:{abbr:"Tob",name:"Tobiae"},en:{abbr:"Tob",name:"Tobit"},de:{abbr:"Tob",name:"Tobit"},pl:{abbr:"Tb",name:"Księga Tobiasza"}},{id:"iudt",la:{abbr:"Iudt",name:"Iudith"},en:{abbr:"Jdt",name:"Judith"},de:{abbr:"Jdt",name:"Judit"},pl:{abbr:"Jdt",name:"Księga Judyty"}},{id:"est",la:{abbr:"Est",name:"Esther"},en:{abbr:"Est",name:"Esther"},de:{abbr:"Est",name:"Ester"},pl:{abbr:"Est",name:"Księga Estery"}},{id:"1macc",la:{abbr:"1 Macc",name:"I Maccabaeorum"},en:{abbr:"1 Mc",name:"1 Maccabees"},de:{abbr:"1 Makk",name:"1 Makkabäer"},pl:{abbr:"1 Mch",name:"1 Księga Machabejska"}},{id:"2macc",la:{abbr:"2 Macc",name:"II Maccabaeorum"},en:{abbr:"2 Mc",name:"2 Maccabees"},de:{abbr:"2 Makk",name:"2 Makkabäer"},pl:{abbr:"2 Mch",name:"2 Księga Machabejska"}},{id:"iob",la:{abbr:"Iob",name:"Iob"},en:{abbr:"Job",name:"Job"},de:{abbr:"Ijob",name:"Ijob"},pl:{abbr:"Hi",name:"Księga Hioba"}},{id:"ps",la:{abbr:"Ps",name:"Psalmi"},en:{abbr:"Ps",name:"Psalms"},de:{abbr:"Ps",name:"Psalmen"},pl:{abbr:"Ps",name:"Księga Psalmów"}},{id:"prov",la:{abbr:"Prov",name:"Proverbia"},en:{abbr:"Prov",name:"Proverbs"},de:{abbr:"Spr",name:"Sprichwörter"},pl:{abbr:"Prz",name:"Księga Przysłów"}},{id:"ecc",la:{abbr:"Ecc",name:"Ecclesiastes"},en:{abbr:"Eccl",name:"Ecclesiastes"},de:{abbr:"Koh",name:"Kohelet"},pl:{abbr:"Koh",name:"Księga Koheleta"}},{id:"cant",la:{abbr:"Cant",name:"Canticum Canticorum"},en:{abbr:"Song",name:"Song of Songs"},de:{abbr:"Hld",name:"Hoheslied"},pl:{abbr:"Pnp",name:"Pieśń nad Pieśniami"}},{id:"sap",la:{abbr:"Sap",name:"Sapientia"},en:{abbr:"Wis",name:"Wisdom"},de:{abbr:"Weish",name:"Weisheit"},pl:{abbr:"Mdr",name:"Księga Mądrości"}},{id:"sir",la:{abbr:"Sir",name:"Ecclesiasticus (Sirach)"},en:{abbr:"Sir",name:"Sirach"},de:{abbr:"Sir",name:"Jesus Sirach"},pl:{abbr:"Syr",name:"Mądrość Syracha"}},{id:"isa",la:{abbr:"Isa",name:"Isaias"},en:{abbr:"Isa",name:"Isaiah"},de:{abbr:"Jes",name:"Jesaja"},pl:{abbr:"Iz",name:"Księga Izajasza"}},{id:"ier",la:{abbr:"Ier",name:"Ieremias"},en:{abbr:"Jer",name:"Jeremiah"},de:{abbr:"Jer",name:"Jeremia"},pl:{abbr:"Jr",name:"Księga Jeremiasza"}},{id:"lam",la:{abbr:"Lam",name:"Lamentationes"},en:{abbr:"Lam",name:"Lamentations"},de:{abbr:"Klgl",name:"Klagelieder"},pl:{abbr:"Lm",name:"Lamentacje"}},{id:"bar",la:{abbr:"Bar",name:"Baruch"},en:{abbr:"Bar",name:"Baruch"},de:{abbr:"Bar",name:"Baruch"},pl:{abbr:"Ba",name:"Księga Barucha"}},{id:"ez",la:{abbr:"Ez",name:"Ezechiel"},en:{abbr:"Ezek",name:"Ezekiel"},de:{abbr:"Ez",name:"Ezechiel"},pl:{abbr:"Ez",name:"Księga Ezechiela"}},{id:"dan",la:{abbr:"Dan",name:"Daniel"},en:{abbr:"Dan",name:"Daniel"},de:{abbr:"Dan",name:"Daniel"},pl:{abbr:"Dn",name:"Księga Daniela"}},{id:"hos",la:{abbr:"Hos",name:"Osee"},en:{abbr:"Hos",name:"Hosea"},de:{abbr:"Hos",name:"Hosea"},pl:{abbr:"Oz",name:"Księga Ozeasza"}},{id:"ioel",la:{abbr:"Ioel",name:"Ioel"},en:{abbr:"Joel",name:"Joel"},de:{abbr:"Joel",name:"Joel"},pl:{abbr:"Jl",name:"Księga Joela"}},{id:"amos",la:{abbr:"Amos",name:"Amos"},en:{abbr:"Am",name:"Amos"},de:{abbr:"Am",name:"Amos"},pl:{abbr:"Am",name:"Księga Amosa"}},{id:"abd",la:{abbr:"Abd",name:"Abdias"},en:{abbr:"Obad",name:"Obadiah"},de:{abbr:"Obd",name:"Obadja"},pl:{abbr:"Abd",name:"Księga Abdiasza"}},{id:"ion",la:{abbr:"Ion",name:"Ionas"},en:{abbr:"Jon",name:"Jonah"},de:{abbr:"Jona",name:"Jona"},pl:{abbr:"Jon",name:"Księga Jonasza"}},{id:"mich",la:{abbr:"Mich",name:"Michaeas"},en:{abbr:"Mic",name:"Micah"},de:{abbr:"Mi",name:"Micha"},pl:{abbr:"Mi",name:"Księga Micheasza"}},{id:"nah",la:{abbr:"Nah",name:"Nahum"},en:{abbr:"Nah",name:"Nahum"},de:{abbr:"Nah",name:"Nahum"},pl:{abbr:"Na",name:"Księga Nahuma"}},{id:"hab",la:{abbr:"Hab",name:"Habacuc"},en:{abbr:"Hab",name:"Habakkuk"},de:{abbr:"Hab",name:"Habakuk"},pl:{abbr:"Ha",name:"Księga Habakuka"}},{id:"soph",la:{abbr:"Soph",name:"Sophonias"},en:{abbr:"Zeph",name:"Zephaniah"},de:{abbr:"Zef",name:"Zefanja"},pl:{abbr:"So",name:"Księga Sofoniasza"}},{id:"agg",la:{abbr:"Agg",name:"Aggaeus"},en:{abbr:"Hag",name:"Haggai"},de:{abbr:"Hag",name:"Haggai"},pl:{abbr:"Ag",name:"Księga Aggeusza"}},{id:"zach",la:{abbr:"Zach",name:"Zacharias"},en:{abbr:"Zech",name:"Zechariah"},de:{abbr:"Sach",name:"Sacharja"},pl:{abbr:"Za",name:"Księga Zachariasza"}},{id:"mal",la:{abbr:"Mal",name:"Malachias"},en:{abbr:"Mal",name:"Malachi"},de:{abbr:"Mal",name:"Maleachi"},pl:{abbr:"Ml",name:"Księga Malachiasza"}},{id:"mt",la:{abbr:"Mt",name:"Matthaeus"},en:{abbr:"Matt",name:"Matthew"},de:{abbr:"Mt",name:"Matthäus"},pl:{abbr:"Mt",name:"Ewangelia wg św. Mateusza"}},{id:"mc",la:{abbr:"Mc",name:"Marcus"},en:{abbr:"Mark",name:"Mark"},de:{abbr:"Mk",name:"Markus"},pl:{abbr:"Mk",name:"Ewangelia wg św. Marka"}},{id:"lc",la:{abbr:"Lc",name:"Lucas"},en:{abbr:"Luke",name:"Luke"},de:{abbr:"Lk",name:"Lukas"},pl:{abbr:"Łk",name:"Ewangelia wg św. Łukasza"}},{id:"io",la:{abbr:"Io",name:"Ioannes"},en:{abbr:"John",name:"John"},de:{abbr:"Joh",name:"Johannes"},pl:{abbr:"J",name:"Ewangelia wg św. Jana"}},{id:"act",la:{abbr:"Act",name:"Actus Apostolorum"},en:{abbr:"Acts",name:"Acts"},de:{abbr:"Apg",name:"Apostelgeschichte"},pl:{abbr:"Dz",name:"Dzieje Apostolskie"}},{id:"rom",la:{abbr:"Rom",name:"ad Romanos"},en:{abbr:"Rom",name:"Romans"},de:{abbr:"Röm",name:"Römer"},pl:{abbr:"Rz",name:"List do Rzymian"}},{id:"1cor",la:{abbr:"1 Cor",name:"I ad Corinthios"},en:{abbr:"1 Cor",name:"1 Corinthians"},de:{abbr:"1 Kor",name:"1 Korinther"},pl:{abbr:"1 Kor",name:"1 List do Koryntian"}},{id:"2cor",la:{abbr:"2 Cor",name:"II ad Corinthios"},en:{abbr:"2 Cor",name:"2 Corinthians"},de:{abbr:"2 Kor",name:"2 Korinther"},pl:{abbr:"2 Kor",name:"2 List do Koryntian"}},{id:"gal",la:{abbr:"Gal",name:"ad Galatas"},en:{abbr:"Gal",name:"Galatians"},de:{abbr:"Gal",name:"Galater"},pl:{abbr:"Ga",name:"List do Galatów"}},{id:"eph",la:{abbr:"Eph",name:"ad Ephesios"},en:{abbr:"Eph",name:"Ephesians"},de:{abbr:"Eph",name:"Epheser"},pl:{abbr:"Ef",name:"List do Efezjan"}},{id:"phil",la:{abbr:"Phil",name:"ad Philippenses"},en:{abbr:"Phil",name:"Philippians"},de:{abbr:"Phil",name:"Philipper"},pl:{abbr:"Flp",name:"List do Filipian"}},{id:"col",la:{abbr:"Col",name:"ad Colossenses"},en:{abbr:"Col",name:"Colossians"},de:{abbr:"Kol",name:"Kolosser"},pl:{abbr:"Kol",name:"List do Kolosan"}},{id:"1thess",la:{abbr:"1 Thess",name:"I ad Thessalonicenses"},en:{abbr:"1 Thess",name:"1 Thessalonians"},de:{abbr:"1 Thess",name:"1 Thessalonicher"},pl:{abbr:"1 Tes",name:"1 List do Tesaloniczan"}},{id:"2thess",la:{abbr:"2 Thess",name:"II ad Thessalonicenses"},en:{abbr:"2 Thess",name:"2 Thessalonians"},de:{abbr:"2 Thess",name:"2 Thessalonicher"},pl:{abbr:"2 Tes",name:"2 List do Tesaloniczan"}},{id:"1tim",la:{abbr:"1 Tim",name:"I ad Timotheum"},en:{abbr:"1 Tim",name:"1 Timothy"},de:{abbr:"1 Tim",name:"1 Timotheus"},pl:{abbr:"1 Tm",name:"1 List do Tymoteusza"}},{id:"2tim",la:{abbr:"2 Tim",name:"II ad Timotheum"},en:{abbr:"2 Tim",name:"2 Timothy"},de:{abbr:"2 Tim",name:"2 Timotheus"},pl:{abbr:"2 Tm",name:"2 List do Tymoteusza"}},{id:"tit",la:{abbr:"Tit",name:"ad Titum"},en:{abbr:"Titus",name:"Titus"},de:{abbr:"Tit",name:"Titus"},pl:{abbr:"Tt",name:"List do Tytusa"}},{id:"phlm",la:{abbr:"Phlm",name:"ad Philemonem"},en:{abbr:"Phlm",name:"Philemon"},de:{abbr:"Phlm",name:"Philemon"},pl:{abbr:"Flm",name:"List do Filemona"}},{id:"heb",la:{abbr:"Heb",name:"ad Hebraeos"},en:{abbr:"Heb",name:"Hebrews"},de:{abbr:"Hebr",name:"Hebräer"},pl:{abbr:"Hbr",name:"List do Hebrajczyków"}},{id:"iac",la:{abbr:"Iac",name:"Iacobi"},en:{abbr:"Jas",name:"James"},de:{abbr:"Jak",name:"Jakobus"},pl:{abbr:"Jk",name:"List św. Jakuba"}},{id:"1pet",la:{abbr:"1 Pet",name:"I Petri"},en:{abbr:"1 Pet",name:"1 Peter"},de:{abbr:"1 Petr",name:"1 Petrus"},pl:{abbr:"1 P",name:"1 List św. Piotra"}},{id:"2pet",la:{abbr:"2 Pet",name:"II Petri"},en:{abbr:"2 Pet",name:"2 Peter"},de:{abbr:"2 Petr",name:"2 Petrus"},pl:{abbr:"2 P",name:"2 List św. Piotra"}},{id:"1io",la:{abbr:"1 Io",name:"I Ioannis"},en:{abbr:"1 John",name:"1 John"},de:{abbr:"1 Joh",name:"1 Johannes"},pl:{abbr:"1 J",name:"1 List św. Jana"}},{id:"2io",la:{abbr:"2 Io",name:"II Ioannis"},en:{abbr:"2 John",name:"2 John"},de:{abbr:"2 Joh",name:"2 Johannes"},pl:{abbr:"2 J",name:"2 List św. Jana"}},{id:"3io",la:{abbr:"3 Io",name:"III Ioannis"},en:{abbr:"3 John",name:"3 John"},de:{abbr:"3 Joh",name:"3 Johannes"},pl:{abbr:"3 J",name:"3 List św. Jana"}},{id:"iud",la:{abbr:"Iud",name:"Iudae"},en:{abbr:"Jude",name:"Jude"},de:{abbr:"Jud",name:"Judas"},pl:{abbr:"Jud",name:"List św. Judy"}},{id:"apoc",la:{abbr:"Apoc",name:"Apocalypsis Ioannis"},en:{abbr:"Rev",name:"Revelation"},de:{abbr:"Offb",name:"Offenbarung"},pl:{abbr:"Ap",name:"Apokalipsa św. Jana"}}],Ns=8;function Ss({libraryId:t,copy:a,language:s,sourceKindOptions:r,value:i,onChange:u,labels:l}){const[b,m]=n.useState(!1),[x,d]=n.useState(-1),p=n.useMemo(()=>{const h=s;return ks.map(k=>{var y;const L=(k==null?void 0:k[h])??(k==null?void 0:k.en)??(k==null?void 0:k.la);return{label:`${L.abbr} — ${L.name}`,latin:((y=k==null?void 0:k.la)==null?void 0:y.abbr)??L.abbr}})},[s]),o=(h,k=!1)=>{const L=h.trim().toLowerCase();return L?p.filter(v=>v.label.toLowerCase().includes(L)).slice(0,Ns):k?p.slice(0,Ns):[]},c=(h,k)=>{const L=h.trim().toLowerCase();if(!L)return null;const v=ks;for(const y of v){const Z=y==null?void 0:y.la,V=(y==null?void 0:y[k])??(y==null?void 0:y.en)??Z,w=(V==null?void 0:V.abbr)??"",Q=(V==null?void 0:V.name)??"";if(w.toLowerCase()===L||Q.toLowerCase()===L||`${w} — ${Q}`.toLowerCase()===L)return{book:y,entry:V,la:Z}}return null};n.useEffect(()=>{if(i.sourceKind==="bible"&&i.locatorValue&&!b){const h=c(i.locatorValue,s);if(h){const k=`${h.entry.abbr} — ${h.entry.name}`;k!==i.bibleBookDisplay&&u({...i,bibleBookDisplay:k})}}},[s,i,b,u]);const j=h=>u({...i,...h});return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:l.sourceKindLabel}),e.jsx("select",{value:i.sourceKind,onChange:h=>j({sourceKind:h.target.value,churchDocument:null,bookMedia:null,work:null,locatorValue:"",locatorAux:"",bibleBookDisplay:""}),children:r.map(h=>e.jsx("option",{value:h.value,children:h.label},h.value))})]}),i.sourceKind==="bible"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-lookup full",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:l.bibleBookLabel}),e.jsx("input",{type:"text",value:i.bibleBookDisplay,onChange:h=>{const k=h.target.value;j({bibleBookDisplay:k,locatorValue:""}),m(!0),d(-1)},onKeyDown:h=>{var L;const k=o(i.bibleBookDisplay);if(k.length){if(h.key==="ArrowDown")h.preventDefault(),d(v=>Math.min(v+1,k.length-1));else if(h.key==="ArrowUp")h.preventDefault(),d(v=>Math.max(v-1,0));else if((h.key==="Enter"||h.key==="Tab")&&x>=0&&k[x]){const v=k[x],y=c(v.label,s);if(!y)return;j({bibleBookDisplay:v.label,locatorValue:((L=y.la)==null?void 0:L.abbr)??i.locatorValue}),m(!1)}}},onFocus:()=>m(!0),onBlur:()=>window.setTimeout(()=>m(!1),100),placeholder:l.bibleBookPlaceholder})]}),b&&o(i.bibleBookDisplay,!0).length>0&&e.jsx("div",{className:"cogita-lookup-results",children:o(i.bibleBookDisplay,!0).map((h,k)=>e.jsx("button",{type:"button",className:"cogita-lookup-option","data-active":k===x,tabIndex:-1,onMouseDown:()=>{var v;const L=c(h.label,s);L&&j({bibleBookDisplay:h.label,locatorValue:((v=L.la)==null?void 0:v.abbr)??i.locatorValue})},children:e.jsx("strong",{children:h.label})},h.latin))})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:l.bibleRestLabel}),e.jsx("input",{type:"text",value:i.locatorAux,onChange:h=>j({locatorAux:h.target.value}),placeholder:l.bibleRestPlaceholder})]})]}),i.sourceKind==="website"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:a.cogita.library.add.info.sourceUrlLabel}),e.jsx("input",{type:"text",value:i.sourceUrl,onChange:h=>j({sourceUrl:h.target.value}),placeholder:a.cogita.library.add.info.sourceUrlPlaceholder})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:a.cogita.library.add.info.sourceAccessedDateLabel}),e.jsx("input",{type:"text",value:i.sourceAccessedDate,onChange:h=>j({sourceAccessedDate:h.target.value}),placeholder:a.cogita.library.add.info.sourceAccessedDatePlaceholder})]})]}),i.sourceKind==="number_document"&&e.jsxs(e.Fragment,{children:[e.jsx(Xt,{libraryId:t,infoType:"work",label:l.churchDocumentLabel,placeholder:l.churchDocumentPlaceholder,value:i.churchDocument,onChange:h=>j({churchDocument:h}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.work),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:l.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:h=>j({locatorValue:h.target.value}),placeholder:l.locatorPlaceholder})]})]}),i.sourceKind==="work"&&e.jsx(Xt,{libraryId:t,infoType:"work",label:l.workLabel,placeholder:l.workPlaceholder,value:i.work,onChange:h=>j({work:h}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.work),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),i.sourceKind==="book"&&e.jsxs(e.Fragment,{children:[e.jsx(Xt,{libraryId:t,infoType:"media",label:l.bookLabel,placeholder:l.bookPlaceholder,value:i.bookMedia,onChange:h=>j({bookMedia:h}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.media),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:l.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:h=>j({locatorValue:h.target.value}),placeholder:l.locatorPlaceholder})]})]}),i.sourceKind!=="website"&&i.sourceKind!=="bible"&&i.sourceKind!=="book"&&i.sourceKind!=="number_document"&&e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:l.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:h=>j({locatorValue:h.target.value}),placeholder:l.locatorPlaceholder})]})]})}const Ba=JSON.stringify({type:"selection",title:"Question title",question:"Question text",options:["Option A","Option B","Option C"],answer:[0]},null,2);function Za(t="selection"){return t==="matching"?{type:t,title:"",question:"",columns:[[""],[""]],answer:{paths:[]},matchingPaths:[["",""]]}:t==="ordering"?{type:t,title:"",question:"",options:[""]}:t==="truefalse"?{type:t,title:"",question:"",answer:!0}:t==="text"||t==="date"?{type:t,title:"",question:"",answer:""}:t==="number"?{type:t,title:"",question:"",answer:""}:{type:t,title:"",question:"",options:[""],answer:[]}}function Ni(t){return["selection","truefalse","text","number","date","matching","ordering"].includes(t)}function za(t){if(!t||typeof t!="object")return null;const a=t,s=typeof a.type=="string"?a.type:typeof a.kind=="string"?a.kind:"selection",r=s==="multi_select"||s==="single_select"?"selection":s==="boolean"?"truefalse":s==="order"?"ordering":s,i=Ni(r)?r:"selection",u=typeof a.title=="string"?a.title:"",l=typeof a.question=="string"?a.question:"";if(i==="matching"){let x=[];Array.isArray(a.columns)?x=a.columns.map(h=>Array.isArray(h)?h.map(k=>typeof k=="string"?k:""):[""]):Array.isArray(a.left)&&Array.isArray(a.right)&&(x=[a.left.map(h=>typeof h=="string"?h:""),a.right.map(h=>typeof h=="string"?h:"")]),x.length<2&&(x=[[""],[""]]);const d=a.answer&&typeof a.answer=="object"?a.answer:null,o=(Array.isArray(d==null?void 0:d.paths)?d==null?void 0:d.paths:Array.isArray(a.correctPairs)?a.correctPairs:[]).map(h=>Array.isArray(h)?h.map(k=>Number(k)).filter(k=>Number.isInteger(k)&&k>=0):[]).filter(h=>h.length>0),c=Array.isArray(a.matchingPaths)?a.matchingPaths.map(h=>Array.isArray(h)?Array.from({length:x.length},(k,L)=>String(h[L]??"")):new Array(x.length).fill("")):null,j=c&&c.length>0?c:[...o.map(h=>h.map(String)),new Array(x.length).fill("")];return{type:i,title:u,question:l,columns:x,answer:{paths:o},matchingPaths:j}}if(i==="ordering"){const x=Array.isArray(a.options)?a.options.map(d=>typeof d=="string"?d:""):Array.isArray(a.items)?a.items.map(d=>typeof d=="string"?d:""):[""];return{type:i,title:u,question:l,options:x.length?x:[""]}}if(i==="truefalse"){const x=typeof a.answer=="boolean"?a.answer:typeof a.expected=="boolean"?a.expected:!0;return{type:i,title:u,question:l,answer:x}}if(i==="number")return typeof a.answer=="number"?{type:i,title:u,question:l,answer:a.answer}:typeof a.answer=="string"?{type:i,title:u,question:l,answer:a.answer}:typeof a.expected=="number"?{type:i,title:u,question:l,answer:a.expected}:{type:i,title:u,question:l,answer:""};if(i==="text"||i==="date"){const x=typeof a.answer=="string"?a.answer:typeof a.expected=="string"?a.expected:"";return{type:i,title:u,question:l,answer:x}}const b=Array.isArray(a.options)?a.options.map(x=>typeof x=="string"?x:""):[""],m=Array.isArray(a.answer)?a.answer.map(x=>Number(x)).filter(x=>Number.isInteger(x)&&x>=0):Array.isArray(a.correct)?a.correct.map(x=>Number(x)).filter(x=>Number.isInteger(x)&&x>=0):[];return{type:i,title:u,question:l,options:b.length?b:[""],answer:m}}function Si(t){const a=(t.title??"").trim(),s=(t.question??"").trim();switch(t.type){case"matching":{const r=(t.columns??[[""],[""]]).map(p=>p.map(o=>o.trim()).filter(Boolean)).filter(p=>p.length>0),i=r.length>=2?r:[[""],[""]],u=t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[],l=(t.matchingPaths??[]).map(p=>p.map(o=>String(o??""))),b=i.length,m=l.map(p=>p.slice(0,b).map(o=>o.trim())).filter(p=>p.some(Boolean)).map(p=>p.map(o=>Number(o))).filter(p=>p.length===b&&p.every(o=>Number.isInteger(o)&&o>=0)),x=(Array.isArray(u)?u:[]).map(p=>Array.isArray(p)?p.map(o=>Number(o)).filter(o=>Number.isInteger(o)&&o>=0):[]).filter(p=>p.length===b),d=Array.from(new Set([...x,...m].map(p=>JSON.stringify(p)))).map(p=>JSON.parse(p));return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,columns:i,answer:{paths:d}},null,2)}case"ordering":{const r=(t.options??[]).map(i=>i.trim()).filter(Boolean);return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,options:r},null,2)}case"truefalse":return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,answer:!!t.answer},null,2);case"number":return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,answer:typeof t.answer=="number"||typeof t.answer=="string"?t.answer:""},null,2);case"date":case"text":return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,answer:String(t.answer??"")},null,2);case"selection":default:{const r=(t.options??[]).map(l=>l.trim()).filter(Boolean),i=Array.isArray(t.answer)?t.answer:[],u=Array.from(new Set(i.filter(l=>Number.isInteger(l)&&l>=0&&l<r.length))).sort((l,b)=>l-b);return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,options:r,answer:u},null,2)}}}const Ts=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}];function Oa(){return{sourceKind:"string",locatorValue:"",locatorAux:"",bibleBookDisplay:"",sourceUrl:"",sourceAccessedDate:"",churchDocument:null,bookMedia:null,work:null}}function Cs(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function Is(t,a){if(!t||typeof t!="object")return a;const s=t,r=s.definition&&typeof s.definition=="object"?s.definition:null,i=[s.label,s.name,s.title,s.text,s.orcid,s.email,s.number];r&&i.unshift(r.title,r.question);for(const u of i)if(typeof u=="string"&&u.trim())return u.trim();return a}function Ms(t,a){var r;if(!(t instanceof ts))return a;const s=(r=t.message)==null?void 0:r.trim();if(!s)return a;try{const i=JSON.parse(s);if(typeof i.error=="string"&&i.error.trim())return i.error.trim()}catch{}return s}function Ti(t){const a=t.trim();if(!a)return null;try{const s=JSON.parse(a);return s&&typeof s=="object"&&!Array.isArray(s)?s:null}catch{return null}}function ia(t,a){const s=t==null?void 0:t[a];return typeof s=="string"?s:""}function Ci(t,a){return a?t==="book"&&a.infoType==="media"?{bookMedia:a}:t==="work"&&a.infoType==="work"?{work:a}:t==="number_document"&&a.infoType==="work"?{churchDocument:a}:{}:{}}function Ii(t,a){const s=Oa(),r=(t.sourceKind??"").trim()||s.sourceKind,i=t.locator??"",u=Ti(i);let l="",b="",m="",x="",d="";return r==="website"?(x=ia(u,"url"),d=ia(u,"accessedDate"),l=ia(u,"value")):r==="bible"?(l=ia(u,"book")||i.trim(),b=ia(u,"passage")||ia(u,"rest"),m=ia(u,"bookDisplay")):u?(l=ia(u,"value")||ia(u,"locator"),b=ia(u,"aux")):l=i,{...s,sourceKind:r,locatorValue:l,locatorAux:b,bibleBookDisplay:m,sourceUrl:x,sourceAccessedDate:d,...Ci(r,a)}}function Rn(t){return t.sourceKind==="book"?t.bookMedia:t.sourceKind==="work"?t.work:t.sourceKind==="number_document"?t.churchDocument:null}function $n(t){const a=t.locatorValue.trim(),s=t.locatorAux.trim(),r=t.sourceUrl.trim(),i=t.sourceAccessedDate.trim();switch(t.sourceKind){case"website":return{url:r,accessedDate:i};case"bible":return{book:a,bookDisplay:t.bibleBookDisplay.trim(),passage:s};case"book":case"work":case"number_document":return s?{value:a,aux:s}:a;default:return s?{value:a,aux:s}:a}}function Ls(t){var i,u,l;const a=t.locatorValue.trim(),s=t.locatorAux.trim(),r=[a,s].filter(Boolean).join(" ");switch(t.sourceKind){case"website":return t.sourceUrl.trim()||"website";case"bible":return r||"bible";case"book":return[(i=t.bookMedia)==null?void 0:i.label,r].filter(Boolean).join(" · ")||"book";case"work":return[(u=t.work)==null?void 0:u.label,r].filter(Boolean).join(" · ")||"work";case"number_document":return[(l=t.churchDocument)==null?void 0:l.label,r].filter(Boolean).join(" · ")||"number_document";default:return r||t.sourceKind||"source"}}function As(t){return t.sourceKind.trim()?t.sourceKind==="website"?!!t.sourceUrl.trim():t.sourceKind==="bible"?!!(t.locatorValue.trim()&&t.locatorAux.trim()):t.sourceKind==="book"?!!t.bookMedia:t.sourceKind==="work"?!!t.work:t.sourceKind==="number_document"?!!(t.churchDocument&&t.locatorValue.trim()):!!t.locatorValue.trim():!1}function Mi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,libraryId:d,editInfoId:p}){var Le,Be,at;const{libraryName:o}=ua(d),c=!!p,[j,h]=n.useState([]),[k,L]=n.useState("word"),[v,y]=n.useState({}),[Z,V]=n.useState({}),[w,Q]=n.useState({}),[S,te]=n.useState({}),[T,$]=n.useState(null),[oe,me]=n.useState("idle"),[Se,Je]=n.useState(Oa),[pe,E]=n.useState({}),[D,M]=n.useState({}),[G,O]=n.useState({}),[K,W]=n.useState(null),[U,ce]=n.useState(()=>za(JSON.parse(Ba))??Za()),[ve,Me]=n.useState(Ba),Ie=n.useMemo(()=>j.find(_=>_.infoType===k),[k,j]),He=n.useMemo(()=>j.find(_=>_.infoType==="source"),[j]),it=n.useMemo(()=>j.map(_=>({value:_.infoType,label:ot(t,_.infoType)})),[t,j]),Ce=_=>{const R=za(_)??Za(),z=Si(R);ce(R),y(F=>({...F,definition:z}))};n.useEffect(()=>{let _=!1;return jr({libraryId:d}).then(R=>{var z;if(!_&&(h(R),!c)){const F=(z=R[0])==null?void 0:z.infoType;F&&L(F)}}).catch(()=>{_||h([])}),()=>{_=!0}},[c,d]),n.useEffect(()=>{if(c||!Ie)return;const _={},R={},z={},F={};for(const N of Ie.payloadFields)Ie.infoType==="question"&&N.key==="definition"&&N.inputType==="json"?_[N.key]=Ba:_[N.key]="";for(const N of Ie.linkFields)N.multiple?z[N.key]=[]:R[N.key]=null,N.targetTypes.length>0&&(F[N.key]=N.targetTypes[0]);y(_),V(R),Q(z),te(F)},[Ie==null?void 0:Ie.infoType,c]),n.useEffect(()=>{if(k!=="question")return;const _=v.definition??"";if(!_.trim()){const R=za(JSON.parse(Ba))??Za();ce(R),Me(Ba);return}try{const R=JSON.parse(_),z=za(R);if(!z)return;ce(z),Me(JSON.stringify(R,null,2))}catch{}},[v.definition,k]),n.useEffect(()=>{if(!c||!p||j.length===0)return;let _=!1;return me("loading"),$(null),(async()=>{const z=await aa({libraryId:d,infoId:p});if(_)return;const F=z.infoType;L(F);const N=j.find(X=>X.infoType===F);if(!N){me("idle");return}const C=z.payload??{},A={};for(const X of N.payloadFields)A[X.key]=Cs(C[X.key]);y(A);const de=z.links??{}??{},xe={},ge={},ae={},P=[];for(const X of N.linkFields){X.targetTypes.length>0&&(ae[X.key]=X.targetTypes[0]);const se=de[X.key];if(X.multiple){const Y=Array.isArray(se)?se.filter(ee=>typeof ee=="string"):[];ge[X.key]=[];for(const ee of Y)P.push(aa({libraryId:d,infoId:ee}).then(Re=>{if(_)return;const ue={id:ee,infoType:Re.infoType,label:Is(Re.payload,ee)};ae[X.key]=ue.infoType,ge[X.key]=[...ge[X.key],ue]}).catch(()=>{}))}else{const Y=typeof se=="string"?se:null;xe[X.key]=null,Y&&P.push(aa({libraryId:d,infoId:Y}).then(ee=>{if(_)return;const Re={id:Y,infoType:ee.infoType,label:Is(ee.payload,Y)};ae[X.key]=Re.infoType,xe[X.key]=Re}).catch(()=>{}))}}await Promise.all(P),!_&&(V(xe),Q(ge),te(ae),me("idle"))})().catch(()=>{_||($("Failed to load info details."),me("idle"))}),()=>{_=!0}},[p,c,d,j]),n.useEffect(()=>{k==="source"&&Je(Ii(v,Z.resource??null))},[k,v.sourceKind,v.locator,(Le=Z.resource)==null?void 0:Le.id,(Be=Z.resource)==null?void 0:Be.infoType,(at=Z.resource)==null?void 0:at.label]);const Ye=_=>{var N,C;const R=((N=He==null?void 0:He.payloadFields.find(A=>A.key==="sourceKind"))==null?void 0:N.keepOnCreate)??!1,z=((C=He==null?void 0:He.linkFields.find(A=>A.key==="resource"))==null?void 0:C.keepOnCreate)??!1,F=Oa();return F.sourceKind=R?_.sourceKind:F.sourceKind,z&&(F.work=_.work,F.bookMedia=_.bookMedia,F.churchDocument=_.churchDocument),R&&_.sourceKind==="bible"&&(F.locatorValue=_.locatorValue,F.bibleBookDisplay=_.bibleBookDisplay),R&&_.sourceKind==="website"&&(F.sourceUrl=_.sourceUrl,F.sourceAccessedDate=_.sourceAccessedDate),F},kt=n.useMemo(()=>({sourceKindLabel:t.cogita.library.add.info.sourceKindLabel,bibleBookLabel:t.cogita.library.add.info.sourceBibleBookLabel,bibleBookPlaceholder:t.cogita.library.add.info.sourceBibleBookPlaceholder,bibleRestLabel:t.cogita.library.add.info.sourceBibleRestLabel,bibleRestPlaceholder:t.cogita.library.add.info.sourceBibleRestPlaceholder,churchDocumentLabel:t.cogita.library.add.info.sourceResourceLabel,churchDocumentPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,workLabel:t.cogita.library.add.info.sourceResourceLabel,workPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,bookLabel:t.cogita.library.add.info.sourceResourceLabel,bookPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,locatorLabel:t.cogita.library.list.typeFilterLocator,locatorPlaceholder:t.cogita.library.list.typeFilterLocator}),[t]),Oe=async _=>{const R=D[_]??Oa();if(!As(R)){O(z=>({...z,[_]:t.cogita.library.add.info.referenceMissingSource}));return}W(_),O(z=>({...z,[_]:null}));try{const z=Rn(R),F=z?{resource:z.id}:{},N={label:Ls(R),sourceKind:R.sourceKind.trim(),locator:$n(R)},A={id:(await Un({libraryId:d,infoType:"source",payload:N,links:F})).infoId,infoType:"source",label:N.label};if(Q(de=>{const xe=de[_]??[];return xe.some(ge=>ge.id===A.id)?de:{...de,[_]:[...xe,A]}}),c&&p){const de=await aa({libraryId:d,infoId:p}),xe=de.links&&typeof de.links=="object"?{...de.links}:{},ge=xe[_],ae=Array.isArray(ge)?ge.filter(P=>typeof P=="string"):typeof ge=="string"?[ge]:[];ae.includes(A.id)||(xe[_]=[...ae,A.id],await us({libraryId:d,infoId:p,payload:de.payload,links:xe}))}M(de=>({...de,[_]:Ye(R)})),O(de=>({...de,[_]:null}))}catch(z){O(F=>({...F,[_]:Ms(z,t.cogita.library.lookup.createFailed)}))}finally{W(z=>z===_?null:z)}},De=async()=>{var z;if(!Ie)return;const _={};for(const F of Ie.payloadFields){if(k==="source"&&(F.key==="sourceKind"||F.key==="locator"))continue;const N=(v[F.key]??"").trim();if(!N){if(F.required){$(`Field '${F.label}' is required.`);return}continue}if(F.inputType==="json")try{_[F.key]=JSON.parse(N)}catch{$(`Field '${F.label}' must be valid JSON.`);return}else _[F.key]=N}const R={};for(const F of Ie.linkFields)if(!(k==="source"&&F.key==="resource"))if(F.multiple){const N=(w[F.key]??[]).map(C=>C.id);if(F.required&&N.length===0){$(`Link '${F.label}' is required.`);return}N.length>0&&(R[F.key]=N)}else{const N=((z=Z[F.key])==null?void 0:z.id)??null;if(F.required&&!N){$(`Link '${F.label}' is required.`);return}N&&(R[F.key]=N)}if(k==="source"){if(!As(Se)){$(t.cogita.library.add.info.referenceMissingSource);return}const F=Se.sourceKind.trim();_.sourceKind=F,_.locator=$n(Se),(typeof _.label!="string"||!_.label.trim())&&(_.label=Ls(Se));const N=Rn(Se);N&&(R.resource=N.id)}me("saving"),$(null);try{if(c&&p)await us({libraryId:d,infoId:p,payload:_,links:R}),$("Info updated.");else{await Un({libraryId:d,infoType:k,payload:_,links:R}),$("Info saved.");const F={};for(const A of Ie.payloadFields)F[A.key]=A.keepOnCreate?v[A.key]??"":"";y(F);const N={},C={};for(const A of Ie.linkFields)A.multiple?C[A.key]=A.keepOnCreate?w[A.key]??[]:[]:N[A.key]=A.keepOnCreate?Z[A.key]??null:null;V(A=>({...A,...N})),Q(A=>({...A,...C})),k==="source"&&Je(A=>{const de=Ye(A),xe=Rn(de);return y(ge=>({...ge,sourceKind:de.sourceKind,locator:Cs($n(de))})),V(ge=>({...ge,resource:xe})),xe&&te(ge=>({...ge,resource:xe.infoType})),de})}}catch(F){$(Ms(F,"Failed to save info."))}finally{me("idle")}},rt=_=>{const R=v[_.key]??"";if(k==="question"&&_.key==="definition"&&_.inputType==="json"){const F=U.type,N=P=>{const X=U.title??"",se=U.question??"";Ce({...Za(P),title:X,question:se})},C=P=>P.length===0?[""]:P[P.length-1].trim()?[...P,""]:P,A=P=>{const X=(P.length?P:[[""],[""]]).map(se=>C(se));return X.length>=2?X:[...X,[""]]},de=(P,X)=>{const se=P.map(ee=>Array.from({length:X},(Re,ue)=>ee[ue]??"")).filter(ee=>ee.some(Re=>Re.trim())||ee===P[P.length-1]);return se.length===0?[new Array(X).fill("")]:se[se.length-1].some(ee=>ee.trim())?[...se,new Array(X).fill("")]:se},xe=Array.isArray(U.answer)?U.answer:[],ge=A(U.columns??[[""],[""]]),ae=de(U.matchingPaths??[[]],ge.length);return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:_.label}),e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.8rem"},children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question type"}),e.jsxs("select",{value:F,onChange:P=>N(P.target.value),children:[e.jsx("option",{value:"selection",children:"Selection"}),e.jsx("option",{value:"truefalse",children:"True / false"}),e.jsx("option",{value:"text",children:"Text answer"}),e.jsx("option",{value:"number",children:"Number answer"}),e.jsx("option",{value:"date",children:"Date answer"}),e.jsx("option",{value:"matching",children:"Matching"}),e.jsx("option",{value:"ordering",children:"Right order"})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Title"}),e.jsx("input",{type:"text",value:U.title??"",onChange:P=>Ce({...U,title:P.target.value}),placeholder:"Optional title"})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question"}),e.jsx("textarea",{rows:3,value:U.question??"",onChange:P=>Ce({...U,question:P.target.value}),placeholder:"Question text"})]}),F==="selection"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Options / correct indices"}),C(U.options??[""]).map((P,X,se)=>{const Y=new Set(xe.filter(Re=>Number.isInteger(Re))),ee=X===se.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:Y.has(X),disabled:!P.trim(),onChange:Re=>{const ue=Re.target.checked?[...Y,X]:[...Y].filter(fe=>fe!==X);Ce({...U,answer:ue})}}),e.jsx("input",{type:"text",value:P,placeholder:`Answer ${X+1}`,onChange:Re=>{const ue=[...U.options??[""]];ue[X]=Re.target.value;const fe=C(ue),ze=fe.length-1,et=xe.filter(Qe=>Qe>=0&&Qe<ze);Ce({...U,options:fe,answer:et})}}),ee?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const ue=(U.options??[""]).filter((ze,et)=>et!==X),fe=xe.filter(ze=>ze!==X).map(ze=>ze>X?ze-1:ze);Ce({...U,options:C(ue),answer:fe})},children:"Remove"})]},`question-option:${X}`)})]}):null,F==="text"||F==="date"||F==="number"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsx("input",{type:F==="date"?"date":"text",value:typeof U.answer=="string"||typeof U.answer=="number"?String(U.answer):"",onChange:P=>Ce({...U,answer:P.target.value})})]}):null,F==="truefalse"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsxs("select",{value:String(!!U.answer),onChange:P=>Ce({...U,answer:P.target.value==="true"}),children:[e.jsx("option",{value:"true",children:"True"}),e.jsx("option",{value:"false",children:"False"})]})]}):null,F==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Columns"}),ge.map((P,X)=>e.jsxs("div",{style:{display:"grid",gap:"0.35rem",border:"1px solid rgba(120,170,220,0.22)",borderRadius:"0.6rem",padding:"0.55rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"0.5rem"},children:[e.jsxs("span",{style:{fontSize:"0.8rem",color:"rgba(184,209,234,0.85)"},children:["Column ",X+1]}),ge.length>2?e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const se=ge.filter((ee,Re)=>Re!==X),Y=ae.map(ee=>ee.filter((Re,ue)=>ue!==X));Ce({...U,columns:A(se),matchingPaths:de(Y,Math.max(2,se.length))})},children:"Remove column"}):null]}),P.map((se,Y)=>{const ee=Y===P.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",gap:"0.4rem",alignItems:"center"},children:[e.jsx("input",{type:"text",value:se,placeholder:`Option ${Y+1}`,onChange:Re=>{const ue=ge.map(fe=>[...fe]);ue[X][Y]=Re.target.value,Ce({...U,columns:A(ue),matchingPaths:de(ae,ge.length)})}}),ee?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const Re=ge.map(ue=>[...ue]);Re[X]=Re[X].filter((ue,fe)=>fe!==Y),Ce({...U,columns:A(Re),matchingPaths:de(ae,ge.length)})},children:"Remove"})]},`question-column:${X}:row:${Y}`)})]},`question-column:${X}`)),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{const P=[...ge.map(se=>[...se]),[""]],X=ae.map(se=>[...se,""]);Ce({...U,columns:A(P),matchingPaths:de(X,P.length)})},children:"Add column"})}),e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Correct paths (0-based indices)"}),ae.map((P,X)=>{const se=X===ae.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:`repeat(${ge.length}, minmax(0,1fr)) auto`,gap:"0.35rem",alignItems:"center"},children:[P.map((Y,ee)=>e.jsx("input",{type:"number",min:0,step:1,value:Y,placeholder:`${ee}`,onChange:Re=>{const ue=ae.map(et=>[...et]);ue[X][ee]=Re.target.value;const fe=de(ue,ge.length),ze=fe.map(et=>et.map(Qe=>Qe.trim())).filter(et=>et.every(Qe=>Qe!=="")).map(et=>et.map(Qe=>Number(Qe))).filter(et=>et.every(Qe=>Number.isInteger(Qe)&&Qe>=0));Ce({...U,matchingPaths:fe,answer:{paths:ze}})}},`question-path:${X}:${ee}`)),se?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const Y=ae.filter((ue,fe)=>fe!==X),ee=de(Y,ge.length),Re=ee.map(ue=>ue.map(fe=>fe.trim())).filter(ue=>ue.every(fe=>fe!=="")).map(ue=>ue.map(fe=>Number(fe))).filter(ue=>ue.every(fe=>Number.isInteger(fe)&&fe>=0));Ce({...U,matchingPaths:ee,answer:{paths:Re}})},children:"Remove"})]},`question-path:${X}`)})]}):null,F==="ordering"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Ordered options (correct order = listed order)"}),C(U.options??[""]).map((P,X,se)=>{const Y=X===se.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)",minWidth:"1.5rem"},children:[X+1,"."]}),e.jsx("input",{type:"text",value:P,placeholder:`Step ${X+1}`,onChange:ee=>{const Re=[...U.options??[""]];Re[X]=ee.target.value,Ce({...U,options:C(Re)})}}),Y?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ce({...U,options:C((U.options??[]).filter((ee,Re)=>Re!==X))}),children:"Remove"})]},`question-order:${X}`)})]}):null,e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"JSON import"}),e.jsx("textarea",{rows:8,value:ve,onChange:P=>Me(P.target.value),placeholder:"Paste question JSON"}),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{try{const P=JSON.parse(ve),X=za(P);if(!X){$("Question JSON must be an object.");return}Ce(X),$(null)}catch{$("Question JSON is invalid.")}},children:"Interpret JSON"})})]})]})]},`payload:${_.key}`)}const z=_.inputType==="textarea"||_.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:_.label}),z?e.jsx("textarea",{rows:_.inputType==="json"?8:4,value:R,onChange:F=>y(N=>({...N,[_.key]:F.target.value})),placeholder:_.key}):e.jsx("input",{type:"text",value:R,onChange:F=>y(N=>({...N,[_.key]:F.target.value})),placeholder:_.key})]},`payload:${_.key}`)},gt=_=>{const R=S[_.key]??_.targetTypes[0],z=_.key==="references"&&_.multiple&&_.targetTypes.includes("source"),F=D[_.key]??Oa(),N=pe[_.key]??!1,C=G[_.key];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:_.label}),_.targetTypes.length>1?e.jsx("select",{value:R,onChange:A=>te(de=>({...de,[_.key]:A.target.value})),children:_.targetTypes.map(A=>e.jsx("option",{value:A,children:ot(t,A)},`${_.key}:${A}`))}):null,_.multiple?e.jsx(Xt,{libraryId:d,infoType:R,label:_.label,placeholder:_.key,multiple:!0,values:w[_.key]??[],onChangeMultiple:A=>Q(de=>({...de,[_.key]:A})),allowCreate:!z,searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(Xt,{libraryId:d,infoType:R,label:_.label,placeholder:_.key,value:Z[_.key]??null,onChange:A=>V(de=>({...de,[_.key]:A})),searchFailedText:"Search failed",createFailedText:"Create failed"}),z?e.jsxs("div",{children:[e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:N,onChange:A=>E(de=>({...de,[_.key]:A.target.checked}))}),e.jsx("span",{children:t.cogita.library.add.info.referenceToggle})]}),N?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(Ss,{libraryId:d,copy:t,language:m,sourceKindOptions:[...Ts],value:F,onChange:A=>M(de=>({...de,[_.key]:A})),labels:kt}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>Oe(_.key),disabled:K===_.key,children:K===_.key?t.cogita.library.lookup.saving:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.source)})}),C?e.jsx("p",{className:"cogita-library-subtitle",children:C}):null]}):null]}):null]},`link:${_.key}`)},tt=()=>e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(Ss,{libraryId:d,copy:t,language:m,sourceKindOptions:[...Ts],value:Se,onChange:Je,labels:kt})]});return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:c?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:o}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${d}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[c?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:k,onChange:_=>L(_.target.value),children:it.map(_=>e.jsx("option",{value:_.value,children:_.label},_.value))})]}),oe==="loading"&&c?e.jsx("p",{children:"Loading..."}):null,Ie&&!(oe==="loading"&&c)?e.jsxs("div",{className:"cogita-form-grid",children:[Ie.payloadFields.filter(_=>!(k==="source"&&(_.key==="sourceKind"||_.key==="locator"))).map(rt),k==="source"?tt():null,Ie.linkFields.filter(_=>!(k==="source"&&_.key==="resource")).map(gt)]}):oe==="loading"&&c?null:e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:De,disabled:oe==="saving"||!Ie,children:oe==="saving"?"Saving...":c?"Update info":"Create info"})}),T?e.jsx("p",{className:"cogita-library-subtitle",children:T}):null]})})})]})})}const Rs=t=>/\s/.test(t),on=t=>/[\p{L}\p{N}]/u.test(t),$s=(t,a)=>{const s=a>0?t[a-1]:"",r=a<t.length?t[a]:"";if(!s||!r)return 0;const i=Rs(s),u=Rs(r);if(i||u)return 3;const l=on(s),b=on(r);return l!==b?2:!l&&!b?1:0},Pn=(t,a,s,r,i)=>{const u=Math.max(r-a,s-r);for(let l=0;l<=u;l+=1){const b=r-l;if(b>=a&&b<=s&&$s(t,b)>=i)return b;const m=r+l;if(m>=a&&m<=s&&$s(t,m)>=i)return m}return null},En=(t,a)=>{const s=a>0?t[a-1]:"",r=a<t.length?t[a]:"";return!s||!r?!0:on(s)!==on(r)},Li=(t,a,s,r)=>{const i=s-a,u=a+r,l=s-r;if(i<=r*2||l<=u)return null;const b=Math.floor((a+s)/2),m=Pn(t,u,l,b,3);if(m!==null&&En(t,m))return m;const x=Pn(t,u,l,b,2);if(x!==null&&En(t,x))return x;const d=Pn(t,u,l,b,1);return d!==null&&En(t,d)?d:null},va=(t,a)=>{const s=Math.max(1,(a==null?void 0:a.minLen)??7),r=Math.max(s,(a==null?void 0:a.maxLen)??13),i={},u=(m,x,d,p,o)=>{const c=String(p),j={id:c,start:m,end:x,text:t.slice(m,x),depth:d,index:p,parentId:o};if(i[c]=j,x-m>r){let k=Li(t,m,x,s);if(k!==null&&k>m&&k<x){const L=u(m,k,d+1,p*2+1,c),v=u(k,x,d+1,p*2+2,c);j.leftId=L.id,j.rightId=v.id}}return j},l=u(0,t.length,0,0),b=Object.values(i).sort((m,x)=>x.depth-m.depth||m.start-x.start).map(m=>m.id);return{text:t,rootId:l.id,nodes:i,order:b}},Ra=(t,a,s,r,i,u,l)=>{const b=u==="reverse"?t.order.slice().sort((m,x)=>t.nodes[x].start-t.nodes[m].start||t.nodes[x].depth-t.nodes[m].depth):t.order;for(const m of b){if(l&&m===l||a.has(m))continue;const x=t.nodes[m];if(x){if(i&&(x.leftId||x.rightId)){const d=x.leftId?s[x.leftId]??0:r,p=x.rightId?s[x.rightId]??0:r;if((d+p)/2<r)continue}return x}}return null},vn=(t,a)=>({before:t.slice(0,a.start),fragment:t.slice(a.start,a.end),after:t.slice(a.end)});function Ai({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,libraryId:d}){const p=`/#/cogita/library/${d}`,[o,c,j]=Qn([]),[h,k,L]=Gn([]),[v,y]=n.useState(null),[Z,V]=n.useState(null),[w,Q]=n.useState(null),[S,te]=n.useState(null),T=n.useMemo(()=>o.find(E=>E.id===v)??null,[o,v]);n.useEffect(()=>{let E=!0;return wr({libraryId:d}).then(D=>{if(!E)return;const M=D.nodes.map(G=>{var O,K,W;return{id:G.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:G.payload&&typeof G.payload=="object"&&"label"in G.payload?String(G.payload.label):"Item",nodeType:G.nodeType,itemType:((O=G.payload)==null?void 0:O.itemType)??"info",itemId:((K=G.payload)==null?void 0:K.itemId)??null,infoType:((W=G.payload)==null?void 0:W.infoType)??null}}});c(M),k(D.edges.map(G=>({id:G.edgeId,source:G.fromNodeId,target:G.toNodeId})))}).catch(()=>{E&&(c([]),k([]))}),()=>{E=!1}},[d]),n.useEffect(()=>{kr({libraryId:d}).then(V).catch(()=>V(null))},[d,o,h]);const $=n.useCallback(E=>{k(D=>Yn(E,D))},[]),oe=()=>{const E=crypto.randomUUID();c(D=>[...D,{id:E,type:"default",position:{x:140+D.length*40,y:120+D.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},me=()=>{const E=crypto.randomUUID();c(D=>[...D,{id:E,type:"default",position:{x:180+D.length*40,y:160+D.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},Se=async()=>{Q(null);try{const E=o.map(M=>({nodeId:M.id,nodeType:M.data.nodeType,payload:{itemType:M.data.itemType,itemId:M.data.itemId??null,label:M.data.label,infoType:M.data.infoType??null}})),D=h.map(M=>({edgeId:M.id,fromNodeId:M.source,toNodeId:M.target}));await Nr({libraryId:d,nodes:E,edges:D}),Q(t.cogita.library.graph.saveSuccess)}catch{Q(t.cogita.library.graph.saveFail)}},Je=E=>{T&&c(D=>D.map(M=>M.id===T.id?{...M,data:{...M.data,itemId:(E==null?void 0:E.infoId)??null,itemType:"collection",infoType:"collection",label:(E==null?void 0:E.label)??t.cogita.library.infoTypes.collection}}:M))},pe=E=>{T&&c(D=>D.map(M=>M.id===T.id?{...M,data:{...M.data,itemId:(E==null?void 0:E.infoId)??null,itemType:"info",infoType:(E==null?void 0:E.infoType)??null,label:(E==null?void 0:E.label)??t.cogita.library.infoTypes.any}}:M))};return n.useEffect(()=>{if(!T||T.data.nodeType!=="info"||T.data.infoType!=="citation"||!T.data.itemId){te(null);return}let E=!0;return aa({libraryId:d,infoId:T.data.itemId}).then(D=>{if(!E)return;const M=D.payload,G=(M==null?void 0:M.text)??"";if(!G){te(null);return}const O=va(G),K=Object.values(O.nodes).sort((W,U)=>W.depth-U.depth||W.start-U.start).map(W=>({id:W.id,text:W.text,depth:W.depth}));te({title:(M==null?void 0:M.title)??T.data.label,fragments:K})}).catch(()=>te(null)),()=>{E=!1}},[d,T]),e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:p,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:Se,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:oe,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:me,children:t.cogita.library.actions.addInfo}),Z?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(Z.totalCollections))})}):null,w?e.jsx("p",{className:"cogita-help",children:w}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(fn,{nodes:o,edges:h,onNodesChange:j,onEdgesChange:L,onConnect:$,onNodeClick:(E,D)=>y(D.id),fitView:!0,children:[e.jsx(bn,{gap:18,size:1}),e.jsx(yn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),T?e.jsxs("div",{className:"cogita-graph-inspector",children:[T.data.nodeType==="collection"?e.jsx(Xt,{libraryId:d,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:T.data.itemId?{id:T.data.itemId,label:T.data.label,infoType:"collection"}:null,onChange:Je,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(Xt,{libraryId:d,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:T.data.itemId?{id:T.data.itemId,label:T.data.label,infoType:T.data.infoType??void 0}:null,onChange:pe,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),S?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:S.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:S.fragments.map(E=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:E.id}),e.jsx("span",{children:E.text})]},E.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function Ea({children:t,flashState:a,flashTick:s=0,feedbackToken:r,className:i}){const u=r??(a?`${a}-${s}`:"idle"),[l,b]=n.useState("a"),m=n.useRef(u);return n.useEffect(()=>{m.current!==u&&(m.current=u,b(x=>x==="a"?"b":"a"))},[u]),e.jsx("section",{className:i?`cogita-revision-card ${i}`:"cogita-revision-card","data-feedback":u,"data-feedback-variant":l,children:t})}function ns({copy:t,currentCard:a,currentTypeLabel:s,prompt:r,languages:i,answer:u,onAnswerChange:l,computedExpected:b,computedAnswers:m,onComputedAnswerChange:x,answerTemplate:d,outputVariables:p,variableValues:o,computedFieldFeedback:c,feedback:j,canAdvance:h,quoteContext:k,quotePlaceholder:L,onCheckAnswer:v,onSkip:y,onLanguageSelect:Z,onMarkReviewed:V,onAdvance:w,showCorrectAnswer:Q,setShowCorrectAnswer:S,onRevealCorrect:te,answerMask:T,expectedAnswer:$,hasExpectedAnswer:oe,handleComputedKeyDown:me,answerInputRef:Se,computedInputRefs:Je,scriptMode:pe,setScriptMode:E,matchPairs:D,matchLeftOrder:M,matchRightOrder:G,matchSelection:O,matchActiveLeft:K,matchActiveRight:W,matchFeedback:U,onMatchLeftSelect:ce,onMatchRightSelect:ve,disableCheckAnswer:Me=!1,hideSkipAction:Ie=!1,allowRevealBeforeCheck:He=!1,autoRevealAfterAnswer:it=!1,disableCheckAfterAnswer:Ce=!1}){const Ye=n.useMemo(()=>{var X;const R=!d&&b.length===2?`The {${b[0].key}} is of type {${b[1].key}}`:null,z=d??R;if(!z)return null;const F=new Map(b.map(se=>[se.key,se.expected])),N=new Set,C=[],A=/\{([^}]+)\}/g;let de=0,xe,ge=null;for(;(xe=A.exec(z))!==null;){const se=z.slice(de,xe.index);se&&C.push({type:"text",value:se});const Y=((X=xe[1])==null?void 0:X.trim())??"",ee=Y&&F.has(Y)?Y:Y&&p&&p[Y]?p[Y]:null;Y&&N.add(Y),ee&&N.add(ee),ee&&F.has(ee)?(C.push({type:"input",value:ee}),ge||(ge=ee)):Y&&o&&o[Y]!==void 0?C.push({type:"text",value:o[Y]}):C.push({type:"text",value:xe[0]}),de=xe.index+xe[0].length}const ae=z.slice(de);return ae&&C.push({type:"text",value:ae}),b.filter(se=>!N.has(se.key)).length>0?null:{parts:C,expectedByKey:F,firstInputKey:ge}},[d,b,p,o]),kt=()=>{if(!Ye)return null;const{parts:R,expectedByKey:z,firstInputKey:F}=Ye;return e.jsx("div",{className:"cogita-revision-inline-answer",children:R.map((N,C)=>{var A,de;return N.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:N.value},`text-${C}`):e.jsx("input",{ref:xe=>{Je.current[N.value]=xe},autoFocus:N.value===F,value:m[N.value]??"",onChange:xe=>x(N.value,xe.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":c[N.value]??(j==="correct"?"correct":j==="incorrect"?"incorrect":void 0),onKeyDown:xe=>gt(xe)||me(xe),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((A=m[N.value])==null?void 0:A.length)??0,((de=z.get(N.value))==null?void 0:de.length)??6)}ch`}},`input-${N.value}-${C}`)})})},Oe=n.useMemo(()=>{const R=new Map;return(D??[]).forEach(z=>R.set(z.leftId,z)),R},[D]),De=n.useMemo(()=>{const R=new Map;return(D??[]).forEach(z=>R.set(z.rightId,z)),R},[D]);n.useEffect(()=>{var C;if(a.cardType!=="info"||a.infoType!=="computed"||b.length===0)return;const R=typeof document<"u"?document.activeElement:null;if(R&&(R.tagName==="INPUT"||R.tagName==="TEXTAREA"))return;const z=(Ye==null?void 0:Ye.firstInputKey)??((C=b[0])==null?void 0:C.key);if(!z)return;const F=Je.current[z];if(!F)return;const N=requestAnimationFrame(()=>{F.focus()});return()=>cancelAnimationFrame(N)},[a,b,Ye]);const rt=(()=>{const R=[$??"",...b.map(N=>N.expected??"")].join(""),z=[u,...Object.values(m)].join(""),F=`${R}${z}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(F)})(),gt=R=>R.ctrlKey&&(R.key==="^"||R.key==="6")?(R.preventDefault(),E(z=>z==="super"?null:"super"),!0):R.ctrlKey&&(R.key==="_"||R.key==="-")?(R.preventDefault(),E(z=>z==="sub"?null:"sub"),!0):!1,tt=()=>{if(!$||!T)return $??"";const R=$.split(""),z=Array.from(T),F=z.length>0?z.reduce((N,C)=>N+C,0)/z.length:127;return R.map((N,C)=>{const A=z[C]??F,de=Math.max(0,Math.min(255,Math.round(A)));let xe=255,ge=0;return de<=127?ge=Math.round(de/127*255):(ge=255,xe=Math.round(255*(1-(de-127)/128))),e.jsx("span",{style:{color:`rgb(${xe}, ${ge}, 0)`},children:N},`mask-${C}`)})},Le=a.cardType==="info"&&a.infoType==="citation"?(k==null?void 0:k.title)||a.label:a.description,Be=Q||it&&j!==null,at=Me||Ce&&(j!==null||Be),_=oe&&(He||j==="incorrect"||Be);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[s?e.jsx("span",{children:s}):null,e.jsx("strong",{children:Le})]}),a.cardType==="vocab"&&a.checkType==="translation-match"&&D?e.jsxs("div",{className:"cogita-revision-body",children:[r?e.jsx("h2",{children:r}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(M??[]).map(R=>{const z=Oe.get(R);if(!z)return null;const F=(O==null?void 0:O[R])??null,N=(U==null?void 0:U[R])??null,C=K===R;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":C,"data-state":N??void 0,"data-locked":F?"true":void 0,onClick:()=>ce==null?void 0:ce(R),children:[e.jsx("span",{children:z.leftLabel}),F&&Q?e.jsx("em",{children:"✓"}):null]},R)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(G??[]).map(R=>{const z=De.get(R);if(!z)return null;const F=Object.values(O??{}).includes(R),N=W===R;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":F||N,"data-locked":F?"true":void 0,onClick:()=>ve==null?void 0:ve(R),children:e.jsx("span",{children:z.rightLabel})},R)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:a.checkType==="translation-match"||at,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):a.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:Se,value:u,onChange:R=>l(R.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":j==="correct"?"correct":j==="incorrect"?"incorrect":void 0,onKeyDown:R=>{if(R.key==="Enter")if(R.preventDefault(),R.stopPropagation(),h)w();else{if(at)return;v()}}})]}),rt?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":pe==="super",onClick:()=>E(R=>R==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":pe==="sub",onClick:()=>E(R=>R==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:at,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[a.label?e.jsx("p",{className:"cogita-revision-hint",children:a.label}):null,d?null:e.jsx(Sr,{value:r??"",mode:"auto"}),b.length>0?(()=>{const R=kt();return R?e.jsx("div",{className:"cogita-inline-answer-wrap",children:R}):e.jsx("div",{className:"cogita-form-grid",children:b.map((z,F)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:z.key}),e.jsx("textarea",{ref:N=>{Je.current[z.key]=N},autoFocus:F===0,value:m[z.key]??"",onChange:N=>x(z.key,N.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":c[z.key]??(j==="correct"?"correct":j==="incorrect"?"incorrect":void 0),onKeyDown:N=>gt(N)||me(N)})]},z.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:Se,value:u,onChange:R=>l(R.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":j==="correct"?"correct":j==="incorrect"?"incorrect":void 0,onKeyDown:R=>{if(!gt(R)&&R.key==="Enter")if(R.preventDefault(),R.stopPropagation(),h)w();else{if(at)return;v()}}})]})}),rt?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":pe==="super",onClick:()=>E(R=>R==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":pe==="sub",onClick:()=>E(R=>R==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:at,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="citation"&&k?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(k.completed)).replace("{total}",String(k.total))}),e.jsx("p",{className:"cogita-quote-text",children:k.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:Se,value:u,onChange:R=>l(R.target.value),placeholder:L??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":j==="correct"?"correct":j==="incorrect"?"incorrect":void 0,onKeyDown:R=>{if(R.key==="Enter")if(R.preventDefault(),R.stopPropagation(),h)w();else{if(at)return;v()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:k.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:at,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:i.length?i.map(R=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>Z(R.label),children:R.label},R.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:V,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}),j&&e.jsx("div",{className:"cogita-revision-feedback","data-state":j,children:j==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),_?e.jsxs("div",{className:"cogita-revision-reveal",children:[Be?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>S(R=>{const z=!R;return z&&te(),z}),children:t.cogita.library.revision.showAnswer}),Be?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),b.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[b.map(R=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:R.key}),e.jsx("span",{children:R.expected})]},R.key)),$?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:$})]}):null]}):e.jsx("p",{children:T?tt():$})]}):null]}):null,h?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:w,children:t.cogita.library.revision.nextQuestion})}):null]})}const Ps={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},Ri=(t,a)=>{const s=Math.max(t.length,a.length,1),r=Math.abs(t.length-a.length);return Math.max(0,1-r/s)},$i=(t,a)=>{const s=new Uint8Array(t.length),r=Ri(t,a);for(let i=0;i<t.length;i+=1){const u=t[i]===(a[i]??"")?128:0,l=t.length-1-i,b=a.length-1-i,m=t[l]===(a[b]??"")?127:0,x=Math.round((u+m)*r);s[i]=Math.max(0,Math.min(255,x))}return s},Pi=(t,a)=>t===a||(Ps[t]??[]).includes(a)?!0:(Ps[a]??[]).includes(t),en=(t,a,s)=>s?Pi(t,a):t===a,ln=(t,a,s)=>{const r=new Uint8Array(t.length);if(!t.length)return r;const i=(s==null?void 0:s.allowSimilarChars)??!0,u=[];for(let b=0;b<=t.length-3;b+=1)u.push({index:b,text:t.slice(b,b+3)});let l=!1;return u.forEach(b=>{for(let m=0;m<=a.length-3;m+=1){const x=a.slice(m,m+3);let d=0;for(let h=0;h<3;h+=1)en(b.text[h],x[h],i)&&(d+=1);if(d<2)continue;let p=b.index-1,o=m-1;for(;p>=0&&o>=0;){const h=t[p],k=a[o];if(h===k){r[p]=Math.max(r[p],255),p-=1,o-=1,l=!0;continue}if(en(h,k,i)&&h!==k){r[p]=Math.max(r[p],127),p-=1,o-=1,l=!0;continue}if(p>0&&t[p-1]===k){r[p]=Math.max(r[p],0),p-=1,l=!0;continue}if(o>0&&t[p]===a[o-1]){o-=1,l=!0;continue}break}for(let h=0;h<3;h+=1){const k=b.index+h,L=b.text[h],v=x[h],y=L===v?255:en(L,v,i)?127:0;r[k]=Math.max(r[k],y),l=!0}let c=b.index+3,j=m+3;for(;c<t.length&&j<a.length;){const h=t[c],k=a[j];if(h===k){r[c]=Math.max(r[c],255),c+=1,j+=1,l=!0;continue}if(en(h,k,i)&&h!==k){r[c]=Math.max(r[c],127),c+=1,j+=1,l=!0;continue}if(c+1<t.length&&t[c+1]===k){r[c]=Math.max(r[c],0),c+=1,l=!0;continue}if(j+1<a.length&&t[c]===a[j+1]){j+=1,l=!0;continue}break}}}),l?r:$i(t,a)},Fn=t=>/[\p{L}\p{N}]/u.test(t),Es=t=>t.trim().toLowerCase(),xa=(t,a)=>{if(t.length===0)return 100;const s=(a==null?void 0:a.treatSimilarCharsAsSame)??!1,r=Array.from(t).reduce((i,u)=>s&&u===127?i+255:i+u,0);return Math.round(r/(t.length*255)*100)},Sa=(t,a,s)=>{const r=Math.max(0,Math.min(100,(s==null?void 0:s.thresholdPercent)??100)),i=(s==null?void 0:s.treatSimilarCharsAsSame)??!0,u=(s==null?void 0:s.ignorePunctuationAndSpacing)??!1,l=Es(t),b=Es(a);if(!u){const v=ln(l,b,{allowSimilarChars:i}),y=xa(v,{treatSimilarCharsAsSame:i});return{mask:v,percent:y,isCorrect:y>=r,normalizedExpected:l,normalizedAnswer:b}}const m=Array.from(l),x=Array.from(b),d=[],p=[],o=[];m.forEach((v,y)=>{Fn(v)&&(d.push(v),p.push(y))}),x.forEach(v=>{Fn(v)&&o.push(v)});const c=d.join(""),j=o.join(""),h=ln(c,j,{allowSimilarChars:i}),k=new Uint8Array(m.length);for(let v=0;v<k.length;v+=1)k[v]=Fn(m[v]??"")?0:255;for(let v=0;v<h.length;v+=1){const y=p[v];y!==void 0&&(k[y]=h[v])}const L=xa(h,{treatSimilarCharsAsSame:i});return{mask:k,percent:L,isCorrect:L>=r,normalizedExpected:c,normalizedAnswer:j}},$a=(t,a,s)=>{const r=t.trim().toLowerCase(),i=a.trim().toLowerCase();return s==="prefix"||s==="bidirectional"?ln(r,i,{allowSimilarChars:!0}):ln(r,i,{allowSimilarChars:!0})};function Ei(t){if(!t||typeof t!="object")return null;const s=t.definition;if(!s||typeof s!="object")return null;const r=s,i=typeof r.type=="string"?r.type:typeof r.kind=="string"?r.kind:"selection",u=i==="multi_select"||i==="single_select"?"selection":i==="boolean"?"truefalse":i==="order"?"ordering":i;if(!["selection","truefalse","text","number","date","ordering","matching"].includes(u))return null;const l=u,b=typeof r.title=="string"?r.title:void 0,m=typeof r.question=="string"?r.question:"",x=Array.isArray(r.options)?r.options.map(o=>typeof o=="string"?o:"").filter(Boolean):void 0,d=Array.isArray(r.columns)?r.columns.map(o=>Array.isArray(o)?o.map(c=>typeof c=="string"?c:"").filter(Boolean):[]).filter(o=>o.length>0):void 0,p=(()=>{if(u==="selection")return(Array.isArray(r.answer)?r.answer:Array.isArray(r.correct)?r.correct:[]).map(c=>Number(c)).filter(c=>Number.isInteger(c)&&c>=0);if(u==="truefalse")return typeof r.answer=="boolean"?r.answer:typeof r.expected=="boolean"?r.expected:!1;if(u==="matching"){const o=r.answer&&typeof r.answer=="object"?r.answer:null;return{paths:(Array.isArray(o==null?void 0:o.paths)?o==null?void 0:o.paths:Array.isArray(r.correctPairs)?r.correctPairs:[]).map(h=>Array.isArray(h)?h.map(k=>Number(k)).filter(k=>Number.isInteger(k)&&k>=0):[]).filter(h=>h.length>0)}}if(typeof r.answer=="string"||typeof r.answer=="number")return r.answer;if(typeof r.expected=="string"||typeof r.expected=="number")return r.expected})();return{type:l,title:b,question:m,options:x,columns:d,answer:p}}function Fi(t){const a=[...t];for(let s=a.length-1;s>0;s-=1){const r=Math.floor(Math.random()*(s+1));[a[s],a[r]]=[a[r],a[s]]}return a}function Fs(t){const a=t.map((i,u)=>({value:i,oldIndex:u}));for(let i=a.length-1;i>0;i-=1){const u=Math.floor(Math.random()*(i+1));[a[i],a[u]]=[a[u],a[i]]}const s=a.map(i=>i.value),r=new Map;return a.forEach((i,u)=>r.set(i.oldIndex,u)),{values:s,oldToNew:r}}function Ki(t){if(t.type==="selection"){const a=t.options??[],s=Fs(a),r=Array.isArray(t.answer)?t.answer:[];return{...t,options:s.values,answer:r.map(i=>s.oldToNew.get(i)).filter(i=>Number.isInteger(i)).sort((i,u)=>i-u)}}if(t.type==="matching"){const s=(t.columns??[]).map(u=>Fs(u??[])),i=(t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[]).map(u=>u.map((l,b)=>{var m;return((m=s[b])==null?void 0:m.oldToNew.get(l))??l}));return{...t,columns:s.map(u=>u.values),answer:{paths:i}}}return t}function oa(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function Ks(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function _s(t){const a=t.checkType??"info",s=a.startsWith("question-")?`question / ${a.slice(9)}`:a;return t.direction?`${s} / ${t.direction}`:s}function _i({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,libraryId:d,infoId:p,selectedReviewerRoleId:o}){const[c,j]=n.useState(p),[h,k]=n.useState([]),[L,v]=n.useState([]),[y,Z]=n.useState("loading"),[V,w]=n.useState(null),[Q,S]=n.useState(null),[te,T]=n.useState(null),[$,oe]=n.useState(null),[me,Se]=n.useState(""),[Je,pe]=n.useState(null),[E,D]=n.useState(1),[M,G]=n.useState(null),[O,K]=n.useState(0),[W,U]=n.useState(!1),[ce,ve]=n.useState(null),[Me,Ie]=n.useState({}),[He,it]=n.useState({}),[Ce]=n.useState({}),[Ye,kt]=n.useState(null),[Oe,De]=n.useState({selection:[],booleanAnswer:null,ordering:[],matchingRows:[],matchingSelection:[]}),rt=n.useRef(null),gt=n.useRef({}),tt=Wa();n.useEffect(()=>{let ae=!1;return Z("loading"),Promise.all([aa({libraryId:d,infoId:p}).catch(()=>null),nn({libraryId:d,infoId:p}),sn({libraryId:d,infoId:p})]).then(([P,X,se])=>{if(ae)return;const Y=(P==null?void 0:P.payload)??{},ee=typeof Y.title=="string"&&Y.title||typeof Y.label=="string"&&Y.label||typeof Y.name=="string"&&Y.name||p;j(ee),S(Y),T((P==null?void 0:P.infoType)??null),k(X.items),v(se.items),Z("ready")}).catch(()=>{ae||(S(null),T(null),k([]),v([]),Z("error"))}),()=>{ae=!0}},[d,p]),n.useEffect(()=>{if(te!=="translation"){oe(null);return}Gs({libraryId:d,infoId:p,approachKey:"vocab-card"}).then(ae=>oe(ae.projection??null)).catch(()=>oe(null))},[te,p,d]);const Le=n.useMemo(()=>{var Re;const ae=new Map(h.map(ue=>[oa(ue),ue])),P=new Map,X=new Map;for(const ue of h)P.set(oa(ue),0),X.set(oa(ue),[]);for(const ue of L){const fe=Ks({parentItemId:ue.parentItemId,parentCheckType:ue.parentCheckType,parentDirection:ue.parentDirection}),ze=[ue.childItemId,ue.childCheckType??"",ue.childDirection??""].join("|");!ae.has(fe)||!ae.has(ze)||((Re=X.get(fe))==null||Re.push(ze),P.set(ze,(P.get(ze)??0)+1))}const se=Array.from(P.entries()).filter(([,ue])=>ue===0).map(([ue])=>ue),Y=new Map;for(const ue of se)Y.set(ue,0);for(;se.length;){const ue=se.shift(),fe=Y.get(ue)??0;for(const ze of X.get(ue)??[]){const et=Math.max(Y.get(ze)??0,fe+1);Y.set(ze,et),P.set(ze,(P.get(ze)??1)-1),(P.get(ze)??0)<=0&&se.push(ze)}}const ee=new Map;for(const ue of h){const fe=oa(ue),ze=Y.get(fe)??0,et=ee.get(ze)??[];et.push(fe),ee.set(ze,et)}return h.map(ue=>{const fe=oa(ue),ze=Y.get(fe)??0,et=ee.get(ze)??[fe],Qe=Math.max(0,et.indexOf(fe));return{id:fe,position:{x:40+Qe*290+(ze%2?18:0),y:30+ze*120},draggable:!1,selectable:!0,data:{label:ue.label,subtitle:_s(ue),checkType:ue.checkType??"info",direction:ue.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[h,L]),Be=n.useMemo(()=>new Map(h.map(ae=>[oa(ae),ae])),[h]),at=n.useMemo(()=>{const ae=[];for(const P of L){const X=Ks({parentItemId:P.parentItemId,parentCheckType:P.parentCheckType,parentDirection:P.parentDirection}),se=[P.childItemId,P.childCheckType??"",P.childDirection??""].join("|");!Be.has(X)||!Be.has(se)||ae.push({id:`${X}->${se}`,source:X,target:se,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return ae},[Be,L]),_=n.useMemo(()=>V?Be.get(V)??null:null,[Be,V]);n.useEffect(()=>{Se(""),G(null),K(0),U(!1),ve(null),pe(null),it({}),De({selection:[],booleanAnswer:null,ordering:[],matchingRows:[],matchingSelection:[]})},[V]);const R=n.useMemo(()=>{var Y,ee;if(!_)return null;const ae=te??_.infoType??null,P=_.checkType??"info",X=_.direction??null,se=Q??{};if(_.cardType==="vocab"&&$&&Array.isArray($.words)){const Re=$.words,ue=((Y=Re[0])==null?void 0:Y.label)??"?",fe=((ee=Re[1])==null?void 0:ee.label)??"?";return X==="a-to-b"?{kind:"vocab",prompt:String(ue),expected:String(fe)}:X==="b-to-a"?{kind:"vocab",prompt:String(fe),expected:String(ue)}:{kind:"generic",prompt:`${ue} ↔ ${fe}`,expected:`${ue} ↔ ${fe}`}}if(ae==="citation"&&P==="quote-fragment"&&X&&typeof se.text=="string"){const Re=X,ue=va(se.text),fe=ue.nodes[Re];if(fe){const ze=vn(se.text,fe);return{kind:"citation-fragment",expected:fe.text,quoteContext:{title:c,before:ze.before,after:ze.after,total:Object.keys(ue.nodes).length,completed:0},quotePlaceholder:fe.text.length>0?".".repeat(Math.max(4,Math.min(18,fe.text.length))):"..."}}}if(ae==="question"){const Re=Ei(se);if(Re)return{kind:"question",definition:Ki(Re)}}return{kind:"generic",prompt:_.description||_.label,expected:_.label}},[te,Q,_,c,$]);n.useEffect(()=>{var P;if(!R||R.kind!=="question")return;const ae=R.definition;De({selection:[],booleanAnswer:null,ordering:ae.type==="ordering"?Fi(ae.options??[]):[],matchingRows:[],matchingSelection:ae.type==="matching"?new Array(Math.max(2,((P=ae.columns)==null?void 0:P.length)??2)).fill(null):[]})},[R,V]);const z=async ae=>{if(_&&o)try{await Tr({libraryId:d,outcome:{itemType:"info",itemId:_.cardId,checkType:_.checkType??"info",direction:_.direction??null,revisionType:"direct",evalType:"direct-check",correct:ae,clientId:"cogita-info-checkcards",clientSequence:E,personRoleId:o}}),D(P=>P+1),pe(ae?"Saved as correct.":"Saved as incorrect.")}catch{pe("Failed to save answer.")}},F=_?oa(_):null,N=F?!!Me[F]:!1,C=async()=>{var se;if(!_||!R)return;const ae=oa(_);if(Me[ae]){pe("This card was already checked.");return}let P=!1,X=null;if(R.kind==="question"){const Y=R.definition;if(Y.type==="selection"){const ee=Array.isArray(Y.answer)?[...Y.answer].sort((ue,fe)=>ue-fe):[],Re=[...Oe.selection].sort((ue,fe)=>ue-fe);P=ee.length===Re.length&&ee.every((ue,fe)=>ue===Re[fe])}else if(Y.type==="truefalse")P=typeof Y.answer=="boolean"&&Oe.booleanAnswer!==null&&Y.answer===Oe.booleanAnswer;else if(Y.type==="ordering"){const ee=(Y.options??[]).join(`
`),Re=Oe.ordering.join(`
`),ue=Sa(ee,Re,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});P=ue.isCorrect,X=ue.mask}else if(Y.type==="matching"){const ee=Math.max(2,((se=Y.columns)==null?void 0:se.length)??2),Re=Oe.matchingRows.map(et=>et.slice(0,ee)).filter(et=>et.length===ee&&et.every(Qe=>Number.isInteger(Qe)&&Qe>=0)).map(et=>JSON.stringify(et)),ue=(Y.answer&&typeof Y.answer=="object"&&"paths"in Y.answer?Y.answer.paths:[]).map(et=>JSON.stringify(et)),fe=Array.from(new Set(Re)).sort(),ze=Array.from(new Set(ue)).sort();P=fe.length===ze.length&&fe.every((et,Qe)=>et===ze[Qe])}else{const ee=String(Y.answer??""),Re=Sa(ee,me,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});P=Re.isCorrect,X=Re.mask}ve(X),U(!0)}else{const Y=R.expected,ee=R.kind==="citation-fragment",Re=Sa(Y,me,{thresholdPercent:ee?90:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:ee});P=Re.isCorrect,ve(Re.mask),U(!0)}G(P?"correct":"incorrect"),K(Y=>Y+1),pe(o?null:"Answer checked locally (not saved: no person selected)."),Ie(Y=>({...Y,[ae]:!0})),o&&await z(P)},A=()=>{if(!_||!R)return;const ae=oa(_);if(Me[ae]||(Ie(X=>({...X,[ae]:!0})),pe("Answer revealed (not saved).")),R.kind==="question"){ve(null);return}const P=Sa(R.expected,R.expected,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:R.kind==="citation-fragment"});ve(P.mask)},de=n.useMemo(()=>_?_.infoType==="question"?{..._,description:_.label}:_.infoType==="citation"?{..._,description:c}:{..._,description:_.label}:null,[_,c]),xe=ae=>{var St,Mt;const P=ae.definition,X=N||W,se=Array.isArray(P.answer)?P.answer:[],Y=P.answer&&typeof P.answer=="object"&&"paths"in P.answer?P.answer.paths:[],ee=Math.max(2,((St=P.columns)==null?void 0:St.length)??2),Re=P.type==="matching"?Oe.matchingRows.filter(Ve=>Ve.length===ee&&Ve.every(Ee=>Number.isInteger(Ee)&&Ee>=0)):[],ue=Array.from({length:ee},(Ve,Ee)=>Oe.matchingSelection[Ee]??null),fe=Ve=>Ve.join("|"),ze=new Map;for(const Ve of Y){const Ee=fe(Ve);ze.set(Ee,(ze.get(Ee)??0)+1)}const et=new Map;for(const Ve of Re){const Ee=fe(Ve);et.set(Ee,(et.get(Ee)??0)+1)}const Qe=Y.filter(Ve=>{const Ee=fe(Ve),ht=et.get(Ee)??0;return ht>0?(et.set(Ee,ht-1),!1):!0}),Xe=new Map;for(const Ve of Qe)Ve.forEach((Ee,ht)=>{const nt=Xe.get(ht)??new Map;nt.set(Ee,(nt.get(Ee)??0)+1),Xe.set(ht,nt)});const Ct=(Ve,Ee)=>{X||De(ht=>{var jt;const nt=Math.max(2,((jt=P.columns)==null?void 0:jt.length)??2),mt=Array.from({length:nt},(dt,Kt)=>ht.matchingSelection[Kt]??null);if(mt[Ve]=mt[Ve]===Ee?null:Ee,mt.some(dt=>dt==null))return{...ht,matchingSelection:mt};const zt=mt.map(dt=>Number(dt)),Tt=fe(zt),vt=ht.matchingRows.filter(dt=>fe(dt)===Tt).length;return(ze.get(Tt)??0)>vt?(G("correct"),K(dt=>dt+1),pe(null),{...ht,matchingRows:[...ht.matchingRows,zt],matchingSelection:new Array(nt).fill(null)}):(G("incorrect"),K(dt=>dt+1),pe("This path is not valid or has already been used."),{...ht,matchingSelection:new Array(nt).fill(null)})})};return e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:P.question||(_==null?void 0:_.label)}),P.title?e.jsx("p",{className:"cogita-revision-hint",children:P.title}):null,P.type==="selection"?e.jsx("div",{className:"cogita-choice-grid",style:{gridTemplateColumns:"1fr"},children:(P.options??[]).map((Ve,Ee)=>e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.6rem"},children:[e.jsx("input",{type:"checkbox",checked:Oe.selection.includes(Ee),disabled:X,onChange:ht=>De(nt=>({...nt,selection:ht.target.checked?Array.from(new Set([...nt.selection,Ee])):nt.selection.filter(mt=>mt!==Ee)}))}),e.jsx("span",{children:Ve})]},`q-opt:${Ee}`))}):null,P.type==="truefalse"?e.jsxs("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:[e.jsx("button",{type:"button",className:"ghost","data-active":Oe.booleanAnswer===!0,disabled:X,onClick:()=>De(Ve=>({...Ve,booleanAnswer:!0})),children:"True"}),e.jsx("button",{type:"button",className:"ghost","data-active":Oe.booleanAnswer===!1,disabled:X,onClick:()=>De(Ve=>({...Ve,booleanAnswer:!1})),children:"False"})]}):null,P.type==="text"||P.type==="number"||P.type==="date"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:rt,type:P.type==="date"?"date":"text",value:me,onChange:Ve=>Se(Ve.target.value),disabled:X,"data-state":M==="correct"?"correct":M==="incorrect"?"incorrect":void 0})]}):null,P.type==="ordering"?e.jsx("div",{style:{display:"grid",gap:"0.45rem"},children:Oe.ordering.map((Ve,Ee)=>e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)"},children:[Ee+1,"."]}),e.jsx("span",{children:Ve}),e.jsx("button",{type:"button",className:"ghost",disabled:X||Ee===0,onClick:()=>De(ht=>{const nt=[...ht.ordering];return[nt[Ee-1],nt[Ee]]=[nt[Ee],nt[Ee-1]],{...ht,ordering:nt}}),children:"Up"}),e.jsx("button",{type:"button",className:"ghost",disabled:X||Ee>=Oe.ordering.length-1,onClick:()=>De(ht=>{const nt=[...ht.ordering];return[nt[Ee+1],nt[Ee]]=[nt[Ee],nt[Ee+1]],{...ht,ordering:nt}}),children:"Down"})]},`q-order:${Ee}:${Ve}`))}):null,P.type==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.65rem"},children:[e.jsx("div",{style:{display:"grid",gap:"0.65rem",gridTemplateColumns:`repeat(${Math.max(2,((Mt=P.columns)==null?void 0:Mt.length)??2)}, minmax(0, 1fr))`,alignItems:"start"},children:(P.columns??[]).map((Ve,Ee)=>e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.35rem",padding:"0.6rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:`Column ${Ee+1}`}),Ve.map((ht,nt)=>{var mt;return e.jsxs("button",{type:"button",className:"ghost cogita-checkcard-row",style:{textAlign:"left"},disabled:X||ue[Ee]!==nt&&(((mt=Xe.get(Ee))==null?void 0:mt.get(nt))??0)<=0,"data-active":ue[Ee]===nt?"true":void 0,onClick:()=>Ct(Ee,nt),children:[e.jsx("span",{children:ht}),e.jsx("small",{children:nt})]},`q-col:${Ee}:${nt}`)})]},`q-col:${Ee}`))}),e.jsxs("div",{style:{display:"grid",gap:"0.4rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:"Selected paths"}),Re.length?Re.map((Ve,Ee)=>e.jsxs("div",{className:"cogita-share-row",style:{alignItems:"center"},children:[e.jsx("span",{children:Ve.map((ht,nt)=>{var zt,Tt;const mt=String(((Tt=(zt=P.columns)==null?void 0:zt[nt])==null?void 0:Tt[ht])??ht);return`${nt>0?" -> ":""}${mt}`})}),X?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>De(ht=>({...ht,matchingRows:ht.matchingRows.filter((nt,mt)=>mt!==Ee)})),children:"Remove"})]},`q-path:${Ee}`)):e.jsx("p",{className:"cogita-library-hint",children:"Choose one option in each column. After the last column is selected, the path is checked automatically."})]})]}):null,e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>void C(),disabled:X,children:t.cogita.library.revision.checkAnswer})}),W?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),P.type==="selection"?e.jsx("p",{children:se.length?se.map(Ve=>{var Ee;return`${Ve}${(Ee=P.options)!=null&&Ee[Ve]?`: ${P.options[Ve]}`:""}`}).join(", "):"-"}):P.type==="truefalse"?e.jsx("p",{children:String(!!P.answer)}):P.type==="ordering"?e.jsx("ol",{children:(P.options??[]).map((Ve,Ee)=>e.jsx("li",{children:Ve},`ans-order:${Ee}`))}):P.type==="matching"?e.jsx("div",{style:{display:"grid",gap:"0.35rem"},children:Y.length?Y.map((Ve,Ee)=>e.jsx("p",{children:Ve.join(" → ")},`ans-path:${Ee}`)):e.jsx("p",{children:"-"})}):e.jsx("p",{children:String(P.answer??"")})]}):e.jsx("div",{className:"cogita-revision-reveal",children:e.jsx("button",{type:"button",className:"ghost",onClick:()=>{U(!0),A()},children:t.cogita.library.revision.showAnswer})})]})},ge=n.useMemo(()=>te?ot(t,te):t.cogita.library.infoTypes.any,[t,te]);return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:ge}),e.jsx("h2",{className:"cogita-card-title",children:c}),e.jsx("p",{className:"cogita-card-subtitle",children:p})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${h.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${L.length}`}),e.jsx("button",{type:"button",className:"cta",disabled:h.length===0,onClick:()=>tt(`/cogita/library/${d}/revision/run?libraryTarget=revisions&scope=info&infoId=${encodeURIComponent(p)}`),children:"Start revision"})]})]}),y==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):y==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(fn,{nodes:Le,edges:at,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:(ae,P)=>w(P.id),panOnDrag:!0,children:[e.jsx(bn,{}),e.jsx(yn,{showInteractive:!1})]})}),_?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[R&&de?e.jsx(Ea,{flashState:M,flashTick:O,children:R.kind==="question"?xe(R):e.jsx(ns,{copy:t,currentCard:de,currentTypeLabel:"",prompt:R.kind==="citation-fragment"?null:R.prompt,languages:[],answer:me,onAnswerChange:Se,computedExpected:[],computedAnswers:He,onComputedAnswerChange:(ae,P)=>it(X=>({...X,[ae]:P})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:Ce,feedback:M,canAdvance:!1,quoteContext:R.kind==="citation-fragment"?R.quoteContext:null,quotePlaceholder:R.kind==="citation-fragment"?R.quotePlaceholder:null,onCheckAnswer:()=>void C(),onSkip:()=>w(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:W,setShowCorrectAnswer:U,onRevealCorrect:A,answerMask:ce,expectedAnswer:R.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:rt,computedInputRefs:gt,scriptMode:Ye,setScriptMode:kt,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:N||W,hideSkipAction:!0,allowRevealBeforeCheck:!0,autoRevealAfterAnswer:!0,disableCheckAfterAnswer:!0})}):null,o?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),Je?e.jsx("p",{className:"cogita-library-hint",children:Je}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:h.map(ae=>{const P=oa(ae),X=V===P;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${X?"active":""}`,onClick:()=>w(P),children:[e.jsx("span",{children:ae.label}),e.jsx("small",{children:_s(ae)})]},P)})})]})]})]})})})})})}function tn(t,a){var s,r;return((r=(s=t.fields.find(i=>i.fieldType===a))==null?void 0:s.plainValue)==null?void 0:r.trim())??""}function Di(t){return tn(t,"role_kind").toLowerCase()==="person"}function Bi(t){return tn(t,"label")||tn(t,"display_name")||tn(t,"name")||t.roleId}function zi({copy:t,onPersonCreated:a}){const[s,r]=n.useState([]),[i,u]=n.useState("loading"),[l,b]=n.useState(null),[m,x]=n.useState(!1),[d,p]=n.useState(""),o=async()=>{u("loading");try{const h=await Ys();r(h),u("ready")}catch{r([]),u("error")}};n.useEffect(()=>{o()},[]);const c=n.useMemo(()=>s.filter(Di).map(h=>({roleId:h.roleId,label:Bi(h)})).sort((h,k)=>h.label.localeCompare(k.label)),[s]),j=async()=>{const h=d.trim();if(!h){b("Name is required.");return}x(!0),b(null);try{const k=await Cr({fields:[{fieldType:"nick",plainValue:h},{fieldType:"role_kind",plainValue:"person"},{fieldType:"label",plainValue:h},{fieldType:"display_name",plainValue:h}]});p(""),b("Person role created."),a==null||a(k.roleId),await o()}catch{b("Failed to create person role.")}finally{x(!1)}};return e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-browser-panel",children:[e.jsx("div",{className:"cogita-info-overview-head",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Cogita"}),e.jsx("h2",{className:"cogita-card-title",children:"Persons"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Select reviewer persons in the header and create new person roles here."})]})}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Create"}),e.jsx("h3",{className:"cogita-detail-title",children:"New person role"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{type:"text",value:d,onChange:h=>p(h.target.value),placeholder:"e.g. Anna Kowalska",disabled:m})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:j,disabled:m,children:m?"Creating...":"Create person"})}),l?e.jsx("p",{className:"cogita-library-hint",children:l}):null]})]}),e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Overview"}),e.jsx("h3",{className:"cogita-detail-title",children:"All person roles"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[i==="loading"?e.jsx("p",{children:"Loading persons..."}):null,i==="error"?e.jsx("p",{children:"Failed to load persons."}):null,i==="ready"&&c.length===0?e.jsx("p",{children:"No person roles found."}):null,i==="ready"&&c.length>0?e.jsxs("div",{className:"cogita-details-grid",children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:"Name"}),e.jsx("span",{children:"Type"}),e.jsx("span",{children:"Role ID"}),e.jsx("span",{})]}),c.map(h=>e.jsxs("div",{className:"cogita-details-row",role:"row",children:[e.jsx("span",{}),e.jsx("span",{title:h.label,children:h.label}),e.jsx("span",{children:"person"}),e.jsx("span",{title:h.roleId,children:h.roleId}),e.jsx("span",{})]},h.roleId))]}):null]})]})]})]})})})})}function Vi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,libraryId:d,collectionId:p}){const{libraryName:o}=ua(d),[c,j]=n.useState([]),[h,k]=n.useState("loading"),[L,v]=n.useState("idle"),y=n.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),Z=`/#/cogita/library/${d}`,V=()=>{k("loading"),Xs({libraryId:d}).then(S=>{j(S),k("idle")}).catch(()=>{j([]),k("error")})};n.useEffect(()=>{V()},[d]);const w=async S=>{try{await Zs({libraryId:d,shareId:S}),V()}catch{V()}},Q=async S=>{const te=`${y}/${S}`;try{await navigator.clipboard.writeText(te),v("copied")}catch{v("failed")}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:o}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:Z,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${Z}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[h==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):h==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):c.filter(S=>!p||S.collectionId===p).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:c.filter(S=>!p||S.collectionId===p).map(S=>e.jsxs("div",{className:"cogita-share-row","data-state":S.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:S.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(S.createdUtc).toLocaleString(),S.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),S.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${y}/${S.shareCode}`}):null]}),S.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[S.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>Q(S.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>w(S.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},S.shareId))}),L==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):L==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function Oi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,libraryId:d}){const{libraryName:p}=ua(d),[o,c]=n.useState(null),[j,h]=n.useState(null),[k,L]=n.useState(null),[v,y]=n.useState(null),[Z,V]=n.useState(null),[w,Q]=n.useState(null),S=n.useRef(null),te=oe=>{if(!Number.isFinite(oe))return"0 B";if(oe<1024)return`${oe} B`;const me=oe/1024;if(me<1024)return`${me.toFixed(1)} KB`;const Se=me/1024;return Se<1024?`${Se.toFixed(1)} MB`:`${(Se/1024).toFixed(1)} GB`},T=async()=>{c(null),V({loadedBytes:0,totalBytes:null,percent:null});try{c(t.cogita.library.overview.exporting);const oe=await Ir(d,V),me=URL.createObjectURL(oe),Se=document.createElement("a");Se.href=me,Se.download=`cogita-library-${p||d}.json`,Se.click(),URL.revokeObjectURL(me),c(t.cogita.library.overview.exportReady)}catch{c(t.cogita.library.overview.exportFail)}finally{V(oe=>oe??{loadedBytes:0,totalBytes:null,percent:null})}},$=async oe=>{var Se;h(null),L(null),y(null);const me=(Se=oe.target.files)==null?void 0:Se[0];if(me)try{h(t.cogita.library.overview.importing),Q({loadedBytes:0,totalBytes:me.size,percent:0});const Je=await Mr(d,me,Q,pe=>{const E=pe.stage==="infos"?t.cogita.library.overview.importStageInfos:pe.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;y(t.cogita.library.overview.importLiveProgress.replace("{stage}",E).replace("{done}",String(pe.processed)).replace("{total}",String(pe.total)).replace("{infos}",String(pe.infos)).replace("{connections}",String(pe.connections)).replace("{collections}",String(pe.collections)))});L({infos:Je.infosImported,connections:Je.connectionsImported,collections:Je.collectionsImported}),h(t.cogita.library.overview.importDone)}catch(Je){const pe=Je instanceof ts&&Je.message?` ${Je.message}`:"";h(`${t.cogita.library.overview.importFail}${pe}`)}finally{S.current&&(S.current.value="")}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:T,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:S,type:"file",accept:"application/json",onChange:$})]})]}),Z?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:Z.percent??void 0,max:Z.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",te(Z.loadedBytes)).replace("{total}",Z.totalBytes?te(Z.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,w?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:w.percent??void 0,max:w.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",te(w.loadedBytes)).replace("{total}",w.totalBytes?te(w.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,o?e.jsx("p",{className:"cogita-help",children:o}):null,j?e.jsx("p",{className:"cogita-help",children:j}):null,v?e.jsx("p",{className:"cogita-help",children:v}):null,k?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(k.infos)).replace("{connections}",String(k.connections)).replace("{collections}",String(k.collections))}):null]})]})})})]})})}function qi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,libraryId:d}){const{libraryName:p}=ua(d),[o,c]=n.useState(""),[j,h]=n.useState([]),k=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:o,onChange:L=>c(L.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const L=o.trim();L&&(h(v=>[{id:k(),name:L},...v]),c(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[j.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,j.map(L=>e.jsx("button",{type:"button",className:"ghost",children:L.name},L.id))]})]})]})})})]})})}function Ui({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,libraryId:d}){const{libraryName:p}=ua(d),[o,c]=n.useState(""),[j,h]=n.useState([]),k=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:o,onChange:L=>c(L.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const L=o.trim();L&&(h(v=>[{id:k(),name:L},...v]),c(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[j.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,j.map(L=>e.jsx("button",{type:"button",className:"ghost",children:L.name},L.id))]})]})]})})})]})})}function Ji({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,libraryId:d}){const{libraryName:p}=ua(d),o=`/#/cogita/library/${d}`,[c,j]=n.useState(""),[h,k]=n.useState([]),[L,v]=n.useState("idle"),[y,Z]=n.useState(0),[V,w]=n.useState(null);n.useEffect(()=>{v("loading");const S=window.setTimeout(()=>{Ua({libraryId:d,query:c.trim()||void 0,limit:30}).then(te=>{k(te.items),Z(te.total),w(te.nextCursor??null),v("ready")}).catch(()=>{k([]),Z(0),w(null),v("ready")})},240);return()=>window.clearTimeout(S)},[d,c]);const Q=async()=>{if(V){v("loading");try{const S=await Ua({libraryId:d,query:c.trim()||void 0,limit:30,cursor:V});k(te=>[...te,...S.items]),w(S.nextCursor??null),Z(S.total),v("ready")}catch{v("ready")}}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:o,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${o}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:c,onChange:S=>j(S.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(h.length)).replace("{total}",String(y||h.length))}),e.jsx("span",{children:L==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:h.length?h.map(S=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${o}/collections/${S.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:S.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(S.itemCount))," ·"," ",S.notes||t.cogita.library.collections.noNotes]})]})},S.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${o}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),V?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:Q,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const Te=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,ta=(t,a,s,r)=>`${t}:${a}:${s??""}:${r??""}`;function Hi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,libraryId:d,collectionId:p}){ua(d);const o=`/#/cogita/library/${d}`,[c,j]=n.useState(t.cogita.library.collections.defaultName),[h,k]=n.useState(null),[L,v]=n.useState(0),[y,Z]=n.useState([]),[V,w]=n.useState("idle"),[Q,S]=n.useState(null),te=n.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(y.length)).replace("{total}",String(L||y.length)),[t,y.length,L]);n.useEffect(()=>{xn(d,p).then($=>{j($.name),k($.notes??null),v($.itemCount)}).catch(()=>{j(t.cogita.library.collections.defaultName),k(null)})},[d,p]),n.useEffect(()=>{w("loading"),Ja({libraryId:d,collectionId:p,limit:40}).then($=>{Z($.items),S($.nextCursor??null),v($.total),w("ready")}).catch(()=>{Z([]),S(null),w("ready")})},[d,p]);const T=async()=>{if(Q){w("loading");try{const $=await Ja({libraryId:d,collectionId:p,limit:40,cursor:Q});Z(oe=>[...oe,...$.items]),S($.nextCursor??null),v($.total),w("ready")}catch{w("ready")}}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:h||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:o,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${o}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${o}/collections/${p}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${o}/collections/${p}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:te}),e.jsx("span",{children:V==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:y.length?y.map($=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:$.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:$.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:$.label}),e.jsx("p",{className:"cogita-card-subtitle",children:$.description})]})},Te($))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),Q?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:T,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${o}/collections/${p}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const Ds=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],Wi={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},Qi=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Gi=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function Yi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,libraryId:d,onCreated:p}){const o=Pa(),{libraryName:c}=ua(d),j=`/#/cogita/library/${d}`,[h,k]=n.useState(null),[L,v]=n.useState(""),[y,Z]=n.useState(""),[V,w,Q]=Qn([]),[S,te,T]=Gn([]),[$,oe]=n.useState(null),[me,Se]=n.useState(null),Je=n.useRef(null),pe=n.useMemo(()=>V.find(O=>O.id===$)??null,[V,$]);n.useEffect(()=>{const O=new URLSearchParams(o.search),K=(O.get("draft")??"").trim(),W=(O.get("draftType")??"").trim();if(!K||W!=="info-selection"||Je.current===K)return;const U=bi(d,K);if(!U||U.infoIds.length===0)return;const ce=crypto.randomUUID(),ve=U.infoIds.length>1?crypto.randomUUID():null,Me=U.infoIds.map((Ce,Ye)=>({id:crypto.randomUUID(),type:"default",position:{x:80,y:80+Ye*100},data:{nodeType:"source.info",label:"Selected info",params:{infoId:Ce,infoType:"any"}}})),Ie=ve?[{id:ve,type:"default",position:{x:360,y:120+Math.max(0,(U.infoIds.length-1)*50)},data:{nodeType:"logic.or",label:"Selected infos",params:{}}}]:[],He={id:ce,type:"default",position:{x:660,y:140+Math.max(0,(U.infoIds.length-1)*35)},data:{nodeType:"output.collection",label:"Collection output",params:{}}},it=Me.map(Ce=>({id:crypto.randomUUID(),source:Ce.id,target:ve??ce}));ve&&it.push({id:crypto.randomUUID(),source:ve,target:ce}),w([...Me,...Ie,He]),te(it),oe(ce),Se(`Draft loaded from ${U.infoIds.length} selected infos. Set name and save to create collection.`),Je.current=K},[d,o.search,te,w]);const E=O=>{var ce;const K=crypto.randomUUID(),W=((ce=Ds.find(ve=>ve.type===O))==null?void 0:ce.label)??O,U={...Wi[O]};w(ve=>[...ve,{id:K,type:"default",position:{x:120+ve.length*40,y:120+ve.length*40},data:{nodeType:O,label:W,params:U}}]),oe(K)},D=n.useCallback(O=>{te(K=>Yn({...O,id:crypto.randomUUID()},K))},[te]),M=O=>{pe&&w(K=>K.map(W=>W.id===pe.id?{...W,data:{...W.data,params:O}}:W))},G=async()=>{if(Se(null),!L.trim()){Se(t.cogita.library.collections.saveRequiredName);return}try{const O={nodes:V.map(U=>({nodeId:U.id,nodeType:U.data.nodeType,payload:{position:U.position,params:U.data.params}})),edges:S.map(U=>({edgeId:U.id,fromNodeId:U.source,fromPort:U.sourceHandle??null,toNodeId:U.target,toPort:U.targetHandle??null}))};let K=h,W=!1;if(K)await er({libraryId:d,collectionId:K,nodes:O.nodes,edges:O.edges});else{const U=await Lr({libraryId:d,name:L.trim(),notes:y.trim()||void 0,items:[],graph:O});K=U.collectionId,W=!0,k(U.collectionId)}Se(W?t.cogita.library.collections.saveSuccess:t.cogita.library.graph.saveSuccess),p(K)}catch{Se(h?t.cogita.library.graph.saveFail:t.cogita.library.collections.saveFail)}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.createKicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.createSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:j,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${j}/collections`,children:t.cogita.library.actions.collections}),e.jsx("button",{type:"button",className:"cta",onClick:G,children:t.cogita.library.actions.saveCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.collectionInfoTitle}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{value:L,onChange:O=>v(O.target.value),placeholder:t.cogita.library.collections.namePlaceholder})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.notesLabel}),e.jsx("textarea",{value:y,onChange:O=>Z(O.target.value),placeholder:t.cogita.library.collections.notesPlaceholder})]}),me?e.jsx("p",{className:"cogita-help",children:me}):null,e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Ds.map(O=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>E(O.type),children:O.label},O.type))})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(fn,{nodes:V,edges:S,onNodesChange:Q,onEdgesChange:T,onConnect:D,onNodeClick:(O,K)=>oe(K.id),fitView:!0,children:[e.jsx(bn,{color:"rgba(120,160,200,0.2)"}),e.jsx(yn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),pe?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:pe.data.label}),pe.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Xt,{libraryId:d,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:pe.data.params.tagId?{id:pe.data.params.tagId,label:pe.data.params.tagLabel??"",infoType:"topic"}:null,onChange:O=>M({...pe.data.params,tagId:(O==null?void 0:O.id)??null,tagLabel:(O==null?void 0:O.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:pe.data.params.scope??"any",onChange:O=>M({...pe.data.params,scope:O.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),pe.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Xt,{libraryId:d,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:pe.data.params.languageId?{id:pe.data.params.languageId,label:pe.data.params.languageLabel??"",infoType:"language"}:null,onChange:O=>M({...pe.data.params,languageId:(O==null?void 0:O.id)??null,languageLabel:(O==null?void 0:O.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:pe.data.params.scope??"any",onChange:O=>M({...pe.data.params,scope:O.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),pe.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:pe.data.params.infoType??"word",onChange:O=>M({...pe.data.params,infoType:O.target.value}),children:Gi.map(O=>e.jsx("option",{value:O.value,children:O.label},O.value))})]}),e.jsx(Xt,{libraryId:d,infoType:pe.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:pe.data.params.infoId?{id:pe.data.params.infoId,label:pe.data.params.infoLabel??"",infoType:pe.data.params.infoType??"word"}:null,onChange:O=>M({...pe.data.params,infoId:(O==null?void 0:O.id)??null,infoLabel:(O==null?void 0:O.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),pe.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:pe.data.params.connectionType??"translation",onChange:O=>M({...pe.data.params,connectionType:O.target.value}),children:Qi.map(O=>e.jsx("option",{value:O.value,children:O.label},O.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:pe.data.params.connectionId??"",onChange:O=>M({...pe.data.params,connectionId:O.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(pe.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const ca=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const a=t.length,s=t.filter(u=>u.correct).length,r=jn(ss(t));return{score:Math.round(Math.max(0,Math.min(100,r.knowness*100))*100)/100,total:a,correct:s,lastReviewedUtc:r.lastReviewedUtc??null}},Xi=t=>{if(t.maskBase64)try{const a=Ar(t.maskBase64);if(!a.length)return t.correct?1:0;const s=a.reduce((r,i)=>r+i,0);return Math.max(0,Math.min(1,s/a.length/255))}catch{return t.correct?1:0}return t.correct?1:0},ss=t=>t.map(a=>({correctness:Xi(a),createdUtc:a.createdUtc})),jn=(t,a=Date.now())=>{var L;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const r=t.slice().sort((v,y)=>v.createdUtc.localeCompare(y.createdUtc)).slice(-5),i=r.reduce((v,y)=>v+y.correctness,0)/r.length,u=5,l=2,b=.15;let m=0,x=0;for(let v=0;v<r.length;v+=1){const y=new Date(r[v].createdUtc).getTime(),Z=v===r.length-1?a:new Date(r[v+1].createdUtc).getTime(),V=Math.max(0,(Z-y)/(1e3*60)),w=1-Math.exp(-V/u);m+=w,r[v].correctness>.5&&(x+=b)}let d=i*m*l+x;const p=((L=r[r.length-1])==null?void 0:L.createdUtc)??null,o=p?Math.max(0,(a-new Date(p).getTime())/(1e3*60)):0,j=1/(1+Math.log1p(o/60));return d*=j,r.length===1&&r[0].correctness>.5&&(d+=5.44*Math.exp(-o/2)),{knowness:d,avgCorrectness:i,lastReviewedUtc:p}},Ha=t=>{const a=t.slice();for(let s=a.length-1;s>0;s-=1){const r=Math.floor(Math.random()*(s+1));[a[s],a[r]]=[a[r],a[s]]}return a},an=t=>t[Math.floor(Math.random()*t.length)],Zi=(t,a)=>{const s=new Map;return t.forEach(r=>s.set(r,Math.random())),t.sort((r,i)=>{const u=a(r)-a(i);return u!==0?u:(s.get(r)??0)-(s.get(i)??0)})},wn=(t,a,s,r,i)=>{if(!t.length)return null;const u=t.filter(b=>!(i!=null&&i.has(Te(b))));if(u.length===0)return null;const l=u.filter(b=>Te(b)!==s);return an(l.length?l:u)},eo=(t,a,s,r,i)=>{if(!t.length)return null;let u=Number.POSITIVE_INFINITY;for(const x of t){const d=Te(x);if(s.has(d))continue;const p=a[d]??1;p<u&&(u=p)}if(!Number.isFinite(u))return null;const l=t.filter(x=>{const d=Te(x);return!s.has(d)&&(a[d]??1)===u}),b=l.filter(x=>!i||Te(x)!==i),m=r?b.filter(x=>!r.has(Te(x))):b;return m.length>0?an(m):b.length>0?an(b):i&&l.some(x=>Te(x)===i)?l.find(x=>Te(x)===i)??null:l.length?an(l):null},or=(t,a,s,r,i)=>{const u=[],l=t.filter(m=>!i.has(Te(m))&&!s.has(Te(m))&&(a[Te(m)]??0)<1),b=Zi(l,m=>a[Te(m)]??0);for(const m of b){if(u.length>=r)break;u.push(m),i.add(Te(m))}if(u.length<r){const m=Ha(t.filter(x=>!i.has(Te(x))&&s.has(Te(x))));for(const x of m){if(u.length>=r)break;u.push(x),i.add(Te(x))}}return u},to=(t,a,s,r)=>or(t,a,s,r,new Set),rs=(t,a,s,r,i,u)=>{const l=Math.max(1,s.stackSize??a),m=Ha(t).filter((j,h,k)=>k.findIndex(L=>Te(L)===Te(j))===h),x=to(m,r,i,l),d=new Set,p=new Set,o=wn(x,{},null,d,p),c=o?[o]:[];return o&&p.add(Te(o)),{queue:c,meta:{pool:m,active:x,knownessMap:r,unknownSet:i,outcomesById:u,asked:d,queued:p}}},Wn={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,a)=>{const r=Ha(t).filter((i,u,l)=>l.findIndex(b=>Te(b)===Te(i))===u);return{queue:r.slice(0,Math.min(a,r.length)),meta:{}}},applyOutcome:t=>t},is=(t,a,s,r)=>{const i=Math.max(1,s.stackSize??a),l=Ha(t).filter((h,k,L)=>L.findIndex(v=>Te(v)===Te(h))===k),b={},m=new Set,x=new Set,d=new Set,p=Math.max(1,s.levels??1);l.forEach(h=>{const k=Te(h),L=r==null?void 0:r[k],v=typeof L=="number"&&Number.isFinite(L)?L:1;b[k]=Math.min(p,Math.max(1,Math.round(v)))});const o=[];if(l.length>0){const h=new Map;l.forEach(L=>{var y;const v=b[Te(L)]??1;h.has(v)||h.set(v,[]),(y=h.get(v))==null||y.push(L)});const k=Array.from(h.keys()).sort((L,v)=>L-v);for(const L of k){if(o.length>=i)break;const v=Ha(h.get(L)??[]);for(const y of v){if(o.length>=i)break;o.push(y)}}}const c=wn(o,b,null,m,x),j=c?[c]:[];return c&&x.add(Te(c)),{queue:j,meta:{pool:l,active:o,levelMap:b,asked:m,queued:x,wrongSinceCorrect:d}}},ao={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,a)=>Math.max(1,a.stackSize??t),getProgressTotal:()=>null,prepare:(t,a,s)=>is(t,a,s),applyOutcome:(t,a,s,r,i)=>{if(!a)return t;const u=Math.max(1,r.levels??1),l=t.meta.pool??[],b=t.meta.active??[],m={...t.meta.levelMap??{}},x=new Set(t.meta.asked??[]),d=new Set(t.meta.queued??[]),p=new Set(t.meta.wrongSinceCorrect??[]),o=Te(a);d.delete(o),x.add(o);const c=m[o]??1;i.correct?(m[o]=p.has(o)?1:Math.min(c+1,u),p.delete(o)):(m[o]=1,p.add(o));const j=i.correct?b.filter(L=>Te(L)!==o):b.slice();if(i.correct&&j.length<Math.max(1,r.stackSize??1)){const L=new Set(j.map(y=>Te(y))),v=eo(l,m,L,x,o);v&&j.push(v)}const h=t.queue.slice(),k=wn(j,m,o,x,d);return k&&(h.push(k),d.add(Te(k))),{queue:h,meta:{pool:l,active:j,levelMap:m,asked:x,queued:d,wrongSinceCorrect:p}}}},no={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,a)=>Math.max(1,a.stackSize??t),getProgressTotal:()=>null,prepare:(t,a,s)=>rs(t,a,s,{},new Set,{}),applyOutcome:(t,a,s,r,i)=>{if(!a)return t;const u=t.meta.pool??[],l=t.meta.active??[],b={...t.meta.knownessMap??{}},m=new Set(t.meta.unknownSet??[]),x={...t.meta.outcomesById??{}},d=new Set(t.meta.asked??[]),p=new Set(t.meta.queued??[]),o=Te(a);p.delete(o),d.add(o);const c={correctness:Math.max(0,Math.min(1,i.correctness??(i.correct?1:0))),createdUtc:i.createdUtc??new Date().toISOString()},h=(x[o]??[]).concat(c).sort((V,w)=>V.createdUtc.localeCompare(w.createdUtc)).slice(-5);x[o]=h,m.delete(o);const k=Date.now();u.forEach(V=>{const w=Te(V),Q=x[w]??[];if(Q.length===0){b[w]=0,m.add(w);return}const S=jn(Q,k);b[w]=S.knowness});const L=l.slice();if((b[o]??0)>=1){const V=L.filter(w=>Te(w)!==o);L.length=0,L.push(...V)}const y=Math.max(1,r.stackSize??s);if(L.length<y){const V=new Set(L.map(Q=>Te(Q))),w=or(u,b,m,y-L.length,V);L.push(...w)}const Z=t.queue.slice();if(Z.length===0||Te(Z[Z.length-1])===o){const V=wn(L,{},o,d,p);V&&(Z.push(V),p.add(Te(V)))}return{queue:Z,meta:{pool:u,active:L,knownessMap:b,unknownSet:m,outcomesById:x,asked:d,queued:p}}}},lr={random:Wn,levels:ao,temporal:no},so=Object.values(lr),os=t=>{if(!t)return Wn;const a=t.trim().toLowerCase();return a==="random"||a==="levels"||a==="temporal"?lr[a]:Wn},kn=(t,a)=>{const s={...t.defaultSettings};return a&&Object.entries(a).forEach(([r,i])=>{typeof i=="number"&&Number.isFinite(i)&&(s[r]=i),typeof i=="string"&&(s[r]=i)}),t.settingsFields.forEach(r=>{var u;const i=s[r.key];if(r.type==="number"){if(typeof i!="number"||Number.isNaN(i)){s[r.key]=t.defaultSettings[r.key]??0;return}r.min!==void 0&&(s[r.key]=Math.max(r.min,s[r.key])),r.max!==void 0&&(s[r.key]=Math.min(r.max,s[r.key]));return}if(r.type==="select"){const l=((u=r.options)==null?void 0:u.map(b=>b.value))??[];(typeof i!="string"||l.length>0&&!l.includes(i))&&(s[r.key]=t.defaultSettings[r.key]??l[0]??"")}}),s},cr=(t,a)=>{const s={};return t.settingsFields.forEach(r=>{const i=a.get(r.key);if(i){if(r.type==="number"){const u=Number(i);Number.isNaN(u)||(s[r.key]=u);return}s[r.key]=i}}),kn(t,s)},ro=(t,a)=>{const s=new URLSearchParams;return t.settingsFields.forEach(r=>{const i=a[r.key];(typeof i=="number"||typeof i=="string")&&s.set(r.key,String(i))}),s};function Bs({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,libraryId:d,collectionId:p,revisionId:o}){const c=Wa(),{libraryName:j}=ua(d),h=`/#/cogita/library/${d}`,[k,L]=n.useState(t.cogita.library.collections.defaultName),[v,y]=n.useState([]),[Z,V]=n.useState(p??""),[w,Q]=n.useState(""),[S,te]=n.useState(20),[T,$]=n.useState("random"),[oe,me]=n.useState({}),[Se,Je]=n.useState("exact"),[pe,E]=n.useState([]),[D,M]=n.useState(null),[G,O]=n.useState([]),[K,W]=n.useState([]),[U,ce]=n.useState(""),[ve,Me]=n.useState("idle"),[Ie,He]=n.useState(null),[it,Ce]=n.useState("idle"),[Ye,kt]=n.useState("idle"),[Oe,De]=n.useState("idle"),rt=n.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),gt=n.useMemo(()=>os(T),[T]),tt=n.useMemo(()=>kn(gt,oe),[gt,oe]),Le=n.useMemo(()=>ro(gt,tt).toString(),[gt,tt]),Be=n.useMemo(()=>{const N=U.trim().toLocaleLowerCase();return N?K.filter(C=>C.name.toLocaleLowerCase().includes(N)):K},[U,K]);n.useEffect(()=>{V(p??"")},[p]),n.useEffect(()=>{if(!Z){L(t.cogita.library.collections.defaultName);return}xn(d,Z).then(N=>L(N.name)).catch(()=>L(t.cogita.library.collections.defaultName))},[t.cogita.library.collections.defaultName,d,Z]),n.useEffect(()=>{Ua({libraryId:d,limit:200}).then(N=>y(N.items.map(C=>({collectionId:C.collectionId,name:C.name})))).catch(()=>y([]))},[d]),n.useEffect(()=>{Xn({libraryId:d}).then(N=>W(N)).catch(()=>W([]))},[d]),n.useEffect(()=>{o&&as({libraryId:d,revisionId:o}).then(N=>{V(N.collectionId),Q(N.name),$(N.mode||"random"),Je(N.check||"exact"),te(N.limit||20),me(N.revisionSettings??{})}).catch(()=>{Q("")})},[d,o]),n.useEffect(()=>{tr({libraryId:d}).then(N=>{E(N),!D&&N.length>0&&M(N[0].roleId)}).catch(()=>{E([])})},[d]);const at=()=>{kt("loading"),Xs({libraryId:d}).then(N=>{O(N),kt("idle")}).catch(()=>{O([]),kt("error")})};n.useEffect(()=>{at()},[d]);const _=async()=>{Me("working"),Ce("idle");try{if(!Z){Me("error");return}const N=await $r({libraryId:d,collectionId:Z,revisionType:gt.id,revisionSettings:tt,mode:T,check:Se,limit:S});He(`${rt}/${N.shareCode}${Le?`?${Le}`:""}`),Me("ready"),at()}catch{Me("error")}},R=async()=>{if(o){De("saving");try{await Rr({libraryId:d,collectionId:p??Z,revisionId:o,targetCollectionId:Z,name:w||k,revisionType:gt.id,revisionSettings:tt,mode:T,check:Se,limit:S}),De("saved"),Z&&c(`/cogita/library/${d}/revisions/${encodeURIComponent(o)}`,{replace:!0})}catch{De("error")}}},z=async()=>{if(Ie)try{await navigator.clipboard.writeText(Ie),Ce("copied")}catch{Ce("failed")}},F=async N=>{try{await Zs({libraryId:d,shareId:N}),at()}catch{at()}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:k}),e.jsx("p",{className:"cogita-library-subtitle",children:j})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:h,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${h}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:Z?`${h}/collections/${Z}`:`${h}/collections`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${h}${o?`/revisions/${encodeURIComponent(o)}/run`:Z?`/collections/${Z}/revision/run`:"/revision/run"}?mode=${encodeURIComponent(T)}&check=${encodeURIComponent(Se)}&limit=${S}${Le?`&${Le}`:""}${D?`&reviewer=${encodeURIComponent(D)}`:""}${o?`&revisionId=${encodeURIComponent(o)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:U,onChange:N=>ce(N.target.value),placeholder:t.cogita.workspace.revisionForm.namePlaceholder})}),e.jsxs("div",{className:"cogita-card-list","data-view":"list",children:[e.jsxs("a",{className:"cogita-card-select",href:`${h}/revisions/new`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:t.cogita.workspace.revisionForm.createAction})]}),Be.map(N=>e.jsxs("a",{className:"cogita-card-select",href:`${h}/revisions/${encodeURIComponent(N.revisionId)}`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:N.name})]},N.revisionId))]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsx("select",{value:Z,onChange:N=>V(N.target.value),children:v.map(N=>e.jsx("option",{value:N.collectionId,children:N.name},N.collectionId))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:w,onChange:N=>Q(N.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:T,onChange:N=>$(N.target.value),children:so.map(N=>e.jsx("option",{value:N.id,children:t.cogita.library.revision[N.labelKey]},N.id))})]}),gt.settingsFields.map(N=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[N.labelKey]}),N.type==="select"?e.jsx("select",{value:String(tt[N.key]??""),onChange:C=>me(A=>({...A,[N.key]:C.target.value})),children:(N.options??[]).map(C=>e.jsx("option",{value:C.value,children:t.cogita.library.revision[C.labelKey]},C.value))}):e.jsx("input",{type:"number",min:N.min,max:N.max,step:N.step,value:tt[N.key]??0,onChange:C=>me(A=>({...A,[N.key]:Number(C.target.value||0)}))})]},N.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),gt.id!=="levels"&&gt.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:S,onChange:N=>te(Number(N.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:D??"",onChange:N=>M(N.target.value||null),children:pe.map(N=>e.jsx("option",{value:N.roleId,children:N.label},N.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[o?e.jsx("button",{type:"button",className:"cta ghost",onClick:R,disabled:Oe==="saving",children:Oe==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${h}${o?`/revisions/${encodeURIComponent(o)}/run`:Z?`/collections/${Z}/revision/run`:"/revision/run"}?mode=${encodeURIComponent(T)}&check=${encodeURIComponent(Se)}&limit=${S}${Le?`&${Le}`:""}${D?`&reviewer=${encodeURIComponent(D)}`:""}${o?`&revisionId=${encodeURIComponent(o)}`:""}`,children:t.cogita.library.actions.startRevision}),o?e.jsx("a",{className:"cta ghost",href:`/#/cogita/live-revision-host/${encodeURIComponent(d)}/${encodeURIComponent(o)}`,children:"Live session"}):null,e.jsx("a",{className:"cta ghost",href:`/#/cogita/live-sessions/${encodeURIComponent(d)}`,children:"Active live sessions"})]}),Oe==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),Ie?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:Ie,readOnly:!0})]}):null,ve==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,it==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):it==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:_,disabled:ve==="working",children:ve==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),Ie?e.jsx("button",{type:"button",className:"cta ghost",onClick:z,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),Ye==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):G.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:G.map(N=>e.jsxs("div",{className:"cogita-share-row","data-state":N.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:N.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(N.createdUtc).toLocaleString(),N.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),N.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>F(N.shareId),children:t.cogita.library.revision.shareRevokeAction})]},N.shareId))})]})]})]})]})})})]})})}const Kn=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function dr(t,a,s){if(!t)return null;const r=new Map(t.nodes.map(V=>[V.id,V])),i=new Map,u=new Set,l=V=>{if(typeof V=="number")return V;if(typeof V=="string"){const w=Number(V);return Number.isFinite(w)?w:0}return 0},b=V=>{if(i.has(V))return i.get(V);if(u.has(V))return 0;const w=r.get(V);if(!w)return 0;u.add(V);const Q=te=>{var $,oe;return(te?(($=w.inputsByHandle)==null?void 0:$[te])??[]:w.inputs??((oe=w.inputsByHandle)==null?void 0:oe.in)??[]).map(me=>b(me))};let S=0;switch(w.type){case"input.random":{const te=w.min??0,T=w.max??te+10,$=Math.min(te,T),oe=Math.max(te,T);S=Math.floor(Math.random()*(oe-$+1))+$;break}case"input.const":{S=w.value??0;break}case"input.list":{const te=(w.list??[]).filter(Boolean),T=Math.round(l(Q("index")[0]));S=te.length?te[Math.max(0,Math.min(te.length-1,T))]:String(T);break}case"compute.add":{S=Q("in").map(T=>l(T)).reduce((T,$)=>T+$,0);break}case"compute.sub":{const te=Q("add").map($=>l($)),T=Q("sub").map($=>l($));S=te.reduce(($,oe)=>$+oe,0)-T.reduce(($,oe)=>$+oe,0);break}case"compute.mul":{const te=Q("in").map(T=>l(T));S=te.length?te.reduce((T,$)=>T*$,1):0;break}case"compute.div":{const te=l(Q("num")[0]),T=Q("den").map($=>l($)).reduce(($,oe)=>$+oe,0);S=Math.abs(T)<Number.EPSILON?0:te/T;break}case"compute.pow":{const te=l(Q("base")[0]),T=l(Q("exp")[0]);S=Math.pow(te,T);break}case"compute.exp":{const te=l(Q("base")[0]),T=l(Q("exp")[0]);S=Math.pow(te,T);break}case"compute.log":{const te=l(Q("value")[0]),T=l(Q("base")[0]),$=Math.max(te,Number.EPSILON);S=Math.abs(T)<Number.EPSILON?Math.log($):Math.log($)/Math.log(T);break}case"compute.abs":{S=Math.abs(l(Q("in")[0]));break}case"compute.min":{const te=Q("in").map(T=>l(T));S=te.length?Math.min(...te):0;break}case"compute.max":{const te=Q("in").map(T=>l(T));S=te.length?Math.max(...te):0;break}case"compute.floor":{S=Math.floor(l(Q("in")[0]));break}case"compute.ceil":{S=Math.ceil(l(Q("in")[0]));break}case"compute.round":{S=Math.round(l(Q("in")[0]));break}case"compute.mod":{const te=l(Q("a")[0]),T=l(Q("b")[0]);S=Math.abs(T)<Number.EPSILON?0:te%T;break}case"compute.concat":{const T=["in1","in2","in3","in4","in5","in6"].flatMap(Se=>Q(Se)),$=T.length?T:Q("in");S=($.length?$:Q()).map(Se=>Se==null?"":String(Se)).join("");break}case"compute.trim":{const te=Q("text")[0]??Q("in")[0]??"",T=te==null?"":String(te),$=Math.max(0,Math.round(l(Q("start")[0]))),oe=Math.max(0,Math.round(l(Q("end")[0])));$+oe>=T.length?S="":S=T.substring($,T.length-oe);break}case"output":{S=Q("in")[0]??0;break}default:S=0}return u.delete(V),i.set(V,S),S},m=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(V=>V.type==="output").map(V=>V.id);t.nodes.forEach(V=>b(V.id)),m.forEach(V=>b(V));const x=V=>Math.abs(V%1)<1e-5?String(Math.round(V)):V.toFixed(3).replace(/\.?0+$/,""),d=V=>typeof V=="number"?x(V):V??"",p=new Map;m.forEach(V=>{var T,$,oe,me;const w=r.get(V);if(!w)return;const Q=($=(T=w.inputsByHandle)==null?void 0:T.name)==null?void 0:$[0],S=Q?d(i.get(Q)):"",te=(S==null?void 0:S.toString().trim())||((oe=w.outputLabel)==null?void 0:oe.trim())||((me=w.name)==null?void 0:me.trim())||V;p.set(V,te)});const o={},c={},j={};m.forEach(V=>{var S,te;const w=r.get(V);if(!w)return;const Q=p.get(V)??(((S=w.outputLabel)==null?void 0:S.trim())||((te=w.name)==null?void 0:te.trim())||V);o[Q]=d(i.get(V)),w.name&&(c[w.name.trim()]=Q),c[V]=Q});const h=(V,w)=>{let Q=V;return t.nodes.forEach(S=>{var me,Se;const te=d(i.get(S.id)),T=m.includes(S.id),$=T?p.get(S.id)??((me=S.outputLabel)==null?void 0:me.trim())??((Se=S.name)==null?void 0:Se.trim())??S.id:"",oe=T&&w?$:te;Q=Q.replace(new RegExp(`\\{\\s*${Kn(S.id)}\\s*\\}`,"gi"),oe),S.name&&(Q=Q.replace(new RegExp(`\\{\\s*${Kn(S.name)}\\s*\\}`,"gi"),oe)),T&&S.outputLabel&&(Q=Q.replace(new RegExp(`\\{\\s*${Kn(S.outputLabel)}\\s*\\}`,"gi"),$))}),Q},k=a;let L=k.trim().length>0?k:"";L||(L=m.length?`Compute ${m.join(", ")}`:"Compute"),L=h(L,!0);const v=(s==null?void 0:s.trim())??"",y=v?h(v,!1):"",Z={};return i.forEach((V,w)=>{Z[w]=V,j[w]=d(V);const Q=r.get(w);Q!=null&&Q.name&&(j[Q.name.trim()]=d(V))}),{prompt:L,answers:o,values:Z,answerText:y,outputVariables:c,variableValues:j}}function ur(t){var s;const a=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((s=a[0])==null?void 0:s[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const _n=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function hr({outcomes:t}){const[a,s]=n.useState("day"),r=n.useMemo(()=>{const i=_n.find(b=>b.id===a)??_n[1],u=Date.now()-i.ms,l=t.filter(b=>new Date(b.createdUtc).getTime()>=u);return ca(l)},[t,a]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:_n.map(i=>e.jsx("button",{type:"button",className:"ghost","data-active":a===i.id,onClick:()=>s(i.id),children:i.label},i.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[r.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[r.correct," / ",r.total]})]})}const io="cogita-revision",oo=1,cn="outcomes",lo=()=>new Promise((t,a)=>{const s=indexedDB.open(io,oo);s.onupgradeneeded=()=>{const r=s.result;if(!r.objectStoreNames.contains(cn)){const i=r.createObjectStore(cn,{keyPath:"id"});i.createIndex("byItem","itemKey",{unique:!1}),i.createIndex("byPending","pending",{unique:!1})}},s.onerror=()=>a(s.error),s.onsuccess=()=>t(s.result)}),Qa=async(t,a)=>{const s=await lo();return new Promise((r,i)=>{const u=s.transaction(cn,t),l=u.objectStore(cn);a(l).then(r).catch(i),u.onerror=()=>i(u.error)})},gr=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const a=Array.from(t).map(s=>s.toString(16).padStart(2,"0"));return`${a.slice(0,4).join("")}-${a.slice(4,6).join("")}-${a.slice(6,8).join("")}-${a.slice(8,10).join("")}-${a.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},co=()=>{const t="cogita_revision_client_id",a=localStorage.getItem(t);if(a)return a;const s=gr();return localStorage.setItem(t,s),s},uo=()=>{const t="cogita_revision_client_seq",a=Number(localStorage.getItem(t)??"0"),s=Number.isFinite(a)?a+1:1;return localStorage.setItem(t,String(s)),s},mr=(t,a,s,r)=>ta(t,a,s,r),dn=async t=>{const a=co(),s=uo(),r=new Date().toISOString(),i={...t,clientId:a,clientSequence:s,createdUtc:r,id:gr(),pending:!0};return await Qa("readwrite",u=>new Promise((l,b)=>{const m={...i,itemKey:mr(i.itemType,i.itemId,i.checkType,i.direction)},x=u.add(m);x.onsuccess=()=>l(),x.onerror=()=>b(x.error)})),i},un=async(t,a,s,r)=>{if(!a)return[];try{const i=mr(t,a,s,r);return await Qa("readonly",u=>new Promise((l,b)=>{const x=u.index("byItem").getAll(i);x.onsuccess=()=>{const p=(x.result??[]).map(o=>({itemType:o.itemType,itemId:o.itemId,checkType:o.checkType??null,direction:o.direction??null,revisionType:o.revisionType,evalType:o.evalType,correct:o.correct,createdUtc:o.createdUtc,maskBase64:o.maskBase64,payloadBase64:o.payloadBase64,payloadHashBase64:o.payloadHashBase64,clientId:o.clientId,clientSequence:o.clientSequence,personRoleId:o.personRoleId??null})).sort((o,c)=>o.createdUtc.localeCompare(c.createdUtc));l(p)},x.onerror=()=>b(x.error)}))}catch{return[]}},da=async()=>{try{return await Qa("readonly",t=>new Promise((a,s)=>{const r=t.getAll();r.onsuccess=()=>{const u=(r.result??[]).map(l=>({itemType:l.itemType,itemId:l.itemId,checkType:l.checkType??null,direction:l.direction??null,revisionType:l.revisionType,evalType:l.evalType,correct:l.correct,createdUtc:l.createdUtc,maskBase64:l.maskBase64,payloadBase64:l.payloadBase64,payloadHashBase64:l.payloadHashBase64,clientId:l.clientId,clientSequence:l.clientSequence,personRoleId:l.personRoleId??null}));a(u)},r.onerror=()=>s(r.error)}))}catch{return[]}},ho=async(t=100)=>{try{return await Qa("readonly",a=>new Promise((s,r)=>{const u=a.index("byPending").getAll(!0);u.onsuccess=()=>{const l=u.result??[];s(l.slice(0,t))},u.onerror=()=>r(u.error)}))}catch{return[]}},go=async t=>{if(t.length!==0)try{await Qa("readwrite",a=>new Promise((s,r)=>{let i=t.length;t.forEach(u=>{const l=a.get(u);l.onsuccess=()=>{const b=l.result;if(b){b.pending=!1;const m=a.put(b);m.onsuccess=()=>{i-=1,i===0&&s()},m.onerror=()=>r(m.error)}else i-=1,i===0&&s()},l.onerror=()=>r(l.error)})}))}catch{}},Dn=async(t,a)=>{const s=await ho(200);if(s.length===0)return;const r=new Map;s.forEach(i=>{var l;const u=i.personRoleId??a??"";r.has(u)||r.set(u,[]),(l=r.get(u))==null||l.push(i)});for(const[i,u]of r.entries()){const l=u.map(b=>({itemType:b.itemType,itemId:b.itemId,checkType:b.checkType??null,direction:b.direction??null,revisionType:b.revisionType,evalType:b.evalType,correct:b.correct,clientId:b.clientId,clientSequence:b.clientSequence,maskBase64:b.maskBase64??null,payloadHashBase64:b.payloadHashBase64??null,payloadBase64:b.payloadBase64??null,personRoleId:i||null}));try{await Pr({libraryId:t,outcomes:l}),await go(u.map(b=>b.id))}catch{}}},Bt=t=>t.trim().toLowerCase(),Qt=t=>{const a=t==null?void 0:t.trim();return a?{fragmentId:a}:null},hn=(t,a)=>{const s=Qt(a);if(!s)return!0;const r=Qt(t);return(r==null?void 0:r.fragmentId)===s.fragmentId},Lt=t=>{const a=t==null?void 0:t.trim().toLowerCase();return a||null},pr=(t,a)=>{if((Lt(t.childItemType)??"info")!==(a.cardType??"").toLowerCase()||t.childItemId!==a.cardId)return!1;const r=Lt(t.childCheckType),i=Lt(t.childDirection),u=Lt(a.checkType),l=Lt(a.direction);return!(r&&r!==u||i&&i!==l)},mo={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},po={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},gn=(t,a,s)=>{if(!s||!a.startsWith(t))return a;const r=a.slice(t.length);if(!r)return a;const i=s==="super"?mo:po,u=r.split("").map(l=>i[l]??l).join("");return t+u},mn=(t,a,s)=>{var l,b,m;if(!t)return((l=a[0])==null?void 0:l.key)??null;const r=new Set(a.map(x=>x.key)),i=/\{([^}]+)\}/g;let u;for(;(u=i.exec(t))!==null;){const x=((b=u[1])==null?void 0:b.trim())??"";if(!x)continue;if(r.has(x))return x;const d=s==null?void 0:s[x];if(d&&r.has(d))return d}return((m=a[0])==null?void 0:m.key)??null},qa=t=>(()=>{const a=new Set;return t.flatMap(s=>{if(s.cardType!=="info"||s.infoType!=="citation")return[s];const r=s.description??"";if(!r.trim())return[s];const i=va(r),u=Object.keys(i.nodes);return u.length===0?[s]:u.map(l=>({...s,checkType:"quote-fragment",direction:l})).filter(l=>{const b=[l.cardId,l.checkType??"",l.direction??""].join("|");return a.has(b)?!1:(a.add(b),!0)})})})();function Bn({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,libraryId:d,collectionId:p,revisionId:o}){const c=Pa(),j=`/#/cogita/library/${d}`,h=n.useMemo(()=>new URLSearchParams(c.search),[c.search]),k=Math.max(1,Number(h.get("limit")??20)),L=h.get("mode")??"random",v=n.useMemo(()=>os(L),[L]),y=n.useMemo(()=>kn(v,cr(v,h)),[v,h]),Z=h.get("check")??"exact",V=h.get("reviewer"),w=(h.get("scope")??"").trim(),Q=w==="info"||w==="info-selection"?w:"collection",S=Q==="info"?(h.get("infoId")??"").trim():"",te=Q==="info-selection"?(h.get("seed")??"").trim():"",[T,$]=n.useState(null),oe=p??T??void 0,me=Q==="collection"&&!!oe,Se=n.useMemo(()=>t.cogita.library.revision[v.labelKey]??L,[t,L,v]),Je=n.useMemo(()=>Z==="exact"?t.cogita.library.revision.checkValue:Z,[t,Z]),[pe,E]=n.useState(t.cogita.library.collections.defaultName),[D,M]=n.useState([]),[G,O]=n.useState([]),[K,W]=n.useState("idle"),[U,ce]=n.useState({current:0,total:0}),[ve,Me]=n.useState(0),[Ie,He]=n.useState(""),[it,Ce]=n.useState(null),[Ye,kt]=n.useState(null),[Oe,De]=n.useState(null),[rt,gt]=n.useState(null),[tt,Le]=n.useState([]),[Be,at]=n.useState({}),[_,R]=n.useState({}),[z,F]=n.useState(null),[N,C]=n.useState(null),[A,de]=n.useState(null),[xe,ge]=n.useState(null),[ae,P]=n.useState(null),[X,se]=n.useState({}),Y=n.useRef(0),[ee,Re]=n.useState(null),ue=n.useRef(null),fe=n.useRef(null),[ze,et]=n.useState(null),[Qe,Xe]=n.useState(!1),[Ct,St]=n.useState(null),[Mt,Ve]=n.useState([]),[Ee,ht]=n.useState(null),nt=n.useRef(null),mt=n.useRef(null),[zt,Tt]=n.useState(null),[vt,It]=n.useState(0),jt=n.useRef(null),dt=n.useRef({}),[Kt,lt]=n.useState(!1),[We,wt]=n.useState({}),[Gt,qt]=n.useState([]),Vt=n.useRef(new Map),[be,Et]=n.useState(new Set),[Zt,Ut]=n.useState(!1),q=n.useRef(null),g=n.useRef(new Set),re=n.useRef({});n.useEffect(()=>{if(!o||p){$(null);return}as({libraryId:d,revisionId:o}).then(f=>$(f.collectionId)).catch(()=>$(null))},[p,d,o]);const H=D[ve]??null,Ze=(H==null?void 0:H.checkType)==="translation-match"&&ae,ut=n.useRef(new Map),pt=n.useRef(new Map),Rt=n.useRef(new Map),At=n.useRef(new Map),Nt=n.useMemo(()=>H?H.cardType==="vocab"?t.cogita.library.revision.vocabLabel:H.infoType?ot(t,H.infoType):t.cogita.library.revision.infoLabel:"",[t,H]),Pt=n.useMemo(()=>{var I;return v.id!=="levels"?D.length:((I=We.pool)==null?void 0:I.length)??v.getFetchLimit(k,y)},[We,y,v,D.length,k]),ha=v.getProgressTotal?v.getProgressTotal(D,We,k,y):v.id==="levels"?Math.min(k,Pt):D.length,ma=ha?Math.min(ve+1,ha):0,_t=Math.max(1,Number(y.tries??1)),na=y.compare??"anchors",Ta=Math.max(0,Math.min(100,Number(y.minCorrectness??0))),bt=(y.considerDependencies??"on")==="on",Dt=Math.max(0,Math.min(100,Number(y.dependencyThreshold??85))),ea=f=>{const I=f.slice();for(let J=I.length-1;J>0;J-=1){const he=Math.floor(Math.random()*(J+1));[I[J],I[he]]=[I[he],I[J]]}return I},ja=f=>xa(f,{treatSimilarCharsAsSame:!0})>=Ta,Ga=async()=>{const f=await da(),I=new Map,J=new Map,he=new Map;f.forEach(ne=>{const Ne=`${ne.itemType}:${ne.itemId}`,_e=ta(ne.itemType,ne.itemId,ne.checkType,ne.direction);if(I.has(Ne)||I.set(Ne,[]),I.get(Ne).push(ne),J.has(_e)||J.set(_e,[]),J.get(_e).push(ne),ne.itemType==="info"&&ne.checkType==="quote-fragment"&&ne.direction){const qe=`${ne.itemId}:${ne.direction}`;he.has(qe)||he.set(qe,[]),he.get(qe).push(ne)}});const ye=new Map,ie=new Map,je=new Map;return I.forEach((ne,Ne)=>ye.set(Ne,ca(ne).score)),J.forEach((ne,Ne)=>ie.set(Ne,ca(ne).score)),he.forEach((ne,Ne)=>je.set(Ne,ca(ne).score)),{itemKnowness:ye,cardKnowness:ie,fragmentKnowness:je}},Yt=async f=>{const I=[];let J=null;for(;;){const he=await Ja({libraryId:d,collectionId:f,limit:200,cursor:J});if(I.push(...he.items),!he.nextCursor)break;J=he.nextCursor}return qa(I)},Ca=async(f,I)=>{if(Vt.current.has(f))return Vt.current.get(f)??0;const J=await Yt(f);if(J.length===0)return Vt.current.set(f,0),0;const ye=J.reduce((ie,je)=>{const ne=Te(je);return ie+(I.get(ne)??0)},0)/J.length;return Vt.current.set(f,ye),ye},Ia=(f,I)=>{if(!bt||f.cardType!=="info"||f.infoType!=="citation"||f.checkType!=="quote-fragment")return!0;const J=Qt(f.direction);if(!(J!=null&&J.fragmentId))return!0;const he=f.description??"";if(!he.trim())return!0;const ie=va(he).nodes[J.fragmentId];if(!ie||!ie.leftId&&!ie.rightId)return!0;const je=[ie.leftId,ie.rightId].filter(_e=>!!_e);if(je.length===0)return!0;const ne=je.map(_e=>{const qe=ta("info",f.cardId,"quote-fragment",_e);return I.get(qe)??0});return ne.reduce((_e,qe)=>_e+qe,0)/ne.length>=Dt},Fa=async f=>{const I=We,J=f.concat(I.active??[]).concat(I.pool??[]).filter((ne,Ne,_e)=>_e.findIndex(qe=>Te(qe)===Te(ne))===Ne);if(!bt){Et(new Set(J.map(Te)));return}const{itemKnowness:he,cardKnowness:ye}=await Ga(),ie=Gt.filter(ne=>Lt(ne.childItemType)==="collection"&&ne.childItemId===p&&!Lt(ne.childCheckType)&&!Lt(ne.childDirection)),je=new Set;for(const ne of J){if(ne.cardType!=="info"){je.add(Te(ne));continue}if(!Ia(ne,ye))continue;const Ne=Gt.filter(Ue=>pr(Ue,ne)).concat(ie);if(Ne.length===0){je.add(Te(ne));continue}let _e=0;for(const Ue of Ne)if(Lt(Ue.parentItemType)==="collection")_e+=await Ca(Ue.parentItemId,ye);else if(Lt(Ue.parentCheckType)||Lt(Ue.parentDirection)){const st=Lt(Ue.parentCheckType),ct=Lt(Ue.parentDirection),ft=ta(Ue.parentItemType,Ue.parentItemId,st,ct);_e+=ye.get(ft)??0}else{const st=`${Ue.parentItemType}:${Ue.parentItemId}`;_e+=he.get(st)??0}_e/Ne.length>=Dt&&je.add(Te(ne))}Et(je)},Ya=f=>{for(let I=f;I<D.length;I+=1){const J=D[I];if(J&&(!bt||J.cardType!=="info"||be.has(Te(J))))return I}return-1},Ka=f=>!bt||f.cardType!=="info"||be.has(Te(f)),Nn=f=>{if(v.id!=="temporal"&&v.id!=="levels")return null;const I=We,J=(I.active??[]).concat(I.pool??[]),he=new Set;for(const ye of J){const ie=Te(ye);if(!(he.has(ie)||f.has(ie))&&(he.add(ie),Ka(ye)))return ye}return null},Jt=n.useMemo(()=>{if(v.id!=="levels")return null;const f=We,I=f.pool??[],J=f.active??[],he=f.levelMap??{},ye=Math.max(1,Number(y.levels??1)),ie=Array.from({length:ye},()=>0),je=new Set(J.map(qe=>Te(qe)));I.forEach(qe=>{const Ue=Math.min(ye,Math.max(1,he[Te(qe)]??1));ie[Ue-1]+=1});const ne=I.length||1,Ne=ie.map(qe=>qe/ne*100),_e=H?he[Te(H)]??1:null;return{counts:ie,percentages:Ne,currentLevel:_e,levelsCount:ye,activeCount:J.length,poolCount:I.length,activeSet:je}},[We,y,v,H]),Ht=n.useMemo(()=>{if(v.id!=="temporal")return null;const f=We,I=f.pool??[],J=f.active??[],he=f.knownessMap??{},ye=new Set(f.unknownSet??[]);let ie=0;I.forEach(Ne=>{(he[Te(Ne)]??0)>1&&(ie+=1)});const je=ye.size,ne=J.map(Ne=>({id:Te(Ne),value:ye.has(Te(Ne))?0:Math.max(0,Math.min(1,he[Te(Ne)]??0))}));return{knownCount:ie,unknownCount:je,dots:ne}},[We,v]),Sn=n.useMemo(()=>{if(!bt)return 0;const f=We;return D.concat(f.active??[]).concat(f.pool??[]).filter((J,he,ye)=>ye.findIndex(ie=>Te(ie)===Te(J))===he).filter(J=>J.cardType==="info"&&!be.has(Te(J))).length},[bt,We,D,be]);n.useEffect(()=>{if(!bt||K!=="ready")return;const f=We,J=D.concat(f.active??[]).concat(f.pool??[]).filter((ie,je,ne)=>ne.findIndex(Ne=>Te(Ne)===Te(ie))===je).filter(ie=>ie.cardType!=="info"||be.has(Te(ie))).length,he=nt.current;if(nt.current=J,he===null||J<=he)return;const ye=J-he;ht(`New card available (+${ye})`),mt.current&&window.clearTimeout(mt.current),mt.current=window.setTimeout(()=>ht(null),2200)},[bt,K,We,D,be]),n.useEffect(()=>()=>{mt.current&&window.clearTimeout(mt.current)},[]);const Ot=(f,I)=>{const J=v.applyOutcome({queue:D,meta:We},H,k,y,{correct:f,correctness:I,createdUtc:new Date().toISOString()});M(J.queue),wt(J.meta);const he=J.queue[ve+1];he&&ga(he,ve+1)};n.useEffect(()=>{if(me&&oe){xn(d,oe).then(f=>E(f.name)).catch(()=>E(t.cogita.library.collections.defaultName));return}if(Q==="info"&&S){aa({libraryId:d,infoId:S}).then(f=>{const I=f.payload??{};E(I.title||I.label||I.name||S)}).catch(()=>E(S||t.cogita.library.revision.runKicker));return}if(Q==="info-selection"){const f=te?bs(d,te):null,I=(f==null?void 0:f.infoIds.length)??0;E(I>0?`Selected infos (${I})`:"Selected infos");return}E(t.cogita.library.collections.defaultName)},[t,oe,me,d,Q,S,te]),n.useEffect(()=>{es({libraryId:d,type:"language"}).then(f=>O(f)).catch(()=>O([]))},[d]),n.useEffect(()=>{me&&Zn({libraryId:d}).then(f=>qt(f.items??[])).catch(()=>qt([]))},[me,d]),n.useEffect(()=>{Dn(d,V)},[d,V]),n.useEffect(()=>{Fa(D)},[D,Gt,bt,Dt,oe]),n.useEffect(()=>{if(!H||!bt){Ut(!1);return}if(H.cardType!=="info"||be.has(Te(H))){Ut(!1);return}const f=Ya(ve+1);if(f>=0){Ut(!1),Me(f);return}if(v.id==="temporal"||v.id==="levels"){const I=D.slice(0,ve+1),J=D.slice(ve+1).filter(Ka),he=I.concat(J),ye=new Set(he.map(Te)),ie=Nn(ye);if(ie){const ne=Te(ie);ye.has(ne)||(he.push(ie),ye.add(ne),wt(Ne=>{const _e=Ne,qe=new Set(_e.queued??[]);return qe.add(ne),{..._e,queued:qe}}))}const je=he.findIndex((ne,Ne)=>Ne!==ve&&Ka(ne));if(je>=0){M(he),Me(je),Ut(!1);return}}Ut(!0)},[H,be,bt,ve,D,We,v.id]),n.useEffect(()=>{let f=!0;return(async()=>{W("loading"),ce({current:0,total:v.id==="levels"?0:v.getFetchLimit(k,y)});try{if(!me){if(qt([]),Q==="info"){if(!S){f&&(M([]),qt([]),wt({}),Me(0),W("ready"));return}const[Ue,st]=await Promise.all([nn({libraryId:d,infoId:S}),sn({libraryId:d,infoId:S})]);if(!f)return;const ct=qa(Ue.items??[]);qt(st.items??[]);const ft=v.prepare(ct,k,y);M(ft.queue),wt(ft.meta),Me(0),W("ready"),ce({current:ct.length,total:ct.length});return}if(Q==="info-selection"){const Ue=te?bs(d,te):null,st=(Ue==null?void 0:Ue.infoIds)??[];if(!st.length){f&&(M([]),qt([]),wt({}),Me(0),W("ready"));return}const ct=await Promise.all(st.map(async pa=>{const[Wt,Xa]=await Promise.all([nn({libraryId:d,infoId:pa}),sn({libraryId:d,infoId:pa})]);return{cards:Wt.items??[],deps:Xa.items??[]}}));if(!f)return;const ft=new Map;ct.forEach(pa=>{qa(pa.cards).forEach(Wt=>{ft.set(Te(Wt),Wt)})});const yt=Array.from(ft.values()),xt=new Set(yt.map(Te)),Ft=new Map;ct.forEach(pa=>{(pa.deps??[]).forEach(Wt=>{const Xa=ta(Wt.parentItemType,Wt.parentItemId,Lt(Wt.parentCheckType),Lt(Wt.parentDirection)),ls=ta(Wt.childItemType,Wt.childItemId,Lt(Wt.childCheckType),Lt(Wt.childDirection));if(!xt.has(Xa)||!xt.has(ls))return;const cs=`${Xa}->${ls}`;Ft.has(cs)||Ft.set(cs,Wt)})}),qt(Array.from(Ft.values()));const ka=v.prepare(yt,k,y);M(ka.queue),wt(ka.meta),Me(0),W("ready"),ce({current:yt.length,total:yt.length});return}}const J=[];let he=null,ye=null;do{const Ue=await Ja({libraryId:d,collectionId:oe,limit:300,cursor:he});if(J.push(...Ue.items),(v.id==="levels"||v.id==="temporal")&&Ue.total&&(ye=Ue.total),ce(st=>({current:J.length,total:st.total||Ue.total||v.getFetchLimit(k,y)})),he=Ue.nextCursor??null,ye!==null&&J.length>=ye||v.id!=="levels"&&v.id!=="temporal"&&J.length>=v.getFetchLimit(k,y))break}while(he);if(!f)return;const ie=qa(J);let je;if(v.id==="levels"){const Ue=Math.max(1,Number(y.levels??1)),ct=(await da()).reduce((ft,yt)=>{const xt=ta(yt.itemType,yt.itemId,yt.checkType,yt.direction);return ft[xt]||(ft[xt]=[]),ft[xt].push(yt),ft},{});je={},ie.forEach(ft=>{const yt=Te(ft),xt=ct[yt]??[],Ft=xt.length>0?ca(xt).score:0,ka=Math.max(1,Math.min(Ue,Math.ceil(Ft/100*Ue)));je[yt]=ka})}let ne=null,Ne=null,_e=null;if(v.id==="temporal"){const Ue=await da(),st=new Set(ie.map(yt=>Te(yt))),ct=Ue.reduce((yt,xt)=>{const Ft=ta(xt.itemType,xt.itemId,xt.checkType,xt.direction);return st.has(Ft)&&(yt[Ft]||(yt[Ft]=[]),yt[Ft].push(xt)),yt},{});ne={},Ne=new Set,_e={};const ft=Date.now();ie.forEach(yt=>{const xt=Te(yt),Ft=ct[xt]??[];if(Ft.length===0){ne[xt]=0,Ne.add(xt),_e[xt]=[];return}const ka=ss(Ft);_e[xt]=ka;const pa=jn(ka,ft);ne[xt]=pa.knowness})}const qe=v.id==="levels"?is(ie,k,y,je):v.id==="temporal"?rs(ie,k,y,ne??{},Ne??new Set,_e??{}):v.prepare(ie,k,y);M(qe.queue),wt(qe.meta),Me(0),W("ready"),ce(Ue=>({current:Math.min(Ue.current,Ue.total),total:Ue.total}))}catch{f&&W("error")}})(),()=>{f=!1}},[oe,me,d,k,Q,y,v,V,S,te]),n.useEffect(()=>{if(He(""),Ce(null),Tt(null),It(0),Le([]),at({}),R({}),C(null),de(null),ge(null),Xe(!1),lt(!1),et(null),P(null),se({}),!H){kt(null),De(null),F(null),St(null);return}H.cardType==="info"&&H.infoType==="computed"&&kt(t.cogita.library.revision.loadingComputed);let f=!0;return ga(H,ve).then(I=>{!f||!I||(kt(I.prompt),De(I.expectedAnswer),Le(I.computedExpected),at(I.computedAnswers),F(I.computedValues),C(I.answerTemplate),de(I.outputVariables),ge(I.variableValues))}),()=>{f=!1}},[H,t]),n.useEffect(()=>{if(!H||H.cardType!=="info"||H.infoType!=="citation"){q.current=null,g.current=new Set,gt(null);return}const f=H.description??"",I=(H.label??"").trim(),J=I.replace(/\s+/g," ").trim(),he=f.replace(/\s+/g," ").trim(),ye=J&&J!==he?I:t.cogita.library.infoTypes.citation;if(!f){gt(null),De(null);return}const ie=va(f);q.current=ie,kt(ye);let je=!0;return Ga().then(({fragmentKnowness:ne})=>{if(!je)return;const Ne=new Set,_e={};ne.forEach((st,ct)=>{const[ft,yt]=ct.split(":",2);if(ft!==H.cardId)return;const xt=Qt(yt);if(!xt)return;const{fragmentId:Ft}=xt;_e[Ft]=st,st>=Dt&&Ne.add(Ft)}),g.current=Ne,re.current=_e;const qe=Qt(H.direction);if(qe!=null&&qe.fragmentId&&ie.nodes[qe.fragmentId]){B(ie,qe.fragmentId,ye);return}const Ue=Ra(ie,Ne,_e,Dt,bt,H.direction);B(ie,(Ue==null?void 0:Ue.id)??null,ye)}).catch(()=>{g.current=new Set,re.current={};const ne=Qt(H.direction);if(ne!=null&&ne.fragmentId&&ie.nodes[ne.fragmentId]){B(ie,ne.fragmentId,ye);return}const Ne=Ra(ie,g.current,{},Dt,bt,H.direction);B(ie,(Ne==null?void 0:Ne.id)??null,ye)}),()=>{je=!1}},[H,t,bt,Dt]),n.useEffect(()=>{if(!H||H.cardType!=="vocab"||H.checkType!=="translation-match"){P(null),se({});return}const J=(We.pool??We.active??D).filter(ne=>ne.cardType==="vocab"&&ne.checkType==="translation-match").filter((ne,Ne,_e)=>_e.findIndex(qe=>qe.cardId===ne.cardId)===Ne);J.some(ne=>ne.cardId===H.cardId)||J.unshift(H);const ye=ea(J).slice(0,6).map(ne=>{const Ne=ne.label.split("↔").map(Ue=>Ue.trim()).filter(Boolean);if(Ne.length<2)return null;const _e=`${ne.cardId}:L`,qe=`${ne.cardId}:R`;return{cardId:ne.cardId,leftId:_e,rightId:qe,leftLabel:Ne[0],rightLabel:Ne[1]}}).filter(Boolean),ie=ye.map(ne=>ne.leftId),je=ea(ye.map(ne=>ne.rightId));P({pairs:ye,leftOrder:ie,rightOrder:je,selection:{},activeLeft:null,activeRight:null,locked:{}})},[H,D,We]),n.useEffect(()=>()=>{ue.current&&window.clearTimeout(ue.current),fe.current&&window.clearTimeout(fe.current)},[]);const ra=n.useRef(null);n.useEffect(()=>{if(!H)return;const f=Te(H),I=typeof document<"u"?document.activeElement:null;if(ra.current===f&&I&&(I.tagName==="INPUT"||I.tagName==="TEXTAREA"))return;let J=0;const he=()=>{if(H){if(H.cardType==="info"&&H.infoType==="computed"){if(tt.length>0){const ie=mn(N,tt,A),je=ie?dt.current[ie]:null;if(je&&(je.focus(),document.activeElement===je)){ra.current=f;return}}if(jt.current&&(jt.current.focus(),document.activeElement===jt.current)){ra.current=f;return}}else if(H.cardType==="vocab"&&jt.current&&(jt.current.focus(),document.activeElement===jt.current)){ra.current=f;return}J<6&&(J+=1,window.setTimeout(he,40))}},ye=window.setTimeout(he,40);return()=>window.clearTimeout(ye)},[H,tt,N,A]),n.useEffect(()=>{if(!Kt)return;const f=I=>{I.key==="Enter"&&(I.preventDefault(),La())};return window.addEventListener("keydown",f),()=>window.removeEventListener("keydown",f)},[Kt]);const Ma=f=>{Ve(f),St(ca(f))};n.useEffect(()=>{if(!H){St(null),Ve([]);return}const f=H.cardType==="info"?"info":"connection";if(H.cardType==="info"&&H.infoType==="citation"){da().then(I=>{const J=I.filter(he=>he.itemType==="info"&&he.itemId===H.cardId&&he.checkType==="quote-fragment"&&hn(he.direction,H.direction));Ma(J)}).catch(()=>{St(null),Ve([])});return}un(f,H.cardId,H.checkType,H.direction).then(I=>Ma(I)).catch(()=>{St(null),Ve([])})},[d,H,V]);const wa=(f,I,J,he)=>{if(f==="info"&&J==="quote-fragment"){da().then(ye=>{const ie=ye.filter(je=>je.itemType==="info"&&je.itemId===I&&je.checkType==="quote-fragment"&&hn(je.direction,he));Ma(ie)}).catch(()=>{St(null),Ve([])});return}un(f,I,J,he).then(ye=>Ma(ye)).catch(()=>{St(null),Ve([])})},_a=(f,I,J)=>{var je;const he=((je=J.pairs.find(ne=>ne.leftId===f))==null?void 0:je.rightId)??null;if(!he)return J;const ye=he===I;se(ne=>({...ne,[f]:ye?"correct":"incorrect"})),ue.current&&window.clearTimeout(ue.current),fe.current&&window.clearTimeout(fe.current),Y.current+=1;const ie={kind:ye?"correct":"incorrect",tick:Y.current};if(Re(null),ue.current=window.setTimeout(()=>Re(ie),0),fe.current=window.setTimeout(()=>Re(null),420),ye){const ne={...J.locked,[f]:!0};return Object.keys(ne).length>=J.pairs.length?(Ce("correct"),lt(!0)):Ce("correct"),{...J,selection:{...J.selection,[f]:I},activeLeft:null,activeRight:null,locked:ne}}return Ce("incorrect"),{...J,activeLeft:null,activeRight:null}},Tn=f=>{P(I=>!I||I.locked[f]?I:I.activeRight?_a(f,I.activeRight,I):{...I,activeLeft:I.activeLeft===f?null:f})},Cn=f=>{P(I=>I&&(I.activeLeft?_a(I.activeLeft,f,I):{...I,activeRight:I.activeRight===f?null:f}))},La=()=>{var f;if(H&&H.cardType==="info"&&H.infoType==="citation"&&q.current&&rt&&!((f=Qt(H.direction))!=null&&f.fragmentId)){const I=Ra(q.current,g.current,re.current,Dt,bt,H.direction,rt.fragmentId);if(I){Ce(null),He(""),Xe(!1),R({}),lt(!1),Tt(null),It(0),B(q.current,I.id,rt.title);return}}Ce(null),He(""),Xe(!1),R({}),lt(!1),Tt(null),It(0),Me(I=>Math.min(I+1,D.length))},sa=f=>{if(!H)return;const I=f.expected??null,J=f.answer??"";let he=I??"",ye=J;if(!I&&f.expectedMap&&f.answerMap){const Ue=Object.keys(f.expectedMap).sort((st,ct)=>st.localeCompare(ct));he=Ue.map(st=>{var ct;return((ct=f.expectedMap)==null?void 0:ct[st])??""}).join("|"),ye=Ue.map(st=>{var ct;return((ct=f.answerMap)==null?void 0:ct[st])??""}).join("|")}const ie=he?$a(he,ye,na):new Uint8Array,je={revisionType:v.id,evalType:f.evalType,direction:f.direction,prompt:Ye??"",expected:I,answer:J,expectedAnswers:f.expectedMap??null,answers:f.answerMap??null,correct:f.correct,maskBase64:ie.length?ya(ie):null,values:z??null,checkMode:Z,compareMode:na,minCorrectness:Ta},ne=new TextEncoder().encode(JSON.stringify(je)),Ne=H.cardType==="info"?"info":"connection",_e=f.overrideCheckType??H.checkType??null,qe=f.overrideDirection??H.direction??null;dn({itemType:Ne,itemId:H.cardId,checkType:_e,direction:qe,revisionType:v.id,evalType:f.evalType,correct:f.correct,maskBase64:ie.length?ya(ie):null,payloadBase64:ya(ne),personRoleId:V??null}).then(()=>{wa(Ne,H.cardId,_e,qe),Fa(D),Dn(d,V)}).catch(()=>{})},In=(f,I)=>{const J=ut.current.get(I);if(J)return Promise.resolve(J);const he=pt.current.get(I);if(he)return he;const ye=aa({libraryId:d,infoId:f}).then(ie=>{var Ue,st;const je=ie.payload,ne=((Ue=je.definition)==null?void 0:Ue.graph)??null,Ne="",_e=((st=je.definition)==null?void 0:st.answerTemplate)??"",qe=dr(ne,Ne,_e);if(qe){const ft={sample:ur(qe),answerTemplate:_e||null};return ut.current.set(I,ft),ft}return Jn({libraryId:d,infoId:f}).then(ct=>{const ft={sample:ct,answerTemplate:null};return ut.current.set(I,ft),ft})}).catch(()=>Jn({libraryId:d,infoId:f}).then(ie=>{const je={sample:ie,answerTemplate:null};return ut.current.set(I,je),je}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{pt.current.delete(I)});return pt.current.set(I,ye),ye},ga=(f,I)=>{var ne;const J=`${Te(f)}:${I}`,he=Rt.current.get(J);if(he)return Promise.resolve(he);const ye=At.current.get(J);if(ye)return ye;const ie=Ne=>(Rt.current.set(J,Ne),Ne);let je;if(f.cardType==="vocab"){if(f.checkType==="translation-match")return je=Promise.resolve(ie({prompt:f.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),je;const Ne=f.label.split("↔").map(_e=>_e.trim()).filter(Boolean);if(Ne.length>=2){const qe=(f.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",Ue=qe?Ne[0]:Ne[1],st=qe?Ne[1]:Ne[0];je=Promise.resolve(ie({prompt:Ue,expectedAnswer:st,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else je=Promise.resolve(ie({prompt:f.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(f.cardType==="info"&&f.infoType==="word"){const Ne=(ne=f.description)!=null&&ne.startsWith("Language: ")?f.description.replace("Language: ",""):null;je=Promise.resolve(ie({prompt:f.label,expectedAnswer:Ne,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else f.cardType==="info"&&f.infoType==="question"?je=aa({libraryId:d,infoId:f.cardId}).then(Ne=>{const _e=Ne.payload??{},qe=_e.definition??_e??{},Ue=typeof qe.type=="string"?qe.type:"",st=(typeof qe.question=="string"&&qe.question.trim()?qe.question.trim():null)??(typeof qe.title=="string"&&qe.title.trim()?qe.title.trim():null)??f.label,ct=qe.answer;return ie(Ue==="text"||Ue==="number"||Ue==="date"?{prompt:st,expectedAnswer:typeof ct=="string"||typeof ct=="number"?String(ct):null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}:{prompt:st,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})}).catch(()=>ie({prompt:f.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{At.current.delete(J)}):f.cardType==="info"&&f.infoType==="computed"?je=In(f.cardId,J).then(Ne=>{var ct,ft;if(!Ne.sample)return ie({prompt:f.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const _e=Ne.sample,qe=_e.expectedAnswers?Object.entries(_e.expectedAnswers).map(([yt,xt])=>({key:yt,expected:xt})):[],Ue=qe.reduce((yt,xt)=>(yt[xt.key]="",yt),{}),st=_e.expectedAnswerIsSentence&&((ct=_e.expectedAnswer)==null?void 0:ct.trim())||null;return ie({prompt:_e.prompt,expectedAnswer:qe.length>0?st:((ft=_e.expectedAnswer)==null?void 0:ft.trim())||null,computedExpected:qe,computedAnswers:Ue,computedValues:_e.values??null,answerTemplate:Ne.answerTemplate,outputVariables:_e.outputVariables??null,variableValues:_e.variableValues??null})}).catch(()=>ie({prompt:f.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{At.current.delete(J)}):je=Promise.resolve(ie({prompt:f.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return At.current.set(J,je),je},B=(f,I,J)=>{const he=Object.keys(f.nodes).length,ye=g.current.size;if(!I){gt({title:J,before:f.text,after:"",fragmentId:null,total:he,completed:ye}),De(null),lt(!0);return}const ie=f.nodes[I];if(!ie)return;const je=vn(f.text,ie);gt({title:J,before:je.before,after:je.after,fragmentId:ie.id,total:he,completed:ye}),De(je.fragment),lt(!1)},le=()=>{const f=q.current;f&&gt(I=>I&&{...I,total:Object.keys(f.nodes).length,completed:g.current.size})},we=()=>{const f=D[ve+1];f&&ga(f,ve+1)},Fe=()=>{if(we(),H&&H.cardType==="vocab"&&H.checkType==="translation-match"&&ae){if(ae.pairs.length===0){Ce("incorrect"),lt(!0);return}const ie=ae.pairs.reduce((st,ct)=>(st[ct.rightId]=ct.rightLabel,st),{});let je=0;const ne={};ae.pairs.forEach(st=>{const ft=ae.selection[st.leftId]===st.rightId;ne[st.leftId]=ft?"correct":"incorrect",ft&&(je+=1)});const Ne=ae.pairs.length||1,_e=je/Ne,qe=je===ae.pairs.length;se(st=>({...st,...ne})),qe?(Ce("correct"),lt(!0),It(0)):(Ce("incorrect"),lt(!1),It(st=>{const ct=st+1;return ct>=_t&&(Xe(!0),lt(!0),P(ft=>{if(!ft)return ft;const yt=ft.pairs.reduce((xt,Ft)=>(xt[Ft.leftId]=Ft.rightId,xt),{});return{...ft,selection:yt}})),ct})),Ot(qe,_e);const Ue="connection";Promise.all(ae.pairs.map(st=>{const ct=ae.selection[st.leftId]??null,ft=ct?ie[ct]:"",yt={left:st.leftLabel,expected:st.rightLabel,answer:ft,checkType:"translation-match"},xt=new TextEncoder().encode(JSON.stringify(yt));return dn({itemType:Ue,itemId:st.cardId,checkType:"translation-match",direction:null,revisionType:v.id,evalType:"translation-match",correct:ct===st.rightId,maskBase64:null,payloadBase64:ya(xt),personRoleId:V??null})})).then(()=>{wa(Ue,H.cardId,H.checkType,H.direction),Dn(d,V)}).catch(()=>{});return}if(tt.length>0){const ie=tt.reduce((ne,Ne)=>{const _e=Be[Ne.key]??"";return ne[Ne.key]=Bt(_e)===Bt(Ne.expected)?"correct":"incorrect",ne},{});tt.every(({key:ne,expected:Ne})=>{const _e=Be[ne]??"";return Z==="exact"&&Bt(_e)===Bt(Ne)})?(Ce("correct"),R(ie),lt(!0),It(0),Ot(!0,1),sa({correct:!0,direction:Ye?`${Ye} -> computed`:"computed",expectedMap:tt.reduce((ne,Ne)=>(ne[Ne.key]=Ne.expected,ne),{}),answerMap:Be,evalType:"computed"})):(Ce("incorrect"),R(ie),lt(!1),It(ne=>{const Ne=ne+1;return Ne>=_t&&Ge&&(Xe(!0),lt(!0)),Ne}),Ot(!1,0),window.setTimeout(()=>{var Ne;const ne=mn(N,tt,A);ne&&dt.current[ne]&&((Ne=dt.current[ne])==null||Ne.focus())},40),sa({correct:!1,direction:Ye?`${Ye} -> computed`:"computed",expectedMap:tt.reduce((ne,Ne)=>(ne[Ne.key]=Ne.expected,ne),{}),answerMap:Be,evalType:"computed"}));return}if(H&&H.cardType==="info"&&H.infoType==="citation"&&(rt!=null&&rt.fragmentId)){if(!Oe)return;const ie=Qt(H.direction),je=(ie==null?void 0:ie.fragmentId)??rt.fragmentId,ne=Sa(Oe,Ie,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Ne=ne.mask,_e=ne.isCorrect,qe=ne.percent;_e?(re.current[rt.fragmentId]=Math.max(re.current[rt.fragmentId]??0,qe),(re.current[rt.fragmentId]??0)>=Dt&&g.current.add(rt.fragmentId),le(),Ce("correct"),R({}),lt(!0),Tt(Ne),It(0),qe<100&&_t<=1&&Xe(!0),Ot(!0,qe/100),sa({correct:!0,direction:`quote:${rt.fragmentId}`,expected:Oe,answer:Ie,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:je})):(Ce("incorrect"),R({}),lt(!1),Tt(Ne),It(Ue=>{const st=Ue+1;return st>=_t&&Ge&&(Xe(!0),lt(!0)),st}),Ot(!1,qe/100),window.setTimeout(()=>{var Ue;return(Ue=jt.current)==null?void 0:Ue.focus()},40),sa({correct:!1,direction:`quote:${rt.fragmentId}`,expected:Oe,answer:Ie,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:je}));return}if(!Oe)return;const f=$a(Oe,Ie,na),I=Z==="exact"&&Bt(Ie)===Bt(Oe),J=ja(f),he=I||J,ye=xa(f);he?(Ce("correct"),R({}),lt(!0),Tt(f),It(0),ye<100&&_t<=1&&Xe(!0),Ot(!0,ye/100),sa({correct:!0,direction:Ye?`${Ye} -> ${Oe}`:null,expected:Oe,answer:Ie,evalType:"text"})):(Ce("incorrect"),R({}),lt(!1),Tt(f),It(ie=>{const je=ie+1;return je>=_t&&Ge&&(Xe(!0),lt(!0)),je}),Ot(!1,ye/100),window.setTimeout(()=>{var ie;return(ie=jt.current)==null?void 0:ie.focus()},40),sa({correct:!1,direction:Ye?`${Ye} -> ${Oe}`:null,expected:Oe,answer:Ie,evalType:"text"}))},Ke=f=>{if(we(),!Oe)return;const I=$a(Oe,f,na),J=Bt(f)===Bt(Oe),he=ja(I),ye=J||he,ie=xa(I);ye?(Ce("correct"),R({}),lt(!0),Tt(I),It(0),ie<100&&_t<=1&&Xe(!0),Ot(!0,ie/100),sa({correct:!0,direction:"word->language",expected:Oe,answer:f,evalType:"language-select"})):(Ce("incorrect"),R({}),lt(!1),Tt(I),It(je=>{const ne=je+1;return ne>=_t&&Ge&&(Xe(!0),lt(!0)),ne}),Ot(!1,ie/100),sa({correct:!1,direction:"word->language",expected:Oe,answer:f,evalType:"language-select"}))},ke=()=>{we(),Ce("correct"),lt(!0),It(0),Ot(!0,1),Oe&&sa({correct:!0,direction:"manual",expected:Oe,answer:Ie,evalType:"manual"})},Pe=()=>{if(Ot(!1,0),H&&H.cardType==="info"&&H.infoType==="citation"){Ce(null),He(""),Xe(!1),R({}),lt(!1),Tt(null),It(0),Me(f=>Math.min(f+1,D.length));return}La()};n.useEffect(()=>{we()},[ve,D]);const Ae=f=>{var J;if(f.key!=="Enter")return;if(f.preventDefault(),f.stopPropagation(),Kt){La();return}const I=tt.find(he=>!(Be[he.key]??"").trim());if(I){(J=dt.current[I.key])==null||J.focus();return}Fe()},$e=t.cogita.library.revision.revealModeAfterIncorrect,Ge=tt.length>0||!!Oe;return e.jsxs($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,children:[K==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${U.total?Math.min(100,Math.max(0,U.current/U.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:U.total?`${Math.min(U.current,U.total)} / ${U.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:pe}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",Se).replace("{check}",Je)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:j,children:t.cogita.library.actions.libraryOverview}),me?e.jsxs(e.Fragment,{children:[e.jsx("a",{className:"cta ghost",href:`${j}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${j}/collections/${oe}`,children:t.cogita.library.actions.collectionDetail})]}):e.jsx("a",{className:"cta ghost",href:`${j}/list`,children:t.cogita.library.actions.allCards})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Ct?`${Ct.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Jt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Jt.currentLevel??"-"," / ",Jt.levelsCount]}):null,Ct?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(Ct.correct)).replace("{total}",String(Ct.total))}),Ct.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(Ct.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(hr,{outcomes:Mt})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[Ee?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:Ee})}):null,e.jsx(Ea,{feedbackToken:ee?`${ee.kind}-${ee.tick}`:Ze?"idle":it?`${it}-${ve}-${vt}`:"idle",children:H?e.jsx(e.Fragment,{children:Zt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(ns,{copy:t,currentCard:H,currentTypeLabel:Nt,prompt:Ye,languages:G,answer:Ie,onAnswerChange:f=>He(I=>gn(I,f,ze)),computedExpected:tt,computedAnswers:Be,onComputedAnswerChange:(f,I)=>at(J=>({...J,[f]:gn(J[f]??"",I,ze)})),answerTemplate:N,outputVariables:A,variableValues:xe,computedFieldFeedback:_,feedback:it,canAdvance:Kt,quoteContext:rt,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Fe,onSkip:Pe,onLanguageSelect:Ke,onMarkReviewed:ke,onAdvance:La,showCorrectAnswer:Qe,setShowCorrectAnswer:Xe,onRevealCorrect:()=>lt(!0),answerMask:zt,expectedAnswer:Oe,hasExpectedAnswer:Ge,handleComputedKeyDown:Ae,answerInputRef:jt,computedInputRefs:dt,scriptMode:ze,setScriptMode:et,matchPairs:ae==null?void 0:ae.pairs,matchLeftOrder:ae==null?void 0:ae.leftOrder,matchRightOrder:ae==null?void 0:ae.rightOrder,matchSelection:ae==null?void 0:ae.selection,matchActiveLeft:ae==null?void 0:ae.activeLeft,matchActiveRight:ae==null?void 0:ae.activeRight,matchFeedback:X,onMatchLeftSelect:Tn,onMatchRightSelect:Cn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:me?`${j}/collections/${oe}`:`${j}/list`,children:me?t.cogita.library.actions.collectionDetail:t.cogita.library.actions.allCards})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:ha?`${ma} / ${ha}`:t.cogita.library.revision.progressUnlimited}),K==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),K==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),K==="ready"&&D.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:$e}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",_t]})]})]}),Jt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Jt.activeCount," / ",Jt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Jt.counts.map((f,I)=>{const J=I+1,he=Jt.currentLevel===J,ye=Jt.percentages[I]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":he,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:J}),e.jsx("strong",{children:f})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,ye))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[ye.toFixed(1),"%"]})]},`level-${J}`)})})]}):null,Ht?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:Ht.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:Ht.dots.map(f=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,f.value*100))}%`,background:`rgba(${Math.round(255*(1-f.value))}, ${Math.round(200*f.value)}, 80, 0.9)`}},f.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:Ht.knownCount})]})]}):null,bt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Sn})]})}):null]})]})]})})})]})]})}const zn=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],fo={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},bo=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],yo=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function xo({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,libraryId:d,collectionId:p}){const[o,c]=n.useState(""),[j,h,k]=Qn([]),[L,v,y]=Gn([]),[Z,V]=n.useState(null),[w,Q]=n.useState(null),[S,te]=n.useState(null),T=`/#/cogita/library/${d}`;n.useEffect(()=>{xn(d,p).then(E=>c(E.name)).catch(()=>c(t.cogita.library.collections.defaultName))},[d,p,t]),n.useEffect(()=>{Er({libraryId:d,collectionId:p}).then(E=>{if(!E.graphId||E.graphId==="00000000-0000-0000-0000-000000000000"){h([]),v([]);return}const D=E.nodes.map(G=>{var U;const O=G.payload??{},K=O.position??{x:120,y:120},W=O.params??{};return{id:G.nodeId,type:"default",position:K,data:{nodeType:G.nodeType,label:((U=zn.find(ce=>ce.type===G.nodeType))==null?void 0:U.label)??G.nodeType,params:W}}}),M=E.edges.map(G=>({id:G.edgeId,source:G.fromNodeId,target:G.toNodeId,sourceHandle:G.fromPort??void 0,targetHandle:G.toPort??void 0}));h(D),v(M)}).catch(()=>{h([]),v([])})},[d,p,v,h]);const $=n.useMemo(()=>j.find(E=>E.id===Z)??null,[j,Z]),oe=E=>{var O;const D=crypto.randomUUID(),M=((O=zn.find(K=>K.type===E))==null?void 0:O.label)??E,G={...fo[E]};h(K=>[...K,{id:D,type:"default",position:{x:120+K.length*40,y:120+K.length*40},data:{nodeType:E,label:M,params:G}}]),V(D)},me=n.useCallback(E=>{v(D=>Yn({...E,id:crypto.randomUUID()},D))},[v]),Se=async()=>{Q(null);try{await er({libraryId:d,collectionId:p,nodes:j.map(E=>({nodeId:E.id,nodeType:E.data.nodeType,payload:{position:E.position,params:E.data.params}})),edges:L.map(E=>({edgeId:E.id,fromNodeId:E.source,fromPort:E.sourceHandle??null,toNodeId:E.target,toPort:E.targetHandle??null}))}),Q(t.cogita.library.graph.saveSuccess)}catch{Q(t.cogita.library.graph.saveFail)}},Je=async()=>{try{const E=await Fr({libraryId:d,collectionId:p});te(E)}catch{te(null)}},pe=E=>{$&&h(D=>D.map(M=>M.id===$.id?{...M,data:{...M.data,params:E}}:M))};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:o}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${T}/collections/${p}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Je,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:Se,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:zn.map(E=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>oe(E.type),children:E.label},E.type))}),w?e.jsx("p",{className:"cogita-help",children:w}):null,S&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(S.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(S.connections)).replace("{infos}",String(S.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(fn,{nodes:j,edges:L,onNodesChange:k,onEdgesChange:y,onConnect:me,onNodeClick:(E,D)=>V(D.id),fitView:!0,children:[e.jsx(bn,{color:"rgba(120,160,200,0.2)"}),e.jsx(yn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),$?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:$.data.label}),$.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Xt,{libraryId:d,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:$.data.params.tagId?{id:$.data.params.tagId,label:$.data.params.tagLabel??"",infoType:"topic"}:null,onChange:E=>pe({...$.data.params,tagId:(E==null?void 0:E.id)??null,tagLabel:(E==null?void 0:E.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:$.data.params.scope??"any",onChange:E=>pe({...$.data.params,scope:E.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),$.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Xt,{libraryId:d,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:$.data.params.languageId?{id:$.data.params.languageId,label:$.data.params.languageLabel??"",infoType:"language"}:null,onChange:E=>pe({...$.data.params,languageId:(E==null?void 0:E.id)??null,languageLabel:(E==null?void 0:E.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:$.data.params.scope??"any",onChange:E=>pe({...$.data.params,scope:E.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),$.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:$.data.params.infoType??"word",onChange:E=>pe({...$.data.params,infoType:E.target.value}),children:yo.map(E=>e.jsx("option",{value:E.value,children:E.label},E.value))})]}),e.jsx(Xt,{libraryId:d,infoType:$.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:$.data.params.infoId?{id:$.data.params.infoId,label:$.data.params.infoLabel??"",infoType:$.data.params.infoType??"word"}:null,onChange:E=>pe({...$.data.params,infoId:(E==null?void 0:E.id)??null,infoLabel:(E==null?void 0:E.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),$.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:$.data.params.connectionType??"translation",onChange:E=>pe({...$.data.params,connectionType:E.target.value}),children:bo.map(E=>e.jsx("option",{value:E.value,children:E.label},E.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:$.data.params.connectionId??"",onChange:E=>pe({...$.data.params,connectionId:E.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes($.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const Vn="cogita.preferences",On="cogita.reviewer.preferences",fr=["library_overview","all_cards","all_collections","all_revisions","storyboards","texts","dependencies","transfer"],qn={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},all_revisions:{requiresCollection:!1,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},vo=["settings","run","shared"],Aa=30,zs=42;function fa(t,a){const s=(t??"").trim();return s.length<=a?s:a<=1?s.slice(0,a):`${s.slice(0,Math.max(1,a-1)).trimEnd()}…`}function jo(t,a=""){const s=t.split("/").filter(Boolean);if(s[0]!=="cogita"||s[1]!=="library")return{};const r=s[2];if(!r)return{};if(!s[3])return{libraryId:r,target:"library_overview"};const i=new URLSearchParams(a),u=i.get("revisionId")??void 0,l=i.get("infoId")??void 0,b=i.get("infoView"),m=b==="cards"?"cards":b==="collections"?"collections":"overview",x=i.get("collectionView")==="overview"?"overview":"infos",d=i.get("collectionAction"),p=i.get("libraryAction"),c=i.get("libraryTarget")==="revisions"?"all_revisions":"all_collections";if(s[3]==="list")return{libraryId:r,target:p==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:u,infoId:l,infoView:m,libraryAction:p==="new-info"?"new-info":void 0};if(s[3]==="detail"||s[3]==="collection")return{libraryId:r,target:"all_cards",cardMode:s[3],revisionId:u,infoId:l,infoView:m};if(s[3]==="new"||s[3]==="add")return{libraryId:r,target:"new_card",revisionId:u,libraryAction:"new-info"};if(s[3]==="edit")return{libraryId:r,target:"new_card",revisionId:u,infoId:s[4]};if(s[3]==="infos"){const h=s[4];return h?s[5]==="checkcards"?{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u,infoId:h,infoView:"cards"}:s[5]==="collections"?{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u,infoId:h,infoView:"collections"}:{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u,infoId:h,infoView:"overview"}:{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u}}if(s[3]==="shared-revisions")return{libraryId:r,target:c,revisionId:u};if(s[3]==="revisions"){const h=s[4];return h?h==="shared-links"?{libraryId:r,target:"all_revisions",revisionView:"shared"}:h==="new"?{libraryId:r,target:"all_revisions",revisionView:"new"}:s[5]==="run"?{libraryId:r,target:"all_revisions",revisionId:h,revisionView:"run"}:s[5]==="shared"?{libraryId:r,target:"all_revisions",revisionId:h,revisionView:"shared"}:{libraryId:r,target:"all_revisions",revisionId:h,revisionView:"settings"}:{libraryId:r,target:"all_revisions"}}if(s[3]==="revision"&&s[4]==="run")return{libraryId:r,target:c,revisionView:"run",revisionId:u,infoId:l,infoView:m};if(s[3]==="dependencies")return{libraryId:r,target:"dependencies"};if(s[3]==="transfer")return{libraryId:r,target:"transfer"};if(s[3]==="storyboards")return s[4]==="new"?{libraryId:r,target:"new_storyboard"}:{libraryId:r,target:"storyboards"};if(s[3]==="texts")return s[4]==="new"?{libraryId:r,target:"new_text"}:{libraryId:r,target:"texts"};if(s[3]!=="collections")return{libraryId:r,target:"library_overview"};if(s[4]==="new")return{libraryId:r,target:"new_collection",revisionId:u};const j=s[4];return j?s[5]==="graph"?{libraryId:r,target:c,collectionId:j,revisionId:u,revisionView:"graph"}:s[5]==="shared-revisions"?{libraryId:r,target:c,collectionId:j,revisionId:u,revisionView:"shared"}:s[5]==="revision"?{libraryId:r,target:c,collectionId:j,revisionId:u,revisionView:s[6]==="run"?"run":"settings",collectionView:x}:d==="new-revision"?{libraryId:r,target:c,collectionId:j,revisionId:u,revisionView:"new"}:{libraryId:r,target:c,collectionId:j,revisionId:u,revisionView:"detail",collectionView:x}:d==="new-collection"?{libraryId:r,target:"new_collection",collectionAction:"new-collection"}:{libraryId:r,target:c}}function Vs(t,a="library_overview",s,r,i,u,l="overview",b="infos"){const m=(x,d)=>{const p=new URLSearchParams;d!=null&&d.revisionId&&p.set("revisionId",d.revisionId),d!=null&&d.collectionAction&&p.set("collectionAction",d.collectionAction),d!=null&&d.libraryAction&&p.set("libraryAction",d.libraryAction),d!=null&&d.libraryTarget&&p.set("libraryTarget",d.libraryTarget),d!=null&&d.infoId&&p.set("infoId",d.infoId),d!=null&&d.infoView&&(d!=null&&d.infoId)&&p.set("infoView",d.infoView),d!=null&&d.collectionView&&d.collectionView!=="infos"&&p.set("collectionView",d.collectionView);const o=p.toString();return o?`${x}?${o}`:x};if(!t)return"/cogita";if(a==="library_overview")return m(`/cogita/library/${t}`,{revisionId:i});if(a==="all_cards")return u?l==="cards"?m(`/cogita/library/${t}/infos/${u}/checkcards`,{revisionId:i}):l==="collections"?m(`/cogita/library/${t}/infos/${u}/collections`,{revisionId:i}):m(`/cogita/library/${t}/infos/${u}`,{revisionId:i}):m(`/cogita/library/${t}/list`,{revisionId:i,infoId:u,infoView:l});if(a==="new_card")return u?m(`/cogita/library/${t}/edit/${u}`,{revisionId:i}):m(`/cogita/library/${t}/list`,{revisionId:i,libraryAction:"new-info"});if(a==="all_collections"||a==="all_revisions"){const x=a==="all_revisions"?"revisions":void 0;return a==="all_revisions"&&i?r==="run"?m(`/cogita/library/${t}/revisions/${i}/run`,{revisionId:i}):r==="shared"?m(`/cogita/library/${t}/revisions/${i}/shared`,{revisionId:i}):m(`/cogita/library/${t}/revisions/${i}`,{revisionId:i}):a==="all_revisions"&&r==="new"?m(`/cogita/library/${t}/revisions/new`,{revisionId:i}):a==="all_revisions"?r==="shared"?m(`/cogita/library/${t}/revisions/shared-links`,{revisionId:i}):r==="run"?m(`/cogita/library/${t}/revision/run`,{revisionId:i,libraryTarget:x}):m(`/cogita/library/${t}/revisions`,{revisionId:i}):!s&&r==="run"?m(`/cogita/library/${t}/revision/run`,{revisionId:i,libraryTarget:x}):s?r==="graph"?m(`/cogita/library/${t}/collections/${s}/graph`,{revisionId:i,libraryTarget:x}):r==="settings"?m(`/cogita/library/${t}/collections/${s}/revision`,{revisionId:i,libraryTarget:x}):r==="run"?m(`/cogita/library/${t}/collections/${s}/revision/run`,{revisionId:i,libraryTarget:x}):r==="shared"?m(`/cogita/library/${t}/collections/${s}/shared-revisions`,{revisionId:i,libraryTarget:x}):r==="new"?m(`/cogita/library/${t}/collections/${s}`,{revisionId:i,libraryTarget:x,collectionAction:"new-revision"}):m(`/cogita/library/${t}/collections/${s}`,{revisionId:i,libraryTarget:x,collectionView:b}):m(`/cogita/library/${t}/collections`,{revisionId:i,libraryTarget:x})}return a==="new_collection"?m(`/cogita/library/${t}/collections`,{revisionId:i,collectionAction:"new-collection"}):a==="transfer"?m(`/cogita/library/${t}/transfer`,{revisionId:i}):a==="storyboards"?m(`/cogita/library/${t}/storyboards`,{revisionId:i}):a==="new_storyboard"?m(`/cogita/library/${t}/storyboards/new`,{revisionId:i}):a==="texts"?m(`/cogita/library/${t}/texts`,{revisionId:i}):a==="new_text"?m(`/cogita/library/${t}/texts/new`,{revisionId:i}):a==="dependencies"?m(`/cogita/library/${t}/dependencies`,{revisionId:i}):m(`/cogita/library/${t}`,{revisionId:i})}function ba(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function wo(t){return typeof t=="string"&&fr.includes(t)}function ko(t,a){var b;if(!t.length)return null;const s=t.filter(m=>a.has(m.roleId)),r=s.length>0?s:t,i=r.map(m=>{var d,p;const x=((p=(d=m.fields.find(o=>o.fieldType==="role_kind"))==null?void 0:d.plainValue)==null?void 0:p.toLowerCase())??"";return{roleId:m.roleId,roleKind:x}}),u=i.find(m=>m.roleKind.includes("master"));if(u)return u.roleId;const l=i.find(m=>m.roleKind.includes("account")||m.roleKind.includes("user"));return l?l.roleId:((b=r[0])==null?void 0:b.roleId)??null}function No(t){if(!t)return{version:1,byLibrary:{}};try{const a=JSON.parse(t);return!a||typeof a!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:a.lastLibraryId,byLibrary:a.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function So({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x}){const d=Wa(),p=Pa(),o=n.useMemo(()=>jo(p.pathname,p.search),[p.pathname,p.search]),c=t.cogita.workspace,[j,h]=n.useState([]),[k,L]=n.useState([]),[v,y]=n.useState([]),[Z,V]=n.useState([]),[w,Q]=n.useState(void 0),[S,te]=n.useState("library_overview"),[T,$]=n.useState(void 0),[oe,me]=n.useState(void 0),[Se,Je]=n.useState("detail"),[pe,E]=n.useState(void 0),[D,M]=n.useState(!1),[G,O]=n.useState(!0),[K,W]=n.useState(!1),[U,ce]=n.useState(!1),[ve,Me]=n.useState(null),[Ie,He]=n.useState(0),[it,Ce]=n.useState(""),[Ye,kt]=n.useState(""),[Oe,De]=n.useState(""),[rt,gt]=n.useState([]),[tt,Le]=n.useState(""),[Be,at]=n.useState(0),[_,R]=n.useState(null),[z,F]=n.useState(null),N=n.useRef({version:1,byLibrary:{}}),C=n.useRef(!1),A=n.useRef(!1),de=n.useRef(null),xe=n.useMemo(()=>j.find(g=>g.libraryId===w)??null,[j,w]),ge=n.useMemo(()=>k.find(g=>g.collectionId===T)??null,[k,T]),ae=ba(p.pathname)==="/cogita/persons";n.useEffect(()=>{if(!w){gt([]),Le("");return}let g=!1;return tr({libraryId:w}).then(re=>{if(g)return;const H=re.filter(Ze=>(Ze.roleKind??"").trim().toLowerCase()==="person");gt(H);try{const Ze=window.localStorage.getItem(On),pt=(Ze?JSON.parse(Ze):{})[w]??"",Rt=pt&&H.some(At=>At.roleId===pt)?pt:"";Le(Rt)}catch{Le("")}}).catch(()=>{g||(gt([]),Le(""))}),()=>{g=!0}},[w,Be]),n.useEffect(()=>{if(w)try{const g=window.localStorage.getItem(On),re=g?JSON.parse(g):{};tt?re[w]=tt:delete re[w],window.localStorage.setItem(On,JSON.stringify(re))}catch{}},[w,tt]);const P=n.useMemo(()=>Z.find(g=>g.revisionId===oe)??null,[Z,oe]),X=n.useMemo(()=>({detail:c.revisions.detail,graph:c.revisions.graph,settings:c.revisions.settings,run:c.revisions.run,shared:c.targets.sharedRevisions,new:c.revisionForm.createAction}),[c.revisions.detail,c.revisions.graph,c.revisions.run,c.revisions.settings,c.targets.sharedRevisions,c.revisionForm.createAction]),se=n.useMemo(()=>S==="new_card"?"all_cards":S==="new_collection"?"all_collections":S==="new_storyboard"?"storyboards":S==="new_text"?"texts":S,[S]),Y=n.useMemo(()=>Se==="new"?"settings":Se,[Se]),ee=S==="all_collections"||S==="all_revisions",Re=n.useMemo(()=>S==="new_collection"?"create":S==="all_collections"&&T?"selected":"search",[T,S]),ue=n.useMemo(()=>o.infoId?"selected":S==="new_card"?"create":"search",[o.infoId,S]),fe=n.useMemo(()=>v.find(g=>g.infoId===o.infoId)??null,[v,o.infoId]),ze=n.useMemo(()=>({library_overview:c.targets.libraryOverview,all_cards:c.targets.allCards,new_card:c.targets.newCard,all_collections:c.targets.allCollections,all_revisions:c.targets.allRevisions,new_collection:c.targets.newCollection,transfer:c.targets.transfer,storyboards:c.targets.storyboards,new_storyboard:c.targets.newStoryboard,texts:c.targets.texts,new_text:c.targets.newText,dependencies:c.targets.dependencies}),[c.targets]),et=n.useMemo(()=>ze[se]??se,[se,ze]),Qe=X[Y],Xe=!!w,Ct=n.useMemo(()=>{const g=m==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":m==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return m==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:g},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:g},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:g},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:g},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:g},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:g},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:g},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:g},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:g},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:g},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:g},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:g},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:g},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:m==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:g},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:g},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:g},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:g},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:g},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:g},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:g},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:g},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:g},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:g},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:g},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:g},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:g},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:g},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:g},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:g},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:g},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:g},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:g},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:g},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:g},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:g},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:g},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:g},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:g},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:g},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[m]),St=Ct.length,Mt=Math.max(0,Math.min(Ie,St-1)),Ve=Ct[Mt],Ee=!!T,ht=Xe&&S==="all_collections",nt=Ee&&S==="all_collections",mt=Xe&&(S==="all_revisions"||Ee&&S==="all_collections")&&(Y==="settings"||Y==="run"||Y==="shared"||S==="all_revisions"),zt=mt,Tt=mt&&!!oe,vt=n.useCallback(g=>{const re=!!g.libraryId;let H=g.target,Ze=g.collectionId,ut=g.revisionId,pt=g.revisionView,Rt=g.infoId,At=g.infoView??o.infoView??"overview",Nt=g.collectionView??o.collectionView??"infos";re?qn[H].requiresCollection&&!Ze?(H=H==="all_revisions"?"all_revisions":"all_collections",ut=void 0,pt="detail"):H!=="all_collections"&&H!=="all_revisions"?(Ze=void 0,ut=void 0,H!=="new_card"&&H!=="all_cards"&&(Rt=void 0,At="overview"),H!=="new_collection"&&(Nt="infos")):qn[H].allowsRevision?vo.includes(pt)||(ut=void 0):pt="detail":(H="library_overview",Ze=void 0,ut=void 0,pt="detail",Rt=void 0,At="overview",Nt="infos"),Q(g.libraryId),te(H),$(Ze),me(ut),Je(pt),M(!1);const Pt=ba(Vs(g.libraryId,H,Ze,pt,ut,Rt,At,Nt));ba(`${p.pathname}${p.search}`)!==Pt&&(de.current=Pt,d(Pt))},[p.pathname,p.search,d,o.collectionView,o.infoView]),It=n.useMemo(()=>[{key:"library",label:c.layers.library,visible:!0,value:w??"",selectedLabel:(xe==null?void 0:xe.name)??c.path.noLibrarySelected,disabled:G||j.length===0,options:j.map(g=>({value:g.libraryId,label:g.name})),emptyOption:c.noLibraryOption,onSelect:g=>{const re=g||void 0;vt({libraryId:re,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:c.layers.target,visible:Xe,value:se,selectedLabel:et,disabled:!Xe,options:fr.map(g=>({value:g,label:ze[g]})),onSelect:g=>{const re=g;vt({libraryId:w,target:re,collectionId:T,revisionId:oe,revisionView:Se,infoId:re==="new_card"?o.infoId:void 0})}},{key:"info_mode",label:c.layers.target,visible:se==="all_cards",value:ue,selectedLabel:ue==="create"?c.infoMode.create:ue==="selected"?(fe==null?void 0:fe.label)??pe??t.cogita.library.list.selectedEmpty:c.infoMode.search,disabled:!Xe,options:[{value:"search",label:c.infoMode.search},{value:"create",label:c.infoMode.create},...o.infoId?[{value:"selected",label:(fe==null?void 0:fe.label)??pe??t.cogita.library.list.selectedEmpty}]:[]],onSelect:g=>{if(g==="selected"){if(!o.infoId)return;vt({libraryId:w,target:"all_cards",collectionId:T,revisionId:oe,revisionView:Se,infoId:o.infoId,infoView:"overview"});return}if(g==="create"){vt({libraryId:w,target:"new_card",collectionId:T,revisionId:oe,revisionView:Se,infoId:void 0});return}vt({libraryId:w,target:"all_cards",collectionId:T,revisionId:oe,revisionView:Se,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:c.layers.target,visible:se==="all_cards"&&!!o.infoId,value:S==="new_card"&&o.infoId?"edit":o.infoView==="cards"?"cards":o.infoView==="collections"?"collections":"overview",selectedLabel:S==="new_card"&&o.infoId?c.infoActions.edit:o.infoView==="cards"?c.infoActions.seeCards:o.infoView==="collections"?"Kolekcje":c.infoActions.overview,disabled:!Xe||!o.infoId,options:[{value:"overview",label:c.infoActions.overview},{value:"edit",label:c.infoActions.edit},{value:"cards",label:c.infoActions.seeCards},{value:"collections",label:"Kolekcje"}],onSelect:g=>{if(o.infoId){if(g==="edit"){vt({libraryId:w,target:"new_card",collectionId:T,revisionId:oe,revisionView:Se,infoId:o.infoId});return}if(g==="cards"){vt({libraryId:w,target:"all_cards",collectionId:T,revisionId:oe,revisionView:Se,infoId:o.infoId,infoView:"cards"});return}vt({libraryId:w,target:"all_cards",collectionId:T,revisionId:oe,revisionView:Se,infoId:o.infoId,infoView:"overview"})}}},{key:"collection_mode",label:c.layers.collection,visible:Xe&&(S==="all_collections"||S==="new_collection"),value:Re,selectedLabel:Re==="create"?t.cogita.library.actions.createCollection:Re==="selected"?(ge==null?void 0:ge.name)??c.path.noCollectionSelected:t.cogita.library.actions.collections,disabled:!Xe,options:[{value:"search",label:t.cogita.library.actions.collections},{value:"create",label:t.cogita.library.actions.createCollection},...T&&ge?[{value:"selected",label:ge.name}]:[]],onSelect:g=>{if(g==="create"){vt({libraryId:w,target:"new_collection",collectionId:void 0,revisionId:void 0,revisionView:"detail"});return}if(g==="selected"&&T){const re=ee?S:"all_collections";vt({libraryId:w,target:re,collectionId:T,revisionId:oe,revisionView:re==="all_revisions"?"settings":"detail"});return}if(g==="collections"){vt({libraryId:w,target:"all_cards",collectionId:T,revisionId:oe,revisionView:Se,infoId:o.infoId,infoView:"collections"});return}vt({libraryId:w,target:ee?S:"all_collections",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection",label:c.layers.collection,visible:ht&&Re!=="create",value:T??"",selectedLabel:(ge==null?void 0:ge.name)??c.path.noCollectionSelected,disabled:!Xe||K||k.length===0,options:k.map(g=>({value:g.collectionId,label:g.name})),emptyOption:c.selectCollectionOption,onSelect:g=>{const re=g||void 0,H=ee?S:"all_collections";vt({libraryId:w,target:H,collectionId:re,revisionId:void 0,revisionView:H==="all_revisions"?"settings":"detail"})}},{key:"collection_selected_action",label:c.layers.revision,visible:nt,value:S==="all_revisions"?"revisions":Y==="graph"?"edit":Y==="settings"||Y==="run"||Y==="shared"?"revisions":(o.collectionView??"infos")==="overview"?"overview":"infos",selectedLabel:S==="all_revisions"?c.targets.allRevisions:Y==="graph"?"Edytuj":Y==="settings"||Y==="run"||Y==="shared"?c.targets.allRevisions:(o.collectionView??"infos")==="overview"?"Przegląd":"Informacje",disabled:!T,options:[{value:"overview",label:"Przegląd"},{value:"edit",label:"Edytuj"},{value:"infos",label:"Informacje"},{value:"revisions",label:c.targets.allRevisions}],onSelect:g=>{if(T){if(g==="edit"){vt({libraryId:w,target:ee?S:"all_collections",collectionId:T,revisionId:void 0,revisionView:"graph"});return}if(g==="revisions"){vt({libraryId:w,target:ee?S:"all_collections",collectionId:T,revisionId:oe,revisionView:"settings"});return}vt({libraryId:w,target:ee?S:"all_collections",collectionId:T,revisionId:void 0,revisionView:"detail",infoId:o.infoId,infoView:o.infoView,collectionView:g==="overview"?"overview":"infos"})}}},{key:"revision_mode",label:c.layers.revision,visible:zt,value:Se==="new"?"create":!oe&&Y==="shared"?"shared":"search",selectedLabel:Se==="new"?c.revisionForm.createAction:!oe&&Y==="shared"?c.targets.sharedRevisions:c.infoActions.search,disabled:S==="all_revisions"?!Xe:!Ee,options:[{value:"search",label:c.infoActions.search},{value:"create",label:c.revisionForm.createAction},{value:"shared",label:c.targets.sharedRevisions}],onSelect:g=>{vt({libraryId:w,target:ee?S:"all_revisions",collectionId:S==="all_revisions"?void 0:T,revisionId:void 0,revisionView:g==="create"?"new":g==="shared"?"shared":"settings"})}},{key:"revision_entry",label:c.layers.revision,visible:zt,value:oe??"",selectedLabel:(P==null?void 0:P.name)??c.status.noRevisions,disabled:(S==="all_revisions"?!Xe:!Ee)||U||Z.length===0,options:Z.map(g=>({value:g.revisionId,label:g.name})),emptyOption:c.status.noRevisions,onSelect:g=>{vt({libraryId:w,target:ee?S:"all_collections",collectionId:T,revisionId:g||void 0,revisionView:Y==="settings"||Y==="run"||Y==="shared"?Y:"settings"})}},{key:"revision_selected_action",label:c.layers.revision,visible:Tt,value:Y==="run"?"run":Y==="shared"?"shared":"settings",selectedLabel:Y==="run"?c.revisions.run:Y==="shared"?c.targets.sharedRevisions:c.infoActions.edit,disabled:!oe,options:[{value:"settings",label:c.infoActions.edit},{value:"run",label:c.revisions.run},{value:"shared",label:c.targets.sharedRevisions}],onSelect:g=>{oe&&vt({libraryId:w,target:ee?S:"all_collections",collectionId:T,revisionId:oe,revisionView:g==="run"?"run":g==="shared"?"shared":"settings"})}}],[k,K,ue,v,j,G,vt,Z,U,ge,T,fe,P,oe,pe,Ee,Xe,xe,ee,w,Qe,Se,S,Y,se,et,ht,nt,zt,Tt,ze,t.cogita.library.list.selectedEmpty,o.infoId,o.infoView,o.collectionView,c.infoActions.edit,c.infoActions.overview,c.infoActions.seeCards,c.layers.collection,c.layers.library,c.layers.revision,c.layers.target,c.noLibraryOption,c.path.noCollectionSelected,c.path.noLibrarySelected,c.selectCollectionOption,c.targets.allRevisions,c.infoActions.search,c.revisionForm.createAction,c.revisions.run,c.targets.sharedRevisions,Re]),jt=n.useMemo(()=>It.filter(g=>g.visible),[It]),dt=n.useMemo(()=>jt.filter(g=>g.key!=="library"&&g.key!=="collection"),[jt]),Kt=n.useMemo(()=>dt.find(g=>g.key==="target")??null,[dt]),lt=n.useMemo(()=>dt.find(g=>g.key==="info_mode")??null,[dt]),We=n.useMemo(()=>dt.find(g=>g.key==="info_selected_action")??null,[dt]),wt=n.useMemo(()=>dt.find(g=>g.key==="collection_mode")??null,[dt]),Gt=n.useMemo(()=>dt.find(g=>g.key==="revision_mode")??null,[dt]),qt=n.useMemo(()=>dt.find(g=>g.key==="collection_selected_action")??null,[dt]),Vt=n.useMemo(()=>dt.find(g=>g.key==="revision_entry")??null,[dt]),be=n.useMemo(()=>dt.find(g=>g.key==="revision_selected_action")??null,[dt]),Et=n.useCallback((g,re)=>g?e.jsx("div",{className:"cogita-sidebar-actions",children:g.options.map(H=>e.jsx("button",{type:"button",className:`ghost ${String(g.value)===H.value?"active":""}`,onClick:()=>g.onSelect(H.value),disabled:g.disabled,title:H.label,children:fa(H.label,Aa)},`${re}:${g.key}:${H.value}`))}):null,[]),Zt=n.useMemo(()=>{const g=o.libraryId;if(!g||!p.pathname.startsWith("/cogita/library/"))return null;const re={copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,libraryId:g};if(o.target==="library_overview")return e.jsx(oi,{...re});if(o.target==="all_cards")return o.infoId&&o.infoView==="cards"?e.jsx(_i,{...re,infoId:o.infoId,selectedReviewerRoleId:tt||null}):e.jsx(xi,{...re,mode:o.cardMode??"list"});if(o.target==="new_card")return e.jsx(Mi,{...re,editInfoId:o.infoId});if(o.target==="dependencies")return e.jsx(Ai,{...re});if(o.target==="transfer")return e.jsx(Oi,{...re});if(o.target==="storyboards"||o.target==="new_storyboard")return e.jsx(qi,{...re});if(o.target==="texts"||o.target==="new_text")return e.jsx(Ui,{...re});if(o.target==="all_collections"||o.target==="all_revisions"){if(o.target==="all_revisions"&&!o.collectionId)return o.revisionView==="run"?e.jsx(Bn,{...re,revisionId:o.revisionId}):e.jsx(Bs,{...re,revisionId:o.revisionId});if(!o.collectionId&&o.revisionView==="run")return e.jsx(Bn,{...re,revisionId:o.revisionId});if(o.collectionId){const H={...re,collectionId:o.collectionId};return o.revisionView==="graph"?e.jsx(xo,{...H}):o.revisionView==="shared"?e.jsx(Vi,{...re,collectionId:o.collectionId}):o.revisionView==="settings"?e.jsx(Bs,{...H,revisionId:o.revisionId}):o.revisionView==="run"?e.jsx(Bn,{...H,revisionId:o.revisionId}):e.jsx(Hi,{...H})}return e.jsx(Ji,{...re})}return o.target==="new_collection"?e.jsx(Yi,{...re,onCreated:H=>{vt({libraryId:g,target:S==="all_revisions"?"all_revisions":"all_collections",collectionId:H,revisionId:void 0,revisionView:"graph"})}}):null},[a,vt,t,m,p.pathname,d,x,u,b,r,i,o.cardMode,o.collectionId,o.infoId,o.libraryId,o.revisionId,o.revisionView,o.target,l,s,S,tt]);n.useEffect(()=>{let g=!1;return(async()=>{var H,Ze,ut,pt,Rt;O(!0);try{await Kr();const[At,Nt,Pt]=await Promise.all([Qs(),Ys(),_r()]);if(g)return;h(At);const ha=new Set(Pt.nodes.filter(bt=>bt.nodeType==="role"&&bt.canLink).map(bt=>bt.roleId??"")),ma=ko(Nt,ha);if(R(ma),ma){const bt=Pt.nodes.find(Dt=>Dt.nodeType==="data"&&Dt.roleId===ma&&(Dt.fieldType===Vn||Dt.label===Vn));F((bt==null?void 0:bt.dataKeyId)??null),N.current=No(bt==null?void 0:bt.value)}const _t=(H=At.find(bt=>bt.libraryId===o.libraryId))==null?void 0:H.libraryId,na=_t?(ut=(Ze=N.current.byLibrary)==null?void 0:Ze[_t])==null?void 0:ut.lastTarget:void 0,Ta=wo(na)?na:"library_overview";Q(_t),te(o.target??Ta),me(o.revisionId??(_t?(Rt=(pt=N.current.byLibrary)==null?void 0:pt[_t])==null?void 0:Rt.lastRevisionId:void 0)),Je(o.revisionView??"detail"),C.current=!0}catch{g||Me(c.status.loadFailed)}finally{g||O(!1)}})(),()=>{g=!0}},[c.status.loadFailed]),n.useLayoutEffect(()=>{if(C.current){if(!o.libraryId){Q(void 0),te(o.target??"library_overview"),$(void 0),me(void 0),Je("detail");return}o.libraryId&&j.some(g=>g.libraryId===o.libraryId)&&Q(o.libraryId),o.target&&te(o.target),$(o.collectionId),me(o.revisionId),o.revisionView&&Je(o.revisionView)}},[j,o.collectionId,o.libraryId,o.revisionId,o.revisionView,o.target]),n.useEffect(()=>{if(!w){L([]),$(void 0),y([]),V([]),me(void 0);return}let g=!1;return W(!0),Ua({libraryId:w,limit:200}).then(re=>{var ut;if(g)return;const H=re.items;L(H);const Ze=(ut=H.find(pt=>pt.collectionId===o.collectionId))==null?void 0:ut.collectionId;$(Ze)}).catch(()=>{g||(L([]),$(void 0))}).finally(()=>{g||W(!1)}),()=>{g=!0}},[o.collectionId,w]),n.useEffect(()=>{if(!w||se!=="all_cards"&&S!=="new_card"){y([]);return}let g=!1;return es({libraryId:w,limit:200}).then(re=>{g||y(re)}).catch(()=>{g||y([])}),()=>{g=!0}},[se,w,S]),n.useEffect(()=>{if(!w||S!=="all_revisions"&&!T){V([]),S!=="all_revisions"&&me(void 0);return}let g=!1;return ce(!0),Xn({libraryId:w,collectionId:S==="all_revisions"?void 0:T}).then(re=>{var ut,pt,Rt,At;if(g)return;V(re);const H=(pt=(ut=N.current.byLibrary)==null?void 0:ut[w])==null?void 0:pt.lastRevisionId,Ze=((Rt=re.find(Nt=>Nt.revisionId===o.revisionId))==null?void 0:Rt.revisionId)??((At=re.find(Nt=>Nt.revisionId===H))==null?void 0:At.revisionId);me(Ze)}).catch(()=>{g||(V([]),me(void 0))}).finally(()=>{g||ce(!1)}),()=>{g=!0}},[o.revisionId,T,w,S]),n.useEffect(()=>{const g=o.infoId;if(!w||!g){E(void 0);return}let re=!1;return aa({libraryId:w,infoId:g}).then(H=>{if(re)return;const Ze=H.payload??{},ut=Ze.definition&&typeof Ze.definition=="object"?Ze.definition:null,pt=typeof(ut==null?void 0:ut.title)=="string"?ut.title:void 0,Rt=typeof(ut==null?void 0:ut.question)=="string"?ut.question:void 0,At=typeof Ze.label=="string"?Ze.label:void 0,Nt=typeof Ze.name=="string"?Ze.name:void 0,Pt=typeof Ze.title=="string"?Ze.title:void 0;E(pt??Rt??At??Nt??Pt??H.infoId)}).catch(()=>{re||E(g)}),()=>{re=!0}},[o.infoId,w]),n.useEffect(()=>{if(!C.current||o.libraryId&&j.some(ut=>ut.libraryId===o.libraryId)&&o.libraryId!==w||o.target&&o.target!==S||o.revisionView&&o.revisionView!==Se||o.revisionId&&o.revisionId!==oe||qn[S].requiresCollection&&!T&&(o.target==="all_collections"||o.target==="all_revisions")&&o.collectionId)return;const g=ba(`${p.pathname}${p.search}`);if(ba(p.pathname)==="/cogita"&&!o.libraryId&&!w){de.current=null;return}if(ba(p.pathname)==="/cogita/persons"){de.current=null;return}if(ba(p.pathname)===`/cogita/library/${w}/revision/run`&&o.revisionView==="run"&&!o.collectionId&&(S==="all_collections"||S==="all_revisions")&&Se==="run"&&!T){de.current=null;return}const Ze=ba(Vs(w,S,T,Se,oe,o.infoId,o.infoView??"overview",o.collectionView??"infos"));if(g===Ze){de.current=null;return}de.current!==Ze&&(de.current=Ze,d(Ze,{replace:!0}))},[j,p.pathname,p.search,d,o.collectionId,o.infoId,o.infoView,o.collectionView,o.libraryId,o.revisionId,o.revisionView,o.target,T,w,oe,Se,S]),n.useEffect(()=>{if(typeof window>"u")return;const g=()=>{window.innerWidth>920&&M(!1)};return window.addEventListener("resize",g),()=>window.removeEventListener("resize",g)},[]),n.useEffect(()=>{if(!C.current||!_||!w||A.current)return;const g=N.current,re={...g.byLibrary??{}},H={...re[w]??{},lastCollectionId:T,lastRevisionId:oe,lastRevisionView:Se,lastTarget:S},Ze={version:1,lastLibraryId:w,byLibrary:{...re,[w]:H}},ut=JSON.stringify(g),pt=JSON.stringify(Ze);if(ut===pt)return;N.current=Ze,A.current=!0,(async()=>{try{if(z)await Dr(z,{plainValue:pt});else{const At=await Br(_,{itemName:Vn,itemType:"data",plainValue:pt});F(At.dataItemId)}}catch{Me(c.status.savePrefsFailed)}finally{A.current=!1}})()},[z,_,T,w,oe,Se,S,c.status.savePrefsFailed]);const Ut=async()=>{const g=it.trim();if(!g){Me(t.cogita.user.libraryNameRequired);return}Me(null);try{const re=await Vr({name:g});h(H=>[re,...H]),Q(re.libraryId),te("library_overview"),$(void 0),Ce("")}catch{Me(t.cogita.user.libraryCreateFailed)}},q=async()=>{if(!w||!T){Me(c.status.selectLibraryFirst);return}const g=Oe.trim();if(!g){Me(c.revisionForm.nameLabel);return}Me(null);try{const re=await zr({libraryId:w,collectionId:T,name:g,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});V(H=>[re,...H]),me(re.revisionId),te(S==="all_revisions"?"all_revisions":"all_collections"),Je("settings"),De("")}catch{Me(c.status.loadFailed)}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,headerExtra:e.jsxs("div",{className:"cogita-header-reviewer-actions",children:[e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:tt,disabled:!w,onChange:g=>{const re=g.target.value;if(re==="__new_person__"){d("/cogita/persons");return}Le(re)},children:[e.jsx("option",{value:"",children:w?"No person":"Select library first"}),rt.map(g=>e.jsx("option",{value:g.roleId,children:g.label},g.roleId)),e.jsx("option",{value:"__new_person__",children:"+ Create new person"})]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>d("/cogita/persons"),children:"Persons"})]}),children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${D?"open":""}`,"aria-label":c.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{title:(xe==null?void 0:xe.name)??c.path.noLibrarySelected,children:fa((xe==null?void 0:xe.name)??c.path.noLibrarySelected,Aa)}),e.jsx("p",{className:"cogita-sidebar-note",children:xe?c.sidebar.libraryActionsHint:c.status.selectLibraryFirst}),Et(Kt,"sidebar"),S==="all_revisions"&&Vt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.targets.allRevisions}),Et(Gt,"sidebar"),Et(Vt,"sidebar"),be?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(P==null?void 0:P.name)??c.status.noRevisions,children:fa((P==null?void 0:P.name)??c.status.noRevisions,Aa)}),Et(be,"sidebar")]}):null]}):null,lt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.sidebar.infoActionsHint}),Et(lt,"sidebar"),We?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(fe==null?void 0:fe.label)??pe??t.cogita.library.list.selectedEmpty,children:fa((fe==null?void 0:fe.label)??pe??t.cogita.library.list.selectedEmpty,Aa)}),e.jsx("p",{className:"cogita-sidebar-note",children:c.sidebar.selectedInfoActionsHint}),Et(We,"sidebar")]}):null]}):null,wt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.sidebar.collectionActionsHint}),Et(wt,"sidebar"),ge&&qt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:ge.name,children:fa(ge.name,Aa)}),Et(qt,"sidebar"),S!=="all_revisions"&&Vt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.targets.allRevisions}),Et(Gt,"sidebar"),Et(Vt,"sidebar"),be?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(P==null?void 0:P.name)??c.status.noRevisions,children:fa((P==null?void 0:P.name)??c.status.noRevisions,Aa)}),Et(be,"sidebar")]}):null]}):null]}):null]}):null]}),e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:c.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:r,children:c.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{b("cogita"),M(!1)},children:c.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:i,children:l?t.account.secureModeDisable:t.account.secureModeEnable}),e.jsx("button",{type:"button",className:"ghost",disabled:!w,onClick:()=>{w&&(d(`/cogita/live-sessions/${encodeURIComponent(w)}`),M(!1))},children:t.cogita.library.revision.live.hostTitle})]})]})]}),D?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":c.sidebar.closeMenu,onClick:()=>M(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":c.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>M(g=>!g),"aria-label":D?c.sidebar.closeMenu:c.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),jt.map((g,re)=>e.jsxs("div",{className:"cogita-browser-segment",children:[re>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,g.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":g.label,title:g.selectedLabel,children:fa(g.selectedLabel,zs)}):e.jsxs("select",{"aria-label":g.label,value:g.value,onChange:H=>g.onSelect(H.target.value),disabled:g.disabled,children:[g.emptyOption?e.jsx("option",{value:"",children:g.emptyOption}):null,g.options.map(H=>e.jsx("option",{value:H.value,title:H.label,children:fa(H.label,zs)},`${g.key}:${H.value}`))]})]},`menu:${g.key}`))]}),Zt?e.jsxs(e.Fragment,{children:[(S==="all_collections"||S==="all_revisions")&&Se==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:c.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsxs("select",{value:T??"",onChange:g=>$(g.target.value||void 0),children:[e.jsx("option",{value:"",children:c.selectCollectionOption}),k.map(g=>e.jsx("option",{value:g.collectionId,children:g.name},g.collectionId))]})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:c.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Oe,onChange:g=>De(g.target.value),placeholder:c.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:q,children:c.revisionForm.createAction}),ve?e.jsx("p",{className:"cogita-form-error",children:ve}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(nr.Provider,{value:!0,children:Zt})})]}):null,Zt?null:e.jsxs(e.Fragment,{children:[ae?e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(zi,{copy:t,onPersonCreated:g=>{at(re=>re+1)}})}):null,!w&&!ae?e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:Ve.step}),e.jsx("h2",{children:Ve.title})]}),e.jsxs("p",{children:[Mt+1," / ",St]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:Ve.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:Ve.passages.map(g=>e.jsx("p",{children:g},g))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:Ve.focus.map(g=>e.jsx("span",{children:g},g))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:Ve.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:Ct.map((g,re)=>e.jsx("button",{type:"button",className:`ghost ${re===Mt?"active":""}`,onClick:()=>He(re),"aria-label":`${re+1}`,children:re+1},`tutorial:${g.title}:${re}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:Mt===0,onClick:()=>He(g=>Math.max(0,g-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:Mt===St-1,onClick:()=>He(g=>Math.min(St-1,g+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:it,onChange:g=>Ce(g.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Ut,children:t.cogita.user.createLibraryAction}),ve?e.jsx("p",{className:"cogita-form-error",children:ve}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),j.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,j.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:j.map(g=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{vt({libraryId:g.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:g.name})]},g.libraryId))}):null]})]})]}):null]})]})]})})}const Bo=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:So},Symbol.toStringTag,{value:"Module"}));function To({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,shareId:d}){const[p,o]=n.useState(null),[c,j]=n.useState("loading"),[h,k]=n.useState(t.cogita.library.collections.defaultName),[L,v]=n.useState("Cogita Library"),[y,Z]=n.useState([]),[V,w]=n.useState([]),[Q,S]=n.useState("idle"),[te,T]=n.useState({current:0,total:0}),[$,oe]=n.useState(0),[me,Se]=n.useState(""),[Je,pe]=n.useState(null),[E,D]=n.useState(null),[M,G]=n.useState(null),[O,K]=n.useState(null),[W,U]=n.useState([]),[ce,ve]=n.useState({}),[Me,Ie]=n.useState({}),[He,it]=n.useState(null),[Ce,Ye]=n.useState(null),[kt,Oe]=n.useState(null),[De,rt]=n.useState(null),[gt,tt]=n.useState({}),Le=n.useRef(0),[Be,at]=n.useState(null),_=n.useRef(null),R=n.useRef(null),[z,F]=n.useState(null),[N,C]=n.useState(!1),[A,de]=n.useState(null),[xe,ge]=n.useState([]),[ae,P]=n.useState(null),X=n.useRef(null),se=n.useRef(null),[Y,ee]=n.useState(null),[Re,ue]=n.useState(0),fe=n.useRef(null),ze=n.useRef({}),[et,Qe]=n.useState(!1),[Xe,Ct]=n.useState({}),St=n.useRef(null),Mt=n.useRef(new Set),Ve=n.useRef({}),[Ee,ht]=n.useState([]),[nt,mt]=n.useState(new Set),[zt,Tt]=n.useState(!1),vt=Pa(),It=n.useMemo(()=>new URLSearchParams(vt.search),[vt.search]),jt=n.useMemo(()=>It.get("key")??"",[It]),dt=(p==null?void 0:p.mode)??"random",Kt=(p==null?void 0:p.check)??"exact",lt=(p==null?void 0:p.limit)??20,We=n.useMemo(()=>os((p==null?void 0:p.revisionType)??dt),[p,dt]),wt=n.useMemo(()=>{const B=p==null?void 0:p.revisionSettings,le=cr(We,It);return kn(We,B??le)},[p,It,We]),Gt=n.useMemo(()=>t.cogita.library.revision[We.labelKey]??dt,[t,dt,We]),qt=n.useMemo(()=>Kt==="exact"?t.cogita.library.revision.checkValue:Kt,[t,Kt]),be=c==="ready"?y[$]??null:null,Et=(be==null?void 0:be.checkType)==="translation-match"&&De,Zt=n.useRef(new Map),Ut=n.useRef(new Map),q=n.useRef(new Map),g=n.useRef(new Map),re=n.useMemo(()=>be?be.cardType==="vocab"?t.cogita.library.revision.vocabLabel:be.infoType?ot(t,be.infoType):t.cogita.library.revision.infoLabel:"",[t,be]),H=n.useMemo(()=>{var le;return We.id!=="levels"?y.length:((le=Xe.pool)==null?void 0:le.length)??We.getFetchLimit(lt,wt)},[Xe,wt,We,y.length,lt]),Ze=We.getProgressTotal?We.getProgressTotal(y,Xe,lt,wt):We.id==="levels"?Math.min(lt,H):y.length,ut=Ze?Math.min($+1,Ze):0,pt=Math.max(1,Number(wt.tries??1)),Rt=wt.compare??"anchors",At=Math.max(0,Math.min(100,Number(wt.minCorrectness??0))),Nt=(wt.considerDependencies??"on")==="on",Pt=Math.max(0,Math.min(100,Number(wt.dependencyThreshold??85))),ha=B=>{const le=B.slice();for(let we=le.length-1;we>0;we-=1){const Fe=Math.floor(Math.random()*(we+1));[le[we],le[Fe]]=[le[Fe],le[we]]}return le},ma=B=>xa(B,{treatSimilarCharsAsSame:!0})>=At,_t=async()=>{const B=await da(),le=new Map,we=new Map;B.forEach(ke=>{const Pe=`${ke.itemType}:${ke.itemId}`,Ae=ta(ke.itemType,ke.itemId,ke.checkType,ke.direction);le.has(Pe)||le.set(Pe,[]),le.get(Pe).push(ke),we.has(Ae)||we.set(Ae,[]),we.get(Ae).push(ke)});const Fe=new Map,Ke=new Map;return le.forEach((ke,Pe)=>Fe.set(Pe,ca(ke).score)),we.forEach((ke,Pe)=>Ke.set(Pe,ca(ke).score)),{itemKnowness:Fe,cardKnowness:Ke}},na=async B=>{const le=Xe,we=B.concat(le.active??[]).concat(le.pool??[]).filter((f,I,J)=>J.findIndex(he=>Te(he)===Te(f))===I);if(!Nt){mt(new Set(we.map(Te)));return}const{itemKnowness:Fe,cardKnowness:Ke}=await _t(),ke=f=>{if(f.cardType!=="info"||f.infoType!=="citation"||f.checkType!=="quote-fragment")return!0;const I=Qt(f.direction);if(!(I!=null&&I.fragmentId))return!0;const J=f.description??"";if(!J.trim())return!0;const ye=va(J).nodes[I.fragmentId];if(!ye||!ye.leftId&&!ye.rightId)return!0;const ie=[ye.leftId,ye.rightId].filter(Ne=>!!Ne);if(ie.length===0)return!0;const je=ie.map(Ne=>{const _e=ta("info",f.cardId,"quote-fragment",Ne);return Ke.get(_e)??0});return je.reduce((Ne,_e)=>Ne+_e,0)/je.length>=Pt},Pe=(p==null?void 0:p.collectionId)??null,Ae=Pe?Ee.filter(f=>Lt(f.childItemType)==="collection"&&f.childItemId===Pe&&!Lt(f.childCheckType)&&!Lt(f.childDirection)):[],$e=Pe&&we.length>0?we.reduce((f,I)=>f+(Ke.get(Te(I))??0),0)/we.length:0,Ge=new Set;for(const f of we){if(f.cardType!=="info"){Ge.add(Te(f));continue}if(!ke(f))continue;const I=Ee.filter(ye=>pr(ye,f)).concat(Ae);if(I.length===0){Ge.add(Te(f));continue}let J=0;for(const ye of I)if(Lt(ye.parentItemType)==="collection")J+=ye.parentItemId===Pe?$e:0;else if(Lt(ye.parentCheckType)||Lt(ye.parentDirection)){const ie=Lt(ye.parentCheckType),je=Lt(ye.parentDirection),ne=ta(ye.parentItemType,ye.parentItemId,ie,je);J+=Ke.get(ne)??0}else{const ie=`${ye.parentItemType}:${ye.parentItemId}`;J+=Fe.get(ie)??0}J/I.length>=Pt&&Ge.add(Te(f))}mt(Ge)},Ta=B=>{for(let le=B;le<y.length;le+=1){const we=y[le];if(we&&(!Nt||we.cardType!=="info"||nt.has(Te(we))))return le}return-1},bt=B=>!Nt||B.cardType!=="info"||nt.has(Te(B)),Dt=B=>{if(We.id!=="temporal"&&We.id!=="levels")return null;const le=Xe,we=(le.active??[]).concat(le.pool??[]),Fe=new Set;for(const Ke of we){const ke=Te(Ke);if(!(Fe.has(ke)||B.has(ke))&&(Fe.add(ke),bt(Ke)))return Ke}return null},ea=n.useMemo(()=>{if(We.id!=="levels")return null;const B=Xe,le=B.pool??[],we=B.active??[],Fe=B.levelMap??{},Ke=Math.max(1,Number(wt.levels??1)),ke=Array.from({length:Ke},()=>0),Pe=new Set(we.map(f=>Te(f)));le.forEach(f=>{const I=Math.min(Ke,Math.max(1,Fe[Te(f)]??1));ke[I-1]+=1});const Ae=le.length||1,$e=ke.map(f=>f/Ae*100),Ge=be?Fe[Te(be)]??1:null;return{counts:ke,percentages:$e,currentLevel:Ge,levelsCount:Ke,activeCount:we.length,poolCount:le.length,activeSet:Pe}},[Xe,wt,We,be]),ja=n.useMemo(()=>{if(We.id!=="temporal")return null;const B=Xe,le=B.pool??[],we=B.active??[],Fe=B.knownessMap??{},Ke=new Set(B.unknownSet??[]);let ke=0;le.forEach($e=>{(Fe[Te($e)]??0)>1&&(ke+=1)});const Pe=Ke.size,Ae=we.map($e=>({id:Te($e),value:Ke.has(Te($e))?0:Math.max(0,Math.min(1,Fe[Te($e)]??0))}));return{knownCount:ke,unknownCount:Pe,dots:Ae}},[Xe,We]),Ga=n.useMemo(()=>{if(!Nt)return 0;const B=Xe;return y.concat(B.active??[]).concat(B.pool??[]).filter((we,Fe,Ke)=>Ke.findIndex(ke=>Te(ke)===Te(we))===Fe).filter(we=>we.cardType==="info"&&!nt.has(Te(we))).length},[Nt,Xe,y,nt]);n.useEffect(()=>{if(!Nt||Q!=="ready")return;const B=Xe,we=y.concat(B.active??[]).concat(B.pool??[]).filter((ke,Pe,Ae)=>Ae.findIndex($e=>Te($e)===Te(ke))===Pe).filter(ke=>ke.cardType!=="info"||nt.has(Te(ke))).length,Fe=X.current;if(X.current=we,Fe===null||we<=Fe)return;const Ke=we-Fe;P(`New card available (+${Ke})`),se.current&&window.clearTimeout(se.current),se.current=window.setTimeout(()=>P(null),2200)},[Nt,Q,Xe,y,nt]),n.useEffect(()=>()=>{se.current&&window.clearTimeout(se.current)},[]);const Yt=(B,le)=>{const we=We.applyOutcome({queue:y,meta:Xe},be,lt,wt,{correct:B,correctness:le,createdUtc:new Date().toISOString()});Z(we.queue),Ct(we.meta);const Fe=we.queue[$+1];Fe&&Ot(Fe,$+1)};n.useEffect(()=>{if(!d){j("error");return}j("loading"),Or({shareId:d,key:jt}).then(B=>{o(B),k(B.collectionName),v(B.libraryName),j("ready")}).catch(()=>{j("error")})},[d,jt]),n.useEffect(()=>{d&&qr({shareId:d,key:jt,type:"language"}).then(B=>w(B)).catch(()=>w([]))},[d,jt]),n.useEffect(()=>{!d||c!=="ready"||Ur({shareId:d,key:jt}).then(B=>ht(B.items??[])).catch(()=>ht([]))},[d,jt,c]),n.useEffect(()=>{if(!d||c!=="ready")return;let B=!0;return(async()=>{S("loading"),T({current:0,total:We.id==="levels"?0:We.getFetchLimit(lt,wt)});try{const we=[];let Fe=null,Ke=null;do{const I=await Jr({shareId:d,key:jt,limit:300,cursor:Fe});if(we.push(...I.items),(We.id==="levels"||We.id==="temporal")&&I.total&&(Ke=I.total),T(J=>({current:we.length,total:J.total||I.total||We.getFetchLimit(lt,wt)})),Fe=I.nextCursor??null,Ke!==null&&we.length>=Ke||We.id!=="levels"&&We.id!=="temporal"&&we.length>=We.getFetchLimit(lt,wt))break}while(Fe);if(!B)return;const ke=qa(we);let Pe;if(We.id==="levels"){const I=Math.max(1,Number(wt.levels??1));Pe={},ke.forEach(J=>{const he=Te(J);Pe[he]=Math.max(1,Math.min(I,1))})}let Ae=null,$e=null,Ge=null;if(We.id==="temporal"){const I=await da(),J=new Set(ke.map(ie=>Te(ie))),he=I.reduce((ie,je)=>{const ne=ta(je.itemType,je.itemId,je.checkType,je.direction);return J.has(ne)&&(ie[ne]||(ie[ne]=[]),ie[ne].push(je)),ie},{});Ae={},$e=new Set,Ge={};const ye=Date.now();ke.forEach(ie=>{const je=Te(ie),ne=he[je]??[];if(ne.length===0){Ae[je]=0,$e.add(je),Ge[je]=[];return}const Ne=ss(ne);Ge[je]=Ne;const _e=jn(Ne,ye);Ae[je]=_e.knowness})}const f=We.id==="levels"?is(ke,lt,wt,Pe):We.id==="temporal"?rs(ke,lt,wt,Ae??{},$e??new Set,Ge??{}):We.prepare(ke,lt,wt);Z(f.queue),Ct(f.meta),oe(0),S("ready"),T(I=>({current:Math.min(I.current,I.total),total:I.total}))}catch{B&&S("error")}})(),()=>{B=!1}},[d,jt,lt,We,wt,c]),n.useEffect(()=>{na(y)},[y,Ee,Nt,Pt,p==null?void 0:p.collectionId]),n.useEffect(()=>{if(!be||!Nt){Tt(!1);return}if(be.cardType!=="info"||nt.has(Te(be))){Tt(!1);return}const B=Ta($+1);if(B>=0){Tt(!1),oe(B);return}if(We.id==="temporal"||We.id==="levels"){const le=y.slice(0,$+1),we=y.slice($+1).filter(bt),Fe=le.concat(we),Ke=new Set(Fe.map(Te)),ke=Dt(Ke);if(ke){const Ae=Te(ke);Ke.has(Ae)||(Fe.push(ke),Ke.add(Ae),Ct($e=>{const Ge=$e,f=new Set(Ge.queued??[]);return f.add(Ae),{...Ge,queued:f}}))}const Pe=Fe.findIndex((Ae,$e)=>$e!==$&&bt(Ae));if(Pe>=0){Z(Fe),oe(Pe),Tt(!1);return}}Tt(!0)},[be,nt,Nt,$,y,Xe,We.id]),n.useEffect(()=>{if(Se(""),pe(null),ee(null),ue(0),U([]),ve({}),Ie({}),it(null),Ye(null),Oe(null),C(!1),Qe(!1),F(null),rt(null),tt({}),!be){D(null),G(null);return}be.cardType==="info"&&be.infoType==="computed"&&D(t.cogita.library.revision.loadingComputed);let B=!0;return Ot(be,$).then(le=>{!B||!le||(D(le.prompt),G(le.expectedAnswer),U(le.computedExpected),ve(le.computedAnswers),it(le.answerTemplate),Ye(le.outputVariables),Oe(le.variableValues))}),()=>{B=!1}},[be,d,t]),n.useEffect(()=>{if(!be||be.cardType!=="info"||be.infoType!=="citation"){St.current=null,Mt.current=new Set,K(null);return}const B=be.description??"",le=(be.label??"").trim(),we=le.replace(/\s+/g," ").trim(),Fe=B.replace(/\s+/g," ").trim(),Ke=we&&we!==Fe?le:t.cogita.library.infoTypes.citation;if(!B){K(null),G(null);return}const ke=va(B);St.current=ke,D(Ke);let Pe=!0;return da().then(Ae=>{if(!Pe)return;const $e=new Map;Ae.forEach(he=>{if(he.itemType!=="info"||he.checkType!=="quote-fragment"||!he.direction)return;const ye=Qt(he.direction);if(!ye)return;const ie=`${he.itemId}:${ye.fragmentId}`;$e.has(ie)||$e.set(ie,[]),$e.get(ie).push(he)});const Ge={},f=new Set;$e.forEach((he,ye)=>{const[ie,je]=ye.split(":",2);if(ie!==be.cardId)return;const ne=ca(he).score;Ge[je]=ne,ne>=Pt&&f.add(je)}),Mt.current=f,Ve.current=Ge;const I=Qt(be.direction);if(I!=null&&I.fragmentId&&ke.nodes[I.fragmentId]){ra(ke,I.fragmentId,Ke);return}const J=Ra(ke,f,Ge,Pt,Nt,be.direction);ra(ke,(J==null?void 0:J.id)??null,Ke)}).catch(()=>{Mt.current=new Set,Ve.current={};const Ae=Qt(be.direction);if(Ae!=null&&Ae.fragmentId&&ke.nodes[Ae.fragmentId]){ra(ke,Ae.fragmentId,Ke);return}const $e=Ra(ke,Mt.current,{},Pt,Nt,be.direction);ra(ke,($e==null?void 0:$e.id)??null,Ke)}),()=>{Pe=!1}},[be,t,Nt,Pt]),n.useEffect(()=>{if(!be||be.cardType!=="vocab"||be.checkType!=="translation-match"){rt(null),tt({});return}const we=(Xe.pool??Xe.active??y).filter(Ae=>Ae.cardType==="vocab"&&Ae.checkType==="translation-match").filter((Ae,$e,Ge)=>Ge.findIndex(f=>f.cardId===Ae.cardId)===$e);we.some(Ae=>Ae.cardId===be.cardId)||we.unshift(be);const Ke=ha(we).slice(0,6).map(Ae=>{const $e=Ae.label.split("↔").map(I=>I.trim()).filter(Boolean);if($e.length<2)return null;const Ge=`${Ae.cardId}:L`,f=`${Ae.cardId}:R`;return{cardId:Ae.cardId,leftId:Ge,rightId:f,leftLabel:$e[0],rightLabel:$e[1]}}).filter(Boolean),ke=Ke.map(Ae=>Ae.leftId),Pe=ha(Ke.map(Ae=>Ae.rightId));rt({pairs:Ke,leftOrder:ke,rightOrder:Pe,selection:{},activeLeft:null,activeRight:null,locked:{}})},[be,y,Xe]),n.useEffect(()=>()=>{_.current&&window.clearTimeout(_.current),R.current&&window.clearTimeout(R.current)},[]);const Ca=n.useRef(null);n.useEffect(()=>{if(!be)return;const B=Te(be),le=typeof document<"u"?document.activeElement:null;if(Ca.current===B&&le&&(le.tagName==="INPUT"||le.tagName==="TEXTAREA"))return;let we=0;const Fe=()=>{if(be){if(be.cardType==="info"&&be.infoType==="computed"){if(W.length>0){const ke=mn(He,W,Ce),Pe=ke?ze.current[ke]:null;if(Pe&&(Pe.focus(),document.activeElement===Pe)){Ca.current=B;return}}if(fe.current&&(fe.current.focus(),document.activeElement===fe.current)){Ca.current=B;return}}else if(be.cardType==="vocab"&&fe.current&&(fe.current.focus(),document.activeElement===fe.current)){Ca.current=B;return}we<6&&(we+=1,window.setTimeout(Fe,40))}},Ke=window.setTimeout(Fe,40);return()=>window.clearTimeout(Ke)},[be,W,He,Ce]),n.useEffect(()=>{if(!et)return;const B=le=>{le.key==="Enter"&&(le.preventDefault(),Jt())};return window.addEventListener("keydown",B),()=>window.removeEventListener("keydown",B)},[et]);const Ia=B=>{ge(B),de(ca(B))};n.useEffect(()=>{if(!be){de(null),ge([]);return}const B=be.cardType==="info"?"info":"connection";if(be.cardType==="info"&&be.infoType==="citation"){da().then(le=>{const we=le.filter(Fe=>Fe.itemType==="info"&&Fe.itemId===be.cardId&&Fe.checkType==="quote-fragment"&&hn(Fe.direction,be.direction));Ia(we)}).catch(()=>{de(null),ge([])});return}un(B,be.cardId,be.checkType,be.direction).then(le=>Ia(le)).catch(()=>{de(null),ge([])})},[be]);const Fa=(B,le,we,Fe)=>{if(B==="info"&&we==="quote-fragment"){da().then(Ke=>{const ke=Ke.filter(Pe=>Pe.itemType==="info"&&Pe.itemId===le&&Pe.checkType==="quote-fragment"&&hn(Pe.direction,Fe));Ia(ke)}).catch(()=>{de(null),ge([])});return}un(B,le,we,Fe).then(Ke=>Ia(Ke)).catch(()=>{de(null),ge([])})},Ya=(B,le,we)=>{var Pe;const Fe=((Pe=we.pairs.find(Ae=>Ae.leftId===B))==null?void 0:Pe.rightId)??null;if(!Fe)return we;const Ke=Fe===le;tt(Ae=>({...Ae,[B]:Ke?"correct":"incorrect"})),_.current&&window.clearTimeout(_.current),R.current&&window.clearTimeout(R.current),Le.current+=1;const ke={kind:Ke?"correct":"incorrect",tick:Le.current};if(at(null),_.current=window.setTimeout(()=>at(ke),0),R.current=window.setTimeout(()=>at(null),420),Ke){const Ae={...we.locked,[B]:!0};return Object.keys(Ae).length>=we.pairs.length?(pe("correct"),Qe(!0)):pe("correct"),{...we,selection:{...we.selection,[B]:le},activeLeft:null,activeRight:null,locked:Ae}}return pe("incorrect"),{...we,activeLeft:null,activeRight:null}},Ka=B=>{rt(le=>!le||le.locked[B]?le:le.activeRight?Ya(B,le.activeRight,le):{...le,activeLeft:le.activeLeft===B?null:B})},Nn=B=>{rt(le=>le&&(le.activeLeft?Ya(le.activeLeft,B,le):{...le,activeRight:le.activeRight===B?null:B}))},Jt=()=>{var B;if(be&&be.cardType==="info"&&be.infoType==="citation"&&St.current&&O&&!((B=Qt(be.direction))!=null&&B.fragmentId)){const le=Ra(St.current,Mt.current,Ve.current,Pt,Nt,be.direction,O.fragmentId);if(le){pe(null),Se(""),C(!1),Ie({}),Qe(!1),ee(null),ue(0),ra(St.current,le.id,O.title);return}}pe(null),Se(""),C(!1),Ie({}),Qe(!1),ee(null),ue(0),oe(le=>Math.min(le+1,y.length))},Ht=B=>{if(!be)return;const le=B.expected??null,we=B.answer??"";let Fe=le??"",Ke=we;if(!le&&B.expectedMap&&B.answerMap){const I=Object.keys(B.expectedMap).sort((J,he)=>J.localeCompare(he));Fe=I.map(J=>{var he;return((he=B.expectedMap)==null?void 0:he[J])??""}).join("|"),Ke=I.map(J=>{var he;return((he=B.answerMap)==null?void 0:he[J])??""}).join("|")}const ke=Fe?$a(Fe,Ke,Rt):new Uint8Array,Pe={revisionType:We.id,evalType:B.evalType,direction:B.direction,prompt:E??"",expected:le,answer:we,expectedAnswers:B.expectedMap??null,answers:B.answerMap??null,correct:B.correct,maskBase64:ke.length?ya(ke):null,checkMode:Kt,compareMode:Rt,minCorrectness:At},Ae=new TextEncoder().encode(JSON.stringify(Pe)),$e=be.cardType==="info"?"info":"connection",Ge=B.overrideCheckType??be.checkType??null,f=B.overrideDirection??be.direction??null;dn({itemType:$e,itemId:be.cardId,checkType:Ge,direction:f,revisionType:We.id,evalType:B.evalType,correct:B.correct,maskBase64:ke.length?ya(ke):null,payloadBase64:ya(Ae)}).then(()=>{Fa($e,be.cardId,Ge,f),na(y)}).catch(()=>{})},Sn=(B,le)=>{const we=Zt.current.get(le);if(we)return Promise.resolve(we);const Fe=Ut.current.get(le);if(Fe)return Fe;const Ke=hs({shareCode:d,infoId:B,key:jt}).then(ke=>{var I,J;const Pe=ke.payload,Ae=((I=Pe.definition)==null?void 0:I.graph)??null,$e="",Ge=((J=Pe.definition)==null?void 0:J.answerTemplate)??"",f=dr(Ae,$e,Ge);if(f){const ye={sample:ur(f),answerTemplate:Ge||null};return Zt.current.set(le,ye),ye}return gs({shareId:d,infoId:B,key:jt}).then(he=>{const ye={sample:he,answerTemplate:null};return Zt.current.set(le,ye),ye})}).catch(()=>gs({shareId:d,infoId:B,key:jt}).then(ke=>{const Pe={sample:ke,answerTemplate:null};return Zt.current.set(le,Pe),Pe}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{Ut.current.delete(le)});return Ut.current.set(le,Ke),Ke},Ot=(B,le)=>{var Ae;const we=`${Te(B)}:${le}`,Fe=q.current.get(we);if(Fe)return Promise.resolve(Fe);const Ke=g.current.get(we);if(Ke)return Ke;const ke=$e=>(q.current.set(we,$e),$e);let Pe;if(B.cardType==="vocab"){if(B.checkType==="translation-match")return Pe=Promise.resolve(ke({prompt:B.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),Pe;const $e=B.label.split("↔").map(Ge=>Ge.trim()).filter(Boolean);if($e.length>=2){const f=(B.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",I=f?$e[0]:$e[1],J=f?$e[1]:$e[0];Pe=Promise.resolve(ke({prompt:I,expectedAnswer:J,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else Pe=Promise.resolve(ke({prompt:B.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(B.cardType==="info"&&B.infoType==="word"){const $e=(Ae=B.description)!=null&&Ae.startsWith("Language: ")?B.description.replace("Language: ",""):null;Pe=Promise.resolve(ke({prompt:B.label,expectedAnswer:$e,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else B.cardType==="info"&&B.infoType==="question"?Pe=hs({shareCode:d,infoId:B.cardId,key:jt}).then($e=>{const Ge=$e.payload??{},f=Ge.definition??Ge??{},I=typeof f.type=="string"?f.type:"",J=(typeof f.question=="string"&&f.question.trim()?f.question.trim():null)??(typeof f.title=="string"&&f.title.trim()?f.title.trim():null)??B.label,he=f.answer;return ke(I==="text"||I==="number"||I==="date"?{prompt:J,expectedAnswer:typeof he=="string"||typeof he=="number"?String(he):null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}:{prompt:J,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})}).catch(()=>ke({prompt:B.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{g.current.delete(we)}):B.cardType==="info"&&B.infoType==="computed"?Pe=Sn(B.cardId,we).then($e=>{var he,ye;if(!$e.sample)return ke({prompt:B.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const Ge=$e.sample,f=Ge.expectedAnswers?Object.entries(Ge.expectedAnswers).map(([ie,je])=>({key:ie,expected:je})):[],I=f.reduce((ie,je)=>(ie[je.key]="",ie),{}),J=Ge.expectedAnswerIsSentence&&((he=Ge.expectedAnswer)==null?void 0:he.trim())||null;return ke({prompt:Ge.prompt,expectedAnswer:f.length>0?J:((ye=Ge.expectedAnswer)==null?void 0:ye.trim())||null,computedExpected:f,computedAnswers:I,answerTemplate:$e.answerTemplate,outputVariables:Ge.outputVariables??null,variableValues:Ge.variableValues??null})}).catch(()=>ke({prompt:B.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{g.current.delete(we)}):Pe=Promise.resolve(ke({prompt:B.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return g.current.set(we,Pe),Pe},ra=(B,le,we)=>{const Fe=Object.keys(B.nodes).length,Ke=Mt.current.size;if(!le){K({title:we,before:B.text,after:"",fragmentId:null,total:Fe,completed:Ke}),G(null),Qe(!0);return}const ke=B.nodes[le];if(!ke)return;const Pe=vn(B.text,ke);K({title:we,before:Pe.before,after:Pe.after,fragmentId:ke.id,total:Fe,completed:Ke}),G(Pe.fragment),Qe(!1)},Ma=()=>{const B=St.current;B&&K(le=>le&&{...le,total:Object.keys(B.nodes).length,completed:Mt.current.size})},wa=()=>{const B=y[$+1];B&&Ot(B,$+1)},_a=()=>{if(wa(),be&&be.cardType==="vocab"&&be.checkType==="translation-match"&&De){if(De.pairs.length===0){pe("incorrect"),Qe(!0);return}const ke=De.pairs.reduce((J,he)=>(J[he.rightId]=he.rightLabel,J),{});let Pe=0;const Ae={};De.pairs.forEach(J=>{const ye=De.selection[J.leftId]===J.rightId;Ae[J.leftId]=ye?"correct":"incorrect",ye&&(Pe+=1)});const $e=De.pairs.length||1,Ge=Pe/$e,f=Pe===De.pairs.length;tt(J=>({...J,...Ae})),f?(pe("correct"),Qe(!0),ue(0)):(pe("incorrect"),Qe(!1),ue(J=>{const he=J+1;return he>=pt&&(C(!0),Qe(!0),rt(ye=>{if(!ye)return ye;const ie=ye.pairs.reduce((je,ne)=>(je[ne.leftId]=ne.rightId,je),{});return{...ye,selection:ie}})),he})),Yt(f,Ge);const I="connection";Promise.all(De.pairs.map(J=>{const he=De.selection[J.leftId]??null,ye=he?ke[he]:"",ie={left:J.leftLabel,expected:J.rightLabel,answer:ye,checkType:"translation-match"},je=new TextEncoder().encode(JSON.stringify(ie));return dn({itemType:I,itemId:J.cardId,checkType:"translation-match",direction:null,revisionType:We.id,evalType:"translation-match",correct:he===J.rightId,maskBase64:null,payloadBase64:ya(je)})})).then(()=>{Fa(I,be.cardId,be.checkType,be.direction),na(y)}).catch(()=>{});return}if(W.length>0){const ke=W.reduce((Ae,$e)=>{const Ge=ce[$e.key]??"";return Ae[$e.key]=Bt(Ge)===Bt($e.expected)?"correct":"incorrect",Ae},{});W.every(({key:Ae,expected:$e})=>{const Ge=ce[Ae]??"";return Kt==="exact"&&Bt(Ge)===Bt($e)})?(pe("correct"),Ie(ke),Qe(!0),ue(0),Yt(!0,1),Ht({correct:!0,direction:E?`${E} -> computed`:"computed",expectedMap:W.reduce((Ae,$e)=>(Ae[$e.key]=$e.expected,Ae),{}),answerMap:ce,evalType:"computed"})):(pe("incorrect"),Ie(ke),Qe(!1),ue(Ae=>{const $e=Ae+1;return $e>=pt&&ga&&(C(!0),Qe(!0)),$e}),Yt(!1,0),window.setTimeout(()=>{var $e;const Ae=mn(He,W,Ce);Ae&&ze.current[Ae]&&(($e=ze.current[Ae])==null||$e.focus())},40),Ht({correct:!1,direction:E?`${E} -> computed`:"computed",expectedMap:W.reduce((Ae,$e)=>(Ae[$e.key]=$e.expected,Ae),{}),answerMap:ce,evalType:"computed"}));return}if(be&&be.cardType==="info"&&be.infoType==="citation"&&(O!=null&&O.fragmentId)){if(!M)return;const ke=Qt(be.direction),Pe=(ke==null?void 0:ke.fragmentId)??O.fragmentId,Ae=Sa(M,me,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),$e=Ae.mask,Ge=Ae.isCorrect,f=Ae.percent;Ge?(Ve.current[O.fragmentId]=Math.max(Ve.current[O.fragmentId]??0,f),(Ve.current[O.fragmentId]??0)>=Pt&&Mt.current.add(O.fragmentId),Ma(),pe("correct"),Ie({}),Qe(!0),ee($e),ue(0),f<100&&pt<=1&&C(!0),Yt(!0,f/100),Ht({correct:!0,direction:`quote:${O.fragmentId}`,expected:M,answer:me,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Pe})):(pe("incorrect"),Ie({}),Qe(!1),ee($e),ue(I=>{const J=I+1;return J>=pt&&ga&&(C(!0),Qe(!0)),J}),Yt(!1,f/100),window.setTimeout(()=>{var I;return(I=fe.current)==null?void 0:I.focus()},40),Ht({correct:!1,direction:`quote:${O.fragmentId}`,expected:M,answer:me,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Pe}));return}if(!M)return;const B=$a(M,me,Rt),le=Kt==="exact"&&Bt(me)===Bt(M),we=ma(B),Fe=le||we,Ke=xa(B);Fe?(pe("correct"),Ie({}),Qe(!0),ee(B),ue(0),Ke<100&&pt<=1&&C(!0),Yt(!0,Ke/100),Ht({correct:!0,direction:E?`${E} -> ${M}`:null,expected:M,answer:me,evalType:"text"})):(pe("incorrect"),Ie({}),Qe(!1),ee(B),ue(ke=>{const Pe=ke+1;return Pe>=pt&&ga&&(C(!0),Qe(!0)),Pe}),Yt(!1,Ke/100),window.setTimeout(()=>{var ke;return(ke=fe.current)==null?void 0:ke.focus()},40),Ht({correct:!1,direction:E?`${E} -> ${M}`:null,expected:M,answer:me,evalType:"text"}))},Tn=B=>{if(wa(),!M)return;const le=$a(M,B,Rt),we=Bt(B)===Bt(M),Fe=ma(le),Ke=we||Fe,ke=xa(le);Ke?(pe("correct"),Ie({}),Qe(!0),ee(le),ue(0),ke<100&&pt<=1&&C(!0),Yt(!0,ke/100),Ht({correct:!0,direction:"word->language",expected:M,answer:B,evalType:"language-select"})):(pe("incorrect"),Ie({}),Qe(!1),ee(le),ue(Pe=>{const Ae=Pe+1;return Ae>=pt&&ga&&(C(!0),Qe(!0)),Ae}),Yt(!1,ke/100),Ht({correct:!1,direction:"word->language",expected:M,answer:B,evalType:"language-select"}))},Cn=B=>{var we;if(B.key!=="Enter")return;if(B.preventDefault(),B.stopPropagation(),et){Jt();return}const le=W.find(Fe=>!(ce[Fe.key]??"").trim());if(le){(we=ze.current[le.key])==null||we.focus();return}_a()},La=()=>{wa(),pe("correct"),Qe(!0),ue(0),Yt(!0,1),M&&Ht({correct:!0,direction:"manual",expected:M,answer:me,evalType:"manual"})},sa=()=>{if(Yt(!1,0),be&&be.cardType==="info"&&be.infoType==="citation"){pe(null),Se(""),C(!1),Ie({}),Qe(!1),ee(null),ue(0),oe(B=>Math.min(B+1,y.length));return}Jt()};n.useEffect(()=>{wa()},[$,y]);const In=t.cogita.library.revision.revealModeAfterIncorrect,ga=W.length>0||!!M;return e.jsxs($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:l,onNavigate:b,language:m,onLanguageChange:x,children:[(c==="loading"||Q==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:c==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${te.total?Math.min(100,Math.max(0,te.current/te.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:te.total?`${Math.min(te.current,te.total)} / ${te.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:h}),e.jsx("p",{className:"cogita-library-subtitle",children:L}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",Gt).replace("{check}",qt)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:A?`${A.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[ea?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",ea.currentLevel??"-"," / ",ea.levelsCount]}):null,A?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(A.correct)).replace("{total}",String(A.total))}),A.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(A.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(hr,{outcomes:xe})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[ae?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:ae})}):null,e.jsx(Ea,{feedbackToken:Be?`${Be.kind}-${Be.tick}`:Et?"idle":Je?`${Je}-${$}-${Re}`:"idle",children:c!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:c==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):be?e.jsx(e.Fragment,{children:zt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(ns,{copy:t,currentCard:be,currentTypeLabel:re,prompt:E,languages:V,answer:me,onAnswerChange:B=>Se(le=>gn(le,B,z)),computedExpected:W,computedAnswers:ce,onComputedAnswerChange:(B,le)=>ve(we=>({...we,[B]:gn(we[B]??"",le,z)})),answerTemplate:He,outputVariables:Ce,variableValues:kt,computedFieldFeedback:Me,feedback:Je,canAdvance:et,quoteContext:O,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:_a,onSkip:sa,onLanguageSelect:Tn,onMarkReviewed:La,onAdvance:Jt,showCorrectAnswer:N,setShowCorrectAnswer:C,onRevealCorrect:()=>Qe(!0),answerMask:Y,expectedAnswer:M,hasExpectedAnswer:ga,handleComputedKeyDown:Cn,answerInputRef:fe,computedInputRefs:ze,scriptMode:z,setScriptMode:F,matchPairs:De==null?void 0:De.pairs,matchLeftOrder:De==null?void 0:De.leftOrder,matchRightOrder:De==null?void 0:De.rightOrder,matchSelection:De==null?void 0:De.selection,matchActiveLeft:De==null?void 0:De.activeLeft,matchActiveRight:De==null?void 0:De.activeRight,matchFeedback:gt,onMatchLeftSelect:Ka,onMatchRightSelect:Nn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Ze?`${ut} / ${Ze}`:t.cogita.library.revision.progressUnlimited}),c==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),c==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),c==="ready"&&Q==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),c==="ready"&&Q==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),c==="ready"&&Q==="ready"&&y.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:In}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",pt]})]})]}),ea?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",ea.activeCount," / ",ea.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:ea.counts.map((B,le)=>{const we=le+1,Fe=ea.currentLevel===we,Ke=ea.percentages[le]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":Fe,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:we}),e.jsx("strong",{children:B})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,Ke))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[Ke.toFixed(1),"%"]})]},`level-${we}`)})})]}):null,ja?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:ja.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:ja.dots.map(B=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-B.value))}, ${Math.round(200*B.value)}, 80, 0.9)`}},B.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:ja.knownCount})]})]}):null,Nt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Ga})]})}):null]})]})]})})})]})]})}const zo=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:To},Symbol.toStringTag,{value:"Module"})),la=t=>String(t??"").trim().toLocaleLowerCase(),pn=t=>Array.from(new Set(t.map(a=>Number(a)).filter(Number.isFinite))).sort((a,s)=>a-s),Os=t=>t.map(a=>a.join(",")).sort().join("|");function Co(t){const a=[...t];for(let s=a.length-1;s>0;s-=1){const r=Math.floor(Math.random()*(s+1));[a[s],a[r]]=[a[r],a[s]]}return a}function qs(t){const a=t.map((i,u)=>({value:i,oldIndex:u}));for(let i=a.length-1;i>0;i-=1){const u=Math.floor(Math.random()*(i+1));[a[i],a[u]]=[a[u],a[i]]}const s=a.map(i=>i.value),r=new Map;return a.forEach((i,u)=>r.set(i.oldIndex,u)),{values:s,oldToNew:r}}function Io(t){const a=t.split("↔").map(s=>s.trim()).filter(Boolean);return a.length>=2?[a[0],a[1]]:null}function Mo(t){if(!t)return null;const a=t.indexOf(":");return a>=0?t.slice(a+1).trim():t.trim()}function Lo(t,a,s,r){const i=typeof s.type=="string"?s.type:"",u=typeof s.title=="string"&&s.title.trim()?s.title.trim():a,l=typeof s.question=="string"?s.question:a;if(!i||!l)return null;if(i==="selection"){const b=Array.isArray(s.options)?s.options.filter(p=>typeof p=="string"):[],m=Array.isArray(s.answer)?pn(s.answer):[],x=qs(b),d=m.map(p=>x.oldToNew.get(p)).filter(p=>Number.isInteger(p)).sort((p,o)=>p-o);return{roundIndex:r,cardKey:`info:${t}:question-selection`,publicPrompt:{kind:"selection",title:u,prompt:l,options:x.values,multiple:!0,cardLabel:"question"},reveal:{kind:"selection",expected:d,title:u},grade:p=>{const o=Array.isArray(p)?pn(p):[];return JSON.stringify(o)===JSON.stringify(d)}}}if(i==="truefalse"){const b=!!s.answer;return{roundIndex:r,cardKey:`info:${t}:question-truefalse`,publicPrompt:{kind:"boolean",title:u,prompt:l,cardLabel:"question"},reveal:{kind:"boolean",expected:b,title:u},grade:m=>!!m===b}}if(i==="text"||i==="number"||i==="date"){const b=String(s.answer??"");return{roundIndex:r,cardKey:`info:${t}:question-${i}`,publicPrompt:{kind:"text",title:u,prompt:l,inputType:i==="number"?"number":i==="date"?"date":"text",cardLabel:"question"},reveal:{kind:"text",expected:b,title:u},grade:m=>{if(i==="number"){const x=Number(m),d=Number(b);return Number.isFinite(x)&&Number.isFinite(d)&&Math.abs(x-d)<1e-9}return la(m)===la(b)}}}if(i==="ordering"){const b=Array.isArray(s.options)?s.options.filter(x=>typeof x=="string"):[],m=Co(b);return{roundIndex:r,cardKey:`info:${t}:question-ordering`,publicPrompt:{kind:"ordering",title:u,prompt:l,options:m,cardLabel:"question"},reveal:{kind:"ordering",expected:b,title:u},grade:x=>JSON.stringify(Array.isArray(x)?x.map(String):[])===JSON.stringify(b)}}if(i==="matching"){const m=(Array.isArray(s.columns)?s.columns.map(o=>Array.isArray(o)?o.filter(c=>typeof c=="string"):[]):[]).map(o=>qs(o)),x=s.answer??{},p=(Array.isArray(x.paths)?x.paths.map(o=>Array.isArray(o)?o.map(c=>Number(c)).filter(Number.isFinite):null).filter(o=>Array.isArray(o)):[]).map(o=>o.map((c,j)=>{var h;return((h=m[j])==null?void 0:h.oldToNew.get(c))??c}));return{roundIndex:r,cardKey:`info:${t}:question-matching`,publicPrompt:{kind:"matching",title:u,prompt:l,columns:m.map(o=>o.values),cardLabel:"question"},reveal:{kind:"matching",expected:{paths:p},title:u},grade:o=>{const c=o??{},j=Array.isArray(c.paths)?c.paths.map(h=>Array.isArray(h)?h.map(k=>Number(k)).filter(Number.isFinite):null).filter(h=>Array.isArray(h)):[];return Os(j)===Os(p)}}}return null}async function Ao(t){var p,o;const a=await as({libraryId:t.libraryId,revisionId:t.revisionId}),r=(await Ja({libraryId:t.libraryId,collectionId:a.collectionId,limit:1e3})).items,i=Array.from(new Set(r.filter(c=>c.cardType==="info").map(c=>c.cardId))),u=new Map;await Promise.all(i.map(async c=>{try{const j=await aa({libraryId:t.libraryId,infoId:c});u.set(c,{infoType:j.infoType,payload:j.payload})}catch{}}));const l=new Map;await Promise.all(Array.from(u.entries()).filter(([,c])=>c.infoType==="computed").map(async([c])=>{try{const j=await Jn({libraryId:t.libraryId,infoId:c});l.set(c,j)}catch{}}));const b=Array.from(new Set(r.filter(c=>c.cardType==="vocab").map(c=>c.label))).filter(Boolean),m={selectMatchingPairPrompt:((p=t.labels)==null?void 0:p.selectMatchingPairPrompt)??"Select the matching pair",wordLanguagePromptPrefix:((o=t.labels)==null?void 0:o.wordLanguagePromptPrefix)??"Language of"},x=[],d=new Set;for(const c of r){if(c.cardType==="vocab"){const h=Io(c.label);if(!h)continue;if(c.checkType==="translation"&&c.direction==="a-to-b"){const[k,L]=h;x.push({roundIndex:x.length,cardKey:`connection:${c.cardId}:translation:a-to-b`,publicPrompt:{kind:"text",title:c.label,prompt:k,cardLabel:c.description??void 0},reveal:{kind:"text",expected:L,title:c.label},grade:v=>la(v)===la(L)})}else if(c.checkType==="translation"&&c.direction==="b-to-a"){const[k,L]=h;x.push({roundIndex:x.length,cardKey:`connection:${c.cardId}:translation:b-to-a`,publicPrompt:{kind:"text",title:c.label,prompt:L,cardLabel:c.description??void 0},reveal:{kind:"text",expected:k,title:c.label},grade:v=>la(v)===la(k)})}else if(c.checkType==="translation-match"){const k=Array.from(new Set([c.label,...b.filter(v=>v!==c.label).slice(0,3)])),L=k.findIndex(v=>v===c.label);x.push({roundIndex:x.length,cardKey:`connection:${c.cardId}:translation-match`,publicPrompt:{kind:"selection",title:c.label,prompt:m.selectMatchingPairPrompt,options:k,multiple:!1,cardLabel:c.description??void 0},reveal:{kind:"selection",expected:[L],title:c.label},grade:v=>{const y=Array.isArray(v)?pn(v):pn([v]);return y.length===1&&y[0]===L}})}continue}if(c.cardType!=="info")continue;const j=u.get(c.cardId);if(j){if(j.infoType==="word"&&c.checkType==="word-language"){const h=Mo(c.description);if(!h)continue;x.push({roundIndex:x.length,cardKey:`info:${c.cardId}:word-language:${c.direction??""}`,publicPrompt:{kind:"text",title:c.label,prompt:`${m.wordLanguagePromptPrefix}: ${c.label}`,cardLabel:"word-language"},reveal:{kind:"text",expected:h,title:c.label},grade:k=>la(k)===la(h)});continue}if(j.infoType==="computed"&&c.checkType==="computed"){const h=l.get(c.cardId);if(!h)continue;x.push({roundIndex:x.length,cardKey:`info:${c.cardId}:computed`,publicPrompt:{kind:"text",title:c.label,prompt:h.prompt,multiLine:!1,cardLabel:"computed"},reveal:{kind:"text",expected:h.expectedAnswer,title:c.label},grade:k=>la(k)===la(h.expectedAnswer)});continue}if(j.infoType==="question"){const h=j.payload,k=h.definition??h,L=Lo(c.cardId,c.label,k,x.length);L&&(L.roundIndex=x.length,x.push(L));continue}if(j.infoType==="citation"&&!d.has(c.cardId)){d.add(c.cardId);const h=j.payload,k=typeof h.text=="string"?h.text:"",L=typeof h.title=="string"&&h.title.trim()?h.title.trim():c.label;if(!k.trim())continue;const v=va(k,{minLen:7,maxLen:13});for(const y of v.order){const Z=v.nodes[y];if(!Z)continue;const V=vn(k,Z);x.push({roundIndex:x.length,cardKey:`info:${c.cardId}:quote-fragment:${y}`,publicPrompt:{kind:"citation-fragment",title:L,before:V.before,after:V.after,fragmentId:y,cardLabel:"quote-fragment"},reveal:{kind:"citation-fragment",expected:V.fragment,title:L},grade:w=>Sa(V.fragment,String(w??""),{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}).isCorrect})}continue}}}return x.map((c,j)=>({...c,roundIndex:j}))}function Ro(t){var E;const{libraryId:a,revisionId:s}=t,r=Pa(),i=t.copy.cogita.library.revision,u=i.live,[l,b]=n.useState(null),[m,x]=n.useState([]),[d,p]=n.useState("loading"),[o,c]=n.useState(null),j=`cogita.live.host.${a}.${s}`,h=l?m[l.currentRoundIndex]??null:null,k=l!=null&&l.status&&l.status!=="lobby"?l.currentPrompt??null:null,L=(l==null?void 0:l.currentReveal)??null,v=n.useMemo(()=>l!=null&&l.code&&typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision/${encodeURIComponent(l.code)}`:"",[l==null?void 0:l.code]),y=n.useMemo(()=>l!=null&&l.code&&typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision-screen/${encodeURIComponent(l.code)}`:"",[l==null?void 0:l.code]),Z=(l==null?void 0:l.status)==="finished"?"finished":l!=null&&l.status&&l.status!=="lobby"?"active":"lobby",V=(D,M)=>D.replace(/\{(\w+)\}/g,(G,O)=>String(M[O]??"")),w={lobby:u.statusLobby,running:u.statusRunning,revealed:u.statusRevealed,finished:u.statusFinished},Q=(D,M,G)=>({...D,hostSecret:D.hostSecret||(M==null?void 0:M.hostSecret)||(G==null?void 0:G.hostSecret)||"",code:D.code||(M==null?void 0:M.code)||(G==null?void 0:G.code)||""});n.useEffect(()=>{let D=!1;return Ao({libraryId:a,revisionId:s,labels:{selectMatchingPairPrompt:u.selectMatchingPairPrompt,wordLanguagePromptPrefix:u.wordLanguagePromptPrefix}}).then(M=>{D||x(M)}).catch(()=>{D||(c(u.loadRoundsError),p("error"))}),()=>{D=!0}},[a,u.selectMatchingPairPrompt,u.wordLanguagePromptPrefix,s]),n.useEffect(()=>{let D=!1;async function M(){try{const G=new URLSearchParams(r.search),O=G.get("sessionId"),K=G.get("hostSecret"),W=G.get("code");if(!!(O&&K)&&O&&K){const ve=await ms({libraryId:a,sessionId:O,hostSecret:K});if(D)return;const Me=Q(ve,null,{hostSecret:K,code:W??void 0});b(Me),typeof localStorage<"u"&&localStorage.setItem(j,JSON.stringify({sessionId:Me.sessionId,hostSecret:Me.hostSecret,code:Me.code})),p("ready");return}const ce=await Hr({libraryId:a,revisionId:s,title:u.hostKicker});if(D)return;b(ce),localStorage.setItem(j,JSON.stringify({sessionId:ce.sessionId,hostSecret:ce.hostSecret,code:ce.code})),p("ready")}catch{if(D)return;c(u.createSessionError),p("error")}}return M(),()=>{D=!0}},[a,u.hostKicker,r.search,s,j]),n.useEffect(()=>{if(!l)return;const D=window.setInterval(async()=>{try{const M=await ms({libraryId:a,sessionId:l.sessionId,hostSecret:l.hostSecret});b(G=>Q(M,G))}catch{}},1200);return()=>window.clearInterval(D)},[a,l]);const S=async D=>{if(!l)return;const M=Object.prototype.hasOwnProperty.call(D,"currentPrompt"),G=Object.prototype.hasOwnProperty.call(D,"currentReveal"),O=await Gr({libraryId:a,sessionId:l.sessionId,hostSecret:l.hostSecret,status:D.status??l.status,currentRoundIndex:D.currentRoundIndex??l.currentRoundIndex,revealVersion:D.revealVersion??l.revealVersion,currentPrompt:M?D.currentPrompt??null:l.currentPrompt??null,currentReveal:G?D.currentReveal??null:l.currentReveal??null});b(K=>Q(O,K))},te=async D=>{const M=m[D];!M||!l||await S({status:"running",currentRoundIndex:D,revealVersion:l.revealVersion+1,currentReveal:null,currentPrompt:{...M.publicPrompt,roundIndex:D,cardKey:M.cardKey}})},T=async()=>{m.length&&await te((l==null?void 0:l.currentRoundIndex)??0)},$=async()=>{if(!l||!h)return;const D=new Map(l.currentRoundAnswers.map(O=>[O.participantId,O.answer])),M=l.participants.map(O=>{const K=D.get(O.participantId),W=h.grade(K);return{participantId:O.participantId,isCorrect:W,pointsAwarded:W?1:0}}),G=await Qr({libraryId:a,sessionId:l.sessionId,hostSecret:l.hostSecret,scores:M});b(O=>Q(G,O)),await S({status:"revealed",revealVersion:G.revealVersion+1,currentReveal:h.reveal})},oe=async()=>{if(!l)return;const D=l.currentRoundIndex+1;if(D>=m.length){await S({status:"finished",currentReveal:null});return}await te(D)},me=async()=>{if(l){if(l.status==="running"){await $();return}if(l.status==="revealed"){await oe();return}l.status==="lobby"&&await T()}},Se=async D=>{if(l!=null&&l.hostSecret)try{const M=await Wr({libraryId:a,sessionId:l.sessionId,hostSecret:l.hostSecret,requestId:D});b(G=>Q(M,G))}catch{}},Je=async()=>{if(l)try{const D=await ar({libraryId:a,sessionId:l.sessionId});b(D),typeof localStorage<"u"&&localStorage.setItem(j,JSON.stringify({sessionId:D.sessionId,hostSecret:D.hostSecret,code:D.code}))}catch{}},pe=(D,M)=>{if(!D)return e.jsx("p",{className:"cogita-help",children:u.waitingForHostQuestion});const G=String(D.kind??""),O=typeof M<"u",K=Array.isArray(M)?M.map(W=>Number(W)).filter(Number.isFinite):[];if(G==="citation-fragment")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":O?"correct":"idle",children:[e.jsxs("p",{children:[e.jsx("span",{style:{opacity:.7},children:String(D.before??"")}),e.jsx("strong",{children:" [ ... ] "}),e.jsx("span",{style:{opacity:.7},children:String(D.after??"")})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:O?u.correctFragmentLabel:u.fragmentLabel}),e.jsx("input",{readOnly:!0,value:O?String(M??""):"",placeholder:u.participantAnswerPlaceholder})]})]});if(G==="text")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":O?"correct":"idle",children:[e.jsx("p",{children:String(D.prompt??"")}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:O?i.correctAnswerLabel:i.answerLabel}),e.jsx("input",{readOnly:!0,value:O?String(M??""):"",placeholder:u.participantAnswerPlaceholder})]})]});if(G==="boolean"){const W=!!M;return e.jsxs("div",{className:"cogita-live-card-surface","data-state":O?"correct":"idle",children:[e.jsx("p",{children:String(D.prompt??"")}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:`cta ghost ${O&&W?"live-correct-answer":""}`,disabled:!0,children:u.trueLabel}),e.jsx("button",{type:"button",className:`cta ghost ${O&&!W?"live-correct-answer":""}`,disabled:!0,children:u.falseLabel})]})]})}if(G==="selection"){const W=Array.isArray(D.options)?D.options.map(String):[],U=!!D.multiple;return e.jsxs("div",{className:"cogita-live-card-surface","data-state":O?"correct":"idle",children:[e.jsx("p",{children:String(D.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:W.map((ce,ve)=>e.jsxs("label",{className:"cogita-share-row","data-state":O&&K.includes(ve)?"correct":void 0,children:[e.jsx("span",{children:ce}),e.jsx("input",{type:U?"checkbox":"radio",disabled:!0,checked:O?K.includes(ve):!1,readOnly:!0})]},`${ve}-${ce}`))})]})}if(G==="ordering"){const W=Array.isArray(O?M:D.options)?(O?M:D.options).map(String):[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":O?"correct":"idle",children:[e.jsx("p",{children:String(D.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:W.map((U,ce)=>e.jsxs("div",{className:"cogita-share-row","data-state":O?"correct":void 0,children:[e.jsx("span",{children:U}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:!0,children:"↑"}),e.jsx("button",{type:"button",className:"ghost",disabled:!0,children:"↓"})]})]},`${ce}-${U}`))})]})}if(G==="matching"){const W=Array.isArray(D.columns)?D.columns:[],U=(M==null?void 0:M.paths)??[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":O?"correct":"idle",children:[e.jsx("p",{children:String(D.prompt??"")}),O?e.jsx("div",{className:"cogita-share-list",children:U.map((ce,ve)=>e.jsx("div",{className:"cogita-share-row","data-state":"correct",children:e.jsx("span",{children:ce.map((Me,Ie)=>{const He=Array.isArray(W[Ie])?W[Ie]:[],it=String(He[Me]??Me);return`${Ie>0?" → ":""}${it}`})})},`path-${ve}`))}):e.jsx("div",{className:"cogita-form-actions",children:W.map((ce,ve)=>e.jsx("select",{disabled:!0,children:(Array.isArray(ce)?ce:[]).map((Me,Ie)=>e.jsx("option",{children:String(Me)},`${ve}-${Ie}`))},`host-col-${ve}`))})]})}return e.jsx("p",{className:"cogita-help",children:u.unsupportedPromptType})};return e.jsx($t,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":Z,children:[e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:u.hostKicker}),e.jsx("h2",{className:"cogita-detail-title",children:u.hostTitle}),d==="loading"?e.jsx("p",{children:u.loading}):null,o?e.jsx("p",{className:"cogita-help",children:o}):null,l?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:u.joinCodeLabel}),e.jsx("input",{readOnly:!0,value:l.code})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:u.joinUrlLabel}),e.jsx("input",{readOnly:!0,value:v})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Presenter URL"}),e.jsx("input",{readOnly:!0,value:y})]}),v?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:u.qrLabel}),e.jsx("div",{style:{display:"inline-flex",padding:"0.75rem",borderRadius:"12px",background:"#fff"},children:e.jsx(Js,{value:v,size:176,marginSize:2})})]}):null,e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:u.statusLabel}),e.jsx("input",{readOnly:!0,value:w[l.status]??l.status})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:T,disabled:!m.length,children:u.publishCurrentRound}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Je,children:"Refresh links"})]}),e.jsx("p",{className:"cogita-help",children:V(u.roundsLabel,{count:m.length})})]}):null]}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:u.currentRoundTitle}),e.jsx("h3",{className:"cogita-detail-title",children:k&&typeof k.title=="string"?k.title:(l==null?void 0:l.status)==="lobby"?u.sessionNotStarted:u.waitingForPublishedRound}),(l==null?void 0:l.status)==="lobby"?e.jsx("p",{className:"cogita-help",children:u.hiddenBeforeStart}):e.jsx(Ea,{className:"cogita-live-card-container",feedbackToken:L?`correct-${(l==null?void 0:l.revealVersion)??0}`:"idle",children:pe(k,L==null?void 0:L.expected)}),Z!=="lobby"?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:me,disabled:!m.length||!h||l.status==="finished",children:l.status==="revealed"?i.nextQuestion:i.checkAnswer})}):null,Z!=="finished"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:u.participantsTitle}),e.jsxs("div",{className:"cogita-share-list",children:[l==null?void 0:l.participants.map(D=>{const M=l.currentRoundAnswers.find(G=>G.participantId===D.participantId);return e.jsx("div",{className:"cogita-share-row",children:e.jsxs("div",{children:[e.jsx("strong",{children:D.displayName}),e.jsxs("div",{className:"cogita-share-meta",children:[M?u.answerStatusAnswered:u.answerStatusWaiting,(M==null?void 0:M.isCorrect)===!0?` · ${u.answerStatusCorrect}`:"",(M==null?void 0:M.isCorrect)===!1?` · ${u.answerStatusIncorrect}`:""]})]})},D.participantId)}),l&&l.participants.length===0?e.jsx("p",{className:"cogita-help",children:u.noParticipants}):null]}),l&&(((E=l.pendingReloginRequests)==null?void 0:E.length)??0)>0?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Relogin requests"}),e.jsx("div",{className:"cogita-share-list",children:(l.pendingReloginRequests??[]).map(D=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsxs("div",{children:[e.jsx("strong",{children:D.displayName}),e.jsx("div",{className:"cogita-share-meta",children:new Date(D.requestedUtc).toLocaleTimeString()})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Se(D.requestId),children:"Allow relogin"})]},D.requestId))})]}):null]}):null]}),Z!=="lobby"?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:Z==="finished"?u.finalScoreTitle:u.pointsTitle}),e.jsx("div",{className:"cogita-share-list",children:((l==null?void 0:l.scoreboard)??[]).map(D=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:D.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[D.score," ",u.scoreUnit]})]},`score:${D.participantId}`))})]}):null]})})})})})}const Vo=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionHostPage:Ro},Symbol.toStringTag,{value:"Module"}));function Us(t){return`cogita.live.join.${t}`}function $o(t){const{code:a}=t,s=t.copy.cogita.library.revision,r=s.live,[i,u]=n.useState(""),[l,b]=n.useState(()=>typeof localStorage>"u"?null:localStorage.getItem(Us(a))),[m,x]=n.useState(null),[d,p]=n.useState("idle"),[o,c]=n.useState(""),[j,h]=n.useState([]),[k,L]=n.useState(null),[v,y]=n.useState([]),[Z,V]=n.useState([]),[w,Q]=n.useState(null),[S,te]=n.useState(!1),T=(m==null?void 0:m.currentPrompt)??null,$=(m==null?void 0:m.currentReveal)??null,oe=$==null?void 0:$.expected,me=(m==null?void 0:m.status)==="finished"?"finished":m!=null&&m.status&&m.status!=="lobby"?"active":"lobby",Se=n.useMemo(()=>`${(m==null?void 0:m.currentRoundIndex)??0}:${(m==null?void 0:m.revealVersion)??0}:${String((T==null?void 0:T.cardKey)??"")}`,[T==null?void 0:T.cardKey,m==null?void 0:m.currentRoundIndex,m==null?void 0:m.revealVersion]);n.useEffect(()=>{c(""),h([]),L(null),y(Array.isArray(T==null?void 0:T.options)?[...T.options??[]]:[]),V([])},[Se]),n.useEffect(()=>{let K=!0;const W=async()=>{try{const ce=await Hn({code:a,participantToken:l});if(!K)return;x(ce),l&&p("ready")}catch{K&&d!=="joining"&&p("error")}};W();const U=window.setInterval(W,1200);return()=>{K=!1,window.clearInterval(U)}},[a,l,d]),n.useEffect(()=>{if(!w||!S||l)return;let K=!1;const W=window.setInterval(async()=>{try{const U=await Yr({code:a,requestId:w});if(K)return;U.status==="approved"&&(te(!1),p("idle"))}catch{}},1200);return()=>{K=!0,window.clearInterval(W)}},[a,l,S,w]);const Je=async()=>{p("joining");try{const K=await Xr({code:a,name:i});b(K.participantToken),localStorage.setItem(Us(a),K.participantToken),te(!1),Q(null),p("ready")}catch(K){if(K instanceof ts&&K.status===409)try{const W=await Zr({code:a,name:i});Q(W.requestId),te(!0),p("ready");return}catch{p("error");return}p("error")}},pe=K=>{if(!!(T!=null&&T.multiple)){h(U=>U.includes(K)?U.filter(ce=>ce!==K):[...U,K].sort((ce,ve)=>ce-ve));return}h([K])},E=(K,W)=>{y(U=>{const ce=[...U],ve=K+W;return ve<0||ve>=ce.length?U:([ce[K],ce[ve]]=[ce[ve],ce[K]],ce)})},D=()=>{const K=Array.isArray(T==null?void 0:T.columns)?T.columns:[];V(W=>[...W,K.map(()=>0)])},M=(K,W,U)=>{V(ce=>ce.map((ve,Me)=>Me!==K?ve:ve.map((Ie,He)=>He===W?U:Ie)))},G=async()=>{if(!l||!T||typeof T.cardKey!="string")return;let K=null;switch(T.kind){case"selection":K=j;break;case"boolean":K=k;break;case"ordering":K=v;break;case"matching":K={paths:Z};break;case"citation-fragment":case"text":default:K=o;break}try{await ei({code:a,participantToken:l,roundIndex:Number(T.roundIndex??(m==null?void 0:m.currentRoundIndex)??0),cardKey:T.cardKey,answer:K});const W=await Hn({code:a,participantToken:l});x(W),p("ready")}catch{p("error")}},O=()=>{if(!T)return e.jsx("p",{className:"cogita-help",children:r.waitingForHostQuestion});const K=!!$,W=Array.isArray(oe)?oe.map(U=>Number(U)).filter(Number.isFinite):[];if(T.kind==="citation-fragment")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":K?"correct":"idle",children:[e.jsxs("p",{children:[e.jsx("span",{style:{opacity:.7},children:String(T.before??"")}),e.jsx("strong",{children:" [ ... ] "}),e.jsx("span",{style:{opacity:.7},children:String(T.after??"")})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:K?r.correctFragmentLabel:r.fragmentLabel}),e.jsx("input",{value:K?String(oe??""):o,onChange:U=>c(U.target.value),readOnly:K})]})]});if(T.kind==="text")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":K?"correct":"idle",children:[e.jsx("p",{children:String(T.prompt??"")}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:K?s.correctAnswerLabel:s.answerLabel}),e.jsx("input",{type:T.inputType==="number"?"number":T.inputType==="date"?"date":"text",value:K?String(oe??""):o,onChange:U=>c(U.target.value),readOnly:K})]})]});if(T.kind==="boolean"){const U=!!oe;return e.jsxs("div",{className:"cogita-live-card-surface","data-state":K?"correct":"idle",children:[e.jsx("p",{children:String(T.prompt??"")}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:`cta ghost ${K&&U?"live-correct-answer":""}`,onClick:()=>L(!0),disabled:K,children:r.trueLabel}),e.jsx("button",{type:"button",className:`cta ghost ${K&&!U?"live-correct-answer":""}`,onClick:()=>L(!1),disabled:K,children:r.falseLabel})]})]})}if(T.kind==="selection")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":K?"correct":"idle",children:[e.jsx("p",{children:String(T.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:(Array.isArray(T.options)?T.options:[]).map((U,ce)=>e.jsxs("label",{className:"cogita-share-row","data-state":K&&W.includes(ce)?"correct":void 0,children:[e.jsx("span",{children:U}),e.jsx("input",{type:T.multiple?"checkbox":"radio",name:"live-selection",checked:K?W.includes(ce):j.includes(ce),onChange:()=>pe(ce),disabled:K})]},`${ce}-${U}`))})]});if(T.kind==="ordering"){const U=Array.isArray(K?oe:v)?(K?oe:v).map(String):[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":K?"correct":"idle",children:[e.jsx("p",{children:String(T.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:U.map((ce,ve)=>e.jsxs("div",{className:"cogita-share-row","data-state":K?"correct":void 0,children:[e.jsx("span",{children:ce}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>E(ve,-1),disabled:K,children:"↑"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>E(ve,1),disabled:K,children:"↓"})]})]},`${ve}-${ce}`))})]})}if(T.kind==="matching"){const U=Array.isArray(T.columns)?T.columns:[],ce=(oe==null?void 0:oe.paths)??[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":K?"correct":"idle",children:[e.jsx("p",{children:String(T.prompt??"")}),K?e.jsx("div",{className:"cogita-share-list",children:ce.map((ve,Me)=>e.jsx("div",{className:"cogita-share-row","data-state":"correct",children:e.jsx("span",{children:ve.map((Ie,He)=>{const it=Array.isArray(U[He])?U[He]:[];return`${He>0?" → ":""}${String(it[Ie]??Ie)}`})})},`path-${Me}`))}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:D,children:r.addPathAction})}),Z.map((ve,Me)=>e.jsx("div",{className:"cogita-form-actions",children:U.map((Ie,He)=>e.jsx("select",{value:ve[He]??0,onChange:it=>M(Me,He,Number(it.target.value)),children:Ie.map((it,Ce)=>e.jsxs("option",{value:Ce,children:[Ce,": ",it]},`${He}-${Ce}`))},`path-${Me}-col-${He}`))},`path-${Me}`))]})]})}return e.jsx("p",{className:"cogita-help",children:r.unsupportedPromptType})};return e.jsx($t,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":me,children:[e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:r.joinKicker}),e.jsx("h2",{className:"cogita-detail-title",children:r.joinTitle}),l?e.jsx("p",{className:"cogita-help",children:r.joinedWaiting}):e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:r.participantNameLabel}),e.jsx("input",{value:i,onChange:K=>u(K.target.value)})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:Je,disabled:!i.trim()||d==="joining",children:d==="joining"?r.joiningAction:r.joinAction})})]}),S?e.jsx("p",{className:"cogita-help",children:"Relogin request sent. Wait for host approval and join again."}):null,d==="error"?e.jsx("p",{className:"cogita-help",children:r.connectionError}):null,me==="lobby"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:r.scoreboardTitle}),e.jsxs("div",{className:"cogita-share-list",children:[m==null?void 0:m.scoreboard.map(K=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:K.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[K.score," ",r.scoreUnit]})]},K.participantId)),m&&m.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:r.noParticipants}):null]})]}):null]}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:r.questionTitle}),e.jsx("h3",{className:"cogita-detail-title",children:typeof(T==null?void 0:T.title)=="string"?T.title:r.waitingForPublishedRound}),T?e.jsxs(e.Fragment,{children:[e.jsx(Ea,{className:"cogita-live-card-container",feedbackToken:$?`correct-${(m==null?void 0:m.revealVersion)??0}`:"idle",children:O()}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:G,disabled:!l||!T.cardKey||(m==null?void 0:m.answerSubmitted),children:m!=null&&m.answerSubmitted?r.submitted:r.submitAnswer})})]}):e.jsx("p",{className:"cogita-help",children:r.waitingForHostQuestion})]}),me!=="lobby"?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:me==="finished"?r.finalScoreTitle:r.pointsTitle}),e.jsxs("div",{className:"cogita-share-list",children:[m==null?void 0:m.scoreboard.map(K=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:K.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[K.score," ",r.scoreUnit]})]},`score:${K.participantId}`)),m&&m.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:r.noParticipants}):null]})]}):null]})})})})})}const Oo=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionJoinPage:$o},Symbol.toStringTag,{value:"Module"}));function Po(t){const{code:a}=t,s=t.copy.cogita.library.revision.live,[r,i]=n.useState(null),[u,l]=n.useState("loading"),b=(r==null?void 0:r.currentPrompt)??null,m=(r==null?void 0:r.currentReveal)??null,x=m==null?void 0:m.expected,d=n.useMemo(()=>typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision/${encodeURIComponent(a)}`:"",[a]);n.useEffect(()=>{let o=!0;const c=async()=>{try{const h=await Hn({code:a});if(!o)return;i(h),l("ready")}catch{if(!o)return;l("error")}};c();const j=window.setInterval(c,1200);return()=>{o=!1,window.clearInterval(j)}},[a]);const p=()=>{if(!b)return e.jsx("p",{className:"cogita-help",children:s.waitingForHostQuestion});const o=String(b.kind??""),c=!!m,j=Array.isArray(x)?x.map(h=>Number(h)).filter(Number.isFinite):[];if(o==="citation-fragment")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":c?"correct":"idle",children:[e.jsxs("p",{children:[e.jsx("span",{style:{opacity:.7},children:String(b.before??"")}),e.jsx("strong",{children:" [ ... ] "}),e.jsx("span",{style:{opacity:.7},children:String(b.after??"")})]}),c?e.jsx("p",{children:String(x??"")}):null]});if(o==="text")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":c?"correct":"idle",children:[e.jsx("p",{children:String(b.prompt??"")}),c?e.jsx("p",{children:String(x??"")}):null]});if(o==="boolean"){const h=!!x;return e.jsxs("div",{className:"cogita-live-card-surface","data-state":c?"correct":"idle",children:[e.jsx("p",{children:String(b.prompt??"")}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:`cta ghost ${c&&h?"live-correct-answer":""}`,disabled:!0,children:s.trueLabel}),e.jsx("button",{type:"button",className:`cta ghost ${c&&!h?"live-correct-answer":""}`,disabled:!0,children:s.falseLabel})]})]})}if(o==="selection")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":c?"correct":"idle",children:[e.jsx("p",{children:String(b.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:(Array.isArray(b.options)?b.options:[]).map((h,k)=>e.jsxs("label",{className:"cogita-share-row","data-state":c&&j.includes(k)?"correct":void 0,children:[e.jsx("span",{children:h}),e.jsx("input",{type:b.multiple?"checkbox":"radio",disabled:!0,checked:c?j.includes(k):!1,readOnly:!0})]},`${k}-${h}`))})]});if(o==="ordering"){const h=Array.isArray(c?x:b.options)?(c?x:b.options).map(String):[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":c?"correct":"idle",children:[e.jsx("p",{children:String(b.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:h.map((k,L)=>e.jsx("div",{className:"cogita-share-row","data-state":c?"correct":void 0,children:e.jsx("span",{children:k})},`${L}-${k}`))})]})}if(o==="matching"){const h=Array.isArray(b.columns)?b.columns:[],k=(x==null?void 0:x.paths)??[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":c?"correct":"idle",children:[e.jsx("p",{children:String(b.prompt??"")}),c?e.jsx("div",{className:"cogita-share-list",children:k.map((L,v)=>e.jsx("div",{className:"cogita-share-row","data-state":"correct",children:e.jsx("span",{children:L.map((y,Z)=>{const V=Array.isArray(h[Z])?h[Z]:[],w=String(V[y]??y);return`${Z>0?" -> ":""}${w}`})})},`path-${v}`))}):null]})}return e.jsx("p",{className:"cogita-help",children:s.unsupportedPromptType})};return e.jsx($t,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":(r==null?void 0:r.status)==="lobby"?"lobby":"active",children:[e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:s.hostKicker}),e.jsx("h2",{className:"cogita-detail-title",children:u==="error"?s.connectionError:s.statusLobby}),(r==null?void 0:r.status)==="lobby"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:s.joinCodeLabel}),e.jsx("input",{readOnly:!0,value:a})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:s.joinUrlLabel}),e.jsx("input",{readOnly:!0,value:d})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:s.qrLabel}),e.jsx("div",{style:{display:"inline-flex",padding:"0.75rem",borderRadius:"12px",background:"#fff"},children:e.jsx(Js,{value:d,size:176,marginSize:2})})]})]}):e.jsx(Ea,{className:"cogita-live-card-container",feedbackToken:m?`correct-${(r==null?void 0:r.revealVersion)??0}`:"idle",children:p()})]}),e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:(r==null?void 0:r.status)==="finished"?s.finalScoreTitle:s.pointsTitle}),e.jsxs("div",{className:"cogita-share-list",children:[((r==null?void 0:r.scoreboard)??[]).map(o=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:o.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[o.score," ",s.scoreUnit]})]},`presenter-score:${o.participantId}`)),r&&r.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:s.noParticipants}):null]})]})]})})})})})}const qo=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionPresenterPage:Po},Symbol.toStringTag,{value:"Module"}));function Eo(t){const a=Wa(),s=t.copy.cogita.library.revision.live,{libraryId:r}=t,[i,u]=n.useState([]),[l,b]=n.useState("loading"),[m,x]=n.useState(null),[d,p]=n.useState({}),o=n.useMemo(()=>({lobby:s.statusLobby,running:s.statusRunning,revealed:s.statusRevealed,finished:s.statusFinished}),[s.statusFinished,s.statusLobby,s.statusRevealed,s.statusRunning]),c=async()=>{b("loading");try{const h=await ti({libraryId:r});u(h),b("ready")}catch{u([]),b("error")}};n.useEffect(()=>{c()},[r]);const j=async(h,k)=>{x(h.sessionId);try{const L=d[h.sessionId]??await ar({libraryId:r,sessionId:h.sessionId});d[h.sessionId]||p(Z=>({...Z,[h.sessionId]:{sessionId:L.sessionId,code:L.code,hostSecret:L.hostSecret}}));const v=encodeURIComponent(L.code);if(k==="host"){a(`/cogita/live-revision-host/${encodeURIComponent(r)}/${encodeURIComponent(h.revisionId)}?sessionId=${encodeURIComponent(L.sessionId)}&hostSecret=${encodeURIComponent(L.hostSecret)}&code=${v}`);return}const y=k==="presenter"?`${window.location.origin}/#/cogita/public/live-revision-screen/${v}`:`${window.location.origin}/#/cogita/public/live-revision/${v}`;window.open(y,"_blank","noopener")}finally{x(null)}};return e.jsx($t,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("div",{className:"cogita-detail-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:s.hostKicker}),e.jsx("h2",{className:"cogita-detail-title",children:"Active live sessions"})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:c,children:"Refresh"})})]}),l==="loading"?e.jsx("p",{children:s.loading}):null,l==="error"?e.jsx("p",{className:"cogita-help",children:s.connectionError}):null,l==="ready"&&i.length===0?e.jsx("p",{className:"cogita-help",children:"No active sessions."}):null,e.jsx("div",{className:"cogita-share-list",children:i.map(h=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsxs("div",{children:[e.jsx("strong",{children:h.title||h.sessionId}),e.jsxs("div",{className:"cogita-share-meta",children:[o[h.status]??h.status," · ",s.participantsTitle,": ",h.participantCount]})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>j(h,"host"),disabled:m===h.sessionId,children:"Host"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>j(h,"presenter"),disabled:m===h.sessionId,children:"Screen"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>j(h,"login"),disabled:m===h.sessionId,children:"Login panel"})]})]},h.sessionId))})]})})})})})}const Uo=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveSessionsPage:Eo},Symbol.toStringTag,{value:"Module"}));export{Do as C,Bo as a,zo as b,Vo as c,Oo as d,qo as e,Uo as f};
