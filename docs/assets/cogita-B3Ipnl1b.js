import{r as a,j as e,u as ss,a as Oa,b as rs,c as is,d as os,R as xn,B as vn,C as wn}from"./vendor-CL5v9b84.js";import{L as ls,A as cs,g as ds,a as Rs,b as ja,c as us,s as $n,d as jn,e as Es,f as Rn,h as Qt,i as As,j as hs,k as ms,l as gs,m as kn,n as fn,o as Ps,u as Ks,p as ps,q as Fs,r as zs,t as Ds,v as Bs,w as _s,x as fs,y as bs,z as Vs,B as Os,C as qa,D as Ra,E as qs,F as Us,G as ys,H as Js,I as Hs,J as Ws,K as En,M as Yt,N as Gs,O as Ys,P as Qs,Q as Zs,R as Xs,S as er,T as tr,U as ar,V as nr,W as sr,X as rr,Y as ir,Z as or,_ as lr,$ as cr,a0 as dr,a1 as An}from"./recreatio-core-CZDtV1fy.js";import"./vendor-cogita-ui-mbCyoqV0.js";const va={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},ya={moveMs:900,pauseMs:220,errorMs:900},ur=(t=11)=>{let n=t;const s=()=>(n=(n*1664525+1013904223)%4294967296,n/4294967296),{width:r,height:i,paddingX:g,paddingY:h,levels:f}=va,C=(i-h*2)/(f.length-1),M=[],c=[],x=[];f.forEach((p,u)=>{const ue=i-h-u*C,P=r-g*2,y=[];for(let H=0;H<p;H+=1){const F=g+(H+1)*P/(p+1),X=(s()-.5)*18,E=Math.max(g,Math.min(r-g,F+X)),K=u===0?3:u<2?2.1:1.4,ce=u===0?"root":`l${u}-${H}`;y.push({id:ce,x:u===0?r/2:E,y:ue,r:K,level:u,role:u===0?"root":void 0})}x.push(y),M.push(...y)});const l=x[x.length-1];if(l!=null&&l.length){const p=l[Math.floor(l.length/2)];p.role="goal",p.r=2}for(let p=1;p<x.length;p+=1){const u=x[p-1];x[p].forEach(P=>{const y=[...u].sort((E,K)=>Math.abs(E.x-P.x)-Math.abs(K.x-P.x)),H=y[0],F=y[1]&&s()<.45?y[1]:null;(F?[H,F]:[H]).forEach(E=>{c.push({from:E.id,to:P.id,key:`${E.id}-${P.id}`})}),s()<.2&&y[2]&&c.push({from:y[2].id,to:P.id,key:`${y[2].id}-${P.id}`})})}const m=new Map;c.forEach(p=>{const u=m.get(p.to)??[];u.push(p.from),m.set(p.to,u)});const v=new Map,S=new Map,L=new Map;c.forEach(p=>{const u=v.get(p.from)??[];u.push(p.key),v.set(p.from,u);const ue=S.get(p.from)??[];ue.push(p.to),S.set(p.from,ue);const P=L.get(p.from)??[];P.push(p.to),L.set(p.from,P);const y=L.get(p.to)??[];y.push(p.from),L.set(p.to,y)});const D=new Map;return M.forEach(p=>{D.set(p.id,p)}),{nodes:M,links:c,parentsById:m,linksByFrom:v,childrenByFrom:S,neighborsById:L,nodesById:D}};function hr({slides:t,activeIndex:n,introOpen:s,prefersReducedMotion:r,onNext:i,onPrev:g,onSelect:h,onExit:f,onOpen:C,onRegister:M}){const c=n===t.length-1,x=s&&n===0?"entry":"docked",l=t[t.length-1],[m,v]=a.useState(!1),S=a.useMemo(()=>Array.from({length:20},(w,Z)=>({src:`/cogita/logo/Cogita${String(Z).padStart(2,"0")}.png`,kind:Z<=11?"bubble":Z<=17?"text":"recreatio"})),[]),L=s&&n===0;a.useEffect(()=>{if(!s){v(!1);return}n>0&&!m&&v(!0)},[n,s,m]);const D=a.useRef(0),p=a.useRef(null),u=a.useMemo(()=>{const w={x:40,y:160},Z={x:260,y:48},de=6,T=Z.x-w.x,I=w.y-Z.y,O=T/de,ae=[.3,.45,.6,.65,1.4,2.2],ne=ae.reduce((pe,he)=>pe+he,0),we=ae.map(pe=>I*pe/ne),Ce=[w];let Ke=w.x,ie=w.y;for(let pe=1;pe<=de;pe+=1){const he=(Math.random()-.5)*14,at=(Math.random()-.5)*28;Ke=Math.max(w.x+pe*14,Math.min(Z.x-(de-pe)*14,Ke+O+he));const Je=we[pe-1]??we[we.length-1];ie=ie-Je+at;const Ye=Math.max(Z.y,Math.min(w.y-4,ie));Ce.push({x:Math.round(Ke),y:Math.round(Ye)})}return Ce[Ce.length-1]=Z,Ce},[]),ue=a.useMemo(()=>{const I=(ne,we,Ce)=>Math.min(Ce,Math.max(we,ne)),O=u.map(ne=>{const we=10+Math.random()*36;return{x:I(ne.x,40,260),y:I(ne.y-we,40,140)}}),ae=u.map((ne,we)=>{var ie;const Ce=12+Math.random()*40,Ke=((ie=O[we])==null?void 0:ie.y)??ne.y;return{x:I(ne.x,40,260),y:I(Math.max(Ke+10,ne.y+Ce),60,170)}});return{upper:O,lower:ae}},[u]),P=a.useMemo(()=>{var Z;const w=((Z=u[4])==null?void 0:Z.x)??260;return Math.max(0,Math.min(240,w-40))},[u]),y=a.useMemo(()=>{var we,Ce;const w=(Ke,ie,pe)=>Math.min(pe,Math.max(ie,Ke)),Z=(Ke,ie,pe)=>u.map((he,at)=>{var Ct,dt;const Je=((Ct=ue.upper[at])==null?void 0:Ct.y)??he.y,Ye=((dt=ue.lower[at])==null?void 0:dt.y)??he.y,ct=(Math.random()-.5)*70,yt=he.y+Ke+ct,We=w(he.y+ie,Je+6,Ye-6),Ge=w(he.y+pe,Je+6,Ye-6);return{x:he.x,y:w(yt,Math.min(We,Ge),Math.max(We,Ge))}}),de=-14+Math.random()*28,T=14+Math.random()*28,I=Z(de,-80,12),O=Z(T,-12,80);for(let Ke=4;Ke<u.length;Ke+=1){const ie=u[Ke],pe=((we=ue.upper[Ke])==null?void 0:we.y)??ie.y,he=((Ce=ue.lower[Ke])==null?void 0:Ce.y)??ie.y;I[Ke]={x:ie.x,y:w(ie.y-12,pe+6,he-6)},O[Ke]={x:ie.x,y:w(ie.y+12,pe+6,he-6)}}const ae=ue.upper.length?ue.upper[ue.upper.length-1].y:40,ne=ue.lower.length?ue.lower[ue.lower.length-1].y:170;return I[I.length-1]={x:u[u.length-1].x,y:w(u[u.length-1].y-14,ae,ne)},O[O.length-1]={x:u[u.length-1].x,y:w(u[u.length-1].y+12,ae,ne)},{higher:I,lower:O}},[u,ue]),H=1e4,F=a.useMemo(()=>{let w=17;const Z=()=>(w=(w*1664525+1013904223)%4294967296,w/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((T,I)=>{const O=(Z()-.5)*240,ae=(Z()-.5)*180,ne=(Z()-.5)*24;return{id:`card-${I+1}`,throw:{x:`${O.toFixed(0)}px`,y:`${ae.toFixed(0)}px`,rot:`${ne.toFixed(1)}deg`},grid:{x:`${T.x}px`,y:`${T.y}px`},delay:`${I*.12}s`}})},[]),X=a.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[E,K]=a.useState([]),ce=a.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),ge=a.useMemo(()=>{const Z=[],T=(O,ae)=>O+Math.random()*(ae-O);for(let O=0;O<6;O+=1){let ae=!1;for(let ne=0;ne<80;ne+=1){const we=T(14,86),Ce=T(10,34);if(Z.every(ie=>{const pe=ie.x-we,he=ie.y-Ce;return Math.hypot(pe,he)>=12})){Z.push({x:we,y:Ce}),ae=!0;break}}ae||Z.push({x:T(16,84),y:T(12,32)})}return Z.map((O,ae)=>({id:`p${ae+1}`,x:`${O.x.toFixed(1)}%`,y:`${O.y.toFixed(1)}%`,xNum:O.x,yNum:O.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[be,Be]=a.useState(0),[ye,$]=a.useState(0),[ve,G]=a.useState([]),ee=1e4,Le=a.useMemo(()=>{if(ge.length<2)return[];const w=ae=>{let ne=ae+1831565813;return ne=Math.imul(ne^ne>>>15,ne|1),ne^=ne+Math.imul(ne^ne>>>7,ne|61),((ne^ne>>>14)>>>0)/4294967296},Z=(ae,ne)=>Math.floor(w(ae)*ne),de=new Set,T=[],I=Math.min(3,ge.length);let O=0;for(;T.length<I&&O<30;){O+=1;const ae=Z(be*13+O*5,ge.length),ne=Z(be*29+O*7,ge.length);if(ae===ne)continue;const we=ae<ne?`${ae}-${ne}`:`${ne}-${ae}`;de.has(we)||(de.add(we),T.push({id:`link-${we}`,from:ge[ae],to:ge[ne],delay:`${(O*.35).toFixed(2)}s`}))}return T},[be,ge]);a.useEffect(()=>{if(!s||n!==2)return;const w=()=>{const de=F.map(T=>T.id);for(let T=de.length-1;T>0;T-=1){const I=Math.floor(Math.random()*(T+1));[de[T],de[I]]=[de[I],de[T]]}return de.slice(0,4)};K(w());const Z=window.setInterval(()=>{K(w())},H);return()=>window.clearInterval(Z)},[n,s,F,H]),a.useEffect(()=>{if(!s||n!==3)return;const w=()=>{$(Math.floor(Math.random()*ce.length)),G(ge.map(()=>Math.random()<.6?"good":"bad")),Be(de=>de+1)};w();const Z=window.setInterval(w,ee);return()=>window.clearInterval(Z)},[n,s,ce.length,ge,ee]);const oe=a.useMemo(()=>ur(11),[]),[te,Te]=a.useState(new Set(["root"])),[Ie,Ee]=a.useState(new Set),[ze,$e]=a.useState(new Set),[qe,_e]=a.useState({fromId:"root",toId:"root",key:0}),De=a.useRef(te),Ue=a.useRef("root"),ot=a.useRef(0),tt=a.useRef(null),Ae=a.useRef(null),ke=a.useRef([]);a.useEffect(()=>{De.current=te},[te]);const U=a.useMemo(()=>{const w=new Set;return te.forEach(Z=>{const de=oe.linksByFrom.get(Z);de&&de.forEach(T=>w.add(T))}),w},[te,oe]),Re=oe.nodesById.get(qe.toId)??oe.nodesById.get("root"),J=Re?`${Re.x/va.width*100}%`:"50%",Q=Re?`${Re.y/va.height*100}%`:"90%";a.useEffect(()=>{if(!s||n!==1||r)return;(()=>{Te(new Set(["root"])),Ee(new Set),$e(new Set),_e({fromId:"root",toId:"root",key:0}),Ae.current=null,ot.current=0,Ue.current="root",ke.current=[]})();const Z=()=>{const T=Ue.current,I=De.current,ae=(oe.childrenByFrom.get(T)??[]).filter(he=>!I.has(he));if(ae.length)return ae[Math.floor(Math.random()*ae.length)];if(I.size>=oe.nodes.length){const he=oe.neighborsById.get(T)??[];return he.length?he[Math.floor(Math.random()*he.length)]:null}const ne=he=>(oe.childrenByFrom.get(he)??[]).some(Je=>!I.has(Je)),we=[T],Ce=new Set([T]),Ke=new Map;let ie=null;for(;we.length;){const he=we.shift();if(!he)break;if(he!==T&&ne(he)){ie=he;break}(oe.neighborsById.get(he)??[]).forEach(Je=>{Ce.has(Je)||(Ce.add(Je),Ke.set(Je,he),we.push(Je))})}if(!ie)return null;let pe=ie;for(;Ke.get(pe)&&Ke.get(pe)!==T;)pe=Ke.get(pe)??pe;return pe},de=(T,I)=>{if(T===I){const O=Z();O&&de(T,O);return}ot.current+=1,_e({fromId:T,toId:I,key:ot.current}),Ue.current=I,tt.current=window.setTimeout(()=>{const O=oe.parentsById.get(I)??[],ae=De.current,ne=O.filter(ie=>!ae.has(ie));if(!ne.length){const ie=new Set(ae);ie.add(I),Te(ie),tt.current=window.setTimeout(()=>{for(;ke.current.length;){const he=ke.current[ke.current.length-1];if(!ie.has(he)){if(he!==I){de(I,he);return}break}ke.current.pop()}const pe=Z();pe&&de(I,pe)},ya.pauseMs);return}const we=new Set([I,...ne]),Ce=new Set(ne.map(ie=>`${ie}-${I}`));Ee(we),$e(Ce),ke.current.includes(I)||ke.current.push(I);const Ke=ne[Math.floor(Math.random()*ne.length)];Ae.current={fromId:I,toId:Ke},tt.current=window.setTimeout(()=>{Ee(new Set),$e(new Set);const ie=Ae.current;ie&&de(ie.fromId,ie.toId)},ya.errorMs)},ya.moveMs)};return tt.current=window.setTimeout(()=>{const T=Z();T&&de(Ue.current,T)},ya.pauseMs),()=>{tt.current&&window.clearTimeout(tt.current)}},[n,s,oe,r]);const Ne=w=>{if(!s)return;const Z=Date.now();Z-D.current<520||Math.abs(w.deltaY)<10||(D.current=Z,w.deltaY>0?i():g(),w.preventDefault())},Ve=w=>{if(!s)return;const Z=w.touches[0];Z&&(p.current={x:Z.clientX,y:Z.clientY})},z=w=>{if(!s)return;const Z=p.current;if(p.current=null,!Z)return;const de=w.changedTouches[0];if(!de)return;const T=de.clientX-Z.x,I=de.clientY-Z.y;Math.abs(I)<40||Math.abs(I)<Math.abs(T)||(I<0?i():g())};return e.jsxs("div",{className:`cogita-intro ${s?"is-open":"is-closed"} ${r?"is-reduced":""} ${c?"is-final":""}`,"data-slide":n+1,onWheel:Ne,onTouchStart:Ve,onTouchEnd:z,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":x,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${L&&!m?"is-entry":""}`,children:S.map((w,Z)=>e.jsx("img",{src:w.src,alt:"",className:`cogita-logo-layer ${Z===0?"is-base":""} ${w.kind==="text"?"is-text":w.kind==="recreatio"?"is-recreatio":""} ${w.kind==="bubble"?"is-bubble":""}`},w.src))})}),s&&t.map((w,Z)=>{const de=Z===n;return e.jsxs("section",{className:`cogita-intro-slide slide-${Z+1} ${de?"is-active":""}`,"aria-hidden":!de,children:[e.jsxs("div",{className:"cogita-intro-text",children:[w.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:w.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:w.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:w.title}),w.body&&e.jsx("p",{children:w.body.split(`
`).map((T,I)=>e.jsxs("span",{children:[T,I===0&&e.jsx("br",{})]},String(I)))})]}),w.micro&&e.jsx("p",{className:"cogita-intro-micro",children:w.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:c?M:i,children:w.cta}),c&&w.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>h(0),children:w.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[Z===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${va.width} ${va.height}`,preserveAspectRatio:"none",children:[oe.links.map(T=>{const I=oe.nodesById.get(T.from),O=oe.nodesById.get(T.to);if(!I||!O)return null;const ae=U.has(T.key),ne=ze.has(T.key);return e.jsx("line",{className:`map-link ${ae?"is-active":""} ${ne?"is-error":""}`,x1:I.x,y1:I.y,x2:O.x,y2:O.y},T.key)}),oe.nodes.map(T=>{const I=te.has(T.id),O=Ie.has(T.id);return e.jsx("circle",{className:`map-node ${T.role?`is-${T.role}`:""} ${I?"is-active":""} ${O?"is-error":""}`,cx:T.x,cy:T.y,r:T.r},T.id)})]}),Re&&e.jsx("span",{className:"map-explorer-dot",style:{left:J,top:Q,"--move":`${ya.moveMs}ms`}})]}),Z===2&&e.jsx("div",{className:"cogita-index-cards",children:F.map(T=>{const I=E.indexOf(T.id),O=I>=0?X[I]:null,ae=(O==null?void 0:O.x)??"140px",ne=(O==null?void 0:O.y)??"140px",we=I>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":T.throw.x,"--throw-y":T.throw.y,"--throw-rot":T.throw.rot,"--grid-x":T.grid.x,"--grid-y":T.grid.y,"--stack-x":ae,"--stack-y":ne,"--stack-opacity":we,"--delay":T.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},T.id)})}),Z===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[ce.map((T,I)=>e.jsxs("div",{className:`round-card ${I===ye?"is-active":""}`,style:{"--card-x":T.x,"--card-y":T.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},T.id)),ce[ye]&&e.jsx("span",{className:"round-ring",style:{"--card-x":ce[ye].x,"--card-y":`calc(${ce[ye].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:ge.map(T=>e.jsx("span",{className:"player-dot",style:{left:T.x,top:T.y,"--jitter-x":T.jitterX,"--jitter-y":T.jitterY,"--breath-delay":T.delay}},T.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:Le.map(T=>e.jsx("line",{className:"round-link",x1:T.from.xNum,y1:T.from.yNum,x2:T.to.xNum,y2:T.to.yNum,style:{"--delay":T.delay}},T.id))}),e.jsx("div",{className:"round-flows",children:ge.map((T,I)=>{const O=ve[I]??"good",ae=ce[ye];if(!ae)return null;const ne=`calc(${ae.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":T.x,"--from-y":T.y,"--to-x":ae.x,"--to-y":ne,"--delay":`${I*.12}s`}}),e.jsx("span",{className:`return-dot is-${O}`,style:{"--from-x":ae.x,"--from-y":ne,"--to-x":T.x,"--to-y":T.y,"--delay":`${I*.12}s`}}),e.jsx("span",{className:`result-pop is-${O}`,style:{"--at-x":T.x,"--at-y":T.y,"--delay":`${I*.12}s`}})]},`${T.id}-${be}`)})})]},`round-${be}`),Z===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${u[0].x} ${u[0].y} L${u[1].x} ${u[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${u[1].x} ${u[1].y} L${u[2].x} ${u[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${u[2].x} ${u[2].y} L${u[3].x} ${u[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${u[3].x} ${u[3].y} L${u[4].x} ${u[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${u[4].x} ${u[4].y} L${u[5].x} ${u[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${u[5].x} ${u[5].y} L${u[6].x} ${u[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${P};${P};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${ue.upper.map((T,I)=>`${I===0?"M":"L"}${T.x} ${T.y}`).join(" ")} ${ue.lower.slice().reverse().map(T=>`L${T.x} ${T.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${ue.upper.map((T,I)=>`${I===0?"M":"L"}${T.x} ${T.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${ue.lower.map((T,I)=>`${I===0?"M":"L"}${T.x} ${T.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[y.higher.slice(0,6).map((T,I)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${I+1}`,d:`M${T.x} ${T.y} L${y.higher[I+1].x} ${y.higher[I+1].y}`,pathLength:"100"},`peer-1-${I}`)),y.lower.slice(0,6).map((T,I)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${I+1}`,d:`M${T.x} ${T.y} L${y.lower[I+1].x} ${y.lower[I+1].y}`,pathLength:"100"},`peer-2-${I}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${u[0].x/300*100}%`,"--p0y":`${u[0].y/200*100}%`,"--p1x":`${u[1].x/300*100}%`,"--p1y":`${u[1].y/200*100}%`,"--p2x":`${u[2].x/300*100}%`,"--p2y":`${u[2].y/200*100}%`,"--p3x":`${u[3].x/300*100}%`,"--p3y":`${u[3].y/200*100}%`,"--p4x":`${u[4].x/300*100}%`,"--p4y":`${u[4].y/200*100}%`,"--p5x":`${u[5].x/300*100}%`,"--p5y":`${u[5].y/200*100}%`,"--p6x":`${u[6].x/300*100}%`,"--p6y":`${u[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${y.higher[0].x/300*100}%`,"--q0y":`${y.higher[0].y/200*100}%`,"--q1x":`${y.higher[1].x/300*100}%`,"--q1y":`${y.higher[1].y/200*100}%`,"--q2x":`${y.higher[2].x/300*100}%`,"--q2y":`${y.higher[2].y/200*100}%`,"--q3x":`${y.higher[3].x/300*100}%`,"--q3y":`${y.higher[3].y/200*100}%`,"--q4x":`${y.higher[4].x/300*100}%`,"--q4y":`${y.higher[4].y/200*100}%`,"--q5x":`${y.higher[5].x/300*100}%`,"--q5y":`${y.higher[5].y/200*100}%`,"--q6x":`${y.higher[6].x/300*100}%`,"--q6y":`${y.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${y.lower[0].x/300*100}%`,"--q0y":`${y.lower[0].y/200*100}%`,"--q1x":`${y.lower[1].x/300*100}%`,"--q1y":`${y.lower[1].y/200*100}%`,"--q2x":`${y.lower[2].x/300*100}%`,"--q2y":`${y.lower[2].y/200*100}%`,"--q3x":`${y.lower[3].x/300*100}%`,"--q3y":`${y.lower[3].y/200*100}%`,"--q4x":`${y.lower[4].x/300*100}%`,"--q4y":`${y.lower[4].y/200*100}%`,"--q5x":`${y.lower[5].x/300*100}%`,"--q5y":`${y.lower[5].y/200*100}%`,"--q6x":`${y.lower[6].x/300*100}%`,"--q6y":`${y.lower[6].y/200*100}%`}})]})})}),Z===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),Z===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},w.id)}),!s&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:l.title}),l.body&&e.jsx("p",{children:l.body}),l.micro&&e.jsx("p",{className:"cogita-intro-micro",children:l.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:M,children:l.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:C,children:"Otwórz pokaz"})]})]})})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((w,Z)=>e.jsx("button",{type:"button",className:`dot ${n===Z?"active":""}`,"aria-label":w.title,onClick:()=>h(Z)},w.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:f,children:"Pomiń"})]})]})}const mr=6,gr=4;function pr({copy:t,onAuthAction:n,authLabel:s,showProfileMenu:r,onProfileNavigate:i,onToggleSecureMode:g,onLogout:h,secureMode:f,onNavigate:C,language:M,onLanguageChange:c}){const x=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}C("home")},l=a.useRef(null),m=a.useRef([]),v=a.useMemo(()=>{let G=Date.now()%2147483647;const ee=()=>(G=G*48271%2147483647,G/2147483647);return Array.from({length:mr},(Le,oe)=>{const te=6+ee()*8,Te=7+ee()*10,Ie=6+ee()*9,Ee=-ee()*te,ze=-ee()*Te,$e=-ee()*Ie,qe=.18+ee()*.28,_e=12+ee()*18,De=4+ee()*8,Ue=(ee()-.5)*3.2,ot=(ee()-.5)*3.8,tt=ee()>.5?"alternate":"alternate-reverse",Ae=ee()>.5?"alternate":"alternate-reverse",ke=ee()>.5?"alternate":"alternate-reverse",U=.18+ee()*.42,Re=30+ee()*60,J=-45-ee()*38,Q=188+ee()*32,Ne=.1+ee()*.2;return{id:`wave-${oe+1}`,style:{"--wave-sway-duration":`${te}s`,"--wave-scale-duration":`${Te}s`,"--wave-drift-duration":`${Ie}s`,"--wave-sway-delay":`${Ee}s`,"--wave-scale-delay":`${ze}s`,"--wave-drift-delay":`${$e}s`,"--wave-sway-dir":tt,"--wave-scale-dir":Ae,"--wave-drift-dir":ke,"--wave-scale":`${qe}`,"--wave-shift":`${_e}%`,"--wave-xshift":`${De}%`,"--wave-x0":`${Ue}%`,"--wave-y0":`${ot}%`,"--wave-opacity":`${U}`,"--wave-blur":`${Re}px`,"--wave-bottom":`${J}%`,"--wave-hue":`${Q}`,"--wave-glow":`${Ne}`}}})},[]),S=a.useMemo(()=>{let G=Date.now()*3%2147483647;const ee=()=>(G=G*48271%2147483647,G/2147483647);return Array.from({length:gr},(Le,oe)=>{const te=180+ee()*220,Te=220+ee()*280,Ie=-ee()*te,Ee=-ee()*Te,ze=.12+ee()*.22,$e=3+ee()*7,qe=1+ee()*3,_e=(ee()-.5)*2.8,De=(ee()-.5)*2.2;return{id:`mesh-${oe+1}`,seed:1e3+oe*991+Math.floor(ee()*999),style:{"--mesh-sway-duration":`${te}s`,"--mesh-drift-duration":`${Te}s`,"--mesh-sway-delay":`${Ie}s`,"--mesh-drift-delay":`${Ee}s`,"--mesh-scale":`${ze}`,"--mesh-shift":`${$e}%`,"--mesh-xshift":`${qe}%`,"--mesh-x0":`${De}%`,"--mesh-y0":`${_e}%`}}})},[]),L=a.useMemo(()=>{const G=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],ee=t.cogita.introSlides,Le=new Map(ee.map(oe=>[oe.id,oe]));return G.map(oe=>{var Te;const te=Le.get(oe.id);return{...oe,...te,title:(te==null?void 0:te.title)??"Cogita",cta:(te==null?void 0:te.cta)??((Te=t.cogita.introSlides[0])==null?void 0:Te.cta)??t.cogita.loginCta,secondary:te==null?void 0:te.secondary}})},[t.cogita.introSlides]),[D,p]=a.useState(0),[u,ue]=a.useState(!0),[P,y]=a.useState(!1),H=L.length-1,F=a.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),X=a.useCallback(()=>{F(),n()},[F,n]),E=a.useCallback(()=>{ue(!0),p(0)},[]),K=a.useCallback(()=>{ue(!1),p(H)},[H]),ce=a.useCallback(G=>{p(Math.max(0,Math.min(H,G)))},[H]),ge=a.useCallback(()=>{D>=H?X():ce(D+1)},[D,ce,X,H]),be=a.useCallback(()=>{ce(D-1)},[D,ce]);a.useEffect(()=>{var Le;const G=(Le=window.matchMedia)==null?void 0:Le.call(window,"(prefers-reduced-motion: reduce)");if(!G)return;const ee=()=>y(G.matches);return ee(),G.addEventListener?(G.addEventListener("change",ee),()=>G.removeEventListener("change",ee)):(G.addListener(ee),()=>G.removeListener(ee))},[]),a.useEffect(()=>{if(!u)return;const G=ee=>{const Le=ee.target;if(!Le)return;const oe=Le.tagName;if(!(Le.isContentEditable||oe==="INPUT"||oe==="TEXTAREA"||oe==="SELECT"||oe==="BUTTON"||oe==="A"||Le.closest('button, a, [role="button"], [role="link"]'))){if(ee.key==="Escape"){K();return}if(ee.key==="ArrowLeft"||ee.key==="ArrowUp"){be();return}(ee.key==="ArrowRight"||ee.key==="ArrowDown"||ee.code==="Space"||ee.key===" ")&&(ee.preventDefault(),ge())}};return window.addEventListener("keydown",G),()=>window.removeEventListener("keydown",G)},[K,ge,be,u]),a.useEffect(()=>{u&&D===H&&F()},[D,u,H,F]),a.useEffect(()=>{const G=l.current;if(!G)return;const ee=m.current.filter(J=>!!J);if(!ee.length)return;const Le=1,oe=.6,te=.6,Te=Math.max(1,Math.min(Le,window.devicePixelRatio||1));let Ie=0,Ee=0,ze=oe,$e=0,qe=0;const _e=J=>{let Q=J%2147483647;return Q<=0&&(Q+=2147483646),(Ne,Ve)=>{Q=Q*48271%2147483647;const z=Q/2147483647;return Ne+z*(Ve-Ne)}},De={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},Ue=J=>{const Q=Math.sin(J*12.9898)*43758.5453;return Q-Math.floor(Q)},ot=J=>{const Q=Ue(J+.1)||1e-4,Ne=Ue(J+.7)||1e-4;return Math.sqrt(-2*Math.log(Q))*Math.cos(2*Math.PI*Ne)},tt=(J,Q)=>{const Ne=Math.floor(J),Ve=Ne+1,z=J-Ne,w=z*z*(3-2*z),Z=Ue(Ne*12.9898+Q*78.233),de=Ue(Ve*12.9898+Q*78.233);return Z+(de-Z)*w},Ae=J=>{const Q=_e(J),Ne=Math.min(4,Math.max(4,Math.floor(Ie/1200*De.filamentCount)));return Array.from({length:Ne},(Ve,z)=>{const w=Math.max(-1,Math.min(1,ot(J+z*.37))),Z=Math.min(1,Math.max(0,Ue(J+z*1.31))),de=Math.min(De.depthLayers-1,Math.floor(Z*De.depthLayers));return{seed:Q(0,Math.PI*2)+J*.01,offset:w,freqA:De.freq1*(.75+Q(0,.5)),freqB:De.freq2*(.75+Q(0,.5)),ampA:De.amp1*(.6+Q(0,.7)),ampB:De.amp2*(.6+Q(0,.7)),width:2+z%5*.32,depth:Z,layer:de}})},ke=(J,Q,Ne)=>{const Ve=Math.max(30,Math.floor(Ie*Ee/14e4));J.save(),J.globalAlpha=.6;for(let z=0;z<Ve;z+=1){const w=Ue(z*9.1+Ie*.11)*Q+Ne,Z=Ue(z*3.7+Ee*.23)*Ee,de=1.2+Ue(z*5.9)*2.4,T=J.createRadialGradient(w,Z,0,w,Z,de*2);T.addColorStop(0,"rgba(10, 30, 60, 0.45)"),T.addColorStop(1,"rgba(10, 30, 60, 0)"),J.fillStyle=T,J.beginPath(),J.arc(w,Z,de*2,0,Math.PI*2),J.fill()}J.restore()},U=(J,Q)=>{J.clearRect(0,0,Ie,Ee);const Ne=Ee*De.waveCenter,Ve=De.waveBandPx,z=De.segments,w=De.colors.filaments,Z=$e||Ie,de=0;ke(J,Z,de),J.strokeStyle=w,J.lineCap="round",J.lineJoin="round";for(let T=0;T<Q.length;T+=1){const I=Q[T],O=I.offset*Ve*(.85+Ue(I.seed)*.4),ae=1-Math.min(1,Math.abs(O)/Ve),ne=Math.exp(-Math.pow(O/De.crestThickness,2)),we=I.layer===0?1.1:I.layer===1?.85:.6,Ce=.35+(1-I.depth)*.65,Ke=ae*Ce*we*(.34+ne*.45);J.globalAlpha=Ke,J.lineWidth=I.width*(1+(1-I.depth)*.8);const ie=[];for(let he=0;he<=z;he+=1){const at=he/z*Z+de,Je=(tt(at*.012,I.seed)-.5)*De.xJitter,Ye=at+Je,ct=(tt(Ye*I.freqA,I.seed)-.5)*De.jitterA,yt=(tt(Ye*I.freqB,I.seed*1.7)-.5)*De.jitterB,We=Ne+Math.sin(Ye*I.freqA+I.seed)*I.ampA+Math.sin(Ye*I.freqB+I.seed*1.3)*I.ampB+O+ct+yt;ie.push({x:Ye,y:We})}J.beginPath(),J.moveTo(ie[0].x,ie[0].y);for(let he=1;he<ie.length-1;he+=1){const at=(ie[he].x+ie[he+1].x)/2,Je=(ie[he].y+ie[he+1].y)/2;J.quadraticCurveTo(ie[he].x,ie[he].y,at,Je)}const pe=ie[ie.length-1];J.quadraticCurveTo(pe.x,pe.y,pe.x,pe.y),J.stroke()}J.save(),J.globalCompositeOperation="lighter",J.strokeStyle=De.colors.glow,J.lineCap="round",J.lineJoin="round";for(let T=0;T<Q.length;T+=1){const I=Q[T];if(Math.abs(I.offset)*Ve>De.crestThickness)continue;const O=De.glowAlpha*(.7+(1-I.depth)*.6);J.globalAlpha=O,J.lineWidth=1.6+(1-I.depth)*1.2;const ae=[];for(let we=0;we<=z;we+=1){const Ce=we/z*Z+de,Ke=Math.sin(Ce*.02+I.seed)*3,ie=Ne+Math.sin(Ce*I.freqA+I.seed)*I.ampA+Math.sin(Ce*I.freqB+I.seed*1.3)*I.ampB+I.offset*Ve*.35+Ke;ae.push({x:Ce,y:ie})}J.beginPath(),J.moveTo(ae[0].x,ae[0].y);for(let we=1;we<ae.length-1;we+=1){const Ce=(ae[we].x+ae[we+1].x)/2,Ke=(ae[we].y+ae[we+1].y)/2;J.quadraticCurveTo(ae[we].x,ae[we].y,Ce,Ke)}const ne=ae[ae.length-1];J.quadraticCurveTo(ne.x,ne.y,ne.x,ne.y),J.stroke()}J.restore()},Re=()=>{Ie=Math.floor(G.clientWidth),Ee=Math.floor(G.clientHeight),$e=Math.floor(Ie*1.8),qe=Ee,ze=Ie<820?te:oe,ee.forEach(J=>{const Q=J.getContext("2d");if(!Q)return;J.width=Math.floor($e*Te*ze),J.height=Math.floor(qe*Te*ze),J.style.width=`${$e}px`,J.style.height=`${qe}px`,J.style.left=`${-($e-Ie)/2}px`,Q.setTransform(Te*ze,0,0,Te*ze,0,0);const Ne=Number(J.dataset.seed||1),Ve=Ae(Ne);U(Q,Ve)})};return Re(),window.addEventListener("resize",Re,{passive:!0}),()=>window.removeEventListener("resize",Re)},[S]);const Be=L[Math.min(D,L.length-1)],ye=u?Be:L[L.length-1],$=(ye==null?void 0:ye.theme)??L[0].theme,ve={"--cogita-bg0":$.bg0,"--cogita-bg1":$.bg1,"--cogita-bg2":$.bg2,"--cogita-bloom":$.bloom,"--cogita-sat":$.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:x,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(ls,{value:M,onChange:c}),e.jsx(cs,{copy:t,label:s,isAuthenticated:r,secureMode:f,onLogin:n,onProfileNavigate:i,onToggleSecureMode:g,onLogout:h,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:l,className:"cogita-section cogita-home",style:ve,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[S.map((G,ee)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:G.style,"data-seed":G.seed,ref:Le=>{m.current[ee]=Le}},G.id)),v.map(G=>e.jsx("div",{className:"cogita-home-wave",style:G.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},G.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(hr,{slides:L,activeIndex:D,introOpen:u,prefersReducedMotion:P,onNext:ge,onPrev:be,onSelect:ce,onExit:K,onOpen:E,onRegister:X})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const ji=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:pr},Symbol.toStringTag,{value:"Module"})),xs=a.createContext(!1);function Tt({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,headerExtra:c,children:x}){if(a.useContext(xs))return e.jsx(e.Fragment,{children:x});const m=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}f("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:m,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(ls,{value:C,onChange:M}),e.jsxs("div",{className:"cogita-header-right",children:[c,e.jsx(cs,{copy:t,label:n,isAuthenticated:s,secureMode:h,onLogin:()=>f("home"),onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:x}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function Wt(t){const[n,s]=a.useState("Cogita library"),[r,i]=a.useState(null);return a.useEffect(()=>{let g=!1;return ds().then(h=>{if(g)return;const f=h.find(C=>C.libraryId===t);f&&s(f.name)}).catch(()=>{g||s("Cogita library")}),()=>{g=!0}},[t]),a.useEffect(()=>{let g=!1;return Rs(t).then(h=>{g||i(h)}).catch(()=>{g||i(null)}),()=>{g=!0}},[t]),{libraryName:n,stats:r}}function Pn({slices:t}){const n=t.reduce((r,i)=>r+Math.max(0,i.value),0),s=a.useMemo(()=>{if(n<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let r=0;return`conic-gradient(${t.map(g=>{const f=Math.max(0,g.value)/n*360,C=r,M=r+f;return r=M,`${g.color} ${C}deg ${M}deg`}).join(",")})`},[t,n]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:s}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(r=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:r.color}}),e.jsx("strong",{children:r.value}),e.jsx("small",{children:r.label})]},r.label))})]})}function fr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,libraryId:c}){const{libraryName:x,stats:l}=Wt(c),[m,v]=a.useState("infos"),[S,L]=a.useState(0),[D,p]=a.useState(0),[u,ue]=a.useState(0),P=(l==null?void 0:l.totalInfos)??0,y=(l==null?void 0:l.totalCollections)??0,H=0,F=0,X=0,E=Math.max(0,P-X-D),K=Math.max(0,P-D-u);a.useEffect(()=>{let ge=!1;return(async()=>{try{const Be=await ja({libraryId:c,limit:200}),ye=await Promise.all(Be.items.map($=>us({libraryId:c,collectionId:$.collectionId}).catch(()=>[])));if(ge)return;L(ye.reduce(($,ve)=>$+ve.length,0))}catch{ge||L(0)}})(),()=>{ge=!0}},[c]),a.useEffect(()=>{let ge=!1;return(async()=>{try{const[Be,ye,$]=await Promise.all([$n({libraryId:c,type:"computed",limit:1}).catch(()=>({total:0})),$n({libraryId:c,type:"source",limit:1}).catch(()=>({total:0})),jn({libraryId:c}).catch(()=>({items:[]}))]);if(ge)return;p((Be.total??0)+(ye.total??0));const ve=new Set($.items.filter(G=>G.childItemType.toLowerCase()==="info").map(G=>G.childItemId).filter(Boolean));ue(ve.size)}catch{ge||(p(0),ue(0))}})(),()=>{ge=!0}},[c]);const ce=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:P},{key:"collections",label:t.cogita.library.overview.stats.collections,value:y},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:S},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:H},{key:"texts",label:t.cogita.library.overview.stats.texts,value:F}];return e.jsx(Tt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:x})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:ce.map(ge=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${m===ge.key?"active":""}`,onClick:()=>v(ge.key),children:[e.jsx("span",{children:ge.label}),e.jsx("strong",{children:ge.value})]},ge.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),m==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(Pn,{slices:[{label:t.cogita.library.overview.known,value:X,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:E,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:D,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(Pn,{slices:[{label:t.cogita.library.overview.availableChecks,value:u,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:K,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const He=(t,n)=>{const s=t.cogita.library.infoTypes,r=t.cogita.library.connectionTypes,i=t.cogita.library.groupTypes;return{any:s.any,vocab:s.vocab,book:i.book,citation:i.citation,language:s.language,word:s.word,sentence:s.sentence,topic:s.topic,collection:s.collection,person:s.person,institution:s.institution,collective:s.collective,orcid:s.orcid,address:s.address,email:s.email,phone:s.phone,media:s.media,work:s.work,geo:s.geo,music_piece:s.musicPiece,music_fragment:s.musicFragment,source:s.source,computed:s.computed,"word-language":r.wordLanguage,"citation-language":r.citationLanguage,"language-sentence":r.languageSentence,translation:r.translation,"word-topic":r.wordTopic,reference:r.reference,"source-resource":r.sourceResource,"work-contributor":r.workContributor,"work-medium":r.workMedium,"orcid-link":r.orcidLink}[n]??String(n)},br=t=>[{value:"any",label:He(t,"any")},{value:"language",label:He(t,"language")},{value:"word",label:He(t,"word")},{value:"sentence",label:He(t,"sentence")},{value:"topic",label:He(t,"topic")},{value:"collection",label:He(t,"collection")},{value:"person",label:He(t,"person")},{value:"institution",label:He(t,"institution")},{value:"collective",label:He(t,"collective")},{value:"orcid",label:He(t,"orcid")},{value:"address",label:He(t,"address")},{value:"email",label:He(t,"email")},{value:"phone",label:He(t,"phone")},{value:"media",label:He(t,"media")},{value:"work",label:He(t,"work")},{value:"geo",label:He(t,"geo")},{value:"music_piece",label:He(t,"music_piece")},{value:"music_fragment",label:He(t,"music_fragment")},{value:"source",label:He(t,"source")},{value:"citation",label:He(t,"citation")},{value:"computed",label:He(t,"computed")},{value:"vocab",label:He(t,"vocab")},{value:"book",label:He(t,"book")},{value:"word-language",label:He(t,"word-language")},{value:"citation-language",label:He(t,"citation-language")},{value:"language-sentence",label:He(t,"language-sentence")},{value:"translation",label:He(t,"translation")},{value:"word-topic",label:He(t,"word-topic")},{value:"reference",label:He(t,"reference")},{value:"source-resource",label:He(t,"source-resource")},{value:"work-contributor",label:He(t,"work-contributor")},{value:"work-medium",label:He(t,"work-medium")},{value:"orcid-link",label:He(t,"orcid-link")}],yr=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],en={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},xr={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[en]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[en]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId"]},filterFields:[en,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text"],connections:[{relationType:"citation-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"citationText",kind:"text",path:"text",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},Kn={infoType:"default",entityKind:"single",structure:{payloadFields:["label"]},filterFields:[]};function vr(t){return t?xr[t]??Kn:Kn}function wr(t,n){return t.optionsSource==="languages"?n.languages.map(s=>({value:s.infoId,label:s.label})):t.optionsSource==="sourceKinds"?yr:[]}const tn=60,jr=500;function vs(t){return`cogita.info-selection:${t}`}function Fn(t){if(typeof window>"u")return{};const n=window.localStorage.getItem(vs(t));if(!n)return{};try{const s=JSON.parse(n);return!s||typeof s!="object"?{}:s}catch{return{}}}function kr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,libraryId:c,mode:x}){var jt;const l=ss(),m=Oa(),v=t.cogita.library.list,[S,L]=a.useState("any"),[D,p]=a.useState(""),[u,ue]=a.useState("relevance"),[P,y]=a.useState("details"),[H,F]=a.useState(!1),[X,E]=a.useState("idle"),[K,ce]=a.useState([]),[ge,be]=a.useState(tn),[Be,ye]=a.useState(null),[$,ve]=a.useState(()=>Fn(c)),[G,ee]=a.useState({}),[Le,oe]=a.useState([]),[te,Te]=a.useState(null),[Ie,Ee]=a.useState(null),[ze,$e]=a.useState(null),[qe,_e]=a.useState("idle"),[De,Ue]=a.useState([]),[ot,tt]=a.useState(""),[Ae,ke]=a.useState(null),[U,Re]=a.useState("idle"),[J,Q]=a.useState(null),[Ne,Ve]=a.useState(null),[z,w]=a.useState("idle"),Z=a.useMemo(()=>br(t),[t]),de=a.useMemo(()=>[{value:"relevance",label:v.sortRelevance},{value:"label_asc",label:v.sortLabelAsc},{value:"label_desc",label:v.sortLabelDesc},{value:"type_asc",label:v.sortTypeAsc},{value:"type_desc",label:v.sortTypeDesc}],[v.sortLabelAsc,v.sortLabelDesc,v.sortRelevance,v.sortTypeAsc,v.sortTypeDesc]);a.useEffect(()=>{ve(Fn(c)),ee({}),F(!1)},[c]),a.useEffect(()=>{jn({libraryId:c}).then(q=>$e(q)).catch(()=>$e({items:[]}))},[c]),a.useEffect(()=>{Es({libraryId:c}).then(q=>Ue(q)).catch(()=>Ue([]))},[c]),a.useEffect(()=>{Rn({libraryId:c,type:"language",filters:{sourceKind:"info"},limit:200}).then(q=>{const le=q.map(Me=>({infoId:Me.infoId??"",infoType:Me.entityType,label:Me.title})).filter(Me=>Me.infoId.length>0);oe(le)}).catch(()=>oe([]))},[c]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(vs(c),JSON.stringify($))},[c,$]);const T=a.useMemo(()=>vr(S==="any"?null:S),[S]),I=a.useMemo(()=>new URLSearchParams(m.search),[m.search]),O=a.useMemo(()=>m.pathname.split("/").filter(Boolean),[m.pathname]),ae=O.findIndex(q=>q==="infos"),ne=ae>=0&&(O[ae+1]??"").trim()||null,we=ae>=0?(O[ae+2]??"").trim()==="checkcards"?"cards":"overview":"",Ce=ne??((I.get("infoId")??"").trim()||null),Ke=ne?we:(I.get("infoView")??"overview").trim(),ie=Ke==="overview"&&!!Ce,pe=a.useMemo(()=>({language:v.typeFilterLanguage,languageA:v.typeFilterLanguageA,languageB:v.typeFilterLanguageB,originalLanguage:v.typeFilterOriginalLanguage,doi:v.typeFilterDoi,sourceKind:v.typeFilterSourceKind,locator:v.typeFilterLocator,citationText:v.typeFilterCitationText}),[v.typeFilterDoi,v.typeFilterLanguage,v.typeFilterLanguageA,v.typeFilterLanguageB,v.typeFilterLocator,v.typeFilterOriginalLanguage,v.typeFilterCitationText,v.typeFilterSourceKind]),he=a.useMemo(()=>T.filterFields.map(q=>({...q,label:q.labelKey?pe[q.labelKey]:q.label??q.key,options:wr(q,{languages:Le})})),[pe,Le,T.filterFields]),at=a.useMemo(()=>he.some(q=>(G[q.key]??"").trim().length>0),[he,G]);a.useEffect(()=>{ee({})},[S]),a.useEffect(()=>{const q={sourceKind:"info"};if(at)for(const Me of he){const d=(G[Me.key]??"").trim();d&&(q[Me.path??Me.key]=d)}E("loading");const le=window.setTimeout(()=>{Rn({libraryId:c,type:S==="any"?void 0:S,query:D.trim()||void 0,filters:q,limit:jr}).then(Me=>{const d=Me.map(Se=>({infoId:Se.infoId??"",infoType:Se.entityType,label:Se.title})).filter(Se=>Se.infoId.length>0);ce(d),E("ready")}).catch(()=>{ce([]),E("ready")})},240);return()=>window.clearTimeout(le)},[at,c,D,S,he,G]),a.useEffect(()=>{if(!Ce||Ke!=="overview"){Te(null),Ee(null),_e("idle");return}let q=!1;return _e("loading"),Promise.all([Qt({libraryId:c,infoId:Ce}),As({libraryId:c,itemType:"info",itemId:Ce}).catch(()=>null)]).then(([le,Me])=>{q||(Te(le),Ee(Me),_e("ready"))}).catch(()=>{q||(Te(null),Ee(null),_e("error"))}),()=>{q=!0}},[c,Ce,Ke]),a.useEffect(()=>{if(!Ce||Ke!=="overview"){Q(null),Ve(null),w("idle");return}let q=!1;return w("loading"),Promise.all([hs({libraryId:c,infoId:Ce}),ms({libraryId:c,infoId:Ce})]).then(([le,Me])=>{q||(Q(le),Ve(Me),w("ready"))}).catch(()=>{q||(Q(null),Ve(null),w("error"))}),()=>{q=!0}},[c,Ce,Ke]);const Je=a.useMemo(()=>te?De.filter(q=>q.sourceInfoTypes.some(le=>le.toLowerCase()===te.infoType.toLowerCase())):[],[De,te]);a.useEffect(()=>{if(!te){tt("");return}tt(q=>{var le;return q&&Je.some(Me=>Me.approachKey===q)?q:((le=Je[0])==null?void 0:le.approachKey)??""})},[Je,te]),a.useEffect(()=>{if(!te||!ot){ke(null),Re("idle");return}let q=!1;return Re("loading"),gs({libraryId:c,infoId:te.infoId,approachKey:ot}).then(le=>{q||(ke(le),Re("ready"))}).catch(()=>{q||(ke(null),Re("error"))}),()=>{q=!0}},[c,ot,te]);const Ye=a.useMemo(()=>{const q=K.slice(),le=Me=>He(t,Me);return u==="relevance"?q:u==="label_asc"?q.sort((Me,d)=>Me.label.localeCompare(d.label)):u==="label_desc"?q.sort((Me,d)=>d.label.localeCompare(Me.label)):u==="type_asc"?q.sort((Me,d)=>Me.infoType===d.infoType?Me.label.localeCompare(d.label):le(Me.infoType).localeCompare(le(d.infoType))):q.sort((Me,d)=>Me.infoType===d.infoType?Me.label.localeCompare(d.label):le(d.infoType).localeCompare(le(Me.infoType)))},[t,K,u]),ct=a.useMemo(()=>Ye.slice(0,ge),[Ye,ge]),yt=ct.length<Ye.length,We=a.useMemo(()=>new Set(Object.keys($)),[$]),Ge=a.useMemo(()=>Object.values($),[$]),Ct=a.useMemo(()=>{const q=new Map;for(const le of Ge)q.set(le.infoType,(q.get(le.infoType)??0)+1);return Array.from(q.entries()).sort((le,Me)=>Me[1]-le[1]||le[0].localeCompare(Me[0]))},[Ge]),dt=a.useMemo(()=>{if(!Ce||!ze)return 0;const q=new Set;for(const le of ze.items)le.childItemType!=="info"||le.childItemId!==Ce||q.add([le.parentItemType,le.parentItemId,le.parentCheckType??"",le.parentDirection??""].join("|"));return q.size},[ze,Ce]);a.useEffect(()=>{be(tn);const q=new Set(K.map(le=>le.infoId));ye(le=>le&&q.has(le)?le:null)},[K]);const It=q=>{ve(le=>({...le,[q.infoId]:{infoId:q.infoId,infoType:q.infoType,label:q.label}}))},lt=q=>{ve(le=>{if(!le[q])return le;const Me={...le};return delete Me[q],Me})},rt=(q,le)=>{if(le){It(q);return}lt(q.infoId)},Lt=q=>{l(`/cogita/library/${c}/infos/${encodeURIComponent(q)}`,{replace:!0})},xt=()=>{l(`/cogita/library/${c}/list`,{replace:!0})},Xe=()=>{Ce&&l(`/cogita/library/${c}/edit/${encodeURIComponent(Ce)}`,{replace:!0})},et=Ge.length===1?((jt=Ge[0])==null?void 0:jt.infoId)??null:null,Et=v.selectionCount.replace("{count}",String(Ge.length)),$t=x==="collection"?"grid":x==="detail"?"wide":P,Qe=Tr(C),ht=Ie?Math.max(0,Math.min(100,Math.round((Ie.score??0)*100))):0,pt=Ie?Cr(Ie,Qe):Qe.noKnownnessData;return e.jsx(Tt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":$t,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[ie?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:Qe.kicker}),e.jsx("h2",{className:"cogita-card-title",children:te?Nr(te.payload,te.infoType,te.infoId):Qe.loading}),te?e.jsxs("p",{className:"cogita-card-subtitle",children:[He(t,te.infoType)," · ",te.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:xt,children:Qe.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:Xe,disabled:!Ce||qe!=="ready",children:v.editInfo})]})]}),qe==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:Qe.loading})}):qe==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:Qe.loadError})}):te?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Qe.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[ht,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${ht}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:pt})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Qe.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(Ie==null?void 0:Ie.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:Qe.correct.replace("{correct}",String((Ie==null?void 0:Ie.correctReviews)??0)).replace("{total}",String((Ie==null?void 0:Ie.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:Ie!=null&&Ie.lastReviewedUtc?`${Qe.lastReview}: ${Sr(Ie.lastReviewedUtc,C)}`:Qe.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Qe.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:dt}),e.jsx("p",{className:"cogita-library-hint",children:Qe.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Qe.checkcards}),z==="loading"?e.jsx("p",{className:"cogita-library-hint",children:Qe.loadingCheckcards}):z==="error"?e.jsx("p",{className:"cogita-library-hint",children:Qe.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:Qe.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(J==null?void 0:J.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:Qe.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(Ne==null?void 0:Ne.items.length)??0})]})]})]}),Je.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:Qe.approach}),e.jsx("select",{value:ot,onChange:q=>tt(q.target.value),"aria-label":Qe.approach,children:Je.map(q=>e.jsx("option",{value:q.approachKey,children:q.label},q.approachKey))})]}),U==="loading"?e.jsx("p",{className:"cogita-library-hint",children:Qe.loadingApproach}):U==="error"?e.jsx("p",{className:"cogita-library-hint",children:Qe.loadApproachError}):Ae?e.jsx(Ea,{value:Ae.projection,emptyLabel:Qe.empty}):e.jsx("p",{className:"cogita-library-hint",children:Qe.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Qe.payload}),e.jsx(Ea,{value:te.payload,emptyLabel:Qe.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Qe.links}),e.jsx(Mr,{links:te.links,emptyLabel:Qe.noLinks})]})]})]}):null]})}):null,ie?null:e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":v.typeLabel,value:S,onChange:q=>L(q.target.value),children:Z.map(q=>e.jsx("option",{value:q.value,children:q.label},q.value))}),e.jsx("input",{type:"text",value:D,onChange:q=>p(q.target.value),placeholder:v.searchPlaceholder}),e.jsx("select",{"aria-label":v.sortLabel,value:u,onChange:q=>ue(q.target.value),children:de.map(q=>e.jsx("option",{value:q.value,children:q.label},q.value))}),e.jsxs("select",{"aria-label":v.viewLabel,value:P,onChange:q=>y(q.target.value),children:[e.jsx("option",{value:"details",children:v.viewDetails}),e.jsx("option",{value:"wide",children:v.viewWide}),e.jsx("option",{value:"grid",children:v.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:v.cardCount.replace("{shown}",String(ct.length)).replace("{total}",String(Ye.length))}),e.jsx("span",{children:X==="loading"?v.loading:v.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>F(q=>!q),children:H?v.hideFilters:v.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:v.filtersOptionalHint})]}),H&&he.length>0?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsx("div",{className:"cogita-filter-grid",children:he.map(q=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:q.label}),q.kind==="select"?e.jsxs("select",{value:G[q.key]??"",onChange:le=>ee(Me=>({...Me,[q.key]:le.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(q.options??[]).map(le=>e.jsx("option",{value:le.value,children:le.label},`${q.key}:${le.value}`))]}):e.jsx("input",{type:"text",value:G[q.key]??"",onChange:le=>ee(Me=>({...Me,[q.key]:le.target.value}))})]},`type-filter:${q.key}`))})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:Et}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{ve(q=>{const le={...q};for(const Me of ct)le[Me.infoId]={infoId:Me.infoId,infoType:Me.infoType,label:Me.label};return le})},disabled:ct.length===0,children:v.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>ve({}),disabled:Ge.length===0,children:v.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>et&&Lt(et),disabled:!et,title:et?void 0:v.openSelectedDisabled,children:v.openSelected})]})]}),Ge.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:v.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:v.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:Ct.map(([q,le])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:He(t,q)}),e.jsx("span",{className:"cogita-tag-count",children:le})]},`stack:type:${q}`))})]}):null,$t==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":v.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:v.detailColumnName}),e.jsx("span",{children:v.detailColumnType}),e.jsx("span",{children:v.detailColumnId}),e.jsx("span",{})]}),ct.length?ct.map(q=>{const le=He(t,q.infoType),Me=We.has(q.infoId),d=Be===q.infoId;return e.jsxs("div",{className:`cogita-details-row ${d||Me?"active":""}`,role:"row",onClick:()=>ye(q.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:Me,onChange:Se=>rt(q,Se.target.checked),onClick:Se=>Se.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:q.label,children:q.label}),e.jsx("span",{title:le,children:le}),e.jsx("span",{title:q.infoId,children:q.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:Se=>{Se.stopPropagation(),Lt(q.infoId)},"aria-label":v.editInfo,children:">"})]},q.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:v.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${$t}`,"data-view":$t,children:ct.length?ct.map(q=>{const le=He(t,q.infoType),Me=We.has(q.infoId),d=Be===q.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":d||Me,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:Me,onChange:Se=>rt(q,Se.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>ye(q.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:le}),e.jsx("h3",{className:"cogita-card-title",children:q.label}),e.jsx("p",{className:"cogita-card-subtitle",children:q.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Lt(q.infoId),children:v.editInfo})]})},q.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:v.noMatch})})}),yt?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>be(q=>q+tn),children:v.loadMore})}):null]})]})})})})}function Nr(t,n,s){if(t&&typeof t=="object"&&!Array.isArray(t)){const r=t,i=["title","name","label","value","text","quote","term"];for(const g of i){const h=r[g];if(typeof h=="string"&&h.trim())return h.trim()}}return`${n} · ${s}`}function Sr(t,n){try{const s=n==="pl"?"pl-PL":n==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(s,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function Tr(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function Cr(t,n){return t.totalReviews<=0?n.noKnownnessData:t.totalReviews<3||t.score<.35?n.developmentStart:t.totalReviews<8||t.score<.65?n.developmentGrowing:t.score<.85?n.developmentStable:n.developmentStrong}function Mr({links:t,emptyLabel:n}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([s,r])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(r)?r.length?e.jsx("div",{className:"cogita-selection-overview",children:r.map(i=>e.jsx("span",{className:"cogita-tag-chip",children:i},`${s}:${i}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):r?e.jsx("span",{className:"cogita-tag-chip",children:r}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},s))})}function Ea({value:t,emptyLabel:n}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:n});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((s,r)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(Ea,{value:s,emptyLabel:n})})]},r))});if(typeof t=="object"){const s=Object.entries(t);return s.length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:s.map(([r,i])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(Ea,{value:i,emptyLabel:n})})]},r))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const na=5,zn=50,Dn=2,Bn=[];function Jt({libraryId:t,infoType:n,label:s,placeholder:r,value:i,onChange:g,values:h,onChangeMultiple:f,helperText:C,searchFailedText:M,createFailedText:c,createLabel:x,savingLabel:l,loadMoreLabel:m,inputRef:v,autoAdvance:S,onCommit:L,multiple:D}){const p=D?h??Bn:Bn,[u,ue]=a.useState(D?"":(i==null?void 0:i.label)??""),[P,y]=a.useState([]),[H,F]=a.useState(na),[X,E]=a.useState(-1),[K,ce]=a.useState(!1),[ge,be]=a.useState(!1),[Be,ye]=a.useState(null),$=a.useRef(0),ve=a.useRef(new Map),G=a.useMemo(()=>D?u.trim().length>0:u.trim().length>0&&!i,[u,i,D]);a.useEffect(()=>{D||ue((i==null?void 0:i.label)??"")},[i,D]),a.useEffect(()=>{const oe=u.trim();if(!oe||oe.length<Dn){y([]),ce(!1),F(na),E(-1),be(!1),ye(null);return}const te=oe.toLowerCase(),Te=`${t}:${n}:${te}`,Ie=ve.current.get(Te);if(Ie){if(D&&p.length>0){const ze=new Set(p.map($e=>$e.id));y(Ie.filter($e=>!ze.has($e.id)))}else y(Ie);F(na),E(-1),ce(Ie.length>0),be(!1),ye(null);return}const Ee=window.setTimeout(async()=>{const ze=Date.now();$.current=ze,be(!0),ye(null);try{const $e=await kn({libraryId:t,type:n,query:oe,limit:zn});if($.current!==ze)return;const qe=$e.slice(0,zn).map(_e=>({id:_e.infoId,label:_e.label,infoType:_e.infoType}));if(ve.current.set(Te,qe),D&&p.length>0){const _e=new Set(p.map(De=>De.id));y(qe.filter(De=>!_e.has(De.id)))}else y(qe);F(na),E(-1),ce(!0)}catch{if($.current!==ze)return;ye(M??"Search failed.")}finally{$.current===ze&&be(!1)}},250);return()=>window.clearTimeout(Ee)},[t,n,u,p]);const ee=oe=>{if(D){const te=p.some(Te=>Te.id===oe.id)?p:[...p,oe];f==null||f(te),ue(""),ce(!1),E(-1);return}g==null||g(oe),ue(oe.label),ce(!1),E(-1),S&&(L==null||L())},Le=async()=>{const oe=u.trim();if(oe){be(!0),ye(null);try{const te=await fn({libraryId:t,infoType:n,payload:{label:oe}}),Te={id:te.infoId,label:oe,infoType:te.infoType};if(oe.length>=Dn){const Ie=`${t}:${n}:${oe.toLowerCase()}`,Ee=ve.current.get(Ie)??[];ve.current.set(Ie,[Te,...Ee])}if(D){f==null||f([...p,Te]),ue(""),ce(!1),E(-1);return}g==null||g(Te),ce(!1),E(-1),S&&(L==null||L())}catch{ye(c??"Create failed.")}finally{be(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:s}),e.jsx("input",{value:u,placeholder:r,onChange:oe=>{ue(oe.target.value),!D&&i&&(g==null||g(null))},onKeyDown:oe=>{if(oe.key==="ArrowDown"){if(oe.preventDefault(),!P.length)return;ce(!0),E(te=>{const Te=Math.min(P.length,H)-1,Ie=te<0?0:Math.min(te+1,Te);return Ie===Te&&P.length>H?(F(Ee=>Math.min(Ee+na,P.length)),Math.min(te+1,Math.min(P.length,H+na)-1)):Ie});return}if(oe.key==="ArrowUp"){if(oe.preventDefault(),!P.length)return;ce(!0),E(te=>te<=0?0:te-1);return}if(oe.key==="Enter"){if(oe.preventDefault(),X>=0&&P[X]){ee(P[X]);return}if(G){Le();return}}},onFocus:()=>{P.length>0&&ce(!0)},autoComplete:"off",ref:v})]}),D&&p.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:p.map(oe=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>f==null?void 0:f(p.filter(te=>te.id!==oe.id)),children:[oe.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},oe.id))}),C&&e.jsx("p",{className:"cogita-help",children:C}),Be&&e.jsx("p",{className:"cogita-error",children:Be}),K&&P.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[P.slice(0,H).map((oe,te)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":te===X,onClick:()=>ee(oe),children:[e.jsx("strong",{children:oe.label}),e.jsx("span",{children:oe.infoType})]},oe.id)),H<P.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>F(oe=>Math.min(oe+na,P.length)),children:m??"Load more"})]}),G&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:Le,disabled:ge,children:ge?l??"Saving...":x??`Create new ${n}`})]})}const _n=[{id:"gen",la:{abbr:"Gen",name:"Genesis"},en:{abbr:"Gen",name:"Genesis"},de:{abbr:"Gen",name:"Genesis"},pl:{abbr:"Rdz",name:"Księga Rodzaju"}},{id:"ex",la:{abbr:"Ex",name:"Exodus"},en:{abbr:"Ex",name:"Exodus"},de:{abbr:"Ex",name:"Exodus"},pl:{abbr:"Wj",name:"Księga Wyjścia"}},{id:"lev",la:{abbr:"Lev",name:"Leviticus"},en:{abbr:"Lev",name:"Leviticus"},de:{abbr:"Lev",name:"Levitikus"},pl:{abbr:"Kpł",name:"Księga Kapłańska"}},{id:"num",la:{abbr:"Num",name:"Numeri"},en:{abbr:"Num",name:"Numbers"},de:{abbr:"Num",name:"Numeri"},pl:{abbr:"Lb",name:"Księga Liczb"}},{id:"deut",la:{abbr:"Deut",name:"Deuteronomium"},en:{abbr:"Deut",name:"Deuteronomy"},de:{abbr:"Dtn",name:"Deuteronomium"},pl:{abbr:"Pwt",name:"Księga Powtórzonego Prawa"}},{id:"ios",la:{abbr:"Ios",name:"Iosue"},en:{abbr:"Josh",name:"Joshua"},de:{abbr:"Jos",name:"Josua"},pl:{abbr:"Joz",name:"Księga Jozuego"}},{id:"iudg",la:{abbr:"Iudg",name:"Iudicum"},en:{abbr:"Judg",name:"Judges"},de:{abbr:"Ri",name:"Richter"},pl:{abbr:"Sdz",name:"Księga Sędziów"}},{id:"ruth",la:{abbr:"Ruth",name:"Ruth"},en:{abbr:"Ruth",name:"Ruth"},de:{abbr:"Rut",name:"Rut"},pl:{abbr:"Rt",name:"Księga Rut"}},{id:"1sam",la:{abbr:"1 Sam",name:"I Samuelis"},en:{abbr:"1 Sam",name:"1 Samuel"},de:{abbr:"1 Sam",name:"1 Samuel"},pl:{abbr:"1 Sm",name:"1 Księga Samuela"}},{id:"2sam",la:{abbr:"2 Sam",name:"II Samuelis"},en:{abbr:"2 Sam",name:"2 Samuel"},de:{abbr:"2 Sam",name:"2 Samuel"},pl:{abbr:"2 Sm",name:"2 Księga Samuela"}},{id:"1reg",la:{abbr:"1 Reg",name:"I Regum"},en:{abbr:"1 Kgs",name:"1 Kings"},de:{abbr:"1 Kön",name:"1 Könige"},pl:{abbr:"1 Krl",name:"1 Księga Królewska"}},{id:"2reg",la:{abbr:"2 Reg",name:"II Regum"},en:{abbr:"2 Kgs",name:"2 Kings"},de:{abbr:"2 Kön",name:"2 Könige"},pl:{abbr:"2 Krl",name:"2 Księga Królewska"}},{id:"1par",la:{abbr:"1 Par",name:"I Paralipomenon"},en:{abbr:"1 Chr",name:"1 Chronicles"},de:{abbr:"1 Chr",name:"1 Chronik"},pl:{abbr:"1 Krn",name:"1 Księga Kronik"}},{id:"2par",la:{abbr:"2 Par",name:"II Paralipomenon"},en:{abbr:"2 Chr",name:"2 Chronicles"},de:{abbr:"2 Chr",name:"2 Chronik"},pl:{abbr:"2 Krn",name:"2 Księga Kronik"}},{id:"esd",la:{abbr:"Esd",name:"Esdrae"},en:{abbr:"Ezra",name:"Ezra"},de:{abbr:"Esra",name:"Esra"},pl:{abbr:"Ezd",name:"Księga Ezdrasza"}},{id:"neh",la:{abbr:"Neh",name:"Nehemiae"},en:{abbr:"Neh",name:"Nehemiah"},de:{abbr:"Neh",name:"Nehemia"},pl:{abbr:"Ne",name:"Księga Nehemiasza"}},{id:"tob",la:{abbr:"Tob",name:"Tobiae"},en:{abbr:"Tob",name:"Tobit"},de:{abbr:"Tob",name:"Tobit"},pl:{abbr:"Tb",name:"Księga Tobiasza"}},{id:"iudt",la:{abbr:"Iudt",name:"Iudith"},en:{abbr:"Jdt",name:"Judith"},de:{abbr:"Jdt",name:"Judit"},pl:{abbr:"Jdt",name:"Księga Judyty"}},{id:"est",la:{abbr:"Est",name:"Esther"},en:{abbr:"Est",name:"Esther"},de:{abbr:"Est",name:"Ester"},pl:{abbr:"Est",name:"Księga Estery"}},{id:"1macc",la:{abbr:"1 Macc",name:"I Maccabaeorum"},en:{abbr:"1 Mc",name:"1 Maccabees"},de:{abbr:"1 Makk",name:"1 Makkabäer"},pl:{abbr:"1 Mch",name:"1 Księga Machabejska"}},{id:"2macc",la:{abbr:"2 Macc",name:"II Maccabaeorum"},en:{abbr:"2 Mc",name:"2 Maccabees"},de:{abbr:"2 Makk",name:"2 Makkabäer"},pl:{abbr:"2 Mch",name:"2 Księga Machabejska"}},{id:"iob",la:{abbr:"Iob",name:"Iob"},en:{abbr:"Job",name:"Job"},de:{abbr:"Ijob",name:"Ijob"},pl:{abbr:"Hi",name:"Księga Hioba"}},{id:"ps",la:{abbr:"Ps",name:"Psalmi"},en:{abbr:"Ps",name:"Psalms"},de:{abbr:"Ps",name:"Psalmen"},pl:{abbr:"Ps",name:"Księga Psalmów"}},{id:"prov",la:{abbr:"Prov",name:"Proverbia"},en:{abbr:"Prov",name:"Proverbs"},de:{abbr:"Spr",name:"Sprichwörter"},pl:{abbr:"Prz",name:"Księga Przysłów"}},{id:"ecc",la:{abbr:"Ecc",name:"Ecclesiastes"},en:{abbr:"Eccl",name:"Ecclesiastes"},de:{abbr:"Koh",name:"Kohelet"},pl:{abbr:"Koh",name:"Księga Koheleta"}},{id:"cant",la:{abbr:"Cant",name:"Canticum Canticorum"},en:{abbr:"Song",name:"Song of Songs"},de:{abbr:"Hld",name:"Hoheslied"},pl:{abbr:"Pnp",name:"Pieśń nad Pieśniami"}},{id:"sap",la:{abbr:"Sap",name:"Sapientia"},en:{abbr:"Wis",name:"Wisdom"},de:{abbr:"Weish",name:"Weisheit"},pl:{abbr:"Mdr",name:"Księga Mądrości"}},{id:"sir",la:{abbr:"Sir",name:"Ecclesiasticus (Sirach)"},en:{abbr:"Sir",name:"Sirach"},de:{abbr:"Sir",name:"Jesus Sirach"},pl:{abbr:"Syr",name:"Mądrość Syracha"}},{id:"isa",la:{abbr:"Isa",name:"Isaias"},en:{abbr:"Isa",name:"Isaiah"},de:{abbr:"Jes",name:"Jesaja"},pl:{abbr:"Iz",name:"Księga Izajasza"}},{id:"ier",la:{abbr:"Ier",name:"Ieremias"},en:{abbr:"Jer",name:"Jeremiah"},de:{abbr:"Jer",name:"Jeremia"},pl:{abbr:"Jr",name:"Księga Jeremiasza"}},{id:"lam",la:{abbr:"Lam",name:"Lamentationes"},en:{abbr:"Lam",name:"Lamentations"},de:{abbr:"Klgl",name:"Klagelieder"},pl:{abbr:"Lm",name:"Lamentacje"}},{id:"bar",la:{abbr:"Bar",name:"Baruch"},en:{abbr:"Bar",name:"Baruch"},de:{abbr:"Bar",name:"Baruch"},pl:{abbr:"Ba",name:"Księga Barucha"}},{id:"ez",la:{abbr:"Ez",name:"Ezechiel"},en:{abbr:"Ezek",name:"Ezekiel"},de:{abbr:"Ez",name:"Ezechiel"},pl:{abbr:"Ez",name:"Księga Ezechiela"}},{id:"dan",la:{abbr:"Dan",name:"Daniel"},en:{abbr:"Dan",name:"Daniel"},de:{abbr:"Dan",name:"Daniel"},pl:{abbr:"Dn",name:"Księga Daniela"}},{id:"hos",la:{abbr:"Hos",name:"Osee"},en:{abbr:"Hos",name:"Hosea"},de:{abbr:"Hos",name:"Hosea"},pl:{abbr:"Oz",name:"Księga Ozeasza"}},{id:"ioel",la:{abbr:"Ioel",name:"Ioel"},en:{abbr:"Joel",name:"Joel"},de:{abbr:"Joel",name:"Joel"},pl:{abbr:"Jl",name:"Księga Joela"}},{id:"amos",la:{abbr:"Amos",name:"Amos"},en:{abbr:"Am",name:"Amos"},de:{abbr:"Am",name:"Amos"},pl:{abbr:"Am",name:"Księga Amosa"}},{id:"abd",la:{abbr:"Abd",name:"Abdias"},en:{abbr:"Obad",name:"Obadiah"},de:{abbr:"Obd",name:"Obadja"},pl:{abbr:"Abd",name:"Księga Abdiasza"}},{id:"ion",la:{abbr:"Ion",name:"Ionas"},en:{abbr:"Jon",name:"Jonah"},de:{abbr:"Jona",name:"Jona"},pl:{abbr:"Jon",name:"Księga Jonasza"}},{id:"mich",la:{abbr:"Mich",name:"Michaeas"},en:{abbr:"Mic",name:"Micah"},de:{abbr:"Mi",name:"Micha"},pl:{abbr:"Mi",name:"Księga Micheasza"}},{id:"nah",la:{abbr:"Nah",name:"Nahum"},en:{abbr:"Nah",name:"Nahum"},de:{abbr:"Nah",name:"Nahum"},pl:{abbr:"Na",name:"Księga Nahuma"}},{id:"hab",la:{abbr:"Hab",name:"Habacuc"},en:{abbr:"Hab",name:"Habakkuk"},de:{abbr:"Hab",name:"Habakuk"},pl:{abbr:"Ha",name:"Księga Habakuka"}},{id:"soph",la:{abbr:"Soph",name:"Sophonias"},en:{abbr:"Zeph",name:"Zephaniah"},de:{abbr:"Zef",name:"Zefanja"},pl:{abbr:"So",name:"Księga Sofoniasza"}},{id:"agg",la:{abbr:"Agg",name:"Aggaeus"},en:{abbr:"Hag",name:"Haggai"},de:{abbr:"Hag",name:"Haggai"},pl:{abbr:"Ag",name:"Księga Aggeusza"}},{id:"zach",la:{abbr:"Zach",name:"Zacharias"},en:{abbr:"Zech",name:"Zechariah"},de:{abbr:"Sach",name:"Sacharja"},pl:{abbr:"Za",name:"Księga Zachariasza"}},{id:"mal",la:{abbr:"Mal",name:"Malachias"},en:{abbr:"Mal",name:"Malachi"},de:{abbr:"Mal",name:"Maleachi"},pl:{abbr:"Ml",name:"Księga Malachiasza"}},{id:"mt",la:{abbr:"Mt",name:"Matthaeus"},en:{abbr:"Matt",name:"Matthew"},de:{abbr:"Mt",name:"Matthäus"},pl:{abbr:"Mt",name:"Ewangelia wg św. Mateusza"}},{id:"mc",la:{abbr:"Mc",name:"Marcus"},en:{abbr:"Mark",name:"Mark"},de:{abbr:"Mk",name:"Markus"},pl:{abbr:"Mk",name:"Ewangelia wg św. Marka"}},{id:"lc",la:{abbr:"Lc",name:"Lucas"},en:{abbr:"Luke",name:"Luke"},de:{abbr:"Lk",name:"Lukas"},pl:{abbr:"Łk",name:"Ewangelia wg św. Łukasza"}},{id:"io",la:{abbr:"Io",name:"Ioannes"},en:{abbr:"John",name:"John"},de:{abbr:"Joh",name:"Johannes"},pl:{abbr:"J",name:"Ewangelia wg św. Jana"}},{id:"act",la:{abbr:"Act",name:"Actus Apostolorum"},en:{abbr:"Acts",name:"Acts"},de:{abbr:"Apg",name:"Apostelgeschichte"},pl:{abbr:"Dz",name:"Dzieje Apostolskie"}},{id:"rom",la:{abbr:"Rom",name:"ad Romanos"},en:{abbr:"Rom",name:"Romans"},de:{abbr:"Röm",name:"Römer"},pl:{abbr:"Rz",name:"List do Rzymian"}},{id:"1cor",la:{abbr:"1 Cor",name:"I ad Corinthios"},en:{abbr:"1 Cor",name:"1 Corinthians"},de:{abbr:"1 Kor",name:"1 Korinther"},pl:{abbr:"1 Kor",name:"1 List do Koryntian"}},{id:"2cor",la:{abbr:"2 Cor",name:"II ad Corinthios"},en:{abbr:"2 Cor",name:"2 Corinthians"},de:{abbr:"2 Kor",name:"2 Korinther"},pl:{abbr:"2 Kor",name:"2 List do Koryntian"}},{id:"gal",la:{abbr:"Gal",name:"ad Galatas"},en:{abbr:"Gal",name:"Galatians"},de:{abbr:"Gal",name:"Galater"},pl:{abbr:"Ga",name:"List do Galatów"}},{id:"eph",la:{abbr:"Eph",name:"ad Ephesios"},en:{abbr:"Eph",name:"Ephesians"},de:{abbr:"Eph",name:"Epheser"},pl:{abbr:"Ef",name:"List do Efezjan"}},{id:"phil",la:{abbr:"Phil",name:"ad Philippenses"},en:{abbr:"Phil",name:"Philippians"},de:{abbr:"Phil",name:"Philipper"},pl:{abbr:"Flp",name:"List do Filipian"}},{id:"col",la:{abbr:"Col",name:"ad Colossenses"},en:{abbr:"Col",name:"Colossians"},de:{abbr:"Kol",name:"Kolosser"},pl:{abbr:"Kol",name:"List do Kolosan"}},{id:"1thess",la:{abbr:"1 Thess",name:"I ad Thessalonicenses"},en:{abbr:"1 Thess",name:"1 Thessalonians"},de:{abbr:"1 Thess",name:"1 Thessalonicher"},pl:{abbr:"1 Tes",name:"1 List do Tesaloniczan"}},{id:"2thess",la:{abbr:"2 Thess",name:"II ad Thessalonicenses"},en:{abbr:"2 Thess",name:"2 Thessalonians"},de:{abbr:"2 Thess",name:"2 Thessalonicher"},pl:{abbr:"2 Tes",name:"2 List do Tesaloniczan"}},{id:"1tim",la:{abbr:"1 Tim",name:"I ad Timotheum"},en:{abbr:"1 Tim",name:"1 Timothy"},de:{abbr:"1 Tim",name:"1 Timotheus"},pl:{abbr:"1 Tm",name:"1 List do Tymoteusza"}},{id:"2tim",la:{abbr:"2 Tim",name:"II ad Timotheum"},en:{abbr:"2 Tim",name:"2 Timothy"},de:{abbr:"2 Tim",name:"2 Timotheus"},pl:{abbr:"2 Tm",name:"2 List do Tymoteusza"}},{id:"tit",la:{abbr:"Tit",name:"ad Titum"},en:{abbr:"Titus",name:"Titus"},de:{abbr:"Tit",name:"Titus"},pl:{abbr:"Tt",name:"List do Tytusa"}},{id:"phlm",la:{abbr:"Phlm",name:"ad Philemonem"},en:{abbr:"Phlm",name:"Philemon"},de:{abbr:"Phlm",name:"Philemon"},pl:{abbr:"Flm",name:"List do Filemona"}},{id:"heb",la:{abbr:"Heb",name:"ad Hebraeos"},en:{abbr:"Heb",name:"Hebrews"},de:{abbr:"Hebr",name:"Hebräer"},pl:{abbr:"Hbr",name:"List do Hebrajczyków"}},{id:"iac",la:{abbr:"Iac",name:"Iacobi"},en:{abbr:"Jas",name:"James"},de:{abbr:"Jak",name:"Jakobus"},pl:{abbr:"Jk",name:"List św. Jakuba"}},{id:"1pet",la:{abbr:"1 Pet",name:"I Petri"},en:{abbr:"1 Pet",name:"1 Peter"},de:{abbr:"1 Petr",name:"1 Petrus"},pl:{abbr:"1 P",name:"1 List św. Piotra"}},{id:"2pet",la:{abbr:"2 Pet",name:"II Petri"},en:{abbr:"2 Pet",name:"2 Peter"},de:{abbr:"2 Petr",name:"2 Petrus"},pl:{abbr:"2 P",name:"2 List św. Piotra"}},{id:"1io",la:{abbr:"1 Io",name:"I Ioannis"},en:{abbr:"1 John",name:"1 John"},de:{abbr:"1 Joh",name:"1 Johannes"},pl:{abbr:"1 J",name:"1 List św. Jana"}},{id:"2io",la:{abbr:"2 Io",name:"II Ioannis"},en:{abbr:"2 John",name:"2 John"},de:{abbr:"2 Joh",name:"2 Johannes"},pl:{abbr:"2 J",name:"2 List św. Jana"}},{id:"3io",la:{abbr:"3 Io",name:"III Ioannis"},en:{abbr:"3 John",name:"3 John"},de:{abbr:"3 Joh",name:"3 Johannes"},pl:{abbr:"3 J",name:"3 List św. Jana"}},{id:"iud",la:{abbr:"Iud",name:"Iudae"},en:{abbr:"Jude",name:"Jude"},de:{abbr:"Jud",name:"Judas"},pl:{abbr:"Jud",name:"List św. Judy"}},{id:"apoc",la:{abbr:"Apoc",name:"Apocalypsis Ioannis"},en:{abbr:"Rev",name:"Revelation"},de:{abbr:"Offb",name:"Offenbarung"},pl:{abbr:"Ap",name:"Apokalipsa św. Jana"}}],Vn=8;function On({libraryId:t,copy:n,language:s,sourceKindOptions:r,value:i,onChange:g,labels:h}){const[f,C]=a.useState(!1),[M,c]=a.useState(-1),x=a.useMemo(()=>{const S=s;return _n.map(L=>{var u;const D=(L==null?void 0:L[S])??(L==null?void 0:L.en)??(L==null?void 0:L.la);return{label:`${D.abbr} — ${D.name}`,latin:((u=L==null?void 0:L.la)==null?void 0:u.abbr)??D.abbr}})},[s]),l=(S,L=!1)=>{const D=S.trim().toLowerCase();return D?x.filter(p=>p.label.toLowerCase().includes(D)).slice(0,Vn):L?x.slice(0,Vn):[]},m=(S,L)=>{const D=S.trim().toLowerCase();if(!D)return null;const p=_n;for(const u of p){const ue=u==null?void 0:u.la,P=(u==null?void 0:u[L])??(u==null?void 0:u.en)??ue,y=(P==null?void 0:P.abbr)??"",H=(P==null?void 0:P.name)??"";if(y.toLowerCase()===D||H.toLowerCase()===D||`${y} — ${H}`.toLowerCase()===D)return{book:u,entry:P,la:ue}}return null};a.useEffect(()=>{if(i.sourceKind==="bible"&&i.locatorValue&&!f){const S=m(i.locatorValue,s);if(S){const L=`${S.entry.abbr} — ${S.entry.name}`;L!==i.bibleBookDisplay&&g({...i,bibleBookDisplay:L})}}},[s,i,f,g]);const v=S=>g({...i,...S});return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.sourceKindLabel}),e.jsx("select",{value:i.sourceKind,onChange:S=>v({sourceKind:S.target.value,churchDocument:null,bookMedia:null,work:null,locatorValue:"",locatorAux:"",bibleBookDisplay:""}),children:r.map(S=>e.jsx("option",{value:S.value,children:S.label},S.value))})]}),i.sourceKind==="bible"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-lookup full",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.bibleBookLabel}),e.jsx("input",{type:"text",value:i.bibleBookDisplay,onChange:S=>{const L=S.target.value;v({bibleBookDisplay:L,locatorValue:""}),C(!0),c(-1)},onKeyDown:S=>{var D;const L=l(i.bibleBookDisplay);if(L.length){if(S.key==="ArrowDown")S.preventDefault(),c(p=>Math.min(p+1,L.length-1));else if(S.key==="ArrowUp")S.preventDefault(),c(p=>Math.max(p-1,0));else if((S.key==="Enter"||S.key==="Tab")&&M>=0&&L[M]){const p=L[M],u=m(p.label,s);if(!u)return;v({bibleBookDisplay:p.label,locatorValue:((D=u.la)==null?void 0:D.abbr)??i.locatorValue}),C(!1)}}},onFocus:()=>C(!0),onBlur:()=>window.setTimeout(()=>C(!1),100),placeholder:h.bibleBookPlaceholder})]}),f&&l(i.bibleBookDisplay,!0).length>0&&e.jsx("div",{className:"cogita-lookup-results",children:l(i.bibleBookDisplay,!0).map((S,L)=>e.jsx("button",{type:"button",className:"cogita-lookup-option","data-active":L===M,tabIndex:-1,onMouseDown:()=>{var p;const D=m(S.label,s);D&&v({bibleBookDisplay:S.label,locatorValue:((p=D.la)==null?void 0:p.abbr)??i.locatorValue})},children:e.jsx("strong",{children:S.label})},S.latin))})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.bibleRestLabel}),e.jsx("input",{type:"text",value:i.locatorAux,onChange:S=>v({locatorAux:S.target.value}),placeholder:h.bibleRestPlaceholder})]})]}),i.sourceKind==="website"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceUrlLabel}),e.jsx("input",{type:"text",value:i.sourceUrl,onChange:S=>v({sourceUrl:S.target.value}),placeholder:n.cogita.library.add.info.sourceUrlPlaceholder})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceAccessedDateLabel}),e.jsx("input",{type:"text",value:i.sourceAccessedDate,onChange:S=>v({sourceAccessedDate:S.target.value}),placeholder:n.cogita.library.add.info.sourceAccessedDatePlaceholder})]})]}),i.sourceKind==="number_document"&&e.jsxs(e.Fragment,{children:[e.jsx(Jt,{libraryId:t,infoType:"work",label:h.churchDocumentLabel,placeholder:h.churchDocumentPlaceholder,value:i.churchDocument,onChange:S=>v({churchDocument:S}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:S=>v({locatorValue:S.target.value}),placeholder:h.locatorPlaceholder})]})]}),i.sourceKind==="work"&&e.jsx(Jt,{libraryId:t,infoType:"work",label:h.workLabel,placeholder:h.workPlaceholder,value:i.work,onChange:S=>v({work:S}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),i.sourceKind==="book"&&e.jsxs(e.Fragment,{children:[e.jsx(Jt,{libraryId:t,infoType:"media",label:h.bookLabel,placeholder:h.bookPlaceholder,value:i.bookMedia,onChange:S=>v({bookMedia:S}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.media),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:S=>v({locatorValue:S.target.value}),placeholder:h.locatorPlaceholder})]})]}),i.sourceKind!=="website"&&i.sourceKind!=="bible"&&i.sourceKind!=="book"&&i.sourceKind!=="number_document"&&e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:S=>v({locatorValue:S.target.value}),placeholder:h.locatorPlaceholder})]})]})}const qn=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}];function wa(){return{sourceKind:"string",locatorValue:"",locatorAux:"",bibleBookDisplay:"",sourceUrl:"",sourceAccessedDate:"",churchDocument:null,bookMedia:null,work:null}}function Un(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function Jn(t,n){if(!t||typeof t!="object")return n;const s=t,r=[s.label,s.name,s.title,s.text,s.orcid,s.email,s.number];for(const i of r)if(typeof i=="string"&&i.trim())return i.trim();return n}function Hn(t,n){var r;if(!(t instanceof ps))return n;const s=(r=t.message)==null?void 0:r.trim();if(!s)return n;try{const i=JSON.parse(s);if(typeof i.error=="string"&&i.error.trim())return i.error.trim()}catch{}return s}function Ir(t){const n=t.trim();if(!n)return null;try{const s=JSON.parse(n);return s&&typeof s=="object"&&!Array.isArray(s)?s:null}catch{return null}}function _t(t,n){const s=t==null?void 0:t[n];return typeof s=="string"?s:""}function Lr(t,n){return n?t==="book"&&n.infoType==="media"?{bookMedia:n}:t==="work"&&n.infoType==="work"?{work:n}:t==="number_document"&&n.infoType==="work"?{churchDocument:n}:{}:{}}function $r(t,n){const s=wa(),r=(t.sourceKind??"").trim()||s.sourceKind,i=t.locator??"",g=Ir(i);let h="",f="",C="",M="",c="";return r==="website"?(M=_t(g,"url"),c=_t(g,"accessedDate"),h=_t(g,"value")):r==="bible"?(h=_t(g,"book")||i.trim(),f=_t(g,"passage")||_t(g,"rest"),C=_t(g,"bookDisplay")):g?(h=_t(g,"value")||_t(g,"locator"),f=_t(g,"aux")):h=i,{...s,sourceKind:r,locatorValue:h,locatorAux:f,bibleBookDisplay:C,sourceUrl:M,sourceAccessedDate:c,...Lr(r,n)}}function an(t){return t.sourceKind==="book"?t.bookMedia:t.sourceKind==="work"?t.work:t.sourceKind==="number_document"?t.churchDocument:null}function nn(t){const n=t.locatorValue.trim(),s=t.locatorAux.trim(),r=t.sourceUrl.trim(),i=t.sourceAccessedDate.trim();switch(t.sourceKind){case"website":return{url:r,accessedDate:i};case"bible":return{book:n,bookDisplay:t.bibleBookDisplay.trim(),passage:s};case"book":case"work":case"number_document":return s?{value:n,aux:s}:n;default:return s?{value:n,aux:s}:n}}function Wn(t){var i,g,h;const n=t.locatorValue.trim(),s=t.locatorAux.trim(),r=[n,s].filter(Boolean).join(" ");switch(t.sourceKind){case"website":return t.sourceUrl.trim()||"website";case"bible":return r||"bible";case"book":return[(i=t.bookMedia)==null?void 0:i.label,r].filter(Boolean).join(" · ")||"book";case"work":return[(g=t.work)==null?void 0:g.label,r].filter(Boolean).join(" · ")||"work";case"number_document":return[(h=t.churchDocument)==null?void 0:h.label,r].filter(Boolean).join(" · ")||"number_document";default:return r||t.sourceKind||"source"}}function Gn(t){return t.sourceKind.trim()?t.sourceKind==="website"?!!t.sourceUrl.trim():t.sourceKind==="bible"?!!(t.locatorValue.trim()&&t.locatorAux.trim()):t.sourceKind==="book"?!!t.bookMedia:t.sourceKind==="work"?!!t.work:t.sourceKind==="number_document"?!!(t.churchDocument&&t.locatorValue.trim()):!!t.locatorValue.trim():!1}function Rr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,libraryId:c,editInfoId:x}){var tt,Ae,ke;const{libraryName:l}=Wt(c),m=!!x,[v,S]=a.useState([]),[L,D]=a.useState("word"),[p,u]=a.useState({}),[ue,P]=a.useState({}),[y,H]=a.useState({}),[F,X]=a.useState({}),[E,K]=a.useState(null),[ce,ge]=a.useState("idle"),[be,Be]=a.useState(wa),[ye,$]=a.useState({}),[ve,G]=a.useState({}),[ee,Le]=a.useState({}),[oe,te]=a.useState(null),Te=a.useMemo(()=>v.find(U=>U.infoType===L),[L,v]),Ie=a.useMemo(()=>v.find(U=>U.infoType==="source"),[v]),Ee=a.useMemo(()=>v.map(U=>({value:U.infoType,label:He(t,U.infoType)})),[t,v]);a.useEffect(()=>{let U=!1;return Ps({libraryId:c}).then(Re=>{var J;if(!U&&(S(Re),!m)){const Q=(J=Re[0])==null?void 0:J.infoType;Q&&D(Q)}}).catch(()=>{U||S([])}),()=>{U=!0}},[m,c]),a.useEffect(()=>{if(m||!Te)return;const U={},Re={},J={},Q={};for(const Ne of Te.payloadFields)U[Ne.key]="";for(const Ne of Te.linkFields)Ne.multiple?J[Ne.key]=[]:Re[Ne.key]=null,Ne.targetTypes.length>0&&(Q[Ne.key]=Ne.targetTypes[0]);u(U),P(Re),H(J),X(Q)},[Te==null?void 0:Te.infoType,m]),a.useEffect(()=>{if(!m||!x||v.length===0)return;let U=!1;return ge("loading"),K(null),(async()=>{const J=await Qt({libraryId:c,infoId:x});if(U)return;const Q=J.infoType;D(Q);const Ne=v.find(O=>O.infoType===Q);if(!Ne){ge("idle");return}const Ve=J.payload??{},z={};for(const O of Ne.payloadFields)z[O.key]=Un(Ve[O.key]);u(z);const w=J.links??{}??{},Z={},de={},T={},I=[];for(const O of Ne.linkFields){O.targetTypes.length>0&&(T[O.key]=O.targetTypes[0]);const ae=w[O.key];if(O.multiple){const ne=Array.isArray(ae)?ae.filter(we=>typeof we=="string"):[];de[O.key]=[];for(const we of ne)I.push(Qt({libraryId:c,infoId:we}).then(Ce=>{if(U)return;const Ke={id:we,infoType:Ce.infoType,label:Jn(Ce.payload,we)};T[O.key]=Ke.infoType,de[O.key]=[...de[O.key],Ke]}).catch(()=>{}))}else{const ne=typeof ae=="string"?ae:null;Z[O.key]=null,ne&&I.push(Qt({libraryId:c,infoId:ne}).then(we=>{if(U)return;const Ce={id:ne,infoType:we.infoType,label:Jn(we.payload,ne)};T[O.key]=Ce.infoType,Z[O.key]=Ce}).catch(()=>{}))}}await Promise.all(I),!U&&(P(Z),H(de),X(T),ge("idle"))})().catch(()=>{U||(K("Failed to load info details."),ge("idle"))}),()=>{U=!0}},[x,m,c,v]),a.useEffect(()=>{L==="source"&&Be($r(p,ue.resource??null))},[L,p.sourceKind,p.locator,(tt=ue.resource)==null?void 0:tt.id,(Ae=ue.resource)==null?void 0:Ae.infoType,(ke=ue.resource)==null?void 0:ke.label]);const ze=U=>{var Ne,Ve;const Re=((Ne=Ie==null?void 0:Ie.payloadFields.find(z=>z.key==="sourceKind"))==null?void 0:Ne.keepOnCreate)??!1,J=((Ve=Ie==null?void 0:Ie.linkFields.find(z=>z.key==="resource"))==null?void 0:Ve.keepOnCreate)??!1,Q=wa();return Q.sourceKind=Re?U.sourceKind:Q.sourceKind,J&&(Q.work=U.work,Q.bookMedia=U.bookMedia,Q.churchDocument=U.churchDocument),Re&&U.sourceKind==="bible"&&(Q.locatorValue=U.locatorValue,Q.bibleBookDisplay=U.bibleBookDisplay),Re&&U.sourceKind==="website"&&(Q.sourceUrl=U.sourceUrl,Q.sourceAccessedDate=U.sourceAccessedDate),Q},$e=a.useMemo(()=>({sourceKindLabel:t.cogita.library.add.info.sourceKindLabel,bibleBookLabel:t.cogita.library.add.info.sourceBibleBookLabel,bibleBookPlaceholder:t.cogita.library.add.info.sourceBibleBookPlaceholder,bibleRestLabel:t.cogita.library.add.info.sourceBibleRestLabel,bibleRestPlaceholder:t.cogita.library.add.info.sourceBibleRestPlaceholder,churchDocumentLabel:t.cogita.library.add.info.sourceResourceLabel,churchDocumentPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,workLabel:t.cogita.library.add.info.sourceResourceLabel,workPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,bookLabel:t.cogita.library.add.info.sourceResourceLabel,bookPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,locatorLabel:t.cogita.library.list.typeFilterLocator,locatorPlaceholder:t.cogita.library.list.typeFilterLocator}),[t]),qe=async U=>{const Re=ve[U]??wa();if(!Gn(Re)){Le(J=>({...J,[U]:t.cogita.library.add.info.referenceMissingSource}));return}te(U),Le(J=>({...J,[U]:null}));try{const J=an(Re),Q=J?{resource:J.id}:{},Ne={label:Wn(Re),sourceKind:Re.sourceKind.trim(),locator:nn(Re)},z={id:(await fn({libraryId:c,infoType:"source",payload:Ne,links:Q})).infoId,infoType:"source",label:Ne.label};H(w=>{const Z=w[U]??[];return Z.some(de=>de.id===z.id)?w:{...w,[U]:[...Z,z]}}),G(w=>({...w,[U]:ze(Re)})),Le(w=>({...w,[U]:null}))}catch(J){Le(Q=>({...Q,[U]:Hn(J,t.cogita.library.lookup.createFailed)}))}finally{te(J=>J===U?null:J)}},_e=async()=>{var J;if(!Te)return;const U={};for(const Q of Te.payloadFields){if(L==="source"&&(Q.key==="sourceKind"||Q.key==="locator"))continue;const Ne=(p[Q.key]??"").trim();if(!Ne){if(Q.required){K(`Field '${Q.label}' is required.`);return}continue}if(Q.inputType==="json")try{U[Q.key]=JSON.parse(Ne)}catch{K(`Field '${Q.label}' must be valid JSON.`);return}else U[Q.key]=Ne}const Re={};for(const Q of Te.linkFields)if(!(L==="source"&&Q.key==="resource"))if(Q.multiple){const Ne=(y[Q.key]??[]).map(Ve=>Ve.id);if(Q.required&&Ne.length===0){K(`Link '${Q.label}' is required.`);return}Ne.length>0&&(Re[Q.key]=Ne)}else{const Ne=((J=ue[Q.key])==null?void 0:J.id)??null;if(Q.required&&!Ne){K(`Link '${Q.label}' is required.`);return}Ne&&(Re[Q.key]=Ne)}if(L==="source"){if(!Gn(be)){K(t.cogita.library.add.info.referenceMissingSource);return}const Q=be.sourceKind.trim();U.sourceKind=Q,U.locator=nn(be),(typeof U.label!="string"||!U.label.trim())&&(U.label=Wn(be));const Ne=an(be);Ne&&(Re.resource=Ne.id)}ge("saving"),K(null);try{if(m&&x)await Ks({libraryId:c,infoId:x,payload:U,links:Re}),K("Info updated.");else{await fn({libraryId:c,infoType:L,payload:U,links:Re}),K("Info saved.");const Q={};for(const z of Te.payloadFields)Q[z.key]=z.keepOnCreate?p[z.key]??"":"";u(Q);const Ne={},Ve={};for(const z of Te.linkFields)z.multiple?Ve[z.key]=z.keepOnCreate?y[z.key]??[]:[]:Ne[z.key]=z.keepOnCreate?ue[z.key]??null:null;P(z=>({...z,...Ne})),H(z=>({...z,...Ve})),L==="source"&&Be(z=>{const w=ze(z),Z=an(w);return u(de=>({...de,sourceKind:w.sourceKind,locator:Un(nn(w))})),P(de=>({...de,resource:Z})),Z&&X(de=>({...de,resource:Z.infoType})),w})}}catch(Q){K(Hn(Q,"Failed to save info."))}finally{ge("idle")}},De=U=>{const Re=p[U.key]??"",J=U.inputType==="textarea"||U.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:U.label}),J?e.jsx("textarea",{rows:U.inputType==="json"?8:4,value:Re,onChange:Q=>u(Ne=>({...Ne,[U.key]:Q.target.value})),placeholder:U.key}):e.jsx("input",{type:"text",value:Re,onChange:Q=>u(Ne=>({...Ne,[U.key]:Q.target.value})),placeholder:U.key})]},`payload:${U.key}`)},Ue=U=>{const Re=F[U.key]??U.targetTypes[0],J=U.key==="references"&&U.multiple&&U.targetTypes.includes("source"),Q=ve[U.key]??wa(),Ne=ye[U.key]??!1,Ve=ee[U.key];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:U.label}),U.targetTypes.length>1?e.jsx("select",{value:Re,onChange:z=>X(w=>({...w,[U.key]:z.target.value})),children:U.targetTypes.map(z=>e.jsx("option",{value:z,children:He(t,z)},`${U.key}:${z}`))}):null,U.multiple?e.jsx(Jt,{libraryId:c,infoType:Re,label:U.label,placeholder:U.key,multiple:!0,values:y[U.key]??[],onChangeMultiple:z=>H(w=>({...w,[U.key]:z})),searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(Jt,{libraryId:c,infoType:Re,label:U.label,placeholder:U.key,value:ue[U.key]??null,onChange:z=>P(w=>({...w,[U.key]:z})),searchFailedText:"Search failed",createFailedText:"Create failed"}),J?e.jsxs("div",{children:[e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:Ne,onChange:z=>$(w=>({...w,[U.key]:z.target.checked}))}),e.jsx("span",{children:t.cogita.library.add.info.referenceToggle})]}),Ne?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(On,{libraryId:c,copy:t,language:C,sourceKindOptions:[...qn],value:Q,onChange:z=>G(w=>({...w,[U.key]:z})),labels:$e}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>qe(U.key),disabled:oe===U.key,children:oe===U.key?t.cogita.library.lookup.saving:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.source)})}),Ve?e.jsx("p",{className:"cogita-library-subtitle",children:Ve}):null]}):null]}):null]},`link:${U.key}`)},ot=()=>e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(On,{libraryId:c,copy:t,language:C,sourceKindOptions:[...qn],value:be,onChange:Be,labels:$e})]});return e.jsx(Tt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:m?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${c}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[m?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:L,onChange:U=>D(U.target.value),children:Ee.map(U=>e.jsx("option",{value:U.value,children:U.label},U.value))})]}),ce==="loading"&&m?e.jsx("p",{children:"Loading..."}):null,Te&&!(ce==="loading"&&m)?e.jsxs("div",{className:"cogita-form-grid",children:[Te.payloadFields.filter(U=>!(L==="source"&&(U.key==="sourceKind"||U.key==="locator"))).map(De),L==="source"?ot():null,Te.linkFields.filter(U=>!(L==="source"&&U.key==="resource")).map(Ue)]}):ce==="loading"&&m?null:e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:_e,disabled:ce==="saving"||!Te,children:ce==="saving"?"Saving...":m?"Update info":"Create info"})}),E?e.jsx("p",{className:"cogita-library-subtitle",children:E}):null]})})})]})})}const Yn=t=>/\s/.test(t),Aa=t=>/[\p{L}\p{N}]/u.test(t),Qn=(t,n)=>{const s=n>0?t[n-1]:"",r=n<t.length?t[n]:"";if(!s||!r)return 0;const i=Yn(s),g=Yn(r);if(i||g)return 3;const h=Aa(s),f=Aa(r);return h!==f?2:!h&&!f?1:0},sn=(t,n,s,r,i)=>{const g=Math.max(r-n,s-r);for(let h=0;h<=g;h+=1){const f=r-h;if(f>=n&&f<=s&&Qn(t,f)>=i)return f;const C=r+h;if(C>=n&&C<=s&&Qn(t,C)>=i)return C}return null},rn=(t,n)=>{const s=n>0?t[n-1]:"",r=n<t.length?t[n]:"";return!s||!r?!0:Aa(s)!==Aa(r)},Er=(t,n,s,r)=>{const i=s-n,g=n+r,h=s-r;if(i<=r*2||h<=g)return null;const f=Math.floor((n+s)/2),C=sn(t,g,h,f,3);if(C!==null&&rn(t,C))return C;const M=sn(t,g,h,f,2);if(M!==null&&rn(t,M))return M;const c=sn(t,g,h,f,1);return c!==null&&rn(t,c)?c:null},sa=(t,n)=>{const s=Math.max(1,7),r=Math.max(s,13),i={},g=(C,M,c,x,l)=>{const m=String(x),v={id:m,start:C,end:M,text:t.slice(C,M),depth:c,index:x,parentId:l};if(i[m]=v,M-C>r){let L=Er(t,C,M,s);if(L!==null&&L>C&&L<M){const D=g(C,L,c+1,x*2+1,m),p=g(L,M,c+1,x*2+2,m);v.leftId=D.id,v.rightId=p.id}}return v},h=g(0,t.length,0,0),f=Object.values(i).sort((C,M)=>M.depth-C.depth||C.start-M.start).map(C=>C.id);return{text:t,rootId:h.id,nodes:i,order:f}},ha=(t,n,s,r,i,g,h)=>{const f=g==="reverse"?t.order.slice().sort((C,M)=>t.nodes[M].start-t.nodes[C].start||t.nodes[M].depth-t.nodes[C].depth):t.order;for(const C of f){if(h&&C===h||n.has(C))continue;const M=t.nodes[C];if(M){if(i&&(M.leftId||M.rightId)){const c=M.leftId?s[M.leftId]??0:r,x=M.rightId?s[M.rightId]??0:r;if((c+x)/2<r)continue}return M}}return null},Nn=(t,n)=>({before:t.slice(0,n.start),fragment:t.slice(n.start,n.end),after:t.slice(n.end)});function Ar({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,libraryId:c}){const x=`/#/cogita/library/${c}`,[l,m,v]=rs([]),[S,L,D]=is([]),[p,u]=a.useState(null),[ue,P]=a.useState(null),[y,H]=a.useState(null),[F,X]=a.useState(null),E=a.useMemo(()=>l.find($=>$.id===p)??null,[l,p]);a.useEffect(()=>{let $=!0;return Fs({libraryId:c}).then(ve=>{if(!$)return;const G=ve.nodes.map(ee=>{var Le,oe,te;return{id:ee.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:ee.payload&&typeof ee.payload=="object"&&"label"in ee.payload?String(ee.payload.label):"Item",nodeType:ee.nodeType,itemType:((Le=ee.payload)==null?void 0:Le.itemType)??"info",itemId:((oe=ee.payload)==null?void 0:oe.itemId)??null,infoType:((te=ee.payload)==null?void 0:te.infoType)??null}}});m(G),L(ve.edges.map(ee=>({id:ee.edgeId,source:ee.fromNodeId,target:ee.toNodeId})))}).catch(()=>{$&&(m([]),L([]))}),()=>{$=!1}},[c]),a.useEffect(()=>{zs({libraryId:c}).then(P).catch(()=>P(null))},[c,l,S]);const K=a.useCallback($=>{L(ve=>os($,ve))},[]),ce=()=>{const $=crypto.randomUUID();m(ve=>[...ve,{id:$,type:"default",position:{x:140+ve.length*40,y:120+ve.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},ge=()=>{const $=crypto.randomUUID();m(ve=>[...ve,{id:$,type:"default",position:{x:180+ve.length*40,y:160+ve.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},be=async()=>{H(null);try{const $=l.map(G=>({nodeId:G.id,nodeType:G.data.nodeType,payload:{itemType:G.data.itemType,itemId:G.data.itemId??null,label:G.data.label,infoType:G.data.infoType??null}})),ve=S.map(G=>({edgeId:G.id,fromNodeId:G.source,toNodeId:G.target}));await Ds({libraryId:c,nodes:$,edges:ve}),H(t.cogita.library.graph.saveSuccess)}catch{H(t.cogita.library.graph.saveFail)}},Be=$=>{E&&m(ve=>ve.map(G=>G.id===E.id?{...G,data:{...G.data,itemId:($==null?void 0:$.infoId)??null,itemType:"collection",infoType:"collection",label:($==null?void 0:$.label)??t.cogita.library.infoTypes.collection}}:G))},ye=$=>{E&&m(ve=>ve.map(G=>G.id===E.id?{...G,data:{...G.data,itemId:($==null?void 0:$.infoId)??null,itemType:"info",infoType:($==null?void 0:$.infoType)??null,label:($==null?void 0:$.label)??t.cogita.library.infoTypes.any}}:G))};return a.useEffect(()=>{if(!E||E.data.nodeType!=="info"||E.data.infoType!=="citation"||!E.data.itemId){X(null);return}let $=!0;return Qt({libraryId:c,infoId:E.data.itemId}).then(ve=>{if(!$)return;const G=ve.payload,ee=(G==null?void 0:G.text)??"";if(!ee){X(null);return}const Le=sa(ee),oe=Object.values(Le.nodes).sort((te,Te)=>te.depth-Te.depth||te.start-Te.start).map(te=>({id:te.id,text:te.text,depth:te.depth}));X({title:(G==null?void 0:G.title)??E.data.label,fragments:oe})}).catch(()=>X(null)),()=>{$=!1}},[c,E]),e.jsx(Tt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:x,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:be,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ce,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ge,children:t.cogita.library.actions.addInfo}),ue?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(ue.totalCollections))})}):null,y?e.jsx("p",{className:"cogita-help",children:y}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(xn,{nodes:l,edges:S,onNodesChange:v,onEdgesChange:D,onConnect:K,onNodeClick:($,ve)=>u(ve.id),fitView:!0,children:[e.jsx(vn,{gap:18,size:1}),e.jsx(wn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),E?e.jsxs("div",{className:"cogita-graph-inspector",children:[E.data.nodeType==="collection"?e.jsx(Jt,{libraryId:c,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:E.data.itemId?{id:E.data.itemId,label:E.data.label,infoType:"collection"}:null,onChange:Be,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(Jt,{libraryId:c,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:E.data.itemId?{id:E.data.itemId,label:E.data.label,infoType:E.data.infoType??void 0}:null,onChange:ye,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),F?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:F.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:F.fragments.map($=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:$.id}),e.jsx("span",{children:$.text})]},$.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function Sn({children:t,flashState:n,flashTick:s=0,feedbackToken:r,className:i}){const g=r??(n?`${n}-${s}`:"idle");return e.jsx("section",{className:i?`cogita-revision-card ${i}`:"cogita-revision-card","data-feedback":g,children:t})}function Tn({copy:t,currentCard:n,currentTypeLabel:s,prompt:r,languages:i,answer:g,onAnswerChange:h,computedExpected:f,computedAnswers:C,onComputedAnswerChange:M,answerTemplate:c,outputVariables:x,variableValues:l,computedFieldFeedback:m,feedback:v,canAdvance:S,quoteContext:L,quotePlaceholder:D,onCheckAnswer:p,onSkip:u,onLanguageSelect:ue,onMarkReviewed:P,onAdvance:y,showCorrectAnswer:H,setShowCorrectAnswer:F,onRevealCorrect:X,answerMask:E,expectedAnswer:K,hasExpectedAnswer:ce,handleComputedKeyDown:ge,answerInputRef:be,computedInputRefs:Be,scriptMode:ye,setScriptMode:$,matchPairs:ve,matchLeftOrder:G,matchRightOrder:ee,matchSelection:Le,matchActiveLeft:oe,matchActiveRight:te,matchFeedback:Te,onMatchLeftSelect:Ie,onMatchRightSelect:Ee,disableCheckAnswer:ze=!1,hideSkipAction:$e=!1,allowRevealBeforeCheck:qe=!1,autoRevealAfterAnswer:_e=!1,disableCheckAfterAnswer:De=!1}){const Ue=a.useMemo(()=>{var Ke;const z=!c&&f.length===2?`The {${f[0].key}} is of type {${f[1].key}}`:null,w=c??z;if(!w)return null;const Z=new Map(f.map(ie=>[ie.key,ie.expected])),de=new Set,T=[],I=/\{([^}]+)\}/g;let O=0,ae,ne=null;for(;(ae=I.exec(w))!==null;){const ie=w.slice(O,ae.index);ie&&T.push({type:"text",value:ie});const pe=((Ke=ae[1])==null?void 0:Ke.trim())??"",he=pe&&Z.has(pe)?pe:pe&&x&&x[pe]?x[pe]:null;pe&&de.add(pe),he&&de.add(he),he&&Z.has(he)?(T.push({type:"input",value:he}),ne||(ne=he)):pe&&l&&l[pe]!==void 0?T.push({type:"text",value:l[pe]}):T.push({type:"text",value:ae[0]}),O=ae.index+ae[0].length}const we=w.slice(O);return we&&T.push({type:"text",value:we}),f.filter(ie=>!de.has(ie.key)).length>0?null:{parts:T,expectedByKey:Z,firstInputKey:ne}},[c,f,x,l]),ot=()=>{if(!Ue)return null;const{parts:z,expectedByKey:w,firstInputKey:Z}=Ue;return e.jsx("div",{className:"cogita-revision-inline-answer",children:z.map((de,T)=>{var I,O;return de.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:de.value},`text-${T}`):e.jsx("input",{ref:ae=>{Be.current[de.value]=ae},autoFocus:de.value===Z,value:C[de.value]??"",onChange:ae=>M(de.value,ae.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":m[de.value]??(v==="correct"?"correct":v==="incorrect"?"incorrect":void 0),onKeyDown:ae=>U(ae)||ge(ae),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((I=C[de.value])==null?void 0:I.length)??0,((O=w.get(de.value))==null?void 0:O.length)??6)}ch`}},`input-${de.value}-${T}`)})})},tt=a.useMemo(()=>{const z=new Map;return(ve??[]).forEach(w=>z.set(w.leftId,w)),z},[ve]),Ae=a.useMemo(()=>{const z=new Map;return(ve??[]).forEach(w=>z.set(w.rightId,w)),z},[ve]);a.useEffect(()=>{var T;if(n.cardType!=="info"||n.infoType!=="computed"||f.length===0)return;const z=typeof document<"u"?document.activeElement:null;if(z&&(z.tagName==="INPUT"||z.tagName==="TEXTAREA"))return;const w=(Ue==null?void 0:Ue.firstInputKey)??((T=f[0])==null?void 0:T.key);if(!w)return;const Z=Be.current[w];if(!Z)return;const de=requestAnimationFrame(()=>{Z.focus()});return()=>cancelAnimationFrame(de)},[n,f,Ue]);const ke=(()=>{const z=[K??"",...f.map(de=>de.expected??"")].join(""),w=[g,...Object.values(C)].join(""),Z=`${z}${w}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(Z)})(),U=z=>z.ctrlKey&&(z.key==="^"||z.key==="6")?(z.preventDefault(),$(w=>w==="super"?null:"super"),!0):z.ctrlKey&&(z.key==="_"||z.key==="-")?(z.preventDefault(),$(w=>w==="sub"?null:"sub"),!0):!1,Re=()=>{if(!K||!E)return K??"";const z=K.split(""),w=Array.from(E),Z=w.length>0?w.reduce((de,T)=>de+T,0)/w.length:127;return z.map((de,T)=>{const I=w[T]??Z,O=Math.max(0,Math.min(255,Math.round(I)));let ae=255,ne=0;return O<=127?ne=Math.round(O/127*255):(ne=255,ae=Math.round(255*(1-(O-127)/128))),e.jsx("span",{style:{color:`rgb(${ae}, ${ne}, 0)`},children:de},`mask-${T}`)})},J=n.cardType==="info"&&n.infoType==="citation"?(L==null?void 0:L.title)||n.label:n.description,Q=H||_e&&v!==null,Ne=ze||De&&(v!==null||Q),Ve=ce&&(qe||v==="incorrect"||Q);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[s?e.jsx("span",{children:s}):null,e.jsx("strong",{children:J})]}),n.cardType==="vocab"&&n.checkType==="translation-match"&&ve?e.jsxs("div",{className:"cogita-revision-body",children:[r?e.jsx("h2",{children:r}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(G??[]).map(z=>{const w=tt.get(z);if(!w)return null;const Z=(Le==null?void 0:Le[z])??null,de=(Te==null?void 0:Te[z])??null,T=oe===z;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":T,"data-state":de??void 0,"data-locked":Z?"true":void 0,onClick:()=>Ie==null?void 0:Ie(z),children:[e.jsx("span",{children:w.leftLabel}),Z&&H?e.jsx("em",{children:"✓"}):null]},z)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(ee??[]).map(z=>{const w=Ae.get(z);if(!w)return null;const Z=Object.values(Le??{}).includes(z),de=te===z;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":Z||de,"data-locked":Z?"true":void 0,onClick:()=>Ee==null?void 0:Ee(z),children:e.jsx("span",{children:w.rightLabel})},z)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:p,disabled:n.checkType==="translation-match"||Ne,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:u,children:t.cogita.library.revision.skip})]})]}):n.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:be,value:g,onChange:z=>h(z.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:z=>{if(z.key==="Enter")if(z.preventDefault(),z.stopPropagation(),S)y();else{if(Ne)return;p()}}})]}),ke?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":ye==="super",onClick:()=>$(z=>z==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":ye==="sub",onClick:()=>$(z=>z==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:p,disabled:Ne,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:u,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[n.label?e.jsx("p",{className:"cogita-revision-hint",children:n.label}):null,c?null:e.jsx(Bs,{value:r??"",mode:"auto"}),f.length>0?(()=>{const z=ot();return z?e.jsx("div",{className:"cogita-inline-answer-wrap",children:z}):e.jsx("div",{className:"cogita-form-grid",children:f.map((w,Z)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:w.key}),e.jsx("textarea",{ref:de=>{Be.current[w.key]=de},autoFocus:Z===0,value:C[w.key]??"",onChange:de=>M(w.key,de.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":m[w.key]??(v==="correct"?"correct":v==="incorrect"?"incorrect":void 0),onKeyDown:de=>U(de)||ge(de)})]},w.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:be,value:g,onChange:z=>h(z.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:z=>{if(!U(z)&&z.key==="Enter")if(z.preventDefault(),z.stopPropagation(),S)y();else{if(Ne)return;p()}}})]})}),ke?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":ye==="super",onClick:()=>$(z=>z==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":ye==="sub",onClick:()=>$(z=>z==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:p,disabled:Ne,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:u,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="citation"&&L?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(L.completed)).replace("{total}",String(L.total))}),e.jsx("p",{className:"cogita-quote-text",children:L.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:be,value:g,onChange:z=>h(z.target.value),placeholder:D??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:z=>{if(z.key==="Enter")if(z.preventDefault(),z.stopPropagation(),S)y();else{if(Ne)return;p()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:L.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:p,disabled:Ne,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:u,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:i.length?i.map(z=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>ue(z.label),children:z.label},z.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:u,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:P,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:u,children:t.cogita.library.revision.skip})]})]}),v&&e.jsx("div",{className:"cogita-revision-feedback","data-state":v,children:v==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),Ve?e.jsxs("div",{className:"cogita-revision-reveal",children:[Q?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>F(z=>{const w=!z;return w&&X(),w}),children:t.cogita.library.revision.showAnswer}),Q?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),f.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[f.map(z=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:z.key}),e.jsx("span",{children:z.expected})]},z.key)),K?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:K})]}):null]}):e.jsx("p",{children:E?Re():K})]}):null]}):null,S?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:y,children:t.cogita.library.revision.nextQuestion})}):null]})}const Zn={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},Pr=(t,n)=>{const s=Math.max(t.length,n.length,1),r=Math.abs(t.length-n.length);return Math.max(0,1-r/s)},Kr=(t,n)=>{const s=new Uint8Array(t.length),r=Pr(t,n);for(let i=0;i<t.length;i+=1){const g=t[i]===(n[i]??"")?128:0,h=t.length-1-i,f=n.length-1-i,C=t[h]===(n[f]??"")?127:0,M=Math.round((g+C)*r);s[i]=Math.max(0,Math.min(255,M))}return s},Fr=(t,n)=>t===n||(Zn[t]??[]).includes(n)?!0:(Zn[n]??[]).includes(t),La=(t,n,s)=>s?Fr(t,n):t===n,Pa=(t,n,s)=>{const r=new Uint8Array(t.length);if(!t.length)return r;const i=(s==null?void 0:s.allowSimilarChars)??!0,g=[];for(let f=0;f<=t.length-3;f+=1)g.push({index:f,text:t.slice(f,f+3)});let h=!1;return g.forEach(f=>{for(let C=0;C<=n.length-3;C+=1){const M=n.slice(C,C+3);let c=0;for(let S=0;S<3;S+=1)La(f.text[S],M[S],i)&&(c+=1);if(c<2)continue;let x=f.index-1,l=C-1;for(;x>=0&&l>=0;){const S=t[x],L=n[l];if(S===L){r[x]=Math.max(r[x],255),x-=1,l-=1,h=!0;continue}if(La(S,L,i)&&S!==L){r[x]=Math.max(r[x],127),x-=1,l-=1,h=!0;continue}if(x>0&&t[x-1]===L){r[x]=Math.max(r[x],0),x-=1,h=!0;continue}if(l>0&&t[x]===n[l-1]){l-=1,h=!0;continue}break}for(let S=0;S<3;S+=1){const L=f.index+S,D=f.text[S],p=M[S],u=D===p?255:La(D,p,i)?127:0;r[L]=Math.max(r[L],u),h=!0}let m=f.index+3,v=C+3;for(;m<t.length&&v<n.length;){const S=t[m],L=n[v];if(S===L){r[m]=Math.max(r[m],255),m+=1,v+=1,h=!0;continue}if(La(S,L,i)&&S!==L){r[m]=Math.max(r[m],127),m+=1,v+=1,h=!0;continue}if(m+1<t.length&&t[m+1]===L){r[m]=Math.max(r[m],0),m+=1,h=!0;continue}if(v+1<n.length&&t[m]===n[v+1]){v+=1,h=!0;continue}break}}}),h?r:Kr(t,n)},on=t=>/[\p{L}\p{N}]/u.test(t),Xn=t=>t.trim().toLowerCase(),Zt=(t,n)=>{if(t.length===0)return 100;const s=(n==null?void 0:n.treatSimilarCharsAsSame)??!1,r=Array.from(t).reduce((i,g)=>s&&g===127?i+255:i+g,0);return Math.round(r/(t.length*255)*100)},Ka=(t,n,s)=>{const r=Math.max(0,Math.min(100,(s==null?void 0:s.thresholdPercent)??100)),i=(s==null?void 0:s.treatSimilarCharsAsSame)??!0,g=(s==null?void 0:s.ignorePunctuationAndSpacing)??!1,h=Xn(t),f=Xn(n);if(!g){const p=Pa(h,f,{allowSimilarChars:i}),u=Zt(p,{treatSimilarCharsAsSame:i});return{mask:p,percent:u,isCorrect:u>=r,normalizedExpected:h,normalizedAnswer:f}}const C=Array.from(h),M=Array.from(f),c=[],x=[],l=[];C.forEach((p,u)=>{on(p)&&(c.push(p),x.push(u))}),M.forEach(p=>{on(p)&&l.push(p)});const m=c.join(""),v=l.join(""),S=Pa(m,v,{allowSimilarChars:i}),L=new Uint8Array(C.length);for(let p=0;p<L.length;p+=1)L[p]=on(C[p]??"")?0:255;for(let p=0;p<S.length;p+=1){const u=x[p];u!==void 0&&(L[u]=S[p])}const D=Zt(S,{treatSimilarCharsAsSame:i});return{mask:L,percent:D,isCorrect:D>=r,normalizedExpected:m,normalizedAnswer:v}},ma=(t,n,s)=>{const r=t.trim().toLowerCase(),i=n.trim().toLowerCase();return s==="prefix"||s==="bidirectional"?Pa(r,i,{allowSimilarChars:!0}):Pa(r,i,{allowSimilarChars:!0})};function Vt(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function es(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function ts(t){const n=t.checkType??"info";return t.direction?`${n} / ${t.direction}`:n}function zr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,libraryId:c,infoId:x,selectedReviewerRoleId:l}){const[m,v]=a.useState(x),[S,L]=a.useState([]),[D,p]=a.useState([]),[u,ue]=a.useState("loading"),[P,y]=a.useState(null),[H,F]=a.useState(null),[X,E]=a.useState(null),[K,ce]=a.useState(null),[ge,be]=a.useState(""),[Be,ye]=a.useState(null),[$,ve]=a.useState(1),[G,ee]=a.useState(null),[Le,oe]=a.useState(0),[te,Te]=a.useState(!1),[Ie,Ee]=a.useState(null),[ze,$e]=a.useState({}),[qe,_e]=a.useState({}),[De]=a.useState({}),[Ue,ot]=a.useState(null),tt=a.useRef(null),Ae=a.useRef({});a.useEffect(()=>{let I=!1;return ue("loading"),Promise.all([Qt({libraryId:c,infoId:x}).catch(()=>null),hs({libraryId:c,infoId:x}),ms({libraryId:c,infoId:x})]).then(([O,ae,ne])=>{if(I)return;const we=(O==null?void 0:O.payload)??{},Ce=typeof we.title=="string"&&we.title||typeof we.label=="string"&&we.label||typeof we.name=="string"&&we.name||x;v(Ce),F(we),E((O==null?void 0:O.infoType)??null),L(ae.items),p(ne.items),ue("ready")}).catch(()=>{I||(F(null),E(null),L([]),p([]),ue("error"))}),()=>{I=!0}},[c,x]),a.useEffect(()=>{if(X!=="translation"){ce(null);return}gs({libraryId:c,infoId:x,approachKey:"vocab-card"}).then(I=>ce(I.projection??null)).catch(()=>ce(null))},[X,x,c]);const ke=a.useMemo(()=>{var Ke;const I=new Map(S.map(ie=>[Vt(ie),ie])),O=new Map,ae=new Map;for(const ie of S)O.set(Vt(ie),0),ae.set(Vt(ie),[]);for(const ie of D){const pe=es({parentItemId:ie.parentItemId,parentCheckType:ie.parentCheckType,parentDirection:ie.parentDirection}),he=[ie.childItemId,ie.childCheckType??"",ie.childDirection??""].join("|");!I.has(pe)||!I.has(he)||((Ke=ae.get(pe))==null||Ke.push(he),O.set(he,(O.get(he)??0)+1))}const ne=Array.from(O.entries()).filter(([,ie])=>ie===0).map(([ie])=>ie),we=new Map;for(const ie of ne)we.set(ie,0);for(;ne.length;){const ie=ne.shift(),pe=we.get(ie)??0;for(const he of ae.get(ie)??[]){const at=Math.max(we.get(he)??0,pe+1);we.set(he,at),O.set(he,(O.get(he)??1)-1),(O.get(he)??0)<=0&&ne.push(he)}}const Ce=new Map;for(const ie of S){const pe=Vt(ie),he=we.get(pe)??0,at=Ce.get(he)??[];at.push(pe),Ce.set(he,at)}return S.map(ie=>{const pe=Vt(ie),he=we.get(pe)??0,at=Ce.get(he)??[pe],Je=Math.max(0,at.indexOf(pe));return{id:pe,position:{x:40+Je*290+(he%2?18:0),y:30+he*120},draggable:!1,selectable:!0,data:{label:ie.label,subtitle:ts(ie),checkType:ie.checkType??"info",direction:ie.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[S,D]),U=a.useMemo(()=>new Map(S.map(I=>[Vt(I),I])),[S]),Re=a.useMemo(()=>{const I=[];for(const O of D){const ae=es({parentItemId:O.parentItemId,parentCheckType:O.parentCheckType,parentDirection:O.parentDirection}),ne=[O.childItemId,O.childCheckType??"",O.childDirection??""].join("|");!U.has(ae)||!U.has(ne)||I.push({id:`${ae}->${ne}`,source:ae,target:ne,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return I},[U,D]),J=a.useMemo(()=>P?U.get(P)??null:null,[U,P]);a.useEffect(()=>{be(""),ee(null),oe(0),Te(!1),Ee(null),ye(null),_e({})},[P]);const Q=a.useMemo(()=>{var we,Ce;if(!J)return null;const I=X??J.infoType??null,O=J.checkType??"info",ae=J.direction??null,ne=H??{};if(J.cardType==="vocab"&&K&&Array.isArray(K.words)){const Ke=K.words,ie=((we=Ke[0])==null?void 0:we.label)??"?",pe=((Ce=Ke[1])==null?void 0:Ce.label)??"?";return ae==="a-to-b"?{kind:"vocab",prompt:String(ie),expected:String(pe)}:ae==="b-to-a"?{kind:"vocab",prompt:String(pe),expected:String(ie)}:{kind:"generic",prompt:`${ie} ↔ ${pe}`,expected:`${ie} ↔ ${pe}`}}if(I==="citation"&&O==="quote-fragment"&&ae&&typeof ne.text=="string"){const Ke=ae,ie=sa(ne.text),pe=ie.nodes[Ke];if(pe){const he=Nn(ne.text,pe);return{kind:"citation-fragment",expected:pe.text,quoteContext:{title:m,before:he.before,after:he.after,total:Object.keys(ie.nodes).length,completed:0},quotePlaceholder:pe.text.length>0?".".repeat(Math.max(4,Math.min(18,pe.text.length))):"..."}}}return{kind:"generic",prompt:J.description||J.label,expected:J.label}},[X,H,J,m,K]),Ne=async I=>{if(J&&l)try{await _s({libraryId:c,outcome:{itemType:"info",itemId:J.cardId,checkType:J.checkType??"info",direction:J.direction??null,revisionType:"direct",evalType:"direct-check",correct:I,clientId:"cogita-info-checkcards",clientSequence:$,personRoleId:l}}),ve(O=>O+1),ye(I?"Saved as correct.":"Saved as incorrect.")}catch{ye("Failed to save answer.")}},Ve=J?Vt(J):null,z=Ve?!!ze[Ve]:!1,w=async()=>{if(!J||!Q)return;const I=Vt(J);if(ze[I]){ye("This card was already checked.");return}const O=Q.expected,ae=Q.kind==="citation-fragment",ne=Ka(O,ge,{thresholdPercent:ae?90:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:ae}),we=ne.isCorrect;ee(we?"correct":"incorrect"),oe(Ce=>Ce+1),Ee(ne.mask),Te(!0),ye(l?null:"Answer checked locally (not saved: no person selected)."),$e(Ce=>({...Ce,[I]:!0})),l&&await Ne(we)},Z=()=>{if(!J||!Q)return;const I=Vt(J);ze[I]||($e(ae=>({...ae,[I]:!0})),ye("Answer revealed (not saved)."));const O=Ka(Q.expected,Q.expected,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:Q.kind==="citation-fragment"});Ee(O.mask)},de=a.useMemo(()=>J?J.infoType==="citation"?{...J,description:m}:{...J,description:J.label}:null,[J,m]),T=a.useMemo(()=>X?He(t,X):t.cogita.library.infoTypes.any,[t,X]);return e.jsx(Tt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:T}),e.jsx("h2",{className:"cogita-card-title",children:m}),e.jsx("p",{className:"cogita-card-subtitle",children:x})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${S.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${D.length}`})]})]}),u==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):u==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(xn,{nodes:ke,edges:Re,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:(I,O)=>y(O.id),panOnDrag:!0,children:[e.jsx(vn,{}),e.jsx(wn,{showInteractive:!1})]})}),J?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[Q&&de?e.jsx(Sn,{flashState:G,flashTick:Le,children:e.jsx(Tn,{copy:t,currentCard:de,currentTypeLabel:"",prompt:Q.kind==="citation-fragment"?null:Q.prompt,languages:[],answer:ge,onAnswerChange:be,computedExpected:[],computedAnswers:qe,onComputedAnswerChange:(I,O)=>_e(ae=>({...ae,[I]:O})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:De,feedback:G,canAdvance:!1,quoteContext:Q.kind==="citation-fragment"?Q.quoteContext:null,quotePlaceholder:Q.kind==="citation-fragment"?Q.quotePlaceholder:null,onCheckAnswer:()=>void w(),onSkip:()=>y(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:te,setShowCorrectAnswer:Te,onRevealCorrect:Z,answerMask:Ie,expectedAnswer:Q.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:tt,computedInputRefs:Ae,scriptMode:Ue,setScriptMode:ot,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:z||te,hideSkipAction:!0,allowRevealBeforeCheck:!0,autoRevealAfterAnswer:!0,disableCheckAfterAnswer:!0})}):null,l?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),Be?e.jsx("p",{className:"cogita-library-hint",children:Be}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:S.map(I=>{const O=Vt(I),ae=P===O;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${ae?"active":""}`,onClick:()=>y(O),children:[e.jsx("span",{children:I.label}),e.jsx("small",{children:ts(I)})]},O)})})]})]})]})})})})})}function Dr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,libraryId:c,collectionId:x}){const{libraryName:l}=Wt(c),[m,v]=a.useState([]),[S,L]=a.useState("loading"),[D,p]=a.useState("idle"),u=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),ue=`/#/cogita/library/${c}`,P=()=>{L("loading"),fs({libraryId:c}).then(F=>{v(F),L("idle")}).catch(()=>{v([]),L("error")})};a.useEffect(()=>{P()},[c]);const y=async F=>{try{await bs({libraryId:c,shareId:F}),P()}catch{P()}},H=async F=>{const X=`${u}/${F}`;try{await navigator.clipboard.writeText(X),p("copied")}catch{p("failed")}};return e.jsx(Tt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:ue,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${ue}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[S==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):S==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):m.filter(F=>!x||F.collectionId===x).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:m.filter(F=>!x||F.collectionId===x).map(F=>e.jsxs("div",{className:"cogita-share-row","data-state":F.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:F.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(F.createdUtc).toLocaleString(),F.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),F.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${u}/${F.shareCode}`}):null]}),F.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[F.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>H(F.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>y(F.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},F.shareId))}),D==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):D==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function Br({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,libraryId:c}){const{libraryName:x}=Wt(c),[l,m]=a.useState(null),[v,S]=a.useState(null),[L,D]=a.useState(null),[p,u]=a.useState(null),[ue,P]=a.useState(null),[y,H]=a.useState(null),F=a.useRef(null),X=ce=>{if(!Number.isFinite(ce))return"0 B";if(ce<1024)return`${ce} B`;const ge=ce/1024;if(ge<1024)return`${ge.toFixed(1)} KB`;const be=ge/1024;return be<1024?`${be.toFixed(1)} MB`:`${(be/1024).toFixed(1)} GB`},E=async()=>{m(null),P({loadedBytes:0,totalBytes:null,percent:null});try{m(t.cogita.library.overview.exporting);const ce=await Vs(c,P),ge=URL.createObjectURL(ce),be=document.createElement("a");be.href=ge,be.download=`cogita-library-${x||c}.json`,be.click(),URL.revokeObjectURL(ge),m(t.cogita.library.overview.exportReady)}catch{m(t.cogita.library.overview.exportFail)}finally{P(ce=>ce??{loadedBytes:0,totalBytes:null,percent:null})}},K=async ce=>{var be;S(null),D(null),u(null);const ge=(be=ce.target.files)==null?void 0:be[0];if(ge)try{S(t.cogita.library.overview.importing),H({loadedBytes:0,totalBytes:ge.size,percent:0});const Be=await Os(c,ge,H,ye=>{const $=ye.stage==="infos"?t.cogita.library.overview.importStageInfos:ye.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;u(t.cogita.library.overview.importLiveProgress.replace("{stage}",$).replace("{done}",String(ye.processed)).replace("{total}",String(ye.total)).replace("{infos}",String(ye.infos)).replace("{connections}",String(ye.connections)).replace("{collections}",String(ye.collections)))});D({infos:Be.infosImported,connections:Be.connectionsImported,collections:Be.collectionsImported}),S(t.cogita.library.overview.importDone)}catch(Be){const ye=Be instanceof ps&&Be.message?` ${Be.message}`:"";S(`${t.cogita.library.overview.importFail}${ye}`)}finally{F.current&&(F.current.value="")}};return e.jsx(Tt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:E,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:F,type:"file",accept:"application/json",onChange:K})]})]}),ue?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:ue.percent??void 0,max:ue.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",X(ue.loadedBytes)).replace("{total}",ue.totalBytes?X(ue.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,y?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:y.percent??void 0,max:y.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",X(y.loadedBytes)).replace("{total}",y.totalBytes?X(y.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,l?e.jsx("p",{className:"cogita-help",children:l}):null,v?e.jsx("p",{className:"cogita-help",children:v}):null,p?e.jsx("p",{className:"cogita-help",children:p}):null,L?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(L.infos)).replace("{connections}",String(L.connections)).replace("{collections}",String(L.collections))}):null]})]})})})]})})}function _r({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,libraryId:c}){const{libraryName:x}=Wt(c),[l,m]=a.useState(""),[v,S]=a.useState([]),L=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Tt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:D=>m(D.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const D=l.trim();D&&(S(p=>[{id:L(),name:D},...p]),m(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[v.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,v.map(D=>e.jsx("button",{type:"button",className:"ghost",children:D.name},D.id))]})]})]})})})]})})}function Vr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,libraryId:c}){const{libraryName:x}=Wt(c),[l,m]=a.useState(""),[v,S]=a.useState([]),L=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Tt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:D=>m(D.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const D=l.trim();D&&(S(p=>[{id:L(),name:D},...p]),m(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[v.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,v.map(D=>e.jsx("button",{type:"button",className:"ghost",children:D.name},D.id))]})]})]})})})]})})}function as({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,libraryId:c}){const{libraryName:x}=Wt(c),l=`/#/cogita/library/${c}`,[m,v]=a.useState(""),[S,L]=a.useState([]),[D,p]=a.useState("idle"),[u,ue]=a.useState(0),[P,y]=a.useState(null);a.useEffect(()=>{p("loading");const F=window.setTimeout(()=>{ja({libraryId:c,query:m.trim()||void 0,limit:30}).then(X=>{L(X.items),ue(X.total),y(X.nextCursor??null),p("ready")}).catch(()=>{L([]),ue(0),y(null),p("ready")})},240);return()=>window.clearTimeout(F)},[c,m]);const H=async()=>{if(P){p("loading");try{const F=await ja({libraryId:c,query:m.trim()||void 0,limit:30,cursor:P});L(X=>[...X,...F.items]),y(F.nextCursor??null),ue(F.total),p("ready")}catch{p("ready")}}};return e.jsx(Tt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${l}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:m,onChange:F=>v(F.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(S.length)).replace("{total}",String(u||S.length))}),e.jsx("span",{children:D==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:S.length?S.map(F=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${l}/collections/${F.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:F.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(F.itemCount))," ·"," ",F.notes||t.cogita.library.collections.noNotes]})]})},F.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${l}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),P?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:H,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const fe=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,Ot=(t,n,s,r)=>`${t}:${n}:${s??""}:${r??""}`;function Or({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,libraryId:c,collectionId:x}){Wt(c);const l=`/#/cogita/library/${c}`,[m,v]=a.useState(t.cogita.library.collections.defaultName),[S,L]=a.useState(null),[D,p]=a.useState(0),[u,ue]=a.useState([]),[P,y]=a.useState("idle"),[H,F]=a.useState(null),X=a.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(u.length)).replace("{total}",String(D||u.length)),[t,u.length,D]);a.useEffect(()=>{qa(c,x).then(K=>{v(K.name),L(K.notes??null),p(K.itemCount)}).catch(()=>{v(t.cogita.library.collections.defaultName),L(null)})},[c,x]),a.useEffect(()=>{y("loading"),Ra({libraryId:c,collectionId:x,limit:40}).then(K=>{ue(K.items),F(K.nextCursor??null),p(K.total),y("ready")}).catch(()=>{ue([]),F(null),y("ready")})},[c,x]);const E=async()=>{if(H){y("loading");try{const K=await Ra({libraryId:c,collectionId:x,limit:40,cursor:H});ue(ce=>[...ce,...K.items]),F(K.nextCursor??null),p(K.total),y("ready")}catch{y("ready")}}};return e.jsx(Tt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:m}),e.jsx("p",{className:"cogita-library-subtitle",children:S||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${l}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${l}/collections/${x}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${l}/collections/${x}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:X}),e.jsx("span",{children:P==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:u.length?u.map(K=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:K.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:K.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:K.label}),e.jsx("p",{className:"cogita-card-subtitle",children:K.description})]})},fe(K))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),H?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:E,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${l}/collections/${x}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const qt=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const n=t.length,s=t.filter(g=>g.correct).length,r=Ua(Cn(t));return{score:Math.round(Math.max(0,Math.min(100,r.knowness*100))*100)/100,total:n,correct:s,lastReviewedUtc:r.lastReviewedUtc??null}},qr=t=>{if(t.maskBase64)try{const n=qs(t.maskBase64);if(!n.length)return t.correct?1:0;const s=n.reduce((r,i)=>r+i,0);return Math.max(0,Math.min(1,s/n.length/255))}catch{return t.correct?1:0}return t.correct?1:0},Cn=t=>t.map(n=>({correctness:qr(n),createdUtc:n.createdUtc})),Ua=(t,n=Date.now())=>{var D;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const r=t.slice().sort((p,u)=>p.createdUtc.localeCompare(u.createdUtc)).slice(-5),i=r.reduce((p,u)=>p+u.correctness,0)/r.length,g=5,h=2,f=.15;let C=0,M=0;for(let p=0;p<r.length;p+=1){const u=new Date(r[p].createdUtc).getTime(),ue=p===r.length-1?n:new Date(r[p+1].createdUtc).getTime(),P=Math.max(0,(ue-u)/(1e3*60)),y=1-Math.exp(-P/g);C+=y,r[p].correctness>.5&&(M+=f)}let c=i*C*h+M;const x=((D=r[r.length-1])==null?void 0:D.createdUtc)??null,l=x?Math.max(0,(n-new Date(x).getTime())/(1e3*60)):0,v=1/(1+Math.log1p(l/60));return c*=v,r.length===1&&r[0].correctness>.5&&(c+=5.44*Math.exp(-l/2)),{knowness:c,avgCorrectness:i,lastReviewedUtc:x}},ka=t=>{const n=t.slice();for(let s=n.length-1;s>0;s-=1){const r=Math.floor(Math.random()*(s+1));[n[s],n[r]]=[n[r],n[s]]}return n},$a=t=>t[Math.floor(Math.random()*t.length)],Ur=(t,n)=>{const s=new Map;return t.forEach(r=>s.set(r,Math.random())),t.sort((r,i)=>{const g=n(r)-n(i);return g!==0?g:(s.get(r)??0)-(s.get(i)??0)})},Ja=(t,n,s,r,i)=>{if(!t.length)return null;const g=t.filter(f=>!(i!=null&&i.has(fe(f))));if(g.length===0)return null;const h=g.filter(f=>fe(f)!==s);return $a(h.length?h:g)},Jr=(t,n,s,r,i)=>{if(!t.length)return null;let g=Number.POSITIVE_INFINITY;for(const M of t){const c=fe(M);if(s.has(c))continue;const x=n[c]??1;x<g&&(g=x)}if(!Number.isFinite(g))return null;const h=t.filter(M=>{const c=fe(M);return!s.has(c)&&(n[c]??1)===g}),f=h.filter(M=>!i||fe(M)!==i),C=r?f.filter(M=>!r.has(fe(M))):f;return C.length>0?$a(C):f.length>0?$a(f):i&&h.some(M=>fe(M)===i)?h.find(M=>fe(M)===i)??null:h.length?$a(h):null},ws=(t,n,s,r,i)=>{const g=[],h=t.filter(C=>!i.has(fe(C))&&!s.has(fe(C))&&(n[fe(C)]??0)<1),f=Ur(h,C=>n[fe(C)]??0);for(const C of f){if(g.length>=r)break;g.push(C),i.add(fe(C))}if(g.length<r){const C=ka(t.filter(M=>!i.has(fe(M))&&s.has(fe(M))));for(const M of C){if(g.length>=r)break;g.push(M),i.add(fe(M))}}return g},Hr=(t,n,s,r)=>ws(t,n,s,r,new Set),Mn=(t,n,s,r,i,g)=>{const h=Math.max(1,s.stackSize??n),C=ka(t).filter((v,S,L)=>L.findIndex(D=>fe(D)===fe(v))===S),M=Hr(C,r,i,h),c=new Set,x=new Set,l=Ja(M,{},null,c,x),m=l?[l]:[];return l&&x.add(fe(l)),{queue:m,meta:{pool:C,active:M,knownessMap:r,unknownSet:i,outcomesById:g,asked:c,queued:x}}},bn={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,n)=>{const r=ka(t).filter((i,g,h)=>h.findIndex(f=>fe(f)===fe(i))===g);return{queue:r.slice(0,Math.min(n,r.length)),meta:{}}},applyOutcome:t=>t},In=(t,n,s,r)=>{const i=Math.max(1,s.stackSize??n),h=ka(t).filter((S,L,D)=>D.findIndex(p=>fe(p)===fe(S))===L),f={},C=new Set,M=new Set,c=new Set,x=Math.max(1,s.levels??1);h.forEach(S=>{const L=fe(S),D=r==null?void 0:r[L],p=typeof D=="number"&&Number.isFinite(D)?D:1;f[L]=Math.min(x,Math.max(1,Math.round(p)))});const l=[];if(h.length>0){const S=new Map;h.forEach(D=>{var u;const p=f[fe(D)]??1;S.has(p)||S.set(p,[]),(u=S.get(p))==null||u.push(D)});const L=Array.from(S.keys()).sort((D,p)=>D-p);for(const D of L){if(l.length>=i)break;const p=ka(S.get(D)??[]);for(const u of p){if(l.length>=i)break;l.push(u)}}}const m=Ja(l,f,null,C,M),v=m?[m]:[];return m&&M.add(fe(m)),{queue:v,meta:{pool:h,active:l,levelMap:f,asked:C,queued:M,wrongSinceCorrect:c}}},Wr={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,s)=>In(t,n,s),applyOutcome:(t,n,s,r,i)=>{if(!n)return t;const g=Math.max(1,r.levels??1),h=t.meta.pool??[],f=t.meta.active??[],C={...t.meta.levelMap??{}},M=new Set(t.meta.asked??[]),c=new Set(t.meta.queued??[]),x=new Set(t.meta.wrongSinceCorrect??[]),l=fe(n);c.delete(l),M.add(l);const m=C[l]??1;i.correct?(C[l]=x.has(l)?1:Math.min(m+1,g),x.delete(l)):(C[l]=1,x.add(l));const v=i.correct?f.filter(D=>fe(D)!==l):f.slice();if(i.correct&&v.length<Math.max(1,r.stackSize??1)){const D=new Set(v.map(u=>fe(u))),p=Jr(h,C,D,M,l);p&&v.push(p)}const S=t.queue.slice(),L=Ja(v,C,l,M,c);return L&&(S.push(L),c.add(fe(L))),{queue:S,meta:{pool:h,active:v,levelMap:C,asked:M,queued:c,wrongSinceCorrect:x}}}},Gr={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,s)=>Mn(t,n,s,{},new Set,{}),applyOutcome:(t,n,s,r,i)=>{if(!n)return t;const g=t.meta.pool??[],h=t.meta.active??[],f={...t.meta.knownessMap??{}},C=new Set(t.meta.unknownSet??[]),M={...t.meta.outcomesById??{}},c=new Set(t.meta.asked??[]),x=new Set(t.meta.queued??[]),l=fe(n);x.delete(l),c.add(l);const m={correctness:Math.max(0,Math.min(1,i.correctness??(i.correct?1:0))),createdUtc:i.createdUtc??new Date().toISOString()},S=(M[l]??[]).concat(m).sort((P,y)=>P.createdUtc.localeCompare(y.createdUtc)).slice(-5);M[l]=S,C.delete(l);const L=Date.now();g.forEach(P=>{const y=fe(P),H=M[y]??[];if(H.length===0){f[y]=0,C.add(y);return}const F=Ua(H,L);f[y]=F.knowness});const D=h.slice();if((f[l]??0)>=1){const P=D.filter(y=>fe(y)!==l);D.length=0,D.push(...P)}const u=Math.max(1,r.stackSize??s);if(D.length<u){const P=new Set(D.map(H=>fe(H))),y=ws(g,f,C,u-D.length,P);D.push(...y)}const ue=t.queue.slice();if(ue.length===0||fe(ue[ue.length-1])===l){const P=Ja(D,{},l,c,x);P&&(ue.push(P),x.add(fe(P)))}return{queue:ue,meta:{pool:g,active:D,knownessMap:f,unknownSet:C,outcomesById:M,asked:c,queued:x}}}},js={random:bn,levels:Wr,temporal:Gr},Yr=Object.values(js),Ln=t=>{if(!t)return bn;const n=t.trim().toLowerCase();return n==="random"||n==="levels"||n==="temporal"?js[n]:bn},Ha=(t,n)=>{const s={...t.defaultSettings};return n&&Object.entries(n).forEach(([r,i])=>{typeof i=="number"&&Number.isFinite(i)&&(s[r]=i),typeof i=="string"&&(s[r]=i)}),t.settingsFields.forEach(r=>{var g;const i=s[r.key];if(r.type==="number"){if(typeof i!="number"||Number.isNaN(i)){s[r.key]=t.defaultSettings[r.key]??0;return}r.min!==void 0&&(s[r.key]=Math.max(r.min,s[r.key])),r.max!==void 0&&(s[r.key]=Math.min(r.max,s[r.key]));return}if(r.type==="select"){const h=((g=r.options)==null?void 0:g.map(f=>f.value))??[];(typeof i!="string"||h.length>0&&!h.includes(i))&&(s[r.key]=t.defaultSettings[r.key]??h[0]??"")}}),s},ks=(t,n)=>{const s={};return t.settingsFields.forEach(r=>{const i=n.get(r.key);if(i){if(r.type==="number"){const g=Number(i);Number.isNaN(g)||(s[r.key]=g);return}s[r.key]=i}}),Ha(t,s)},Qr=(t,n)=>{const s=new URLSearchParams;return t.settingsFields.forEach(r=>{const i=n[r.key];(typeof i=="number"||typeof i=="string")&&s.set(r.key,String(i))}),s};function Zr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,libraryId:c,collectionId:x,revisionId:l}){const{libraryName:m}=Wt(c),v=`/#/cogita/library/${c}`,[S,L]=a.useState(t.cogita.library.collections.defaultName),[D,p]=a.useState(""),[u,ue]=a.useState(20),[P,y]=a.useState("random"),[H,F]=a.useState({}),[X,E]=a.useState("exact"),[K,ce]=a.useState([]),[ge,be]=a.useState(null),[Be,ye]=a.useState([]),[$,ve]=a.useState("idle"),[G,ee]=a.useState(null),[Le,oe]=a.useState("idle"),[te,Te]=a.useState("idle"),[Ie,Ee]=a.useState("idle"),ze=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),$e=a.useMemo(()=>Ln(P),[P]),qe=a.useMemo(()=>Ha($e,H),[$e,H]),_e=a.useMemo(()=>Qr($e,qe).toString(),[$e,qe]);a.useEffect(()=>{qa(c,x).then(ke=>L(ke.name)).catch(()=>L(t.cogita.library.collections.defaultName))},[c,x]),a.useEffect(()=>{l&&Us({libraryId:c,collectionId:x,revisionId:l}).then(ke=>{p(ke.name),y(ke.mode||"random"),E(ke.check||"exact"),ue(ke.limit||20),F(ke.revisionSettings??{})}).catch(()=>{p("")})},[x,c,l]),a.useEffect(()=>{ys({libraryId:c}).then(ke=>{ce(ke),!ge&&ke.length>0&&be(ke[0].roleId)}).catch(()=>{ce([])})},[c]);const De=()=>{Te("loading"),fs({libraryId:c}).then(ke=>{ye(ke),Te("idle")}).catch(()=>{ye([]),Te("error")})};a.useEffect(()=>{De()},[c]);const Ue=async()=>{ve("working"),oe("idle");try{const ke=await Hs({libraryId:c,collectionId:x,revisionType:$e.id,revisionSettings:qe,mode:P,check:X,limit:u});ee(`${ze}/${ke.shareCode}${_e?`?${_e}`:""}`),ve("ready"),De()}catch{ve("error")}},ot=async()=>{if(l){Ee("saving");try{await Js({libraryId:c,collectionId:x,revisionId:l,name:D||S,revisionType:$e.id,revisionSettings:qe,mode:P,check:X,limit:u}),Ee("saved")}catch{Ee("error")}}},tt=async()=>{if(G)try{await navigator.clipboard.writeText(G),oe("copied")}catch{oe("failed")}},Ae=async ke=>{try{await bs({libraryId:c,shareId:ke}),De()}catch{De()}};return e.jsx(Tt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:S}),e.jsx("p",{className:"cogita-library-subtitle",children:m})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${v}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${v}/collections/${x}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${v}/collections/${x}/revision/run?mode=${encodeURIComponent(P)}&check=${encodeURIComponent(X)}&limit=${u}${_e?`&${_e}`:""}${ge?`&reviewer=${encodeURIComponent(ge)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:D,onChange:ke=>p(ke.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:P,onChange:ke=>y(ke.target.value),children:Yr.map(ke=>e.jsx("option",{value:ke.id,children:t.cogita.library.revision[ke.labelKey]},ke.id))})]}),$e.settingsFields.map(ke=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[ke.labelKey]}),ke.type==="select"?e.jsx("select",{value:String(qe[ke.key]??""),onChange:U=>F(Re=>({...Re,[ke.key]:U.target.value})),children:(ke.options??[]).map(U=>e.jsx("option",{value:U.value,children:t.cogita.library.revision[U.labelKey]},U.value))}):e.jsx("input",{type:"number",min:ke.min,max:ke.max,step:ke.step,value:qe[ke.key]??0,onChange:U=>F(Re=>({...Re,[ke.key]:Number(U.target.value||0)}))})]},ke.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),$e.id!=="levels"&&$e.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:u,onChange:ke=>ue(Number(ke.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:ge??"",onChange:ke=>be(ke.target.value||null),children:K.map(ke=>e.jsx("option",{value:ke.roleId,children:ke.label},ke.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[l?e.jsx("button",{type:"button",className:"cta ghost",onClick:ot,disabled:Ie==="saving",children:Ie==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${v}/collections/${x}/revision/run?mode=${encodeURIComponent(P)}&check=${encodeURIComponent(X)}&limit=${u}${_e?`&${_e}`:""}${ge?`&reviewer=${encodeURIComponent(ge)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]}),Ie==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),G?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:G,readOnly:!0})]}):null,$==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,Le==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):Le==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:Ue,disabled:$==="working",children:$==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),G?e.jsx("button",{type:"button",className:"cta ghost",onClick:tt,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),te==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):Be.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:Be.map(ke=>e.jsxs("div",{className:"cogita-share-row","data-state":ke.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:ke.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(ke.createdUtc).toLocaleString(),ke.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),ke.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ae(ke.shareId),children:t.cogita.library.revision.shareRevokeAction})]},ke.shareId))})]})]})]})]})})})]})})}const ln=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function Ns(t,n,s){if(!t)return null;const r=new Map(t.nodes.map(P=>[P.id,P])),i=new Map,g=new Set,h=P=>{if(typeof P=="number")return P;if(typeof P=="string"){const y=Number(P);return Number.isFinite(y)?y:0}return 0},f=P=>{if(i.has(P))return i.get(P);if(g.has(P))return 0;const y=r.get(P);if(!y)return 0;g.add(P);const H=X=>{var K,ce;return(X?((K=y.inputsByHandle)==null?void 0:K[X])??[]:y.inputs??((ce=y.inputsByHandle)==null?void 0:ce.in)??[]).map(ge=>f(ge))};let F=0;switch(y.type){case"input.random":{const X=y.min??0,E=y.max??X+10,K=Math.min(X,E),ce=Math.max(X,E);F=Math.floor(Math.random()*(ce-K+1))+K;break}case"input.const":{F=y.value??0;break}case"input.list":{const X=(y.list??[]).filter(Boolean),E=Math.round(h(H("index")[0]));F=X.length?X[Math.max(0,Math.min(X.length-1,E))]:String(E);break}case"compute.add":{F=H("in").map(E=>h(E)).reduce((E,K)=>E+K,0);break}case"compute.sub":{const X=H("add").map(K=>h(K)),E=H("sub").map(K=>h(K));F=X.reduce((K,ce)=>K+ce,0)-E.reduce((K,ce)=>K+ce,0);break}case"compute.mul":{const X=H("in").map(E=>h(E));F=X.length?X.reduce((E,K)=>E*K,1):0;break}case"compute.div":{const X=h(H("num")[0]),E=H("den").map(K=>h(K)).reduce((K,ce)=>K+ce,0);F=Math.abs(E)<Number.EPSILON?0:X/E;break}case"compute.pow":{const X=h(H("base")[0]),E=h(H("exp")[0]);F=Math.pow(X,E);break}case"compute.exp":{const X=h(H("base")[0]),E=h(H("exp")[0]);F=Math.pow(X,E);break}case"compute.log":{const X=h(H("value")[0]),E=h(H("base")[0]),K=Math.max(X,Number.EPSILON);F=Math.abs(E)<Number.EPSILON?Math.log(K):Math.log(K)/Math.log(E);break}case"compute.abs":{F=Math.abs(h(H("in")[0]));break}case"compute.min":{const X=H("in").map(E=>h(E));F=X.length?Math.min(...X):0;break}case"compute.max":{const X=H("in").map(E=>h(E));F=X.length?Math.max(...X):0;break}case"compute.floor":{F=Math.floor(h(H("in")[0]));break}case"compute.ceil":{F=Math.ceil(h(H("in")[0]));break}case"compute.round":{F=Math.round(h(H("in")[0]));break}case"compute.mod":{const X=h(H("a")[0]),E=h(H("b")[0]);F=Math.abs(E)<Number.EPSILON?0:X%E;break}case"compute.concat":{const E=["in1","in2","in3","in4","in5","in6"].flatMap(be=>H(be)),K=E.length?E:H("in");F=(K.length?K:H()).map(be=>be==null?"":String(be)).join("");break}case"compute.trim":{const X=H("text")[0]??H("in")[0]??"",E=X==null?"":String(X),K=Math.max(0,Math.round(h(H("start")[0]))),ce=Math.max(0,Math.round(h(H("end")[0])));K+ce>=E.length?F="":F=E.substring(K,E.length-ce);break}case"output":{F=H("in")[0]??0;break}default:F=0}return g.delete(P),i.set(P,F),F},C=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(P=>P.type==="output").map(P=>P.id);t.nodes.forEach(P=>f(P.id)),C.forEach(P=>f(P));const M=P=>Math.abs(P%1)<1e-5?String(Math.round(P)):P.toFixed(3).replace(/\.?0+$/,""),c=P=>typeof P=="number"?M(P):P??"",x=new Map;C.forEach(P=>{var E,K,ce,ge;const y=r.get(P);if(!y)return;const H=(K=(E=y.inputsByHandle)==null?void 0:E.name)==null?void 0:K[0],F=H?c(i.get(H)):"",X=(F==null?void 0:F.toString().trim())||((ce=y.outputLabel)==null?void 0:ce.trim())||((ge=y.name)==null?void 0:ge.trim())||P;x.set(P,X)});const l={},m={},v={};C.forEach(P=>{var F,X;const y=r.get(P);if(!y)return;const H=x.get(P)??(((F=y.outputLabel)==null?void 0:F.trim())||((X=y.name)==null?void 0:X.trim())||P);l[H]=c(i.get(P)),y.name&&(m[y.name.trim()]=H),m[P]=H});const S=(P,y)=>{let H=P;return t.nodes.forEach(F=>{var ge,be;const X=c(i.get(F.id)),E=C.includes(F.id),K=E?x.get(F.id)??((ge=F.outputLabel)==null?void 0:ge.trim())??((be=F.name)==null?void 0:be.trim())??F.id:"",ce=E&&y?K:X;H=H.replace(new RegExp(`\\{\\s*${ln(F.id)}\\s*\\}`,"gi"),ce),F.name&&(H=H.replace(new RegExp(`\\{\\s*${ln(F.name)}\\s*\\}`,"gi"),ce)),E&&F.outputLabel&&(H=H.replace(new RegExp(`\\{\\s*${ln(F.outputLabel)}\\s*\\}`,"gi"),K))}),H},L=n;let D=L.trim().length>0?L:"";D||(D=C.length?`Compute ${C.join(", ")}`:"Compute"),D=S(D,!0);const p=(s==null?void 0:s.trim())??"",u=p?S(p,!1):"",ue={};return i.forEach((P,y)=>{ue[y]=P,v[y]=c(P);const H=r.get(y);H!=null&&H.name&&(v[H.name.trim()]=c(P))}),{prompt:D,answers:l,values:ue,answerText:u,outputVariables:m,variableValues:v}}function Ss(t){var s;const n=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((s=n[0])==null?void 0:s[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const cn=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function Ts({outcomes:t}){const[n,s]=a.useState("day"),r=a.useMemo(()=>{const i=cn.find(f=>f.id===n)??cn[1],g=Date.now()-i.ms,h=t.filter(f=>new Date(f.createdUtc).getTime()>=g);return qt(h)},[t,n]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:cn.map(i=>e.jsx("button",{type:"button",className:"ghost","data-active":n===i.id,onClick:()=>s(i.id),children:i.label},i.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[r.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[r.correct," / ",r.total]})]})}const Xr="cogita-revision",ei=1,Fa="outcomes",ti=()=>new Promise((t,n)=>{const s=indexedDB.open(Xr,ei);s.onupgradeneeded=()=>{const r=s.result;if(!r.objectStoreNames.contains(Fa)){const i=r.createObjectStore(Fa,{keyPath:"id"});i.createIndex("byItem","itemKey",{unique:!1}),i.createIndex("byPending","pending",{unique:!1})}},s.onerror=()=>n(s.error),s.onsuccess=()=>t(s.result)}),Na=async(t,n)=>{const s=await ti();return new Promise((r,i)=>{const g=s.transaction(Fa,t),h=g.objectStore(Fa);n(h).then(r).catch(i),g.onerror=()=>i(g.error)})},Cs=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const n=Array.from(t).map(s=>s.toString(16).padStart(2,"0"));return`${n.slice(0,4).join("")}-${n.slice(4,6).join("")}-${n.slice(6,8).join("")}-${n.slice(8,10).join("")}-${n.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},ai=()=>{const t="cogita_revision_client_id",n=localStorage.getItem(t);if(n)return n;const s=Cs();return localStorage.setItem(t,s),s},ni=()=>{const t="cogita_revision_client_seq",n=Number(localStorage.getItem(t)??"0"),s=Number.isFinite(n)?n+1:1;return localStorage.setItem(t,String(s)),s},Ms=(t,n,s,r)=>Ot(t,n,s,r),za=async t=>{const n=ai(),s=ni(),r=new Date().toISOString(),i={...t,clientId:n,clientSequence:s,createdUtc:r,id:Cs(),pending:!0};return await Na("readwrite",g=>new Promise((h,f)=>{const C={...i,itemKey:Ms(i.itemType,i.itemId,i.checkType,i.direction)},M=g.add(C);M.onsuccess=()=>h(),M.onerror=()=>f(M.error)})),i},Da=async(t,n,s,r)=>{if(!n)return[];try{const i=Ms(t,n,s,r);return await Na("readonly",g=>new Promise((h,f)=>{const M=g.index("byItem").getAll(i);M.onsuccess=()=>{const x=(M.result??[]).map(l=>({itemType:l.itemType,itemId:l.itemId,checkType:l.checkType??null,direction:l.direction??null,revisionType:l.revisionType,evalType:l.evalType,correct:l.correct,createdUtc:l.createdUtc,maskBase64:l.maskBase64,payloadBase64:l.payloadBase64,payloadHashBase64:l.payloadHashBase64,clientId:l.clientId,clientSequence:l.clientSequence,personRoleId:l.personRoleId??null})).sort((l,m)=>l.createdUtc.localeCompare(m.createdUtc));h(x)},M.onerror=()=>f(M.error)}))}catch{return[]}},Ut=async()=>{try{return await Na("readonly",t=>new Promise((n,s)=>{const r=t.getAll();r.onsuccess=()=>{const g=(r.result??[]).map(h=>({itemType:h.itemType,itemId:h.itemId,checkType:h.checkType??null,direction:h.direction??null,revisionType:h.revisionType,evalType:h.evalType,correct:h.correct,createdUtc:h.createdUtc,maskBase64:h.maskBase64,payloadBase64:h.payloadBase64,payloadHashBase64:h.payloadHashBase64,clientId:h.clientId,clientSequence:h.clientSequence,personRoleId:h.personRoleId??null}));n(g)},r.onerror=()=>s(r.error)}))}catch{return[]}},si=async(t=100)=>{try{return await Na("readonly",n=>new Promise((s,r)=>{const g=n.index("byPending").getAll(!0);g.onsuccess=()=>{const h=g.result??[];s(h.slice(0,t))},g.onerror=()=>r(g.error)}))}catch{return[]}},ri=async t=>{if(t.length!==0)try{await Na("readwrite",n=>new Promise((s,r)=>{let i=t.length;t.forEach(g=>{const h=n.get(g);h.onsuccess=()=>{const f=h.result;if(f){f.pending=!1;const C=n.put(f);C.onsuccess=()=>{i-=1,i===0&&s()},C.onerror=()=>r(C.error)}else i-=1,i===0&&s()},h.onerror=()=>r(h.error)})}))}catch{}},dn=async(t,n)=>{const s=await si(200);if(s.length===0)return;const r=new Map;s.forEach(i=>{var h;const g=i.personRoleId??n??"";r.has(g)||r.set(g,[]),(h=r.get(g))==null||h.push(i)});for(const[i,g]of r.entries()){const h=g.map(f=>({itemType:f.itemType,itemId:f.itemId,checkType:f.checkType??null,direction:f.direction??null,revisionType:f.revisionType,evalType:f.evalType,correct:f.correct,clientId:f.clientId,clientSequence:f.clientSequence,maskBase64:f.maskBase64??null,payloadHashBase64:f.payloadHashBase64??null,payloadBase64:f.payloadBase64??null,personRoleId:i||null}));try{await Ws({libraryId:t,outcomes:h}),await ri(g.map(f=>f.id))}catch{}}},St=t=>t.trim().toLowerCase(),Rt=t=>{const n=t==null?void 0:t.trim();return n?{fragmentId:n}:null},Ba=(t,n)=>{const s=Rt(n);if(!s)return!0;const r=Rt(t);return(r==null?void 0:r.fragmentId)===s.fragmentId},gt=t=>{const n=t==null?void 0:t.trim().toLowerCase();return n||null},Is=(t,n)=>{if((gt(t.childItemType)??"info")!==(n.cardType??"").toLowerCase()||t.childItemId!==n.cardId)return!1;const r=gt(t.childCheckType),i=gt(t.childDirection),g=gt(n.checkType),h=gt(n.direction);return!(r&&r!==g||i&&i!==h)},ii={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},oi={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},_a=(t,n,s)=>{if(!s||!n.startsWith(t))return n;const r=n.slice(t.length);if(!r)return n;const i=s==="super"?ii:oi,g=r.split("").map(h=>i[h]??h).join("");return t+g},Va=(t,n,s)=>{var h,f,C;if(!t)return((h=n[0])==null?void 0:h.key)??null;const r=new Set(n.map(M=>M.key)),i=/\{([^}]+)\}/g;let g;for(;(g=i.exec(t))!==null;){const M=((f=g[1])==null?void 0:f.trim())??"";if(!M)continue;if(r.has(M))return M;const c=s==null?void 0:s[M];if(c&&r.has(c))return c}return((C=n[0])==null?void 0:C.key)??null},yn=t=>(()=>{const n=new Set;return t.flatMap(s=>{if(s.cardType!=="info"||s.infoType!=="citation")return[s];const r=s.description??"";if(!r.trim())return[s];const i=sa(r),g=Object.keys(i.nodes);return g.length===0?[s]:g.map(h=>({...s,checkType:"quote-fragment",direction:h})).filter(h=>{const f=[h.cardId,h.checkType??"",h.direction??""].join("|");return n.has(f)?!1:(n.add(f),!0)})})})();function li({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,libraryId:c,collectionId:x,revisionId:l}){const m=Oa(),v=`/#/cogita/library/${c}`,S=a.useMemo(()=>new URLSearchParams(m.search),[m.search]),L=Math.max(1,Number(S.get("limit")??20)),D=S.get("mode")??"random",p=a.useMemo(()=>Ln(D),[D]),u=a.useMemo(()=>Ha(p,ks(p,S)),[p,S]),ue=S.get("check")??"exact",P=S.get("reviewer"),y=a.useMemo(()=>t.cogita.library.revision[p.labelKey]??D,[t,D,p]),H=a.useMemo(()=>ue==="exact"?t.cogita.library.revision.checkValue:ue,[t,ue]),[F,X]=a.useState(t.cogita.library.collections.defaultName),[E,K]=a.useState([]),[ce,ge]=a.useState([]),[be,Be]=a.useState("idle"),[ye,$]=a.useState({current:0,total:0}),[ve,G]=a.useState(0),[ee,Le]=a.useState(""),[oe,te]=a.useState(null),[Te,Ie]=a.useState(null),[Ee,ze]=a.useState(null),[$e,qe]=a.useState(null),[_e,De]=a.useState([]),[Ue,ot]=a.useState({}),[tt,Ae]=a.useState({}),[ke,U]=a.useState(null),[Re,J]=a.useState(null),[Q,Ne]=a.useState(null),[Ve,z]=a.useState(null),[w,Z]=a.useState(null),[de,T]=a.useState({}),I=a.useRef(0),[O,ae]=a.useState(null),ne=a.useRef(null),we=a.useRef(null),[Ce,Ke]=a.useState(null),[ie,pe]=a.useState(!1),[he,at]=a.useState(null),[Je,Ye]=a.useState([]),[ct,yt]=a.useState(null),We=a.useRef(null),Ge=a.useRef(null),[Ct,dt]=a.useState(null),[It,lt]=a.useState(0),rt=a.useRef(null),Lt=a.useRef({}),[xt,Xe]=a.useState(!1),[et,Et]=a.useState({}),[$t,Qe]=a.useState([]),ht=a.useRef(new Map),[pt,jt]=a.useState(new Set),[q,le]=a.useState(!1),Me=a.useRef(null),d=a.useRef(new Set),Se=a.useRef({}),Y=E[ve]??null,re=(Y==null?void 0:Y.checkType)==="translation-match"&&w,ut=a.useRef(new Map),st=a.useRef(new Map),bt=a.useRef(new Map),ft=a.useRef(new Map),Mt=a.useMemo(()=>Y?Y.cardType==="vocab"?t.cogita.library.revision.vocabLabel:Y.infoType?He(t,Y.infoType):t.cogita.library.revision.infoLabel:"",[t,Y]),ra=a.useMemo(()=>{var b;return p.id!=="levels"?E.length:((b=et.pool)==null?void 0:b.length)??p.getFetchLimit(L,u)},[et,u,p,E.length,L]),Gt=p.getProgressTotal?p.getProgressTotal(E,et,L,u):p.id==="levels"?Math.min(L,ra):E.length,Dt=Gt?Math.min(ve+1,Gt):0,vt=Math.max(1,Number(u.tries??1)),wt=u.compare??"anchors",Ht=Math.max(0,Math.min(100,Number(u.minCorrectness??0))),nt=(u.considerDependencies??"on")==="on",it=Math.max(0,Math.min(100,Number(u.dependencyThreshold??85))),Kt=o=>{const b=o.slice();for(let N=b.length-1;N>0;N-=1){const k=Math.floor(Math.random()*(N+1));[b[N],b[k]]=[b[k],b[N]]}return b},ga=o=>Zt(o,{treatSimilarCharsAsSame:!0})>=Ht,pa=async()=>{const o=await Ut(),b=new Map,N=new Map,k=new Map;o.forEach(R=>{const _=`${R.itemType}:${R.itemId}`,se=Ot(R.itemType,R.itemId,R.checkType,R.direction);if(b.has(_)||b.set(_,[]),b.get(_).push(R),N.has(se)||N.set(se,[]),N.get(se).push(R),R.itemType==="info"&&R.checkType==="quote-fragment"&&R.direction){const me=`${R.itemId}:${R.direction}`;k.has(me)||k.set(me,[]),k.get(me).push(R)}});const V=new Map,j=new Map,B=new Map;return b.forEach((R,_)=>V.set(_,qt(R).score)),N.forEach((R,_)=>j.set(_,qt(R).score)),k.forEach((R,_)=>B.set(_,qt(R).score)),{itemKnowness:V,cardKnowness:j,fragmentKnowness:B}},Wa=async o=>{const b=[];let N=null;for(;;){const k=await Ra({libraryId:c,collectionId:o,limit:200,cursor:N});if(b.push(...k.items),!k.nextCursor)break;N=k.nextCursor}return yn(b)},fa=async(o,b)=>{if(ht.current.has(o))return ht.current.get(o)??0;const N=await Wa(o);if(N.length===0)return ht.current.set(o,0),0;const V=N.reduce((j,B)=>{const R=fe(B);return j+(b.get(R)??0)},0)/N.length;return ht.current.set(o,V),V},Ga=(o,b)=>{if(!nt||o.cardType!=="info"||o.infoType!=="citation"||o.checkType!=="quote-fragment")return!0;const N=Rt(o.direction);if(!(N!=null&&N.fragmentId))return!0;const k=o.description??"";if(!k.trim())return!0;const j=sa(k).nodes[N.fragmentId];if(!j||!j.leftId&&!j.rightId)return!0;const B=[j.leftId,j.rightId].filter(se=>!!se);if(B.length===0)return!0;const R=B.map(se=>{const me=Ot("info",o.cardId,"quote-fragment",se);return b.get(me)??0});return R.reduce((se,me)=>se+me,0)/R.length>=it},ia=async o=>{const b=et,N=o.concat(b.active??[]).concat(b.pool??[]).filter((R,_,se)=>se.findIndex(me=>fe(me)===fe(R))===_);if(!nt){jt(new Set(N.map(fe)));return}const{itemKnowness:k,cardKnowness:V}=await pa(),j=$t.filter(R=>gt(R.childItemType)==="collection"&&R.childItemId===x&&!gt(R.childCheckType)&&!gt(R.childDirection)),B=new Set;for(const R of N){if(R.cardType!=="info"){B.add(fe(R));continue}if(!Ga(R,V))continue;const _=$t.filter(xe=>Is(xe,R)).concat(j);if(_.length===0){B.add(fe(R));continue}let se=0;for(const xe of _)if(gt(xe.parentItemType)==="collection")se+=await fa(xe.parentItemId,V);else if(gt(xe.parentCheckType)||gt(xe.parentDirection)){const je=gt(xe.parentCheckType),Pe=gt(xe.parentDirection),Fe=Ot(xe.parentItemType,xe.parentItemId,je,Pe);se+=V.get(Fe)??0}else{const je=`${xe.parentItemType}:${xe.parentItemId}`;se+=k.get(je)??0}se/_.length>=it&&B.add(fe(R))}jt(B)},Ya=o=>{for(let b=o;b<E.length;b+=1){const N=E[b];if(N&&(!nt||N.cardType!=="info"||pt.has(fe(N))))return b}return-1},At=o=>!nt||o.cardType!=="info"||pt.has(fe(o)),oa=o=>{if(p.id!=="temporal"&&p.id!=="levels")return null;const b=et,N=(b.active??[]).concat(b.pool??[]),k=new Set;for(const V of N){const j=fe(V);if(!(k.has(j)||o.has(j))&&(k.add(j),At(V)))return V}return null},Ft=a.useMemo(()=>{if(p.id!=="levels")return null;const o=et,b=o.pool??[],N=o.active??[],k=o.levelMap??{},V=Math.max(1,Number(u.levels??1)),j=Array.from({length:V},()=>0),B=new Set(N.map(me=>fe(me)));b.forEach(me=>{const xe=Math.min(V,Math.max(1,k[fe(me)]??1));j[xe-1]+=1});const R=b.length||1,_=j.map(me=>me/R*100),se=Y?k[fe(Y)]??1:null;return{counts:j,percentages:_,currentLevel:se,levelsCount:V,activeCount:N.length,poolCount:b.length,activeSet:B}},[et,u,p,Y]),kt=a.useMemo(()=>{if(p.id!=="temporal")return null;const o=et,b=o.pool??[],N=o.active??[],k=o.knownessMap??{},V=new Set(o.unknownSet??[]);let j=0;b.forEach(_=>{(k[fe(_)]??0)>1&&(j+=1)});const B=V.size,R=N.map(_=>({id:fe(_),value:V.has(fe(_))?0:Math.max(0,Math.min(1,k[fe(_)]??0))}));return{knownCount:j,unknownCount:B,dots:R}},[et,p]),la=a.useMemo(()=>{if(!nt)return 0;const o=et;return E.concat(o.active??[]).concat(o.pool??[]).filter((N,k,V)=>V.findIndex(j=>fe(j)===fe(N))===k).filter(N=>N.cardType==="info"&&!pt.has(fe(N))).length},[nt,et,E,pt]);a.useEffect(()=>{if(!nt||be!=="ready")return;const o=et,N=E.concat(o.active??[]).concat(o.pool??[]).filter((j,B,R)=>R.findIndex(_=>fe(_)===fe(j))===B).filter(j=>j.cardType!=="info"||pt.has(fe(j))).length,k=We.current;if(We.current=N,k===null||N<=k)return;const V=N-k;yt(`New card available (+${V})`),Ge.current&&window.clearTimeout(Ge.current),Ge.current=window.setTimeout(()=>yt(null),2200)},[nt,be,et,E,pt]),a.useEffect(()=>()=>{Ge.current&&window.clearTimeout(Ge.current)},[]);const Nt=(o,b)=>{const N=p.applyOutcome({queue:E,meta:et},Y,L,u,{correct:o,correctness:b,createdUtc:new Date().toISOString()});K(N.queue),Et(N.meta);const k=N.queue[ve+1];k&&ba(k,ve+1)};a.useEffect(()=>{qa(c,x).then(o=>X(o.name)).catch(()=>X(t.cogita.library.collections.defaultName))},[c,x]),a.useEffect(()=>{kn({libraryId:c,type:"language"}).then(o=>ge(o)).catch(()=>ge([]))},[c]),a.useEffect(()=>{jn({libraryId:c}).then(o=>Qe(o.items??[])).catch(()=>Qe([]))},[c]),a.useEffect(()=>{dn(c,P)},[c,P]),a.useEffect(()=>{ia(E)},[E,$t,nt,it,x]),a.useEffect(()=>{if(!Y||!nt){le(!1);return}if(Y.cardType!=="info"||pt.has(fe(Y))){le(!1);return}const o=Ya(ve+1);if(o>=0){le(!1),G(o);return}if(p.id==="temporal"||p.id==="levels"){const b=E.slice(0,ve+1),N=E.slice(ve+1).filter(At),k=b.concat(N),V=new Set(k.map(fe)),j=oa(V);if(j){const R=fe(j);V.has(R)||(k.push(j),V.add(R),Et(_=>{const se=_,me=new Set(se.queued??[]);return me.add(R),{...se,queued:me}}))}const B=k.findIndex((R,_)=>_!==ve&&At(R));if(B>=0){K(k),G(B),le(!1);return}}le(!0)},[Y,pt,nt,ve,E,et,p.id]),a.useEffect(()=>{let o=!0;return(async()=>{Be("loading"),$({current:0,total:p.id==="levels"?0:p.getFetchLimit(L,u)});try{const N=[];let k=null,V=null;do{const xe=await Ra({libraryId:c,collectionId:x,limit:300,cursor:k});if(N.push(...xe.items),(p.id==="levels"||p.id==="temporal")&&xe.total&&(V=xe.total),$(je=>({current:N.length,total:je.total||xe.total||p.getFetchLimit(L,u)})),k=xe.nextCursor??null,V!==null&&N.length>=V||p.id!=="levels"&&p.id!=="temporal"&&N.length>=p.getFetchLimit(L,u))break}while(k);if(!o)return;const j=yn(N);let B;if(p.id==="levels"){const xe=Math.max(1,Number(u.levels??1)),Pe=(await Ut()).reduce((Fe,Oe)=>{const Ze=Ot(Oe.itemType,Oe.itemId,Oe.checkType,Oe.direction);return Fe[Ze]||(Fe[Ze]=[]),Fe[Ze].push(Oe),Fe},{});B={},j.forEach(Fe=>{const Oe=fe(Fe),Ze=Pe[Oe]??[],mt=Ze.length>0?qt(Ze).score:0,Ia=Math.max(1,Math.min(xe,Math.ceil(mt/100*xe)));B[Oe]=Ia})}let R=null,_=null,se=null;if(p.id==="temporal"){const xe=await Ut(),je=new Set(j.map(Oe=>fe(Oe))),Pe=xe.reduce((Oe,Ze)=>{const mt=Ot(Ze.itemType,Ze.itemId,Ze.checkType,Ze.direction);return je.has(mt)&&(Oe[mt]||(Oe[mt]=[]),Oe[mt].push(Ze)),Oe},{});R={},_=new Set,se={};const Fe=Date.now();j.forEach(Oe=>{const Ze=fe(Oe),mt=Pe[Ze]??[];if(mt.length===0){R[Ze]=0,_.add(Ze),se[Ze]=[];return}const Ia=Cn(mt);se[Ze]=Ia;const $s=Ua(Ia,Fe);R[Ze]=$s.knowness})}const me=p.id==="levels"?In(j,L,u,B):p.id==="temporal"?Mn(j,L,u,R??{},_??new Set,se??{}):p.prepare(j,L,u);K(me.queue),Et(me.meta),G(0),Be("ready"),$(xe=>({current:Math.min(xe.current,xe.total),total:xe.total}))}catch{o&&Be("error")}})(),()=>{o=!1}},[c,x,L,u,p,P]),a.useEffect(()=>{if(Le(""),te(null),dt(null),lt(0),De([]),ot({}),Ae({}),J(null),Ne(null),z(null),pe(!1),Xe(!1),Ke(null),Z(null),T({}),!Y){Ie(null),ze(null),U(null),at(null);return}Y.cardType==="info"&&Y.infoType==="computed"&&Ie(t.cogita.library.revision.loadingComputed);let o=!0;return ba(Y,ve).then(b=>{!o||!b||(Ie(b.prompt),ze(b.expectedAnswer),De(b.computedExpected),ot(b.computedAnswers),U(b.computedValues),J(b.answerTemplate),Ne(b.outputVariables),z(b.variableValues))}),()=>{o=!1}},[Y,t]),a.useEffect(()=>{if(!Y||Y.cardType!=="info"||Y.infoType!=="citation"){Me.current=null,d.current=new Set,qe(null);return}const o=Y.description??"",b=(Y.label??"").trim(),N=b.replace(/\s+/g," ").trim(),k=o.replace(/\s+/g," ").trim(),V=N&&N!==k?b:t.cogita.library.infoTypes.citation;if(!o){qe(null),ze(null);return}const j=sa(o);Me.current=j,Ie(V);let B=!0;return pa().then(({fragmentKnowness:R})=>{if(!B)return;const _=new Set,se={};R.forEach((je,Pe)=>{const[Fe,Oe]=Pe.split(":",2);if(Fe!==Y.cardId)return;const Ze=Rt(Oe);if(!Ze)return;const{fragmentId:mt}=Ze;se[mt]=je,je>=it&&_.add(mt)}),d.current=_,Se.current=se;const me=Rt(Y.direction);if(me!=null&&me.fragmentId&&j.nodes[me.fragmentId]){Bt(j,me.fragmentId,V);return}const xe=ha(j,_,se,it,nt,Y.direction);Bt(j,(xe==null?void 0:xe.id)??null,V)}).catch(()=>{d.current=new Set,Se.current={};const R=Rt(Y.direction);if(R!=null&&R.fragmentId&&j.nodes[R.fragmentId]){Bt(j,R.fragmentId,V);return}const _=ha(j,d.current,{},it,nt,Y.direction);Bt(j,(_==null?void 0:_.id)??null,V)}),()=>{B=!1}},[Y,t,nt,it]),a.useEffect(()=>{if(!Y||Y.cardType!=="vocab"||Y.checkType!=="translation-match"){Z(null),T({});return}const N=(et.pool??et.active??E).filter(R=>R.cardType==="vocab"&&R.checkType==="translation-match").filter((R,_,se)=>se.findIndex(me=>me.cardId===R.cardId)===_);N.some(R=>R.cardId===Y.cardId)||N.unshift(Y);const V=Kt(N).slice(0,6).map(R=>{const _=R.label.split("↔").map(xe=>xe.trim()).filter(Boolean);if(_.length<2)return null;const se=`${R.cardId}:L`,me=`${R.cardId}:R`;return{cardId:R.cardId,leftId:se,rightId:me,leftLabel:_[0],rightLabel:_[1]}}).filter(Boolean),j=V.map(R=>R.leftId),B=Kt(V.map(R=>R.rightId));Z({pairs:V,leftOrder:j,rightOrder:B,selection:{},activeLeft:null,activeRight:null,locked:{}})},[Y,E,et]),a.useEffect(()=>()=>{ne.current&&window.clearTimeout(ne.current),we.current&&window.clearTimeout(we.current)},[]);const Xt=a.useRef(null);a.useEffect(()=>{if(!Y)return;const o=fe(Y),b=typeof document<"u"?document.activeElement:null;if(Xt.current===o&&b&&(b.tagName==="INPUT"||b.tagName==="TEXTAREA"))return;let N=0;const k=()=>{if(Y){if(Y.cardType==="info"&&Y.infoType==="computed"){if(_e.length>0){const j=Va(Re,_e,Q),B=j?Lt.current[j]:null;if(B&&(B.focus(),document.activeElement===B)){Xt.current=o;return}}if(rt.current&&(rt.current.focus(),document.activeElement===rt.current)){Xt.current=o;return}}else if(Y.cardType==="vocab"&&rt.current&&(rt.current.focus(),document.activeElement===rt.current)){Xt.current=o;return}N<6&&(N+=1,window.setTimeout(k,40))}},V=window.setTimeout(k,40);return()=>window.clearTimeout(V)},[Y,_e,Re,Q]),a.useEffect(()=>{if(!xt)return;const o=b=>{b.key==="Enter"&&(b.preventDefault(),da())};return window.addEventListener("keydown",o),()=>window.removeEventListener("keydown",o)},[xt]);const ea=o=>{Ye(o),at(qt(o))};a.useEffect(()=>{if(!Y){at(null),Ye([]);return}const o=Y.cardType==="info"?"info":"connection";if(Y.cardType==="info"&&Y.infoType==="citation"){Ut().then(b=>{const N=b.filter(k=>k.itemType==="info"&&k.itemId===Y.cardId&&k.checkType==="quote-fragment"&&Ba(k.direction,Y.direction));ea(N)}).catch(()=>{at(null),Ye([])});return}Da(o,Y.cardId,Y.checkType,Y.direction).then(b=>ea(b)).catch(()=>{at(null),Ye([])})},[c,Y,P]);const Sa=(o,b,N,k)=>{if(o==="info"&&N==="quote-fragment"){Ut().then(V=>{const j=V.filter(B=>B.itemType==="info"&&B.itemId===b&&B.checkType==="quote-fragment"&&Ba(B.direction,k));ea(j)}).catch(()=>{at(null),Ye([])});return}Da(o,b,N,k).then(V=>ea(V)).catch(()=>{at(null),Ye([])})},Ta=(o,b,N)=>{var B;const k=((B=N.pairs.find(R=>R.leftId===o))==null?void 0:B.rightId)??null;if(!k)return N;const V=k===b;T(R=>({...R,[o]:V?"correct":"incorrect"})),ne.current&&window.clearTimeout(ne.current),we.current&&window.clearTimeout(we.current),I.current+=1;const j={kind:V?"correct":"incorrect",tick:I.current};if(ae(null),ne.current=window.setTimeout(()=>ae(j),0),we.current=window.setTimeout(()=>ae(null),420),V){const R={...N.locked,[o]:!0};return Object.keys(R).length>=N.pairs.length?(te("correct"),Xe(!0)):te("correct"),{...N,selection:{...N.selection,[o]:b},activeLeft:null,activeRight:null,locked:R}}return te("incorrect"),{...N,activeLeft:null,activeRight:null}},ca=o=>{Z(b=>!b||b.locked[o]?b:b.activeRight?Ta(o,b.activeRight,b):{...b,activeLeft:b.activeLeft===o?null:o})},zt=o=>{Z(b=>b&&(b.activeLeft?Ta(b.activeLeft,o,b):{...b,activeRight:b.activeRight===o?null:o}))},da=()=>{var o;if(Y&&Y.cardType==="info"&&Y.infoType==="citation"&&Me.current&&$e&&!((o=Rt(Y.direction))!=null&&o.fragmentId)){const b=ha(Me.current,d.current,Se.current,it,nt,Y.direction,$e.fragmentId);if(b){te(null),Le(""),pe(!1),Ae({}),Xe(!1),dt(null),lt(0),Bt(Me.current,b.id,$e.title);return}}te(null),Le(""),pe(!1),Ae({}),Xe(!1),dt(null),lt(0),G(b=>Math.min(b+1,E.length))},Pt=o=>{if(!Y)return;const b=o.expected??null,N=o.answer??"";let k=b??"",V=N;if(!b&&o.expectedMap&&o.answerMap){const xe=Object.keys(o.expectedMap).sort((je,Pe)=>je.localeCompare(Pe));k=xe.map(je=>{var Pe;return((Pe=o.expectedMap)==null?void 0:Pe[je])??""}).join("|"),V=xe.map(je=>{var Pe;return((Pe=o.answerMap)==null?void 0:Pe[je])??""}).join("|")}const j=k?ma(k,V,wt):new Uint8Array,B={revisionType:p.id,evalType:o.evalType,direction:o.direction,prompt:Te??"",expected:b,answer:N,expectedAnswers:o.expectedMap??null,answers:o.answerMap??null,correct:o.correct,maskBase64:j.length?Yt(j):null,values:ke??null,checkMode:ue,compareMode:wt,minCorrectness:Ht},R=new TextEncoder().encode(JSON.stringify(B)),_=Y.cardType==="info"?"info":"connection",se=o.overrideCheckType??Y.checkType??null,me=o.overrideDirection??Y.direction??null;za({itemType:_,itemId:Y.cardId,checkType:se,direction:me,revisionType:p.id,evalType:o.evalType,correct:o.correct,maskBase64:j.length?Yt(j):null,payloadBase64:Yt(R),personRoleId:P??null}).then(()=>{Sa(_,Y.cardId,se,me),ia(E),dn(c,P)}).catch(()=>{})},ta=(o,b)=>{const N=ut.current.get(b);if(N)return Promise.resolve(N);const k=st.current.get(b);if(k)return k;const V=Qt({libraryId:c,infoId:o}).then(j=>{var xe,je;const B=j.payload,R=((xe=B.definition)==null?void 0:xe.graph)??null,_="",se=((je=B.definition)==null?void 0:je.answerTemplate)??"",me=Ns(R,_,se);if(me){const Fe={sample:Ss(me),answerTemplate:se||null};return ut.current.set(b,Fe),Fe}return En({libraryId:c,infoId:o}).then(Pe=>{const Fe={sample:Pe,answerTemplate:null};return ut.current.set(b,Fe),Fe})}).catch(()=>En({libraryId:c,infoId:o}).then(j=>{const B={sample:j,answerTemplate:null};return ut.current.set(b,B),B}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{st.current.delete(b)});return st.current.set(b,V),V},ba=(o,b)=>{var R;const N=`${fe(o)}:${b}`,k=bt.current.get(N);if(k)return Promise.resolve(k);const V=ft.current.get(N);if(V)return V;const j=_=>(bt.current.set(N,_),_);let B;if(o.cardType==="vocab"){if(o.checkType==="translation-match")return B=Promise.resolve(j({prompt:o.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),B;const _=o.label.split("↔").map(se=>se.trim()).filter(Boolean);if(_.length>=2){const me=(o.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",xe=me?_[0]:_[1],je=me?_[1]:_[0];B=Promise.resolve(j({prompt:xe,expectedAnswer:je,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else B=Promise.resolve(j({prompt:o.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(o.cardType==="info"&&o.infoType==="word"){const _=(R=o.description)!=null&&R.startsWith("Language: ")?o.description.replace("Language: ",""):null;B=Promise.resolve(j({prompt:o.label,expectedAnswer:_,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else o.cardType==="info"&&o.infoType==="computed"?B=ta(o.cardId,N).then(_=>{var Pe,Fe;if(!_.sample)return j({prompt:o.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const se=_.sample,me=se.expectedAnswers?Object.entries(se.expectedAnswers).map(([Oe,Ze])=>({key:Oe,expected:Ze})):[],xe=me.reduce((Oe,Ze)=>(Oe[Ze.key]="",Oe),{}),je=se.expectedAnswerIsSentence&&((Pe=se.expectedAnswer)==null?void 0:Pe.trim())||null;return j({prompt:se.prompt,expectedAnswer:me.length>0?je:((Fe=se.expectedAnswer)==null?void 0:Fe.trim())||null,computedExpected:me,computedAnswers:xe,computedValues:se.values??null,answerTemplate:_.answerTemplate,outputVariables:se.outputVariables??null,variableValues:se.variableValues??null})}).catch(()=>j({prompt:o.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{ft.current.delete(N)}):B=Promise.resolve(j({prompt:o.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return ft.current.set(N,B),B},Bt=(o,b,N)=>{const k=Object.keys(o.nodes).length,V=d.current.size;if(!b){qe({title:N,before:o.text,after:"",fragmentId:null,total:k,completed:V}),ze(null),Xe(!0);return}const j=o.nodes[b];if(!j)return;const B=Nn(o.text,j);qe({title:N,before:B.before,after:B.after,fragmentId:j.id,total:k,completed:V}),ze(B.fragment),Xe(!1)},Ca=()=>{const o=Me.current;o&&qe(b=>b&&{...b,total:Object.keys(o.nodes).length,completed:d.current.size})},ua=()=>{const o=E[ve+1];o&&ba(o,ve+1)},Ma=()=>{if(ua(),Y&&Y.cardType==="vocab"&&Y.checkType==="translation-match"&&w){if(w.pairs.length===0){te("incorrect"),Xe(!0);return}const j=w.pairs.reduce((je,Pe)=>(je[Pe.rightId]=Pe.rightLabel,je),{});let B=0;const R={};w.pairs.forEach(je=>{const Fe=w.selection[je.leftId]===je.rightId;R[je.leftId]=Fe?"correct":"incorrect",Fe&&(B+=1)});const _=w.pairs.length||1,se=B/_,me=B===w.pairs.length;T(je=>({...je,...R})),me?(te("correct"),Xe(!0),lt(0)):(te("incorrect"),Xe(!1),lt(je=>{const Pe=je+1;return Pe>=vt&&(pe(!0),Xe(!0),Z(Fe=>{if(!Fe)return Fe;const Oe=Fe.pairs.reduce((Ze,mt)=>(Ze[mt.leftId]=mt.rightId,Ze),{});return{...Fe,selection:Oe}})),Pe})),Nt(me,se);const xe="connection";Promise.all(w.pairs.map(je=>{const Pe=w.selection[je.leftId]??null,Fe=Pe?j[Pe]:"",Oe={left:je.leftLabel,expected:je.rightLabel,answer:Fe,checkType:"translation-match"},Ze=new TextEncoder().encode(JSON.stringify(Oe));return za({itemType:xe,itemId:je.cardId,checkType:"translation-match",direction:null,revisionType:p.id,evalType:"translation-match",correct:Pe===je.rightId,maskBase64:null,payloadBase64:Yt(Ze),personRoleId:P??null})})).then(()=>{Sa(xe,Y.cardId,Y.checkType,Y.direction),dn(c,P)}).catch(()=>{});return}if(_e.length>0){const j=_e.reduce((R,_)=>{const se=Ue[_.key]??"";return R[_.key]=St(se)===St(_.expected)?"correct":"incorrect",R},{});_e.every(({key:R,expected:_})=>{const se=Ue[R]??"";return ue==="exact"&&St(se)===St(_)})?(te("correct"),Ae(j),Xe(!0),lt(0),Nt(!0,1),Pt({correct:!0,direction:Te?`${Te} -> computed`:"computed",expectedMap:_e.reduce((R,_)=>(R[_.key]=_.expected,R),{}),answerMap:Ue,evalType:"computed"})):(te("incorrect"),Ae(j),Xe(!1),lt(R=>{const _=R+1;return _>=vt&&W&&(pe(!0),Xe(!0)),_}),Nt(!1,0),window.setTimeout(()=>{var _;const R=Va(Re,_e,Q);R&&Lt.current[R]&&((_=Lt.current[R])==null||_.focus())},40),Pt({correct:!1,direction:Te?`${Te} -> computed`:"computed",expectedMap:_e.reduce((R,_)=>(R[_.key]=_.expected,R),{}),answerMap:Ue,evalType:"computed"}));return}if(Y&&Y.cardType==="info"&&Y.infoType==="citation"&&($e!=null&&$e.fragmentId)){if(!Ee)return;const j=Rt(Y.direction),B=(j==null?void 0:j.fragmentId)??$e.fragmentId,R=Ka(Ee,ee,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),_=R.mask,se=R.isCorrect,me=R.percent;se?(Se.current[$e.fragmentId]=Math.max(Se.current[$e.fragmentId]??0,me),(Se.current[$e.fragmentId]??0)>=it&&d.current.add($e.fragmentId),Ca(),te("correct"),Ae({}),Xe(!0),dt(_),lt(0),me<100&&vt<=1&&pe(!0),Nt(!0,me/100),Pt({correct:!0,direction:`quote:${$e.fragmentId}`,expected:Ee,answer:ee,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:B})):(te("incorrect"),Ae({}),Xe(!1),dt(_),lt(xe=>{const je=xe+1;return je>=vt&&W&&(pe(!0),Xe(!0)),je}),Nt(!1,me/100),window.setTimeout(()=>{var xe;return(xe=rt.current)==null?void 0:xe.focus()},40),Pt({correct:!1,direction:`quote:${$e.fragmentId}`,expected:Ee,answer:ee,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:B}));return}if(!Ee)return;const o=ma(Ee,ee,wt),b=ue==="exact"&&St(ee)===St(Ee),N=ga(o),k=b||N,V=Zt(o);k?(te("correct"),Ae({}),Xe(!0),dt(o),lt(0),V<100&&vt<=1&&pe(!0),Nt(!0,V/100),Pt({correct:!0,direction:Te?`${Te} -> ${Ee}`:null,expected:Ee,answer:ee,evalType:"text"})):(te("incorrect"),Ae({}),Xe(!1),dt(o),lt(j=>{const B=j+1;return B>=vt&&W&&(pe(!0),Xe(!0)),B}),Nt(!1,V/100),window.setTimeout(()=>{var j;return(j=rt.current)==null?void 0:j.focus()},40),Pt({correct:!1,direction:Te?`${Te} -> ${Ee}`:null,expected:Ee,answer:ee,evalType:"text"}))},Qa=o=>{if(ua(),!Ee)return;const b=ma(Ee,o,wt),N=St(o)===St(Ee),k=ga(b),V=N||k,j=Zt(b);V?(te("correct"),Ae({}),Xe(!0),dt(b),lt(0),j<100&&vt<=1&&pe(!0),Nt(!0,j/100),Pt({correct:!0,direction:"word->language",expected:Ee,answer:o,evalType:"language-select"})):(te("incorrect"),Ae({}),Xe(!1),dt(b),lt(B=>{const R=B+1;return R>=vt&&W&&(pe(!0),Xe(!0)),R}),Nt(!1,j/100),Pt({correct:!1,direction:"word->language",expected:Ee,answer:o,evalType:"language-select"}))},Za=()=>{ua(),te("correct"),Xe(!0),lt(0),Nt(!0,1),Ee&&Pt({correct:!0,direction:"manual",expected:Ee,answer:ee,evalType:"manual"})},Xa=()=>{if(Nt(!1,0),Y&&Y.cardType==="info"&&Y.infoType==="citation"){te(null),Le(""),pe(!1),Ae({}),Xe(!1),dt(null),lt(0),G(o=>Math.min(o+1,E.length));return}da()};a.useEffect(()=>{ua()},[ve,E]);const aa=o=>{var N;if(o.key!=="Enter")return;if(o.preventDefault(),o.stopPropagation(),xt){da();return}const b=_e.find(k=>!(Ue[k.key]??"").trim());if(b){(N=Lt.current[b.key])==null||N.focus();return}Ma()},A=t.cogita.library.revision.revealModeAfterIncorrect,W=_e.length>0||!!Ee;return e.jsxs(Tt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,children:[be==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${ye.total?Math.min(100,Math.max(0,ye.current/ye.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:ye.total?`${Math.min(ye.current,ye.total)} / ${ye.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:F}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",y).replace("{check}",H)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${v}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${v}/collections/${x}`,children:t.cogita.library.actions.collectionDetail})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:he?`${he.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Ft?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Ft.currentLevel??"-"," / ",Ft.levelsCount]}):null,he?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(he.correct)).replace("{total}",String(he.total))}),he.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(he.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(Ts,{outcomes:Je})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[ct?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:ct})}):null,e.jsx(Sn,{feedbackToken:O?`${O.kind}-${O.tick}`:re?"idle":oe??"idle",children:Y?e.jsx(e.Fragment,{children:q?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(Tn,{copy:t,currentCard:Y,currentTypeLabel:Mt,prompt:Te,languages:ce,answer:ee,onAnswerChange:o=>Le(b=>_a(b,o,Ce)),computedExpected:_e,computedAnswers:Ue,onComputedAnswerChange:(o,b)=>ot(N=>({...N,[o]:_a(N[o]??"",b,Ce)})),answerTemplate:Re,outputVariables:Q,variableValues:Ve,computedFieldFeedback:tt,feedback:oe,canAdvance:xt,quoteContext:$e,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Ma,onSkip:Xa,onLanguageSelect:Qa,onMarkReviewed:Za,onAdvance:da,showCorrectAnswer:ie,setShowCorrectAnswer:pe,onRevealCorrect:()=>Xe(!0),answerMask:Ct,expectedAnswer:Ee,hasExpectedAnswer:W,handleComputedKeyDown:aa,answerInputRef:rt,computedInputRefs:Lt,scriptMode:Ce,setScriptMode:Ke,matchPairs:w==null?void 0:w.pairs,matchLeftOrder:w==null?void 0:w.leftOrder,matchRightOrder:w==null?void 0:w.rightOrder,matchSelection:w==null?void 0:w.selection,matchActiveLeft:w==null?void 0:w.activeLeft,matchActiveRight:w==null?void 0:w.activeRight,matchFeedback:de,onMatchLeftSelect:ca,onMatchRightSelect:zt})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${v}/collections/${x}`,children:t.cogita.library.actions.collectionDetail})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Gt?`${Dt} / ${Gt}`:t.cogita.library.revision.progressUnlimited}),be==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),be==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),be==="ready"&&E.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:A}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",vt]})]})]}),Ft?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Ft.activeCount," / ",Ft.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Ft.counts.map((o,b)=>{const N=b+1,k=Ft.currentLevel===N,V=Ft.percentages[b]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":k,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:N}),e.jsx("strong",{children:o})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,V))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[V.toFixed(1),"%"]})]},`level-${N}`)})})]}):null,kt?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:kt.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:kt.dots.map(o=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,o.value*100))}%`,background:`rgba(${Math.round(255*(1-o.value))}, ${Math.round(200*o.value)}, 80, 0.9)`}},o.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:kt.knownCount})]})]}):null,nt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:la})]})}):null]})]})]})})})]})]})}const un=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],ci={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},di=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],ui=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function hi({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,libraryId:c,collectionId:x}){const[l,m]=a.useState(""),[v,S,L]=rs([]),[D,p,u]=is([]),[ue,P]=a.useState(null),[y,H]=a.useState(null),[F,X]=a.useState(null),E=`/#/cogita/library/${c}`;a.useEffect(()=>{qa(c,x).then($=>m($.name)).catch(()=>m(t.cogita.library.collections.defaultName))},[c,x,t]),a.useEffect(()=>{Gs({libraryId:c,collectionId:x}).then($=>{if(!$.graphId||$.graphId==="00000000-0000-0000-0000-000000000000"){S([]),p([]);return}const ve=$.nodes.map(ee=>{var Te;const Le=ee.payload??{},oe=Le.position??{x:120,y:120},te=Le.params??{};return{id:ee.nodeId,type:"default",position:oe,data:{nodeType:ee.nodeType,label:((Te=un.find(Ie=>Ie.type===ee.nodeType))==null?void 0:Te.label)??ee.nodeType,params:te}}}),G=$.edges.map(ee=>({id:ee.edgeId,source:ee.fromNodeId,target:ee.toNodeId,sourceHandle:ee.fromPort??void 0,targetHandle:ee.toPort??void 0}));S(ve),p(G)}).catch(()=>{S([]),p([])})},[c,x,p,S]);const K=a.useMemo(()=>v.find($=>$.id===ue)??null,[v,ue]),ce=$=>{var Le;const ve=crypto.randomUUID(),G=((Le=un.find(oe=>oe.type===$))==null?void 0:Le.label)??$,ee={...ci[$]};S(oe=>[...oe,{id:ve,type:"default",position:{x:120+oe.length*40,y:120+oe.length*40},data:{nodeType:$,label:G,params:ee}}]),P(ve)},ge=a.useCallback($=>{p(ve=>os({...$,id:crypto.randomUUID()},ve))},[p]),be=async()=>{H(null);try{await Qs({libraryId:c,collectionId:x,nodes:v.map($=>({nodeId:$.id,nodeType:$.data.nodeType,payload:{position:$.position,params:$.data.params}})),edges:D.map($=>({edgeId:$.id,fromNodeId:$.source,fromPort:$.sourceHandle??null,toNodeId:$.target,toPort:$.targetHandle??null}))}),H(t.cogita.library.graph.saveSuccess)}catch{H(t.cogita.library.graph.saveFail)}},Be=async()=>{try{const $=await Ys({libraryId:c,collectionId:x});X($)}catch{X(null)}},ye=$=>{K&&S(ve=>ve.map(G=>G.id===K.id?{...G,data:{...G.data,params:$}}:G))};return e.jsx(Tt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${E}/collections/${x}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Be,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:be,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:un.map($=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>ce($.type),children:$.label},$.type))}),y?e.jsx("p",{className:"cogita-help",children:y}):null,F&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(F.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(F.connections)).replace("{infos}",String(F.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(xn,{nodes:v,edges:D,onNodesChange:L,onEdgesChange:u,onConnect:ge,onNodeClick:($,ve)=>P(ve.id),fitView:!0,children:[e.jsx(vn,{color:"rgba(120,160,200,0.2)"}),e.jsx(wn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),K?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:K.data.label}),K.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Jt,{libraryId:c,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:K.data.params.tagId?{id:K.data.params.tagId,label:K.data.params.tagLabel??"",infoType:"topic"}:null,onChange:$=>ye({...K.data.params,tagId:($==null?void 0:$.id)??null,tagLabel:($==null?void 0:$.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:K.data.params.scope??"any",onChange:$=>ye({...K.data.params,scope:$.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),K.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Jt,{libraryId:c,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:K.data.params.languageId?{id:K.data.params.languageId,label:K.data.params.languageLabel??"",infoType:"language"}:null,onChange:$=>ye({...K.data.params,languageId:($==null?void 0:$.id)??null,languageLabel:($==null?void 0:$.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:K.data.params.scope??"any",onChange:$=>ye({...K.data.params,scope:$.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),K.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:K.data.params.infoType??"word",onChange:$=>ye({...K.data.params,infoType:$.target.value}),children:ui.map($=>e.jsx("option",{value:$.value,children:$.label},$.value))})]}),e.jsx(Jt,{libraryId:c,infoType:K.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:K.data.params.infoId?{id:K.data.params.infoId,label:K.data.params.infoLabel??"",infoType:K.data.params.infoType??"word"}:null,onChange:$=>ye({...K.data.params,infoId:($==null?void 0:$.id)??null,infoLabel:($==null?void 0:$.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),K.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:K.data.params.connectionType??"translation",onChange:$=>ye({...K.data.params,connectionType:$.target.value}),children:di.map($=>e.jsx("option",{value:$.value,children:$.label},$.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:K.data.params.connectionId??"",onChange:$=>ye({...K.data.params,connectionId:$.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(K.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const hn="cogita.preferences",mn="cogita.reviewer.preferences",Ls=["library_overview","all_cards","all_collections","storyboards","texts","dependencies","transfer"],gn={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},pn=["settings","run","shared"];function mi(t,n=""){const s=t.split("/").filter(Boolean);if(s[0]!=="cogita"||s[1]!=="library")return{};const r=s[2];if(!r)return{};if(!s[3])return{libraryId:r,target:"library_overview"};const i=new URLSearchParams(n),g=i.get("revisionId")??void 0,h=i.get("infoId")??void 0,f=i.get("infoView")==="cards"?"cards":"overview",C=i.get("collectionAction"),M=i.get("libraryAction");if(s[3]==="list")return{libraryId:r,target:M==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:g,infoId:h,infoView:f,libraryAction:M==="new-info"?"new-info":void 0};if(s[3]==="detail"||s[3]==="collection")return{libraryId:r,target:"all_cards",cardMode:s[3],revisionId:g,infoId:h,infoView:f};if(s[3]==="new"||s[3]==="add")return{libraryId:r,target:"new_card",revisionId:g,libraryAction:"new-info"};if(s[3]==="edit")return{libraryId:r,target:"new_card",revisionId:g,infoId:s[4]};if(s[3]==="infos"){const x=s[4];return x?s[5]==="checkcards"?{libraryId:r,target:"all_cards",cardMode:"list",revisionId:g,infoId:x,infoView:"cards"}:{libraryId:r,target:"all_cards",cardMode:"list",revisionId:g,infoId:x,infoView:"overview"}:{libraryId:r,target:"all_cards",cardMode:"list",revisionId:g}}if(s[3]==="shared-revisions")return{libraryId:r,target:"all_collections",revisionId:g};if(s[3]==="dependencies")return{libraryId:r,target:"dependencies"};if(s[3]==="transfer")return{libraryId:r,target:"transfer"};if(s[3]==="storyboards")return s[4]==="new"?{libraryId:r,target:"new_storyboard"}:{libraryId:r,target:"storyboards"};if(s[3]==="texts")return s[4]==="new"?{libraryId:r,target:"new_text"}:{libraryId:r,target:"texts"};if(s[3]!=="collections")return{libraryId:r,target:"library_overview"};if(s[4]==="new")return{libraryId:r,target:"new_collection",revisionId:g};const c=s[4];return c?s[5]==="graph"?{libraryId:r,target:"all_collections",collectionId:c,revisionId:g,revisionView:"graph"}:s[5]==="shared-revisions"?{libraryId:r,target:"all_collections",collectionId:c,revisionId:g,revisionView:"shared"}:s[5]==="revision"?{libraryId:r,target:"all_collections",collectionId:c,revisionId:g,revisionView:s[6]==="run"?"run":"settings"}:C==="new-revision"?{libraryId:r,target:"all_collections",collectionId:c,revisionId:g,revisionView:"new"}:{libraryId:r,target:"all_collections",collectionId:c,revisionId:g,revisionView:"detail"}:C==="new-collection"?{libraryId:r,target:"new_collection",collectionAction:"new-collection"}:{libraryId:r,target:"all_collections"}}function ns(t,n="library_overview",s,r,i,g,h="overview"){const f=(C,M)=>{const c=new URLSearchParams;M!=null&&M.revisionId&&c.set("revisionId",M.revisionId),M!=null&&M.collectionAction&&c.set("collectionAction",M.collectionAction),M!=null&&M.libraryAction&&c.set("libraryAction",M.libraryAction),M!=null&&M.infoId&&c.set("infoId",M.infoId),M!=null&&M.infoView&&(M!=null&&M.infoId)&&c.set("infoView",M.infoView);const x=c.toString();return x?`${C}?${x}`:C};return t?n==="library_overview"?f(`/cogita/library/${t}`,{revisionId:i}):n==="all_cards"?g?h==="cards"?f(`/cogita/library/${t}/infos/${g}/checkcards`,{revisionId:i}):f(`/cogita/library/${t}/infos/${g}`,{revisionId:i}):f(`/cogita/library/${t}/list`,{revisionId:i,infoId:g,infoView:h}):n==="new_card"?g?f(`/cogita/library/${t}/edit/${g}`,{revisionId:i}):f(`/cogita/library/${t}/list`,{revisionId:i,libraryAction:"new-info"}):n==="all_collections"?s?r==="graph"?f(`/cogita/library/${t}/collections/${s}/graph`,{revisionId:i}):r==="settings"?f(`/cogita/library/${t}/collections/${s}/revision`,{revisionId:i}):r==="run"?f(`/cogita/library/${t}/collections/${s}/revision/run`,{revisionId:i}):r==="shared"?f(`/cogita/library/${t}/collections/${s}/shared-revisions`,{revisionId:i}):r==="new"?f(`/cogita/library/${t}/collections/${s}`,{revisionId:i,collectionAction:"new-revision"}):f(`/cogita/library/${t}/collections/${s}`,{revisionId:i}):f(`/cogita/library/${t}/collections`,{revisionId:i}):n==="new_collection"?f(`/cogita/library/${t}/collections`,{revisionId:i,collectionAction:"new-collection"}):n==="transfer"?f(`/cogita/library/${t}/transfer`,{revisionId:i}):n==="storyboards"?f(`/cogita/library/${t}/storyboards`,{revisionId:i}):n==="new_storyboard"?f(`/cogita/library/${t}/storyboards/new`,{revisionId:i}):n==="texts"?f(`/cogita/library/${t}/texts`,{revisionId:i}):n==="new_text"?f(`/cogita/library/${t}/texts/new`,{revisionId:i}):n==="dependencies"?f(`/cogita/library/${t}/dependencies`,{revisionId:i}):f(`/cogita/library/${t}`,{revisionId:i}):"/cogita"}function xa(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function gi(t){return typeof t=="string"&&Ls.includes(t)}function pi(t,n){var f;if(!t.length)return null;const s=t.filter(C=>n.has(C.roleId)),r=s.length>0?s:t,i=r.map(C=>{var c,x;const M=((x=(c=C.fields.find(l=>l.fieldType==="role_kind"))==null?void 0:c.plainValue)==null?void 0:x.toLowerCase())??"";return{roleId:C.roleId,roleKind:M}}),g=i.find(C=>C.roleKind.includes("master"));if(g)return g.roleId;const h=i.find(C=>C.roleKind.includes("account")||C.roleKind.includes("user"));return h?h.roleId:((f=r[0])==null?void 0:f.roleId)??null}function fi(t){if(!t)return{version:1,byLibrary:{}};try{const n=JSON.parse(t);return!n||typeof n!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:n.lastLibraryId,byLibrary:n.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function bi({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M}){const c=ss(),x=Oa(),l=a.useMemo(()=>mi(x.pathname,x.search),[x.pathname,x.search]),m=t.cogita.workspace,[v,S]=a.useState([]),[L,D]=a.useState([]),[p,u]=a.useState([]),[ue,P]=a.useState([]),[y,H]=a.useState(void 0),[F,X]=a.useState("library_overview"),[E,K]=a.useState(void 0),[ce,ge]=a.useState(void 0),[be,Be]=a.useState("detail"),[ye,$]=a.useState(void 0),[ve,G]=a.useState(!1),[ee,Le]=a.useState(!0),[oe,te]=a.useState(!1),[Te,Ie]=a.useState(!1),[Ee,ze]=a.useState(null),[$e,qe]=a.useState(0),[_e,De]=a.useState(""),[Ue,ot]=a.useState(""),[tt,Ae]=a.useState(""),[ke,U]=a.useState([]),[Re,J]=a.useState(""),[Q,Ne]=a.useState(null),[Ve,z]=a.useState(null),w=a.useRef({version:1,byLibrary:{}}),Z=a.useRef(!1),de=a.useRef(!1),T=a.useRef(null),I=a.useMemo(()=>v.find(d=>d.libraryId===y)??null,[v,y]),O=a.useMemo(()=>L.find(d=>d.collectionId===E)??null,[L,E]);a.useEffect(()=>{if(!y){U([]),J("");return}let d=!1;return ys({libraryId:y}).then(Se=>{if(d)return;const Y=Se.filter(re=>(re.roleKind??"").trim().toLowerCase()==="person");U(Y);try{const re=window.localStorage.getItem(mn),st=(re?JSON.parse(re):{})[y]??"",bt=st&&Y.some(ft=>ft.roleId===st)?st:"";J(bt)}catch{J("")}}).catch(()=>{d||(U([]),J(""))}),()=>{d=!0}},[y]),a.useEffect(()=>{if(y)try{const d=window.localStorage.getItem(mn),Se=d?JSON.parse(d):{};Re?Se[y]=Re:delete Se[y],window.localStorage.setItem(mn,JSON.stringify(Se))}catch{}},[y,Re]);const ae=a.useMemo(()=>ue.find(d=>d.revisionId===ce)??null,[ue,ce]),ne=a.useMemo(()=>({detail:m.revisions.detail,graph:m.revisions.graph,settings:m.revisions.settings,run:m.revisions.run,shared:m.targets.sharedRevisions,new:m.revisionForm.createAction}),[m.revisions.detail,m.revisions.graph,m.revisions.run,m.revisions.settings,m.targets.sharedRevisions,m.revisionForm.createAction]),we=a.useMemo(()=>[{value:"detail",label:ne.detail},{value:"graph",label:ne.graph},{value:"settings",label:m.targets.allRevisions},{value:"run",label:ne.run},{value:"shared",label:ne.shared}],[ne.detail,ne.graph,ne.run,ne.shared,m.targets.allRevisions]),Ce=a.useMemo(()=>F==="new_card"?"all_cards":F==="new_collection"?"all_collections":F==="new_storyboard"?"storyboards":F==="new_text"?"texts":F,[F]),Ke=a.useMemo(()=>be==="new"?"settings":be,[be]),ie=a.useMemo(()=>l.infoId?"selected":F==="new_card"?"create":"search",[l.infoId,F]),pe=a.useMemo(()=>p.find(d=>d.infoId===l.infoId)??null,[p,l.infoId]),he=a.useMemo(()=>({library_overview:m.targets.libraryOverview,all_cards:m.targets.allCards,new_card:m.targets.newCard,all_collections:m.targets.allCollections,new_collection:m.targets.newCollection,transfer:m.targets.transfer,storyboards:m.targets.storyboards,new_storyboard:m.targets.newStoryboard,texts:m.targets.texts,new_text:m.targets.newText,dependencies:m.targets.dependencies}),[m.targets]),at=a.useMemo(()=>he[Ce]??Ce,[Ce,he]),Je=ne[Ke],Ye=!!y,ct=a.useMemo(()=>{const d=C==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":C==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return C==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:d},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:d},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:d},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:d},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:d},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:d},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:d},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:d},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:d},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:d},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:d},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:d},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:d},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:C==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:d},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:d},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:d},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:d},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:d},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:d},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:d},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:d},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:d},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:d},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:d},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:d},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:d},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:d},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:d},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:d},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:d},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:d},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:d},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:d},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:d},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:d},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:d},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:d},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:d},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:d},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[C]),yt=ct.length,We=Math.max(0,Math.min($e,yt-1)),Ge=ct[We],Ct=!!E,dt=Ye&&F==="all_collections",It=Ct&&F==="all_collections",lt=Ct&&F==="all_collections"&&pn.includes(be),rt=a.useCallback(d=>{const Se=!!d.libraryId;let Y=d.target,re=d.collectionId,ut=d.revisionId,st=d.revisionView,bt=d.infoId,ft=d.infoView??l.infoView??"overview";Se?gn[Y].requiresCollection&&!re?(Y="all_collections",ut=void 0,st="detail"):Y!=="all_collections"?(re=void 0,ut=void 0,Y!=="new_card"&&Y!=="all_cards"&&(bt=void 0,ft="overview")):gn[Y].allowsRevision?pn.includes(st)||(ut=void 0):st="detail":(Y="library_overview",re=void 0,ut=void 0,st="detail",bt=void 0,ft="overview"),H(d.libraryId),X(Y),K(re),ge(ut),Be(st),G(!1);const Mt=xa(ns(d.libraryId,Y,re,st,ut,bt,ft));xa(`${x.pathname}${x.search}`)!==Mt&&(T.current=Mt,c(Mt))},[x.pathname,x.search,c,l.infoView]),Lt=d=>{rt({libraryId:y,target:"all_collections",collectionId:E,revisionId:pn.includes(d)?ce:void 0,revisionView:d})},xt=a.useMemo(()=>[{key:"library",label:m.layers.library,visible:!0,value:y??"",selectedLabel:(I==null?void 0:I.name)??m.path.noLibrarySelected,disabled:ee||v.length===0,options:v.map(d=>({value:d.libraryId,label:d.name})),emptyOption:m.noLibraryOption,onSelect:d=>{const Se=d||void 0;rt({libraryId:Se,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:m.layers.target,visible:Ye,value:Ce,selectedLabel:at,disabled:!Ye,options:Ls.map(d=>({value:d,label:he[d]})),onSelect:d=>{const Se=d;rt({libraryId:y,target:Se,collectionId:E,revisionId:ce,revisionView:be,infoId:Se==="new_card"?l.infoId:void 0})}},{key:"info_mode",label:m.layers.target,visible:Ce==="all_cards",value:ie,selectedLabel:ie==="create"?m.infoMode.create:ie==="selected"?(pe==null?void 0:pe.label)??ye??t.cogita.library.list.selectedEmpty:m.infoMode.search,disabled:!Ye,options:[{value:"search",label:m.infoMode.search},{value:"create",label:m.infoMode.create},...l.infoId?[{value:"selected",label:(pe==null?void 0:pe.label)??ye??t.cogita.library.list.selectedEmpty}]:[]],onSelect:d=>{if(d==="selected"){if(!l.infoId)return;rt({libraryId:y,target:"all_cards",collectionId:E,revisionId:ce,revisionView:be,infoId:l.infoId,infoView:"overview"});return}if(d==="create"){rt({libraryId:y,target:"new_card",collectionId:E,revisionId:ce,revisionView:be,infoId:void 0});return}rt({libraryId:y,target:"all_cards",collectionId:E,revisionId:ce,revisionView:be,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:m.layers.target,visible:Ce==="all_cards"&&!!l.infoId,value:F==="new_card"&&l.infoId?"edit":l.infoView==="cards"?"cards":"overview",selectedLabel:F==="new_card"&&l.infoId?m.infoActions.edit:l.infoView==="cards"?m.infoActions.seeCards:m.infoActions.overview,disabled:!Ye||!l.infoId,options:[{value:"overview",label:m.infoActions.overview},{value:"edit",label:m.infoActions.edit},{value:"cards",label:m.infoActions.seeCards}],onSelect:d=>{if(l.infoId){if(d==="edit"){rt({libraryId:y,target:"new_card",collectionId:E,revisionId:ce,revisionView:be,infoId:l.infoId});return}if(d==="cards"){rt({libraryId:y,target:"all_cards",collectionId:E,revisionId:ce,revisionView:be,infoId:l.infoId,infoView:"cards"});return}rt({libraryId:y,target:"all_cards",collectionId:E,revisionId:ce,revisionView:be,infoId:l.infoId,infoView:"overview"})}}},{key:"collection",label:m.layers.collection,visible:dt,value:E??"",selectedLabel:(O==null?void 0:O.name)??m.path.noCollectionSelected,disabled:!Ye||oe||L.length===0,options:L.map(d=>({value:d.collectionId,label:d.name})),emptyOption:m.selectCollectionOption,onSelect:d=>{rt({libraryId:y,target:"all_collections",collectionId:d||void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection_action",label:m.layers.revision,visible:It,value:Ke,selectedLabel:Je,disabled:!E,options:we.map(d=>({value:d.value,label:d.label})),onSelect:d=>{Lt(d)}},{key:"revision_entry",label:m.layers.revision,visible:lt,value:ce??"",selectedLabel:(ae==null?void 0:ae.name)??m.status.noRevisions,disabled:!Ct||Te||ue.length===0,options:ue.map(d=>({value:d.revisionId,label:d.name})),emptyOption:m.status.noRevisions,onSelect:d=>{rt({libraryId:y,target:"all_collections",collectionId:E,revisionId:d||void 0,revisionView:be})}}],[we,L,oe,ie,p,v,ee,rt,ue,Te,O,E,pe,ae,ce,ye,Ct,Ye,I,y,Je,be,F,Ke,Ce,at,dt,It,lt,he,t.cogita.library.list.selectedEmpty,l.infoId,l.infoView,m.infoActions.edit,m.infoActions.overview,m.infoActions.seeCards,m.layers.collection,m.layers.library,m.layers.revision,m.layers.target,m.noLibraryOption,m.path.noCollectionSelected,m.path.noLibrarySelected,m.selectCollectionOption]),Xe=a.useMemo(()=>xt.filter(d=>d.visible),[xt]),et=a.useMemo(()=>Xe.filter(d=>d.key!=="library"&&d.key!=="collection"&&d.key!=="revision_entry"),[Xe]),Et=a.useMemo(()=>et.find(d=>d.key==="target")??null,[et]),$t=a.useMemo(()=>et.find(d=>d.key==="info_mode")??null,[et]),Qe=a.useMemo(()=>et.find(d=>d.key==="info_selected_action")??null,[et]),ht=a.useMemo(()=>et.find(d=>d.key==="collection_action")??null,[et]),pt=a.useCallback((d,Se)=>d?e.jsx("div",{className:"cogita-sidebar-actions",children:d.options.map(Y=>e.jsx("button",{type:"button",className:`ghost ${String(d.value)===Y.value?"active":""}`,onClick:()=>d.onSelect(Y.value),disabled:d.disabled,children:Y.label},`${Se}:${d.key}:${Y.value}`))}):null,[]),jt=a.useMemo(()=>{const d=l.libraryId;if(!d||!x.pathname.startsWith("/cogita/library/"))return null;const Se={copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,libraryId:d};if(l.target==="library_overview")return e.jsx(fr,{...Se});if(l.target==="all_cards")return l.infoId&&l.infoView==="cards"?e.jsx(zr,{...Se,infoId:l.infoId,selectedReviewerRoleId:Re||null}):e.jsx(kr,{...Se,mode:l.cardMode??"list"});if(l.target==="new_card")return e.jsx(Rr,{...Se,editInfoId:l.infoId});if(l.target==="dependencies")return e.jsx(Ar,{...Se});if(l.target==="transfer")return e.jsx(Br,{...Se});if(l.target==="storyboards"||l.target==="new_storyboard")return e.jsx(_r,{...Se});if(l.target==="texts"||l.target==="new_text")return e.jsx(Vr,{...Se});if(l.target==="all_collections"){if(l.collectionId){const Y={...Se,collectionId:l.collectionId};return l.revisionView==="graph"?e.jsx(hi,{...Y}):l.revisionView==="shared"?e.jsx(Dr,{...Se,collectionId:l.collectionId}):l.revisionView==="settings"?e.jsx(Zr,{...Y,revisionId:l.revisionId}):l.revisionView==="run"?e.jsx(li,{...Y,revisionId:l.revisionId}):e.jsx(Or,{...Y})}return e.jsx(as,{...Se})}return l.target==="new_collection"?e.jsx(as,{...Se}):null},[n,t,C,x.pathname,c,M,g,f,r,i,l.cardMode,l.collectionId,l.infoId,l.libraryId,l.revisionId,l.revisionView,l.target,h,s,Re]);a.useEffect(()=>{let d=!1;return(async()=>{var Y,re,ut,st,bt;Le(!0);try{await Zs();const[ft,Mt,ra]=await Promise.all([ds(),Xs(),er()]);if(d)return;S(ft);const Gt=new Set(ra.nodes.filter(nt=>nt.nodeType==="role"&&nt.canLink).map(nt=>nt.roleId??"")),Dt=pi(Mt,Gt);if(Ne(Dt),Dt){const nt=ra.nodes.find(it=>it.nodeType==="data"&&it.roleId===Dt&&(it.fieldType===hn||it.label===hn));z((nt==null?void 0:nt.dataKeyId)??null),w.current=fi(nt==null?void 0:nt.value)}const vt=(Y=ft.find(nt=>nt.libraryId===l.libraryId))==null?void 0:Y.libraryId,wt=vt?(ut=(re=w.current.byLibrary)==null?void 0:re[vt])==null?void 0:ut.lastTarget:void 0,Ht=gi(wt)?wt:"library_overview";H(vt),X(l.target??Ht),ge(l.revisionId??(vt?(bt=(st=w.current.byLibrary)==null?void 0:st[vt])==null?void 0:bt.lastRevisionId:void 0)),Be(l.revisionView??"detail"),Z.current=!0}catch{d||ze(m.status.loadFailed)}finally{d||Le(!1)}})(),()=>{d=!0}},[m.status.loadFailed]),a.useLayoutEffect(()=>{if(Z.current){if(!l.libraryId){H(void 0),X(l.target??"library_overview"),K(void 0),ge(void 0),Be("detail");return}l.libraryId&&v.some(d=>d.libraryId===l.libraryId)&&H(l.libraryId),l.target&&X(l.target),K(l.collectionId),ge(l.revisionId),l.revisionView&&Be(l.revisionView)}},[v,l.collectionId,l.libraryId,l.revisionId,l.revisionView,l.target]),a.useEffect(()=>{if(!y){D([]),K(void 0),u([]),P([]),ge(void 0);return}let d=!1;return te(!0),ja({libraryId:y,limit:200}).then(Se=>{var ut;if(d)return;const Y=Se.items;D(Y);const re=(ut=Y.find(st=>st.collectionId===l.collectionId))==null?void 0:ut.collectionId;K(re)}).catch(()=>{d||(D([]),K(void 0))}).finally(()=>{d||te(!1)}),()=>{d=!0}},[l.collectionId,y]),a.useEffect(()=>{if(!y||Ce!=="all_cards"&&F!=="new_card"){u([]);return}let d=!1;return kn({libraryId:y,limit:200}).then(Se=>{d||u(Se)}).catch(()=>{d||u([])}),()=>{d=!0}},[Ce,y,F]),a.useEffect(()=>{if(!y||!E){P([]),ge(void 0);return}let d=!1;return Ie(!0),us({libraryId:y,collectionId:E}).then(Se=>{var ut,st,bt,ft;if(d)return;P(Se);const Y=(st=(ut=w.current.byLibrary)==null?void 0:ut[y])==null?void 0:st.lastRevisionId,re=((bt=Se.find(Mt=>Mt.revisionId===l.revisionId))==null?void 0:bt.revisionId)??((ft=Se.find(Mt=>Mt.revisionId===Y))==null?void 0:ft.revisionId);ge(re)}).catch(()=>{d||(P([]),ge(void 0))}).finally(()=>{d||Ie(!1)}),()=>{d=!0}},[l.revisionId,E,y]),a.useEffect(()=>{const d=l.infoId;if(!y||!d){$(void 0);return}let Se=!1;return Qt({libraryId:y,infoId:d}).then(Y=>{if(Se)return;const re=Y.payload;$((re==null?void 0:re.label)??(re==null?void 0:re.name)??(re==null?void 0:re.title)??Y.infoId)}).catch(()=>{Se||$(d)}),()=>{Se=!0}},[l.infoId,y]),a.useEffect(()=>{if(!Z.current||l.libraryId&&v.some(re=>re.libraryId===l.libraryId)&&l.libraryId!==y||l.target&&l.target!==F||l.revisionView&&l.revisionView!==be||l.revisionId&&l.revisionId!==ce||gn[F].requiresCollection&&!E&&l.target==="all_collections"&&l.collectionId)return;const d=xa(`${x.pathname}${x.search}`);if(xa(x.pathname)==="/cogita"&&!l.libraryId&&!y){T.current=null;return}const Y=xa(ns(y,F,E,be,ce,l.infoId,l.infoView??"overview"));if(d===Y){T.current=null;return}T.current!==Y&&(T.current=Y,c(Y,{replace:!0}))},[v,x.pathname,x.search,c,l.collectionId,l.infoId,l.infoView,l.libraryId,l.revisionId,l.revisionView,l.target,E,y,ce,be,F]),a.useEffect(()=>{if(typeof window>"u")return;const d=()=>{window.innerWidth>920&&G(!1)};return window.addEventListener("resize",d),()=>window.removeEventListener("resize",d)},[]),a.useEffect(()=>{if(!Z.current||!Q||!y||de.current)return;const d=w.current,Se={...d.byLibrary??{}},Y={...Se[y]??{},lastCollectionId:E,lastRevisionId:ce,lastRevisionView:be,lastTarget:F},re={version:1,lastLibraryId:y,byLibrary:{...Se,[y]:Y}},ut=JSON.stringify(d),st=JSON.stringify(re);if(ut===st)return;w.current=re,de.current=!0,(async()=>{try{if(Ve)await tr(Ve,{plainValue:st});else{const ft=await ar(Q,{itemName:hn,itemType:"data",plainValue:st});z(ft.dataItemId)}}catch{ze(m.status.savePrefsFailed)}finally{de.current=!1}})()},[Ve,Q,E,y,ce,be,F,m.status.savePrefsFailed]);const q=async()=>{const d=_e.trim();if(!d){ze(t.cogita.user.libraryNameRequired);return}ze(null);try{const Se=await rr({name:d});S(Y=>[Se,...Y]),H(Se.libraryId),X("library_overview"),K(void 0),De("")}catch{ze(t.cogita.user.libraryCreateFailed)}},le=async()=>{if(!y){ze(m.status.selectLibraryFirst);return}const d=Ue.trim();if(!d){ze(t.cogita.library.collections.saveRequiredName);return}ze(null);try{const Se=await nr({libraryId:y,name:d,items:[]}),Y=await ja({libraryId:y,limit:200});D(Y.items),K(Se.collectionId),ge(void 0),X("all_collections"),Be("detail"),ot("")}catch{ze(t.cogita.library.collections.saveFail)}},Me=async()=>{if(!y||!E){ze(m.status.selectLibraryFirst);return}const d=tt.trim();if(!d){ze(m.revisionForm.nameLabel);return}ze(null);try{const Se=await sr({libraryId:y,collectionId:E,name:d,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});P(Y=>[Se,...Y]),ge(Se.revisionId),X("all_collections"),Be("settings"),Ae("")}catch{ze(m.status.loadFailed)}};return e.jsx(Tt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,headerExtra:y?e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:Re,onChange:d=>J(d.target.value),children:[e.jsx("option",{value:"",children:"No person"}),ke.map(d=>e.jsx("option",{value:d.roleId,children:d.label},d.roleId))]})]}):null,children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${ve?"open":""}`,"aria-label":m.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{children:(I==null?void 0:I.name)??m.path.noLibrarySelected}),e.jsx("p",{className:"cogita-sidebar-note",children:I?m.sidebar.libraryActionsHint:m.status.selectLibraryFirst}),pt(Et,"sidebar")]}),$t?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:m.sidebar.infoActionsHint}),pt($t,"sidebar"),Qe?e.jsxs("div",{className:"cogita-sidebar-actions-nested",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(pe==null?void 0:pe.label)??ye??t.cogita.library.list.selectedEmpty}),e.jsx("p",{className:"cogita-sidebar-note",children:m.sidebar.selectedInfoActionsHint}),pt(Qe,"sidebar")]}):null]}):null,O?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:O.name}),e.jsx("p",{className:"cogita-sidebar-note",children:m.sidebar.collectionActionsHint}),pt(ht,"sidebar")]}):null,e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:m.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:r,children:m.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{f("cogita"),G(!1)},children:m.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:i,children:h?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),ve?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":m.sidebar.closeMenu,onClick:()=>G(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":m.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>G(d=>!d),"aria-label":ve?m.sidebar.closeMenu:m.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),Xe.map((d,Se)=>e.jsxs("div",{className:"cogita-browser-segment",children:[Se>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,d.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":d.label,children:d.selectedLabel}):e.jsxs("select",{"aria-label":d.label,value:d.value,onChange:Y=>d.onSelect(Y.target.value),disabled:d.disabled,children:[d.emptyOption?e.jsx("option",{value:"",children:d.emptyOption}):null,d.options.map(Y=>e.jsx("option",{value:Y.value,children:Y.label},`${d.key}:${Y.value}`))]})]},`menu:${d.key}`))]}),jt?e.jsxs(e.Fragment,{children:[F==="new_collection"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.library.actions.createCollection}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{type:"text",value:Ue,onChange:d=>ot(d.target.value),placeholder:t.cogita.library.collections.namePlaceholder,disabled:!y})]}),e.jsx("button",{type:"button",className:"cta",onClick:le,disabled:!y,children:t.cogita.library.actions.createCollection}),Ee?e.jsx("p",{className:"cogita-form-error",children:Ee}):null]}):null,F==="all_collections"&&E&&be==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:m.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:m.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:tt,onChange:d=>Ae(d.target.value),placeholder:m.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Me,children:m.revisionForm.createAction}),Ee?e.jsx("p",{className:"cogita-form-error",children:Ee}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(xs.Provider,{value:!0,children:jt})})]}):null,jt?null:e.jsx(e.Fragment,{children:y?null:e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:Ge.step}),e.jsx("h2",{children:Ge.title})]}),e.jsxs("p",{children:[We+1," / ",yt]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:Ge.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:Ge.passages.map(d=>e.jsx("p",{children:d},d))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:Ge.focus.map(d=>e.jsx("span",{children:d},d))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:Ge.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:ct.map((d,Se)=>e.jsx("button",{type:"button",className:`ghost ${Se===We?"active":""}`,onClick:()=>qe(Se),"aria-label":`${Se+1}`,children:Se+1},`tutorial:${d.title}:${Se}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:We===0,onClick:()=>qe(d=>Math.max(0,d-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:We===yt-1,onClick:()=>qe(d=>Math.min(yt-1,d+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:_e,onChange:d=>De(d.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:q,children:t.cogita.user.createLibraryAction}),Ee?e.jsx("p",{className:"cogita-form-error",children:Ee}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),v.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,v.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:v.map(d=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{rt({libraryId:d.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:d.name})]},d.libraryId))}):null]})]})]})})]})]})})}const ki=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:bi},Symbol.toStringTag,{value:"Module"}));function yi({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,shareId:c}){const[x,l]=a.useState(null),[m,v]=a.useState("loading"),[S,L]=a.useState(t.cogita.library.collections.defaultName),[D,p]=a.useState("Cogita Library"),[u,ue]=a.useState([]),[P,y]=a.useState([]),[H,F]=a.useState("idle"),[X,E]=a.useState({current:0,total:0}),[K,ce]=a.useState(0),[ge,be]=a.useState(""),[Be,ye]=a.useState(null),[$,ve]=a.useState(null),[G,ee]=a.useState(null),[Le,oe]=a.useState(null),[te,Te]=a.useState([]),[Ie,Ee]=a.useState({}),[ze,$e]=a.useState({}),[qe,_e]=a.useState(null),[De,Ue]=a.useState(null),[ot,tt]=a.useState(null),[Ae,ke]=a.useState(null),[U,Re]=a.useState({}),J=a.useRef(0),[Q,Ne]=a.useState(null),Ve=a.useRef(null),z=a.useRef(null),[w,Z]=a.useState(null),[de,T]=a.useState(!1),[I,O]=a.useState(null),[ae,ne]=a.useState([]),[we,Ce]=a.useState(null),Ke=a.useRef(null),ie=a.useRef(null),[pe,he]=a.useState(null),[at,Je]=a.useState(0),Ye=a.useRef(null),ct=a.useRef({}),[yt,We]=a.useState(!1),[Ge,Ct]=a.useState({}),dt=a.useRef(null),It=a.useRef(new Set),lt=a.useRef({}),[rt,Lt]=a.useState([]),[xt,Xe]=a.useState(new Set),[et,Et]=a.useState(!1),$t=Oa(),Qe=a.useMemo(()=>new URLSearchParams($t.search),[$t.search]),ht=a.useMemo(()=>Qe.get("key")??"",[Qe]),pt=(x==null?void 0:x.mode)??"random",jt=(x==null?void 0:x.check)??"exact",q=(x==null?void 0:x.limit)??20,le=a.useMemo(()=>Ln((x==null?void 0:x.revisionType)??pt),[x,pt]),Me=a.useMemo(()=>{const A=x==null?void 0:x.revisionSettings,W=ks(le,Qe);return Ha(le,A??W)},[x,Qe,le]),d=a.useMemo(()=>t.cogita.library.revision[le.labelKey]??pt,[t,pt,le]),Se=a.useMemo(()=>jt==="exact"?t.cogita.library.revision.checkValue:jt,[t,jt]),re=m==="ready"?u[K]??null:null,ut=(re==null?void 0:re.checkType)==="translation-match"&&Ae,st=a.useRef(new Map),bt=a.useRef(new Map),ft=a.useRef(new Map),Mt=a.useRef(new Map),ra=a.useMemo(()=>re?re.cardType==="vocab"?t.cogita.library.revision.vocabLabel:re.infoType?He(t,re.infoType):t.cogita.library.revision.infoLabel:"",[t,re]),Gt=a.useMemo(()=>{var W;return le.id!=="levels"?u.length:((W=Ge.pool)==null?void 0:W.length)??le.getFetchLimit(q,Me)},[Ge,Me,le,u.length,q]),Dt=le.getProgressTotal?le.getProgressTotal(u,Ge,q,Me):le.id==="levels"?Math.min(q,Gt):u.length,vt=Dt?Math.min(K+1,Dt):0,wt=Math.max(1,Number(Me.tries??1)),Ht=Me.compare??"anchors",nt=Math.max(0,Math.min(100,Number(Me.minCorrectness??0))),it=(Me.considerDependencies??"on")==="on",Kt=Math.max(0,Math.min(100,Number(Me.dependencyThreshold??85))),ga=A=>{const W=A.slice();for(let o=W.length-1;o>0;o-=1){const b=Math.floor(Math.random()*(o+1));[W[o],W[b]]=[W[b],W[o]]}return W},pa=A=>Zt(A,{treatSimilarCharsAsSame:!0})>=nt,Wa=async()=>{const A=await Ut(),W=new Map,o=new Map;A.forEach(k=>{const V=`${k.itemType}:${k.itemId}`,j=Ot(k.itemType,k.itemId,k.checkType,k.direction);W.has(V)||W.set(V,[]),W.get(V).push(k),o.has(j)||o.set(j,[]),o.get(j).push(k)});const b=new Map,N=new Map;return W.forEach((k,V)=>b.set(V,qt(k).score)),o.forEach((k,V)=>N.set(V,qt(k).score)),{itemKnowness:b,cardKnowness:N}},fa=async A=>{const W=Ge,o=A.concat(W.active??[]).concat(W.pool??[]).filter((_,se,me)=>me.findIndex(xe=>fe(xe)===fe(_))===se);if(!it){Xe(new Set(o.map(fe)));return}const{itemKnowness:b,cardKnowness:N}=await Wa(),k=_=>{if(_.cardType!=="info"||_.infoType!=="citation"||_.checkType!=="quote-fragment")return!0;const se=Rt(_.direction);if(!(se!=null&&se.fragmentId))return!0;const me=_.description??"";if(!me.trim())return!0;const je=sa(me).nodes[se.fragmentId];if(!je||!je.leftId&&!je.rightId)return!0;const Pe=[je.leftId,je.rightId].filter(Ze=>!!Ze);if(Pe.length===0)return!0;const Fe=Pe.map(Ze=>{const mt=Ot("info",_.cardId,"quote-fragment",Ze);return N.get(mt)??0});return Fe.reduce((Ze,mt)=>Ze+mt,0)/Fe.length>=Kt},V=(x==null?void 0:x.collectionId)??null,j=V?rt.filter(_=>gt(_.childItemType)==="collection"&&_.childItemId===V&&!gt(_.childCheckType)&&!gt(_.childDirection)):[],B=V&&o.length>0?o.reduce((_,se)=>_+(N.get(fe(se))??0),0)/o.length:0,R=new Set;for(const _ of o){if(_.cardType!=="info"){R.add(fe(_));continue}if(!k(_))continue;const se=rt.filter(je=>Is(je,_)).concat(j);if(se.length===0){R.add(fe(_));continue}let me=0;for(const je of se)if(gt(je.parentItemType)==="collection")me+=je.parentItemId===V?B:0;else if(gt(je.parentCheckType)||gt(je.parentDirection)){const Pe=gt(je.parentCheckType),Fe=gt(je.parentDirection),Oe=Ot(je.parentItemType,je.parentItemId,Pe,Fe);me+=N.get(Oe)??0}else{const Pe=`${je.parentItemType}:${je.parentItemId}`;me+=b.get(Pe)??0}me/se.length>=Kt&&R.add(fe(_))}Xe(R)},Ga=A=>{for(let W=A;W<u.length;W+=1){const o=u[W];if(o&&(!it||o.cardType!=="info"||xt.has(fe(o))))return W}return-1},ia=A=>!it||A.cardType!=="info"||xt.has(fe(A)),Ya=A=>{if(le.id!=="temporal"&&le.id!=="levels")return null;const W=Ge,o=(W.active??[]).concat(W.pool??[]),b=new Set;for(const N of o){const k=fe(N);if(!(b.has(k)||A.has(k))&&(b.add(k),ia(N)))return N}return null},At=a.useMemo(()=>{if(le.id!=="levels")return null;const A=Ge,W=A.pool??[],o=A.active??[],b=A.levelMap??{},N=Math.max(1,Number(Me.levels??1)),k=Array.from({length:N},()=>0),V=new Set(o.map(_=>fe(_)));W.forEach(_=>{const se=Math.min(N,Math.max(1,b[fe(_)]??1));k[se-1]+=1});const j=W.length||1,B=k.map(_=>_/j*100),R=re?b[fe(re)]??1:null;return{counts:k,percentages:B,currentLevel:R,levelsCount:N,activeCount:o.length,poolCount:W.length,activeSet:V}},[Ge,Me,le,re]),oa=a.useMemo(()=>{if(le.id!=="temporal")return null;const A=Ge,W=A.pool??[],o=A.active??[],b=A.knownessMap??{},N=new Set(A.unknownSet??[]);let k=0;W.forEach(B=>{(b[fe(B)]??0)>1&&(k+=1)});const V=N.size,j=o.map(B=>({id:fe(B),value:N.has(fe(B))?0:Math.max(0,Math.min(1,b[fe(B)]??0))}));return{knownCount:k,unknownCount:V,dots:j}},[Ge,le]),Ft=a.useMemo(()=>{if(!it)return 0;const A=Ge;return u.concat(A.active??[]).concat(A.pool??[]).filter((o,b,N)=>N.findIndex(k=>fe(k)===fe(o))===b).filter(o=>o.cardType==="info"&&!xt.has(fe(o))).length},[it,Ge,u,xt]);a.useEffect(()=>{if(!it||H!=="ready")return;const A=Ge,o=u.concat(A.active??[]).concat(A.pool??[]).filter((k,V,j)=>j.findIndex(B=>fe(B)===fe(k))===V).filter(k=>k.cardType!=="info"||xt.has(fe(k))).length,b=Ke.current;if(Ke.current=o,b===null||o<=b)return;const N=o-b;Ce(`New card available (+${N})`),ie.current&&window.clearTimeout(ie.current),ie.current=window.setTimeout(()=>Ce(null),2200)},[it,H,Ge,u,xt]),a.useEffect(()=>()=>{ie.current&&window.clearTimeout(ie.current)},[]);const kt=(A,W)=>{const o=le.applyOutcome({queue:u,meta:Ge},re,q,Me,{correct:A,correctness:W,createdUtc:new Date().toISOString()});ue(o.queue),Ct(o.meta);const b=o.queue[K+1];b&&Pt(b,K+1)};a.useEffect(()=>{if(!c){v("error");return}v("loading"),ir({shareId:c,key:ht}).then(A=>{l(A),L(A.collectionName),p(A.libraryName),v("ready")}).catch(()=>{v("error")})},[c,ht]),a.useEffect(()=>{c&&or({shareId:c,key:ht,type:"language"}).then(A=>y(A)).catch(()=>y([]))},[c,ht]),a.useEffect(()=>{!c||m!=="ready"||lr({shareId:c,key:ht}).then(A=>Lt(A.items??[])).catch(()=>Lt([]))},[c,ht,m]),a.useEffect(()=>{if(!c||m!=="ready")return;let A=!0;return(async()=>{F("loading"),E({current:0,total:le.id==="levels"?0:le.getFetchLimit(q,Me)});try{const o=[];let b=null,N=null;do{const se=await cr({shareId:c,key:ht,limit:300,cursor:b});if(o.push(...se.items),(le.id==="levels"||le.id==="temporal")&&se.total&&(N=se.total),E(me=>({current:o.length,total:me.total||se.total||le.getFetchLimit(q,Me)})),b=se.nextCursor??null,N!==null&&o.length>=N||le.id!=="levels"&&le.id!=="temporal"&&o.length>=le.getFetchLimit(q,Me))break}while(b);if(!A)return;const k=yn(o);let V;if(le.id==="levels"){const se=Math.max(1,Number(Me.levels??1));V={},k.forEach(me=>{const xe=fe(me);V[xe]=Math.max(1,Math.min(se,1))})}let j=null,B=null,R=null;if(le.id==="temporal"){const se=await Ut(),me=new Set(k.map(Pe=>fe(Pe))),xe=se.reduce((Pe,Fe)=>{const Oe=Ot(Fe.itemType,Fe.itemId,Fe.checkType,Fe.direction);return me.has(Oe)&&(Pe[Oe]||(Pe[Oe]=[]),Pe[Oe].push(Fe)),Pe},{});j={},B=new Set,R={};const je=Date.now();k.forEach(Pe=>{const Fe=fe(Pe),Oe=xe[Fe]??[];if(Oe.length===0){j[Fe]=0,B.add(Fe),R[Fe]=[];return}const Ze=Cn(Oe);R[Fe]=Ze;const mt=Ua(Ze,je);j[Fe]=mt.knowness})}const _=le.id==="levels"?In(k,q,Me,V):le.id==="temporal"?Mn(k,q,Me,j??{},B??new Set,R??{}):le.prepare(k,q,Me);ue(_.queue),Ct(_.meta),ce(0),F("ready"),E(se=>({current:Math.min(se.current,se.total),total:se.total}))}catch{A&&F("error")}})(),()=>{A=!1}},[c,ht,q,le,Me,m]),a.useEffect(()=>{fa(u)},[u,rt,it,Kt,x==null?void 0:x.collectionId]),a.useEffect(()=>{if(!re||!it){Et(!1);return}if(re.cardType!=="info"||xt.has(fe(re))){Et(!1);return}const A=Ga(K+1);if(A>=0){Et(!1),ce(A);return}if(le.id==="temporal"||le.id==="levels"){const W=u.slice(0,K+1),o=u.slice(K+1).filter(ia),b=W.concat(o),N=new Set(b.map(fe)),k=Ya(N);if(k){const j=fe(k);N.has(j)||(b.push(k),N.add(j),Ct(B=>{const R=B,_=new Set(R.queued??[]);return _.add(j),{...R,queued:_}}))}const V=b.findIndex((j,B)=>B!==K&&ia(j));if(V>=0){ue(b),ce(V),Et(!1);return}}Et(!0)},[re,xt,it,K,u,Ge,le.id]),a.useEffect(()=>{if(be(""),ye(null),he(null),Je(0),Te([]),Ee({}),$e({}),_e(null),Ue(null),tt(null),T(!1),We(!1),Z(null),ke(null),Re({}),!re){ve(null),ee(null);return}re.cardType==="info"&&re.infoType==="computed"&&ve(t.cogita.library.revision.loadingComputed);let A=!0;return Pt(re,K).then(W=>{!A||!W||(ve(W.prompt),ee(W.expectedAnswer),Te(W.computedExpected),Ee(W.computedAnswers),_e(W.answerTemplate),Ue(W.outputVariables),tt(W.variableValues))}),()=>{A=!1}},[re,c,t]),a.useEffect(()=>{if(!re||re.cardType!=="info"||re.infoType!=="citation"){dt.current=null,It.current=new Set,oe(null);return}const A=re.description??"",W=(re.label??"").trim(),o=W.replace(/\s+/g," ").trim(),b=A.replace(/\s+/g," ").trim(),N=o&&o!==b?W:t.cogita.library.infoTypes.citation;if(!A){oe(null),ee(null);return}const k=sa(A);dt.current=k,ve(N);let V=!0;return Ut().then(j=>{if(!V)return;const B=new Map;j.forEach(xe=>{if(xe.itemType!=="info"||xe.checkType!=="quote-fragment"||!xe.direction)return;const je=Rt(xe.direction);if(!je)return;const Pe=`${xe.itemId}:${je.fragmentId}`;B.has(Pe)||B.set(Pe,[]),B.get(Pe).push(xe)});const R={},_=new Set;B.forEach((xe,je)=>{const[Pe,Fe]=je.split(":",2);if(Pe!==re.cardId)return;const Oe=qt(xe).score;R[Fe]=Oe,Oe>=Kt&&_.add(Fe)}),It.current=_,lt.current=R;const se=Rt(re.direction);if(se!=null&&se.fragmentId&&k.nodes[se.fragmentId]){ta(k,se.fragmentId,N);return}const me=ha(k,_,R,Kt,it,re.direction);ta(k,(me==null?void 0:me.id)??null,N)}).catch(()=>{It.current=new Set,lt.current={};const j=Rt(re.direction);if(j!=null&&j.fragmentId&&k.nodes[j.fragmentId]){ta(k,j.fragmentId,N);return}const B=ha(k,It.current,{},Kt,it,re.direction);ta(k,(B==null?void 0:B.id)??null,N)}),()=>{V=!1}},[re,t,it,Kt]),a.useEffect(()=>{if(!re||re.cardType!=="vocab"||re.checkType!=="translation-match"){ke(null),Re({});return}const o=(Ge.pool??Ge.active??u).filter(j=>j.cardType==="vocab"&&j.checkType==="translation-match").filter((j,B,R)=>R.findIndex(_=>_.cardId===j.cardId)===B);o.some(j=>j.cardId===re.cardId)||o.unshift(re);const N=ga(o).slice(0,6).map(j=>{const B=j.label.split("↔").map(se=>se.trim()).filter(Boolean);if(B.length<2)return null;const R=`${j.cardId}:L`,_=`${j.cardId}:R`;return{cardId:j.cardId,leftId:R,rightId:_,leftLabel:B[0],rightLabel:B[1]}}).filter(Boolean),k=N.map(j=>j.leftId),V=ga(N.map(j=>j.rightId));ke({pairs:N,leftOrder:k,rightOrder:V,selection:{},activeLeft:null,activeRight:null,locked:{}})},[re,u,Ge]),a.useEffect(()=>()=>{Ve.current&&window.clearTimeout(Ve.current),z.current&&window.clearTimeout(z.current)},[]);const la=a.useRef(null);a.useEffect(()=>{if(!re)return;const A=fe(re),W=typeof document<"u"?document.activeElement:null;if(la.current===A&&W&&(W.tagName==="INPUT"||W.tagName==="TEXTAREA"))return;let o=0;const b=()=>{if(re){if(re.cardType==="info"&&re.infoType==="computed"){if(te.length>0){const k=Va(qe,te,De),V=k?ct.current[k]:null;if(V&&(V.focus(),document.activeElement===V)){la.current=A;return}}if(Ye.current&&(Ye.current.focus(),document.activeElement===Ye.current)){la.current=A;return}}else if(re.cardType==="vocab"&&Ye.current&&(Ye.current.focus(),document.activeElement===Ye.current)){la.current=A;return}o<6&&(o+=1,window.setTimeout(b,40))}},N=window.setTimeout(b,40);return()=>window.clearTimeout(N)},[re,te,qe,De]),a.useEffect(()=>{if(!yt)return;const A=W=>{W.key==="Enter"&&(W.preventDefault(),ca())};return window.addEventListener("keydown",A),()=>window.removeEventListener("keydown",A)},[yt]);const Nt=A=>{ne(A),O(qt(A))};a.useEffect(()=>{if(!re){O(null),ne([]);return}const A=re.cardType==="info"?"info":"connection";if(re.cardType==="info"&&re.infoType==="citation"){Ut().then(W=>{const o=W.filter(b=>b.itemType==="info"&&b.itemId===re.cardId&&b.checkType==="quote-fragment"&&Ba(b.direction,re.direction));Nt(o)}).catch(()=>{O(null),ne([])});return}Da(A,re.cardId,re.checkType,re.direction).then(W=>Nt(W)).catch(()=>{O(null),ne([])})},[re]);const Xt=(A,W,o,b)=>{if(A==="info"&&o==="quote-fragment"){Ut().then(N=>{const k=N.filter(V=>V.itemType==="info"&&V.itemId===W&&V.checkType==="quote-fragment"&&Ba(V.direction,b));Nt(k)}).catch(()=>{O(null),ne([])});return}Da(A,W,o,b).then(N=>Nt(N)).catch(()=>{O(null),ne([])})},ea=(A,W,o)=>{var V;const b=((V=o.pairs.find(j=>j.leftId===A))==null?void 0:V.rightId)??null;if(!b)return o;const N=b===W;Re(j=>({...j,[A]:N?"correct":"incorrect"})),Ve.current&&window.clearTimeout(Ve.current),z.current&&window.clearTimeout(z.current),J.current+=1;const k={kind:N?"correct":"incorrect",tick:J.current};if(Ne(null),Ve.current=window.setTimeout(()=>Ne(k),0),z.current=window.setTimeout(()=>Ne(null),420),N){const j={...o.locked,[A]:!0};return Object.keys(j).length>=o.pairs.length?(ye("correct"),We(!0)):ye("correct"),{...o,selection:{...o.selection,[A]:W},activeLeft:null,activeRight:null,locked:j}}return ye("incorrect"),{...o,activeLeft:null,activeRight:null}},Sa=A=>{ke(W=>!W||W.locked[A]?W:W.activeRight?ea(A,W.activeRight,W):{...W,activeLeft:W.activeLeft===A?null:A})},Ta=A=>{ke(W=>W&&(W.activeLeft?ea(W.activeLeft,A,W):{...W,activeRight:W.activeRight===A?null:A}))},ca=()=>{var A;if(re&&re.cardType==="info"&&re.infoType==="citation"&&dt.current&&Le&&!((A=Rt(re.direction))!=null&&A.fragmentId)){const W=ha(dt.current,It.current,lt.current,Kt,it,re.direction,Le.fragmentId);if(W){ye(null),be(""),T(!1),$e({}),We(!1),he(null),Je(0),ta(dt.current,W.id,Le.title);return}}ye(null),be(""),T(!1),$e({}),We(!1),he(null),Je(0),ce(W=>Math.min(W+1,u.length))},zt=A=>{if(!re)return;const W=A.expected??null,o=A.answer??"";let b=W??"",N=o;if(!W&&A.expectedMap&&A.answerMap){const se=Object.keys(A.expectedMap).sort((me,xe)=>me.localeCompare(xe));b=se.map(me=>{var xe;return((xe=A.expectedMap)==null?void 0:xe[me])??""}).join("|"),N=se.map(me=>{var xe;return((xe=A.answerMap)==null?void 0:xe[me])??""}).join("|")}const k=b?ma(b,N,Ht):new Uint8Array,V={revisionType:le.id,evalType:A.evalType,direction:A.direction,prompt:$??"",expected:W,answer:o,expectedAnswers:A.expectedMap??null,answers:A.answerMap??null,correct:A.correct,maskBase64:k.length?Yt(k):null,checkMode:jt,compareMode:Ht,minCorrectness:nt},j=new TextEncoder().encode(JSON.stringify(V)),B=re.cardType==="info"?"info":"connection",R=A.overrideCheckType??re.checkType??null,_=A.overrideDirection??re.direction??null;za({itemType:B,itemId:re.cardId,checkType:R,direction:_,revisionType:le.id,evalType:A.evalType,correct:A.correct,maskBase64:k.length?Yt(k):null,payloadBase64:Yt(j)}).then(()=>{Xt(B,re.cardId,R,_),fa(u)}).catch(()=>{})},da=(A,W)=>{const o=st.current.get(W);if(o)return Promise.resolve(o);const b=bt.current.get(W);if(b)return b;const N=dr({shareCode:c,infoId:A,key:ht}).then(k=>{var se,me;const V=k.payload,j=((se=V.definition)==null?void 0:se.graph)??null,B="",R=((me=V.definition)==null?void 0:me.answerTemplate)??"",_=Ns(j,B,R);if(_){const je={sample:Ss(_),answerTemplate:R||null};return st.current.set(W,je),je}return An({shareId:c,infoId:A,key:ht}).then(xe=>{const je={sample:xe,answerTemplate:null};return st.current.set(W,je),je})}).catch(()=>An({shareId:c,infoId:A,key:ht}).then(k=>{const V={sample:k,answerTemplate:null};return st.current.set(W,V),V}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{bt.current.delete(W)});return bt.current.set(W,N),N},Pt=(A,W)=>{var j;const o=`${fe(A)}:${W}`,b=ft.current.get(o);if(b)return Promise.resolve(b);const N=Mt.current.get(o);if(N)return N;const k=B=>(ft.current.set(o,B),B);let V;if(A.cardType==="vocab"){if(A.checkType==="translation-match")return V=Promise.resolve(k({prompt:A.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),V;const B=A.label.split("↔").map(R=>R.trim()).filter(Boolean);if(B.length>=2){const _=(A.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",se=_?B[0]:B[1],me=_?B[1]:B[0];V=Promise.resolve(k({prompt:se,expectedAnswer:me,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else V=Promise.resolve(k({prompt:A.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(A.cardType==="info"&&A.infoType==="word"){const B=(j=A.description)!=null&&j.startsWith("Language: ")?A.description.replace("Language: ",""):null;V=Promise.resolve(k({prompt:A.label,expectedAnswer:B,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else A.cardType==="info"&&A.infoType==="computed"?V=da(A.cardId,o).then(B=>{var xe,je;if(!B.sample)return k({prompt:A.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const R=B.sample,_=R.expectedAnswers?Object.entries(R.expectedAnswers).map(([Pe,Fe])=>({key:Pe,expected:Fe})):[],se=_.reduce((Pe,Fe)=>(Pe[Fe.key]="",Pe),{}),me=R.expectedAnswerIsSentence&&((xe=R.expectedAnswer)==null?void 0:xe.trim())||null;return k({prompt:R.prompt,expectedAnswer:_.length>0?me:((je=R.expectedAnswer)==null?void 0:je.trim())||null,computedExpected:_,computedAnswers:se,answerTemplate:B.answerTemplate,outputVariables:R.outputVariables??null,variableValues:R.variableValues??null})}).catch(()=>k({prompt:A.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Mt.current.delete(o)}):V=Promise.resolve(k({prompt:A.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return Mt.current.set(o,V),V},ta=(A,W,o)=>{const b=Object.keys(A.nodes).length,N=It.current.size;if(!W){oe({title:o,before:A.text,after:"",fragmentId:null,total:b,completed:N}),ee(null),We(!0);return}const k=A.nodes[W];if(!k)return;const V=Nn(A.text,k);oe({title:o,before:V.before,after:V.after,fragmentId:k.id,total:b,completed:N}),ee(V.fragment),We(!1)},ba=()=>{const A=dt.current;A&&oe(W=>W&&{...W,total:Object.keys(A.nodes).length,completed:It.current.size})},Bt=()=>{const A=u[K+1];A&&Pt(A,K+1)},Ca=()=>{if(Bt(),re&&re.cardType==="vocab"&&re.checkType==="translation-match"&&Ae){if(Ae.pairs.length===0){ye("incorrect"),We(!0);return}const k=Ae.pairs.reduce((me,xe)=>(me[xe.rightId]=xe.rightLabel,me),{});let V=0;const j={};Ae.pairs.forEach(me=>{const je=Ae.selection[me.leftId]===me.rightId;j[me.leftId]=je?"correct":"incorrect",je&&(V+=1)});const B=Ae.pairs.length||1,R=V/B,_=V===Ae.pairs.length;Re(me=>({...me,...j})),_?(ye("correct"),We(!0),Je(0)):(ye("incorrect"),We(!1),Je(me=>{const xe=me+1;return xe>=wt&&(T(!0),We(!0),ke(je=>{if(!je)return je;const Pe=je.pairs.reduce((Fe,Oe)=>(Fe[Oe.leftId]=Oe.rightId,Fe),{});return{...je,selection:Pe}})),xe})),kt(_,R);const se="connection";Promise.all(Ae.pairs.map(me=>{const xe=Ae.selection[me.leftId]??null,je=xe?k[xe]:"",Pe={left:me.leftLabel,expected:me.rightLabel,answer:je,checkType:"translation-match"},Fe=new TextEncoder().encode(JSON.stringify(Pe));return za({itemType:se,itemId:me.cardId,checkType:"translation-match",direction:null,revisionType:le.id,evalType:"translation-match",correct:xe===me.rightId,maskBase64:null,payloadBase64:Yt(Fe)})})).then(()=>{Xt(se,re.cardId,re.checkType,re.direction),fa(u)}).catch(()=>{});return}if(te.length>0){const k=te.reduce((j,B)=>{const R=Ie[B.key]??"";return j[B.key]=St(R)===St(B.expected)?"correct":"incorrect",j},{});te.every(({key:j,expected:B})=>{const R=Ie[j]??"";return jt==="exact"&&St(R)===St(B)})?(ye("correct"),$e(k),We(!0),Je(0),kt(!0,1),zt({correct:!0,direction:$?`${$} -> computed`:"computed",expectedMap:te.reduce((j,B)=>(j[B.key]=B.expected,j),{}),answerMap:Ie,evalType:"computed"})):(ye("incorrect"),$e(k),We(!1),Je(j=>{const B=j+1;return B>=wt&&aa&&(T(!0),We(!0)),B}),kt(!1,0),window.setTimeout(()=>{var B;const j=Va(qe,te,De);j&&ct.current[j]&&((B=ct.current[j])==null||B.focus())},40),zt({correct:!1,direction:$?`${$} -> computed`:"computed",expectedMap:te.reduce((j,B)=>(j[B.key]=B.expected,j),{}),answerMap:Ie,evalType:"computed"}));return}if(re&&re.cardType==="info"&&re.infoType==="citation"&&(Le!=null&&Le.fragmentId)){if(!G)return;const k=Rt(re.direction),V=(k==null?void 0:k.fragmentId)??Le.fragmentId,j=Ka(G,ge,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),B=j.mask,R=j.isCorrect,_=j.percent;R?(lt.current[Le.fragmentId]=Math.max(lt.current[Le.fragmentId]??0,_),(lt.current[Le.fragmentId]??0)>=Kt&&It.current.add(Le.fragmentId),ba(),ye("correct"),$e({}),We(!0),he(B),Je(0),_<100&&wt<=1&&T(!0),kt(!0,_/100),zt({correct:!0,direction:`quote:${Le.fragmentId}`,expected:G,answer:ge,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:V})):(ye("incorrect"),$e({}),We(!1),he(B),Je(se=>{const me=se+1;return me>=wt&&aa&&(T(!0),We(!0)),me}),kt(!1,_/100),window.setTimeout(()=>{var se;return(se=Ye.current)==null?void 0:se.focus()},40),zt({correct:!1,direction:`quote:${Le.fragmentId}`,expected:G,answer:ge,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:V}));return}if(!G)return;const A=ma(G,ge,Ht),W=jt==="exact"&&St(ge)===St(G),o=pa(A),b=W||o,N=Zt(A);b?(ye("correct"),$e({}),We(!0),he(A),Je(0),N<100&&wt<=1&&T(!0),kt(!0,N/100),zt({correct:!0,direction:$?`${$} -> ${G}`:null,expected:G,answer:ge,evalType:"text"})):(ye("incorrect"),$e({}),We(!1),he(A),Je(k=>{const V=k+1;return V>=wt&&aa&&(T(!0),We(!0)),V}),kt(!1,N/100),window.setTimeout(()=>{var k;return(k=Ye.current)==null?void 0:k.focus()},40),zt({correct:!1,direction:$?`${$} -> ${G}`:null,expected:G,answer:ge,evalType:"text"}))},ua=A=>{if(Bt(),!G)return;const W=ma(G,A,Ht),o=St(A)===St(G),b=pa(W),N=o||b,k=Zt(W);N?(ye("correct"),$e({}),We(!0),he(W),Je(0),k<100&&wt<=1&&T(!0),kt(!0,k/100),zt({correct:!0,direction:"word->language",expected:G,answer:A,evalType:"language-select"})):(ye("incorrect"),$e({}),We(!1),he(W),Je(V=>{const j=V+1;return j>=wt&&aa&&(T(!0),We(!0)),j}),kt(!1,k/100),zt({correct:!1,direction:"word->language",expected:G,answer:A,evalType:"language-select"}))},Ma=A=>{var o;if(A.key!=="Enter")return;if(A.preventDefault(),A.stopPropagation(),yt){ca();return}const W=te.find(b=>!(Ie[b.key]??"").trim());if(W){(o=ct.current[W.key])==null||o.focus();return}Ca()},Qa=()=>{Bt(),ye("correct"),We(!0),Je(0),kt(!0,1),G&&zt({correct:!0,direction:"manual",expected:G,answer:ge,evalType:"manual"})},Za=()=>{if(kt(!1,0),re&&re.cardType==="info"&&re.infoType==="citation"){ye(null),be(""),T(!1),$e({}),We(!1),he(null),Je(0),ce(A=>Math.min(A+1,u.length));return}ca()};a.useEffect(()=>{Bt()},[K,u]);const Xa=t.cogita.library.revision.revealModeAfterIncorrect,aa=te.length>0||!!G;return e.jsxs(Tt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:g,secureMode:h,onNavigate:f,language:C,onLanguageChange:M,children:[(m==="loading"||H==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:m==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${X.total?Math.min(100,Math.max(0,X.current/X.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:X.total?`${Math.min(X.current,X.total)} / ${X.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:S}),e.jsx("p",{className:"cogita-library-subtitle",children:D}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",d).replace("{check}",Se)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:I?`${I.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[At?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",At.currentLevel??"-"," / ",At.levelsCount]}):null,I?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(I.correct)).replace("{total}",String(I.total))}),I.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(I.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(Ts,{outcomes:ae})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[we?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:we})}):null,e.jsx(Sn,{feedbackToken:Q?`${Q.kind}-${Q.tick}`:ut?"idle":Be??"idle",children:m!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:m==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):re?e.jsx(e.Fragment,{children:et?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(Tn,{copy:t,currentCard:re,currentTypeLabel:ra,prompt:$,languages:P,answer:ge,onAnswerChange:A=>be(W=>_a(W,A,w)),computedExpected:te,computedAnswers:Ie,onComputedAnswerChange:(A,W)=>Ee(o=>({...o,[A]:_a(o[A]??"",W,w)})),answerTemplate:qe,outputVariables:De,variableValues:ot,computedFieldFeedback:ze,feedback:Be,canAdvance:yt,quoteContext:Le,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Ca,onSkip:Za,onLanguageSelect:ua,onMarkReviewed:Qa,onAdvance:ca,showCorrectAnswer:de,setShowCorrectAnswer:T,onRevealCorrect:()=>We(!0),answerMask:pe,expectedAnswer:G,hasExpectedAnswer:aa,handleComputedKeyDown:Ma,answerInputRef:Ye,computedInputRefs:ct,scriptMode:w,setScriptMode:Z,matchPairs:Ae==null?void 0:Ae.pairs,matchLeftOrder:Ae==null?void 0:Ae.leftOrder,matchRightOrder:Ae==null?void 0:Ae.rightOrder,matchSelection:Ae==null?void 0:Ae.selection,matchActiveLeft:Ae==null?void 0:Ae.activeLeft,matchActiveRight:Ae==null?void 0:Ae.activeRight,matchFeedback:U,onMatchLeftSelect:Sa,onMatchRightSelect:Ta})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Dt?`${vt} / ${Dt}`:t.cogita.library.revision.progressUnlimited}),m==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),m==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),m==="ready"&&H==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),m==="ready"&&H==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),m==="ready"&&H==="ready"&&u.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Xa}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",wt]})]})]}),At?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",At.activeCount," / ",At.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:At.counts.map((A,W)=>{const o=W+1,b=At.currentLevel===o,N=At.percentages[W]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":b,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:o}),e.jsx("strong",{children:A})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,N))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[N.toFixed(1),"%"]})]},`level-${o}`)})})]}):null,oa?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:oa.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:oa.dots.map(A=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-A.value))}, ${Math.round(200*A.value)}, 80, 0.9)`}},A.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:oa.knownCount})]})]}):null,it?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Ft})]})}):null]})]})]})})})]})]})}const Ni=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:yi},Symbol.toStringTag,{value:"Module"}));export{ji as C,ki as a,Ni as b};
