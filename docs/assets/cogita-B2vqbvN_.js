import{r as n,j as e,u as nn,a as Oa,b as hs,c as ms,d as gs,R as Mn,B as Ln,C as An,Q as dr}from"./vendor-CAC2WLor.js";import{L as ur,A as hr,g as mr,a as Er,b as en,c as ps,s as Cs,d as fs,e as Fr,f as On,h as aa,i as Kr,j as _r,k as bn,l as yn,m as gr,n as bs,o as os,p as Dr,u as Is,q as ys,r as Br,t as zr,v as qr,w as Vr,x as Or,y as pr,z as Ur,B as fr,C as br,D as Jr,E as Qr,F as Rn,G as tn,H as Hr,I as yr,J as Wr,K as xs,M as xr,N as Gr,O as Yr,P as Xr,Q as Zr,R as ls,S as ja,T as ei,U as ti,V as ai,W as ni,X as si,Y as ri,Z as ii,_ as oi,$ as li,a0 as ci,a1 as di,a2 as Ms,a3 as ui,a4 as Ls,a5 as As,a6 as hi,a7 as Rs,a8 as mi,a9 as vr,aa as gi,ab as pi,ac as fi,ad as cs,ae as bi,af as yi,ag as xi,ah as vi,ai as wi}from"./recreatio-core-BQsNPQ_b.js";import"./vendor-cogita-ui-DTaQ_FiW.js";const Ga={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},Ha={moveMs:900,pauseMs:220,errorMs:900},ji=(t=11)=>{let a=t;const s=()=>(a=(a*1664525+1013904223)%4294967296,a/4294967296),{width:r,height:i,paddingX:u,paddingY:o,levels:y}=Ga,h=(i-o*2)/(y.length-1),b=[],c=[],p=[];y.forEach((x,f)=>{const Q=i-o-f*h,R=r-u*2,j=[];for(let B=0;B<x;B+=1){const L=u+(B+1)*R/(x+1),Z=(s()-.5)*18,q=Math.max(u,Math.min(r-u,L+Z)),E=f===0?3:f<2?2.1:1.4,O=f===0?"root":`l${f}-${B}`;j.push({id:O,x:f===0?r/2:q,y:Q,r:E,level:f,role:f===0?"root":void 0})}p.push(j),b.push(...j)});const l=p[p.length-1];if(l!=null&&l.length){const x=l[Math.floor(l.length/2)];x.role="goal",x.r=2}for(let x=1;x<p.length;x+=1){const f=p[x-1];p[x].forEach(R=>{const j=[...f].sort((q,E)=>Math.abs(q.x-R.x)-Math.abs(E.x-R.x)),B=j[0],L=j[1]&&s()<.45?j[1]:null;(L?[B,L]:[B]).forEach(q=>{c.push({from:q.id,to:R.id,key:`${q.id}-${R.id}`})}),s()<.2&&j[2]&&c.push({from:j[2].id,to:R.id,key:`${j[2].id}-${R.id}`})})}const d=new Map;c.forEach(x=>{const f=d.get(x.to)??[];f.push(x.from),d.set(x.to,f)});const w=new Map,m=new Map,k=new Map;c.forEach(x=>{const f=w.get(x.from)??[];f.push(x.key),w.set(x.from,f);const Q=m.get(x.from)??[];Q.push(x.to),m.set(x.from,Q);const R=k.get(x.from)??[];R.push(x.to),k.set(x.from,R);const j=k.get(x.to)??[];j.push(x.from),k.set(x.to,j)});const I=new Map;return b.forEach(x=>{I.set(x.id,x)}),{nodes:b,links:c,parentsById:d,linksByFrom:w,childrenByFrom:m,neighborsById:k,nodesById:I}};function ki({slides:t,activeIndex:a,introOpen:s,prefersReducedMotion:r,onNext:i,onPrev:u,onSelect:o,onExit:y,onOpen:h,onRegister:b}){const c=a===t.length-1,p=s&&a===0?"entry":"docked",l=t[t.length-1],[d,w]=n.useState(!1),m=n.useMemo(()=>Array.from({length:20},(fe,we)=>({src:`/cogita/logo/Cogita${String(we).padStart(2,"0")}.png`,kind:we<=11?"bubble":we<=17?"text":"recreatio"})),[]),k=s&&a===0;n.useEffect(()=>{if(!s){w(!1);return}a>0&&!d&&w(!0)},[a,s,d]);const I=n.useRef(0),x=n.useRef(null),f=n.useMemo(()=>{const fe={x:40,y:160},we={x:260,y:48},M=6,$=we.x-fe.x,D=fe.y-we.y,z=$/M,H=[.3,.45,.6,.65,1.4,2.2],ae=H.reduce((oe,v)=>oe+v,0),S=H.map(oe=>D*oe/ae),C=[fe];let ce=fe.x,_=fe.y;for(let oe=1;oe<=M;oe+=1){const v=(Math.random()-.5)*14,G=(Math.random()-.5)*28;ce=Math.max(fe.x+oe*14,Math.min(we.x-(M-oe)*14,ce+z+v));const te=S[oe-1]??S[S.length-1];_=_-te+G;const W=Math.max(we.y,Math.min(fe.y-4,_));C.push({x:Math.round(ce),y:Math.round(W)})}return C[C.length-1]=we,C},[]),Q=n.useMemo(()=>{const D=(ae,S,C)=>Math.min(C,Math.max(S,ae)),z=f.map(ae=>{const S=10+Math.random()*36;return{x:D(ae.x,40,260),y:D(ae.y-S,40,140)}}),H=f.map((ae,S)=>{var _;const C=12+Math.random()*40,ce=((_=z[S])==null?void 0:_.y)??ae.y;return{x:D(ae.x,40,260),y:D(Math.max(ce+10,ae.y+C),60,170)}});return{upper:z,lower:H}},[f]),R=n.useMemo(()=>{var we;const fe=((we=f[4])==null?void 0:we.x)??260;return Math.max(0,Math.min(240,fe-40))},[f]),j=n.useMemo(()=>{var S,C;const fe=(ce,_,oe)=>Math.min(oe,Math.max(_,ce)),we=(ce,_,oe)=>f.map((v,G)=>{var ct,yt;const te=((ct=Q.upper[G])==null?void 0:ct.y)??v.y,W=((yt=Q.lower[G])==null?void 0:yt.y)??v.y,Ie=(Math.random()-.5)*70,at=v.y+ce+Ie,st=fe(v.y+_,te+6,W-6),dt=fe(v.y+oe,te+6,W-6);return{x:v.x,y:fe(at,Math.min(st,dt),Math.max(st,dt))}}),M=-14+Math.random()*28,$=14+Math.random()*28,D=we(M,-80,12),z=we($,-12,80);for(let ce=4;ce<f.length;ce+=1){const _=f[ce],oe=((S=Q.upper[ce])==null?void 0:S.y)??_.y,v=((C=Q.lower[ce])==null?void 0:C.y)??_.y;D[ce]={x:_.x,y:fe(_.y-12,oe+6,v-6)},z[ce]={x:_.x,y:fe(_.y+12,oe+6,v-6)}}const H=Q.upper.length?Q.upper[Q.upper.length-1].y:40,ae=Q.lower.length?Q.lower[Q.lower.length-1].y:170;return D[D.length-1]={x:f[f.length-1].x,y:fe(f[f.length-1].y-14,H,ae)},z[z.length-1]={x:f[f.length-1].x,y:fe(f[f.length-1].y+12,H,ae)},{higher:D,lower:z}},[f,Q]),B=1e4,L=n.useMemo(()=>{let fe=17;const we=()=>(fe=(fe*1664525+1013904223)%4294967296,fe/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map(($,D)=>{const z=(we()-.5)*240,H=(we()-.5)*180,ae=(we()-.5)*24;return{id:`card-${D+1}`,throw:{x:`${z.toFixed(0)}px`,y:`${H.toFixed(0)}px`,rot:`${ae.toFixed(1)}deg`},grid:{x:`${$.x}px`,y:`${$.y}px`},delay:`${D*.12}s`}})},[]),Z=n.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[q,E]=n.useState([]),O=n.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),he=n.useMemo(()=>{const we=[],$=(z,H)=>z+Math.random()*(H-z);for(let z=0;z<6;z+=1){let H=!1;for(let ae=0;ae<80;ae+=1){const S=$(14,86),C=$(10,34);if(we.every(_=>{const oe=_.x-S,v=_.y-C;return Math.hypot(oe,v)>=12})){we.push({x:S,y:C}),H=!0;break}}H||we.push({x:$(16,84),y:$(12,32)})}return we.map((z,H)=>({id:`p${H+1}`,x:`${z.x.toFixed(1)}%`,y:`${z.y.toFixed(1)}%`,xNum:z.x,yNum:z.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[Se,et]=n.useState(0),[re,F]=n.useState(0),[ve,J]=n.useState([]),ue=1e4,ne=n.useMemo(()=>{if(he.length<2)return[];const fe=H=>{let ae=H+1831565813;return ae=Math.imul(ae^ae>>>15,ae|1),ae^=ae+Math.imul(ae^ae>>>7,ae|61),((ae^ae>>>14)>>>0)/4294967296},we=(H,ae)=>Math.floor(fe(H)*ae),M=new Set,$=[],D=Math.min(3,he.length);let z=0;for(;$.length<D&&z<30;){z+=1;const H=we(Se*13+z*5,he.length),ae=we(Se*29+z*7,he.length);if(H===ae)continue;const S=H<ae?`${H}-${ae}`:`${ae}-${H}`;M.has(S)||(M.add(S),$.push({id:`link-${S}`,from:he[H],to:he[ae],delay:`${(z*.35).toFixed(2)}s`}))}return $},[Se,he]);n.useEffect(()=>{if(!s||a!==2)return;const fe=()=>{const M=L.map($=>$.id);for(let $=M.length-1;$>0;$-=1){const D=Math.floor(Math.random()*($+1));[M[$],M[D]]=[M[D],M[$]]}return M.slice(0,4)};E(fe());const we=window.setInterval(()=>{E(fe())},B);return()=>window.clearInterval(we)},[a,s,L,B]),n.useEffect(()=>{if(!s||a!==3)return;const fe=()=>{F(Math.floor(Math.random()*O.length)),J(he.map(()=>Math.random()<.6?"good":"bad")),et(M=>M+1)};fe();const we=window.setInterval(fe,ue);return()=>window.clearInterval(we)},[a,s,O.length,he,ue]);const je=n.useMemo(()=>ji(11),[]),[de,se]=n.useState(new Set(["root"])),[$e,ie]=n.useState(new Set),[Ee,Be]=n.useState(new Set),[Je,it]=n.useState({fromId:"root",toId:"root",key:0}),V=n.useRef(de),ke=n.useRef("root"),He=n.useRef(0),Pe=n.useRef(null),Oe=n.useRef(null),ot=n.useRef([]);n.useEffect(()=>{V.current=de},[de]);const wt=n.useMemo(()=>{const fe=new Set;return de.forEach(we=>{const M=je.linksByFrom.get(we);M&&M.forEach($=>fe.add($))}),fe},[de,je]),ft=je.nodesById.get(Je.toId)??je.nodesById.get("root"),_e=ft?`${ft.x/Ga.width*100}%`:"50%",Ze=ft?`${ft.y/Ga.height*100}%`:"90%";n.useEffect(()=>{if(!s||a!==1||r)return;(()=>{se(new Set(["root"])),ie(new Set),Be(new Set),it({fromId:"root",toId:"root",key:0}),Oe.current=null,He.current=0,ke.current="root",ot.current=[]})();const we=()=>{const $=ke.current,D=V.current,H=(je.childrenByFrom.get($)??[]).filter(v=>!D.has(v));if(H.length)return H[Math.floor(Math.random()*H.length)];if(D.size>=je.nodes.length){const v=je.neighborsById.get($)??[];return v.length?v[Math.floor(Math.random()*v.length)]:null}const ae=v=>(je.childrenByFrom.get(v)??[]).some(te=>!D.has(te)),S=[$],C=new Set([$]),ce=new Map;let _=null;for(;S.length;){const v=S.shift();if(!v)break;if(v!==$&&ae(v)){_=v;break}(je.neighborsById.get(v)??[]).forEach(te=>{C.has(te)||(C.add(te),ce.set(te,v),S.push(te))})}if(!_)return null;let oe=_;for(;ce.get(oe)&&ce.get(oe)!==$;)oe=ce.get(oe)??oe;return oe},M=($,D)=>{if($===D){const z=we();z&&M($,z);return}He.current+=1,it({fromId:$,toId:D,key:He.current}),ke.current=D,Pe.current=window.setTimeout(()=>{const z=je.parentsById.get(D)??[],H=V.current,ae=z.filter(_=>!H.has(_));if(!ae.length){const _=new Set(H);_.add(D),se(_),Pe.current=window.setTimeout(()=>{for(;ot.current.length;){const v=ot.current[ot.current.length-1];if(!_.has(v)){if(v!==D){M(D,v);return}break}ot.current.pop()}const oe=we();oe&&M(D,oe)},Ha.pauseMs);return}const S=new Set([D,...ae]),C=new Set(ae.map(_=>`${_}-${D}`));ie(S),Be(C),ot.current.includes(D)||ot.current.push(D);const ce=ae[Math.floor(Math.random()*ae.length)];Oe.current={fromId:D,toId:ce},Pe.current=window.setTimeout(()=>{ie(new Set),Be(new Set);const _=Oe.current;_&&M(_.fromId,_.toId)},Ha.errorMs)},Ha.moveMs)};return Pe.current=window.setTimeout(()=>{const $=we();$&&M(ke.current,$)},Ha.pauseMs),()=>{Pe.current&&window.clearTimeout(Pe.current)}},[a,s,je,r]);const ut=fe=>{if(!s)return;const we=Date.now();we-I.current<520||Math.abs(fe.deltaY)<10||(I.current=we,fe.deltaY>0?i():u(),fe.preventDefault())},Qe=fe=>{if(!s)return;const we=fe.touches[0];we&&(x.current={x:we.clientX,y:we.clientY})},be=fe=>{if(!s)return;const we=x.current;if(x.current=null,!we)return;const M=fe.changedTouches[0];if(!M)return;const $=M.clientX-we.x,D=M.clientY-we.y;Math.abs(D)<40||Math.abs(D)<Math.abs($)||(D<0?i():u())};return e.jsxs("div",{className:`cogita-intro ${s?"is-open":"is-closed"} ${r?"is-reduced":""} ${c?"is-final":""}`,"data-slide":a+1,onWheel:ut,onTouchStart:Qe,onTouchEnd:be,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":p,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${k&&!d?"is-entry":""}`,children:m.map((fe,we)=>e.jsx("img",{src:fe.src,alt:"",className:`cogita-logo-layer ${we===0?"is-base":""} ${fe.kind==="text"?"is-text":fe.kind==="recreatio"?"is-recreatio":""} ${fe.kind==="bubble"?"is-bubble":""}`},fe.src))})}),s&&t.map((fe,we)=>{const M=we===a;return e.jsxs("section",{className:`cogita-intro-slide slide-${we+1} ${M?"is-active":""}`,"aria-hidden":!M,children:[e.jsxs("div",{className:"cogita-intro-text",children:[fe.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:fe.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:fe.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:fe.title}),fe.body&&e.jsx("p",{children:fe.body.split(`
`).map(($,D)=>e.jsxs("span",{children:[$,D===0&&e.jsx("br",{})]},String(D)))})]}),fe.micro&&e.jsx("p",{className:"cogita-intro-micro",children:fe.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:c?b:i,children:fe.cta}),c&&fe.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>o(0),children:fe.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[we===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${Ga.width} ${Ga.height}`,preserveAspectRatio:"none",children:[je.links.map($=>{const D=je.nodesById.get($.from),z=je.nodesById.get($.to);if(!D||!z)return null;const H=wt.has($.key),ae=Ee.has($.key);return e.jsx("line",{className:`map-link ${H?"is-active":""} ${ae?"is-error":""}`,x1:D.x,y1:D.y,x2:z.x,y2:z.y},$.key)}),je.nodes.map($=>{const D=de.has($.id),z=$e.has($.id);return e.jsx("circle",{className:`map-node ${$.role?`is-${$.role}`:""} ${D?"is-active":""} ${z?"is-error":""}`,cx:$.x,cy:$.y,r:$.r},$.id)})]}),ft&&e.jsx("span",{className:"map-explorer-dot",style:{left:_e,top:Ze,"--move":`${Ha.moveMs}ms`}})]}),we===2&&e.jsx("div",{className:"cogita-index-cards",children:L.map($=>{const D=q.indexOf($.id),z=D>=0?Z[D]:null,H=(z==null?void 0:z.x)??"140px",ae=(z==null?void 0:z.y)??"140px",S=D>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":$.throw.x,"--throw-y":$.throw.y,"--throw-rot":$.throw.rot,"--grid-x":$.grid.x,"--grid-y":$.grid.y,"--stack-x":H,"--stack-y":ae,"--stack-opacity":S,"--delay":$.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},$.id)})}),we===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[O.map(($,D)=>e.jsxs("div",{className:`round-card ${D===re?"is-active":""}`,style:{"--card-x":$.x,"--card-y":$.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},$.id)),O[re]&&e.jsx("span",{className:"round-ring",style:{"--card-x":O[re].x,"--card-y":`calc(${O[re].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:he.map($=>e.jsx("span",{className:"player-dot",style:{left:$.x,top:$.y,"--jitter-x":$.jitterX,"--jitter-y":$.jitterY,"--breath-delay":$.delay}},$.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:ne.map($=>e.jsx("line",{className:"round-link",x1:$.from.xNum,y1:$.from.yNum,x2:$.to.xNum,y2:$.to.yNum,style:{"--delay":$.delay}},$.id))}),e.jsx("div",{className:"round-flows",children:he.map(($,D)=>{const z=ve[D]??"good",H=O[re];if(!H)return null;const ae=`calc(${H.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":$.x,"--from-y":$.y,"--to-x":H.x,"--to-y":ae,"--delay":`${D*.12}s`}}),e.jsx("span",{className:`return-dot is-${z}`,style:{"--from-x":H.x,"--from-y":ae,"--to-x":$.x,"--to-y":$.y,"--delay":`${D*.12}s`}}),e.jsx("span",{className:`result-pop is-${z}`,style:{"--at-x":$.x,"--at-y":$.y,"--delay":`${D*.12}s`}})]},`${$.id}-${Se}`)})})]},`round-${Se}`),we===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${f[0].x} ${f[0].y} L${f[1].x} ${f[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${f[1].x} ${f[1].y} L${f[2].x} ${f[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${f[2].x} ${f[2].y} L${f[3].x} ${f[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${f[3].x} ${f[3].y} L${f[4].x} ${f[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${f[4].x} ${f[4].y} L${f[5].x} ${f[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${f[5].x} ${f[5].y} L${f[6].x} ${f[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${R};${R};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${Q.upper.map(($,D)=>`${D===0?"M":"L"}${$.x} ${$.y}`).join(" ")} ${Q.lower.slice().reverse().map($=>`L${$.x} ${$.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${Q.upper.map(($,D)=>`${D===0?"M":"L"}${$.x} ${$.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${Q.lower.map(($,D)=>`${D===0?"M":"L"}${$.x} ${$.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[j.higher.slice(0,6).map(($,D)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${D+1}`,d:`M${$.x} ${$.y} L${j.higher[D+1].x} ${j.higher[D+1].y}`,pathLength:"100"},`peer-1-${D}`)),j.lower.slice(0,6).map(($,D)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${D+1}`,d:`M${$.x} ${$.y} L${j.lower[D+1].x} ${j.lower[D+1].y}`,pathLength:"100"},`peer-2-${D}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${f[0].x/300*100}%`,"--p0y":`${f[0].y/200*100}%`,"--p1x":`${f[1].x/300*100}%`,"--p1y":`${f[1].y/200*100}%`,"--p2x":`${f[2].x/300*100}%`,"--p2y":`${f[2].y/200*100}%`,"--p3x":`${f[3].x/300*100}%`,"--p3y":`${f[3].y/200*100}%`,"--p4x":`${f[4].x/300*100}%`,"--p4y":`${f[4].y/200*100}%`,"--p5x":`${f[5].x/300*100}%`,"--p5y":`${f[5].y/200*100}%`,"--p6x":`${f[6].x/300*100}%`,"--p6y":`${f[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${j.higher[0].x/300*100}%`,"--q0y":`${j.higher[0].y/200*100}%`,"--q1x":`${j.higher[1].x/300*100}%`,"--q1y":`${j.higher[1].y/200*100}%`,"--q2x":`${j.higher[2].x/300*100}%`,"--q2y":`${j.higher[2].y/200*100}%`,"--q3x":`${j.higher[3].x/300*100}%`,"--q3y":`${j.higher[3].y/200*100}%`,"--q4x":`${j.higher[4].x/300*100}%`,"--q4y":`${j.higher[4].y/200*100}%`,"--q5x":`${j.higher[5].x/300*100}%`,"--q5y":`${j.higher[5].y/200*100}%`,"--q6x":`${j.higher[6].x/300*100}%`,"--q6y":`${j.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${j.lower[0].x/300*100}%`,"--q0y":`${j.lower[0].y/200*100}%`,"--q1x":`${j.lower[1].x/300*100}%`,"--q1y":`${j.lower[1].y/200*100}%`,"--q2x":`${j.lower[2].x/300*100}%`,"--q2y":`${j.lower[2].y/200*100}%`,"--q3x":`${j.lower[3].x/300*100}%`,"--q3y":`${j.lower[3].y/200*100}%`,"--q4x":`${j.lower[4].x/300*100}%`,"--q4y":`${j.lower[4].y/200*100}%`,"--q5x":`${j.lower[5].x/300*100}%`,"--q5y":`${j.lower[5].y/200*100}%`,"--q6x":`${j.lower[6].x/300*100}%`,"--q6y":`${j.lower[6].y/200*100}%`}})]})})}),we===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),we===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},fe.id)}),!s&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:l.title}),l.body&&e.jsx("p",{children:l.body}),l.micro&&e.jsx("p",{className:"cogita-intro-micro",children:l.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:b,children:l.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:h,children:"Otwórz pokaz"})]})]})})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((fe,we)=>e.jsx("button",{type:"button",className:`dot ${a===we?"active":""}`,"aria-label":fe.title,onClick:()=>o(we)},fe.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:y,children:"Pomiń"})]})]})}const Ni=6,Si=4;function Ti({copy:t,onAuthAction:a,authLabel:s,showProfileMenu:r,onProfileNavigate:i,onToggleSecureMode:u,onLogout:o,secureMode:y,onNavigate:h,language:b,onLanguageChange:c}){const p=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}h("home")},l=n.useRef(null),d=n.useRef([]),w=n.useMemo(()=>{let J=Date.now()%2147483647;const ue=()=>(J=J*48271%2147483647,J/2147483647);return Array.from({length:Ni},(ne,je)=>{const de=6+ue()*8,se=7+ue()*10,$e=6+ue()*9,ie=-ue()*de,Ee=-ue()*se,Be=-ue()*$e,Je=.18+ue()*.28,it=12+ue()*18,V=4+ue()*8,ke=(ue()-.5)*3.2,He=(ue()-.5)*3.8,Pe=ue()>.5?"alternate":"alternate-reverse",Oe=ue()>.5?"alternate":"alternate-reverse",ot=ue()>.5?"alternate":"alternate-reverse",wt=.18+ue()*.42,ft=30+ue()*60,_e=-45-ue()*38,Ze=188+ue()*32,ut=.1+ue()*.2;return{id:`wave-${je+1}`,style:{"--wave-sway-duration":`${de}s`,"--wave-scale-duration":`${se}s`,"--wave-drift-duration":`${$e}s`,"--wave-sway-delay":`${ie}s`,"--wave-scale-delay":`${Ee}s`,"--wave-drift-delay":`${Be}s`,"--wave-sway-dir":Pe,"--wave-scale-dir":Oe,"--wave-drift-dir":ot,"--wave-scale":`${Je}`,"--wave-shift":`${it}%`,"--wave-xshift":`${V}%`,"--wave-x0":`${ke}%`,"--wave-y0":`${He}%`,"--wave-opacity":`${wt}`,"--wave-blur":`${ft}px`,"--wave-bottom":`${_e}%`,"--wave-hue":`${Ze}`,"--wave-glow":`${ut}`}}})},[]),m=n.useMemo(()=>{let J=Date.now()*3%2147483647;const ue=()=>(J=J*48271%2147483647,J/2147483647);return Array.from({length:Si},(ne,je)=>{const de=180+ue()*220,se=220+ue()*280,$e=-ue()*de,ie=-ue()*se,Ee=.12+ue()*.22,Be=3+ue()*7,Je=1+ue()*3,it=(ue()-.5)*2.8,V=(ue()-.5)*2.2;return{id:`mesh-${je+1}`,seed:1e3+je*991+Math.floor(ue()*999),style:{"--mesh-sway-duration":`${de}s`,"--mesh-drift-duration":`${se}s`,"--mesh-sway-delay":`${$e}s`,"--mesh-drift-delay":`${ie}s`,"--mesh-scale":`${Ee}`,"--mesh-shift":`${Be}%`,"--mesh-xshift":`${Je}%`,"--mesh-x0":`${V}%`,"--mesh-y0":`${it}%`}}})},[]),k=n.useMemo(()=>{const J=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],ue=t.cogita.introSlides,ne=new Map(ue.map(je=>[je.id,je]));return J.map(je=>{var se;const de=ne.get(je.id);return{...je,...de,title:(de==null?void 0:de.title)??"Cogita",cta:(de==null?void 0:de.cta)??((se=t.cogita.introSlides[0])==null?void 0:se.cta)??t.cogita.loginCta,secondary:de==null?void 0:de.secondary}})},[t.cogita.introSlides]),[I,x]=n.useState(0),[f,Q]=n.useState(!0),[R,j]=n.useState(!1),B=k.length-1,L=n.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),Z=n.useCallback(()=>{L(),a()},[L,a]),q=n.useCallback(()=>{Q(!0),x(0)},[]),E=n.useCallback(()=>{Q(!1),x(B)},[B]),O=n.useCallback(J=>{x(Math.max(0,Math.min(B,J)))},[B]),he=n.useCallback(()=>{I>=B?Z():O(I+1)},[I,O,Z,B]),Se=n.useCallback(()=>{O(I-1)},[I,O]);n.useEffect(()=>{var ne;const J=(ne=window.matchMedia)==null?void 0:ne.call(window,"(prefers-reduced-motion: reduce)");if(!J)return;const ue=()=>j(J.matches);return ue(),J.addEventListener?(J.addEventListener("change",ue),()=>J.removeEventListener("change",ue)):(J.addListener(ue),()=>J.removeListener(ue))},[]),n.useEffect(()=>{if(!f)return;const J=ue=>{const ne=ue.target;if(!ne)return;const je=ne.tagName;if(!(ne.isContentEditable||je==="INPUT"||je==="TEXTAREA"||je==="SELECT"||je==="BUTTON"||je==="A"||ne.closest('button, a, [role="button"], [role="link"]'))){if(ue.key==="Escape"){E();return}if(ue.key==="ArrowLeft"||ue.key==="ArrowUp"){Se();return}(ue.key==="ArrowRight"||ue.key==="ArrowDown"||ue.code==="Space"||ue.key===" ")&&(ue.preventDefault(),he())}};return window.addEventListener("keydown",J),()=>window.removeEventListener("keydown",J)},[E,he,Se,f]),n.useEffect(()=>{f&&I===B&&L()},[I,f,B,L]),n.useEffect(()=>{const J=l.current;if(!J)return;const ue=d.current.filter(_e=>!!_e);if(!ue.length)return;const ne=1,je=.6,de=.6,se=Math.max(1,Math.min(ne,window.devicePixelRatio||1));let $e=0,ie=0,Ee=je,Be=0,Je=0;const it=_e=>{let Ze=_e%2147483647;return Ze<=0&&(Ze+=2147483646),(ut,Qe)=>{Ze=Ze*48271%2147483647;const be=Ze/2147483647;return ut+be*(Qe-ut)}},V={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},ke=_e=>{const Ze=Math.sin(_e*12.9898)*43758.5453;return Ze-Math.floor(Ze)},He=_e=>{const Ze=ke(_e+.1)||1e-4,ut=ke(_e+.7)||1e-4;return Math.sqrt(-2*Math.log(Ze))*Math.cos(2*Math.PI*ut)},Pe=(_e,Ze)=>{const ut=Math.floor(_e),Qe=ut+1,be=_e-ut,fe=be*be*(3-2*be),we=ke(ut*12.9898+Ze*78.233),M=ke(Qe*12.9898+Ze*78.233);return we+(M-we)*fe},Oe=_e=>{const Ze=it(_e),ut=Math.min(4,Math.max(4,Math.floor($e/1200*V.filamentCount)));return Array.from({length:ut},(Qe,be)=>{const fe=Math.max(-1,Math.min(1,He(_e+be*.37))),we=Math.min(1,Math.max(0,ke(_e+be*1.31))),M=Math.min(V.depthLayers-1,Math.floor(we*V.depthLayers));return{seed:Ze(0,Math.PI*2)+_e*.01,offset:fe,freqA:V.freq1*(.75+Ze(0,.5)),freqB:V.freq2*(.75+Ze(0,.5)),ampA:V.amp1*(.6+Ze(0,.7)),ampB:V.amp2*(.6+Ze(0,.7)),width:2+be%5*.32,depth:we,layer:M}})},ot=(_e,Ze,ut)=>{const Qe=Math.max(30,Math.floor($e*ie/14e4));_e.save(),_e.globalAlpha=.6;for(let be=0;be<Qe;be+=1){const fe=ke(be*9.1+$e*.11)*Ze+ut,we=ke(be*3.7+ie*.23)*ie,M=1.2+ke(be*5.9)*2.4,$=_e.createRadialGradient(fe,we,0,fe,we,M*2);$.addColorStop(0,"rgba(10, 30, 60, 0.45)"),$.addColorStop(1,"rgba(10, 30, 60, 0)"),_e.fillStyle=$,_e.beginPath(),_e.arc(fe,we,M*2,0,Math.PI*2),_e.fill()}_e.restore()},wt=(_e,Ze)=>{_e.clearRect(0,0,$e,ie);const ut=ie*V.waveCenter,Qe=V.waveBandPx,be=V.segments,fe=V.colors.filaments,we=Be||$e,M=0;ot(_e,we,M),_e.strokeStyle=fe,_e.lineCap="round",_e.lineJoin="round";for(let $=0;$<Ze.length;$+=1){const D=Ze[$],z=D.offset*Qe*(.85+ke(D.seed)*.4),H=1-Math.min(1,Math.abs(z)/Qe),ae=Math.exp(-Math.pow(z/V.crestThickness,2)),S=D.layer===0?1.1:D.layer===1?.85:.6,C=.35+(1-D.depth)*.65,ce=H*C*S*(.34+ae*.45);_e.globalAlpha=ce,_e.lineWidth=D.width*(1+(1-D.depth)*.8);const _=[];for(let v=0;v<=be;v+=1){const G=v/be*we+M,te=(Pe(G*.012,D.seed)-.5)*V.xJitter,W=G+te,Ie=(Pe(W*D.freqA,D.seed)-.5)*V.jitterA,at=(Pe(W*D.freqB,D.seed*1.7)-.5)*V.jitterB,st=ut+Math.sin(W*D.freqA+D.seed)*D.ampA+Math.sin(W*D.freqB+D.seed*1.3)*D.ampB+z+Ie+at;_.push({x:W,y:st})}_e.beginPath(),_e.moveTo(_[0].x,_[0].y);for(let v=1;v<_.length-1;v+=1){const G=(_[v].x+_[v+1].x)/2,te=(_[v].y+_[v+1].y)/2;_e.quadraticCurveTo(_[v].x,_[v].y,G,te)}const oe=_[_.length-1];_e.quadraticCurveTo(oe.x,oe.y,oe.x,oe.y),_e.stroke()}_e.save(),_e.globalCompositeOperation="lighter",_e.strokeStyle=V.colors.glow,_e.lineCap="round",_e.lineJoin="round";for(let $=0;$<Ze.length;$+=1){const D=Ze[$];if(Math.abs(D.offset)*Qe>V.crestThickness)continue;const z=V.glowAlpha*(.7+(1-D.depth)*.6);_e.globalAlpha=z,_e.lineWidth=1.6+(1-D.depth)*1.2;const H=[];for(let S=0;S<=be;S+=1){const C=S/be*we+M,ce=Math.sin(C*.02+D.seed)*3,_=ut+Math.sin(C*D.freqA+D.seed)*D.ampA+Math.sin(C*D.freqB+D.seed*1.3)*D.ampB+D.offset*Qe*.35+ce;H.push({x:C,y:_})}_e.beginPath(),_e.moveTo(H[0].x,H[0].y);for(let S=1;S<H.length-1;S+=1){const C=(H[S].x+H[S+1].x)/2,ce=(H[S].y+H[S+1].y)/2;_e.quadraticCurveTo(H[S].x,H[S].y,C,ce)}const ae=H[H.length-1];_e.quadraticCurveTo(ae.x,ae.y,ae.x,ae.y),_e.stroke()}_e.restore()},ft=()=>{$e=Math.floor(J.clientWidth),ie=Math.floor(J.clientHeight),Be=Math.floor($e*1.8),Je=ie,Ee=$e<820?de:je,ue.forEach(_e=>{const Ze=_e.getContext("2d");if(!Ze)return;_e.width=Math.floor(Be*se*Ee),_e.height=Math.floor(Je*se*Ee),_e.style.width=`${Be}px`,_e.style.height=`${Je}px`,_e.style.left=`${-(Be-$e)/2}px`,Ze.setTransform(se*Ee,0,0,se*Ee,0,0);const ut=Number(_e.dataset.seed||1),Qe=Oe(ut);wt(Ze,Qe)})};return ft(),window.addEventListener("resize",ft,{passive:!0}),()=>window.removeEventListener("resize",ft)},[m]);const et=k[Math.min(I,k.length-1)],re=f?et:k[k.length-1],F=(re==null?void 0:re.theme)??k[0].theme,ve={"--cogita-bg0":F.bg0,"--cogita-bg1":F.bg1,"--cogita-bg2":F.bg2,"--cogita-bloom":F.bloom,"--cogita-sat":F.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:p,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(ur,{value:b,onChange:c}),e.jsx(hr,{copy:t,label:s,isAuthenticated:r,secureMode:y,onLogin:a,onProfileNavigate:i,onToggleSecureMode:u,onLogout:o,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:l,className:"cogita-section cogita-home",style:ve,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[m.map((J,ue)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:J.style,"data-seed":J.seed,ref:ne=>{d.current[ue]=ne}},J.id)),w.map(J=>e.jsx("div",{className:"cogita-home-wave",style:J.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},J.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(ki,{slides:k,activeIndex:I,introOpen:f,prefersReducedMotion:R,onNext:he,onPrev:Se,onSelect:O,onExit:E,onOpen:q,onRegister:Z})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const ol=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:Ti},Symbol.toStringTag,{value:"Module"})),wr=n.createContext(!1);function At({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,headerExtra:c,children:p}){if(n.useContext(wr))return e.jsx(e.Fragment,{children:p});const d=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}y("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:d,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(ur,{value:h,onChange:b}),e.jsxs("div",{className:"cogita-header-right",children:[c,e.jsx(hr,{copy:t,label:a,isAuthenticated:s,secureMode:o,onLogin:()=>y("home"),onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:p}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function ha(t){const[a,s]=n.useState("Cogita library"),[r,i]=n.useState(null);return n.useEffect(()=>{let u=!1;return mr().then(o=>{if(u)return;const y=o.find(h=>h.libraryId===t);y&&s(y.name)}).catch(()=>{u||s("Cogita library")}),()=>{u=!0}},[t]),n.useEffect(()=>{let u=!1;return Er(t).then(o=>{u||i(o)}).catch(()=>{u||i(null)}),()=>{u=!0}},[t]),{libraryName:a,stats:r}}function $s({slices:t}){const a=t.reduce((r,i)=>r+Math.max(0,i.value),0),s=n.useMemo(()=>{if(a<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let r=0;return`conic-gradient(${t.map(u=>{const y=Math.max(0,u.value)/a*360,h=r,b=r+y;return r=b,`${u.color} ${h}deg ${b}deg`}).join(",")})`},[t,a]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:s}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(r=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:r.color}}),e.jsx("strong",{children:r.value}),e.jsx("small",{children:r.label})]},r.label))})]})}function Ci({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,libraryId:c}){const{libraryName:p,stats:l}=ha(c),[d,w]=n.useState("infos"),[m,k]=n.useState(0),[I,x]=n.useState(0),[f,Q]=n.useState(0),R=(l==null?void 0:l.totalInfos)??0,j=(l==null?void 0:l.totalCollections)??0,B=0,L=0,Z=0,q=Math.max(0,R-Z-I),E=Math.max(0,R-I-f);n.useEffect(()=>{let he=!1;return(async()=>{try{const et=await en({libraryId:c,limit:200}),re=await Promise.all(et.items.map(F=>ps({libraryId:c,collectionId:F.collectionId}).catch(()=>[])));if(he)return;k(re.reduce((F,ve)=>F+ve.length,0))}catch{he||k(0)}})(),()=>{he=!0}},[c]),n.useEffect(()=>{let he=!1;return(async()=>{try{const[et,re,F]=await Promise.all([Cs({libraryId:c,type:"computed",limit:1}).catch(()=>({total:0})),Cs({libraryId:c,type:"source",limit:1}).catch(()=>({total:0})),fs({libraryId:c}).catch(()=>({items:[]}))]);if(he)return;x((et.total??0)+(re.total??0));const ve=new Set(F.items.filter(J=>J.childItemType.toLowerCase()==="info").map(J=>J.childItemId).filter(Boolean));Q(ve.size)}catch{he||(x(0),Q(0))}})(),()=>{he=!0}},[c]);const O=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:R},{key:"collections",label:t.cogita.library.overview.stats.collections,value:j},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:m},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:B},{key:"texts",label:t.cogita.library.overview.stats.texts,value:L}];return e.jsx(At,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:p})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:O.map(he=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${d===he.key?"active":""}`,onClick:()=>w(he.key),children:[e.jsx("span",{children:he.label}),e.jsx("strong",{children:he.value})]},he.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),d==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx($s,{slices:[{label:t.cogita.library.overview.known,value:Z,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:q,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:I,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx($s,{slices:[{label:t.cogita.library.overview.availableChecks,value:f,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:E,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const gt=(t,a)=>{const s=t.cogita.library.infoTypes,r=t.cogita.library.connectionTypes,i=t.cogita.library.groupTypes;return{any:s.any,vocab:s.vocab,book:i.book,citation:i.citation,language:s.language,word:s.word,sentence:s.sentence,topic:s.topic,collection:s.collection,person:s.person,institution:s.institution,collective:s.collective,orcid:s.orcid,address:s.address,email:s.email,phone:s.phone,media:s.media,work:s.work,geo:s.geo,music_piece:s.musicPiece,music_fragment:s.musicFragment,source:s.source,question:s.question,computed:s.computed,"word-language":r.wordLanguage,"citation-language":r.citationLanguage,"language-sentence":r.languageSentence,translation:r.translation,"word-topic":r.wordTopic,reference:r.reference,"source-resource":r.sourceResource,"work-contributor":r.workContributor,"work-medium":r.workMedium,"orcid-link":r.orcidLink}[a]??String(a)},Ii=t=>[{value:"any",label:gt(t,"any")},{value:"language",label:gt(t,"language")},{value:"word",label:gt(t,"word")},{value:"sentence",label:gt(t,"sentence")},{value:"topic",label:gt(t,"topic")},{value:"collection",label:gt(t,"collection")},{value:"person",label:gt(t,"person")},{value:"institution",label:gt(t,"institution")},{value:"collective",label:gt(t,"collective")},{value:"orcid",label:gt(t,"orcid")},{value:"address",label:gt(t,"address")},{value:"email",label:gt(t,"email")},{value:"phone",label:gt(t,"phone")},{value:"media",label:gt(t,"media")},{value:"work",label:gt(t,"work")},{value:"geo",label:gt(t,"geo")},{value:"music_piece",label:gt(t,"music_piece")},{value:"music_fragment",label:gt(t,"music_fragment")},{value:"source",label:gt(t,"source")},{value:"question",label:gt(t,"question")},{value:"citation",label:gt(t,"citation")},{value:"computed",label:gt(t,"computed")},{value:"vocab",label:gt(t,"vocab")},{value:"book",label:gt(t,"book")},{value:"word-language",label:gt(t,"word-language")},{value:"citation-language",label:gt(t,"citation-language")},{value:"language-sentence",label:gt(t,"language-sentence")},{value:"translation",label:gt(t,"translation")},{value:"word-topic",label:gt(t,"word-topic")},{value:"reference",label:gt(t,"reference")},{value:"source-resource",label:gt(t,"source-resource")},{value:"work-contributor",label:gt(t,"work-contributor")},{value:"work-medium",label:gt(t,"work-medium")},{value:"orcid-link",label:gt(t,"orcid-link")}],Mi=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Un={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},Li={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Un]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Un]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId"]},filterFields:[Un,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text"],connections:[{relationType:"citation-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"citationText",kind:"text",path:"text",matcher:"contains"}]},question:{infoType:"question",entityKind:"single",structure:{payloadFields:["definition"]},filterFields:[{key:"questionType",labelKey:"type",kind:"text",path:"definition.type",matcher:"contains"},{key:"questionText",labelKey:"text",kind:"text",path:"definition.question",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},Ps={infoType:"default",entityKind:"single",structure:{payloadFields:["label"]},filterFields:[]};function Ai(t){return t?Li[t]??Ps:Ps}function Ri(t,a){return t.optionsSource==="languages"?a.languages.map(s=>({value:s.infoId,label:s.label})):t.optionsSource==="sourceKinds"?Mi:[]}const $i="cogita.revision.seed:";function jr(t){return`${$i}${t}`}function Pi(t,a){if(typeof window>"u")return null;const s=Array.from(new Set(a.map(u=>u.trim()).filter(Boolean)));if(!s.length)return null;const r=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,i={kind:"info-selection",libraryId:t,infoIds:s,createdAt:new Date().toISOString()};return window.localStorage.setItem(jr(r),JSON.stringify(i)),r}function Es(t,a){if(typeof window>"u")return null;const s=window.localStorage.getItem(jr(a));if(!s)return null;try{const r=JSON.parse(s);if(r.kind!=="info-selection"||r.libraryId!==t||!Array.isArray(r.infoIds))return null;const i=r.infoIds.map(u=>String(u??"").trim()).filter(Boolean);return i.length?{infoIds:i}:null}catch{return null}}const Ei="cogita.collection-draft:";function kr(t){return`${Ei}${t}`}function Fi(t,a){if(typeof window>"u")return null;const s=Array.from(new Set(a.map(u=>u.trim()).filter(Boolean)));if(!s.length)return null;const r=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,i={kind:"info-selection",libraryId:t,infoIds:s,createdAt:new Date().toISOString()};return window.localStorage.setItem(kr(r),JSON.stringify(i)),r}function Ki(t,a){if(typeof window>"u")return null;const s=window.localStorage.getItem(kr(a));if(!s)return null;try{const r=JSON.parse(s);if(r.kind!=="info-selection"||r.libraryId!==t||!Array.isArray(r.infoIds))return null;const i=r.infoIds.map(u=>String(u??"").trim()).filter(Boolean);return i.length?{infoIds:i}:null}catch{return null}}const Jn=60,_i=500;function Nr(t){return`cogita.info-selection:${t}`}function Fs(t){if(typeof window>"u")return{};const a=window.localStorage.getItem(Nr(t));if(!a)return{};try{const s=JSON.parse(a);return!s||typeof s!="object"?{}:s}catch{return{}}}function Di({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,libraryId:c,mode:p}){var ze;const l=nn(),d=Oa(),w=t.cogita.library.list,[m,k]=n.useState("any"),[I,x]=n.useState(""),[f,Q]=n.useState("relevance"),[R,j]=n.useState("details"),[B,L]=n.useState(!1),[Z,q]=n.useState("idle"),[E,O]=n.useState([]),[he,Se]=n.useState(Jn),[et,re]=n.useState(null),[F,ve]=n.useState(()=>Fs(c)),[J,ue]=n.useState({}),[ne,je]=n.useState([]),[de,se]=n.useState([]),[$e,ie]=n.useState(null),[Ee,Be]=n.useState(null),[Je,it]=n.useState(null),[V,ke]=n.useState("idle"),[He,Pe]=n.useState([]),[Oe,ot]=n.useState(""),[wt,ft]=n.useState(null),[_e,Ze]=n.useState("idle"),[ut,Qe]=n.useState(null),[be,fe]=n.useState(null),[we,M]=n.useState("idle"),[$,D]=n.useState([]),[z,H]=n.useState("idle"),ae=n.useMemo(()=>Ii(t),[t]),S=n.useMemo(()=>[{value:"relevance",label:w.sortRelevance},{value:"label_asc",label:w.sortLabelAsc},{value:"label_desc",label:w.sortLabelDesc},{value:"type_asc",label:w.sortTypeAsc},{value:"type_desc",label:w.sortTypeDesc}],[w.sortLabelAsc,w.sortLabelDesc,w.sortRelevance,w.sortTypeAsc,w.sortTypeDesc]);n.useEffect(()=>{ve(Fs(c)),ue({}),L(!1)},[c]),n.useEffect(()=>{fs({libraryId:c}).then(P=>it(P)).catch(()=>it({items:[]}))},[c]),n.useEffect(()=>{Fr({libraryId:c}).then(P=>Pe(P)).catch(()=>Pe([]))},[c]),n.useEffect(()=>{On({libraryId:c,type:"language",filters:{sourceKind:"info"},limit:200}).then(P=>{const Ae=P.map(Ye=>({infoId:Ye.infoId??"",infoType:Ye.entityType,label:Ye.title})).filter(Ye=>Ye.infoId.length>0);je(Ae)}).catch(()=>je([]))},[c]),n.useEffect(()=>{On({libraryId:c,type:"source",filters:{sourceKind:"info"},limit:200}).then(P=>{const Ae=P.map(Ye=>({infoId:Ye.infoId??"",infoType:Ye.entityType,label:Ye.title})).filter(Ye=>Ye.infoId.length>0);se(Ae)}).catch(()=>se([]))},[c]),n.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(Nr(c),JSON.stringify(F))},[c,F]);const C=n.useMemo(()=>Ai(m==="any"?null:m),[m]),ce=n.useMemo(()=>new URLSearchParams(d.search),[d.search]),_=n.useMemo(()=>d.pathname.split("/").filter(Boolean),[d.pathname]),oe=_.findIndex(P=>P==="infos"),v=oe>=0&&(_[oe+1]??"").trim()||null,G=oe>=0?(_[oe+2]??"").trim():"",te=oe>=0?G==="checkcards"?"cards":G==="collections"?"collections":"overview":"",W=v??((ce.get("infoId")??"").trim()||null),Ie=v?te:(ce.get("infoView")??"overview").trim(),at=Ie==="overview"&&!!W,st=Ie==="collections"&&!!W,dt=n.useMemo(()=>({language:w.typeFilterLanguage,languageA:w.typeFilterLanguageA,languageB:w.typeFilterLanguageB,originalLanguage:w.typeFilterOriginalLanguage,doi:w.typeFilterDoi,sourceKind:w.typeFilterSourceKind,locator:w.typeFilterLocator,citationText:w.typeFilterCitationText}),[w.typeFilterDoi,w.typeFilterLanguage,w.typeFilterLanguageA,w.typeFilterLanguageB,w.typeFilterLocator,w.typeFilterOriginalLanguage,w.typeFilterCitationText,w.typeFilterSourceKind]),ct=n.useMemo(()=>C.filterFields.map(P=>({...P,label:P.labelKey?dt[P.labelKey]:P.label??P.key,options:Ri(P,{languages:ne})})),[dt,ne,C.filterFields]),yt=n.useMemo(()=>ct.some(P=>(J[P.key]??"").trim().length>0),[ct,J]);n.useEffect(()=>{ue({})},[m]),n.useEffect(()=>{const P={sourceKind:"info"};if(yt)for(const xt of ct){const ye=(J[xt.key]??"").trim();ye&&(P[xt.path??xt.key]=ye)}const Ae=(J.__referenceId??"").trim();Ae&&(P["link.references"]=Ae),q("loading");const Ye=window.setTimeout(()=>{On({libraryId:c,type:m==="any"?void 0:m,query:I.trim()||void 0,filters:P,limit:_i}).then(xt=>{const ye=xt.map(Ht=>({infoId:Ht.infoId??"",infoType:Ht.entityType,label:Ht.title})).filter(Ht=>Ht.infoId.length>0);O(ye),q("ready")}).catch(()=>{O([]),q("ready")})},240);return()=>window.clearTimeout(Ye)},[yt,c,I,m,ct,J]),n.useEffect(()=>{if(!W||Ie!=="overview"&&Ie!=="collections"){ie(null),Be(null),ke("idle");return}let P=!1;return ke("loading"),Promise.all([aa({libraryId:c,infoId:W}),Kr({libraryId:c,itemType:"info",itemId:W}).catch(()=>null)]).then(([Ae,Ye])=>{P||(ie(Ae),Be(Ye),ke("ready"))}).catch(()=>{P||(ie(null),Be(null),ke("error"))}),()=>{P=!0}},[c,W,Ie]),n.useEffect(()=>{if(!W||Ie!=="collections"){D([]),H("idle");return}let P=!1;return H("loading"),_r({libraryId:c,infoId:W}).then(Ae=>{P||(D(Ae),H("ready"))}).catch(()=>{P||(D([]),H("error"))}),()=>{P=!0}},[c,W,Ie]),n.useEffect(()=>{if(!W||Ie!=="overview"){Qe(null),fe(null),M("idle");return}let P=!1;return M("loading"),Promise.all([bn({libraryId:c,infoId:W}),yn({libraryId:c,infoId:W})]).then(([Ae,Ye])=>{P||(Qe(Ae),fe(Ye),M("ready"))}).catch(()=>{P||(Qe(null),fe(null),M("error"))}),()=>{P=!0}},[c,W,Ie]);const mt=n.useMemo(()=>$e?He.filter(P=>P.sourceInfoTypes.some(Ae=>Ae.toLowerCase()===$e.infoType.toLowerCase())):[],[He,$e]);n.useEffect(()=>{if(!$e){ot("");return}ot(P=>{var Ae;return P&&mt.some(Ye=>Ye.approachKey===P)?P:((Ae=mt[0])==null?void 0:Ae.approachKey)??""})},[mt,$e]),n.useEffect(()=>{if(!$e||!Oe){ft(null),Ze("idle");return}let P=!1;return Ze("loading"),gr({libraryId:c,infoId:$e.infoId,approachKey:Oe}).then(Ae=>{P||(ft(Ae),Ze("ready"))}).catch(()=>{P||(ft(null),Ze("error"))}),()=>{P=!0}},[c,Oe,$e]);const nt=n.useMemo(()=>{const P=E.slice(),Ae=Ye=>gt(t,Ye);return f==="relevance"?P:f==="label_asc"?P.sort((Ye,xt)=>Ye.label.localeCompare(xt.label)):f==="label_desc"?P.sort((Ye,xt)=>xt.label.localeCompare(Ye.label)):f==="type_asc"?P.sort((Ye,xt)=>Ye.infoType===xt.infoType?Ye.label.localeCompare(xt.label):Ae(Ye.infoType).localeCompare(Ae(xt.infoType))):P.sort((Ye,xt)=>Ye.infoType===xt.infoType?Ye.label.localeCompare(xt.label):Ae(xt.infoType).localeCompare(Ae(Ye.infoType)))},[t,E,f]),Le=n.useMemo(()=>nt.slice(0,he),[nt,he]),pt=Le.length<nt.length,We=n.useMemo(()=>new Set(Object.keys(F)),[F]),Ue=n.useMemo(()=>Object.values(F),[F]),It=n.useMemo(()=>{const P=new Map;for(const Ae of Ue)P.set(Ae.infoType,(P.get(Ae.infoType)??0)+1);return Array.from(P.entries()).sort((Ae,Ye)=>Ye[1]-Ae[1]||Ae[0].localeCompare(Ye[0]))},[Ue]),Nt=n.useMemo(()=>{if(!W||!Je)return 0;const P=new Set;for(const Ae of Je.items)Ae.childItemType!=="info"||Ae.childItemId!==W||P.add([Ae.parentItemType,Ae.parentItemId,Ae.parentCheckType??"",Ae.parentDirection??""].join("|"));return P.size},[Je,W]);n.useEffect(()=>{Se(Jn);const P=new Set(E.map(Ae=>Ae.infoId));re(Ae=>Ae&&P.has(Ae)?Ae:null)},[E]);const Kt=P=>{ve(Ae=>({...Ae,[P.infoId]:{infoId:P.infoId,infoType:P.infoType,label:P.label}}))},Pt=P=>{ve(Ae=>{if(!Ae[P])return Ae;const Ye={...Ae};return delete Ye[P],Ye})},_t=(P,Ae)=>{if(Ae){Kt(P);return}Pt(P.infoId)},Tt=P=>{l(`/cogita/library/${c}/infos/${encodeURIComponent(P)}`,{replace:!0})},Mt=()=>{l(`/cogita/library/${c}/list`,{replace:!0})},Rt=()=>{W&&l(`/cogita/library/${c}/edit/${encodeURIComponent(W)}`,{replace:!0})},ma=()=>{const P=Pi(c,Ue.map(Ae=>Ae.infoId));P&&l(`/cogita/library/${c}/revision/run?libraryTarget=revisions&scope=info-selection&seed=${encodeURIComponent(P)}`)},Lt=()=>{const P=Fi(c,Ue.map(Ae=>Ae.infoId));P&&l(`/cogita/library/${c}/collections/new?draft=${encodeURIComponent(P)}&draftType=info-selection`)},na=Ue.length===1?((ze=Ue[0])==null?void 0:ze.infoId)??null:null,N=w.selectionCount.replace("{count}",String(Ue.length)),Te=p==="collection"?"grid":p==="detail"?"wide":R,Me=zi(h),lt=Ee?Math.max(0,Math.min(100,Math.round((Ee.score??0)*100))):0,Ge=Ee?qi(Ee,Me):Me.noKnownnessData;return e.jsx(At,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":Te,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[at?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:Me.kicker}),e.jsx("h2",{className:"cogita-card-title",children:$e?Ks($e.payload,$e.infoType,$e.infoId):Me.loading}),$e?e.jsxs("p",{className:"cogita-card-subtitle",children:[gt(t,$e.infoType)," · ",$e.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:Mt,children:Me.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:Rt,disabled:!W||V!=="ready",children:w.editInfo})]})]}),V==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:Me.loading})}):V==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:Me.loadError})}):$e?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Me.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[lt,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${lt}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:Ge})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Me.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(Ee==null?void 0:Ee.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:Me.correct.replace("{correct}",String((Ee==null?void 0:Ee.correctReviews)??0)).replace("{total}",String((Ee==null?void 0:Ee.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:Ee!=null&&Ee.lastReviewedUtc?`${Me.lastReview}: ${Bi(Ee.lastReviewedUtc,h)}`:Me.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Me.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:Nt}),e.jsx("p",{className:"cogita-library-hint",children:Me.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Me.checkcards}),we==="loading"?e.jsx("p",{className:"cogita-library-hint",children:Me.loadingCheckcards}):we==="error"?e.jsx("p",{className:"cogita-library-hint",children:Me.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:Me.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(ut==null?void 0:ut.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:Me.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(be==null?void 0:be.items.length)??0})]})]})]}),mt.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:Me.approach}),e.jsx("select",{value:Oe,onChange:P=>ot(P.target.value),"aria-label":Me.approach,children:mt.map(P=>e.jsx("option",{value:P.approachKey,children:P.label},P.approachKey))})]}),_e==="loading"?e.jsx("p",{className:"cogita-library-hint",children:Me.loadingApproach}):_e==="error"?e.jsx("p",{className:"cogita-library-hint",children:Me.loadApproachError}):wt?e.jsx(xn,{value:wt.projection,emptyLabel:Me.empty}):e.jsx("p",{className:"cogita-library-hint",children:Me.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Me.payload}),e.jsx(xn,{value:$e.payload,emptyLabel:Me.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Me.links}),e.jsx(Vi,{links:$e.links,emptyLabel:Me.noLinks})]})]})]}):null]})}):null,st?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Informacja"}),e.jsx("h2",{className:"cogita-card-title",children:$e?Ks($e.payload,$e.infoType,$e.infoId):W??""}),e.jsx("p",{className:"cogita-card-subtitle",children:"Collections using this info"})]}),e.jsx("div",{className:"cogita-info-overview-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:Mt,children:"Back to search"})})]}),z==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading collections..."})}):null,z==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load collections."})}):null,z==="ready"&&$.length===0?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"This info is not used in any collection yet."})}):null,z==="ready"&&$.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:$.map(P=>e.jsx("article",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`/#/cogita/library/${c}/collections/${P.collectionId}?libraryTarget=collections`,children:[e.jsx("div",{className:"cogita-card-type",children:"Collection"}),e.jsx("h3",{className:"cogita-card-title",children:P.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[P.itemCount," items"]})]})},P.collectionId))}):null]})}):null,!at&&!st?e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":w.typeLabel,value:m,onChange:P=>k(P.target.value),children:ae.map(P=>e.jsx("option",{value:P.value,children:P.label},P.value))}),e.jsx("input",{type:"text",value:I,onChange:P=>x(P.target.value),placeholder:w.searchPlaceholder}),e.jsx("select",{"aria-label":w.sortLabel,value:f,onChange:P=>Q(P.target.value),children:S.map(P=>e.jsx("option",{value:P.value,children:P.label},P.value))}),e.jsxs("select",{"aria-label":w.viewLabel,value:R,onChange:P=>j(P.target.value),children:[e.jsx("option",{value:"details",children:w.viewDetails}),e.jsx("option",{value:"wide",children:w.viewWide}),e.jsx("option",{value:"grid",children:w.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:w.cardCount.replace("{shown}",String(Le.length)).replace("{total}",String(nt.length))}),e.jsx("span",{children:Z==="loading"?w.loading:w.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>L(P=>!P),children:B?w.hideFilters:w.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:w.filtersOptionalHint})]}),B?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsxs("div",{className:"cogita-filter-grid",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:w.typeLabel}),e.jsx("select",{value:m,onChange:P=>k(P.target.value),children:ae.map(P=>e.jsx("option",{value:P.value,children:P.label},`advanced-type:${P.value}`))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Reference"}),e.jsxs("select",{value:J.__referenceId??"",onChange:P=>ue(Ae=>({...Ae,__referenceId:P.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),de.map(P=>e.jsx("option",{value:P.infoId,children:P.label},`reference:${P.infoId}`))]})]}),ct.map(P=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:P.label}),P.kind==="select"?e.jsxs("select",{value:J[P.key]??"",onChange:Ae=>ue(Ye=>({...Ye,[P.key]:Ae.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(P.options??[]).map(Ae=>e.jsx("option",{value:Ae.value,children:Ae.label},`${P.key}:${Ae.value}`))]}):e.jsx("input",{type:"text",value:J[P.key]??"",onChange:Ae=>ue(Ye=>({...Ye,[P.key]:Ae.target.value}))})]},`type-filter:${P.key}`))]})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:N}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{ve(P=>{const Ae={...P};for(const Ye of Le)Ae[Ye.infoId]={infoId:Ye.infoId,infoType:Ye.infoType,label:Ye.label};return Ae})},disabled:Le.length===0,children:w.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>ve({}),disabled:Ue.length===0,children:w.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>na&&Tt(na),disabled:!na,title:na?void 0:w.openSelectedDisabled,children:w.openSelected})]})]}),Te==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":w.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:w.detailColumnName}),e.jsx("span",{children:w.detailColumnType}),e.jsx("span",{children:w.detailColumnId}),e.jsx("span",{})]}),Le.length?Le.map(P=>{const Ae=gt(t,P.infoType),Ye=We.has(P.infoId),xt=et===P.infoId;return e.jsxs("div",{className:`cogita-details-row ${xt||Ye?"active":""}`,role:"row",onClick:()=>re(P.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:Ye,onChange:ye=>_t(P,ye.target.checked),onClick:ye=>ye.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:P.label,children:P.label}),e.jsx("span",{title:Ae,children:Ae}),e.jsx("span",{title:P.infoId,children:P.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:ye=>{ye.stopPropagation(),Tt(P.infoId)},"aria-label":w.editInfo,children:">"})]},P.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:w.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${Te}`,"data-view":Te,children:Le.length?Le.map(P=>{const Ae=gt(t,P.infoType),Ye=We.has(P.infoId),xt=et===P.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":xt||Ye,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:Ye,onChange:ye=>_t(P,ye.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>re(P.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:Ae}),e.jsx("h3",{className:"cogita-card-title",children:P.label}),e.jsx("p",{className:"cogita-card-subtitle",children:P.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Tt(P.infoId),children:w.editInfo})]})},P.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:w.noMatch})})}),pt?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>Se(P=>P+Jn),children:w.loadMore})}):null,Ue.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:w.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:w.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:It.map(([P,Ae])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:gt(t,P)}),e.jsx("span",{className:"cogita-tag-count",children:Ae})]},`stack:type:${P}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:ma,disabled:Ue.length===0,children:"Start revision"}),e.jsx("button",{type:"button",className:"ghost",onClick:Lt,disabled:Ue.length===0,children:"Create collection from selection"})]})]}):null]}):null]})})})})}function Ks(t,a,s){if(t&&typeof t=="object"&&!Array.isArray(t)){const r=t,i=["title","name","label","value","text","quote","term"];for(const u of i){const o=r[u];if(typeof o=="string"&&o.trim())return o.trim()}}return`${a} · ${s}`}function Bi(t,a){try{const s=a==="pl"?"pl-PL":a==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(s,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function zi(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function qi(t,a){return t.totalReviews<=0?a.noKnownnessData:t.totalReviews<3||t.score<.35?a.developmentStart:t.totalReviews<8||t.score<.65?a.developmentGrowing:t.score<.85?a.developmentStable:a.developmentStrong}function Vi({links:t,emptyLabel:a}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:a}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([s,r])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(r)?r.length?e.jsx("div",{className:"cogita-selection-overview",children:r.map(i=>e.jsx("span",{className:"cogita-tag-chip",children:i},`${s}:${i}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):r?e.jsx("span",{className:"cogita-tag-chip",children:r}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},s))})}function xn({value:t,emptyLabel:a}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:a});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((s,r)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(xn,{value:s,emptyLabel:a})})]},r))});if(typeof t=="object"){const s=Object.entries(t);return s.length===0?e.jsx("p",{className:"cogita-library-hint",children:a}):e.jsx("div",{className:"cogita-info-tree",children:s.map(([r,i])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(xn,{value:i,emptyLabel:a})})]},r))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const Ma=5,_s=50,Ds=2,Bs=[];function Yt({libraryId:t,infoType:a,label:s,placeholder:r,value:i,onChange:u,values:o,onChangeMultiple:y,helperText:h,searchFailedText:b,createFailedText:c,createLabel:p,savingLabel:l,loadMoreLabel:d,allowCreate:w=!0,inputRef:m,autoAdvance:k,onCommit:I,multiple:x}){const f=x?o??Bs:Bs,[Q,R]=n.useState(x?"":(i==null?void 0:i.label)??""),[j,B]=n.useState([]),[L,Z]=n.useState(Ma),[q,E]=n.useState(-1),[O,he]=n.useState(!1),[Se,et]=n.useState(!1),[re,F]=n.useState(null),ve=n.useRef(0),J=n.useRef(new Map),ue=n.useMemo(()=>w?x?Q.trim().length>0:Q.trim().length>0&&!i:!1,[w,Q,i,x]);n.useEffect(()=>{x||R((i==null?void 0:i.label)??"")},[i,x]),n.useEffect(()=>{const de=Q.trim();if(!de||de.length<Ds){B([]),he(!1),Z(Ma),E(-1),et(!1),F(null);return}const se=de.toLowerCase(),$e=`${t}:${a}:${se}`,ie=J.current.get($e);if(ie){if(x&&f.length>0){const Be=new Set(f.map(Je=>Je.id));B(ie.filter(Je=>!Be.has(Je.id)))}else B(ie);Z(Ma),E(-1),he(ie.length>0),et(!1),F(null);return}const Ee=window.setTimeout(async()=>{const Be=Date.now();ve.current=Be,et(!0),F(null);try{const Je=await bs({libraryId:t,type:a,query:de,limit:_s});if(ve.current!==Be)return;const it=Je.slice(0,_s).map(V=>({id:V.infoId,label:V.label,infoType:V.infoType}));if(J.current.set($e,it),x&&f.length>0){const V=new Set(f.map(ke=>ke.id));B(it.filter(ke=>!V.has(ke.id)))}else B(it);Z(Ma),E(-1),he(!0)}catch{if(ve.current!==Be)return;F(b??"Search failed.")}finally{ve.current===Be&&et(!1)}},250);return()=>window.clearTimeout(Ee)},[t,a,Q,f]);const ne=de=>{if(x){const se=f.some($e=>$e.id===de.id)?f:[...f,de];y==null||y(se),R(""),he(!1),E(-1);return}u==null||u(de),R(de.label),he(!1),E(-1),k&&(I==null||I())},je=async()=>{const de=Q.trim();if(de){et(!0),F(null);try{const se=await os({libraryId:t,infoType:a,payload:{label:de}}),$e={id:se.infoId,label:de,infoType:se.infoType};if(de.length>=Ds){const ie=`${t}:${a}:${de.toLowerCase()}`,Ee=J.current.get(ie)??[];J.current.set(ie,[$e,...Ee])}if(x){y==null||y([...f,$e]),R(""),he(!1),E(-1);return}u==null||u($e),he(!1),E(-1),k&&(I==null||I())}catch{F(c??"Create failed.")}finally{et(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:s}),e.jsx("input",{value:Q,placeholder:r,onChange:de=>{R(de.target.value),!x&&i&&(u==null||u(null))},onKeyDown:de=>{if(de.key==="ArrowDown"){if(de.preventDefault(),!j.length)return;he(!0),E(se=>{const $e=Math.min(j.length,L)-1,ie=se<0?0:Math.min(se+1,$e);return ie===$e&&j.length>L?(Z(Ee=>Math.min(Ee+Ma,j.length)),Math.min(se+1,Math.min(j.length,L+Ma)-1)):ie});return}if(de.key==="ArrowUp"){if(de.preventDefault(),!j.length)return;he(!0),E(se=>se<=0?0:se-1);return}if(de.key==="Enter"){if(de.preventDefault(),q>=0&&j[q]){ne(j[q]);return}if(ue){je();return}}},onFocus:()=>{j.length>0&&he(!0)},autoComplete:"off",ref:m})]}),x&&f.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:f.map(de=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>y==null?void 0:y(f.filter(se=>se.id!==de.id)),children:[de.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},de.id))}),h&&e.jsx("p",{className:"cogita-help",children:h}),re&&e.jsx("p",{className:"cogita-error",children:re}),O&&j.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[j.slice(0,L).map((de,se)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":se===q,onClick:()=>ne(de),children:[e.jsx("strong",{children:de.label}),e.jsx("span",{children:de.infoType})]},de.id)),L<j.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>Z(de=>Math.min(de+Ma,j.length)),children:d??"Load more"})]}),ue&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:je,disabled:Se,children:Se?l??"Saving...":p??`Create new ${a}`})]})}const zs=[{id:"gen",la:{abbr:"Gen",name:"Genesis"},en:{abbr:"Gen",name:"Genesis"},de:{abbr:"Gen",name:"Genesis"},pl:{abbr:"Rdz",name:"Księga Rodzaju"}},{id:"ex",la:{abbr:"Ex",name:"Exodus"},en:{abbr:"Ex",name:"Exodus"},de:{abbr:"Ex",name:"Exodus"},pl:{abbr:"Wj",name:"Księga Wyjścia"}},{id:"lev",la:{abbr:"Lev",name:"Leviticus"},en:{abbr:"Lev",name:"Leviticus"},de:{abbr:"Lev",name:"Levitikus"},pl:{abbr:"Kpł",name:"Księga Kapłańska"}},{id:"num",la:{abbr:"Num",name:"Numeri"},en:{abbr:"Num",name:"Numbers"},de:{abbr:"Num",name:"Numeri"},pl:{abbr:"Lb",name:"Księga Liczb"}},{id:"deut",la:{abbr:"Deut",name:"Deuteronomium"},en:{abbr:"Deut",name:"Deuteronomy"},de:{abbr:"Dtn",name:"Deuteronomium"},pl:{abbr:"Pwt",name:"Księga Powtórzonego Prawa"}},{id:"ios",la:{abbr:"Ios",name:"Iosue"},en:{abbr:"Josh",name:"Joshua"},de:{abbr:"Jos",name:"Josua"},pl:{abbr:"Joz",name:"Księga Jozuego"}},{id:"iudg",la:{abbr:"Iudg",name:"Iudicum"},en:{abbr:"Judg",name:"Judges"},de:{abbr:"Ri",name:"Richter"},pl:{abbr:"Sdz",name:"Księga Sędziów"}},{id:"ruth",la:{abbr:"Ruth",name:"Ruth"},en:{abbr:"Ruth",name:"Ruth"},de:{abbr:"Rut",name:"Rut"},pl:{abbr:"Rt",name:"Księga Rut"}},{id:"1sam",la:{abbr:"1 Sam",name:"I Samuelis"},en:{abbr:"1 Sam",name:"1 Samuel"},de:{abbr:"1 Sam",name:"1 Samuel"},pl:{abbr:"1 Sm",name:"1 Księga Samuela"}},{id:"2sam",la:{abbr:"2 Sam",name:"II Samuelis"},en:{abbr:"2 Sam",name:"2 Samuel"},de:{abbr:"2 Sam",name:"2 Samuel"},pl:{abbr:"2 Sm",name:"2 Księga Samuela"}},{id:"1reg",la:{abbr:"1 Reg",name:"I Regum"},en:{abbr:"1 Kgs",name:"1 Kings"},de:{abbr:"1 Kön",name:"1 Könige"},pl:{abbr:"1 Krl",name:"1 Księga Królewska"}},{id:"2reg",la:{abbr:"2 Reg",name:"II Regum"},en:{abbr:"2 Kgs",name:"2 Kings"},de:{abbr:"2 Kön",name:"2 Könige"},pl:{abbr:"2 Krl",name:"2 Księga Królewska"}},{id:"1par",la:{abbr:"1 Par",name:"I Paralipomenon"},en:{abbr:"1 Chr",name:"1 Chronicles"},de:{abbr:"1 Chr",name:"1 Chronik"},pl:{abbr:"1 Krn",name:"1 Księga Kronik"}},{id:"2par",la:{abbr:"2 Par",name:"II Paralipomenon"},en:{abbr:"2 Chr",name:"2 Chronicles"},de:{abbr:"2 Chr",name:"2 Chronik"},pl:{abbr:"2 Krn",name:"2 Księga Kronik"}},{id:"esd",la:{abbr:"Esd",name:"Esdrae"},en:{abbr:"Ezra",name:"Ezra"},de:{abbr:"Esra",name:"Esra"},pl:{abbr:"Ezd",name:"Księga Ezdrasza"}},{id:"neh",la:{abbr:"Neh",name:"Nehemiae"},en:{abbr:"Neh",name:"Nehemiah"},de:{abbr:"Neh",name:"Nehemia"},pl:{abbr:"Ne",name:"Księga Nehemiasza"}},{id:"tob",la:{abbr:"Tob",name:"Tobiae"},en:{abbr:"Tob",name:"Tobit"},de:{abbr:"Tob",name:"Tobit"},pl:{abbr:"Tb",name:"Księga Tobiasza"}},{id:"iudt",la:{abbr:"Iudt",name:"Iudith"},en:{abbr:"Jdt",name:"Judith"},de:{abbr:"Jdt",name:"Judit"},pl:{abbr:"Jdt",name:"Księga Judyty"}},{id:"est",la:{abbr:"Est",name:"Esther"},en:{abbr:"Est",name:"Esther"},de:{abbr:"Est",name:"Ester"},pl:{abbr:"Est",name:"Księga Estery"}},{id:"1macc",la:{abbr:"1 Macc",name:"I Maccabaeorum"},en:{abbr:"1 Mc",name:"1 Maccabees"},de:{abbr:"1 Makk",name:"1 Makkabäer"},pl:{abbr:"1 Mch",name:"1 Księga Machabejska"}},{id:"2macc",la:{abbr:"2 Macc",name:"II Maccabaeorum"},en:{abbr:"2 Mc",name:"2 Maccabees"},de:{abbr:"2 Makk",name:"2 Makkabäer"},pl:{abbr:"2 Mch",name:"2 Księga Machabejska"}},{id:"iob",la:{abbr:"Iob",name:"Iob"},en:{abbr:"Job",name:"Job"},de:{abbr:"Ijob",name:"Ijob"},pl:{abbr:"Hi",name:"Księga Hioba"}},{id:"ps",la:{abbr:"Ps",name:"Psalmi"},en:{abbr:"Ps",name:"Psalms"},de:{abbr:"Ps",name:"Psalmen"},pl:{abbr:"Ps",name:"Księga Psalmów"}},{id:"prov",la:{abbr:"Prov",name:"Proverbia"},en:{abbr:"Prov",name:"Proverbs"},de:{abbr:"Spr",name:"Sprichwörter"},pl:{abbr:"Prz",name:"Księga Przysłów"}},{id:"ecc",la:{abbr:"Ecc",name:"Ecclesiastes"},en:{abbr:"Eccl",name:"Ecclesiastes"},de:{abbr:"Koh",name:"Kohelet"},pl:{abbr:"Koh",name:"Księga Koheleta"}},{id:"cant",la:{abbr:"Cant",name:"Canticum Canticorum"},en:{abbr:"Song",name:"Song of Songs"},de:{abbr:"Hld",name:"Hoheslied"},pl:{abbr:"Pnp",name:"Pieśń nad Pieśniami"}},{id:"sap",la:{abbr:"Sap",name:"Sapientia"},en:{abbr:"Wis",name:"Wisdom"},de:{abbr:"Weish",name:"Weisheit"},pl:{abbr:"Mdr",name:"Księga Mądrości"}},{id:"sir",la:{abbr:"Sir",name:"Ecclesiasticus (Sirach)"},en:{abbr:"Sir",name:"Sirach"},de:{abbr:"Sir",name:"Jesus Sirach"},pl:{abbr:"Syr",name:"Mądrość Syracha"}},{id:"isa",la:{abbr:"Isa",name:"Isaias"},en:{abbr:"Isa",name:"Isaiah"},de:{abbr:"Jes",name:"Jesaja"},pl:{abbr:"Iz",name:"Księga Izajasza"}},{id:"ier",la:{abbr:"Ier",name:"Ieremias"},en:{abbr:"Jer",name:"Jeremiah"},de:{abbr:"Jer",name:"Jeremia"},pl:{abbr:"Jr",name:"Księga Jeremiasza"}},{id:"lam",la:{abbr:"Lam",name:"Lamentationes"},en:{abbr:"Lam",name:"Lamentations"},de:{abbr:"Klgl",name:"Klagelieder"},pl:{abbr:"Lm",name:"Lamentacje"}},{id:"bar",la:{abbr:"Bar",name:"Baruch"},en:{abbr:"Bar",name:"Baruch"},de:{abbr:"Bar",name:"Baruch"},pl:{abbr:"Ba",name:"Księga Barucha"}},{id:"ez",la:{abbr:"Ez",name:"Ezechiel"},en:{abbr:"Ezek",name:"Ezekiel"},de:{abbr:"Ez",name:"Ezechiel"},pl:{abbr:"Ez",name:"Księga Ezechiela"}},{id:"dan",la:{abbr:"Dan",name:"Daniel"},en:{abbr:"Dan",name:"Daniel"},de:{abbr:"Dan",name:"Daniel"},pl:{abbr:"Dn",name:"Księga Daniela"}},{id:"hos",la:{abbr:"Hos",name:"Osee"},en:{abbr:"Hos",name:"Hosea"},de:{abbr:"Hos",name:"Hosea"},pl:{abbr:"Oz",name:"Księga Ozeasza"}},{id:"ioel",la:{abbr:"Ioel",name:"Ioel"},en:{abbr:"Joel",name:"Joel"},de:{abbr:"Joel",name:"Joel"},pl:{abbr:"Jl",name:"Księga Joela"}},{id:"amos",la:{abbr:"Amos",name:"Amos"},en:{abbr:"Am",name:"Amos"},de:{abbr:"Am",name:"Amos"},pl:{abbr:"Am",name:"Księga Amosa"}},{id:"abd",la:{abbr:"Abd",name:"Abdias"},en:{abbr:"Obad",name:"Obadiah"},de:{abbr:"Obd",name:"Obadja"},pl:{abbr:"Abd",name:"Księga Abdiasza"}},{id:"ion",la:{abbr:"Ion",name:"Ionas"},en:{abbr:"Jon",name:"Jonah"},de:{abbr:"Jona",name:"Jona"},pl:{abbr:"Jon",name:"Księga Jonasza"}},{id:"mich",la:{abbr:"Mich",name:"Michaeas"},en:{abbr:"Mic",name:"Micah"},de:{abbr:"Mi",name:"Micha"},pl:{abbr:"Mi",name:"Księga Micheasza"}},{id:"nah",la:{abbr:"Nah",name:"Nahum"},en:{abbr:"Nah",name:"Nahum"},de:{abbr:"Nah",name:"Nahum"},pl:{abbr:"Na",name:"Księga Nahuma"}},{id:"hab",la:{abbr:"Hab",name:"Habacuc"},en:{abbr:"Hab",name:"Habakkuk"},de:{abbr:"Hab",name:"Habakuk"},pl:{abbr:"Ha",name:"Księga Habakuka"}},{id:"soph",la:{abbr:"Soph",name:"Sophonias"},en:{abbr:"Zeph",name:"Zephaniah"},de:{abbr:"Zef",name:"Zefanja"},pl:{abbr:"So",name:"Księga Sofoniasza"}},{id:"agg",la:{abbr:"Agg",name:"Aggaeus"},en:{abbr:"Hag",name:"Haggai"},de:{abbr:"Hag",name:"Haggai"},pl:{abbr:"Ag",name:"Księga Aggeusza"}},{id:"zach",la:{abbr:"Zach",name:"Zacharias"},en:{abbr:"Zech",name:"Zechariah"},de:{abbr:"Sach",name:"Sacharja"},pl:{abbr:"Za",name:"Księga Zachariasza"}},{id:"mal",la:{abbr:"Mal",name:"Malachias"},en:{abbr:"Mal",name:"Malachi"},de:{abbr:"Mal",name:"Maleachi"},pl:{abbr:"Ml",name:"Księga Malachiasza"}},{id:"mt",la:{abbr:"Mt",name:"Matthaeus"},en:{abbr:"Matt",name:"Matthew"},de:{abbr:"Mt",name:"Matthäus"},pl:{abbr:"Mt",name:"Ewangelia wg św. Mateusza"}},{id:"mc",la:{abbr:"Mc",name:"Marcus"},en:{abbr:"Mark",name:"Mark"},de:{abbr:"Mk",name:"Markus"},pl:{abbr:"Mk",name:"Ewangelia wg św. Marka"}},{id:"lc",la:{abbr:"Lc",name:"Lucas"},en:{abbr:"Luke",name:"Luke"},de:{abbr:"Lk",name:"Lukas"},pl:{abbr:"Łk",name:"Ewangelia wg św. Łukasza"}},{id:"io",la:{abbr:"Io",name:"Ioannes"},en:{abbr:"John",name:"John"},de:{abbr:"Joh",name:"Johannes"},pl:{abbr:"J",name:"Ewangelia wg św. Jana"}},{id:"act",la:{abbr:"Act",name:"Actus Apostolorum"},en:{abbr:"Acts",name:"Acts"},de:{abbr:"Apg",name:"Apostelgeschichte"},pl:{abbr:"Dz",name:"Dzieje Apostolskie"}},{id:"rom",la:{abbr:"Rom",name:"ad Romanos"},en:{abbr:"Rom",name:"Romans"},de:{abbr:"Röm",name:"Römer"},pl:{abbr:"Rz",name:"List do Rzymian"}},{id:"1cor",la:{abbr:"1 Cor",name:"I ad Corinthios"},en:{abbr:"1 Cor",name:"1 Corinthians"},de:{abbr:"1 Kor",name:"1 Korinther"},pl:{abbr:"1 Kor",name:"1 List do Koryntian"}},{id:"2cor",la:{abbr:"2 Cor",name:"II ad Corinthios"},en:{abbr:"2 Cor",name:"2 Corinthians"},de:{abbr:"2 Kor",name:"2 Korinther"},pl:{abbr:"2 Kor",name:"2 List do Koryntian"}},{id:"gal",la:{abbr:"Gal",name:"ad Galatas"},en:{abbr:"Gal",name:"Galatians"},de:{abbr:"Gal",name:"Galater"},pl:{abbr:"Ga",name:"List do Galatów"}},{id:"eph",la:{abbr:"Eph",name:"ad Ephesios"},en:{abbr:"Eph",name:"Ephesians"},de:{abbr:"Eph",name:"Epheser"},pl:{abbr:"Ef",name:"List do Efezjan"}},{id:"phil",la:{abbr:"Phil",name:"ad Philippenses"},en:{abbr:"Phil",name:"Philippians"},de:{abbr:"Phil",name:"Philipper"},pl:{abbr:"Flp",name:"List do Filipian"}},{id:"col",la:{abbr:"Col",name:"ad Colossenses"},en:{abbr:"Col",name:"Colossians"},de:{abbr:"Kol",name:"Kolosser"},pl:{abbr:"Kol",name:"List do Kolosan"}},{id:"1thess",la:{abbr:"1 Thess",name:"I ad Thessalonicenses"},en:{abbr:"1 Thess",name:"1 Thessalonians"},de:{abbr:"1 Thess",name:"1 Thessalonicher"},pl:{abbr:"1 Tes",name:"1 List do Tesaloniczan"}},{id:"2thess",la:{abbr:"2 Thess",name:"II ad Thessalonicenses"},en:{abbr:"2 Thess",name:"2 Thessalonians"},de:{abbr:"2 Thess",name:"2 Thessalonicher"},pl:{abbr:"2 Tes",name:"2 List do Tesaloniczan"}},{id:"1tim",la:{abbr:"1 Tim",name:"I ad Timotheum"},en:{abbr:"1 Tim",name:"1 Timothy"},de:{abbr:"1 Tim",name:"1 Timotheus"},pl:{abbr:"1 Tm",name:"1 List do Tymoteusza"}},{id:"2tim",la:{abbr:"2 Tim",name:"II ad Timotheum"},en:{abbr:"2 Tim",name:"2 Timothy"},de:{abbr:"2 Tim",name:"2 Timotheus"},pl:{abbr:"2 Tm",name:"2 List do Tymoteusza"}},{id:"tit",la:{abbr:"Tit",name:"ad Titum"},en:{abbr:"Titus",name:"Titus"},de:{abbr:"Tit",name:"Titus"},pl:{abbr:"Tt",name:"List do Tytusa"}},{id:"phlm",la:{abbr:"Phlm",name:"ad Philemonem"},en:{abbr:"Phlm",name:"Philemon"},de:{abbr:"Phlm",name:"Philemon"},pl:{abbr:"Flm",name:"List do Filemona"}},{id:"heb",la:{abbr:"Heb",name:"ad Hebraeos"},en:{abbr:"Heb",name:"Hebrews"},de:{abbr:"Hebr",name:"Hebräer"},pl:{abbr:"Hbr",name:"List do Hebrajczyków"}},{id:"iac",la:{abbr:"Iac",name:"Iacobi"},en:{abbr:"Jas",name:"James"},de:{abbr:"Jak",name:"Jakobus"},pl:{abbr:"Jk",name:"List św. Jakuba"}},{id:"1pet",la:{abbr:"1 Pet",name:"I Petri"},en:{abbr:"1 Pet",name:"1 Peter"},de:{abbr:"1 Petr",name:"1 Petrus"},pl:{abbr:"1 P",name:"1 List św. Piotra"}},{id:"2pet",la:{abbr:"2 Pet",name:"II Petri"},en:{abbr:"2 Pet",name:"2 Peter"},de:{abbr:"2 Petr",name:"2 Petrus"},pl:{abbr:"2 P",name:"2 List św. Piotra"}},{id:"1io",la:{abbr:"1 Io",name:"I Ioannis"},en:{abbr:"1 John",name:"1 John"},de:{abbr:"1 Joh",name:"1 Johannes"},pl:{abbr:"1 J",name:"1 List św. Jana"}},{id:"2io",la:{abbr:"2 Io",name:"II Ioannis"},en:{abbr:"2 John",name:"2 John"},de:{abbr:"2 Joh",name:"2 Johannes"},pl:{abbr:"2 J",name:"2 List św. Jana"}},{id:"3io",la:{abbr:"3 Io",name:"III Ioannis"},en:{abbr:"3 John",name:"3 John"},de:{abbr:"3 Joh",name:"3 Johannes"},pl:{abbr:"3 J",name:"3 List św. Jana"}},{id:"iud",la:{abbr:"Iud",name:"Iudae"},en:{abbr:"Jude",name:"Jude"},de:{abbr:"Jud",name:"Judas"},pl:{abbr:"Jud",name:"List św. Judy"}},{id:"apoc",la:{abbr:"Apoc",name:"Apocalypsis Ioannis"},en:{abbr:"Rev",name:"Revelation"},de:{abbr:"Offb",name:"Offenbarung"},pl:{abbr:"Ap",name:"Apokalipsa św. Jana"}}],qs=8;function Vs({libraryId:t,copy:a,language:s,sourceKindOptions:r,value:i,onChange:u,labels:o}){const[y,h]=n.useState(!1),[b,c]=n.useState(-1),p=n.useMemo(()=>{const m=s;return zs.map(k=>{var f;const I=(k==null?void 0:k[m])??(k==null?void 0:k.en)??(k==null?void 0:k.la);return{label:`${I.abbr} — ${I.name}`,latin:((f=k==null?void 0:k.la)==null?void 0:f.abbr)??I.abbr}})},[s]),l=(m,k=!1)=>{const I=m.trim().toLowerCase();return I?p.filter(x=>x.label.toLowerCase().includes(I)).slice(0,qs):k?p.slice(0,qs):[]},d=(m,k)=>{const I=m.trim().toLowerCase();if(!I)return null;const x=zs;for(const f of x){const Q=f==null?void 0:f.la,R=(f==null?void 0:f[k])??(f==null?void 0:f.en)??Q,j=(R==null?void 0:R.abbr)??"",B=(R==null?void 0:R.name)??"";if(j.toLowerCase()===I||B.toLowerCase()===I||`${j} — ${B}`.toLowerCase()===I)return{book:f,entry:R,la:Q}}return null};n.useEffect(()=>{if(i.sourceKind==="bible"&&i.locatorValue&&!y){const m=d(i.locatorValue,s);if(m){const k=`${m.entry.abbr} — ${m.entry.name}`;k!==i.bibleBookDisplay&&u({...i,bibleBookDisplay:k})}}},[s,i,y,u]);const w=m=>u({...i,...m});return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.sourceKindLabel}),e.jsx("select",{value:i.sourceKind,onChange:m=>w({sourceKind:m.target.value,churchDocument:null,bookMedia:null,work:null,locatorValue:"",locatorAux:"",bibleBookDisplay:""}),children:r.map(m=>e.jsx("option",{value:m.value,children:m.label},m.value))})]}),i.sourceKind==="bible"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-lookup full",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.bibleBookLabel}),e.jsx("input",{type:"text",value:i.bibleBookDisplay,onChange:m=>{const k=m.target.value;w({bibleBookDisplay:k,locatorValue:""}),h(!0),c(-1)},onKeyDown:m=>{var I;const k=l(i.bibleBookDisplay);if(k.length){if(m.key==="ArrowDown")m.preventDefault(),c(x=>Math.min(x+1,k.length-1));else if(m.key==="ArrowUp")m.preventDefault(),c(x=>Math.max(x-1,0));else if((m.key==="Enter"||m.key==="Tab")&&b>=0&&k[b]){const x=k[b],f=d(x.label,s);if(!f)return;w({bibleBookDisplay:x.label,locatorValue:((I=f.la)==null?void 0:I.abbr)??i.locatorValue}),h(!1)}}},onFocus:()=>h(!0),onBlur:()=>window.setTimeout(()=>h(!1),100),placeholder:o.bibleBookPlaceholder})]}),y&&l(i.bibleBookDisplay,!0).length>0&&e.jsx("div",{className:"cogita-lookup-results",children:l(i.bibleBookDisplay,!0).map((m,k)=>e.jsx("button",{type:"button",className:"cogita-lookup-option","data-active":k===b,tabIndex:-1,onMouseDown:()=>{var x;const I=d(m.label,s);I&&w({bibleBookDisplay:m.label,locatorValue:((x=I.la)==null?void 0:x.abbr)??i.locatorValue})},children:e.jsx("strong",{children:m.label})},m.latin))})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.bibleRestLabel}),e.jsx("input",{type:"text",value:i.locatorAux,onChange:m=>w({locatorAux:m.target.value}),placeholder:o.bibleRestPlaceholder})]})]}),i.sourceKind==="website"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:a.cogita.library.add.info.sourceUrlLabel}),e.jsx("input",{type:"text",value:i.sourceUrl,onChange:m=>w({sourceUrl:m.target.value}),placeholder:a.cogita.library.add.info.sourceUrlPlaceholder})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:a.cogita.library.add.info.sourceAccessedDateLabel}),e.jsx("input",{type:"text",value:i.sourceAccessedDate,onChange:m=>w({sourceAccessedDate:m.target.value}),placeholder:a.cogita.library.add.info.sourceAccessedDatePlaceholder})]})]}),i.sourceKind==="number_document"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:t,infoType:"work",label:o.churchDocumentLabel,placeholder:o.churchDocumentPlaceholder,value:i.churchDocument,onChange:m=>w({churchDocument:m}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.work),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:m=>w({locatorValue:m.target.value}),placeholder:o.locatorPlaceholder})]})]}),i.sourceKind==="work"&&e.jsx(Yt,{libraryId:t,infoType:"work",label:o.workLabel,placeholder:o.workPlaceholder,value:i.work,onChange:m=>w({work:m}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.work),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),i.sourceKind==="book"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:t,infoType:"media",label:o.bookLabel,placeholder:o.bookPlaceholder,value:i.bookMedia,onChange:m=>w({bookMedia:m}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.media),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:m=>w({locatorValue:m.target.value}),placeholder:o.locatorPlaceholder})]})]}),i.sourceKind!=="website"&&i.sourceKind!=="bible"&&i.sourceKind!=="book"&&i.sourceKind!=="number_document"&&e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:m=>w({locatorValue:m.target.value}),placeholder:o.locatorPlaceholder})]})]})}const Wa=JSON.stringify({type:"selection",title:"Question title",question:"Question text",options:["Option A","Option B","Option C"],answer:[0]},null,2);function hn(t="selection"){return t==="matching"?{type:t,title:"",question:"",columns:[[""],[""]],answer:{paths:[]},matchingPaths:[["",""]]}:t==="ordering"?{type:t,title:"",question:"",options:[""]}:t==="truefalse"?{type:t,title:"",question:"",answer:!0}:t==="text"||t==="date"?{type:t,title:"",question:"",answer:""}:t==="number"?{type:t,title:"",question:"",answer:""}:{type:t,title:"",question:"",options:[""],answer:[]}}function Oi(t){return["selection","truefalse","text","number","date","matching","ordering"].includes(t)}function Da(t){if(!t||typeof t!="object")return null;const a=t,s=typeof a.type=="string"?a.type:typeof a.kind=="string"?a.kind:"selection",r=s==="multi_select"||s==="single_select"?"selection":s==="boolean"?"truefalse":s==="order"?"ordering":s==="short"||s==="open"||s==="short_text"?"text":s,i=Oi(r)?r:"selection",u=typeof a.title=="string"?a.title:"",o=typeof a.question=="string"?a.question:"";if(i==="matching"){let b=[];Array.isArray(a.columns)?b=a.columns.map(m=>Array.isArray(m)?m.map(k=>typeof k=="string"?k:""):[""]):Array.isArray(a.left)&&Array.isArray(a.right)&&(b=[a.left.map(m=>typeof m=="string"?m:""),a.right.map(m=>typeof m=="string"?m:"")]),b.length<2&&(b=[[""],[""]]);const c=a.answer&&typeof a.answer=="object"?a.answer:null,l=(Array.isArray(c==null?void 0:c.paths)?c==null?void 0:c.paths:Array.isArray(a.correctPairs)?a.correctPairs:[]).map(m=>Array.isArray(m)?m.map(k=>Number(k)).filter(k=>Number.isInteger(k)&&k>=0):[]).filter(m=>m.length>0),d=Array.isArray(a.matchingPaths)?a.matchingPaths.map(m=>Array.isArray(m)?Array.from({length:b.length},(k,I)=>String(m[I]??"")):new Array(b.length).fill("")):null,w=d&&d.length>0?d:[...l.map(m=>m.map(String)),new Array(b.length).fill("")];return{type:i,title:u,question:o,columns:b,answer:{paths:l},matchingPaths:w}}if(i==="ordering"){const b=Array.isArray(a.options)?a.options.map(c=>typeof c=="string"?c:""):Array.isArray(a.items)?a.items.map(c=>typeof c=="string"?c:""):[""];return{type:i,title:u,question:o,options:b.length?b:[""]}}if(i==="truefalse"){const b=typeof a.answer=="boolean"?a.answer:typeof a.expected=="boolean"?a.expected:!0;return{type:i,title:u,question:o,answer:b}}if(i==="number")return typeof a.answer=="number"?{type:i,title:u,question:o,answer:a.answer}:typeof a.answer=="string"?{type:i,title:u,question:o,answer:a.answer}:typeof a.expected=="number"?{type:i,title:u,question:o,answer:a.expected}:{type:i,title:u,question:o,answer:""};if(i==="text"||i==="date"){const b=typeof a.answer=="string"?a.answer:typeof a.expected=="string"?a.expected:"";return{type:i,title:u,question:o,answer:b}}const y=Array.isArray(a.options)?a.options.map(b=>typeof b=="string"?b:""):[""],h=Array.isArray(a.answer)?a.answer.map(b=>Number(b)).filter(b=>Number.isInteger(b)&&b>=0):Array.isArray(a.correct)?a.correct.map(b=>Number(b)).filter(b=>Number.isInteger(b)&&b>=0):[];return{type:i,title:u,question:o,options:y.length?y:[""],answer:h}}function Qn(t){const a=(t.title??"").trim(),s=(t.question??"").trim();switch(t.type){case"matching":{const r=(t.columns??[[""],[""]]).map(p=>p.map(l=>l.trim()).filter(Boolean)).filter(p=>p.length>0),i=r.length>=2?r:[[""],[""]],u=t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[],o=(t.matchingPaths??[]).map(p=>p.map(l=>String(l??""))),y=i.length,h=o.map(p=>p.slice(0,y).map(l=>l.trim())).filter(p=>p.some(Boolean)).map(p=>p.map(l=>Number(l))).filter(p=>p.length===y&&p.every(l=>Number.isInteger(l)&&l>=0)),b=(Array.isArray(u)?u:[]).map(p=>Array.isArray(p)?p.map(l=>Number(l)).filter(l=>Number.isInteger(l)&&l>=0):[]).filter(p=>p.length===y),c=Array.from(new Set([...b,...h].map(p=>JSON.stringify(p)))).map(p=>JSON.parse(p));return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,columns:i,answer:{paths:c}},null,2)}case"ordering":{const r=(t.options??[]).map(i=>i.trim()).filter(Boolean);return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,options:r},null,2)}case"truefalse":return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,answer:!!t.answer},null,2);case"number":return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,answer:typeof t.answer=="number"||typeof t.answer=="string"?t.answer:""},null,2);case"date":case"text":return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,answer:String(t.answer??"")},null,2);case"selection":default:{const r=(t.options??[]).map(o=>o.trim()).filter(Boolean),i=Array.isArray(t.answer)?t.answer:[],u=Array.from(new Set(i.filter(o=>Number.isInteger(o)&&o>=0&&o<r.length))).sort((o,y)=>o-y);return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,options:r,answer:u},null,2)}}}const Os=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}];function Ya(){return{sourceKind:"string",locatorValue:"",locatorAux:"",bibleBookDisplay:"",sourceUrl:"",sourceAccessedDate:"",churchDocument:null,bookMedia:null,work:null}}function Us(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function Js(t,a){if(!t||typeof t!="object")return a;const s=t,r=s.definition&&typeof s.definition=="object"?s.definition:null,i=[s.label,s.name,s.title,s.text,s.orcid,s.email,s.number];r&&i.unshift(r.title,r.question);for(const u of i)if(typeof u=="string"&&u.trim())return u.trim();return a}function Qs(t,a){var r;if(!(t instanceof ys))return a;const s=(r=t.message)==null?void 0:r.trim();if(!s)return a;try{const i=JSON.parse(s);if(typeof i.error=="string"&&i.error.trim())return i.error.trim()}catch{}return s}function Ui(t){const a=t.trim();if(!a)return null;try{const s=JSON.parse(a);return s&&typeof s=="object"&&!Array.isArray(s)?s:null}catch{return null}}function oa(t,a){const s=t==null?void 0:t[a];return typeof s=="string"?s:""}function Ji(t,a){return a?t==="book"&&a.infoType==="media"?{bookMedia:a}:t==="work"&&a.infoType==="work"?{work:a}:t==="number_document"&&a.infoType==="work"?{churchDocument:a}:{}:{}}function Qi(t,a){const s=Ya(),r=(t.sourceKind??"").trim()||s.sourceKind,i=t.locator??"",u=Ui(i);let o="",y="",h="",b="",c="";return r==="website"?(b=oa(u,"url"),c=oa(u,"accessedDate"),o=oa(u,"value")):r==="bible"?(o=oa(u,"book")||i.trim(),y=oa(u,"passage")||oa(u,"rest"),h=oa(u,"bookDisplay")):u?(o=oa(u,"value")||oa(u,"locator"),y=oa(u,"aux")):o=i,{...s,sourceKind:r,locatorValue:o,locatorAux:y,bibleBookDisplay:h,sourceUrl:b,sourceAccessedDate:c,...Ji(r,a)}}function Hn(t){return t.sourceKind==="book"?t.bookMedia:t.sourceKind==="work"?t.work:t.sourceKind==="number_document"?t.churchDocument:null}function Wn(t){const a=t.locatorValue.trim(),s=t.locatorAux.trim(),r=t.sourceUrl.trim(),i=t.sourceAccessedDate.trim();switch(t.sourceKind){case"website":return{url:r,accessedDate:i};case"bible":return{book:a,bookDisplay:t.bibleBookDisplay.trim(),passage:s};case"book":case"work":case"number_document":return s?{value:a,aux:s}:a;default:return s?{value:a,aux:s}:a}}function Hs(t){var i,u,o;const a=t.locatorValue.trim(),s=t.locatorAux.trim(),r=[a,s].filter(Boolean).join(" ");switch(t.sourceKind){case"website":return t.sourceUrl.trim()||"website";case"bible":return r||"bible";case"book":return[(i=t.bookMedia)==null?void 0:i.label,r].filter(Boolean).join(" · ")||"book";case"work":return[(u=t.work)==null?void 0:u.label,r].filter(Boolean).join(" · ")||"work";case"number_document":return[(o=t.churchDocument)==null?void 0:o.label,r].filter(Boolean).join(" · ")||"number_document";default:return r||t.sourceKind||"source"}}function Ws(t){return t.sourceKind.trim()?t.sourceKind==="website"?!!t.sourceUrl.trim():t.sourceKind==="bible"?!!(t.locatorValue.trim()&&t.locatorAux.trim()):t.sourceKind==="book"?!!t.bookMedia:t.sourceKind==="work"?!!t.work:t.sourceKind==="number_document"?!!(t.churchDocument&&t.locatorValue.trim()):!!t.locatorValue.trim():!1}function Hi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,libraryId:c,editInfoId:p}){var be,fe,we;const{libraryName:l}=ha(c),d=!!p,[w,m]=n.useState([]),[k,I]=n.useState("word"),[x,f]=n.useState({}),[Q,R]=n.useState({}),[j,B]=n.useState({}),[L,Z]=n.useState({}),[q,E]=n.useState(null),[O,he]=n.useState("idle"),[Se,et]=n.useState(Ya),[re,F]=n.useState({}),[ve,J]=n.useState({}),[ue,ne]=n.useState({}),[je,de]=n.useState(null),[se,$e]=n.useState(()=>Da(JSON.parse(Wa))??hn()),[ie,Ee]=n.useState(Wa),[Be,Je]=n.useState([]),[it,V]=n.useState(0),ke=n.useMemo(()=>w.find(M=>M.infoType===k),[k,w]),He=n.useMemo(()=>w.find(M=>M.infoType==="source"),[w]),Pe=n.useMemo(()=>w.map(M=>({value:M.infoType,label:gt(t,M.infoType)})),[t,w]),Oe=M=>{const $=Da(M)??hn(),D=Qn($);$e($),f(z=>({...z,definition:D}))};n.useEffect(()=>{let M=!1;return Dr({libraryId:c}).then($=>{var D;if(!M&&(m($),!d)){const z=(D=$[0])==null?void 0:D.infoType;z&&I(z)}}).catch(()=>{M||m([])}),()=>{M=!0}},[d,c]),n.useEffect(()=>{if(d||!ke)return;const M={},$={},D={},z={};for(const H of ke.payloadFields)ke.infoType==="question"&&H.key==="definition"&&H.inputType==="json"?M[H.key]=Wa:M[H.key]="";for(const H of ke.linkFields)H.multiple?D[H.key]=[]:$[H.key]=null,H.targetTypes.length>0&&(z[H.key]=H.targetTypes[0]);f(M),R($),B(D),Z(z)},[ke==null?void 0:ke.infoType,d]),n.useEffect(()=>{if(k!=="question")return;const M=x.definition??"";if(!M.trim()){const $=Da(JSON.parse(Wa))??hn();$e($),Ee(Wa);return}try{const $=JSON.parse(M),D=Da($);if(!D)return;$e(D),Be.length===0&&Ee(JSON.stringify($,null,2))}catch{}},[x.definition,Be.length,k]),n.useEffect(()=>{if(!d||!p||w.length===0)return;let M=!1;return he("loading"),E(null),(async()=>{const D=await aa({libraryId:c,infoId:p});if(M)return;const z=D.infoType;I(z);const H=w.find(G=>G.infoType===z);if(!H){he("idle");return}const ae=D.payload??{},S={};for(const G of H.payloadFields)S[G.key]=Us(ae[G.key]);f(S);const C=D.links??{}??{},ce={},_={},oe={},v=[];for(const G of H.linkFields){G.targetTypes.length>0&&(oe[G.key]=G.targetTypes[0]);const te=C[G.key];if(G.multiple){const W=Array.isArray(te)?te.filter(Ie=>typeof Ie=="string"):[];_[G.key]=[];for(const Ie of W)v.push(aa({libraryId:c,infoId:Ie}).then(at=>{if(M)return;const st={id:Ie,infoType:at.infoType,label:Js(at.payload,Ie)};oe[G.key]=st.infoType,_[G.key]=[..._[G.key],st]}).catch(()=>{}))}else{const W=typeof te=="string"?te:null;ce[G.key]=null,W&&v.push(aa({libraryId:c,infoId:W}).then(Ie=>{if(M)return;const at={id:W,infoType:Ie.infoType,label:Js(Ie.payload,W)};oe[G.key]=at.infoType,ce[G.key]=at}).catch(()=>{}))}}await Promise.all(v),!M&&(R(ce),B(_),Z(oe),he("idle"))})().catch(()=>{M||(E("Failed to load info details."),he("idle"))}),()=>{M=!0}},[p,d,c,w]),n.useEffect(()=>{k==="source"&&et(Qi(x,Q.resource??null))},[k,x.sourceKind,x.locator,(be=Q.resource)==null?void 0:be.id,(fe=Q.resource)==null?void 0:fe.infoType,(we=Q.resource)==null?void 0:we.label]);const ot=M=>{var H,ae;const $=((H=He==null?void 0:He.payloadFields.find(S=>S.key==="sourceKind"))==null?void 0:H.keepOnCreate)??!1,D=((ae=He==null?void 0:He.linkFields.find(S=>S.key==="resource"))==null?void 0:ae.keepOnCreate)??!1,z=Ya();return z.sourceKind=$?M.sourceKind:z.sourceKind,D&&(z.work=M.work,z.bookMedia=M.bookMedia,z.churchDocument=M.churchDocument),$&&M.sourceKind==="bible"&&(z.locatorValue=M.locatorValue,z.bibleBookDisplay=M.bibleBookDisplay),$&&M.sourceKind==="website"&&(z.sourceUrl=M.sourceUrl,z.sourceAccessedDate=M.sourceAccessedDate),z},wt=n.useMemo(()=>({sourceKindLabel:t.cogita.library.add.info.sourceKindLabel,bibleBookLabel:t.cogita.library.add.info.sourceBibleBookLabel,bibleBookPlaceholder:t.cogita.library.add.info.sourceBibleBookPlaceholder,bibleRestLabel:t.cogita.library.add.info.sourceBibleRestLabel,bibleRestPlaceholder:t.cogita.library.add.info.sourceBibleRestPlaceholder,churchDocumentLabel:t.cogita.library.add.info.sourceResourceLabel,churchDocumentPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,workLabel:t.cogita.library.add.info.sourceResourceLabel,workPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,bookLabel:t.cogita.library.add.info.sourceResourceLabel,bookPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,locatorLabel:t.cogita.library.list.typeFilterLocator,locatorPlaceholder:t.cogita.library.list.typeFilterLocator}),[t]),ft=async M=>{const $=ve[M]??Ya();if(!Ws($)){ne(D=>({...D,[M]:t.cogita.library.add.info.referenceMissingSource}));return}de(M),ne(D=>({...D,[M]:null}));try{const D=Hn($),z=D?{resource:D.id}:{},H={label:Hs($),sourceKind:$.sourceKind.trim(),locator:Wn($)},S={id:(await os({libraryId:c,infoType:"source",payload:H,links:z})).infoId,infoType:"source",label:H.label};if(B(C=>{const ce=C[M]??[];return ce.some(_=>_.id===S.id)?C:{...C,[M]:[...ce,S]}}),d&&p){const C=await aa({libraryId:c,infoId:p}),ce=C.links&&typeof C.links=="object"?{...C.links}:{},_=ce[M],oe=Array.isArray(_)?_.filter(v=>typeof v=="string"):typeof _=="string"?[_]:[];oe.includes(S.id)||(ce[M]=[...oe,S.id],await Is({libraryId:c,infoId:p,payload:C.payload,links:ce}))}J(C=>({...C,[M]:ot($)})),ne(C=>({...C,[M]:null}))}catch(D){ne(z=>({...z,[M]:Qs(D,t.cogita.library.lookup.createFailed)}))}finally{de(D=>D===M?null:D)}},_e=async()=>{var D;if(!ke)return;const M={};for(const z of ke.payloadFields){if(k==="source"&&(z.key==="sourceKind"||z.key==="locator"))continue;const H=(x[z.key]??"").trim();if(!H){if(z.required){E(`Field '${z.label}' is required.`);return}continue}if(z.inputType==="json")try{M[z.key]=JSON.parse(H)}catch{E(`Field '${z.label}' must be valid JSON.`);return}else M[z.key]=H}const $={};for(const z of ke.linkFields)if(!(k==="source"&&z.key==="resource"))if(z.multiple){const H=(j[z.key]??[]).map(ae=>ae.id);if(z.required&&H.length===0){E(`Link '${z.label}' is required.`);return}H.length>0&&($[z.key]=H)}else{const H=((D=Q[z.key])==null?void 0:D.id)??null;if(z.required&&!H){E(`Link '${z.label}' is required.`);return}H&&($[z.key]=H)}if(k==="source"){if(!Ws(Se)){E(t.cogita.library.add.info.referenceMissingSource);return}const z=Se.sourceKind.trim();M.sourceKind=z,M.locator=Wn(Se),(typeof M.label!="string"||!M.label.trim())&&(M.label=Hs(Se));const H=Hn(Se);H&&($.resource=H.id)}he("saving"),E(null);try{if(d&&p)await Is({libraryId:c,infoId:p,payload:M,links:$}),E("Info updated.");else{await os({libraryId:c,infoType:k,payload:M,links:$});const z=k==="question"&&Be.length>0&&it<Be.length-1;if(z){const C=it+1,ce=Be[C]??null;if(ce){const _=Qn(ce);V(C),$e(ce),f(oe=>({...oe,definition:_})),E(`Info saved. Loaded next question (${C+1}/${Be.length}).`)}else E("Info saved.")}else k==="question"&&Be.length>0&&(Je([]),V(0)),E("Info saved.");const H={};for(const C of ke.payloadFields)H[C.key]=C.keepOnCreate?x[C.key]??"":"";if(z){const C=Be[Math.min(it+1,Be.length-1)];C&&(H.definition=Qn(C))}f(H);const ae={},S={};for(const C of ke.linkFields)C.multiple?S[C.key]=C.keepOnCreate?j[C.key]??[]:[]:ae[C.key]=C.keepOnCreate?Q[C.key]??null:null;R(C=>({...C,...ae})),B(C=>({...C,...S})),k==="source"&&et(C=>{const ce=ot(C),_=Hn(ce);return f(oe=>({...oe,sourceKind:ce.sourceKind,locator:Us(Wn(ce))})),R(oe=>({...oe,resource:_})),_&&Z(oe=>({...oe,resource:_.infoType})),ce})}}catch(z){E(Qs(z,"Failed to save info."))}finally{he("idle")}},Ze=M=>{const $=x[M.key]??"";if(k==="question"&&M.key==="definition"&&M.inputType==="json"){const z=se.type,H=v=>{const G=se.title??"",te=se.question??"";Oe({...hn(v),title:G,question:te})},ae=v=>v.length===0?[""]:v[v.length-1].trim()?[...v,""]:v,S=v=>{const G=(v.length?v:[[""],[""]]).map(te=>ae(te));return G.length>=2?G:[...G,[""]]},C=(v,G)=>{const te=v.map(Ie=>Array.from({length:G},(at,st)=>Ie[st]??"")).filter(Ie=>Ie.some(at=>at.trim())||Ie===v[v.length-1]);return te.length===0?[new Array(G).fill("")]:te[te.length-1].some(Ie=>Ie.trim())?[...te,new Array(G).fill("")]:te},ce=Array.isArray(se.answer)?se.answer:[],_=S(se.columns??[[""],[""]]),oe=C(se.matchingPaths??[[]],_.length);return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:M.label}),e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.8rem"},children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question type"}),e.jsxs("select",{value:z,onChange:v=>H(v.target.value),children:[e.jsx("option",{value:"selection",children:"Selection"}),e.jsx("option",{value:"truefalse",children:"True / false"}),e.jsx("option",{value:"text",children:"Text answer"}),e.jsx("option",{value:"number",children:"Number answer"}),e.jsx("option",{value:"date",children:"Date answer"}),e.jsx("option",{value:"matching",children:"Matching"}),e.jsx("option",{value:"ordering",children:"Right order"})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Title"}),e.jsx("input",{type:"text",value:se.title??"",onChange:v=>Oe({...se,title:v.target.value}),placeholder:"Optional title"})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question"}),e.jsx("textarea",{rows:3,value:se.question??"",onChange:v=>Oe({...se,question:v.target.value}),placeholder:"Question text"})]}),z==="selection"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Options / correct indices"}),ae(se.options??[""]).map((v,G,te)=>{const W=new Set(ce.filter(at=>Number.isInteger(at))),Ie=G===te.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:W.has(G),disabled:!v.trim(),onChange:at=>{const st=at.target.checked?[...W,G]:[...W].filter(dt=>dt!==G);Oe({...se,answer:st})}}),e.jsx("input",{type:"text",value:v,placeholder:`Answer ${G+1}`,onChange:at=>{const st=[...se.options??[""]];st[G]=at.target.value;const dt=ae(st),ct=dt.length-1,yt=ce.filter(mt=>mt>=0&&mt<ct);Oe({...se,options:dt,answer:yt})}}),Ie?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const st=(se.options??[""]).filter((ct,yt)=>yt!==G),dt=ce.filter(ct=>ct!==G).map(ct=>ct>G?ct-1:ct);Oe({...se,options:ae(st),answer:dt})},children:"Remove"})]},`question-option:${G}`)})]}):null,z==="text"||z==="date"||z==="number"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsx("input",{type:z==="date"?"date":"text",value:typeof se.answer=="string"||typeof se.answer=="number"?String(se.answer):"",onChange:v=>Oe({...se,answer:v.target.value})})]}):null,z==="truefalse"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsxs("select",{value:String(!!se.answer),onChange:v=>Oe({...se,answer:v.target.value==="true"}),children:[e.jsx("option",{value:"true",children:"True"}),e.jsx("option",{value:"false",children:"False"})]})]}):null,z==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Columns"}),_.map((v,G)=>e.jsxs("div",{style:{display:"grid",gap:"0.35rem",border:"1px solid rgba(120,170,220,0.22)",borderRadius:"0.6rem",padding:"0.55rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"0.5rem"},children:[e.jsxs("span",{style:{fontSize:"0.8rem",color:"rgba(184,209,234,0.85)"},children:["Column ",G+1]}),_.length>2?e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const te=_.filter((Ie,at)=>at!==G),W=oe.map(Ie=>Ie.filter((at,st)=>st!==G));Oe({...se,columns:S(te),matchingPaths:C(W,Math.max(2,te.length))})},children:"Remove column"}):null]}),v.map((te,W)=>{const Ie=W===v.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",gap:"0.4rem",alignItems:"center"},children:[e.jsx("input",{type:"text",value:te,placeholder:`Option ${W+1}`,onChange:at=>{const st=_.map(dt=>[...dt]);st[G][W]=at.target.value,Oe({...se,columns:S(st),matchingPaths:C(oe,_.length)})}}),Ie?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const at=_.map(st=>[...st]);at[G]=at[G].filter((st,dt)=>dt!==W),Oe({...se,columns:S(at),matchingPaths:C(oe,_.length)})},children:"Remove"})]},`question-column:${G}:row:${W}`)})]},`question-column:${G}`)),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{const v=[..._.map(te=>[...te]),[""]],G=oe.map(te=>[...te,""]);Oe({...se,columns:S(v),matchingPaths:C(G,v.length)})},children:"Add column"})}),e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Correct paths (0-based indices)"}),oe.map((v,G)=>{const te=G===oe.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:`repeat(${_.length}, minmax(0,1fr)) auto`,gap:"0.35rem",alignItems:"center"},children:[v.map((W,Ie)=>e.jsx("input",{type:"number",min:0,step:1,value:W,placeholder:`${Ie}`,onChange:at=>{const st=oe.map(yt=>[...yt]);st[G][Ie]=at.target.value;const dt=C(st,_.length),ct=dt.map(yt=>yt.map(mt=>mt.trim())).filter(yt=>yt.every(mt=>mt!=="")).map(yt=>yt.map(mt=>Number(mt))).filter(yt=>yt.every(mt=>Number.isInteger(mt)&&mt>=0));Oe({...se,matchingPaths:dt,answer:{paths:ct}})}},`question-path:${G}:${Ie}`)),te?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const W=oe.filter((st,dt)=>dt!==G),Ie=C(W,_.length),at=Ie.map(st=>st.map(dt=>dt.trim())).filter(st=>st.every(dt=>dt!=="")).map(st=>st.map(dt=>Number(dt))).filter(st=>st.every(dt=>Number.isInteger(dt)&&dt>=0));Oe({...se,matchingPaths:Ie,answer:{paths:at}})},children:"Remove"})]},`question-path:${G}`)})]}):null,z==="ordering"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Ordered options (correct order = listed order)"}),ae(se.options??[""]).map((v,G,te)=>{const W=G===te.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)",minWidth:"1.5rem"},children:[G+1,"."]}),e.jsx("input",{type:"text",value:v,placeholder:`Step ${G+1}`,onChange:Ie=>{const at=[...se.options??[""]];at[G]=Ie.target.value,Oe({...se,options:ae(at)})}}),W?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>Oe({...se,options:ae((se.options??[]).filter((Ie,at)=>at!==G))}),children:"Remove"})]},`question-order:${G}`)})]}):null,e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"JSON import"}),e.jsx("textarea",{rows:8,value:ie,onChange:v=>Ee(v.target.value),placeholder:"Paste question JSON"}),e.jsxs("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:[e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{try{const v=JSON.parse(ie);if(Array.isArray(v)){const te=v.map(Ie=>Da(Ie)).filter(Ie=>!!Ie);if(te.length===0){E("Question JSON array must contain at least one valid question object.");return}const W=te[0];Je(te),V(0),Oe(W),E(`Loaded question array (${te.length} items).`);return}const G=Da(v);if(!G){E("Question JSON must be an object or an array of question objects.");return}Je([]),V(0),Oe(G),E(null)}catch{E("Question JSON is invalid.")}},children:"Interpret JSON"}),Be.length>0?e.jsxs("span",{className:"cogita-library-hint",children:["Queue: ",Math.min(it+1,Be.length)," / ",Be.length]}):null]})]})]})]},`payload:${M.key}`)}const D=M.inputType==="textarea"||M.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:M.label}),D?e.jsx("textarea",{rows:M.inputType==="json"?8:4,value:$,onChange:z=>f(H=>({...H,[M.key]:z.target.value})),placeholder:M.key}):e.jsx("input",{type:"text",value:$,onChange:z=>f(H=>({...H,[M.key]:z.target.value})),placeholder:M.key})]},`payload:${M.key}`)},ut=M=>{const $=L[M.key]??M.targetTypes[0],D=M.key==="references"&&M.multiple&&M.targetTypes.includes("source"),z=ve[M.key]??Ya(),H=re[M.key]??!1,ae=ue[M.key];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:M.label}),M.targetTypes.length>1?e.jsx("select",{value:$,onChange:S=>Z(C=>({...C,[M.key]:S.target.value})),children:M.targetTypes.map(S=>e.jsx("option",{value:S,children:gt(t,S)},`${M.key}:${S}`))}):null,M.multiple?e.jsx(Yt,{libraryId:c,infoType:$,label:M.label,placeholder:M.key,multiple:!0,values:j[M.key]??[],onChangeMultiple:S=>B(C=>({...C,[M.key]:S})),allowCreate:!D,searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(Yt,{libraryId:c,infoType:$,label:M.label,placeholder:M.key,value:Q[M.key]??null,onChange:S=>R(C=>({...C,[M.key]:S})),searchFailedText:"Search failed",createFailedText:"Create failed"}),D?e.jsxs("div",{children:[e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:H,onChange:S=>F(C=>({...C,[M.key]:S.target.checked}))}),e.jsx("span",{children:t.cogita.library.add.info.referenceToggle})]}),H?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(Vs,{libraryId:c,copy:t,language:h,sourceKindOptions:[...Os],value:z,onChange:S=>J(C=>({...C,[M.key]:S})),labels:wt}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>ft(M.key),disabled:je===M.key,children:je===M.key?t.cogita.library.lookup.saving:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.source)})}),ae?e.jsx("p",{className:"cogita-library-subtitle",children:ae}):null]}):null]}):null]},`link:${M.key}`)},Qe=()=>e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(Vs,{libraryId:c,copy:t,language:h,sourceKindOptions:[...Os],value:Se,onChange:et,labels:wt})]});return e.jsx(At,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:d?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${c}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[d?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:k,onChange:M=>I(M.target.value),children:Pe.map(M=>e.jsx("option",{value:M.value,children:M.label},M.value))})]}),O==="loading"&&d?e.jsx("p",{children:"Loading..."}):null,ke&&!(O==="loading"&&d)?e.jsxs("div",{className:"cogita-form-grid",children:[ke.payloadFields.filter(M=>!(k==="source"&&(M.key==="sourceKind"||M.key==="locator"))).map(Ze),k==="source"?Qe():null,ke.linkFields.filter(M=>!(k==="source"&&M.key==="resource")).map(ut)]}):O==="loading"&&d?null:e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:_e,disabled:O==="saving"||!ke,children:O==="saving"?"Saving...":d?"Update info":"Create info"})}),q?e.jsx("p",{className:"cogita-library-subtitle",children:q}):null]})})})]})})}const Gs=t=>/\s/.test(t),vn=t=>/[\p{L}\p{N}]/u.test(t),Ys=(t,a)=>{const s=a>0?t[a-1]:"",r=a<t.length?t[a]:"";if(!s||!r)return 0;const i=Gs(s),u=Gs(r);if(i||u)return 3;const o=vn(s),y=vn(r);return o!==y?2:!o&&!y?1:0},Gn=(t,a,s,r,i)=>{const u=Math.max(r-a,s-r);for(let o=0;o<=u;o+=1){const y=r-o;if(y>=a&&y<=s&&Ys(t,y)>=i)return y;const h=r+o;if(h>=a&&h<=s&&Ys(t,h)>=i)return h}return null},Yn=(t,a)=>{const s=a>0?t[a-1]:"",r=a<t.length?t[a]:"";return!s||!r?!0:vn(s)!==vn(r)},Wi=(t,a,s,r)=>{const i=s-a,u=a+r,o=s-r;if(i<=r*2||o<=u)return null;const y=Math.floor((a+s)/2),h=Gn(t,u,o,y,3);if(h!==null&&Yn(t,h))return h;const b=Gn(t,u,o,y,2);if(b!==null&&Yn(t,b))return b;const c=Gn(t,u,o,y,1);return c!==null&&Yn(t,c)?c:null},ka=(t,a)=>{const s=Math.max(1,(a==null?void 0:a.minLen)??7),r=Math.max(s,(a==null?void 0:a.maxLen)??13),i={},u=(h,b,c,p,l)=>{const d=String(p),w={id:d,start:h,end:b,text:t.slice(h,b),depth:c,index:p,parentId:l};if(i[d]=w,b-h>r){let k=Wi(t,h,b,s);if(k!==null&&k>h&&k<b){const I=u(h,k,c+1,p*2+1,d),x=u(k,b,c+1,p*2+2,d);w.leftId=I.id,w.rightId=x.id}}return w},o=u(0,t.length,0,0),y=Object.values(i).sort((h,b)=>b.depth-h.depth||h.start-b.start).map(h=>h.id);return{text:t,rootId:o.id,nodes:i,order:y}},za=(t,a,s,r,i,u,o)=>{const y=u==="reverse"?t.order.slice().sort((h,b)=>t.nodes[b].start-t.nodes[h].start||t.nodes[b].depth-t.nodes[h].depth):t.order;for(const h of y){if(o&&h===o||a.has(h))continue;const b=t.nodes[h];if(b){if(i&&(b.leftId||b.rightId)){const c=b.leftId?s[b.leftId]??0:r,p=b.rightId?s[b.rightId]??0:r;if((c+p)/2<r)continue}return b}}return null},$n=(t,a)=>({before:t.slice(0,a.start),fragment:t.slice(a.start,a.end),after:t.slice(a.end)});function Gi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,libraryId:c}){const p=`/#/cogita/library/${c}`,[l,d,w]=hs([]),[m,k,I]=ms([]),[x,f]=n.useState(null),[Q,R]=n.useState(null),[j,B]=n.useState(null),[L,Z]=n.useState(null),q=n.useMemo(()=>l.find(F=>F.id===x)??null,[l,x]);n.useEffect(()=>{let F=!0;return Br({libraryId:c}).then(ve=>{if(!F)return;const J=ve.nodes.map(ue=>{var ne,je,de;return{id:ue.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:ue.payload&&typeof ue.payload=="object"&&"label"in ue.payload?String(ue.payload.label):"Item",nodeType:ue.nodeType,itemType:((ne=ue.payload)==null?void 0:ne.itemType)??"info",itemId:((je=ue.payload)==null?void 0:je.itemId)??null,infoType:((de=ue.payload)==null?void 0:de.infoType)??null}}});d(J),k(ve.edges.map(ue=>({id:ue.edgeId,source:ue.fromNodeId,target:ue.toNodeId})))}).catch(()=>{F&&(d([]),k([]))}),()=>{F=!1}},[c]),n.useEffect(()=>{zr({libraryId:c}).then(R).catch(()=>R(null))},[c,l,m]);const E=n.useCallback(F=>{k(ve=>gs(F,ve))},[]),O=()=>{const F=crypto.randomUUID();d(ve=>[...ve,{id:F,type:"default",position:{x:140+ve.length*40,y:120+ve.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},he=()=>{const F=crypto.randomUUID();d(ve=>[...ve,{id:F,type:"default",position:{x:180+ve.length*40,y:160+ve.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},Se=async()=>{B(null);try{const F=l.map(J=>({nodeId:J.id,nodeType:J.data.nodeType,payload:{itemType:J.data.itemType,itemId:J.data.itemId??null,label:J.data.label,infoType:J.data.infoType??null}})),ve=m.map(J=>({edgeId:J.id,fromNodeId:J.source,toNodeId:J.target}));await qr({libraryId:c,nodes:F,edges:ve}),B(t.cogita.library.graph.saveSuccess)}catch{B(t.cogita.library.graph.saveFail)}},et=F=>{q&&d(ve=>ve.map(J=>J.id===q.id?{...J,data:{...J.data,itemId:(F==null?void 0:F.infoId)??null,itemType:"collection",infoType:"collection",label:(F==null?void 0:F.label)??t.cogita.library.infoTypes.collection}}:J))},re=F=>{q&&d(ve=>ve.map(J=>J.id===q.id?{...J,data:{...J.data,itemId:(F==null?void 0:F.infoId)??null,itemType:"info",infoType:(F==null?void 0:F.infoType)??null,label:(F==null?void 0:F.label)??t.cogita.library.infoTypes.any}}:J))};return n.useEffect(()=>{if(!q||q.data.nodeType!=="info"||q.data.infoType!=="citation"||!q.data.itemId){Z(null);return}let F=!0;return aa({libraryId:c,infoId:q.data.itemId}).then(ve=>{if(!F)return;const J=ve.payload,ue=(J==null?void 0:J.text)??"";if(!ue){Z(null);return}const ne=ka(ue),je=Object.values(ne.nodes).sort((de,se)=>de.depth-se.depth||de.start-se.start).map(de=>({id:de.id,text:de.text,depth:de.depth}));Z({title:(J==null?void 0:J.title)??q.data.label,fragments:je})}).catch(()=>Z(null)),()=>{F=!1}},[c,q]),e.jsx(At,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:p,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:Se,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:O,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:he,children:t.cogita.library.actions.addInfo}),Q?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(Q.totalCollections))})}):null,j?e.jsx("p",{className:"cogita-help",children:j}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(Mn,{nodes:l,edges:m,onNodesChange:w,onEdgesChange:I,onConnect:E,onNodeClick:(F,ve)=>f(ve.id),fitView:!0,children:[e.jsx(Ln,{gap:18,size:1}),e.jsx(An,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),q?e.jsxs("div",{className:"cogita-graph-inspector",children:[q.data.nodeType==="collection"?e.jsx(Yt,{libraryId:c,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:q.data.itemId?{id:q.data.itemId,label:q.data.label,infoType:"collection"}:null,onChange:et,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(Yt,{libraryId:c,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:q.data.itemId?{id:q.data.itemId,label:q.data.label,infoType:q.data.infoType??void 0}:null,onChange:re,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),L?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:L.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:L.fragments.map(F=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:F.id}),e.jsx("span",{children:F.text})]},F.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function Ua({children:t,flashState:a,flashTick:s=0,feedbackToken:r,className:i}){const u=r??(a?`${a}-${s}`:"idle"),[o,y]=n.useState("a"),h=n.useRef(u);return n.useEffect(()=>{h.current!==u&&(h.current=u,y(b=>b==="a"?"b":"a"))},[u]),e.jsx("section",{className:i?`cogita-revision-card ${i}`:"cogita-revision-card","data-feedback":u,"data-feedback-variant":o,children:t})}const Yi={answerLabel:"Answer",correctAnswerLabel:"Correct answer",trueLabel:"True",falseLabel:"False",fragmentLabel:"Fragment",correctFragmentLabel:"Correct fragment",participantAnswerPlaceholder:"",unsupportedPromptType:"Unsupported prompt type",waitingForReveal:"Waiting for reveal.",selectedPaths:"Selected paths",removePath:"Remove",columnPrefix:"Column"};function Pn({prompt:t,revealExpected:a,mode:s,labels:r,answers:i,onTextChange:u,onSelectionToggle:o,onBooleanChange:y,onOrderingMove:h,onMatchingPick:b,onMatchingRemovePath:c}){var x;if(!t)return null;const p={...Yi,...r??{}},l=typeof a<"u",d=String(t.kind??""),w=Array.isArray(a)?a.map(f=>Number(f)).filter(Number.isFinite):[],m=(f,Q,R)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:l?p.correctAnswerLabel:p.answerLabel}),e.jsx("input",{type:f==="number"?"number":f==="date"?"date":"text",value:Q??"",onChange:j=>R==null?void 0:R(j.target.value),readOnly:s==="readonly"||l,placeholder:p.participantAnswerPlaceholder})]}),k=(f,Q)=>Q.map((R,j)=>{const B=Array.isArray(f[j])?f[j]:[];return`${j>0?" -> ":""}${String(B[R]??R)}`}).join(""),I=f=>e.jsx("div",{className:"cogita-live-card-surface","data-state":l?"correct":"idle",children:f});if(d==="citation-fragment")return I(e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("span",{style:{opacity:.7},children:String(t.before??"")}),e.jsx("strong",{children:" [ ... ] "}),e.jsx("span",{style:{opacity:.7},children:String(t.after??"")})]}),m("text",l?String(a??""):(i==null?void 0:i.text)??"",u)]}));if(d==="text")return I(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),m(String(t.inputType??"text"),l?String(a??""):(i==null?void 0:i.text)??"",u)]}));if(d==="boolean"){const f=!!a,Q=i==null?void 0:i.booleanAnswer;return I(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:`cta ghost ${l&&f?"live-correct-answer":""}`,"data-active":!l&&Q===!0?"true":void 0,onClick:()=>y==null?void 0:y(!0),disabled:s==="readonly"||l,children:p.trueLabel}),e.jsx("button",{type:"button",className:`cta ghost ${l&&!f?"live-correct-answer":""}`,"data-active":!l&&Q===!1?"true":void 0,onClick:()=>y==null?void 0:y(!1),disabled:s==="readonly"||l,children:p.falseLabel})]})]}))}if(d==="selection"){const f=Array.isArray(t.options)?t.options:[],Q=!!t.multiple,R=(i==null?void 0:i.selection)??[];return I(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:f.map((j,B)=>e.jsxs("label",{className:"cogita-share-row","data-state":l&&w.includes(B)?"correct":void 0,children:[e.jsx("span",{children:j}),e.jsx("input",{type:Q?"checkbox":"radio",name:"live-selection",checked:l?w.includes(B):R.includes(B),onChange:()=>o==null?void 0:o(B),disabled:s==="readonly"||l})]},`${B}-${j}`))})]}))}if(d==="ordering"){const f=Array.isArray(l?a:i==null?void 0:i.ordering)?(l?a:(i==null?void 0:i.ordering)??[]).map(String):[];return I(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:f.map((Q,R)=>e.jsxs("div",{className:"cogita-share-row","data-state":l?"correct":void 0,children:[e.jsx("span",{children:Q}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>h==null?void 0:h(R,-1),disabled:s==="readonly"||l,children:"↑"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>h==null?void 0:h(R,1),disabled:s==="readonly"||l,children:"↓"})]})]},`${R}-${Q}`))})]}))}if(d==="matching"){const f=Array.isArray(t.columns)?t.columns:[],Q=(a==null?void 0:a.paths)??[],R=Math.max(2,f.length),j=Array.from({length:R},(B,L)=>(i==null?void 0:i.matchingSelection[L])??null);return I(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),e.jsx("div",{style:{display:"grid",gap:"0.65rem",gridTemplateColumns:`repeat(${R}, minmax(0, 1fr))`,alignItems:"start"},children:f.map((B,L)=>e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.35rem",padding:"0.6rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:`${p.columnPrefix} ${L+1}`}),B.map((Z,q)=>e.jsxs("button",{type:"button",className:"ghost cogita-checkcard-row",style:{textAlign:"left"},"data-active":!l&&j[L]===q?"true":void 0,onClick:()=>b==null?void 0:b(L,q),disabled:s==="readonly"||l,children:[e.jsx("span",{children:Z}),e.jsx("small",{children:q})]},`live-col:${L}:${q}`))]},`live-col:${L}`))}),e.jsxs("div",{style:{display:"grid",gap:"0.4rem",marginTop:"0.65rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:p.selectedPaths}),l?e.jsx("div",{className:"cogita-share-list",children:Q.map((B,L)=>e.jsx("div",{className:"cogita-share-row","data-state":"correct",children:e.jsx("span",{children:k(f,B)})},`path-${L}`))}):(((x=i==null?void 0:i.matchingRows)==null?void 0:x.length)??0)>0?e.jsx("div",{className:"cogita-share-list",children:((i==null?void 0:i.matchingRows)??[]).map((B,L)=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("span",{children:k(f,B)}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>c==null?void 0:c(L),disabled:s==="readonly",children:p.removePath})]},`path-${L}`))}):e.jsx("p",{className:"cogita-library-hint",children:p.waitingForReveal})]})]}))}return e.jsx("p",{className:"cogita-help",children:p.unsupportedPromptType})}function vs({copy:t,currentCard:a,currentTypeLabel:s,prompt:r,languages:i,answer:u,onAnswerChange:o,computedExpected:y,computedAnswers:h,onComputedAnswerChange:b,answerTemplate:c,outputVariables:p,variableValues:l,computedFieldFeedback:d,feedback:w,canAdvance:m,quoteContext:k,quotePlaceholder:I,onCheckAnswer:x,onSkip:f,onLanguageSelect:Q,onMarkReviewed:R,onAdvance:j,showCorrectAnswer:B,setShowCorrectAnswer:L,onRevealCorrect:Z,answerMask:q,expectedAnswer:E,hasExpectedAnswer:O,handleComputedKeyDown:he,answerInputRef:Se,computedInputRefs:et,scriptMode:re,setScriptMode:F,matchPairs:ve,matchLeftOrder:J,matchRightOrder:ue,matchSelection:ne,matchActiveLeft:je,matchActiveRight:de,matchFeedback:se,onMatchLeftSelect:$e,onMatchRightSelect:ie,questionPrompt:Ee,questionAnswers:Be,questionRevealExpected:Je,onQuestionTextChange:it,onQuestionSelectionToggle:V,onQuestionBooleanChange:ke,onQuestionOrderingMove:He,onQuestionMatchingPick:Pe,onQuestionMatchingRemovePath:Oe,disableCheckAnswer:ot=!1,hideSkipAction:wt=!1,allowRevealBeforeCheck:ft=!1,autoRevealAfterAnswer:_e=!1,disableCheckAfterAnswer:Ze=!1}){const ut=n.useMemo(()=>{var st;const S=!c&&y.length===2?`The {${y[0].key}} is of type {${y[1].key}}`:null,C=c??S;if(!C)return null;const ce=new Map(y.map(dt=>[dt.key,dt.expected])),_=new Set,oe=[],v=/\{([^}]+)\}/g;let G=0,te,W=null;for(;(te=v.exec(C))!==null;){const dt=C.slice(G,te.index);dt&&oe.push({type:"text",value:dt});const ct=((st=te[1])==null?void 0:st.trim())??"",yt=ct&&ce.has(ct)?ct:ct&&p&&p[ct]?p[ct]:null;ct&&_.add(ct),yt&&_.add(yt),yt&&ce.has(yt)?(oe.push({type:"input",value:yt}),W||(W=yt)):ct&&l&&l[ct]!==void 0?oe.push({type:"text",value:l[ct]}):oe.push({type:"text",value:te[0]}),G=te.index+te[0].length}const Ie=C.slice(G);return Ie&&oe.push({type:"text",value:Ie}),y.filter(dt=>!_.has(dt.key)).length>0?null:{parts:oe,expectedByKey:ce,firstInputKey:W}},[c,y,p,l]),Qe=()=>{if(!ut)return null;const{parts:S,expectedByKey:C,firstInputKey:ce}=ut;return e.jsx("div",{className:"cogita-revision-inline-answer",children:S.map((_,oe)=>{var v,G;return _.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:_.value},`text-${oe}`):e.jsx("input",{ref:te=>{et.current[_.value]=te},autoFocus:_.value===ce,value:h[_.value]??"",onChange:te=>b(_.value,te.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":d[_.value]??(w==="correct"?"correct":w==="incorrect"?"incorrect":void 0),onKeyDown:te=>M(te)||he(te),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((v=h[_.value])==null?void 0:v.length)??0,((G=C.get(_.value))==null?void 0:G.length)??6)}ch`}},`input-${_.value}-${oe}`)})})},be=n.useMemo(()=>{const S=new Map;return(ve??[]).forEach(C=>S.set(C.leftId,C)),S},[ve]),fe=n.useMemo(()=>{const S=new Map;return(ve??[]).forEach(C=>S.set(C.rightId,C)),S},[ve]);n.useEffect(()=>{var oe;if(a.cardType!=="info"||a.infoType!=="computed"||y.length===0)return;const S=typeof document<"u"?document.activeElement:null;if(S&&(S.tagName==="INPUT"||S.tagName==="TEXTAREA"))return;const C=(ut==null?void 0:ut.firstInputKey)??((oe=y[0])==null?void 0:oe.key);if(!C)return;const ce=et.current[C];if(!ce)return;const _=requestAnimationFrame(()=>{ce.focus()});return()=>cancelAnimationFrame(_)},[a,y,ut]);const we=(()=>{const S=[E??"",...y.map(_=>_.expected??"")].join(""),C=[u,...Object.values(h)].join(""),ce=`${S}${C}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(ce)})(),M=S=>S.ctrlKey&&(S.key==="^"||S.key==="6")?(S.preventDefault(),F(C=>C==="super"?null:"super"),!0):S.ctrlKey&&(S.key==="_"||S.key==="-")?(S.preventDefault(),F(C=>C==="sub"?null:"sub"),!0):!1,$=()=>{if(!E||!q)return E??"";const S=E.split(""),C=Array.from(q),ce=C.length>0?C.reduce((_,oe)=>_+oe,0)/C.length:127;return S.map((_,oe)=>{const v=C[oe]??ce,G=Math.max(0,Math.min(255,Math.round(v)));let te=255,W=0;return G<=127?W=Math.round(G/127*255):(W=255,te=Math.round(255*(1-(G-127)/128))),e.jsx("span",{style:{color:`rgb(${te}, ${W}, 0)`},children:_},`mask-${oe}`)})},D=a.cardType==="info"&&a.infoType==="citation"?(k==null?void 0:k.title)||a.label:a.description,z=B||_e&&w!==null,H=ot||Ze&&(w!==null||z),ae=O&&(ft||w==="incorrect"||z);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[s?e.jsx("span",{children:s}):null,e.jsx("strong",{children:D})]}),a.cardType==="vocab"&&a.checkType==="translation-match"&&ve?e.jsxs("div",{className:"cogita-revision-body",children:[r?e.jsx("h2",{children:r}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(J??[]).map(S=>{const C=be.get(S);if(!C)return null;const ce=(ne==null?void 0:ne[S])??null,_=(se==null?void 0:se[S])??null,oe=je===S;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":oe,"data-state":_??void 0,"data-locked":ce?"true":void 0,onClick:()=>$e==null?void 0:$e(S),children:[e.jsx("span",{children:C.leftLabel}),ce&&B?e.jsx("em",{children:"✓"}):null]},S)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(ue??[]).map(S=>{const C=fe.get(S);if(!C)return null;const ce=Object.values(ne??{}).includes(S),_=de===S;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":ce||_,"data-locked":ce?"true":void 0,onClick:()=>ie==null?void 0:ie(S),children:e.jsx("span",{children:C.rightLabel})},S)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:a.checkType==="translation-match"||H,children:t.cogita.library.revision.checkAnswer}),wt?null:e.jsx("button",{type:"button",className:"ghost",onClick:f,children:t.cogita.library.revision.skip})]})]}):a.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:Se,value:u,onChange:S=>o(S.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":w==="correct"?"correct":w==="incorrect"?"incorrect":void 0,onKeyDown:S=>{if(S.key==="Enter")if(S.preventDefault(),S.stopPropagation(),m)j();else{if(H)return;x()}}})]}),we?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":re==="super",onClick:()=>F(S=>S==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":re==="sub",onClick:()=>F(S=>S==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:H,children:t.cogita.library.revision.checkAnswer}),wt?null:e.jsx("button",{type:"button",className:"ghost",onClick:f,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="question"?e.jsxs("div",{className:"cogita-revision-body",children:[Ee?e.jsx(Pn,{prompt:Ee,revealExpected:Je,mode:"interactive",labels:{answerLabel:t.cogita.library.revision.answerLabel,correctAnswerLabel:t.cogita.library.revision.correctAnswerLabel,participantAnswerPlaceholder:t.cogita.library.revision.answerPlaceholder},answers:Be,onTextChange:it,onSelectionToggle:V,onBooleanChange:ke,onOrderingMove:He,onMatchingPick:Pe,onMatchingRemovePath:Oe}):e.jsxs(e.Fragment,{children:[e.jsx("h2",{children:r}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:Se,value:u,onChange:S=>o(S.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":w==="correct"?"correct":w==="incorrect"?"incorrect":void 0,onKeyDown:S=>{if(S.key==="Enter")if(S.preventDefault(),S.stopPropagation(),m)j();else{if(H)return;x()}}})]})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:H,children:t.cogita.library.revision.checkAnswer}),wt?null:e.jsx("button",{type:"button",className:"ghost",onClick:f,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[a.label?e.jsx("p",{className:"cogita-revision-hint",children:a.label}):null,c?null:e.jsx(Vr,{value:r??"",mode:"auto"}),y.length>0?(()=>{const S=Qe();return S?e.jsx("div",{className:"cogita-inline-answer-wrap",children:S}):e.jsx("div",{className:"cogita-form-grid",children:y.map((C,ce)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:C.key}),e.jsx("textarea",{ref:_=>{et.current[C.key]=_},autoFocus:ce===0,value:h[C.key]??"",onChange:_=>b(C.key,_.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":d[C.key]??(w==="correct"?"correct":w==="incorrect"?"incorrect":void 0),onKeyDown:_=>M(_)||he(_)})]},C.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:Se,value:u,onChange:S=>o(S.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":w==="correct"?"correct":w==="incorrect"?"incorrect":void 0,onKeyDown:S=>{if(!M(S)&&S.key==="Enter")if(S.preventDefault(),S.stopPropagation(),m)j();else{if(H)return;x()}}})]})}),we?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":re==="super",onClick:()=>F(S=>S==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":re==="sub",onClick:()=>F(S=>S==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:H,children:t.cogita.library.revision.checkAnswer}),wt?null:e.jsx("button",{type:"button",className:"ghost",onClick:f,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="citation"&&k?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(k.completed)).replace("{total}",String(k.total))}),e.jsx("p",{className:"cogita-quote-text",children:k.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:Se,value:u,onChange:S=>o(S.target.value),placeholder:I??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":w==="correct"?"correct":w==="incorrect"?"incorrect":void 0,onKeyDown:S=>{if(S.key==="Enter")if(S.preventDefault(),S.stopPropagation(),m)j();else{if(H)return;x()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:k.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:H,children:t.cogita.library.revision.checkAnswer}),wt?null:e.jsx("button",{type:"button",className:"ghost",onClick:f,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:i.length?i.map(S=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>Q(S.label),children:S.label},S.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:f,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:R,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:f,children:t.cogita.library.revision.skip})]})]}),w&&e.jsx("div",{className:"cogita-revision-feedback","data-state":w,children:w==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),ae?e.jsxs("div",{className:"cogita-revision-reveal",children:[z?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>L(S=>{const C=!S;return C&&Z(),C}),children:t.cogita.library.revision.showAnswer}),z?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),y.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[y.map(S=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:S.key}),e.jsx("span",{children:S.expected})]},S.key)),E?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:E})]}):null]}):e.jsx("p",{children:q?$():E})]}):null]}):null,m?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:j,children:t.cogita.library.revision.nextQuestion})}):null]})}const Xs={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},Xi=(t,a)=>{const s=Math.max(t.length,a.length,1),r=Math.abs(t.length-a.length);return Math.max(0,1-r/s)},Zi=(t,a)=>{const s=new Uint8Array(t.length),r=Xi(t,a);for(let i=0;i<t.length;i+=1){const u=t[i]===(a[i]??"")?128:0,o=t.length-1-i,y=a.length-1-i,h=t[o]===(a[y]??"")?127:0,b=Math.round((u+h)*r);s[i]=Math.max(0,Math.min(255,b))}return s},eo=(t,a)=>t===a||(Xs[t]??[]).includes(a)?!0:(Xs[a]??[]).includes(t),mn=(t,a,s)=>s?eo(t,a):t===a,wn=(t,a,s)=>{const r=new Uint8Array(t.length);if(!t.length)return r;const i=(s==null?void 0:s.allowSimilarChars)??!0,u=[];for(let y=0;y<=t.length-3;y+=1)u.push({index:y,text:t.slice(y,y+3)});let o=!1;return u.forEach(y=>{for(let h=0;h<=a.length-3;h+=1){const b=a.slice(h,h+3);let c=0;for(let m=0;m<3;m+=1)mn(y.text[m],b[m],i)&&(c+=1);if(c<2)continue;let p=y.index-1,l=h-1;for(;p>=0&&l>=0;){const m=t[p],k=a[l];if(m===k){r[p]=Math.max(r[p],255),p-=1,l-=1,o=!0;continue}if(mn(m,k,i)&&m!==k){r[p]=Math.max(r[p],127),p-=1,l-=1,o=!0;continue}if(p>0&&t[p-1]===k){r[p]=Math.max(r[p],0),p-=1,o=!0;continue}if(l>0&&t[p]===a[l-1]){l-=1,o=!0;continue}break}for(let m=0;m<3;m+=1){const k=y.index+m,I=y.text[m],x=b[m],f=I===x?255:mn(I,x,i)?127:0;r[k]=Math.max(r[k],f),o=!0}let d=y.index+3,w=h+3;for(;d<t.length&&w<a.length;){const m=t[d],k=a[w];if(m===k){r[d]=Math.max(r[d],255),d+=1,w+=1,o=!0;continue}if(mn(m,k,i)&&m!==k){r[d]=Math.max(r[d],127),d+=1,w+=1,o=!0;continue}if(d+1<t.length&&t[d+1]===k){r[d]=Math.max(r[d],0),d+=1,o=!0;continue}if(w+1<a.length&&t[d]===a[w+1]){w+=1,o=!0;continue}break}}}),o?r:Zi(t,a)},Xn=t=>/[\p{L}\p{N}]/u.test(t),Zs=t=>t.trim().toLowerCase(),ua=(t,a)=>{if(t.length===0)return 100;const s=(a==null?void 0:a.treatSimilarCharsAsSame)??!1,r=Array.from(t).reduce((i,u)=>s&&u===127?i+255:i+u,0);return Math.round(r/(t.length*255)*100)},an=(t,a,s)=>{const r=Math.max(0,Math.min(100,(s==null?void 0:s.thresholdPercent)??100)),i=(s==null?void 0:s.treatSimilarCharsAsSame)??!0,u=(s==null?void 0:s.ignorePunctuationAndSpacing)??!1,o=Zs(t),y=Zs(a);if(!u){const x=wn(o,y,{allowSimilarChars:i}),f=ua(x,{treatSimilarCharsAsSame:i});return{mask:x,percent:f,isCorrect:f>=r,normalizedExpected:o,normalizedAnswer:y}}const h=Array.from(o),b=Array.from(y),c=[],p=[],l=[];h.forEach((x,f)=>{Xn(x)&&(c.push(x),p.push(f))}),b.forEach(x=>{Xn(x)&&l.push(x)});const d=c.join(""),w=l.join(""),m=wn(d,w,{allowSimilarChars:i}),k=new Uint8Array(h.length);for(let x=0;x<k.length;x+=1)k[x]=Xn(h[x]??"")?0:255;for(let x=0;x<m.length;x+=1){const f=p[x];f!==void 0&&(k[f]=m[x])}const I=ua(m,{treatSimilarCharsAsSame:i});return{mask:k,percent:I,isCorrect:I>=r,normalizedExpected:d,normalizedAnswer:w}},qa=(t,a,s)=>{const r=t.trim().toLowerCase(),i=a.trim().toLowerCase();return s==="prefix"||s==="bidirectional"?wn(r,i,{allowSimilarChars:!0}):wn(r,i,{allowSimilarChars:!0})},to=t=>{if(typeof t!="string")return"";const a=t.trim().toLowerCase();return a==="single_select"||a==="multi_select"?"selection":a==="boolean"||a==="true_false"?"truefalse":a==="order"?"ordering":a==="short"||a==="open"||a==="short_text"?"text":a==="selection"||a==="truefalse"||a==="text"||a==="number"||a==="date"||a==="ordering"||a==="matching"?a:""};function ws(t){if(!t||typeof t!="object")return null;const a=t,s=(()=>{if(a.definition&&typeof a.definition=="object")return a.definition;if(typeof a.definition=="string")try{const b=JSON.parse(a.definition);if(b&&typeof b=="object")return b}catch{}return a})(),r=to(s.type??s.kind??s.questionType);if(!r)return null;const i=typeof s.title=="string"?s.title:void 0,u=typeof s.question=="string"?s.question:typeof s.prompt=="string"?s.prompt:"",o=Array.isArray(s.options)?s.options.map(b=>typeof b=="string"?b:"").filter(Boolean):void 0,y=Array.isArray(s.columns)?s.columns.map(b=>Array.isArray(b)?b.map(c=>typeof c=="string"?c:"").filter(Boolean):[]).filter(b=>b.length>0):void 0,h=(()=>{if(r==="selection")return(Array.isArray(s.answer)?s.answer:Array.isArray(s.correct)?s.correct:[]).map(c=>Number(c)).filter(c=>Number.isInteger(c)&&c>=0).sort((c,p)=>c-p);if(r==="truefalse")return typeof s.answer=="boolean"?s.answer:typeof s.expected=="boolean"?s.expected:!1;if(r==="matching"){const b=s.answer&&typeof s.answer=="object"?s.answer:null;return{paths:(Array.isArray(b==null?void 0:b.paths)?b.paths:Array.isArray(s.correctPairs)?s.correctPairs:[]).map(l=>Array.isArray(l)?l.map(d=>Number(d)).filter(d=>Number.isInteger(d)&&d>=0):[]).filter(l=>l.length>0)}}if(typeof s.answer=="string"||typeof s.answer=="number")return s.answer;if(typeof s.expected=="string"||typeof s.expected=="number")return s.expected})();return{type:r,title:i,question:u,options:o,answer:h,columns:y}}function er(t){const a=t.map((i,u)=>({value:i,oldIndex:u}));for(let i=a.length-1;i>0;i-=1){const u=Math.floor(Math.random()*(i+1));[a[i],a[u]]=[a[u],a[i]]}const s=a.map(i=>i.value),r=new Map;return a.forEach((i,u)=>r.set(i.oldIndex,u)),{values:s,oldToNew:r}}function Sr(t){if(t.type==="selection"){const a=t.options??[],s=er(a),r=Array.isArray(t.answer)?t.answer:[];return{...t,options:s.values,answer:r.map(i=>s.oldToNew.get(i)).filter(i=>Number.isInteger(i)).sort((i,u)=>i-u)}}if(t.type==="matching"){const s=(t.columns??[]).map(u=>er(u)),i=(t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[]).map(u=>u.map((o,y)=>{var h;return((h=s[y])==null?void 0:h.oldToNew.get(o))??o}));return{...t,columns:s.map(u=>u.values),answer:{paths:i}}}return t}function gn(t){return t.map(a=>Number(a)).filter(a=>Number.isInteger(a)&&a>=0).sort((a,s)=>a-s)}function tr(t){return t.join("|")}function Jt(t){const{prompt:a,expected:s,answer:r}=t;if(a.kind==="selection"){const h=Array.isArray(s)?gn(s):[],b=gn(r.selection??[]);return{correct:h.length===b.length&&h.every((p,l)=>p===b[l]),mask:null}}if(a.kind==="boolean")return{correct:typeof s=="boolean"&&r.booleanAnswer!=null&&s===r.booleanAnswer,mask:null};if(a.kind==="ordering"){const h=Array.isArray(s)?s.map(String).join(`
`):Array.isArray(a.options)?a.options.map(String).join(`
`):"",b=Array.isArray(r.ordering)?r.ordering.map(String).join(`
`):"",c=an(h,b,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});return{correct:c.isCorrect,mask:c.mask}}if(a.kind==="matching"){const h=s&&typeof s=="object"&&"paths"in s&&Array.isArray(s.paths)?s.paths.map(d=>Array.isArray(d)?gn(d):[]).filter(d=>d.length>0).map(tr):[],b=(r.matchingPaths??[]).map(d=>Array.isArray(d)?gn(d):[]).filter(d=>d.length>0).map(tr),c=Array.from(new Set(h)).sort(),p=Array.from(new Set(b)).sort();return{correct:c.length===p.length&&c.every((d,w)=>d===p[w]),mask:null}}if(a.kind==="text"&&a.inputType==="number"){const h=Number(s),b=Number(r.text??"");return{correct:Number.isFinite(h)&&Number.isFinite(b)&&Math.abs(h-b)<1e-9,mask:null}}const i=typeof s=="string"||typeof s=="number"?String(s):"",u=String(r.text??""),o=a.kind==="citation-fragment",y=an(i,u,{thresholdPercent:o?90:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:o});return{correct:y.isCorrect,mask:y.mask}}function ao(t){const a=[...t];for(let s=a.length-1;s>0;s-=1){const r=Math.floor(Math.random()*(s+1));[a[s],a[r]]=[a[r],a[s]]}return a}function la(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function ar(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function nr(t){const a=t.checkType??"info",s=a.startsWith("question-")?`question / ${a.slice(9)}`:a;return t.direction?`${s} / ${t.direction}`:s}function no({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,libraryId:c,infoId:p,selectedReviewerRoleId:l}){const[d,w]=n.useState(p),[m,k]=n.useState([]),[I,x]=n.useState([]),[f,Q]=n.useState("loading"),[R,j]=n.useState(null),[B,L]=n.useState(null),[Z,q]=n.useState(null),[E,O]=n.useState(null),[he,Se]=n.useState(""),[et,re]=n.useState(null),[F,ve]=n.useState(1),[J,ue]=n.useState(null),[ne,je]=n.useState(0),[de,se]=n.useState(!1),[$e,ie]=n.useState(null),[Ee,Be]=n.useState({}),[Je,it]=n.useState({}),[V]=n.useState({}),[ke,He]=n.useState(null),[Pe,Oe]=n.useState({selection:[],booleanAnswer:null,ordering:[],matchingRows:[],matchingSelection:[]}),ot=n.useRef(null),wt=n.useRef({}),ft=nn();n.useEffect(()=>{let S=!1;return Q("loading"),Promise.all([aa({libraryId:c,infoId:p}).catch(()=>null),bn({libraryId:c,infoId:p}),yn({libraryId:c,infoId:p})]).then(([C,ce,_])=>{if(S)return;const oe=(C==null?void 0:C.payload)??{},v=typeof oe.title=="string"&&oe.title||typeof oe.label=="string"&&oe.label||typeof oe.name=="string"&&oe.name||p;w(v),L(oe),q((C==null?void 0:C.infoType)??null),k(ce.items),x(_.items),Q("ready")}).catch(()=>{S||(L(null),q(null),k([]),x([]),Q("error"))}),()=>{S=!0}},[c,p]),n.useEffect(()=>{if(Z!=="translation"){O(null);return}gr({libraryId:c,infoId:p,approachKey:"vocab-card"}).then(S=>O(S.projection??null)).catch(()=>O(null))},[Z,p,c]);const _e=n.useMemo(()=>{var G;const S=new Map(m.map(te=>[la(te),te])),C=new Map,ce=new Map;for(const te of m)C.set(la(te),0),ce.set(la(te),[]);for(const te of I){const W=ar({parentItemId:te.parentItemId,parentCheckType:te.parentCheckType,parentDirection:te.parentDirection}),Ie=[te.childItemId,te.childCheckType??"",te.childDirection??""].join("|");!S.has(W)||!S.has(Ie)||((G=ce.get(W))==null||G.push(Ie),C.set(Ie,(C.get(Ie)??0)+1))}const _=Array.from(C.entries()).filter(([,te])=>te===0).map(([te])=>te),oe=new Map;for(const te of _)oe.set(te,0);for(;_.length;){const te=_.shift(),W=oe.get(te)??0;for(const Ie of ce.get(te)??[]){const at=Math.max(oe.get(Ie)??0,W+1);oe.set(Ie,at),C.set(Ie,(C.get(Ie)??1)-1),(C.get(Ie)??0)<=0&&_.push(Ie)}}const v=new Map;for(const te of m){const W=la(te),Ie=oe.get(W)??0,at=v.get(Ie)??[];at.push(W),v.set(Ie,at)}return m.map(te=>{const W=la(te),Ie=oe.get(W)??0,at=v.get(Ie)??[W],st=Math.max(0,at.indexOf(W));return{id:W,position:{x:40+st*290+(Ie%2?18:0),y:30+Ie*120},draggable:!1,selectable:!0,data:{label:te.label,subtitle:nr(te),checkType:te.checkType??"info",direction:te.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[m,I]),Ze=n.useMemo(()=>new Map(m.map(S=>[la(S),S])),[m]),ut=n.useMemo(()=>{const S=[];for(const C of I){const ce=ar({parentItemId:C.parentItemId,parentCheckType:C.parentCheckType,parentDirection:C.parentDirection}),_=[C.childItemId,C.childCheckType??"",C.childDirection??""].join("|");!Ze.has(ce)||!Ze.has(_)||S.push({id:`${ce}->${_}`,source:ce,target:_,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return S},[Ze,I]),Qe=n.useMemo(()=>R?Ze.get(R)??null:null,[Ze,R]);n.useEffect(()=>{Se(""),ue(null),je(0),se(!1),ie(null),re(null),it({}),Oe({selection:[],booleanAnswer:null,ordering:[],matchingRows:[],matchingSelection:[]})},[R]);const be=n.useMemo(()=>{var oe,v;if(!Qe)return null;const S=Z??Qe.infoType??null,C=Qe.checkType??"info",ce=Qe.direction??null,_=B??{};if(Qe.cardType==="vocab"&&E&&Array.isArray(E.words)){const G=E.words,te=((oe=G[0])==null?void 0:oe.label)??"?",W=((v=G[1])==null?void 0:v.label)??"?";return ce==="a-to-b"?{kind:"vocab",prompt:String(te),expected:String(W)}:ce==="b-to-a"?{kind:"vocab",prompt:String(W),expected:String(te)}:{kind:"generic",prompt:`${te} ↔ ${W}`,expected:`${te} ↔ ${W}`}}if(S==="citation"&&C==="quote-fragment"&&ce&&typeof _.text=="string"){const G=ce,te=ka(_.text),W=te.nodes[G];if(W){const Ie=$n(_.text,W);return{kind:"citation-fragment",expected:W.text,quoteContext:{title:d,before:Ie.before,after:Ie.after,total:Object.keys(te.nodes).length,completed:0},quotePlaceholder:W.text.length>0?".".repeat(Math.max(4,Math.min(18,W.text.length))):"..."}}}if(S==="question"){const G=ws(_);if(G)return{kind:"question",definition:Sr(G)}}return{kind:"generic",prompt:Qe.description||Qe.label,expected:Qe.label}},[Z,B,Qe,d,E]);n.useEffect(()=>{var C;if(!be||be.kind!=="question")return;const S=be.definition;Oe({selection:[],booleanAnswer:null,ordering:S.type==="ordering"?ao(S.options??[]):[],matchingRows:[],matchingSelection:S.type==="matching"?new Array(Math.max(2,((C=S.columns)==null?void 0:C.length)??2)).fill(null):[]})},[be,R]);const fe=async S=>{if(Qe&&l)try{await Or({libraryId:c,outcome:{itemType:"info",itemId:Qe.cardId,checkType:Qe.checkType??"info",direction:Qe.direction??null,revisionType:"direct",evalType:"direct-check",correct:S,clientId:"cogita-info-checkcards",clientSequence:F,personRoleId:l}}),ve(C=>C+1),re(S?"Saved as correct.":"Saved as incorrect.")}catch{re("Failed to save answer.")}},we=Qe?la(Qe):null,M=we?!!Ee[we]:!1,$=async()=>{if(!Qe||!be)return;const S=la(Qe);if(Ee[S]){re("This card was already checked.");return}const C=be.kind==="question"?be.definition.type==="selection"?{kind:"selection",options:be.definition.options??[]}:be.definition.type==="truefalse"?{kind:"boolean"}:be.definition.type==="ordering"?{kind:"ordering",options:be.definition.options??[]}:be.definition.type==="matching"?{kind:"matching",columns:be.definition.columns??[]}:{kind:"text",inputType:be.definition.type==="number"?"number":be.definition.type==="date"?"date":"text"}:{kind:be.kind==="citation-fragment"?"citation-fragment":"text",inputType:"text"},ce=be.kind==="question"?be.definition.answer:be.expected,_=Jt({prompt:C,expected:ce,answer:{text:he,selection:Pe.selection,booleanAnswer:Pe.booleanAnswer,ordering:Pe.ordering,matchingPaths:Pe.matchingRows}}),oe=_.correct;ie(_.mask),se(!0),ue(oe?"correct":"incorrect"),je(v=>v+1),re(l?null:"Answer checked locally (not saved: no person selected)."),Be(v=>({...v,[S]:!0})),l&&await fe(oe)},D=()=>{if(!Qe||!be)return;const S=la(Qe);if(Ee[S]||(Be(ce=>({...ce,[S]:!0})),re("Answer revealed (not saved).")),be.kind==="question"){ie(null);return}const C=an(be.expected,be.expected,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:be.kind==="citation-fragment"});ie(C.mask)},z=n.useMemo(()=>Qe?Qe.infoType==="question"?{...Qe,description:Qe.label}:Qe.infoType==="citation"?{...Qe,description:d}:{...Qe,description:Qe.label}:null,[Qe,d]),H=S=>{var yt,mt;const C=S.definition,ce=M||de,_=Array.isArray(C.answer)?C.answer:[],oe=C.answer&&typeof C.answer=="object"&&"paths"in C.answer?C.answer.paths:[],v=Math.max(2,((yt=C.columns)==null?void 0:yt.length)??2),G=C.type==="matching"?Pe.matchingRows.filter(nt=>nt.length===v&&nt.every(Le=>Number.isInteger(Le)&&Le>=0)):[],te=Array.from({length:v},(nt,Le)=>Pe.matchingSelection[Le]??null),W=nt=>nt.join("|"),Ie=new Map;for(const nt of oe){const Le=W(nt);Ie.set(Le,(Ie.get(Le)??0)+1)}const at=new Map;for(const nt of G){const Le=W(nt);at.set(Le,(at.get(Le)??0)+1)}const st=oe.filter(nt=>{const Le=W(nt),pt=at.get(Le)??0;return pt>0?(at.set(Le,pt-1),!1):!0}),dt=new Map;for(const nt of st)nt.forEach((Le,pt)=>{const We=dt.get(pt)??new Map;We.set(Le,(We.get(Le)??0)+1),dt.set(pt,We)});const ct=(nt,Le)=>{ce||Oe(pt=>{var _t;const We=Math.max(2,((_t=C.columns)==null?void 0:_t.length)??2),Ue=Array.from({length:We},(Tt,Mt)=>pt.matchingSelection[Mt]??null);if(Ue[nt]=Ue[nt]===Le?null:Le,Ue.some(Tt=>Tt==null))return{...pt,matchingSelection:Ue};const It=Ue.map(Tt=>Number(Tt)),Nt=W(It),Kt=pt.matchingRows.filter(Tt=>W(Tt)===Nt).length;return(Ie.get(Nt)??0)>Kt?(ue("correct"),je(Tt=>Tt+1),re(null),{...pt,matchingRows:[...pt.matchingRows,It],matchingSelection:new Array(We).fill(null)}):(ue("incorrect"),je(Tt=>Tt+1),re("This path is not valid or has already been used."),{...pt,matchingSelection:new Array(We).fill(null)})})};return e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:C.question||(Qe==null?void 0:Qe.label)}),C.title?e.jsx("p",{className:"cogita-revision-hint",children:C.title}):null,C.type==="selection"?e.jsx("div",{className:"cogita-choice-grid",style:{gridTemplateColumns:"1fr"},children:(C.options??[]).map((nt,Le)=>e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.6rem"},children:[e.jsx("input",{type:"checkbox",checked:Pe.selection.includes(Le),disabled:ce,onChange:pt=>Oe(We=>({...We,selection:pt.target.checked?Array.from(new Set([...We.selection,Le])):We.selection.filter(Ue=>Ue!==Le)}))}),e.jsx("span",{children:nt})]},`q-opt:${Le}`))}):null,C.type==="truefalse"?e.jsxs("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:[e.jsx("button",{type:"button",className:"ghost","data-active":Pe.booleanAnswer===!0,disabled:ce,onClick:()=>Oe(nt=>({...nt,booleanAnswer:!0})),children:"True"}),e.jsx("button",{type:"button",className:"ghost","data-active":Pe.booleanAnswer===!1,disabled:ce,onClick:()=>Oe(nt=>({...nt,booleanAnswer:!1})),children:"False"})]}):null,C.type==="text"||C.type==="number"||C.type==="date"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ot,type:C.type==="date"?"date":"text",value:he,onChange:nt=>Se(nt.target.value),disabled:ce,"data-state":J==="correct"?"correct":J==="incorrect"?"incorrect":void 0})]}):null,C.type==="ordering"?e.jsx("div",{style:{display:"grid",gap:"0.45rem"},children:Pe.ordering.map((nt,Le)=>e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)"},children:[Le+1,"."]}),e.jsx("span",{children:nt}),e.jsx("button",{type:"button",className:"ghost",disabled:ce||Le===0,onClick:()=>Oe(pt=>{const We=[...pt.ordering];return[We[Le-1],We[Le]]=[We[Le],We[Le-1]],{...pt,ordering:We}}),children:"Up"}),e.jsx("button",{type:"button",className:"ghost",disabled:ce||Le>=Pe.ordering.length-1,onClick:()=>Oe(pt=>{const We=[...pt.ordering];return[We[Le+1],We[Le]]=[We[Le],We[Le+1]],{...pt,ordering:We}}),children:"Down"})]},`q-order:${Le}:${nt}`))}):null,C.type==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.65rem"},children:[e.jsx("div",{style:{display:"grid",gap:"0.65rem",gridTemplateColumns:`repeat(${Math.max(2,((mt=C.columns)==null?void 0:mt.length)??2)}, minmax(0, 1fr))`,alignItems:"start"},children:(C.columns??[]).map((nt,Le)=>e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.35rem",padding:"0.6rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:`Column ${Le+1}`}),nt.map((pt,We)=>{var Ue;return e.jsxs("button",{type:"button",className:"ghost cogita-checkcard-row",style:{textAlign:"left"},disabled:ce||te[Le]!==We&&(((Ue=dt.get(Le))==null?void 0:Ue.get(We))??0)<=0,"data-active":te[Le]===We?"true":void 0,onClick:()=>ct(Le,We),children:[e.jsx("span",{children:pt}),e.jsx("small",{children:We})]},`q-col:${Le}:${We}`)})]},`q-col:${Le}`))}),e.jsxs("div",{style:{display:"grid",gap:"0.4rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:"Selected paths"}),G.length?G.map((nt,Le)=>e.jsxs("div",{className:"cogita-share-row",style:{alignItems:"center"},children:[e.jsx("span",{children:nt.map((pt,We)=>{var It,Nt;const Ue=String(((Nt=(It=C.columns)==null?void 0:It[We])==null?void 0:Nt[pt])??pt);return`${We>0?" -> ":""}${Ue}`})}),ce?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>Oe(pt=>({...pt,matchingRows:pt.matchingRows.filter((We,Ue)=>Ue!==Le)})),children:"Remove"})]},`q-path:${Le}`)):e.jsx("p",{className:"cogita-library-hint",children:"Choose one option in each column. After the last column is selected, the path is checked automatically."})]})]}):null,e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>void $(),disabled:ce,children:t.cogita.library.revision.checkAnswer})}),de?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),C.type==="selection"?e.jsx("p",{children:_.length?_.map(nt=>{var Le;return`${nt}${(Le=C.options)!=null&&Le[nt]?`: ${C.options[nt]}`:""}`}).join(", "):"-"}):C.type==="truefalse"?e.jsx("p",{children:String(!!C.answer)}):C.type==="ordering"?e.jsx("ol",{children:(C.options??[]).map((nt,Le)=>e.jsx("li",{children:nt},`ans-order:${Le}`))}):C.type==="matching"?e.jsx("div",{style:{display:"grid",gap:"0.35rem"},children:oe.length?oe.map((nt,Le)=>e.jsx("p",{children:nt.join(" → ")},`ans-path:${Le}`)):e.jsx("p",{children:"-"})}):e.jsx("p",{children:String(C.answer??"")})]}):e.jsx("div",{className:"cogita-revision-reveal",children:e.jsx("button",{type:"button",className:"ghost",onClick:()=>{se(!0),D()},children:t.cogita.library.revision.showAnswer})})]})},ae=n.useMemo(()=>Z?gt(t,Z):t.cogita.library.infoTypes.any,[t,Z]);return e.jsx(At,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:ae}),e.jsx("h2",{className:"cogita-card-title",children:d}),e.jsx("p",{className:"cogita-card-subtitle",children:p})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${m.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${I.length}`}),e.jsx("button",{type:"button",className:"cta",disabled:m.length===0,onClick:()=>ft(`/cogita/library/${c}/revision/run?libraryTarget=revisions&scope=info&infoId=${encodeURIComponent(p)}`),children:"Start revision"})]})]}),f==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):f==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(Mn,{nodes:_e,edges:ut,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:(S,C)=>j(C.id),panOnDrag:!0,children:[e.jsx(Ln,{}),e.jsx(An,{showInteractive:!1})]})}),Qe?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[be&&z?e.jsx(Ua,{flashState:J,flashTick:ne,children:be.kind==="question"?H(be):e.jsx(vs,{copy:t,currentCard:z,currentTypeLabel:"",prompt:be.kind==="citation-fragment"?null:be.prompt,languages:[],answer:he,onAnswerChange:Se,computedExpected:[],computedAnswers:Je,onComputedAnswerChange:(S,C)=>it(ce=>({...ce,[S]:C})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:V,feedback:J,canAdvance:!1,quoteContext:be.kind==="citation-fragment"?be.quoteContext:null,quotePlaceholder:be.kind==="citation-fragment"?be.quotePlaceholder:null,onCheckAnswer:()=>void $(),onSkip:()=>j(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:de,setShowCorrectAnswer:se,onRevealCorrect:D,answerMask:$e,expectedAnswer:be.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:ot,computedInputRefs:wt,scriptMode:ke,setScriptMode:He,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:M||de,hideSkipAction:!0,allowRevealBeforeCheck:!0,autoRevealAfterAnswer:!0,disableCheckAfterAnswer:!0})}):null,l?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),et?e.jsx("p",{className:"cogita-library-hint",children:et}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:m.map(S=>{const C=la(S),ce=R===C;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${ce?"active":""}`,onClick:()=>j(C),children:[e.jsx("span",{children:S.label}),e.jsx("small",{children:nr(S)})]},C)})})]})]})]})})})})})}function pn(t,a){var s,r;return((r=(s=t.fields.find(i=>i.fieldType===a))==null?void 0:s.plainValue)==null?void 0:r.trim())??""}function so(t){return pn(t,"role_kind").toLowerCase()==="person"}function ro(t){return pn(t,"label")||pn(t,"display_name")||pn(t,"name")||t.roleId}function io({copy:t,onPersonCreated:a}){const[s,r]=n.useState([]),[i,u]=n.useState("loading"),[o,y]=n.useState(null),[h,b]=n.useState(!1),[c,p]=n.useState(""),l=async()=>{u("loading");try{const m=await pr();r(m),u("ready")}catch{r([]),u("error")}};n.useEffect(()=>{l()},[]);const d=n.useMemo(()=>s.filter(so).map(m=>({roleId:m.roleId,label:ro(m)})).sort((m,k)=>m.label.localeCompare(k.label)),[s]),w=async()=>{const m=c.trim();if(!m){y("Name is required.");return}b(!0),y(null);try{const k=await Ur({fields:[{fieldType:"nick",plainValue:m},{fieldType:"role_kind",plainValue:"person"},{fieldType:"label",plainValue:m},{fieldType:"display_name",plainValue:m}]});p(""),y("Person role created."),a==null||a(k.roleId),await l()}catch{y("Failed to create person role.")}finally{b(!1)}};return e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-browser-panel",children:[e.jsx("div",{className:"cogita-info-overview-head",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Cogita"}),e.jsx("h2",{className:"cogita-card-title",children:"Persons"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Select reviewer persons in the header and create new person roles here."})]})}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Create"}),e.jsx("h3",{className:"cogita-detail-title",children:"New person role"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{type:"text",value:c,onChange:m=>p(m.target.value),placeholder:"e.g. Anna Kowalska",disabled:h})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:w,disabled:h,children:h?"Creating...":"Create person"})}),o?e.jsx("p",{className:"cogita-library-hint",children:o}):null]})]}),e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Overview"}),e.jsx("h3",{className:"cogita-detail-title",children:"All person roles"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[i==="loading"?e.jsx("p",{children:"Loading persons..."}):null,i==="error"?e.jsx("p",{children:"Failed to load persons."}):null,i==="ready"&&d.length===0?e.jsx("p",{children:"No person roles found."}):null,i==="ready"&&d.length>0?e.jsxs("div",{className:"cogita-details-grid",children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:"Name"}),e.jsx("span",{children:"Type"}),e.jsx("span",{children:"Role ID"}),e.jsx("span",{})]}),d.map(m=>e.jsxs("div",{className:"cogita-details-row",role:"row",children:[e.jsx("span",{}),e.jsx("span",{title:m.label,children:m.label}),e.jsx("span",{children:"person"}),e.jsx("span",{title:m.roleId,children:m.roleId}),e.jsx("span",{})]},m.roleId))]}):null]})]})]})]})})})})}function oo({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,libraryId:c,collectionId:p}){const{libraryName:l}=ha(c),[d,w]=n.useState([]),[m,k]=n.useState("loading"),[I,x]=n.useState("idle"),f=n.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),Q=`/#/cogita/library/${c}`,R=()=>{k("loading"),fr({libraryId:c}).then(L=>{w(L),k("idle")}).catch(()=>{w([]),k("error")})};n.useEffect(()=>{R()},[c]);const j=async L=>{try{await br({libraryId:c,shareId:L}),R()}catch{R()}},B=async L=>{const Z=`${f}/${L}`;try{await navigator.clipboard.writeText(Z),x("copied")}catch{x("failed")}};return e.jsx(At,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:Q,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${Q}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[m==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):m==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):d.filter(L=>!p||L.collectionId===p).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:d.filter(L=>!p||L.collectionId===p).map(L=>e.jsxs("div",{className:"cogita-share-row","data-state":L.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:L.revisionName}),e.jsx("div",{className:"cogita-share-meta",children:L.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(L.createdUtc).toLocaleString(),L.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),L.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${f}/${L.shareCode}`}):null]}),L.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[L.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>B(L.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>j(L.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},L.shareId))}),I==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):I==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function lo({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,libraryId:c}){const{libraryName:p}=ha(c),[l,d]=n.useState(null),[w,m]=n.useState(null),[k,I]=n.useState(null),[x,f]=n.useState(null),[Q,R]=n.useState(null),[j,B]=n.useState(null),L=n.useRef(null),Z=O=>{if(!Number.isFinite(O))return"0 B";if(O<1024)return`${O} B`;const he=O/1024;if(he<1024)return`${he.toFixed(1)} KB`;const Se=he/1024;return Se<1024?`${Se.toFixed(1)} MB`:`${(Se/1024).toFixed(1)} GB`},q=async()=>{d(null),R({loadedBytes:0,totalBytes:null,percent:null});try{d(t.cogita.library.overview.exporting);const O=await Jr(c,R),he=URL.createObjectURL(O),Se=document.createElement("a");Se.href=he,Se.download=`cogita-library-${p||c}.json`,Se.click(),URL.revokeObjectURL(he),d(t.cogita.library.overview.exportReady)}catch{d(t.cogita.library.overview.exportFail)}finally{R(O=>O??{loadedBytes:0,totalBytes:null,percent:null})}},E=async O=>{var Se;m(null),I(null),f(null);const he=(Se=O.target.files)==null?void 0:Se[0];if(he)try{m(t.cogita.library.overview.importing),B({loadedBytes:0,totalBytes:he.size,percent:0});const et=await Qr(c,he,B,re=>{const F=re.stage==="infos"?t.cogita.library.overview.importStageInfos:re.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;f(t.cogita.library.overview.importLiveProgress.replace("{stage}",F).replace("{done}",String(re.processed)).replace("{total}",String(re.total)).replace("{infos}",String(re.infos)).replace("{connections}",String(re.connections)).replace("{collections}",String(re.collections)))});I({infos:et.infosImported,connections:et.connectionsImported,collections:et.collectionsImported}),m(t.cogita.library.overview.importDone)}catch(et){const re=et instanceof ys&&et.message?` ${et.message}`:"";m(`${t.cogita.library.overview.importFail}${re}`)}finally{L.current&&(L.current.value="")}};return e.jsx(At,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:q,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:L,type:"file",accept:"application/json",onChange:E})]})]}),Q?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:Q.percent??void 0,max:Q.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",Z(Q.loadedBytes)).replace("{total}",Q.totalBytes?Z(Q.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,j?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:j.percent??void 0,max:j.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",Z(j.loadedBytes)).replace("{total}",j.totalBytes?Z(j.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,l?e.jsx("p",{className:"cogita-help",children:l}):null,w?e.jsx("p",{className:"cogita-help",children:w}):null,x?e.jsx("p",{className:"cogita-help",children:x}):null,k?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(k.infos)).replace("{connections}",String(k.connections)).replace("{collections}",String(k.collections))}):null]})]})})})]})})}function co({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,libraryId:c}){const{libraryName:p}=ha(c),[l,d]=n.useState(""),[w,m]=n.useState([]),k=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(At,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:I=>d(I.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const I=l.trim();I&&(m(x=>[{id:k(),name:I},...x]),d(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[w.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,w.map(I=>e.jsx("button",{type:"button",className:"ghost",children:I.name},I.id))]})]})]})})})]})})}function uo({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,libraryId:c}){const{libraryName:p}=ha(c),[l,d]=n.useState(""),[w,m]=n.useState([]),k=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(At,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:I=>d(I.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const I=l.trim();I&&(m(x=>[{id:k(),name:I},...x]),d(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[w.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,w.map(I=>e.jsx("button",{type:"button",className:"ghost",children:I.name},I.id))]})]})]})})})]})})}function ho({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,libraryId:c}){const{libraryName:p}=ha(c),l=`/#/cogita/library/${c}`,[d,w]=n.useState(""),[m,k]=n.useState([]),[I,x]=n.useState("idle"),[f,Q]=n.useState(0),[R,j]=n.useState(null);n.useEffect(()=>{x("loading");const L=window.setTimeout(()=>{en({libraryId:c,query:d.trim()||void 0,limit:30}).then(Z=>{k(Z.items),Q(Z.total),j(Z.nextCursor??null),x("ready")}).catch(()=>{k([]),Q(0),j(null),x("ready")})},240);return()=>window.clearTimeout(L)},[c,d]);const B=async()=>{if(R){x("loading");try{const L=await en({libraryId:c,query:d.trim()||void 0,limit:30,cursor:R});k(Z=>[...Z,...L.items]),j(L.nextCursor??null),Q(L.total),x("ready")}catch{x("ready")}}};return e.jsx(At,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${l}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:d,onChange:L=>w(L.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(m.length)).replace("{total}",String(f||m.length))}),e.jsx("span",{children:I==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:m.length?m.map(L=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${l}/collections/${L.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:L.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(L.itemCount))," ·"," ",L.notes||t.cogita.library.collections.noNotes]})]})},L.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${l}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),R?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:B,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const Ne=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,ta=(t,a,s,r)=>`${t}:${a}:${s??""}:${r??""}`;function mo({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,libraryId:c,collectionId:p}){ha(c);const l=`/#/cogita/library/${c}`,[d,w]=n.useState(t.cogita.library.collections.defaultName),[m,k]=n.useState(null),[I,x]=n.useState(0),[f,Q]=n.useState([]),[R,j]=n.useState("idle"),[B,L]=n.useState(null),Z=n.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(f.length)).replace("{total}",String(I||f.length)),[t,f.length,I]);n.useEffect(()=>{Rn(c,p).then(E=>{w(E.name),k(E.notes??null),x(E.itemCount)}).catch(()=>{w(t.cogita.library.collections.defaultName),k(null)})},[c,p]),n.useEffect(()=>{j("loading"),tn({libraryId:c,collectionId:p,limit:40}).then(E=>{Q(E.items),L(E.nextCursor??null),x(E.total),j("ready")}).catch(()=>{Q([]),L(null),j("ready")})},[c,p]);const q=async()=>{if(B){j("loading");try{const E=await tn({libraryId:c,collectionId:p,limit:40,cursor:B});Q(O=>[...O,...E.items]),L(E.nextCursor??null),x(E.total),j("ready")}catch{j("ready")}}};return e.jsx(At,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:d}),e.jsx("p",{className:"cogita-library-subtitle",children:m||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${l}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${l}/collections/${p}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${l}/collections/${p}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:Z}),e.jsx("span",{children:R==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:f.length?f.map(E=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:E.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:E.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:E.label}),e.jsx("p",{className:"cogita-card-subtitle",children:E.description})]})},Ne(E))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),B?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:q,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${l}/collections/${p}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const sr=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],go={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},po=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],fo=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function bo({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,libraryId:c,onCreated:p}){const l=Oa(),{libraryName:d}=ha(c),w=`/#/cogita/library/${c}`,[m,k]=n.useState(null),[I,x]=n.useState(""),[f,Q]=n.useState(""),[R,j,B]=hs([]),[L,Z,q]=ms([]),[E,O]=n.useState(null),[he,Se]=n.useState(null),et=n.useRef(null),re=n.useMemo(()=>R.find(ne=>ne.id===E)??null,[R,E]);n.useEffect(()=>{const ne=new URLSearchParams(l.search),je=(ne.get("draft")??"").trim(),de=(ne.get("draftType")??"").trim();if(!je||de!=="info-selection"||et.current===je)return;const se=Ki(c,je);if(!se||se.infoIds.length===0)return;const $e=crypto.randomUUID(),ie=se.infoIds.length>1?crypto.randomUUID():null,Ee=se.infoIds.map((V,ke)=>({id:crypto.randomUUID(),type:"default",position:{x:80,y:80+ke*100},data:{nodeType:"source.info",label:"Selected info",params:{infoId:V,infoType:"any"}}})),Be=ie?[{id:ie,type:"default",position:{x:360,y:120+Math.max(0,(se.infoIds.length-1)*50)},data:{nodeType:"logic.or",label:"Selected infos",params:{}}}]:[],Je={id:$e,type:"default",position:{x:660,y:140+Math.max(0,(se.infoIds.length-1)*35)},data:{nodeType:"output.collection",label:"Collection output",params:{}}},it=Ee.map(V=>({id:crypto.randomUUID(),source:V.id,target:ie??$e}));ie&&it.push({id:crypto.randomUUID(),source:ie,target:$e}),j([...Ee,...Be,Je]),Z(it),O($e),Se(`Draft loaded from ${se.infoIds.length} selected infos. Set name and save to create collection.`),et.current=je},[c,l.search,Z,j]);const F=ne=>{var $e;const je=crypto.randomUUID(),de=(($e=sr.find(ie=>ie.type===ne))==null?void 0:$e.label)??ne,se={...go[ne]};j(ie=>[...ie,{id:je,type:"default",position:{x:120+ie.length*40,y:120+ie.length*40},data:{nodeType:ne,label:de,params:se}}]),O(je)},ve=n.useCallback(ne=>{Z(je=>gs({...ne,id:crypto.randomUUID()},je))},[Z]),J=ne=>{re&&j(je=>je.map(de=>de.id===re.id?{...de,data:{...de.data,params:ne}}:de))},ue=async()=>{if(Se(null),!I.trim()){Se(t.cogita.library.collections.saveRequiredName);return}try{const ne={nodes:R.map(se=>({nodeId:se.id,nodeType:se.data.nodeType,payload:{position:se.position,params:se.data.params}})),edges:L.map(se=>({edgeId:se.id,fromNodeId:se.source,fromPort:se.sourceHandle??null,toNodeId:se.target,toPort:se.targetHandle??null}))};let je=m,de=!1;if(je)await yr({libraryId:c,collectionId:je,nodes:ne.nodes,edges:ne.edges});else{const se=await Hr({libraryId:c,name:I.trim(),notes:f.trim()||void 0,items:[],graph:ne});je=se.collectionId,de=!0,k(se.collectionId)}Se(de?t.cogita.library.collections.saveSuccess:t.cogita.library.graph.saveSuccess),p(je)}catch{Se(m?t.cogita.library.graph.saveFail:t.cogita.library.collections.saveFail)}};return e.jsx(At,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.createKicker}),e.jsx("h1",{className:"cogita-library-title",children:d}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.createSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:w,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${w}/collections`,children:t.cogita.library.actions.collections}),e.jsx("button",{type:"button",className:"cta",onClick:ue,children:t.cogita.library.actions.saveCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.collectionInfoTitle}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{value:I,onChange:ne=>x(ne.target.value),placeholder:t.cogita.library.collections.namePlaceholder})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.notesLabel}),e.jsx("textarea",{value:f,onChange:ne=>Q(ne.target.value),placeholder:t.cogita.library.collections.notesPlaceholder})]}),he?e.jsx("p",{className:"cogita-help",children:he}):null,e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:sr.map(ne=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>F(ne.type),children:ne.label},ne.type))})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(Mn,{nodes:R,edges:L,onNodesChange:B,onEdgesChange:q,onConnect:ve,onNodeClick:(ne,je)=>O(je.id),fitView:!0,children:[e.jsx(Ln,{color:"rgba(120,160,200,0.2)"}),e.jsx(An,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),re?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:re.data.label}),re.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:c,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:re.data.params.tagId?{id:re.data.params.tagId,label:re.data.params.tagLabel??"",infoType:"topic"}:null,onChange:ne=>J({...re.data.params,tagId:(ne==null?void 0:ne.id)??null,tagLabel:(ne==null?void 0:ne.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:re.data.params.scope??"any",onChange:ne=>J({...re.data.params,scope:ne.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),re.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:c,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:re.data.params.languageId?{id:re.data.params.languageId,label:re.data.params.languageLabel??"",infoType:"language"}:null,onChange:ne=>J({...re.data.params,languageId:(ne==null?void 0:ne.id)??null,languageLabel:(ne==null?void 0:ne.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:re.data.params.scope??"any",onChange:ne=>J({...re.data.params,scope:ne.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),re.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:re.data.params.infoType??"word",onChange:ne=>J({...re.data.params,infoType:ne.target.value}),children:fo.map(ne=>e.jsx("option",{value:ne.value,children:ne.label},ne.value))})]}),e.jsx(Yt,{libraryId:c,infoType:re.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:re.data.params.infoId?{id:re.data.params.infoId,label:re.data.params.infoLabel??"",infoType:re.data.params.infoType??"word"}:null,onChange:ne=>J({...re.data.params,infoId:(ne==null?void 0:ne.id)??null,infoLabel:(ne==null?void 0:ne.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),re.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:re.data.params.connectionType??"translation",onChange:ne=>J({...re.data.params,connectionType:ne.target.value}),children:po.map(ne=>e.jsx("option",{value:ne.value,children:ne.label},ne.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:re.data.params.connectionId??"",onChange:ne=>J({...re.data.params,connectionId:ne.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(re.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const ca=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const a=t.length,s=t.filter(u=>u.correct).length,r=En(js(t));return{score:Math.round(Math.max(0,Math.min(100,r.knowness*100))*100)/100,total:a,correct:s,lastReviewedUtc:r.lastReviewedUtc??null}},yo=t=>{if(t.maskBase64)try{const a=Wr(t.maskBase64);if(!a.length)return t.correct?1:0;const s=a.reduce((r,i)=>r+i,0);return Math.max(0,Math.min(1,s/a.length/255))}catch{return t.correct?1:0}return t.correct?1:0},js=t=>t.map(a=>({correctness:yo(a),createdUtc:a.createdUtc})),En=(t,a=Date.now())=>{var I;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const r=t.slice().sort((x,f)=>x.createdUtc.localeCompare(f.createdUtc)).slice(-5),i=r.reduce((x,f)=>x+f.correctness,0)/r.length,u=5,o=2,y=.15;let h=0,b=0;for(let x=0;x<r.length;x+=1){const f=new Date(r[x].createdUtc).getTime(),Q=x===r.length-1?a:new Date(r[x+1].createdUtc).getTime(),R=Math.max(0,(Q-f)/(1e3*60)),j=1-Math.exp(-R/u);h+=j,r[x].correctness>.5&&(b+=y)}let c=i*h*o+b;const p=((I=r[r.length-1])==null?void 0:I.createdUtc)??null,l=p?Math.max(0,(a-new Date(p).getTime())/(1e3*60)):0,w=1/(1+Math.log1p(l/60));return c*=w,r.length===1&&r[0].correctness>.5&&(c+=5.44*Math.exp(-l/2)),{knowness:c,avgCorrectness:i,lastReviewedUtc:p}},Va=t=>{const a=t.slice();for(let s=a.length-1;s>0;s-=1){const r=Math.floor(Math.random()*(s+1));[a[s],a[r]]=[a[r],a[s]]}return a},fn=t=>t[Math.floor(Math.random()*t.length)],xo=(t,a)=>{const s=new Map;return t.forEach(r=>s.set(r,Math.random())),t.sort((r,i)=>{const u=a(r)-a(i);return u!==0?u:(s.get(r)??0)-(s.get(i)??0)})},Fn=(t,a,s,r,i)=>{if(!t.length)return null;const u=t.filter(y=>!(i!=null&&i.has(Ne(y))));if(u.length===0)return null;const o=u.filter(y=>Ne(y)!==s);return fn(o.length?o:u)},vo=(t,a,s,r,i)=>{if(!t.length)return null;let u=Number.POSITIVE_INFINITY;for(const b of t){const c=Ne(b);if(s.has(c))continue;const p=a[c]??1;p<u&&(u=p)}if(!Number.isFinite(u))return null;const o=t.filter(b=>{const c=Ne(b);return!s.has(c)&&(a[c]??1)===u}),y=o.filter(b=>!i||Ne(b)!==i),h=r?y.filter(b=>!r.has(Ne(b))):y;return h.length>0?fn(h):y.length>0?fn(y):i&&o.some(b=>Ne(b)===i)?o.find(b=>Ne(b)===i)??null:o.length?fn(o):null},Tr=(t,a,s,r,i)=>{const u=[],o=t.filter(h=>!i.has(Ne(h))&&!s.has(Ne(h))&&(a[Ne(h)]??0)<1),y=xo(o,h=>a[Ne(h)]??0);for(const h of y){if(u.length>=r)break;u.push(h),i.add(Ne(h))}if(u.length<r){const h=Va(t.filter(b=>!i.has(Ne(b))&&s.has(Ne(b))));for(const b of h){if(u.length>=r)break;u.push(b),i.add(Ne(b))}}return u},wo=(t,a,s,r)=>Tr(t,a,s,r,new Set),ks=(t,a,s,r,i,u)=>{const o=Math.max(1,s.stackSize??a),h=Va(t).filter((w,m,k)=>k.findIndex(I=>Ne(I)===Ne(w))===m),b=wo(h,r,i,o),c=new Set,p=new Set,l=Fn(b,{},null,c,p),d=l?[l]:[];return l&&p.add(Ne(l)),{queue:d,meta:{pool:h,active:b,knownessMap:r,unknownSet:i,outcomesById:u,asked:c,queued:p}}},ds={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,a)=>{const r=Va(t).filter((i,u,o)=>o.findIndex(y=>Ne(y)===Ne(i))===u);return{queue:r.slice(0,Math.min(a,r.length)),meta:{}}},applyOutcome:t=>t},jo={id:"random-once",labelKey:"modeValueRandomOnce",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:()=>Number.MAX_SAFE_INTEGER,prepare:t=>({queue:Va(t).filter((r,i,u)=>u.findIndex(o=>Ne(o)===Ne(r))===i),meta:{}}),applyOutcome:t=>t},Ns=(t,a,s,r)=>{const i=Math.max(1,s.stackSize??a),o=Va(t).filter((m,k,I)=>I.findIndex(x=>Ne(x)===Ne(m))===k),y={},h=new Set,b=new Set,c=new Set,p=Math.max(1,s.levels??1);o.forEach(m=>{const k=Ne(m),I=r==null?void 0:r[k],x=typeof I=="number"&&Number.isFinite(I)?I:1;y[k]=Math.min(p,Math.max(1,Math.round(x)))});const l=[];if(o.length>0){const m=new Map;o.forEach(I=>{var f;const x=y[Ne(I)]??1;m.has(x)||m.set(x,[]),(f=m.get(x))==null||f.push(I)});const k=Array.from(m.keys()).sort((I,x)=>I-x);for(const I of k){if(l.length>=i)break;const x=Va(m.get(I)??[]);for(const f of x){if(l.length>=i)break;l.push(f)}}}const d=Fn(l,y,null,h,b),w=d?[d]:[];return d&&b.add(Ne(d)),{queue:w,meta:{pool:o,active:l,levelMap:y,asked:h,queued:b,wrongSinceCorrect:c}}},ko={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,a)=>Math.max(1,a.stackSize??t),getProgressTotal:()=>null,prepare:(t,a,s)=>Ns(t,a,s),applyOutcome:(t,a,s,r,i)=>{if(!a)return t;const u=Math.max(1,r.levels??1),o=t.meta.pool??[],y=t.meta.active??[],h={...t.meta.levelMap??{}},b=new Set(t.meta.asked??[]),c=new Set(t.meta.queued??[]),p=new Set(t.meta.wrongSinceCorrect??[]),l=Ne(a);c.delete(l),b.add(l);const d=h[l]??1;i.correct?(h[l]=p.has(l)?1:Math.min(d+1,u),p.delete(l)):(h[l]=1,p.add(l));const w=i.correct?y.filter(I=>Ne(I)!==l):y.slice();if(i.correct&&w.length<Math.max(1,r.stackSize??1)){const I=new Set(w.map(f=>Ne(f))),x=vo(o,h,I,b,l);x&&w.push(x)}const m=t.queue.slice(),k=Fn(w,h,l,b,c);return k&&(m.push(k),c.add(Ne(k))),{queue:m,meta:{pool:o,active:w,levelMap:h,asked:b,queued:c,wrongSinceCorrect:p}}}},No={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,a)=>Math.max(1,a.stackSize??t),getProgressTotal:()=>null,prepare:(t,a,s)=>ks(t,a,s,{},new Set,{}),applyOutcome:(t,a,s,r,i)=>{if(!a)return t;const u=t.meta.pool??[],o=t.meta.active??[],y={...t.meta.knownessMap??{}},h=new Set(t.meta.unknownSet??[]),b={...t.meta.outcomesById??{}},c=new Set(t.meta.asked??[]),p=new Set(t.meta.queued??[]),l=Ne(a);p.delete(l),c.add(l);const d={correctness:Math.max(0,Math.min(1,i.correctness??(i.correct?1:0))),createdUtc:i.createdUtc??new Date().toISOString()},m=(b[l]??[]).concat(d).sort((R,j)=>R.createdUtc.localeCompare(j.createdUtc)).slice(-5);b[l]=m,h.delete(l);const k=Date.now();u.forEach(R=>{const j=Ne(R),B=b[j]??[];if(B.length===0){y[j]=0,h.add(j);return}const L=En(B,k);y[j]=L.knowness});const I=o.slice();if((y[l]??0)>=1){const R=I.filter(j=>Ne(j)!==l);I.length=0,I.push(...R)}const f=Math.max(1,r.stackSize??s);if(I.length<f){const R=new Set(I.map(B=>Ne(B))),j=Tr(u,y,h,f-I.length,R);I.push(...j)}const Q=t.queue.slice();if(Q.length===0||Ne(Q[Q.length-1])===l){const R=Fn(I,{},l,c,p);R&&(Q.push(R),p.add(Ne(R)))}return{queue:Q,meta:{pool:u,active:I,knownessMap:y,unknownSet:h,outcomesById:b,asked:c,queued:p}}}},us={random:ds,"random-once":jo,levels:ko,temporal:No},So=Object.values(us),Za=t=>{if(!t)return ds;const a=t.trim().toLowerCase();return a==="random"||a==="levels"||a==="temporal"||a==="random-once"?us[a]:a==="random_once"?us["random-once"]:ds},Kn=(t,a)=>{const s={...t.defaultSettings};return a&&Object.entries(a).forEach(([r,i])=>{typeof i=="number"&&Number.isFinite(i)&&(s[r]=i),typeof i=="string"&&(s[r]=i)}),t.settingsFields.forEach(r=>{var u;const i=s[r.key];if(r.type==="number"){if(typeof i!="number"||Number.isNaN(i)){s[r.key]=t.defaultSettings[r.key]??0;return}r.min!==void 0&&(s[r.key]=Math.max(r.min,s[r.key])),r.max!==void 0&&(s[r.key]=Math.min(r.max,s[r.key]));return}if(r.type==="select"){const o=((u=r.options)==null?void 0:u.map(y=>y.value))??[];(typeof i!="string"||o.length>0&&!o.includes(i))&&(s[r.key]=t.defaultSettings[r.key]??o[0]??"")}}),s},Cr=(t,a)=>{const s={};return t.settingsFields.forEach(r=>{const i=a.get(r.key);if(i){if(r.type==="number"){const u=Number(i);Number.isNaN(u)||(s[r.key]=u);return}s[r.key]=i}}),Kn(t,s)},To=(t,a)=>{const s=new URLSearchParams;return t.settingsFields.forEach(r=>{const i=a[r.key];(typeof i=="number"||typeof i=="string")&&s.set(r.key,String(i))}),s};function rr({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,libraryId:c,collectionId:p,revisionId:l}){const d=nn(),{libraryName:w}=ha(c),m=`/#/cogita/library/${c}`,[k,I]=n.useState(t.cogita.library.collections.defaultName),[x,f]=n.useState([]),[Q,R]=n.useState(p??""),[j,B]=n.useState(""),[L,Z]=n.useState(20),[q,E]=n.useState("random"),[O,he]=n.useState({}),[Se,et]=n.useState("exact"),[re,F]=n.useState([]),[ve,J]=n.useState(null),[ue,ne]=n.useState([]),[je,de]=n.useState([]),[se,$e]=n.useState(""),[ie,Ee]=n.useState("all"),[Be,Je]=n.useState("all"),[it,V]=n.useState("all"),[ke,He]=n.useState("idle"),[Pe,Oe]=n.useState(null),[ot,wt]=n.useState("idle"),[ft,_e]=n.useState("idle"),[Ze,ut]=n.useState("idle"),[Qe,be]=n.useState([]),fe=n.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),we=n.useMemo(()=>Za(q),[q]),M=n.useMemo(()=>Kn(we,O),[we,O]),$=n.useMemo(()=>To(we,M).toString(),[we,M]),D=n.useMemo(()=>new Map(x.map(v=>[v.collectionId,v.name])),[x]),z=n.useMemo(()=>{const v=new Set,G=[];return je.forEach(te=>{const W=(te.revisionType??te.mode??"random").toLowerCase();v.has(W)||(v.add(W),G.push(W))}),G},[je]),H=n.useMemo(()=>{const v=new Set,G=[];return je.forEach(te=>{const W=(te.mode??"random").toLowerCase();v.has(W)||(v.add(W),G.push(W))}),G},[je]),ae=n.useMemo(()=>{const v=se.trim().toLocaleLowerCase();return je.filter(G=>{const te=(G.revisionType??G.mode??"random").toLowerCase(),W=(G.mode??"random").toLowerCase(),Ie=D.get(G.collectionId)??"";return ie!=="all"&&te!==ie||Be!=="all"&&W!==Be||it!=="all"&&G.collectionId!==it?!1:v?G.name.toLocaleLowerCase().includes(v)||Ie.toLocaleLowerCase().includes(v)||te.includes(v)||W.includes(v):!0})},[D,it,Be,se,ie,je]);n.useEffect(()=>{R(p??"")},[p]),n.useEffect(()=>{if(!Q){I(t.cogita.library.collections.defaultName);return}Rn(c,Q).then(v=>I(v.name)).catch(()=>I(t.cogita.library.collections.defaultName))},[t.cogita.library.collections.defaultName,c,Q]),n.useEffect(()=>{en({libraryId:c,limit:200}).then(v=>f(v.items.map(G=>({collectionId:G.collectionId,name:G.name})))).catch(()=>f([]))},[c]),n.useEffect(()=>{ps({libraryId:c}).then(v=>de(v)).catch(()=>de([]))},[c]),n.useEffect(()=>{l&&xs({libraryId:c,revisionId:l}).then(v=>{R(v.collectionId),B(v.name),E(v.mode||"random"),et(v.check||"exact"),Z(v.limit||20),he(v.revisionSettings??{})}).catch(()=>{B("")})},[c,l]),n.useEffect(()=>{xr({libraryId:c}).then(v=>{F(v),!ve&&v.length>0&&J(v[0].roleId)}).catch(()=>{F([])})},[c]);const S=()=>{_e("loading"),fr({libraryId:c}).then(v=>{ne(v),_e("idle")}).catch(()=>{ne([]),_e("error")})};n.useEffect(()=>{S()},[c]),n.useEffect(()=>{if(!l){be([]);return}Gr({libraryId:c,revisionId:l}).then(v=>be(v)).catch(()=>be([]))},[c,l]);const C=async()=>{He("working"),wt("idle");try{if(!l){He("error");return}const v=await Xr({libraryId:c,revisionId:l});Oe(`${fe}/${v.shareCode}${$?`?${$}`:""}`),He("ready"),S()}catch{He("error")}},ce=async()=>{if(l){ut("saving");try{await Yr({libraryId:c,collectionId:p??Q,revisionId:l,targetCollectionId:Q,name:j||k,revisionType:we.id,revisionSettings:M,mode:q,check:Se,limit:L}),ut("saved"),Q&&d(`/cogita/library/${c}/revisions/${encodeURIComponent(l)}`,{replace:!0})}catch{ut("error")}}},_=async()=>{if(Pe)try{await navigator.clipboard.writeText(Pe),wt("copied")}catch{wt("failed")}},oe=async v=>{try{await br({libraryId:c,shareId:v}),S()}catch{S()}};return e.jsx(At,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:k}),e.jsx("p",{className:"cogita-library-subtitle",children:w})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:m,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${m}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:Q?`${m}/collections/${Q}`:`${m}/collections`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${m}${l?`/revisions/${encodeURIComponent(l)}/run`:Q?`/collections/${Q}/revision/run`:"/revision/run"}?mode=${encodeURIComponent(q)}&check=${encodeURIComponent(Se)}&limit=${L}${$?`&${$}`:""}${ve?`&reviewer=${encodeURIComponent(ve)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:se,onChange:v=>$e(v.target.value),placeholder:t.cogita.workspace.revisionForm.namePlaceholder})}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsxs("select",{value:ie,onChange:v=>Ee(v.target.value),children:[e.jsx("option",{value:"all",children:t.cogita.library.infoTypes.any}),z.map(v=>e.jsx("option",{value:v,children:t.cogita.library.revision[Za(v).labelKey]},`type:${v}`))]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsxs("select",{value:Be,onChange:v=>Je(v.target.value),children:[e.jsx("option",{value:"all",children:t.cogita.library.infoTypes.any}),H.map(v=>e.jsx("option",{value:v,children:v},`mode:${v}`))]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsxs("select",{value:it,onChange:v=>V(v.target.value),children:[e.jsx("option",{value:"all",children:t.cogita.library.infoTypes.any}),x.map(v=>e.jsx("option",{value:v.collectionId,children:v.name},`filter:${v.collectionId}`))]})]}),e.jsxs("div",{className:"cogita-card-list","data-view":"list",children:[e.jsxs("a",{className:"cogita-card-select",href:`${m}/revisions/new`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:t.cogita.workspace.revisionForm.createAction})]}),ae.map(v=>e.jsxs("a",{className:"cogita-card-select",href:`${m}/revisions/${encodeURIComponent(v.revisionId)}`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.revision[Za((v.revisionType??v.mode??"random").toLowerCase()).labelKey]}),e.jsx("h3",{className:"cogita-card-title",children:v.name}),e.jsxs("p",{className:"cogita-card-meta",children:[D.get(v.collectionId)??v.collectionId," · ",v.mode]})]},v.revisionId)),ae.length===0?e.jsx("p",{className:"cogita-help",children:t.cogita.workspace.status.noRevisions}):null]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsx("select",{value:Q,onChange:v=>R(v.target.value),children:x.map(v=>e.jsx("option",{value:v.collectionId,children:v.name},v.collectionId))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:j,onChange:v=>B(v.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:q,onChange:v=>E(v.target.value),children:So.map(v=>e.jsx("option",{value:v.id,children:t.cogita.library.revision[v.labelKey]},v.id))})]}),we.settingsFields.map(v=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[v.labelKey]}),v.type==="select"?e.jsx("select",{value:String(M[v.key]??""),onChange:G=>he(te=>({...te,[v.key]:G.target.value})),children:(v.options??[]).map(G=>e.jsx("option",{value:G.value,children:t.cogita.library.revision[G.labelKey]},G.value))}):e.jsx("input",{type:"number",min:v.min,max:v.max,step:v.step,value:M[v.key]??0,onChange:G=>he(te=>({...te,[v.key]:Number(G.target.value||0)}))})]},v.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),we.id==="random"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:L,onChange:v=>Z(Number(v.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:ve??"",onChange:v=>J(v.target.value||null),children:re.map(v=>e.jsx("option",{value:v.roleId,children:v.label},v.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[l?e.jsx("button",{type:"button",className:"cta ghost",onClick:ce,disabled:Ze==="saving",children:Ze==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${m}${l?`/revisions/${encodeURIComponent(l)}/run`:Q?`/collections/${Q}/revision/run`:"/revision/run"}?mode=${encodeURIComponent(q)}&check=${encodeURIComponent(Se)}&limit=${L}${$?`&${$}`:""}${ve?`&reviewer=${encodeURIComponent(ve)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision}),l?e.jsx("a",{className:"cta ghost",href:`/#/cogita/live-revision-host/${encodeURIComponent(c)}/${encodeURIComponent(l)}`,children:"Live session"}):null,e.jsx("a",{className:"cta ghost",href:`/#/cogita/live-sessions/${encodeURIComponent(c)}`,children:"Active live sessions"})]}),Ze==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),Pe?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:Pe,readOnly:!0})]}):null,ke==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,ot==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):ot==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:C,disabled:ke==="working",children:ke==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),Pe?e.jsx("button",{type:"button",className:"cta ghost",onClick:_,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),ft==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):ue.filter(v=>!l||v.revisionId===l).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:ue.filter(v=>!l||v.revisionId===l).map(v=>e.jsxs("div",{className:"cogita-share-row","data-state":v.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:v.revisionName}),e.jsx("div",{className:"cogita-share-meta",children:v.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(v.createdUtc).toLocaleString(),v.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),v.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>oe(v.shareId),children:t.cogita.library.revision.shareRevokeAction})]},v.shareId))})]})]}),l?e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Live sessions"}),e.jsx("h3",{className:"cogita-detail-title",children:"Active sessions for this revision"})]})}),e.jsx("div",{className:"cogita-detail-body",children:Qe.length===0?e.jsx("p",{className:"cogita-help",children:"No active sessions."}):e.jsx("div",{className:"cogita-share-list",children:Qe.map(v=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsxs("div",{children:[e.jsx("strong",{children:v.title||v.sessionId}),e.jsxs("div",{className:"cogita-share-meta",children:[v.status," · participants: ",v.participantCount]})]}),e.jsx("a",{className:"ghost",href:`/#/cogita/live-sessions/${encodeURIComponent(c)}`,children:"Open sessions"})]},`revision-live:${v.sessionId}`))})})]}):null]})]})})})]})})}const Zn=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function Ir(t,a,s){if(!t)return null;const r=new Map(t.nodes.map(R=>[R.id,R])),i=new Map,u=new Set,o=R=>{if(typeof R=="number")return R;if(typeof R=="string"){const j=Number(R);return Number.isFinite(j)?j:0}return 0},y=R=>{if(i.has(R))return i.get(R);if(u.has(R))return 0;const j=r.get(R);if(!j)return 0;u.add(R);const B=Z=>{var E,O;return(Z?((E=j.inputsByHandle)==null?void 0:E[Z])??[]:j.inputs??((O=j.inputsByHandle)==null?void 0:O.in)??[]).map(he=>y(he))};let L=0;switch(j.type){case"input.random":{const Z=j.min??0,q=j.max??Z+10,E=Math.min(Z,q),O=Math.max(Z,q);L=Math.floor(Math.random()*(O-E+1))+E;break}case"input.const":{L=j.value??0;break}case"input.list":{const Z=(j.list??[]).filter(Boolean),q=Math.round(o(B("index")[0]));L=Z.length?Z[Math.max(0,Math.min(Z.length-1,q))]:String(q);break}case"compute.add":{L=B("in").map(q=>o(q)).reduce((q,E)=>q+E,0);break}case"compute.sub":{const Z=B("add").map(E=>o(E)),q=B("sub").map(E=>o(E));L=Z.reduce((E,O)=>E+O,0)-q.reduce((E,O)=>E+O,0);break}case"compute.mul":{const Z=B("in").map(q=>o(q));L=Z.length?Z.reduce((q,E)=>q*E,1):0;break}case"compute.div":{const Z=o(B("num")[0]),q=B("den").map(E=>o(E)).reduce((E,O)=>E+O,0);L=Math.abs(q)<Number.EPSILON?0:Z/q;break}case"compute.pow":{const Z=o(B("base")[0]),q=o(B("exp")[0]);L=Math.pow(Z,q);break}case"compute.exp":{const Z=o(B("base")[0]),q=o(B("exp")[0]);L=Math.pow(Z,q);break}case"compute.log":{const Z=o(B("value")[0]),q=o(B("base")[0]),E=Math.max(Z,Number.EPSILON);L=Math.abs(q)<Number.EPSILON?Math.log(E):Math.log(E)/Math.log(q);break}case"compute.abs":{L=Math.abs(o(B("in")[0]));break}case"compute.min":{const Z=B("in").map(q=>o(q));L=Z.length?Math.min(...Z):0;break}case"compute.max":{const Z=B("in").map(q=>o(q));L=Z.length?Math.max(...Z):0;break}case"compute.floor":{L=Math.floor(o(B("in")[0]));break}case"compute.ceil":{L=Math.ceil(o(B("in")[0]));break}case"compute.round":{L=Math.round(o(B("in")[0]));break}case"compute.mod":{const Z=o(B("a")[0]),q=o(B("b")[0]);L=Math.abs(q)<Number.EPSILON?0:Z%q;break}case"compute.concat":{const q=["in1","in2","in3","in4","in5","in6"].flatMap(Se=>B(Se)),E=q.length?q:B("in");L=(E.length?E:B()).map(Se=>Se==null?"":String(Se)).join("");break}case"compute.trim":{const Z=B("text")[0]??B("in")[0]??"",q=Z==null?"":String(Z),E=Math.max(0,Math.round(o(B("start")[0]))),O=Math.max(0,Math.round(o(B("end")[0])));E+O>=q.length?L="":L=q.substring(E,q.length-O);break}case"output":{L=B("in")[0]??0;break}default:L=0}return u.delete(R),i.set(R,L),L},h=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(R=>R.type==="output").map(R=>R.id);t.nodes.forEach(R=>y(R.id)),h.forEach(R=>y(R));const b=R=>Math.abs(R%1)<1e-5?String(Math.round(R)):R.toFixed(3).replace(/\.?0+$/,""),c=R=>typeof R=="number"?b(R):R??"",p=new Map;h.forEach(R=>{var q,E,O,he;const j=r.get(R);if(!j)return;const B=(E=(q=j.inputsByHandle)==null?void 0:q.name)==null?void 0:E[0],L=B?c(i.get(B)):"",Z=(L==null?void 0:L.toString().trim())||((O=j.outputLabel)==null?void 0:O.trim())||((he=j.name)==null?void 0:he.trim())||R;p.set(R,Z)});const l={},d={},w={};h.forEach(R=>{var L,Z;const j=r.get(R);if(!j)return;const B=p.get(R)??(((L=j.outputLabel)==null?void 0:L.trim())||((Z=j.name)==null?void 0:Z.trim())||R);l[B]=c(i.get(R)),j.name&&(d[j.name.trim()]=B),d[R]=B});const m=(R,j)=>{let B=R;return t.nodes.forEach(L=>{var he,Se;const Z=c(i.get(L.id)),q=h.includes(L.id),E=q?p.get(L.id)??((he=L.outputLabel)==null?void 0:he.trim())??((Se=L.name)==null?void 0:Se.trim())??L.id:"",O=q&&j?E:Z;B=B.replace(new RegExp(`\\{\\s*${Zn(L.id)}\\s*\\}`,"gi"),O),L.name&&(B=B.replace(new RegExp(`\\{\\s*${Zn(L.name)}\\s*\\}`,"gi"),O)),q&&L.outputLabel&&(B=B.replace(new RegExp(`\\{\\s*${Zn(L.outputLabel)}\\s*\\}`,"gi"),E))}),B},k=a;let I=k.trim().length>0?k:"";I||(I=h.length?`Compute ${h.join(", ")}`:"Compute"),I=m(I,!0);const x=(s==null?void 0:s.trim())??"",f=x?m(x,!1):"",Q={};return i.forEach((R,j)=>{Q[j]=R,w[j]=c(R);const B=r.get(j);B!=null&&B.name&&(w[B.name.trim()]=c(R))}),{prompt:I,answers:l,values:Q,answerText:f,outputVariables:d,variableValues:w}}function Mr(t){var s;const a=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((s=a[0])==null?void 0:s[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const es=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function Lr({outcomes:t}){const[a,s]=n.useState("day"),r=n.useMemo(()=>{const i=es.find(y=>y.id===a)??es[1],u=Date.now()-i.ms,o=t.filter(y=>new Date(y.createdUtc).getTime()>=u);return ca(o)},[t,a]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:es.map(i=>e.jsx("button",{type:"button",className:"ghost","data-active":a===i.id,onClick:()=>s(i.id),children:i.label},i.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[r.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[r.correct," / ",r.total]})]})}const Co="cogita-revision",Io=1,jn="outcomes",Mo=()=>new Promise((t,a)=>{const s=indexedDB.open(Co,Io);s.onupgradeneeded=()=>{const r=s.result;if(!r.objectStoreNames.contains(jn)){const i=r.createObjectStore(jn,{keyPath:"id"});i.createIndex("byItem","itemKey",{unique:!1}),i.createIndex("byPending","pending",{unique:!1})}},s.onerror=()=>a(s.error),s.onsuccess=()=>t(s.result)}),sn=async(t,a)=>{const s=await Mo();return new Promise((r,i)=>{const u=s.transaction(jn,t),o=u.objectStore(jn);a(o).then(r).catch(i),u.onerror=()=>i(u.error)})},Ar=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const a=Array.from(t).map(s=>s.toString(16).padStart(2,"0"));return`${a.slice(0,4).join("")}-${a.slice(4,6).join("")}-${a.slice(6,8).join("")}-${a.slice(8,10).join("")}-${a.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},Lo=()=>{const t="cogita_revision_client_id",a=localStorage.getItem(t);if(a)return a;const s=Ar();return localStorage.setItem(t,s),s},Ao=()=>{const t="cogita_revision_client_seq",a=Number(localStorage.getItem(t)??"0"),s=Number.isFinite(a)?a+1:1;return localStorage.setItem(t,String(s)),s},Rr=(t,a,s,r)=>ta(t,a,s,r),kn=async t=>{const a=Lo(),s=Ao(),r=new Date().toISOString(),i={...t,clientId:a,clientSequence:s,createdUtc:r,id:Ar(),pending:!0};return await sn("readwrite",u=>new Promise((o,y)=>{const h={...i,itemKey:Rr(i.itemType,i.itemId,i.checkType,i.direction)},b=u.add(h);b.onsuccess=()=>o(),b.onerror=()=>y(b.error)})),i},Nn=async(t,a,s,r)=>{if(!a)return[];try{const i=Rr(t,a,s,r);return await sn("readonly",u=>new Promise((o,y)=>{const b=u.index("byItem").getAll(i);b.onsuccess=()=>{const p=(b.result??[]).map(l=>({itemType:l.itemType,itemId:l.itemId,checkType:l.checkType??null,direction:l.direction??null,revisionType:l.revisionType,evalType:l.evalType,correct:l.correct,createdUtc:l.createdUtc,maskBase64:l.maskBase64,payloadBase64:l.payloadBase64,payloadHashBase64:l.payloadHashBase64,clientId:l.clientId,clientSequence:l.clientSequence,personRoleId:l.personRoleId??null})).sort((l,d)=>l.createdUtc.localeCompare(d.createdUtc));o(p)},b.onerror=()=>y(b.error)}))}catch{return[]}},da=async()=>{try{return await sn("readonly",t=>new Promise((a,s)=>{const r=t.getAll();r.onsuccess=()=>{const u=(r.result??[]).map(o=>({itemType:o.itemType,itemId:o.itemId,checkType:o.checkType??null,direction:o.direction??null,revisionType:o.revisionType,evalType:o.evalType,correct:o.correct,createdUtc:o.createdUtc,maskBase64:o.maskBase64,payloadBase64:o.payloadBase64,payloadHashBase64:o.payloadHashBase64,clientId:o.clientId,clientSequence:o.clientSequence,personRoleId:o.personRoleId??null}));a(u)},r.onerror=()=>s(r.error)}))}catch{return[]}},Ro=async(t=100)=>{try{return await sn("readonly",a=>new Promise((s,r)=>{const u=a.index("byPending").getAll(!0);u.onsuccess=()=>{const o=u.result??[];s(o.slice(0,t))},u.onerror=()=>r(u.error)}))}catch{return[]}},$o=async t=>{if(t.length!==0)try{await sn("readwrite",a=>new Promise((s,r)=>{let i=t.length;t.forEach(u=>{const o=a.get(u);o.onsuccess=()=>{const y=o.result;if(y){y.pending=!1;const h=a.put(y);h.onsuccess=()=>{i-=1,i===0&&s()},h.onerror=()=>r(h.error)}else i-=1,i===0&&s()},o.onerror=()=>r(o.error)})}))}catch{}},ts=async(t,a)=>{const s=await Ro(200);if(s.length===0)return;const r=new Map;s.forEach(i=>{var o;const u=i.personRoleId??a??"";r.has(u)||r.set(u,[]),(o=r.get(u))==null||o.push(i)});for(const[i,u]of r.entries()){const o=u.map(y=>({itemType:y.itemType,itemId:y.itemId,checkType:y.checkType??null,direction:y.direction??null,revisionType:y.revisionType,evalType:y.evalType,correct:y.correct,clientId:y.clientId,clientSequence:y.clientSequence,maskBase64:y.maskBase64??null,payloadHashBase64:y.payloadHashBase64??null,payloadBase64:y.payloadBase64??null,personRoleId:i||null}));try{await Zr({libraryId:t,outcomes:o}),await $o(u.map(y=>y.id))}catch{}}},Gt=()=>({text:"",selection:[],booleanAnswer:null,ordering:[],matchingRows:[],matchingSelection:[]});function Po(t){const a=[...t];for(let s=a.length-1;s>0;s-=1){const r=Math.floor(Math.random()*(s+1));[a[s],a[r]]=[a[r],a[s]]}return a}function Sn(t,a){const s=ws(t);if(!s)return null;const r=Sr(s),i=(r.question||r.title||a||"").trim();if(r.type==="selection"){const y=r.options??[],h=Array.isArray(r.answer)?r.answer:[];return{promptText:i,promptModel:{kind:"selection",options:y},expectedModel:h,promptPayload:{kind:"selection",prompt:i,options:y,multiple:h.length!==1},initialAnswers:Gt()}}if(r.type==="truefalse"){const y=typeof r.answer=="boolean"?r.answer:!1;return{promptText:i,promptModel:{kind:"boolean"},expectedModel:y,promptPayload:{kind:"boolean",prompt:i},initialAnswers:Gt()}}if(r.type==="ordering"){const y=r.options??[];return{promptText:i,promptModel:{kind:"ordering",options:y},expectedModel:y,promptPayload:{kind:"ordering",prompt:i,options:y},initialAnswers:{...Gt(),ordering:Po(y)}}}if(r.type==="matching"){const y=r.columns??[],h=r.answer&&typeof r.answer=="object"&&"paths"in r.answer?{paths:Array.isArray(r.answer.paths)?r.answer.paths:[]}:{paths:[]};return{promptText:i,promptModel:{kind:"matching",columns:y},expectedModel:h,promptPayload:{kind:"matching",prompt:i,columns:y},initialAnswers:{...Gt(),matchingSelection:new Array(Math.max(2,y.length)).fill(null)}}}const u=typeof r.answer=="string"||typeof r.answer=="number"?r.answer:"",o=r.type==="number"?"number":r.type==="date"?"date":"text";return{promptText:i,promptModel:{kind:"text",inputType:o},expectedModel:u,promptPayload:{kind:"text",prompt:i,inputType:o},initialAnswers:Gt()}}const Bt=t=>t.trim().toLowerCase(),Qt=t=>{const a=t==null?void 0:t.trim();return a?{fragmentId:a}:null},Tn=(t,a)=>{const s=Qt(a);if(!s)return!0;const r=Qt(t);return(r==null?void 0:r.fragmentId)===s.fragmentId},St=t=>{const a=t==null?void 0:t.trim().toLowerCase();return a||null},$r=(t,a)=>{if((St(t.childItemType)??"info")!==(a.cardType??"").toLowerCase()||t.childItemId!==a.cardId)return!1;const r=St(t.childCheckType),i=St(t.childDirection),u=St(a.checkType),o=St(a.direction);return!(r&&r!==u||i&&i!==o)},Eo={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},Fo={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},Cn=(t,a,s)=>{if(!s||!a.startsWith(t))return a;const r=a.slice(t.length);if(!r)return a;const i=s==="super"?Eo:Fo,u=r.split("").map(o=>i[o]??o).join("");return t+u},In=(t,a,s)=>{var o,y,h;if(!t)return((o=a[0])==null?void 0:o.key)??null;const r=new Set(a.map(b=>b.key)),i=/\{([^}]+)\}/g;let u;for(;(u=i.exec(t))!==null;){const b=((y=u[1])==null?void 0:y.trim())??"";if(!b)continue;if(r.has(b))return b;const c=s==null?void 0:s[b];if(c&&r.has(c))return c}return((h=a[0])==null?void 0:h.key)??null},Xa=t=>(()=>{const a=new Set;return t.flatMap(s=>{if(s.cardType!=="info"||s.infoType!=="citation")return[s];const r=s.description??"";if(!r.trim())return[s];const i=ka(r),u=Object.keys(i.nodes);return u.length===0?[s]:u.map(o=>({...s,checkType:"quote-fragment",direction:o})).filter(o=>{const y=[o.cardId,o.checkType??"",o.direction??""].join("|");return a.has(y)?!1:(a.add(y),!0)})})})();function as({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,libraryId:c,collectionId:p,revisionId:l}){const d=Oa(),w=`/#/cogita/library/${c}`,m=n.useMemo(()=>new URLSearchParams(d.search),[d.search]),k=Math.max(1,Number(m.get("limit")??20)),I=m.get("mode")??"random",x=n.useMemo(()=>Za(I),[I]),f=n.useMemo(()=>Kn(x,Cr(x,m)),[x,m]),Q=m.get("check")??"exact",R=m.get("reviewer"),j=(m.get("scope")??"").trim(),B=j==="info"||j==="info-selection"?j:"collection",L=B==="info"?(m.get("infoId")??"").trim():"",Z=B==="info-selection"?(m.get("seed")??"").trim():"",[q,E]=n.useState(null),O=p??q??void 0,he=B==="collection"&&!!O,Se=n.useMemo(()=>t.cogita.library.revision[x.labelKey]??I,[t,I,x]),et=n.useMemo(()=>Q==="exact"?t.cogita.library.revision.checkValue:Q,[t,Q]),[re,F]=n.useState(t.cogita.library.collections.defaultName),[ve,J]=n.useState([]),[ue,ne]=n.useState([]),[je,de]=n.useState("idle"),[se,$e]=n.useState({current:0,total:0}),[ie,Ee]=n.useState(0),[Be,Je]=n.useState(""),[it,V]=n.useState(null),[ke,He]=n.useState(null),[Pe,Oe]=n.useState(null),[ot,wt]=n.useState(null),[ft,_e]=n.useState(null),[Ze,ut]=n.useState(null),[Qe,be]=n.useState(()=>Gt()),[fe,we]=n.useState(null),[M,$]=n.useState([]),[D,z]=n.useState({}),[H,ae]=n.useState({}),[S,C]=n.useState(null),[ce,_]=n.useState(null),[oe,v]=n.useState(null),[G,te]=n.useState(null),[W,Ie]=n.useState(null),[at,st]=n.useState({}),dt=n.useRef(0),[ct,yt]=n.useState(null),mt=n.useRef(null),nt=n.useRef(null),[Le,pt]=n.useState(null),[We,Ue]=n.useState(!1),[It,Nt]=n.useState(null),[Kt,Pt]=n.useState([]),[_t,Tt]=n.useState(null),Mt=n.useRef(null),Rt=n.useRef(null),[ma,Lt]=n.useState(null),[na,N]=n.useState(0),Te=n.useRef(null),Me=n.useRef({}),[lt,Ge]=n.useState(!1),[ze,P]=n.useState({}),[Ae,Ye]=n.useState([]),xt=n.useRef(new Map),[ye,Ht]=n.useState(new Set),[pa,Ct]=n.useState(!1),Vt=n.useRef(null),Wt=n.useRef(new Set),fa=n.useRef({});n.useEffect(()=>{if(!l||p){E(null);return}xs({libraryId:c,revisionId:l}).then(g=>E(g.collectionId)).catch(()=>E(null))},[p,c,l]);const Fe=ve[ie]??null,La=(Fe==null?void 0:Fe.checkType)==="translation-match"&&W,Aa=n.useRef(new Map),Ot=n.useRef(new Map),Na=n.useRef(new Map),Sa=n.useRef(new Map),Dt=n.useMemo(()=>Fe?Fe.cardType==="vocab"?t.cogita.library.revision.vocabLabel:Fe.infoType?gt(t,Fe.infoType):t.cogita.library.revision.infoLabel:"",[t,Fe]),sa=n.useMemo(()=>{var T;return x.id!=="levels"?ve.length:((T=ze.pool)==null?void 0:T.length)??x.getFetchLimit(k,f)},[ze,f,x,ve.length,k]),Ta=x.getProgressTotal?x.getProgressTotal(ve,ze,k,f):x.id==="levels"?Math.min(k,sa):ve.length,rn=Ta?Math.min(ie+1,Ta):0,Xt=Math.max(1,Number(f.tries??1)),ba=f.compare??"anchors",on=Math.max(0,Math.min(100,Number(f.minCorrectness??0))),$t=(f.considerDependencies??"on")==="on",ra=Math.max(0,Math.min(100,Number(f.dependencyThreshold??85))),Zt=g=>{const T=g.slice();for(let K=T.length-1;K>0;K-=1){const ee=Math.floor(Math.random()*(K+1));[T[K],T[ee]]=[T[ee],T[K]]}return T},Ca=g=>ua(g,{treatSimilarCharsAsSame:!0})>=on,ln=async()=>{const g=await da(),T=new Map,K=new Map,ee=new Map;g.forEach(Y=>{const ge=`${Y.itemType}:${Y.itemId}`,Ve=ta(Y.itemType,Y.itemId,Y.checkType,Y.direction);if(T.has(ge)||T.set(ge,[]),T.get(ge).push(Y),K.has(Ve)||K.set(Ve,[]),K.get(Ve).push(Y),Y.itemType==="info"&&Y.checkType==="quote-fragment"&&Y.direction){const tt=`${Y.itemId}:${Y.direction}`;ee.has(tt)||ee.set(tt,[]),ee.get(tt).push(Y)}});const le=new Map,X=new Map,pe=new Map;return T.forEach((Y,ge)=>le.set(ge,ca(Y).score)),K.forEach((Y,ge)=>X.set(ge,ca(Y).score)),ee.forEach((Y,ge)=>pe.set(ge,ca(Y).score)),{itemKnowness:le,cardKnowness:X,fragmentKnowness:pe}},zt=async g=>{const T=[];let K=null;for(;;){const ee=await tn({libraryId:c,collectionId:g,limit:200,cursor:K});if(T.push(...ee.items),!ee.nextCursor)break;K=ee.nextCursor}return Xa(T)},Ra=async(g,T)=>{if(xt.current.has(g))return xt.current.get(g)??0;const K=await zt(g);if(K.length===0)return xt.current.set(g,0),0;const le=K.reduce((X,pe)=>{const Y=Ne(pe);return X+(T.get(Y)??0)},0)/K.length;return xt.current.set(g,le),le},$a=(g,T)=>{if(!$t||g.cardType!=="info"||g.infoType!=="citation"||g.checkType!=="quote-fragment")return!0;const K=Qt(g.direction);if(!(K!=null&&K.fragmentId))return!0;const ee=g.description??"";if(!ee.trim())return!0;const X=ka(ee).nodes[K.fragmentId];if(!X||!X.leftId&&!X.rightId)return!0;const pe=[X.leftId,X.rightId].filter(Ve=>!!Ve);if(pe.length===0)return!0;const Y=pe.map(Ve=>{const tt=ta("info",g.cardId,"quote-fragment",Ve);return T.get(tt)??0});return Y.reduce((Ve,tt)=>Ve+tt,0)/Y.length>=ra},Ja=async g=>{const T=ze,K=g.concat(T.active??[]).concat(T.pool??[]).filter((Y,ge,Ve)=>Ve.findIndex(tt=>Ne(tt)===Ne(Y))===ge);if(!$t){Ht(new Set(K.map(Ne)));return}const{itemKnowness:ee,cardKnowness:le}=await ln(),X=Ae.filter(Y=>St(Y.childItemType)==="collection"&&Y.childItemId===p&&!St(Y.childCheckType)&&!St(Y.childDirection)),pe=new Set;for(const Y of K){if(Y.cardType!=="info"){pe.add(Ne(Y));continue}if(!$a(Y,le))continue;const ge=Ae.filter(rt=>$r(rt,Y)).concat(X);if(ge.length===0){pe.add(Ne(Y));continue}let Ve=0;for(const rt of ge)if(St(rt.parentItemType)==="collection")Ve+=await Ra(rt.parentItemId,le);else if(St(rt.parentCheckType)||St(rt.parentDirection)){const ht=St(rt.parentCheckType),bt=St(rt.parentDirection),vt=ta(rt.parentItemType,rt.parentItemId,ht,bt);Ve+=le.get(vt)??0}else{const ht=`${rt.parentItemType}:${rt.parentItemId}`;Ve+=ee.get(ht)??0}Ve/ge.length>=ra&&pe.add(Ne(Y))}Ht(pe)},cn=g=>{for(let T=g;T<ve.length;T+=1){const K=ve[T];if(K&&(!$t||K.cardType!=="info"||ye.has(Ne(K))))return T}return-1},Qa=g=>!$t||g.cardType!=="info"||ye.has(Ne(g)),_n=g=>{if(x.id!=="temporal"&&x.id!=="levels")return null;const T=ze,K=(T.active??[]).concat(T.pool??[]),ee=new Set;for(const le of K){const X=Ne(le);if(!(ee.has(X)||g.has(X))&&(ee.add(X),Qa(le)))return le}return null},ia=n.useMemo(()=>{if(x.id!=="levels")return null;const g=ze,T=g.pool??[],K=g.active??[],ee=g.levelMap??{},le=Math.max(1,Number(f.levels??1)),X=Array.from({length:le},()=>0),pe=new Set(K.map(tt=>Ne(tt)));T.forEach(tt=>{const rt=Math.min(le,Math.max(1,ee[Ne(tt)]??1));X[rt-1]+=1});const Y=T.length||1,ge=X.map(tt=>tt/Y*100),Ve=Fe?ee[Ne(Fe)]??1:null;return{counts:X,percentages:ge,currentLevel:Ve,levelsCount:le,activeCount:K.length,poolCount:T.length,activeSet:pe}},[ze,f,x,Fe]),Pa=n.useMemo(()=>{if(x.id!=="temporal")return null;const g=ze,T=g.pool??[],K=g.active??[],ee=g.knownessMap??{},le=new Set(g.unknownSet??[]);let X=0;T.forEach(ge=>{(ee[Ne(ge)]??0)>1&&(X+=1)});const pe=le.size,Y=K.map(ge=>({id:Ne(ge),value:le.has(Ne(ge))?0:Math.max(0,Math.min(1,ee[Ne(ge)]??0))}));return{knownCount:X,unknownCount:pe,dots:Y}},[ze,x]),Dn=n.useMemo(()=>{if(!$t)return 0;const g=ze;return ve.concat(g.active??[]).concat(g.pool??[]).filter((K,ee,le)=>le.findIndex(X=>Ne(X)===Ne(K))===ee).filter(K=>K.cardType==="info"&&!ye.has(Ne(K))).length},[$t,ze,ve,ye]);n.useEffect(()=>{if(!$t||je!=="ready")return;const g=ze,K=ve.concat(g.active??[]).concat(g.pool??[]).filter((X,pe,Y)=>Y.findIndex(ge=>Ne(ge)===Ne(X))===pe).filter(X=>X.cardType!=="info"||ye.has(Ne(X))).length,ee=Mt.current;if(Mt.current=K,ee===null||K<=ee)return;const le=K-ee;Tt(`New card available (+${le})`),Rt.current&&window.clearTimeout(Rt.current),Rt.current=window.setTimeout(()=>Tt(null),2200)},[$t,je,ze,ve,ye]),n.useEffect(()=>()=>{Rt.current&&window.clearTimeout(Rt.current)},[]);const Ft=(g,T)=>{const K=x.applyOutcome({queue:ve,meta:ze},Fe,k,f,{correct:g,correctness:T,createdUtc:new Date().toISOString()});J(K.queue),P(K.meta);const ee=K.queue[ie+1];ee&&ga(ee,ie+1)};n.useEffect(()=>{if(he&&O){Rn(c,O).then(g=>F(g.name)).catch(()=>F(t.cogita.library.collections.defaultName));return}if(B==="info"&&L){aa({libraryId:c,infoId:L}).then(g=>{const T=g.payload??{};F(T.title||T.label||T.name||L)}).catch(()=>F(L||t.cogita.library.revision.runKicker));return}if(B==="info-selection"){const g=Z?Es(c,Z):null,T=(g==null?void 0:g.infoIds.length)??0;F(T>0?`Selected infos (${T})`:"Selected infos");return}F(t.cogita.library.collections.defaultName)},[t,O,he,c,B,L,Z]),n.useEffect(()=>{bs({libraryId:c,type:"language"}).then(g=>ne(g)).catch(()=>ne([]))},[c]),n.useEffect(()=>{he&&fs({libraryId:c}).then(g=>Ye(g.items??[])).catch(()=>Ye([]))},[he,c]),n.useEffect(()=>{ts(c,R)},[c,R]),n.useEffect(()=>{Ja(ve)},[ve,Ae,$t,ra,O]),n.useEffect(()=>{if(!Fe||!$t){Ct(!1);return}if(Fe.cardType!=="info"||ye.has(Ne(Fe))){Ct(!1);return}const g=cn(ie+1);if(g>=0){Ct(!1),Ee(g);return}if(x.id==="temporal"||x.id==="levels"){const T=ve.slice(0,ie+1),K=ve.slice(ie+1).filter(Qa),ee=T.concat(K),le=new Set(ee.map(Ne)),X=_n(le);if(X){const Y=Ne(X);le.has(Y)||(ee.push(X),le.add(Y),P(ge=>{const Ve=ge,tt=new Set(Ve.queued??[]);return tt.add(Y),{...Ve,queued:tt}}))}const pe=ee.findIndex((Y,ge)=>ge!==ie&&Qa(Y));if(pe>=0){J(ee),Ee(pe),Ct(!1);return}}Ct(!0)},[Fe,ye,$t,ie,ve,ze,x.id]),n.useEffect(()=>{let g=!0;return(async()=>{de("loading"),$e({current:0,total:x.id==="levels"||x.id==="random-once"?0:x.getFetchLimit(k,f)});try{if(!he){if(Ye([]),B==="info"){if(!L){g&&(J([]),Ye([]),P({}),Ee(0),de("ready"));return}const[rt,ht]=await Promise.all([bn({libraryId:c,infoId:L}),yn({libraryId:c,infoId:L})]);if(!g)return;const bt=Xa(rt.items??[]);Ye(ht.items??[]);const vt=x.prepare(bt,k,f);J(vt.queue),P(vt.meta),Ee(0),de("ready"),$e({current:bt.length,total:bt.length});return}if(B==="info-selection"){const rt=Z?Es(c,Z):null,ht=(rt==null?void 0:rt.infoIds)??[];if(!ht.length){g&&(J([]),Ye([]),P({}),Ee(0),de("ready"));return}const bt=await Promise.all(ht.map(async xa=>{const[Ut,un]=await Promise.all([bn({libraryId:c,infoId:xa}),yn({libraryId:c,infoId:xa})]);return{cards:Ut.items??[],deps:un.items??[]}}));if(!g)return;const vt=new Map;bt.forEach(xa=>{Xa(xa.cards).forEach(Ut=>{vt.set(Ne(Ut),Ut)})});const jt=Array.from(vt.values()),kt=new Set(jt.map(Ne)),Et=new Map;bt.forEach(xa=>{(xa.deps??[]).forEach(Ut=>{const un=ta(Ut.parentItemType,Ut.parentItemId,St(Ut.parentCheckType),St(Ut.parentDirection)),Ss=ta(Ut.childItemType,Ut.childItemId,St(Ut.childCheckType),St(Ut.childDirection));if(!kt.has(un)||!kt.has(Ss))return;const Ts=`${un}->${Ss}`;Et.has(Ts)||Et.set(Ts,Ut)})}),Ye(Array.from(Et.values()));const Ia=x.prepare(jt,k,f);J(Ia.queue),P(Ia.meta),Ee(0),de("ready"),$e({current:jt.length,total:jt.length});return}}const K=[];let ee=null,le=null;do{const rt=await tn({libraryId:c,collectionId:O,limit:300,cursor:ee});if(K.push(...rt.items),(x.id==="levels"||x.id==="temporal"||x.id==="random-once")&&rt.total&&(le=rt.total),$e(ht=>({current:K.length,total:ht.total||rt.total||x.getFetchLimit(k,f)})),ee=rt.nextCursor??null,le!==null&&K.length>=le||x.id!=="levels"&&x.id!=="temporal"&&x.id!=="random-once"&&K.length>=x.getFetchLimit(k,f))break}while(ee);if(!g)return;const X=Xa(K);let pe;if(x.id==="levels"){const rt=Math.max(1,Number(f.levels??1)),bt=(await da()).reduce((vt,jt)=>{const kt=ta(jt.itemType,jt.itemId,jt.checkType,jt.direction);return vt[kt]||(vt[kt]=[]),vt[kt].push(jt),vt},{});pe={},X.forEach(vt=>{const jt=Ne(vt),kt=bt[jt]??[],Et=kt.length>0?ca(kt).score:0,Ia=Math.max(1,Math.min(rt,Math.ceil(Et/100*rt)));pe[jt]=Ia})}let Y=null,ge=null,Ve=null;if(x.id==="temporal"){const rt=await da(),ht=new Set(X.map(jt=>Ne(jt))),bt=rt.reduce((jt,kt)=>{const Et=ta(kt.itemType,kt.itemId,kt.checkType,kt.direction);return ht.has(Et)&&(jt[Et]||(jt[Et]=[]),jt[Et].push(kt)),jt},{});Y={},ge=new Set,Ve={};const vt=Date.now();X.forEach(jt=>{const kt=Ne(jt),Et=bt[kt]??[];if(Et.length===0){Y[kt]=0,ge.add(kt),Ve[kt]=[];return}const Ia=js(Et);Ve[kt]=Ia;const xa=En(Ia,vt);Y[kt]=xa.knowness})}const tt=x.id==="levels"?Ns(X,k,f,pe):x.id==="temporal"?ks(X,k,f,Y??{},ge??new Set,Ve??{}):x.prepare(X,k,f);J(tt.queue),P(tt.meta),Ee(0),de("ready"),$e(rt=>({current:Math.min(rt.current,rt.total),total:rt.total}))}catch{g&&de("error")}})(),()=>{g=!1}},[O,he,c,k,B,f,x,R,L,Z]),n.useEffect(()=>{if(Je(""),V(null),Lt(null),N(0),$([]),z({}),ae({}),_(null),v(null),te(null),wt(null),_e(null),ut(null),be(Gt()),Ue(!1),Ge(!1),pt(null),Ie(null),st({}),!Fe){He(null),Oe(null),C(null),wt(null),_e(null),ut(null),be(Gt()),Nt(null);return}Fe.cardType==="info"&&Fe.infoType==="computed"&&He(t.cogita.library.revision.loadingComputed);let g=!0;return ga(Fe,ie).then(T=>{!g||!T||(He(T.prompt),Oe(T.expectedAnswer),$(T.computedExpected),z(T.computedAnswers),C(T.computedValues),_(T.answerTemplate),v(T.outputVariables),te(T.variableValues),wt(T.questionPrompt),_e(T.questionPromptModel),ut(T.questionExpectedModel),be(T.questionInitialAnswers))}),()=>{g=!1}},[Fe,t]),n.useEffect(()=>{if(!Fe||Fe.cardType!=="info"||Fe.infoType!=="citation"){Vt.current=null,Wt.current=new Set,we(null);return}const g=Fe.description??"",T=(Fe.label??"").trim(),K=T.replace(/\s+/g," ").trim(),ee=g.replace(/\s+/g," ").trim(),le=K&&K!==ee?T:t.cogita.library.infoTypes.citation;if(!g){we(null),Oe(null);return}const X=ka(g);Vt.current=X,He(le);let pe=!0;return ln().then(({fragmentKnowness:Y})=>{if(!pe)return;const ge=new Set,Ve={};Y.forEach((ht,bt)=>{const[vt,jt]=bt.split(":",2);if(vt!==Fe.cardId)return;const kt=Qt(jt);if(!kt)return;const{fragmentId:Et}=kt;Ve[Et]=ht,ht>=ra&&ge.add(Et)}),Wt.current=ge,fa.current=Ve;const tt=Qt(Fe.direction);if(tt!=null&&tt.fragmentId&&X.nodes[tt.fragmentId]){A(X,tt.fragmentId,le);return}const rt=za(X,ge,Ve,ra,$t,Fe.direction);A(X,(rt==null?void 0:rt.id)??null,le)}).catch(()=>{Wt.current=new Set,fa.current={};const Y=Qt(Fe.direction);if(Y!=null&&Y.fragmentId&&X.nodes[Y.fragmentId]){A(X,Y.fragmentId,le);return}const ge=za(X,Wt.current,{},ra,$t,Fe.direction);A(X,(ge==null?void 0:ge.id)??null,le)}),()=>{pe=!1}},[Fe,t,$t,ra]),n.useEffect(()=>{if(!Fe||Fe.cardType!=="vocab"||Fe.checkType!=="translation-match"){Ie(null),st({});return}const K=(ze.pool??ze.active??ve).filter(Y=>Y.cardType==="vocab"&&Y.checkType==="translation-match").filter((Y,ge,Ve)=>Ve.findIndex(tt=>tt.cardId===Y.cardId)===ge);K.some(Y=>Y.cardId===Fe.cardId)||K.unshift(Fe);const le=Zt(K).slice(0,6).map(Y=>{const ge=Y.label.split("↔").map(rt=>rt.trim()).filter(Boolean);if(ge.length<2)return null;const Ve=`${Y.cardId}:L`,tt=`${Y.cardId}:R`;return{cardId:Y.cardId,leftId:Ve,rightId:tt,leftLabel:ge[0],rightLabel:ge[1]}}).filter(Boolean),X=le.map(Y=>Y.leftId),pe=Zt(le.map(Y=>Y.rightId));Ie({pairs:le,leftOrder:X,rightOrder:pe,selection:{},activeLeft:null,activeRight:null,locked:{}})},[Fe,ve,ze]),n.useEffect(()=>()=>{mt.current&&window.clearTimeout(mt.current),nt.current&&window.clearTimeout(nt.current)},[]);const qt=n.useRef(null);n.useEffect(()=>{if(!Fe)return;const g=Ne(Fe),T=typeof document<"u"?document.activeElement:null;if(qt.current===g&&T&&(T.tagName==="INPUT"||T.tagName==="TEXTAREA"))return;let K=0;const ee=()=>{if(Fe){if(Fe.cardType==="info"&&Fe.infoType==="computed"){if(M.length>0){const X=In(ce,M,oe),pe=X?Me.current[X]:null;if(pe&&(pe.focus(),document.activeElement===pe)){qt.current=g;return}}if(Te.current&&(Te.current.focus(),document.activeElement===Te.current)){qt.current=g;return}}else if(Fe.cardType==="vocab"&&Te.current&&(Te.current.focus(),document.activeElement===Te.current)){qt.current=g;return}K<6&&(K+=1,window.setTimeout(ee,40))}},le=window.setTimeout(ee,40);return()=>window.clearTimeout(le)},[Fe,M,ce,oe]),n.useEffect(()=>{if(!lt)return;const g=T=>{T.key==="Enter"&&(T.preventDefault(),_a())};return window.addEventListener("keydown",g),()=>window.removeEventListener("keydown",g)},[lt]);const Ea=g=>{Pt(g),Nt(ca(g))};n.useEffect(()=>{if(!Fe){Nt(null),Pt([]);return}const g=Fe.cardType==="info"?"info":"connection";if(Fe.cardType==="info"&&Fe.infoType==="citation"){da().then(T=>{const K=T.filter(ee=>ee.itemType==="info"&&ee.itemId===Fe.cardId&&ee.checkType==="quote-fragment"&&Tn(ee.direction,Fe.direction));Ea(K)}).catch(()=>{Nt(null),Pt([])});return}Nn(g,Fe.cardId,Fe.checkType,Fe.direction).then(T=>Ea(T)).catch(()=>{Nt(null),Pt([])})},[c,Fe,R]);const Fa=(g,T,K,ee)=>{if(g==="info"&&K==="quote-fragment"){da().then(le=>{const X=le.filter(pe=>pe.itemType==="info"&&pe.itemId===T&&pe.checkType==="quote-fragment"&&Tn(pe.direction,ee));Ea(X)}).catch(()=>{Nt(null),Pt([])});return}Nn(g,T,K,ee).then(le=>Ea(le)).catch(()=>{Nt(null),Pt([])})},ya=(g,T,K)=>{var pe;const ee=((pe=K.pairs.find(Y=>Y.leftId===g))==null?void 0:pe.rightId)??null;if(!ee)return K;const le=ee===T;st(Y=>({...Y,[g]:le?"correct":"incorrect"})),mt.current&&window.clearTimeout(mt.current),nt.current&&window.clearTimeout(nt.current),dt.current+=1;const X={kind:le?"correct":"incorrect",tick:dt.current};if(yt(null),mt.current=window.setTimeout(()=>yt(X),0),nt.current=window.setTimeout(()=>yt(null),420),le){const Y={...K.locked,[g]:!0};return Object.keys(Y).length>=K.pairs.length?(V("correct"),Ge(!0)):V("correct"),{...K,selection:{...K.selection,[g]:T},activeLeft:null,activeRight:null,locked:Y}}return V("incorrect"),{...K,activeLeft:null,activeRight:null}},Bn=g=>{Ie(T=>!T||T.locked[g]?T:T.activeRight?ya(g,T.activeRight,T):{...T,activeLeft:T.activeLeft===g?null:g})},Ka=g=>{Ie(T=>T&&(T.activeLeft?ya(T.activeLeft,g,T):{...T,activeRight:T.activeRight===g?null:g}))},dn=g=>{be(T=>{if(ot!=null&&ot.multiple){const K=T.selection.includes(g)?T.selection.filter(ee=>ee!==g):Array.from(new Set([...T.selection,g]));return{...T,selection:K}}return{...T,selection:T.selection[0]===g?[]:[g]}})},zn=(g,T)=>{be(K=>{var ge;const ee=Math.max(2,((ge=ot==null?void 0:ot.columns)==null?void 0:ge.length)??2),le=Array.from({length:ee},(Ve,tt)=>K.matchingSelection[tt]??null);if(le[g]=le[g]===T?null:T,le.some(Ve=>Ve==null))return{...K,matchingSelection:le};const X=le.map(Ve=>Number(Ve)),pe=X.join("|"),Y=K.matchingRows.some(Ve=>Ve.join("|")===pe);return{...K,matchingRows:Y?K.matchingRows:[...K.matchingRows,X],matchingSelection:new Array(ee).fill(null)}})},qn=(g,T)=>{be(K=>{const ee=[...K.ordering],le=g+T;return le<0||le>=ee.length?K:([ee[g],ee[le]]=[ee[le],ee[g]],{...K,ordering:ee})})},_a=()=>{var g;if(Fe&&Fe.cardType==="info"&&Fe.infoType==="citation"&&Vt.current&&fe&&!((g=Qt(Fe.direction))!=null&&g.fragmentId)){const T=za(Vt.current,Wt.current,fa.current,ra,$t,Fe.direction,fe.fragmentId);if(T){V(null),Je(""),Ue(!1),ae({}),Ge(!1),Lt(null),N(0),A(Vt.current,T.id,fe.title);return}}V(null),Je(""),Ue(!1),ae({}),Ge(!1),Lt(null),N(0),Ee(T=>Math.min(T+1,ve.length))},ea=g=>{if(!Fe)return;const T=g.expected??null,K=g.answer??"";let ee=T??"",le=K;if(!T&&g.expectedMap&&g.answerMap){const rt=Object.keys(g.expectedMap).sort((ht,bt)=>ht.localeCompare(bt));ee=rt.map(ht=>{var bt;return((bt=g.expectedMap)==null?void 0:bt[ht])??""}).join("|"),le=rt.map(ht=>{var bt;return((bt=g.answerMap)==null?void 0:bt[ht])??""}).join("|")}const X=ee?qa(ee,le,ba):new Uint8Array,pe={revisionType:x.id,evalType:g.evalType,direction:g.direction,prompt:ke??"",expected:T,answer:K,expectedAnswers:g.expectedMap??null,answers:g.answerMap??null,correct:g.correct,maskBase64:X.length?ja(X):null,values:S??null,checkMode:Q,compareMode:ba,minCorrectness:on},Y=new TextEncoder().encode(JSON.stringify(pe)),ge=Fe.cardType==="info"?"info":"connection",Ve=g.overrideCheckType??Fe.checkType??null,tt=g.overrideDirection??Fe.direction??null;kn({itemType:ge,itemId:Fe.cardId,checkType:Ve,direction:tt,revisionType:x.id,evalType:g.evalType,correct:g.correct,maskBase64:X.length?ja(X):null,payloadBase64:ja(Y),personRoleId:R??null}).then(()=>{Fa(ge,Fe.cardId,Ve,tt),Ja(ve),ts(c,R)}).catch(()=>{})},Vn=(g,T)=>{const K=Aa.current.get(T);if(K)return Promise.resolve(K);const ee=Ot.current.get(T);if(ee)return ee;const le=aa({libraryId:c,infoId:g}).then(X=>{var rt,ht;const pe=X.payload,Y=((rt=pe.definition)==null?void 0:rt.graph)??null,ge="",Ve=((ht=pe.definition)==null?void 0:ht.answerTemplate)??"",tt=Ir(Y,ge,Ve);if(tt){const vt={sample:Mr(tt),answerTemplate:Ve||null};return Aa.current.set(T,vt),vt}return ls({libraryId:c,infoId:g}).then(bt=>{const vt={sample:bt,answerTemplate:null};return Aa.current.set(T,vt),vt})}).catch(()=>ls({libraryId:c,infoId:g}).then(X=>{const pe={sample:X,answerTemplate:null};return Aa.current.set(T,pe),pe}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{Ot.current.delete(T)});return Ot.current.set(T,le),le},ga=(g,T)=>{var Y;const K=`${Ne(g)}:${T}`,ee=Na.current.get(K);if(ee)return Promise.resolve(ee);const le=Sa.current.get(K);if(le)return le;const X=ge=>{const Ve={...ge,questionPrompt:ge.questionPrompt??null,questionPromptModel:ge.questionPromptModel??null,questionExpectedModel:ge.questionExpectedModel??null,questionInitialAnswers:ge.questionInitialAnswers??Gt()};return Na.current.set(K,Ve),Ve};let pe;if(g.cardType==="vocab"){if(g.checkType==="translation-match")return pe=Promise.resolve(X({prompt:g.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),pe;const ge=g.label.split("↔").map(Ve=>Ve.trim()).filter(Boolean);if(ge.length>=2){const tt=(g.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",rt=tt?ge[0]:ge[1],ht=tt?ge[1]:ge[0];pe=Promise.resolve(X({prompt:rt,expectedAnswer:ht,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else pe=Promise.resolve(X({prompt:g.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(g.cardType==="info"&&g.infoType==="word"){const ge=(Y=g.description)!=null&&Y.startsWith("Language: ")?g.description.replace("Language: ",""):null;pe=Promise.resolve(X({prompt:g.label,expectedAnswer:ge,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(g.cardType==="info"&&g.infoType==="question"){const ge=Sn(g.payload??null,g.label);ge?pe=Promise.resolve(X({prompt:ge.promptText,expectedAnswer:ge.promptModel.kind==="text"&&(typeof ge.expectedModel=="string"||typeof ge.expectedModel=="number")?String(ge.expectedModel):null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null,questionPrompt:ge.promptPayload,questionPromptModel:ge.promptModel,questionExpectedModel:ge.expectedModel,questionInitialAnswers:ge.initialAnswers})):pe=aa({libraryId:c,infoId:g.cardId}).then(Ve=>{const tt=Sn(Ve.payload??{},g.label);return X(tt?{prompt:tt.promptText,expectedAnswer:tt.promptModel.kind==="text"&&(typeof tt.expectedModel=="string"||typeof tt.expectedModel=="number")?String(tt.expectedModel):null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null,questionPrompt:tt.promptPayload,questionPromptModel:tt.promptModel,questionExpectedModel:tt.expectedModel,questionInitialAnswers:tt.initialAnswers}:{prompt:g.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})}).catch(()=>X({prompt:g.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Sa.current.delete(K)})}else g.cardType==="info"&&g.infoType==="computed"?pe=Vn(g.cardId,K).then(ge=>{var bt,vt;if(!ge.sample)return X({prompt:g.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const Ve=ge.sample,tt=Ve.expectedAnswers?Object.entries(Ve.expectedAnswers).map(([jt,kt])=>({key:jt,expected:kt})):[],rt=tt.reduce((jt,kt)=>(jt[kt.key]="",jt),{}),ht=Ve.expectedAnswerIsSentence&&((bt=Ve.expectedAnswer)==null?void 0:bt.trim())||null;return X({prompt:Ve.prompt,expectedAnswer:tt.length>0?ht:((vt=Ve.expectedAnswer)==null?void 0:vt.trim())||null,computedExpected:tt,computedAnswers:rt,computedValues:Ve.values??null,answerTemplate:ge.answerTemplate,outputVariables:Ve.outputVariables??null,variableValues:Ve.variableValues??null})}).catch(()=>X({prompt:g.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Sa.current.delete(K)}):pe=Promise.resolve(X({prompt:g.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return Sa.current.set(K,pe),pe},A=(g,T,K)=>{const ee=Object.keys(g.nodes).length,le=Wt.current.size;if(!T){we({title:K,before:g.text,after:"",fragmentId:null,total:ee,completed:le}),Oe(null),Ge(!0);return}const X=g.nodes[T];if(!X)return;const pe=$n(g.text,X);we({title:K,before:pe.before,after:pe.after,fragmentId:X.id,total:ee,completed:le}),Oe(pe.fragment),Ge(!1)},U=()=>{const g=Vt.current;g&&we(T=>T&&{...T,total:Object.keys(g.nodes).length,completed:Wt.current.size})},me=()=>{const g=ve[ie+1];g&&ga(g,ie+1)},De=()=>{if(me(),Fe&&Fe.cardType==="vocab"&&Fe.checkType==="translation-match"&&W){if(W.pairs.length===0){V("incorrect"),Ge(!0);return}const X=W.pairs.reduce((ht,bt)=>(ht[bt.rightId]=bt.rightLabel,ht),{});let pe=0;const Y={};W.pairs.forEach(ht=>{const vt=W.selection[ht.leftId]===ht.rightId;Y[ht.leftId]=vt?"correct":"incorrect",vt&&(pe+=1)});const ge=W.pairs.length||1,Ve=pe/ge,tt=pe===W.pairs.length;st(ht=>({...ht,...Y})),tt?(V("correct"),Ge(!0),N(0)):(V("incorrect"),Ge(!1),N(ht=>{const bt=ht+1;return bt>=Xt&&(Ue(!0),Ge(!0),Ie(vt=>{if(!vt)return vt;const jt=vt.pairs.reduce((kt,Et)=>(kt[Et.leftId]=Et.rightId,kt),{});return{...vt,selection:jt}})),bt})),Ft(tt,Ve);const rt="connection";Promise.all(W.pairs.map(ht=>{const bt=W.selection[ht.leftId]??null,vt=bt?X[bt]:"",jt={left:ht.leftLabel,expected:ht.rightLabel,answer:vt,checkType:"translation-match"},kt=new TextEncoder().encode(JSON.stringify(jt));return kn({itemType:rt,itemId:ht.cardId,checkType:"translation-match",direction:null,revisionType:x.id,evalType:"translation-match",correct:bt===ht.rightId,maskBase64:null,payloadBase64:ja(kt),personRoleId:R??null})})).then(()=>{Fa(rt,Fe.cardId,Fe.checkType,Fe.direction),ts(c,R)}).catch(()=>{});return}if(Fe&&Fe.cardType==="info"&&Fe.infoType==="question"&&ft){const X={text:Qe.text,selection:Qe.selection,booleanAnswer:Qe.booleanAnswer,ordering:Qe.ordering,matchingPaths:Qe.matchingRows},pe=Jt({prompt:ft,expected:Ze,answer:X}),Y=pe.mask?ua(pe.mask):pe.correct?100:0;Lt(pe.mask),pe.correct?(V("correct"),ae({}),Ge(!0),N(0),Ft(!0,Y/100)):(V("incorrect"),ae({}),Ge(!1),N(ge=>{const Ve=ge+1;return Ve>=Xt&&(Ue(!0),Ge(!0)),Ve}),Ft(!1,Y/100)),ea({correct:pe.correct,direction:ke?`${ke} -> question`:"question",expected:JSON.stringify(Ze??null),answer:JSON.stringify(X),evalType:`question:${ft.kind}`});return}if(M.length>0){const X=M.reduce((Y,ge)=>{const Ve=D[ge.key]??"";return Y[ge.key]=Bt(Ve)===Bt(ge.expected)?"correct":"incorrect",Y},{});M.every(({key:Y,expected:ge})=>{const Ve=D[Y]??"";return Q==="exact"&&Bt(Ve)===Bt(ge)})?(V("correct"),ae(X),Ge(!0),N(0),Ft(!0,1),ea({correct:!0,direction:ke?`${ke} -> computed`:"computed",expectedMap:M.reduce((Y,ge)=>(Y[ge.key]=ge.expected,Y),{}),answerMap:D,evalType:"computed"})):(V("incorrect"),ae(X),Ge(!1),N(Y=>{const ge=Y+1;return ge>=Xt&&Xe&&(Ue(!0),Ge(!0)),ge}),Ft(!1,0),window.setTimeout(()=>{var ge;const Y=In(ce,M,oe);Y&&Me.current[Y]&&((ge=Me.current[Y])==null||ge.focus())},40),ea({correct:!1,direction:ke?`${ke} -> computed`:"computed",expectedMap:M.reduce((Y,ge)=>(Y[ge.key]=ge.expected,Y),{}),answerMap:D,evalType:"computed"}));return}if(Fe&&Fe.cardType==="info"&&Fe.infoType==="citation"&&(fe!=null&&fe.fragmentId)){if(!Pe)return;const X=Qt(Fe.direction),pe=(X==null?void 0:X.fragmentId)??fe.fragmentId,Y=an(Pe,Be,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),ge=Y.mask,Ve=Y.isCorrect,tt=Y.percent;Ve?(fa.current[fe.fragmentId]=Math.max(fa.current[fe.fragmentId]??0,tt),(fa.current[fe.fragmentId]??0)>=ra&&Wt.current.add(fe.fragmentId),U(),V("correct"),ae({}),Ge(!0),Lt(ge),N(0),tt<100&&Xt<=1&&Ue(!0),Ft(!0,tt/100),ea({correct:!0,direction:`quote:${fe.fragmentId}`,expected:Pe,answer:Be,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:pe})):(V("incorrect"),ae({}),Ge(!1),Lt(ge),N(rt=>{const ht=rt+1;return ht>=Xt&&Xe&&(Ue(!0),Ge(!0)),ht}),Ft(!1,tt/100),window.setTimeout(()=>{var rt;return(rt=Te.current)==null?void 0:rt.focus()},40),ea({correct:!1,direction:`quote:${fe.fragmentId}`,expected:Pe,answer:Be,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:pe}));return}if(!Pe)return;const g=qa(Pe,Be,ba),T=Q==="exact"&&Bt(Be)===Bt(Pe),K=Ca(g),ee=T||K,le=ua(g);ee?(V("correct"),ae({}),Ge(!0),Lt(g),N(0),le<100&&Xt<=1&&Ue(!0),Ft(!0,le/100),ea({correct:!0,direction:ke?`${ke} -> ${Pe}`:null,expected:Pe,answer:Be,evalType:"text"})):(V("incorrect"),ae({}),Ge(!1),Lt(g),N(X=>{const pe=X+1;return pe>=Xt&&Xe&&(Ue(!0),Ge(!0)),pe}),Ft(!1,le/100),window.setTimeout(()=>{var X;return(X=Te.current)==null?void 0:X.focus()},40),ea({correct:!1,direction:ke?`${ke} -> ${Pe}`:null,expected:Pe,answer:Be,evalType:"text"}))},qe=g=>{if(me(),!Pe)return;const T=qa(Pe,g,ba),K=Bt(g)===Bt(Pe),ee=Ca(T),le=K||ee,X=ua(T);le?(V("correct"),ae({}),Ge(!0),Lt(T),N(0),X<100&&Xt<=1&&Ue(!0),Ft(!0,X/100),ea({correct:!0,direction:"word->language",expected:Pe,answer:g,evalType:"language-select"})):(V("incorrect"),ae({}),Ge(!1),Lt(T),N(pe=>{const Y=pe+1;return Y>=Xt&&Xe&&(Ue(!0),Ge(!0)),Y}),Ft(!1,X/100),ea({correct:!1,direction:"word->language",expected:Pe,answer:g,evalType:"language-select"}))},xe=()=>{me(),V("correct"),Ge(!0),N(0),Ft(!0,1),Pe&&ea({correct:!0,direction:"manual",expected:Pe,answer:Be,evalType:"manual"})},Ke=()=>{if(Ft(!1,0),Fe&&Fe.cardType==="info"&&Fe.infoType==="citation"){V(null),Je(""),Ue(!1),ae({}),Ge(!1),Lt(null),N(0),Ee(g=>Math.min(g+1,ve.length));return}_a()};n.useEffect(()=>{me()},[ie,ve]);const Re=g=>{var K;if(g.key!=="Enter")return;if(g.preventDefault(),g.stopPropagation(),lt){_a();return}const T=M.find(ee=>!(D[ee.key]??"").trim());if(T){(K=Me.current[T.key])==null||K.focus();return}De()},Ce=t.cogita.library.revision.revealModeAfterIncorrect,Xe=M.length>0||!!Pe||(Fe==null?void 0:Fe.cardType)==="info"&&Fe.infoType==="question"&&ft!==null;return e.jsxs(At,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,children:[je==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${se.total?Math.min(100,Math.max(0,se.current/se.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:se.total?`${Math.min(se.current,se.total)} / ${se.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:re}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",Se).replace("{check}",et)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:w,children:t.cogita.library.actions.libraryOverview}),he?e.jsxs(e.Fragment,{children:[e.jsx("a",{className:"cta ghost",href:`${w}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${w}/collections/${O}`,children:t.cogita.library.actions.collectionDetail})]}):e.jsx("a",{className:"cta ghost",href:`${w}/list`,children:t.cogita.library.actions.allCards})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:It?`${It.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[ia?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",ia.currentLevel??"-"," / ",ia.levelsCount]}):null,It?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(It.correct)).replace("{total}",String(It.total))}),It.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(It.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(Lr,{outcomes:Kt})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[_t?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:_t})}):null,e.jsx(Ua,{feedbackToken:ct?`${ct.kind}-${ct.tick}`:La?"idle":it?`${it}-${ie}-${na}`:"idle",children:Fe?e.jsx(e.Fragment,{children:pa?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(vs,{copy:t,currentCard:Fe,currentTypeLabel:Dt,prompt:ke,languages:ue,answer:Be,onAnswerChange:g=>Je(T=>Cn(T,g,Le)),computedExpected:M,computedAnswers:D,onComputedAnswerChange:(g,T)=>z(K=>({...K,[g]:Cn(K[g]??"",T,Le)})),answerTemplate:ce,outputVariables:oe,variableValues:G,computedFieldFeedback:H,feedback:it,canAdvance:lt,quoteContext:fe,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:De,onSkip:Ke,onLanguageSelect:qe,onMarkReviewed:xe,onAdvance:_a,showCorrectAnswer:We,setShowCorrectAnswer:Ue,onRevealCorrect:()=>Ge(!0),answerMask:ma,expectedAnswer:Pe,hasExpectedAnswer:Xe,handleComputedKeyDown:Re,answerInputRef:Te,computedInputRefs:Me,scriptMode:Le,setScriptMode:pt,matchPairs:W==null?void 0:W.pairs,matchLeftOrder:W==null?void 0:W.leftOrder,matchRightOrder:W==null?void 0:W.rightOrder,matchSelection:W==null?void 0:W.selection,matchActiveLeft:W==null?void 0:W.activeLeft,matchActiveRight:W==null?void 0:W.activeRight,matchFeedback:at,onMatchLeftSelect:Bn,onMatchRightSelect:Ka,questionPrompt:ot,questionAnswers:Qe,questionRevealExpected:We?Ze:void 0,onQuestionTextChange:g=>{Je(g),be(T=>({...T,text:g}))},onQuestionSelectionToggle:dn,onQuestionBooleanChange:g=>be(T=>({...T,booleanAnswer:g})),onQuestionOrderingMove:qn,onQuestionMatchingPick:zn,onQuestionMatchingRemovePath:g=>be(T=>({...T,matchingRows:T.matchingRows.filter((K,ee)=>ee!==g)}))})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:he?`${w}/collections/${O}`:`${w}/list`,children:he?t.cogita.library.actions.collectionDetail:t.cogita.library.actions.allCards})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Ta?`${rn} / ${Ta}`:t.cogita.library.revision.progressUnlimited}),je==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),je==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),je==="ready"&&ve.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Ce}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",Xt]})]})]}),ia?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",ia.activeCount," / ",ia.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:ia.counts.map((g,T)=>{const K=T+1,ee=ia.currentLevel===K,le=ia.percentages[T]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":ee,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:K}),e.jsx("strong",{children:g})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,le))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[le.toFixed(1),"%"]})]},`level-${K}`)})})]}):null,Pa?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:Pa.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:Pa.dots.map(g=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,g.value*100))}%`,background:`rgba(${Math.round(255*(1-g.value))}, ${Math.round(200*g.value)}, 80, 0.9)`}},g.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:Pa.knownCount})]})]}):null,$t?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Dn})]})}):null]})]})]})})})]})]})}const ns=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],Ko={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},_o=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Do=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function Bo({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,libraryId:c,collectionId:p}){const[l,d]=n.useState(""),[w,m,k]=hs([]),[I,x,f]=ms([]),[Q,R]=n.useState(null),[j,B]=n.useState(null),[L,Z]=n.useState(null),q=`/#/cogita/library/${c}`;n.useEffect(()=>{Rn(c,p).then(F=>d(F.name)).catch(()=>d(t.cogita.library.collections.defaultName))},[c,p,t]),n.useEffect(()=>{ei({libraryId:c,collectionId:p}).then(F=>{if(!F.graphId||F.graphId==="00000000-0000-0000-0000-000000000000"){m([]),x([]);return}const ve=F.nodes.map(ue=>{var se;const ne=ue.payload??{},je=ne.position??{x:120,y:120},de=ne.params??{};return{id:ue.nodeId,type:"default",position:je,data:{nodeType:ue.nodeType,label:((se=ns.find($e=>$e.type===ue.nodeType))==null?void 0:se.label)??ue.nodeType,params:de}}}),J=F.edges.map(ue=>({id:ue.edgeId,source:ue.fromNodeId,target:ue.toNodeId,sourceHandle:ue.fromPort??void 0,targetHandle:ue.toPort??void 0}));m(ve),x(J)}).catch(()=>{m([]),x([])})},[c,p,x,m]);const E=n.useMemo(()=>w.find(F=>F.id===Q)??null,[w,Q]),O=F=>{var ne;const ve=crypto.randomUUID(),J=((ne=ns.find(je=>je.type===F))==null?void 0:ne.label)??F,ue={...Ko[F]};m(je=>[...je,{id:ve,type:"default",position:{x:120+je.length*40,y:120+je.length*40},data:{nodeType:F,label:J,params:ue}}]),R(ve)},he=n.useCallback(F=>{x(ve=>gs({...F,id:crypto.randomUUID()},ve))},[x]),Se=async()=>{B(null);try{await yr({libraryId:c,collectionId:p,nodes:w.map(F=>({nodeId:F.id,nodeType:F.data.nodeType,payload:{position:F.position,params:F.data.params}})),edges:I.map(F=>({edgeId:F.id,fromNodeId:F.source,fromPort:F.sourceHandle??null,toNodeId:F.target,toPort:F.targetHandle??null}))}),B(t.cogita.library.graph.saveSuccess)}catch{B(t.cogita.library.graph.saveFail)}},et=async()=>{try{const F=await ti({libraryId:c,collectionId:p});Z(F)}catch{Z(null)}},re=F=>{E&&m(ve=>ve.map(J=>J.id===E.id?{...J,data:{...J.data,params:F}}:J))};return e.jsx(At,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${q}/collections/${p}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:et,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:Se,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:ns.map(F=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>O(F.type),children:F.label},F.type))}),j?e.jsx("p",{className:"cogita-help",children:j}):null,L&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(L.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(L.connections)).replace("{infos}",String(L.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(Mn,{nodes:w,edges:I,onNodesChange:k,onEdgesChange:f,onConnect:he,onNodeClick:(F,ve)=>R(ve.id),fitView:!0,children:[e.jsx(Ln,{color:"rgba(120,160,200,0.2)"}),e.jsx(An,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),E?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:E.data.label}),E.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:c,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:E.data.params.tagId?{id:E.data.params.tagId,label:E.data.params.tagLabel??"",infoType:"topic"}:null,onChange:F=>re({...E.data.params,tagId:(F==null?void 0:F.id)??null,tagLabel:(F==null?void 0:F.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:E.data.params.scope??"any",onChange:F=>re({...E.data.params,scope:F.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),E.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:c,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:E.data.params.languageId?{id:E.data.params.languageId,label:E.data.params.languageLabel??"",infoType:"language"}:null,onChange:F=>re({...E.data.params,languageId:(F==null?void 0:F.id)??null,languageLabel:(F==null?void 0:F.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:E.data.params.scope??"any",onChange:F=>re({...E.data.params,scope:F.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),E.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:E.data.params.infoType??"word",onChange:F=>re({...E.data.params,infoType:F.target.value}),children:Do.map(F=>e.jsx("option",{value:F.value,children:F.label},F.value))})]}),e.jsx(Yt,{libraryId:c,infoType:E.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:E.data.params.infoId?{id:E.data.params.infoId,label:E.data.params.infoLabel??"",infoType:E.data.params.infoType??"word"}:null,onChange:F=>re({...E.data.params,infoId:(F==null?void 0:F.id)??null,infoLabel:(F==null?void 0:F.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),E.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:E.data.params.connectionType??"translation",onChange:F=>re({...E.data.params,connectionType:F.target.value}),children:_o.map(F=>e.jsx("option",{value:F.value,children:F.label},F.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:E.data.params.connectionId??"",onChange:F=>re({...E.data.params,connectionId:F.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(E.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const ss="cogita.preferences",rs="cogita.reviewer.preferences",Pr=["library_overview","all_cards","all_collections","all_revisions","storyboards","texts","dependencies","transfer"],is={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},all_revisions:{requiresCollection:!1,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},zo=["settings","run","shared"],Ba=30,ir=42;function va(t,a){const s=(t??"").trim();return s.length<=a?s:a<=1?s.slice(0,a):`${s.slice(0,Math.max(1,a-1)).trimEnd()}…`}function qo(t,a=""){const s=t.split("/").filter(Boolean);if(s[0]!=="cogita"||s[1]!=="library")return{};const r=s[2];if(!r)return{};if(!s[3])return{libraryId:r,target:"library_overview"};const i=new URLSearchParams(a),u=i.get("revisionId")??void 0,o=i.get("infoId")??void 0,y=i.get("infoView"),h=y==="cards"?"cards":y==="collections"?"collections":"overview",b=i.get("collectionView")==="overview"?"overview":"infos",c=i.get("collectionAction"),p=i.get("libraryAction"),d=i.get("libraryTarget")==="revisions"?"all_revisions":"all_collections";if(s[3]==="list")return{libraryId:r,target:p==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:u,infoId:o,infoView:h,libraryAction:p==="new-info"?"new-info":void 0};if(s[3]==="detail"||s[3]==="collection")return{libraryId:r,target:"all_cards",cardMode:s[3],revisionId:u,infoId:o,infoView:h};if(s[3]==="new"||s[3]==="add")return{libraryId:r,target:"new_card",revisionId:u,libraryAction:"new-info"};if(s[3]==="edit")return{libraryId:r,target:"new_card",revisionId:u,infoId:s[4]};if(s[3]==="infos"){const m=s[4];return m?s[5]==="checkcards"?{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u,infoId:m,infoView:"cards"}:s[5]==="collections"?{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u,infoId:m,infoView:"collections"}:{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u,infoId:m,infoView:"overview"}:{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u}}if(s[3]==="shared-revisions")return{libraryId:r,target:d,revisionId:u};if(s[3]==="revisions"){const m=s[4];return m?m==="shared-links"?{libraryId:r,target:"all_revisions",revisionView:"shared"}:m==="new"?{libraryId:r,target:"all_revisions",revisionView:"new"}:s[5]==="run"?{libraryId:r,target:"all_revisions",revisionId:m,revisionView:"run"}:s[5]==="shared"?{libraryId:r,target:"all_revisions",revisionId:m,revisionView:"shared"}:{libraryId:r,target:"all_revisions",revisionId:m,revisionView:"settings"}:{libraryId:r,target:"all_revisions"}}if(s[3]==="revision"&&s[4]==="run")return{libraryId:r,target:d,revisionView:"run",revisionId:u,infoId:o,infoView:h};if(s[3]==="dependencies")return{libraryId:r,target:"dependencies"};if(s[3]==="transfer")return{libraryId:r,target:"transfer"};if(s[3]==="storyboards")return s[4]==="new"?{libraryId:r,target:"new_storyboard"}:{libraryId:r,target:"storyboards"};if(s[3]==="texts")return s[4]==="new"?{libraryId:r,target:"new_text"}:{libraryId:r,target:"texts"};if(s[3]!=="collections")return{libraryId:r,target:"library_overview"};if(s[4]==="new")return{libraryId:r,target:"new_collection",revisionId:u};const w=s[4];return w?s[5]==="graph"?{libraryId:r,target:d,collectionId:w,revisionId:u,revisionView:"graph"}:s[5]==="shared-revisions"?{libraryId:r,target:d,collectionId:w,revisionId:u,revisionView:"shared"}:s[5]==="revision"?{libraryId:r,target:d,collectionId:w,revisionId:u,revisionView:s[6]==="run"?"run":"settings",collectionView:b}:c==="new-revision"?{libraryId:r,target:d,collectionId:w,revisionId:u,revisionView:"new"}:{libraryId:r,target:d,collectionId:w,revisionId:u,revisionView:"detail",collectionView:b}:c==="new-collection"?{libraryId:r,target:"new_collection",collectionAction:"new-collection"}:{libraryId:r,target:d}}function or(t,a="library_overview",s,r,i,u,o="overview",y="infos"){const h=(b,c)=>{const p=new URLSearchParams;c!=null&&c.revisionId&&p.set("revisionId",c.revisionId),c!=null&&c.collectionAction&&p.set("collectionAction",c.collectionAction),c!=null&&c.libraryAction&&p.set("libraryAction",c.libraryAction),c!=null&&c.libraryTarget&&p.set("libraryTarget",c.libraryTarget),c!=null&&c.infoId&&p.set("infoId",c.infoId),c!=null&&c.infoView&&(c!=null&&c.infoId)&&p.set("infoView",c.infoView),c!=null&&c.collectionView&&c.collectionView!=="infos"&&p.set("collectionView",c.collectionView);const l=p.toString();return l?`${b}?${l}`:b};if(!t)return"/cogita";if(a==="library_overview")return h(`/cogita/library/${t}`,{revisionId:i});if(a==="all_cards")return u?o==="cards"?h(`/cogita/library/${t}/infos/${u}/checkcards`,{revisionId:i}):o==="collections"?h(`/cogita/library/${t}/infos/${u}/collections`,{revisionId:i}):h(`/cogita/library/${t}/infos/${u}`,{revisionId:i}):h(`/cogita/library/${t}/list`,{revisionId:i,infoId:u,infoView:o});if(a==="new_card")return u?h(`/cogita/library/${t}/edit/${u}`,{revisionId:i}):h(`/cogita/library/${t}/list`,{revisionId:i,libraryAction:"new-info"});if(a==="all_collections"||a==="all_revisions"){const b=a==="all_revisions"?"revisions":void 0;return a==="all_revisions"&&i?r==="run"?h(`/cogita/library/${t}/revisions/${i}/run`,{revisionId:i}):r==="shared"?h(`/cogita/library/${t}/revisions/${i}/shared`,{revisionId:i}):h(`/cogita/library/${t}/revisions/${i}`,{revisionId:i}):a==="all_revisions"&&r==="new"?h(`/cogita/library/${t}/revisions/new`,{revisionId:i}):a==="all_revisions"?r==="shared"?h(`/cogita/library/${t}/revisions/shared-links`,{revisionId:i}):r==="run"?h(`/cogita/library/${t}/revision/run`,{revisionId:i,libraryTarget:b}):h(`/cogita/library/${t}/revisions`,{revisionId:i}):!s&&r==="run"?h(`/cogita/library/${t}/revision/run`,{revisionId:i,libraryTarget:b}):s?r==="graph"?h(`/cogita/library/${t}/collections/${s}/graph`,{revisionId:i,libraryTarget:b}):r==="settings"?h(`/cogita/library/${t}/collections/${s}/revision`,{revisionId:i,libraryTarget:b}):r==="run"?h(`/cogita/library/${t}/collections/${s}/revision/run`,{revisionId:i,libraryTarget:b}):r==="shared"?h(`/cogita/library/${t}/collections/${s}/shared-revisions`,{revisionId:i,libraryTarget:b}):r==="new"?h(`/cogita/library/${t}/collections/${s}`,{revisionId:i,libraryTarget:b,collectionAction:"new-revision"}):h(`/cogita/library/${t}/collections/${s}`,{revisionId:i,libraryTarget:b,collectionView:y}):h(`/cogita/library/${t}/collections`,{revisionId:i,libraryTarget:b})}return a==="new_collection"?h(`/cogita/library/${t}/collections`,{revisionId:i,collectionAction:"new-collection"}):a==="transfer"?h(`/cogita/library/${t}/transfer`,{revisionId:i}):a==="storyboards"?h(`/cogita/library/${t}/storyboards`,{revisionId:i}):a==="new_storyboard"?h(`/cogita/library/${t}/storyboards/new`,{revisionId:i}):a==="texts"?h(`/cogita/library/${t}/texts`,{revisionId:i}):a==="new_text"?h(`/cogita/library/${t}/texts/new`,{revisionId:i}):a==="dependencies"?h(`/cogita/library/${t}/dependencies`,{revisionId:i}):h(`/cogita/library/${t}`,{revisionId:i})}function wa(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function Vo(t){return typeof t=="string"&&Pr.includes(t)}function Oo(t,a){var y;if(!t.length)return null;const s=t.filter(h=>a.has(h.roleId)),r=s.length>0?s:t,i=r.map(h=>{var c,p;const b=((p=(c=h.fields.find(l=>l.fieldType==="role_kind"))==null?void 0:c.plainValue)==null?void 0:p.toLowerCase())??"";return{roleId:h.roleId,roleKind:b}}),u=i.find(h=>h.roleKind.includes("master"));if(u)return u.roleId;const o=i.find(h=>h.roleKind.includes("account")||h.roleKind.includes("user"));return o?o.roleId:((y=r[0])==null?void 0:y.roleId)??null}function Uo(t){if(!t)return{version:1,byLibrary:{}};try{const a=JSON.parse(t);return!a||typeof a!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:a.lastLibraryId,byLibrary:a.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function Jo({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b}){const c=nn(),p=Oa(),l=n.useMemo(()=>qo(p.pathname,p.search),[p.pathname,p.search]),d=t.cogita.workspace,[w,m]=n.useState([]),[k,I]=n.useState([]),[x,f]=n.useState([]),[Q,R]=n.useState([]),[j,B]=n.useState(void 0),[L,Z]=n.useState("library_overview"),[q,E]=n.useState(void 0),[O,he]=n.useState(void 0),[Se,et]=n.useState("detail"),[re,F]=n.useState(void 0),[ve,J]=n.useState(!1),[ue,ne]=n.useState(!0),[je,de]=n.useState(null),[se,$e]=n.useState(0),[ie,Ee]=n.useState(""),[Be,Je]=n.useState(""),[it,V]=n.useState(""),[ke,He]=n.useState([]),[Pe,Oe]=n.useState(""),[ot,wt]=n.useState(0),[ft,_e]=n.useState(null),[Ze,ut]=n.useState(null),Qe=n.useRef({version:1,byLibrary:{}}),be=n.useRef(!1),fe=n.useRef(!1),we=n.useRef(null),M=n.useMemo(()=>w.find(N=>N.libraryId===j)??null,[w,j]),$=n.useMemo(()=>k.find(N=>N.collectionId===q)??null,[k,q]),D=wa(p.pathname)==="/cogita/persons";n.useEffect(()=>{if(!j){He([]),Oe("");return}let N=!1;return xr({libraryId:j}).then(Te=>{if(N)return;const Me=Te.filter(lt=>(lt.roleKind??"").trim().toLowerCase()==="person");He(Me);try{const lt=window.localStorage.getItem(rs),ze=(lt?JSON.parse(lt):{})[j]??"",P=ze&&Me.some(Ae=>Ae.roleId===ze)?ze:"";Oe(P)}catch{Oe("")}}).catch(()=>{N||(He([]),Oe(""))}),()=>{N=!0}},[j,ot]),n.useEffect(()=>{if(j)try{const N=window.localStorage.getItem(rs),Te=N?JSON.parse(N):{};Pe?Te[j]=Pe:delete Te[j],window.localStorage.setItem(rs,JSON.stringify(Te))}catch{}},[j,Pe]);const z=n.useMemo(()=>Q.find(N=>N.revisionId===O)??null,[Q,O]),H=n.useMemo(()=>L==="new_card"?"all_cards":L==="new_collection"?"all_collections":L==="new_storyboard"?"storyboards":L==="new_text"?"texts":L,[L]),ae=n.useMemo(()=>Se==="new"?"settings":Se,[Se]),S=n.useMemo(()=>L==="new_collection"?"create":L==="all_collections"&&q?"selected":"search",[q,L]),C=n.useMemo(()=>l.infoId?"selected":L==="new_card"?"create":"search",[l.infoId,L]),ce=n.useMemo(()=>Se==="new"?"create":!O&&ae==="shared"?"shared":O?"selected":"search",[ae,O,Se]),_=n.useMemo(()=>x.find(N=>N.infoId===l.infoId)??null,[x,l.infoId]),oe=n.useMemo(()=>({library_overview:d.targets.libraryOverview,all_cards:d.targets.allCards,new_card:d.targets.newCard,all_collections:d.targets.allCollections,all_revisions:d.targets.allRevisions,new_collection:d.targets.newCollection,transfer:d.targets.transfer,storyboards:d.targets.storyboards,new_storyboard:d.targets.newStoryboard,texts:d.targets.texts,new_text:d.targets.newText,dependencies:d.targets.dependencies}),[d.targets]),v=n.useMemo(()=>oe[H]??H,[H,oe]),G=!!j,te=n.useMemo(()=>{const N=h==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":h==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return h==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:N},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:N},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:N},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:N},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:N},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:N},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:N},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:N},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:N},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:N},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:N},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:N},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:N},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:h==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:N},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:N},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:N},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:N},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:N},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:N},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:N},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:N},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:N},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:N},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:N},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:N},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:N},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:N},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:N},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:N},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:N},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:N},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:N},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:N},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:N},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:N},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:N},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:N},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:N},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:N},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[h]),W=te.length,Ie=Math.max(0,Math.min(se,W-1)),at=te[Ie],st=!!q,dt=G&&H==="all_collections",ct=dt&&L==="all_collections"&&st,yt=G&&(H==="all_revisions"||H==="all_collections"&&st&&(Se==="new"||!!O||ae==="settings"||ae==="run"||ae==="shared")),mt=yt,nt=yt&&!!O,Le=n.useCallback(N=>{const Te=!!N.libraryId;let Me=N.target,lt=N.collectionId,Ge=N.revisionId,ze=N.revisionView,P=N.infoId,Ae=N.infoView??l.infoView??"overview",Ye=N.collectionView??l.collectionView??"infos";Te?is[Me].requiresCollection&&!lt?(Me=Me==="all_revisions"?"all_revisions":"all_collections",Ge=void 0,ze="detail"):Me!=="all_collections"&&Me!=="all_revisions"?(lt=void 0,Ge=void 0,Me!=="new_card"&&Me!=="all_cards"&&(P=void 0,Ae="overview"),Me!=="new_collection"&&(Ye="infos")):is[Me].allowsRevision?zo.includes(ze)||(Ge=void 0):ze="detail":(Me="library_overview",lt=void 0,Ge=void 0,ze="detail",P=void 0,Ae="overview",Ye="infos"),B(N.libraryId),Z(Me),E(lt),he(Ge),et(ze),J(!1);const xt=wa(or(N.libraryId,Me,lt,ze,Ge,P,Ae,Ye));wa(`${p.pathname}${p.search}`)!==xt&&(we.current=xt,c(xt))},[p.pathname,p.search,c,l.collectionView,l.infoView]),pt=n.useMemo(()=>[{key:"library",label:d.layers.library,visible:!0,value:j??"",selectedLabel:(M==null?void 0:M.name)??d.path.noLibrarySelected,disabled:ue||w.length===0,options:w.map(N=>({value:N.libraryId,label:N.name})),emptyOption:d.noLibraryOption,onSelect:N=>{const Te=N||void 0;Le({libraryId:Te,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:d.layers.target,visible:G,value:H,selectedLabel:v,disabled:!G,options:Pr.map(N=>({value:N,label:oe[N]})),onSelect:N=>{const Te=N;Le({libraryId:j,target:Te,collectionId:q,revisionId:O,revisionView:Se,infoId:Te==="new_card"?l.infoId:void 0})}},{key:"info_mode",label:d.layers.target,visible:H==="all_cards",value:C,selectedLabel:C==="create"?d.infoMode.create:C==="selected"?(_==null?void 0:_.label)??re??t.cogita.library.list.selectedEmpty:d.infoMode.search,disabled:!G,options:[{value:"search",label:d.infoMode.search},{value:"create",label:d.infoMode.create},...l.infoId?[{value:"selected",label:(_==null?void 0:_.label)??re??t.cogita.library.list.selectedEmpty}]:[]],onSelect:N=>{if(N==="selected"){if(!l.infoId)return;Le({libraryId:j,target:"all_cards",collectionId:q,revisionId:O,revisionView:Se,infoId:l.infoId,infoView:"overview"});return}if(N==="create"){Le({libraryId:j,target:"new_card",collectionId:q,revisionId:O,revisionView:Se,infoId:void 0});return}Le({libraryId:j,target:"all_cards",collectionId:q,revisionId:O,revisionView:Se,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:d.layers.target,visible:H==="all_cards"&&!!l.infoId,value:L==="new_card"&&l.infoId?"edit":l.infoView==="cards"?"cards":l.infoView==="collections"?"collections":"overview",selectedLabel:L==="new_card"&&l.infoId?d.infoActions.edit:l.infoView==="cards"?d.infoActions.seeCards:l.infoView==="collections"?"Kolekcje":d.infoActions.overview,disabled:!G||!l.infoId,options:[{value:"overview",label:d.infoActions.overview},{value:"edit",label:d.infoActions.edit},{value:"cards",label:d.infoActions.seeCards},{value:"collections",label:"Kolekcje"}],onSelect:N=>{if(l.infoId){if(N==="edit"){Le({libraryId:j,target:"new_card",collectionId:q,revisionId:O,revisionView:Se,infoId:l.infoId});return}if(N==="cards"){Le({libraryId:j,target:"all_cards",collectionId:q,revisionId:O,revisionView:Se,infoId:l.infoId,infoView:"cards"});return}Le({libraryId:j,target:"all_cards",collectionId:q,revisionId:O,revisionView:Se,infoId:l.infoId,infoView:"overview"})}}},{key:"collection_mode",label:d.layers.collection,visible:dt,value:S,selectedLabel:S==="create"?t.cogita.library.actions.createCollection:S==="selected"?($==null?void 0:$.name)??d.path.noCollectionSelected:d.infoActions.search,disabled:!G,options:[{value:"search",label:d.infoActions.search},{value:"create",label:t.cogita.library.actions.createCollection},...q?[{value:"selected",label:($==null?void 0:$.name)??d.path.noCollectionSelected}]:[]],onSelect:N=>{if(N==="selected"&&q){Le({libraryId:j,target:"all_collections",collectionId:q,revisionId:void 0,revisionView:"detail"});return}if(N==="create"){Le({libraryId:j,target:"new_collection",collectionId:void 0,revisionId:void 0,revisionView:"detail"});return}Le({libraryId:j,target:"all_collections",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection_selected_action",label:d.layers.collection,visible:ct,value:ae==="graph"?"edit":ae==="settings"||ae==="run"||ae==="shared"?"revisions":(l.collectionView??"infos")==="overview"?"overview":"infos",selectedLabel:ae==="graph"?d.infoActions.edit:ae==="settings"||ae==="run"||ae==="shared"?d.targets.allRevisions:(l.collectionView??"infos")==="overview"?d.infoActions.overview:d.targets.allCards,disabled:!q,options:[{value:"overview",label:d.infoActions.overview},{value:"edit",label:d.infoActions.edit},{value:"infos",label:d.targets.allCards},{value:"revisions",label:d.targets.allRevisions}],onSelect:N=>{if(q){if(N==="edit"){Le({libraryId:j,target:"all_collections",collectionId:q,revisionId:void 0,revisionView:"graph"});return}if(N==="revisions"){Le({libraryId:j,target:"all_collections",collectionId:q,revisionId:O,revisionView:"settings"});return}Le({libraryId:j,target:"all_collections",collectionId:q,revisionId:void 0,revisionView:"detail",infoId:l.infoId,infoView:l.infoView,collectionView:N==="overview"?"overview":"infos"})}}},{key:"revision_mode",label:d.layers.revision,visible:mt,value:ce,selectedLabel:ce==="create"?d.revisionForm.createAction:ce==="shared"?d.targets.sharedRevisions:ce==="selected"?(z==null?void 0:z.name)??d.status.noRevisions:d.infoActions.search,disabled:H==="all_revisions"?!G:!st,options:[{value:"search",label:d.infoActions.search},{value:"create",label:d.revisionForm.createAction},{value:"shared",label:d.targets.sharedRevisions},...O?[{value:"selected",label:(z==null?void 0:z.name)??d.status.noRevisions}]:[]],onSelect:N=>{const Te=H==="all_revisions",Me=Te?"all_revisions":"all_collections",lt=Te?void 0:q;if(N==="selected"&&O){Le({libraryId:j,target:Me,collectionId:lt,revisionId:O,revisionView:ae==="run"||ae==="shared"?ae:"settings"});return}Le({libraryId:j,target:Me,collectionId:lt,revisionId:void 0,revisionView:N==="create"?"new":N==="shared"?"shared":"settings"})}},{key:"revision_selected_action",label:d.layers.revision,visible:nt,value:ae==="run"?"run":ae==="shared"?"shared":"settings",selectedLabel:ae==="run"?d.revisions.run:ae==="shared"?d.targets.sharedRevisions:d.infoActions.edit,disabled:!O,options:[{value:"settings",label:d.infoActions.edit},{value:"run",label:d.revisions.run},{value:"shared",label:d.targets.sharedRevisions}],onSelect:N=>{if(!O)return;const Te=H==="all_revisions";Le({libraryId:j,target:Te?"all_revisions":"all_collections",collectionId:Te?void 0:q,revisionId:O,revisionView:N==="run"?"run":N==="shared"?"shared":"settings"})}}],[k,C,x,w,ue,Le,Q,$,q,_,z,O,re,st,G,M,j,Se,L,ae,H,v,dt,ct,mt,nt,oe,t.cogita.library.list.selectedEmpty,l.infoId,l.infoView,l.collectionView,d.infoActions.edit,d.infoActions.overview,d.infoActions.seeCards,d.layers.collection,d.layers.library,d.layers.revision,d.layers.target,d.noLibraryOption,d.path.noCollectionSelected,d.path.noLibrarySelected,d.targets.allCards,d.targets.allRevisions,d.infoActions.search,d.revisionForm.createAction,d.revisions.run,d.targets.sharedRevisions,S,ce]),We=n.useMemo(()=>pt.filter(N=>N.visible),[pt]),Ue=n.useMemo(()=>We.filter(N=>N.key!=="library"&&N.key!=="collection"),[We]),It=n.useMemo(()=>Ue.find(N=>N.key==="target")??null,[Ue]),Nt=n.useMemo(()=>Ue.find(N=>N.key==="info_mode")??null,[Ue]),Kt=n.useMemo(()=>Ue.find(N=>N.key==="info_selected_action")??null,[Ue]),Pt=n.useMemo(()=>Ue.find(N=>N.key==="collection_mode")??null,[Ue]),_t=n.useMemo(()=>Ue.find(N=>N.key==="revision_mode")??null,[Ue]),Tt=n.useMemo(()=>Ue.find(N=>N.key==="collection_selected_action")??null,[Ue]),Mt=n.useMemo(()=>Ue.find(N=>N.key==="revision_selected_action")??null,[Ue]),Rt=n.useCallback((N,Te)=>N?e.jsx("div",{className:"cogita-sidebar-actions",children:N.options.map(Me=>e.jsx("button",{type:"button",className:`ghost ${String(N.value)===Me.value?"active":""}`,onClick:()=>N.onSelect(Me.value),disabled:N.disabled,title:Me.label,children:va(Me.label,Ba)},`${Te}:${N.key}:${Me.value}`))}):null,[]),ma=n.useMemo(()=>{const N=l.libraryId;if(!N||!p.pathname.startsWith("/cogita/library/"))return null;const Te={copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,libraryId:N};if(l.target==="library_overview")return e.jsx(Ci,{...Te});if(l.target==="all_cards")return l.infoId&&l.infoView==="cards"?e.jsx(no,{...Te,infoId:l.infoId,selectedReviewerRoleId:Pe||null}):e.jsx(Di,{...Te,mode:l.cardMode??"list"});if(l.target==="new_card")return e.jsx(Hi,{...Te,editInfoId:l.infoId});if(l.target==="dependencies")return e.jsx(Gi,{...Te});if(l.target==="transfer")return e.jsx(lo,{...Te});if(l.target==="storyboards"||l.target==="new_storyboard")return e.jsx(co,{...Te});if(l.target==="texts"||l.target==="new_text")return e.jsx(uo,{...Te});if(l.target==="all_collections"||l.target==="all_revisions"){if(l.target==="all_revisions"&&!l.collectionId)return l.revisionView==="run"?e.jsx(as,{...Te,revisionId:l.revisionId}):e.jsx(rr,{...Te,revisionId:l.revisionId});if(!l.collectionId&&l.revisionView==="run")return e.jsx(as,{...Te,revisionId:l.revisionId});if(l.collectionId){const Me={...Te,collectionId:l.collectionId};return l.revisionView==="graph"?e.jsx(Bo,{...Me}):l.revisionView==="shared"?e.jsx(oo,{...Te,collectionId:l.collectionId}):l.revisionView==="settings"?e.jsx(rr,{...Me,revisionId:l.revisionId}):l.revisionView==="run"?e.jsx(as,{...Me,revisionId:l.revisionId}):e.jsx(mo,{...Me})}return e.jsx(ho,{...Te})}return l.target==="new_collection"?e.jsx(bo,{...Te,onCreated:Me=>{Le({libraryId:N,target:L==="all_revisions"?"all_revisions":"all_collections",collectionId:Me,revisionId:void 0,revisionView:"graph"})}}):null},[a,Le,t,h,p.pathname,c,b,u,y,r,i,l.cardMode,l.collectionId,l.infoId,l.libraryId,l.revisionId,l.revisionView,l.target,o,s,L,Pe]);n.useEffect(()=>{let N=!1;return(async()=>{var Me,lt,Ge;ne(!0);try{await ai();const[ze,P,Ae]=await Promise.all([mr(),pr(),ni()]);if(N)return;m(ze);const Ye=new Set(Ae.nodes.filter(Ct=>Ct.nodeType==="role"&&Ct.canLink).map(Ct=>Ct.roleId??"")),xt=Oo(P,Ye);if(_e(xt),xt){const Ct=Ae.nodes.find(Vt=>Vt.nodeType==="data"&&Vt.roleId===xt&&(Vt.fieldType===ss||Vt.label===ss));ut((Ct==null?void 0:Ct.dataKeyId)??null),Qe.current=Uo(Ct==null?void 0:Ct.value)}const ye=(Me=ze.find(Ct=>Ct.libraryId===l.libraryId))==null?void 0:Me.libraryId,Ht=ye?(Ge=(lt=Qe.current.byLibrary)==null?void 0:lt[ye])==null?void 0:Ge.lastTarget:void 0,pa=Vo(Ht)?Ht:"library_overview";B(ye),Z(l.target??pa),he(l.revisionId),et(l.revisionView??"detail"),be.current=!0}catch{N||de(d.status.loadFailed)}finally{N||ne(!1)}})(),()=>{N=!0}},[d.status.loadFailed]),n.useLayoutEffect(()=>{if(be.current){if(!l.libraryId){B(void 0),Z(l.target??"library_overview"),E(void 0),he(void 0),et("detail");return}l.libraryId&&w.some(N=>N.libraryId===l.libraryId)&&B(l.libraryId),l.target&&Z(l.target),E(l.collectionId),he(l.revisionId),l.revisionView&&et(l.revisionView)}},[w,l.collectionId,l.libraryId,l.revisionId,l.revisionView,l.target]),n.useEffect(()=>{if(!j){I([]),E(void 0),f([]),R([]),he(void 0);return}let N=!1;return en({libraryId:j,limit:200}).then(Te=>{var Ge;if(N)return;const Me=Te.items;I(Me);const lt=(Ge=Me.find(ze=>ze.collectionId===l.collectionId))==null?void 0:Ge.collectionId;E(lt)}).catch(()=>{N||(I([]),E(void 0))}),()=>{N=!0}},[l.collectionId,j]),n.useEffect(()=>{if(!j||H!=="all_cards"&&L!=="new_card"){f([]);return}let N=!1;return bs({libraryId:j,limit:200}).then(Te=>{N||f(Te)}).catch(()=>{N||f([])}),()=>{N=!0}},[H,j,L]),n.useEffect(()=>{if(!j||L!=="all_revisions"&&!q){R([]),L!=="all_revisions"&&he(void 0);return}let N=!1;return ps({libraryId:j,collectionId:L==="all_revisions"?void 0:q}).then(Te=>{var lt;if(N)return;R(Te);const Me=(lt=Te.find(Ge=>Ge.revisionId===l.revisionId))==null?void 0:lt.revisionId;he(Me)}).catch(()=>{N||(R([]),he(void 0))}),()=>{N=!0}},[l.revisionId,q,j,L]),n.useEffect(()=>{const N=l.infoId;if(!j||!N){F(void 0);return}let Te=!1;return aa({libraryId:j,infoId:N}).then(Me=>{if(Te)return;const lt=Me.payload??{},Ge=lt.definition&&typeof lt.definition=="object"?lt.definition:null,ze=typeof(Ge==null?void 0:Ge.title)=="string"?Ge.title:void 0,P=typeof(Ge==null?void 0:Ge.question)=="string"?Ge.question:void 0,Ae=typeof lt.label=="string"?lt.label:void 0,Ye=typeof lt.name=="string"?lt.name:void 0,xt=typeof lt.title=="string"?lt.title:void 0;F(ze??P??Ae??Ye??xt??Me.infoId)}).catch(()=>{Te||F(N)}),()=>{Te=!0}},[l.infoId,j]),n.useEffect(()=>{if(!be.current||l.libraryId&&w.some(Ge=>Ge.libraryId===l.libraryId)&&l.libraryId!==j||l.target&&l.target!==L||l.revisionView&&l.revisionView!==Se||l.revisionId&&l.revisionId!==O||is[L].requiresCollection&&!q&&(l.target==="all_collections"||l.target==="all_revisions")&&l.collectionId)return;const N=wa(`${p.pathname}${p.search}`);if(wa(p.pathname)==="/cogita"&&!l.libraryId&&!j){we.current=null;return}if(wa(p.pathname)==="/cogita/persons"){we.current=null;return}if(wa(p.pathname)===`/cogita/library/${j}/revision/run`&&l.revisionView==="run"&&!l.collectionId&&(L==="all_collections"||L==="all_revisions")&&Se==="run"&&!q){we.current=null;return}const lt=wa(or(j,L,q,Se,O,l.infoId,l.infoView??"overview",l.collectionView??"infos"));if(N===lt){we.current=null;return}we.current!==lt&&(we.current=lt,c(lt,{replace:!0}))},[w,p.pathname,p.search,c,l.collectionId,l.infoId,l.infoView,l.collectionView,l.libraryId,l.revisionId,l.revisionView,l.target,q,j,O,Se,L]),n.useEffect(()=>{if(typeof window>"u")return;const N=()=>{window.innerWidth>920&&J(!1)};return window.addEventListener("resize",N),()=>window.removeEventListener("resize",N)},[]),n.useEffect(()=>{if(!be.current||!ft||!j||fe.current)return;const N=Qe.current,Te={...N.byLibrary??{}},Me={...Te[j]??{},lastCollectionId:q,lastRevisionId:O,lastRevisionView:Se,lastTarget:L},lt={version:1,lastLibraryId:j,byLibrary:{...Te,[j]:Me}},Ge=JSON.stringify(N),ze=JSON.stringify(lt);if(Ge===ze)return;Qe.current=lt,fe.current=!0,(async()=>{try{if(Ze)await si(Ze,{plainValue:ze});else{const Ae=await ri(ft,{itemName:ss,itemType:"data",plainValue:ze});ut(Ae.dataItemId)}}catch{de(d.status.savePrefsFailed)}finally{fe.current=!1}})()},[Ze,ft,q,j,O,Se,L,d.status.savePrefsFailed]);const Lt=async()=>{const N=ie.trim();if(!N){de(t.cogita.user.libraryNameRequired);return}de(null);try{const Te=await oi({name:N});m(Me=>[Te,...Me]),B(Te.libraryId),Z("library_overview"),E(void 0),Ee("")}catch{de(t.cogita.user.libraryCreateFailed)}},na=async()=>{if(!j||!q){de(d.status.selectLibraryFirst);return}const N=it.trim();if(!N){de(d.revisionForm.nameLabel);return}de(null);try{const Te=await ii({libraryId:j,collectionId:q,name:N,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});R(Me=>[Te,...Me]),he(Te.revisionId),Z(L==="all_revisions"?"all_revisions":"all_collections"),et("settings"),V("")}catch{de(d.status.loadFailed)}};return e.jsx(At,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,headerExtra:e.jsxs("div",{className:"cogita-header-reviewer-actions",children:[e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:Pe,disabled:!j,onChange:N=>{const Te=N.target.value;if(Te==="__new_person__"){c("/cogita/persons");return}Oe(Te)},children:[e.jsx("option",{value:"",children:j?"No person":"Select library first"}),ke.map(N=>e.jsx("option",{value:N.roleId,children:N.label},N.roleId)),e.jsx("option",{value:"__new_person__",children:"+ Create new person"})]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>c("/cogita/persons"),children:"Persons"})]}),children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${ve?"open":""}`,"aria-label":d.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{title:(M==null?void 0:M.name)??d.path.noLibrarySelected,children:va((M==null?void 0:M.name)??d.path.noLibrarySelected,Ba)}),e.jsx("p",{className:"cogita-sidebar-note",children:M?d.sidebar.libraryActionsHint:d.status.selectLibraryFirst}),Rt(It,"sidebar"),L==="all_revisions"&&_t?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.targets.allRevisions}),Rt(_t,"sidebar"),Mt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(z==null?void 0:z.name)??d.status.noRevisions,children:va((z==null?void 0:z.name)??d.status.noRevisions,Ba)}),Rt(Mt,"sidebar")]}):null]}):null,Nt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.infoActionsHint}),Rt(Nt,"sidebar"),Kt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(_==null?void 0:_.label)??re??t.cogita.library.list.selectedEmpty,children:va((_==null?void 0:_.label)??re??t.cogita.library.list.selectedEmpty,Ba)}),e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.selectedInfoActionsHint}),Rt(Kt,"sidebar")]}):null]}):null,Pt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.collectionActionsHint}),Rt(Pt,"sidebar"),$&&Tt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:$.name,children:va($.name,Ba)}),Rt(Tt,"sidebar"),L!=="all_revisions"&&_t?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.targets.allRevisions}),Rt(_t,"sidebar"),Mt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(z==null?void 0:z.name)??d.status.noRevisions,children:va((z==null?void 0:z.name)??d.status.noRevisions,Ba)}),Rt(Mt,"sidebar")]}):null]}):null]}):null]}):null]}),e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:d.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:r,children:d.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{y("cogita"),J(!1)},children:d.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:i,children:o?t.account.secureModeDisable:t.account.secureModeEnable}),e.jsx("button",{type:"button",className:"ghost",disabled:!j,onClick:()=>{j&&(c(`/cogita/live-sessions/${encodeURIComponent(j)}`),J(!1))},children:t.cogita.library.revision.live.hostTitle})]})]})]}),ve?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":d.sidebar.closeMenu,onClick:()=>J(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":d.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>J(N=>!N),"aria-label":ve?d.sidebar.closeMenu:d.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),We.map((N,Te)=>e.jsxs("div",{className:"cogita-browser-segment",children:[Te>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,N.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":N.label,title:N.selectedLabel,children:va(N.selectedLabel,ir)}):e.jsxs("select",{"aria-label":N.label,value:N.value,onChange:Me=>N.onSelect(Me.target.value),disabled:N.disabled,children:[N.emptyOption?e.jsx("option",{value:"",children:N.emptyOption}):null,N.options.map(Me=>e.jsx("option",{value:Me.value,title:Me.label,children:va(Me.label,ir)},`${N.key}:${Me.value}`))]})]},`menu:${N.key}`))]}),ma?e.jsxs(e.Fragment,{children:[(L==="all_collections"||L==="all_revisions")&&Se==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:d.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsxs("select",{value:q??"",onChange:N=>E(N.target.value||void 0),children:[e.jsx("option",{value:"",children:d.selectCollectionOption}),k.map(N=>e.jsx("option",{value:N.collectionId,children:N.name},N.collectionId))]})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:d.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:it,onChange:N=>V(N.target.value),placeholder:d.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:na,children:d.revisionForm.createAction}),je?e.jsx("p",{className:"cogita-form-error",children:je}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(wr.Provider,{value:!0,children:ma})})]}):null,ma?null:e.jsxs(e.Fragment,{children:[D?e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(io,{copy:t,onPersonCreated:N=>{wt(Te=>Te+1)}})}):null,!j&&!D?e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:at.step}),e.jsx("h2",{children:at.title})]}),e.jsxs("p",{children:[Ie+1," / ",W]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:at.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:at.passages.map(N=>e.jsx("p",{children:N},N))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:at.focus.map(N=>e.jsx("span",{children:N},N))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:at.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:te.map((N,Te)=>e.jsx("button",{type:"button",className:`ghost ${Te===Ie?"active":""}`,onClick:()=>$e(Te),"aria-label":`${Te+1}`,children:Te+1},`tutorial:${N.title}:${Te}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:Ie===0,onClick:()=>$e(N=>Math.max(0,N-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:Ie===W-1,onClick:()=>$e(N=>Math.min(W-1,N+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:ie,onChange:N=>Ee(N.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Lt,children:t.cogita.user.createLibraryAction}),je?e.jsx("p",{className:"cogita-form-error",children:je}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),w.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,w.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:w.map(N=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{Le({libraryId:N.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:N.name})]},N.libraryId))}):null]})]})]}):null]})]})]})})}const ll=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:Jo},Symbol.toStringTag,{value:"Module"}));function Qo({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,shareId:c}){const[p,l]=n.useState(null),[d,w]=n.useState("loading"),[m,k]=n.useState(t.cogita.library.collections.defaultName),[I,x]=n.useState("Cogita Library"),[f,Q]=n.useState([]),[R,j]=n.useState([]),[B,L]=n.useState("idle"),[Z,q]=n.useState({current:0,total:0}),[E,O]=n.useState(0),[he,Se]=n.useState(""),[et,re]=n.useState(null),[F,ve]=n.useState(null),[J,ue]=n.useState(null),[ne,je]=n.useState(null),[de,se]=n.useState(null),[$e,ie]=n.useState(null),[Ee,Be]=n.useState(()=>Gt()),[Je,it]=n.useState(null),[V,ke]=n.useState([]),[He,Pe]=n.useState({}),[Oe,ot]=n.useState({}),[wt,ft]=n.useState(null),[_e,Ze]=n.useState(null),[ut,Qe]=n.useState(null),[be,fe]=n.useState(null),[we,M]=n.useState({}),$=n.useRef(0),[D,z]=n.useState(null),H=n.useRef(null),ae=n.useRef(null),[S,C]=n.useState(null),[ce,_]=n.useState(!1),[oe,v]=n.useState(null),[G,te]=n.useState([]),[W,Ie]=n.useState(null),at=n.useRef(null),st=n.useRef(null),[dt,ct]=n.useState(null),[yt,mt]=n.useState(0),nt=n.useRef(null),Le=n.useRef({}),[pt,We]=n.useState(!1),[Ue,It]=n.useState({}),Nt=n.useRef(null),Kt=n.useRef(new Set),Pt=n.useRef({}),[_t,Tt]=n.useState([]),[Mt,Rt]=n.useState(new Set),[ma,Lt]=n.useState(!1),na=Oa(),N=n.useMemo(()=>new URLSearchParams(na.search),[na.search]),Te=n.useMemo(()=>N.get("key")??"",[N]),Me=(p==null?void 0:p.mode)??"random",lt=(p==null?void 0:p.check)??"exact",Ge=(p==null?void 0:p.limit)??20,ze=n.useMemo(()=>Za((p==null?void 0:p.revisionType)??Me),[p,Me]),P=n.useMemo(()=>{const A=p==null?void 0:p.revisionSettings,U=Cr(ze,N);return Kn(ze,A??U)},[p,N,ze]),Ae=n.useMemo(()=>t.cogita.library.revision[ze.labelKey]??Me,[t,Me,ze]),Ye=n.useMemo(()=>lt==="exact"?t.cogita.library.revision.checkValue:lt,[t,lt]),ye=d==="ready"?f[E]??null:null,Ht=(ye==null?void 0:ye.checkType)==="translation-match"&&be,pa=n.useRef(new Map),Ct=n.useRef(new Map),Vt=n.useRef(new Map),Wt=n.useRef(new Map),fa=n.useMemo(()=>ye?ye.cardType==="vocab"?t.cogita.library.revision.vocabLabel:ye.infoType?gt(t,ye.infoType):t.cogita.library.revision.infoLabel:"",[t,ye]),Fe=n.useMemo(()=>{var U;return ze.id!=="levels"?f.length:((U=Ue.pool)==null?void 0:U.length)??ze.getFetchLimit(Ge,P)},[Ue,P,ze,f.length,Ge]),La=ze.getProgressTotal?ze.getProgressTotal(f,Ue,Ge,P):ze.id==="levels"?Math.min(Ge,Fe):f.length,Aa=La?Math.min(E+1,La):0,Ot=Math.max(1,Number(P.tries??1)),Na=P.compare??"anchors",Sa=Math.max(0,Math.min(100,Number(P.minCorrectness??0))),Dt=(P.considerDependencies??"on")==="on",sa=Math.max(0,Math.min(100,Number(P.dependencyThreshold??85))),Ta=A=>{const U=A.slice();for(let me=U.length-1;me>0;me-=1){const De=Math.floor(Math.random()*(me+1));[U[me],U[De]]=[U[De],U[me]]}return U},rn=A=>ua(A,{treatSimilarCharsAsSame:!0})>=Sa,Xt=async()=>{const A=await da(),U=new Map,me=new Map;A.forEach(xe=>{const Ke=`${xe.itemType}:${xe.itemId}`,Re=ta(xe.itemType,xe.itemId,xe.checkType,xe.direction);U.has(Ke)||U.set(Ke,[]),U.get(Ke).push(xe),me.has(Re)||me.set(Re,[]),me.get(Re).push(xe)});const De=new Map,qe=new Map;return U.forEach((xe,Ke)=>De.set(Ke,ca(xe).score)),me.forEach((xe,Ke)=>qe.set(Ke,ca(xe).score)),{itemKnowness:De,cardKnowness:qe}},ba=async A=>{const U=Ue,me=A.concat(U.active??[]).concat(U.pool??[]).filter((g,T,K)=>K.findIndex(ee=>Ne(ee)===Ne(g))===T);if(!Dt){Rt(new Set(me.map(Ne)));return}const{itemKnowness:De,cardKnowness:qe}=await Xt(),xe=g=>{if(g.cardType!=="info"||g.infoType!=="citation"||g.checkType!=="quote-fragment")return!0;const T=Qt(g.direction);if(!(T!=null&&T.fragmentId))return!0;const K=g.description??"";if(!K.trim())return!0;const le=ka(K).nodes[T.fragmentId];if(!le||!le.leftId&&!le.rightId)return!0;const X=[le.leftId,le.rightId].filter(ge=>!!ge);if(X.length===0)return!0;const pe=X.map(ge=>{const Ve=ta("info",g.cardId,"quote-fragment",ge);return qe.get(Ve)??0});return pe.reduce((ge,Ve)=>ge+Ve,0)/pe.length>=sa},Ke=(p==null?void 0:p.collectionId)??null,Re=Ke?_t.filter(g=>St(g.childItemType)==="collection"&&g.childItemId===Ke&&!St(g.childCheckType)&&!St(g.childDirection)):[],Ce=Ke&&me.length>0?me.reduce((g,T)=>g+(qe.get(Ne(T))??0),0)/me.length:0,Xe=new Set;for(const g of me){if(g.cardType!=="info"){Xe.add(Ne(g));continue}if(!xe(g))continue;const T=_t.filter(le=>$r(le,g)).concat(Re);if(T.length===0){Xe.add(Ne(g));continue}let K=0;for(const le of T)if(St(le.parentItemType)==="collection")K+=le.parentItemId===Ke?Ce:0;else if(St(le.parentCheckType)||St(le.parentDirection)){const X=St(le.parentCheckType),pe=St(le.parentDirection),Y=ta(le.parentItemType,le.parentItemId,X,pe);K+=qe.get(Y)??0}else{const X=`${le.parentItemType}:${le.parentItemId}`;K+=De.get(X)??0}K/T.length>=sa&&Xe.add(Ne(g))}Rt(Xe)},on=A=>{for(let U=A;U<f.length;U+=1){const me=f[U];if(me&&(!Dt||me.cardType!=="info"||Mt.has(Ne(me))))return U}return-1},$t=A=>!Dt||A.cardType!=="info"||Mt.has(Ne(A)),ra=A=>{if(ze.id!=="temporal"&&ze.id!=="levels")return null;const U=Ue,me=(U.active??[]).concat(U.pool??[]),De=new Set;for(const qe of me){const xe=Ne(qe);if(!(De.has(xe)||A.has(xe))&&(De.add(xe),$t(qe)))return qe}return null},Zt=n.useMemo(()=>{if(ze.id!=="levels")return null;const A=Ue,U=A.pool??[],me=A.active??[],De=A.levelMap??{},qe=Math.max(1,Number(P.levels??1)),xe=Array.from({length:qe},()=>0),Ke=new Set(me.map(g=>Ne(g)));U.forEach(g=>{const T=Math.min(qe,Math.max(1,De[Ne(g)]??1));xe[T-1]+=1});const Re=U.length||1,Ce=xe.map(g=>g/Re*100),Xe=ye?De[Ne(ye)]??1:null;return{counts:xe,percentages:Ce,currentLevel:Xe,levelsCount:qe,activeCount:me.length,poolCount:U.length,activeSet:Ke}},[Ue,P,ze,ye]),Ca=n.useMemo(()=>{if(ze.id!=="temporal")return null;const A=Ue,U=A.pool??[],me=A.active??[],De=A.knownessMap??{},qe=new Set(A.unknownSet??[]);let xe=0;U.forEach(Ce=>{(De[Ne(Ce)]??0)>1&&(xe+=1)});const Ke=qe.size,Re=me.map(Ce=>({id:Ne(Ce),value:qe.has(Ne(Ce))?0:Math.max(0,Math.min(1,De[Ne(Ce)]??0))}));return{knownCount:xe,unknownCount:Ke,dots:Re}},[Ue,ze]),ln=n.useMemo(()=>{if(!Dt)return 0;const A=Ue;return f.concat(A.active??[]).concat(A.pool??[]).filter((me,De,qe)=>qe.findIndex(xe=>Ne(xe)===Ne(me))===De).filter(me=>me.cardType==="info"&&!Mt.has(Ne(me))).length},[Dt,Ue,f,Mt]);n.useEffect(()=>{if(!Dt||B!=="ready")return;const A=Ue,me=f.concat(A.active??[]).concat(A.pool??[]).filter((xe,Ke,Re)=>Re.findIndex(Ce=>Ne(Ce)===Ne(xe))===Ke).filter(xe=>xe.cardType!=="info"||Mt.has(Ne(xe))).length,De=at.current;if(at.current=me,De===null||me<=De)return;const qe=me-De;Ie(`New card available (+${qe})`),st.current&&window.clearTimeout(st.current),st.current=window.setTimeout(()=>Ie(null),2200)},[Dt,B,Ue,f,Mt]),n.useEffect(()=>()=>{st.current&&window.clearTimeout(st.current)},[]);const zt=(A,U)=>{const me=ze.applyOutcome({queue:f,meta:Ue},ye,Ge,P,{correct:A,correctness:U,createdUtc:new Date().toISOString()});Q(me.queue),It(me.meta);const De=me.queue[E+1];De&&Fa(De,E+1)};n.useEffect(()=>{if(!c){w("error");return}w("loading"),li({shareId:c,key:Te}).then(A=>{l(A),k(A.collectionName),x(A.libraryName),w("ready")}).catch(()=>{w("error")})},[c,Te]),n.useEffect(()=>{c&&ci({shareId:c,key:Te,type:"language"}).then(A=>j(A)).catch(()=>j([]))},[c,Te]),n.useEffect(()=>{!c||d!=="ready"||di({shareId:c,key:Te}).then(A=>Tt(A.items??[])).catch(()=>Tt([]))},[c,Te,d]),n.useEffect(()=>{if(!c||d!=="ready")return;let A=!0;return(async()=>{L("loading"),q({current:0,total:ze.id==="levels"||ze.id==="random-once"?0:ze.getFetchLimit(Ge,P)});try{const me=[];let De=null,qe=null;do{const T=await ui({shareId:c,key:Te,limit:300,cursor:De});if(me.push(...T.items),(ze.id==="levels"||ze.id==="temporal"||ze.id==="random-once")&&T.total&&(qe=T.total),q(K=>({current:me.length,total:K.total||T.total||ze.getFetchLimit(Ge,P)})),De=T.nextCursor??null,qe!==null&&me.length>=qe||ze.id!=="levels"&&ze.id!=="temporal"&&ze.id!=="random-once"&&me.length>=ze.getFetchLimit(Ge,P))break}while(De);if(!A)return;const xe=Xa(me);let Ke;if(ze.id==="levels"){const T=Math.max(1,Number(P.levels??1));Ke={},xe.forEach(K=>{const ee=Ne(K);Ke[ee]=Math.max(1,Math.min(T,1))})}let Re=null,Ce=null,Xe=null;if(ze.id==="temporal"){const T=await da(),K=new Set(xe.map(X=>Ne(X))),ee=T.reduce((X,pe)=>{const Y=ta(pe.itemType,pe.itemId,pe.checkType,pe.direction);return K.has(Y)&&(X[Y]||(X[Y]=[]),X[Y].push(pe)),X},{});Re={},Ce=new Set,Xe={};const le=Date.now();xe.forEach(X=>{const pe=Ne(X),Y=ee[pe]??[];if(Y.length===0){Re[pe]=0,Ce.add(pe),Xe[pe]=[];return}const ge=js(Y);Xe[pe]=ge;const Ve=En(ge,le);Re[pe]=Ve.knowness})}const g=ze.id==="levels"?Ns(xe,Ge,P,Ke):ze.id==="temporal"?ks(xe,Ge,P,Re??{},Ce??new Set,Xe??{}):ze.prepare(xe,Ge,P);Q(g.queue),It(g.meta),O(0),L("ready"),q(T=>({current:Math.min(T.current,T.total),total:T.total}))}catch{A&&L("error")}})(),()=>{A=!1}},[c,Te,Ge,ze,P,d]),n.useEffect(()=>{ba(f)},[f,_t,Dt,sa,p==null?void 0:p.collectionId]),n.useEffect(()=>{if(!ye||!Dt){Lt(!1);return}if(ye.cardType!=="info"||Mt.has(Ne(ye))){Lt(!1);return}const A=on(E+1);if(A>=0){Lt(!1),O(A);return}if(ze.id==="temporal"||ze.id==="levels"){const U=f.slice(0,E+1),me=f.slice(E+1).filter($t),De=U.concat(me),qe=new Set(De.map(Ne)),xe=ra(qe);if(xe){const Re=Ne(xe);qe.has(Re)||(De.push(xe),qe.add(Re),It(Ce=>{const Xe=Ce,g=new Set(Xe.queued??[]);return g.add(Re),{...Xe,queued:g}}))}const Ke=De.findIndex((Re,Ce)=>Ce!==E&&$t(Re));if(Ke>=0){Q(De),O(Ke),Lt(!1);return}}Lt(!0)},[ye,Mt,Dt,E,f,Ue,ze.id]),n.useEffect(()=>{if(Se(""),re(null),ct(null),mt(0),ke([]),Pe({}),ot({}),ft(null),Ze(null),Qe(null),je(null),se(null),ie(null),Be(Gt()),_(!1),We(!1),C(null),fe(null),M({}),!ye){ve(null),ue(null),je(null),se(null),ie(null),Be(Gt());return}ye.cardType==="info"&&ye.infoType==="computed"&&ve(t.cogita.library.revision.loadingComputed);let A=!0;return Fa(ye,E).then(U=>{!A||!U||(ve(U.prompt),ue(U.expectedAnswer),ke(U.computedExpected),Pe(U.computedAnswers),ft(U.answerTemplate),Ze(U.outputVariables),Qe(U.variableValues),je(U.questionPrompt),se(U.questionPromptModel),ie(U.questionExpectedModel),Be(U.questionInitialAnswers))}),()=>{A=!1}},[ye,c,t]),n.useEffect(()=>{if(!ye||ye.cardType!=="info"||ye.infoType!=="citation"){Nt.current=null,Kt.current=new Set,it(null);return}const A=ye.description??"",U=(ye.label??"").trim(),me=U.replace(/\s+/g," ").trim(),De=A.replace(/\s+/g," ").trim(),qe=me&&me!==De?U:t.cogita.library.infoTypes.citation;if(!A){it(null),ue(null);return}const xe=ka(A);Nt.current=xe,ve(qe);let Ke=!0;return da().then(Re=>{if(!Ke)return;const Ce=new Map;Re.forEach(ee=>{if(ee.itemType!=="info"||ee.checkType!=="quote-fragment"||!ee.direction)return;const le=Qt(ee.direction);if(!le)return;const X=`${ee.itemId}:${le.fragmentId}`;Ce.has(X)||Ce.set(X,[]),Ce.get(X).push(ee)});const Xe={},g=new Set;Ce.forEach((ee,le)=>{const[X,pe]=le.split(":",2);if(X!==ye.cardId)return;const Y=ca(ee).score;Xe[pe]=Y,Y>=sa&&g.add(pe)}),Kt.current=g,Pt.current=Xe;const T=Qt(ye.direction);if(T!=null&&T.fragmentId&&xe.nodes[T.fragmentId]){ya(xe,T.fragmentId,qe);return}const K=za(xe,g,Xe,sa,Dt,ye.direction);ya(xe,(K==null?void 0:K.id)??null,qe)}).catch(()=>{Kt.current=new Set,Pt.current={};const Re=Qt(ye.direction);if(Re!=null&&Re.fragmentId&&xe.nodes[Re.fragmentId]){ya(xe,Re.fragmentId,qe);return}const Ce=za(xe,Kt.current,{},sa,Dt,ye.direction);ya(xe,(Ce==null?void 0:Ce.id)??null,qe)}),()=>{Ke=!1}},[ye,t,Dt,sa]),n.useEffect(()=>{if(!ye||ye.cardType!=="vocab"||ye.checkType!=="translation-match"){fe(null),M({});return}const me=(Ue.pool??Ue.active??f).filter(Re=>Re.cardType==="vocab"&&Re.checkType==="translation-match").filter((Re,Ce,Xe)=>Xe.findIndex(g=>g.cardId===Re.cardId)===Ce);me.some(Re=>Re.cardId===ye.cardId)||me.unshift(ye);const qe=Ta(me).slice(0,6).map(Re=>{const Ce=Re.label.split("↔").map(T=>T.trim()).filter(Boolean);if(Ce.length<2)return null;const Xe=`${Re.cardId}:L`,g=`${Re.cardId}:R`;return{cardId:Re.cardId,leftId:Xe,rightId:g,leftLabel:Ce[0],rightLabel:Ce[1]}}).filter(Boolean),xe=qe.map(Re=>Re.leftId),Ke=Ta(qe.map(Re=>Re.rightId));fe({pairs:qe,leftOrder:xe,rightOrder:Ke,selection:{},activeLeft:null,activeRight:null,locked:{}})},[ye,f,Ue]),n.useEffect(()=>()=>{H.current&&window.clearTimeout(H.current),ae.current&&window.clearTimeout(ae.current)},[]);const Ra=n.useRef(null);n.useEffect(()=>{if(!ye)return;const A=Ne(ye),U=typeof document<"u"?document.activeElement:null;if(Ra.current===A&&U&&(U.tagName==="INPUT"||U.tagName==="TEXTAREA"))return;let me=0;const De=()=>{if(ye){if(ye.cardType==="info"&&ye.infoType==="computed"){if(V.length>0){const xe=In(wt,V,_e),Ke=xe?Le.current[xe]:null;if(Ke&&(Ke.focus(),document.activeElement===Ke)){Ra.current=A;return}}if(nt.current&&(nt.current.focus(),document.activeElement===nt.current)){Ra.current=A;return}}else if(ye.cardType==="vocab"&&nt.current&&(nt.current.focus(),document.activeElement===nt.current)){Ra.current=A;return}me<6&&(me+=1,window.setTimeout(De,40))}},qe=window.setTimeout(De,40);return()=>window.clearTimeout(qe)},[ye,V,wt,_e]),n.useEffect(()=>{if(!pt)return;const A=U=>{U.key==="Enter"&&(U.preventDefault(),Ft())};return window.addEventListener("keydown",A),()=>window.removeEventListener("keydown",A)},[pt]);const $a=A=>{te(A),v(ca(A))};n.useEffect(()=>{if(!ye){v(null),te([]);return}const A=ye.cardType==="info"?"info":"connection";if(ye.cardType==="info"&&ye.infoType==="citation"){da().then(U=>{const me=U.filter(De=>De.itemType==="info"&&De.itemId===ye.cardId&&De.checkType==="quote-fragment"&&Tn(De.direction,ye.direction));$a(me)}).catch(()=>{v(null),te([])});return}Nn(A,ye.cardId,ye.checkType,ye.direction).then(U=>$a(U)).catch(()=>{v(null),te([])})},[ye]);const Ja=(A,U,me,De)=>{if(A==="info"&&me==="quote-fragment"){da().then(qe=>{const xe=qe.filter(Ke=>Ke.itemType==="info"&&Ke.itemId===U&&Ke.checkType==="quote-fragment"&&Tn(Ke.direction,De));$a(xe)}).catch(()=>{v(null),te([])});return}Nn(A,U,me,De).then(qe=>$a(qe)).catch(()=>{v(null),te([])})},cn=(A,U,me)=>{var Ke;const De=((Ke=me.pairs.find(Re=>Re.leftId===A))==null?void 0:Ke.rightId)??null;if(!De)return me;const qe=De===U;M(Re=>({...Re,[A]:qe?"correct":"incorrect"})),H.current&&window.clearTimeout(H.current),ae.current&&window.clearTimeout(ae.current),$.current+=1;const xe={kind:qe?"correct":"incorrect",tick:$.current};if(z(null),H.current=window.setTimeout(()=>z(xe),0),ae.current=window.setTimeout(()=>z(null),420),qe){const Re={...me.locked,[A]:!0};return Object.keys(Re).length>=me.pairs.length?(re("correct"),We(!0)):re("correct"),{...me,selection:{...me.selection,[A]:U},activeLeft:null,activeRight:null,locked:Re}}return re("incorrect"),{...me,activeLeft:null,activeRight:null}},Qa=A=>{fe(U=>!U||U.locked[A]?U:U.activeRight?cn(A,U.activeRight,U):{...U,activeLeft:U.activeLeft===A?null:A})},_n=A=>{fe(U=>U&&(U.activeLeft?cn(U.activeLeft,A,U):{...U,activeRight:U.activeRight===A?null:A}))},ia=A=>{Be(U=>{if(ne!=null&&ne.multiple){const me=U.selection.includes(A)?U.selection.filter(De=>De!==A):Array.from(new Set([...U.selection,A]));return{...U,selection:me}}return{...U,selection:U.selection[0]===A?[]:[A]}})},Pa=(A,U)=>{Be(me=>{var Ce;const De=Math.max(2,((Ce=ne==null?void 0:ne.columns)==null?void 0:Ce.length)??2),qe=Array.from({length:De},(Xe,g)=>me.matchingSelection[g]??null);if(qe[A]=qe[A]===U?null:U,qe.some(Xe=>Xe==null))return{...me,matchingSelection:qe};const xe=qe.map(Xe=>Number(Xe)),Ke=xe.join("|"),Re=me.matchingRows.some(Xe=>Xe.join("|")===Ke);return{...me,matchingRows:Re?me.matchingRows:[...me.matchingRows,xe],matchingSelection:new Array(De).fill(null)}})},Dn=(A,U)=>{Be(me=>{const De=[...me.ordering],qe=A+U;return qe<0||qe>=De.length?me:([De[A],De[qe]]=[De[qe],De[A]],{...me,ordering:De})})},Ft=()=>{var A;if(ye&&ye.cardType==="info"&&ye.infoType==="citation"&&Nt.current&&Je&&!((A=Qt(ye.direction))!=null&&A.fragmentId)){const U=za(Nt.current,Kt.current,Pt.current,sa,Dt,ye.direction,Je.fragmentId);if(U){re(null),Se(""),_(!1),ot({}),We(!1),ct(null),mt(0),ya(Nt.current,U.id,Je.title);return}}re(null),Se(""),_(!1),ot({}),We(!1),ct(null),mt(0),O(U=>Math.min(U+1,f.length))},qt=A=>{if(!ye)return;const U=A.expected??null,me=A.answer??"";let De=U??"",qe=me;if(!U&&A.expectedMap&&A.answerMap){const T=Object.keys(A.expectedMap).sort((K,ee)=>K.localeCompare(ee));De=T.map(K=>{var ee;return((ee=A.expectedMap)==null?void 0:ee[K])??""}).join("|"),qe=T.map(K=>{var ee;return((ee=A.answerMap)==null?void 0:ee[K])??""}).join("|")}const xe=De?qa(De,qe,Na):new Uint8Array,Ke={revisionType:ze.id,evalType:A.evalType,direction:A.direction,prompt:F??"",expected:U,answer:me,expectedAnswers:A.expectedMap??null,answers:A.answerMap??null,correct:A.correct,maskBase64:xe.length?ja(xe):null,checkMode:lt,compareMode:Na,minCorrectness:Sa},Re=new TextEncoder().encode(JSON.stringify(Ke)),Ce=ye.cardType==="info"?"info":"connection",Xe=A.overrideCheckType??ye.checkType??null,g=A.overrideDirection??ye.direction??null;kn({itemType:Ce,itemId:ye.cardId,checkType:Xe,direction:g,revisionType:ze.id,evalType:A.evalType,correct:A.correct,maskBase64:xe.length?ja(xe):null,payloadBase64:ja(Re)}).then(()=>{Ja(Ce,ye.cardId,Xe,g),ba(f)}).catch(()=>{})},Ea=(A,U)=>{const me=pa.current.get(U);if(me)return Promise.resolve(me);const De=Ct.current.get(U);if(De)return De;const qe=Ms({shareCode:c,infoId:A,key:Te}).then(xe=>{var T,K;const Ke=xe.payload,Re=((T=Ke.definition)==null?void 0:T.graph)??null,Ce="",Xe=((K=Ke.definition)==null?void 0:K.answerTemplate)??"",g=Ir(Re,Ce,Xe);if(g){const le={sample:Mr(g),answerTemplate:Xe||null};return pa.current.set(U,le),le}return Ls({shareId:c,infoId:A,key:Te}).then(ee=>{const le={sample:ee,answerTemplate:null};return pa.current.set(U,le),le})}).catch(()=>Ls({shareId:c,infoId:A,key:Te}).then(xe=>{const Ke={sample:xe,answerTemplate:null};return pa.current.set(U,Ke),Ke}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{Ct.current.delete(U)});return Ct.current.set(U,qe),qe},Fa=(A,U)=>{var Re;const me=`${Ne(A)}:${U}`,De=Vt.current.get(me);if(De)return Promise.resolve(De);const qe=Wt.current.get(me);if(qe)return qe;const xe=Ce=>{const Xe={...Ce,questionPrompt:Ce.questionPrompt??null,questionPromptModel:Ce.questionPromptModel??null,questionExpectedModel:Ce.questionExpectedModel??null,questionInitialAnswers:Ce.questionInitialAnswers??Gt()};return Vt.current.set(me,Xe),Xe};let Ke;if(A.cardType==="vocab"){if(A.checkType==="translation-match")return Ke=Promise.resolve(xe({prompt:A.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),Ke;const Ce=A.label.split("↔").map(Xe=>Xe.trim()).filter(Boolean);if(Ce.length>=2){const g=(A.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",T=g?Ce[0]:Ce[1],K=g?Ce[1]:Ce[0];Ke=Promise.resolve(xe({prompt:T,expectedAnswer:K,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else Ke=Promise.resolve(xe({prompt:A.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(A.cardType==="info"&&A.infoType==="word"){const Ce=(Re=A.description)!=null&&Re.startsWith("Language: ")?A.description.replace("Language: ",""):null;Ke=Promise.resolve(xe({prompt:A.label,expectedAnswer:Ce,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(A.cardType==="info"&&A.infoType==="question"){const Ce=Sn(A.payload??null,A.label);Ce?Ke=Promise.resolve(xe({prompt:Ce.promptText,expectedAnswer:Ce.promptModel.kind==="text"&&(typeof Ce.expectedModel=="string"||typeof Ce.expectedModel=="number")?String(Ce.expectedModel):null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null,questionPrompt:Ce.promptPayload,questionPromptModel:Ce.promptModel,questionExpectedModel:Ce.expectedModel,questionInitialAnswers:Ce.initialAnswers})):Ke=Ms({shareCode:c,infoId:A.cardId,key:Te}).then(Xe=>{const g=Sn(Xe.payload??{},A.label);return xe(g?{prompt:g.promptText,expectedAnswer:g.promptModel.kind==="text"&&(typeof g.expectedModel=="string"||typeof g.expectedModel=="number")?String(g.expectedModel):null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null,questionPrompt:g.promptPayload,questionPromptModel:g.promptModel,questionExpectedModel:g.expectedModel,questionInitialAnswers:g.initialAnswers}:{prompt:A.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})}).catch(()=>xe({prompt:A.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Wt.current.delete(me)})}else A.cardType==="info"&&A.infoType==="computed"?Ke=Ea(A.cardId,me).then(Ce=>{var ee,le;if(!Ce.sample)return xe({prompt:A.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const Xe=Ce.sample,g=Xe.expectedAnswers?Object.entries(Xe.expectedAnswers).map(([X,pe])=>({key:X,expected:pe})):[],T=g.reduce((X,pe)=>(X[pe.key]="",X),{}),K=Xe.expectedAnswerIsSentence&&((ee=Xe.expectedAnswer)==null?void 0:ee.trim())||null;return xe({prompt:Xe.prompt,expectedAnswer:g.length>0?K:((le=Xe.expectedAnswer)==null?void 0:le.trim())||null,computedExpected:g,computedAnswers:T,computedValues:Xe.values??null,answerTemplate:Ce.answerTemplate,outputVariables:Xe.outputVariables??null,variableValues:Xe.variableValues??null})}).catch(()=>xe({prompt:A.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Wt.current.delete(me)}):Ke=Promise.resolve(xe({prompt:A.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return Wt.current.set(me,Ke),Ke},ya=(A,U,me)=>{const De=Object.keys(A.nodes).length,qe=Kt.current.size;if(!U){it({title:me,before:A.text,after:"",fragmentId:null,total:De,completed:qe}),ue(null),We(!0);return}const xe=A.nodes[U];if(!xe)return;const Ke=$n(A.text,xe);it({title:me,before:Ke.before,after:Ke.after,fragmentId:xe.id,total:De,completed:qe}),ue(Ke.fragment),We(!1)},Bn=()=>{const A=Nt.current;A&&it(U=>U&&{...U,total:Object.keys(A.nodes).length,completed:Kt.current.size})},Ka=()=>{const A=f[E+1];A&&Fa(A,E+1)},dn=()=>{if(Ka(),ye&&ye.cardType==="vocab"&&ye.checkType==="translation-match"&&be){if(be.pairs.length===0){re("incorrect"),We(!0);return}const xe=be.pairs.reduce((K,ee)=>(K[ee.rightId]=ee.rightLabel,K),{});let Ke=0;const Re={};be.pairs.forEach(K=>{const le=be.selection[K.leftId]===K.rightId;Re[K.leftId]=le?"correct":"incorrect",le&&(Ke+=1)});const Ce=be.pairs.length||1,Xe=Ke/Ce,g=Ke===be.pairs.length;M(K=>({...K,...Re})),g?(re("correct"),We(!0),mt(0)):(re("incorrect"),We(!1),mt(K=>{const ee=K+1;return ee>=Ot&&(_(!0),We(!0),fe(le=>{if(!le)return le;const X=le.pairs.reduce((pe,Y)=>(pe[Y.leftId]=Y.rightId,pe),{});return{...le,selection:X}})),ee})),zt(g,Xe);const T="connection";Promise.all(be.pairs.map(K=>{const ee=be.selection[K.leftId]??null,le=ee?xe[ee]:"",X={left:K.leftLabel,expected:K.rightLabel,answer:le,checkType:"translation-match"},pe=new TextEncoder().encode(JSON.stringify(X));return kn({itemType:T,itemId:K.cardId,checkType:"translation-match",direction:null,revisionType:ze.id,evalType:"translation-match",correct:ee===K.rightId,maskBase64:null,payloadBase64:ja(pe)})})).then(()=>{Ja(T,ye.cardId,ye.checkType,ye.direction),ba(f)}).catch(()=>{});return}if(ye&&ye.cardType==="info"&&ye.infoType==="question"&&de){const xe={text:Ee.text,selection:Ee.selection,booleanAnswer:Ee.booleanAnswer,ordering:Ee.ordering,matchingPaths:Ee.matchingRows},Ke=Jt({prompt:de,expected:$e,answer:xe}),Re=Ke.mask?ua(Ke.mask):Ke.correct?100:0;ct(Ke.mask),Ke.correct?(re("correct"),ot({}),We(!0),mt(0),zt(!0,Re/100)):(re("incorrect"),ot({}),We(!1),mt(Ce=>{const Xe=Ce+1;return Xe>=Ot&&(_(!0),We(!0)),Xe}),zt(!1,Re/100)),qt({correct:Ke.correct,direction:F?`${F} -> question`:"question",expected:JSON.stringify($e??null),answer:JSON.stringify(xe),evalType:`question:${de.kind}`});return}if(V.length>0){const xe=V.reduce((Re,Ce)=>{const Xe=He[Ce.key]??"";return Re[Ce.key]=Bt(Xe)===Bt(Ce.expected)?"correct":"incorrect",Re},{});V.every(({key:Re,expected:Ce})=>{const Xe=He[Re]??"";return lt==="exact"&&Bt(Xe)===Bt(Ce)})?(re("correct"),ot(xe),We(!0),mt(0),zt(!0,1),qt({correct:!0,direction:F?`${F} -> computed`:"computed",expectedMap:V.reduce((Re,Ce)=>(Re[Ce.key]=Ce.expected,Re),{}),answerMap:He,evalType:"computed"})):(re("incorrect"),ot(xe),We(!1),mt(Re=>{const Ce=Re+1;return Ce>=Ot&&ga&&(_(!0),We(!0)),Ce}),zt(!1,0),window.setTimeout(()=>{var Ce;const Re=In(wt,V,_e);Re&&Le.current[Re]&&((Ce=Le.current[Re])==null||Ce.focus())},40),qt({correct:!1,direction:F?`${F} -> computed`:"computed",expectedMap:V.reduce((Re,Ce)=>(Re[Ce.key]=Ce.expected,Re),{}),answerMap:He,evalType:"computed"}));return}if(ye&&ye.cardType==="info"&&ye.infoType==="citation"&&(Je!=null&&Je.fragmentId)){if(!J)return;const xe=Qt(ye.direction),Ke=(xe==null?void 0:xe.fragmentId)??Je.fragmentId,Re=an(J,he,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Ce=Re.mask,Xe=Re.isCorrect,g=Re.percent;Xe?(Pt.current[Je.fragmentId]=Math.max(Pt.current[Je.fragmentId]??0,g),(Pt.current[Je.fragmentId]??0)>=sa&&Kt.current.add(Je.fragmentId),Bn(),re("correct"),ot({}),We(!0),ct(Ce),mt(0),g<100&&Ot<=1&&_(!0),zt(!0,g/100),qt({correct:!0,direction:`quote:${Je.fragmentId}`,expected:J,answer:he,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Ke})):(re("incorrect"),ot({}),We(!1),ct(Ce),mt(T=>{const K=T+1;return K>=Ot&&ga&&(_(!0),We(!0)),K}),zt(!1,g/100),window.setTimeout(()=>{var T;return(T=nt.current)==null?void 0:T.focus()},40),qt({correct:!1,direction:`quote:${Je.fragmentId}`,expected:J,answer:he,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Ke}));return}if(!J)return;const A=qa(J,he,Na),U=lt==="exact"&&Bt(he)===Bt(J),me=rn(A),De=U||me,qe=ua(A);De?(re("correct"),ot({}),We(!0),ct(A),mt(0),qe<100&&Ot<=1&&_(!0),zt(!0,qe/100),qt({correct:!0,direction:F?`${F} -> ${J}`:null,expected:J,answer:he,evalType:"text"})):(re("incorrect"),ot({}),We(!1),ct(A),mt(xe=>{const Ke=xe+1;return Ke>=Ot&&ga&&(_(!0),We(!0)),Ke}),zt(!1,qe/100),window.setTimeout(()=>{var xe;return(xe=nt.current)==null?void 0:xe.focus()},40),qt({correct:!1,direction:F?`${F} -> ${J}`:null,expected:J,answer:he,evalType:"text"}))},zn=A=>{if(Ka(),!J)return;const U=qa(J,A,Na),me=Bt(A)===Bt(J),De=rn(U),qe=me||De,xe=ua(U);qe?(re("correct"),ot({}),We(!0),ct(U),mt(0),xe<100&&Ot<=1&&_(!0),zt(!0,xe/100),qt({correct:!0,direction:"word->language",expected:J,answer:A,evalType:"language-select"})):(re("incorrect"),ot({}),We(!1),ct(U),mt(Ke=>{const Re=Ke+1;return Re>=Ot&&ga&&(_(!0),We(!0)),Re}),zt(!1,xe/100),qt({correct:!1,direction:"word->language",expected:J,answer:A,evalType:"language-select"}))},qn=A=>{var me;if(A.key!=="Enter")return;if(A.preventDefault(),A.stopPropagation(),pt){Ft();return}const U=V.find(De=>!(He[De.key]??"").trim());if(U){(me=Le.current[U.key])==null||me.focus();return}dn()},_a=()=>{Ka(),re("correct"),We(!0),mt(0),zt(!0,1),J&&qt({correct:!0,direction:"manual",expected:J,answer:he,evalType:"manual"})},ea=()=>{if(zt(!1,0),ye&&ye.cardType==="info"&&ye.infoType==="citation"){re(null),Se(""),_(!1),ot({}),We(!1),ct(null),mt(0),O(A=>Math.min(A+1,f.length));return}Ft()};n.useEffect(()=>{Ka()},[E,f]);const Vn=t.cogita.library.revision.revealModeAfterIncorrect,ga=V.length>0||!!J||(ye==null?void 0:ye.cardType)==="info"&&ye.infoType==="question"&&de!==null;return e.jsxs(At,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:y,language:h,onLanguageChange:b,children:[(d==="loading"||B==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:d==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${Z.total?Math.min(100,Math.max(0,Z.current/Z.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:Z.total?`${Math.min(Z.current,Z.total)} / ${Z.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:m}),e.jsx("p",{className:"cogita-library-subtitle",children:I}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",Ae).replace("{check}",Ye)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:oe?`${oe.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Zt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Zt.currentLevel??"-"," / ",Zt.levelsCount]}):null,oe?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(oe.correct)).replace("{total}",String(oe.total))}),oe.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(oe.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(Lr,{outcomes:G})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[W?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:W})}):null,e.jsx(Ua,{feedbackToken:D?`${D.kind}-${D.tick}`:Ht?"idle":et?`${et}-${E}-${yt}`:"idle",children:d!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:d==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):ye?e.jsx(e.Fragment,{children:ma?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(vs,{copy:t,currentCard:ye,currentTypeLabel:fa,prompt:F,languages:R,answer:he,onAnswerChange:A=>Se(U=>Cn(U,A,S)),computedExpected:V,computedAnswers:He,onComputedAnswerChange:(A,U)=>Pe(me=>({...me,[A]:Cn(me[A]??"",U,S)})),answerTemplate:wt,outputVariables:_e,variableValues:ut,computedFieldFeedback:Oe,feedback:et,canAdvance:pt,quoteContext:Je,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:dn,onSkip:ea,onLanguageSelect:zn,onMarkReviewed:_a,onAdvance:Ft,showCorrectAnswer:ce,setShowCorrectAnswer:_,onRevealCorrect:()=>We(!0),answerMask:dt,expectedAnswer:J,hasExpectedAnswer:ga,handleComputedKeyDown:qn,answerInputRef:nt,computedInputRefs:Le,scriptMode:S,setScriptMode:C,matchPairs:be==null?void 0:be.pairs,matchLeftOrder:be==null?void 0:be.leftOrder,matchRightOrder:be==null?void 0:be.rightOrder,matchSelection:be==null?void 0:be.selection,matchActiveLeft:be==null?void 0:be.activeLeft,matchActiveRight:be==null?void 0:be.activeRight,matchFeedback:we,onMatchLeftSelect:Qa,onMatchRightSelect:_n,questionPrompt:ne,questionAnswers:Ee,questionRevealExpected:ce?$e:void 0,onQuestionTextChange:A=>{Se(A),Be(U=>({...U,text:A}))},onQuestionSelectionToggle:ia,onQuestionBooleanChange:A=>Be(U=>({...U,booleanAnswer:A})),onQuestionOrderingMove:Dn,onQuestionMatchingPick:Pa,onQuestionMatchingRemovePath:A=>Be(U=>({...U,matchingRows:U.matchingRows.filter((me,De)=>De!==A)}))})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:La?`${Aa} / ${La}`:t.cogita.library.revision.progressUnlimited}),d==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),d==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),d==="ready"&&B==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),d==="ready"&&B==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),d==="ready"&&B==="ready"&&f.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Vn}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",Ot]})]})]}),Zt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Zt.activeCount," / ",Zt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Zt.counts.map((A,U)=>{const me=U+1,De=Zt.currentLevel===me,qe=Zt.percentages[U]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":De,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:me}),e.jsx("strong",{children:A})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,qe))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[qe.toFixed(1),"%"]})]},`level-${me}`)})})]}):null,Ca?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:Ca.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:Ca.dots.map(A=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-A.value))}, ${Math.round(200*A.value)}, 80, 0.9)`}},A.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:Ca.knownCount})]})]}):null,Dt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:ln})]})}):null]})]})]})})})]})]})}const cl=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:Qo},Symbol.toStringTag,{value:"Module"})),Ho=t=>Array.from(new Set(t.map(a=>Number(a)).filter(Number.isFinite))).sort((a,s)=>a-s);function Wo(t){const a=[...t];for(let s=a.length-1;s>0;s-=1){const r=Math.floor(Math.random()*(s+1));[a[s],a[r]]=[a[r],a[s]]}return a}function lr(t){const a=t.map((i,u)=>({value:i,oldIndex:u}));for(let i=a.length-1;i>0;i-=1){const u=Math.floor(Math.random()*(i+1));[a[i],a[u]]=[a[u],a[i]]}const s=a.map(i=>i.value),r=new Map;return a.forEach((i,u)=>r.set(i.oldIndex,u)),{values:s,oldToNew:r}}function Go(t){const a=t.split("↔").map(s=>s.trim()).filter(Boolean);return a.length>=2?[a[0],a[1]]:null}function Yo(t){if(!t)return null;const a=t.indexOf(":");return a>=0?t.slice(a+1).trim():t.trim()}function Xo(t,a,s,r){const i=typeof s.title=="string"&&s.title.trim()?s.title.trim():a,u=typeof s.question=="string"?s.question:a,o=s.type;if(!u)return null;if(o==="selection"){const y=Array.isArray(s.options)?s.options.filter(l=>typeof l=="string"):[],h=Array.isArray(s.answer)?Ho(s.answer):[],b=h.length!==1,c=lr(y),p=h.map(l=>c.oldToNew.get(l)).filter(l=>Number.isInteger(l)).sort((l,d)=>l-d);return{roundIndex:r,cardKey:`info:${t}:question-selection`,publicPrompt:{kind:"selection",title:i,prompt:u,options:c.values,multiple:b,cardLabel:"question"},reveal:{kind:"selection",expected:p,title:i},grade:l=>Jt({prompt:{kind:"selection",options:c.values},expected:p,answer:{selection:Array.isArray(l)?l:[]}}).correct}}if(o==="truefalse"){const y=!!s.answer;return{roundIndex:r,cardKey:`info:${t}:question-truefalse`,publicPrompt:{kind:"boolean",title:i,prompt:u,cardLabel:"question"},reveal:{kind:"boolean",expected:y,title:i},grade:h=>Jt({prompt:{kind:"boolean"},expected:y,answer:{booleanAnswer:h==null?null:!!h}}).correct}}if(o==="text"||o==="number"||o==="date"){const y=String(s.answer??"");return{roundIndex:r,cardKey:`info:${t}:question-${o}`,publicPrompt:{kind:"text",title:i,prompt:u,inputType:o==="number"?"number":o==="date"?"date":"text",cardLabel:"question"},reveal:{kind:"text",expected:y,title:i},grade:h=>Jt({prompt:{kind:"text",inputType:o==="number"?"number":o==="date"?"date":"text"},expected:y,answer:{text:String(h??"")}}).correct}}if(o==="ordering"){const y=Array.isArray(s.options)?s.options.filter(b=>typeof b=="string"):[],h=Wo(y);return{roundIndex:r,cardKey:`info:${t}:question-ordering`,publicPrompt:{kind:"ordering",title:i,prompt:u,options:h,cardLabel:"question"},reveal:{kind:"ordering",expected:y,title:i},grade:b=>Jt({prompt:{kind:"ordering",options:y},expected:y,answer:{ordering:Array.isArray(b)?b.map(String):[]}}).correct}}if(o==="matching"){const h=(Array.isArray(s.columns)?s.columns.map(l=>Array.isArray(l)?l.filter(d=>typeof d=="string"):[]):[]).map(l=>lr(l)),b=s.answer??{},p=(Array.isArray(b.paths)?b.paths.map(l=>Array.isArray(l)?l.map(d=>Number(d)).filter(Number.isFinite):null).filter(l=>Array.isArray(l)):[]).map(l=>l.map((d,w)=>{var m;return((m=h[w])==null?void 0:m.oldToNew.get(d))??d}));return{roundIndex:r,cardKey:`info:${t}:question-matching`,publicPrompt:{kind:"matching",title:i,prompt:u,columns:h.map(l=>l.values),cardLabel:"question"},reveal:{kind:"matching",expected:{paths:p},title:i},grade:l=>{const d=l??{},w=Array.isArray(d.paths)?d.paths.map(m=>Array.isArray(m)?m.map(k=>Number(k)).filter(Number.isFinite):null).filter(m=>Array.isArray(m)):[];return Jt({prompt:{kind:"matching",columns:h.map(m=>m.values)},expected:{paths:p},answer:{matchingPaths:w}}).correct}}}return null}async function Zo(t){var p,l;const a=await xs({libraryId:t.libraryId,revisionId:t.revisionId}),r=(await tn({libraryId:t.libraryId,collectionId:a.collectionId,limit:1e3})).items,i=Array.from(new Set(r.filter(d=>d.cardType==="info").map(d=>d.cardId))),u=new Map;await Promise.all(i.map(async d=>{try{const w=await aa({libraryId:t.libraryId,infoId:d});u.set(d,{infoType:w.infoType,payload:w.payload})}catch{}}));const o=new Map;await Promise.all(Array.from(u.entries()).filter(([,d])=>d.infoType==="computed").map(async([d])=>{try{const w=await ls({libraryId:t.libraryId,infoId:d});o.set(d,w)}catch{}}));const y=Array.from(new Set(r.filter(d=>d.cardType==="vocab").map(d=>d.label))).filter(Boolean),h={selectMatchingPairPrompt:((p=t.labels)==null?void 0:p.selectMatchingPairPrompt)??"Select the matching pair",wordLanguagePromptPrefix:((l=t.labels)==null?void 0:l.wordLanguagePromptPrefix)??"Language of"},b=[],c=new Set;for(const d of r){if(d.cardType==="vocab"){const m=Go(d.label);if(!m)continue;if(d.checkType==="translation"&&d.direction==="a-to-b"){const[k,I]=m;b.push({roundIndex:b.length,cardKey:`connection:${d.cardId}:translation:a-to-b`,publicPrompt:{kind:"text",title:d.label,prompt:k,cardLabel:d.description??void 0},reveal:{kind:"text",expected:I,title:d.label},grade:x=>Jt({prompt:{kind:"text",inputType:"text"},expected:I,answer:{text:String(x??"")}}).correct})}else if(d.checkType==="translation"&&d.direction==="b-to-a"){const[k,I]=m;b.push({roundIndex:b.length,cardKey:`connection:${d.cardId}:translation:b-to-a`,publicPrompt:{kind:"text",title:d.label,prompt:I,cardLabel:d.description??void 0},reveal:{kind:"text",expected:k,title:d.label},grade:x=>Jt({prompt:{kind:"text",inputType:"text"},expected:k,answer:{text:String(x??"")}}).correct})}else if(d.checkType==="translation-match"){const k=Array.from(new Set([d.label,...y.filter(x=>x!==d.label).slice(0,3)])),I=k.findIndex(x=>x===d.label);b.push({roundIndex:b.length,cardKey:`connection:${d.cardId}:translation-match`,publicPrompt:{kind:"selection",title:d.label,prompt:h.selectMatchingPairPrompt,options:k,multiple:!1,cardLabel:d.description??void 0},reveal:{kind:"selection",expected:[I],title:d.label},grade:x=>Jt({prompt:{kind:"selection",options:k},expected:[I],answer:{selection:Array.isArray(x)?x.map(f=>Number(f)).filter(Number.isFinite):[Number(x)].filter(Number.isFinite)}}).correct})}continue}if(d.cardType!=="info")continue;const w=u.get(d.cardId);if(w){if(w.infoType==="word"&&d.checkType==="word-language"){const m=Yo(d.description);if(!m)continue;b.push({roundIndex:b.length,cardKey:`info:${d.cardId}:word-language:${d.direction??""}`,publicPrompt:{kind:"text",title:d.label,prompt:`${h.wordLanguagePromptPrefix}: ${d.label}`,cardLabel:"word-language"},reveal:{kind:"text",expected:m,title:d.label},grade:k=>Jt({prompt:{kind:"text",inputType:"text"},expected:m,answer:{text:String(k??"")}}).correct});continue}if(w.infoType==="computed"&&d.checkType==="computed"){const m=o.get(d.cardId);if(!m)continue;b.push({roundIndex:b.length,cardKey:`info:${d.cardId}:computed`,publicPrompt:{kind:"text",title:d.label,prompt:m.prompt,multiLine:!1,cardLabel:"computed"},reveal:{kind:"text",expected:m.expectedAnswer,title:d.label},grade:k=>Jt({prompt:{kind:"text",inputType:"text"},expected:m.expectedAnswer,answer:{text:String(k??"")}}).correct});continue}if(w.infoType==="question"){const m=ws(w.payload),k=m?Xo(d.cardId,d.label,m,b.length):null;k&&(k.roundIndex=b.length,b.push(k));continue}if(w.infoType==="citation"&&!c.has(d.cardId)){c.add(d.cardId);const m=w.payload,k=typeof m.text=="string"?m.text:"",I=typeof m.title=="string"&&m.title.trim()?m.title.trim():d.label;if(!k.trim())continue;const x=ka(k,{minLen:7,maxLen:13});for(const f of x.order){const Q=x.nodes[f];if(!Q)continue;const R=$n(k,Q);b.push({roundIndex:b.length,cardKey:`info:${d.cardId}:quote-fragment:${f}`,publicPrompt:{kind:"citation-fragment",title:I,before:R.before,after:R.after,fragmentId:f,cardLabel:"quote-fragment"},reveal:{kind:"citation-fragment",expected:R.fragment,title:I},grade:j=>Jt({prompt:{kind:"citation-fragment"},expected:R.fragment,answer:{text:String(j??"")}}).correct})}continue}}}return b.map((d,w)=>({...d,roundIndex:w}))}function el(t){var it;const{libraryId:a,revisionId:s}=t,r=Oa(),i=t.copy.cogita.library.revision,u=i.live,[o,y]=n.useState(null),[h,b]=n.useState([]),[c,p]=n.useState("loading"),[l,d]=n.useState(null),[w,m]=n.useState("simultaneous"),[k,I]=n.useState("panel"),[x,f]=n.useState("question"),Q=`cogita.live.host.${a}.${s}`,R=o?h[o.currentRoundIndex]??null:null,j=o!=null&&o.status&&o.status!=="lobby"?o.currentPrompt??null:null,B=(o==null?void 0:o.currentReveal)??null,L=n.useMemo(()=>o!=null&&o.code&&typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision/${encodeURIComponent(o.code)}`:"",[o==null?void 0:o.code]),Z=n.useMemo(()=>o!=null&&o.code&&typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision-screen/${encodeURIComponent(o.code)}`:"",[o==null?void 0:o.code]),q=n.useMemo(()=>{if(!(o!=null&&o.sessionId)||!(o!=null&&o.hostSecret)||typeof window>"u")return"";const V=`${window.location.origin}/#/cogita/live-revision-host/${encodeURIComponent(a)}/${encodeURIComponent(s)}`,ke=new URLSearchParams({sessionId:o.sessionId,hostSecret:o.hostSecret,code:o.code});return`${V}?${ke.toString()}`},[a,s,o==null?void 0:o.code,o==null?void 0:o.hostSecret,o==null?void 0:o.sessionId]),E=(o==null?void 0:o.status)==="finished"||(o==null?void 0:o.status)==="closed"?"finished":o!=null&&o.status&&o.status!=="lobby"?"active":"lobby",O=k==="panel",he=k==="panel"||k==="question",Se=k==="panel"||k==="score",et=(V,ke)=>V.replace(/\{(\w+)\}/g,(He,Pe)=>String(ke[Pe]??"")),re={lobby:u.statusLobby,running:u.statusRunning,revealed:u.statusRevealed,finished:u.statusFinished,closed:"Closed"},F=(V,ke,He)=>({...V,hostSecret:V.hostSecret||(ke==null?void 0:ke.hostSecret)||(He==null?void 0:He.hostSecret)||"",code:V.code||(ke==null?void 0:ke.code)||(He==null?void 0:He.code)||""}),ve=n.useRef(null),J=async()=>{const V=await Rs({libraryId:a,revisionId:s,title:u.hostKicker,sessionMode:w,hostViewMode:k,participantViewMode:x,sessionSettings:{mode:w,hostViewMode:k,participantViewMode:x}});y(V),typeof localStorage<"u"&&localStorage.setItem(Q,JSON.stringify({sessionId:V.sessionId,hostSecret:V.hostSecret,code:V.code}))};n.useEffect(()=>{o!=null&&o.sessionId&&(m(o.sessionMode==="asynchronous"?"asynchronous":"simultaneous"),I(o.hostViewMode==="question"||o.hostViewMode==="score"?o.hostViewMode:"panel"),f(o.participantViewMode==="score"||o.participantViewMode==="fullscreen"?o.participantViewMode:"question"))},[o==null?void 0:o.sessionId]),n.useEffect(()=>{let V=!1;return Zo({libraryId:a,revisionId:s,labels:{selectMatchingPairPrompt:u.selectMatchingPairPrompt,wordLanguagePromptPrefix:u.wordLanguagePromptPrefix}}).then(ke=>{V||b(ke)}).catch(()=>{V||(d(u.loadRoundsError),p("error"))}),()=>{V=!0}},[a,u.selectMatchingPairPrompt,u.wordLanguagePromptPrefix,s]),n.useEffect(()=>{let V=!1;async function ke(){try{const He=new URLSearchParams(r.search),Pe=He.get("sessionId"),Oe=He.get("hostSecret"),ot=He.get("code");if(!!(Pe&&Oe)&&Pe&&Oe){const _e=await As({libraryId:a,sessionId:Pe,hostSecret:Oe});if(V)return;const Ze=F(_e,null,{hostSecret:Oe,code:ot??void 0});y(Ze),typeof localStorage<"u"&&localStorage.setItem(Q,JSON.stringify({sessionId:Ze.sessionId,hostSecret:Ze.hostSecret,code:Ze.code})),p("ready");return}const ft=await Rs({libraryId:a,revisionId:s,title:u.hostKicker,sessionMode:w,hostViewMode:k,participantViewMode:x,sessionSettings:{mode:w,hostViewMode:k,participantViewMode:x}});if(V)return;y(ft),localStorage.setItem(Q,JSON.stringify({sessionId:ft.sessionId,hostSecret:ft.hostSecret,code:ft.code})),p("ready")}catch{if(V)return;d(u.createSessionError),p("error")}}return ke(),()=>{V=!0}},[a,u.hostKicker,r.search,s,Q]),n.useEffect(()=>{if(!o)return;const V=window.setInterval(async()=>{try{const ke=await As({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret});y(He=>F(ke,He))}catch{}},1200);return()=>window.clearInterval(V)},[a,o]),n.useEffect(()=>{if(!o||!R||o.status!=="running"||o.sessionMode!=="simultaneous")return;const V=o.participants.filter(Oe=>Oe.isConnected);if(V.length===0)return;const ke=new Set(o.currentRoundAnswers.filter(Oe=>Oe.roundIndex===o.currentRoundIndex&&(Oe.cardKey??"")===R.cardKey).map(Oe=>Oe.participantId));if(!V.every(Oe=>ke.has(Oe.participantId)))return;const Pe=`${o.sessionId}:${o.currentRoundIndex}:${R.cardKey}:running`;ve.current!==Pe&&(ve.current=Pe,de().catch(()=>{ve.current=null}))},[R,o]);const ue=async V=>{if(!o)return;const ke=Object.prototype.hasOwnProperty.call(V,"currentPrompt"),He=Object.prototype.hasOwnProperty.call(V,"currentReveal"),Pe=await mi({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret,status:V.status??o.status,currentRoundIndex:V.currentRoundIndex??o.currentRoundIndex,revealVersion:V.revealVersion??o.revealVersion,currentPrompt:ke?V.currentPrompt??null:o.currentPrompt??null,currentReveal:He?V.currentReveal??null:o.currentReveal??null});y(Oe=>F(Pe,Oe))},ne=async V=>{const ke=h[V];!ke||!o||await ue({status:"running",currentRoundIndex:V,revealVersion:o.revealVersion+1,currentReveal:null,currentPrompt:{...ke.publicPrompt,roundIndex:V,cardKey:ke.cardKey}})},je=async()=>{h.length&&await ne((o==null?void 0:o.currentRoundIndex)??0)},de=async()=>{if(!o||!R)return;const V=new Map(o.currentRoundAnswers.filter(Pe=>Pe.roundIndex===o.currentRoundIndex&&(Pe.cardKey??"")===R.cardKey).map(Pe=>[Pe.participantId,Pe.answer])),ke=o.participants.map(Pe=>{const Oe=V.get(Pe.participantId),ot=R.grade(Oe);return{participantId:Pe.participantId,isCorrect:ot,pointsAwarded:ot?1:0}}),He=await hi({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret,scores:ke});y(Pe=>F(He,Pe)),await ue({status:"revealed",revealVersion:He.revealVersion+1,currentReveal:R.reveal})},se=async()=>{if(!o)return;const V=o.currentRoundIndex+1;if(V>=h.length){await ue({status:"finished",currentReveal:null});return}await ne(V)},$e=async()=>{if(o){if(o.status==="running"){await de();return}if(o.status==="revealed"){await se();return}o.status==="lobby"&&await je()}},ie=async V=>{if(o!=null&&o.hostSecret)try{const ke=await pi({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret,requestId:V});y(He=>F(ke,He))}catch{}},Ee=async()=>{if(o)try{const V=await vr({libraryId:a,sessionId:o.sessionId});y(V),typeof localStorage<"u"&&localStorage.setItem(Q,JSON.stringify({sessionId:V.sessionId,hostSecret:V.hostSecret,code:V.code}))}catch{}},Be=async()=>{try{p("loading"),await J(),p("ready")}catch{d(u.createSessionError),p("error")}},Je=async()=>{if(o)try{const V=await gi({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret});y(ke=>F(V,ke))}catch{}};return e.jsx(At,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":E,children:[O?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:u.hostKicker}),e.jsx("h2",{className:"cogita-detail-title",children:u.hostTitle}),c==="loading"?e.jsx("p",{children:u.loading}):null,l?e.jsx("p",{className:"cogita-help",children:l}):null,o?e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Session mode"}),e.jsxs("select",{value:w,onChange:V=>m(V.target.value),children:[e.jsx("option",{value:"simultaneous",children:"Simultaneous"}),e.jsx("option",{value:"asynchronous",children:"Asynchronous"})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Host view"}),e.jsxs("select",{value:k,onChange:V=>I(V.target.value),children:[e.jsx("option",{value:"panel",children:"Panel"}),e.jsx("option",{value:"question",children:"Question"}),e.jsx("option",{value:"score",children:"Score"})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Participant view"}),e.jsxs("select",{value:x,onChange:V=>f(V.target.value),children:[e.jsx("option",{value:"question",children:"Question"}),e.jsx("option",{value:"score",children:"Score"}),e.jsx("option",{value:"fullscreen",children:"Fullscreen"})]})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:u.joinCodeLabel}),e.jsx("input",{readOnly:!0,value:o.code})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:u.joinUrlLabel}),e.jsx("input",{readOnly:!0,value:L})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Host URL"}),e.jsx("input",{readOnly:!0,value:q})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Presenter URL"}),e.jsx("input",{readOnly:!0,value:Z})]}),L?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:u.qrLabel}),e.jsx("div",{style:{display:"inline-flex",padding:"0.75rem",borderRadius:"12px",background:"#fff"},children:e.jsx(dr,{value:L,size:176,marginSize:2})})]}):null,e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:u.statusLabel}),e.jsx("input",{readOnly:!0,value:re[o.status]??o.status})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:je,disabled:!h.length,children:u.publishCurrentRound}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Be,children:"New session"}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Ee,children:"Refresh links"}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Je,disabled:o.status==="closed",children:"Close session"})]}),e.jsx("p",{className:"cogita-help",children:et(u.roundsLabel,{count:h.length})})]}):null]}):null,he?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:u.currentRoundTitle}),e.jsx("h3",{className:"cogita-detail-title",children:j&&typeof j.title=="string"?j.title:(o==null?void 0:o.status)==="lobby"?u.sessionNotStarted:u.waitingForPublishedRound}),(o==null?void 0:o.status)==="lobby"?e.jsx("p",{className:"cogita-help",children:u.hiddenBeforeStart}):e.jsx(Ua,{className:"cogita-live-card-container",feedbackToken:B?`correct-${(o==null?void 0:o.revealVersion)??0}`:"idle",children:e.jsx(Pn,{prompt:j,revealExpected:B==null?void 0:B.expected,mode:"readonly",labels:{answerLabel:i.answerLabel,correctAnswerLabel:i.correctAnswerLabel,trueLabel:u.trueLabel,falseLabel:u.falseLabel,fragmentLabel:u.fragmentLabel,correctFragmentLabel:u.correctFragmentLabel,participantAnswerPlaceholder:u.participantAnswerPlaceholder,unsupportedPromptType:u.unsupportedPromptType,waitingForReveal:"Waiting for reveal.",selectedPaths:"Selected paths",removePath:"Remove",columnPrefix:"Column"}})}),E!=="lobby"?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:$e,disabled:!h.length||!R||o.status==="finished"||o.status==="closed",children:o.status==="revealed"?i.nextQuestion:i.checkAnswer})}):null,E!=="finished"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:u.participantsTitle}),e.jsxs("div",{className:"cogita-share-list",children:[o==null?void 0:o.participants.map(V=>{const ke=o.currentRoundAnswers.find(He=>He.participantId===V.participantId);return e.jsx("div",{className:"cogita-share-row",children:e.jsxs("div",{children:[e.jsx("strong",{children:V.displayName}),e.jsxs("div",{className:"cogita-share-meta",children:[ke?u.answerStatusAnswered:u.answerStatusWaiting,(ke==null?void 0:ke.isCorrect)===!0?` · ${u.answerStatusCorrect}`:"",(ke==null?void 0:ke.isCorrect)===!1?` · ${u.answerStatusIncorrect}`:""]})]})},V.participantId)}),o&&o.participants.length===0?e.jsx("p",{className:"cogita-help",children:u.noParticipants}):null]}),o&&(((it=o.pendingReloginRequests)==null?void 0:it.length)??0)>0?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Relogin requests"}),e.jsx("div",{className:"cogita-share-list",children:(o.pendingReloginRequests??[]).map(V=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsxs("div",{children:[e.jsx("strong",{children:V.displayName}),e.jsx("div",{className:"cogita-share-meta",children:new Date(V.requestedUtc).toLocaleTimeString()})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>ie(V.requestId),children:"Allow relogin"})]},V.requestId))})]}):null]}):null]}):null,E!=="lobby"&&Se?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:E==="finished"?u.finalScoreTitle:u.pointsTitle}),e.jsx("div",{className:"cogita-share-list",children:((o==null?void 0:o.scoreboard)??[]).map(V=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:V.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[V.score," ",u.scoreUnit]})]},`score:${V.participantId}`))})]}):null]})})})})})}const dl=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionHostPage:el},Symbol.toStringTag,{value:"Module"}));function cr(t){return`cogita.live.join.${t}`}function tl(t){const{code:a}=t,s=t.copy.cogita.library.revision,r=s.live,[i,u]=n.useState(""),[o,y]=n.useState(()=>typeof localStorage>"u"?null:localStorage.getItem(cr(a))),[h,b]=n.useState(null),[c,p]=n.useState("idle"),[l,d]=n.useState(""),[w,m]=n.useState([]),[k,I]=n.useState(null),[x,f]=n.useState([]),[Q,R]=n.useState([]),[j,B]=n.useState([]),[L,Z]=n.useState(null),[q,E]=n.useState(!1),O=(h==null?void 0:h.currentPrompt)??null,he=(h==null?void 0:h.currentReveal)??null,Se=he==null?void 0:he.expected,et=(h==null?void 0:h.status)==="finished"||(h==null?void 0:h.status)==="closed"?"finished":h!=null&&h.status&&h.status!=="lobby"?"active":"lobby",re=(h==null?void 0:h.participantViewMode)??"question",F=re!=="fullscreen"||et==="lobby"||!o,ve=re!=="score",J=re!=="question"||et==="finished",ue=n.useMemo(()=>`${(h==null?void 0:h.currentRoundIndex)??0}:${(h==null?void 0:h.revealVersion)??0}:${String((O==null?void 0:O.cardKey)??"")}`,[O==null?void 0:O.cardKey,h==null?void 0:h.currentRoundIndex,h==null?void 0:h.revealVersion]);n.useEffect(()=>{d(""),m([]),I(null),f(Array.isArray(O==null?void 0:O.options)?[...O.options??[]]:[]);const ie=Array.isArray(O==null?void 0:O.columns)?Math.max(2,O.columns.length):0;R([]),B(ie>0?new Array(ie).fill(null):[])},[ue]),n.useEffect(()=>{let ie=!0;const Ee=async()=>{try{const Je=await cs({code:a,participantToken:o});if(!ie)return;b(Je),o&&p("ready")}catch{ie&&c!=="joining"&&p("error")}};Ee();const Be=window.setInterval(Ee,1200);return()=>{ie=!1,window.clearInterval(Be)}},[a,o,c]),n.useEffect(()=>{if(!L||!q||o)return;let ie=!1;const Ee=window.setInterval(async()=>{try{const Be=await fi({code:a,requestId:L});if(ie)return;Be.status==="approved"&&(E(!1),p("idle"))}catch{}},1200);return()=>{ie=!0,window.clearInterval(Ee)}},[a,o,q,L]);const ne=async()=>{p("joining");try{const ie=await bi({code:a,name:i});y(ie.participantToken),localStorage.setItem(cr(a),ie.participantToken),E(!1),Z(null),p("ready")}catch(ie){if(ie instanceof ys&&ie.status===409)try{const Ee=await yi({code:a,name:i});Z(Ee.requestId),E(!0),p("ready");return}catch{p("error");return}p("error")}},je=ie=>{if(!!(O!=null&&O.multiple)){m(Be=>Be.includes(ie)?Be.filter(Je=>Je!==ie):[...Be,ie].sort((Je,it)=>Je-it));return}m([ie])},de=(ie,Ee)=>{f(Be=>{const Je=[...Be],it=ie+Ee;return it<0||it>=Je.length?Be:([Je[ie],Je[it]]=[Je[it],Je[ie]],Je)})},se=(ie,Ee)=>{const Be=Array.isArray(O==null?void 0:O.columns)?O.columns:[],Je=Math.max(2,Be.length);B(it=>{const V=Array.from({length:Je},(He,Pe)=>it[Pe]??null);if(V[ie]=V[ie]===Ee?null:Ee,V.some(He=>He==null))return V;const ke=V.map(He=>Number(He));return R(He=>[...He,ke]),new Array(Je).fill(null)})},$e=async()=>{if(!o||!O||typeof O.cardKey!="string")return;let ie=null;switch(O.kind){case"selection":ie=w;break;case"boolean":ie=k;break;case"ordering":ie=x;break;case"matching":ie={paths:Q};break;case"citation-fragment":case"text":default:ie=l;break}try{await xi({code:a,participantToken:o,roundIndex:Number(O.roundIndex??(h==null?void 0:h.currentRoundIndex)??0),cardKey:O.cardKey,answer:ie});const Ee=await cs({code:a,participantToken:o});b(Ee),p("ready")}catch{p("error")}};return e.jsx(At,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":et,"data-participant-view":re,children:[F?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:r.joinKicker}),e.jsx("h2",{className:"cogita-detail-title",children:r.joinTitle}),o?e.jsx("p",{className:"cogita-help",children:r.joinedWaiting}):e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:r.participantNameLabel}),e.jsx("input",{value:i,onChange:ie=>u(ie.target.value)})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:ne,disabled:!i.trim()||c==="joining",children:c==="joining"?r.joiningAction:r.joinAction})})]}),q?e.jsx("p",{className:"cogita-help",children:"Relogin request sent. Wait for host approval and join again."}):null,c==="error"?e.jsx("p",{className:"cogita-help",children:r.connectionError}):null,et==="lobby"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:r.scoreboardTitle}),e.jsxs("div",{className:"cogita-share-list",children:[h==null?void 0:h.scoreboard.map(ie=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:ie.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[ie.score," ",r.scoreUnit]})]},ie.participantId)),h&&h.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:r.noParticipants}):null]})]}):null]}):null,ve?e.jsxs("div",{className:`cogita-library-panel ${re==="fullscreen"?"cogita-live-fullscreen-panel":""}`,children:[e.jsx("p",{className:"cogita-user-kicker",children:r.questionTitle}),e.jsx("h3",{className:"cogita-detail-title",children:typeof(O==null?void 0:O.title)=="string"?O.title:r.waitingForPublishedRound}),O?e.jsxs(e.Fragment,{children:[e.jsx(Ua,{className:"cogita-live-card-container",feedbackToken:he?`correct-${(h==null?void 0:h.revealVersion)??0}`:"idle",children:e.jsx(Pn,{prompt:O,revealExpected:Se,mode:"interactive",labels:{answerLabel:s.answerLabel,correctAnswerLabel:s.correctAnswerLabel,trueLabel:r.trueLabel,falseLabel:r.falseLabel,fragmentLabel:r.fragmentLabel,correctFragmentLabel:r.correctFragmentLabel,participantAnswerPlaceholder:r.participantAnswerPlaceholder,unsupportedPromptType:r.unsupportedPromptType,waitingForReveal:"Waiting for reveal.",selectedPaths:"Selected paths",removePath:"Remove",columnPrefix:"Column"},answers:{text:l,selection:w,booleanAnswer:k,ordering:x,matchingRows:Q,matchingSelection:j},onTextChange:d,onSelectionToggle:je,onBooleanChange:I,onOrderingMove:de,onMatchingPick:se,onMatchingRemovePath:ie=>R(Ee=>Ee.filter((Be,Je)=>Je!==ie))})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:$e,disabled:!o||!O.cardKey||(h==null?void 0:h.answerSubmitted),children:h!=null&&h.answerSubmitted?r.submitted:r.submitAnswer})})]}):e.jsx("p",{className:"cogita-help",children:r.waitingForHostQuestion})]}):null,et!=="lobby"&&J?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:et==="finished"?r.finalScoreTitle:r.pointsTitle}),e.jsxs("div",{className:"cogita-share-list",children:[h==null?void 0:h.scoreboard.map(ie=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:ie.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[ie.score," ",r.scoreUnit]})]},`score:${ie.participantId}`)),h&&h.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:r.noParticipants}):null]})]}):null]})})})})})}const ul=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionJoinPage:tl},Symbol.toStringTag,{value:"Module"}));function al(t){const{code:a}=t,s=t.copy.cogita.library.revision.live,[r,i]=n.useState(null),[u,o]=n.useState("loading"),y=(r==null?void 0:r.currentPrompt)??null,h=(r==null?void 0:r.currentReveal)??null,b=h==null?void 0:h.expected,c=(r==null?void 0:r.participantViewMode)??"question",p=(r==null?void 0:r.status)==="finished"||(r==null?void 0:r.status)==="closed"?"finished":r!=null&&r.status&&r.status!=="lobby"?"active":"lobby",l=c!=="score",d=c!=="question"||p==="finished",w=n.useMemo(()=>typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision/${encodeURIComponent(a)}`:"",[a]);return n.useEffect(()=>{let m=!0;const k=async()=>{try{const x=await cs({code:a});if(!m)return;i(x),o("ready")}catch{if(!m)return;o("error")}};k();const I=window.setInterval(k,1200);return()=>{m=!1,window.clearInterval(I)}},[a]),e.jsx(At,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":p,"data-participant-view":c,children:[l?e.jsxs("div",{className:`cogita-library-panel ${c==="fullscreen"?"cogita-live-fullscreen-panel":""}`,children:[e.jsx("p",{className:"cogita-user-kicker",children:s.hostKicker}),e.jsx("h2",{className:"cogita-detail-title",children:u==="error"?s.connectionError:s.statusLobby}),(r==null?void 0:r.status)==="lobby"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:s.joinCodeLabel}),e.jsx("input",{readOnly:!0,value:a})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:s.joinUrlLabel}),e.jsx("input",{readOnly:!0,value:w})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:s.qrLabel}),e.jsx("div",{style:{display:"inline-flex",padding:"0.75rem",borderRadius:"12px",background:"#fff"},children:e.jsx(dr,{value:w,size:176,marginSize:2})})]})]}):e.jsx(Ua,{className:"cogita-live-card-container",feedbackToken:h?`correct-${(r==null?void 0:r.revealVersion)??0}`:"idle",children:e.jsx(Pn,{prompt:y,revealExpected:b,mode:"readonly",labels:{answerLabel:t.copy.cogita.library.revision.answerLabel,correctAnswerLabel:t.copy.cogita.library.revision.correctAnswerLabel,trueLabel:s.trueLabel,falseLabel:s.falseLabel,fragmentLabel:s.fragmentLabel,correctFragmentLabel:s.correctFragmentLabel,participantAnswerPlaceholder:s.participantAnswerPlaceholder,unsupportedPromptType:s.unsupportedPromptType,waitingForReveal:"Waiting for reveal.",selectedPaths:"Selected paths",removePath:"Remove",columnPrefix:"Column"}})})]}):null,d?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:(r==null?void 0:r.status)==="finished"?s.finalScoreTitle:s.pointsTitle}),e.jsxs("div",{className:"cogita-share-list",children:[((r==null?void 0:r.scoreboard)??[]).map(m=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:m.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[m.score," ",s.scoreUnit]})]},`presenter-score:${m.participantId}`)),r&&r.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:s.noParticipants}):null]})]}):null]})})})})})}const hl=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionPresenterPage:al},Symbol.toStringTag,{value:"Module"}));function nl(t){const a=nn(),s=t.copy.cogita.library.revision.live,{libraryId:r}=t,[i,u]=n.useState([]),[o,y]=n.useState([]),[h,b]=n.useState("loading"),[c,p]=n.useState(null),[l,d]=n.useState({}),w=n.useMemo(()=>({lobby:s.statusLobby,running:s.statusRunning,revealed:s.statusRevealed,finished:s.statusFinished,closed:"Closed"}),[s.statusFinished,s.statusLobby,s.statusRevealed,s.statusRunning]),m=async()=>{b("loading");try{const[I,x]=await Promise.all([vi({libraryId:r}),wi({libraryId:r})]);u(I),y(x),b("ready")}catch{u([]),y([]),b("error")}};n.useEffect(()=>{m()},[r]);const k=async(I,x)=>{p(I.sessionId);try{const f=l[I.sessionId]??await vr({libraryId:r,sessionId:I.sessionId});l[I.sessionId]||d(j=>({...j,[I.sessionId]:{sessionId:f.sessionId,code:f.code,hostSecret:f.hostSecret}}));const Q=encodeURIComponent(f.code);if(x==="host"){a(`/cogita/live-revision-host/${encodeURIComponent(r)}/${encodeURIComponent(I.revisionId)}?sessionId=${encodeURIComponent(f.sessionId)}&hostSecret=${encodeURIComponent(f.hostSecret)}&code=${Q}`);return}const R=x==="presenter"?`${window.location.origin}/#/cogita/public/live-revision-screen/${Q}`:`${window.location.origin}/#/cogita/public/live-revision/${Q}`;window.open(R,"_blank","noopener")}finally{p(null)}};return e.jsx(At,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("div",{className:"cogita-detail-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:s.hostKicker}),e.jsx("h2",{className:"cogita-detail-title",children:"Active live sessions"})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:m,children:"Refresh"})})]}),h==="loading"?e.jsx("p",{children:s.loading}):null,h==="error"?e.jsx("p",{className:"cogita-help",children:s.connectionError}):null,h==="ready"&&i.length===0?e.jsx("p",{className:"cogita-help",children:"No active sessions."}):null,e.jsx("div",{className:"cogita-share-list",children:i.map(I=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsxs("div",{children:[e.jsx("strong",{children:I.title||I.sessionId}),e.jsxs("div",{className:"cogita-share-meta",children:[w[I.status]??I.status," · ",s.participantsTitle,": ",I.participantCount]})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>k(I,"host"),disabled:c===I.sessionId,children:"Host"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>k(I,"presenter"),disabled:c===I.sessionId,children:"Screen"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>k(I,"login"),disabled:c===I.sessionId,children:"Login panel"})]})]},I.sessionId))}),e.jsx("div",{className:"cogita-detail-header",style:{marginTop:"1rem"},children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Participant sessions"}),e.jsx("h3",{className:"cogita-detail-title",children:"Sessions where you participate"})]})}),h==="ready"&&o.length===0?e.jsx("p",{className:"cogita-help",children:"No participant sessions."}):null,e.jsx("div",{className:"cogita-share-list",children:o.map(I=>e.jsx("div",{className:"cogita-share-row",children:e.jsxs("div",{children:[e.jsx("strong",{children:I.title||I.sessionId}),e.jsxs("div",{className:"cogita-share-meta",children:[w[I.status]??I.status," · ",s.participantsTitle,": ",I.participantCount]}),e.jsxs("div",{className:"cogita-share-meta",children:["Score: ",I.participantScore," · ",I.isConnected?"Connected":"Disconnected"]})]})},`participating:${I.sessionId}`))})]})})})})})}const ml=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveSessionsPage:nl},Symbol.toStringTag,{value:"Module"}));export{ol as C,ll as a,cl as b,dl as c,ul as d,hl as e,ml as f};
