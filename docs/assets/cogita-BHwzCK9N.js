import{r as a,j as e,u as An,a as Fa,b as En,c as Pn,d as Kn,R as sn,B as rn,C as on}from"./vendor-CL5v9b84.js";import{L as Ss,A as Ts,g as Cs,a as Ys,b as Ua,c as Is,s as Wn,d as Fn,e as Qs,f as fn,h as da,i as Xs,j as Zs,k as qa,l as Ja,m as Ms,n as Dn,o as Rn,p as ei,u as Gn,q as Ls,r as ti,t as ai,v as ni,w as si,x as ii,y as Rs,z as ri,B as $s,C as As,D as oi,E as li,F as ln,G as Ha,H as ci,I as Es,J as di,K as ui,M as Ps,N as hi,O as gi,P as mi,Q as Yn,R as fa,S as pi,T as fi,U as bi,V as yi,W as xi,X as vi,Y as wi,Z as ji,_ as ki,$ as Ni,a0 as Si,a1 as Ti,a2 as Ci,a3 as Qn}from"./recreatio-core-ULPb4Sxr.js";import"./vendor-cogita-ui-mbCyoqV0.js";const Aa={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},$a={moveMs:900,pauseMs:220,errorMs:900},Ii=(t=11)=>{let n=t;const s=()=>(n=(n*1664525+1013904223)%4294967296,n/4294967296),{width:i,height:r,paddingX:u,paddingY:m,levels:k}=Aa,j=(r-m*2)/(k.length-1),M=[],o=[],x=[];k.forEach((f,g)=>{const le=r-m-g*j,P=i-u*2,p=[];for(let V=0;V<f;V+=1){const N=u+(V+1)*P/(f+1),W=(s()-.5)*18,R=Math.max(u,Math.min(i-u,N+W)),I=g===0?3:g<2?2.1:1.4,re=g===0?"root":`l${g}-${V}`;p.push({id:re,x:g===0?i/2:R,y:le,r:I,level:g,role:g===0?"root":void 0})}x.push(p),M.push(...p)});const l=x[x.length-1];if(l!=null&&l.length){const f=l[Math.floor(l.length/2)];f.role="goal",f.r=2}for(let f=1;f<x.length;f+=1){const g=x[f-1];x[f].forEach(P=>{const p=[...g].sort((R,I)=>Math.abs(R.x-P.x)-Math.abs(I.x-P.x)),V=p[0],N=p[1]&&s()<.45?p[1]:null;(N?[V,N]:[V]).forEach(R=>{o.push({from:R.id,to:P.id,key:`${R.id}-${P.id}`})}),s()<.2&&p[2]&&o.push({from:p[2].id,to:P.id,key:`${p[2].id}-${P.id}`})})}const d=new Map;o.forEach(f=>{const g=d.get(f.to)??[];g.push(f.from),d.set(f.to,g)});const v=new Map,w=new Map,S=new Map;o.forEach(f=>{const g=v.get(f.from)??[];g.push(f.key),v.set(f.from,g);const le=w.get(f.from)??[];le.push(f.to),w.set(f.from,le);const P=S.get(f.from)??[];P.push(f.to),S.set(f.from,P);const p=S.get(f.to)??[];p.push(f.from),S.set(f.to,p)});const D=new Map;return M.forEach(f=>{D.set(f.id,f)}),{nodes:M,links:o,parentsById:d,linksByFrom:v,childrenByFrom:w,neighborsById:S,nodesById:D}};function Mi({slides:t,activeIndex:n,introOpen:s,prefersReducedMotion:i,onNext:r,onPrev:u,onSelect:m,onExit:k,onOpen:j,onRegister:M}){const o=n===t.length-1,x=s&&n===0?"entry":"docked",l=t[t.length-1],[d,v]=a.useState(!1),w=a.useMemo(()=>Array.from({length:20},(A,Y)=>({src:`/cogita/logo/Cogita${String(Y).padStart(2,"0")}.png`,kind:Y<=11?"bubble":Y<=17?"text":"recreatio"})),[]),S=s&&n===0;a.useEffect(()=>{if(!s){v(!1);return}n>0&&!d&&v(!0)},[n,s,d]);const D=a.useRef(0),f=a.useRef(null),g=a.useMemo(()=>{const A={x:40,y:160},Y={x:260,y:48},se=6,T=Y.x-A.x,U=A.y-Y.y,K=T/se,H=[.3,.45,.6,.65,1.4,2.2],ie=H.reduce((be,ue)=>be+ue,0),ke=H.map(be=>U*be/ie),Ae=[A];let De=A.x,ve=A.y;for(let be=1;be<=se;be+=1){const ue=(Math.random()-.5)*14,Xe=(Math.random()-.5)*28;De=Math.max(A.x+be*14,Math.min(Y.x-(se-be)*14,De+K+ue));const Qe=ke[be-1]??ke[ke.length-1];ve=ve-Qe+Xe;const Ye=Math.max(Y.y,Math.min(A.y-4,ve));Ae.push({x:Math.round(De),y:Math.round(Ye)})}return Ae[Ae.length-1]=Y,Ae},[]),le=a.useMemo(()=>{const U=(ie,ke,Ae)=>Math.min(Ae,Math.max(ke,ie)),K=g.map(ie=>{const ke=10+Math.random()*36;return{x:U(ie.x,40,260),y:U(ie.y-ke,40,140)}}),H=g.map((ie,ke)=>{var ve;const Ae=12+Math.random()*40,De=((ve=K[ke])==null?void 0:ve.y)??ie.y;return{x:U(ie.x,40,260),y:U(Math.max(De+10,ie.y+Ae),60,170)}});return{upper:K,lower:H}},[g]),P=a.useMemo(()=>{var Y;const A=((Y=g[4])==null?void 0:Y.x)??260;return Math.max(0,Math.min(240,A-40))},[g]),p=a.useMemo(()=>{var ke,Ae;const A=(De,ve,be)=>Math.min(be,Math.max(ve,De)),Y=(De,ve,be)=>g.map((ue,Xe)=>{var jt,yt;const Qe=((jt=le.upper[Xe])==null?void 0:jt.y)??ue.y,Ye=((yt=le.lower[Xe])==null?void 0:yt.y)??ue.y,et=(Math.random()-.5)*70,nt=ue.y+De+et,qe=A(ue.y+ve,Qe+6,Ye-6),ut=A(ue.y+be,Qe+6,Ye-6);return{x:ue.x,y:A(nt,Math.min(qe,ut),Math.max(qe,ut))}}),se=-14+Math.random()*28,T=14+Math.random()*28,U=Y(se,-80,12),K=Y(T,-12,80);for(let De=4;De<g.length;De+=1){const ve=g[De],be=((ke=le.upper[De])==null?void 0:ke.y)??ve.y,ue=((Ae=le.lower[De])==null?void 0:Ae.y)??ve.y;U[De]={x:ve.x,y:A(ve.y-12,be+6,ue-6)},K[De]={x:ve.x,y:A(ve.y+12,be+6,ue-6)}}const H=le.upper.length?le.upper[le.upper.length-1].y:40,ie=le.lower.length?le.lower[le.lower.length-1].y:170;return U[U.length-1]={x:g[g.length-1].x,y:A(g[g.length-1].y-14,H,ie)},K[K.length-1]={x:g[g.length-1].x,y:A(g[g.length-1].y+12,H,ie)},{higher:U,lower:K}},[g,le]),V=1e4,N=a.useMemo(()=>{let A=17;const Y=()=>(A=(A*1664525+1013904223)%4294967296,A/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((T,U)=>{const K=(Y()-.5)*240,H=(Y()-.5)*180,ie=(Y()-.5)*24;return{id:`card-${U+1}`,throw:{x:`${K.toFixed(0)}px`,y:`${H.toFixed(0)}px`,rot:`${ie.toFixed(1)}deg`},grid:{x:`${T.x}px`,y:`${T.y}px`},delay:`${U*.12}s`}})},[]),W=a.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[R,I]=a.useState([]),re=a.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),ce=a.useMemo(()=>{const Y=[],T=(K,H)=>K+Math.random()*(H-K);for(let K=0;K<6;K+=1){let H=!1;for(let ie=0;ie<80;ie+=1){const ke=T(14,86),Ae=T(10,34);if(Y.every(ve=>{const be=ve.x-ke,ue=ve.y-Ae;return Math.hypot(be,ue)>=12})){Y.push({x:ke,y:Ae}),H=!0;break}}H||Y.push({x:T(16,84),y:T(12,32)})}return Y.map((K,H)=>({id:`p${H+1}`,x:`${K.x.toFixed(1)}%`,y:`${K.y.toFixed(1)}%`,xNum:K.x,yNum:K.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[xe,Te]=a.useState(0),[Z,C]=a.useState(0),[Ie,B]=a.useState([]),ee=1e4,q=a.useMemo(()=>{if(ce.length<2)return[];const A=H=>{let ie=H+1831565813;return ie=Math.imul(ie^ie>>>15,ie|1),ie^=ie+Math.imul(ie^ie>>>7,ie|61),((ie^ie>>>14)>>>0)/4294967296},Y=(H,ie)=>Math.floor(A(H)*ie),se=new Set,T=[],U=Math.min(3,ce.length);let K=0;for(;T.length<U&&K<30;){K+=1;const H=Y(xe*13+K*5,ce.length),ie=Y(xe*29+K*7,ce.length);if(H===ie)continue;const ke=H<ie?`${H}-${ie}`:`${ie}-${H}`;se.has(ke)||(se.add(ke),T.push({id:`link-${ke}`,from:ce[H],to:ce[ie],delay:`${(K*.35).toFixed(2)}s`}))}return T},[xe,ce]);a.useEffect(()=>{if(!s||n!==2)return;const A=()=>{const se=N.map(T=>T.id);for(let T=se.length-1;T>0;T-=1){const U=Math.floor(Math.random()*(T+1));[se[T],se[U]]=[se[U],se[T]]}return se.slice(0,4)};I(A());const Y=window.setInterval(()=>{I(A())},V);return()=>window.clearInterval(Y)},[n,s,N,V]),a.useEffect(()=>{if(!s||n!==3)return;const A=()=>{C(Math.floor(Math.random()*re.length)),B(ce.map(()=>Math.random()<.6?"good":"bad")),Te(se=>se+1)};A();const Y=window.setInterval(A,ee);return()=>window.clearInterval(Y)},[n,s,re.length,ce,ee]);const fe=a.useMemo(()=>Ii(11),[]),[X,de]=a.useState(new Set(["root"])),[ye,Pe]=a.useState(new Set),[Ve,Ce]=a.useState(new Set),[He,Ze]=a.useState({fromId:"root",toId:"root",key:0}),Me=a.useRef(X),We=a.useRef("root"),rt=a.useRef(0),ot=a.useRef(null),_e=a.useRef(null),je=a.useRef([]);a.useEffect(()=>{Me.current=X},[X]);const J=a.useMemo(()=>{const A=new Set;return X.forEach(Y=>{const se=fe.linksByFrom.get(Y);se&&se.forEach(T=>A.add(T))}),A},[X,fe]),Le=fe.nodesById.get(He.toId)??fe.nodesById.get("root"),oe=Le?`${Le.x/Aa.width*100}%`:"50%",_=Le?`${Le.y/Aa.height*100}%`:"90%";a.useEffect(()=>{if(!s||n!==1||i)return;(()=>{de(new Set(["root"])),Pe(new Set),Ce(new Set),Ze({fromId:"root",toId:"root",key:0}),_e.current=null,rt.current=0,We.current="root",je.current=[]})();const Y=()=>{const T=We.current,U=Me.current,H=(fe.childrenByFrom.get(T)??[]).filter(ue=>!U.has(ue));if(H.length)return H[Math.floor(Math.random()*H.length)];if(U.size>=fe.nodes.length){const ue=fe.neighborsById.get(T)??[];return ue.length?ue[Math.floor(Math.random()*ue.length)]:null}const ie=ue=>(fe.childrenByFrom.get(ue)??[]).some(Qe=>!U.has(Qe)),ke=[T],Ae=new Set([T]),De=new Map;let ve=null;for(;ke.length;){const ue=ke.shift();if(!ue)break;if(ue!==T&&ie(ue)){ve=ue;break}(fe.neighborsById.get(ue)??[]).forEach(Qe=>{Ae.has(Qe)||(Ae.add(Qe),De.set(Qe,ue),ke.push(Qe))})}if(!ve)return null;let be=ve;for(;De.get(be)&&De.get(be)!==T;)be=De.get(be)??be;return be},se=(T,U)=>{if(T===U){const K=Y();K&&se(T,K);return}rt.current+=1,Ze({fromId:T,toId:U,key:rt.current}),We.current=U,ot.current=window.setTimeout(()=>{const K=fe.parentsById.get(U)??[],H=Me.current,ie=K.filter(ve=>!H.has(ve));if(!ie.length){const ve=new Set(H);ve.add(U),de(ve),ot.current=window.setTimeout(()=>{for(;je.current.length;){const ue=je.current[je.current.length-1];if(!ve.has(ue)){if(ue!==U){se(U,ue);return}break}je.current.pop()}const be=Y();be&&se(U,be)},$a.pauseMs);return}const ke=new Set([U,...ie]),Ae=new Set(ie.map(ve=>`${ve}-${U}`));Pe(ke),Ce(Ae),je.current.includes(U)||je.current.push(U);const De=ie[Math.floor(Math.random()*ie.length)];_e.current={fromId:U,toId:De},ot.current=window.setTimeout(()=>{Pe(new Set),Ce(new Set);const ve=_e.current;ve&&se(ve.fromId,ve.toId)},$a.errorMs)},$a.moveMs)};return ot.current=window.setTimeout(()=>{const T=Y();T&&se(We.current,T)},$a.pauseMs),()=>{ot.current&&window.clearTimeout(ot.current)}},[n,s,fe,i]);const me=A=>{if(!s)return;const Y=Date.now();Y-D.current<520||Math.abs(A.deltaY)<10||(D.current=Y,A.deltaY>0?r():u(),A.preventDefault())},Ge=A=>{if(!s)return;const Y=A.touches[0];Y&&(f.current={x:Y.clientX,y:Y.clientY})},$=A=>{if(!s)return;const Y=f.current;if(f.current=null,!Y)return;const se=A.changedTouches[0];if(!se)return;const T=se.clientX-Y.x,U=se.clientY-Y.y;Math.abs(U)<40||Math.abs(U)<Math.abs(T)||(U<0?r():u())};return e.jsxs("div",{className:`cogita-intro ${s?"is-open":"is-closed"} ${i?"is-reduced":""} ${o?"is-final":""}`,"data-slide":n+1,onWheel:me,onTouchStart:Ge,onTouchEnd:$,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":x,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${S&&!d?"is-entry":""}`,children:w.map((A,Y)=>e.jsx("img",{src:A.src,alt:"",className:`cogita-logo-layer ${Y===0?"is-base":""} ${A.kind==="text"?"is-text":A.kind==="recreatio"?"is-recreatio":""} ${A.kind==="bubble"?"is-bubble":""}`},A.src))})}),s&&t.map((A,Y)=>{const se=Y===n;return e.jsxs("section",{className:`cogita-intro-slide slide-${Y+1} ${se?"is-active":""}`,"aria-hidden":!se,children:[e.jsxs("div",{className:"cogita-intro-text",children:[A.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:A.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:A.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:A.title}),A.body&&e.jsx("p",{children:A.body.split(`
`).map((T,U)=>e.jsxs("span",{children:[T,U===0&&e.jsx("br",{})]},String(U)))})]}),A.micro&&e.jsx("p",{className:"cogita-intro-micro",children:A.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:o?M:r,children:A.cta}),o&&A.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>m(0),children:A.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[Y===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${Aa.width} ${Aa.height}`,preserveAspectRatio:"none",children:[fe.links.map(T=>{const U=fe.nodesById.get(T.from),K=fe.nodesById.get(T.to);if(!U||!K)return null;const H=J.has(T.key),ie=Ve.has(T.key);return e.jsx("line",{className:`map-link ${H?"is-active":""} ${ie?"is-error":""}`,x1:U.x,y1:U.y,x2:K.x,y2:K.y},T.key)}),fe.nodes.map(T=>{const U=X.has(T.id),K=ye.has(T.id);return e.jsx("circle",{className:`map-node ${T.role?`is-${T.role}`:""} ${U?"is-active":""} ${K?"is-error":""}`,cx:T.x,cy:T.y,r:T.r},T.id)})]}),Le&&e.jsx("span",{className:"map-explorer-dot",style:{left:oe,top:_,"--move":`${$a.moveMs}ms`}})]}),Y===2&&e.jsx("div",{className:"cogita-index-cards",children:N.map(T=>{const U=R.indexOf(T.id),K=U>=0?W[U]:null,H=(K==null?void 0:K.x)??"140px",ie=(K==null?void 0:K.y)??"140px",ke=U>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":T.throw.x,"--throw-y":T.throw.y,"--throw-rot":T.throw.rot,"--grid-x":T.grid.x,"--grid-y":T.grid.y,"--stack-x":H,"--stack-y":ie,"--stack-opacity":ke,"--delay":T.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},T.id)})}),Y===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[re.map((T,U)=>e.jsxs("div",{className:`round-card ${U===Z?"is-active":""}`,style:{"--card-x":T.x,"--card-y":T.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},T.id)),re[Z]&&e.jsx("span",{className:"round-ring",style:{"--card-x":re[Z].x,"--card-y":`calc(${re[Z].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:ce.map(T=>e.jsx("span",{className:"player-dot",style:{left:T.x,top:T.y,"--jitter-x":T.jitterX,"--jitter-y":T.jitterY,"--breath-delay":T.delay}},T.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:q.map(T=>e.jsx("line",{className:"round-link",x1:T.from.xNum,y1:T.from.yNum,x2:T.to.xNum,y2:T.to.yNum,style:{"--delay":T.delay}},T.id))}),e.jsx("div",{className:"round-flows",children:ce.map((T,U)=>{const K=Ie[U]??"good",H=re[Z];if(!H)return null;const ie=`calc(${H.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":T.x,"--from-y":T.y,"--to-x":H.x,"--to-y":ie,"--delay":`${U*.12}s`}}),e.jsx("span",{className:`return-dot is-${K}`,style:{"--from-x":H.x,"--from-y":ie,"--to-x":T.x,"--to-y":T.y,"--delay":`${U*.12}s`}}),e.jsx("span",{className:`result-pop is-${K}`,style:{"--at-x":T.x,"--at-y":T.y,"--delay":`${U*.12}s`}})]},`${T.id}-${xe}`)})})]},`round-${xe}`),Y===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${g[0].x} ${g[0].y} L${g[1].x} ${g[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${g[1].x} ${g[1].y} L${g[2].x} ${g[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${g[2].x} ${g[2].y} L${g[3].x} ${g[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${g[3].x} ${g[3].y} L${g[4].x} ${g[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${g[4].x} ${g[4].y} L${g[5].x} ${g[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${g[5].x} ${g[5].y} L${g[6].x} ${g[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${P};${P};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${le.upper.map((T,U)=>`${U===0?"M":"L"}${T.x} ${T.y}`).join(" ")} ${le.lower.slice().reverse().map(T=>`L${T.x} ${T.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${le.upper.map((T,U)=>`${U===0?"M":"L"}${T.x} ${T.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${le.lower.map((T,U)=>`${U===0?"M":"L"}${T.x} ${T.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[p.higher.slice(0,6).map((T,U)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${U+1}`,d:`M${T.x} ${T.y} L${p.higher[U+1].x} ${p.higher[U+1].y}`,pathLength:"100"},`peer-1-${U}`)),p.lower.slice(0,6).map((T,U)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${U+1}`,d:`M${T.x} ${T.y} L${p.lower[U+1].x} ${p.lower[U+1].y}`,pathLength:"100"},`peer-2-${U}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${g[0].x/300*100}%`,"--p0y":`${g[0].y/200*100}%`,"--p1x":`${g[1].x/300*100}%`,"--p1y":`${g[1].y/200*100}%`,"--p2x":`${g[2].x/300*100}%`,"--p2y":`${g[2].y/200*100}%`,"--p3x":`${g[3].x/300*100}%`,"--p3y":`${g[3].y/200*100}%`,"--p4x":`${g[4].x/300*100}%`,"--p4y":`${g[4].y/200*100}%`,"--p5x":`${g[5].x/300*100}%`,"--p5y":`${g[5].y/200*100}%`,"--p6x":`${g[6].x/300*100}%`,"--p6y":`${g[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${p.higher[0].x/300*100}%`,"--q0y":`${p.higher[0].y/200*100}%`,"--q1x":`${p.higher[1].x/300*100}%`,"--q1y":`${p.higher[1].y/200*100}%`,"--q2x":`${p.higher[2].x/300*100}%`,"--q2y":`${p.higher[2].y/200*100}%`,"--q3x":`${p.higher[3].x/300*100}%`,"--q3y":`${p.higher[3].y/200*100}%`,"--q4x":`${p.higher[4].x/300*100}%`,"--q4y":`${p.higher[4].y/200*100}%`,"--q5x":`${p.higher[5].x/300*100}%`,"--q5y":`${p.higher[5].y/200*100}%`,"--q6x":`${p.higher[6].x/300*100}%`,"--q6y":`${p.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${p.lower[0].x/300*100}%`,"--q0y":`${p.lower[0].y/200*100}%`,"--q1x":`${p.lower[1].x/300*100}%`,"--q1y":`${p.lower[1].y/200*100}%`,"--q2x":`${p.lower[2].x/300*100}%`,"--q2y":`${p.lower[2].y/200*100}%`,"--q3x":`${p.lower[3].x/300*100}%`,"--q3y":`${p.lower[3].y/200*100}%`,"--q4x":`${p.lower[4].x/300*100}%`,"--q4y":`${p.lower[4].y/200*100}%`,"--q5x":`${p.lower[5].x/300*100}%`,"--q5y":`${p.lower[5].y/200*100}%`,"--q6x":`${p.lower[6].x/300*100}%`,"--q6y":`${p.lower[6].y/200*100}%`}})]})})}),Y===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),Y===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},A.id)}),!s&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:l.title}),l.body&&e.jsx("p",{children:l.body}),l.micro&&e.jsx("p",{className:"cogita-intro-micro",children:l.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:M,children:l.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:j,children:"Otwórz pokaz"})]})]})})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((A,Y)=>e.jsx("button",{type:"button",className:`dot ${n===Y?"active":""}`,"aria-label":A.title,onClick:()=>m(Y)},A.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:k,children:"Pomiń"})]})]})}const Li=6,Ri=4;function $i({copy:t,onAuthAction:n,authLabel:s,showProfileMenu:i,onProfileNavigate:r,onToggleSecureMode:u,onLogout:m,secureMode:k,onNavigate:j,language:M,onLanguageChange:o}){const x=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}j("home")},l=a.useRef(null),d=a.useRef([]),v=a.useMemo(()=>{let B=Date.now()%2147483647;const ee=()=>(B=B*48271%2147483647,B/2147483647);return Array.from({length:Li},(q,fe)=>{const X=6+ee()*8,de=7+ee()*10,ye=6+ee()*9,Pe=-ee()*X,Ve=-ee()*de,Ce=-ee()*ye,He=.18+ee()*.28,Ze=12+ee()*18,Me=4+ee()*8,We=(ee()-.5)*3.2,rt=(ee()-.5)*3.8,ot=ee()>.5?"alternate":"alternate-reverse",_e=ee()>.5?"alternate":"alternate-reverse",je=ee()>.5?"alternate":"alternate-reverse",J=.18+ee()*.42,Le=30+ee()*60,oe=-45-ee()*38,_=188+ee()*32,me=.1+ee()*.2;return{id:`wave-${fe+1}`,style:{"--wave-sway-duration":`${X}s`,"--wave-scale-duration":`${de}s`,"--wave-drift-duration":`${ye}s`,"--wave-sway-delay":`${Pe}s`,"--wave-scale-delay":`${Ve}s`,"--wave-drift-delay":`${Ce}s`,"--wave-sway-dir":ot,"--wave-scale-dir":_e,"--wave-drift-dir":je,"--wave-scale":`${He}`,"--wave-shift":`${Ze}%`,"--wave-xshift":`${Me}%`,"--wave-x0":`${We}%`,"--wave-y0":`${rt}%`,"--wave-opacity":`${J}`,"--wave-blur":`${Le}px`,"--wave-bottom":`${oe}%`,"--wave-hue":`${_}`,"--wave-glow":`${me}`}}})},[]),w=a.useMemo(()=>{let B=Date.now()*3%2147483647;const ee=()=>(B=B*48271%2147483647,B/2147483647);return Array.from({length:Ri},(q,fe)=>{const X=180+ee()*220,de=220+ee()*280,ye=-ee()*X,Pe=-ee()*de,Ve=.12+ee()*.22,Ce=3+ee()*7,He=1+ee()*3,Ze=(ee()-.5)*2.8,Me=(ee()-.5)*2.2;return{id:`mesh-${fe+1}`,seed:1e3+fe*991+Math.floor(ee()*999),style:{"--mesh-sway-duration":`${X}s`,"--mesh-drift-duration":`${de}s`,"--mesh-sway-delay":`${ye}s`,"--mesh-drift-delay":`${Pe}s`,"--mesh-scale":`${Ve}`,"--mesh-shift":`${Ce}%`,"--mesh-xshift":`${He}%`,"--mesh-x0":`${Me}%`,"--mesh-y0":`${Ze}%`}}})},[]),S=a.useMemo(()=>{const B=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],ee=t.cogita.introSlides,q=new Map(ee.map(fe=>[fe.id,fe]));return B.map(fe=>{var de;const X=q.get(fe.id);return{...fe,...X,title:(X==null?void 0:X.title)??"Cogita",cta:(X==null?void 0:X.cta)??((de=t.cogita.introSlides[0])==null?void 0:de.cta)??t.cogita.loginCta,secondary:X==null?void 0:X.secondary}})},[t.cogita.introSlides]),[D,f]=a.useState(0),[g,le]=a.useState(!0),[P,p]=a.useState(!1),V=S.length-1,N=a.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),W=a.useCallback(()=>{N(),n()},[N,n]),R=a.useCallback(()=>{le(!0),f(0)},[]),I=a.useCallback(()=>{le(!1),f(V)},[V]),re=a.useCallback(B=>{f(Math.max(0,Math.min(V,B)))},[V]),ce=a.useCallback(()=>{D>=V?W():re(D+1)},[D,re,W,V]),xe=a.useCallback(()=>{re(D-1)},[D,re]);a.useEffect(()=>{var q;const B=(q=window.matchMedia)==null?void 0:q.call(window,"(prefers-reduced-motion: reduce)");if(!B)return;const ee=()=>p(B.matches);return ee(),B.addEventListener?(B.addEventListener("change",ee),()=>B.removeEventListener("change",ee)):(B.addListener(ee),()=>B.removeListener(ee))},[]),a.useEffect(()=>{if(!g)return;const B=ee=>{const q=ee.target;if(!q)return;const fe=q.tagName;if(!(q.isContentEditable||fe==="INPUT"||fe==="TEXTAREA"||fe==="SELECT"||fe==="BUTTON"||fe==="A"||q.closest('button, a, [role="button"], [role="link"]'))){if(ee.key==="Escape"){I();return}if(ee.key==="ArrowLeft"||ee.key==="ArrowUp"){xe();return}(ee.key==="ArrowRight"||ee.key==="ArrowDown"||ee.code==="Space"||ee.key===" ")&&(ee.preventDefault(),ce())}};return window.addEventListener("keydown",B),()=>window.removeEventListener("keydown",B)},[I,ce,xe,g]),a.useEffect(()=>{g&&D===V&&N()},[D,g,V,N]),a.useEffect(()=>{const B=l.current;if(!B)return;const ee=d.current.filter(oe=>!!oe);if(!ee.length)return;const q=1,fe=.6,X=.6,de=Math.max(1,Math.min(q,window.devicePixelRatio||1));let ye=0,Pe=0,Ve=fe,Ce=0,He=0;const Ze=oe=>{let _=oe%2147483647;return _<=0&&(_+=2147483646),(me,Ge)=>{_=_*48271%2147483647;const $=_/2147483647;return me+$*(Ge-me)}},Me={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},We=oe=>{const _=Math.sin(oe*12.9898)*43758.5453;return _-Math.floor(_)},rt=oe=>{const _=We(oe+.1)||1e-4,me=We(oe+.7)||1e-4;return Math.sqrt(-2*Math.log(_))*Math.cos(2*Math.PI*me)},ot=(oe,_)=>{const me=Math.floor(oe),Ge=me+1,$=oe-me,A=$*$*(3-2*$),Y=We(me*12.9898+_*78.233),se=We(Ge*12.9898+_*78.233);return Y+(se-Y)*A},_e=oe=>{const _=Ze(oe),me=Math.min(4,Math.max(4,Math.floor(ye/1200*Me.filamentCount)));return Array.from({length:me},(Ge,$)=>{const A=Math.max(-1,Math.min(1,rt(oe+$*.37))),Y=Math.min(1,Math.max(0,We(oe+$*1.31))),se=Math.min(Me.depthLayers-1,Math.floor(Y*Me.depthLayers));return{seed:_(0,Math.PI*2)+oe*.01,offset:A,freqA:Me.freq1*(.75+_(0,.5)),freqB:Me.freq2*(.75+_(0,.5)),ampA:Me.amp1*(.6+_(0,.7)),ampB:Me.amp2*(.6+_(0,.7)),width:2+$%5*.32,depth:Y,layer:se}})},je=(oe,_,me)=>{const Ge=Math.max(30,Math.floor(ye*Pe/14e4));oe.save(),oe.globalAlpha=.6;for(let $=0;$<Ge;$+=1){const A=We($*9.1+ye*.11)*_+me,Y=We($*3.7+Pe*.23)*Pe,se=1.2+We($*5.9)*2.4,T=oe.createRadialGradient(A,Y,0,A,Y,se*2);T.addColorStop(0,"rgba(10, 30, 60, 0.45)"),T.addColorStop(1,"rgba(10, 30, 60, 0)"),oe.fillStyle=T,oe.beginPath(),oe.arc(A,Y,se*2,0,Math.PI*2),oe.fill()}oe.restore()},J=(oe,_)=>{oe.clearRect(0,0,ye,Pe);const me=Pe*Me.waveCenter,Ge=Me.waveBandPx,$=Me.segments,A=Me.colors.filaments,Y=Ce||ye,se=0;je(oe,Y,se),oe.strokeStyle=A,oe.lineCap="round",oe.lineJoin="round";for(let T=0;T<_.length;T+=1){const U=_[T],K=U.offset*Ge*(.85+We(U.seed)*.4),H=1-Math.min(1,Math.abs(K)/Ge),ie=Math.exp(-Math.pow(K/Me.crestThickness,2)),ke=U.layer===0?1.1:U.layer===1?.85:.6,Ae=.35+(1-U.depth)*.65,De=H*Ae*ke*(.34+ie*.45);oe.globalAlpha=De,oe.lineWidth=U.width*(1+(1-U.depth)*.8);const ve=[];for(let ue=0;ue<=$;ue+=1){const Xe=ue/$*Y+se,Qe=(ot(Xe*.012,U.seed)-.5)*Me.xJitter,Ye=Xe+Qe,et=(ot(Ye*U.freqA,U.seed)-.5)*Me.jitterA,nt=(ot(Ye*U.freqB,U.seed*1.7)-.5)*Me.jitterB,qe=me+Math.sin(Ye*U.freqA+U.seed)*U.ampA+Math.sin(Ye*U.freqB+U.seed*1.3)*U.ampB+K+et+nt;ve.push({x:Ye,y:qe})}oe.beginPath(),oe.moveTo(ve[0].x,ve[0].y);for(let ue=1;ue<ve.length-1;ue+=1){const Xe=(ve[ue].x+ve[ue+1].x)/2,Qe=(ve[ue].y+ve[ue+1].y)/2;oe.quadraticCurveTo(ve[ue].x,ve[ue].y,Xe,Qe)}const be=ve[ve.length-1];oe.quadraticCurveTo(be.x,be.y,be.x,be.y),oe.stroke()}oe.save(),oe.globalCompositeOperation="lighter",oe.strokeStyle=Me.colors.glow,oe.lineCap="round",oe.lineJoin="round";for(let T=0;T<_.length;T+=1){const U=_[T];if(Math.abs(U.offset)*Ge>Me.crestThickness)continue;const K=Me.glowAlpha*(.7+(1-U.depth)*.6);oe.globalAlpha=K,oe.lineWidth=1.6+(1-U.depth)*1.2;const H=[];for(let ke=0;ke<=$;ke+=1){const Ae=ke/$*Y+se,De=Math.sin(Ae*.02+U.seed)*3,ve=me+Math.sin(Ae*U.freqA+U.seed)*U.ampA+Math.sin(Ae*U.freqB+U.seed*1.3)*U.ampB+U.offset*Ge*.35+De;H.push({x:Ae,y:ve})}oe.beginPath(),oe.moveTo(H[0].x,H[0].y);for(let ke=1;ke<H.length-1;ke+=1){const Ae=(H[ke].x+H[ke+1].x)/2,De=(H[ke].y+H[ke+1].y)/2;oe.quadraticCurveTo(H[ke].x,H[ke].y,Ae,De)}const ie=H[H.length-1];oe.quadraticCurveTo(ie.x,ie.y,ie.x,ie.y),oe.stroke()}oe.restore()},Le=()=>{ye=Math.floor(B.clientWidth),Pe=Math.floor(B.clientHeight),Ce=Math.floor(ye*1.8),He=Pe,Ve=ye<820?X:fe,ee.forEach(oe=>{const _=oe.getContext("2d");if(!_)return;oe.width=Math.floor(Ce*de*Ve),oe.height=Math.floor(He*de*Ve),oe.style.width=`${Ce}px`,oe.style.height=`${He}px`,oe.style.left=`${-(Ce-ye)/2}px`,_.setTransform(de*Ve,0,0,de*Ve,0,0);const me=Number(oe.dataset.seed||1),Ge=_e(me);J(_,Ge)})};return Le(),window.addEventListener("resize",Le,{passive:!0}),()=>window.removeEventListener("resize",Le)},[w]);const Te=S[Math.min(D,S.length-1)],Z=g?Te:S[S.length-1],C=(Z==null?void 0:Z.theme)??S[0].theme,Ie={"--cogita-bg0":C.bg0,"--cogita-bg1":C.bg1,"--cogita-bg2":C.bg2,"--cogita-bloom":C.bloom,"--cogita-sat":C.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:x,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Ss,{value:M,onChange:o}),e.jsx(Ts,{copy:t,label:s,isAuthenticated:i,secureMode:k,onLogin:n,onProfileNavigate:r,onToggleSecureMode:u,onLogout:m,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:l,className:"cogita-section cogita-home",style:Ie,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[w.map((B,ee)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:B.style,"data-seed":B.seed,ref:q=>{d.current[ee]=q}},B.id)),v.map(B=>e.jsx("div",{className:"cogita-home-wave",style:B.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},B.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(Mi,{slides:S,activeIndex:D,introOpen:g,prefersReducedMotion:P,onNext:ce,onPrev:xe,onSelect:re,onExit:I,onOpen:R,onRegister:W})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const Qr=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:$i},Symbol.toStringTag,{value:"Module"})),Ks=a.createContext(!1);function Kt({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,headerExtra:o,children:x}){if(a.useContext(Ks))return e.jsx(e.Fragment,{children:x});const d=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}k("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:d,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Ss,{value:j,onChange:M}),e.jsxs("div",{className:"cogita-header-right",children:[o,e.jsx(Ts,{copy:t,label:n,isAuthenticated:s,secureMode:m,onLogin:()=>k("home"),onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:x}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function ua(t){const[n,s]=a.useState("Cogita library"),[i,r]=a.useState(null);return a.useEffect(()=>{let u=!1;return Cs().then(m=>{if(u)return;const k=m.find(j=>j.libraryId===t);k&&s(k.name)}).catch(()=>{u||s("Cogita library")}),()=>{u=!0}},[t]),a.useEffect(()=>{let u=!1;return Ys(t).then(m=>{u||r(m)}).catch(()=>{u||r(null)}),()=>{u=!0}},[t]),{libraryName:n,stats:i}}function Xn({slices:t}){const n=t.reduce((i,r)=>i+Math.max(0,r.value),0),s=a.useMemo(()=>{if(n<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let i=0;return`conic-gradient(${t.map(u=>{const k=Math.max(0,u.value)/n*360,j=i,M=i+k;return i=M,`${u.color} ${j}deg ${M}deg`}).join(",")})`},[t,n]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:s}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(i=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:i.color}}),e.jsx("strong",{children:i.value}),e.jsx("small",{children:i.label})]},i.label))})]})}function Ai({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o}){const{libraryName:x,stats:l}=ua(o),[d,v]=a.useState("infos"),[w,S]=a.useState(0),[D,f]=a.useState(0),[g,le]=a.useState(0),P=(l==null?void 0:l.totalInfos)??0,p=(l==null?void 0:l.totalCollections)??0,V=0,N=0,W=0,R=Math.max(0,P-W-D),I=Math.max(0,P-D-g);a.useEffect(()=>{let ce=!1;return(async()=>{try{const Te=await Ua({libraryId:o,limit:200}),Z=await Promise.all(Te.items.map(C=>Is({libraryId:o,collectionId:C.collectionId}).catch(()=>[])));if(ce)return;S(Z.reduce((C,Ie)=>C+Ie.length,0))}catch{ce||S(0)}})(),()=>{ce=!0}},[o]),a.useEffect(()=>{let ce=!1;return(async()=>{try{const[Te,Z,C]=await Promise.all([Wn({libraryId:o,type:"computed",limit:1}).catch(()=>({total:0})),Wn({libraryId:o,type:"source",limit:1}).catch(()=>({total:0})),Fn({libraryId:o}).catch(()=>({items:[]}))]);if(ce)return;f((Te.total??0)+(Z.total??0));const Ie=new Set(C.items.filter(B=>B.childItemType.toLowerCase()==="info").map(B=>B.childItemId).filter(Boolean));le(Ie.size)}catch{ce||(f(0),le(0))}})(),()=>{ce=!0}},[o]);const re=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:P},{key:"collections",label:t.cogita.library.overview.stats.collections,value:p},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:w},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:V},{key:"texts",label:t.cogita.library.overview.stats.texts,value:N}];return e.jsx(Kt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:x})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:re.map(ce=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${d===ce.key?"active":""}`,onClick:()=>v(ce.key),children:[e.jsx("span",{children:ce.label}),e.jsx("strong",{children:ce.value})]},ce.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),d==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(Xn,{slices:[{label:t.cogita.library.overview.known,value:W,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:R,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:D,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(Xn,{slices:[{label:t.cogita.library.overview.availableChecks,value:g,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:I,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const at=(t,n)=>{const s=t.cogita.library.infoTypes,i=t.cogita.library.connectionTypes,r=t.cogita.library.groupTypes;return{any:s.any,vocab:s.vocab,book:r.book,citation:r.citation,language:s.language,word:s.word,sentence:s.sentence,topic:s.topic,collection:s.collection,person:s.person,institution:s.institution,collective:s.collective,orcid:s.orcid,address:s.address,email:s.email,phone:s.phone,media:s.media,work:s.work,geo:s.geo,music_piece:s.musicPiece,music_fragment:s.musicFragment,source:s.source,computed:s.computed,"word-language":i.wordLanguage,"citation-language":i.citationLanguage,"language-sentence":i.languageSentence,translation:i.translation,"word-topic":i.wordTopic,reference:i.reference,"source-resource":i.sourceResource,"work-contributor":i.workContributor,"work-medium":i.workMedium,"orcid-link":i.orcidLink}[n]??String(n)},Ei=t=>[{value:"any",label:at(t,"any")},{value:"language",label:at(t,"language")},{value:"word",label:at(t,"word")},{value:"sentence",label:at(t,"sentence")},{value:"topic",label:at(t,"topic")},{value:"collection",label:at(t,"collection")},{value:"person",label:at(t,"person")},{value:"institution",label:at(t,"institution")},{value:"collective",label:at(t,"collective")},{value:"orcid",label:at(t,"orcid")},{value:"address",label:at(t,"address")},{value:"email",label:at(t,"email")},{value:"phone",label:at(t,"phone")},{value:"media",label:at(t,"media")},{value:"work",label:at(t,"work")},{value:"geo",label:at(t,"geo")},{value:"music_piece",label:at(t,"music_piece")},{value:"music_fragment",label:at(t,"music_fragment")},{value:"source",label:at(t,"source")},{value:"citation",label:at(t,"citation")},{value:"computed",label:at(t,"computed")},{value:"vocab",label:at(t,"vocab")},{value:"book",label:at(t,"book")},{value:"word-language",label:at(t,"word-language")},{value:"citation-language",label:at(t,"citation-language")},{value:"language-sentence",label:at(t,"language-sentence")},{value:"translation",label:at(t,"translation")},{value:"word-topic",label:at(t,"word-topic")},{value:"reference",label:at(t,"reference")},{value:"source-resource",label:at(t,"source-resource")},{value:"work-contributor",label:at(t,"work-contributor")},{value:"work-medium",label:at(t,"work-medium")},{value:"orcid-link",label:at(t,"orcid-link")}],Pi=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],bn={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},Ki={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[bn]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[bn]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId"]},filterFields:[bn,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text"],connections:[{relationType:"citation-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"citationText",kind:"text",path:"text",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},Zn={infoType:"default",entityKind:"single",structure:{payloadFields:["label"]},filterFields:[]};function Fi(t){return t?Ki[t]??Zn:Zn}function Di(t,n){return t.optionsSource==="languages"?n.languages.map(s=>({value:s.infoId,label:s.label})):t.optionsSource==="sourceKinds"?Pi:[]}const zi="cogita.revision.seed:";function Fs(t){return`${zi}${t}`}function Bi(t,n){if(typeof window>"u")return null;const s=Array.from(new Set(n.map(u=>u.trim()).filter(Boolean)));if(!s.length)return null;const i=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,r={kind:"info-selection",libraryId:t,infoIds:s,createdAt:new Date().toISOString()};return window.localStorage.setItem(Fs(i),JSON.stringify(r)),i}function es(t,n){if(typeof window>"u")return null;const s=window.localStorage.getItem(Fs(n));if(!s)return null;try{const i=JSON.parse(s);if(i.kind!=="info-selection"||i.libraryId!==t||!Array.isArray(i.infoIds))return null;const r=i.infoIds.map(u=>String(u??"").trim()).filter(Boolean);return r.length?{infoIds:r}:null}catch{return null}}const _i="cogita.collection-draft:";function Ds(t){return`${_i}${t}`}function Vi(t,n){if(typeof window>"u")return null;const s=Array.from(new Set(n.map(u=>u.trim()).filter(Boolean)));if(!s.length)return null;const i=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,r={kind:"info-selection",libraryId:t,infoIds:s,createdAt:new Date().toISOString()};return window.localStorage.setItem(Ds(i),JSON.stringify(r)),i}function Oi(t,n){if(typeof window>"u")return null;const s=window.localStorage.getItem(Ds(n));if(!s)return null;try{const i=JSON.parse(s);if(i.kind!=="info-selection"||i.libraryId!==t||!Array.isArray(i.infoIds))return null;const r=i.infoIds.map(u=>String(u??"").trim()).filter(Boolean);return r.length?{infoIds:r}:null}catch{return null}}const yn=60,Ui=500;function zs(t){return`cogita.info-selection:${t}`}function ts(t){if(typeof window>"u")return{};const n=window.localStorage.getItem(zs(t));if(!n)return{};try{const s=JSON.parse(n);return!s||typeof s!="object"?{}:s}catch{return{}}}function qi({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o,mode:x}){var Dt;const l=An(),d=Fa(),v=t.cogita.library.list,[w,S]=a.useState("any"),[D,f]=a.useState(""),[g,le]=a.useState("relevance"),[P,p]=a.useState("details"),[V,N]=a.useState(!1),[W,R]=a.useState("idle"),[I,re]=a.useState([]),[ce,xe]=a.useState(yn),[Te,Z]=a.useState(null),[C,Ie]=a.useState(()=>ts(o)),[B,ee]=a.useState({}),[q,fe]=a.useState([]),[X,de]=a.useState([]),[ye,Pe]=a.useState(null),[Ve,Ce]=a.useState(null),[He,Ze]=a.useState(null),[Me,We]=a.useState("idle"),[rt,ot]=a.useState([]),[_e,je]=a.useState(""),[J,Le]=a.useState(null),[oe,_]=a.useState("idle"),[me,Ge]=a.useState(null),[$,A]=a.useState(null),[Y,se]=a.useState("idle"),[T,U]=a.useState([]),[K,H]=a.useState("idle"),ie=a.useMemo(()=>Ei(t),[t]),ke=a.useMemo(()=>[{value:"relevance",label:v.sortRelevance},{value:"label_asc",label:v.sortLabelAsc},{value:"label_desc",label:v.sortLabelDesc},{value:"type_asc",label:v.sortTypeAsc},{value:"type_desc",label:v.sortTypeDesc}],[v.sortLabelAsc,v.sortLabelDesc,v.sortRelevance,v.sortTypeAsc,v.sortTypeDesc]);a.useEffect(()=>{Ie(ts(o)),ee({}),N(!1)},[o]),a.useEffect(()=>{Fn({libraryId:o}).then(h=>Ze(h)).catch(()=>Ze({items:[]}))},[o]),a.useEffect(()=>{Qs({libraryId:o}).then(h=>ot(h)).catch(()=>ot([]))},[o]),a.useEffect(()=>{fn({libraryId:o,type:"language",filters:{sourceKind:"info"},limit:200}).then(h=>{const Ne=h.map(Oe=>({infoId:Oe.infoId??"",infoType:Oe.entityType,label:Oe.title})).filter(Oe=>Oe.infoId.length>0);fe(Ne)}).catch(()=>fe([]))},[o]),a.useEffect(()=>{fn({libraryId:o,type:"source",filters:{sourceKind:"info"},limit:200}).then(h=>{const Ne=h.map(Oe=>({infoId:Oe.infoId??"",infoType:Oe.entityType,label:Oe.title})).filter(Oe=>Oe.infoId.length>0);de(Ne)}).catch(()=>de([]))},[o]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(zs(o),JSON.stringify(C))},[o,C]);const Ae=a.useMemo(()=>Fi(w==="any"?null:w),[w]),De=a.useMemo(()=>new URLSearchParams(d.search),[d.search]),ve=a.useMemo(()=>d.pathname.split("/").filter(Boolean),[d.pathname]),be=ve.findIndex(h=>h==="infos"),ue=be>=0&&(ve[be+1]??"").trim()||null,Xe=be>=0?(ve[be+2]??"").trim():"",Qe=be>=0?Xe==="checkcards"?"cards":Xe==="collections"?"collections":"overview":"",Ye=ue??((De.get("infoId")??"").trim()||null),et=ue?Qe:(De.get("infoView")??"overview").trim(),nt=et==="overview"&&!!Ye,qe=et==="collections"&&!!Ye,ut=a.useMemo(()=>({language:v.typeFilterLanguage,languageA:v.typeFilterLanguageA,languageB:v.typeFilterLanguageB,originalLanguage:v.typeFilterOriginalLanguage,doi:v.typeFilterDoi,sourceKind:v.typeFilterSourceKind,locator:v.typeFilterLocator,citationText:v.typeFilterCitationText}),[v.typeFilterDoi,v.typeFilterLanguage,v.typeFilterLanguageA,v.typeFilterLanguageB,v.typeFilterLocator,v.typeFilterOriginalLanguage,v.typeFilterCitationText,v.typeFilterSourceKind]),jt=a.useMemo(()=>Ae.filterFields.map(h=>({...h,label:h.labelKey?ut[h.labelKey]:h.label??h.key,options:Di(h,{languages:q})})),[ut,q,Ae.filterFields]),yt=a.useMemo(()=>jt.some(h=>(B[h.key]??"").trim().length>0),[jt,B]);a.useEffect(()=>{ee({})},[w]),a.useEffect(()=>{const h={sourceKind:"info"};if(yt)for(const lt of jt){const Nt=(B[lt.key]??"").trim();Nt&&(h[lt.path??lt.key]=Nt)}const Ne=(B.__referenceId??"").trim();Ne&&(h["link.references"]=Ne),R("loading");const Oe=window.setTimeout(()=>{fn({libraryId:o,type:w==="any"?void 0:w,query:D.trim()||void 0,filters:h,limit:Ui}).then(lt=>{const Nt=lt.map(Yt=>({infoId:Yt.infoId??"",infoType:Yt.entityType,label:Yt.title})).filter(Yt=>Yt.infoId.length>0);re(Nt),R("ready")}).catch(()=>{re([]),R("ready")})},240);return()=>window.clearTimeout(Oe)},[yt,o,D,w,jt,B]),a.useEffect(()=>{if(!Ye||et!=="overview"&&et!=="collections"){Pe(null),Ce(null),We("idle");return}let h=!1;return We("loading"),Promise.all([da({libraryId:o,infoId:Ye}),Xs({libraryId:o,itemType:"info",itemId:Ye}).catch(()=>null)]).then(([Ne,Oe])=>{h||(Pe(Ne),Ce(Oe),We("ready"))}).catch(()=>{h||(Pe(null),Ce(null),We("error"))}),()=>{h=!0}},[o,Ye,et]),a.useEffect(()=>{if(!Ye||et!=="collections"){U([]),H("idle");return}let h=!1;return H("loading"),Zs({libraryId:o,infoId:Ye}).then(Ne=>{h||(U(Ne),H("ready"))}).catch(()=>{h||(U([]),H("error"))}),()=>{h=!0}},[o,Ye,et]),a.useEffect(()=>{if(!Ye||et!=="overview"){Ge(null),A(null),se("idle");return}let h=!1;return se("loading"),Promise.all([qa({libraryId:o,infoId:Ye}),Ja({libraryId:o,infoId:Ye})]).then(([Ne,Oe])=>{h||(Ge(Ne),A(Oe),se("ready"))}).catch(()=>{h||(Ge(null),A(null),se("error"))}),()=>{h=!0}},[o,Ye,et]);const St=a.useMemo(()=>ye?rt.filter(h=>h.sourceInfoTypes.some(Ne=>Ne.toLowerCase()===ye.infoType.toLowerCase())):[],[rt,ye]);a.useEffect(()=>{if(!ye){je("");return}je(h=>{var Ne;return h&&St.some(Oe=>Oe.approachKey===h)?h:((Ne=St[0])==null?void 0:Ne.approachKey)??""})},[St,ye]),a.useEffect(()=>{if(!ye||!_e){Le(null),_("idle");return}let h=!1;return _("loading"),Ms({libraryId:o,infoId:ye.infoId,approachKey:_e}).then(Ne=>{h||(Le(Ne),_("ready"))}).catch(()=>{h||(Le(null),_("error"))}),()=>{h=!0}},[o,_e,ye]);const Pt=a.useMemo(()=>{const h=I.slice(),Ne=Oe=>at(t,Oe);return g==="relevance"?h:g==="label_asc"?h.sort((Oe,lt)=>Oe.label.localeCompare(lt.label)):g==="label_desc"?h.sort((Oe,lt)=>lt.label.localeCompare(Oe.label)):g==="type_asc"?h.sort((Oe,lt)=>Oe.infoType===lt.infoType?Oe.label.localeCompare(lt.label):Ne(Oe.infoType).localeCompare(Ne(lt.infoType))):h.sort((Oe,lt)=>Oe.infoType===lt.infoType?Oe.label.localeCompare(lt.label):Ne(lt.infoType).localeCompare(Ne(Oe.infoType)))},[t,I,g]),Mt=a.useMemo(()=>Pt.slice(0,ce),[Pt,ce]),Ft=Mt.length<Pt.length,xt=a.useMemo(()=>new Set(Object.keys(C)),[C]),Lt=a.useMemo(()=>Object.values(C),[C]),vt=a.useMemo(()=>{const h=new Map;for(const Ne of Lt)h.set(Ne.infoType,(h.get(Ne.infoType)??0)+1);return Array.from(h.entries()).sort((Ne,Oe)=>Oe[1]-Ne[1]||Ne[0].localeCompare(Oe[0]))},[Lt]),kt=a.useMemo(()=>{if(!Ye||!He)return 0;const h=new Set;for(const Ne of He.items)Ne.childItemType!=="info"||Ne.childItemId!==Ye||h.add([Ne.parentItemType,Ne.parentItemId,Ne.parentCheckType??"",Ne.parentDirection??""].join("|"));return h.size},[He,Ye]);a.useEffect(()=>{xe(yn);const h=new Set(I.map(Ne=>Ne.infoId));Z(Ne=>Ne&&h.has(Ne)?Ne:null)},[I]);const Vt=h=>{Ie(Ne=>({...Ne,[h.infoId]:{infoId:h.infoId,infoType:h.infoType,label:h.label}}))},Ut=h=>{Ie(Ne=>{if(!Ne[h])return Ne;const Oe={...Ne};return delete Oe[h],Oe})},tt=(h,Ne)=>{if(Ne){Vt(h);return}Ut(h.infoId)},gt=h=>{l(`/cogita/library/${o}/infos/${encodeURIComponent(h)}`,{replace:!0})},Rt=()=>{l(`/cogita/library/${o}/list`,{replace:!0})},Tt=()=>{Ye&&l(`/cogita/library/${o}/edit/${encodeURIComponent(Ye)}`,{replace:!0})},Ke=()=>{const h=Bi(o,Lt.map(Ne=>Ne.infoId));h&&l(`/cogita/library/${o}/revision/run?libraryTarget=revisions&scope=info-selection&seed=${encodeURIComponent(h)}`)},mt=()=>{const h=Vi(o,Lt.map(Ne=>Ne.infoId));h&&l(`/cogita/library/${o}/collections/new?draft=${encodeURIComponent(h)}&draftType=info-selection`)},Ct=Lt.length===1?((Dt=Lt[0])==null?void 0:Dt.infoId)??null:null,It=v.selectionCount.replace("{count}",String(Lt.length)),ha=x==="collection"?"grid":x==="detail"?"wide":P,ae=Hi(j),qt=Ve?Math.max(0,Math.min(100,Math.round((Ve.score??0)*100))):0,Et=Ve?Wi(Ve,ae):ae.noKnownnessData;return e.jsx(Kt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":ha,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[nt?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:ae.kicker}),e.jsx("h2",{className:"cogita-card-title",children:ye?as(ye.payload,ye.infoType,ye.infoId):ae.loading}),ye?e.jsxs("p",{className:"cogita-card-subtitle",children:[at(t,ye.infoType)," · ",ye.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:Rt,children:ae.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:Tt,disabled:!Ye||Me!=="ready",children:v.editInfo})]})]}),Me==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:ae.loading})}):Me==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:ae.loadError})}):ye?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:ae.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[qt,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${qt}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:Et})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:ae.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(Ve==null?void 0:Ve.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:ae.correct.replace("{correct}",String((Ve==null?void 0:Ve.correctReviews)??0)).replace("{total}",String((Ve==null?void 0:Ve.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:Ve!=null&&Ve.lastReviewedUtc?`${ae.lastReview}: ${Ji(Ve.lastReviewedUtc,j)}`:ae.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:ae.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:kt}),e.jsx("p",{className:"cogita-library-hint",children:ae.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:ae.checkcards}),Y==="loading"?e.jsx("p",{className:"cogita-library-hint",children:ae.loadingCheckcards}):Y==="error"?e.jsx("p",{className:"cogita-library-hint",children:ae.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:ae.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(me==null?void 0:me.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:ae.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:($==null?void 0:$.items.length)??0})]})]})]}),St.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:ae.approach}),e.jsx("select",{value:_e,onChange:h=>je(h.target.value),"aria-label":ae.approach,children:St.map(h=>e.jsx("option",{value:h.approachKey,children:h.label},h.approachKey))})]}),oe==="loading"?e.jsx("p",{className:"cogita-library-hint",children:ae.loadingApproach}):oe==="error"?e.jsx("p",{className:"cogita-library-hint",children:ae.loadApproachError}):J?e.jsx(Wa,{value:J.projection,emptyLabel:ae.empty}):e.jsx("p",{className:"cogita-library-hint",children:ae.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:ae.payload}),e.jsx(Wa,{value:ye.payload,emptyLabel:ae.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:ae.links}),e.jsx(Gi,{links:ye.links,emptyLabel:ae.noLinks})]})]})]}):null]})}):null,qe?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Informacja"}),e.jsx("h2",{className:"cogita-card-title",children:ye?as(ye.payload,ye.infoType,ye.infoId):Ye??""}),e.jsx("p",{className:"cogita-card-subtitle",children:"Collections using this info"})]}),e.jsx("div",{className:"cogita-info-overview-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:Rt,children:"Back to search"})})]}),K==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading collections..."})}):null,K==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load collections."})}):null,K==="ready"&&T.length===0?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"This info is not used in any collection yet."})}):null,K==="ready"&&T.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:T.map(h=>e.jsx("article",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`/#/cogita/library/${o}/collections/${h.collectionId}?libraryTarget=collections`,children:[e.jsx("div",{className:"cogita-card-type",children:"Collection"}),e.jsx("h3",{className:"cogita-card-title",children:h.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[h.itemCount," items"]})]})},h.collectionId))}):null]})}):null,!nt&&!qe?e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":v.typeLabel,value:w,onChange:h=>S(h.target.value),children:ie.map(h=>e.jsx("option",{value:h.value,children:h.label},h.value))}),e.jsx("input",{type:"text",value:D,onChange:h=>f(h.target.value),placeholder:v.searchPlaceholder}),e.jsx("select",{"aria-label":v.sortLabel,value:g,onChange:h=>le(h.target.value),children:ke.map(h=>e.jsx("option",{value:h.value,children:h.label},h.value))}),e.jsxs("select",{"aria-label":v.viewLabel,value:P,onChange:h=>p(h.target.value),children:[e.jsx("option",{value:"details",children:v.viewDetails}),e.jsx("option",{value:"wide",children:v.viewWide}),e.jsx("option",{value:"grid",children:v.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:v.cardCount.replace("{shown}",String(Mt.length)).replace("{total}",String(Pt.length))}),e.jsx("span",{children:W==="loading"?v.loading:v.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>N(h=>!h),children:V?v.hideFilters:v.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:v.filtersOptionalHint})]}),V?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsxs("div",{className:"cogita-filter-grid",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:v.typeLabel}),e.jsx("select",{value:w,onChange:h=>S(h.target.value),children:ie.map(h=>e.jsx("option",{value:h.value,children:h.label},`advanced-type:${h.value}`))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Reference"}),e.jsxs("select",{value:B.__referenceId??"",onChange:h=>ee(Ne=>({...Ne,__referenceId:h.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),X.map(h=>e.jsx("option",{value:h.infoId,children:h.label},`reference:${h.infoId}`))]})]}),jt.map(h=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:h.label}),h.kind==="select"?e.jsxs("select",{value:B[h.key]??"",onChange:Ne=>ee(Oe=>({...Oe,[h.key]:Ne.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(h.options??[]).map(Ne=>e.jsx("option",{value:Ne.value,children:Ne.label},`${h.key}:${Ne.value}`))]}):e.jsx("input",{type:"text",value:B[h.key]??"",onChange:Ne=>ee(Oe=>({...Oe,[h.key]:Ne.target.value}))})]},`type-filter:${h.key}`))]})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:It}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{Ie(h=>{const Ne={...h};for(const Oe of Mt)Ne[Oe.infoId]={infoId:Oe.infoId,infoType:Oe.infoType,label:Oe.label};return Ne})},disabled:Mt.length===0,children:v.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ie({}),disabled:Lt.length===0,children:v.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ct&&gt(Ct),disabled:!Ct,title:Ct?void 0:v.openSelectedDisabled,children:v.openSelected})]})]}),ha==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":v.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:v.detailColumnName}),e.jsx("span",{children:v.detailColumnType}),e.jsx("span",{children:v.detailColumnId}),e.jsx("span",{})]}),Mt.length?Mt.map(h=>{const Ne=at(t,h.infoType),Oe=xt.has(h.infoId),lt=Te===h.infoId;return e.jsxs("div",{className:`cogita-details-row ${lt||Oe?"active":""}`,role:"row",onClick:()=>Z(h.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:Oe,onChange:Nt=>tt(h,Nt.target.checked),onClick:Nt=>Nt.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:h.label,children:h.label}),e.jsx("span",{title:Ne,children:Ne}),e.jsx("span",{title:h.infoId,children:h.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:Nt=>{Nt.stopPropagation(),gt(h.infoId)},"aria-label":v.editInfo,children:">"})]},h.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:v.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${ha}`,"data-view":ha,children:Mt.length?Mt.map(h=>{const Ne=at(t,h.infoType),Oe=xt.has(h.infoId),lt=Te===h.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":lt||Oe,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:Oe,onChange:Nt=>tt(h,Nt.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>Z(h.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:Ne}),e.jsx("h3",{className:"cogita-card-title",children:h.label}),e.jsx("p",{className:"cogita-card-subtitle",children:h.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>gt(h.infoId),children:v.editInfo})]})},h.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:v.noMatch})})}),Ft?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>xe(h=>h+yn),children:v.loadMore})}):null,Lt.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:v.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:v.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:vt.map(([h,Ne])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:at(t,h)}),e.jsx("span",{className:"cogita-tag-count",children:Ne})]},`stack:type:${h}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:Ke,disabled:Lt.length===0,children:"Start revision"}),e.jsx("button",{type:"button",className:"ghost",onClick:mt,disabled:Lt.length===0,children:"Create collection from selection"})]})]}):null]}):null]})})})})}function as(t,n,s){if(t&&typeof t=="object"&&!Array.isArray(t)){const i=t,r=["title","name","label","value","text","quote","term"];for(const u of r){const m=i[u];if(typeof m=="string"&&m.trim())return m.trim()}}return`${n} · ${s}`}function Ji(t,n){try{const s=n==="pl"?"pl-PL":n==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(s,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function Hi(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function Wi(t,n){return t.totalReviews<=0?n.noKnownnessData:t.totalReviews<3||t.score<.35?n.developmentStart:t.totalReviews<8||t.score<.65?n.developmentGrowing:t.score<.85?n.developmentStable:n.developmentStrong}function Gi({links:t,emptyLabel:n}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([s,i])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(i)?i.length?e.jsx("div",{className:"cogita-selection-overview",children:i.map(r=>e.jsx("span",{className:"cogita-tag-chip",children:r},`${s}:${r}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):i?e.jsx("span",{className:"cogita-tag-chip",children:i}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},s))})}function Wa({value:t,emptyLabel:n}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:n});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((s,i)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:i+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(Wa,{value:s,emptyLabel:n})})]},i))});if(typeof t=="object"){const s=Object.entries(t);return s.length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:s.map(([i,r])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:i}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(Wa,{value:r,emptyLabel:n})})]},i))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const wa=5,ns=50,ss=2,is=[];function ea({libraryId:t,infoType:n,label:s,placeholder:i,value:r,onChange:u,values:m,onChangeMultiple:k,helperText:j,searchFailedText:M,createFailedText:o,createLabel:x,savingLabel:l,loadMoreLabel:d,allowCreate:v=!0,inputRef:w,autoAdvance:S,onCommit:D,multiple:f}){const g=f?m??is:is,[le,P]=a.useState(f?"":(r==null?void 0:r.label)??""),[p,V]=a.useState([]),[N,W]=a.useState(wa),[R,I]=a.useState(-1),[re,ce]=a.useState(!1),[xe,Te]=a.useState(!1),[Z,C]=a.useState(null),Ie=a.useRef(0),B=a.useRef(new Map),ee=a.useMemo(()=>v?f?le.trim().length>0:le.trim().length>0&&!r:!1,[v,le,r,f]);a.useEffect(()=>{f||P((r==null?void 0:r.label)??"")},[r,f]),a.useEffect(()=>{const X=le.trim();if(!X||X.length<ss){V([]),ce(!1),W(wa),I(-1),Te(!1),C(null);return}const de=X.toLowerCase(),ye=`${t}:${n}:${de}`,Pe=B.current.get(ye);if(Pe){if(f&&g.length>0){const Ce=new Set(g.map(He=>He.id));V(Pe.filter(He=>!Ce.has(He.id)))}else V(Pe);W(wa),I(-1),ce(Pe.length>0),Te(!1),C(null);return}const Ve=window.setTimeout(async()=>{const Ce=Date.now();Ie.current=Ce,Te(!0),C(null);try{const He=await Dn({libraryId:t,type:n,query:X,limit:ns});if(Ie.current!==Ce)return;const Ze=He.slice(0,ns).map(Me=>({id:Me.infoId,label:Me.label,infoType:Me.infoType}));if(B.current.set(ye,Ze),f&&g.length>0){const Me=new Set(g.map(We=>We.id));V(Ze.filter(We=>!Me.has(We.id)))}else V(Ze);W(wa),I(-1),ce(!0)}catch{if(Ie.current!==Ce)return;C(M??"Search failed.")}finally{Ie.current===Ce&&Te(!1)}},250);return()=>window.clearTimeout(Ve)},[t,n,le,g]);const q=X=>{if(f){const de=g.some(ye=>ye.id===X.id)?g:[...g,X];k==null||k(de),P(""),ce(!1),I(-1);return}u==null||u(X),P(X.label),ce(!1),I(-1),S&&(D==null||D())},fe=async()=>{const X=le.trim();if(X){Te(!0),C(null);try{const de=await Rn({libraryId:t,infoType:n,payload:{label:X}}),ye={id:de.infoId,label:X,infoType:de.infoType};if(X.length>=ss){const Pe=`${t}:${n}:${X.toLowerCase()}`,Ve=B.current.get(Pe)??[];B.current.set(Pe,[ye,...Ve])}if(f){k==null||k([...g,ye]),P(""),ce(!1),I(-1);return}u==null||u(ye),ce(!1),I(-1),S&&(D==null||D())}catch{C(o??"Create failed.")}finally{Te(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:s}),e.jsx("input",{value:le,placeholder:i,onChange:X=>{P(X.target.value),!f&&r&&(u==null||u(null))},onKeyDown:X=>{if(X.key==="ArrowDown"){if(X.preventDefault(),!p.length)return;ce(!0),I(de=>{const ye=Math.min(p.length,N)-1,Pe=de<0?0:Math.min(de+1,ye);return Pe===ye&&p.length>N?(W(Ve=>Math.min(Ve+wa,p.length)),Math.min(de+1,Math.min(p.length,N+wa)-1)):Pe});return}if(X.key==="ArrowUp"){if(X.preventDefault(),!p.length)return;ce(!0),I(de=>de<=0?0:de-1);return}if(X.key==="Enter"){if(X.preventDefault(),R>=0&&p[R]){q(p[R]);return}if(ee){fe();return}}},onFocus:()=>{p.length>0&&ce(!0)},autoComplete:"off",ref:w})]}),f&&g.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:g.map(X=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>k==null?void 0:k(g.filter(de=>de.id!==X.id)),children:[X.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},X.id))}),j&&e.jsx("p",{className:"cogita-help",children:j}),Z&&e.jsx("p",{className:"cogita-error",children:Z}),re&&p.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[p.slice(0,N).map((X,de)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":de===R,onClick:()=>q(X),children:[e.jsx("strong",{children:X.label}),e.jsx("span",{children:X.infoType})]},X.id)),N<p.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>W(X=>Math.min(X+wa,p.length)),children:d??"Load more"})]}),ee&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:fe,disabled:xe,children:xe?l??"Saving...":x??`Create new ${n}`})]})}const rs=[{id:"gen",la:{abbr:"Gen",name:"Genesis"},en:{abbr:"Gen",name:"Genesis"},de:{abbr:"Gen",name:"Genesis"},pl:{abbr:"Rdz",name:"Księga Rodzaju"}},{id:"ex",la:{abbr:"Ex",name:"Exodus"},en:{abbr:"Ex",name:"Exodus"},de:{abbr:"Ex",name:"Exodus"},pl:{abbr:"Wj",name:"Księga Wyjścia"}},{id:"lev",la:{abbr:"Lev",name:"Leviticus"},en:{abbr:"Lev",name:"Leviticus"},de:{abbr:"Lev",name:"Levitikus"},pl:{abbr:"Kpł",name:"Księga Kapłańska"}},{id:"num",la:{abbr:"Num",name:"Numeri"},en:{abbr:"Num",name:"Numbers"},de:{abbr:"Num",name:"Numeri"},pl:{abbr:"Lb",name:"Księga Liczb"}},{id:"deut",la:{abbr:"Deut",name:"Deuteronomium"},en:{abbr:"Deut",name:"Deuteronomy"},de:{abbr:"Dtn",name:"Deuteronomium"},pl:{abbr:"Pwt",name:"Księga Powtórzonego Prawa"}},{id:"ios",la:{abbr:"Ios",name:"Iosue"},en:{abbr:"Josh",name:"Joshua"},de:{abbr:"Jos",name:"Josua"},pl:{abbr:"Joz",name:"Księga Jozuego"}},{id:"iudg",la:{abbr:"Iudg",name:"Iudicum"},en:{abbr:"Judg",name:"Judges"},de:{abbr:"Ri",name:"Richter"},pl:{abbr:"Sdz",name:"Księga Sędziów"}},{id:"ruth",la:{abbr:"Ruth",name:"Ruth"},en:{abbr:"Ruth",name:"Ruth"},de:{abbr:"Rut",name:"Rut"},pl:{abbr:"Rt",name:"Księga Rut"}},{id:"1sam",la:{abbr:"1 Sam",name:"I Samuelis"},en:{abbr:"1 Sam",name:"1 Samuel"},de:{abbr:"1 Sam",name:"1 Samuel"},pl:{abbr:"1 Sm",name:"1 Księga Samuela"}},{id:"2sam",la:{abbr:"2 Sam",name:"II Samuelis"},en:{abbr:"2 Sam",name:"2 Samuel"},de:{abbr:"2 Sam",name:"2 Samuel"},pl:{abbr:"2 Sm",name:"2 Księga Samuela"}},{id:"1reg",la:{abbr:"1 Reg",name:"I Regum"},en:{abbr:"1 Kgs",name:"1 Kings"},de:{abbr:"1 Kön",name:"1 Könige"},pl:{abbr:"1 Krl",name:"1 Księga Królewska"}},{id:"2reg",la:{abbr:"2 Reg",name:"II Regum"},en:{abbr:"2 Kgs",name:"2 Kings"},de:{abbr:"2 Kön",name:"2 Könige"},pl:{abbr:"2 Krl",name:"2 Księga Królewska"}},{id:"1par",la:{abbr:"1 Par",name:"I Paralipomenon"},en:{abbr:"1 Chr",name:"1 Chronicles"},de:{abbr:"1 Chr",name:"1 Chronik"},pl:{abbr:"1 Krn",name:"1 Księga Kronik"}},{id:"2par",la:{abbr:"2 Par",name:"II Paralipomenon"},en:{abbr:"2 Chr",name:"2 Chronicles"},de:{abbr:"2 Chr",name:"2 Chronik"},pl:{abbr:"2 Krn",name:"2 Księga Kronik"}},{id:"esd",la:{abbr:"Esd",name:"Esdrae"},en:{abbr:"Ezra",name:"Ezra"},de:{abbr:"Esra",name:"Esra"},pl:{abbr:"Ezd",name:"Księga Ezdrasza"}},{id:"neh",la:{abbr:"Neh",name:"Nehemiae"},en:{abbr:"Neh",name:"Nehemiah"},de:{abbr:"Neh",name:"Nehemia"},pl:{abbr:"Ne",name:"Księga Nehemiasza"}},{id:"tob",la:{abbr:"Tob",name:"Tobiae"},en:{abbr:"Tob",name:"Tobit"},de:{abbr:"Tob",name:"Tobit"},pl:{abbr:"Tb",name:"Księga Tobiasza"}},{id:"iudt",la:{abbr:"Iudt",name:"Iudith"},en:{abbr:"Jdt",name:"Judith"},de:{abbr:"Jdt",name:"Judit"},pl:{abbr:"Jdt",name:"Księga Judyty"}},{id:"est",la:{abbr:"Est",name:"Esther"},en:{abbr:"Est",name:"Esther"},de:{abbr:"Est",name:"Ester"},pl:{abbr:"Est",name:"Księga Estery"}},{id:"1macc",la:{abbr:"1 Macc",name:"I Maccabaeorum"},en:{abbr:"1 Mc",name:"1 Maccabees"},de:{abbr:"1 Makk",name:"1 Makkabäer"},pl:{abbr:"1 Mch",name:"1 Księga Machabejska"}},{id:"2macc",la:{abbr:"2 Macc",name:"II Maccabaeorum"},en:{abbr:"2 Mc",name:"2 Maccabees"},de:{abbr:"2 Makk",name:"2 Makkabäer"},pl:{abbr:"2 Mch",name:"2 Księga Machabejska"}},{id:"iob",la:{abbr:"Iob",name:"Iob"},en:{abbr:"Job",name:"Job"},de:{abbr:"Ijob",name:"Ijob"},pl:{abbr:"Hi",name:"Księga Hioba"}},{id:"ps",la:{abbr:"Ps",name:"Psalmi"},en:{abbr:"Ps",name:"Psalms"},de:{abbr:"Ps",name:"Psalmen"},pl:{abbr:"Ps",name:"Księga Psalmów"}},{id:"prov",la:{abbr:"Prov",name:"Proverbia"},en:{abbr:"Prov",name:"Proverbs"},de:{abbr:"Spr",name:"Sprichwörter"},pl:{abbr:"Prz",name:"Księga Przysłów"}},{id:"ecc",la:{abbr:"Ecc",name:"Ecclesiastes"},en:{abbr:"Eccl",name:"Ecclesiastes"},de:{abbr:"Koh",name:"Kohelet"},pl:{abbr:"Koh",name:"Księga Koheleta"}},{id:"cant",la:{abbr:"Cant",name:"Canticum Canticorum"},en:{abbr:"Song",name:"Song of Songs"},de:{abbr:"Hld",name:"Hoheslied"},pl:{abbr:"Pnp",name:"Pieśń nad Pieśniami"}},{id:"sap",la:{abbr:"Sap",name:"Sapientia"},en:{abbr:"Wis",name:"Wisdom"},de:{abbr:"Weish",name:"Weisheit"},pl:{abbr:"Mdr",name:"Księga Mądrości"}},{id:"sir",la:{abbr:"Sir",name:"Ecclesiasticus (Sirach)"},en:{abbr:"Sir",name:"Sirach"},de:{abbr:"Sir",name:"Jesus Sirach"},pl:{abbr:"Syr",name:"Mądrość Syracha"}},{id:"isa",la:{abbr:"Isa",name:"Isaias"},en:{abbr:"Isa",name:"Isaiah"},de:{abbr:"Jes",name:"Jesaja"},pl:{abbr:"Iz",name:"Księga Izajasza"}},{id:"ier",la:{abbr:"Ier",name:"Ieremias"},en:{abbr:"Jer",name:"Jeremiah"},de:{abbr:"Jer",name:"Jeremia"},pl:{abbr:"Jr",name:"Księga Jeremiasza"}},{id:"lam",la:{abbr:"Lam",name:"Lamentationes"},en:{abbr:"Lam",name:"Lamentations"},de:{abbr:"Klgl",name:"Klagelieder"},pl:{abbr:"Lm",name:"Lamentacje"}},{id:"bar",la:{abbr:"Bar",name:"Baruch"},en:{abbr:"Bar",name:"Baruch"},de:{abbr:"Bar",name:"Baruch"},pl:{abbr:"Ba",name:"Księga Barucha"}},{id:"ez",la:{abbr:"Ez",name:"Ezechiel"},en:{abbr:"Ezek",name:"Ezekiel"},de:{abbr:"Ez",name:"Ezechiel"},pl:{abbr:"Ez",name:"Księga Ezechiela"}},{id:"dan",la:{abbr:"Dan",name:"Daniel"},en:{abbr:"Dan",name:"Daniel"},de:{abbr:"Dan",name:"Daniel"},pl:{abbr:"Dn",name:"Księga Daniela"}},{id:"hos",la:{abbr:"Hos",name:"Osee"},en:{abbr:"Hos",name:"Hosea"},de:{abbr:"Hos",name:"Hosea"},pl:{abbr:"Oz",name:"Księga Ozeasza"}},{id:"ioel",la:{abbr:"Ioel",name:"Ioel"},en:{abbr:"Joel",name:"Joel"},de:{abbr:"Joel",name:"Joel"},pl:{abbr:"Jl",name:"Księga Joela"}},{id:"amos",la:{abbr:"Amos",name:"Amos"},en:{abbr:"Am",name:"Amos"},de:{abbr:"Am",name:"Amos"},pl:{abbr:"Am",name:"Księga Amosa"}},{id:"abd",la:{abbr:"Abd",name:"Abdias"},en:{abbr:"Obad",name:"Obadiah"},de:{abbr:"Obd",name:"Obadja"},pl:{abbr:"Abd",name:"Księga Abdiasza"}},{id:"ion",la:{abbr:"Ion",name:"Ionas"},en:{abbr:"Jon",name:"Jonah"},de:{abbr:"Jona",name:"Jona"},pl:{abbr:"Jon",name:"Księga Jonasza"}},{id:"mich",la:{abbr:"Mich",name:"Michaeas"},en:{abbr:"Mic",name:"Micah"},de:{abbr:"Mi",name:"Micha"},pl:{abbr:"Mi",name:"Księga Micheasza"}},{id:"nah",la:{abbr:"Nah",name:"Nahum"},en:{abbr:"Nah",name:"Nahum"},de:{abbr:"Nah",name:"Nahum"},pl:{abbr:"Na",name:"Księga Nahuma"}},{id:"hab",la:{abbr:"Hab",name:"Habacuc"},en:{abbr:"Hab",name:"Habakkuk"},de:{abbr:"Hab",name:"Habakuk"},pl:{abbr:"Ha",name:"Księga Habakuka"}},{id:"soph",la:{abbr:"Soph",name:"Sophonias"},en:{abbr:"Zeph",name:"Zephaniah"},de:{abbr:"Zef",name:"Zefanja"},pl:{abbr:"So",name:"Księga Sofoniasza"}},{id:"agg",la:{abbr:"Agg",name:"Aggaeus"},en:{abbr:"Hag",name:"Haggai"},de:{abbr:"Hag",name:"Haggai"},pl:{abbr:"Ag",name:"Księga Aggeusza"}},{id:"zach",la:{abbr:"Zach",name:"Zacharias"},en:{abbr:"Zech",name:"Zechariah"},de:{abbr:"Sach",name:"Sacharja"},pl:{abbr:"Za",name:"Księga Zachariasza"}},{id:"mal",la:{abbr:"Mal",name:"Malachias"},en:{abbr:"Mal",name:"Malachi"},de:{abbr:"Mal",name:"Maleachi"},pl:{abbr:"Ml",name:"Księga Malachiasza"}},{id:"mt",la:{abbr:"Mt",name:"Matthaeus"},en:{abbr:"Matt",name:"Matthew"},de:{abbr:"Mt",name:"Matthäus"},pl:{abbr:"Mt",name:"Ewangelia wg św. Mateusza"}},{id:"mc",la:{abbr:"Mc",name:"Marcus"},en:{abbr:"Mark",name:"Mark"},de:{abbr:"Mk",name:"Markus"},pl:{abbr:"Mk",name:"Ewangelia wg św. Marka"}},{id:"lc",la:{abbr:"Lc",name:"Lucas"},en:{abbr:"Luke",name:"Luke"},de:{abbr:"Lk",name:"Lukas"},pl:{abbr:"Łk",name:"Ewangelia wg św. Łukasza"}},{id:"io",la:{abbr:"Io",name:"Ioannes"},en:{abbr:"John",name:"John"},de:{abbr:"Joh",name:"Johannes"},pl:{abbr:"J",name:"Ewangelia wg św. Jana"}},{id:"act",la:{abbr:"Act",name:"Actus Apostolorum"},en:{abbr:"Acts",name:"Acts"},de:{abbr:"Apg",name:"Apostelgeschichte"},pl:{abbr:"Dz",name:"Dzieje Apostolskie"}},{id:"rom",la:{abbr:"Rom",name:"ad Romanos"},en:{abbr:"Rom",name:"Romans"},de:{abbr:"Röm",name:"Römer"},pl:{abbr:"Rz",name:"List do Rzymian"}},{id:"1cor",la:{abbr:"1 Cor",name:"I ad Corinthios"},en:{abbr:"1 Cor",name:"1 Corinthians"},de:{abbr:"1 Kor",name:"1 Korinther"},pl:{abbr:"1 Kor",name:"1 List do Koryntian"}},{id:"2cor",la:{abbr:"2 Cor",name:"II ad Corinthios"},en:{abbr:"2 Cor",name:"2 Corinthians"},de:{abbr:"2 Kor",name:"2 Korinther"},pl:{abbr:"2 Kor",name:"2 List do Koryntian"}},{id:"gal",la:{abbr:"Gal",name:"ad Galatas"},en:{abbr:"Gal",name:"Galatians"},de:{abbr:"Gal",name:"Galater"},pl:{abbr:"Ga",name:"List do Galatów"}},{id:"eph",la:{abbr:"Eph",name:"ad Ephesios"},en:{abbr:"Eph",name:"Ephesians"},de:{abbr:"Eph",name:"Epheser"},pl:{abbr:"Ef",name:"List do Efezjan"}},{id:"phil",la:{abbr:"Phil",name:"ad Philippenses"},en:{abbr:"Phil",name:"Philippians"},de:{abbr:"Phil",name:"Philipper"},pl:{abbr:"Flp",name:"List do Filipian"}},{id:"col",la:{abbr:"Col",name:"ad Colossenses"},en:{abbr:"Col",name:"Colossians"},de:{abbr:"Kol",name:"Kolosser"},pl:{abbr:"Kol",name:"List do Kolosan"}},{id:"1thess",la:{abbr:"1 Thess",name:"I ad Thessalonicenses"},en:{abbr:"1 Thess",name:"1 Thessalonians"},de:{abbr:"1 Thess",name:"1 Thessalonicher"},pl:{abbr:"1 Tes",name:"1 List do Tesaloniczan"}},{id:"2thess",la:{abbr:"2 Thess",name:"II ad Thessalonicenses"},en:{abbr:"2 Thess",name:"2 Thessalonians"},de:{abbr:"2 Thess",name:"2 Thessalonicher"},pl:{abbr:"2 Tes",name:"2 List do Tesaloniczan"}},{id:"1tim",la:{abbr:"1 Tim",name:"I ad Timotheum"},en:{abbr:"1 Tim",name:"1 Timothy"},de:{abbr:"1 Tim",name:"1 Timotheus"},pl:{abbr:"1 Tm",name:"1 List do Tymoteusza"}},{id:"2tim",la:{abbr:"2 Tim",name:"II ad Timotheum"},en:{abbr:"2 Tim",name:"2 Timothy"},de:{abbr:"2 Tim",name:"2 Timotheus"},pl:{abbr:"2 Tm",name:"2 List do Tymoteusza"}},{id:"tit",la:{abbr:"Tit",name:"ad Titum"},en:{abbr:"Titus",name:"Titus"},de:{abbr:"Tit",name:"Titus"},pl:{abbr:"Tt",name:"List do Tytusa"}},{id:"phlm",la:{abbr:"Phlm",name:"ad Philemonem"},en:{abbr:"Phlm",name:"Philemon"},de:{abbr:"Phlm",name:"Philemon"},pl:{abbr:"Flm",name:"List do Filemona"}},{id:"heb",la:{abbr:"Heb",name:"ad Hebraeos"},en:{abbr:"Heb",name:"Hebrews"},de:{abbr:"Hebr",name:"Hebräer"},pl:{abbr:"Hbr",name:"List do Hebrajczyków"}},{id:"iac",la:{abbr:"Iac",name:"Iacobi"},en:{abbr:"Jas",name:"James"},de:{abbr:"Jak",name:"Jakobus"},pl:{abbr:"Jk",name:"List św. Jakuba"}},{id:"1pet",la:{abbr:"1 Pet",name:"I Petri"},en:{abbr:"1 Pet",name:"1 Peter"},de:{abbr:"1 Petr",name:"1 Petrus"},pl:{abbr:"1 P",name:"1 List św. Piotra"}},{id:"2pet",la:{abbr:"2 Pet",name:"II Petri"},en:{abbr:"2 Pet",name:"2 Peter"},de:{abbr:"2 Petr",name:"2 Petrus"},pl:{abbr:"2 P",name:"2 List św. Piotra"}},{id:"1io",la:{abbr:"1 Io",name:"I Ioannis"},en:{abbr:"1 John",name:"1 John"},de:{abbr:"1 Joh",name:"1 Johannes"},pl:{abbr:"1 J",name:"1 List św. Jana"}},{id:"2io",la:{abbr:"2 Io",name:"II Ioannis"},en:{abbr:"2 John",name:"2 John"},de:{abbr:"2 Joh",name:"2 Johannes"},pl:{abbr:"2 J",name:"2 List św. Jana"}},{id:"3io",la:{abbr:"3 Io",name:"III Ioannis"},en:{abbr:"3 John",name:"3 John"},de:{abbr:"3 Joh",name:"3 Johannes"},pl:{abbr:"3 J",name:"3 List św. Jana"}},{id:"iud",la:{abbr:"Iud",name:"Iudae"},en:{abbr:"Jude",name:"Jude"},de:{abbr:"Jud",name:"Judas"},pl:{abbr:"Jud",name:"List św. Judy"}},{id:"apoc",la:{abbr:"Apoc",name:"Apocalypsis Ioannis"},en:{abbr:"Rev",name:"Revelation"},de:{abbr:"Offb",name:"Offenbarung"},pl:{abbr:"Ap",name:"Apokalipsa św. Jana"}}],os=8;function ls({libraryId:t,copy:n,language:s,sourceKindOptions:i,value:r,onChange:u,labels:m}){const[k,j]=a.useState(!1),[M,o]=a.useState(-1),x=a.useMemo(()=>{const w=s;return rs.map(S=>{var g;const D=(S==null?void 0:S[w])??(S==null?void 0:S.en)??(S==null?void 0:S.la);return{label:`${D.abbr} — ${D.name}`,latin:((g=S==null?void 0:S.la)==null?void 0:g.abbr)??D.abbr}})},[s]),l=(w,S=!1)=>{const D=w.trim().toLowerCase();return D?x.filter(f=>f.label.toLowerCase().includes(D)).slice(0,os):S?x.slice(0,os):[]},d=(w,S)=>{const D=w.trim().toLowerCase();if(!D)return null;const f=rs;for(const g of f){const le=g==null?void 0:g.la,P=(g==null?void 0:g[S])??(g==null?void 0:g.en)??le,p=(P==null?void 0:P.abbr)??"",V=(P==null?void 0:P.name)??"";if(p.toLowerCase()===D||V.toLowerCase()===D||`${p} — ${V}`.toLowerCase()===D)return{book:g,entry:P,la:le}}return null};a.useEffect(()=>{if(r.sourceKind==="bible"&&r.locatorValue&&!k){const w=d(r.locatorValue,s);if(w){const S=`${w.entry.abbr} — ${w.entry.name}`;S!==r.bibleBookDisplay&&u({...r,bibleBookDisplay:S})}}},[s,r,k,u]);const v=w=>u({...r,...w});return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:m.sourceKindLabel}),e.jsx("select",{value:r.sourceKind,onChange:w=>v({sourceKind:w.target.value,churchDocument:null,bookMedia:null,work:null,locatorValue:"",locatorAux:"",bibleBookDisplay:""}),children:i.map(w=>e.jsx("option",{value:w.value,children:w.label},w.value))})]}),r.sourceKind==="bible"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-lookup full",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:m.bibleBookLabel}),e.jsx("input",{type:"text",value:r.bibleBookDisplay,onChange:w=>{const S=w.target.value;v({bibleBookDisplay:S,locatorValue:""}),j(!0),o(-1)},onKeyDown:w=>{var D;const S=l(r.bibleBookDisplay);if(S.length){if(w.key==="ArrowDown")w.preventDefault(),o(f=>Math.min(f+1,S.length-1));else if(w.key==="ArrowUp")w.preventDefault(),o(f=>Math.max(f-1,0));else if((w.key==="Enter"||w.key==="Tab")&&M>=0&&S[M]){const f=S[M],g=d(f.label,s);if(!g)return;v({bibleBookDisplay:f.label,locatorValue:((D=g.la)==null?void 0:D.abbr)??r.locatorValue}),j(!1)}}},onFocus:()=>j(!0),onBlur:()=>window.setTimeout(()=>j(!1),100),placeholder:m.bibleBookPlaceholder})]}),k&&l(r.bibleBookDisplay,!0).length>0&&e.jsx("div",{className:"cogita-lookup-results",children:l(r.bibleBookDisplay,!0).map((w,S)=>e.jsx("button",{type:"button",className:"cogita-lookup-option","data-active":S===M,tabIndex:-1,onMouseDown:()=>{var f;const D=d(w.label,s);D&&v({bibleBookDisplay:w.label,locatorValue:((f=D.la)==null?void 0:f.abbr)??r.locatorValue})},children:e.jsx("strong",{children:w.label})},w.latin))})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:m.bibleRestLabel}),e.jsx("input",{type:"text",value:r.locatorAux,onChange:w=>v({locatorAux:w.target.value}),placeholder:m.bibleRestPlaceholder})]})]}),r.sourceKind==="website"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceUrlLabel}),e.jsx("input",{type:"text",value:r.sourceUrl,onChange:w=>v({sourceUrl:w.target.value}),placeholder:n.cogita.library.add.info.sourceUrlPlaceholder})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceAccessedDateLabel}),e.jsx("input",{type:"text",value:r.sourceAccessedDate,onChange:w=>v({sourceAccessedDate:w.target.value}),placeholder:n.cogita.library.add.info.sourceAccessedDatePlaceholder})]})]}),r.sourceKind==="number_document"&&e.jsxs(e.Fragment,{children:[e.jsx(ea,{libraryId:t,infoType:"work",label:m.churchDocumentLabel,placeholder:m.churchDocumentPlaceholder,value:r.churchDocument,onChange:w=>v({churchDocument:w}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:m.locatorLabel}),e.jsx("input",{type:"text",value:r.locatorValue,onChange:w=>v({locatorValue:w.target.value}),placeholder:m.locatorPlaceholder})]})]}),r.sourceKind==="work"&&e.jsx(ea,{libraryId:t,infoType:"work",label:m.workLabel,placeholder:m.workPlaceholder,value:r.work,onChange:w=>v({work:w}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),r.sourceKind==="book"&&e.jsxs(e.Fragment,{children:[e.jsx(ea,{libraryId:t,infoType:"media",label:m.bookLabel,placeholder:m.bookPlaceholder,value:r.bookMedia,onChange:w=>v({bookMedia:w}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.media),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:m.locatorLabel}),e.jsx("input",{type:"text",value:r.locatorValue,onChange:w=>v({locatorValue:w.target.value}),placeholder:m.locatorPlaceholder})]})]}),r.sourceKind!=="website"&&r.sourceKind!=="bible"&&r.sourceKind!=="book"&&r.sourceKind!=="number_document"&&e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:m.locatorLabel}),e.jsx("input",{type:"text",value:r.locatorValue,onChange:w=>v({locatorValue:w.target.value}),placeholder:m.locatorPlaceholder})]})]})}const cs=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}];function Ea(){return{sourceKind:"string",locatorValue:"",locatorAux:"",bibleBookDisplay:"",sourceUrl:"",sourceAccessedDate:"",churchDocument:null,bookMedia:null,work:null}}function ds(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function us(t,n){if(!t||typeof t!="object")return n;const s=t,i=[s.label,s.name,s.title,s.text,s.orcid,s.email,s.number];for(const r of i)if(typeof r=="string"&&r.trim())return r.trim();return n}function hs(t,n){var i;if(!(t instanceof Ls))return n;const s=(i=t.message)==null?void 0:i.trim();if(!s)return n;try{const r=JSON.parse(s);if(typeof r.error=="string"&&r.error.trim())return r.error.trim()}catch{}return s}function Yi(t){const n=t.trim();if(!n)return null;try{const s=JSON.parse(n);return s&&typeof s=="object"&&!Array.isArray(s)?s:null}catch{return null}}function ra(t,n){const s=t==null?void 0:t[n];return typeof s=="string"?s:""}function Qi(t,n){return n?t==="book"&&n.infoType==="media"?{bookMedia:n}:t==="work"&&n.infoType==="work"?{work:n}:t==="number_document"&&n.infoType==="work"?{churchDocument:n}:{}:{}}function Xi(t,n){const s=Ea(),i=(t.sourceKind??"").trim()||s.sourceKind,r=t.locator??"",u=Yi(r);let m="",k="",j="",M="",o="";return i==="website"?(M=ra(u,"url"),o=ra(u,"accessedDate"),m=ra(u,"value")):i==="bible"?(m=ra(u,"book")||r.trim(),k=ra(u,"passage")||ra(u,"rest"),j=ra(u,"bookDisplay")):u?(m=ra(u,"value")||ra(u,"locator"),k=ra(u,"aux")):m=r,{...s,sourceKind:i,locatorValue:m,locatorAux:k,bibleBookDisplay:j,sourceUrl:M,sourceAccessedDate:o,...Qi(i,n)}}function xn(t){return t.sourceKind==="book"?t.bookMedia:t.sourceKind==="work"?t.work:t.sourceKind==="number_document"?t.churchDocument:null}function vn(t){const n=t.locatorValue.trim(),s=t.locatorAux.trim(),i=t.sourceUrl.trim(),r=t.sourceAccessedDate.trim();switch(t.sourceKind){case"website":return{url:i,accessedDate:r};case"bible":return{book:n,bookDisplay:t.bibleBookDisplay.trim(),passage:s};case"book":case"work":case"number_document":return s?{value:n,aux:s}:n;default:return s?{value:n,aux:s}:n}}function gs(t){var r,u,m;const n=t.locatorValue.trim(),s=t.locatorAux.trim(),i=[n,s].filter(Boolean).join(" ");switch(t.sourceKind){case"website":return t.sourceUrl.trim()||"website";case"bible":return i||"bible";case"book":return[(r=t.bookMedia)==null?void 0:r.label,i].filter(Boolean).join(" · ")||"book";case"work":return[(u=t.work)==null?void 0:u.label,i].filter(Boolean).join(" · ")||"work";case"number_document":return[(m=t.churchDocument)==null?void 0:m.label,i].filter(Boolean).join(" · ")||"number_document";default:return i||t.sourceKind||"source"}}function ms(t){return t.sourceKind.trim()?t.sourceKind==="website"?!!t.sourceUrl.trim():t.sourceKind==="bible"?!!(t.locatorValue.trim()&&t.locatorAux.trim()):t.sourceKind==="book"?!!t.bookMedia:t.sourceKind==="work"?!!t.work:t.sourceKind==="number_document"?!!(t.churchDocument&&t.locatorValue.trim()):!!t.locatorValue.trim():!1}function Zi({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o,editInfoId:x}){var ot,_e,je;const{libraryName:l}=ua(o),d=!!x,[v,w]=a.useState([]),[S,D]=a.useState("word"),[f,g]=a.useState({}),[le,P]=a.useState({}),[p,V]=a.useState({}),[N,W]=a.useState({}),[R,I]=a.useState(null),[re,ce]=a.useState("idle"),[xe,Te]=a.useState(Ea),[Z,C]=a.useState({}),[Ie,B]=a.useState({}),[ee,q]=a.useState({}),[fe,X]=a.useState(null),de=a.useMemo(()=>v.find(J=>J.infoType===S),[S,v]),ye=a.useMemo(()=>v.find(J=>J.infoType==="source"),[v]),Pe=a.useMemo(()=>v.map(J=>({value:J.infoType,label:at(t,J.infoType)})),[t,v]);a.useEffect(()=>{let J=!1;return ei({libraryId:o}).then(Le=>{var oe;if(!J&&(w(Le),!d)){const _=(oe=Le[0])==null?void 0:oe.infoType;_&&D(_)}}).catch(()=>{J||w([])}),()=>{J=!0}},[d,o]),a.useEffect(()=>{if(d||!de)return;const J={},Le={},oe={},_={};for(const me of de.payloadFields)J[me.key]="";for(const me of de.linkFields)me.multiple?oe[me.key]=[]:Le[me.key]=null,me.targetTypes.length>0&&(_[me.key]=me.targetTypes[0]);g(J),P(Le),V(oe),W(_)},[de==null?void 0:de.infoType,d]),a.useEffect(()=>{if(!d||!x||v.length===0)return;let J=!1;return ce("loading"),I(null),(async()=>{const oe=await da({libraryId:o,infoId:x});if(J)return;const _=oe.infoType;D(_);const me=v.find(K=>K.infoType===_);if(!me){ce("idle");return}const Ge=oe.payload??{},$={};for(const K of me.payloadFields)$[K.key]=ds(Ge[K.key]);g($);const A=oe.links??{}??{},Y={},se={},T={},U=[];for(const K of me.linkFields){K.targetTypes.length>0&&(T[K.key]=K.targetTypes[0]);const H=A[K.key];if(K.multiple){const ie=Array.isArray(H)?H.filter(ke=>typeof ke=="string"):[];se[K.key]=[];for(const ke of ie)U.push(da({libraryId:o,infoId:ke}).then(Ae=>{if(J)return;const De={id:ke,infoType:Ae.infoType,label:us(Ae.payload,ke)};T[K.key]=De.infoType,se[K.key]=[...se[K.key],De]}).catch(()=>{}))}else{const ie=typeof H=="string"?H:null;Y[K.key]=null,ie&&U.push(da({libraryId:o,infoId:ie}).then(ke=>{if(J)return;const Ae={id:ie,infoType:ke.infoType,label:us(ke.payload,ie)};T[K.key]=Ae.infoType,Y[K.key]=Ae}).catch(()=>{}))}}await Promise.all(U),!J&&(P(Y),V(se),W(T),ce("idle"))})().catch(()=>{J||(I("Failed to load info details."),ce("idle"))}),()=>{J=!0}},[x,d,o,v]),a.useEffect(()=>{S==="source"&&Te(Xi(f,le.resource??null))},[S,f.sourceKind,f.locator,(ot=le.resource)==null?void 0:ot.id,(_e=le.resource)==null?void 0:_e.infoType,(je=le.resource)==null?void 0:je.label]);const Ve=J=>{var me,Ge;const Le=((me=ye==null?void 0:ye.payloadFields.find($=>$.key==="sourceKind"))==null?void 0:me.keepOnCreate)??!1,oe=((Ge=ye==null?void 0:ye.linkFields.find($=>$.key==="resource"))==null?void 0:Ge.keepOnCreate)??!1,_=Ea();return _.sourceKind=Le?J.sourceKind:_.sourceKind,oe&&(_.work=J.work,_.bookMedia=J.bookMedia,_.churchDocument=J.churchDocument),Le&&J.sourceKind==="bible"&&(_.locatorValue=J.locatorValue,_.bibleBookDisplay=J.bibleBookDisplay),Le&&J.sourceKind==="website"&&(_.sourceUrl=J.sourceUrl,_.sourceAccessedDate=J.sourceAccessedDate),_},Ce=a.useMemo(()=>({sourceKindLabel:t.cogita.library.add.info.sourceKindLabel,bibleBookLabel:t.cogita.library.add.info.sourceBibleBookLabel,bibleBookPlaceholder:t.cogita.library.add.info.sourceBibleBookPlaceholder,bibleRestLabel:t.cogita.library.add.info.sourceBibleRestLabel,bibleRestPlaceholder:t.cogita.library.add.info.sourceBibleRestPlaceholder,churchDocumentLabel:t.cogita.library.add.info.sourceResourceLabel,churchDocumentPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,workLabel:t.cogita.library.add.info.sourceResourceLabel,workPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,bookLabel:t.cogita.library.add.info.sourceResourceLabel,bookPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,locatorLabel:t.cogita.library.list.typeFilterLocator,locatorPlaceholder:t.cogita.library.list.typeFilterLocator}),[t]),He=async J=>{const Le=Ie[J]??Ea();if(!ms(Le)){q(oe=>({...oe,[J]:t.cogita.library.add.info.referenceMissingSource}));return}X(J),q(oe=>({...oe,[J]:null}));try{const oe=xn(Le),_=oe?{resource:oe.id}:{},me={label:gs(Le),sourceKind:Le.sourceKind.trim(),locator:vn(Le)},$={id:(await Rn({libraryId:o,infoType:"source",payload:me,links:_})).infoId,infoType:"source",label:me.label};if(V(A=>{const Y=A[J]??[];return Y.some(se=>se.id===$.id)?A:{...A,[J]:[...Y,$]}}),d&&x){const A=await da({libraryId:o,infoId:x}),Y=A.links&&typeof A.links=="object"?{...A.links}:{},se=Y[J],T=Array.isArray(se)?se.filter(U=>typeof U=="string"):typeof se=="string"?[se]:[];T.includes($.id)||(Y[J]=[...T,$.id],await Gn({libraryId:o,infoId:x,payload:A.payload,links:Y}))}B(A=>({...A,[J]:Ve(Le)})),q(A=>({...A,[J]:null}))}catch(oe){q(_=>({..._,[J]:hs(oe,t.cogita.library.lookup.createFailed)}))}finally{X(oe=>oe===J?null:oe)}},Ze=async()=>{var oe;if(!de)return;const J={};for(const _ of de.payloadFields){if(S==="source"&&(_.key==="sourceKind"||_.key==="locator"))continue;const me=(f[_.key]??"").trim();if(!me){if(_.required){I(`Field '${_.label}' is required.`);return}continue}if(_.inputType==="json")try{J[_.key]=JSON.parse(me)}catch{I(`Field '${_.label}' must be valid JSON.`);return}else J[_.key]=me}const Le={};for(const _ of de.linkFields)if(!(S==="source"&&_.key==="resource"))if(_.multiple){const me=(p[_.key]??[]).map(Ge=>Ge.id);if(_.required&&me.length===0){I(`Link '${_.label}' is required.`);return}me.length>0&&(Le[_.key]=me)}else{const me=((oe=le[_.key])==null?void 0:oe.id)??null;if(_.required&&!me){I(`Link '${_.label}' is required.`);return}me&&(Le[_.key]=me)}if(S==="source"){if(!ms(xe)){I(t.cogita.library.add.info.referenceMissingSource);return}const _=xe.sourceKind.trim();J.sourceKind=_,J.locator=vn(xe),(typeof J.label!="string"||!J.label.trim())&&(J.label=gs(xe));const me=xn(xe);me&&(Le.resource=me.id)}ce("saving"),I(null);try{if(d&&x)await Gn({libraryId:o,infoId:x,payload:J,links:Le}),I("Info updated.");else{await Rn({libraryId:o,infoType:S,payload:J,links:Le}),I("Info saved.");const _={};for(const $ of de.payloadFields)_[$.key]=$.keepOnCreate?f[$.key]??"":"";g(_);const me={},Ge={};for(const $ of de.linkFields)$.multiple?Ge[$.key]=$.keepOnCreate?p[$.key]??[]:[]:me[$.key]=$.keepOnCreate?le[$.key]??null:null;P($=>({...$,...me})),V($=>({...$,...Ge})),S==="source"&&Te($=>{const A=Ve($),Y=xn(A);return g(se=>({...se,sourceKind:A.sourceKind,locator:ds(vn(A))})),P(se=>({...se,resource:Y})),Y&&W(se=>({...se,resource:Y.infoType})),A})}}catch(_){I(hs(_,"Failed to save info."))}finally{ce("idle")}},Me=J=>{const Le=f[J.key]??"",oe=J.inputType==="textarea"||J.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:J.label}),oe?e.jsx("textarea",{rows:J.inputType==="json"?8:4,value:Le,onChange:_=>g(me=>({...me,[J.key]:_.target.value})),placeholder:J.key}):e.jsx("input",{type:"text",value:Le,onChange:_=>g(me=>({...me,[J.key]:_.target.value})),placeholder:J.key})]},`payload:${J.key}`)},We=J=>{const Le=N[J.key]??J.targetTypes[0],oe=J.key==="references"&&J.multiple&&J.targetTypes.includes("source"),_=Ie[J.key]??Ea(),me=Z[J.key]??!1,Ge=ee[J.key];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:J.label}),J.targetTypes.length>1?e.jsx("select",{value:Le,onChange:$=>W(A=>({...A,[J.key]:$.target.value})),children:J.targetTypes.map($=>e.jsx("option",{value:$,children:at(t,$)},`${J.key}:${$}`))}):null,J.multiple?e.jsx(ea,{libraryId:o,infoType:Le,label:J.label,placeholder:J.key,multiple:!0,values:p[J.key]??[],onChangeMultiple:$=>V(A=>({...A,[J.key]:$})),allowCreate:!oe,searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(ea,{libraryId:o,infoType:Le,label:J.label,placeholder:J.key,value:le[J.key]??null,onChange:$=>P(A=>({...A,[J.key]:$})),searchFailedText:"Search failed",createFailedText:"Create failed"}),oe?e.jsxs("div",{children:[e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:me,onChange:$=>C(A=>({...A,[J.key]:$.target.checked}))}),e.jsx("span",{children:t.cogita.library.add.info.referenceToggle})]}),me?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(ls,{libraryId:o,copy:t,language:j,sourceKindOptions:[...cs],value:_,onChange:$=>B(A=>({...A,[J.key]:$})),labels:Ce}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>He(J.key),disabled:fe===J.key,children:fe===J.key?t.cogita.library.lookup.saving:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.source)})}),Ge?e.jsx("p",{className:"cogita-library-subtitle",children:Ge}):null]}):null]}):null]},`link:${J.key}`)},rt=()=>e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(ls,{libraryId:o,copy:t,language:j,sourceKindOptions:[...cs],value:xe,onChange:Te,labels:Ce})]});return e.jsx(Kt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:d?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${o}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[d?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:S,onChange:J=>D(J.target.value),children:Pe.map(J=>e.jsx("option",{value:J.value,children:J.label},J.value))})]}),re==="loading"&&d?e.jsx("p",{children:"Loading..."}):null,de&&!(re==="loading"&&d)?e.jsxs("div",{className:"cogita-form-grid",children:[de.payloadFields.filter(J=>!(S==="source"&&(J.key==="sourceKind"||J.key==="locator"))).map(Me),S==="source"?rt():null,de.linkFields.filter(J=>!(S==="source"&&J.key==="resource")).map(We)]}):re==="loading"&&d?null:e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:Ze,disabled:re==="saving"||!de,children:re==="saving"?"Saving...":d?"Update info":"Create info"})}),R?e.jsx("p",{className:"cogita-library-subtitle",children:R}):null]})})})]})})}const ps=t=>/\s/.test(t),Ga=t=>/[\p{L}\p{N}]/u.test(t),fs=(t,n)=>{const s=n>0?t[n-1]:"",i=n<t.length?t[n]:"";if(!s||!i)return 0;const r=ps(s),u=ps(i);if(r||u)return 3;const m=Ga(s),k=Ga(i);return m!==k?2:!m&&!k?1:0},wn=(t,n,s,i,r)=>{const u=Math.max(i-n,s-i);for(let m=0;m<=u;m+=1){const k=i-m;if(k>=n&&k<=s&&fs(t,k)>=r)return k;const j=i+m;if(j>=n&&j<=s&&fs(t,j)>=r)return j}return null},jn=(t,n)=>{const s=n>0?t[n-1]:"",i=n<t.length?t[n]:"";return!s||!i?!0:Ga(s)!==Ga(i)},er=(t,n,s,i)=>{const r=s-n,u=n+i,m=s-i;if(r<=i*2||m<=u)return null;const k=Math.floor((n+s)/2),j=wn(t,u,m,k,3);if(j!==null&&jn(t,j))return j;const M=wn(t,u,m,k,2);if(M!==null&&jn(t,M))return M;const o=wn(t,u,m,k,1);return o!==null&&jn(t,o)?o:null},ja=(t,n)=>{const s=Math.max(1,7),i=Math.max(s,13),r={},u=(j,M,o,x,l)=>{const d=String(x),v={id:d,start:j,end:M,text:t.slice(j,M),depth:o,index:x,parentId:l};if(r[d]=v,M-j>i){let S=er(t,j,M,s);if(S!==null&&S>j&&S<M){const D=u(j,S,o+1,x*2+1,d),f=u(S,M,o+1,x*2+2,d);v.leftId=D.id,v.rightId=f.id}}return v},m=u(0,t.length,0,0),k=Object.values(r).sort((j,M)=>M.depth-j.depth||j.start-M.start).map(j=>j.id);return{text:t,rootId:m.id,nodes:r,order:k}},Ma=(t,n,s,i,r,u,m)=>{const k=u==="reverse"?t.order.slice().sort((j,M)=>t.nodes[M].start-t.nodes[j].start||t.nodes[M].depth-t.nodes[j].depth):t.order;for(const j of k){if(m&&j===m||n.has(j))continue;const M=t.nodes[j];if(M){if(r&&(M.leftId||M.rightId)){const o=M.leftId?s[M.leftId]??0:i,x=M.rightId?s[M.rightId]??0:i;if((o+x)/2<i)continue}return M}}return null},zn=(t,n)=>({before:t.slice(0,n.start),fragment:t.slice(n.start,n.end),after:t.slice(n.end)});function tr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o}){const x=`/#/cogita/library/${o}`,[l,d,v]=En([]),[w,S,D]=Pn([]),[f,g]=a.useState(null),[le,P]=a.useState(null),[p,V]=a.useState(null),[N,W]=a.useState(null),R=a.useMemo(()=>l.find(C=>C.id===f)??null,[l,f]);a.useEffect(()=>{let C=!0;return ti({libraryId:o}).then(Ie=>{if(!C)return;const B=Ie.nodes.map(ee=>{var q,fe,X;return{id:ee.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:ee.payload&&typeof ee.payload=="object"&&"label"in ee.payload?String(ee.payload.label):"Item",nodeType:ee.nodeType,itemType:((q=ee.payload)==null?void 0:q.itemType)??"info",itemId:((fe=ee.payload)==null?void 0:fe.itemId)??null,infoType:((X=ee.payload)==null?void 0:X.infoType)??null}}});d(B),S(Ie.edges.map(ee=>({id:ee.edgeId,source:ee.fromNodeId,target:ee.toNodeId})))}).catch(()=>{C&&(d([]),S([]))}),()=>{C=!1}},[o]),a.useEffect(()=>{ai({libraryId:o}).then(P).catch(()=>P(null))},[o,l,w]);const I=a.useCallback(C=>{S(Ie=>Kn(C,Ie))},[]),re=()=>{const C=crypto.randomUUID();d(Ie=>[...Ie,{id:C,type:"default",position:{x:140+Ie.length*40,y:120+Ie.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},ce=()=>{const C=crypto.randomUUID();d(Ie=>[...Ie,{id:C,type:"default",position:{x:180+Ie.length*40,y:160+Ie.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},xe=async()=>{V(null);try{const C=l.map(B=>({nodeId:B.id,nodeType:B.data.nodeType,payload:{itemType:B.data.itemType,itemId:B.data.itemId??null,label:B.data.label,infoType:B.data.infoType??null}})),Ie=w.map(B=>({edgeId:B.id,fromNodeId:B.source,toNodeId:B.target}));await ni({libraryId:o,nodes:C,edges:Ie}),V(t.cogita.library.graph.saveSuccess)}catch{V(t.cogita.library.graph.saveFail)}},Te=C=>{R&&d(Ie=>Ie.map(B=>B.id===R.id?{...B,data:{...B.data,itemId:(C==null?void 0:C.infoId)??null,itemType:"collection",infoType:"collection",label:(C==null?void 0:C.label)??t.cogita.library.infoTypes.collection}}:B))},Z=C=>{R&&d(Ie=>Ie.map(B=>B.id===R.id?{...B,data:{...B.data,itemId:(C==null?void 0:C.infoId)??null,itemType:"info",infoType:(C==null?void 0:C.infoType)??null,label:(C==null?void 0:C.label)??t.cogita.library.infoTypes.any}}:B))};return a.useEffect(()=>{if(!R||R.data.nodeType!=="info"||R.data.infoType!=="citation"||!R.data.itemId){W(null);return}let C=!0;return da({libraryId:o,infoId:R.data.itemId}).then(Ie=>{if(!C)return;const B=Ie.payload,ee=(B==null?void 0:B.text)??"";if(!ee){W(null);return}const q=ja(ee),fe=Object.values(q.nodes).sort((X,de)=>X.depth-de.depth||X.start-de.start).map(X=>({id:X.id,text:X.text,depth:X.depth}));W({title:(B==null?void 0:B.title)??R.data.label,fragments:fe})}).catch(()=>W(null)),()=>{C=!1}},[o,R]),e.jsx(Kt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:x,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:xe,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:re,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ce,children:t.cogita.library.actions.addInfo}),le?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(le.totalCollections))})}):null,p?e.jsx("p",{className:"cogita-help",children:p}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(sn,{nodes:l,edges:w,onNodesChange:v,onEdgesChange:D,onConnect:I,onNodeClick:(C,Ie)=>g(Ie.id),fitView:!0,children:[e.jsx(rn,{gap:18,size:1}),e.jsx(on,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),R?e.jsxs("div",{className:"cogita-graph-inspector",children:[R.data.nodeType==="collection"?e.jsx(ea,{libraryId:o,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:R.data.itemId?{id:R.data.itemId,label:R.data.label,infoType:"collection"}:null,onChange:Te,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(ea,{libraryId:o,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:R.data.itemId?{id:R.data.itemId,label:R.data.label,infoType:R.data.infoType??void 0}:null,onChange:Z,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),N?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:N.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:N.fragments.map(C=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:C.id}),e.jsx("span",{children:C.text})]},C.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function Bn({children:t,flashState:n,flashTick:s=0,feedbackToken:i,className:r}){const u=i??(n?`${n}-${s}`:"idle");return e.jsx("section",{className:r?`cogita-revision-card ${r}`:"cogita-revision-card","data-feedback":u,children:t})}function _n({copy:t,currentCard:n,currentTypeLabel:s,prompt:i,languages:r,answer:u,onAnswerChange:m,computedExpected:k,computedAnswers:j,onComputedAnswerChange:M,answerTemplate:o,outputVariables:x,variableValues:l,computedFieldFeedback:d,feedback:v,canAdvance:w,quoteContext:S,quotePlaceholder:D,onCheckAnswer:f,onSkip:g,onLanguageSelect:le,onMarkReviewed:P,onAdvance:p,showCorrectAnswer:V,setShowCorrectAnswer:N,onRevealCorrect:W,answerMask:R,expectedAnswer:I,hasExpectedAnswer:re,handleComputedKeyDown:ce,answerInputRef:xe,computedInputRefs:Te,scriptMode:Z,setScriptMode:C,matchPairs:Ie,matchLeftOrder:B,matchRightOrder:ee,matchSelection:q,matchActiveLeft:fe,matchActiveRight:X,matchFeedback:de,onMatchLeftSelect:ye,onMatchRightSelect:Pe,disableCheckAnswer:Ve=!1,hideSkipAction:Ce=!1,allowRevealBeforeCheck:He=!1,autoRevealAfterAnswer:Ze=!1,disableCheckAfterAnswer:Me=!1}){const We=a.useMemo(()=>{var De;const $=!o&&k.length===2?`The {${k[0].key}} is of type {${k[1].key}}`:null,A=o??$;if(!A)return null;const Y=new Map(k.map(ve=>[ve.key,ve.expected])),se=new Set,T=[],U=/\{([^}]+)\}/g;let K=0,H,ie=null;for(;(H=U.exec(A))!==null;){const ve=A.slice(K,H.index);ve&&T.push({type:"text",value:ve});const be=((De=H[1])==null?void 0:De.trim())??"",ue=be&&Y.has(be)?be:be&&x&&x[be]?x[be]:null;be&&se.add(be),ue&&se.add(ue),ue&&Y.has(ue)?(T.push({type:"input",value:ue}),ie||(ie=ue)):be&&l&&l[be]!==void 0?T.push({type:"text",value:l[be]}):T.push({type:"text",value:H[0]}),K=H.index+H[0].length}const ke=A.slice(K);return ke&&T.push({type:"text",value:ke}),k.filter(ve=>!se.has(ve.key)).length>0?null:{parts:T,expectedByKey:Y,firstInputKey:ie}},[o,k,x,l]),rt=()=>{if(!We)return null;const{parts:$,expectedByKey:A,firstInputKey:Y}=We;return e.jsx("div",{className:"cogita-revision-inline-answer",children:$.map((se,T)=>{var U,K;return se.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:se.value},`text-${T}`):e.jsx("input",{ref:H=>{Te.current[se.value]=H},autoFocus:se.value===Y,value:j[se.value]??"",onChange:H=>M(se.value,H.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":d[se.value]??(v==="correct"?"correct":v==="incorrect"?"incorrect":void 0),onKeyDown:H=>J(H)||ce(H),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((U=j[se.value])==null?void 0:U.length)??0,((K=A.get(se.value))==null?void 0:K.length)??6)}ch`}},`input-${se.value}-${T}`)})})},ot=a.useMemo(()=>{const $=new Map;return(Ie??[]).forEach(A=>$.set(A.leftId,A)),$},[Ie]),_e=a.useMemo(()=>{const $=new Map;return(Ie??[]).forEach(A=>$.set(A.rightId,A)),$},[Ie]);a.useEffect(()=>{var T;if(n.cardType!=="info"||n.infoType!=="computed"||k.length===0)return;const $=typeof document<"u"?document.activeElement:null;if($&&($.tagName==="INPUT"||$.tagName==="TEXTAREA"))return;const A=(We==null?void 0:We.firstInputKey)??((T=k[0])==null?void 0:T.key);if(!A)return;const Y=Te.current[A];if(!Y)return;const se=requestAnimationFrame(()=>{Y.focus()});return()=>cancelAnimationFrame(se)},[n,k,We]);const je=(()=>{const $=[I??"",...k.map(se=>se.expected??"")].join(""),A=[u,...Object.values(j)].join(""),Y=`${$}${A}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(Y)})(),J=$=>$.ctrlKey&&($.key==="^"||$.key==="6")?($.preventDefault(),C(A=>A==="super"?null:"super"),!0):$.ctrlKey&&($.key==="_"||$.key==="-")?($.preventDefault(),C(A=>A==="sub"?null:"sub"),!0):!1,Le=()=>{if(!I||!R)return I??"";const $=I.split(""),A=Array.from(R),Y=A.length>0?A.reduce((se,T)=>se+T,0)/A.length:127;return $.map((se,T)=>{const U=A[T]??Y,K=Math.max(0,Math.min(255,Math.round(U)));let H=255,ie=0;return K<=127?ie=Math.round(K/127*255):(ie=255,H=Math.round(255*(1-(K-127)/128))),e.jsx("span",{style:{color:`rgb(${H}, ${ie}, 0)`},children:se},`mask-${T}`)})},oe=n.cardType==="info"&&n.infoType==="citation"?(S==null?void 0:S.title)||n.label:n.description,_=V||Ze&&v!==null,me=Ve||Me&&(v!==null||_),Ge=re&&(He||v==="incorrect"||_);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[s?e.jsx("span",{children:s}):null,e.jsx("strong",{children:oe})]}),n.cardType==="vocab"&&n.checkType==="translation-match"&&Ie?e.jsxs("div",{className:"cogita-revision-body",children:[i?e.jsx("h2",{children:i}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(B??[]).map($=>{const A=ot.get($);if(!A)return null;const Y=(q==null?void 0:q[$])??null,se=(de==null?void 0:de[$])??null,T=fe===$;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":T,"data-state":se??void 0,"data-locked":Y?"true":void 0,onClick:()=>ye==null?void 0:ye($),children:[e.jsx("span",{children:A.leftLabel}),Y&&V?e.jsx("em",{children:"✓"}):null]},$)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(ee??[]).map($=>{const A=_e.get($);if(!A)return null;const Y=Object.values(q??{}).includes($),se=X===$;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":Y||se,"data-locked":Y?"true":void 0,onClick:()=>Pe==null?void 0:Pe($),children:e.jsx("span",{children:A.rightLabel})},$)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:f,disabled:n.checkType==="translation-match"||me,children:t.cogita.library.revision.checkAnswer}),Ce?null:e.jsx("button",{type:"button",className:"ghost",onClick:g,children:t.cogita.library.revision.skip})]})]}):n.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:xe,value:u,onChange:$=>m($.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:$=>{if($.key==="Enter")if($.preventDefault(),$.stopPropagation(),w)p();else{if(me)return;f()}}})]}),je?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":Z==="super",onClick:()=>C($=>$==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":Z==="sub",onClick:()=>C($=>$==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:f,disabled:me,children:t.cogita.library.revision.checkAnswer}),Ce?null:e.jsx("button",{type:"button",className:"ghost",onClick:g,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[n.label?e.jsx("p",{className:"cogita-revision-hint",children:n.label}):null,o?null:e.jsx(si,{value:i??"",mode:"auto"}),k.length>0?(()=>{const $=rt();return $?e.jsx("div",{className:"cogita-inline-answer-wrap",children:$}):e.jsx("div",{className:"cogita-form-grid",children:k.map((A,Y)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:A.key}),e.jsx("textarea",{ref:se=>{Te.current[A.key]=se},autoFocus:Y===0,value:j[A.key]??"",onChange:se=>M(A.key,se.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":d[A.key]??(v==="correct"?"correct":v==="incorrect"?"incorrect":void 0),onKeyDown:se=>J(se)||ce(se)})]},A.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:xe,value:u,onChange:$=>m($.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:$=>{if(!J($)&&$.key==="Enter")if($.preventDefault(),$.stopPropagation(),w)p();else{if(me)return;f()}}})]})}),je?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":Z==="super",onClick:()=>C($=>$==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":Z==="sub",onClick:()=>C($=>$==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:f,disabled:me,children:t.cogita.library.revision.checkAnswer}),Ce?null:e.jsx("button",{type:"button",className:"ghost",onClick:g,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="citation"&&S?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(S.completed)).replace("{total}",String(S.total))}),e.jsx("p",{className:"cogita-quote-text",children:S.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:xe,value:u,onChange:$=>m($.target.value),placeholder:D??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:$=>{if($.key==="Enter")if($.preventDefault(),$.stopPropagation(),w)p();else{if(me)return;f()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:S.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:f,disabled:me,children:t.cogita.library.revision.checkAnswer}),Ce?null:e.jsx("button",{type:"button",className:"ghost",onClick:g,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:r.length?r.map($=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>le($.label),children:$.label},$.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:g,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:P,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:g,children:t.cogita.library.revision.skip})]})]}),v&&e.jsx("div",{className:"cogita-revision-feedback","data-state":v,children:v==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),Ge?e.jsxs("div",{className:"cogita-revision-reveal",children:[_?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>N($=>{const A=!$;return A&&W(),A}),children:t.cogita.library.revision.showAnswer}),_?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),k.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[k.map($=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:$.key}),e.jsx("span",{children:$.expected})]},$.key)),I?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:I})]}):null]}):e.jsx("p",{children:R?Le():I})]}):null]}):null,w?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:p,children:t.cogita.library.revision.nextQuestion})}):null]})}const bs={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},ar=(t,n)=>{const s=Math.max(t.length,n.length,1),i=Math.abs(t.length-n.length);return Math.max(0,1-i/s)},nr=(t,n)=>{const s=new Uint8Array(t.length),i=ar(t,n);for(let r=0;r<t.length;r+=1){const u=t[r]===(n[r]??"")?128:0,m=t.length-1-r,k=n.length-1-r,j=t[m]===(n[k]??"")?127:0,M=Math.round((u+j)*i);s[r]=Math.max(0,Math.min(255,M))}return s},sr=(t,n)=>t===n||(bs[t]??[]).includes(n)?!0:(bs[n]??[]).includes(t),_a=(t,n,s)=>s?sr(t,n):t===n,Ya=(t,n,s)=>{const i=new Uint8Array(t.length);if(!t.length)return i;const r=(s==null?void 0:s.allowSimilarChars)??!0,u=[];for(let k=0;k<=t.length-3;k+=1)u.push({index:k,text:t.slice(k,k+3)});let m=!1;return u.forEach(k=>{for(let j=0;j<=n.length-3;j+=1){const M=n.slice(j,j+3);let o=0;for(let w=0;w<3;w+=1)_a(k.text[w],M[w],r)&&(o+=1);if(o<2)continue;let x=k.index-1,l=j-1;for(;x>=0&&l>=0;){const w=t[x],S=n[l];if(w===S){i[x]=Math.max(i[x],255),x-=1,l-=1,m=!0;continue}if(_a(w,S,r)&&w!==S){i[x]=Math.max(i[x],127),x-=1,l-=1,m=!0;continue}if(x>0&&t[x-1]===S){i[x]=Math.max(i[x],0),x-=1,m=!0;continue}if(l>0&&t[x]===n[l-1]){l-=1,m=!0;continue}break}for(let w=0;w<3;w+=1){const S=k.index+w,D=k.text[w],f=M[w],g=D===f?255:_a(D,f,r)?127:0;i[S]=Math.max(i[S],g),m=!0}let d=k.index+3,v=j+3;for(;d<t.length&&v<n.length;){const w=t[d],S=n[v];if(w===S){i[d]=Math.max(i[d],255),d+=1,v+=1,m=!0;continue}if(_a(w,S,r)&&w!==S){i[d]=Math.max(i[d],127),d+=1,v+=1,m=!0;continue}if(d+1<t.length&&t[d+1]===S){i[d]=Math.max(i[d],0),d+=1,m=!0;continue}if(v+1<n.length&&t[d]===n[v+1]){v+=1,m=!0;continue}break}}}),m?i:nr(t,n)},kn=t=>/[\p{L}\p{N}]/u.test(t),ys=t=>t.trim().toLowerCase(),ba=(t,n)=>{if(t.length===0)return 100;const s=(n==null?void 0:n.treatSimilarCharsAsSame)??!1,i=Array.from(t).reduce((r,u)=>s&&u===127?r+255:r+u,0);return Math.round(i/(t.length*255)*100)},Qa=(t,n,s)=>{const i=Math.max(0,Math.min(100,(s==null?void 0:s.thresholdPercent)??100)),r=(s==null?void 0:s.treatSimilarCharsAsSame)??!0,u=(s==null?void 0:s.ignorePunctuationAndSpacing)??!1,m=ys(t),k=ys(n);if(!u){const f=Ya(m,k,{allowSimilarChars:r}),g=ba(f,{treatSimilarCharsAsSame:r});return{mask:f,percent:g,isCorrect:g>=i,normalizedExpected:m,normalizedAnswer:k}}const j=Array.from(m),M=Array.from(k),o=[],x=[],l=[];j.forEach((f,g)=>{kn(f)&&(o.push(f),x.push(g))}),M.forEach(f=>{kn(f)&&l.push(f)});const d=o.join(""),v=l.join(""),w=Ya(d,v,{allowSimilarChars:r}),S=new Uint8Array(j.length);for(let f=0;f<S.length;f+=1)S[f]=kn(j[f]??"")?0:255;for(let f=0;f<w.length;f+=1){const g=x[f];g!==void 0&&(S[g]=w[f])}const D=ba(w,{treatSimilarCharsAsSame:r});return{mask:S,percent:D,isCorrect:D>=i,normalizedExpected:d,normalizedAnswer:v}},La=(t,n,s)=>{const i=t.trim().toLowerCase(),r=n.trim().toLowerCase();return s==="prefix"||s==="bidirectional"?Ya(i,r,{allowSimilarChars:!0}):Ya(i,r,{allowSimilarChars:!0})};function oa(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function xs(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function vs(t){const n=t.checkType??"info";return t.direction?`${n} / ${t.direction}`:n}function ir({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o,infoId:x,selectedReviewerRoleId:l}){const[d,v]=a.useState(x),[w,S]=a.useState([]),[D,f]=a.useState([]),[g,le]=a.useState("loading"),[P,p]=a.useState(null),[V,N]=a.useState(null),[W,R]=a.useState(null),[I,re]=a.useState(null),[ce,xe]=a.useState(""),[Te,Z]=a.useState(null),[C,Ie]=a.useState(1),[B,ee]=a.useState(null),[q,fe]=a.useState(0),[X,de]=a.useState(!1),[ye,Pe]=a.useState(null),[Ve,Ce]=a.useState({}),[He,Ze]=a.useState({}),[Me]=a.useState({}),[We,rt]=a.useState(null),ot=a.useRef(null),_e=a.useRef({}),je=An();a.useEffect(()=>{let K=!1;return le("loading"),Promise.all([da({libraryId:o,infoId:x}).catch(()=>null),qa({libraryId:o,infoId:x}),Ja({libraryId:o,infoId:x})]).then(([H,ie,ke])=>{if(K)return;const Ae=(H==null?void 0:H.payload)??{},De=typeof Ae.title=="string"&&Ae.title||typeof Ae.label=="string"&&Ae.label||typeof Ae.name=="string"&&Ae.name||x;v(De),N(Ae),R((H==null?void 0:H.infoType)??null),S(ie.items),f(ke.items),le("ready")}).catch(()=>{K||(N(null),R(null),S([]),f([]),le("error"))}),()=>{K=!0}},[o,x]),a.useEffect(()=>{if(W!=="translation"){re(null);return}Ms({libraryId:o,infoId:x,approachKey:"vocab-card"}).then(K=>re(K.projection??null)).catch(()=>re(null))},[W,x,o]);const J=a.useMemo(()=>{var ve;const K=new Map(w.map(be=>[oa(be),be])),H=new Map,ie=new Map;for(const be of w)H.set(oa(be),0),ie.set(oa(be),[]);for(const be of D){const ue=xs({parentItemId:be.parentItemId,parentCheckType:be.parentCheckType,parentDirection:be.parentDirection}),Xe=[be.childItemId,be.childCheckType??"",be.childDirection??""].join("|");!K.has(ue)||!K.has(Xe)||((ve=ie.get(ue))==null||ve.push(Xe),H.set(Xe,(H.get(Xe)??0)+1))}const ke=Array.from(H.entries()).filter(([,be])=>be===0).map(([be])=>be),Ae=new Map;for(const be of ke)Ae.set(be,0);for(;ke.length;){const be=ke.shift(),ue=Ae.get(be)??0;for(const Xe of ie.get(be)??[]){const Qe=Math.max(Ae.get(Xe)??0,ue+1);Ae.set(Xe,Qe),H.set(Xe,(H.get(Xe)??1)-1),(H.get(Xe)??0)<=0&&ke.push(Xe)}}const De=new Map;for(const be of w){const ue=oa(be),Xe=Ae.get(ue)??0,Qe=De.get(Xe)??[];Qe.push(ue),De.set(Xe,Qe)}return w.map(be=>{const ue=oa(be),Xe=Ae.get(ue)??0,Qe=De.get(Xe)??[ue],Ye=Math.max(0,Qe.indexOf(ue));return{id:ue,position:{x:40+Ye*290+(Xe%2?18:0),y:30+Xe*120},draggable:!1,selectable:!0,data:{label:be.label,subtitle:vs(be),checkType:be.checkType??"info",direction:be.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[w,D]),Le=a.useMemo(()=>new Map(w.map(K=>[oa(K),K])),[w]),oe=a.useMemo(()=>{const K=[];for(const H of D){const ie=xs({parentItemId:H.parentItemId,parentCheckType:H.parentCheckType,parentDirection:H.parentDirection}),ke=[H.childItemId,H.childCheckType??"",H.childDirection??""].join("|");!Le.has(ie)||!Le.has(ke)||K.push({id:`${ie}->${ke}`,source:ie,target:ke,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return K},[Le,D]),_=a.useMemo(()=>P?Le.get(P)??null:null,[Le,P]);a.useEffect(()=>{xe(""),ee(null),fe(0),de(!1),Pe(null),Z(null),Ze({})},[P]);const me=a.useMemo(()=>{var Ae,De;if(!_)return null;const K=W??_.infoType??null,H=_.checkType??"info",ie=_.direction??null,ke=V??{};if(_.cardType==="vocab"&&I&&Array.isArray(I.words)){const ve=I.words,be=((Ae=ve[0])==null?void 0:Ae.label)??"?",ue=((De=ve[1])==null?void 0:De.label)??"?";return ie==="a-to-b"?{kind:"vocab",prompt:String(be),expected:String(ue)}:ie==="b-to-a"?{kind:"vocab",prompt:String(ue),expected:String(be)}:{kind:"generic",prompt:`${be} ↔ ${ue}`,expected:`${be} ↔ ${ue}`}}if(K==="citation"&&H==="quote-fragment"&&ie&&typeof ke.text=="string"){const ve=ie,be=ja(ke.text),ue=be.nodes[ve];if(ue){const Xe=zn(ke.text,ue);return{kind:"citation-fragment",expected:ue.text,quoteContext:{title:d,before:Xe.before,after:Xe.after,total:Object.keys(be.nodes).length,completed:0},quotePlaceholder:ue.text.length>0?".".repeat(Math.max(4,Math.min(18,ue.text.length))):"..."}}}return{kind:"generic",prompt:_.description||_.label,expected:_.label}},[W,V,_,d,I]),Ge=async K=>{if(_&&l)try{await ii({libraryId:o,outcome:{itemType:"info",itemId:_.cardId,checkType:_.checkType??"info",direction:_.direction??null,revisionType:"direct",evalType:"direct-check",correct:K,clientId:"cogita-info-checkcards",clientSequence:C,personRoleId:l}}),Ie(H=>H+1),Z(K?"Saved as correct.":"Saved as incorrect.")}catch{Z("Failed to save answer.")}},$=_?oa(_):null,A=$?!!Ve[$]:!1,Y=async()=>{if(!_||!me)return;const K=oa(_);if(Ve[K]){Z("This card was already checked.");return}const H=me.expected,ie=me.kind==="citation-fragment",ke=Qa(H,ce,{thresholdPercent:ie?90:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:ie}),Ae=ke.isCorrect;ee(Ae?"correct":"incorrect"),fe(De=>De+1),Pe(ke.mask),de(!0),Z(l?null:"Answer checked locally (not saved: no person selected)."),Ce(De=>({...De,[K]:!0})),l&&await Ge(Ae)},se=()=>{if(!_||!me)return;const K=oa(_);Ve[K]||(Ce(ie=>({...ie,[K]:!0})),Z("Answer revealed (not saved)."));const H=Qa(me.expected,me.expected,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:me.kind==="citation-fragment"});Pe(H.mask)},T=a.useMemo(()=>_?_.infoType==="citation"?{..._,description:d}:{..._,description:_.label}:null,[_,d]),U=a.useMemo(()=>W?at(t,W):t.cogita.library.infoTypes.any,[t,W]);return e.jsx(Kt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:U}),e.jsx("h2",{className:"cogita-card-title",children:d}),e.jsx("p",{className:"cogita-card-subtitle",children:x})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${w.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${D.length}`}),e.jsx("button",{type:"button",className:"cta",disabled:w.length===0,onClick:()=>je(`/cogita/library/${o}/revision/run?libraryTarget=revisions&scope=info&infoId=${encodeURIComponent(x)}`),children:"Start revision"})]})]}),g==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):g==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(sn,{nodes:J,edges:oe,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:(K,H)=>p(H.id),panOnDrag:!0,children:[e.jsx(rn,{}),e.jsx(on,{showInteractive:!1})]})}),_?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[me&&T?e.jsx(Bn,{flashState:B,flashTick:q,children:e.jsx(_n,{copy:t,currentCard:T,currentTypeLabel:"",prompt:me.kind==="citation-fragment"?null:me.prompt,languages:[],answer:ce,onAnswerChange:xe,computedExpected:[],computedAnswers:He,onComputedAnswerChange:(K,H)=>Ze(ie=>({...ie,[K]:H})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:Me,feedback:B,canAdvance:!1,quoteContext:me.kind==="citation-fragment"?me.quoteContext:null,quotePlaceholder:me.kind==="citation-fragment"?me.quotePlaceholder:null,onCheckAnswer:()=>void Y(),onSkip:()=>p(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:X,setShowCorrectAnswer:de,onRevealCorrect:se,answerMask:ye,expectedAnswer:me.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:ot,computedInputRefs:_e,scriptMode:We,setScriptMode:rt,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:A||X,hideSkipAction:!0,allowRevealBeforeCheck:!0,autoRevealAfterAnswer:!0,disableCheckAfterAnswer:!0})}):null,l?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),Te?e.jsx("p",{className:"cogita-library-hint",children:Te}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:w.map(K=>{const H=oa(K),ie=P===H;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${ie?"active":""}`,onClick:()=>p(H),children:[e.jsx("span",{children:K.label}),e.jsx("small",{children:vs(K)})]},H)})})]})]})]})})})})})}function Va(t,n){var s,i;return((i=(s=t.fields.find(r=>r.fieldType===n))==null?void 0:s.plainValue)==null?void 0:i.trim())??""}function rr(t){return Va(t,"role_kind").toLowerCase()==="person"}function or(t){return Va(t,"label")||Va(t,"display_name")||Va(t,"name")||t.roleId}function lr({copy:t,onPersonCreated:n}){const[s,i]=a.useState([]),[r,u]=a.useState("loading"),[m,k]=a.useState(null),[j,M]=a.useState(!1),[o,x]=a.useState(""),l=async()=>{u("loading");try{const w=await Rs();i(w),u("ready")}catch{i([]),u("error")}};a.useEffect(()=>{l()},[]);const d=a.useMemo(()=>s.filter(rr).map(w=>({roleId:w.roleId,label:or(w)})).sort((w,S)=>w.label.localeCompare(S.label)),[s]),v=async()=>{const w=o.trim();if(!w){k("Name is required.");return}M(!0),k(null);try{const S=await ri({fields:[{fieldType:"role_kind",plainValue:"person"},{fieldType:"label",plainValue:w},{fieldType:"display_name",plainValue:w}]});x(""),k("Person role created."),n==null||n(S.roleId),await l()}catch{k("Failed to create person role.")}finally{M(!1)}};return e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-browser-panel",children:[e.jsx("div",{className:"cogita-info-overview-head",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Cogita"}),e.jsx("h2",{className:"cogita-card-title",children:"Persons"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Select reviewer persons in the header and create new person roles here."})]})}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Create"}),e.jsx("h3",{className:"cogita-detail-title",children:"New person role"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{type:"text",value:o,onChange:w=>x(w.target.value),placeholder:"e.g. Anna Kowalska",disabled:j})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:j,children:j?"Creating...":"Create person"})}),m?e.jsx("p",{className:"cogita-library-hint",children:m}):null]})]}),e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Overview"}),e.jsx("h3",{className:"cogita-detail-title",children:"All person roles"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[r==="loading"?e.jsx("p",{children:"Loading persons..."}):null,r==="error"?e.jsx("p",{children:"Failed to load persons."}):null,r==="ready"&&d.length===0?e.jsx("p",{children:"No person roles found."}):null,r==="ready"&&d.length>0?e.jsxs("div",{className:"cogita-details-grid",children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:"Name"}),e.jsx("span",{children:"Type"}),e.jsx("span",{children:"Role ID"}),e.jsx("span",{})]}),d.map(w=>e.jsxs("div",{className:"cogita-details-row",role:"row",children:[e.jsx("span",{}),e.jsx("span",{title:w.label,children:w.label}),e.jsx("span",{children:"person"}),e.jsx("span",{title:w.roleId,children:w.roleId}),e.jsx("span",{})]},w.roleId))]}):null]})]})]})]})})})})}function cr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o,collectionId:x}){const{libraryName:l}=ua(o),[d,v]=a.useState([]),[w,S]=a.useState("loading"),[D,f]=a.useState("idle"),g=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),le=`/#/cogita/library/${o}`,P=()=>{S("loading"),$s({libraryId:o}).then(N=>{v(N),S("idle")}).catch(()=>{v([]),S("error")})};a.useEffect(()=>{P()},[o]);const p=async N=>{try{await As({libraryId:o,shareId:N}),P()}catch{P()}},V=async N=>{const W=`${g}/${N}`;try{await navigator.clipboard.writeText(W),f("copied")}catch{f("failed")}};return e.jsx(Kt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:le,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${le}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[w==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):w==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):d.filter(N=>!x||N.collectionId===x).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:d.filter(N=>!x||N.collectionId===x).map(N=>e.jsxs("div",{className:"cogita-share-row","data-state":N.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:N.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(N.createdUtc).toLocaleString(),N.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),N.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${g}/${N.shareCode}`}):null]}),N.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[N.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>V(N.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>p(N.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},N.shareId))}),D==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):D==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function dr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o}){const{libraryName:x}=ua(o),[l,d]=a.useState(null),[v,w]=a.useState(null),[S,D]=a.useState(null),[f,g]=a.useState(null),[le,P]=a.useState(null),[p,V]=a.useState(null),N=a.useRef(null),W=re=>{if(!Number.isFinite(re))return"0 B";if(re<1024)return`${re} B`;const ce=re/1024;if(ce<1024)return`${ce.toFixed(1)} KB`;const xe=ce/1024;return xe<1024?`${xe.toFixed(1)} MB`:`${(xe/1024).toFixed(1)} GB`},R=async()=>{d(null),P({loadedBytes:0,totalBytes:null,percent:null});try{d(t.cogita.library.overview.exporting);const re=await oi(o,P),ce=URL.createObjectURL(re),xe=document.createElement("a");xe.href=ce,xe.download=`cogita-library-${x||o}.json`,xe.click(),URL.revokeObjectURL(ce),d(t.cogita.library.overview.exportReady)}catch{d(t.cogita.library.overview.exportFail)}finally{P(re=>re??{loadedBytes:0,totalBytes:null,percent:null})}},I=async re=>{var xe;w(null),D(null),g(null);const ce=(xe=re.target.files)==null?void 0:xe[0];if(ce)try{w(t.cogita.library.overview.importing),V({loadedBytes:0,totalBytes:ce.size,percent:0});const Te=await li(o,ce,V,Z=>{const C=Z.stage==="infos"?t.cogita.library.overview.importStageInfos:Z.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;g(t.cogita.library.overview.importLiveProgress.replace("{stage}",C).replace("{done}",String(Z.processed)).replace("{total}",String(Z.total)).replace("{infos}",String(Z.infos)).replace("{connections}",String(Z.connections)).replace("{collections}",String(Z.collections)))});D({infos:Te.infosImported,connections:Te.connectionsImported,collections:Te.collectionsImported}),w(t.cogita.library.overview.importDone)}catch(Te){const Z=Te instanceof Ls&&Te.message?` ${Te.message}`:"";w(`${t.cogita.library.overview.importFail}${Z}`)}finally{N.current&&(N.current.value="")}};return e.jsx(Kt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:R,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:N,type:"file",accept:"application/json",onChange:I})]})]}),le?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:le.percent??void 0,max:le.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",W(le.loadedBytes)).replace("{total}",le.totalBytes?W(le.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,p?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:p.percent??void 0,max:p.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",W(p.loadedBytes)).replace("{total}",p.totalBytes?W(p.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,l?e.jsx("p",{className:"cogita-help",children:l}):null,v?e.jsx("p",{className:"cogita-help",children:v}):null,f?e.jsx("p",{className:"cogita-help",children:f}):null,S?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(S.infos)).replace("{connections}",String(S.connections)).replace("{collections}",String(S.collections))}):null]})]})})})]})})}function ur({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o}){const{libraryName:x}=ua(o),[l,d]=a.useState(""),[v,w]=a.useState([]),S=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Kt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:D=>d(D.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const D=l.trim();D&&(w(f=>[{id:S(),name:D},...f]),d(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[v.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,v.map(D=>e.jsx("button",{type:"button",className:"ghost",children:D.name},D.id))]})]})]})})})]})})}function hr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o}){const{libraryName:x}=ua(o),[l,d]=a.useState(""),[v,w]=a.useState([]),S=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Kt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:D=>d(D.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const D=l.trim();D&&(w(f=>[{id:S(),name:D},...f]),d(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[v.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,v.map(D=>e.jsx("button",{type:"button",className:"ghost",children:D.name},D.id))]})]})]})})})]})})}function gr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o}){const{libraryName:x}=ua(o),l=`/#/cogita/library/${o}`,[d,v]=a.useState(""),[w,S]=a.useState([]),[D,f]=a.useState("idle"),[g,le]=a.useState(0),[P,p]=a.useState(null);a.useEffect(()=>{f("loading");const N=window.setTimeout(()=>{Ua({libraryId:o,query:d.trim()||void 0,limit:30}).then(W=>{S(W.items),le(W.total),p(W.nextCursor??null),f("ready")}).catch(()=>{S([]),le(0),p(null),f("ready")})},240);return()=>window.clearTimeout(N)},[o,d]);const V=async()=>{if(P){f("loading");try{const N=await Ua({libraryId:o,query:d.trim()||void 0,limit:30,cursor:P});S(W=>[...W,...N.items]),p(N.nextCursor??null),le(N.total),f("ready")}catch{f("ready")}}};return e.jsx(Kt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${l}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:d,onChange:N=>v(N.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(w.length)).replace("{total}",String(g||w.length))}),e.jsx("span",{children:D==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:w.length?w.map(N=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${l}/collections/${N.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:N.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(N.itemCount))," ·"," ",N.notes||t.cogita.library.collections.noNotes]})]})},N.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${l}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),P?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:V,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const pe=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,na=(t,n,s,i)=>`${t}:${n}:${s??""}:${i??""}`;function mr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o,collectionId:x}){ua(o);const l=`/#/cogita/library/${o}`,[d,v]=a.useState(t.cogita.library.collections.defaultName),[w,S]=a.useState(null),[D,f]=a.useState(0),[g,le]=a.useState([]),[P,p]=a.useState("idle"),[V,N]=a.useState(null),W=a.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(g.length)).replace("{total}",String(D||g.length)),[t,g.length,D]);a.useEffect(()=>{ln(o,x).then(I=>{v(I.name),S(I.notes??null),f(I.itemCount)}).catch(()=>{v(t.cogita.library.collections.defaultName),S(null)})},[o,x]),a.useEffect(()=>{p("loading"),Ha({libraryId:o,collectionId:x,limit:40}).then(I=>{le(I.items),N(I.nextCursor??null),f(I.total),p("ready")}).catch(()=>{le([]),N(null),p("ready")})},[o,x]);const R=async()=>{if(V){p("loading");try{const I=await Ha({libraryId:o,collectionId:x,limit:40,cursor:V});le(re=>[...re,...I.items]),N(I.nextCursor??null),f(I.total),p("ready")}catch{p("ready")}}};return e.jsx(Kt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:d}),e.jsx("p",{className:"cogita-library-subtitle",children:w||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${l}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${l}/collections/${x}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${l}/collections/${x}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:W}),e.jsx("span",{children:P==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:g.length?g.map(I=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:I.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:I.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:I.label}),e.jsx("p",{className:"cogita-card-subtitle",children:I.description})]})},pe(I))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),V?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:R,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${l}/collections/${x}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const ws=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],pr={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},fr=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],br=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function yr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o,onCreated:x}){const l=Fa(),{libraryName:d}=ua(o),v=`/#/cogita/library/${o}`,[w,S]=a.useState(null),[D,f]=a.useState(""),[g,le]=a.useState(""),[P,p,V]=En([]),[N,W,R]=Pn([]),[I,re]=a.useState(null),[ce,xe]=a.useState(null),Te=a.useRef(null),Z=a.useMemo(()=>P.find(q=>q.id===I)??null,[P,I]);a.useEffect(()=>{const q=new URLSearchParams(l.search),fe=(q.get("draft")??"").trim(),X=(q.get("draftType")??"").trim();if(!fe||X!=="info-selection"||Te.current===fe)return;const de=Oi(o,fe);if(!de||de.infoIds.length===0)return;const ye=crypto.randomUUID(),Pe=de.infoIds.length>1?crypto.randomUUID():null,Ve=de.infoIds.map((Me,We)=>({id:crypto.randomUUID(),type:"default",position:{x:80,y:80+We*100},data:{nodeType:"source.info",label:"Selected info",params:{infoId:Me,infoType:"any"}}})),Ce=Pe?[{id:Pe,type:"default",position:{x:360,y:120+Math.max(0,(de.infoIds.length-1)*50)},data:{nodeType:"logic.or",label:"Selected infos",params:{}}}]:[],He={id:ye,type:"default",position:{x:660,y:140+Math.max(0,(de.infoIds.length-1)*35)},data:{nodeType:"output.collection",label:"Collection output",params:{}}},Ze=Ve.map(Me=>({id:crypto.randomUUID(),source:Me.id,target:Pe??ye}));Pe&&Ze.push({id:crypto.randomUUID(),source:Pe,target:ye}),p([...Ve,...Ce,He]),W(Ze),re(ye),xe(`Draft loaded from ${de.infoIds.length} selected infos. Set name and save to create collection.`),Te.current=fe},[o,l.search,W,p]);const C=q=>{var ye;const fe=crypto.randomUUID(),X=((ye=ws.find(Pe=>Pe.type===q))==null?void 0:ye.label)??q,de={...pr[q]};p(Pe=>[...Pe,{id:fe,type:"default",position:{x:120+Pe.length*40,y:120+Pe.length*40},data:{nodeType:q,label:X,params:de}}]),re(fe)},Ie=a.useCallback(q=>{W(fe=>Kn({...q,id:crypto.randomUUID()},fe))},[W]),B=q=>{Z&&p(fe=>fe.map(X=>X.id===Z.id?{...X,data:{...X.data,params:q}}:X))},ee=async()=>{if(xe(null),!D.trim()){xe(t.cogita.library.collections.saveRequiredName);return}try{const q={nodes:P.map(de=>({nodeId:de.id,nodeType:de.data.nodeType,payload:{position:de.position,params:de.data.params}})),edges:N.map(de=>({edgeId:de.id,fromNodeId:de.source,fromPort:de.sourceHandle??null,toNodeId:de.target,toPort:de.targetHandle??null}))};let fe=w,X=!1;if(fe)await Es({libraryId:o,collectionId:fe,nodes:q.nodes,edges:q.edges});else{const de=await ci({libraryId:o,name:D.trim(),notes:g.trim()||void 0,items:[],graph:q});fe=de.collectionId,X=!0,S(de.collectionId)}xe(X?t.cogita.library.collections.saveSuccess:t.cogita.library.graph.saveSuccess),x(fe)}catch{xe(w?t.cogita.library.graph.saveFail:t.cogita.library.collections.saveFail)}};return e.jsx(Kt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.createKicker}),e.jsx("h1",{className:"cogita-library-title",children:d}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.createSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${v}/collections`,children:t.cogita.library.actions.collections}),e.jsx("button",{type:"button",className:"cta",onClick:ee,children:t.cogita.library.actions.saveCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.collectionInfoTitle}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{value:D,onChange:q=>f(q.target.value),placeholder:t.cogita.library.collections.namePlaceholder})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.notesLabel}),e.jsx("textarea",{value:g,onChange:q=>le(q.target.value),placeholder:t.cogita.library.collections.notesPlaceholder})]}),ce?e.jsx("p",{className:"cogita-help",children:ce}):null,e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:ws.map(q=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>C(q.type),children:q.label},q.type))})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(sn,{nodes:P,edges:N,onNodesChange:V,onEdgesChange:R,onConnect:Ie,onNodeClick:(q,fe)=>re(fe.id),fitView:!0,children:[e.jsx(rn,{color:"rgba(120,160,200,0.2)"}),e.jsx(on,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),Z?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:Z.data.label}),Z.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(ea,{libraryId:o,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:Z.data.params.tagId?{id:Z.data.params.tagId,label:Z.data.params.tagLabel??"",infoType:"topic"}:null,onChange:q=>B({...Z.data.params,tagId:(q==null?void 0:q.id)??null,tagLabel:(q==null?void 0:q.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:Z.data.params.scope??"any",onChange:q=>B({...Z.data.params,scope:q.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),Z.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(ea,{libraryId:o,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:Z.data.params.languageId?{id:Z.data.params.languageId,label:Z.data.params.languageLabel??"",infoType:"language"}:null,onChange:q=>B({...Z.data.params,languageId:(q==null?void 0:q.id)??null,languageLabel:(q==null?void 0:q.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:Z.data.params.scope??"any",onChange:q=>B({...Z.data.params,scope:q.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),Z.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:Z.data.params.infoType??"word",onChange:q=>B({...Z.data.params,infoType:q.target.value}),children:br.map(q=>e.jsx("option",{value:q.value,children:q.label},q.value))})]}),e.jsx(ea,{libraryId:o,infoType:Z.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:Z.data.params.infoId?{id:Z.data.params.infoId,label:Z.data.params.infoLabel??"",infoType:Z.data.params.infoType??"word"}:null,onChange:q=>B({...Z.data.params,infoId:(q==null?void 0:q.id)??null,infoLabel:(q==null?void 0:q.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),Z.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:Z.data.params.connectionType??"translation",onChange:q=>B({...Z.data.params,connectionType:q.target.value}),children:fr.map(q=>e.jsx("option",{value:q.value,children:q.label},q.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:Z.data.params.connectionId??"",onChange:q=>B({...Z.data.params,connectionId:q.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(Z.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const la=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const n=t.length,s=t.filter(u=>u.correct).length,i=cn(Vn(t));return{score:Math.round(Math.max(0,Math.min(100,i.knowness*100))*100)/100,total:n,correct:s,lastReviewedUtc:i.lastReviewedUtc??null}},xr=t=>{if(t.maskBase64)try{const n=di(t.maskBase64);if(!n.length)return t.correct?1:0;const s=n.reduce((i,r)=>i+r,0);return Math.max(0,Math.min(1,s/n.length/255))}catch{return t.correct?1:0}return t.correct?1:0},Vn=t=>t.map(n=>({correctness:xr(n),createdUtc:n.createdUtc})),cn=(t,n=Date.now())=>{var D;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const i=t.slice().sort((f,g)=>f.createdUtc.localeCompare(g.createdUtc)).slice(-5),r=i.reduce((f,g)=>f+g.correctness,0)/i.length,u=5,m=2,k=.15;let j=0,M=0;for(let f=0;f<i.length;f+=1){const g=new Date(i[f].createdUtc).getTime(),le=f===i.length-1?n:new Date(i[f+1].createdUtc).getTime(),P=Math.max(0,(le-g)/(1e3*60)),p=1-Math.exp(-P/u);j+=p,i[f].correctness>.5&&(M+=k)}let o=r*j*m+M;const x=((D=i[i.length-1])==null?void 0:D.createdUtc)??null,l=x?Math.max(0,(n-new Date(x).getTime())/(1e3*60)):0,v=1/(1+Math.log1p(l/60));return o*=v,i.length===1&&i[0].correctness>.5&&(o+=5.44*Math.exp(-l/2)),{knowness:o,avgCorrectness:r,lastReviewedUtc:x}},Ka=t=>{const n=t.slice();for(let s=n.length-1;s>0;s-=1){const i=Math.floor(Math.random()*(s+1));[n[s],n[i]]=[n[i],n[s]]}return n},Oa=t=>t[Math.floor(Math.random()*t.length)],vr=(t,n)=>{const s=new Map;return t.forEach(i=>s.set(i,Math.random())),t.sort((i,r)=>{const u=n(i)-n(r);return u!==0?u:(s.get(i)??0)-(s.get(r)??0)})},dn=(t,n,s,i,r)=>{if(!t.length)return null;const u=t.filter(k=>!(r!=null&&r.has(pe(k))));if(u.length===0)return null;const m=u.filter(k=>pe(k)!==s);return Oa(m.length?m:u)},wr=(t,n,s,i,r)=>{if(!t.length)return null;let u=Number.POSITIVE_INFINITY;for(const M of t){const o=pe(M);if(s.has(o))continue;const x=n[o]??1;x<u&&(u=x)}if(!Number.isFinite(u))return null;const m=t.filter(M=>{const o=pe(M);return!s.has(o)&&(n[o]??1)===u}),k=m.filter(M=>!r||pe(M)!==r),j=i?k.filter(M=>!i.has(pe(M))):k;return j.length>0?Oa(j):k.length>0?Oa(k):r&&m.some(M=>pe(M)===r)?m.find(M=>pe(M)===r)??null:m.length?Oa(m):null},Bs=(t,n,s,i,r)=>{const u=[],m=t.filter(j=>!r.has(pe(j))&&!s.has(pe(j))&&(n[pe(j)]??0)<1),k=vr(m,j=>n[pe(j)]??0);for(const j of k){if(u.length>=i)break;u.push(j),r.add(pe(j))}if(u.length<i){const j=Ka(t.filter(M=>!r.has(pe(M))&&s.has(pe(M))));for(const M of j){if(u.length>=i)break;u.push(M),r.add(pe(M))}}return u},jr=(t,n,s,i)=>Bs(t,n,s,i,new Set),On=(t,n,s,i,r,u)=>{const m=Math.max(1,s.stackSize??n),j=Ka(t).filter((v,w,S)=>S.findIndex(D=>pe(D)===pe(v))===w),M=jr(j,i,r,m),o=new Set,x=new Set,l=dn(M,{},null,o,x),d=l?[l]:[];return l&&x.add(pe(l)),{queue:d,meta:{pool:j,active:M,knownessMap:i,unknownSet:r,outcomesById:u,asked:o,queued:x}}},$n={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,n)=>{const i=Ka(t).filter((r,u,m)=>m.findIndex(k=>pe(k)===pe(r))===u);return{queue:i.slice(0,Math.min(n,i.length)),meta:{}}},applyOutcome:t=>t},Un=(t,n,s,i)=>{const r=Math.max(1,s.stackSize??n),m=Ka(t).filter((w,S,D)=>D.findIndex(f=>pe(f)===pe(w))===S),k={},j=new Set,M=new Set,o=new Set,x=Math.max(1,s.levels??1);m.forEach(w=>{const S=pe(w),D=i==null?void 0:i[S],f=typeof D=="number"&&Number.isFinite(D)?D:1;k[S]=Math.min(x,Math.max(1,Math.round(f)))});const l=[];if(m.length>0){const w=new Map;m.forEach(D=>{var g;const f=k[pe(D)]??1;w.has(f)||w.set(f,[]),(g=w.get(f))==null||g.push(D)});const S=Array.from(w.keys()).sort((D,f)=>D-f);for(const D of S){if(l.length>=r)break;const f=Ka(w.get(D)??[]);for(const g of f){if(l.length>=r)break;l.push(g)}}}const d=dn(l,k,null,j,M),v=d?[d]:[];return d&&M.add(pe(d)),{queue:v,meta:{pool:m,active:l,levelMap:k,asked:j,queued:M,wrongSinceCorrect:o}}},kr={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,s)=>Un(t,n,s),applyOutcome:(t,n,s,i,r)=>{if(!n)return t;const u=Math.max(1,i.levels??1),m=t.meta.pool??[],k=t.meta.active??[],j={...t.meta.levelMap??{}},M=new Set(t.meta.asked??[]),o=new Set(t.meta.queued??[]),x=new Set(t.meta.wrongSinceCorrect??[]),l=pe(n);o.delete(l),M.add(l);const d=j[l]??1;r.correct?(j[l]=x.has(l)?1:Math.min(d+1,u),x.delete(l)):(j[l]=1,x.add(l));const v=r.correct?k.filter(D=>pe(D)!==l):k.slice();if(r.correct&&v.length<Math.max(1,i.stackSize??1)){const D=new Set(v.map(g=>pe(g))),f=wr(m,j,D,M,l);f&&v.push(f)}const w=t.queue.slice(),S=dn(v,j,l,M,o);return S&&(w.push(S),o.add(pe(S))),{queue:w,meta:{pool:m,active:v,levelMap:j,asked:M,queued:o,wrongSinceCorrect:x}}}},Nr={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,s)=>On(t,n,s,{},new Set,{}),applyOutcome:(t,n,s,i,r)=>{if(!n)return t;const u=t.meta.pool??[],m=t.meta.active??[],k={...t.meta.knownessMap??{}},j=new Set(t.meta.unknownSet??[]),M={...t.meta.outcomesById??{}},o=new Set(t.meta.asked??[]),x=new Set(t.meta.queued??[]),l=pe(n);x.delete(l),o.add(l);const d={correctness:Math.max(0,Math.min(1,r.correctness??(r.correct?1:0))),createdUtc:r.createdUtc??new Date().toISOString()},w=(M[l]??[]).concat(d).sort((P,p)=>P.createdUtc.localeCompare(p.createdUtc)).slice(-5);M[l]=w,j.delete(l);const S=Date.now();u.forEach(P=>{const p=pe(P),V=M[p]??[];if(V.length===0){k[p]=0,j.add(p);return}const N=cn(V,S);k[p]=N.knowness});const D=m.slice();if((k[l]??0)>=1){const P=D.filter(p=>pe(p)!==l);D.length=0,D.push(...P)}const g=Math.max(1,i.stackSize??s);if(D.length<g){const P=new Set(D.map(V=>pe(V))),p=Bs(u,k,j,g-D.length,P);D.push(...p)}const le=t.queue.slice();if(le.length===0||pe(le[le.length-1])===l){const P=dn(D,{},l,o,x);P&&(le.push(P),x.add(pe(P)))}return{queue:le,meta:{pool:u,active:D,knownessMap:k,unknownSet:j,outcomesById:M,asked:o,queued:x}}}},_s={random:$n,levels:kr,temporal:Nr},Sr=Object.values(_s),qn=t=>{if(!t)return $n;const n=t.trim().toLowerCase();return n==="random"||n==="levels"||n==="temporal"?_s[n]:$n},un=(t,n)=>{const s={...t.defaultSettings};return n&&Object.entries(n).forEach(([i,r])=>{typeof r=="number"&&Number.isFinite(r)&&(s[i]=r),typeof r=="string"&&(s[i]=r)}),t.settingsFields.forEach(i=>{var u;const r=s[i.key];if(i.type==="number"){if(typeof r!="number"||Number.isNaN(r)){s[i.key]=t.defaultSettings[i.key]??0;return}i.min!==void 0&&(s[i.key]=Math.max(i.min,s[i.key])),i.max!==void 0&&(s[i.key]=Math.min(i.max,s[i.key]));return}if(i.type==="select"){const m=((u=i.options)==null?void 0:u.map(k=>k.value))??[];(typeof r!="string"||m.length>0&&!m.includes(r))&&(s[i.key]=t.defaultSettings[i.key]??m[0]??"")}}),s},Vs=(t,n)=>{const s={};return t.settingsFields.forEach(i=>{const r=n.get(i.key);if(r){if(i.type==="number"){const u=Number(r);Number.isNaN(u)||(s[i.key]=u);return}s[i.key]=r}}),un(t,s)},Tr=(t,n)=>{const s=new URLSearchParams;return t.settingsFields.forEach(i=>{const r=n[i.key];(typeof r=="number"||typeof r=="string")&&s.set(i.key,String(r))}),s};function Cr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o,collectionId:x,revisionId:l}){const{libraryName:d}=ua(o),v=`/#/cogita/library/${o}`,[w,S]=a.useState(t.cogita.library.collections.defaultName),[D,f]=a.useState(""),[g,le]=a.useState(20),[P,p]=a.useState("random"),[V,N]=a.useState({}),[W,R]=a.useState("exact"),[I,re]=a.useState([]),[ce,xe]=a.useState(null),[Te,Z]=a.useState([]),[C,Ie]=a.useState("idle"),[B,ee]=a.useState(null),[q,fe]=a.useState("idle"),[X,de]=a.useState("idle"),[ye,Pe]=a.useState("idle"),Ve=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),Ce=a.useMemo(()=>qn(P),[P]),He=a.useMemo(()=>un(Ce,V),[Ce,V]),Ze=a.useMemo(()=>Tr(Ce,He).toString(),[Ce,He]);a.useEffect(()=>{ln(o,x).then(je=>S(je.name)).catch(()=>S(t.cogita.library.collections.defaultName))},[o,x]),a.useEffect(()=>{l&&ui({libraryId:o,collectionId:x,revisionId:l}).then(je=>{f(je.name),p(je.mode||"random"),R(je.check||"exact"),le(je.limit||20),N(je.revisionSettings??{})}).catch(()=>{f("")})},[x,o,l]),a.useEffect(()=>{Ps({libraryId:o}).then(je=>{re(je),!ce&&je.length>0&&xe(je[0].roleId)}).catch(()=>{re([])})},[o]);const Me=()=>{de("loading"),$s({libraryId:o}).then(je=>{Z(je),de("idle")}).catch(()=>{Z([]),de("error")})};a.useEffect(()=>{Me()},[o]);const We=async()=>{Ie("working"),fe("idle");try{const je=await gi({libraryId:o,collectionId:x,revisionType:Ce.id,revisionSettings:He,mode:P,check:W,limit:g});ee(`${Ve}/${je.shareCode}${Ze?`?${Ze}`:""}`),Ie("ready"),Me()}catch{Ie("error")}},rt=async()=>{if(l){Pe("saving");try{await hi({libraryId:o,collectionId:x,revisionId:l,name:D||w,revisionType:Ce.id,revisionSettings:He,mode:P,check:W,limit:g}),Pe("saved")}catch{Pe("error")}}},ot=async()=>{if(B)try{await navigator.clipboard.writeText(B),fe("copied")}catch{fe("failed")}},_e=async je=>{try{await As({libraryId:o,shareId:je}),Me()}catch{Me()}};return e.jsx(Kt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:w}),e.jsx("p",{className:"cogita-library-subtitle",children:d})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${v}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${v}/collections/${x}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${v}/collections/${x}/revision/run?mode=${encodeURIComponent(P)}&check=${encodeURIComponent(W)}&limit=${g}${Ze?`&${Ze}`:""}${ce?`&reviewer=${encodeURIComponent(ce)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:D,onChange:je=>f(je.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:P,onChange:je=>p(je.target.value),children:Sr.map(je=>e.jsx("option",{value:je.id,children:t.cogita.library.revision[je.labelKey]},je.id))})]}),Ce.settingsFields.map(je=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[je.labelKey]}),je.type==="select"?e.jsx("select",{value:String(He[je.key]??""),onChange:J=>N(Le=>({...Le,[je.key]:J.target.value})),children:(je.options??[]).map(J=>e.jsx("option",{value:J.value,children:t.cogita.library.revision[J.labelKey]},J.value))}):e.jsx("input",{type:"number",min:je.min,max:je.max,step:je.step,value:He[je.key]??0,onChange:J=>N(Le=>({...Le,[je.key]:Number(J.target.value||0)}))})]},je.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),Ce.id!=="levels"&&Ce.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:g,onChange:je=>le(Number(je.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:ce??"",onChange:je=>xe(je.target.value||null),children:I.map(je=>e.jsx("option",{value:je.roleId,children:je.label},je.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[l?e.jsx("button",{type:"button",className:"cta ghost",onClick:rt,disabled:ye==="saving",children:ye==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${v}/collections/${x}/revision/run?mode=${encodeURIComponent(P)}&check=${encodeURIComponent(W)}&limit=${g}${Ze?`&${Ze}`:""}${ce?`&reviewer=${encodeURIComponent(ce)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]}),ye==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),B?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:B,readOnly:!0})]}):null,C==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,q==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):q==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:We,disabled:C==="working",children:C==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),B?e.jsx("button",{type:"button",className:"cta ghost",onClick:ot,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),X==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):Te.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:Te.map(je=>e.jsxs("div",{className:"cogita-share-row","data-state":je.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:je.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(je.createdUtc).toLocaleString(),je.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),je.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>_e(je.shareId),children:t.cogita.library.revision.shareRevokeAction})]},je.shareId))})]})]})]})]})})})]})})}const Nn=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function Os(t,n,s){if(!t)return null;const i=new Map(t.nodes.map(P=>[P.id,P])),r=new Map,u=new Set,m=P=>{if(typeof P=="number")return P;if(typeof P=="string"){const p=Number(P);return Number.isFinite(p)?p:0}return 0},k=P=>{if(r.has(P))return r.get(P);if(u.has(P))return 0;const p=i.get(P);if(!p)return 0;u.add(P);const V=W=>{var I,re;return(W?((I=p.inputsByHandle)==null?void 0:I[W])??[]:p.inputs??((re=p.inputsByHandle)==null?void 0:re.in)??[]).map(ce=>k(ce))};let N=0;switch(p.type){case"input.random":{const W=p.min??0,R=p.max??W+10,I=Math.min(W,R),re=Math.max(W,R);N=Math.floor(Math.random()*(re-I+1))+I;break}case"input.const":{N=p.value??0;break}case"input.list":{const W=(p.list??[]).filter(Boolean),R=Math.round(m(V("index")[0]));N=W.length?W[Math.max(0,Math.min(W.length-1,R))]:String(R);break}case"compute.add":{N=V("in").map(R=>m(R)).reduce((R,I)=>R+I,0);break}case"compute.sub":{const W=V("add").map(I=>m(I)),R=V("sub").map(I=>m(I));N=W.reduce((I,re)=>I+re,0)-R.reduce((I,re)=>I+re,0);break}case"compute.mul":{const W=V("in").map(R=>m(R));N=W.length?W.reduce((R,I)=>R*I,1):0;break}case"compute.div":{const W=m(V("num")[0]),R=V("den").map(I=>m(I)).reduce((I,re)=>I+re,0);N=Math.abs(R)<Number.EPSILON?0:W/R;break}case"compute.pow":{const W=m(V("base")[0]),R=m(V("exp")[0]);N=Math.pow(W,R);break}case"compute.exp":{const W=m(V("base")[0]),R=m(V("exp")[0]);N=Math.pow(W,R);break}case"compute.log":{const W=m(V("value")[0]),R=m(V("base")[0]),I=Math.max(W,Number.EPSILON);N=Math.abs(R)<Number.EPSILON?Math.log(I):Math.log(I)/Math.log(R);break}case"compute.abs":{N=Math.abs(m(V("in")[0]));break}case"compute.min":{const W=V("in").map(R=>m(R));N=W.length?Math.min(...W):0;break}case"compute.max":{const W=V("in").map(R=>m(R));N=W.length?Math.max(...W):0;break}case"compute.floor":{N=Math.floor(m(V("in")[0]));break}case"compute.ceil":{N=Math.ceil(m(V("in")[0]));break}case"compute.round":{N=Math.round(m(V("in")[0]));break}case"compute.mod":{const W=m(V("a")[0]),R=m(V("b")[0]);N=Math.abs(R)<Number.EPSILON?0:W%R;break}case"compute.concat":{const R=["in1","in2","in3","in4","in5","in6"].flatMap(xe=>V(xe)),I=R.length?R:V("in");N=(I.length?I:V()).map(xe=>xe==null?"":String(xe)).join("");break}case"compute.trim":{const W=V("text")[0]??V("in")[0]??"",R=W==null?"":String(W),I=Math.max(0,Math.round(m(V("start")[0]))),re=Math.max(0,Math.round(m(V("end")[0])));I+re>=R.length?N="":N=R.substring(I,R.length-re);break}case"output":{N=V("in")[0]??0;break}default:N=0}return u.delete(P),r.set(P,N),N},j=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(P=>P.type==="output").map(P=>P.id);t.nodes.forEach(P=>k(P.id)),j.forEach(P=>k(P));const M=P=>Math.abs(P%1)<1e-5?String(Math.round(P)):P.toFixed(3).replace(/\.?0+$/,""),o=P=>typeof P=="number"?M(P):P??"",x=new Map;j.forEach(P=>{var R,I,re,ce;const p=i.get(P);if(!p)return;const V=(I=(R=p.inputsByHandle)==null?void 0:R.name)==null?void 0:I[0],N=V?o(r.get(V)):"",W=(N==null?void 0:N.toString().trim())||((re=p.outputLabel)==null?void 0:re.trim())||((ce=p.name)==null?void 0:ce.trim())||P;x.set(P,W)});const l={},d={},v={};j.forEach(P=>{var N,W;const p=i.get(P);if(!p)return;const V=x.get(P)??(((N=p.outputLabel)==null?void 0:N.trim())||((W=p.name)==null?void 0:W.trim())||P);l[V]=o(r.get(P)),p.name&&(d[p.name.trim()]=V),d[P]=V});const w=(P,p)=>{let V=P;return t.nodes.forEach(N=>{var ce,xe;const W=o(r.get(N.id)),R=j.includes(N.id),I=R?x.get(N.id)??((ce=N.outputLabel)==null?void 0:ce.trim())??((xe=N.name)==null?void 0:xe.trim())??N.id:"",re=R&&p?I:W;V=V.replace(new RegExp(`\\{\\s*${Nn(N.id)}\\s*\\}`,"gi"),re),N.name&&(V=V.replace(new RegExp(`\\{\\s*${Nn(N.name)}\\s*\\}`,"gi"),re)),R&&N.outputLabel&&(V=V.replace(new RegExp(`\\{\\s*${Nn(N.outputLabel)}\\s*\\}`,"gi"),I))}),V},S=n;let D=S.trim().length>0?S:"";D||(D=j.length?`Compute ${j.join(", ")}`:"Compute"),D=w(D,!0);const f=(s==null?void 0:s.trim())??"",g=f?w(f,!1):"",le={};return r.forEach((P,p)=>{le[p]=P,v[p]=o(P);const V=i.get(p);V!=null&&V.name&&(v[V.name.trim()]=o(P))}),{prompt:D,answers:l,values:le,answerText:g,outputVariables:d,variableValues:v}}function Us(t){var s;const n=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((s=n[0])==null?void 0:s[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const Sn=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function qs({outcomes:t}){const[n,s]=a.useState("day"),i=a.useMemo(()=>{const r=Sn.find(k=>k.id===n)??Sn[1],u=Date.now()-r.ms,m=t.filter(k=>new Date(k.createdUtc).getTime()>=u);return la(m)},[t,n]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:Sn.map(r=>e.jsx("button",{type:"button",className:"ghost","data-active":n===r.id,onClick:()=>s(r.id),children:r.label},r.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[i.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[i.correct," / ",i.total]})]})}const Ir="cogita-revision",Mr=1,Xa="outcomes",Lr=()=>new Promise((t,n)=>{const s=indexedDB.open(Ir,Mr);s.onupgradeneeded=()=>{const i=s.result;if(!i.objectStoreNames.contains(Xa)){const r=i.createObjectStore(Xa,{keyPath:"id"});r.createIndex("byItem","itemKey",{unique:!1}),r.createIndex("byPending","pending",{unique:!1})}},s.onerror=()=>n(s.error),s.onsuccess=()=>t(s.result)}),Da=async(t,n)=>{const s=await Lr();return new Promise((i,r)=>{const u=s.transaction(Xa,t),m=u.objectStore(Xa);n(m).then(i).catch(r),u.onerror=()=>r(u.error)})},Js=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const n=Array.from(t).map(s=>s.toString(16).padStart(2,"0"));return`${n.slice(0,4).join("")}-${n.slice(4,6).join("")}-${n.slice(6,8).join("")}-${n.slice(8,10).join("")}-${n.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},Rr=()=>{const t="cogita_revision_client_id",n=localStorage.getItem(t);if(n)return n;const s=Js();return localStorage.setItem(t,s),s},$r=()=>{const t="cogita_revision_client_seq",n=Number(localStorage.getItem(t)??"0"),s=Number.isFinite(n)?n+1:1;return localStorage.setItem(t,String(s)),s},Hs=(t,n,s,i)=>na(t,n,s,i),Za=async t=>{const n=Rr(),s=$r(),i=new Date().toISOString(),r={...t,clientId:n,clientSequence:s,createdUtc:i,id:Js(),pending:!0};return await Da("readwrite",u=>new Promise((m,k)=>{const j={...r,itemKey:Hs(r.itemType,r.itemId,r.checkType,r.direction)},M=u.add(j);M.onsuccess=()=>m(),M.onerror=()=>k(M.error)})),r},en=async(t,n,s,i)=>{if(!n)return[];try{const r=Hs(t,n,s,i);return await Da("readonly",u=>new Promise((m,k)=>{const M=u.index("byItem").getAll(r);M.onsuccess=()=>{const x=(M.result??[]).map(l=>({itemType:l.itemType,itemId:l.itemId,checkType:l.checkType??null,direction:l.direction??null,revisionType:l.revisionType,evalType:l.evalType,correct:l.correct,createdUtc:l.createdUtc,maskBase64:l.maskBase64,payloadBase64:l.payloadBase64,payloadHashBase64:l.payloadHashBase64,clientId:l.clientId,clientSequence:l.clientSequence,personRoleId:l.personRoleId??null})).sort((l,d)=>l.createdUtc.localeCompare(d.createdUtc));m(x)},M.onerror=()=>k(M.error)}))}catch{return[]}},ca=async()=>{try{return await Da("readonly",t=>new Promise((n,s)=>{const i=t.getAll();i.onsuccess=()=>{const u=(i.result??[]).map(m=>({itemType:m.itemType,itemId:m.itemId,checkType:m.checkType??null,direction:m.direction??null,revisionType:m.revisionType,evalType:m.evalType,correct:m.correct,createdUtc:m.createdUtc,maskBase64:m.maskBase64,payloadBase64:m.payloadBase64,payloadHashBase64:m.payloadHashBase64,clientId:m.clientId,clientSequence:m.clientSequence,personRoleId:m.personRoleId??null}));n(u)},i.onerror=()=>s(i.error)}))}catch{return[]}},Ar=async(t=100)=>{try{return await Da("readonly",n=>new Promise((s,i)=>{const u=n.index("byPending").getAll(!0);u.onsuccess=()=>{const m=u.result??[];s(m.slice(0,t))},u.onerror=()=>i(u.error)}))}catch{return[]}},Er=async t=>{if(t.length!==0)try{await Da("readwrite",n=>new Promise((s,i)=>{let r=t.length;t.forEach(u=>{const m=n.get(u);m.onsuccess=()=>{const k=m.result;if(k){k.pending=!1;const j=n.put(k);j.onsuccess=()=>{r-=1,r===0&&s()},j.onerror=()=>i(j.error)}else r-=1,r===0&&s()},m.onerror=()=>i(m.error)})}))}catch{}},Tn=async(t,n)=>{const s=await Ar(200);if(s.length===0)return;const i=new Map;s.forEach(r=>{var m;const u=r.personRoleId??n??"";i.has(u)||i.set(u,[]),(m=i.get(u))==null||m.push(r)});for(const[r,u]of i.entries()){const m=u.map(k=>({itemType:k.itemType,itemId:k.itemId,checkType:k.checkType??null,direction:k.direction??null,revisionType:k.revisionType,evalType:k.evalType,correct:k.correct,clientId:k.clientId,clientSequence:k.clientSequence,maskBase64:k.maskBase64??null,payloadHashBase64:k.payloadHashBase64??null,payloadBase64:k.payloadBase64??null,personRoleId:r||null}));try{await mi({libraryId:t,outcomes:m}),await Er(u.map(k=>k.id))}catch{}}},_t=t=>t.trim().toLowerCase(),Gt=t=>{const n=t==null?void 0:t.trim();return n?{fragmentId:n}:null},tn=(t,n)=>{const s=Gt(n);if(!s)return!0;const i=Gt(t);return(i==null?void 0:i.fragmentId)===s.fragmentId},wt=t=>{const n=t==null?void 0:t.trim().toLowerCase();return n||null},Ws=(t,n)=>{if((wt(t.childItemType)??"info")!==(n.cardType??"").toLowerCase()||t.childItemId!==n.cardId)return!1;const i=wt(t.childCheckType),r=wt(t.childDirection),u=wt(n.checkType),m=wt(n.direction);return!(i&&i!==u||r&&r!==m)},Pr={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},Kr={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},an=(t,n,s)=>{if(!s||!n.startsWith(t))return n;const i=n.slice(t.length);if(!i)return n;const r=s==="super"?Pr:Kr,u=i.split("").map(m=>r[m]??m).join("");return t+u},nn=(t,n,s)=>{var m,k,j;if(!t)return((m=n[0])==null?void 0:m.key)??null;const i=new Set(n.map(M=>M.key)),r=/\{([^}]+)\}/g;let u;for(;(u=r.exec(t))!==null;){const M=((k=u[1])==null?void 0:k.trim())??"";if(!M)continue;if(i.has(M))return M;const o=s==null?void 0:s[M];if(o&&i.has(o))return o}return((j=n[0])==null?void 0:j.key)??null},Pa=t=>(()=>{const n=new Set;return t.flatMap(s=>{if(s.cardType!=="info"||s.infoType!=="citation")return[s];const i=s.description??"";if(!i.trim())return[s];const r=ja(i),u=Object.keys(r.nodes);return u.length===0?[s]:u.map(m=>({...s,checkType:"quote-fragment",direction:m})).filter(m=>{const k=[m.cardId,m.checkType??"",m.direction??""].join("|");return n.has(k)?!1:(n.add(k),!0)})})})();function js({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o,collectionId:x,revisionId:l}){const d=Fa(),v=`/#/cogita/library/${o}`,w=a.useMemo(()=>new URLSearchParams(d.search),[d.search]),S=Math.max(1,Number(w.get("limit")??20)),D=w.get("mode")??"random",f=a.useMemo(()=>qn(D),[D]),g=a.useMemo(()=>un(f,Vs(f,w)),[f,w]),le=w.get("check")??"exact",P=w.get("reviewer"),p=(w.get("scope")??"").trim(),V=p==="info"||p==="info-selection"?p:"collection",N=V==="info"?(w.get("infoId")??"").trim():"",W=V==="info-selection"?(w.get("seed")??"").trim():"",R=V==="collection"&&!!x,I=a.useMemo(()=>t.cogita.library.revision[f.labelKey]??D,[t,D,f]),re=a.useMemo(()=>le==="exact"?t.cogita.library.revision.checkValue:le,[t,le]),[ce,xe]=a.useState(t.cogita.library.collections.defaultName),[Te,Z]=a.useState([]),[C,Ie]=a.useState([]),[B,ee]=a.useState("idle"),[q,fe]=a.useState({current:0,total:0}),[X,de]=a.useState(0),[ye,Pe]=a.useState(""),[Ve,Ce]=a.useState(null),[He,Ze]=a.useState(null),[Me,We]=a.useState(null),[rt,ot]=a.useState(null),[_e,je]=a.useState([]),[J,Le]=a.useState({}),[oe,_]=a.useState({}),[me,Ge]=a.useState(null),[$,A]=a.useState(null),[Y,se]=a.useState(null),[T,U]=a.useState(null),[K,H]=a.useState(null),[ie,ke]=a.useState({}),Ae=a.useRef(0),[De,ve]=a.useState(null),be=a.useRef(null),ue=a.useRef(null),[Xe,Qe]=a.useState(null),[Ye,et]=a.useState(!1),[nt,qe]=a.useState(null),[ut,jt]=a.useState([]),[yt,St]=a.useState(null),Pt=a.useRef(null),Mt=a.useRef(null),[Ft,xt]=a.useState(null),[Lt,vt]=a.useState(0),kt=a.useRef(null),Vt=a.useRef({}),[Ut,tt]=a.useState(!1),[gt,Rt]=a.useState({}),[Tt,Ke]=a.useState([]),mt=a.useRef(new Map),[Ct,It]=a.useState(new Set),[ha,ae]=a.useState(!1),qt=a.useRef(null),Et=a.useRef(new Set),Dt=a.useRef({}),h=Te[X]??null,Ne=(h==null?void 0:h.checkType)==="translation-match"&&K,Oe=a.useRef(new Map),lt=a.useRef(new Map),Nt=a.useRef(new Map),Yt=a.useRef(new Map),Qt=a.useMemo(()=>h?h.cardType==="vocab"?t.cogita.library.revision.vocabLabel:h.infoType?at(t,h.infoType):t.cogita.library.revision.infoLabel:"",[t,h]),b=a.useMemo(()=>{var y;return f.id!=="levels"?Te.length:((y=gt.pool)==null?void 0:y.length)??f.getFetchLimit(S,g)},[gt,g,f,Te.length,S]),Re=f.getProgressTotal?f.getProgressTotal(Te,gt,S,g):f.id==="levels"?Math.min(S,b):Te.length,ze=Re?Math.min(X+1,Re):0,Ue=Math.max(1,Number(g.tries??1)),pt=g.compare??"anchors",ft=Math.max(0,Math.min(100,Number(g.minCorrectness??0))),ht=(g.considerDependencies??"on")==="on",bt=Math.max(0,Math.min(100,Number(g.dependencyThreshold??85))),Jt=c=>{const y=c.slice();for(let F=y.length-1;F>0;F-=1){const O=Math.floor(Math.random()*(F+1));[y[F],y[O]]=[y[O],y[F]]}return y},Xt=c=>ba(c,{treatSimilarCharsAsSame:!0})>=ft,ka=async()=>{const c=await ca(),y=new Map,F=new Map,O=new Map;c.forEach(E=>{const te=`${E.itemType}:${E.itemId}`,we=na(E.itemType,E.itemId,E.checkType,E.direction);if(y.has(te)||y.set(te,[]),y.get(te).push(E),F.has(we)||F.set(we,[]),F.get(we).push(E),E.itemType==="info"&&E.checkType==="quote-fragment"&&E.direction){const Fe=`${E.itemId}:${E.direction}`;O.has(Fe)||O.set(Fe,[]),O.get(Fe).push(E)}});const Q=new Map,z=new Map,ne=new Map;return y.forEach((E,te)=>Q.set(te,la(E).score)),F.forEach((E,te)=>z.set(te,la(E).score)),O.forEach((E,te)=>ne.set(te,la(E).score)),{itemKnowness:Q,cardKnowness:z,fragmentKnowness:ne}},Ot=async c=>{const y=[];let F=null;for(;;){const O=await Ha({libraryId:o,collectionId:c,limit:200,cursor:F});if(y.push(...O.items),!O.nextCursor)break;F=O.nextCursor}return Pa(y)},ta=async(c,y)=>{if(mt.current.has(c))return mt.current.get(c)??0;const F=await Ot(c);if(F.length===0)return mt.current.set(c,0),0;const Q=F.reduce((z,ne)=>{const E=pe(ne);return z+(y.get(E)??0)},0)/F.length;return mt.current.set(c,Q),Q},Na=(c,y)=>{if(!ht||c.cardType!=="info"||c.infoType!=="citation"||c.checkType!=="quote-fragment")return!0;const F=Gt(c.direction);if(!(F!=null&&F.fragmentId))return!0;const O=c.description??"";if(!O.trim())return!0;const z=ja(O).nodes[F.fragmentId];if(!z||!z.leftId&&!z.rightId)return!0;const ne=[z.leftId,z.rightId].filter(we=>!!we);if(ne.length===0)return!0;const E=ne.map(we=>{const Fe=na("info",c.cardId,"quote-fragment",we);return y.get(Fe)??0});return E.reduce((we,Fe)=>we+Fe,0)/E.length>=bt},zt=async c=>{const y=gt,F=c.concat(y.active??[]).concat(y.pool??[]).filter((E,te,we)=>we.findIndex(Fe=>pe(Fe)===pe(E))===te);if(!ht){It(new Set(F.map(pe)));return}const{itemKnowness:O,cardKnowness:Q}=await ka(),z=Tt.filter(E=>wt(E.childItemType)==="collection"&&E.childItemId===x&&!wt(E.childCheckType)&&!wt(E.childDirection)),ne=new Set;for(const E of F){if(E.cardType!=="info"){ne.add(pe(E));continue}if(!Na(E,Q))continue;const te=Tt.filter(Be=>Ws(Be,E)).concat(z);if(te.length===0){ne.add(pe(E));continue}let we=0;for(const Be of te)if(wt(Be.parentItemType)==="collection")we+=await ta(Be.parentItemId,Q);else if(wt(Be.parentCheckType)||wt(Be.parentDirection)){const Je=wt(Be.parentCheckType),st=wt(Be.parentDirection),it=na(Be.parentItemType,Be.parentItemId,Je,st);we+=Q.get(it)??0}else{const Je=`${Be.parentItemType}:${Be.parentItemId}`;we+=O.get(Je)??0}we/te.length>=bt&&ne.add(pe(E))}It(ne)},$t=c=>{for(let y=c;y<Te.length;y+=1){const F=Te[y];if(F&&(!ht||F.cardType!=="info"||Ct.has(pe(F))))return y}return-1},Zt=c=>!ht||c.cardType!=="info"||Ct.has(pe(c)),za=c=>{if(f.id!=="temporal"&&f.id!=="levels")return null;const y=gt,F=(y.active??[]).concat(y.pool??[]),O=new Set;for(const Q of F){const z=pe(Q);if(!(O.has(z)||c.has(z))&&(O.add(z),Zt(Q)))return Q}return null},aa=a.useMemo(()=>{if(f.id!=="levels")return null;const c=gt,y=c.pool??[],F=c.active??[],O=c.levelMap??{},Q=Math.max(1,Number(g.levels??1)),z=Array.from({length:Q},()=>0),ne=new Set(F.map(Fe=>pe(Fe)));y.forEach(Fe=>{const Be=Math.min(Q,Math.max(1,O[pe(Fe)]??1));z[Be-1]+=1});const E=y.length||1,te=z.map(Fe=>Fe/E*100),we=h?O[pe(h)]??1:null;return{counts:z,percentages:te,currentLevel:we,levelsCount:Q,activeCount:F.length,poolCount:y.length,activeSet:ne}},[gt,g,f,h]),Sa=a.useMemo(()=>{if(f.id!=="temporal")return null;const c=gt,y=c.pool??[],F=c.active??[],O=c.knownessMap??{},Q=new Set(c.unknownSet??[]);let z=0;y.forEach(te=>{(O[pe(te)]??0)>1&&(z+=1)});const ne=Q.size,E=F.map(te=>({id:pe(te),value:Q.has(pe(te))?0:Math.max(0,Math.min(1,O[pe(te)]??0))}));return{knownCount:z,unknownCount:ne,dots:E}},[gt,f]),hn=a.useMemo(()=>{if(!ht)return 0;const c=gt;return Te.concat(c.active??[]).concat(c.pool??[]).filter((F,O,Q)=>Q.findIndex(z=>pe(z)===pe(F))===O).filter(F=>F.cardType==="info"&&!Ct.has(pe(F))).length},[ht,gt,Te,Ct]);a.useEffect(()=>{if(!ht||B!=="ready")return;const c=gt,F=Te.concat(c.active??[]).concat(c.pool??[]).filter((z,ne,E)=>E.findIndex(te=>pe(te)===pe(z))===ne).filter(z=>z.cardType!=="info"||Ct.has(pe(z))).length,O=Pt.current;if(Pt.current=F,O===null||F<=O)return;const Q=F-O;St(`New card available (+${Q})`),Mt.current&&window.clearTimeout(Mt.current),Mt.current=window.setTimeout(()=>St(null),2200)},[ht,B,gt,Te,Ct]),a.useEffect(()=>()=>{Mt.current&&window.clearTimeout(Mt.current)},[]);const Bt=(c,y)=>{const F=f.applyOutcome({queue:Te,meta:gt},h,S,g,{correct:c,correctness:y,createdUtc:new Date().toISOString()});Z(F.queue),Rt(F.meta);const O=F.queue[X+1];O&&Ra(O,X+1)};a.useEffect(()=>{if(R&&x){ln(o,x).then(c=>xe(c.name)).catch(()=>xe(t.cogita.library.collections.defaultName));return}if(V==="info"&&N){da({libraryId:o,infoId:N}).then(c=>{const y=c.payload??{};xe(y.title||y.label||y.name||N)}).catch(()=>xe(N||t.cogita.library.revision.runKicker));return}if(V==="info-selection"){const c=W?es(o,W):null,y=(c==null?void 0:c.infoIds.length)??0;xe(y>0?`Selected infos (${y})`:"Selected infos");return}xe(t.cogita.library.collections.defaultName)},[t,R,x,o,V,N,W]),a.useEffect(()=>{Dn({libraryId:o,type:"language"}).then(c=>Ie(c)).catch(()=>Ie([]))},[o]),a.useEffect(()=>{R&&Fn({libraryId:o}).then(c=>Ke(c.items??[])).catch(()=>Ke([]))},[R,o]),a.useEffect(()=>{Tn(o,P)},[o,P]),a.useEffect(()=>{zt(Te)},[Te,Tt,ht,bt,x]),a.useEffect(()=>{if(!h||!ht){ae(!1);return}if(h.cardType!=="info"||Ct.has(pe(h))){ae(!1);return}const c=$t(X+1);if(c>=0){ae(!1),de(c);return}if(f.id==="temporal"||f.id==="levels"){const y=Te.slice(0,X+1),F=Te.slice(X+1).filter(Zt),O=y.concat(F),Q=new Set(O.map(pe)),z=za(Q);if(z){const E=pe(z);Q.has(E)||(O.push(z),Q.add(E),Rt(te=>{const we=te,Fe=new Set(we.queued??[]);return Fe.add(E),{...we,queued:Fe}}))}const ne=O.findIndex((E,te)=>te!==X&&Zt(E));if(ne>=0){Z(O),de(ne),ae(!1);return}}ae(!0)},[h,Ct,ht,X,Te,gt,f.id]),a.useEffect(()=>{let c=!0;return(async()=>{ee("loading"),fe({current:0,total:f.id==="levels"?0:f.getFetchLimit(S,g)});try{if(!R){if(Ke([]),V==="info"){if(!N){c&&(Z([]),Ke([]),Rt({}),de(0),ee("ready"));return}const[Be,Je]=await Promise.all([qa({libraryId:o,infoId:N}),Ja({libraryId:o,infoId:N})]);if(!c)return;const st=Pa(Be.items??[]);Ke(Je.items??[]);const it=f.prepare(st,S,g);Z(it.queue),Rt(it.meta),de(0),ee("ready"),fe({current:st.length,total:st.length});return}if(V==="info-selection"){const Be=W?es(o,W):null,Je=(Be==null?void 0:Be.infoIds)??[];if(!Je.length){c&&(Z([]),Ke([]),Rt({}),de(0),ee("ready"));return}const st=await Promise.all(Je.map(async ma=>{const[Wt,Ba]=await Promise.all([qa({libraryId:o,infoId:ma}),Ja({libraryId:o,infoId:ma})]);return{cards:Wt.items??[],deps:Ba.items??[]}}));if(!c)return;const it=new Map;st.forEach(ma=>{Pa(ma.cards).forEach(Wt=>{it.set(pe(Wt),Wt)})});const ct=Array.from(it.values()),dt=new Set(ct.map(pe)),At=new Map;st.forEach(ma=>{(ma.deps??[]).forEach(Wt=>{const Ba=na(Wt.parentItemType,Wt.parentItemId,wt(Wt.parentCheckType),wt(Wt.parentDirection)),Jn=na(Wt.childItemType,Wt.childItemId,wt(Wt.childCheckType),wt(Wt.childDirection));if(!dt.has(Ba)||!dt.has(Jn))return;const Hn=`${Ba}->${Jn}`;At.has(Hn)||At.set(Hn,Wt)})}),Ke(Array.from(At.values()));const va=f.prepare(ct,S,g);Z(va.queue),Rt(va.meta),de(0),ee("ready"),fe({current:ct.length,total:ct.length});return}}const F=[];let O=null,Q=null;do{const Be=await Ha({libraryId:o,collectionId:x,limit:300,cursor:O});if(F.push(...Be.items),(f.id==="levels"||f.id==="temporal")&&Be.total&&(Q=Be.total),fe(Je=>({current:F.length,total:Je.total||Be.total||f.getFetchLimit(S,g)})),O=Be.nextCursor??null,Q!==null&&F.length>=Q||f.id!=="levels"&&f.id!=="temporal"&&F.length>=f.getFetchLimit(S,g))break}while(O);if(!c)return;const z=Pa(F);let ne;if(f.id==="levels"){const Be=Math.max(1,Number(g.levels??1)),st=(await ca()).reduce((it,ct)=>{const dt=na(ct.itemType,ct.itemId,ct.checkType,ct.direction);return it[dt]||(it[dt]=[]),it[dt].push(ct),it},{});ne={},z.forEach(it=>{const ct=pe(it),dt=st[ct]??[],At=dt.length>0?la(dt).score:0,va=Math.max(1,Math.min(Be,Math.ceil(At/100*Be)));ne[ct]=va})}let E=null,te=null,we=null;if(f.id==="temporal"){const Be=await ca(),Je=new Set(z.map(ct=>pe(ct))),st=Be.reduce((ct,dt)=>{const At=na(dt.itemType,dt.itemId,dt.checkType,dt.direction);return Je.has(At)&&(ct[At]||(ct[At]=[]),ct[At].push(dt)),ct},{});E={},te=new Set,we={};const it=Date.now();z.forEach(ct=>{const dt=pe(ct),At=st[dt]??[];if(At.length===0){E[dt]=0,te.add(dt),we[dt]=[];return}const va=Vn(At);we[dt]=va;const ma=cn(va,it);E[dt]=ma.knowness})}const Fe=f.id==="levels"?Un(z,S,g,ne):f.id==="temporal"?On(z,S,g,E??{},te??new Set,we??{}):f.prepare(z,S,g);Z(Fe.queue),Rt(Fe.meta),de(0),ee("ready"),fe(Be=>({current:Math.min(Be.current,Be.total),total:Be.total}))}catch{c&&ee("error")}})(),()=>{c=!1}},[x,R,o,S,V,g,f,P,N,W]),a.useEffect(()=>{if(Pe(""),Ce(null),xt(null),vt(0),je([]),Le({}),_({}),A(null),se(null),U(null),et(!1),tt(!1),Qe(null),H(null),ke({}),!h){Ze(null),We(null),Ge(null),qe(null);return}h.cardType==="info"&&h.infoType==="computed"&&Ze(t.cogita.library.revision.loadingComputed);let c=!0;return Ra(h,X).then(y=>{!c||!y||(Ze(y.prompt),We(y.expectedAnswer),je(y.computedExpected),Le(y.computedAnswers),Ge(y.computedValues),A(y.answerTemplate),se(y.outputVariables),U(y.variableValues))}),()=>{c=!1}},[h,t]),a.useEffect(()=>{if(!h||h.cardType!=="info"||h.infoType!=="citation"){qt.current=null,Et.current=new Set,ot(null);return}const c=h.description??"",y=(h.label??"").trim(),F=y.replace(/\s+/g," ").trim(),O=c.replace(/\s+/g," ").trim(),Q=F&&F!==O?y:t.cogita.library.infoTypes.citation;if(!c){ot(null),We(null);return}const z=ja(c);qt.current=z,Ze(Q);let ne=!0;return ka().then(({fragmentKnowness:E})=>{if(!ne)return;const te=new Set,we={};E.forEach((Je,st)=>{const[it,ct]=st.split(":",2);if(it!==h.cardId)return;const dt=Gt(ct);if(!dt)return;const{fragmentId:At}=dt;we[At]=Je,Je>=bt&&te.add(At)}),Et.current=te,Dt.current=we;const Fe=Gt(h.direction);if(Fe!=null&&Fe.fragmentId&&z.nodes[Fe.fragmentId]){xa(z,Fe.fragmentId,Q);return}const Be=Ma(z,te,we,bt,ht,h.direction);xa(z,(Be==null?void 0:Be.id)??null,Q)}).catch(()=>{Et.current=new Set,Dt.current={};const E=Gt(h.direction);if(E!=null&&E.fragmentId&&z.nodes[E.fragmentId]){xa(z,E.fragmentId,Q);return}const te=Ma(z,Et.current,{},bt,ht,h.direction);xa(z,(te==null?void 0:te.id)??null,Q)}),()=>{ne=!1}},[h,t,ht,bt]),a.useEffect(()=>{if(!h||h.cardType!=="vocab"||h.checkType!=="translation-match"){H(null),ke({});return}const F=(gt.pool??gt.active??Te).filter(E=>E.cardType==="vocab"&&E.checkType==="translation-match").filter((E,te,we)=>we.findIndex(Fe=>Fe.cardId===E.cardId)===te);F.some(E=>E.cardId===h.cardId)||F.unshift(h);const Q=Jt(F).slice(0,6).map(E=>{const te=E.label.split("↔").map(Be=>Be.trim()).filter(Boolean);if(te.length<2)return null;const we=`${E.cardId}:L`,Fe=`${E.cardId}:R`;return{cardId:E.cardId,leftId:we,rightId:Fe,leftLabel:te[0],rightLabel:te[1]}}).filter(Boolean),z=Q.map(E=>E.leftId),ne=Jt(Q.map(E=>E.rightId));H({pairs:Q,leftOrder:z,rightOrder:ne,selection:{},activeLeft:null,activeRight:null,locked:{}})},[h,Te,gt]),a.useEffect(()=>()=>{be.current&&window.clearTimeout(be.current),ue.current&&window.clearTimeout(ue.current)},[]);const Ht=a.useRef(null);a.useEffect(()=>{if(!h)return;const c=pe(h),y=typeof document<"u"?document.activeElement:null;if(Ht.current===c&&y&&(y.tagName==="INPUT"||y.tagName==="TEXTAREA"))return;let F=0;const O=()=>{if(h){if(h.cardType==="info"&&h.infoType==="computed"){if(_e.length>0){const z=nn($,_e,Y),ne=z?Vt.current[z]:null;if(ne&&(ne.focus(),document.activeElement===ne)){Ht.current=c;return}}if(kt.current&&(kt.current.focus(),document.activeElement===kt.current)){Ht.current=c;return}}else if(h.cardType==="vocab"&&kt.current&&(kt.current.focus(),document.activeElement===kt.current)){Ht.current=c;return}F<6&&(F+=1,window.setTimeout(O,40))}},Q=window.setTimeout(O,40);return()=>window.clearTimeout(Q)},[h,_e,$,Y]),a.useEffect(()=>{if(!Ut)return;const c=y=>{y.key==="Enter"&&(y.preventDefault(),ya())};return window.addEventListener("keydown",c),()=>window.removeEventListener("keydown",c)},[Ut]);const Ta=c=>{jt(c),qe(la(c))};a.useEffect(()=>{if(!h){qe(null),jt([]);return}const c=h.cardType==="info"?"info":"connection";if(h.cardType==="info"&&h.infoType==="citation"){ca().then(y=>{const F=y.filter(O=>O.itemType==="info"&&O.itemId===h.cardId&&O.checkType==="quote-fragment"&&tn(O.direction,h.direction));Ta(F)}).catch(()=>{qe(null),jt([])});return}en(c,h.cardId,h.checkType,h.direction).then(y=>Ta(y)).catch(()=>{qe(null),jt([])})},[o,h,P]);const Ca=(c,y,F,O)=>{if(c==="info"&&F==="quote-fragment"){ca().then(Q=>{const z=Q.filter(ne=>ne.itemType==="info"&&ne.itemId===y&&ne.checkType==="quote-fragment"&&tn(ne.direction,O));Ta(z)}).catch(()=>{qe(null),jt([])});return}en(c,y,F,O).then(Q=>Ta(Q)).catch(()=>{qe(null),jt([])})},ga=(c,y,F)=>{var ne;const O=((ne=F.pairs.find(E=>E.leftId===c))==null?void 0:ne.rightId)??null;if(!O)return F;const Q=O===y;ke(E=>({...E,[c]:Q?"correct":"incorrect"})),be.current&&window.clearTimeout(be.current),ue.current&&window.clearTimeout(ue.current),Ae.current+=1;const z={kind:Q?"correct":"incorrect",tick:Ae.current};if(ve(null),be.current=window.setTimeout(()=>ve(z),0),ue.current=window.setTimeout(()=>ve(null),420),Q){const E={...F.locked,[c]:!0};return Object.keys(E).length>=F.pairs.length?(Ce("correct"),tt(!0)):Ce("correct"),{...F,selection:{...F.selection,[c]:y},activeLeft:null,activeRight:null,locked:E}}return Ce("incorrect"),{...F,activeLeft:null,activeRight:null}},gn=c=>{H(y=>!y||y.locked[c]?y:y.activeRight?ga(c,y.activeRight,y):{...y,activeLeft:y.activeLeft===c?null:c})},Ia=c=>{H(y=>y&&(y.activeLeft?ga(y.activeLeft,c,y):{...y,activeRight:y.activeRight===c?null:c}))},ya=()=>{var c;if(h&&h.cardType==="info"&&h.infoType==="citation"&&qt.current&&rt&&!((c=Gt(h.direction))!=null&&c.fragmentId)){const y=Ma(qt.current,Et.current,Dt.current,bt,ht,h.direction,rt.fragmentId);if(y){Ce(null),Pe(""),et(!1),_({}),tt(!1),xt(null),vt(0),xa(qt.current,y.id,rt.title);return}}Ce(null),Pe(""),et(!1),_({}),tt(!1),xt(null),vt(0),de(y=>Math.min(y+1,Te.length))},sa=c=>{if(!h)return;const y=c.expected??null,F=c.answer??"";let O=y??"",Q=F;if(!y&&c.expectedMap&&c.answerMap){const Be=Object.keys(c.expectedMap).sort((Je,st)=>Je.localeCompare(st));O=Be.map(Je=>{var st;return((st=c.expectedMap)==null?void 0:st[Je])??""}).join("|"),Q=Be.map(Je=>{var st;return((st=c.answerMap)==null?void 0:st[Je])??""}).join("|")}const z=O?La(O,Q,pt):new Uint8Array,ne={revisionType:f.id,evalType:c.evalType,direction:c.direction,prompt:He??"",expected:y,answer:F,expectedAnswers:c.expectedMap??null,answers:c.answerMap??null,correct:c.correct,maskBase64:z.length?fa(z):null,values:me??null,checkMode:le,compareMode:pt,minCorrectness:ft},E=new TextEncoder().encode(JSON.stringify(ne)),te=h.cardType==="info"?"info":"connection",we=c.overrideCheckType??h.checkType??null,Fe=c.overrideDirection??h.direction??null;Za({itemType:te,itemId:h.cardId,checkType:we,direction:Fe,revisionType:f.id,evalType:c.evalType,correct:c.correct,maskBase64:z.length?fa(z):null,payloadBase64:fa(E),personRoleId:P??null}).then(()=>{Ca(te,h.cardId,we,Fe),zt(Te),Tn(o,P)}).catch(()=>{})},mn=(c,y)=>{const F=Oe.current.get(y);if(F)return Promise.resolve(F);const O=lt.current.get(y);if(O)return O;const Q=da({libraryId:o,infoId:c}).then(z=>{var Be,Je;const ne=z.payload,E=((Be=ne.definition)==null?void 0:Be.graph)??null,te="",we=((Je=ne.definition)==null?void 0:Je.answerTemplate)??"",Fe=Os(E,te,we);if(Fe){const it={sample:Us(Fe),answerTemplate:we||null};return Oe.current.set(y,it),it}return Yn({libraryId:o,infoId:c}).then(st=>{const it={sample:st,answerTemplate:null};return Oe.current.set(y,it),it})}).catch(()=>Yn({libraryId:o,infoId:c}).then(z=>{const ne={sample:z,answerTemplate:null};return Oe.current.set(y,ne),ne}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{lt.current.delete(y)});return lt.current.set(y,Q),Q},Ra=(c,y)=>{var E;const F=`${pe(c)}:${y}`,O=Nt.current.get(F);if(O)return Promise.resolve(O);const Q=Yt.current.get(F);if(Q)return Q;const z=te=>(Nt.current.set(F,te),te);let ne;if(c.cardType==="vocab"){if(c.checkType==="translation-match")return ne=Promise.resolve(z({prompt:c.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),ne;const te=c.label.split("↔").map(we=>we.trim()).filter(Boolean);if(te.length>=2){const Fe=(c.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",Be=Fe?te[0]:te[1],Je=Fe?te[1]:te[0];ne=Promise.resolve(z({prompt:Be,expectedAnswer:Je,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else ne=Promise.resolve(z({prompt:c.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(c.cardType==="info"&&c.infoType==="word"){const te=(E=c.description)!=null&&E.startsWith("Language: ")?c.description.replace("Language: ",""):null;ne=Promise.resolve(z({prompt:c.label,expectedAnswer:te,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else c.cardType==="info"&&c.infoType==="computed"?ne=mn(c.cardId,F).then(te=>{var st,it;if(!te.sample)return z({prompt:c.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const we=te.sample,Fe=we.expectedAnswers?Object.entries(we.expectedAnswers).map(([ct,dt])=>({key:ct,expected:dt})):[],Be=Fe.reduce((ct,dt)=>(ct[dt.key]="",ct),{}),Je=we.expectedAnswerIsSentence&&((st=we.expectedAnswer)==null?void 0:st.trim())||null;return z({prompt:we.prompt,expectedAnswer:Fe.length>0?Je:((it=we.expectedAnswer)==null?void 0:it.trim())||null,computedExpected:Fe,computedAnswers:Be,computedValues:we.values??null,answerTemplate:te.answerTemplate,outputVariables:we.outputVariables??null,variableValues:we.variableValues??null})}).catch(()=>z({prompt:c.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Yt.current.delete(F)}):ne=Promise.resolve(z({prompt:c.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return Yt.current.set(F,ne),ne},xa=(c,y,F)=>{const O=Object.keys(c.nodes).length,Q=Et.current.size;if(!y){ot({title:F,before:c.text,after:"",fragmentId:null,total:O,completed:Q}),We(null),tt(!0);return}const z=c.nodes[y];if(!z)return;const ne=zn(c.text,z);ot({title:F,before:ne.before,after:ne.after,fragmentId:z.id,total:O,completed:Q}),We(ne.fragment),tt(!1)},pn=()=>{const c=qt.current;c&&ot(y=>y&&{...y,total:Object.keys(c.nodes).length,completed:Et.current.size})},ia=()=>{const c=Te[X+1];c&&Ra(c,X+1)},L=()=>{if(ia(),h&&h.cardType==="vocab"&&h.checkType==="translation-match"&&K){if(K.pairs.length===0){Ce("incorrect"),tt(!0);return}const z=K.pairs.reduce((Je,st)=>(Je[st.rightId]=st.rightLabel,Je),{});let ne=0;const E={};K.pairs.forEach(Je=>{const it=K.selection[Je.leftId]===Je.rightId;E[Je.leftId]=it?"correct":"incorrect",it&&(ne+=1)});const te=K.pairs.length||1,we=ne/te,Fe=ne===K.pairs.length;ke(Je=>({...Je,...E})),Fe?(Ce("correct"),tt(!0),vt(0)):(Ce("incorrect"),tt(!1),vt(Je=>{const st=Je+1;return st>=Ue&&(et(!0),tt(!0),H(it=>{if(!it)return it;const ct=it.pairs.reduce((dt,At)=>(dt[At.leftId]=At.rightId,dt),{});return{...it,selection:ct}})),st})),Bt(Fe,we);const Be="connection";Promise.all(K.pairs.map(Je=>{const st=K.selection[Je.leftId]??null,it=st?z[st]:"",ct={left:Je.leftLabel,expected:Je.rightLabel,answer:it,checkType:"translation-match"},dt=new TextEncoder().encode(JSON.stringify(ct));return Za({itemType:Be,itemId:Je.cardId,checkType:"translation-match",direction:null,revisionType:f.id,evalType:"translation-match",correct:st===Je.rightId,maskBase64:null,payloadBase64:fa(dt),personRoleId:P??null})})).then(()=>{Ca(Be,h.cardId,h.checkType,h.direction),Tn(o,P)}).catch(()=>{});return}if(_e.length>0){const z=_e.reduce((E,te)=>{const we=J[te.key]??"";return E[te.key]=_t(we)===_t(te.expected)?"correct":"incorrect",E},{});_e.every(({key:E,expected:te})=>{const we=J[E]??"";return le==="exact"&&_t(we)===_t(te)})?(Ce("correct"),_(z),tt(!0),vt(0),Bt(!0,1),sa({correct:!0,direction:He?`${He} -> computed`:"computed",expectedMap:_e.reduce((E,te)=>(E[te.key]=te.expected,E),{}),answerMap:J,evalType:"computed"})):(Ce("incorrect"),_(z),tt(!1),vt(E=>{const te=E+1;return te>=Ue&&Se&&(et(!0),tt(!0)),te}),Bt(!1,0),window.setTimeout(()=>{var te;const E=nn($,_e,Y);E&&Vt.current[E]&&((te=Vt.current[E])==null||te.focus())},40),sa({correct:!1,direction:He?`${He} -> computed`:"computed",expectedMap:_e.reduce((E,te)=>(E[te.key]=te.expected,E),{}),answerMap:J,evalType:"computed"}));return}if(h&&h.cardType==="info"&&h.infoType==="citation"&&(rt!=null&&rt.fragmentId)){if(!Me)return;const z=Gt(h.direction),ne=(z==null?void 0:z.fragmentId)??rt.fragmentId,E=Qa(Me,ye,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),te=E.mask,we=E.isCorrect,Fe=E.percent;we?(Dt.current[rt.fragmentId]=Math.max(Dt.current[rt.fragmentId]??0,Fe),(Dt.current[rt.fragmentId]??0)>=bt&&Et.current.add(rt.fragmentId),pn(),Ce("correct"),_({}),tt(!0),xt(te),vt(0),Fe<100&&Ue<=1&&et(!0),Bt(!0,Fe/100),sa({correct:!0,direction:`quote:${rt.fragmentId}`,expected:Me,answer:ye,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:ne})):(Ce("incorrect"),_({}),tt(!1),xt(te),vt(Be=>{const Je=Be+1;return Je>=Ue&&Se&&(et(!0),tt(!0)),Je}),Bt(!1,Fe/100),window.setTimeout(()=>{var Be;return(Be=kt.current)==null?void 0:Be.focus()},40),sa({correct:!1,direction:`quote:${rt.fragmentId}`,expected:Me,answer:ye,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:ne}));return}if(!Me)return;const c=La(Me,ye,pt),y=le==="exact"&&_t(ye)===_t(Me),F=Xt(c),O=y||F,Q=ba(c);O?(Ce("correct"),_({}),tt(!0),xt(c),vt(0),Q<100&&Ue<=1&&et(!0),Bt(!0,Q/100),sa({correct:!0,direction:He?`${He} -> ${Me}`:null,expected:Me,answer:ye,evalType:"text"})):(Ce("incorrect"),_({}),tt(!1),xt(c),vt(z=>{const ne=z+1;return ne>=Ue&&Se&&(et(!0),tt(!0)),ne}),Bt(!1,Q/100),window.setTimeout(()=>{var z;return(z=kt.current)==null?void 0:z.focus()},40),sa({correct:!1,direction:He?`${He} -> ${Me}`:null,expected:Me,answer:ye,evalType:"text"}))},G=c=>{if(ia(),!Me)return;const y=La(Me,c,pt),F=_t(c)===_t(Me),O=Xt(y),Q=F||O,z=ba(y);Q?(Ce("correct"),_({}),tt(!0),xt(y),vt(0),z<100&&Ue<=1&&et(!0),Bt(!0,z/100),sa({correct:!0,direction:"word->language",expected:Me,answer:c,evalType:"language-select"})):(Ce("incorrect"),_({}),tt(!1),xt(y),vt(ne=>{const E=ne+1;return E>=Ue&&Se&&(et(!0),tt(!0)),E}),Bt(!1,z/100),sa({correct:!1,direction:"word->language",expected:Me,answer:c,evalType:"language-select"}))},ge=()=>{ia(),Ce("correct"),tt(!0),vt(0),Bt(!0,1),Me&&sa({correct:!0,direction:"manual",expected:Me,answer:ye,evalType:"manual"})},$e=()=>{if(Bt(!1,0),h&&h.cardType==="info"&&h.infoType==="citation"){Ce(null),Pe(""),et(!1),_({}),tt(!1),xt(null),vt(0),de(c=>Math.min(c+1,Te.length));return}ya()};a.useEffect(()=>{ia()},[X,Te]);const Ee=c=>{var F;if(c.key!=="Enter")return;if(c.preventDefault(),c.stopPropagation(),Ut){ya();return}const y=_e.find(O=>!(J[O.key]??"").trim());if(y){(F=Vt.current[y.key])==null||F.focus();return}L()},he=t.cogita.library.revision.revealModeAfterIncorrect,Se=_e.length>0||!!Me;return e.jsxs(Kt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:[B==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${q.total?Math.min(100,Math.max(0,q.current/q.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:q.total?`${Math.min(q.current,q.total)} / ${q.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:ce}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",I).replace("{check}",re)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),R?e.jsxs(e.Fragment,{children:[e.jsx("a",{className:"cta ghost",href:`${v}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${v}/collections/${x}`,children:t.cogita.library.actions.collectionDetail})]}):e.jsx("a",{className:"cta ghost",href:`${v}/list`,children:t.cogita.library.actions.allCards})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:nt?`${nt.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[aa?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",aa.currentLevel??"-"," / ",aa.levelsCount]}):null,nt?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(nt.correct)).replace("{total}",String(nt.total))}),nt.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(nt.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(qs,{outcomes:ut})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[yt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:yt})}):null,e.jsx(Bn,{feedbackToken:De?`${De.kind}-${De.tick}`:Ne?"idle":Ve??"idle",children:h?e.jsx(e.Fragment,{children:ha?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(_n,{copy:t,currentCard:h,currentTypeLabel:Qt,prompt:He,languages:C,answer:ye,onAnswerChange:c=>Pe(y=>an(y,c,Xe)),computedExpected:_e,computedAnswers:J,onComputedAnswerChange:(c,y)=>Le(F=>({...F,[c]:an(F[c]??"",y,Xe)})),answerTemplate:$,outputVariables:Y,variableValues:T,computedFieldFeedback:oe,feedback:Ve,canAdvance:Ut,quoteContext:rt,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:L,onSkip:$e,onLanguageSelect:G,onMarkReviewed:ge,onAdvance:ya,showCorrectAnswer:Ye,setShowCorrectAnswer:et,onRevealCorrect:()=>tt(!0),answerMask:Ft,expectedAnswer:Me,hasExpectedAnswer:Se,handleComputedKeyDown:Ee,answerInputRef:kt,computedInputRefs:Vt,scriptMode:Xe,setScriptMode:Qe,matchPairs:K==null?void 0:K.pairs,matchLeftOrder:K==null?void 0:K.leftOrder,matchRightOrder:K==null?void 0:K.rightOrder,matchSelection:K==null?void 0:K.selection,matchActiveLeft:K==null?void 0:K.activeLeft,matchActiveRight:K==null?void 0:K.activeRight,matchFeedback:ie,onMatchLeftSelect:gn,onMatchRightSelect:Ia})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:R?`${v}/collections/${x}`:`${v}/list`,children:R?t.cogita.library.actions.collectionDetail:t.cogita.library.actions.allCards})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Re?`${ze} / ${Re}`:t.cogita.library.revision.progressUnlimited}),B==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),B==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),B==="ready"&&Te.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:he}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",Ue]})]})]}),aa?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",aa.activeCount," / ",aa.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:aa.counts.map((c,y)=>{const F=y+1,O=aa.currentLevel===F,Q=aa.percentages[y]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":O,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:F}),e.jsx("strong",{children:c})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,Q))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[Q.toFixed(1),"%"]})]},`level-${F}`)})})]}):null,Sa?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:Sa.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:Sa.dots.map(c=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,c.value*100))}%`,background:`rgba(${Math.round(255*(1-c.value))}, ${Math.round(200*c.value)}, 80, 0.9)`}},c.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:Sa.knownCount})]})]}):null,ht?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:hn})]})}):null]})]})]})})})]})]})}const Cn=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],Fr={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},Dr=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],zr=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function Br({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o,collectionId:x}){const[l,d]=a.useState(""),[v,w,S]=En([]),[D,f,g]=Pn([]),[le,P]=a.useState(null),[p,V]=a.useState(null),[N,W]=a.useState(null),R=`/#/cogita/library/${o}`;a.useEffect(()=>{ln(o,x).then(C=>d(C.name)).catch(()=>d(t.cogita.library.collections.defaultName))},[o,x,t]),a.useEffect(()=>{pi({libraryId:o,collectionId:x}).then(C=>{if(!C.graphId||C.graphId==="00000000-0000-0000-0000-000000000000"){w([]),f([]);return}const Ie=C.nodes.map(ee=>{var de;const q=ee.payload??{},fe=q.position??{x:120,y:120},X=q.params??{};return{id:ee.nodeId,type:"default",position:fe,data:{nodeType:ee.nodeType,label:((de=Cn.find(ye=>ye.type===ee.nodeType))==null?void 0:de.label)??ee.nodeType,params:X}}}),B=C.edges.map(ee=>({id:ee.edgeId,source:ee.fromNodeId,target:ee.toNodeId,sourceHandle:ee.fromPort??void 0,targetHandle:ee.toPort??void 0}));w(Ie),f(B)}).catch(()=>{w([]),f([])})},[o,x,f,w]);const I=a.useMemo(()=>v.find(C=>C.id===le)??null,[v,le]),re=C=>{var q;const Ie=crypto.randomUUID(),B=((q=Cn.find(fe=>fe.type===C))==null?void 0:q.label)??C,ee={...Fr[C]};w(fe=>[...fe,{id:Ie,type:"default",position:{x:120+fe.length*40,y:120+fe.length*40},data:{nodeType:C,label:B,params:ee}}]),P(Ie)},ce=a.useCallback(C=>{f(Ie=>Kn({...C,id:crypto.randomUUID()},Ie))},[f]),xe=async()=>{V(null);try{await Es({libraryId:o,collectionId:x,nodes:v.map(C=>({nodeId:C.id,nodeType:C.data.nodeType,payload:{position:C.position,params:C.data.params}})),edges:D.map(C=>({edgeId:C.id,fromNodeId:C.source,fromPort:C.sourceHandle??null,toNodeId:C.target,toPort:C.targetHandle??null}))}),V(t.cogita.library.graph.saveSuccess)}catch{V(t.cogita.library.graph.saveFail)}},Te=async()=>{try{const C=await fi({libraryId:o,collectionId:x});W(C)}catch{W(null)}},Z=C=>{I&&w(Ie=>Ie.map(B=>B.id===I.id?{...B,data:{...B.data,params:C}}:B))};return e.jsx(Kt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${R}/collections/${x}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Te,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:xe,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Cn.map(C=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>re(C.type),children:C.label},C.type))}),p?e.jsx("p",{className:"cogita-help",children:p}):null,N&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(N.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(N.connections)).replace("{infos}",String(N.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(sn,{nodes:v,edges:D,onNodesChange:S,onEdgesChange:g,onConnect:ce,onNodeClick:(C,Ie)=>P(Ie.id),fitView:!0,children:[e.jsx(rn,{color:"rgba(120,160,200,0.2)"}),e.jsx(on,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),I?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:I.data.label}),I.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(ea,{libraryId:o,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:I.data.params.tagId?{id:I.data.params.tagId,label:I.data.params.tagLabel??"",infoType:"topic"}:null,onChange:C=>Z({...I.data.params,tagId:(C==null?void 0:C.id)??null,tagLabel:(C==null?void 0:C.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:I.data.params.scope??"any",onChange:C=>Z({...I.data.params,scope:C.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),I.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(ea,{libraryId:o,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:I.data.params.languageId?{id:I.data.params.languageId,label:I.data.params.languageLabel??"",infoType:"language"}:null,onChange:C=>Z({...I.data.params,languageId:(C==null?void 0:C.id)??null,languageLabel:(C==null?void 0:C.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:I.data.params.scope??"any",onChange:C=>Z({...I.data.params,scope:C.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),I.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:I.data.params.infoType??"word",onChange:C=>Z({...I.data.params,infoType:C.target.value}),children:zr.map(C=>e.jsx("option",{value:C.value,children:C.label},C.value))})]}),e.jsx(ea,{libraryId:o,infoType:I.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:I.data.params.infoId?{id:I.data.params.infoId,label:I.data.params.infoLabel??"",infoType:I.data.params.infoType??"word"}:null,onChange:C=>Z({...I.data.params,infoId:(C==null?void 0:C.id)??null,infoLabel:(C==null?void 0:C.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),I.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:I.data.params.connectionType??"translation",onChange:C=>Z({...I.data.params,connectionType:C.target.value}),children:Dr.map(C=>e.jsx("option",{value:C.value,children:C.label},C.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:I.data.params.connectionId??"",onChange:C=>Z({...I.data.params,connectionId:C.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(I.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function ks(t,n,s){const i=n.trim().toLocaleLowerCase();if(!i)return t;const r=t.filter(u=>u.label.toLocaleLowerCase().includes(i));if(s&&!r.some(u=>u.value===s)){const u=t.find(m=>m.value===s);if(u)return[u,...r]}return r}const In="cogita.preferences",Mn="cogita.reviewer.preferences",Gs=["library_overview","all_cards","all_collections","all_revisions","storyboards","texts","dependencies","transfer"],Ln={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},all_revisions:{requiresCollection:!0,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},_r=["settings","run","shared"];function Vr(t,n=""){const s=t.split("/").filter(Boolean);if(s[0]!=="cogita"||s[1]!=="library")return{};const i=s[2];if(!i)return{};if(!s[3])return{libraryId:i,target:"library_overview"};const r=new URLSearchParams(n),u=r.get("revisionId")??void 0,m=r.get("infoId")??void 0,k=r.get("infoView"),j=k==="cards"?"cards":k==="collections"?"collections":"overview",M=r.get("collectionView")==="overview"?"overview":"infos",o=r.get("collectionAction"),x=r.get("libraryAction"),d=r.get("libraryTarget")==="revisions"?"all_revisions":"all_collections";if(s[3]==="list")return{libraryId:i,target:x==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:u,infoId:m,infoView:j,libraryAction:x==="new-info"?"new-info":void 0};if(s[3]==="detail"||s[3]==="collection")return{libraryId:i,target:"all_cards",cardMode:s[3],revisionId:u,infoId:m,infoView:j};if(s[3]==="new"||s[3]==="add")return{libraryId:i,target:"new_card",revisionId:u,libraryAction:"new-info"};if(s[3]==="edit")return{libraryId:i,target:"new_card",revisionId:u,infoId:s[4]};if(s[3]==="infos"){const w=s[4];return w?s[5]==="checkcards"?{libraryId:i,target:"all_cards",cardMode:"list",revisionId:u,infoId:w,infoView:"cards"}:s[5]==="collections"?{libraryId:i,target:"all_cards",cardMode:"list",revisionId:u,infoId:w,infoView:"collections"}:{libraryId:i,target:"all_cards",cardMode:"list",revisionId:u,infoId:w,infoView:"overview"}:{libraryId:i,target:"all_cards",cardMode:"list",revisionId:u}}if(s[3]==="shared-revisions")return{libraryId:i,target:d,revisionId:u};if(s[3]==="revision"&&s[4]==="run")return{libraryId:i,target:d,revisionView:"run",revisionId:u,infoId:m,infoView:j};if(s[3]==="dependencies")return{libraryId:i,target:"dependencies"};if(s[3]==="transfer")return{libraryId:i,target:"transfer"};if(s[3]==="storyboards")return s[4]==="new"?{libraryId:i,target:"new_storyboard"}:{libraryId:i,target:"storyboards"};if(s[3]==="texts")return s[4]==="new"?{libraryId:i,target:"new_text"}:{libraryId:i,target:"texts"};if(s[3]!=="collections")return{libraryId:i,target:"library_overview"};if(s[4]==="new")return{libraryId:i,target:"new_collection",revisionId:u};const v=s[4];return v?s[5]==="graph"?{libraryId:i,target:d,collectionId:v,revisionId:u,revisionView:"graph"}:s[5]==="shared-revisions"?{libraryId:i,target:d,collectionId:v,revisionId:u,revisionView:"shared"}:s[5]==="revision"?{libraryId:i,target:d,collectionId:v,revisionId:u,revisionView:s[6]==="run"?"run":"settings",collectionView:M}:o==="new-revision"?{libraryId:i,target:d,collectionId:v,revisionId:u,revisionView:"new"}:{libraryId:i,target:d,collectionId:v,revisionId:u,revisionView:"detail",collectionView:M}:o==="new-collection"?{libraryId:i,target:"new_collection",collectionAction:"new-collection"}:{libraryId:i,target:d}}function Ns(t,n="library_overview",s,i,r,u,m="overview",k="infos"){const j=(M,o)=>{const x=new URLSearchParams;o!=null&&o.revisionId&&x.set("revisionId",o.revisionId),o!=null&&o.collectionAction&&x.set("collectionAction",o.collectionAction),o!=null&&o.libraryAction&&x.set("libraryAction",o.libraryAction),o!=null&&o.libraryTarget&&x.set("libraryTarget",o.libraryTarget),o!=null&&o.infoId&&x.set("infoId",o.infoId),o!=null&&o.infoView&&(o!=null&&o.infoId)&&x.set("infoView",o.infoView),o!=null&&o.collectionView&&o.collectionView!=="infos"&&x.set("collectionView",o.collectionView);const l=x.toString();return l?`${M}?${l}`:M};if(!t)return"/cogita";if(n==="library_overview")return j(`/cogita/library/${t}`,{revisionId:r});if(n==="all_cards")return u?m==="cards"?j(`/cogita/library/${t}/infos/${u}/checkcards`,{revisionId:r}):m==="collections"?j(`/cogita/library/${t}/infos/${u}/collections`,{revisionId:r}):j(`/cogita/library/${t}/infos/${u}`,{revisionId:r}):j(`/cogita/library/${t}/list`,{revisionId:r,infoId:u,infoView:m});if(n==="new_card")return u?j(`/cogita/library/${t}/edit/${u}`,{revisionId:r}):j(`/cogita/library/${t}/list`,{revisionId:r,libraryAction:"new-info"});if(n==="all_collections"||n==="all_revisions"){const M=n==="all_revisions"?"revisions":void 0;return!s&&i==="run"?j(`/cogita/library/${t}/revision/run`,{revisionId:r,libraryTarget:M}):s?i==="graph"?j(`/cogita/library/${t}/collections/${s}/graph`,{revisionId:r,libraryTarget:M}):i==="settings"?j(`/cogita/library/${t}/collections/${s}/revision`,{revisionId:r,libraryTarget:M}):i==="run"?j(`/cogita/library/${t}/collections/${s}/revision/run`,{revisionId:r,libraryTarget:M}):i==="shared"?j(`/cogita/library/${t}/collections/${s}/shared-revisions`,{revisionId:r,libraryTarget:M}):i==="new"?j(`/cogita/library/${t}/collections/${s}`,{revisionId:r,libraryTarget:M,collectionAction:"new-revision"}):j(`/cogita/library/${t}/collections/${s}`,{revisionId:r,libraryTarget:M,collectionView:k}):j(`/cogita/library/${t}/collections`,{revisionId:r,libraryTarget:M})}return n==="new_collection"?j(`/cogita/library/${t}/collections`,{revisionId:r,collectionAction:"new-collection"}):n==="transfer"?j(`/cogita/library/${t}/transfer`,{revisionId:r}):n==="storyboards"?j(`/cogita/library/${t}/storyboards`,{revisionId:r}):n==="new_storyboard"?j(`/cogita/library/${t}/storyboards/new`,{revisionId:r}):n==="texts"?j(`/cogita/library/${t}/texts`,{revisionId:r}):n==="new_text"?j(`/cogita/library/${t}/texts/new`,{revisionId:r}):n==="dependencies"?j(`/cogita/library/${t}/dependencies`,{revisionId:r}):j(`/cogita/library/${t}`,{revisionId:r})}function pa(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function Or(t){return typeof t=="string"&&Gs.includes(t)}function Ur(t,n){var k;if(!t.length)return null;const s=t.filter(j=>n.has(j.roleId)),i=s.length>0?s:t,r=i.map(j=>{var o,x;const M=((x=(o=j.fields.find(l=>l.fieldType==="role_kind"))==null?void 0:o.plainValue)==null?void 0:x.toLowerCase())??"";return{roleId:j.roleId,roleKind:M}}),u=r.find(j=>j.roleKind.includes("master"));if(u)return u.roleId;const m=r.find(j=>j.roleKind.includes("account")||j.roleKind.includes("user"));return m?m.roleId:((k=i[0])==null?void 0:k.roleId)??null}function qr(t){if(!t)return{version:1,byLibrary:{}};try{const n=JSON.parse(t);return!n||typeof n!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:n.lastLibraryId,byLibrary:n.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function Jr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M}){const o=An(),x=Fa(),l=a.useMemo(()=>Vr(x.pathname,x.search),[x.pathname,x.search]),d=t.cogita.workspace,[v,w]=a.useState([]),[S,D]=a.useState([]),[f,g]=a.useState([]),[le,P]=a.useState([]),[p,V]=a.useState(void 0),[N,W]=a.useState("library_overview"),[R,I]=a.useState(void 0),[re,ce]=a.useState(void 0),[xe,Te]=a.useState("detail"),[Z,C]=a.useState(void 0),[Ie,B]=a.useState(!1),[ee,q]=a.useState(!0),[fe,X]=a.useState(!1),[de,ye]=a.useState(!1),[Pe,Ve]=a.useState(null),[Ce,He]=a.useState(0),[Ze,Me]=a.useState(""),[We,rt]=a.useState(""),[ot,_e]=a.useState(""),[je,J]=a.useState([]),[Le,oe]=a.useState(""),[_,me]=a.useState(0),[Ge,$]=a.useState(""),[A,Y]=a.useState(""),[se,T]=a.useState(null),[U,K]=a.useState(null),H=a.useRef({version:1,byLibrary:{}}),ie=a.useRef(!1),ke=a.useRef(!1),Ae=a.useRef(null),De=a.useMemo(()=>v.find(b=>b.libraryId===p)??null,[v,p]),ve=a.useMemo(()=>S.find(b=>b.collectionId===R)??null,[S,R]),be=pa(x.pathname)==="/cogita/persons";a.useEffect(()=>{if(!p){J([]),oe("");return}let b=!1;return Ps({libraryId:p}).then(Re=>{if(b)return;const ze=Re.filter(Ue=>(Ue.roleKind??"").trim().toLowerCase()==="person");J(ze);try{const Ue=window.localStorage.getItem(Mn),ft=(Ue?JSON.parse(Ue):{})[p]??"",ht=ft&&ze.some(bt=>bt.roleId===ft)?ft:"";oe(ht)}catch{oe("")}}).catch(()=>{b||(J([]),oe(""))}),()=>{b=!0}},[p,_]),a.useEffect(()=>{if(p)try{const b=window.localStorage.getItem(Mn),Re=b?JSON.parse(b):{};Le?Re[p]=Le:delete Re[p],window.localStorage.setItem(Mn,JSON.stringify(Re))}catch{}},[p,Le]);const ue=a.useMemo(()=>le.find(b=>b.revisionId===re)??null,[le,re]),Xe=a.useMemo(()=>ks(S.map(b=>({value:b.collectionId,label:b.name})),Ge,R),[Ge,S,R]),Qe=a.useMemo(()=>ks(le.map(b=>({value:b.revisionId,label:b.name})),A,re),[A,le,re]),Ye=a.useMemo(()=>({detail:d.revisions.detail,graph:d.revisions.graph,settings:d.revisions.settings,run:d.revisions.run,shared:d.targets.sharedRevisions,new:d.revisionForm.createAction}),[d.revisions.detail,d.revisions.graph,d.revisions.run,d.revisions.settings,d.targets.sharedRevisions,d.revisionForm.createAction]),et=a.useMemo(()=>N==="new_card"?"all_cards":N==="new_collection"?"all_collections":N==="new_storyboard"?"storyboards":N==="new_text"?"texts":N,[N]),nt=a.useMemo(()=>xe==="new"?"settings":xe,[xe]),qe=N==="all_collections"||N==="all_revisions",ut=a.useMemo(()=>N==="new_collection"?"create":qe&&R?"selected":"search",[qe,R,N]),jt=a.useMemo(()=>l.infoId?"selected":N==="new_card"?"create":"search",[l.infoId,N]),yt=a.useMemo(()=>f.find(b=>b.infoId===l.infoId)??null,[f,l.infoId]),St=a.useMemo(()=>({library_overview:d.targets.libraryOverview,all_cards:d.targets.allCards,new_card:d.targets.newCard,all_collections:d.targets.allCollections,all_revisions:d.targets.allRevisions,new_collection:d.targets.newCollection,transfer:d.targets.transfer,storyboards:d.targets.storyboards,new_storyboard:d.targets.newStoryboard,texts:d.targets.texts,new_text:d.targets.newText,dependencies:d.targets.dependencies}),[d.targets]),Pt=a.useMemo(()=>St[et]??et,[et,St]),Mt=Ye[nt],Ft=!!p,xt=a.useMemo(()=>{const b=j==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":j==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return j==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:b},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:b},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:b},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:b},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:b},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:b},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:b},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:b},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:b},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:b},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:b},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:b},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:b},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:j==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:b},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:b},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:b},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:b},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:b},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:b},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:b},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:b},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:b},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:b},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:b},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:b},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:b},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:b},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:b},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:b},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:b},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:b},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:b},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:b},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:b},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:b},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:b},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:b},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:b},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:b},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[j]),Lt=xt.length,vt=Math.max(0,Math.min(Ce,Lt-1)),kt=xt[vt],Vt=!!R,Ut=Ft&&qe,tt=Vt&&qe,gt=Vt&&qe&&(N==="all_revisions"||nt==="settings"||nt==="run"||nt==="shared"),Rt=gt,Tt=gt&&!!re,Ke=a.useCallback(b=>{const Re=!!b.libraryId;let ze=b.target,Ue=b.collectionId,pt=b.revisionId,ft=b.revisionView,ht=b.infoId,bt=b.infoView??l.infoView??"overview",Jt=b.collectionView??l.collectionView??"infos";Re?Ln[ze].requiresCollection&&!Ue?(ze=ze==="all_revisions"?"all_revisions":"all_collections",pt=void 0,ft="detail"):ze!=="all_collections"&&ze!=="all_revisions"?(Ue=void 0,pt=void 0,ze!=="new_card"&&ze!=="all_cards"&&(ht=void 0,bt="overview"),ze!=="new_collection"&&(Jt="infos")):Ln[ze].allowsRevision?_r.includes(ft)||(pt=void 0):ft="detail":(ze="library_overview",Ue=void 0,pt=void 0,ft="detail",ht=void 0,bt="overview",Jt="infos"),V(b.libraryId),W(ze),I(Ue),ce(pt),Te(ft),B(!1);const Xt=pa(Ns(b.libraryId,ze,Ue,ft,pt,ht,bt,Jt));pa(`${x.pathname}${x.search}`)!==Xt&&(Ae.current=Xt,o(Xt))},[x.pathname,x.search,o,l.collectionView,l.infoView]),mt=a.useMemo(()=>[{key:"library",label:d.layers.library,visible:!0,value:p??"",selectedLabel:(De==null?void 0:De.name)??d.path.noLibrarySelected,disabled:ee||v.length===0,options:v.map(b=>({value:b.libraryId,label:b.name})),emptyOption:d.noLibraryOption,onSelect:b=>{const Re=b||void 0;Ke({libraryId:Re,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:d.layers.target,visible:Ft,value:et,selectedLabel:Pt,disabled:!Ft,options:Gs.map(b=>({value:b,label:St[b]})),onSelect:b=>{const Re=b;Ke({libraryId:p,target:Re,collectionId:R,revisionId:re,revisionView:xe,infoId:Re==="new_card"?l.infoId:void 0})}},{key:"info_mode",label:d.layers.target,visible:et==="all_cards",value:jt,selectedLabel:jt==="create"?d.infoMode.create:jt==="selected"?(yt==null?void 0:yt.label)??Z??t.cogita.library.list.selectedEmpty:d.infoMode.search,disabled:!Ft,options:[{value:"search",label:d.infoMode.search},{value:"create",label:d.infoMode.create},...l.infoId?[{value:"selected",label:(yt==null?void 0:yt.label)??Z??t.cogita.library.list.selectedEmpty}]:[]],onSelect:b=>{if(b==="selected"){if(!l.infoId)return;Ke({libraryId:p,target:"all_cards",collectionId:R,revisionId:re,revisionView:xe,infoId:l.infoId,infoView:"overview"});return}if(b==="create"){Ke({libraryId:p,target:"new_card",collectionId:R,revisionId:re,revisionView:xe,infoId:void 0});return}Ke({libraryId:p,target:"all_cards",collectionId:R,revisionId:re,revisionView:xe,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:d.layers.target,visible:et==="all_cards"&&!!l.infoId,value:N==="new_card"&&l.infoId?"edit":l.infoView==="cards"?"cards":l.infoView==="collections"?"collections":"overview",selectedLabel:N==="new_card"&&l.infoId?d.infoActions.edit:l.infoView==="cards"?d.infoActions.seeCards:l.infoView==="collections"?"Kolekcje":d.infoActions.overview,disabled:!Ft||!l.infoId,options:[{value:"overview",label:d.infoActions.overview},{value:"edit",label:d.infoActions.edit},{value:"cards",label:d.infoActions.seeCards},{value:"collections",label:"Kolekcje"}],onSelect:b=>{if(l.infoId){if(b==="edit"){Ke({libraryId:p,target:"new_card",collectionId:R,revisionId:re,revisionView:xe,infoId:l.infoId});return}if(b==="cards"){Ke({libraryId:p,target:"all_cards",collectionId:R,revisionId:re,revisionView:xe,infoId:l.infoId,infoView:"cards"});return}Ke({libraryId:p,target:"all_cards",collectionId:R,revisionId:re,revisionView:xe,infoId:l.infoId,infoView:"overview"})}}},{key:"collection_mode",label:d.layers.collection,visible:Ft&&(qe||N==="new_collection"),value:ut,selectedLabel:ut==="create"?t.cogita.library.actions.createCollection:ut==="selected"?(ve==null?void 0:ve.name)??d.path.noCollectionSelected:t.cogita.library.actions.collections,disabled:!Ft,options:[{value:"search",label:t.cogita.library.actions.collections},{value:"create",label:t.cogita.library.actions.createCollection},...R&&ve?[{value:"selected",label:ve.name}]:[]],onSelect:b=>{if(b==="create"){Ke({libraryId:p,target:"new_collection",collectionId:void 0,revisionId:void 0,revisionView:"detail"});return}if(b==="selected"&&R){Ke({libraryId:p,target:qe?N:"all_collections",collectionId:R,revisionId:re,revisionView:"detail"});return}if(b==="collections"){Ke({libraryId:p,target:"all_cards",collectionId:R,revisionId:re,revisionView:xe,infoId:l.infoId,infoView:"collections"});return}Ke({libraryId:p,target:qe?N:"all_collections",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection",label:d.layers.collection,visible:Ut&&ut!=="create",value:R??"",selectedLabel:(ve==null?void 0:ve.name)??d.path.noCollectionSelected,disabled:!Ft||fe||S.length===0,options:Xe,emptyOption:d.selectCollectionOption,onSelect:b=>{Ke({libraryId:p,target:qe?N:"all_collections",collectionId:b||void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection_selected_action",label:d.layers.revision,visible:tt,value:nt==="graph"?"edit":nt==="settings"||nt==="run"||nt==="shared"?"revisions":(l.collectionView??"infos")==="overview"?"overview":"infos",selectedLabel:nt==="graph"?"Edytuj":nt==="settings"||nt==="run"||nt==="shared"?d.targets.allRevisions:(l.collectionView??"infos")==="overview"?"Przegląd":"Informacje",disabled:!R,options:[{value:"overview",label:"Przegląd"},{value:"edit",label:"Edytuj"},{value:"infos",label:"Informacje"},{value:"revisions",label:d.targets.allRevisions}],onSelect:b=>{if(R){if(b==="edit"){Ke({libraryId:p,target:qe?N:"all_collections",collectionId:R,revisionId:void 0,revisionView:"graph"});return}if(b==="revisions"){Ke({libraryId:p,target:qe?N:"all_collections",collectionId:R,revisionId:re,revisionView:"settings"});return}Ke({libraryId:p,target:qe?N:"all_collections",collectionId:R,revisionId:void 0,revisionView:"detail",infoId:l.infoId,infoView:l.infoView,collectionView:b==="overview"?"overview":"infos"})}}},{key:"revision_entry",label:d.layers.revision,visible:Rt,value:re??"",selectedLabel:(ue==null?void 0:ue.name)??d.status.noRevisions,disabled:!Vt||de||le.length===0,options:Qe,emptyOption:d.status.noRevisions,onSelect:b=>{Ke({libraryId:p,target:qe?N:"all_collections",collectionId:R,revisionId:b||void 0,revisionView:nt==="settings"||nt==="run"||nt==="shared"?nt:"settings"})}},{key:"revision_selected_action",label:d.layers.revision,visible:Tt,value:nt==="run"?"run":nt==="shared"?"shared":"settings",selectedLabel:nt==="run"?d.revisions.run:nt==="shared"?d.targets.sharedRevisions:d.revisions.settings,disabled:!R||!re,options:[{value:"settings",label:d.revisions.settings},{value:"run",label:d.revisions.run},{value:"shared",label:d.targets.sharedRevisions}],onSelect:b=>{!R||!re||Ke({libraryId:p,target:qe?N:"all_collections",collectionId:R,revisionId:re,revisionView:b==="run"?"run":b==="shared"?"shared":"settings"})}}],[S,fe,jt,f,v,ee,Ke,le,de,Xe,Qe,ve,R,yt,ue,re,Z,Vt,Ft,De,qe,p,Mt,xe,N,nt,et,Pt,Ut,tt,Rt,Tt,St,t.cogita.library.list.selectedEmpty,l.infoId,l.infoView,l.collectionView,d.infoActions.edit,d.infoActions.overview,d.infoActions.seeCards,d.layers.collection,d.layers.library,d.layers.revision,d.layers.target,d.noLibraryOption,d.path.noCollectionSelected,d.path.noLibrarySelected,d.selectCollectionOption,d.targets.allRevisions,d.revisions.run,d.revisions.settings,d.targets.sharedRevisions,ut]),Ct=a.useMemo(()=>mt.filter(b=>b.visible),[mt]),It=a.useMemo(()=>Ct.filter(b=>b.key!=="library"&&b.key!=="collection"),[Ct]),ha=a.useMemo(()=>It.find(b=>b.key==="target")??null,[It]),ae=a.useMemo(()=>It.find(b=>b.key==="info_mode")??null,[It]),qt=a.useMemo(()=>It.find(b=>b.key==="info_selected_action")??null,[It]),Et=a.useMemo(()=>It.find(b=>b.key==="collection_mode")??null,[It]),Dt=a.useMemo(()=>It.find(b=>b.key==="collection_selected_action")??null,[It]),h=a.useMemo(()=>Ct.find(b=>b.key==="collection")??null,[Ct]),Ne=a.useMemo(()=>It.find(b=>b.key==="revision_entry")??null,[It]),Oe=a.useMemo(()=>It.find(b=>b.key==="revision_selected_action")??null,[It]),lt=a.useCallback((b,Re,ze)=>b?e.jsxs("div",{className:"cogita-sidebar-actions",children:[ze?e.jsx("div",{className:"cogita-search-field cogita-sidebar-search",children:e.jsx("input",{type:"text",value:ze.value,onChange:Ue=>ze.onChange(Ue.target.value),placeholder:ze.placeholder})}):null,b.options.map(Ue=>e.jsx("button",{type:"button",className:`ghost ${String(b.value)===Ue.value?"active":""}`,onClick:()=>b.onSelect(Ue.value),disabled:b.disabled,children:Ue.label},`${Re}:${b.key}:${Ue.value}`))]}):null,[]),Nt=a.useMemo(()=>{const b=l.libraryId;if(!b||!x.pathname.startsWith("/cogita/library/"))return null;const Re={copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:b};if(l.target==="library_overview")return e.jsx(Ai,{...Re});if(l.target==="all_cards")return l.infoId&&l.infoView==="cards"?e.jsx(ir,{...Re,infoId:l.infoId,selectedReviewerRoleId:Le||null}):e.jsx(qi,{...Re,mode:l.cardMode??"list"});if(l.target==="new_card")return e.jsx(Zi,{...Re,editInfoId:l.infoId});if(l.target==="dependencies")return e.jsx(tr,{...Re});if(l.target==="transfer")return e.jsx(dr,{...Re});if(l.target==="storyboards"||l.target==="new_storyboard")return e.jsx(ur,{...Re});if(l.target==="texts"||l.target==="new_text")return e.jsx(hr,{...Re});if(l.target==="all_collections"||l.target==="all_revisions"){if(!l.collectionId&&l.revisionView==="run")return e.jsx(js,{...Re,revisionId:l.revisionId});if(l.collectionId){const ze={...Re,collectionId:l.collectionId};return l.revisionView==="graph"?e.jsx(Br,{...ze}):l.revisionView==="shared"?e.jsx(cr,{...Re,collectionId:l.collectionId}):l.revisionView==="settings"?e.jsx(Cr,{...ze,revisionId:l.revisionId}):l.revisionView==="run"?e.jsx(js,{...ze,revisionId:l.revisionId}):e.jsx(mr,{...ze})}return e.jsx(gr,{...Re})}return l.target==="new_collection"?e.jsx(yr,{...Re,onCreated:ze=>{Ke({libraryId:b,target:N==="all_revisions"?"all_revisions":"all_collections",collectionId:ze,revisionId:void 0,revisionView:"graph"})}}):null},[n,Ke,t,j,x.pathname,o,M,u,k,i,r,l.cardMode,l.collectionId,l.infoId,l.libraryId,l.revisionId,l.revisionView,l.target,m,s,N,Le]);a.useEffect(()=>{let b=!1;return(async()=>{var ze,Ue,pt,ft,ht;q(!0);try{await bi();const[bt,Jt,Xt]=await Promise.all([Cs(),Rs(),yi()]);if(b)return;w(bt);const ka=new Set(Xt.nodes.filter($t=>$t.nodeType==="role"&&$t.canLink).map($t=>$t.roleId??"")),Ot=Ur(Jt,ka);if(T(Ot),Ot){const $t=Xt.nodes.find(Zt=>Zt.nodeType==="data"&&Zt.roleId===Ot&&(Zt.fieldType===In||Zt.label===In));K(($t==null?void 0:$t.dataKeyId)??null),H.current=qr($t==null?void 0:$t.value)}const ta=(ze=bt.find($t=>$t.libraryId===l.libraryId))==null?void 0:ze.libraryId,Na=ta?(pt=(Ue=H.current.byLibrary)==null?void 0:Ue[ta])==null?void 0:pt.lastTarget:void 0,zt=Or(Na)?Na:"library_overview";V(ta),W(l.target??zt),ce(l.revisionId??(ta?(ht=(ft=H.current.byLibrary)==null?void 0:ft[ta])==null?void 0:ht.lastRevisionId:void 0)),Te(l.revisionView??"detail"),ie.current=!0}catch{b||Ve(d.status.loadFailed)}finally{b||q(!1)}})(),()=>{b=!0}},[d.status.loadFailed]),a.useLayoutEffect(()=>{if(ie.current){if(!l.libraryId){V(void 0),W(l.target??"library_overview"),I(void 0),ce(void 0),Te("detail");return}l.libraryId&&v.some(b=>b.libraryId===l.libraryId)&&V(l.libraryId),l.target&&W(l.target),I(l.collectionId),ce(l.revisionId),l.revisionView&&Te(l.revisionView)}},[v,l.collectionId,l.libraryId,l.revisionId,l.revisionView,l.target]),a.useEffect(()=>{if(!p){D([]),I(void 0),g([]),P([]),ce(void 0);return}let b=!1;return X(!0),Ua({libraryId:p,limit:200}).then(Re=>{var pt;if(b)return;const ze=Re.items;D(ze);const Ue=(pt=ze.find(ft=>ft.collectionId===l.collectionId))==null?void 0:pt.collectionId;I(Ue)}).catch(()=>{b||(D([]),I(void 0))}).finally(()=>{b||X(!1)}),()=>{b=!0}},[l.collectionId,p]),a.useEffect(()=>{if(!p||et!=="all_cards"&&N!=="new_card"){g([]);return}let b=!1;return Dn({libraryId:p,limit:200}).then(Re=>{b||g(Re)}).catch(()=>{b||g([])}),()=>{b=!0}},[et,p,N]),a.useEffect(()=>{if(!p||!R){P([]),ce(void 0);return}let b=!1;return ye(!0),Is({libraryId:p,collectionId:R}).then(Re=>{var pt,ft,ht,bt;if(b)return;P(Re);const ze=(ft=(pt=H.current.byLibrary)==null?void 0:pt[p])==null?void 0:ft.lastRevisionId,Ue=((ht=Re.find(Jt=>Jt.revisionId===l.revisionId))==null?void 0:ht.revisionId)??((bt=Re.find(Jt=>Jt.revisionId===ze))==null?void 0:bt.revisionId);ce(Ue)}).catch(()=>{b||(P([]),ce(void 0))}).finally(()=>{b||ye(!1)}),()=>{b=!0}},[l.revisionId,R,p]),a.useEffect(()=>{$(""),Y("")},[p]),a.useEffect(()=>{Y("")},[R]),a.useEffect(()=>{const b=l.infoId;if(!p||!b){C(void 0);return}let Re=!1;return da({libraryId:p,infoId:b}).then(ze=>{if(Re)return;const Ue=ze.payload;C((Ue==null?void 0:Ue.label)??(Ue==null?void 0:Ue.name)??(Ue==null?void 0:Ue.title)??ze.infoId)}).catch(()=>{Re||C(b)}),()=>{Re=!0}},[l.infoId,p]),a.useEffect(()=>{if(!ie.current||l.libraryId&&v.some(pt=>pt.libraryId===l.libraryId)&&l.libraryId!==p||l.target&&l.target!==N||l.revisionView&&l.revisionView!==xe||l.revisionId&&l.revisionId!==re||Ln[N].requiresCollection&&!R&&(l.target==="all_collections"||l.target==="all_revisions")&&l.collectionId)return;const b=pa(`${x.pathname}${x.search}`);if(pa(x.pathname)==="/cogita"&&!l.libraryId&&!p){Ae.current=null;return}if(pa(x.pathname)==="/cogita/persons"){Ae.current=null;return}if(pa(x.pathname)===`/cogita/library/${p}/revision/run`&&l.revisionView==="run"&&!l.collectionId&&(N==="all_collections"||N==="all_revisions")&&xe==="run"&&!R){Ae.current=null;return}const Ue=pa(Ns(p,N,R,xe,re,l.infoId,l.infoView??"overview",l.collectionView??"infos"));if(b===Ue){Ae.current=null;return}Ae.current!==Ue&&(Ae.current=Ue,o(Ue,{replace:!0}))},[v,x.pathname,x.search,o,l.collectionId,l.infoId,l.infoView,l.collectionView,l.libraryId,l.revisionId,l.revisionView,l.target,R,p,re,xe,N]),a.useEffect(()=>{if(typeof window>"u")return;const b=()=>{window.innerWidth>920&&B(!1)};return window.addEventListener("resize",b),()=>window.removeEventListener("resize",b)},[]),a.useEffect(()=>{if(!ie.current||!se||!p||ke.current)return;const b=H.current,Re={...b.byLibrary??{}},ze={...Re[p]??{},lastCollectionId:R,lastRevisionId:re,lastRevisionView:xe,lastTarget:N},Ue={version:1,lastLibraryId:p,byLibrary:{...Re,[p]:ze}},pt=JSON.stringify(b),ft=JSON.stringify(Ue);if(pt===ft)return;H.current=Ue,ke.current=!0,(async()=>{try{if(U)await xi(U,{plainValue:ft});else{const bt=await vi(se,{itemName:In,itemType:"data",plainValue:ft});K(bt.dataItemId)}}catch{Ve(d.status.savePrefsFailed)}finally{ke.current=!1}})()},[U,se,R,p,re,xe,N,d.status.savePrefsFailed]);const Yt=async()=>{const b=Ze.trim();if(!b){Ve(t.cogita.user.libraryNameRequired);return}Ve(null);try{const Re=await ji({name:b});w(ze=>[Re,...ze]),V(Re.libraryId),W("library_overview"),I(void 0),Me("")}catch{Ve(t.cogita.user.libraryCreateFailed)}},Qt=async()=>{if(!p||!R){Ve(d.status.selectLibraryFirst);return}const b=ot.trim();if(!b){Ve(d.revisionForm.nameLabel);return}Ve(null);try{const Re=await wi({libraryId:p,collectionId:R,name:b,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});P(ze=>[Re,...ze]),ce(Re.revisionId),W(N==="all_revisions"?"all_revisions":"all_collections"),Te("settings"),_e("")}catch{Ve(d.status.loadFailed)}};return e.jsx(Kt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,headerExtra:e.jsxs("div",{className:"cogita-header-reviewer-actions",children:[e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:Le,disabled:!p,onChange:b=>{const Re=b.target.value;if(Re==="__new_person__"){o("/cogita/persons");return}oe(Re)},children:[e.jsx("option",{value:"",children:p?"No person":"Select library first"}),je.map(b=>e.jsx("option",{value:b.roleId,children:b.label},b.roleId)),e.jsx("option",{value:"__new_person__",children:"+ Create new person"})]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>o("/cogita/persons"),children:"Persons"})]}),children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${Ie?"open":""}`,"aria-label":d.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{children:(De==null?void 0:De.name)??d.path.noLibrarySelected}),e.jsx("p",{className:"cogita-sidebar-note",children:De?d.sidebar.libraryActionsHint:d.status.selectLibraryFirst}),lt(ha,"sidebar"),ae?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.infoActionsHint}),lt(ae,"sidebar"),qt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(yt==null?void 0:yt.label)??Z??t.cogita.library.list.selectedEmpty}),e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.selectedInfoActionsHint}),lt(qt,"sidebar")]}):null]}):null,Et?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.collectionActionsHint}),lt(Et,"sidebar"),h?e.jsx("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:lt(h,"sidebar",{value:Ge,onChange:$,placeholder:t.cogita.library.collections.searchPlaceholder})}):null,ve&&Dt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:ve.name}),lt(Dt,"sidebar"),Ne?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(ue==null?void 0:ue.name)??d.status.noRevisions}),lt(Ne,"sidebar",{value:A,onChange:Y,placeholder:d.revisionForm.namePlaceholder}),Oe?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.layers.revision}),lt(Oe,"sidebar")]}):null]}):null]}):null]}):null]}),e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:d.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:i,children:d.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{k("cogita"),B(!1)},children:d.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:r,children:m?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),Ie?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":d.sidebar.closeMenu,onClick:()=>B(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":d.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>B(b=>!b),"aria-label":Ie?d.sidebar.closeMenu:d.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),Ct.map((b,Re)=>e.jsxs("div",{className:"cogita-browser-segment",children:[Re>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,b.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":b.label,children:b.selectedLabel}):e.jsxs("select",{"aria-label":b.label,value:b.value,onChange:ze=>b.onSelect(ze.target.value),disabled:b.disabled,children:[b.emptyOption?e.jsx("option",{value:"",children:b.emptyOption}):null,b.options.map(ze=>e.jsx("option",{value:ze.value,children:ze.label},`${b.key}:${ze.value}`))]})]},`menu:${b.key}`))]}),Nt?e.jsxs(e.Fragment,{children:[(N==="all_collections"||N==="all_revisions")&&R&&xe==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:d.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:d.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:ot,onChange:b=>_e(b.target.value),placeholder:d.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Qt,children:d.revisionForm.createAction}),Pe?e.jsx("p",{className:"cogita-form-error",children:Pe}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Ks.Provider,{value:!0,children:Nt})})]}):null,Nt?null:e.jsxs(e.Fragment,{children:[be?e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(lr,{copy:t,onPersonCreated:b=>{me(Re=>Re+1)}})}):null,!p&&!be?e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:kt.step}),e.jsx("h2",{children:kt.title})]}),e.jsxs("p",{children:[vt+1," / ",Lt]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:kt.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:kt.passages.map(b=>e.jsx("p",{children:b},b))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:kt.focus.map(b=>e.jsx("span",{children:b},b))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:kt.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:xt.map((b,Re)=>e.jsx("button",{type:"button",className:`ghost ${Re===vt?"active":""}`,onClick:()=>He(Re),"aria-label":`${Re+1}`,children:Re+1},`tutorial:${b.title}:${Re}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:vt===0,onClick:()=>He(b=>Math.max(0,b-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:vt===Lt-1,onClick:()=>He(b=>Math.min(Lt-1,b+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:Ze,onChange:b=>Me(b.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Yt,children:t.cogita.user.createLibraryAction}),Pe?e.jsx("p",{className:"cogita-form-error",children:Pe}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),v.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,v.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:v.map(b=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{Ke({libraryId:b.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:b.name})]},b.libraryId))}):null]})]})]}):null]})]})]})})}const Xr=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:Jr},Symbol.toStringTag,{value:"Module"}));function Hr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,shareId:o}){const[x,l]=a.useState(null),[d,v]=a.useState("loading"),[w,S]=a.useState(t.cogita.library.collections.defaultName),[D,f]=a.useState("Cogita Library"),[g,le]=a.useState([]),[P,p]=a.useState([]),[V,N]=a.useState("idle"),[W,R]=a.useState({current:0,total:0}),[I,re]=a.useState(0),[ce,xe]=a.useState(""),[Te,Z]=a.useState(null),[C,Ie]=a.useState(null),[B,ee]=a.useState(null),[q,fe]=a.useState(null),[X,de]=a.useState([]),[ye,Pe]=a.useState({}),[Ve,Ce]=a.useState({}),[He,Ze]=a.useState(null),[Me,We]=a.useState(null),[rt,ot]=a.useState(null),[_e,je]=a.useState(null),[J,Le]=a.useState({}),oe=a.useRef(0),[_,me]=a.useState(null),Ge=a.useRef(null),$=a.useRef(null),[A,Y]=a.useState(null),[se,T]=a.useState(!1),[U,K]=a.useState(null),[H,ie]=a.useState([]),[ke,Ae]=a.useState(null),De=a.useRef(null),ve=a.useRef(null),[be,ue]=a.useState(null),[Xe,Qe]=a.useState(0),Ye=a.useRef(null),et=a.useRef({}),[nt,qe]=a.useState(!1),[ut,jt]=a.useState({}),yt=a.useRef(null),St=a.useRef(new Set),Pt=a.useRef({}),[Mt,Ft]=a.useState([]),[xt,Lt]=a.useState(new Set),[vt,kt]=a.useState(!1),Vt=Fa(),Ut=a.useMemo(()=>new URLSearchParams(Vt.search),[Vt.search]),tt=a.useMemo(()=>Ut.get("key")??"",[Ut]),gt=(x==null?void 0:x.mode)??"random",Rt=(x==null?void 0:x.check)??"exact",Tt=(x==null?void 0:x.limit)??20,Ke=a.useMemo(()=>qn((x==null?void 0:x.revisionType)??gt),[x,gt]),mt=a.useMemo(()=>{const L=x==null?void 0:x.revisionSettings,G=Vs(Ke,Ut);return un(Ke,L??G)},[x,Ut,Ke]),Ct=a.useMemo(()=>t.cogita.library.revision[Ke.labelKey]??gt,[t,gt,Ke]),It=a.useMemo(()=>Rt==="exact"?t.cogita.library.revision.checkValue:Rt,[t,Rt]),ae=d==="ready"?g[I]??null:null,qt=(ae==null?void 0:ae.checkType)==="translation-match"&&_e,Et=a.useRef(new Map),Dt=a.useRef(new Map),h=a.useRef(new Map),Ne=a.useRef(new Map),Oe=a.useMemo(()=>ae?ae.cardType==="vocab"?t.cogita.library.revision.vocabLabel:ae.infoType?at(t,ae.infoType):t.cogita.library.revision.infoLabel:"",[t,ae]),lt=a.useMemo(()=>{var G;return Ke.id!=="levels"?g.length:((G=ut.pool)==null?void 0:G.length)??Ke.getFetchLimit(Tt,mt)},[ut,mt,Ke,g.length,Tt]),Nt=Ke.getProgressTotal?Ke.getProgressTotal(g,ut,Tt,mt):Ke.id==="levels"?Math.min(Tt,lt):g.length,Yt=Nt?Math.min(I+1,Nt):0,Qt=Math.max(1,Number(mt.tries??1)),b=mt.compare??"anchors",Re=Math.max(0,Math.min(100,Number(mt.minCorrectness??0))),ze=(mt.considerDependencies??"on")==="on",Ue=Math.max(0,Math.min(100,Number(mt.dependencyThreshold??85))),pt=L=>{const G=L.slice();for(let ge=G.length-1;ge>0;ge-=1){const $e=Math.floor(Math.random()*(ge+1));[G[ge],G[$e]]=[G[$e],G[ge]]}return G},ft=L=>ba(L,{treatSimilarCharsAsSame:!0})>=Re,ht=async()=>{const L=await ca(),G=new Map,ge=new Map;L.forEach(he=>{const Se=`${he.itemType}:${he.itemId}`,c=na(he.itemType,he.itemId,he.checkType,he.direction);G.has(Se)||G.set(Se,[]),G.get(Se).push(he),ge.has(c)||ge.set(c,[]),ge.get(c).push(he)});const $e=new Map,Ee=new Map;return G.forEach((he,Se)=>$e.set(Se,la(he).score)),ge.forEach((he,Se)=>Ee.set(Se,la(he).score)),{itemKnowness:$e,cardKnowness:Ee}},bt=async L=>{const G=ut,ge=L.concat(G.active??[]).concat(G.pool??[]).filter((O,Q,z)=>z.findIndex(ne=>pe(ne)===pe(O))===Q);if(!ze){Lt(new Set(ge.map(pe)));return}const{itemKnowness:$e,cardKnowness:Ee}=await ht(),he=O=>{if(O.cardType!=="info"||O.infoType!=="citation"||O.checkType!=="quote-fragment")return!0;const Q=Gt(O.direction);if(!(Q!=null&&Q.fragmentId))return!0;const z=O.description??"";if(!z.trim())return!0;const E=ja(z).nodes[Q.fragmentId];if(!E||!E.leftId&&!E.rightId)return!0;const te=[E.leftId,E.rightId].filter(Be=>!!Be);if(te.length===0)return!0;const we=te.map(Be=>{const Je=na("info",O.cardId,"quote-fragment",Be);return Ee.get(Je)??0});return we.reduce((Be,Je)=>Be+Je,0)/we.length>=Ue},Se=(x==null?void 0:x.collectionId)??null,c=Se?Mt.filter(O=>wt(O.childItemType)==="collection"&&O.childItemId===Se&&!wt(O.childCheckType)&&!wt(O.childDirection)):[],y=Se&&ge.length>0?ge.reduce((O,Q)=>O+(Ee.get(pe(Q))??0),0)/ge.length:0,F=new Set;for(const O of ge){if(O.cardType!=="info"){F.add(pe(O));continue}if(!he(O))continue;const Q=Mt.filter(E=>Ws(E,O)).concat(c);if(Q.length===0){F.add(pe(O));continue}let z=0;for(const E of Q)if(wt(E.parentItemType)==="collection")z+=E.parentItemId===Se?y:0;else if(wt(E.parentCheckType)||wt(E.parentDirection)){const te=wt(E.parentCheckType),we=wt(E.parentDirection),Fe=na(E.parentItemType,E.parentItemId,te,we);z+=Ee.get(Fe)??0}else{const te=`${E.parentItemType}:${E.parentItemId}`;z+=$e.get(te)??0}z/Q.length>=Ue&&F.add(pe(O))}Lt(F)},Jt=L=>{for(let G=L;G<g.length;G+=1){const ge=g[G];if(ge&&(!ze||ge.cardType!=="info"||xt.has(pe(ge))))return G}return-1},Xt=L=>!ze||L.cardType!=="info"||xt.has(pe(L)),ka=L=>{if(Ke.id!=="temporal"&&Ke.id!=="levels")return null;const G=ut,ge=(G.active??[]).concat(G.pool??[]),$e=new Set;for(const Ee of ge){const he=pe(Ee);if(!($e.has(he)||L.has(he))&&($e.add(he),Xt(Ee)))return Ee}return null},Ot=a.useMemo(()=>{if(Ke.id!=="levels")return null;const L=ut,G=L.pool??[],ge=L.active??[],$e=L.levelMap??{},Ee=Math.max(1,Number(mt.levels??1)),he=Array.from({length:Ee},()=>0),Se=new Set(ge.map(O=>pe(O)));G.forEach(O=>{const Q=Math.min(Ee,Math.max(1,$e[pe(O)]??1));he[Q-1]+=1});const c=G.length||1,y=he.map(O=>O/c*100),F=ae?$e[pe(ae)]??1:null;return{counts:he,percentages:y,currentLevel:F,levelsCount:Ee,activeCount:ge.length,poolCount:G.length,activeSet:Se}},[ut,mt,Ke,ae]),ta=a.useMemo(()=>{if(Ke.id!=="temporal")return null;const L=ut,G=L.pool??[],ge=L.active??[],$e=L.knownessMap??{},Ee=new Set(L.unknownSet??[]);let he=0;G.forEach(y=>{($e[pe(y)]??0)>1&&(he+=1)});const Se=Ee.size,c=ge.map(y=>({id:pe(y),value:Ee.has(pe(y))?0:Math.max(0,Math.min(1,$e[pe(y)]??0))}));return{knownCount:he,unknownCount:Se,dots:c}},[ut,Ke]),Na=a.useMemo(()=>{if(!ze)return 0;const L=ut;return g.concat(L.active??[]).concat(L.pool??[]).filter((ge,$e,Ee)=>Ee.findIndex(he=>pe(he)===pe(ge))===$e).filter(ge=>ge.cardType==="info"&&!xt.has(pe(ge))).length},[ze,ut,g,xt]);a.useEffect(()=>{if(!ze||V!=="ready")return;const L=ut,ge=g.concat(L.active??[]).concat(L.pool??[]).filter((he,Se,c)=>c.findIndex(y=>pe(y)===pe(he))===Se).filter(he=>he.cardType!=="info"||xt.has(pe(he))).length,$e=De.current;if(De.current=ge,$e===null||ge<=$e)return;const Ee=ge-$e;Ae(`New card available (+${Ee})`),ve.current&&window.clearTimeout(ve.current),ve.current=window.setTimeout(()=>Ae(null),2200)},[ze,V,ut,g,xt]),a.useEffect(()=>()=>{ve.current&&window.clearTimeout(ve.current)},[]);const zt=(L,G)=>{const ge=Ke.applyOutcome({queue:g,meta:ut},ae,Tt,mt,{correct:L,correctness:G,createdUtc:new Date().toISOString()});le(ge.queue),jt(ge.meta);const $e=ge.queue[I+1];$e&&Ca($e,I+1)};a.useEffect(()=>{if(!o){v("error");return}v("loading"),ki({shareId:o,key:tt}).then(L=>{l(L),S(L.collectionName),f(L.libraryName),v("ready")}).catch(()=>{v("error")})},[o,tt]),a.useEffect(()=>{o&&Ni({shareId:o,key:tt,type:"language"}).then(L=>p(L)).catch(()=>p([]))},[o,tt]),a.useEffect(()=>{!o||d!=="ready"||Si({shareId:o,key:tt}).then(L=>Ft(L.items??[])).catch(()=>Ft([]))},[o,tt,d]),a.useEffect(()=>{if(!o||d!=="ready")return;let L=!0;return(async()=>{N("loading"),R({current:0,total:Ke.id==="levels"?0:Ke.getFetchLimit(Tt,mt)});try{const ge=[];let $e=null,Ee=null;do{const Q=await Ti({shareId:o,key:tt,limit:300,cursor:$e});if(ge.push(...Q.items),(Ke.id==="levels"||Ke.id==="temporal")&&Q.total&&(Ee=Q.total),R(z=>({current:ge.length,total:z.total||Q.total||Ke.getFetchLimit(Tt,mt)})),$e=Q.nextCursor??null,Ee!==null&&ge.length>=Ee||Ke.id!=="levels"&&Ke.id!=="temporal"&&ge.length>=Ke.getFetchLimit(Tt,mt))break}while($e);if(!L)return;const he=Pa(ge);let Se;if(Ke.id==="levels"){const Q=Math.max(1,Number(mt.levels??1));Se={},he.forEach(z=>{const ne=pe(z);Se[ne]=Math.max(1,Math.min(Q,1))})}let c=null,y=null,F=null;if(Ke.id==="temporal"){const Q=await ca(),z=new Set(he.map(te=>pe(te))),ne=Q.reduce((te,we)=>{const Fe=na(we.itemType,we.itemId,we.checkType,we.direction);return z.has(Fe)&&(te[Fe]||(te[Fe]=[]),te[Fe].push(we)),te},{});c={},y=new Set,F={};const E=Date.now();he.forEach(te=>{const we=pe(te),Fe=ne[we]??[];if(Fe.length===0){c[we]=0,y.add(we),F[we]=[];return}const Be=Vn(Fe);F[we]=Be;const Je=cn(Be,E);c[we]=Je.knowness})}const O=Ke.id==="levels"?Un(he,Tt,mt,Se):Ke.id==="temporal"?On(he,Tt,mt,c??{},y??new Set,F??{}):Ke.prepare(he,Tt,mt);le(O.queue),jt(O.meta),re(0),N("ready"),R(Q=>({current:Math.min(Q.current,Q.total),total:Q.total}))}catch{L&&N("error")}})(),()=>{L=!1}},[o,tt,Tt,Ke,mt,d]),a.useEffect(()=>{bt(g)},[g,Mt,ze,Ue,x==null?void 0:x.collectionId]),a.useEffect(()=>{if(!ae||!ze){kt(!1);return}if(ae.cardType!=="info"||xt.has(pe(ae))){kt(!1);return}const L=Jt(I+1);if(L>=0){kt(!1),re(L);return}if(Ke.id==="temporal"||Ke.id==="levels"){const G=g.slice(0,I+1),ge=g.slice(I+1).filter(Xt),$e=G.concat(ge),Ee=new Set($e.map(pe)),he=ka(Ee);if(he){const c=pe(he);Ee.has(c)||($e.push(he),Ee.add(c),jt(y=>{const F=y,O=new Set(F.queued??[]);return O.add(c),{...F,queued:O}}))}const Se=$e.findIndex((c,y)=>y!==I&&Xt(c));if(Se>=0){le($e),re(Se),kt(!1);return}}kt(!0)},[ae,xt,ze,I,g,ut,Ke.id]),a.useEffect(()=>{if(xe(""),Z(null),ue(null),Qe(0),de([]),Pe({}),Ce({}),Ze(null),We(null),ot(null),T(!1),qe(!1),Y(null),je(null),Le({}),!ae){Ie(null),ee(null);return}ae.cardType==="info"&&ae.infoType==="computed"&&Ie(t.cogita.library.revision.loadingComputed);let L=!0;return Ca(ae,I).then(G=>{!L||!G||(Ie(G.prompt),ee(G.expectedAnswer),de(G.computedExpected),Pe(G.computedAnswers),Ze(G.answerTemplate),We(G.outputVariables),ot(G.variableValues))}),()=>{L=!1}},[ae,o,t]),a.useEffect(()=>{if(!ae||ae.cardType!=="info"||ae.infoType!=="citation"){yt.current=null,St.current=new Set,fe(null);return}const L=ae.description??"",G=(ae.label??"").trim(),ge=G.replace(/\s+/g," ").trim(),$e=L.replace(/\s+/g," ").trim(),Ee=ge&&ge!==$e?G:t.cogita.library.infoTypes.citation;if(!L){fe(null),ee(null);return}const he=ja(L);yt.current=he,Ie(Ee);let Se=!0;return ca().then(c=>{if(!Se)return;const y=new Map;c.forEach(ne=>{if(ne.itemType!=="info"||ne.checkType!=="quote-fragment"||!ne.direction)return;const E=Gt(ne.direction);if(!E)return;const te=`${ne.itemId}:${E.fragmentId}`;y.has(te)||y.set(te,[]),y.get(te).push(ne)});const F={},O=new Set;y.forEach((ne,E)=>{const[te,we]=E.split(":",2);if(te!==ae.cardId)return;const Fe=la(ne).score;F[we]=Fe,Fe>=Ue&&O.add(we)}),St.current=O,Pt.current=F;const Q=Gt(ae.direction);if(Q!=null&&Q.fragmentId&&he.nodes[Q.fragmentId]){ga(he,Q.fragmentId,Ee);return}const z=Ma(he,O,F,Ue,ze,ae.direction);ga(he,(z==null?void 0:z.id)??null,Ee)}).catch(()=>{St.current=new Set,Pt.current={};const c=Gt(ae.direction);if(c!=null&&c.fragmentId&&he.nodes[c.fragmentId]){ga(he,c.fragmentId,Ee);return}const y=Ma(he,St.current,{},Ue,ze,ae.direction);ga(he,(y==null?void 0:y.id)??null,Ee)}),()=>{Se=!1}},[ae,t,ze,Ue]),a.useEffect(()=>{if(!ae||ae.cardType!=="vocab"||ae.checkType!=="translation-match"){je(null),Le({});return}const ge=(ut.pool??ut.active??g).filter(c=>c.cardType==="vocab"&&c.checkType==="translation-match").filter((c,y,F)=>F.findIndex(O=>O.cardId===c.cardId)===y);ge.some(c=>c.cardId===ae.cardId)||ge.unshift(ae);const Ee=pt(ge).slice(0,6).map(c=>{const y=c.label.split("↔").map(Q=>Q.trim()).filter(Boolean);if(y.length<2)return null;const F=`${c.cardId}:L`,O=`${c.cardId}:R`;return{cardId:c.cardId,leftId:F,rightId:O,leftLabel:y[0],rightLabel:y[1]}}).filter(Boolean),he=Ee.map(c=>c.leftId),Se=pt(Ee.map(c=>c.rightId));je({pairs:Ee,leftOrder:he,rightOrder:Se,selection:{},activeLeft:null,activeRight:null,locked:{}})},[ae,g,ut]),a.useEffect(()=>()=>{Ge.current&&window.clearTimeout(Ge.current),$.current&&window.clearTimeout($.current)},[]);const $t=a.useRef(null);a.useEffect(()=>{if(!ae)return;const L=pe(ae),G=typeof document<"u"?document.activeElement:null;if($t.current===L&&G&&(G.tagName==="INPUT"||G.tagName==="TEXTAREA"))return;let ge=0;const $e=()=>{if(ae){if(ae.cardType==="info"&&ae.infoType==="computed"){if(X.length>0){const he=nn(He,X,Me),Se=he?et.current[he]:null;if(Se&&(Se.focus(),document.activeElement===Se)){$t.current=L;return}}if(Ye.current&&(Ye.current.focus(),document.activeElement===Ye.current)){$t.current=L;return}}else if(ae.cardType==="vocab"&&Ye.current&&(Ye.current.focus(),document.activeElement===Ye.current)){$t.current=L;return}ge<6&&(ge+=1,window.setTimeout($e,40))}},Ee=window.setTimeout($e,40);return()=>window.clearTimeout(Ee)},[ae,X,He,Me]),a.useEffect(()=>{if(!nt)return;const L=G=>{G.key==="Enter"&&(G.preventDefault(),Bt())};return window.addEventListener("keydown",L),()=>window.removeEventListener("keydown",L)},[nt]);const Zt=L=>{ie(L),K(la(L))};a.useEffect(()=>{if(!ae){K(null),ie([]);return}const L=ae.cardType==="info"?"info":"connection";if(ae.cardType==="info"&&ae.infoType==="citation"){ca().then(G=>{const ge=G.filter($e=>$e.itemType==="info"&&$e.itemId===ae.cardId&&$e.checkType==="quote-fragment"&&tn($e.direction,ae.direction));Zt(ge)}).catch(()=>{K(null),ie([])});return}en(L,ae.cardId,ae.checkType,ae.direction).then(G=>Zt(G)).catch(()=>{K(null),ie([])})},[ae]);const za=(L,G,ge,$e)=>{if(L==="info"&&ge==="quote-fragment"){ca().then(Ee=>{const he=Ee.filter(Se=>Se.itemType==="info"&&Se.itemId===G&&Se.checkType==="quote-fragment"&&tn(Se.direction,$e));Zt(he)}).catch(()=>{K(null),ie([])});return}en(L,G,ge,$e).then(Ee=>Zt(Ee)).catch(()=>{K(null),ie([])})},aa=(L,G,ge)=>{var Se;const $e=((Se=ge.pairs.find(c=>c.leftId===L))==null?void 0:Se.rightId)??null;if(!$e)return ge;const Ee=$e===G;Le(c=>({...c,[L]:Ee?"correct":"incorrect"})),Ge.current&&window.clearTimeout(Ge.current),$.current&&window.clearTimeout($.current),oe.current+=1;const he={kind:Ee?"correct":"incorrect",tick:oe.current};if(me(null),Ge.current=window.setTimeout(()=>me(he),0),$.current=window.setTimeout(()=>me(null),420),Ee){const c={...ge.locked,[L]:!0};return Object.keys(c).length>=ge.pairs.length?(Z("correct"),qe(!0)):Z("correct"),{...ge,selection:{...ge.selection,[L]:G},activeLeft:null,activeRight:null,locked:c}}return Z("incorrect"),{...ge,activeLeft:null,activeRight:null}},Sa=L=>{je(G=>!G||G.locked[L]?G:G.activeRight?aa(L,G.activeRight,G):{...G,activeLeft:G.activeLeft===L?null:L})},hn=L=>{je(G=>G&&(G.activeLeft?aa(G.activeLeft,L,G):{...G,activeRight:G.activeRight===L?null:L}))},Bt=()=>{var L;if(ae&&ae.cardType==="info"&&ae.infoType==="citation"&&yt.current&&q&&!((L=Gt(ae.direction))!=null&&L.fragmentId)){const G=Ma(yt.current,St.current,Pt.current,Ue,ze,ae.direction,q.fragmentId);if(G){Z(null),xe(""),T(!1),Ce({}),qe(!1),ue(null),Qe(0),ga(yt.current,G.id,q.title);return}}Z(null),xe(""),T(!1),Ce({}),qe(!1),ue(null),Qe(0),re(G=>Math.min(G+1,g.length))},Ht=L=>{if(!ae)return;const G=L.expected??null,ge=L.answer??"";let $e=G??"",Ee=ge;if(!G&&L.expectedMap&&L.answerMap){const Q=Object.keys(L.expectedMap).sort((z,ne)=>z.localeCompare(ne));$e=Q.map(z=>{var ne;return((ne=L.expectedMap)==null?void 0:ne[z])??""}).join("|"),Ee=Q.map(z=>{var ne;return((ne=L.answerMap)==null?void 0:ne[z])??""}).join("|")}const he=$e?La($e,Ee,b):new Uint8Array,Se={revisionType:Ke.id,evalType:L.evalType,direction:L.direction,prompt:C??"",expected:G,answer:ge,expectedAnswers:L.expectedMap??null,answers:L.answerMap??null,correct:L.correct,maskBase64:he.length?fa(he):null,checkMode:Rt,compareMode:b,minCorrectness:Re},c=new TextEncoder().encode(JSON.stringify(Se)),y=ae.cardType==="info"?"info":"connection",F=L.overrideCheckType??ae.checkType??null,O=L.overrideDirection??ae.direction??null;Za({itemType:y,itemId:ae.cardId,checkType:F,direction:O,revisionType:Ke.id,evalType:L.evalType,correct:L.correct,maskBase64:he.length?fa(he):null,payloadBase64:fa(c)}).then(()=>{za(y,ae.cardId,F,O),bt(g)}).catch(()=>{})},Ta=(L,G)=>{const ge=Et.current.get(G);if(ge)return Promise.resolve(ge);const $e=Dt.current.get(G);if($e)return $e;const Ee=Ci({shareCode:o,infoId:L,key:tt}).then(he=>{var Q,z;const Se=he.payload,c=((Q=Se.definition)==null?void 0:Q.graph)??null,y="",F=((z=Se.definition)==null?void 0:z.answerTemplate)??"",O=Os(c,y,F);if(O){const E={sample:Us(O),answerTemplate:F||null};return Et.current.set(G,E),E}return Qn({shareId:o,infoId:L,key:tt}).then(ne=>{const E={sample:ne,answerTemplate:null};return Et.current.set(G,E),E})}).catch(()=>Qn({shareId:o,infoId:L,key:tt}).then(he=>{const Se={sample:he,answerTemplate:null};return Et.current.set(G,Se),Se}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{Dt.current.delete(G)});return Dt.current.set(G,Ee),Ee},Ca=(L,G)=>{var c;const ge=`${pe(L)}:${G}`,$e=h.current.get(ge);if($e)return Promise.resolve($e);const Ee=Ne.current.get(ge);if(Ee)return Ee;const he=y=>(h.current.set(ge,y),y);let Se;if(L.cardType==="vocab"){if(L.checkType==="translation-match")return Se=Promise.resolve(he({prompt:L.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),Se;const y=L.label.split("↔").map(F=>F.trim()).filter(Boolean);if(y.length>=2){const O=(L.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",Q=O?y[0]:y[1],z=O?y[1]:y[0];Se=Promise.resolve(he({prompt:Q,expectedAnswer:z,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else Se=Promise.resolve(he({prompt:L.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(L.cardType==="info"&&L.infoType==="word"){const y=(c=L.description)!=null&&c.startsWith("Language: ")?L.description.replace("Language: ",""):null;Se=Promise.resolve(he({prompt:L.label,expectedAnswer:y,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else L.cardType==="info"&&L.infoType==="computed"?Se=Ta(L.cardId,ge).then(y=>{var ne,E;if(!y.sample)return he({prompt:L.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const F=y.sample,O=F.expectedAnswers?Object.entries(F.expectedAnswers).map(([te,we])=>({key:te,expected:we})):[],Q=O.reduce((te,we)=>(te[we.key]="",te),{}),z=F.expectedAnswerIsSentence&&((ne=F.expectedAnswer)==null?void 0:ne.trim())||null;return he({prompt:F.prompt,expectedAnswer:O.length>0?z:((E=F.expectedAnswer)==null?void 0:E.trim())||null,computedExpected:O,computedAnswers:Q,answerTemplate:y.answerTemplate,outputVariables:F.outputVariables??null,variableValues:F.variableValues??null})}).catch(()=>he({prompt:L.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Ne.current.delete(ge)}):Se=Promise.resolve(he({prompt:L.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return Ne.current.set(ge,Se),Se},ga=(L,G,ge)=>{const $e=Object.keys(L.nodes).length,Ee=St.current.size;if(!G){fe({title:ge,before:L.text,after:"",fragmentId:null,total:$e,completed:Ee}),ee(null),qe(!0);return}const he=L.nodes[G];if(!he)return;const Se=zn(L.text,he);fe({title:ge,before:Se.before,after:Se.after,fragmentId:he.id,total:$e,completed:Ee}),ee(Se.fragment),qe(!1)},gn=()=>{const L=yt.current;L&&fe(G=>G&&{...G,total:Object.keys(L.nodes).length,completed:St.current.size})},Ia=()=>{const L=g[I+1];L&&Ca(L,I+1)},ya=()=>{if(Ia(),ae&&ae.cardType==="vocab"&&ae.checkType==="translation-match"&&_e){if(_e.pairs.length===0){Z("incorrect"),qe(!0);return}const he=_e.pairs.reduce((z,ne)=>(z[ne.rightId]=ne.rightLabel,z),{});let Se=0;const c={};_e.pairs.forEach(z=>{const E=_e.selection[z.leftId]===z.rightId;c[z.leftId]=E?"correct":"incorrect",E&&(Se+=1)});const y=_e.pairs.length||1,F=Se/y,O=Se===_e.pairs.length;Le(z=>({...z,...c})),O?(Z("correct"),qe(!0),Qe(0)):(Z("incorrect"),qe(!1),Qe(z=>{const ne=z+1;return ne>=Qt&&(T(!0),qe(!0),je(E=>{if(!E)return E;const te=E.pairs.reduce((we,Fe)=>(we[Fe.leftId]=Fe.rightId,we),{});return{...E,selection:te}})),ne})),zt(O,F);const Q="connection";Promise.all(_e.pairs.map(z=>{const ne=_e.selection[z.leftId]??null,E=ne?he[ne]:"",te={left:z.leftLabel,expected:z.rightLabel,answer:E,checkType:"translation-match"},we=new TextEncoder().encode(JSON.stringify(te));return Za({itemType:Q,itemId:z.cardId,checkType:"translation-match",direction:null,revisionType:Ke.id,evalType:"translation-match",correct:ne===z.rightId,maskBase64:null,payloadBase64:fa(we)})})).then(()=>{za(Q,ae.cardId,ae.checkType,ae.direction),bt(g)}).catch(()=>{});return}if(X.length>0){const he=X.reduce((c,y)=>{const F=ye[y.key]??"";return c[y.key]=_t(F)===_t(y.expected)?"correct":"incorrect",c},{});X.every(({key:c,expected:y})=>{const F=ye[c]??"";return Rt==="exact"&&_t(F)===_t(y)})?(Z("correct"),Ce(he),qe(!0),Qe(0),zt(!0,1),Ht({correct:!0,direction:C?`${C} -> computed`:"computed",expectedMap:X.reduce((c,y)=>(c[y.key]=y.expected,c),{}),answerMap:ye,evalType:"computed"})):(Z("incorrect"),Ce(he),qe(!1),Qe(c=>{const y=c+1;return y>=Qt&&ia&&(T(!0),qe(!0)),y}),zt(!1,0),window.setTimeout(()=>{var y;const c=nn(He,X,Me);c&&et.current[c]&&((y=et.current[c])==null||y.focus())},40),Ht({correct:!1,direction:C?`${C} -> computed`:"computed",expectedMap:X.reduce((c,y)=>(c[y.key]=y.expected,c),{}),answerMap:ye,evalType:"computed"}));return}if(ae&&ae.cardType==="info"&&ae.infoType==="citation"&&(q!=null&&q.fragmentId)){if(!B)return;const he=Gt(ae.direction),Se=(he==null?void 0:he.fragmentId)??q.fragmentId,c=Qa(B,ce,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),y=c.mask,F=c.isCorrect,O=c.percent;F?(Pt.current[q.fragmentId]=Math.max(Pt.current[q.fragmentId]??0,O),(Pt.current[q.fragmentId]??0)>=Ue&&St.current.add(q.fragmentId),gn(),Z("correct"),Ce({}),qe(!0),ue(y),Qe(0),O<100&&Qt<=1&&T(!0),zt(!0,O/100),Ht({correct:!0,direction:`quote:${q.fragmentId}`,expected:B,answer:ce,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Se})):(Z("incorrect"),Ce({}),qe(!1),ue(y),Qe(Q=>{const z=Q+1;return z>=Qt&&ia&&(T(!0),qe(!0)),z}),zt(!1,O/100),window.setTimeout(()=>{var Q;return(Q=Ye.current)==null?void 0:Q.focus()},40),Ht({correct:!1,direction:`quote:${q.fragmentId}`,expected:B,answer:ce,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Se}));return}if(!B)return;const L=La(B,ce,b),G=Rt==="exact"&&_t(ce)===_t(B),ge=ft(L),$e=G||ge,Ee=ba(L);$e?(Z("correct"),Ce({}),qe(!0),ue(L),Qe(0),Ee<100&&Qt<=1&&T(!0),zt(!0,Ee/100),Ht({correct:!0,direction:C?`${C} -> ${B}`:null,expected:B,answer:ce,evalType:"text"})):(Z("incorrect"),Ce({}),qe(!1),ue(L),Qe(he=>{const Se=he+1;return Se>=Qt&&ia&&(T(!0),qe(!0)),Se}),zt(!1,Ee/100),window.setTimeout(()=>{var he;return(he=Ye.current)==null?void 0:he.focus()},40),Ht({correct:!1,direction:C?`${C} -> ${B}`:null,expected:B,answer:ce,evalType:"text"}))},sa=L=>{if(Ia(),!B)return;const G=La(B,L,b),ge=_t(L)===_t(B),$e=ft(G),Ee=ge||$e,he=ba(G);Ee?(Z("correct"),Ce({}),qe(!0),ue(G),Qe(0),he<100&&Qt<=1&&T(!0),zt(!0,he/100),Ht({correct:!0,direction:"word->language",expected:B,answer:L,evalType:"language-select"})):(Z("incorrect"),Ce({}),qe(!1),ue(G),Qe(Se=>{const c=Se+1;return c>=Qt&&ia&&(T(!0),qe(!0)),c}),zt(!1,he/100),Ht({correct:!1,direction:"word->language",expected:B,answer:L,evalType:"language-select"}))},mn=L=>{var ge;if(L.key!=="Enter")return;if(L.preventDefault(),L.stopPropagation(),nt){Bt();return}const G=X.find($e=>!(ye[$e.key]??"").trim());if(G){(ge=et.current[G.key])==null||ge.focus();return}ya()},Ra=()=>{Ia(),Z("correct"),qe(!0),Qe(0),zt(!0,1),B&&Ht({correct:!0,direction:"manual",expected:B,answer:ce,evalType:"manual"})},xa=()=>{if(zt(!1,0),ae&&ae.cardType==="info"&&ae.infoType==="citation"){Z(null),xe(""),T(!1),Ce({}),qe(!1),ue(null),Qe(0),re(L=>Math.min(L+1,g.length));return}Bt()};a.useEffect(()=>{Ia()},[I,g]);const pn=t.cogita.library.revision.revealModeAfterIncorrect,ia=X.length>0||!!B;return e.jsxs(Kt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:u,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:[(d==="loading"||V==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:d==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${W.total?Math.min(100,Math.max(0,W.current/W.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:W.total?`${Math.min(W.current,W.total)} / ${W.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:w}),e.jsx("p",{className:"cogita-library-subtitle",children:D}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",Ct).replace("{check}",It)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:U?`${U.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Ot?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Ot.currentLevel??"-"," / ",Ot.levelsCount]}):null,U?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(U.correct)).replace("{total}",String(U.total))}),U.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(U.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(qs,{outcomes:H})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[ke?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:ke})}):null,e.jsx(Bn,{feedbackToken:_?`${_.kind}-${_.tick}`:qt?"idle":Te??"idle",children:d!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:d==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):ae?e.jsx(e.Fragment,{children:vt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(_n,{copy:t,currentCard:ae,currentTypeLabel:Oe,prompt:C,languages:P,answer:ce,onAnswerChange:L=>xe(G=>an(G,L,A)),computedExpected:X,computedAnswers:ye,onComputedAnswerChange:(L,G)=>Pe(ge=>({...ge,[L]:an(ge[L]??"",G,A)})),answerTemplate:He,outputVariables:Me,variableValues:rt,computedFieldFeedback:Ve,feedback:Te,canAdvance:nt,quoteContext:q,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:ya,onSkip:xa,onLanguageSelect:sa,onMarkReviewed:Ra,onAdvance:Bt,showCorrectAnswer:se,setShowCorrectAnswer:T,onRevealCorrect:()=>qe(!0),answerMask:be,expectedAnswer:B,hasExpectedAnswer:ia,handleComputedKeyDown:mn,answerInputRef:Ye,computedInputRefs:et,scriptMode:A,setScriptMode:Y,matchPairs:_e==null?void 0:_e.pairs,matchLeftOrder:_e==null?void 0:_e.leftOrder,matchRightOrder:_e==null?void 0:_e.rightOrder,matchSelection:_e==null?void 0:_e.selection,matchActiveLeft:_e==null?void 0:_e.activeLeft,matchActiveRight:_e==null?void 0:_e.activeRight,matchFeedback:J,onMatchLeftSelect:Sa,onMatchRightSelect:hn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Nt?`${Yt} / ${Nt}`:t.cogita.library.revision.progressUnlimited}),d==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),d==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),d==="ready"&&V==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),d==="ready"&&V==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),d==="ready"&&V==="ready"&&g.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:pn}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",Qt]})]})]}),Ot?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Ot.activeCount," / ",Ot.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Ot.counts.map((L,G)=>{const ge=G+1,$e=Ot.currentLevel===ge,Ee=Ot.percentages[G]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":$e,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:ge}),e.jsx("strong",{children:L})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,Ee))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[Ee.toFixed(1),"%"]})]},`level-${ge}`)})})]}):null,ta?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:ta.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:ta.dots.map(L=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-L.value))}, ${Math.round(200*L.value)}, 80, 0.9)`}},L.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:ta.knownCount})]})]}):null,ze?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Na})]})}):null]})]})]})})})]})]})}const Zr=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:Hr},Symbol.toStringTag,{value:"Module"}));export{Qr as C,Xr as a,Zr as b};
