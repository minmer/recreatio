import{r as a,j as e,u as hn,a as qa,b as Un,c as Jn,d as Hn,R as gn,B as mn,C as pn,Q as cr}from"./vendor-CAC2WLor.js";import{L as _s,A as zs,g as Bs,a as dr,b as Ba,c as Wn,s as is,d as Qn,e as ur,f as Tn,h as na,i as hr,j as gr,k as Za,l as en,m as Os,n as Gn,o as On,p as mr,u as os,q as Vs,r as pr,t as fr,v as br,w as yr,x as xr,y as qs,z as vr,B as Us,C as Js,D as wr,E as jr,F as fn,G as Oa,H as kr,I as Hs,J as Nr,K as Yn,M as Ws,N as Sr,O as Tr,P as Cr,Q as Vn,R as ya,S as Ir,T as Mr,U as Lr,V as Ar,W as Rr,X as $r,Y as Pr,Z as Er,_ as Kr,$ as Fr,a0 as Dr,a1 as _r,a2 as zr,a3 as ls,a4 as cs,a5 as Br,a6 as Or,a7 as Vr,a8 as ds,a9 as qr,aa as Ur}from"./recreatio-core-B12ledQl.js";import"./vendor-cogita-ui-DTaQ_FiW.js";const Da={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},Ea={moveMs:900,pauseMs:220,errorMs:900},Jr=(t=11)=>{let n=t;const r=()=>(n=(n*1664525+1013904223)%4294967296,n/4294967296),{width:s,height:o,paddingX:h,paddingY:d,levels:w}=Da,f=(o-d*2)/(w.length-1),j=[],i=[],p=[];w.forEach((x,g)=>{const C=o-d-g*f,D=s-h*2,y=[];for(let U=0;U<x;U+=1){const N=h+(U+1)*D/(x+1),ae=(r()-.5)*18,z=Math.max(h,Math.min(s-h,N+ae)),P=g===0?3:g<2?2.1:1.4,B=g===0?"root":`l${g}-${U}`;y.push({id:B,x:g===0?s/2:z,y:C,r:P,level:g,role:g===0?"root":void 0})}p.push(y),j.push(...y)});const c=p[p.length-1];if(c!=null&&c.length){const x=c[Math.floor(c.length/2)];x.role="goal",x.r=2}for(let x=1;x<p.length;x+=1){const g=p[x-1];p[x].forEach(D=>{const y=[...g].sort((z,P)=>Math.abs(z.x-D.x)-Math.abs(P.x-D.x)),U=y[0],N=y[1]&&r()<.45?y[1]:null;(N?[U,N]:[U]).forEach(z=>{i.push({from:z.id,to:D.id,key:`${z.id}-${D.id}`})}),r()<.2&&y[2]&&i.push({from:y[2].id,to:D.id,key:`${y[2].id}-${D.id}`})})}const u=new Map;i.forEach(x=>{const g=u.get(x.to)??[];g.push(x.from),u.set(x.to,g)});const v=new Map,m=new Map,S=new Map;i.forEach(x=>{const g=v.get(x.from)??[];g.push(x.key),v.set(x.from,g);const C=m.get(x.from)??[];C.push(x.to),m.set(x.from,C);const D=S.get(x.from)??[];D.push(x.to),S.set(x.from,D);const y=S.get(x.to)??[];y.push(x.from),S.set(x.to,y)});const _=new Map;return j.forEach(x=>{_.set(x.id,x)}),{nodes:j,links:i,parentsById:u,linksByFrom:v,childrenByFrom:m,neighborsById:S,nodesById:_}};function Hr({slides:t,activeIndex:n,introOpen:r,prefersReducedMotion:s,onNext:o,onPrev:h,onSelect:d,onExit:w,onOpen:f,onRegister:j}){const i=n===t.length-1,p=r&&n===0?"entry":"docked",c=t[t.length-1],[u,v]=a.useState(!1),m=a.useMemo(()=>Array.from({length:20},(K,R)=>({src:`/cogita/logo/Cogita${String(R).padStart(2,"0")}.png`,kind:R<=11?"bubble":R<=17?"text":"recreatio"})),[]),S=r&&n===0;a.useEffect(()=>{if(!r){v(!1);return}n>0&&!u&&v(!0)},[n,r,u]);const _=a.useRef(0),x=a.useRef(null),g=a.useMemo(()=>{const K={x:40,y:160},R={x:260,y:48},k=6,T=R.x-K.x,M=K.y-R.y,oe=T/k,fe=[.3,.45,.6,.65,1.4,2.2],de=fe.reduce((H,X)=>H+X,0),Y=fe.map(H=>M*H/de),E=[K];let W=K.x,te=K.y;for(let H=1;H<=k;H+=1){const X=(Math.random()-.5)*14,be=(Math.random()-.5)*28;W=Math.max(K.x+H*14,Math.min(R.x-(k-H)*14,W+oe+X));const O=Y[H-1]??Y[Y.length-1];te=te-O+be;const ne=Math.max(R.y,Math.min(K.y-4,te));E.push({x:Math.round(W),y:Math.round(ne)})}return E[E.length-1]=R,E},[]),C=a.useMemo(()=>{const M=(de,Y,E)=>Math.min(E,Math.max(Y,de)),oe=g.map(de=>{const Y=10+Math.random()*36;return{x:M(de.x,40,260),y:M(de.y-Y,40,140)}}),fe=g.map((de,Y)=>{var te;const E=12+Math.random()*40,W=((te=oe[Y])==null?void 0:te.y)??de.y;return{x:M(de.x,40,260),y:M(Math.max(W+10,de.y+E),60,170)}});return{upper:oe,lower:fe}},[g]),D=a.useMemo(()=>{var R;const K=((R=g[4])==null?void 0:R.x)??260;return Math.max(0,Math.min(240,K-40))},[g]),y=a.useMemo(()=>{var Y,E;const K=(W,te,H)=>Math.min(H,Math.max(te,W)),R=(W,te,H)=>g.map((X,be)=>{var pt,ht;const O=((pt=C.upper[be])==null?void 0:pt.y)??X.y,ne=((ht=C.lower[be])==null?void 0:ht.y)??X.y,Le=(Math.random()-.5)*70,qe=X.y+W+Le,De=K(X.y+te,O+6,ne-6),Je=K(X.y+H,O+6,ne-6);return{x:X.x,y:K(qe,Math.min(De,Je),Math.max(De,Je))}}),k=-14+Math.random()*28,T=14+Math.random()*28,M=R(k,-80,12),oe=R(T,-12,80);for(let W=4;W<g.length;W+=1){const te=g[W],H=((Y=C.upper[W])==null?void 0:Y.y)??te.y,X=((E=C.lower[W])==null?void 0:E.y)??te.y;M[W]={x:te.x,y:K(te.y-12,H+6,X-6)},oe[W]={x:te.x,y:K(te.y+12,H+6,X-6)}}const fe=C.upper.length?C.upper[C.upper.length-1].y:40,de=C.lower.length?C.lower[C.lower.length-1].y:170;return M[M.length-1]={x:g[g.length-1].x,y:K(g[g.length-1].y-14,fe,de)},oe[oe.length-1]={x:g[g.length-1].x,y:K(g[g.length-1].y+12,fe,de)},{higher:M,lower:oe}},[g,C]),U=1e4,N=a.useMemo(()=>{let K=17;const R=()=>(K=(K*1664525+1013904223)%4294967296,K/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((T,M)=>{const oe=(R()-.5)*240,fe=(R()-.5)*180,de=(R()-.5)*24;return{id:`card-${M+1}`,throw:{x:`${oe.toFixed(0)}px`,y:`${fe.toFixed(0)}px`,rot:`${de.toFixed(1)}deg`},grid:{x:`${T.x}px`,y:`${T.y}px`},delay:`${M*.12}s`}})},[]),ae=a.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[z,P]=a.useState([]),B=a.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),Q=a.useMemo(()=>{const R=[],T=(oe,fe)=>oe+Math.random()*(fe-oe);for(let oe=0;oe<6;oe+=1){let fe=!1;for(let de=0;de<80;de+=1){const Y=T(14,86),E=T(10,34);if(R.every(te=>{const H=te.x-Y,X=te.y-E;return Math.hypot(H,X)>=12})){R.push({x:Y,y:E}),fe=!0;break}}fe||R.push({x:T(16,84),y:T(12,32)})}return R.map((oe,fe)=>({id:`p${fe+1}`,x:`${oe.x.toFixed(1)}%`,y:`${oe.y.toFixed(1)}%`,xNum:oe.x,yNum:oe.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[xe,Ee]=a.useState(0),[re,A]=a.useState(0),[ye,J]=a.useState([]),ge=1e4,ee=a.useMemo(()=>{if(Q.length<2)return[];const K=fe=>{let de=fe+1831565813;return de=Math.imul(de^de>>>15,de|1),de^=de+Math.imul(de^de>>>7,de|61),((de^de>>>14)>>>0)/4294967296},R=(fe,de)=>Math.floor(K(fe)*de),k=new Set,T=[],M=Math.min(3,Q.length);let oe=0;for(;T.length<M&&oe<30;){oe+=1;const fe=R(xe*13+oe*5,Q.length),de=R(xe*29+oe*7,Q.length);if(fe===de)continue;const Y=fe<de?`${fe}-${de}`:`${de}-${fe}`;k.has(Y)||(k.add(Y),T.push({id:`link-${Y}`,from:Q[fe],to:Q[de],delay:`${(oe*.35).toFixed(2)}s`}))}return T},[xe,Q]);a.useEffect(()=>{if(!r||n!==2)return;const K=()=>{const k=N.map(T=>T.id);for(let T=k.length-1;T>0;T-=1){const M=Math.floor(Math.random()*(T+1));[k[T],k[M]]=[k[M],k[T]]}return k.slice(0,4)};P(K());const R=window.setInterval(()=>{P(K())},U);return()=>window.clearInterval(R)},[n,r,N,U]),a.useEffect(()=>{if(!r||n!==3)return;const K=()=>{A(Math.floor(Math.random()*B.length)),J(Q.map(()=>Math.random()<.6?"good":"bad")),Ee(k=>k+1)};K();const R=window.setInterval(K,ge);return()=>window.clearInterval(R)},[n,r,B.length,Q,ge]);const ke=a.useMemo(()=>Jr(11),[]),[ue,le]=a.useState(new Set(["root"])),[Ie,Ae]=a.useState(new Set),[Ke,Re]=a.useState(new Set),[Ze,ot]=a.useState({fromId:"root",toId:"root",key:0}),Te=a.useRef(ue),We=a.useRef("root"),ft=a.useRef(0),Ve=a.useRef(null),ze=a.useRef(null),et=a.useRef([]);a.useEffect(()=>{Te.current=ue},[ue]);const it=a.useMemo(()=>{const K=new Set;return ue.forEach(R=>{const k=ke.linksByFrom.get(R);k&&k.forEach(T=>K.add(T))}),K},[ue,ke]),Ge=ke.nodesById.get(Ze.toId)??ke.nodesById.get("root"),Ce=Ge?`${Ge.x/Da.width*100}%`:"50%",Be=Ge?`${Ge.y/Da.height*100}%`:"90%";a.useEffect(()=>{if(!r||n!==1||s)return;(()=>{le(new Set(["root"])),Ae(new Set),Re(new Set),ot({fromId:"root",toId:"root",key:0}),ze.current=null,ft.current=0,We.current="root",et.current=[]})();const R=()=>{const T=We.current,M=Te.current,fe=(ke.childrenByFrom.get(T)??[]).filter(X=>!M.has(X));if(fe.length)return fe[Math.floor(Math.random()*fe.length)];if(M.size>=ke.nodes.length){const X=ke.neighborsById.get(T)??[];return X.length?X[Math.floor(Math.random()*X.length)]:null}const de=X=>(ke.childrenByFrom.get(X)??[]).some(O=>!M.has(O)),Y=[T],E=new Set([T]),W=new Map;let te=null;for(;Y.length;){const X=Y.shift();if(!X)break;if(X!==T&&de(X)){te=X;break}(ke.neighborsById.get(X)??[]).forEach(O=>{E.has(O)||(E.add(O),W.set(O,X),Y.push(O))})}if(!te)return null;let H=te;for(;W.get(H)&&W.get(H)!==T;)H=W.get(H)??H;return H},k=(T,M)=>{if(T===M){const oe=R();oe&&k(T,oe);return}ft.current+=1,ot({fromId:T,toId:M,key:ft.current}),We.current=M,Ve.current=window.setTimeout(()=>{const oe=ke.parentsById.get(M)??[],fe=Te.current,de=oe.filter(te=>!fe.has(te));if(!de.length){const te=new Set(fe);te.add(M),le(te),Ve.current=window.setTimeout(()=>{for(;et.current.length;){const X=et.current[et.current.length-1];if(!te.has(X)){if(X!==M){k(M,X);return}break}et.current.pop()}const H=R();H&&k(M,H)},Ea.pauseMs);return}const Y=new Set([M,...de]),E=new Set(de.map(te=>`${te}-${M}`));Ae(Y),Re(E),et.current.includes(M)||et.current.push(M);const W=de[Math.floor(Math.random()*de.length)];ze.current={fromId:M,toId:W},Ve.current=window.setTimeout(()=>{Ae(new Set),Re(new Set);const te=ze.current;te&&k(te.fromId,te.toId)},Ea.errorMs)},Ea.moveMs)};return Ve.current=window.setTimeout(()=>{const T=R();T&&k(We.current,T)},Ea.pauseMs),()=>{Ve.current&&window.clearTimeout(Ve.current)}},[n,r,ke,s]);const Ye=K=>{if(!r)return;const R=Date.now();R-_.current<520||Math.abs(K.deltaY)<10||(_.current=R,K.deltaY>0?o():h(),K.preventDefault())},$=K=>{if(!r)return;const R=K.touches[0];R&&(x.current={x:R.clientX,y:R.clientY})},L=K=>{if(!r)return;const R=x.current;if(x.current=null,!R)return;const k=K.changedTouches[0];if(!k)return;const T=k.clientX-R.x,M=k.clientY-R.y;Math.abs(M)<40||Math.abs(M)<Math.abs(T)||(M<0?o():h())};return e.jsxs("div",{className:`cogita-intro ${r?"is-open":"is-closed"} ${s?"is-reduced":""} ${i?"is-final":""}`,"data-slide":n+1,onWheel:Ye,onTouchStart:$,onTouchEnd:L,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":p,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${S&&!u?"is-entry":""}`,children:m.map((K,R)=>e.jsx("img",{src:K.src,alt:"",className:`cogita-logo-layer ${R===0?"is-base":""} ${K.kind==="text"?"is-text":K.kind==="recreatio"?"is-recreatio":""} ${K.kind==="bubble"?"is-bubble":""}`},K.src))})}),r&&t.map((K,R)=>{const k=R===n;return e.jsxs("section",{className:`cogita-intro-slide slide-${R+1} ${k?"is-active":""}`,"aria-hidden":!k,children:[e.jsxs("div",{className:"cogita-intro-text",children:[K.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:K.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:K.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:K.title}),K.body&&e.jsx("p",{children:K.body.split(`
`).map((T,M)=>e.jsxs("span",{children:[T,M===0&&e.jsx("br",{})]},String(M)))})]}),K.micro&&e.jsx("p",{className:"cogita-intro-micro",children:K.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:i?j:o,children:K.cta}),i&&K.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>d(0),children:K.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[R===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${Da.width} ${Da.height}`,preserveAspectRatio:"none",children:[ke.links.map(T=>{const M=ke.nodesById.get(T.from),oe=ke.nodesById.get(T.to);if(!M||!oe)return null;const fe=it.has(T.key),de=Ke.has(T.key);return e.jsx("line",{className:`map-link ${fe?"is-active":""} ${de?"is-error":""}`,x1:M.x,y1:M.y,x2:oe.x,y2:oe.y},T.key)}),ke.nodes.map(T=>{const M=ue.has(T.id),oe=Ie.has(T.id);return e.jsx("circle",{className:`map-node ${T.role?`is-${T.role}`:""} ${M?"is-active":""} ${oe?"is-error":""}`,cx:T.x,cy:T.y,r:T.r},T.id)})]}),Ge&&e.jsx("span",{className:"map-explorer-dot",style:{left:Ce,top:Be,"--move":`${Ea.moveMs}ms`}})]}),R===2&&e.jsx("div",{className:"cogita-index-cards",children:N.map(T=>{const M=z.indexOf(T.id),oe=M>=0?ae[M]:null,fe=(oe==null?void 0:oe.x)??"140px",de=(oe==null?void 0:oe.y)??"140px",Y=M>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":T.throw.x,"--throw-y":T.throw.y,"--throw-rot":T.throw.rot,"--grid-x":T.grid.x,"--grid-y":T.grid.y,"--stack-x":fe,"--stack-y":de,"--stack-opacity":Y,"--delay":T.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},T.id)})}),R===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[B.map((T,M)=>e.jsxs("div",{className:`round-card ${M===re?"is-active":""}`,style:{"--card-x":T.x,"--card-y":T.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},T.id)),B[re]&&e.jsx("span",{className:"round-ring",style:{"--card-x":B[re].x,"--card-y":`calc(${B[re].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:Q.map(T=>e.jsx("span",{className:"player-dot",style:{left:T.x,top:T.y,"--jitter-x":T.jitterX,"--jitter-y":T.jitterY,"--breath-delay":T.delay}},T.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:ee.map(T=>e.jsx("line",{className:"round-link",x1:T.from.xNum,y1:T.from.yNum,x2:T.to.xNum,y2:T.to.yNum,style:{"--delay":T.delay}},T.id))}),e.jsx("div",{className:"round-flows",children:Q.map((T,M)=>{const oe=ye[M]??"good",fe=B[re];if(!fe)return null;const de=`calc(${fe.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":T.x,"--from-y":T.y,"--to-x":fe.x,"--to-y":de,"--delay":`${M*.12}s`}}),e.jsx("span",{className:`return-dot is-${oe}`,style:{"--from-x":fe.x,"--from-y":de,"--to-x":T.x,"--to-y":T.y,"--delay":`${M*.12}s`}}),e.jsx("span",{className:`result-pop is-${oe}`,style:{"--at-x":T.x,"--at-y":T.y,"--delay":`${M*.12}s`}})]},`${T.id}-${xe}`)})})]},`round-${xe}`),R===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${g[0].x} ${g[0].y} L${g[1].x} ${g[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${g[1].x} ${g[1].y} L${g[2].x} ${g[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${g[2].x} ${g[2].y} L${g[3].x} ${g[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${g[3].x} ${g[3].y} L${g[4].x} ${g[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${g[4].x} ${g[4].y} L${g[5].x} ${g[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${g[5].x} ${g[5].y} L${g[6].x} ${g[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${D};${D};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${C.upper.map((T,M)=>`${M===0?"M":"L"}${T.x} ${T.y}`).join(" ")} ${C.lower.slice().reverse().map(T=>`L${T.x} ${T.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${C.upper.map((T,M)=>`${M===0?"M":"L"}${T.x} ${T.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${C.lower.map((T,M)=>`${M===0?"M":"L"}${T.x} ${T.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[y.higher.slice(0,6).map((T,M)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${M+1}`,d:`M${T.x} ${T.y} L${y.higher[M+1].x} ${y.higher[M+1].y}`,pathLength:"100"},`peer-1-${M}`)),y.lower.slice(0,6).map((T,M)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${M+1}`,d:`M${T.x} ${T.y} L${y.lower[M+1].x} ${y.lower[M+1].y}`,pathLength:"100"},`peer-2-${M}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${g[0].x/300*100}%`,"--p0y":`${g[0].y/200*100}%`,"--p1x":`${g[1].x/300*100}%`,"--p1y":`${g[1].y/200*100}%`,"--p2x":`${g[2].x/300*100}%`,"--p2y":`${g[2].y/200*100}%`,"--p3x":`${g[3].x/300*100}%`,"--p3y":`${g[3].y/200*100}%`,"--p4x":`${g[4].x/300*100}%`,"--p4y":`${g[4].y/200*100}%`,"--p5x":`${g[5].x/300*100}%`,"--p5y":`${g[5].y/200*100}%`,"--p6x":`${g[6].x/300*100}%`,"--p6y":`${g[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${y.higher[0].x/300*100}%`,"--q0y":`${y.higher[0].y/200*100}%`,"--q1x":`${y.higher[1].x/300*100}%`,"--q1y":`${y.higher[1].y/200*100}%`,"--q2x":`${y.higher[2].x/300*100}%`,"--q2y":`${y.higher[2].y/200*100}%`,"--q3x":`${y.higher[3].x/300*100}%`,"--q3y":`${y.higher[3].y/200*100}%`,"--q4x":`${y.higher[4].x/300*100}%`,"--q4y":`${y.higher[4].y/200*100}%`,"--q5x":`${y.higher[5].x/300*100}%`,"--q5y":`${y.higher[5].y/200*100}%`,"--q6x":`${y.higher[6].x/300*100}%`,"--q6y":`${y.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${y.lower[0].x/300*100}%`,"--q0y":`${y.lower[0].y/200*100}%`,"--q1x":`${y.lower[1].x/300*100}%`,"--q1y":`${y.lower[1].y/200*100}%`,"--q2x":`${y.lower[2].x/300*100}%`,"--q2y":`${y.lower[2].y/200*100}%`,"--q3x":`${y.lower[3].x/300*100}%`,"--q3y":`${y.lower[3].y/200*100}%`,"--q4x":`${y.lower[4].x/300*100}%`,"--q4y":`${y.lower[4].y/200*100}%`,"--q5x":`${y.lower[5].x/300*100}%`,"--q5y":`${y.lower[5].y/200*100}%`,"--q6x":`${y.lower[6].x/300*100}%`,"--q6y":`${y.lower[6].y/200*100}%`}})]})})}),R===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),R===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},K.id)}),!r&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:c.title}),c.body&&e.jsx("p",{children:c.body}),c.micro&&e.jsx("p",{className:"cogita-intro-micro",children:c.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:j,children:c.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:f,children:"Otwórz pokaz"})]})]})})]}),r&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((K,R)=>e.jsx("button",{type:"button",className:`dot ${n===R?"active":""}`,"aria-label":K.title,onClick:()=>d(R)},K.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:w,children:"Pomiń"})]})]})}const Wr=6,Qr=4;function Gr({copy:t,onAuthAction:n,authLabel:r,showProfileMenu:s,onProfileNavigate:o,onToggleSecureMode:h,onLogout:d,secureMode:w,onNavigate:f,language:j,onLanguageChange:i}){const p=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}f("home")},c=a.useRef(null),u=a.useRef([]),v=a.useMemo(()=>{let J=Date.now()%2147483647;const ge=()=>(J=J*48271%2147483647,J/2147483647);return Array.from({length:Wr},(ee,ke)=>{const ue=6+ge()*8,le=7+ge()*10,Ie=6+ge()*9,Ae=-ge()*ue,Ke=-ge()*le,Re=-ge()*Ie,Ze=.18+ge()*.28,ot=12+ge()*18,Te=4+ge()*8,We=(ge()-.5)*3.2,ft=(ge()-.5)*3.8,Ve=ge()>.5?"alternate":"alternate-reverse",ze=ge()>.5?"alternate":"alternate-reverse",et=ge()>.5?"alternate":"alternate-reverse",it=.18+ge()*.42,Ge=30+ge()*60,Ce=-45-ge()*38,Be=188+ge()*32,Ye=.1+ge()*.2;return{id:`wave-${ke+1}`,style:{"--wave-sway-duration":`${ue}s`,"--wave-scale-duration":`${le}s`,"--wave-drift-duration":`${Ie}s`,"--wave-sway-delay":`${Ae}s`,"--wave-scale-delay":`${Ke}s`,"--wave-drift-delay":`${Re}s`,"--wave-sway-dir":Ve,"--wave-scale-dir":ze,"--wave-drift-dir":et,"--wave-scale":`${Ze}`,"--wave-shift":`${ot}%`,"--wave-xshift":`${Te}%`,"--wave-x0":`${We}%`,"--wave-y0":`${ft}%`,"--wave-opacity":`${it}`,"--wave-blur":`${Ge}px`,"--wave-bottom":`${Ce}%`,"--wave-hue":`${Be}`,"--wave-glow":`${Ye}`}}})},[]),m=a.useMemo(()=>{let J=Date.now()*3%2147483647;const ge=()=>(J=J*48271%2147483647,J/2147483647);return Array.from({length:Qr},(ee,ke)=>{const ue=180+ge()*220,le=220+ge()*280,Ie=-ge()*ue,Ae=-ge()*le,Ke=.12+ge()*.22,Re=3+ge()*7,Ze=1+ge()*3,ot=(ge()-.5)*2.8,Te=(ge()-.5)*2.2;return{id:`mesh-${ke+1}`,seed:1e3+ke*991+Math.floor(ge()*999),style:{"--mesh-sway-duration":`${ue}s`,"--mesh-drift-duration":`${le}s`,"--mesh-sway-delay":`${Ie}s`,"--mesh-drift-delay":`${Ae}s`,"--mesh-scale":`${Ke}`,"--mesh-shift":`${Re}%`,"--mesh-xshift":`${Ze}%`,"--mesh-x0":`${Te}%`,"--mesh-y0":`${ot}%`}}})},[]),S=a.useMemo(()=>{const J=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],ge=t.cogita.introSlides,ee=new Map(ge.map(ke=>[ke.id,ke]));return J.map(ke=>{var le;const ue=ee.get(ke.id);return{...ke,...ue,title:(ue==null?void 0:ue.title)??"Cogita",cta:(ue==null?void 0:ue.cta)??((le=t.cogita.introSlides[0])==null?void 0:le.cta)??t.cogita.loginCta,secondary:ue==null?void 0:ue.secondary}})},[t.cogita.introSlides]),[_,x]=a.useState(0),[g,C]=a.useState(!0),[D,y]=a.useState(!1),U=S.length-1,N=a.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),ae=a.useCallback(()=>{N(),n()},[N,n]),z=a.useCallback(()=>{C(!0),x(0)},[]),P=a.useCallback(()=>{C(!1),x(U)},[U]),B=a.useCallback(J=>{x(Math.max(0,Math.min(U,J)))},[U]),Q=a.useCallback(()=>{_>=U?ae():B(_+1)},[_,B,ae,U]),xe=a.useCallback(()=>{B(_-1)},[_,B]);a.useEffect(()=>{var ee;const J=(ee=window.matchMedia)==null?void 0:ee.call(window,"(prefers-reduced-motion: reduce)");if(!J)return;const ge=()=>y(J.matches);return ge(),J.addEventListener?(J.addEventListener("change",ge),()=>J.removeEventListener("change",ge)):(J.addListener(ge),()=>J.removeListener(ge))},[]),a.useEffect(()=>{if(!g)return;const J=ge=>{const ee=ge.target;if(!ee)return;const ke=ee.tagName;if(!(ee.isContentEditable||ke==="INPUT"||ke==="TEXTAREA"||ke==="SELECT"||ke==="BUTTON"||ke==="A"||ee.closest('button, a, [role="button"], [role="link"]'))){if(ge.key==="Escape"){P();return}if(ge.key==="ArrowLeft"||ge.key==="ArrowUp"){xe();return}(ge.key==="ArrowRight"||ge.key==="ArrowDown"||ge.code==="Space"||ge.key===" ")&&(ge.preventDefault(),Q())}};return window.addEventListener("keydown",J),()=>window.removeEventListener("keydown",J)},[P,Q,xe,g]),a.useEffect(()=>{g&&_===U&&N()},[_,g,U,N]),a.useEffect(()=>{const J=c.current;if(!J)return;const ge=u.current.filter(Ce=>!!Ce);if(!ge.length)return;const ee=1,ke=.6,ue=.6,le=Math.max(1,Math.min(ee,window.devicePixelRatio||1));let Ie=0,Ae=0,Ke=ke,Re=0,Ze=0;const ot=Ce=>{let Be=Ce%2147483647;return Be<=0&&(Be+=2147483646),(Ye,$)=>{Be=Be*48271%2147483647;const L=Be/2147483647;return Ye+L*($-Ye)}},Te={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},We=Ce=>{const Be=Math.sin(Ce*12.9898)*43758.5453;return Be-Math.floor(Be)},ft=Ce=>{const Be=We(Ce+.1)||1e-4,Ye=We(Ce+.7)||1e-4;return Math.sqrt(-2*Math.log(Be))*Math.cos(2*Math.PI*Ye)},Ve=(Ce,Be)=>{const Ye=Math.floor(Ce),$=Ye+1,L=Ce-Ye,K=L*L*(3-2*L),R=We(Ye*12.9898+Be*78.233),k=We($*12.9898+Be*78.233);return R+(k-R)*K},ze=Ce=>{const Be=ot(Ce),Ye=Math.min(4,Math.max(4,Math.floor(Ie/1200*Te.filamentCount)));return Array.from({length:Ye},($,L)=>{const K=Math.max(-1,Math.min(1,ft(Ce+L*.37))),R=Math.min(1,Math.max(0,We(Ce+L*1.31))),k=Math.min(Te.depthLayers-1,Math.floor(R*Te.depthLayers));return{seed:Be(0,Math.PI*2)+Ce*.01,offset:K,freqA:Te.freq1*(.75+Be(0,.5)),freqB:Te.freq2*(.75+Be(0,.5)),ampA:Te.amp1*(.6+Be(0,.7)),ampB:Te.amp2*(.6+Be(0,.7)),width:2+L%5*.32,depth:R,layer:k}})},et=(Ce,Be,Ye)=>{const $=Math.max(30,Math.floor(Ie*Ae/14e4));Ce.save(),Ce.globalAlpha=.6;for(let L=0;L<$;L+=1){const K=We(L*9.1+Ie*.11)*Be+Ye,R=We(L*3.7+Ae*.23)*Ae,k=1.2+We(L*5.9)*2.4,T=Ce.createRadialGradient(K,R,0,K,R,k*2);T.addColorStop(0,"rgba(10, 30, 60, 0.45)"),T.addColorStop(1,"rgba(10, 30, 60, 0)"),Ce.fillStyle=T,Ce.beginPath(),Ce.arc(K,R,k*2,0,Math.PI*2),Ce.fill()}Ce.restore()},it=(Ce,Be)=>{Ce.clearRect(0,0,Ie,Ae);const Ye=Ae*Te.waveCenter,$=Te.waveBandPx,L=Te.segments,K=Te.colors.filaments,R=Re||Ie,k=0;et(Ce,R,k),Ce.strokeStyle=K,Ce.lineCap="round",Ce.lineJoin="round";for(let T=0;T<Be.length;T+=1){const M=Be[T],oe=M.offset*$*(.85+We(M.seed)*.4),fe=1-Math.min(1,Math.abs(oe)/$),de=Math.exp(-Math.pow(oe/Te.crestThickness,2)),Y=M.layer===0?1.1:M.layer===1?.85:.6,E=.35+(1-M.depth)*.65,W=fe*E*Y*(.34+de*.45);Ce.globalAlpha=W,Ce.lineWidth=M.width*(1+(1-M.depth)*.8);const te=[];for(let X=0;X<=L;X+=1){const be=X/L*R+k,O=(Ve(be*.012,M.seed)-.5)*Te.xJitter,ne=be+O,Le=(Ve(ne*M.freqA,M.seed)-.5)*Te.jitterA,qe=(Ve(ne*M.freqB,M.seed*1.7)-.5)*Te.jitterB,De=Ye+Math.sin(ne*M.freqA+M.seed)*M.ampA+Math.sin(ne*M.freqB+M.seed*1.3)*M.ampB+oe+Le+qe;te.push({x:ne,y:De})}Ce.beginPath(),Ce.moveTo(te[0].x,te[0].y);for(let X=1;X<te.length-1;X+=1){const be=(te[X].x+te[X+1].x)/2,O=(te[X].y+te[X+1].y)/2;Ce.quadraticCurveTo(te[X].x,te[X].y,be,O)}const H=te[te.length-1];Ce.quadraticCurveTo(H.x,H.y,H.x,H.y),Ce.stroke()}Ce.save(),Ce.globalCompositeOperation="lighter",Ce.strokeStyle=Te.colors.glow,Ce.lineCap="round",Ce.lineJoin="round";for(let T=0;T<Be.length;T+=1){const M=Be[T];if(Math.abs(M.offset)*$>Te.crestThickness)continue;const oe=Te.glowAlpha*(.7+(1-M.depth)*.6);Ce.globalAlpha=oe,Ce.lineWidth=1.6+(1-M.depth)*1.2;const fe=[];for(let Y=0;Y<=L;Y+=1){const E=Y/L*R+k,W=Math.sin(E*.02+M.seed)*3,te=Ye+Math.sin(E*M.freqA+M.seed)*M.ampA+Math.sin(E*M.freqB+M.seed*1.3)*M.ampB+M.offset*$*.35+W;fe.push({x:E,y:te})}Ce.beginPath(),Ce.moveTo(fe[0].x,fe[0].y);for(let Y=1;Y<fe.length-1;Y+=1){const E=(fe[Y].x+fe[Y+1].x)/2,W=(fe[Y].y+fe[Y+1].y)/2;Ce.quadraticCurveTo(fe[Y].x,fe[Y].y,E,W)}const de=fe[fe.length-1];Ce.quadraticCurveTo(de.x,de.y,de.x,de.y),Ce.stroke()}Ce.restore()},Ge=()=>{Ie=Math.floor(J.clientWidth),Ae=Math.floor(J.clientHeight),Re=Math.floor(Ie*1.8),Ze=Ae,Ke=Ie<820?ue:ke,ge.forEach(Ce=>{const Be=Ce.getContext("2d");if(!Be)return;Ce.width=Math.floor(Re*le*Ke),Ce.height=Math.floor(Ze*le*Ke),Ce.style.width=`${Re}px`,Ce.style.height=`${Ze}px`,Ce.style.left=`${-(Re-Ie)/2}px`,Be.setTransform(le*Ke,0,0,le*Ke,0,0);const Ye=Number(Ce.dataset.seed||1),$=ze(Ye);it(Be,$)})};return Ge(),window.addEventListener("resize",Ge,{passive:!0}),()=>window.removeEventListener("resize",Ge)},[m]);const Ee=S[Math.min(_,S.length-1)],re=g?Ee:S[S.length-1],A=(re==null?void 0:re.theme)??S[0].theme,ye={"--cogita-bg0":A.bg0,"--cogita-bg1":A.bg1,"--cogita-bg2":A.bg2,"--cogita-bloom":A.bloom,"--cogita-sat":A.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:p,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(_s,{value:j,onChange:i}),e.jsx(zs,{copy:t,label:r,isAuthenticated:s,secureMode:w,onLogin:n,onProfileNavigate:o,onToggleSecureMode:h,onLogout:d,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:c,className:"cogita-section cogita-home",style:ye,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[m.map((J,ge)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:J.style,"data-seed":J.seed,ref:ee=>{u.current[ge]=ee}},J.id)),v.map(J=>e.jsx("div",{className:"cogita-home-wave",style:J.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},J.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(Hr,{slides:S,activeIndex:_,introOpen:g,prefersReducedMotion:D,onNext:Q,onPrev:xe,onSelect:B,onExit:P,onOpen:z,onRegister:ae})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const To=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:Gr},Symbol.toStringTag,{value:"Module"})),Qs=a.createContext(!1);function At({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,headerExtra:i,children:p}){if(a.useContext(Qs))return e.jsx(e.Fragment,{children:p});const u=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}w("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:u,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(_s,{value:f,onChange:j}),e.jsxs("div",{className:"cogita-header-right",children:[i,e.jsx(zs,{copy:t,label:n,isAuthenticated:r,secureMode:d,onLogin:()=>w("home"),onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:p}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function ga(t){const[n,r]=a.useState("Cogita library"),[s,o]=a.useState(null);return a.useEffect(()=>{let h=!1;return Bs().then(d=>{if(h)return;const w=d.find(f=>f.libraryId===t);w&&r(w.name)}).catch(()=>{h||r("Cogita library")}),()=>{h=!0}},[t]),a.useEffect(()=>{let h=!1;return dr(t).then(d=>{h||o(d)}).catch(()=>{h||o(null)}),()=>{h=!0}},[t]),{libraryName:n,stats:s}}function us({slices:t}){const n=t.reduce((s,o)=>s+Math.max(0,o.value),0),r=a.useMemo(()=>{if(n<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let s=0;return`conic-gradient(${t.map(h=>{const w=Math.max(0,h.value)/n*360,f=s,j=s+w;return s=j,`${h.color} ${f}deg ${j}deg`}).join(",")})`},[t,n]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:r}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(s=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:s.color}}),e.jsx("strong",{children:s.value}),e.jsx("small",{children:s.label})]},s.label))})]})}function Yr({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,libraryId:i}){const{libraryName:p,stats:c}=ga(i),[u,v]=a.useState("infos"),[m,S]=a.useState(0),[_,x]=a.useState(0),[g,C]=a.useState(0),D=(c==null?void 0:c.totalInfos)??0,y=(c==null?void 0:c.totalCollections)??0,U=0,N=0,ae=0,z=Math.max(0,D-ae-_),P=Math.max(0,D-_-g);a.useEffect(()=>{let Q=!1;return(async()=>{try{const Ee=await Ba({libraryId:i,limit:200}),re=await Promise.all(Ee.items.map(A=>Wn({libraryId:i,collectionId:A.collectionId}).catch(()=>[])));if(Q)return;S(re.reduce((A,ye)=>A+ye.length,0))}catch{Q||S(0)}})(),()=>{Q=!0}},[i]),a.useEffect(()=>{let Q=!1;return(async()=>{try{const[Ee,re,A]=await Promise.all([is({libraryId:i,type:"computed",limit:1}).catch(()=>({total:0})),is({libraryId:i,type:"source",limit:1}).catch(()=>({total:0})),Qn({libraryId:i}).catch(()=>({items:[]}))]);if(Q)return;x((Ee.total??0)+(re.total??0));const ye=new Set(A.items.filter(J=>J.childItemType.toLowerCase()==="info").map(J=>J.childItemId).filter(Boolean));C(ye.size)}catch{Q||(x(0),C(0))}})(),()=>{Q=!0}},[i]);const B=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:D},{key:"collections",label:t.cogita.library.overview.stats.collections,value:y},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:m},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:U},{key:"texts",label:t.cogita.library.overview.stats.texts,value:N}];return e.jsx(At,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:p})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:B.map(Q=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${u===Q.key?"active":""}`,onClick:()=>v(Q.key),children:[e.jsx("span",{children:Q.label}),e.jsx("strong",{children:Q.value})]},Q.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),u==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(us,{slices:[{label:t.cogita.library.overview.known,value:ae,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:z,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:_,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(us,{slices:[{label:t.cogita.library.overview.availableChecks,value:g,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:P,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const nt=(t,n)=>{const r=t.cogita.library.infoTypes,s=t.cogita.library.connectionTypes,o=t.cogita.library.groupTypes;return{any:r.any,vocab:r.vocab,book:o.book,citation:o.citation,language:r.language,word:r.word,sentence:r.sentence,topic:r.topic,collection:r.collection,person:r.person,institution:r.institution,collective:r.collective,orcid:r.orcid,address:r.address,email:r.email,phone:r.phone,media:r.media,work:r.work,geo:r.geo,music_piece:r.musicPiece,music_fragment:r.musicFragment,source:r.source,question:r.question,computed:r.computed,"word-language":s.wordLanguage,"citation-language":s.citationLanguage,"language-sentence":s.languageSentence,translation:s.translation,"word-topic":s.wordTopic,reference:s.reference,"source-resource":s.sourceResource,"work-contributor":s.workContributor,"work-medium":s.workMedium,"orcid-link":s.orcidLink}[n]??String(n)},Xr=t=>[{value:"any",label:nt(t,"any")},{value:"language",label:nt(t,"language")},{value:"word",label:nt(t,"word")},{value:"sentence",label:nt(t,"sentence")},{value:"topic",label:nt(t,"topic")},{value:"collection",label:nt(t,"collection")},{value:"person",label:nt(t,"person")},{value:"institution",label:nt(t,"institution")},{value:"collective",label:nt(t,"collective")},{value:"orcid",label:nt(t,"orcid")},{value:"address",label:nt(t,"address")},{value:"email",label:nt(t,"email")},{value:"phone",label:nt(t,"phone")},{value:"media",label:nt(t,"media")},{value:"work",label:nt(t,"work")},{value:"geo",label:nt(t,"geo")},{value:"music_piece",label:nt(t,"music_piece")},{value:"music_fragment",label:nt(t,"music_fragment")},{value:"source",label:nt(t,"source")},{value:"question",label:nt(t,"question")},{value:"citation",label:nt(t,"citation")},{value:"computed",label:nt(t,"computed")},{value:"vocab",label:nt(t,"vocab")},{value:"book",label:nt(t,"book")},{value:"word-language",label:nt(t,"word-language")},{value:"citation-language",label:nt(t,"citation-language")},{value:"language-sentence",label:nt(t,"language-sentence")},{value:"translation",label:nt(t,"translation")},{value:"word-topic",label:nt(t,"word-topic")},{value:"reference",label:nt(t,"reference")},{value:"source-resource",label:nt(t,"source-resource")},{value:"work-contributor",label:nt(t,"work-contributor")},{value:"work-medium",label:nt(t,"work-medium")},{value:"orcid-link",label:nt(t,"orcid-link")}],Zr=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Cn={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},ei={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Cn]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Cn]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId"]},filterFields:[Cn,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text"],connections:[{relationType:"citation-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"citationText",kind:"text",path:"text",matcher:"contains"}]},question:{infoType:"question",entityKind:"single",structure:{payloadFields:["definition"]},filterFields:[{key:"questionType",labelKey:"type",kind:"text",path:"definition.type",matcher:"contains"},{key:"questionText",labelKey:"text",kind:"text",path:"definition.question",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},hs={infoType:"default",entityKind:"single",structure:{payloadFields:["label"]},filterFields:[]};function ti(t){return t?ei[t]??hs:hs}function ai(t,n){return t.optionsSource==="languages"?n.languages.map(r=>({value:r.infoId,label:r.label})):t.optionsSource==="sourceKinds"?Zr:[]}const ni="cogita.revision.seed:";function Gs(t){return`${ni}${t}`}function si(t,n){if(typeof window>"u")return null;const r=Array.from(new Set(n.map(h=>h.trim()).filter(Boolean)));if(!r.length)return null;const s=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,o={kind:"info-selection",libraryId:t,infoIds:r,createdAt:new Date().toISOString()};return window.localStorage.setItem(Gs(s),JSON.stringify(o)),s}function gs(t,n){if(typeof window>"u")return null;const r=window.localStorage.getItem(Gs(n));if(!r)return null;try{const s=JSON.parse(r);if(s.kind!=="info-selection"||s.libraryId!==t||!Array.isArray(s.infoIds))return null;const o=s.infoIds.map(h=>String(h??"").trim()).filter(Boolean);return o.length?{infoIds:o}:null}catch{return null}}const ri="cogita.collection-draft:";function Ys(t){return`${ri}${t}`}function ii(t,n){if(typeof window>"u")return null;const r=Array.from(new Set(n.map(h=>h.trim()).filter(Boolean)));if(!r.length)return null;const s=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,o={kind:"info-selection",libraryId:t,infoIds:r,createdAt:new Date().toISOString()};return window.localStorage.setItem(Ys(s),JSON.stringify(o)),s}function oi(t,n){if(typeof window>"u")return null;const r=window.localStorage.getItem(Ys(n));if(!r)return null;try{const s=JSON.parse(r);if(s.kind!=="info-selection"||s.libraryId!==t||!Array.isArray(s.infoIds))return null;const o=s.infoIds.map(h=>String(h??"").trim()).filter(Boolean);return o.length?{infoIds:o}:null}catch{return null}}const In=60,li=500;function Xs(t){return`cogita.info-selection:${t}`}function ms(t){if(typeof window>"u")return{};const n=window.localStorage.getItem(Xs(t));if(!n)return{};try{const r=JSON.parse(n);return!r||typeof r!="object"?{}:r}catch{return{}}}function ci({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,libraryId:i,mode:p}){var Bt;const c=hn(),u=qa(),v=t.cogita.library.list,[m,S]=a.useState("any"),[_,x]=a.useState(""),[g,C]=a.useState("relevance"),[D,y]=a.useState("details"),[U,N]=a.useState(!1),[ae,z]=a.useState("idle"),[P,B]=a.useState([]),[Q,xe]=a.useState(In),[Ee,re]=a.useState(null),[A,ye]=a.useState(()=>ms(i)),[J,ge]=a.useState({}),[ee,ke]=a.useState([]),[ue,le]=a.useState([]),[Ie,Ae]=a.useState(null),[Ke,Re]=a.useState(null),[Ze,ot]=a.useState(null),[Te,We]=a.useState("idle"),[ft,Ve]=a.useState([]),[ze,et]=a.useState(""),[it,Ge]=a.useState(null),[Ce,Be]=a.useState("idle"),[Ye,$]=a.useState(null),[L,K]=a.useState(null),[R,k]=a.useState("idle"),[T,M]=a.useState([]),[oe,fe]=a.useState("idle"),de=a.useMemo(()=>Xr(t),[t]),Y=a.useMemo(()=>[{value:"relevance",label:v.sortRelevance},{value:"label_asc",label:v.sortLabelAsc},{value:"label_desc",label:v.sortLabelDesc},{value:"type_asc",label:v.sortTypeAsc},{value:"type_desc",label:v.sortTypeDesc}],[v.sortLabelAsc,v.sortLabelDesc,v.sortRelevance,v.sortTypeAsc,v.sortTypeDesc]);a.useEffect(()=>{ye(ms(i)),ge({}),N(!1)},[i]),a.useEffect(()=>{Qn({libraryId:i}).then(l=>ot(l)).catch(()=>ot({items:[]}))},[i]),a.useEffect(()=>{ur({libraryId:i}).then(l=>Ve(l)).catch(()=>Ve([]))},[i]),a.useEffect(()=>{Tn({libraryId:i,type:"language",filters:{sourceKind:"info"},limit:200}).then(l=>{const q=l.map(pe=>({infoId:pe.infoId??"",infoType:pe.entityType,label:pe.title})).filter(pe=>pe.infoId.length>0);ke(q)}).catch(()=>ke([]))},[i]),a.useEffect(()=>{Tn({libraryId:i,type:"source",filters:{sourceKind:"info"},limit:200}).then(l=>{const q=l.map(pe=>({infoId:pe.infoId??"",infoType:pe.entityType,label:pe.title})).filter(pe=>pe.infoId.length>0);le(q)}).catch(()=>le([]))},[i]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(Xs(i),JSON.stringify(A))},[i,A]);const E=a.useMemo(()=>ti(m==="any"?null:m),[m]),W=a.useMemo(()=>new URLSearchParams(u.search),[u.search]),te=a.useMemo(()=>u.pathname.split("/").filter(Boolean),[u.pathname]),H=te.findIndex(l=>l==="infos"),X=H>=0&&(te[H+1]??"").trim()||null,be=H>=0?(te[H+2]??"").trim():"",O=H>=0?be==="checkcards"?"cards":be==="collections"?"collections":"overview":"",ne=X??((W.get("infoId")??"").trim()||null),Le=X?O:(W.get("infoView")??"overview").trim(),qe=Le==="overview"&&!!ne,De=Le==="collections"&&!!ne,Je=a.useMemo(()=>({language:v.typeFilterLanguage,languageA:v.typeFilterLanguageA,languageB:v.typeFilterLanguageB,originalLanguage:v.typeFilterOriginalLanguage,doi:v.typeFilterDoi,sourceKind:v.typeFilterSourceKind,locator:v.typeFilterLocator,citationText:v.typeFilterCitationText}),[v.typeFilterDoi,v.typeFilterLanguage,v.typeFilterLanguageA,v.typeFilterLanguageB,v.typeFilterLocator,v.typeFilterOriginalLanguage,v.typeFilterCitationText,v.typeFilterSourceKind]),pt=a.useMemo(()=>E.filterFields.map(l=>({...l,label:l.labelKey?Je[l.labelKey]:l.label??l.key,options:ai(l,{languages:ee})})),[Je,ee,E.filterFields]),ht=a.useMemo(()=>pt.some(l=>(J[l.key]??"").trim().length>0),[pt,J]);a.useEffect(()=>{ge({})},[m]),a.useEffect(()=>{const l={sourceKind:"info"};if(ht)for(const G of pt){const tt=(J[G.key]??"").trim();tt&&(l[G.path??G.key]=tt)}const q=(J.__referenceId??"").trim();q&&(l["link.references"]=q),z("loading");const pe=window.setTimeout(()=>{Tn({libraryId:i,type:m==="any"?void 0:m,query:_.trim()||void 0,filters:l,limit:li}).then(G=>{const tt=G.map(lt=>({infoId:lt.infoId??"",infoType:lt.entityType,label:lt.title})).filter(lt=>lt.infoId.length>0);B(tt),z("ready")}).catch(()=>{B([]),z("ready")})},240);return()=>window.clearTimeout(pe)},[ht,i,_,m,pt,J]),a.useEffect(()=>{if(!ne||Le!=="overview"&&Le!=="collections"){Ae(null),Re(null),We("idle");return}let l=!1;return We("loading"),Promise.all([na({libraryId:i,infoId:ne}),hr({libraryId:i,itemType:"info",itemId:ne}).catch(()=>null)]).then(([q,pe])=>{l||(Ae(q),Re(pe),We("ready"))}).catch(()=>{l||(Ae(null),Re(null),We("error"))}),()=>{l=!0}},[i,ne,Le]),a.useEffect(()=>{if(!ne||Le!=="collections"){M([]),fe("idle");return}let l=!1;return fe("loading"),gr({libraryId:i,infoId:ne}).then(q=>{l||(M(q),fe("ready"))}).catch(()=>{l||(M([]),fe("error"))}),()=>{l=!0}},[i,ne,Le]),a.useEffect(()=>{if(!ne||Le!=="overview"){$(null),K(null),k("idle");return}let l=!1;return k("loading"),Promise.all([Za({libraryId:i,infoId:ne}),en({libraryId:i,infoId:ne})]).then(([q,pe])=>{l||($(q),K(pe),k("ready"))}).catch(()=>{l||($(null),K(null),k("error"))}),()=>{l=!0}},[i,ne,Le]);const gt=a.useMemo(()=>Ie?ft.filter(l=>l.sourceInfoTypes.some(q=>q.toLowerCase()===Ie.infoType.toLowerCase())):[],[ft,Ie]);a.useEffect(()=>{if(!Ie){et("");return}et(l=>{var q;return l&&gt.some(pe=>pe.approachKey===l)?l:((q=gt[0])==null?void 0:q.approachKey)??""})},[gt,Ie]),a.useEffect(()=>{if(!Ie||!ze){Ge(null),Be("idle");return}let l=!1;return Be("loading"),Os({libraryId:i,infoId:Ie.infoId,approachKey:ze}).then(q=>{l||(Ge(q),Be("ready"))}).catch(()=>{l||(Ge(null),Be("error"))}),()=>{l=!0}},[i,ze,Ie]);const yt=a.useMemo(()=>{const l=P.slice(),q=pe=>nt(t,pe);return g==="relevance"?l:g==="label_asc"?l.sort((pe,G)=>pe.label.localeCompare(G.label)):g==="label_desc"?l.sort((pe,G)=>G.label.localeCompare(pe.label)):g==="type_asc"?l.sort((pe,G)=>pe.infoType===G.infoType?pe.label.localeCompare(G.label):q(pe.infoType).localeCompare(q(G.infoType))):l.sort((pe,G)=>pe.infoType===G.infoType?pe.label.localeCompare(G.label):q(G.infoType).localeCompare(q(pe.infoType)))},[t,P,g]),Ct=a.useMemo(()=>yt.slice(0,Q),[yt,Q]),zt=Ct.length<yt.length,Rt=a.useMemo(()=>new Set(Object.keys(A)),[A]),kt=a.useMemo(()=>Object.values(A),[A]),pa=a.useMemo(()=>{const l=new Map;for(const q of kt)l.set(q.infoType,(l.get(q.infoType)??0)+1);return Array.from(l.entries()).sort((q,pe)=>pe[1]-q[1]||q[0].localeCompare(pe[0]))},[kt]),Mt=a.useMemo(()=>{if(!ne||!Ze)return 0;const l=new Set;for(const q of Ze.items)q.childItemType!=="info"||q.childItemId!==ne||l.add([q.parentItemType,q.parentItemId,q.parentCheckType??"",q.parentDirection??""].join("|"));return l.size},[Ze,ne]);a.useEffect(()=>{xe(In);const l=new Set(P.map(q=>q.infoId));re(q=>q&&l.has(q)?q:null)},[P]);const xt=l=>{ye(q=>({...q,[l.infoId]:{infoId:l.infoId,infoType:l.infoType,label:l.label}}))},Nt=l=>{ye(q=>{if(!q[l])return q;const pe={...q};return delete pe[l],pe})},vt=(l,q)=>{if(q){xt(l);return}Nt(l.infoId)},bt=l=>{c(`/cogita/library/${i}/infos/${encodeURIComponent(l)}`,{replace:!0})},Et=()=>{c(`/cogita/library/${i}/list`,{replace:!0})},st=()=>{ne&&c(`/cogita/library/${i}/edit/${encodeURIComponent(ne)}`,{replace:!0})},Ue=()=>{const l=si(i,kt.map(q=>q.infoId));l&&c(`/cogita/library/${i}/revision/run?libraryTarget=revisions&scope=info-selection&seed=${encodeURIComponent(l)}`)},mt=()=>{const l=ii(i,kt.map(q=>q.infoId));l&&c(`/cogita/library/${i}/collections/new?draft=${encodeURIComponent(l)}&draftType=info-selection`)},Ht=kt.length===1?((Bt=kt[0])==null?void 0:Bt.infoId)??null:null,Kt=v.selectionCount.replace("{count}",String(kt.length)),Dt=p==="collection"?"grid":p==="detail"?"wide":D,ce=ui(f),Zt=Ke?Math.max(0,Math.min(100,Math.round((Ke.score??0)*100))):0,sa=Ke?hi(Ke,ce):ce.noKnownnessData;return e.jsx(At,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":Dt,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[qe?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:ce.kicker}),e.jsx("h2",{className:"cogita-card-title",children:Ie?ps(Ie.payload,Ie.infoType,Ie.infoId):ce.loading}),Ie?e.jsxs("p",{className:"cogita-card-subtitle",children:[nt(t,Ie.infoType)," · ",Ie.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:Et,children:ce.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:st,disabled:!ne||Te!=="ready",children:v.editInfo})]})]}),Te==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:ce.loading})}):Te==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:ce.loadError})}):Ie?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:ce.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[Zt,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${Zt}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:sa})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:ce.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(Ke==null?void 0:Ke.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:ce.correct.replace("{correct}",String((Ke==null?void 0:Ke.correctReviews)??0)).replace("{total}",String((Ke==null?void 0:Ke.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:Ke!=null&&Ke.lastReviewedUtc?`${ce.lastReview}: ${di(Ke.lastReviewedUtc,f)}`:ce.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:ce.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:Mt}),e.jsx("p",{className:"cogita-library-hint",children:ce.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:ce.checkcards}),R==="loading"?e.jsx("p",{className:"cogita-library-hint",children:ce.loadingCheckcards}):R==="error"?e.jsx("p",{className:"cogita-library-hint",children:ce.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:ce.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(Ye==null?void 0:Ye.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:ce.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(L==null?void 0:L.items.length)??0})]})]})]}),gt.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:ce.approach}),e.jsx("select",{value:ze,onChange:l=>et(l.target.value),"aria-label":ce.approach,children:gt.map(l=>e.jsx("option",{value:l.approachKey,children:l.label},l.approachKey))})]}),Ce==="loading"?e.jsx("p",{className:"cogita-library-hint",children:ce.loadingApproach}):Ce==="error"?e.jsx("p",{className:"cogita-library-hint",children:ce.loadApproachError}):it?e.jsx(tn,{value:it.projection,emptyLabel:ce.empty}):e.jsx("p",{className:"cogita-library-hint",children:ce.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:ce.payload}),e.jsx(tn,{value:Ie.payload,emptyLabel:ce.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:ce.links}),e.jsx(gi,{links:Ie.links,emptyLabel:ce.noLinks})]})]})]}):null]})}):null,De?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Informacja"}),e.jsx("h2",{className:"cogita-card-title",children:Ie?ps(Ie.payload,Ie.infoType,Ie.infoId):ne??""}),e.jsx("p",{className:"cogita-card-subtitle",children:"Collections using this info"})]}),e.jsx("div",{className:"cogita-info-overview-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:Et,children:"Back to search"})})]}),oe==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading collections..."})}):null,oe==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load collections."})}):null,oe==="ready"&&T.length===0?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"This info is not used in any collection yet."})}):null,oe==="ready"&&T.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:T.map(l=>e.jsx("article",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`/#/cogita/library/${i}/collections/${l.collectionId}?libraryTarget=collections`,children:[e.jsx("div",{className:"cogita-card-type",children:"Collection"}),e.jsx("h3",{className:"cogita-card-title",children:l.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[l.itemCount," items"]})]})},l.collectionId))}):null]})}):null,!qe&&!De?e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":v.typeLabel,value:m,onChange:l=>S(l.target.value),children:de.map(l=>e.jsx("option",{value:l.value,children:l.label},l.value))}),e.jsx("input",{type:"text",value:_,onChange:l=>x(l.target.value),placeholder:v.searchPlaceholder}),e.jsx("select",{"aria-label":v.sortLabel,value:g,onChange:l=>C(l.target.value),children:Y.map(l=>e.jsx("option",{value:l.value,children:l.label},l.value))}),e.jsxs("select",{"aria-label":v.viewLabel,value:D,onChange:l=>y(l.target.value),children:[e.jsx("option",{value:"details",children:v.viewDetails}),e.jsx("option",{value:"wide",children:v.viewWide}),e.jsx("option",{value:"grid",children:v.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:v.cardCount.replace("{shown}",String(Ct.length)).replace("{total}",String(yt.length))}),e.jsx("span",{children:ae==="loading"?v.loading:v.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>N(l=>!l),children:U?v.hideFilters:v.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:v.filtersOptionalHint})]}),U?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsxs("div",{className:"cogita-filter-grid",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:v.typeLabel}),e.jsx("select",{value:m,onChange:l=>S(l.target.value),children:de.map(l=>e.jsx("option",{value:l.value,children:l.label},`advanced-type:${l.value}`))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Reference"}),e.jsxs("select",{value:J.__referenceId??"",onChange:l=>ge(q=>({...q,__referenceId:l.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),ue.map(l=>e.jsx("option",{value:l.infoId,children:l.label},`reference:${l.infoId}`))]})]}),pt.map(l=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:l.label}),l.kind==="select"?e.jsxs("select",{value:J[l.key]??"",onChange:q=>ge(pe=>({...pe,[l.key]:q.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(l.options??[]).map(q=>e.jsx("option",{value:q.value,children:q.label},`${l.key}:${q.value}`))]}):e.jsx("input",{type:"text",value:J[l.key]??"",onChange:q=>ge(pe=>({...pe,[l.key]:q.target.value}))})]},`type-filter:${l.key}`))]})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:Kt}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{ye(l=>{const q={...l};for(const pe of Ct)q[pe.infoId]={infoId:pe.infoId,infoType:pe.infoType,label:pe.label};return q})},disabled:Ct.length===0,children:v.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>ye({}),disabled:kt.length===0,children:v.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ht&&bt(Ht),disabled:!Ht,title:Ht?void 0:v.openSelectedDisabled,children:v.openSelected})]})]}),Dt==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":v.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:v.detailColumnName}),e.jsx("span",{children:v.detailColumnType}),e.jsx("span",{children:v.detailColumnId}),e.jsx("span",{})]}),Ct.length?Ct.map(l=>{const q=nt(t,l.infoType),pe=Rt.has(l.infoId),G=Ee===l.infoId;return e.jsxs("div",{className:`cogita-details-row ${G||pe?"active":""}`,role:"row",onClick:()=>re(l.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:pe,onChange:tt=>vt(l,tt.target.checked),onClick:tt=>tt.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:l.label,children:l.label}),e.jsx("span",{title:q,children:q}),e.jsx("span",{title:l.infoId,children:l.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:tt=>{tt.stopPropagation(),bt(l.infoId)},"aria-label":v.editInfo,children:">"})]},l.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:v.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${Dt}`,"data-view":Dt,children:Ct.length?Ct.map(l=>{const q=nt(t,l.infoType),pe=Rt.has(l.infoId),G=Ee===l.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":G||pe,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:pe,onChange:tt=>vt(l,tt.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>re(l.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:q}),e.jsx("h3",{className:"cogita-card-title",children:l.label}),e.jsx("p",{className:"cogita-card-subtitle",children:l.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>bt(l.infoId),children:v.editInfo})]})},l.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:v.noMatch})})}),zt?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>xe(l=>l+In),children:v.loadMore})}):null,kt.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:v.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:v.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:pa.map(([l,q])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:nt(t,l)}),e.jsx("span",{className:"cogita-tag-count",children:q})]},`stack:type:${l}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:Ue,disabled:kt.length===0,children:"Start revision"}),e.jsx("button",{type:"button",className:"ghost",onClick:mt,disabled:kt.length===0,children:"Create collection from selection"})]})]}):null]}):null]})})})})}function ps(t,n,r){if(t&&typeof t=="object"&&!Array.isArray(t)){const s=t,o=["title","name","label","value","text","quote","term"];for(const h of o){const d=s[h];if(typeof d=="string"&&d.trim())return d.trim()}}return`${n} · ${r}`}function di(t,n){try{const r=n==="pl"?"pl-PL":n==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(r,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function ui(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function hi(t,n){return t.totalReviews<=0?n.noKnownnessData:t.totalReviews<3||t.score<.35?n.developmentStart:t.totalReviews<8||t.score<.65?n.developmentGrowing:t.score<.85?n.developmentStable:n.developmentStrong}function gi({links:t,emptyLabel:n}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([r,s])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(s)?s.length?e.jsx("div",{className:"cogita-selection-overview",children:s.map(o=>e.jsx("span",{className:"cogita-tag-chip",children:o},`${r}:${o}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):s?e.jsx("span",{className:"cogita-tag-chip",children:s}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},r))})}function tn({value:t,emptyLabel:n}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:n});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((r,s)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(tn,{value:r,emptyLabel:n})})]},s))});if(typeof t=="object"){const r=Object.entries(t);return r.length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:r.map(([s,o])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(tn,{value:o,emptyLabel:n})})]},s))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const Na=5,fs=50,bs=2,ys=[];function Gt({libraryId:t,infoType:n,label:r,placeholder:s,value:o,onChange:h,values:d,onChangeMultiple:w,helperText:f,searchFailedText:j,createFailedText:i,createLabel:p,savingLabel:c,loadMoreLabel:u,allowCreate:v=!0,inputRef:m,autoAdvance:S,onCommit:_,multiple:x}){const g=x?d??ys:ys,[C,D]=a.useState(x?"":(o==null?void 0:o.label)??""),[y,U]=a.useState([]),[N,ae]=a.useState(Na),[z,P]=a.useState(-1),[B,Q]=a.useState(!1),[xe,Ee]=a.useState(!1),[re,A]=a.useState(null),ye=a.useRef(0),J=a.useRef(new Map),ge=a.useMemo(()=>v?x?C.trim().length>0:C.trim().length>0&&!o:!1,[v,C,o,x]);a.useEffect(()=>{x||D((o==null?void 0:o.label)??"")},[o,x]),a.useEffect(()=>{const ue=C.trim();if(!ue||ue.length<bs){U([]),Q(!1),ae(Na),P(-1),Ee(!1),A(null);return}const le=ue.toLowerCase(),Ie=`${t}:${n}:${le}`,Ae=J.current.get(Ie);if(Ae){if(x&&g.length>0){const Re=new Set(g.map(Ze=>Ze.id));U(Ae.filter(Ze=>!Re.has(Ze.id)))}else U(Ae);ae(Na),P(-1),Q(Ae.length>0),Ee(!1),A(null);return}const Ke=window.setTimeout(async()=>{const Re=Date.now();ye.current=Re,Ee(!0),A(null);try{const Ze=await Gn({libraryId:t,type:n,query:ue,limit:fs});if(ye.current!==Re)return;const ot=Ze.slice(0,fs).map(Te=>({id:Te.infoId,label:Te.label,infoType:Te.infoType}));if(J.current.set(Ie,ot),x&&g.length>0){const Te=new Set(g.map(We=>We.id));U(ot.filter(We=>!Te.has(We.id)))}else U(ot);ae(Na),P(-1),Q(!0)}catch{if(ye.current!==Re)return;A(j??"Search failed.")}finally{ye.current===Re&&Ee(!1)}},250);return()=>window.clearTimeout(Ke)},[t,n,C,g]);const ee=ue=>{if(x){const le=g.some(Ie=>Ie.id===ue.id)?g:[...g,ue];w==null||w(le),D(""),Q(!1),P(-1);return}h==null||h(ue),D(ue.label),Q(!1),P(-1),S&&(_==null||_())},ke=async()=>{const ue=C.trim();if(ue){Ee(!0),A(null);try{const le=await On({libraryId:t,infoType:n,payload:{label:ue}}),Ie={id:le.infoId,label:ue,infoType:le.infoType};if(ue.length>=bs){const Ae=`${t}:${n}:${ue.toLowerCase()}`,Ke=J.current.get(Ae)??[];J.current.set(Ae,[Ie,...Ke])}if(x){w==null||w([...g,Ie]),D(""),Q(!1),P(-1);return}h==null||h(Ie),Q(!1),P(-1),S&&(_==null||_())}catch{A(i??"Create failed.")}finally{Ee(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:r}),e.jsx("input",{value:C,placeholder:s,onChange:ue=>{D(ue.target.value),!x&&o&&(h==null||h(null))},onKeyDown:ue=>{if(ue.key==="ArrowDown"){if(ue.preventDefault(),!y.length)return;Q(!0),P(le=>{const Ie=Math.min(y.length,N)-1,Ae=le<0?0:Math.min(le+1,Ie);return Ae===Ie&&y.length>N?(ae(Ke=>Math.min(Ke+Na,y.length)),Math.min(le+1,Math.min(y.length,N+Na)-1)):Ae});return}if(ue.key==="ArrowUp"){if(ue.preventDefault(),!y.length)return;Q(!0),P(le=>le<=0?0:le-1);return}if(ue.key==="Enter"){if(ue.preventDefault(),z>=0&&y[z]){ee(y[z]);return}if(ge){ke();return}}},onFocus:()=>{y.length>0&&Q(!0)},autoComplete:"off",ref:m})]}),x&&g.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:g.map(ue=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>w==null?void 0:w(g.filter(le=>le.id!==ue.id)),children:[ue.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},ue.id))}),f&&e.jsx("p",{className:"cogita-help",children:f}),re&&e.jsx("p",{className:"cogita-error",children:re}),B&&y.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[y.slice(0,N).map((ue,le)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":le===z,onClick:()=>ee(ue),children:[e.jsx("strong",{children:ue.label}),e.jsx("span",{children:ue.infoType})]},ue.id)),N<y.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>ae(ue=>Math.min(ue+Na,y.length)),children:u??"Load more"})]}),ge&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:ke,disabled:xe,children:xe?c??"Saving...":p??`Create new ${n}`})]})}const xs=[{id:"gen",la:{abbr:"Gen",name:"Genesis"},en:{abbr:"Gen",name:"Genesis"},de:{abbr:"Gen",name:"Genesis"},pl:{abbr:"Rdz",name:"Księga Rodzaju"}},{id:"ex",la:{abbr:"Ex",name:"Exodus"},en:{abbr:"Ex",name:"Exodus"},de:{abbr:"Ex",name:"Exodus"},pl:{abbr:"Wj",name:"Księga Wyjścia"}},{id:"lev",la:{abbr:"Lev",name:"Leviticus"},en:{abbr:"Lev",name:"Leviticus"},de:{abbr:"Lev",name:"Levitikus"},pl:{abbr:"Kpł",name:"Księga Kapłańska"}},{id:"num",la:{abbr:"Num",name:"Numeri"},en:{abbr:"Num",name:"Numbers"},de:{abbr:"Num",name:"Numeri"},pl:{abbr:"Lb",name:"Księga Liczb"}},{id:"deut",la:{abbr:"Deut",name:"Deuteronomium"},en:{abbr:"Deut",name:"Deuteronomy"},de:{abbr:"Dtn",name:"Deuteronomium"},pl:{abbr:"Pwt",name:"Księga Powtórzonego Prawa"}},{id:"ios",la:{abbr:"Ios",name:"Iosue"},en:{abbr:"Josh",name:"Joshua"},de:{abbr:"Jos",name:"Josua"},pl:{abbr:"Joz",name:"Księga Jozuego"}},{id:"iudg",la:{abbr:"Iudg",name:"Iudicum"},en:{abbr:"Judg",name:"Judges"},de:{abbr:"Ri",name:"Richter"},pl:{abbr:"Sdz",name:"Księga Sędziów"}},{id:"ruth",la:{abbr:"Ruth",name:"Ruth"},en:{abbr:"Ruth",name:"Ruth"},de:{abbr:"Rut",name:"Rut"},pl:{abbr:"Rt",name:"Księga Rut"}},{id:"1sam",la:{abbr:"1 Sam",name:"I Samuelis"},en:{abbr:"1 Sam",name:"1 Samuel"},de:{abbr:"1 Sam",name:"1 Samuel"},pl:{abbr:"1 Sm",name:"1 Księga Samuela"}},{id:"2sam",la:{abbr:"2 Sam",name:"II Samuelis"},en:{abbr:"2 Sam",name:"2 Samuel"},de:{abbr:"2 Sam",name:"2 Samuel"},pl:{abbr:"2 Sm",name:"2 Księga Samuela"}},{id:"1reg",la:{abbr:"1 Reg",name:"I Regum"},en:{abbr:"1 Kgs",name:"1 Kings"},de:{abbr:"1 Kön",name:"1 Könige"},pl:{abbr:"1 Krl",name:"1 Księga Królewska"}},{id:"2reg",la:{abbr:"2 Reg",name:"II Regum"},en:{abbr:"2 Kgs",name:"2 Kings"},de:{abbr:"2 Kön",name:"2 Könige"},pl:{abbr:"2 Krl",name:"2 Księga Królewska"}},{id:"1par",la:{abbr:"1 Par",name:"I Paralipomenon"},en:{abbr:"1 Chr",name:"1 Chronicles"},de:{abbr:"1 Chr",name:"1 Chronik"},pl:{abbr:"1 Krn",name:"1 Księga Kronik"}},{id:"2par",la:{abbr:"2 Par",name:"II Paralipomenon"},en:{abbr:"2 Chr",name:"2 Chronicles"},de:{abbr:"2 Chr",name:"2 Chronik"},pl:{abbr:"2 Krn",name:"2 Księga Kronik"}},{id:"esd",la:{abbr:"Esd",name:"Esdrae"},en:{abbr:"Ezra",name:"Ezra"},de:{abbr:"Esra",name:"Esra"},pl:{abbr:"Ezd",name:"Księga Ezdrasza"}},{id:"neh",la:{abbr:"Neh",name:"Nehemiae"},en:{abbr:"Neh",name:"Nehemiah"},de:{abbr:"Neh",name:"Nehemia"},pl:{abbr:"Ne",name:"Księga Nehemiasza"}},{id:"tob",la:{abbr:"Tob",name:"Tobiae"},en:{abbr:"Tob",name:"Tobit"},de:{abbr:"Tob",name:"Tobit"},pl:{abbr:"Tb",name:"Księga Tobiasza"}},{id:"iudt",la:{abbr:"Iudt",name:"Iudith"},en:{abbr:"Jdt",name:"Judith"},de:{abbr:"Jdt",name:"Judit"},pl:{abbr:"Jdt",name:"Księga Judyty"}},{id:"est",la:{abbr:"Est",name:"Esther"},en:{abbr:"Est",name:"Esther"},de:{abbr:"Est",name:"Ester"},pl:{abbr:"Est",name:"Księga Estery"}},{id:"1macc",la:{abbr:"1 Macc",name:"I Maccabaeorum"},en:{abbr:"1 Mc",name:"1 Maccabees"},de:{abbr:"1 Makk",name:"1 Makkabäer"},pl:{abbr:"1 Mch",name:"1 Księga Machabejska"}},{id:"2macc",la:{abbr:"2 Macc",name:"II Maccabaeorum"},en:{abbr:"2 Mc",name:"2 Maccabees"},de:{abbr:"2 Makk",name:"2 Makkabäer"},pl:{abbr:"2 Mch",name:"2 Księga Machabejska"}},{id:"iob",la:{abbr:"Iob",name:"Iob"},en:{abbr:"Job",name:"Job"},de:{abbr:"Ijob",name:"Ijob"},pl:{abbr:"Hi",name:"Księga Hioba"}},{id:"ps",la:{abbr:"Ps",name:"Psalmi"},en:{abbr:"Ps",name:"Psalms"},de:{abbr:"Ps",name:"Psalmen"},pl:{abbr:"Ps",name:"Księga Psalmów"}},{id:"prov",la:{abbr:"Prov",name:"Proverbia"},en:{abbr:"Prov",name:"Proverbs"},de:{abbr:"Spr",name:"Sprichwörter"},pl:{abbr:"Prz",name:"Księga Przysłów"}},{id:"ecc",la:{abbr:"Ecc",name:"Ecclesiastes"},en:{abbr:"Eccl",name:"Ecclesiastes"},de:{abbr:"Koh",name:"Kohelet"},pl:{abbr:"Koh",name:"Księga Koheleta"}},{id:"cant",la:{abbr:"Cant",name:"Canticum Canticorum"},en:{abbr:"Song",name:"Song of Songs"},de:{abbr:"Hld",name:"Hoheslied"},pl:{abbr:"Pnp",name:"Pieśń nad Pieśniami"}},{id:"sap",la:{abbr:"Sap",name:"Sapientia"},en:{abbr:"Wis",name:"Wisdom"},de:{abbr:"Weish",name:"Weisheit"},pl:{abbr:"Mdr",name:"Księga Mądrości"}},{id:"sir",la:{abbr:"Sir",name:"Ecclesiasticus (Sirach)"},en:{abbr:"Sir",name:"Sirach"},de:{abbr:"Sir",name:"Jesus Sirach"},pl:{abbr:"Syr",name:"Mądrość Syracha"}},{id:"isa",la:{abbr:"Isa",name:"Isaias"},en:{abbr:"Isa",name:"Isaiah"},de:{abbr:"Jes",name:"Jesaja"},pl:{abbr:"Iz",name:"Księga Izajasza"}},{id:"ier",la:{abbr:"Ier",name:"Ieremias"},en:{abbr:"Jer",name:"Jeremiah"},de:{abbr:"Jer",name:"Jeremia"},pl:{abbr:"Jr",name:"Księga Jeremiasza"}},{id:"lam",la:{abbr:"Lam",name:"Lamentationes"},en:{abbr:"Lam",name:"Lamentations"},de:{abbr:"Klgl",name:"Klagelieder"},pl:{abbr:"Lm",name:"Lamentacje"}},{id:"bar",la:{abbr:"Bar",name:"Baruch"},en:{abbr:"Bar",name:"Baruch"},de:{abbr:"Bar",name:"Baruch"},pl:{abbr:"Ba",name:"Księga Barucha"}},{id:"ez",la:{abbr:"Ez",name:"Ezechiel"},en:{abbr:"Ezek",name:"Ezekiel"},de:{abbr:"Ez",name:"Ezechiel"},pl:{abbr:"Ez",name:"Księga Ezechiela"}},{id:"dan",la:{abbr:"Dan",name:"Daniel"},en:{abbr:"Dan",name:"Daniel"},de:{abbr:"Dan",name:"Daniel"},pl:{abbr:"Dn",name:"Księga Daniela"}},{id:"hos",la:{abbr:"Hos",name:"Osee"},en:{abbr:"Hos",name:"Hosea"},de:{abbr:"Hos",name:"Hosea"},pl:{abbr:"Oz",name:"Księga Ozeasza"}},{id:"ioel",la:{abbr:"Ioel",name:"Ioel"},en:{abbr:"Joel",name:"Joel"},de:{abbr:"Joel",name:"Joel"},pl:{abbr:"Jl",name:"Księga Joela"}},{id:"amos",la:{abbr:"Amos",name:"Amos"},en:{abbr:"Am",name:"Amos"},de:{abbr:"Am",name:"Amos"},pl:{abbr:"Am",name:"Księga Amosa"}},{id:"abd",la:{abbr:"Abd",name:"Abdias"},en:{abbr:"Obad",name:"Obadiah"},de:{abbr:"Obd",name:"Obadja"},pl:{abbr:"Abd",name:"Księga Abdiasza"}},{id:"ion",la:{abbr:"Ion",name:"Ionas"},en:{abbr:"Jon",name:"Jonah"},de:{abbr:"Jona",name:"Jona"},pl:{abbr:"Jon",name:"Księga Jonasza"}},{id:"mich",la:{abbr:"Mich",name:"Michaeas"},en:{abbr:"Mic",name:"Micah"},de:{abbr:"Mi",name:"Micha"},pl:{abbr:"Mi",name:"Księga Micheasza"}},{id:"nah",la:{abbr:"Nah",name:"Nahum"},en:{abbr:"Nah",name:"Nahum"},de:{abbr:"Nah",name:"Nahum"},pl:{abbr:"Na",name:"Księga Nahuma"}},{id:"hab",la:{abbr:"Hab",name:"Habacuc"},en:{abbr:"Hab",name:"Habakkuk"},de:{abbr:"Hab",name:"Habakuk"},pl:{abbr:"Ha",name:"Księga Habakuka"}},{id:"soph",la:{abbr:"Soph",name:"Sophonias"},en:{abbr:"Zeph",name:"Zephaniah"},de:{abbr:"Zef",name:"Zefanja"},pl:{abbr:"So",name:"Księga Sofoniasza"}},{id:"agg",la:{abbr:"Agg",name:"Aggaeus"},en:{abbr:"Hag",name:"Haggai"},de:{abbr:"Hag",name:"Haggai"},pl:{abbr:"Ag",name:"Księga Aggeusza"}},{id:"zach",la:{abbr:"Zach",name:"Zacharias"},en:{abbr:"Zech",name:"Zechariah"},de:{abbr:"Sach",name:"Sacharja"},pl:{abbr:"Za",name:"Księga Zachariasza"}},{id:"mal",la:{abbr:"Mal",name:"Malachias"},en:{abbr:"Mal",name:"Malachi"},de:{abbr:"Mal",name:"Maleachi"},pl:{abbr:"Ml",name:"Księga Malachiasza"}},{id:"mt",la:{abbr:"Mt",name:"Matthaeus"},en:{abbr:"Matt",name:"Matthew"},de:{abbr:"Mt",name:"Matthäus"},pl:{abbr:"Mt",name:"Ewangelia wg św. Mateusza"}},{id:"mc",la:{abbr:"Mc",name:"Marcus"},en:{abbr:"Mark",name:"Mark"},de:{abbr:"Mk",name:"Markus"},pl:{abbr:"Mk",name:"Ewangelia wg św. Marka"}},{id:"lc",la:{abbr:"Lc",name:"Lucas"},en:{abbr:"Luke",name:"Luke"},de:{abbr:"Lk",name:"Lukas"},pl:{abbr:"Łk",name:"Ewangelia wg św. Łukasza"}},{id:"io",la:{abbr:"Io",name:"Ioannes"},en:{abbr:"John",name:"John"},de:{abbr:"Joh",name:"Johannes"},pl:{abbr:"J",name:"Ewangelia wg św. Jana"}},{id:"act",la:{abbr:"Act",name:"Actus Apostolorum"},en:{abbr:"Acts",name:"Acts"},de:{abbr:"Apg",name:"Apostelgeschichte"},pl:{abbr:"Dz",name:"Dzieje Apostolskie"}},{id:"rom",la:{abbr:"Rom",name:"ad Romanos"},en:{abbr:"Rom",name:"Romans"},de:{abbr:"Röm",name:"Römer"},pl:{abbr:"Rz",name:"List do Rzymian"}},{id:"1cor",la:{abbr:"1 Cor",name:"I ad Corinthios"},en:{abbr:"1 Cor",name:"1 Corinthians"},de:{abbr:"1 Kor",name:"1 Korinther"},pl:{abbr:"1 Kor",name:"1 List do Koryntian"}},{id:"2cor",la:{abbr:"2 Cor",name:"II ad Corinthios"},en:{abbr:"2 Cor",name:"2 Corinthians"},de:{abbr:"2 Kor",name:"2 Korinther"},pl:{abbr:"2 Kor",name:"2 List do Koryntian"}},{id:"gal",la:{abbr:"Gal",name:"ad Galatas"},en:{abbr:"Gal",name:"Galatians"},de:{abbr:"Gal",name:"Galater"},pl:{abbr:"Ga",name:"List do Galatów"}},{id:"eph",la:{abbr:"Eph",name:"ad Ephesios"},en:{abbr:"Eph",name:"Ephesians"},de:{abbr:"Eph",name:"Epheser"},pl:{abbr:"Ef",name:"List do Efezjan"}},{id:"phil",la:{abbr:"Phil",name:"ad Philippenses"},en:{abbr:"Phil",name:"Philippians"},de:{abbr:"Phil",name:"Philipper"},pl:{abbr:"Flp",name:"List do Filipian"}},{id:"col",la:{abbr:"Col",name:"ad Colossenses"},en:{abbr:"Col",name:"Colossians"},de:{abbr:"Kol",name:"Kolosser"},pl:{abbr:"Kol",name:"List do Kolosan"}},{id:"1thess",la:{abbr:"1 Thess",name:"I ad Thessalonicenses"},en:{abbr:"1 Thess",name:"1 Thessalonians"},de:{abbr:"1 Thess",name:"1 Thessalonicher"},pl:{abbr:"1 Tes",name:"1 List do Tesaloniczan"}},{id:"2thess",la:{abbr:"2 Thess",name:"II ad Thessalonicenses"},en:{abbr:"2 Thess",name:"2 Thessalonians"},de:{abbr:"2 Thess",name:"2 Thessalonicher"},pl:{abbr:"2 Tes",name:"2 List do Tesaloniczan"}},{id:"1tim",la:{abbr:"1 Tim",name:"I ad Timotheum"},en:{abbr:"1 Tim",name:"1 Timothy"},de:{abbr:"1 Tim",name:"1 Timotheus"},pl:{abbr:"1 Tm",name:"1 List do Tymoteusza"}},{id:"2tim",la:{abbr:"2 Tim",name:"II ad Timotheum"},en:{abbr:"2 Tim",name:"2 Timothy"},de:{abbr:"2 Tim",name:"2 Timotheus"},pl:{abbr:"2 Tm",name:"2 List do Tymoteusza"}},{id:"tit",la:{abbr:"Tit",name:"ad Titum"},en:{abbr:"Titus",name:"Titus"},de:{abbr:"Tit",name:"Titus"},pl:{abbr:"Tt",name:"List do Tytusa"}},{id:"phlm",la:{abbr:"Phlm",name:"ad Philemonem"},en:{abbr:"Phlm",name:"Philemon"},de:{abbr:"Phlm",name:"Philemon"},pl:{abbr:"Flm",name:"List do Filemona"}},{id:"heb",la:{abbr:"Heb",name:"ad Hebraeos"},en:{abbr:"Heb",name:"Hebrews"},de:{abbr:"Hebr",name:"Hebräer"},pl:{abbr:"Hbr",name:"List do Hebrajczyków"}},{id:"iac",la:{abbr:"Iac",name:"Iacobi"},en:{abbr:"Jas",name:"James"},de:{abbr:"Jak",name:"Jakobus"},pl:{abbr:"Jk",name:"List św. Jakuba"}},{id:"1pet",la:{abbr:"1 Pet",name:"I Petri"},en:{abbr:"1 Pet",name:"1 Peter"},de:{abbr:"1 Petr",name:"1 Petrus"},pl:{abbr:"1 P",name:"1 List św. Piotra"}},{id:"2pet",la:{abbr:"2 Pet",name:"II Petri"},en:{abbr:"2 Pet",name:"2 Peter"},de:{abbr:"2 Petr",name:"2 Petrus"},pl:{abbr:"2 P",name:"2 List św. Piotra"}},{id:"1io",la:{abbr:"1 Io",name:"I Ioannis"},en:{abbr:"1 John",name:"1 John"},de:{abbr:"1 Joh",name:"1 Johannes"},pl:{abbr:"1 J",name:"1 List św. Jana"}},{id:"2io",la:{abbr:"2 Io",name:"II Ioannis"},en:{abbr:"2 John",name:"2 John"},de:{abbr:"2 Joh",name:"2 Johannes"},pl:{abbr:"2 J",name:"2 List św. Jana"}},{id:"3io",la:{abbr:"3 Io",name:"III Ioannis"},en:{abbr:"3 John",name:"3 John"},de:{abbr:"3 Joh",name:"3 Johannes"},pl:{abbr:"3 J",name:"3 List św. Jana"}},{id:"iud",la:{abbr:"Iud",name:"Iudae"},en:{abbr:"Jude",name:"Jude"},de:{abbr:"Jud",name:"Judas"},pl:{abbr:"Jud",name:"List św. Judy"}},{id:"apoc",la:{abbr:"Apoc",name:"Apocalypsis Ioannis"},en:{abbr:"Rev",name:"Revelation"},de:{abbr:"Offb",name:"Offenbarung"},pl:{abbr:"Ap",name:"Apokalipsa św. Jana"}}],vs=8;function ws({libraryId:t,copy:n,language:r,sourceKindOptions:s,value:o,onChange:h,labels:d}){const[w,f]=a.useState(!1),[j,i]=a.useState(-1),p=a.useMemo(()=>{const m=r;return xs.map(S=>{var g;const _=(S==null?void 0:S[m])??(S==null?void 0:S.en)??(S==null?void 0:S.la);return{label:`${_.abbr} — ${_.name}`,latin:((g=S==null?void 0:S.la)==null?void 0:g.abbr)??_.abbr}})},[r]),c=(m,S=!1)=>{const _=m.trim().toLowerCase();return _?p.filter(x=>x.label.toLowerCase().includes(_)).slice(0,vs):S?p.slice(0,vs):[]},u=(m,S)=>{const _=m.trim().toLowerCase();if(!_)return null;const x=xs;for(const g of x){const C=g==null?void 0:g.la,D=(g==null?void 0:g[S])??(g==null?void 0:g.en)??C,y=(D==null?void 0:D.abbr)??"",U=(D==null?void 0:D.name)??"";if(y.toLowerCase()===_||U.toLowerCase()===_||`${y} — ${U}`.toLowerCase()===_)return{book:g,entry:D,la:C}}return null};a.useEffect(()=>{if(o.sourceKind==="bible"&&o.locatorValue&&!w){const m=u(o.locatorValue,r);if(m){const S=`${m.entry.abbr} — ${m.entry.name}`;S!==o.bibleBookDisplay&&h({...o,bibleBookDisplay:S})}}},[r,o,w,h]);const v=m=>h({...o,...m});return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:d.sourceKindLabel}),e.jsx("select",{value:o.sourceKind,onChange:m=>v({sourceKind:m.target.value,churchDocument:null,bookMedia:null,work:null,locatorValue:"",locatorAux:"",bibleBookDisplay:""}),children:s.map(m=>e.jsx("option",{value:m.value,children:m.label},m.value))})]}),o.sourceKind==="bible"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-lookup full",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:d.bibleBookLabel}),e.jsx("input",{type:"text",value:o.bibleBookDisplay,onChange:m=>{const S=m.target.value;v({bibleBookDisplay:S,locatorValue:""}),f(!0),i(-1)},onKeyDown:m=>{var _;const S=c(o.bibleBookDisplay);if(S.length){if(m.key==="ArrowDown")m.preventDefault(),i(x=>Math.min(x+1,S.length-1));else if(m.key==="ArrowUp")m.preventDefault(),i(x=>Math.max(x-1,0));else if((m.key==="Enter"||m.key==="Tab")&&j>=0&&S[j]){const x=S[j],g=u(x.label,r);if(!g)return;v({bibleBookDisplay:x.label,locatorValue:((_=g.la)==null?void 0:_.abbr)??o.locatorValue}),f(!1)}}},onFocus:()=>f(!0),onBlur:()=>window.setTimeout(()=>f(!1),100),placeholder:d.bibleBookPlaceholder})]}),w&&c(o.bibleBookDisplay,!0).length>0&&e.jsx("div",{className:"cogita-lookup-results",children:c(o.bibleBookDisplay,!0).map((m,S)=>e.jsx("button",{type:"button",className:"cogita-lookup-option","data-active":S===j,tabIndex:-1,onMouseDown:()=>{var x;const _=u(m.label,r);_&&v({bibleBookDisplay:m.label,locatorValue:((x=_.la)==null?void 0:x.abbr)??o.locatorValue})},children:e.jsx("strong",{children:m.label})},m.latin))})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:d.bibleRestLabel}),e.jsx("input",{type:"text",value:o.locatorAux,onChange:m=>v({locatorAux:m.target.value}),placeholder:d.bibleRestPlaceholder})]})]}),o.sourceKind==="website"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceUrlLabel}),e.jsx("input",{type:"text",value:o.sourceUrl,onChange:m=>v({sourceUrl:m.target.value}),placeholder:n.cogita.library.add.info.sourceUrlPlaceholder})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceAccessedDateLabel}),e.jsx("input",{type:"text",value:o.sourceAccessedDate,onChange:m=>v({sourceAccessedDate:m.target.value}),placeholder:n.cogita.library.add.info.sourceAccessedDatePlaceholder})]})]}),o.sourceKind==="number_document"&&e.jsxs(e.Fragment,{children:[e.jsx(Gt,{libraryId:t,infoType:"work",label:d.churchDocumentLabel,placeholder:d.churchDocumentPlaceholder,value:o.churchDocument,onChange:m=>v({churchDocument:m}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:d.locatorLabel}),e.jsx("input",{type:"text",value:o.locatorValue,onChange:m=>v({locatorValue:m.target.value}),placeholder:d.locatorPlaceholder})]})]}),o.sourceKind==="work"&&e.jsx(Gt,{libraryId:t,infoType:"work",label:d.workLabel,placeholder:d.workPlaceholder,value:o.work,onChange:m=>v({work:m}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),o.sourceKind==="book"&&e.jsxs(e.Fragment,{children:[e.jsx(Gt,{libraryId:t,infoType:"media",label:d.bookLabel,placeholder:d.bookPlaceholder,value:o.bookMedia,onChange:m=>v({bookMedia:m}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.media),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:d.locatorLabel}),e.jsx("input",{type:"text",value:o.locatorValue,onChange:m=>v({locatorValue:m.target.value}),placeholder:d.locatorPlaceholder})]})]}),o.sourceKind!=="website"&&o.sourceKind!=="bible"&&o.sourceKind!=="book"&&o.sourceKind!=="number_document"&&e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:d.locatorLabel}),e.jsx("input",{type:"text",value:o.locatorValue,onChange:m=>v({locatorValue:m.target.value}),placeholder:d.locatorPlaceholder})]})]})}const Ka=JSON.stringify({type:"selection",title:"Question title",question:"Question text",options:["Option A","Option B","Option C"],answer:[0]},null,2);function Qa(t="selection"){return t==="matching"?{type:t,title:"",question:"",columns:[[""],[""]],answer:{paths:[]},matchingPaths:[["",""]]}:t==="ordering"?{type:t,title:"",question:"",options:[""]}:t==="truefalse"?{type:t,title:"",question:"",answer:!0}:t==="text"||t==="date"?{type:t,title:"",question:"",answer:""}:t==="number"?{type:t,title:"",question:"",answer:""}:{type:t,title:"",question:"",options:[""],answer:[]}}function mi(t){return["selection","truefalse","text","number","date","matching","ordering"].includes(t)}function Fa(t){if(!t||typeof t!="object")return null;const n=t,r=typeof n.type=="string"?n.type:typeof n.kind=="string"?n.kind:"selection",s=r==="multi_select"||r==="single_select"?"selection":r==="boolean"?"truefalse":r==="order"?"ordering":r,o=mi(s)?s:"selection",h=typeof n.title=="string"?n.title:"",d=typeof n.question=="string"?n.question:"";if(o==="matching"){let j=[];Array.isArray(n.columns)?j=n.columns.map(m=>Array.isArray(m)?m.map(S=>typeof S=="string"?S:""):[""]):Array.isArray(n.left)&&Array.isArray(n.right)&&(j=[n.left.map(m=>typeof m=="string"?m:""),n.right.map(m=>typeof m=="string"?m:"")]),j.length<2&&(j=[[""],[""]]);const i=n.answer&&typeof n.answer=="object"?n.answer:null,c=(Array.isArray(i==null?void 0:i.paths)?i==null?void 0:i.paths:Array.isArray(n.correctPairs)?n.correctPairs:[]).map(m=>Array.isArray(m)?m.map(S=>Number(S)).filter(S=>Number.isInteger(S)&&S>=0):[]).filter(m=>m.length>0),u=Array.isArray(n.matchingPaths)?n.matchingPaths.map(m=>Array.isArray(m)?Array.from({length:j.length},(S,_)=>String(m[_]??"")):new Array(j.length).fill("")):null,v=u&&u.length>0?u:[...c.map(m=>m.map(String)),new Array(j.length).fill("")];return{type:o,title:h,question:d,columns:j,answer:{paths:c},matchingPaths:v}}if(o==="ordering"){const j=Array.isArray(n.options)?n.options.map(i=>typeof i=="string"?i:""):Array.isArray(n.items)?n.items.map(i=>typeof i=="string"?i:""):[""];return{type:o,title:h,question:d,options:j.length?j:[""]}}if(o==="truefalse"){const j=typeof n.answer=="boolean"?n.answer:typeof n.expected=="boolean"?n.expected:!0;return{type:o,title:h,question:d,answer:j}}if(o==="number")return typeof n.answer=="number"?{type:o,title:h,question:d,answer:n.answer}:typeof n.answer=="string"?{type:o,title:h,question:d,answer:n.answer}:typeof n.expected=="number"?{type:o,title:h,question:d,answer:n.expected}:{type:o,title:h,question:d,answer:""};if(o==="text"||o==="date"){const j=typeof n.answer=="string"?n.answer:typeof n.expected=="string"?n.expected:"";return{type:o,title:h,question:d,answer:j}}const w=Array.isArray(n.options)?n.options.map(j=>typeof j=="string"?j:""):[""],f=Array.isArray(n.answer)?n.answer.map(j=>Number(j)).filter(j=>Number.isInteger(j)&&j>=0):Array.isArray(n.correct)?n.correct.map(j=>Number(j)).filter(j=>Number.isInteger(j)&&j>=0):[];return{type:o,title:h,question:d,options:w.length?w:[""],answer:f}}function pi(t){const n=(t.title??"").trim(),r=(t.question??"").trim();switch(t.type){case"matching":{const s=(t.columns??[[""],[""]]).map(p=>p.map(c=>c.trim()).filter(Boolean)).filter(p=>p.length>0),o=s.length>=2?s:[[""],[""]],h=t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[],d=(t.matchingPaths??[]).map(p=>p.map(c=>String(c??""))),w=o.length,f=d.map(p=>p.slice(0,w).map(c=>c.trim())).filter(p=>p.some(Boolean)).map(p=>p.map(c=>Number(c))).filter(p=>p.length===w&&p.every(c=>Number.isInteger(c)&&c>=0)),j=(Array.isArray(h)?h:[]).map(p=>Array.isArray(p)?p.map(c=>Number(c)).filter(c=>Number.isInteger(c)&&c>=0):[]).filter(p=>p.length===w),i=Array.from(new Set([...j,...f].map(p=>JSON.stringify(p)))).map(p=>JSON.parse(p));return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,columns:o,answer:{paths:i}},null,2)}case"ordering":{const s=(t.options??[]).map(o=>o.trim()).filter(Boolean);return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,options:s},null,2)}case"truefalse":return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,answer:!!t.answer},null,2);case"number":return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,answer:typeof t.answer=="number"||typeof t.answer=="string"?t.answer:""},null,2);case"date":case"text":return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,answer:String(t.answer??"")},null,2);case"selection":default:{const s=(t.options??[]).map(d=>d.trim()).filter(Boolean),o=Array.isArray(t.answer)?t.answer:[],h=Array.from(new Set(o.filter(d=>Number.isInteger(d)&&d>=0&&d<s.length))).sort((d,w)=>d-w);return JSON.stringify({type:t.type,...n?{title:n}:{},question:r,options:s,answer:h},null,2)}}}const js=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}];function _a(){return{sourceKind:"string",locatorValue:"",locatorAux:"",bibleBookDisplay:"",sourceUrl:"",sourceAccessedDate:"",churchDocument:null,bookMedia:null,work:null}}function ks(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function Ns(t,n){if(!t||typeof t!="object")return n;const r=t,s=r.definition&&typeof r.definition=="object"?r.definition:null,o=[r.label,r.name,r.title,r.text,r.orcid,r.email,r.number];s&&o.unshift(s.title,s.question);for(const h of o)if(typeof h=="string"&&h.trim())return h.trim();return n}function Ss(t,n){var s;if(!(t instanceof Vs))return n;const r=(s=t.message)==null?void 0:s.trim();if(!r)return n;try{const o=JSON.parse(r);if(typeof o.error=="string"&&o.error.trim())return o.error.trim()}catch{}return r}function fi(t){const n=t.trim();if(!n)return null;try{const r=JSON.parse(n);return r&&typeof r=="object"&&!Array.isArray(r)?r:null}catch{return null}}function la(t,n){const r=t==null?void 0:t[n];return typeof r=="string"?r:""}function bi(t,n){return n?t==="book"&&n.infoType==="media"?{bookMedia:n}:t==="work"&&n.infoType==="work"?{work:n}:t==="number_document"&&n.infoType==="work"?{churchDocument:n}:{}:{}}function yi(t,n){const r=_a(),s=(t.sourceKind??"").trim()||r.sourceKind,o=t.locator??"",h=fi(o);let d="",w="",f="",j="",i="";return s==="website"?(j=la(h,"url"),i=la(h,"accessedDate"),d=la(h,"value")):s==="bible"?(d=la(h,"book")||o.trim(),w=la(h,"passage")||la(h,"rest"),f=la(h,"bookDisplay")):h?(d=la(h,"value")||la(h,"locator"),w=la(h,"aux")):d=o,{...r,sourceKind:s,locatorValue:d,locatorAux:w,bibleBookDisplay:f,sourceUrl:j,sourceAccessedDate:i,...bi(s,n)}}function Mn(t){return t.sourceKind==="book"?t.bookMedia:t.sourceKind==="work"?t.work:t.sourceKind==="number_document"?t.churchDocument:null}function Ln(t){const n=t.locatorValue.trim(),r=t.locatorAux.trim(),s=t.sourceUrl.trim(),o=t.sourceAccessedDate.trim();switch(t.sourceKind){case"website":return{url:s,accessedDate:o};case"bible":return{book:n,bookDisplay:t.bibleBookDisplay.trim(),passage:r};case"book":case"work":case"number_document":return r?{value:n,aux:r}:n;default:return r?{value:n,aux:r}:n}}function Ts(t){var o,h,d;const n=t.locatorValue.trim(),r=t.locatorAux.trim(),s=[n,r].filter(Boolean).join(" ");switch(t.sourceKind){case"website":return t.sourceUrl.trim()||"website";case"bible":return s||"bible";case"book":return[(o=t.bookMedia)==null?void 0:o.label,s].filter(Boolean).join(" · ")||"book";case"work":return[(h=t.work)==null?void 0:h.label,s].filter(Boolean).join(" · ")||"work";case"number_document":return[(d=t.churchDocument)==null?void 0:d.label,s].filter(Boolean).join(" · ")||"number_document";default:return s||t.sourceKind||"source"}}function Cs(t){return t.sourceKind.trim()?t.sourceKind==="website"?!!t.sourceUrl.trim():t.sourceKind==="bible"?!!(t.locatorValue.trim()&&t.locatorAux.trim()):t.sourceKind==="book"?!!t.bookMedia:t.sourceKind==="work"?!!t.work:t.sourceKind==="number_document"?!!(t.churchDocument&&t.locatorValue.trim()):!!t.locatorValue.trim():!1}function xi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,libraryId:i,editInfoId:p}){var Ce,Be,Ye;const{libraryName:c}=ga(i),u=!!p,[v,m]=a.useState([]),[S,_]=a.useState("word"),[x,g]=a.useState({}),[C,D]=a.useState({}),[y,U]=a.useState({}),[N,ae]=a.useState({}),[z,P]=a.useState(null),[B,Q]=a.useState("idle"),[xe,Ee]=a.useState(_a),[re,A]=a.useState({}),[ye,J]=a.useState({}),[ge,ee]=a.useState({}),[ke,ue]=a.useState(null),[le,Ie]=a.useState(()=>Fa(JSON.parse(Ka))??Qa()),[Ae,Ke]=a.useState(Ka),Re=a.useMemo(()=>v.find($=>$.infoType===S),[S,v]),Ze=a.useMemo(()=>v.find($=>$.infoType==="source"),[v]),ot=a.useMemo(()=>v.map($=>({value:$.infoType,label:nt(t,$.infoType)})),[t,v]),Te=$=>{const L=Fa($)??Qa(),K=pi(L);Ie(L),g(R=>({...R,definition:K}))};a.useEffect(()=>{let $=!1;return mr({libraryId:i}).then(L=>{var K;if(!$&&(m(L),!u)){const R=(K=L[0])==null?void 0:K.infoType;R&&_(R)}}).catch(()=>{$||m([])}),()=>{$=!0}},[u,i]),a.useEffect(()=>{if(u||!Re)return;const $={},L={},K={},R={};for(const k of Re.payloadFields)Re.infoType==="question"&&k.key==="definition"&&k.inputType==="json"?$[k.key]=Ka:$[k.key]="";for(const k of Re.linkFields)k.multiple?K[k.key]=[]:L[k.key]=null,k.targetTypes.length>0&&(R[k.key]=k.targetTypes[0]);g($),D(L),U(K),ae(R)},[Re==null?void 0:Re.infoType,u]),a.useEffect(()=>{if(S!=="question")return;const $=x.definition??"";if(!$.trim()){const L=Fa(JSON.parse(Ka))??Qa();Ie(L),Ke(Ka);return}try{const L=JSON.parse($),K=Fa(L);if(!K)return;Ie(K),Ke(JSON.stringify(L,null,2))}catch{}},[x.definition,S]),a.useEffect(()=>{if(!u||!p||v.length===0)return;let $=!1;return Q("loading"),P(null),(async()=>{const K=await na({libraryId:i,infoId:p});if($)return;const R=K.infoType;_(R);const k=v.find(W=>W.infoType===R);if(!k){Q("idle");return}const T=K.payload??{},M={};for(const W of k.payloadFields)M[W.key]=ks(T[W.key]);g(M);const oe=K.links??{}??{},fe={},de={},Y={},E=[];for(const W of k.linkFields){W.targetTypes.length>0&&(Y[W.key]=W.targetTypes[0]);const te=oe[W.key];if(W.multiple){const H=Array.isArray(te)?te.filter(X=>typeof X=="string"):[];de[W.key]=[];for(const X of H)E.push(na({libraryId:i,infoId:X}).then(be=>{if($)return;const O={id:X,infoType:be.infoType,label:Ns(be.payload,X)};Y[W.key]=O.infoType,de[W.key]=[...de[W.key],O]}).catch(()=>{}))}else{const H=typeof te=="string"?te:null;fe[W.key]=null,H&&E.push(na({libraryId:i,infoId:H}).then(X=>{if($)return;const be={id:H,infoType:X.infoType,label:Ns(X.payload,H)};Y[W.key]=be.infoType,fe[W.key]=be}).catch(()=>{}))}}await Promise.all(E),!$&&(D(fe),U(de),ae(Y),Q("idle"))})().catch(()=>{$||(P("Failed to load info details."),Q("idle"))}),()=>{$=!0}},[p,u,i,v]),a.useEffect(()=>{S==="source"&&Ee(yi(x,C.resource??null))},[S,x.sourceKind,x.locator,(Ce=C.resource)==null?void 0:Ce.id,(Be=C.resource)==null?void 0:Be.infoType,(Ye=C.resource)==null?void 0:Ye.label]);const We=$=>{var k,T;const L=((k=Ze==null?void 0:Ze.payloadFields.find(M=>M.key==="sourceKind"))==null?void 0:k.keepOnCreate)??!1,K=((T=Ze==null?void 0:Ze.linkFields.find(M=>M.key==="resource"))==null?void 0:T.keepOnCreate)??!1,R=_a();return R.sourceKind=L?$.sourceKind:R.sourceKind,K&&(R.work=$.work,R.bookMedia=$.bookMedia,R.churchDocument=$.churchDocument),L&&$.sourceKind==="bible"&&(R.locatorValue=$.locatorValue,R.bibleBookDisplay=$.bibleBookDisplay),L&&$.sourceKind==="website"&&(R.sourceUrl=$.sourceUrl,R.sourceAccessedDate=$.sourceAccessedDate),R},ft=a.useMemo(()=>({sourceKindLabel:t.cogita.library.add.info.sourceKindLabel,bibleBookLabel:t.cogita.library.add.info.sourceBibleBookLabel,bibleBookPlaceholder:t.cogita.library.add.info.sourceBibleBookPlaceholder,bibleRestLabel:t.cogita.library.add.info.sourceBibleRestLabel,bibleRestPlaceholder:t.cogita.library.add.info.sourceBibleRestPlaceholder,churchDocumentLabel:t.cogita.library.add.info.sourceResourceLabel,churchDocumentPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,workLabel:t.cogita.library.add.info.sourceResourceLabel,workPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,bookLabel:t.cogita.library.add.info.sourceResourceLabel,bookPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,locatorLabel:t.cogita.library.list.typeFilterLocator,locatorPlaceholder:t.cogita.library.list.typeFilterLocator}),[t]),Ve=async $=>{const L=ye[$]??_a();if(!Cs(L)){ee(K=>({...K,[$]:t.cogita.library.add.info.referenceMissingSource}));return}ue($),ee(K=>({...K,[$]:null}));try{const K=Mn(L),R=K?{resource:K.id}:{},k={label:Ts(L),sourceKind:L.sourceKind.trim(),locator:Ln(L)},M={id:(await On({libraryId:i,infoType:"source",payload:k,links:R})).infoId,infoType:"source",label:k.label};if(U(oe=>{const fe=oe[$]??[];return fe.some(de=>de.id===M.id)?oe:{...oe,[$]:[...fe,M]}}),u&&p){const oe=await na({libraryId:i,infoId:p}),fe=oe.links&&typeof oe.links=="object"?{...oe.links}:{},de=fe[$],Y=Array.isArray(de)?de.filter(E=>typeof E=="string"):typeof de=="string"?[de]:[];Y.includes(M.id)||(fe[$]=[...Y,M.id],await os({libraryId:i,infoId:p,payload:oe.payload,links:fe}))}J(oe=>({...oe,[$]:We(L)})),ee(oe=>({...oe,[$]:null}))}catch(K){ee(R=>({...R,[$]:Ss(K,t.cogita.library.lookup.createFailed)}))}finally{ue(K=>K===$?null:K)}},ze=async()=>{var K;if(!Re)return;const $={};for(const R of Re.payloadFields){if(S==="source"&&(R.key==="sourceKind"||R.key==="locator"))continue;const k=(x[R.key]??"").trim();if(!k){if(R.required){P(`Field '${R.label}' is required.`);return}continue}if(R.inputType==="json")try{$[R.key]=JSON.parse(k)}catch{P(`Field '${R.label}' must be valid JSON.`);return}else $[R.key]=k}const L={};for(const R of Re.linkFields)if(!(S==="source"&&R.key==="resource"))if(R.multiple){const k=(y[R.key]??[]).map(T=>T.id);if(R.required&&k.length===0){P(`Link '${R.label}' is required.`);return}k.length>0&&(L[R.key]=k)}else{const k=((K=C[R.key])==null?void 0:K.id)??null;if(R.required&&!k){P(`Link '${R.label}' is required.`);return}k&&(L[R.key]=k)}if(S==="source"){if(!Cs(xe)){P(t.cogita.library.add.info.referenceMissingSource);return}const R=xe.sourceKind.trim();$.sourceKind=R,$.locator=Ln(xe),(typeof $.label!="string"||!$.label.trim())&&($.label=Ts(xe));const k=Mn(xe);k&&(L.resource=k.id)}Q("saving"),P(null);try{if(u&&p)await os({libraryId:i,infoId:p,payload:$,links:L}),P("Info updated.");else{await On({libraryId:i,infoType:S,payload:$,links:L}),P("Info saved.");const R={};for(const M of Re.payloadFields)R[M.key]=M.keepOnCreate?x[M.key]??"":"";g(R);const k={},T={};for(const M of Re.linkFields)M.multiple?T[M.key]=M.keepOnCreate?y[M.key]??[]:[]:k[M.key]=M.keepOnCreate?C[M.key]??null:null;D(M=>({...M,...k})),U(M=>({...M,...T})),S==="source"&&Ee(M=>{const oe=We(M),fe=Mn(oe);return g(de=>({...de,sourceKind:oe.sourceKind,locator:ks(Ln(oe))})),D(de=>({...de,resource:fe})),fe&&ae(de=>({...de,resource:fe.infoType})),oe})}}catch(R){P(Ss(R,"Failed to save info."))}finally{Q("idle")}},et=$=>{const L=x[$.key]??"";if(S==="question"&&$.key==="definition"&&$.inputType==="json"){const R=le.type,k=E=>{const W=le.title??"",te=le.question??"";Te({...Qa(E),title:W,question:te})},T=E=>E.length===0?[""]:E[E.length-1].trim()?[...E,""]:E,M=E=>{const W=(E.length?E:[[""],[""]]).map(te=>T(te));return W.length>=2?W:[...W,[""]]},oe=(E,W)=>{const te=E.map(X=>Array.from({length:W},(be,O)=>X[O]??"")).filter(X=>X.some(be=>be.trim())||X===E[E.length-1]);return te.length===0?[new Array(W).fill("")]:te[te.length-1].some(X=>X.trim())?[...te,new Array(W).fill("")]:te},fe=Array.isArray(le.answer)?le.answer:[],de=M(le.columns??[[""],[""]]),Y=oe(le.matchingPaths??[[]],de.length);return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:$.label}),e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.8rem"},children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question type"}),e.jsxs("select",{value:R,onChange:E=>k(E.target.value),children:[e.jsx("option",{value:"selection",children:"Selection"}),e.jsx("option",{value:"truefalse",children:"True / false"}),e.jsx("option",{value:"text",children:"Text answer"}),e.jsx("option",{value:"number",children:"Number answer"}),e.jsx("option",{value:"date",children:"Date answer"}),e.jsx("option",{value:"matching",children:"Matching"}),e.jsx("option",{value:"ordering",children:"Right order"})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Title"}),e.jsx("input",{type:"text",value:le.title??"",onChange:E=>Te({...le,title:E.target.value}),placeholder:"Optional title"})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question"}),e.jsx("textarea",{rows:3,value:le.question??"",onChange:E=>Te({...le,question:E.target.value}),placeholder:"Question text"})]}),R==="selection"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Options / correct indices"}),T(le.options??[""]).map((E,W,te)=>{const H=new Set(fe.filter(be=>Number.isInteger(be))),X=W===te.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:H.has(W),disabled:!E.trim(),onChange:be=>{const O=be.target.checked?[...H,W]:[...H].filter(ne=>ne!==W);Te({...le,answer:O})}}),e.jsx("input",{type:"text",value:E,placeholder:`Answer ${W+1}`,onChange:be=>{const O=[...le.options??[""]];O[W]=be.target.value;const ne=T(O),Le=ne.length-1,qe=fe.filter(De=>De>=0&&De<Le);Te({...le,options:ne,answer:qe})}}),X?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const O=(le.options??[""]).filter((Le,qe)=>qe!==W),ne=fe.filter(Le=>Le!==W).map(Le=>Le>W?Le-1:Le);Te({...le,options:T(O),answer:ne})},children:"Remove"})]},`question-option:${W}`)})]}):null,R==="text"||R==="date"||R==="number"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsx("input",{type:R==="date"?"date":"text",value:typeof le.answer=="string"||typeof le.answer=="number"?String(le.answer):"",onChange:E=>Te({...le,answer:E.target.value})})]}):null,R==="truefalse"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsxs("select",{value:String(!!le.answer),onChange:E=>Te({...le,answer:E.target.value==="true"}),children:[e.jsx("option",{value:"true",children:"True"}),e.jsx("option",{value:"false",children:"False"})]})]}):null,R==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Columns"}),de.map((E,W)=>e.jsxs("div",{style:{display:"grid",gap:"0.35rem",border:"1px solid rgba(120,170,220,0.22)",borderRadius:"0.6rem",padding:"0.55rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"0.5rem"},children:[e.jsxs("span",{style:{fontSize:"0.8rem",color:"rgba(184,209,234,0.85)"},children:["Column ",W+1]}),de.length>2?e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const te=de.filter((X,be)=>be!==W),H=Y.map(X=>X.filter((be,O)=>O!==W));Te({...le,columns:M(te),matchingPaths:oe(H,Math.max(2,te.length))})},children:"Remove column"}):null]}),E.map((te,H)=>{const X=H===E.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",gap:"0.4rem",alignItems:"center"},children:[e.jsx("input",{type:"text",value:te,placeholder:`Option ${H+1}`,onChange:be=>{const O=de.map(ne=>[...ne]);O[W][H]=be.target.value,Te({...le,columns:M(O),matchingPaths:oe(Y,de.length)})}}),X?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const be=de.map(O=>[...O]);be[W]=be[W].filter((O,ne)=>ne!==H),Te({...le,columns:M(be),matchingPaths:oe(Y,de.length)})},children:"Remove"})]},`question-column:${W}:row:${H}`)})]},`question-column:${W}`)),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{const E=[...de.map(te=>[...te]),[""]],W=Y.map(te=>[...te,""]);Te({...le,columns:M(E),matchingPaths:oe(W,E.length)})},children:"Add column"})}),e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Correct paths (0-based indices)"}),Y.map((E,W)=>{const te=W===Y.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:`repeat(${de.length}, minmax(0,1fr)) auto`,gap:"0.35rem",alignItems:"center"},children:[E.map((H,X)=>e.jsx("input",{type:"number",min:0,step:1,value:H,placeholder:`${X}`,onChange:be=>{const O=Y.map(qe=>[...qe]);O[W][X]=be.target.value;const ne=oe(O,de.length),Le=ne.map(qe=>qe.map(De=>De.trim())).filter(qe=>qe.every(De=>De!=="")).map(qe=>qe.map(De=>Number(De))).filter(qe=>qe.every(De=>Number.isInteger(De)&&De>=0));Te({...le,matchingPaths:ne,answer:{paths:Le}})}},`question-path:${W}:${X}`)),te?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const H=Y.filter((O,ne)=>ne!==W),X=oe(H,de.length),be=X.map(O=>O.map(ne=>ne.trim())).filter(O=>O.every(ne=>ne!=="")).map(O=>O.map(ne=>Number(ne))).filter(O=>O.every(ne=>Number.isInteger(ne)&&ne>=0));Te({...le,matchingPaths:X,answer:{paths:be}})},children:"Remove"})]},`question-path:${W}`)})]}):null,R==="ordering"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Ordered options (correct order = listed order)"}),T(le.options??[""]).map((E,W,te)=>{const H=W===te.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)",minWidth:"1.5rem"},children:[W+1,"."]}),e.jsx("input",{type:"text",value:E,placeholder:`Step ${W+1}`,onChange:X=>{const be=[...le.options??[""]];be[W]=X.target.value,Te({...le,options:T(be)})}}),H?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>Te({...le,options:T((le.options??[]).filter((X,be)=>be!==W))}),children:"Remove"})]},`question-order:${W}`)})]}):null,e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"JSON import"}),e.jsx("textarea",{rows:8,value:Ae,onChange:E=>Ke(E.target.value),placeholder:"Paste question JSON"}),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{try{const E=JSON.parse(Ae),W=Fa(E);if(!W){P("Question JSON must be an object.");return}Te(W),P(null)}catch{P("Question JSON is invalid.")}},children:"Interpret JSON"})})]})]})]},`payload:${$.key}`)}const K=$.inputType==="textarea"||$.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:$.label}),K?e.jsx("textarea",{rows:$.inputType==="json"?8:4,value:L,onChange:R=>g(k=>({...k,[$.key]:R.target.value})),placeholder:$.key}):e.jsx("input",{type:"text",value:L,onChange:R=>g(k=>({...k,[$.key]:R.target.value})),placeholder:$.key})]},`payload:${$.key}`)},it=$=>{const L=N[$.key]??$.targetTypes[0],K=$.key==="references"&&$.multiple&&$.targetTypes.includes("source"),R=ye[$.key]??_a(),k=re[$.key]??!1,T=ge[$.key];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:$.label}),$.targetTypes.length>1?e.jsx("select",{value:L,onChange:M=>ae(oe=>({...oe,[$.key]:M.target.value})),children:$.targetTypes.map(M=>e.jsx("option",{value:M,children:nt(t,M)},`${$.key}:${M}`))}):null,$.multiple?e.jsx(Gt,{libraryId:i,infoType:L,label:$.label,placeholder:$.key,multiple:!0,values:y[$.key]??[],onChangeMultiple:M=>U(oe=>({...oe,[$.key]:M})),allowCreate:!K,searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(Gt,{libraryId:i,infoType:L,label:$.label,placeholder:$.key,value:C[$.key]??null,onChange:M=>D(oe=>({...oe,[$.key]:M})),searchFailedText:"Search failed",createFailedText:"Create failed"}),K?e.jsxs("div",{children:[e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:k,onChange:M=>A(oe=>({...oe,[$.key]:M.target.checked}))}),e.jsx("span",{children:t.cogita.library.add.info.referenceToggle})]}),k?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(ws,{libraryId:i,copy:t,language:f,sourceKindOptions:[...js],value:R,onChange:M=>J(oe=>({...oe,[$.key]:M})),labels:ft}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>Ve($.key),disabled:ke===$.key,children:ke===$.key?t.cogita.library.lookup.saving:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.source)})}),T?e.jsx("p",{className:"cogita-library-subtitle",children:T}):null]}):null]}):null]},`link:${$.key}`)},Ge=()=>e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(ws,{libraryId:i,copy:t,language:f,sourceKindOptions:[...js],value:xe,onChange:Ee,labels:ft})]});return e.jsx(At,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:u?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${i}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[u?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:S,onChange:$=>_($.target.value),children:ot.map($=>e.jsx("option",{value:$.value,children:$.label},$.value))})]}),B==="loading"&&u?e.jsx("p",{children:"Loading..."}):null,Re&&!(B==="loading"&&u)?e.jsxs("div",{className:"cogita-form-grid",children:[Re.payloadFields.filter($=>!(S==="source"&&($.key==="sourceKind"||$.key==="locator"))).map(et),S==="source"?Ge():null,Re.linkFields.filter($=>!(S==="source"&&$.key==="resource")).map(it)]}):B==="loading"&&u?null:e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:ze,disabled:B==="saving"||!Re,children:B==="saving"?"Saving...":u?"Update info":"Create info"})}),z?e.jsx("p",{className:"cogita-library-subtitle",children:z}):null]})})})]})})}const Is=t=>/\s/.test(t),an=t=>/[\p{L}\p{N}]/u.test(t),Ms=(t,n)=>{const r=n>0?t[n-1]:"",s=n<t.length?t[n]:"";if(!r||!s)return 0;const o=Is(r),h=Is(s);if(o||h)return 3;const d=an(r),w=an(s);return d!==w?2:!d&&!w?1:0},An=(t,n,r,s,o)=>{const h=Math.max(s-n,r-s);for(let d=0;d<=h;d+=1){const w=s-d;if(w>=n&&w<=r&&Ms(t,w)>=o)return w;const f=s+d;if(f>=n&&f<=r&&Ms(t,f)>=o)return f}return null},Rn=(t,n)=>{const r=n>0?t[n-1]:"",s=n<t.length?t[n]:"";return!r||!s?!0:an(r)!==an(s)},vi=(t,n,r,s)=>{const o=r-n,h=n+s,d=r-s;if(o<=s*2||d<=h)return null;const w=Math.floor((n+r)/2),f=An(t,h,d,w,3);if(f!==null&&Rn(t,f))return f;const j=An(t,h,d,w,2);if(j!==null&&Rn(t,j))return j;const i=An(t,h,d,w,1);return i!==null&&Rn(t,i)?i:null},va=(t,n)=>{const r=Math.max(1,(n==null?void 0:n.minLen)??7),s=Math.max(r,(n==null?void 0:n.maxLen)??13),o={},h=(f,j,i,p,c)=>{const u=String(p),v={id:u,start:f,end:j,text:t.slice(f,j),depth:i,index:p,parentId:c};if(o[u]=v,j-f>s){let S=vi(t,f,j,r);if(S!==null&&S>f&&S<j){const _=h(f,S,i+1,p*2+1,u),x=h(S,j,i+1,p*2+2,u);v.leftId=_.id,v.rightId=x.id}}return v},d=h(0,t.length,0,0),w=Object.values(o).sort((f,j)=>j.depth-f.depth||f.start-j.start).map(f=>f.id);return{text:t,rootId:d.id,nodes:o,order:w}},La=(t,n,r,s,o,h,d)=>{const w=h==="reverse"?t.order.slice().sort((f,j)=>t.nodes[j].start-t.nodes[f].start||t.nodes[j].depth-t.nodes[f].depth):t.order;for(const f of w){if(d&&f===d||n.has(f))continue;const j=t.nodes[f];if(j){if(o&&(j.leftId||j.rightId)){const i=j.leftId?r[j.leftId]??0:s,p=j.rightId?r[j.rightId]??0:s;if((i+p)/2<s)continue}return j}}return null},bn=(t,n)=>({before:t.slice(0,n.start),fragment:t.slice(n.start,n.end),after:t.slice(n.end)});function wi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,libraryId:i}){const p=`/#/cogita/library/${i}`,[c,u,v]=Un([]),[m,S,_]=Jn([]),[x,g]=a.useState(null),[C,D]=a.useState(null),[y,U]=a.useState(null),[N,ae]=a.useState(null),z=a.useMemo(()=>c.find(A=>A.id===x)??null,[c,x]);a.useEffect(()=>{let A=!0;return pr({libraryId:i}).then(ye=>{if(!A)return;const J=ye.nodes.map(ge=>{var ee,ke,ue;return{id:ge.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:ge.payload&&typeof ge.payload=="object"&&"label"in ge.payload?String(ge.payload.label):"Item",nodeType:ge.nodeType,itemType:((ee=ge.payload)==null?void 0:ee.itemType)??"info",itemId:((ke=ge.payload)==null?void 0:ke.itemId)??null,infoType:((ue=ge.payload)==null?void 0:ue.infoType)??null}}});u(J),S(ye.edges.map(ge=>({id:ge.edgeId,source:ge.fromNodeId,target:ge.toNodeId})))}).catch(()=>{A&&(u([]),S([]))}),()=>{A=!1}},[i]),a.useEffect(()=>{fr({libraryId:i}).then(D).catch(()=>D(null))},[i,c,m]);const P=a.useCallback(A=>{S(ye=>Hn(A,ye))},[]),B=()=>{const A=crypto.randomUUID();u(ye=>[...ye,{id:A,type:"default",position:{x:140+ye.length*40,y:120+ye.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},Q=()=>{const A=crypto.randomUUID();u(ye=>[...ye,{id:A,type:"default",position:{x:180+ye.length*40,y:160+ye.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},xe=async()=>{U(null);try{const A=c.map(J=>({nodeId:J.id,nodeType:J.data.nodeType,payload:{itemType:J.data.itemType,itemId:J.data.itemId??null,label:J.data.label,infoType:J.data.infoType??null}})),ye=m.map(J=>({edgeId:J.id,fromNodeId:J.source,toNodeId:J.target}));await br({libraryId:i,nodes:A,edges:ye}),U(t.cogita.library.graph.saveSuccess)}catch{U(t.cogita.library.graph.saveFail)}},Ee=A=>{z&&u(ye=>ye.map(J=>J.id===z.id?{...J,data:{...J.data,itemId:(A==null?void 0:A.infoId)??null,itemType:"collection",infoType:"collection",label:(A==null?void 0:A.label)??t.cogita.library.infoTypes.collection}}:J))},re=A=>{z&&u(ye=>ye.map(J=>J.id===z.id?{...J,data:{...J.data,itemId:(A==null?void 0:A.infoId)??null,itemType:"info",infoType:(A==null?void 0:A.infoType)??null,label:(A==null?void 0:A.label)??t.cogita.library.infoTypes.any}}:J))};return a.useEffect(()=>{if(!z||z.data.nodeType!=="info"||z.data.infoType!=="citation"||!z.data.itemId){ae(null);return}let A=!0;return na({libraryId:i,infoId:z.data.itemId}).then(ye=>{if(!A)return;const J=ye.payload,ge=(J==null?void 0:J.text)??"";if(!ge){ae(null);return}const ee=va(ge),ke=Object.values(ee.nodes).sort((ue,le)=>ue.depth-le.depth||ue.start-le.start).map(ue=>({id:ue.id,text:ue.text,depth:ue.depth}));ae({title:(J==null?void 0:J.title)??z.data.label,fragments:ke})}).catch(()=>ae(null)),()=>{A=!1}},[i,z]),e.jsx(At,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:p,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:xe,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:B,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Q,children:t.cogita.library.actions.addInfo}),C?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(C.totalCollections))})}):null,y?e.jsx("p",{className:"cogita-help",children:y}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(gn,{nodes:c,edges:m,onNodesChange:v,onEdgesChange:_,onConnect:P,onNodeClick:(A,ye)=>g(ye.id),fitView:!0,children:[e.jsx(mn,{gap:18,size:1}),e.jsx(pn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),z?e.jsxs("div",{className:"cogita-graph-inspector",children:[z.data.nodeType==="collection"?e.jsx(Gt,{libraryId:i,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:z.data.itemId?{id:z.data.itemId,label:z.data.label,infoType:"collection"}:null,onChange:Ee,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(Gt,{libraryId:i,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:z.data.itemId?{id:z.data.itemId,label:z.data.label,infoType:z.data.infoType??void 0}:null,onChange:re,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),N?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:N.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:N.fragments.map(A=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:A.id}),e.jsx("span",{children:A.text})]},A.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function Xn({children:t,flashState:n,flashTick:r=0,feedbackToken:s,className:o}){const h=s??(n?`${n}-${r}`:"idle");return e.jsx("section",{className:o?`cogita-revision-card ${o}`:"cogita-revision-card","data-feedback":h,children:t})}function Zn({copy:t,currentCard:n,currentTypeLabel:r,prompt:s,languages:o,answer:h,onAnswerChange:d,computedExpected:w,computedAnswers:f,onComputedAnswerChange:j,answerTemplate:i,outputVariables:p,variableValues:c,computedFieldFeedback:u,feedback:v,canAdvance:m,quoteContext:S,quotePlaceholder:_,onCheckAnswer:x,onSkip:g,onLanguageSelect:C,onMarkReviewed:D,onAdvance:y,showCorrectAnswer:U,setShowCorrectAnswer:N,onRevealCorrect:ae,answerMask:z,expectedAnswer:P,hasExpectedAnswer:B,handleComputedKeyDown:Q,answerInputRef:xe,computedInputRefs:Ee,scriptMode:re,setScriptMode:A,matchPairs:ye,matchLeftOrder:J,matchRightOrder:ge,matchSelection:ee,matchActiveLeft:ke,matchActiveRight:ue,matchFeedback:le,onMatchLeftSelect:Ie,onMatchRightSelect:Ae,disableCheckAnswer:Ke=!1,hideSkipAction:Re=!1,allowRevealBeforeCheck:Ze=!1,autoRevealAfterAnswer:ot=!1,disableCheckAfterAnswer:Te=!1}){const We=a.useMemo(()=>{var W;const L=!i&&w.length===2?`The {${w[0].key}} is of type {${w[1].key}}`:null,K=i??L;if(!K)return null;const R=new Map(w.map(te=>[te.key,te.expected])),k=new Set,T=[],M=/\{([^}]+)\}/g;let oe=0,fe,de=null;for(;(fe=M.exec(K))!==null;){const te=K.slice(oe,fe.index);te&&T.push({type:"text",value:te});const H=((W=fe[1])==null?void 0:W.trim())??"",X=H&&R.has(H)?H:H&&p&&p[H]?p[H]:null;H&&k.add(H),X&&k.add(X),X&&R.has(X)?(T.push({type:"input",value:X}),de||(de=X)):H&&c&&c[H]!==void 0?T.push({type:"text",value:c[H]}):T.push({type:"text",value:fe[0]}),oe=fe.index+fe[0].length}const Y=K.slice(oe);return Y&&T.push({type:"text",value:Y}),w.filter(te=>!k.has(te.key)).length>0?null:{parts:T,expectedByKey:R,firstInputKey:de}},[i,w,p,c]),ft=()=>{if(!We)return null;const{parts:L,expectedByKey:K,firstInputKey:R}=We;return e.jsx("div",{className:"cogita-revision-inline-answer",children:L.map((k,T)=>{var M,oe;return k.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:k.value},`text-${T}`):e.jsx("input",{ref:fe=>{Ee.current[k.value]=fe},autoFocus:k.value===R,value:f[k.value]??"",onChange:fe=>j(k.value,fe.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":u[k.value]??(v==="correct"?"correct":v==="incorrect"?"incorrect":void 0),onKeyDown:fe=>it(fe)||Q(fe),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((M=f[k.value])==null?void 0:M.length)??0,((oe=K.get(k.value))==null?void 0:oe.length)??6)}ch`}},`input-${k.value}-${T}`)})})},Ve=a.useMemo(()=>{const L=new Map;return(ye??[]).forEach(K=>L.set(K.leftId,K)),L},[ye]),ze=a.useMemo(()=>{const L=new Map;return(ye??[]).forEach(K=>L.set(K.rightId,K)),L},[ye]);a.useEffect(()=>{var T;if(n.cardType!=="info"||n.infoType!=="computed"||w.length===0)return;const L=typeof document<"u"?document.activeElement:null;if(L&&(L.tagName==="INPUT"||L.tagName==="TEXTAREA"))return;const K=(We==null?void 0:We.firstInputKey)??((T=w[0])==null?void 0:T.key);if(!K)return;const R=Ee.current[K];if(!R)return;const k=requestAnimationFrame(()=>{R.focus()});return()=>cancelAnimationFrame(k)},[n,w,We]);const et=(()=>{const L=[P??"",...w.map(k=>k.expected??"")].join(""),K=[h,...Object.values(f)].join(""),R=`${L}${K}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(R)})(),it=L=>L.ctrlKey&&(L.key==="^"||L.key==="6")?(L.preventDefault(),A(K=>K==="super"?null:"super"),!0):L.ctrlKey&&(L.key==="_"||L.key==="-")?(L.preventDefault(),A(K=>K==="sub"?null:"sub"),!0):!1,Ge=()=>{if(!P||!z)return P??"";const L=P.split(""),K=Array.from(z),R=K.length>0?K.reduce((k,T)=>k+T,0)/K.length:127;return L.map((k,T)=>{const M=K[T]??R,oe=Math.max(0,Math.min(255,Math.round(M)));let fe=255,de=0;return oe<=127?de=Math.round(oe/127*255):(de=255,fe=Math.round(255*(1-(oe-127)/128))),e.jsx("span",{style:{color:`rgb(${fe}, ${de}, 0)`},children:k},`mask-${T}`)})},Ce=n.cardType==="info"&&n.infoType==="citation"?(S==null?void 0:S.title)||n.label:n.description,Be=U||ot&&v!==null,Ye=Ke||Te&&(v!==null||Be),$=B&&(Ze||v==="incorrect"||Be);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[r?e.jsx("span",{children:r}):null,e.jsx("strong",{children:Ce})]}),n.cardType==="vocab"&&n.checkType==="translation-match"&&ye?e.jsxs("div",{className:"cogita-revision-body",children:[s?e.jsx("h2",{children:s}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(J??[]).map(L=>{const K=Ve.get(L);if(!K)return null;const R=(ee==null?void 0:ee[L])??null,k=(le==null?void 0:le[L])??null,T=ke===L;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":T,"data-state":k??void 0,"data-locked":R?"true":void 0,onClick:()=>Ie==null?void 0:Ie(L),children:[e.jsx("span",{children:K.leftLabel}),R&&U?e.jsx("em",{children:"✓"}):null]},L)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(ge??[]).map(L=>{const K=ze.get(L);if(!K)return null;const R=Object.values(ee??{}).includes(L),k=ue===L;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":R||k,"data-locked":R?"true":void 0,onClick:()=>Ae==null?void 0:Ae(L),children:e.jsx("span",{children:K.rightLabel})},L)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:n.checkType==="translation-match"||Ye,children:t.cogita.library.revision.checkAnswer}),Re?null:e.jsx("button",{type:"button",className:"ghost",onClick:g,children:t.cogita.library.revision.skip})]})]}):n.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:s}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:xe,value:h,onChange:L=>d(L.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:L=>{if(L.key==="Enter")if(L.preventDefault(),L.stopPropagation(),m)y();else{if(Ye)return;x()}}})]}),et?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":re==="super",onClick:()=>A(L=>L==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":re==="sub",onClick:()=>A(L=>L==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:Ye,children:t.cogita.library.revision.checkAnswer}),Re?null:e.jsx("button",{type:"button",className:"ghost",onClick:g,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[n.label?e.jsx("p",{className:"cogita-revision-hint",children:n.label}):null,i?null:e.jsx(yr,{value:s??"",mode:"auto"}),w.length>0?(()=>{const L=ft();return L?e.jsx("div",{className:"cogita-inline-answer-wrap",children:L}):e.jsx("div",{className:"cogita-form-grid",children:w.map((K,R)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:K.key}),e.jsx("textarea",{ref:k=>{Ee.current[K.key]=k},autoFocus:R===0,value:f[K.key]??"",onChange:k=>j(K.key,k.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":u[K.key]??(v==="correct"?"correct":v==="incorrect"?"incorrect":void 0),onKeyDown:k=>it(k)||Q(k)})]},K.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:xe,value:h,onChange:L=>d(L.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:L=>{if(!it(L)&&L.key==="Enter")if(L.preventDefault(),L.stopPropagation(),m)y();else{if(Ye)return;x()}}})]})}),et?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":re==="super",onClick:()=>A(L=>L==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":re==="sub",onClick:()=>A(L=>L==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:Ye,children:t.cogita.library.revision.checkAnswer}),Re?null:e.jsx("button",{type:"button",className:"ghost",onClick:g,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="citation"&&S?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(S.completed)).replace("{total}",String(S.total))}),e.jsx("p",{className:"cogita-quote-text",children:S.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:xe,value:h,onChange:L=>d(L.target.value),placeholder:_??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:L=>{if(L.key==="Enter")if(L.preventDefault(),L.stopPropagation(),m)y();else{if(Ye)return;x()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:S.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:Ye,children:t.cogita.library.revision.checkAnswer}),Re?null:e.jsx("button",{type:"button",className:"ghost",onClick:g,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:s}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:o.length?o.map(L=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>C(L.label),children:L.label},L.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:g,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:s}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:D,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:g,children:t.cogita.library.revision.skip})]})]}),v&&e.jsx("div",{className:"cogita-revision-feedback","data-state":v,children:v==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),$?e.jsxs("div",{className:"cogita-revision-reveal",children:[Be?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>N(L=>{const K=!L;return K&&ae(),K}),children:t.cogita.library.revision.showAnswer}),Be?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),w.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[w.map(L=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:L.key}),e.jsx("span",{children:L.expected})]},L.key)),P?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:P})]}):null]}):e.jsx("p",{children:z?Ge():P})]}):null]}):null,m?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:y,children:t.cogita.library.revision.nextQuestion})}):null]})}const Ls={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},ji=(t,n)=>{const r=Math.max(t.length,n.length,1),s=Math.abs(t.length-n.length);return Math.max(0,1-s/r)},ki=(t,n)=>{const r=new Uint8Array(t.length),s=ji(t,n);for(let o=0;o<t.length;o+=1){const h=t[o]===(n[o]??"")?128:0,d=t.length-1-o,w=n.length-1-o,f=t[d]===(n[w]??"")?127:0,j=Math.round((h+f)*s);r[o]=Math.max(0,Math.min(255,j))}return r},Ni=(t,n)=>t===n||(Ls[t]??[]).includes(n)?!0:(Ls[n]??[]).includes(t),Ga=(t,n,r)=>r?Ni(t,n):t===n,nn=(t,n,r)=>{const s=new Uint8Array(t.length);if(!t.length)return s;const o=(r==null?void 0:r.allowSimilarChars)??!0,h=[];for(let w=0;w<=t.length-3;w+=1)h.push({index:w,text:t.slice(w,w+3)});let d=!1;return h.forEach(w=>{for(let f=0;f<=n.length-3;f+=1){const j=n.slice(f,f+3);let i=0;for(let m=0;m<3;m+=1)Ga(w.text[m],j[m],o)&&(i+=1);if(i<2)continue;let p=w.index-1,c=f-1;for(;p>=0&&c>=0;){const m=t[p],S=n[c];if(m===S){s[p]=Math.max(s[p],255),p-=1,c-=1,d=!0;continue}if(Ga(m,S,o)&&m!==S){s[p]=Math.max(s[p],127),p-=1,c-=1,d=!0;continue}if(p>0&&t[p-1]===S){s[p]=Math.max(s[p],0),p-=1,d=!0;continue}if(c>0&&t[p]===n[c-1]){c-=1,d=!0;continue}break}for(let m=0;m<3;m+=1){const S=w.index+m,_=w.text[m],x=j[m],g=_===x?255:Ga(_,x,o)?127:0;s[S]=Math.max(s[S],g),d=!0}let u=w.index+3,v=f+3;for(;u<t.length&&v<n.length;){const m=t[u],S=n[v];if(m===S){s[u]=Math.max(s[u],255),u+=1,v+=1,d=!0;continue}if(Ga(m,S,o)&&m!==S){s[u]=Math.max(s[u],127),u+=1,v+=1,d=!0;continue}if(u+1<t.length&&t[u+1]===S){s[u]=Math.max(s[u],0),u+=1,d=!0;continue}if(v+1<n.length&&t[u]===n[v+1]){v+=1,d=!0;continue}break}}}),d?s:ki(t,n)},$n=t=>/[\p{L}\p{N}]/u.test(t),As=t=>t.trim().toLowerCase(),xa=(t,n)=>{if(t.length===0)return 100;const r=(n==null?void 0:n.treatSimilarCharsAsSame)??!1,s=Array.from(t).reduce((o,h)=>r&&h===127?o+255:o+h,0);return Math.round(s/(t.length*255)*100)},Sa=(t,n,r)=>{const s=Math.max(0,Math.min(100,(r==null?void 0:r.thresholdPercent)??100)),o=(r==null?void 0:r.treatSimilarCharsAsSame)??!0,h=(r==null?void 0:r.ignorePunctuationAndSpacing)??!1,d=As(t),w=As(n);if(!h){const x=nn(d,w,{allowSimilarChars:o}),g=xa(x,{treatSimilarCharsAsSame:o});return{mask:x,percent:g,isCorrect:g>=s,normalizedExpected:d,normalizedAnswer:w}}const f=Array.from(d),j=Array.from(w),i=[],p=[],c=[];f.forEach((x,g)=>{$n(x)&&(i.push(x),p.push(g))}),j.forEach(x=>{$n(x)&&c.push(x)});const u=i.join(""),v=c.join(""),m=nn(u,v,{allowSimilarChars:o}),S=new Uint8Array(f.length);for(let x=0;x<S.length;x+=1)S[x]=$n(f[x]??"")?0:255;for(let x=0;x<m.length;x+=1){const g=p[x];g!==void 0&&(S[g]=m[x])}const _=xa(m,{treatSimilarCharsAsSame:o});return{mask:S,percent:_,isCorrect:_>=s,normalizedExpected:u,normalizedAnswer:v}},Aa=(t,n,r)=>{const s=t.trim().toLowerCase(),o=n.trim().toLowerCase();return r==="prefix"||r==="bidirectional"?nn(s,o,{allowSimilarChars:!0}):nn(s,o,{allowSimilarChars:!0})};function Si(t){if(!t||typeof t!="object")return null;const r=t.definition;if(!r||typeof r!="object")return null;const s=r,o=typeof s.type=="string"?s.type:typeof s.kind=="string"?s.kind:"selection",h=o==="multi_select"||o==="single_select"?"selection":o==="boolean"?"truefalse":o==="order"?"ordering":o;if(!["selection","truefalse","text","number","date","ordering","matching"].includes(h))return null;const d=h,w=typeof s.title=="string"?s.title:void 0,f=typeof s.question=="string"?s.question:"",j=Array.isArray(s.options)?s.options.map(c=>typeof c=="string"?c:"").filter(Boolean):void 0,i=Array.isArray(s.columns)?s.columns.map(c=>Array.isArray(c)?c.map(u=>typeof u=="string"?u:"").filter(Boolean):[]).filter(c=>c.length>0):void 0,p=(()=>{if(h==="selection")return(Array.isArray(s.answer)?s.answer:Array.isArray(s.correct)?s.correct:[]).map(u=>Number(u)).filter(u=>Number.isInteger(u)&&u>=0);if(h==="truefalse")return typeof s.answer=="boolean"?s.answer:typeof s.expected=="boolean"?s.expected:!1;if(h==="matching"){const c=s.answer&&typeof s.answer=="object"?s.answer:null;return{paths:(Array.isArray(c==null?void 0:c.paths)?c==null?void 0:c.paths:Array.isArray(s.correctPairs)?s.correctPairs:[]).map(m=>Array.isArray(m)?m.map(S=>Number(S)).filter(S=>Number.isInteger(S)&&S>=0):[]).filter(m=>m.length>0)}}if(typeof s.answer=="string"||typeof s.answer=="number")return s.answer;if(typeof s.expected=="string"||typeof s.expected=="number")return s.expected})();return{type:d,title:w,question:f,options:j,columns:i,answer:p}}function Ti(t){var o;if(t.type!=="matching")return[[]];const n=Math.max(2,((o=t.columns)==null?void 0:o.length)??2);return[...((t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[])??[]).map(h=>Array.from({length:n},(d,w)=>String(h[w]??""))),new Array(n).fill("")]}function Ci(t){const n=[...t];for(let r=n.length-1;r>0;r-=1){const s=Math.floor(Math.random()*(r+1));[n[r],n[s]]=[n[s],n[r]]}return n}function ca(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function Rs(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function $s(t){const n=t.checkType??"info",r=n.startsWith("question-")?`question / ${n.slice(9)}`:n;return t.direction?`${r} / ${t.direction}`:r}function Ii({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,libraryId:i,infoId:p,selectedReviewerRoleId:c}){const[u,v]=a.useState(p),[m,S]=a.useState([]),[_,x]=a.useState([]),[g,C]=a.useState("loading"),[D,y]=a.useState(null),[U,N]=a.useState(null),[ae,z]=a.useState(null),[P,B]=a.useState(null),[Q,xe]=a.useState(""),[Ee,re]=a.useState(null),[A,ye]=a.useState(1),[J,ge]=a.useState(null),[ee,ke]=a.useState(0),[ue,le]=a.useState(!1),[Ie,Ae]=a.useState(null),[Ke,Re]=a.useState({}),[Ze,ot]=a.useState({}),[Te]=a.useState({}),[We,ft]=a.useState(null),[Ve,ze]=a.useState({selection:[],booleanAnswer:null,ordering:[],matchingRows:[[]]}),et=a.useRef(null),it=a.useRef({}),Ge=hn();a.useEffect(()=>{let Y=!1;return C("loading"),Promise.all([na({libraryId:i,infoId:p}).catch(()=>null),Za({libraryId:i,infoId:p}),en({libraryId:i,infoId:p})]).then(([E,W,te])=>{if(Y)return;const H=(E==null?void 0:E.payload)??{},X=typeof H.title=="string"&&H.title||typeof H.label=="string"&&H.label||typeof H.name=="string"&&H.name||p;v(X),N(H),z((E==null?void 0:E.infoType)??null),S(W.items),x(te.items),C("ready")}).catch(()=>{Y||(N(null),z(null),S([]),x([]),C("error"))}),()=>{Y=!0}},[i,p]),a.useEffect(()=>{if(ae!=="translation"){B(null);return}Os({libraryId:i,infoId:p,approachKey:"vocab-card"}).then(Y=>B(Y.projection??null)).catch(()=>B(null))},[ae,p,i]);const Ce=a.useMemo(()=>{var be;const Y=new Map(m.map(O=>[ca(O),O])),E=new Map,W=new Map;for(const O of m)E.set(ca(O),0),W.set(ca(O),[]);for(const O of _){const ne=Rs({parentItemId:O.parentItemId,parentCheckType:O.parentCheckType,parentDirection:O.parentDirection}),Le=[O.childItemId,O.childCheckType??"",O.childDirection??""].join("|");!Y.has(ne)||!Y.has(Le)||((be=W.get(ne))==null||be.push(Le),E.set(Le,(E.get(Le)??0)+1))}const te=Array.from(E.entries()).filter(([,O])=>O===0).map(([O])=>O),H=new Map;for(const O of te)H.set(O,0);for(;te.length;){const O=te.shift(),ne=H.get(O)??0;for(const Le of W.get(O)??[]){const qe=Math.max(H.get(Le)??0,ne+1);H.set(Le,qe),E.set(Le,(E.get(Le)??1)-1),(E.get(Le)??0)<=0&&te.push(Le)}}const X=new Map;for(const O of m){const ne=ca(O),Le=H.get(ne)??0,qe=X.get(Le)??[];qe.push(ne),X.set(Le,qe)}return m.map(O=>{const ne=ca(O),Le=H.get(ne)??0,qe=X.get(Le)??[ne],De=Math.max(0,qe.indexOf(ne));return{id:ne,position:{x:40+De*290+(Le%2?18:0),y:30+Le*120},draggable:!1,selectable:!0,data:{label:O.label,subtitle:$s(O),checkType:O.checkType??"info",direction:O.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[m,_]),Be=a.useMemo(()=>new Map(m.map(Y=>[ca(Y),Y])),[m]),Ye=a.useMemo(()=>{const Y=[];for(const E of _){const W=Rs({parentItemId:E.parentItemId,parentCheckType:E.parentCheckType,parentDirection:E.parentDirection}),te=[E.childItemId,E.childCheckType??"",E.childDirection??""].join("|");!Be.has(W)||!Be.has(te)||Y.push({id:`${W}->${te}`,source:W,target:te,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return Y},[Be,_]),$=a.useMemo(()=>D?Be.get(D)??null:null,[Be,D]);a.useEffect(()=>{xe(""),ge(null),ke(0),le(!1),Ae(null),re(null),ot({}),ze({selection:[],booleanAnswer:null,ordering:[],matchingRows:[[]]})},[D]);const L=a.useMemo(()=>{var H,X;if(!$)return null;const Y=ae??$.infoType??null,E=$.checkType??"info",W=$.direction??null,te=U??{};if($.cardType==="vocab"&&P&&Array.isArray(P.words)){const be=P.words,O=((H=be[0])==null?void 0:H.label)??"?",ne=((X=be[1])==null?void 0:X.label)??"?";return W==="a-to-b"?{kind:"vocab",prompt:String(O),expected:String(ne)}:W==="b-to-a"?{kind:"vocab",prompt:String(ne),expected:String(O)}:{kind:"generic",prompt:`${O} ↔ ${ne}`,expected:`${O} ↔ ${ne}`}}if(Y==="citation"&&E==="quote-fragment"&&W&&typeof te.text=="string"){const be=W,O=va(te.text),ne=O.nodes[be];if(ne){const Le=bn(te.text,ne);return{kind:"citation-fragment",expected:ne.text,quoteContext:{title:u,before:Le.before,after:Le.after,total:Object.keys(O.nodes).length,completed:0},quotePlaceholder:ne.text.length>0?".".repeat(Math.max(4,Math.min(18,ne.text.length))):"..."}}}if(Y==="question"){const be=Si(te);if(be)return{kind:"question",definition:be}}return{kind:"generic",prompt:$.description||$.label,expected:$.label}},[ae,U,$,u,P]);a.useEffect(()=>{if(!L||L.kind!=="question")return;const Y=L.definition;ze({selection:[],booleanAnswer:null,ordering:Y.type==="ordering"?Ci(Y.options??[]):[],matchingRows:Y.type==="matching"?Ti(Y):[[]]})},[L,D]);const K=async Y=>{if($&&c)try{await xr({libraryId:i,outcome:{itemType:"info",itemId:$.cardId,checkType:$.checkType??"info",direction:$.direction??null,revisionType:"direct",evalType:"direct-check",correct:Y,clientId:"cogita-info-checkcards",clientSequence:A,personRoleId:c}}),ye(E=>E+1),re(Y?"Saved as correct.":"Saved as incorrect.")}catch{re("Failed to save answer.")}},R=$?ca($):null,k=R?!!Ke[R]:!1,T=async()=>{var te;if(!$||!L)return;const Y=ca($);if(Ke[Y]){re("This card was already checked.");return}let E=!1,W=null;if(L.kind==="question"){const H=L.definition;if(H.type==="selection"){const X=Array.isArray(H.answer)?[...H.answer].sort((O,ne)=>O-ne):[],be=[...Ve.selection].sort((O,ne)=>O-ne);E=X.length===be.length&&X.every((O,ne)=>O===be[ne])}else if(H.type==="truefalse")E=typeof H.answer=="boolean"&&Ve.booleanAnswer!==null&&H.answer===Ve.booleanAnswer;else if(H.type==="ordering"){const X=(H.options??[]).join(`
`),be=Ve.ordering.join(`
`),O=Sa(X,be,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});E=O.isCorrect,W=O.mask}else if(H.type==="matching"){const X=Math.max(2,((te=H.columns)==null?void 0:te.length)??2),be=Ve.matchingRows.map(qe=>qe.slice(0,X).map(De=>De.trim())).filter(qe=>qe.every(De=>De!=="")).map(qe=>qe.map(De=>Number(De))).filter(qe=>qe.every(De=>Number.isInteger(De)&&De>=0)).map(qe=>JSON.stringify(qe)),O=(H.answer&&typeof H.answer=="object"&&"paths"in H.answer?H.answer.paths:[]).map(qe=>JSON.stringify(qe)),ne=Array.from(new Set(be)).sort(),Le=Array.from(new Set(O)).sort();E=ne.length===Le.length&&ne.every((qe,De)=>qe===Le[De])}else{const X=String(H.answer??""),be=Sa(X,Q,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});E=be.isCorrect,W=be.mask}Ae(W),le(!0)}else{const H=L.expected,X=L.kind==="citation-fragment",be=Sa(H,Q,{thresholdPercent:X?90:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:X});E=be.isCorrect,Ae(be.mask),le(!0)}ge(E?"correct":"incorrect"),ke(H=>H+1),re(c?null:"Answer checked locally (not saved: no person selected)."),Re(H=>({...H,[Y]:!0})),c&&await K(E)},M=()=>{if(!$||!L)return;const Y=ca($);if(Ke[Y]||(Re(W=>({...W,[Y]:!0})),re("Answer revealed (not saved).")),L.kind==="question"){Ae(null);return}const E=Sa(L.expected,L.expected,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:L.kind==="citation-fragment"});Ae(E.mask)},oe=a.useMemo(()=>$?$.infoType==="question"?{...$,description:$.label}:$.infoType==="citation"?{...$,description:u}:{...$,description:$.label}:null,[$,u]),fe=Y=>{const E=Y.definition,W=k||ue,te=E.type==="matching"?(()=>{var qe;const be=Math.max(2,((qe=E.columns)==null?void 0:qe.length)??2),ne=(Ve.matchingRows.length?Ve.matchingRows:[new Array(be).fill("")]).map(De=>Array.from({length:be},(Je,pt)=>De[pt]??""));return ne[ne.length-1].some(De=>De.trim())?[...ne,new Array(be).fill("")]:ne})():[],H=Array.isArray(E.answer)?E.answer:[],X=E.answer&&typeof E.answer=="object"&&"paths"in E.answer?E.answer.paths:[];return e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:E.question||($==null?void 0:$.label)}),E.title?e.jsx("p",{className:"cogita-revision-hint",children:E.title}):null,E.type==="selection"?e.jsx("div",{className:"cogita-choice-grid",style:{gridTemplateColumns:"1fr"},children:(E.options??[]).map((be,O)=>e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.6rem"},children:[e.jsx("input",{type:"checkbox",checked:Ve.selection.includes(O),disabled:W,onChange:ne=>ze(Le=>({...Le,selection:ne.target.checked?Array.from(new Set([...Le.selection,O])):Le.selection.filter(qe=>qe!==O)}))}),e.jsx("span",{children:be})]},`q-opt:${O}`))}):null,E.type==="truefalse"?e.jsxs("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:[e.jsx("button",{type:"button",className:"ghost","data-active":Ve.booleanAnswer===!0,disabled:W,onClick:()=>ze(be=>({...be,booleanAnswer:!0})),children:"True"}),e.jsx("button",{type:"button",className:"ghost","data-active":Ve.booleanAnswer===!1,disabled:W,onClick:()=>ze(be=>({...be,booleanAnswer:!1})),children:"False"})]}):null,E.type==="text"||E.type==="number"||E.type==="date"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:et,type:E.type==="date"?"date":"text",value:Q,onChange:be=>xe(be.target.value),disabled:W,"data-state":J==="correct"?"correct":J==="incorrect"?"incorrect":void 0})]}):null,E.type==="ordering"?e.jsx("div",{style:{display:"grid",gap:"0.45rem"},children:Ve.ordering.map((be,O)=>e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)"},children:[O+1,"."]}),e.jsx("span",{children:be}),e.jsx("button",{type:"button",className:"ghost",disabled:W||O===0,onClick:()=>ze(ne=>{const Le=[...ne.ordering];return[Le[O-1],Le[O]]=[Le[O],Le[O-1]],{...ne,ordering:Le}}),children:"Up"}),e.jsx("button",{type:"button",className:"ghost",disabled:W||O>=Ve.ordering.length-1,onClick:()=>ze(ne=>{const Le=[...ne.ordering];return[Le[O+1],Le[O]]=[Le[O],Le[O+1]],{...ne,ordering:Le}}),children:"Down"})]},`q-order:${O}:${be}`))}):null,E.type==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.65rem"},children:[(E.columns??[]).map((be,O)=>e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.35rem",padding:"0.6rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:`Column ${O+1}`}),be.map((ne,Le)=>e.jsx("div",{className:"cogita-library-hint",children:`${Le}: ${ne}`},`q-col:${O}:${Le}`))]},`q-col:${O}`)),e.jsxs("div",{style:{display:"grid",gap:"0.4rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:"Paths (0-based indices)"}),te.map((be,O)=>{var Le;const ne=O===te.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:`repeat(${Math.max(2,((Le=E.columns)==null?void 0:Le.length)??2)}, minmax(0, 1fr)) auto`,gap:"0.35rem",alignItems:"center"},children:[be.map((qe,De)=>e.jsx("input",{type:"number",min:0,step:1,value:qe,disabled:W,onChange:Je=>ze(pt=>{var Ct;const ht=Math.max(2,((Ct=E.columns)==null?void 0:Ct.length)??2),gt=(pt.matchingRows.length?pt.matchingRows:[new Array(ht).fill("")]).map(zt=>Array.from({length:ht},(Rt,kt)=>zt[kt]??""));return gt[O]=gt[O]??new Array(ht).fill(""),gt[O][De]=Je.target.value,gt[gt.length-1].some(zt=>zt.trim())&&gt.push(new Array(ht).fill("")),{...pt,matchingRows:gt}})},`q-path:${O}:${De}`)),ne?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",disabled:W,onClick:()=>ze(qe=>{var ht;const De=Math.max(2,((ht=E.columns)==null?void 0:ht.length)??2),Je=qe.matchingRows.filter((gt,yt)=>yt!==O);return Je.length===0&&Je.push(new Array(De).fill("")),Je[Je.length-1].some(gt=>gt.trim())&&Je.push(new Array(De).fill("")),{...qe,matchingRows:Je}}),children:"Remove"})]},`q-path:${O}`)})]})]}):null,e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>void T(),disabled:W,children:t.cogita.library.revision.checkAnswer})}),ue?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),E.type==="selection"?e.jsx("p",{children:H.length?H.map(be=>{var O;return`${be}${(O=E.options)!=null&&O[be]?`: ${E.options[be]}`:""}`}).join(", "):"-"}):E.type==="truefalse"?e.jsx("p",{children:String(!!E.answer)}):E.type==="ordering"?e.jsx("ol",{children:(E.options??[]).map((be,O)=>e.jsx("li",{children:be},`ans-order:${O}`))}):E.type==="matching"?e.jsx("div",{style:{display:"grid",gap:"0.35rem"},children:X.length?X.map((be,O)=>e.jsx("p",{children:be.join(" → ")},`ans-path:${O}`)):e.jsx("p",{children:"-"})}):e.jsx("p",{children:String(E.answer??"")})]}):e.jsx("div",{className:"cogita-revision-reveal",children:e.jsx("button",{type:"button",className:"ghost",onClick:()=>{le(!0),M()},children:t.cogita.library.revision.showAnswer})})]})},de=a.useMemo(()=>ae?nt(t,ae):t.cogita.library.infoTypes.any,[t,ae]);return e.jsx(At,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:de}),e.jsx("h2",{className:"cogita-card-title",children:u}),e.jsx("p",{className:"cogita-card-subtitle",children:p})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${m.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${_.length}`}),e.jsx("button",{type:"button",className:"cta",disabled:m.length===0,onClick:()=>Ge(`/cogita/library/${i}/revision/run?libraryTarget=revisions&scope=info&infoId=${encodeURIComponent(p)}`),children:"Start revision"})]})]}),g==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):g==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(gn,{nodes:Ce,edges:Ye,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:(Y,E)=>y(E.id),panOnDrag:!0,children:[e.jsx(mn,{}),e.jsx(pn,{showInteractive:!1})]})}),$?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[L&&oe?e.jsx(Xn,{flashState:J,flashTick:ee,children:L.kind==="question"?fe(L):e.jsx(Zn,{copy:t,currentCard:oe,currentTypeLabel:"",prompt:L.kind==="citation-fragment"?null:L.prompt,languages:[],answer:Q,onAnswerChange:xe,computedExpected:[],computedAnswers:Ze,onComputedAnswerChange:(Y,E)=>ot(W=>({...W,[Y]:E})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:Te,feedback:J,canAdvance:!1,quoteContext:L.kind==="citation-fragment"?L.quoteContext:null,quotePlaceholder:L.kind==="citation-fragment"?L.quotePlaceholder:null,onCheckAnswer:()=>void T(),onSkip:()=>y(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:ue,setShowCorrectAnswer:le,onRevealCorrect:M,answerMask:Ie,expectedAnswer:L.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:et,computedInputRefs:it,scriptMode:We,setScriptMode:ft,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:k||ue,hideSkipAction:!0,allowRevealBeforeCheck:!0,autoRevealAfterAnswer:!0,disableCheckAfterAnswer:!0})}):null,c?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),Ee?e.jsx("p",{className:"cogita-library-hint",children:Ee}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:m.map(Y=>{const E=ca(Y),W=D===E;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${W?"active":""}`,onClick:()=>y(E),children:[e.jsx("span",{children:Y.label}),e.jsx("small",{children:$s(Y)})]},E)})})]})]})]})})})})})}function Ya(t,n){var r,s;return((s=(r=t.fields.find(o=>o.fieldType===n))==null?void 0:r.plainValue)==null?void 0:s.trim())??""}function Mi(t){return Ya(t,"role_kind").toLowerCase()==="person"}function Li(t){return Ya(t,"label")||Ya(t,"display_name")||Ya(t,"name")||t.roleId}function Ai({copy:t,onPersonCreated:n}){const[r,s]=a.useState([]),[o,h]=a.useState("loading"),[d,w]=a.useState(null),[f,j]=a.useState(!1),[i,p]=a.useState(""),c=async()=>{h("loading");try{const m=await qs();s(m),h("ready")}catch{s([]),h("error")}};a.useEffect(()=>{c()},[]);const u=a.useMemo(()=>r.filter(Mi).map(m=>({roleId:m.roleId,label:Li(m)})).sort((m,S)=>m.label.localeCompare(S.label)),[r]),v=async()=>{const m=i.trim();if(!m){w("Name is required.");return}j(!0),w(null);try{const S=await vr({fields:[{fieldType:"nick",plainValue:m},{fieldType:"role_kind",plainValue:"person"},{fieldType:"label",plainValue:m},{fieldType:"display_name",plainValue:m}]});p(""),w("Person role created."),n==null||n(S.roleId),await c()}catch{w("Failed to create person role.")}finally{j(!1)}};return e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-browser-panel",children:[e.jsx("div",{className:"cogita-info-overview-head",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Cogita"}),e.jsx("h2",{className:"cogita-card-title",children:"Persons"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Select reviewer persons in the header and create new person roles here."})]})}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Create"}),e.jsx("h3",{className:"cogita-detail-title",children:"New person role"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{type:"text",value:i,onChange:m=>p(m.target.value),placeholder:"e.g. Anna Kowalska",disabled:f})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:f,children:f?"Creating...":"Create person"})}),d?e.jsx("p",{className:"cogita-library-hint",children:d}):null]})]}),e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Overview"}),e.jsx("h3",{className:"cogita-detail-title",children:"All person roles"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[o==="loading"?e.jsx("p",{children:"Loading persons..."}):null,o==="error"?e.jsx("p",{children:"Failed to load persons."}):null,o==="ready"&&u.length===0?e.jsx("p",{children:"No person roles found."}):null,o==="ready"&&u.length>0?e.jsxs("div",{className:"cogita-details-grid",children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:"Name"}),e.jsx("span",{children:"Type"}),e.jsx("span",{children:"Role ID"}),e.jsx("span",{})]}),u.map(m=>e.jsxs("div",{className:"cogita-details-row",role:"row",children:[e.jsx("span",{}),e.jsx("span",{title:m.label,children:m.label}),e.jsx("span",{children:"person"}),e.jsx("span",{title:m.roleId,children:m.roleId}),e.jsx("span",{})]},m.roleId))]}):null]})]})]})]})})})})}function Ri({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,libraryId:i,collectionId:p}){const{libraryName:c}=ga(i),[u,v]=a.useState([]),[m,S]=a.useState("loading"),[_,x]=a.useState("idle"),g=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),C=`/#/cogita/library/${i}`,D=()=>{S("loading"),Us({libraryId:i}).then(N=>{v(N),S("idle")}).catch(()=>{v([]),S("error")})};a.useEffect(()=>{D()},[i]);const y=async N=>{try{await Js({libraryId:i,shareId:N}),D()}catch{D()}},U=async N=>{const ae=`${g}/${N}`;try{await navigator.clipboard.writeText(ae),x("copied")}catch{x("failed")}};return e.jsx(At,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:C,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${C}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[m==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):m==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):u.filter(N=>!p||N.collectionId===p).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:u.filter(N=>!p||N.collectionId===p).map(N=>e.jsxs("div",{className:"cogita-share-row","data-state":N.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:N.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(N.createdUtc).toLocaleString(),N.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),N.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${g}/${N.shareCode}`}):null]}),N.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[N.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>U(N.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>y(N.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},N.shareId))}),_==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):_==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function $i({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,libraryId:i}){const{libraryName:p}=ga(i),[c,u]=a.useState(null),[v,m]=a.useState(null),[S,_]=a.useState(null),[x,g]=a.useState(null),[C,D]=a.useState(null),[y,U]=a.useState(null),N=a.useRef(null),ae=B=>{if(!Number.isFinite(B))return"0 B";if(B<1024)return`${B} B`;const Q=B/1024;if(Q<1024)return`${Q.toFixed(1)} KB`;const xe=Q/1024;return xe<1024?`${xe.toFixed(1)} MB`:`${(xe/1024).toFixed(1)} GB`},z=async()=>{u(null),D({loadedBytes:0,totalBytes:null,percent:null});try{u(t.cogita.library.overview.exporting);const B=await wr(i,D),Q=URL.createObjectURL(B),xe=document.createElement("a");xe.href=Q,xe.download=`cogita-library-${p||i}.json`,xe.click(),URL.revokeObjectURL(Q),u(t.cogita.library.overview.exportReady)}catch{u(t.cogita.library.overview.exportFail)}finally{D(B=>B??{loadedBytes:0,totalBytes:null,percent:null})}},P=async B=>{var xe;m(null),_(null),g(null);const Q=(xe=B.target.files)==null?void 0:xe[0];if(Q)try{m(t.cogita.library.overview.importing),U({loadedBytes:0,totalBytes:Q.size,percent:0});const Ee=await jr(i,Q,U,re=>{const A=re.stage==="infos"?t.cogita.library.overview.importStageInfos:re.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;g(t.cogita.library.overview.importLiveProgress.replace("{stage}",A).replace("{done}",String(re.processed)).replace("{total}",String(re.total)).replace("{infos}",String(re.infos)).replace("{connections}",String(re.connections)).replace("{collections}",String(re.collections)))});_({infos:Ee.infosImported,connections:Ee.connectionsImported,collections:Ee.collectionsImported}),m(t.cogita.library.overview.importDone)}catch(Ee){const re=Ee instanceof Vs&&Ee.message?` ${Ee.message}`:"";m(`${t.cogita.library.overview.importFail}${re}`)}finally{N.current&&(N.current.value="")}};return e.jsx(At,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:z,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:N,type:"file",accept:"application/json",onChange:P})]})]}),C?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:C.percent??void 0,max:C.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",ae(C.loadedBytes)).replace("{total}",C.totalBytes?ae(C.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,y?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:y.percent??void 0,max:y.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",ae(y.loadedBytes)).replace("{total}",y.totalBytes?ae(y.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,c?e.jsx("p",{className:"cogita-help",children:c}):null,v?e.jsx("p",{className:"cogita-help",children:v}):null,x?e.jsx("p",{className:"cogita-help",children:x}):null,S?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(S.infos)).replace("{connections}",String(S.connections)).replace("{collections}",String(S.collections))}):null]})]})})})]})})}function Pi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,libraryId:i}){const{libraryName:p}=ga(i),[c,u]=a.useState(""),[v,m]=a.useState([]),S=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(At,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:c,onChange:_=>u(_.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const _=c.trim();_&&(m(x=>[{id:S(),name:_},...x]),u(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[v.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,v.map(_=>e.jsx("button",{type:"button",className:"ghost",children:_.name},_.id))]})]})]})})})]})})}function Ei({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,libraryId:i}){const{libraryName:p}=ga(i),[c,u]=a.useState(""),[v,m]=a.useState([]),S=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(At,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:c,onChange:_=>u(_.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const _=c.trim();_&&(m(x=>[{id:S(),name:_},...x]),u(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[v.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,v.map(_=>e.jsx("button",{type:"button",className:"ghost",children:_.name},_.id))]})]})]})})})]})})}function Ki({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,libraryId:i}){const{libraryName:p}=ga(i),c=`/#/cogita/library/${i}`,[u,v]=a.useState(""),[m,S]=a.useState([]),[_,x]=a.useState("idle"),[g,C]=a.useState(0),[D,y]=a.useState(null);a.useEffect(()=>{x("loading");const N=window.setTimeout(()=>{Ba({libraryId:i,query:u.trim()||void 0,limit:30}).then(ae=>{S(ae.items),C(ae.total),y(ae.nextCursor??null),x("ready")}).catch(()=>{S([]),C(0),y(null),x("ready")})},240);return()=>window.clearTimeout(N)},[i,u]);const U=async()=>{if(D){x("loading");try{const N=await Ba({libraryId:i,query:u.trim()||void 0,limit:30,cursor:D});S(ae=>[...ae,...N.items]),y(N.nextCursor??null),C(N.total),x("ready")}catch{x("ready")}}};return e.jsx(At,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:c,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${c}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:u,onChange:N=>v(N.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(m.length)).replace("{total}",String(g||m.length))}),e.jsx("span",{children:_==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:m.length?m.map(N=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${c}/collections/${N.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:N.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(N.itemCount))," ·"," ",N.notes||t.cogita.library.collections.noNotes]})]})},N.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${c}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),D?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:U,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const Ne=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,Xt=(t,n,r,s)=>`${t}:${n}:${r??""}:${s??""}`;function Fi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,libraryId:i,collectionId:p}){ga(i);const c=`/#/cogita/library/${i}`,[u,v]=a.useState(t.cogita.library.collections.defaultName),[m,S]=a.useState(null),[_,x]=a.useState(0),[g,C]=a.useState([]),[D,y]=a.useState("idle"),[U,N]=a.useState(null),ae=a.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(g.length)).replace("{total}",String(_||g.length)),[t,g.length,_]);a.useEffect(()=>{fn(i,p).then(P=>{v(P.name),S(P.notes??null),x(P.itemCount)}).catch(()=>{v(t.cogita.library.collections.defaultName),S(null)})},[i,p]),a.useEffect(()=>{y("loading"),Oa({libraryId:i,collectionId:p,limit:40}).then(P=>{C(P.items),N(P.nextCursor??null),x(P.total),y("ready")}).catch(()=>{C([]),N(null),y("ready")})},[i,p]);const z=async()=>{if(U){y("loading");try{const P=await Oa({libraryId:i,collectionId:p,limit:40,cursor:U});C(B=>[...B,...P.items]),N(P.nextCursor??null),x(P.total),y("ready")}catch{y("ready")}}};return e.jsx(At,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:u}),e.jsx("p",{className:"cogita-library-subtitle",children:m||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:c,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${c}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${c}/collections/${p}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${c}/collections/${p}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:ae}),e.jsx("span",{children:D==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:g.length?g.map(P=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:P.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:P.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:P.label}),e.jsx("p",{className:"cogita-card-subtitle",children:P.description})]})},Ne(P))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),U?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:z,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${c}/collections/${p}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const Ps=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],Di={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},_i=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],zi=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function Bi({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,libraryId:i,onCreated:p}){const c=qa(),{libraryName:u}=ga(i),v=`/#/cogita/library/${i}`,[m,S]=a.useState(null),[_,x]=a.useState(""),[g,C]=a.useState(""),[D,y,U]=Un([]),[N,ae,z]=Jn([]),[P,B]=a.useState(null),[Q,xe]=a.useState(null),Ee=a.useRef(null),re=a.useMemo(()=>D.find(ee=>ee.id===P)??null,[D,P]);a.useEffect(()=>{const ee=new URLSearchParams(c.search),ke=(ee.get("draft")??"").trim(),ue=(ee.get("draftType")??"").trim();if(!ke||ue!=="info-selection"||Ee.current===ke)return;const le=oi(i,ke);if(!le||le.infoIds.length===0)return;const Ie=crypto.randomUUID(),Ae=le.infoIds.length>1?crypto.randomUUID():null,Ke=le.infoIds.map((Te,We)=>({id:crypto.randomUUID(),type:"default",position:{x:80,y:80+We*100},data:{nodeType:"source.info",label:"Selected info",params:{infoId:Te,infoType:"any"}}})),Re=Ae?[{id:Ae,type:"default",position:{x:360,y:120+Math.max(0,(le.infoIds.length-1)*50)},data:{nodeType:"logic.or",label:"Selected infos",params:{}}}]:[],Ze={id:Ie,type:"default",position:{x:660,y:140+Math.max(0,(le.infoIds.length-1)*35)},data:{nodeType:"output.collection",label:"Collection output",params:{}}},ot=Ke.map(Te=>({id:crypto.randomUUID(),source:Te.id,target:Ae??Ie}));Ae&&ot.push({id:crypto.randomUUID(),source:Ae,target:Ie}),y([...Ke,...Re,Ze]),ae(ot),B(Ie),xe(`Draft loaded from ${le.infoIds.length} selected infos. Set name and save to create collection.`),Ee.current=ke},[i,c.search,ae,y]);const A=ee=>{var Ie;const ke=crypto.randomUUID(),ue=((Ie=Ps.find(Ae=>Ae.type===ee))==null?void 0:Ie.label)??ee,le={...Di[ee]};y(Ae=>[...Ae,{id:ke,type:"default",position:{x:120+Ae.length*40,y:120+Ae.length*40},data:{nodeType:ee,label:ue,params:le}}]),B(ke)},ye=a.useCallback(ee=>{ae(ke=>Hn({...ee,id:crypto.randomUUID()},ke))},[ae]),J=ee=>{re&&y(ke=>ke.map(ue=>ue.id===re.id?{...ue,data:{...ue.data,params:ee}}:ue))},ge=async()=>{if(xe(null),!_.trim()){xe(t.cogita.library.collections.saveRequiredName);return}try{const ee={nodes:D.map(le=>({nodeId:le.id,nodeType:le.data.nodeType,payload:{position:le.position,params:le.data.params}})),edges:N.map(le=>({edgeId:le.id,fromNodeId:le.source,fromPort:le.sourceHandle??null,toNodeId:le.target,toPort:le.targetHandle??null}))};let ke=m,ue=!1;if(ke)await Hs({libraryId:i,collectionId:ke,nodes:ee.nodes,edges:ee.edges});else{const le=await kr({libraryId:i,name:_.trim(),notes:g.trim()||void 0,items:[],graph:ee});ke=le.collectionId,ue=!0,S(le.collectionId)}xe(ue?t.cogita.library.collections.saveSuccess:t.cogita.library.graph.saveSuccess),p(ke)}catch{xe(m?t.cogita.library.graph.saveFail:t.cogita.library.collections.saveFail)}};return e.jsx(At,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.createKicker}),e.jsx("h1",{className:"cogita-library-title",children:u}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.createSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${v}/collections`,children:t.cogita.library.actions.collections}),e.jsx("button",{type:"button",className:"cta",onClick:ge,children:t.cogita.library.actions.saveCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.collectionInfoTitle}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{value:_,onChange:ee=>x(ee.target.value),placeholder:t.cogita.library.collections.namePlaceholder})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.notesLabel}),e.jsx("textarea",{value:g,onChange:ee=>C(ee.target.value),placeholder:t.cogita.library.collections.notesPlaceholder})]}),Q?e.jsx("p",{className:"cogita-help",children:Q}):null,e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Ps.map(ee=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>A(ee.type),children:ee.label},ee.type))})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(gn,{nodes:D,edges:N,onNodesChange:U,onEdgesChange:z,onConnect:ye,onNodeClick:(ee,ke)=>B(ke.id),fitView:!0,children:[e.jsx(mn,{color:"rgba(120,160,200,0.2)"}),e.jsx(pn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),re?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:re.data.label}),re.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Gt,{libraryId:i,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:re.data.params.tagId?{id:re.data.params.tagId,label:re.data.params.tagLabel??"",infoType:"topic"}:null,onChange:ee=>J({...re.data.params,tagId:(ee==null?void 0:ee.id)??null,tagLabel:(ee==null?void 0:ee.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:re.data.params.scope??"any",onChange:ee=>J({...re.data.params,scope:ee.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),re.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Gt,{libraryId:i,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:re.data.params.languageId?{id:re.data.params.languageId,label:re.data.params.languageLabel??"",infoType:"language"}:null,onChange:ee=>J({...re.data.params,languageId:(ee==null?void 0:ee.id)??null,languageLabel:(ee==null?void 0:ee.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:re.data.params.scope??"any",onChange:ee=>J({...re.data.params,scope:ee.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),re.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:re.data.params.infoType??"word",onChange:ee=>J({...re.data.params,infoType:ee.target.value}),children:zi.map(ee=>e.jsx("option",{value:ee.value,children:ee.label},ee.value))})]}),e.jsx(Gt,{libraryId:i,infoType:re.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:re.data.params.infoId?{id:re.data.params.infoId,label:re.data.params.infoLabel??"",infoType:re.data.params.infoType??"word"}:null,onChange:ee=>J({...re.data.params,infoId:(ee==null?void 0:ee.id)??null,infoLabel:(ee==null?void 0:ee.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),re.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:re.data.params.connectionType??"translation",onChange:ee=>J({...re.data.params,connectionType:ee.target.value}),children:_i.map(ee=>e.jsx("option",{value:ee.value,children:ee.label},ee.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:re.data.params.connectionId??"",onChange:ee=>J({...re.data.params,connectionId:ee.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(re.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const ua=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const n=t.length,r=t.filter(h=>h.correct).length,s=yn(es(t));return{score:Math.round(Math.max(0,Math.min(100,s.knowness*100))*100)/100,total:n,correct:r,lastReviewedUtc:s.lastReviewedUtc??null}},Oi=t=>{if(t.maskBase64)try{const n=Nr(t.maskBase64);if(!n.length)return t.correct?1:0;const r=n.reduce((s,o)=>s+o,0);return Math.max(0,Math.min(1,r/n.length/255))}catch{return t.correct?1:0}return t.correct?1:0},es=t=>t.map(n=>({correctness:Oi(n),createdUtc:n.createdUtc})),yn=(t,n=Date.now())=>{var _;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const s=t.slice().sort((x,g)=>x.createdUtc.localeCompare(g.createdUtc)).slice(-5),o=s.reduce((x,g)=>x+g.correctness,0)/s.length,h=5,d=2,w=.15;let f=0,j=0;for(let x=0;x<s.length;x+=1){const g=new Date(s[x].createdUtc).getTime(),C=x===s.length-1?n:new Date(s[x+1].createdUtc).getTime(),D=Math.max(0,(C-g)/(1e3*60)),y=1-Math.exp(-D/h);f+=y,s[x].correctness>.5&&(j+=w)}let i=o*f*d+j;const p=((_=s[s.length-1])==null?void 0:_.createdUtc)??null,c=p?Math.max(0,(n-new Date(p).getTime())/(1e3*60)):0,v=1/(1+Math.log1p(c/60));return i*=v,s.length===1&&s[0].correctness>.5&&(i+=5.44*Math.exp(-c/2)),{knowness:i,avgCorrectness:o,lastReviewedUtc:p}},Va=t=>{const n=t.slice();for(let r=n.length-1;r>0;r-=1){const s=Math.floor(Math.random()*(r+1));[n[r],n[s]]=[n[s],n[r]]}return n},Xa=t=>t[Math.floor(Math.random()*t.length)],Vi=(t,n)=>{const r=new Map;return t.forEach(s=>r.set(s,Math.random())),t.sort((s,o)=>{const h=n(s)-n(o);return h!==0?h:(r.get(s)??0)-(r.get(o)??0)})},xn=(t,n,r,s,o)=>{if(!t.length)return null;const h=t.filter(w=>!(o!=null&&o.has(Ne(w))));if(h.length===0)return null;const d=h.filter(w=>Ne(w)!==r);return Xa(d.length?d:h)},qi=(t,n,r,s,o)=>{if(!t.length)return null;let h=Number.POSITIVE_INFINITY;for(const j of t){const i=Ne(j);if(r.has(i))continue;const p=n[i]??1;p<h&&(h=p)}if(!Number.isFinite(h))return null;const d=t.filter(j=>{const i=Ne(j);return!r.has(i)&&(n[i]??1)===h}),w=d.filter(j=>!o||Ne(j)!==o),f=s?w.filter(j=>!s.has(Ne(j))):w;return f.length>0?Xa(f):w.length>0?Xa(w):o&&d.some(j=>Ne(j)===o)?d.find(j=>Ne(j)===o)??null:d.length?Xa(d):null},Zs=(t,n,r,s,o)=>{const h=[],d=t.filter(f=>!o.has(Ne(f))&&!r.has(Ne(f))&&(n[Ne(f)]??0)<1),w=Vi(d,f=>n[Ne(f)]??0);for(const f of w){if(h.length>=s)break;h.push(f),o.add(Ne(f))}if(h.length<s){const f=Va(t.filter(j=>!o.has(Ne(j))&&r.has(Ne(j))));for(const j of f){if(h.length>=s)break;h.push(j),o.add(Ne(j))}}return h},Ui=(t,n,r,s)=>Zs(t,n,r,s,new Set),ts=(t,n,r,s,o,h)=>{const d=Math.max(1,r.stackSize??n),f=Va(t).filter((v,m,S)=>S.findIndex(_=>Ne(_)===Ne(v))===m),j=Ui(f,s,o,d),i=new Set,p=new Set,c=xn(j,{},null,i,p),u=c?[c]:[];return c&&p.add(Ne(c)),{queue:u,meta:{pool:f,active:j,knownessMap:s,unknownSet:o,outcomesById:h,asked:i,queued:p}}},qn={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,n)=>{const s=Va(t).filter((o,h,d)=>d.findIndex(w=>Ne(w)===Ne(o))===h);return{queue:s.slice(0,Math.min(n,s.length)),meta:{}}},applyOutcome:t=>t},as=(t,n,r,s)=>{const o=Math.max(1,r.stackSize??n),d=Va(t).filter((m,S,_)=>_.findIndex(x=>Ne(x)===Ne(m))===S),w={},f=new Set,j=new Set,i=new Set,p=Math.max(1,r.levels??1);d.forEach(m=>{const S=Ne(m),_=s==null?void 0:s[S],x=typeof _=="number"&&Number.isFinite(_)?_:1;w[S]=Math.min(p,Math.max(1,Math.round(x)))});const c=[];if(d.length>0){const m=new Map;d.forEach(_=>{var g;const x=w[Ne(_)]??1;m.has(x)||m.set(x,[]),(g=m.get(x))==null||g.push(_)});const S=Array.from(m.keys()).sort((_,x)=>_-x);for(const _ of S){if(c.length>=o)break;const x=Va(m.get(_)??[]);for(const g of x){if(c.length>=o)break;c.push(g)}}}const u=xn(c,w,null,f,j),v=u?[u]:[];return u&&j.add(Ne(u)),{queue:v,meta:{pool:d,active:c,levelMap:w,asked:f,queued:j,wrongSinceCorrect:i}}},Ji={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,r)=>as(t,n,r),applyOutcome:(t,n,r,s,o)=>{if(!n)return t;const h=Math.max(1,s.levels??1),d=t.meta.pool??[],w=t.meta.active??[],f={...t.meta.levelMap??{}},j=new Set(t.meta.asked??[]),i=new Set(t.meta.queued??[]),p=new Set(t.meta.wrongSinceCorrect??[]),c=Ne(n);i.delete(c),j.add(c);const u=f[c]??1;o.correct?(f[c]=p.has(c)?1:Math.min(u+1,h),p.delete(c)):(f[c]=1,p.add(c));const v=o.correct?w.filter(_=>Ne(_)!==c):w.slice();if(o.correct&&v.length<Math.max(1,s.stackSize??1)){const _=new Set(v.map(g=>Ne(g))),x=qi(d,f,_,j,c);x&&v.push(x)}const m=t.queue.slice(),S=xn(v,f,c,j,i);return S&&(m.push(S),i.add(Ne(S))),{queue:m,meta:{pool:d,active:v,levelMap:f,asked:j,queued:i,wrongSinceCorrect:p}}}},Hi={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,r)=>ts(t,n,r,{},new Set,{}),applyOutcome:(t,n,r,s,o)=>{if(!n)return t;const h=t.meta.pool??[],d=t.meta.active??[],w={...t.meta.knownessMap??{}},f=new Set(t.meta.unknownSet??[]),j={...t.meta.outcomesById??{}},i=new Set(t.meta.asked??[]),p=new Set(t.meta.queued??[]),c=Ne(n);p.delete(c),i.add(c);const u={correctness:Math.max(0,Math.min(1,o.correctness??(o.correct?1:0))),createdUtc:o.createdUtc??new Date().toISOString()},m=(j[c]??[]).concat(u).sort((D,y)=>D.createdUtc.localeCompare(y.createdUtc)).slice(-5);j[c]=m,f.delete(c);const S=Date.now();h.forEach(D=>{const y=Ne(D),U=j[y]??[];if(U.length===0){w[y]=0,f.add(y);return}const N=yn(U,S);w[y]=N.knowness});const _=d.slice();if((w[c]??0)>=1){const D=_.filter(y=>Ne(y)!==c);_.length=0,_.push(...D)}const g=Math.max(1,s.stackSize??r);if(_.length<g){const D=new Set(_.map(U=>Ne(U))),y=Zs(h,w,f,g-_.length,D);_.push(...y)}const C=t.queue.slice();if(C.length===0||Ne(C[C.length-1])===c){const D=xn(_,{},c,i,p);D&&(C.push(D),p.add(Ne(D)))}return{queue:C,meta:{pool:h,active:_,knownessMap:w,unknownSet:f,outcomesById:j,asked:i,queued:p}}}},er={random:qn,levels:Ji,temporal:Hi},Wi=Object.values(er),ns=t=>{if(!t)return qn;const n=t.trim().toLowerCase();return n==="random"||n==="levels"||n==="temporal"?er[n]:qn},vn=(t,n)=>{const r={...t.defaultSettings};return n&&Object.entries(n).forEach(([s,o])=>{typeof o=="number"&&Number.isFinite(o)&&(r[s]=o),typeof o=="string"&&(r[s]=o)}),t.settingsFields.forEach(s=>{var h;const o=r[s.key];if(s.type==="number"){if(typeof o!="number"||Number.isNaN(o)){r[s.key]=t.defaultSettings[s.key]??0;return}s.min!==void 0&&(r[s.key]=Math.max(s.min,r[s.key])),s.max!==void 0&&(r[s.key]=Math.min(s.max,r[s.key]));return}if(s.type==="select"){const d=((h=s.options)==null?void 0:h.map(w=>w.value))??[];(typeof o!="string"||d.length>0&&!d.includes(o))&&(r[s.key]=t.defaultSettings[s.key]??d[0]??"")}}),r},tr=(t,n)=>{const r={};return t.settingsFields.forEach(s=>{const o=n.get(s.key);if(o){if(s.type==="number"){const h=Number(o);Number.isNaN(h)||(r[s.key]=h);return}r[s.key]=o}}),vn(t,r)},Qi=(t,n)=>{const r=new URLSearchParams;return t.settingsFields.forEach(s=>{const o=n[s.key];(typeof o=="number"||typeof o=="string")&&r.set(s.key,String(o))}),r};function Es({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,libraryId:i,collectionId:p,revisionId:c}){const u=hn(),{libraryName:v}=ga(i),m=`/#/cogita/library/${i}`,[S,_]=a.useState(t.cogita.library.collections.defaultName),[x,g]=a.useState([]),[C,D]=a.useState(p??""),[y,U]=a.useState(""),[N,ae]=a.useState(20),[z,P]=a.useState("random"),[B,Q]=a.useState({}),[xe,Ee]=a.useState("exact"),[re,A]=a.useState([]),[ye,J]=a.useState(null),[ge,ee]=a.useState([]),[ke,ue]=a.useState([]),[le,Ie]=a.useState(""),[Ae,Ke]=a.useState("idle"),[Re,Ze]=a.useState(null),[ot,Te]=a.useState("idle"),[We,ft]=a.useState("idle"),[Ve,ze]=a.useState("idle"),et=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),it=a.useMemo(()=>ns(z),[z]),Ge=a.useMemo(()=>vn(it,B),[it,B]),Ce=a.useMemo(()=>Qi(it,Ge).toString(),[it,Ge]),Be=a.useMemo(()=>{const k=le.trim().toLocaleLowerCase();return k?ke.filter(T=>T.name.toLocaleLowerCase().includes(k)):ke},[le,ke]);a.useEffect(()=>{D(p??"")},[p]),a.useEffect(()=>{if(!C){_(t.cogita.library.collections.defaultName);return}fn(i,C).then(k=>_(k.name)).catch(()=>_(t.cogita.library.collections.defaultName))},[t.cogita.library.collections.defaultName,i,C]),a.useEffect(()=>{Ba({libraryId:i,limit:200}).then(k=>g(k.items.map(T=>({collectionId:T.collectionId,name:T.name})))).catch(()=>g([]))},[i]),a.useEffect(()=>{Wn({libraryId:i}).then(k=>ue(k)).catch(()=>ue([]))},[i]),a.useEffect(()=>{c&&Yn({libraryId:i,revisionId:c}).then(k=>{D(k.collectionId),U(k.name),P(k.mode||"random"),Ee(k.check||"exact"),ae(k.limit||20),Q(k.revisionSettings??{})}).catch(()=>{U("")})},[i,c]),a.useEffect(()=>{Ws({libraryId:i}).then(k=>{A(k),!ye&&k.length>0&&J(k[0].roleId)}).catch(()=>{A([])})},[i]);const Ye=()=>{ft("loading"),Us({libraryId:i}).then(k=>{ee(k),ft("idle")}).catch(()=>{ee([]),ft("error")})};a.useEffect(()=>{Ye()},[i]);const $=async()=>{Ke("working"),Te("idle");try{if(!C){Ke("error");return}const k=await Tr({libraryId:i,collectionId:C,revisionType:it.id,revisionSettings:Ge,mode:z,check:xe,limit:N});Ze(`${et}/${k.shareCode}${Ce?`?${Ce}`:""}`),Ke("ready"),Ye()}catch{Ke("error")}},L=async()=>{if(c){ze("saving");try{await Sr({libraryId:i,collectionId:p??C,revisionId:c,targetCollectionId:C,name:y||S,revisionType:it.id,revisionSettings:Ge,mode:z,check:xe,limit:N}),ze("saved"),C&&u(`/cogita/library/${i}/revisions/${encodeURIComponent(c)}`,{replace:!0})}catch{ze("error")}}},K=async()=>{if(Re)try{await navigator.clipboard.writeText(Re),Te("copied")}catch{Te("failed")}},R=async k=>{try{await Js({libraryId:i,shareId:k}),Ye()}catch{Ye()}};return e.jsx(At,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:S}),e.jsx("p",{className:"cogita-library-subtitle",children:v})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:m,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${m}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:C?`${m}/collections/${C}`:`${m}/collections`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${m}${c?`/revisions/${encodeURIComponent(c)}/run`:C?`/collections/${C}/revision/run`:"/revision/run"}?mode=${encodeURIComponent(z)}&check=${encodeURIComponent(xe)}&limit=${N}${Ce?`&${Ce}`:""}${ye?`&reviewer=${encodeURIComponent(ye)}`:""}${c?`&revisionId=${encodeURIComponent(c)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:le,onChange:k=>Ie(k.target.value),placeholder:t.cogita.workspace.revisionForm.namePlaceholder})}),e.jsxs("div",{className:"cogita-card-list","data-view":"list",children:[e.jsxs("a",{className:"cogita-card-select",href:`${m}/revisions/new`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:t.cogita.workspace.revisionForm.createAction})]}),Be.map(k=>e.jsxs("a",{className:"cogita-card-select",href:`${m}/revisions/${encodeURIComponent(k.revisionId)}`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:k.name})]},k.revisionId))]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsx("select",{value:C,onChange:k=>D(k.target.value),children:x.map(k=>e.jsx("option",{value:k.collectionId,children:k.name},k.collectionId))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:y,onChange:k=>U(k.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:z,onChange:k=>P(k.target.value),children:Wi.map(k=>e.jsx("option",{value:k.id,children:t.cogita.library.revision[k.labelKey]},k.id))})]}),it.settingsFields.map(k=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[k.labelKey]}),k.type==="select"?e.jsx("select",{value:String(Ge[k.key]??""),onChange:T=>Q(M=>({...M,[k.key]:T.target.value})),children:(k.options??[]).map(T=>e.jsx("option",{value:T.value,children:t.cogita.library.revision[T.labelKey]},T.value))}):e.jsx("input",{type:"number",min:k.min,max:k.max,step:k.step,value:Ge[k.key]??0,onChange:T=>Q(M=>({...M,[k.key]:Number(T.target.value||0)}))})]},k.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),it.id!=="levels"&&it.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:N,onChange:k=>ae(Number(k.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:ye??"",onChange:k=>J(k.target.value||null),children:re.map(k=>e.jsx("option",{value:k.roleId,children:k.label},k.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[c?e.jsx("button",{type:"button",className:"cta ghost",onClick:L,disabled:Ve==="saving",children:Ve==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${m}${c?`/revisions/${encodeURIComponent(c)}/run`:C?`/collections/${C}/revision/run`:"/revision/run"}?mode=${encodeURIComponent(z)}&check=${encodeURIComponent(xe)}&limit=${N}${Ce?`&${Ce}`:""}${ye?`&reviewer=${encodeURIComponent(ye)}`:""}${c?`&revisionId=${encodeURIComponent(c)}`:""}`,children:t.cogita.library.actions.startRevision}),c?e.jsx("a",{className:"cta ghost",href:`/#/cogita/live-revision-host/${encodeURIComponent(i)}/${encodeURIComponent(c)}`,children:"Live session"}):null]}),Ve==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),Re?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:Re,readOnly:!0})]}):null,Ae==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,ot==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):ot==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:$,disabled:Ae==="working",children:Ae==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),Re?e.jsx("button",{type:"button",className:"cta ghost",onClick:K,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),We==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):ge.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:ge.map(k=>e.jsxs("div",{className:"cogita-share-row","data-state":k.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:k.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(k.createdUtc).toLocaleString(),k.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),k.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>R(k.shareId),children:t.cogita.library.revision.shareRevokeAction})]},k.shareId))})]})]})]})]})})})]})})}const Pn=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function ar(t,n,r){if(!t)return null;const s=new Map(t.nodes.map(D=>[D.id,D])),o=new Map,h=new Set,d=D=>{if(typeof D=="number")return D;if(typeof D=="string"){const y=Number(D);return Number.isFinite(y)?y:0}return 0},w=D=>{if(o.has(D))return o.get(D);if(h.has(D))return 0;const y=s.get(D);if(!y)return 0;h.add(D);const U=ae=>{var P,B;return(ae?((P=y.inputsByHandle)==null?void 0:P[ae])??[]:y.inputs??((B=y.inputsByHandle)==null?void 0:B.in)??[]).map(Q=>w(Q))};let N=0;switch(y.type){case"input.random":{const ae=y.min??0,z=y.max??ae+10,P=Math.min(ae,z),B=Math.max(ae,z);N=Math.floor(Math.random()*(B-P+1))+P;break}case"input.const":{N=y.value??0;break}case"input.list":{const ae=(y.list??[]).filter(Boolean),z=Math.round(d(U("index")[0]));N=ae.length?ae[Math.max(0,Math.min(ae.length-1,z))]:String(z);break}case"compute.add":{N=U("in").map(z=>d(z)).reduce((z,P)=>z+P,0);break}case"compute.sub":{const ae=U("add").map(P=>d(P)),z=U("sub").map(P=>d(P));N=ae.reduce((P,B)=>P+B,0)-z.reduce((P,B)=>P+B,0);break}case"compute.mul":{const ae=U("in").map(z=>d(z));N=ae.length?ae.reduce((z,P)=>z*P,1):0;break}case"compute.div":{const ae=d(U("num")[0]),z=U("den").map(P=>d(P)).reduce((P,B)=>P+B,0);N=Math.abs(z)<Number.EPSILON?0:ae/z;break}case"compute.pow":{const ae=d(U("base")[0]),z=d(U("exp")[0]);N=Math.pow(ae,z);break}case"compute.exp":{const ae=d(U("base")[0]),z=d(U("exp")[0]);N=Math.pow(ae,z);break}case"compute.log":{const ae=d(U("value")[0]),z=d(U("base")[0]),P=Math.max(ae,Number.EPSILON);N=Math.abs(z)<Number.EPSILON?Math.log(P):Math.log(P)/Math.log(z);break}case"compute.abs":{N=Math.abs(d(U("in")[0]));break}case"compute.min":{const ae=U("in").map(z=>d(z));N=ae.length?Math.min(...ae):0;break}case"compute.max":{const ae=U("in").map(z=>d(z));N=ae.length?Math.max(...ae):0;break}case"compute.floor":{N=Math.floor(d(U("in")[0]));break}case"compute.ceil":{N=Math.ceil(d(U("in")[0]));break}case"compute.round":{N=Math.round(d(U("in")[0]));break}case"compute.mod":{const ae=d(U("a")[0]),z=d(U("b")[0]);N=Math.abs(z)<Number.EPSILON?0:ae%z;break}case"compute.concat":{const z=["in1","in2","in3","in4","in5","in6"].flatMap(xe=>U(xe)),P=z.length?z:U("in");N=(P.length?P:U()).map(xe=>xe==null?"":String(xe)).join("");break}case"compute.trim":{const ae=U("text")[0]??U("in")[0]??"",z=ae==null?"":String(ae),P=Math.max(0,Math.round(d(U("start")[0]))),B=Math.max(0,Math.round(d(U("end")[0])));P+B>=z.length?N="":N=z.substring(P,z.length-B);break}case"output":{N=U("in")[0]??0;break}default:N=0}return h.delete(D),o.set(D,N),N},f=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(D=>D.type==="output").map(D=>D.id);t.nodes.forEach(D=>w(D.id)),f.forEach(D=>w(D));const j=D=>Math.abs(D%1)<1e-5?String(Math.round(D)):D.toFixed(3).replace(/\.?0+$/,""),i=D=>typeof D=="number"?j(D):D??"",p=new Map;f.forEach(D=>{var z,P,B,Q;const y=s.get(D);if(!y)return;const U=(P=(z=y.inputsByHandle)==null?void 0:z.name)==null?void 0:P[0],N=U?i(o.get(U)):"",ae=(N==null?void 0:N.toString().trim())||((B=y.outputLabel)==null?void 0:B.trim())||((Q=y.name)==null?void 0:Q.trim())||D;p.set(D,ae)});const c={},u={},v={};f.forEach(D=>{var N,ae;const y=s.get(D);if(!y)return;const U=p.get(D)??(((N=y.outputLabel)==null?void 0:N.trim())||((ae=y.name)==null?void 0:ae.trim())||D);c[U]=i(o.get(D)),y.name&&(u[y.name.trim()]=U),u[D]=U});const m=(D,y)=>{let U=D;return t.nodes.forEach(N=>{var Q,xe;const ae=i(o.get(N.id)),z=f.includes(N.id),P=z?p.get(N.id)??((Q=N.outputLabel)==null?void 0:Q.trim())??((xe=N.name)==null?void 0:xe.trim())??N.id:"",B=z&&y?P:ae;U=U.replace(new RegExp(`\\{\\s*${Pn(N.id)}\\s*\\}`,"gi"),B),N.name&&(U=U.replace(new RegExp(`\\{\\s*${Pn(N.name)}\\s*\\}`,"gi"),B)),z&&N.outputLabel&&(U=U.replace(new RegExp(`\\{\\s*${Pn(N.outputLabel)}\\s*\\}`,"gi"),P))}),U},S=n;let _=S.trim().length>0?S:"";_||(_=f.length?`Compute ${f.join(", ")}`:"Compute"),_=m(_,!0);const x=(r==null?void 0:r.trim())??"",g=x?m(x,!1):"",C={};return o.forEach((D,y)=>{C[y]=D,v[y]=i(D);const U=s.get(y);U!=null&&U.name&&(v[U.name.trim()]=i(D))}),{prompt:_,answers:c,values:C,answerText:g,outputVariables:u,variableValues:v}}function nr(t){var r;const n=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((r=n[0])==null?void 0:r[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const En=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function sr({outcomes:t}){const[n,r]=a.useState("day"),s=a.useMemo(()=>{const o=En.find(w=>w.id===n)??En[1],h=Date.now()-o.ms,d=t.filter(w=>new Date(w.createdUtc).getTime()>=h);return ua(d)},[t,n]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:En.map(o=>e.jsx("button",{type:"button",className:"ghost","data-active":n===o.id,onClick:()=>r(o.id),children:o.label},o.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[s.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[s.correct," / ",s.total]})]})}const Gi="cogita-revision",Yi=1,sn="outcomes",Xi=()=>new Promise((t,n)=>{const r=indexedDB.open(Gi,Yi);r.onupgradeneeded=()=>{const s=r.result;if(!s.objectStoreNames.contains(sn)){const o=s.createObjectStore(sn,{keyPath:"id"});o.createIndex("byItem","itemKey",{unique:!1}),o.createIndex("byPending","pending",{unique:!1})}},r.onerror=()=>n(r.error),r.onsuccess=()=>t(r.result)}),Ua=async(t,n)=>{const r=await Xi();return new Promise((s,o)=>{const h=r.transaction(sn,t),d=h.objectStore(sn);n(d).then(s).catch(o),h.onerror=()=>o(h.error)})},rr=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const n=Array.from(t).map(r=>r.toString(16).padStart(2,"0"));return`${n.slice(0,4).join("")}-${n.slice(4,6).join("")}-${n.slice(6,8).join("")}-${n.slice(8,10).join("")}-${n.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},Zi=()=>{const t="cogita_revision_client_id",n=localStorage.getItem(t);if(n)return n;const r=rr();return localStorage.setItem(t,r),r},eo=()=>{const t="cogita_revision_client_seq",n=Number(localStorage.getItem(t)??"0"),r=Number.isFinite(n)?n+1:1;return localStorage.setItem(t,String(r)),r},ir=(t,n,r,s)=>Xt(t,n,r,s),rn=async t=>{const n=Zi(),r=eo(),s=new Date().toISOString(),o={...t,clientId:n,clientSequence:r,createdUtc:s,id:rr(),pending:!0};return await Ua("readwrite",h=>new Promise((d,w)=>{const f={...o,itemKey:ir(o.itemType,o.itemId,o.checkType,o.direction)},j=h.add(f);j.onsuccess=()=>d(),j.onerror=()=>w(j.error)})),o},on=async(t,n,r,s)=>{if(!n)return[];try{const o=ir(t,n,r,s);return await Ua("readonly",h=>new Promise((d,w)=>{const j=h.index("byItem").getAll(o);j.onsuccess=()=>{const p=(j.result??[]).map(c=>({itemType:c.itemType,itemId:c.itemId,checkType:c.checkType??null,direction:c.direction??null,revisionType:c.revisionType,evalType:c.evalType,correct:c.correct,createdUtc:c.createdUtc,maskBase64:c.maskBase64,payloadBase64:c.payloadBase64,payloadHashBase64:c.payloadHashBase64,clientId:c.clientId,clientSequence:c.clientSequence,personRoleId:c.personRoleId??null})).sort((c,u)=>c.createdUtc.localeCompare(u.createdUtc));d(p)},j.onerror=()=>w(j.error)}))}catch{return[]}},ha=async()=>{try{return await Ua("readonly",t=>new Promise((n,r)=>{const s=t.getAll();s.onsuccess=()=>{const h=(s.result??[]).map(d=>({itemType:d.itemType,itemId:d.itemId,checkType:d.checkType??null,direction:d.direction??null,revisionType:d.revisionType,evalType:d.evalType,correct:d.correct,createdUtc:d.createdUtc,maskBase64:d.maskBase64,payloadBase64:d.payloadBase64,payloadHashBase64:d.payloadHashBase64,clientId:d.clientId,clientSequence:d.clientSequence,personRoleId:d.personRoleId??null}));n(h)},s.onerror=()=>r(s.error)}))}catch{return[]}},to=async(t=100)=>{try{return await Ua("readonly",n=>new Promise((r,s)=>{const h=n.index("byPending").getAll(!0);h.onsuccess=()=>{const d=h.result??[];r(d.slice(0,t))},h.onerror=()=>s(h.error)}))}catch{return[]}},ao=async t=>{if(t.length!==0)try{await Ua("readwrite",n=>new Promise((r,s)=>{let o=t.length;t.forEach(h=>{const d=n.get(h);d.onsuccess=()=>{const w=d.result;if(w){w.pending=!1;const f=n.put(w);f.onsuccess=()=>{o-=1,o===0&&r()},f.onerror=()=>s(f.error)}else o-=1,o===0&&r()},d.onerror=()=>s(d.error)})}))}catch{}},Kn=async(t,n)=>{const r=await to(200);if(r.length===0)return;const s=new Map;r.forEach(o=>{var d;const h=o.personRoleId??n??"";s.has(h)||s.set(h,[]),(d=s.get(h))==null||d.push(o)});for(const[o,h]of s.entries()){const d=h.map(w=>({itemType:w.itemType,itemId:w.itemId,checkType:w.checkType??null,direction:w.direction??null,revisionType:w.revisionType,evalType:w.evalType,correct:w.correct,clientId:w.clientId,clientSequence:w.clientSequence,maskBase64:w.maskBase64??null,payloadHashBase64:w.payloadHashBase64??null,payloadBase64:w.payloadBase64??null,personRoleId:o||null}));try{await Cr({libraryId:t,outcomes:d}),await ao(h.map(w=>w.id))}catch{}}},Ft=t=>t.trim().toLowerCase(),Jt=t=>{const n=t==null?void 0:t.trim();return n?{fragmentId:n}:null},ln=(t,n)=>{const r=Jt(n);if(!r)return!0;const s=Jt(t);return(s==null?void 0:s.fragmentId)===r.fragmentId},Tt=t=>{const n=t==null?void 0:t.trim().toLowerCase();return n||null},or=(t,n)=>{if((Tt(t.childItemType)??"info")!==(n.cardType??"").toLowerCase()||t.childItemId!==n.cardId)return!1;const s=Tt(t.childCheckType),o=Tt(t.childDirection),h=Tt(n.checkType),d=Tt(n.direction);return!(s&&s!==h||o&&o!==d)},no={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},so={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},cn=(t,n,r)=>{if(!r||!n.startsWith(t))return n;const s=n.slice(t.length);if(!s)return n;const o=r==="super"?no:so,h=s.split("").map(d=>o[d]??d).join("");return t+h},dn=(t,n,r)=>{var d,w,f;if(!t)return((d=n[0])==null?void 0:d.key)??null;const s=new Set(n.map(j=>j.key)),o=/\{([^}]+)\}/g;let h;for(;(h=o.exec(t))!==null;){const j=((w=h[1])==null?void 0:w.trim())??"";if(!j)continue;if(s.has(j))return j;const i=r==null?void 0:r[j];if(i&&s.has(i))return i}return((f=n[0])==null?void 0:f.key)??null},za=t=>(()=>{const n=new Set;return t.flatMap(r=>{if(r.cardType!=="info"||r.infoType!=="citation")return[r];const s=r.description??"";if(!s.trim())return[r];const o=va(s),h=Object.keys(o.nodes);return h.length===0?[r]:h.map(d=>({...r,checkType:"quote-fragment",direction:d})).filter(d=>{const w=[d.cardId,d.checkType??"",d.direction??""].join("|");return n.has(w)?!1:(n.add(w),!0)})})})();function Fn({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,libraryId:i,collectionId:p,revisionId:c}){const u=qa(),v=`/#/cogita/library/${i}`,m=a.useMemo(()=>new URLSearchParams(u.search),[u.search]),S=Math.max(1,Number(m.get("limit")??20)),_=m.get("mode")??"random",x=a.useMemo(()=>ns(_),[_]),g=a.useMemo(()=>vn(x,tr(x,m)),[x,m]),C=m.get("check")??"exact",D=m.get("reviewer"),y=(m.get("scope")??"").trim(),U=y==="info"||y==="info-selection"?y:"collection",N=U==="info"?(m.get("infoId")??"").trim():"",ae=U==="info-selection"?(m.get("seed")??"").trim():"",[z,P]=a.useState(null),B=p??z??void 0,Q=U==="collection"&&!!B,xe=a.useMemo(()=>t.cogita.library.revision[x.labelKey]??_,[t,_,x]),Ee=a.useMemo(()=>C==="exact"?t.cogita.library.revision.checkValue:C,[t,C]),[re,A]=a.useState(t.cogita.library.collections.defaultName),[ye,J]=a.useState([]),[ge,ee]=a.useState([]),[ke,ue]=a.useState("idle"),[le,Ie]=a.useState({current:0,total:0}),[Ae,Ke]=a.useState(0),[Re,Ze]=a.useState(""),[ot,Te]=a.useState(null),[We,ft]=a.useState(null),[Ve,ze]=a.useState(null),[et,it]=a.useState(null),[Ge,Ce]=a.useState([]),[Be,Ye]=a.useState({}),[$,L]=a.useState({}),[K,R]=a.useState(null),[k,T]=a.useState(null),[M,oe]=a.useState(null),[fe,de]=a.useState(null),[Y,E]=a.useState(null),[W,te]=a.useState({}),H=a.useRef(0),[X,be]=a.useState(null),O=a.useRef(null),ne=a.useRef(null),[Le,qe]=a.useState(null),[De,Je]=a.useState(!1),[pt,ht]=a.useState(null),[gt,yt]=a.useState([]),[Ct,zt]=a.useState(null),Rt=a.useRef(null),kt=a.useRef(null),[pa,Mt]=a.useState(null),[xt,Nt]=a.useState(0),vt=a.useRef(null),bt=a.useRef({}),[Et,st]=a.useState(!1),[Ue,mt]=a.useState({}),[Ht,Kt]=a.useState([]),Dt=a.useRef(new Map),[ce,Zt]=a.useState(new Set),[sa,Bt]=a.useState(!1),l=a.useRef(null),q=a.useRef(new Set),pe=a.useRef({});a.useEffect(()=>{if(!c||p){P(null);return}Yn({libraryId:i,revisionId:c}).then(b=>P(b.collectionId)).catch(()=>P(null))},[p,i,c]);const G=ye[Ae]??null,tt=(G==null?void 0:G.checkType)==="translation-match"&&Y,lt=a.useRef(new Map),wt=a.useRef(new Map),It=a.useRef(new Map),$t=a.useRef(new Map),jt=a.useMemo(()=>G?G.cardType==="vocab"?t.cogita.library.revision.vocabLabel:G.infoType?nt(t,G.infoType):t.cogita.library.revision.infoLabel:"",[t,G]),Wt=a.useMemo(()=>{var I;return x.id!=="levels"?ye.length:((I=Ue.pool)==null?void 0:I.length)??x.getFetchLimit(S,g)},[Ue,g,x,ye.length,S]),ea=x.getProgressTotal?x.getProgressTotal(ye,Ue,S,g):x.id==="levels"?Math.min(S,Wt):ye.length,ra=ea?Math.min(Ae+1,ea):0,Ot=Math.max(1,Number(g.tries??1)),ia=g.compare??"anchors",Pt=Math.max(0,Math.min(100,Number(g.minCorrectness??0))),St=(g.considerDependencies??"on")==="on",ta=Math.max(0,Math.min(100,Number(g.dependencyThreshold??85))),Yt=b=>{const I=b.slice();for(let V=I.length-1;V>0;V-=1){const he=Math.floor(Math.random()*(V+1));[I[V],I[he]]=[I[he],I[V]]}return I},wa=b=>xa(b,{treatSimilarCharsAsSame:!0})>=Pt,Ja=async()=>{const b=await ha(),I=new Map,V=new Map,he=new Map;b.forEach(Z=>{const Se=`${Z.itemType}:${Z.itemId}`,Oe=Xt(Z.itemType,Z.itemId,Z.checkType,Z.direction);if(I.has(Se)||I.set(Se,[]),I.get(Se).push(Z),V.has(Oe)||V.set(Oe,[]),V.get(Oe).push(Z),Z.itemType==="info"&&Z.checkType==="quote-fragment"&&Z.direction){const Xe=`${Z.itemId}:${Z.direction}`;he.has(Xe)||he.set(Xe,[]),he.get(Xe).push(Z)}});const me=new Map,ie=new Map,ve=new Map;return I.forEach((Z,Se)=>me.set(Se,ua(Z).score)),V.forEach((Z,Se)=>ie.set(Se,ua(Z).score)),he.forEach((Z,Se)=>ve.set(Se,ua(Z).score)),{itemKnowness:me,cardKnowness:ie,fragmentKnowness:ve}},Qt=async b=>{const I=[];let V=null;for(;;){const he=await Oa({libraryId:i,collectionId:b,limit:200,cursor:V});if(I.push(...he.items),!he.nextCursor)break;V=he.nextCursor}return za(I)},Ta=async(b,I)=>{if(Dt.current.has(b))return Dt.current.get(b)??0;const V=await Qt(b);if(V.length===0)return Dt.current.set(b,0),0;const me=V.reduce((ie,ve)=>{const Z=Ne(ve);return ie+(I.get(Z)??0)},0)/V.length;return Dt.current.set(b,me),me},Ca=(b,I)=>{if(!St||b.cardType!=="info"||b.infoType!=="citation"||b.checkType!=="quote-fragment")return!0;const V=Jt(b.direction);if(!(V!=null&&V.fragmentId))return!0;const he=b.description??"";if(!he.trim())return!0;const ie=va(he).nodes[V.fragmentId];if(!ie||!ie.leftId&&!ie.rightId)return!0;const ve=[ie.leftId,ie.rightId].filter(Oe=>!!Oe);if(ve.length===0)return!0;const Z=ve.map(Oe=>{const Xe=Xt("info",b.cardId,"quote-fragment",Oe);return I.get(Xe)??0});return Z.reduce((Oe,Xe)=>Oe+Xe,0)/Z.length>=ta},Ra=async b=>{const I=Ue,V=b.concat(I.active??[]).concat(I.pool??[]).filter((Z,Se,Oe)=>Oe.findIndex(Xe=>Ne(Xe)===Ne(Z))===Se);if(!St){Zt(new Set(V.map(Ne)));return}const{itemKnowness:he,cardKnowness:me}=await Ja(),ie=Ht.filter(Z=>Tt(Z.childItemType)==="collection"&&Z.childItemId===p&&!Tt(Z.childCheckType)&&!Tt(Z.childDirection)),ve=new Set;for(const Z of V){if(Z.cardType!=="info"){ve.add(Ne(Z));continue}if(!Ca(Z,me))continue;const Se=Ht.filter(He=>or(He,Z)).concat(ie);if(Se.length===0){ve.add(Ne(Z));continue}let Oe=0;for(const He of Se)if(Tt(He.parentItemType)==="collection")Oe+=await Ta(He.parentItemId,me);else if(Tt(He.parentCheckType)||Tt(He.parentDirection)){const at=Tt(He.parentCheckType),rt=Tt(He.parentDirection),ct=Xt(He.parentItemType,He.parentItemId,at,rt);Oe+=me.get(ct)??0}else{const at=`${He.parentItemType}:${He.parentItemId}`;Oe+=he.get(at)??0}Oe/Se.length>=ta&&ve.add(Ne(Z))}Zt(ve)},Ha=b=>{for(let I=b;I<ye.length;I+=1){const V=ye[I];if(V&&(!St||V.cardType!=="info"||ce.has(Ne(V))))return I}return-1},$a=b=>!St||b.cardType!=="info"||ce.has(Ne(b)),wn=b=>{if(x.id!=="temporal"&&x.id!=="levels")return null;const I=Ue,V=(I.active??[]).concat(I.pool??[]),he=new Set;for(const me of V){const ie=Ne(me);if(!(he.has(ie)||b.has(ie))&&(he.add(ie),$a(me)))return me}return null},Vt=a.useMemo(()=>{if(x.id!=="levels")return null;const b=Ue,I=b.pool??[],V=b.active??[],he=b.levelMap??{},me=Math.max(1,Number(g.levels??1)),ie=Array.from({length:me},()=>0),ve=new Set(V.map(Xe=>Ne(Xe)));I.forEach(Xe=>{const He=Math.min(me,Math.max(1,he[Ne(Xe)]??1));ie[He-1]+=1});const Z=I.length||1,Se=ie.map(Xe=>Xe/Z*100),Oe=G?he[Ne(G)]??1:null;return{counts:ie,percentages:Se,currentLevel:Oe,levelsCount:me,activeCount:V.length,poolCount:I.length,activeSet:ve}},[Ue,g,x,G]),qt=a.useMemo(()=>{if(x.id!=="temporal")return null;const b=Ue,I=b.pool??[],V=b.active??[],he=b.knownessMap??{},me=new Set(b.unknownSet??[]);let ie=0;I.forEach(Se=>{(he[Ne(Se)]??0)>1&&(ie+=1)});const ve=me.size,Z=V.map(Se=>({id:Ne(Se),value:me.has(Ne(Se))?0:Math.max(0,Math.min(1,he[Ne(Se)]??0))}));return{knownCount:ie,unknownCount:ve,dots:Z}},[Ue,x]),jn=a.useMemo(()=>{if(!St)return 0;const b=Ue;return ye.concat(b.active??[]).concat(b.pool??[]).filter((V,he,me)=>me.findIndex(ie=>Ne(ie)===Ne(V))===he).filter(V=>V.cardType==="info"&&!ce.has(Ne(V))).length},[St,Ue,ye,ce]);a.useEffect(()=>{if(!St||ke!=="ready")return;const b=Ue,V=ye.concat(b.active??[]).concat(b.pool??[]).filter((ie,ve,Z)=>Z.findIndex(Se=>Ne(Se)===Ne(ie))===ve).filter(ie=>ie.cardType!=="info"||ce.has(Ne(ie))).length,he=Rt.current;if(Rt.current=V,he===null||V<=he)return;const me=V-he;zt(`New card available (+${me})`),kt.current&&window.clearTimeout(kt.current),kt.current=window.setTimeout(()=>zt(null),2200)},[St,ke,Ue,ye,ce]),a.useEffect(()=>()=>{kt.current&&window.clearTimeout(kt.current)},[]);const _t=(b,I)=>{const V=x.applyOutcome({queue:ye,meta:Ue},G,S,g,{correct:b,correctness:I,createdUtc:new Date().toISOString()});J(V.queue),mt(V.meta);const he=V.queue[Ae+1];he&&ma(he,Ae+1)};a.useEffect(()=>{if(Q&&B){fn(i,B).then(b=>A(b.name)).catch(()=>A(t.cogita.library.collections.defaultName));return}if(U==="info"&&N){na({libraryId:i,infoId:N}).then(b=>{const I=b.payload??{};A(I.title||I.label||I.name||N)}).catch(()=>A(N||t.cogita.library.revision.runKicker));return}if(U==="info-selection"){const b=ae?gs(i,ae):null,I=(b==null?void 0:b.infoIds.length)??0;A(I>0?`Selected infos (${I})`:"Selected infos");return}A(t.cogita.library.collections.defaultName)},[t,B,Q,i,U,N,ae]),a.useEffect(()=>{Gn({libraryId:i,type:"language"}).then(b=>ee(b)).catch(()=>ee([]))},[i]),a.useEffect(()=>{Q&&Qn({libraryId:i}).then(b=>Kt(b.items??[])).catch(()=>Kt([]))},[Q,i]),a.useEffect(()=>{Kn(i,D)},[i,D]),a.useEffect(()=>{Ra(ye)},[ye,Ht,St,ta,B]),a.useEffect(()=>{if(!G||!St){Bt(!1);return}if(G.cardType!=="info"||ce.has(Ne(G))){Bt(!1);return}const b=Ha(Ae+1);if(b>=0){Bt(!1),Ke(b);return}if(x.id==="temporal"||x.id==="levels"){const I=ye.slice(0,Ae+1),V=ye.slice(Ae+1).filter($a),he=I.concat(V),me=new Set(he.map(Ne)),ie=wn(me);if(ie){const Z=Ne(ie);me.has(Z)||(he.push(ie),me.add(Z),mt(Se=>{const Oe=Se,Xe=new Set(Oe.queued??[]);return Xe.add(Z),{...Oe,queued:Xe}}))}const ve=he.findIndex((Z,Se)=>Se!==Ae&&$a(Z));if(ve>=0){J(he),Ke(ve),Bt(!1);return}}Bt(!0)},[G,ce,St,Ae,ye,Ue,x.id]),a.useEffect(()=>{let b=!0;return(async()=>{ue("loading"),Ie({current:0,total:x.id==="levels"?0:x.getFetchLimit(S,g)});try{if(!Q){if(Kt([]),U==="info"){if(!N){b&&(J([]),Kt([]),mt({}),Ke(0),ue("ready"));return}const[He,at]=await Promise.all([Za({libraryId:i,infoId:N}),en({libraryId:i,infoId:N})]);if(!b)return;const rt=za(He.items??[]);Kt(at.items??[]);const ct=x.prepare(rt,S,g);J(ct.queue),mt(ct.meta),Ke(0),ue("ready"),Ie({current:rt.length,total:rt.length});return}if(U==="info-selection"){const He=ae?gs(i,ae):null,at=(He==null?void 0:He.infoIds)??[];if(!at.length){b&&(J([]),Kt([]),mt({}),Ke(0),ue("ready"));return}const rt=await Promise.all(at.map(async fa=>{const[Ut,Wa]=await Promise.all([Za({libraryId:i,infoId:fa}),en({libraryId:i,infoId:fa})]);return{cards:Ut.items??[],deps:Wa.items??[]}}));if(!b)return;const ct=new Map;rt.forEach(fa=>{za(fa.cards).forEach(Ut=>{ct.set(Ne(Ut),Ut)})});const dt=Array.from(ct.values()),ut=new Set(dt.map(Ne)),Lt=new Map;rt.forEach(fa=>{(fa.deps??[]).forEach(Ut=>{const Wa=Xt(Ut.parentItemType,Ut.parentItemId,Tt(Ut.parentCheckType),Tt(Ut.parentDirection)),ss=Xt(Ut.childItemType,Ut.childItemId,Tt(Ut.childCheckType),Tt(Ut.childDirection));if(!ut.has(Wa)||!ut.has(ss))return;const rs=`${Wa}->${ss}`;Lt.has(rs)||Lt.set(rs,Ut)})}),Kt(Array.from(Lt.values()));const ka=x.prepare(dt,S,g);J(ka.queue),mt(ka.meta),Ke(0),ue("ready"),Ie({current:dt.length,total:dt.length});return}}const V=[];let he=null,me=null;do{const He=await Oa({libraryId:i,collectionId:B,limit:300,cursor:he});if(V.push(...He.items),(x.id==="levels"||x.id==="temporal")&&He.total&&(me=He.total),Ie(at=>({current:V.length,total:at.total||He.total||x.getFetchLimit(S,g)})),he=He.nextCursor??null,me!==null&&V.length>=me||x.id!=="levels"&&x.id!=="temporal"&&V.length>=x.getFetchLimit(S,g))break}while(he);if(!b)return;const ie=za(V);let ve;if(x.id==="levels"){const He=Math.max(1,Number(g.levels??1)),rt=(await ha()).reduce((ct,dt)=>{const ut=Xt(dt.itemType,dt.itemId,dt.checkType,dt.direction);return ct[ut]||(ct[ut]=[]),ct[ut].push(dt),ct},{});ve={},ie.forEach(ct=>{const dt=Ne(ct),ut=rt[dt]??[],Lt=ut.length>0?ua(ut).score:0,ka=Math.max(1,Math.min(He,Math.ceil(Lt/100*He)));ve[dt]=ka})}let Z=null,Se=null,Oe=null;if(x.id==="temporal"){const He=await ha(),at=new Set(ie.map(dt=>Ne(dt))),rt=He.reduce((dt,ut)=>{const Lt=Xt(ut.itemType,ut.itemId,ut.checkType,ut.direction);return at.has(Lt)&&(dt[Lt]||(dt[Lt]=[]),dt[Lt].push(ut)),dt},{});Z={},Se=new Set,Oe={};const ct=Date.now();ie.forEach(dt=>{const ut=Ne(dt),Lt=rt[ut]??[];if(Lt.length===0){Z[ut]=0,Se.add(ut),Oe[ut]=[];return}const ka=es(Lt);Oe[ut]=ka;const fa=yn(ka,ct);Z[ut]=fa.knowness})}const Xe=x.id==="levels"?as(ie,S,g,ve):x.id==="temporal"?ts(ie,S,g,Z??{},Se??new Set,Oe??{}):x.prepare(ie,S,g);J(Xe.queue),mt(Xe.meta),Ke(0),ue("ready"),Ie(He=>({current:Math.min(He.current,He.total),total:He.total}))}catch{b&&ue("error")}})(),()=>{b=!1}},[B,Q,i,S,U,g,x,D,N,ae]),a.useEffect(()=>{if(Ze(""),Te(null),Mt(null),Nt(0),Ce([]),Ye({}),L({}),T(null),oe(null),de(null),Je(!1),st(!1),qe(null),E(null),te({}),!G){ft(null),ze(null),R(null),ht(null);return}G.cardType==="info"&&G.infoType==="computed"&&ft(t.cogita.library.revision.loadingComputed);let b=!0;return ma(G,Ae).then(I=>{!b||!I||(ft(I.prompt),ze(I.expectedAnswer),Ce(I.computedExpected),Ye(I.computedAnswers),R(I.computedValues),T(I.answerTemplate),oe(I.outputVariables),de(I.variableValues))}),()=>{b=!1}},[G,t]),a.useEffect(()=>{if(!G||G.cardType!=="info"||G.infoType!=="citation"){l.current=null,q.current=new Set,it(null);return}const b=G.description??"",I=(G.label??"").trim(),V=I.replace(/\s+/g," ").trim(),he=b.replace(/\s+/g," ").trim(),me=V&&V!==he?I:t.cogita.library.infoTypes.citation;if(!b){it(null),ze(null);return}const ie=va(b);l.current=ie,ft(me);let ve=!0;return Ja().then(({fragmentKnowness:Z})=>{if(!ve)return;const Se=new Set,Oe={};Z.forEach((at,rt)=>{const[ct,dt]=rt.split(":",2);if(ct!==G.cardId)return;const ut=Jt(dt);if(!ut)return;const{fragmentId:Lt}=ut;Oe[Lt]=at,at>=ta&&Se.add(Lt)}),q.current=Se,pe.current=Oe;const Xe=Jt(G.direction);if(Xe!=null&&Xe.fragmentId&&ie.nodes[Xe.fragmentId]){F(ie,Xe.fragmentId,me);return}const He=La(ie,Se,Oe,ta,St,G.direction);F(ie,(He==null?void 0:He.id)??null,me)}).catch(()=>{q.current=new Set,pe.current={};const Z=Jt(G.direction);if(Z!=null&&Z.fragmentId&&ie.nodes[Z.fragmentId]){F(ie,Z.fragmentId,me);return}const Se=La(ie,q.current,{},ta,St,G.direction);F(ie,(Se==null?void 0:Se.id)??null,me)}),()=>{ve=!1}},[G,t,St,ta]),a.useEffect(()=>{if(!G||G.cardType!=="vocab"||G.checkType!=="translation-match"){E(null),te({});return}const V=(Ue.pool??Ue.active??ye).filter(Z=>Z.cardType==="vocab"&&Z.checkType==="translation-match").filter((Z,Se,Oe)=>Oe.findIndex(Xe=>Xe.cardId===Z.cardId)===Se);V.some(Z=>Z.cardId===G.cardId)||V.unshift(G);const me=Yt(V).slice(0,6).map(Z=>{const Se=Z.label.split("↔").map(He=>He.trim()).filter(Boolean);if(Se.length<2)return null;const Oe=`${Z.cardId}:L`,Xe=`${Z.cardId}:R`;return{cardId:Z.cardId,leftId:Oe,rightId:Xe,leftLabel:Se[0],rightLabel:Se[1]}}).filter(Boolean),ie=me.map(Z=>Z.leftId),ve=Yt(me.map(Z=>Z.rightId));E({pairs:me,leftOrder:ie,rightOrder:ve,selection:{},activeLeft:null,activeRight:null,locked:{}})},[G,ye,Ue]),a.useEffect(()=>()=>{O.current&&window.clearTimeout(O.current),ne.current&&window.clearTimeout(ne.current)},[]);const oa=a.useRef(null);a.useEffect(()=>{if(!G)return;const b=Ne(G),I=typeof document<"u"?document.activeElement:null;if(oa.current===b&&I&&(I.tagName==="INPUT"||I.tagName==="TEXTAREA"))return;let V=0;const he=()=>{if(G){if(G.cardType==="info"&&G.infoType==="computed"){if(Ge.length>0){const ie=dn(k,Ge,M),ve=ie?bt.current[ie]:null;if(ve&&(ve.focus(),document.activeElement===ve)){oa.current=b;return}}if(vt.current&&(vt.current.focus(),document.activeElement===vt.current)){oa.current=b;return}}else if(G.cardType==="vocab"&&vt.current&&(vt.current.focus(),document.activeElement===vt.current)){oa.current=b;return}V<6&&(V+=1,window.setTimeout(he,40))}},me=window.setTimeout(he,40);return()=>window.clearTimeout(me)},[G,Ge,k,M]),a.useEffect(()=>{if(!Et)return;const b=I=>{I.key==="Enter"&&(I.preventDefault(),Ma())};return window.addEventListener("keydown",b),()=>window.removeEventListener("keydown",b)},[Et]);const Ia=b=>{yt(b),ht(ua(b))};a.useEffect(()=>{if(!G){ht(null),yt([]);return}const b=G.cardType==="info"?"info":"connection";if(G.cardType==="info"&&G.infoType==="citation"){ha().then(I=>{const V=I.filter(he=>he.itemType==="info"&&he.itemId===G.cardId&&he.checkType==="quote-fragment"&&ln(he.direction,G.direction));Ia(V)}).catch(()=>{ht(null),yt([])});return}on(b,G.cardId,G.checkType,G.direction).then(I=>Ia(I)).catch(()=>{ht(null),yt([])})},[i,G,D]);const ja=(b,I,V,he)=>{if(b==="info"&&V==="quote-fragment"){ha().then(me=>{const ie=me.filter(ve=>ve.itemType==="info"&&ve.itemId===I&&ve.checkType==="quote-fragment"&&ln(ve.direction,he));Ia(ie)}).catch(()=>{ht(null),yt([])});return}on(b,I,V,he).then(me=>Ia(me)).catch(()=>{ht(null),yt([])})},Pa=(b,I,V)=>{var ve;const he=((ve=V.pairs.find(Z=>Z.leftId===b))==null?void 0:ve.rightId)??null;if(!he)return V;const me=he===I;te(Z=>({...Z,[b]:me?"correct":"incorrect"})),O.current&&window.clearTimeout(O.current),ne.current&&window.clearTimeout(ne.current),H.current+=1;const ie={kind:me?"correct":"incorrect",tick:H.current};if(be(null),O.current=window.setTimeout(()=>be(ie),0),ne.current=window.setTimeout(()=>be(null),420),me){const Z={...V.locked,[b]:!0};return Object.keys(Z).length>=V.pairs.length?(Te("correct"),st(!0)):Te("correct"),{...V,selection:{...V.selection,[b]:I},activeLeft:null,activeRight:null,locked:Z}}return Te("incorrect"),{...V,activeLeft:null,activeRight:null}},kn=b=>{E(I=>!I||I.locked[b]?I:I.activeRight?Pa(b,I.activeRight,I):{...I,activeLeft:I.activeLeft===b?null:b})},Nn=b=>{E(I=>I&&(I.activeLeft?Pa(I.activeLeft,b,I):{...I,activeRight:I.activeRight===b?null:b}))},Ma=()=>{var b;if(G&&G.cardType==="info"&&G.infoType==="citation"&&l.current&&et&&!((b=Jt(G.direction))!=null&&b.fragmentId)){const I=La(l.current,q.current,pe.current,ta,St,G.direction,et.fragmentId);if(I){Te(null),Ze(""),Je(!1),L({}),st(!1),Mt(null),Nt(0),F(l.current,I.id,et.title);return}}Te(null),Ze(""),Je(!1),L({}),st(!1),Mt(null),Nt(0),Ke(I=>Math.min(I+1,ye.length))},aa=b=>{if(!G)return;const I=b.expected??null,V=b.answer??"";let he=I??"",me=V;if(!I&&b.expectedMap&&b.answerMap){const He=Object.keys(b.expectedMap).sort((at,rt)=>at.localeCompare(rt));he=He.map(at=>{var rt;return((rt=b.expectedMap)==null?void 0:rt[at])??""}).join("|"),me=He.map(at=>{var rt;return((rt=b.answerMap)==null?void 0:rt[at])??""}).join("|")}const ie=he?Aa(he,me,ia):new Uint8Array,ve={revisionType:x.id,evalType:b.evalType,direction:b.direction,prompt:We??"",expected:I,answer:V,expectedAnswers:b.expectedMap??null,answers:b.answerMap??null,correct:b.correct,maskBase64:ie.length?ya(ie):null,values:K??null,checkMode:C,compareMode:ia,minCorrectness:Pt},Z=new TextEncoder().encode(JSON.stringify(ve)),Se=G.cardType==="info"?"info":"connection",Oe=b.overrideCheckType??G.checkType??null,Xe=b.overrideDirection??G.direction??null;rn({itemType:Se,itemId:G.cardId,checkType:Oe,direction:Xe,revisionType:x.id,evalType:b.evalType,correct:b.correct,maskBase64:ie.length?ya(ie):null,payloadBase64:ya(Z),personRoleId:D??null}).then(()=>{ja(Se,G.cardId,Oe,Xe),Ra(ye),Kn(i,D)}).catch(()=>{})},Sn=(b,I)=>{const V=lt.current.get(I);if(V)return Promise.resolve(V);const he=wt.current.get(I);if(he)return he;const me=na({libraryId:i,infoId:b}).then(ie=>{var He,at;const ve=ie.payload,Z=((He=ve.definition)==null?void 0:He.graph)??null,Se="",Oe=((at=ve.definition)==null?void 0:at.answerTemplate)??"",Xe=ar(Z,Se,Oe);if(Xe){const ct={sample:nr(Xe),answerTemplate:Oe||null};return lt.current.set(I,ct),ct}return Vn({libraryId:i,infoId:b}).then(rt=>{const ct={sample:rt,answerTemplate:null};return lt.current.set(I,ct),ct})}).catch(()=>Vn({libraryId:i,infoId:b}).then(ie=>{const ve={sample:ie,answerTemplate:null};return lt.current.set(I,ve),ve}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{wt.current.delete(I)});return wt.current.set(I,me),me},ma=(b,I)=>{var Z;const V=`${Ne(b)}:${I}`,he=It.current.get(V);if(he)return Promise.resolve(he);const me=$t.current.get(V);if(me)return me;const ie=Se=>(It.current.set(V,Se),Se);let ve;if(b.cardType==="vocab"){if(b.checkType==="translation-match")return ve=Promise.resolve(ie({prompt:b.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),ve;const Se=b.label.split("↔").map(Oe=>Oe.trim()).filter(Boolean);if(Se.length>=2){const Xe=(b.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",He=Xe?Se[0]:Se[1],at=Xe?Se[1]:Se[0];ve=Promise.resolve(ie({prompt:He,expectedAnswer:at,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else ve=Promise.resolve(ie({prompt:b.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(b.cardType==="info"&&b.infoType==="word"){const Se=(Z=b.description)!=null&&Z.startsWith("Language: ")?b.description.replace("Language: ",""):null;ve=Promise.resolve(ie({prompt:b.label,expectedAnswer:Se,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else b.cardType==="info"&&b.infoType==="computed"?ve=Sn(b.cardId,V).then(Se=>{var rt,ct;if(!Se.sample)return ie({prompt:b.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const Oe=Se.sample,Xe=Oe.expectedAnswers?Object.entries(Oe.expectedAnswers).map(([dt,ut])=>({key:dt,expected:ut})):[],He=Xe.reduce((dt,ut)=>(dt[ut.key]="",dt),{}),at=Oe.expectedAnswerIsSentence&&((rt=Oe.expectedAnswer)==null?void 0:rt.trim())||null;return ie({prompt:Oe.prompt,expectedAnswer:Xe.length>0?at:((ct=Oe.expectedAnswer)==null?void 0:ct.trim())||null,computedExpected:Xe,computedAnswers:He,computedValues:Oe.values??null,answerTemplate:Se.answerTemplate,outputVariables:Oe.outputVariables??null,variableValues:Oe.variableValues??null})}).catch(()=>ie({prompt:b.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{$t.current.delete(V)}):ve=Promise.resolve(ie({prompt:b.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return $t.current.set(V,ve),ve},F=(b,I,V)=>{const he=Object.keys(b.nodes).length,me=q.current.size;if(!I){it({title:V,before:b.text,after:"",fragmentId:null,total:he,completed:me}),ze(null),st(!0);return}const ie=b.nodes[I];if(!ie)return;const ve=bn(b.text,ie);it({title:V,before:ve.before,after:ve.after,fragmentId:ie.id,total:he,completed:me}),ze(ve.fragment),st(!1)},se=()=>{const b=l.current;b&&it(I=>I&&{...I,total:Object.keys(b.nodes).length,completed:q.current.size})},we=()=>{const b=ye[Ae+1];b&&ma(b,Ae+1)},Fe=()=>{if(we(),G&&G.cardType==="vocab"&&G.checkType==="translation-match"&&Y){if(Y.pairs.length===0){Te("incorrect"),st(!0);return}const ie=Y.pairs.reduce((at,rt)=>(at[rt.rightId]=rt.rightLabel,at),{});let ve=0;const Z={};Y.pairs.forEach(at=>{const ct=Y.selection[at.leftId]===at.rightId;Z[at.leftId]=ct?"correct":"incorrect",ct&&(ve+=1)});const Se=Y.pairs.length||1,Oe=ve/Se,Xe=ve===Y.pairs.length;te(at=>({...at,...Z})),Xe?(Te("correct"),st(!0),Nt(0)):(Te("incorrect"),st(!1),Nt(at=>{const rt=at+1;return rt>=Ot&&(Je(!0),st(!0),E(ct=>{if(!ct)return ct;const dt=ct.pairs.reduce((ut,Lt)=>(ut[Lt.leftId]=Lt.rightId,ut),{});return{...ct,selection:dt}})),rt})),_t(Xe,Oe);const He="connection";Promise.all(Y.pairs.map(at=>{const rt=Y.selection[at.leftId]??null,ct=rt?ie[rt]:"",dt={left:at.leftLabel,expected:at.rightLabel,answer:ct,checkType:"translation-match"},ut=new TextEncoder().encode(JSON.stringify(dt));return rn({itemType:He,itemId:at.cardId,checkType:"translation-match",direction:null,revisionType:x.id,evalType:"translation-match",correct:rt===at.rightId,maskBase64:null,payloadBase64:ya(ut),personRoleId:D??null})})).then(()=>{ja(He,G.cardId,G.checkType,G.direction),Kn(i,D)}).catch(()=>{});return}if(Ge.length>0){const ie=Ge.reduce((Z,Se)=>{const Oe=Be[Se.key]??"";return Z[Se.key]=Ft(Oe)===Ft(Se.expected)?"correct":"incorrect",Z},{});Ge.every(({key:Z,expected:Se})=>{const Oe=Be[Z]??"";return C==="exact"&&Ft(Oe)===Ft(Se)})?(Te("correct"),L(ie),st(!0),Nt(0),_t(!0,1),aa({correct:!0,direction:We?`${We} -> computed`:"computed",expectedMap:Ge.reduce((Z,Se)=>(Z[Se.key]=Se.expected,Z),{}),answerMap:Be,evalType:"computed"})):(Te("incorrect"),L(ie),st(!1),Nt(Z=>{const Se=Z+1;return Se>=Ot&&Qe&&(Je(!0),st(!0)),Se}),_t(!1,0),window.setTimeout(()=>{var Se;const Z=dn(k,Ge,M);Z&&bt.current[Z]&&((Se=bt.current[Z])==null||Se.focus())},40),aa({correct:!1,direction:We?`${We} -> computed`:"computed",expectedMap:Ge.reduce((Z,Se)=>(Z[Se.key]=Se.expected,Z),{}),answerMap:Be,evalType:"computed"}));return}if(G&&G.cardType==="info"&&G.infoType==="citation"&&(et!=null&&et.fragmentId)){if(!Ve)return;const ie=Jt(G.direction),ve=(ie==null?void 0:ie.fragmentId)??et.fragmentId,Z=Sa(Ve,Re,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Se=Z.mask,Oe=Z.isCorrect,Xe=Z.percent;Oe?(pe.current[et.fragmentId]=Math.max(pe.current[et.fragmentId]??0,Xe),(pe.current[et.fragmentId]??0)>=ta&&q.current.add(et.fragmentId),se(),Te("correct"),L({}),st(!0),Mt(Se),Nt(0),Xe<100&&Ot<=1&&Je(!0),_t(!0,Xe/100),aa({correct:!0,direction:`quote:${et.fragmentId}`,expected:Ve,answer:Re,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:ve})):(Te("incorrect"),L({}),st(!1),Mt(Se),Nt(He=>{const at=He+1;return at>=Ot&&Qe&&(Je(!0),st(!0)),at}),_t(!1,Xe/100),window.setTimeout(()=>{var He;return(He=vt.current)==null?void 0:He.focus()},40),aa({correct:!1,direction:`quote:${et.fragmentId}`,expected:Ve,answer:Re,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:ve}));return}if(!Ve)return;const b=Aa(Ve,Re,ia),I=C==="exact"&&Ft(Re)===Ft(Ve),V=wa(b),he=I||V,me=xa(b);he?(Te("correct"),L({}),st(!0),Mt(b),Nt(0),me<100&&Ot<=1&&Je(!0),_t(!0,me/100),aa({correct:!0,direction:We?`${We} -> ${Ve}`:null,expected:Ve,answer:Re,evalType:"text"})):(Te("incorrect"),L({}),st(!1),Mt(b),Nt(ie=>{const ve=ie+1;return ve>=Ot&&Qe&&(Je(!0),st(!0)),ve}),_t(!1,me/100),window.setTimeout(()=>{var ie;return(ie=vt.current)==null?void 0:ie.focus()},40),aa({correct:!1,direction:We?`${We} -> ${Ve}`:null,expected:Ve,answer:Re,evalType:"text"}))},_e=b=>{if(we(),!Ve)return;const I=Aa(Ve,b,ia),V=Ft(b)===Ft(Ve),he=wa(I),me=V||he,ie=xa(I);me?(Te("correct"),L({}),st(!0),Mt(I),Nt(0),ie<100&&Ot<=1&&Je(!0),_t(!0,ie/100),aa({correct:!0,direction:"word->language",expected:Ve,answer:b,evalType:"language-select"})):(Te("incorrect"),L({}),st(!1),Mt(I),Nt(ve=>{const Z=ve+1;return Z>=Ot&&Qe&&(Je(!0),st(!0)),Z}),_t(!1,ie/100),aa({correct:!1,direction:"word->language",expected:Ve,answer:b,evalType:"language-select"}))},je=()=>{we(),Te("correct"),st(!0),Nt(0),_t(!0,1),Ve&&aa({correct:!0,direction:"manual",expected:Ve,answer:Re,evalType:"manual"})},$e=()=>{if(_t(!1,0),G&&G.cardType==="info"&&G.infoType==="citation"){Te(null),Ze(""),Je(!1),L({}),st(!1),Mt(null),Nt(0),Ke(b=>Math.min(b+1,ye.length));return}Ma()};a.useEffect(()=>{we()},[Ae,ye]);const Me=b=>{var V;if(b.key!=="Enter")return;if(b.preventDefault(),b.stopPropagation(),Et){Ma();return}const I=Ge.find(he=>!(Be[he.key]??"").trim());if(I){(V=bt.current[I.key])==null||V.focus();return}Fe()},Pe=t.cogita.library.revision.revealModeAfterIncorrect,Qe=Ge.length>0||!!Ve;return e.jsxs(At,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,children:[ke==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${le.total?Math.min(100,Math.max(0,le.current/le.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:le.total?`${Math.min(le.current,le.total)} / ${le.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:re}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",xe).replace("{check}",Ee)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),Q?e.jsxs(e.Fragment,{children:[e.jsx("a",{className:"cta ghost",href:`${v}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${v}/collections/${B}`,children:t.cogita.library.actions.collectionDetail})]}):e.jsx("a",{className:"cta ghost",href:`${v}/list`,children:t.cogita.library.actions.allCards})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:pt?`${pt.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Vt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Vt.currentLevel??"-"," / ",Vt.levelsCount]}):null,pt?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(pt.correct)).replace("{total}",String(pt.total))}),pt.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(pt.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(sr,{outcomes:gt})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[Ct?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:Ct})}):null,e.jsx(Xn,{feedbackToken:X?`${X.kind}-${X.tick}`:tt?"idle":ot??"idle",children:G?e.jsx(e.Fragment,{children:sa?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(Zn,{copy:t,currentCard:G,currentTypeLabel:jt,prompt:We,languages:ge,answer:Re,onAnswerChange:b=>Ze(I=>cn(I,b,Le)),computedExpected:Ge,computedAnswers:Be,onComputedAnswerChange:(b,I)=>Ye(V=>({...V,[b]:cn(V[b]??"",I,Le)})),answerTemplate:k,outputVariables:M,variableValues:fe,computedFieldFeedback:$,feedback:ot,canAdvance:Et,quoteContext:et,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Fe,onSkip:$e,onLanguageSelect:_e,onMarkReviewed:je,onAdvance:Ma,showCorrectAnswer:De,setShowCorrectAnswer:Je,onRevealCorrect:()=>st(!0),answerMask:pa,expectedAnswer:Ve,hasExpectedAnswer:Qe,handleComputedKeyDown:Me,answerInputRef:vt,computedInputRefs:bt,scriptMode:Le,setScriptMode:qe,matchPairs:Y==null?void 0:Y.pairs,matchLeftOrder:Y==null?void 0:Y.leftOrder,matchRightOrder:Y==null?void 0:Y.rightOrder,matchSelection:Y==null?void 0:Y.selection,matchActiveLeft:Y==null?void 0:Y.activeLeft,matchActiveRight:Y==null?void 0:Y.activeRight,matchFeedback:W,onMatchLeftSelect:kn,onMatchRightSelect:Nn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:Q?`${v}/collections/${B}`:`${v}/list`,children:Q?t.cogita.library.actions.collectionDetail:t.cogita.library.actions.allCards})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:ea?`${ra} / ${ea}`:t.cogita.library.revision.progressUnlimited}),ke==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),ke==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),ke==="ready"&&ye.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Pe}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",Ot]})]})]}),Vt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Vt.activeCount," / ",Vt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Vt.counts.map((b,I)=>{const V=I+1,he=Vt.currentLevel===V,me=Vt.percentages[I]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":he,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:V}),e.jsx("strong",{children:b})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,me))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[me.toFixed(1),"%"]})]},`level-${V}`)})})]}):null,qt?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:qt.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:qt.dots.map(b=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,b.value*100))}%`,background:`rgba(${Math.round(255*(1-b.value))}, ${Math.round(200*b.value)}, 80, 0.9)`}},b.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:qt.knownCount})]})]}):null,St?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:jn})]})}):null]})]})]})})})]})]})}const Dn=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],ro={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},io=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],oo=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function lo({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,libraryId:i,collectionId:p}){const[c,u]=a.useState(""),[v,m,S]=Un([]),[_,x,g]=Jn([]),[C,D]=a.useState(null),[y,U]=a.useState(null),[N,ae]=a.useState(null),z=`/#/cogita/library/${i}`;a.useEffect(()=>{fn(i,p).then(A=>u(A.name)).catch(()=>u(t.cogita.library.collections.defaultName))},[i,p,t]),a.useEffect(()=>{Ir({libraryId:i,collectionId:p}).then(A=>{if(!A.graphId||A.graphId==="00000000-0000-0000-0000-000000000000"){m([]),x([]);return}const ye=A.nodes.map(ge=>{var le;const ee=ge.payload??{},ke=ee.position??{x:120,y:120},ue=ee.params??{};return{id:ge.nodeId,type:"default",position:ke,data:{nodeType:ge.nodeType,label:((le=Dn.find(Ie=>Ie.type===ge.nodeType))==null?void 0:le.label)??ge.nodeType,params:ue}}}),J=A.edges.map(ge=>({id:ge.edgeId,source:ge.fromNodeId,target:ge.toNodeId,sourceHandle:ge.fromPort??void 0,targetHandle:ge.toPort??void 0}));m(ye),x(J)}).catch(()=>{m([]),x([])})},[i,p,x,m]);const P=a.useMemo(()=>v.find(A=>A.id===C)??null,[v,C]),B=A=>{var ee;const ye=crypto.randomUUID(),J=((ee=Dn.find(ke=>ke.type===A))==null?void 0:ee.label)??A,ge={...ro[A]};m(ke=>[...ke,{id:ye,type:"default",position:{x:120+ke.length*40,y:120+ke.length*40},data:{nodeType:A,label:J,params:ge}}]),D(ye)},Q=a.useCallback(A=>{x(ye=>Hn({...A,id:crypto.randomUUID()},ye))},[x]),xe=async()=>{U(null);try{await Hs({libraryId:i,collectionId:p,nodes:v.map(A=>({nodeId:A.id,nodeType:A.data.nodeType,payload:{position:A.position,params:A.data.params}})),edges:_.map(A=>({edgeId:A.id,fromNodeId:A.source,fromPort:A.sourceHandle??null,toNodeId:A.target,toPort:A.targetHandle??null}))}),U(t.cogita.library.graph.saveSuccess)}catch{U(t.cogita.library.graph.saveFail)}},Ee=async()=>{try{const A=await Mr({libraryId:i,collectionId:p});ae(A)}catch{ae(null)}},re=A=>{P&&m(ye=>ye.map(J=>J.id===P.id?{...J,data:{...J.data,params:A}}:J))};return e.jsx(At,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${z}/collections/${p}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Ee,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:xe,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Dn.map(A=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>B(A.type),children:A.label},A.type))}),y?e.jsx("p",{className:"cogita-help",children:y}):null,N&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(N.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(N.connections)).replace("{infos}",String(N.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(gn,{nodes:v,edges:_,onNodesChange:S,onEdgesChange:g,onConnect:Q,onNodeClick:(A,ye)=>D(ye.id),fitView:!0,children:[e.jsx(mn,{color:"rgba(120,160,200,0.2)"}),e.jsx(pn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),P?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:P.data.label}),P.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Gt,{libraryId:i,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:P.data.params.tagId?{id:P.data.params.tagId,label:P.data.params.tagLabel??"",infoType:"topic"}:null,onChange:A=>re({...P.data.params,tagId:(A==null?void 0:A.id)??null,tagLabel:(A==null?void 0:A.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:P.data.params.scope??"any",onChange:A=>re({...P.data.params,scope:A.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),P.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Gt,{libraryId:i,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:P.data.params.languageId?{id:P.data.params.languageId,label:P.data.params.languageLabel??"",infoType:"language"}:null,onChange:A=>re({...P.data.params,languageId:(A==null?void 0:A.id)??null,languageLabel:(A==null?void 0:A.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:P.data.params.scope??"any",onChange:A=>re({...P.data.params,scope:A.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),P.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:P.data.params.infoType??"word",onChange:A=>re({...P.data.params,infoType:A.target.value}),children:oo.map(A=>e.jsx("option",{value:A.value,children:A.label},A.value))})]}),e.jsx(Gt,{libraryId:i,infoType:P.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:P.data.params.infoId?{id:P.data.params.infoId,label:P.data.params.infoLabel??"",infoType:P.data.params.infoType??"word"}:null,onChange:A=>re({...P.data.params,infoId:(A==null?void 0:A.id)??null,infoLabel:(A==null?void 0:A.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),P.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:P.data.params.connectionType??"translation",onChange:A=>re({...P.data.params,connectionType:A.target.value}),children:io.map(A=>e.jsx("option",{value:A.value,children:A.label},A.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:P.data.params.connectionId??"",onChange:A=>re({...P.data.params,connectionId:A.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(P.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const _n="cogita.preferences",zn="cogita.reviewer.preferences",lr=["library_overview","all_cards","all_collections","all_revisions","storyboards","texts","dependencies","transfer"],Bn={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},all_revisions:{requiresCollection:!1,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},co=["settings","run","shared"];function uo(t,n=""){const r=t.split("/").filter(Boolean);if(r[0]!=="cogita"||r[1]!=="library")return{};const s=r[2];if(!s)return{};if(!r[3])return{libraryId:s,target:"library_overview"};const o=new URLSearchParams(n),h=o.get("revisionId")??void 0,d=o.get("infoId")??void 0,w=o.get("infoView"),f=w==="cards"?"cards":w==="collections"?"collections":"overview",j=o.get("collectionView")==="overview"?"overview":"infos",i=o.get("collectionAction"),p=o.get("libraryAction"),u=o.get("libraryTarget")==="revisions"?"all_revisions":"all_collections";if(r[3]==="list")return{libraryId:s,target:p==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:h,infoId:d,infoView:f,libraryAction:p==="new-info"?"new-info":void 0};if(r[3]==="detail"||r[3]==="collection")return{libraryId:s,target:"all_cards",cardMode:r[3],revisionId:h,infoId:d,infoView:f};if(r[3]==="new"||r[3]==="add")return{libraryId:s,target:"new_card",revisionId:h,libraryAction:"new-info"};if(r[3]==="edit")return{libraryId:s,target:"new_card",revisionId:h,infoId:r[4]};if(r[3]==="infos"){const m=r[4];return m?r[5]==="checkcards"?{libraryId:s,target:"all_cards",cardMode:"list",revisionId:h,infoId:m,infoView:"cards"}:r[5]==="collections"?{libraryId:s,target:"all_cards",cardMode:"list",revisionId:h,infoId:m,infoView:"collections"}:{libraryId:s,target:"all_cards",cardMode:"list",revisionId:h,infoId:m,infoView:"overview"}:{libraryId:s,target:"all_cards",cardMode:"list",revisionId:h}}if(r[3]==="shared-revisions")return{libraryId:s,target:u,revisionId:h};if(r[3]==="revisions"){const m=r[4];return m?m==="new"?{libraryId:s,target:"all_revisions",revisionView:"new"}:r[5]==="run"?{libraryId:s,target:"all_revisions",revisionId:m,revisionView:"run"}:r[5]==="shared"?{libraryId:s,target:"all_revisions",revisionId:m,revisionView:"shared"}:{libraryId:s,target:"all_revisions",revisionId:m,revisionView:"settings"}:{libraryId:s,target:"all_revisions"}}if(r[3]==="revision"&&r[4]==="run")return{libraryId:s,target:u,revisionView:"run",revisionId:h,infoId:d,infoView:f};if(r[3]==="dependencies")return{libraryId:s,target:"dependencies"};if(r[3]==="transfer")return{libraryId:s,target:"transfer"};if(r[3]==="storyboards")return r[4]==="new"?{libraryId:s,target:"new_storyboard"}:{libraryId:s,target:"storyboards"};if(r[3]==="texts")return r[4]==="new"?{libraryId:s,target:"new_text"}:{libraryId:s,target:"texts"};if(r[3]!=="collections")return{libraryId:s,target:"library_overview"};if(r[4]==="new")return{libraryId:s,target:"new_collection",revisionId:h};const v=r[4];return v?r[5]==="graph"?{libraryId:s,target:u,collectionId:v,revisionId:h,revisionView:"graph"}:r[5]==="shared-revisions"?{libraryId:s,target:u,collectionId:v,revisionId:h,revisionView:"shared"}:r[5]==="revision"?{libraryId:s,target:u,collectionId:v,revisionId:h,revisionView:r[6]==="run"?"run":"settings",collectionView:j}:i==="new-revision"?{libraryId:s,target:u,collectionId:v,revisionId:h,revisionView:"new"}:{libraryId:s,target:u,collectionId:v,revisionId:h,revisionView:"detail",collectionView:j}:i==="new-collection"?{libraryId:s,target:"new_collection",collectionAction:"new-collection"}:{libraryId:s,target:u}}function Ks(t,n="library_overview",r,s,o,h,d="overview",w="infos"){const f=(j,i)=>{const p=new URLSearchParams;i!=null&&i.revisionId&&p.set("revisionId",i.revisionId),i!=null&&i.collectionAction&&p.set("collectionAction",i.collectionAction),i!=null&&i.libraryAction&&p.set("libraryAction",i.libraryAction),i!=null&&i.libraryTarget&&p.set("libraryTarget",i.libraryTarget),i!=null&&i.infoId&&p.set("infoId",i.infoId),i!=null&&i.infoView&&(i!=null&&i.infoId)&&p.set("infoView",i.infoView),i!=null&&i.collectionView&&i.collectionView!=="infos"&&p.set("collectionView",i.collectionView);const c=p.toString();return c?`${j}?${c}`:j};if(!t)return"/cogita";if(n==="library_overview")return f(`/cogita/library/${t}`,{revisionId:o});if(n==="all_cards")return h?d==="cards"?f(`/cogita/library/${t}/infos/${h}/checkcards`,{revisionId:o}):d==="collections"?f(`/cogita/library/${t}/infos/${h}/collections`,{revisionId:o}):f(`/cogita/library/${t}/infos/${h}`,{revisionId:o}):f(`/cogita/library/${t}/list`,{revisionId:o,infoId:h,infoView:d});if(n==="new_card")return h?f(`/cogita/library/${t}/edit/${h}`,{revisionId:o}):f(`/cogita/library/${t}/list`,{revisionId:o,libraryAction:"new-info"});if(n==="all_collections"||n==="all_revisions"){const j=n==="all_revisions"?"revisions":void 0;return n==="all_revisions"&&o?s==="run"?f(`/cogita/library/${t}/revisions/${o}/run`,{revisionId:o}):s==="shared"?f(`/cogita/library/${t}/revisions/${o}/shared`,{revisionId:o}):f(`/cogita/library/${t}/revisions/${o}`,{revisionId:o}):n==="all_revisions"&&s==="new"?f(`/cogita/library/${t}/revisions/new`,{revisionId:o}):n==="all_revisions"?s==="run"?f(`/cogita/library/${t}/revision/run`,{revisionId:o,libraryTarget:j}):f(`/cogita/library/${t}/revisions`,{revisionId:o}):!r&&s==="run"?f(`/cogita/library/${t}/revision/run`,{revisionId:o,libraryTarget:j}):r?s==="graph"?f(`/cogita/library/${t}/collections/${r}/graph`,{revisionId:o,libraryTarget:j}):s==="settings"?f(`/cogita/library/${t}/collections/${r}/revision`,{revisionId:o,libraryTarget:j}):s==="run"?f(`/cogita/library/${t}/collections/${r}/revision/run`,{revisionId:o,libraryTarget:j}):s==="shared"?f(`/cogita/library/${t}/collections/${r}/shared-revisions`,{revisionId:o,libraryTarget:j}):s==="new"?f(`/cogita/library/${t}/collections/${r}`,{revisionId:o,libraryTarget:j,collectionAction:"new-revision"}):f(`/cogita/library/${t}/collections/${r}`,{revisionId:o,libraryTarget:j,collectionView:w}):f(`/cogita/library/${t}/collections`,{revisionId:o,libraryTarget:j})}return n==="new_collection"?f(`/cogita/library/${t}/collections`,{revisionId:o,collectionAction:"new-collection"}):n==="transfer"?f(`/cogita/library/${t}/transfer`,{revisionId:o}):n==="storyboards"?f(`/cogita/library/${t}/storyboards`,{revisionId:o}):n==="new_storyboard"?f(`/cogita/library/${t}/storyboards/new`,{revisionId:o}):n==="texts"?f(`/cogita/library/${t}/texts`,{revisionId:o}):n==="new_text"?f(`/cogita/library/${t}/texts/new`,{revisionId:o}):n==="dependencies"?f(`/cogita/library/${t}/dependencies`,{revisionId:o}):f(`/cogita/library/${t}`,{revisionId:o})}function ba(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function ho(t){return typeof t=="string"&&lr.includes(t)}function go(t,n){var w;if(!t.length)return null;const r=t.filter(f=>n.has(f.roleId)),s=r.length>0?r:t,o=s.map(f=>{var i,p;const j=((p=(i=f.fields.find(c=>c.fieldType==="role_kind"))==null?void 0:i.plainValue)==null?void 0:p.toLowerCase())??"";return{roleId:f.roleId,roleKind:j}}),h=o.find(f=>f.roleKind.includes("master"));if(h)return h.roleId;const d=o.find(f=>f.roleKind.includes("account")||f.roleKind.includes("user"));return d?d.roleId:((w=s[0])==null?void 0:w.roleId)??null}function mo(t){if(!t)return{version:1,byLibrary:{}};try{const n=JSON.parse(t);return!n||typeof n!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:n.lastLibraryId,byLibrary:n.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function po({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j}){const i=hn(),p=qa(),c=a.useMemo(()=>uo(p.pathname,p.search),[p.pathname,p.search]),u=t.cogita.workspace,[v,m]=a.useState([]),[S,_]=a.useState([]),[x,g]=a.useState([]),[C,D]=a.useState([]),[y,U]=a.useState(void 0),[N,ae]=a.useState("library_overview"),[z,P]=a.useState(void 0),[B,Q]=a.useState(void 0),[xe,Ee]=a.useState("detail"),[re,A]=a.useState(void 0),[ye,J]=a.useState(!1),[ge,ee]=a.useState(!0),[ke,ue]=a.useState(!1),[le,Ie]=a.useState(!1),[Ae,Ke]=a.useState(null),[Re,Ze]=a.useState(0),[ot,Te]=a.useState(""),[We,ft]=a.useState(""),[Ve,ze]=a.useState(""),[et,it]=a.useState([]),[Ge,Ce]=a.useState(""),[Be,Ye]=a.useState(0),[$,L]=a.useState(null),[K,R]=a.useState(null),k=a.useRef({version:1,byLibrary:{}}),T=a.useRef(!1),M=a.useRef(!1),oe=a.useRef(null),fe=a.useMemo(()=>v.find(l=>l.libraryId===y)??null,[v,y]),de=a.useMemo(()=>S.find(l=>l.collectionId===z)??null,[S,z]),Y=ba(p.pathname)==="/cogita/persons";a.useEffect(()=>{if(!y){it([]),Ce("");return}let l=!1;return Ws({libraryId:y}).then(q=>{if(l)return;const pe=q.filter(G=>(G.roleKind??"").trim().toLowerCase()==="person");it(pe);try{const G=window.localStorage.getItem(zn),lt=(G?JSON.parse(G):{})[y]??"",wt=lt&&pe.some(It=>It.roleId===lt)?lt:"";Ce(wt)}catch{Ce("")}}).catch(()=>{l||(it([]),Ce(""))}),()=>{l=!0}},[y,Be]),a.useEffect(()=>{if(y)try{const l=window.localStorage.getItem(zn),q=l?JSON.parse(l):{};Ge?q[y]=Ge:delete q[y],window.localStorage.setItem(zn,JSON.stringify(q))}catch{}},[y,Ge]);const E=a.useMemo(()=>C.find(l=>l.revisionId===B)??null,[C,B]),W=a.useMemo(()=>({detail:u.revisions.detail,graph:u.revisions.graph,settings:u.revisions.settings,run:u.revisions.run,shared:u.targets.sharedRevisions,new:u.revisionForm.createAction}),[u.revisions.detail,u.revisions.graph,u.revisions.run,u.revisions.settings,u.targets.sharedRevisions,u.revisionForm.createAction]),te=a.useMemo(()=>N==="new_card"?"all_cards":N==="new_collection"?"all_collections":N==="new_storyboard"?"storyboards":N==="new_text"?"texts":N,[N]),H=a.useMemo(()=>xe==="new"?"settings":xe,[xe]),X=N==="all_collections"||N==="all_revisions",be=a.useMemo(()=>N==="new_collection"?"create":N==="all_collections"&&z?"selected":"search",[z,N]),O=a.useMemo(()=>c.infoId?"selected":N==="new_card"?"create":"search",[c.infoId,N]),ne=a.useMemo(()=>x.find(l=>l.infoId===c.infoId)??null,[x,c.infoId]),Le=a.useMemo(()=>({library_overview:u.targets.libraryOverview,all_cards:u.targets.allCards,new_card:u.targets.newCard,all_collections:u.targets.allCollections,all_revisions:u.targets.allRevisions,new_collection:u.targets.newCollection,transfer:u.targets.transfer,storyboards:u.targets.storyboards,new_storyboard:u.targets.newStoryboard,texts:u.targets.texts,new_text:u.targets.newText,dependencies:u.targets.dependencies}),[u.targets]),qe=a.useMemo(()=>Le[te]??te,[te,Le]),De=W[H],Je=!!y,pt=a.useMemo(()=>{const l=f==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":f==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return f==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:l},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:l},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:l},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:l},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:l},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:l},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:l},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:l},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:l},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:l},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:l},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:l},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:l},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:f==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:l},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:l},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:l},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:l},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:l},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:l},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:l},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:l},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:l},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:l},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:l},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:l},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:l},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:l},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:l},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:l},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:l},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:l},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:l},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:l},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:l},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:l},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:l},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:l},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:l},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:l},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[f]),ht=pt.length,gt=Math.max(0,Math.min(Re,ht-1)),yt=pt[gt],Ct=!!z,zt=Je&&N==="all_collections",Rt=Ct&&N==="all_collections",kt=Je&&(N==="all_revisions"||Ct&&N==="all_collections")&&(H==="settings"||H==="run"||H==="shared"||N==="all_revisions"),pa=kt,Mt=kt&&!!B,xt=a.useCallback(l=>{const q=!!l.libraryId;let pe=l.target,G=l.collectionId,tt=l.revisionId,lt=l.revisionView,wt=l.infoId,It=l.infoView??c.infoView??"overview",$t=l.collectionView??c.collectionView??"infos";q?Bn[pe].requiresCollection&&!G?(pe=pe==="all_revisions"?"all_revisions":"all_collections",tt=void 0,lt="detail"):pe!=="all_collections"&&pe!=="all_revisions"?(G=void 0,tt=void 0,pe!=="new_card"&&pe!=="all_cards"&&(wt=void 0,It="overview"),pe!=="new_collection"&&($t="infos")):Bn[pe].allowsRevision?co.includes(lt)||(tt=void 0):lt="detail":(pe="library_overview",G=void 0,tt=void 0,lt="detail",wt=void 0,It="overview",$t="infos"),U(l.libraryId),ae(pe),P(G),Q(tt),Ee(lt),J(!1);const jt=ba(Ks(l.libraryId,pe,G,lt,tt,wt,It,$t));ba(`${p.pathname}${p.search}`)!==jt&&(oe.current=jt,i(jt))},[p.pathname,p.search,i,c.collectionView,c.infoView]),Nt=a.useMemo(()=>[{key:"library",label:u.layers.library,visible:!0,value:y??"",selectedLabel:(fe==null?void 0:fe.name)??u.path.noLibrarySelected,disabled:ge||v.length===0,options:v.map(l=>({value:l.libraryId,label:l.name})),emptyOption:u.noLibraryOption,onSelect:l=>{const q=l||void 0;xt({libraryId:q,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:u.layers.target,visible:Je,value:te,selectedLabel:qe,disabled:!Je,options:lr.map(l=>({value:l,label:Le[l]})),onSelect:l=>{const q=l;xt({libraryId:y,target:q,collectionId:z,revisionId:B,revisionView:xe,infoId:q==="new_card"?c.infoId:void 0})}},{key:"info_mode",label:u.layers.target,visible:te==="all_cards",value:O,selectedLabel:O==="create"?u.infoMode.create:O==="selected"?(ne==null?void 0:ne.label)??re??t.cogita.library.list.selectedEmpty:u.infoMode.search,disabled:!Je,options:[{value:"search",label:u.infoMode.search},{value:"create",label:u.infoMode.create},...c.infoId?[{value:"selected",label:(ne==null?void 0:ne.label)??re??t.cogita.library.list.selectedEmpty}]:[]],onSelect:l=>{if(l==="selected"){if(!c.infoId)return;xt({libraryId:y,target:"all_cards",collectionId:z,revisionId:B,revisionView:xe,infoId:c.infoId,infoView:"overview"});return}if(l==="create"){xt({libraryId:y,target:"new_card",collectionId:z,revisionId:B,revisionView:xe,infoId:void 0});return}xt({libraryId:y,target:"all_cards",collectionId:z,revisionId:B,revisionView:xe,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:u.layers.target,visible:te==="all_cards"&&!!c.infoId,value:N==="new_card"&&c.infoId?"edit":c.infoView==="cards"?"cards":c.infoView==="collections"?"collections":"overview",selectedLabel:N==="new_card"&&c.infoId?u.infoActions.edit:c.infoView==="cards"?u.infoActions.seeCards:c.infoView==="collections"?"Kolekcje":u.infoActions.overview,disabled:!Je||!c.infoId,options:[{value:"overview",label:u.infoActions.overview},{value:"edit",label:u.infoActions.edit},{value:"cards",label:u.infoActions.seeCards},{value:"collections",label:"Kolekcje"}],onSelect:l=>{if(c.infoId){if(l==="edit"){xt({libraryId:y,target:"new_card",collectionId:z,revisionId:B,revisionView:xe,infoId:c.infoId});return}if(l==="cards"){xt({libraryId:y,target:"all_cards",collectionId:z,revisionId:B,revisionView:xe,infoId:c.infoId,infoView:"cards"});return}xt({libraryId:y,target:"all_cards",collectionId:z,revisionId:B,revisionView:xe,infoId:c.infoId,infoView:"overview"})}}},{key:"collection_mode",label:u.layers.collection,visible:Je&&(N==="all_collections"||N==="new_collection"),value:be,selectedLabel:be==="create"?t.cogita.library.actions.createCollection:be==="selected"?(de==null?void 0:de.name)??u.path.noCollectionSelected:t.cogita.library.actions.collections,disabled:!Je,options:[{value:"search",label:t.cogita.library.actions.collections},{value:"create",label:t.cogita.library.actions.createCollection},...z&&de?[{value:"selected",label:de.name}]:[]],onSelect:l=>{if(l==="create"){xt({libraryId:y,target:"new_collection",collectionId:void 0,revisionId:void 0,revisionView:"detail"});return}if(l==="selected"&&z){const q=X?N:"all_collections";xt({libraryId:y,target:q,collectionId:z,revisionId:B,revisionView:q==="all_revisions"?"settings":"detail"});return}if(l==="collections"){xt({libraryId:y,target:"all_cards",collectionId:z,revisionId:B,revisionView:xe,infoId:c.infoId,infoView:"collections"});return}xt({libraryId:y,target:X?N:"all_collections",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection",label:u.layers.collection,visible:zt&&be!=="create",value:z??"",selectedLabel:(de==null?void 0:de.name)??u.path.noCollectionSelected,disabled:!Je||ke||S.length===0,options:S.map(l=>({value:l.collectionId,label:l.name})),emptyOption:u.selectCollectionOption,onSelect:l=>{const q=l||void 0,pe=X?N:"all_collections";xt({libraryId:y,target:pe,collectionId:q,revisionId:void 0,revisionView:pe==="all_revisions"?"settings":"detail"})}},{key:"collection_selected_action",label:u.layers.revision,visible:Rt,value:N==="all_revisions"?"revisions":H==="graph"?"edit":H==="settings"||H==="run"||H==="shared"?"revisions":(c.collectionView??"infos")==="overview"?"overview":"infos",selectedLabel:N==="all_revisions"?u.targets.allRevisions:H==="graph"?"Edytuj":H==="settings"||H==="run"||H==="shared"?u.targets.allRevisions:(c.collectionView??"infos")==="overview"?"Przegląd":"Informacje",disabled:!z,options:[{value:"overview",label:"Przegląd"},{value:"edit",label:"Edytuj"},{value:"infos",label:"Informacje"},{value:"revisions",label:u.targets.allRevisions}],onSelect:l=>{if(z){if(l==="edit"){xt({libraryId:y,target:X?N:"all_collections",collectionId:z,revisionId:void 0,revisionView:"graph"});return}if(l==="revisions"){xt({libraryId:y,target:X?N:"all_collections",collectionId:z,revisionId:B,revisionView:"settings"});return}xt({libraryId:y,target:X?N:"all_collections",collectionId:z,revisionId:void 0,revisionView:"detail",infoId:c.infoId,infoView:c.infoView,collectionView:l==="overview"?"overview":"infos"})}}},{key:"revision_entry",label:u.layers.revision,visible:pa,value:B??"",selectedLabel:(E==null?void 0:E.name)??u.status.noRevisions,disabled:(N==="all_revisions"?!Je:!Ct)||le||C.length===0,options:C.map(l=>({value:l.revisionId,label:l.name})),emptyOption:u.status.noRevisions,onSelect:l=>{xt({libraryId:y,target:X?N:"all_collections",collectionId:z,revisionId:l||void 0,revisionView:H==="settings"||H==="run"||H==="shared"?H:"settings"})}},{key:"revision_selected_action",label:u.layers.revision,visible:Mt,value:H==="run"?"run":H==="shared"?"shared":"settings",selectedLabel:H==="run"?u.revisions.run:H==="shared"?u.targets.sharedRevisions:u.revisions.settings,disabled:!z||!B,options:[{value:"settings",label:u.revisions.settings},{value:"run",label:u.revisions.run},{value:"shared",label:u.targets.sharedRevisions}],onSelect:l=>{!z||!B||xt({libraryId:y,target:X?N:"all_collections",collectionId:z,revisionId:B,revisionView:l==="run"?"run":l==="shared"?"shared":"settings"})}}],[S,ke,O,x,v,ge,xt,C,le,de,z,ne,E,B,re,Ct,Je,fe,X,y,De,xe,N,H,te,qe,zt,Rt,pa,Mt,Le,t.cogita.library.list.selectedEmpty,c.infoId,c.infoView,c.collectionView,u.infoActions.edit,u.infoActions.overview,u.infoActions.seeCards,u.layers.collection,u.layers.library,u.layers.revision,u.layers.target,u.noLibraryOption,u.path.noCollectionSelected,u.path.noLibrarySelected,u.selectCollectionOption,u.targets.allRevisions,u.revisions.run,u.revisions.settings,u.targets.sharedRevisions,be]),vt=a.useMemo(()=>Nt.filter(l=>l.visible),[Nt]),bt=a.useMemo(()=>vt.filter(l=>l.key!=="library"&&l.key!=="collection"),[vt]),Et=a.useMemo(()=>bt.find(l=>l.key==="target")??null,[bt]),st=a.useMemo(()=>bt.find(l=>l.key==="info_mode")??null,[bt]),Ue=a.useMemo(()=>bt.find(l=>l.key==="info_selected_action")??null,[bt]),mt=a.useMemo(()=>bt.find(l=>l.key==="collection_mode")??null,[bt]),Ht=a.useMemo(()=>bt.find(l=>l.key==="collection_selected_action")??null,[bt]),Kt=a.useMemo(()=>bt.find(l=>l.key==="revision_entry")??null,[bt]),Dt=a.useMemo(()=>bt.find(l=>l.key==="revision_selected_action")??null,[bt]),ce=a.useCallback((l,q)=>l?e.jsx("div",{className:"cogita-sidebar-actions",children:l.options.map(pe=>e.jsx("button",{type:"button",className:`ghost ${String(l.value)===pe.value?"active":""}`,onClick:()=>l.onSelect(pe.value),disabled:l.disabled,children:pe.label},`${q}:${l.key}:${pe.value}`))}):null,[]),Zt=a.useMemo(()=>{const l=c.libraryId;if(!l||!p.pathname.startsWith("/cogita/library/"))return null;const q={copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,libraryId:l};if(c.target==="library_overview")return e.jsx(Yr,{...q});if(c.target==="all_cards")return c.infoId&&c.infoView==="cards"?e.jsx(Ii,{...q,infoId:c.infoId,selectedReviewerRoleId:Ge||null}):e.jsx(ci,{...q,mode:c.cardMode??"list"});if(c.target==="new_card")return e.jsx(xi,{...q,editInfoId:c.infoId});if(c.target==="dependencies")return e.jsx(wi,{...q});if(c.target==="transfer")return e.jsx($i,{...q});if(c.target==="storyboards"||c.target==="new_storyboard")return e.jsx(Pi,{...q});if(c.target==="texts"||c.target==="new_text")return e.jsx(Ei,{...q});if(c.target==="all_collections"||c.target==="all_revisions"){if(c.target==="all_revisions"&&!c.collectionId)return c.revisionView==="run"?e.jsx(Fn,{...q,revisionId:c.revisionId}):e.jsx(Es,{...q,revisionId:c.revisionId});if(!c.collectionId&&c.revisionView==="run")return e.jsx(Fn,{...q,revisionId:c.revisionId});if(c.collectionId){const pe={...q,collectionId:c.collectionId};return c.revisionView==="graph"?e.jsx(lo,{...pe}):c.revisionView==="shared"?e.jsx(Ri,{...q,collectionId:c.collectionId}):c.revisionView==="settings"?e.jsx(Es,{...pe,revisionId:c.revisionId}):c.revisionView==="run"?e.jsx(Fn,{...pe,revisionId:c.revisionId}):e.jsx(Fi,{...pe})}return e.jsx(Ki,{...q})}return c.target==="new_collection"?e.jsx(Bi,{...q,onCreated:pe=>{xt({libraryId:l,target:N==="all_revisions"?"all_revisions":"all_collections",collectionId:pe,revisionId:void 0,revisionView:"graph"})}}):null},[n,xt,t,f,p.pathname,i,j,h,w,s,o,c.cardMode,c.collectionId,c.infoId,c.libraryId,c.revisionId,c.revisionView,c.target,d,r,N,Ge]);a.useEffect(()=>{let l=!1;return(async()=>{var pe,G,tt,lt,wt;ee(!0);try{await Lr();const[It,$t,jt]=await Promise.all([Bs(),qs(),Ar()]);if(l)return;m(It);const Wt=new Set(jt.nodes.filter(Pt=>Pt.nodeType==="role"&&Pt.canLink).map(Pt=>Pt.roleId??"")),ea=go($t,Wt);if(L(ea),ea){const Pt=jt.nodes.find(St=>St.nodeType==="data"&&St.roleId===ea&&(St.fieldType===_n||St.label===_n));R((Pt==null?void 0:Pt.dataKeyId)??null),k.current=mo(Pt==null?void 0:Pt.value)}const ra=(pe=It.find(Pt=>Pt.libraryId===c.libraryId))==null?void 0:pe.libraryId,Ot=ra?(tt=(G=k.current.byLibrary)==null?void 0:G[ra])==null?void 0:tt.lastTarget:void 0,ia=ho(Ot)?Ot:"library_overview";U(ra),ae(c.target??ia),Q(c.revisionId??(ra?(wt=(lt=k.current.byLibrary)==null?void 0:lt[ra])==null?void 0:wt.lastRevisionId:void 0)),Ee(c.revisionView??"detail"),T.current=!0}catch{l||Ke(u.status.loadFailed)}finally{l||ee(!1)}})(),()=>{l=!0}},[u.status.loadFailed]),a.useLayoutEffect(()=>{if(T.current){if(!c.libraryId){U(void 0),ae(c.target??"library_overview"),P(void 0),Q(void 0),Ee("detail");return}c.libraryId&&v.some(l=>l.libraryId===c.libraryId)&&U(c.libraryId),c.target&&ae(c.target),P(c.collectionId),Q(c.revisionId),c.revisionView&&Ee(c.revisionView)}},[v,c.collectionId,c.libraryId,c.revisionId,c.revisionView,c.target]),a.useEffect(()=>{if(!y){_([]),P(void 0),g([]),D([]),Q(void 0);return}let l=!1;return ue(!0),Ba({libraryId:y,limit:200}).then(q=>{var tt;if(l)return;const pe=q.items;_(pe);const G=(tt=pe.find(lt=>lt.collectionId===c.collectionId))==null?void 0:tt.collectionId;P(G)}).catch(()=>{l||(_([]),P(void 0))}).finally(()=>{l||ue(!1)}),()=>{l=!0}},[c.collectionId,y]),a.useEffect(()=>{if(!y||te!=="all_cards"&&N!=="new_card"){g([]);return}let l=!1;return Gn({libraryId:y,limit:200}).then(q=>{l||g(q)}).catch(()=>{l||g([])}),()=>{l=!0}},[te,y,N]),a.useEffect(()=>{if(!y||N!=="all_revisions"&&!z){D([]),N!=="all_revisions"&&Q(void 0);return}let l=!1;return Ie(!0),Wn({libraryId:y,collectionId:N==="all_revisions"?void 0:z}).then(q=>{var tt,lt,wt,It;if(l)return;D(q);const pe=(lt=(tt=k.current.byLibrary)==null?void 0:tt[y])==null?void 0:lt.lastRevisionId,G=((wt=q.find($t=>$t.revisionId===c.revisionId))==null?void 0:wt.revisionId)??((It=q.find($t=>$t.revisionId===pe))==null?void 0:It.revisionId);Q(G)}).catch(()=>{l||(D([]),Q(void 0))}).finally(()=>{l||Ie(!1)}),()=>{l=!0}},[c.revisionId,z,y,N]),a.useEffect(()=>{const l=c.infoId;if(!y||!l){A(void 0);return}let q=!1;return na({libraryId:y,infoId:l}).then(pe=>{if(q)return;const G=pe.payload??{},tt=G.definition&&typeof G.definition=="object"?G.definition:null,lt=typeof(tt==null?void 0:tt.title)=="string"?tt.title:void 0,wt=typeof(tt==null?void 0:tt.question)=="string"?tt.question:void 0,It=typeof G.label=="string"?G.label:void 0,$t=typeof G.name=="string"?G.name:void 0,jt=typeof G.title=="string"?G.title:void 0;A(lt??wt??It??$t??jt??pe.infoId)}).catch(()=>{q||A(l)}),()=>{q=!0}},[c.infoId,y]),a.useEffect(()=>{if(!T.current||c.libraryId&&v.some(tt=>tt.libraryId===c.libraryId)&&c.libraryId!==y||c.target&&c.target!==N||c.revisionView&&c.revisionView!==xe||c.revisionId&&c.revisionId!==B||Bn[N].requiresCollection&&!z&&(c.target==="all_collections"||c.target==="all_revisions")&&c.collectionId)return;const l=ba(`${p.pathname}${p.search}`);if(ba(p.pathname)==="/cogita"&&!c.libraryId&&!y){oe.current=null;return}if(ba(p.pathname)==="/cogita/persons"){oe.current=null;return}if(ba(p.pathname)===`/cogita/library/${y}/revision/run`&&c.revisionView==="run"&&!c.collectionId&&(N==="all_collections"||N==="all_revisions")&&xe==="run"&&!z){oe.current=null;return}const G=ba(Ks(y,N,z,xe,B,c.infoId,c.infoView??"overview",c.collectionView??"infos"));if(l===G){oe.current=null;return}oe.current!==G&&(oe.current=G,i(G,{replace:!0}))},[v,p.pathname,p.search,i,c.collectionId,c.infoId,c.infoView,c.collectionView,c.libraryId,c.revisionId,c.revisionView,c.target,z,y,B,xe,N]),a.useEffect(()=>{if(typeof window>"u")return;const l=()=>{window.innerWidth>920&&J(!1)};return window.addEventListener("resize",l),()=>window.removeEventListener("resize",l)},[]),a.useEffect(()=>{if(!T.current||!$||!y||M.current)return;const l=k.current,q={...l.byLibrary??{}},pe={...q[y]??{},lastCollectionId:z,lastRevisionId:B,lastRevisionView:xe,lastTarget:N},G={version:1,lastLibraryId:y,byLibrary:{...q,[y]:pe}},tt=JSON.stringify(l),lt=JSON.stringify(G);if(tt===lt)return;k.current=G,M.current=!0,(async()=>{try{if(K)await Rr(K,{plainValue:lt});else{const It=await $r($,{itemName:_n,itemType:"data",plainValue:lt});R(It.dataItemId)}}catch{Ke(u.status.savePrefsFailed)}finally{M.current=!1}})()},[K,$,z,y,B,xe,N,u.status.savePrefsFailed]);const sa=async()=>{const l=ot.trim();if(!l){Ke(t.cogita.user.libraryNameRequired);return}Ke(null);try{const q=await Er({name:l});m(pe=>[q,...pe]),U(q.libraryId),ae("library_overview"),P(void 0),Te("")}catch{Ke(t.cogita.user.libraryCreateFailed)}},Bt=async()=>{if(!y||!z){Ke(u.status.selectLibraryFirst);return}const l=Ve.trim();if(!l){Ke(u.revisionForm.nameLabel);return}Ke(null);try{const q=await Pr({libraryId:y,collectionId:z,name:l,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});D(pe=>[q,...pe]),Q(q.revisionId),ae(N==="all_revisions"?"all_revisions":"all_collections"),Ee("settings"),ze("")}catch{Ke(u.status.loadFailed)}};return e.jsx(At,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,headerExtra:e.jsxs("div",{className:"cogita-header-reviewer-actions",children:[e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:Ge,disabled:!y,onChange:l=>{const q=l.target.value;if(q==="__new_person__"){i("/cogita/persons");return}Ce(q)},children:[e.jsx("option",{value:"",children:y?"No person":"Select library first"}),et.map(l=>e.jsx("option",{value:l.roleId,children:l.label},l.roleId)),e.jsx("option",{value:"__new_person__",children:"+ Create new person"})]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>i("/cogita/persons"),children:"Persons"})]}),children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${ye?"open":""}`,"aria-label":u.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{children:(fe==null?void 0:fe.name)??u.path.noLibrarySelected}),e.jsx("p",{className:"cogita-sidebar-note",children:fe?u.sidebar.libraryActionsHint:u.status.selectLibraryFirst}),ce(Et,"sidebar"),N==="all_revisions"&&Kt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:u.targets.allRevisions}),ce(Kt,"sidebar"),Dt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(E==null?void 0:E.name)??u.status.noRevisions}),ce(Dt,"sidebar")]}):null]}):null,st?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:u.sidebar.infoActionsHint}),ce(st,"sidebar"),Ue?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(ne==null?void 0:ne.label)??re??t.cogita.library.list.selectedEmpty}),e.jsx("p",{className:"cogita-sidebar-note",children:u.sidebar.selectedInfoActionsHint}),ce(Ue,"sidebar")]}):null]}):null,mt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:u.sidebar.collectionActionsHint}),ce(mt,"sidebar"),de&&Ht?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:de.name}),ce(Ht,"sidebar"),N!=="all_revisions"&&Kt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(E==null?void 0:E.name)??u.status.noRevisions}),ce(Kt,"sidebar"),Dt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:u.layers.revision}),ce(Dt,"sidebar")]}):null]}):null]}):null]}):null]}),e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:u.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:s,children:u.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{w("cogita"),J(!1)},children:u.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:o,children:d?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),ye?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":u.sidebar.closeMenu,onClick:()=>J(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":u.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>J(l=>!l),"aria-label":ye?u.sidebar.closeMenu:u.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),vt.map((l,q)=>e.jsxs("div",{className:"cogita-browser-segment",children:[q>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,l.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":l.label,children:l.selectedLabel}):e.jsxs("select",{"aria-label":l.label,value:l.value,onChange:pe=>l.onSelect(pe.target.value),disabled:l.disabled,children:[l.emptyOption?e.jsx("option",{value:"",children:l.emptyOption}):null,l.options.map(pe=>e.jsx("option",{value:pe.value,children:pe.label},`${l.key}:${pe.value}`))]})]},`menu:${l.key}`))]}),Zt?e.jsxs(e.Fragment,{children:[(N==="all_collections"||N==="all_revisions")&&xe==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:u.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsxs("select",{value:z??"",onChange:l=>P(l.target.value||void 0),children:[e.jsx("option",{value:"",children:u.selectCollectionOption}),S.map(l=>e.jsx("option",{value:l.collectionId,children:l.name},l.collectionId))]})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:u.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Ve,onChange:l=>ze(l.target.value),placeholder:u.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Bt,children:u.revisionForm.createAction}),Ae?e.jsx("p",{className:"cogita-form-error",children:Ae}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Qs.Provider,{value:!0,children:Zt})})]}):null,Zt?null:e.jsxs(e.Fragment,{children:[Y?e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Ai,{copy:t,onPersonCreated:l=>{Ye(q=>q+1)}})}):null,!y&&!Y?e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:yt.step}),e.jsx("h2",{children:yt.title})]}),e.jsxs("p",{children:[gt+1," / ",ht]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:yt.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:yt.passages.map(l=>e.jsx("p",{children:l},l))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:yt.focus.map(l=>e.jsx("span",{children:l},l))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:yt.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:pt.map((l,q)=>e.jsx("button",{type:"button",className:`ghost ${q===gt?"active":""}`,onClick:()=>Ze(q),"aria-label":`${q+1}`,children:q+1},`tutorial:${l.title}:${q}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:gt===0,onClick:()=>Ze(l=>Math.max(0,l-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:gt===ht-1,onClick:()=>Ze(l=>Math.min(ht-1,l+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:ot,onChange:l=>Te(l.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:sa,children:t.cogita.user.createLibraryAction}),Ae?e.jsx("p",{className:"cogita-form-error",children:Ae}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),v.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,v.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:v.map(l=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{xt({libraryId:l.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:l.name})]},l.libraryId))}):null]})]})]}):null]})]})]})})}const Co=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:po},Symbol.toStringTag,{value:"Module"}));function fo({copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,shareId:i}){const[p,c]=a.useState(null),[u,v]=a.useState("loading"),[m,S]=a.useState(t.cogita.library.collections.defaultName),[_,x]=a.useState("Cogita Library"),[g,C]=a.useState([]),[D,y]=a.useState([]),[U,N]=a.useState("idle"),[ae,z]=a.useState({current:0,total:0}),[P,B]=a.useState(0),[Q,xe]=a.useState(""),[Ee,re]=a.useState(null),[A,ye]=a.useState(null),[J,ge]=a.useState(null),[ee,ke]=a.useState(null),[ue,le]=a.useState([]),[Ie,Ae]=a.useState({}),[Ke,Re]=a.useState({}),[Ze,ot]=a.useState(null),[Te,We]=a.useState(null),[ft,Ve]=a.useState(null),[ze,et]=a.useState(null),[it,Ge]=a.useState({}),Ce=a.useRef(0),[Be,Ye]=a.useState(null),$=a.useRef(null),L=a.useRef(null),[K,R]=a.useState(null),[k,T]=a.useState(!1),[M,oe]=a.useState(null),[fe,de]=a.useState([]),[Y,E]=a.useState(null),W=a.useRef(null),te=a.useRef(null),[H,X]=a.useState(null),[be,O]=a.useState(0),ne=a.useRef(null),Le=a.useRef({}),[qe,De]=a.useState(!1),[Je,pt]=a.useState({}),ht=a.useRef(null),gt=a.useRef(new Set),yt=a.useRef({}),[Ct,zt]=a.useState([]),[Rt,kt]=a.useState(new Set),[pa,Mt]=a.useState(!1),xt=qa(),Nt=a.useMemo(()=>new URLSearchParams(xt.search),[xt.search]),vt=a.useMemo(()=>Nt.get("key")??"",[Nt]),bt=(p==null?void 0:p.mode)??"random",Et=(p==null?void 0:p.check)??"exact",st=(p==null?void 0:p.limit)??20,Ue=a.useMemo(()=>ns((p==null?void 0:p.revisionType)??bt),[p,bt]),mt=a.useMemo(()=>{const F=p==null?void 0:p.revisionSettings,se=tr(Ue,Nt);return vn(Ue,F??se)},[p,Nt,Ue]),Ht=a.useMemo(()=>t.cogita.library.revision[Ue.labelKey]??bt,[t,bt,Ue]),Kt=a.useMemo(()=>Et==="exact"?t.cogita.library.revision.checkValue:Et,[t,Et]),ce=u==="ready"?g[P]??null:null,Zt=(ce==null?void 0:ce.checkType)==="translation-match"&&ze,sa=a.useRef(new Map),Bt=a.useRef(new Map),l=a.useRef(new Map),q=a.useRef(new Map),pe=a.useMemo(()=>ce?ce.cardType==="vocab"?t.cogita.library.revision.vocabLabel:ce.infoType?nt(t,ce.infoType):t.cogita.library.revision.infoLabel:"",[t,ce]),G=a.useMemo(()=>{var se;return Ue.id!=="levels"?g.length:((se=Je.pool)==null?void 0:se.length)??Ue.getFetchLimit(st,mt)},[Je,mt,Ue,g.length,st]),tt=Ue.getProgressTotal?Ue.getProgressTotal(g,Je,st,mt):Ue.id==="levels"?Math.min(st,G):g.length,lt=tt?Math.min(P+1,tt):0,wt=Math.max(1,Number(mt.tries??1)),It=mt.compare??"anchors",$t=Math.max(0,Math.min(100,Number(mt.minCorrectness??0))),jt=(mt.considerDependencies??"on")==="on",Wt=Math.max(0,Math.min(100,Number(mt.dependencyThreshold??85))),ea=F=>{const se=F.slice();for(let we=se.length-1;we>0;we-=1){const Fe=Math.floor(Math.random()*(we+1));[se[we],se[Fe]]=[se[Fe],se[we]]}return se},ra=F=>xa(F,{treatSimilarCharsAsSame:!0})>=$t,Ot=async()=>{const F=await ha(),se=new Map,we=new Map;F.forEach(je=>{const $e=`${je.itemType}:${je.itemId}`,Me=Xt(je.itemType,je.itemId,je.checkType,je.direction);se.has($e)||se.set($e,[]),se.get($e).push(je),we.has(Me)||we.set(Me,[]),we.get(Me).push(je)});const Fe=new Map,_e=new Map;return se.forEach((je,$e)=>Fe.set($e,ua(je).score)),we.forEach((je,$e)=>_e.set($e,ua(je).score)),{itemKnowness:Fe,cardKnowness:_e}},ia=async F=>{const se=Je,we=F.concat(se.active??[]).concat(se.pool??[]).filter((b,I,V)=>V.findIndex(he=>Ne(he)===Ne(b))===I);if(!jt){kt(new Set(we.map(Ne)));return}const{itemKnowness:Fe,cardKnowness:_e}=await Ot(),je=b=>{if(b.cardType!=="info"||b.infoType!=="citation"||b.checkType!=="quote-fragment")return!0;const I=Jt(b.direction);if(!(I!=null&&I.fragmentId))return!0;const V=b.description??"";if(!V.trim())return!0;const me=va(V).nodes[I.fragmentId];if(!me||!me.leftId&&!me.rightId)return!0;const ie=[me.leftId,me.rightId].filter(Se=>!!Se);if(ie.length===0)return!0;const ve=ie.map(Se=>{const Oe=Xt("info",b.cardId,"quote-fragment",Se);return _e.get(Oe)??0});return ve.reduce((Se,Oe)=>Se+Oe,0)/ve.length>=Wt},$e=(p==null?void 0:p.collectionId)??null,Me=$e?Ct.filter(b=>Tt(b.childItemType)==="collection"&&b.childItemId===$e&&!Tt(b.childCheckType)&&!Tt(b.childDirection)):[],Pe=$e&&we.length>0?we.reduce((b,I)=>b+(_e.get(Ne(I))??0),0)/we.length:0,Qe=new Set;for(const b of we){if(b.cardType!=="info"){Qe.add(Ne(b));continue}if(!je(b))continue;const I=Ct.filter(me=>or(me,b)).concat(Me);if(I.length===0){Qe.add(Ne(b));continue}let V=0;for(const me of I)if(Tt(me.parentItemType)==="collection")V+=me.parentItemId===$e?Pe:0;else if(Tt(me.parentCheckType)||Tt(me.parentDirection)){const ie=Tt(me.parentCheckType),ve=Tt(me.parentDirection),Z=Xt(me.parentItemType,me.parentItemId,ie,ve);V+=_e.get(Z)??0}else{const ie=`${me.parentItemType}:${me.parentItemId}`;V+=Fe.get(ie)??0}V/I.length>=Wt&&Qe.add(Ne(b))}kt(Qe)},Pt=F=>{for(let se=F;se<g.length;se+=1){const we=g[se];if(we&&(!jt||we.cardType!=="info"||Rt.has(Ne(we))))return se}return-1},St=F=>!jt||F.cardType!=="info"||Rt.has(Ne(F)),ta=F=>{if(Ue.id!=="temporal"&&Ue.id!=="levels")return null;const se=Je,we=(se.active??[]).concat(se.pool??[]),Fe=new Set;for(const _e of we){const je=Ne(_e);if(!(Fe.has(je)||F.has(je))&&(Fe.add(je),St(_e)))return _e}return null},Yt=a.useMemo(()=>{if(Ue.id!=="levels")return null;const F=Je,se=F.pool??[],we=F.active??[],Fe=F.levelMap??{},_e=Math.max(1,Number(mt.levels??1)),je=Array.from({length:_e},()=>0),$e=new Set(we.map(b=>Ne(b)));se.forEach(b=>{const I=Math.min(_e,Math.max(1,Fe[Ne(b)]??1));je[I-1]+=1});const Me=se.length||1,Pe=je.map(b=>b/Me*100),Qe=ce?Fe[Ne(ce)]??1:null;return{counts:je,percentages:Pe,currentLevel:Qe,levelsCount:_e,activeCount:we.length,poolCount:se.length,activeSet:$e}},[Je,mt,Ue,ce]),wa=a.useMemo(()=>{if(Ue.id!=="temporal")return null;const F=Je,se=F.pool??[],we=F.active??[],Fe=F.knownessMap??{},_e=new Set(F.unknownSet??[]);let je=0;se.forEach(Pe=>{(Fe[Ne(Pe)]??0)>1&&(je+=1)});const $e=_e.size,Me=we.map(Pe=>({id:Ne(Pe),value:_e.has(Ne(Pe))?0:Math.max(0,Math.min(1,Fe[Ne(Pe)]??0))}));return{knownCount:je,unknownCount:$e,dots:Me}},[Je,Ue]),Ja=a.useMemo(()=>{if(!jt)return 0;const F=Je;return g.concat(F.active??[]).concat(F.pool??[]).filter((we,Fe,_e)=>_e.findIndex(je=>Ne(je)===Ne(we))===Fe).filter(we=>we.cardType==="info"&&!Rt.has(Ne(we))).length},[jt,Je,g,Rt]);a.useEffect(()=>{if(!jt||U!=="ready")return;const F=Je,we=g.concat(F.active??[]).concat(F.pool??[]).filter((je,$e,Me)=>Me.findIndex(Pe=>Ne(Pe)===Ne(je))===$e).filter(je=>je.cardType!=="info"||Rt.has(Ne(je))).length,Fe=W.current;if(W.current=we,Fe===null||we<=Fe)return;const _e=we-Fe;E(`New card available (+${_e})`),te.current&&window.clearTimeout(te.current),te.current=window.setTimeout(()=>E(null),2200)},[jt,U,Je,g,Rt]),a.useEffect(()=>()=>{te.current&&window.clearTimeout(te.current)},[]);const Qt=(F,se)=>{const we=Ue.applyOutcome({queue:g,meta:Je},ce,st,mt,{correct:F,correctness:se,createdUtc:new Date().toISOString()});C(we.queue),pt(we.meta);const Fe=we.queue[P+1];Fe&&_t(Fe,P+1)};a.useEffect(()=>{if(!i){v("error");return}v("loading"),Kr({shareId:i,key:vt}).then(F=>{c(F),S(F.collectionName),x(F.libraryName),v("ready")}).catch(()=>{v("error")})},[i,vt]),a.useEffect(()=>{i&&Fr({shareId:i,key:vt,type:"language"}).then(F=>y(F)).catch(()=>y([]))},[i,vt]),a.useEffect(()=>{!i||u!=="ready"||Dr({shareId:i,key:vt}).then(F=>zt(F.items??[])).catch(()=>zt([]))},[i,vt,u]),a.useEffect(()=>{if(!i||u!=="ready")return;let F=!0;return(async()=>{N("loading"),z({current:0,total:Ue.id==="levels"?0:Ue.getFetchLimit(st,mt)});try{const we=[];let Fe=null,_e=null;do{const I=await _r({shareId:i,key:vt,limit:300,cursor:Fe});if(we.push(...I.items),(Ue.id==="levels"||Ue.id==="temporal")&&I.total&&(_e=I.total),z(V=>({current:we.length,total:V.total||I.total||Ue.getFetchLimit(st,mt)})),Fe=I.nextCursor??null,_e!==null&&we.length>=_e||Ue.id!=="levels"&&Ue.id!=="temporal"&&we.length>=Ue.getFetchLimit(st,mt))break}while(Fe);if(!F)return;const je=za(we);let $e;if(Ue.id==="levels"){const I=Math.max(1,Number(mt.levels??1));$e={},je.forEach(V=>{const he=Ne(V);$e[he]=Math.max(1,Math.min(I,1))})}let Me=null,Pe=null,Qe=null;if(Ue.id==="temporal"){const I=await ha(),V=new Set(je.map(ie=>Ne(ie))),he=I.reduce((ie,ve)=>{const Z=Xt(ve.itemType,ve.itemId,ve.checkType,ve.direction);return V.has(Z)&&(ie[Z]||(ie[Z]=[]),ie[Z].push(ve)),ie},{});Me={},Pe=new Set,Qe={};const me=Date.now();je.forEach(ie=>{const ve=Ne(ie),Z=he[ve]??[];if(Z.length===0){Me[ve]=0,Pe.add(ve),Qe[ve]=[];return}const Se=es(Z);Qe[ve]=Se;const Oe=yn(Se,me);Me[ve]=Oe.knowness})}const b=Ue.id==="levels"?as(je,st,mt,$e):Ue.id==="temporal"?ts(je,st,mt,Me??{},Pe??new Set,Qe??{}):Ue.prepare(je,st,mt);C(b.queue),pt(b.meta),B(0),N("ready"),z(I=>({current:Math.min(I.current,I.total),total:I.total}))}catch{F&&N("error")}})(),()=>{F=!1}},[i,vt,st,Ue,mt,u]),a.useEffect(()=>{ia(g)},[g,Ct,jt,Wt,p==null?void 0:p.collectionId]),a.useEffect(()=>{if(!ce||!jt){Mt(!1);return}if(ce.cardType!=="info"||Rt.has(Ne(ce))){Mt(!1);return}const F=Pt(P+1);if(F>=0){Mt(!1),B(F);return}if(Ue.id==="temporal"||Ue.id==="levels"){const se=g.slice(0,P+1),we=g.slice(P+1).filter(St),Fe=se.concat(we),_e=new Set(Fe.map(Ne)),je=ta(_e);if(je){const Me=Ne(je);_e.has(Me)||(Fe.push(je),_e.add(Me),pt(Pe=>{const Qe=Pe,b=new Set(Qe.queued??[]);return b.add(Me),{...Qe,queued:b}}))}const $e=Fe.findIndex((Me,Pe)=>Pe!==P&&St(Me));if($e>=0){C(Fe),B($e),Mt(!1);return}}Mt(!0)},[ce,Rt,jt,P,g,Je,Ue.id]),a.useEffect(()=>{if(xe(""),re(null),X(null),O(0),le([]),Ae({}),Re({}),ot(null),We(null),Ve(null),T(!1),De(!1),R(null),et(null),Ge({}),!ce){ye(null),ge(null);return}ce.cardType==="info"&&ce.infoType==="computed"&&ye(t.cogita.library.revision.loadingComputed);let F=!0;return _t(ce,P).then(se=>{!F||!se||(ye(se.prompt),ge(se.expectedAnswer),le(se.computedExpected),Ae(se.computedAnswers),ot(se.answerTemplate),We(se.outputVariables),Ve(se.variableValues))}),()=>{F=!1}},[ce,i,t]),a.useEffect(()=>{if(!ce||ce.cardType!=="info"||ce.infoType!=="citation"){ht.current=null,gt.current=new Set,ke(null);return}const F=ce.description??"",se=(ce.label??"").trim(),we=se.replace(/\s+/g," ").trim(),Fe=F.replace(/\s+/g," ").trim(),_e=we&&we!==Fe?se:t.cogita.library.infoTypes.citation;if(!F){ke(null),ge(null);return}const je=va(F);ht.current=je,ye(_e);let $e=!0;return ha().then(Me=>{if(!$e)return;const Pe=new Map;Me.forEach(he=>{if(he.itemType!=="info"||he.checkType!=="quote-fragment"||!he.direction)return;const me=Jt(he.direction);if(!me)return;const ie=`${he.itemId}:${me.fragmentId}`;Pe.has(ie)||Pe.set(ie,[]),Pe.get(ie).push(he)});const Qe={},b=new Set;Pe.forEach((he,me)=>{const[ie,ve]=me.split(":",2);if(ie!==ce.cardId)return;const Z=ua(he).score;Qe[ve]=Z,Z>=Wt&&b.add(ve)}),gt.current=b,yt.current=Qe;const I=Jt(ce.direction);if(I!=null&&I.fragmentId&&je.nodes[I.fragmentId]){oa(je,I.fragmentId,_e);return}const V=La(je,b,Qe,Wt,jt,ce.direction);oa(je,(V==null?void 0:V.id)??null,_e)}).catch(()=>{gt.current=new Set,yt.current={};const Me=Jt(ce.direction);if(Me!=null&&Me.fragmentId&&je.nodes[Me.fragmentId]){oa(je,Me.fragmentId,_e);return}const Pe=La(je,gt.current,{},Wt,jt,ce.direction);oa(je,(Pe==null?void 0:Pe.id)??null,_e)}),()=>{$e=!1}},[ce,t,jt,Wt]),a.useEffect(()=>{if(!ce||ce.cardType!=="vocab"||ce.checkType!=="translation-match"){et(null),Ge({});return}const we=(Je.pool??Je.active??g).filter(Me=>Me.cardType==="vocab"&&Me.checkType==="translation-match").filter((Me,Pe,Qe)=>Qe.findIndex(b=>b.cardId===Me.cardId)===Pe);we.some(Me=>Me.cardId===ce.cardId)||we.unshift(ce);const _e=ea(we).slice(0,6).map(Me=>{const Pe=Me.label.split("↔").map(I=>I.trim()).filter(Boolean);if(Pe.length<2)return null;const Qe=`${Me.cardId}:L`,b=`${Me.cardId}:R`;return{cardId:Me.cardId,leftId:Qe,rightId:b,leftLabel:Pe[0],rightLabel:Pe[1]}}).filter(Boolean),je=_e.map(Me=>Me.leftId),$e=ea(_e.map(Me=>Me.rightId));et({pairs:_e,leftOrder:je,rightOrder:$e,selection:{},activeLeft:null,activeRight:null,locked:{}})},[ce,g,Je]),a.useEffect(()=>()=>{$.current&&window.clearTimeout($.current),L.current&&window.clearTimeout(L.current)},[]);const Ta=a.useRef(null);a.useEffect(()=>{if(!ce)return;const F=Ne(ce),se=typeof document<"u"?document.activeElement:null;if(Ta.current===F&&se&&(se.tagName==="INPUT"||se.tagName==="TEXTAREA"))return;let we=0;const Fe=()=>{if(ce){if(ce.cardType==="info"&&ce.infoType==="computed"){if(ue.length>0){const je=dn(Ze,ue,Te),$e=je?Le.current[je]:null;if($e&&($e.focus(),document.activeElement===$e)){Ta.current=F;return}}if(ne.current&&(ne.current.focus(),document.activeElement===ne.current)){Ta.current=F;return}}else if(ce.cardType==="vocab"&&ne.current&&(ne.current.focus(),document.activeElement===ne.current)){Ta.current=F;return}we<6&&(we+=1,window.setTimeout(Fe,40))}},_e=window.setTimeout(Fe,40);return()=>window.clearTimeout(_e)},[ce,ue,Ze,Te]),a.useEffect(()=>{if(!qe)return;const F=se=>{se.key==="Enter"&&(se.preventDefault(),Vt())};return window.addEventListener("keydown",F),()=>window.removeEventListener("keydown",F)},[qe]);const Ca=F=>{de(F),oe(ua(F))};a.useEffect(()=>{if(!ce){oe(null),de([]);return}const F=ce.cardType==="info"?"info":"connection";if(ce.cardType==="info"&&ce.infoType==="citation"){ha().then(se=>{const we=se.filter(Fe=>Fe.itemType==="info"&&Fe.itemId===ce.cardId&&Fe.checkType==="quote-fragment"&&ln(Fe.direction,ce.direction));Ca(we)}).catch(()=>{oe(null),de([])});return}on(F,ce.cardId,ce.checkType,ce.direction).then(se=>Ca(se)).catch(()=>{oe(null),de([])})},[ce]);const Ra=(F,se,we,Fe)=>{if(F==="info"&&we==="quote-fragment"){ha().then(_e=>{const je=_e.filter($e=>$e.itemType==="info"&&$e.itemId===se&&$e.checkType==="quote-fragment"&&ln($e.direction,Fe));Ca(je)}).catch(()=>{oe(null),de([])});return}on(F,se,we,Fe).then(_e=>Ca(_e)).catch(()=>{oe(null),de([])})},Ha=(F,se,we)=>{var $e;const Fe=(($e=we.pairs.find(Me=>Me.leftId===F))==null?void 0:$e.rightId)??null;if(!Fe)return we;const _e=Fe===se;Ge(Me=>({...Me,[F]:_e?"correct":"incorrect"})),$.current&&window.clearTimeout($.current),L.current&&window.clearTimeout(L.current),Ce.current+=1;const je={kind:_e?"correct":"incorrect",tick:Ce.current};if(Ye(null),$.current=window.setTimeout(()=>Ye(je),0),L.current=window.setTimeout(()=>Ye(null),420),_e){const Me={...we.locked,[F]:!0};return Object.keys(Me).length>=we.pairs.length?(re("correct"),De(!0)):re("correct"),{...we,selection:{...we.selection,[F]:se},activeLeft:null,activeRight:null,locked:Me}}return re("incorrect"),{...we,activeLeft:null,activeRight:null}},$a=F=>{et(se=>!se||se.locked[F]?se:se.activeRight?Ha(F,se.activeRight,se):{...se,activeLeft:se.activeLeft===F?null:F})},wn=F=>{et(se=>se&&(se.activeLeft?Ha(se.activeLeft,F,se):{...se,activeRight:se.activeRight===F?null:F}))},Vt=()=>{var F;if(ce&&ce.cardType==="info"&&ce.infoType==="citation"&&ht.current&&ee&&!((F=Jt(ce.direction))!=null&&F.fragmentId)){const se=La(ht.current,gt.current,yt.current,Wt,jt,ce.direction,ee.fragmentId);if(se){re(null),xe(""),T(!1),Re({}),De(!1),X(null),O(0),oa(ht.current,se.id,ee.title);return}}re(null),xe(""),T(!1),Re({}),De(!1),X(null),O(0),B(se=>Math.min(se+1,g.length))},qt=F=>{if(!ce)return;const se=F.expected??null,we=F.answer??"";let Fe=se??"",_e=we;if(!se&&F.expectedMap&&F.answerMap){const I=Object.keys(F.expectedMap).sort((V,he)=>V.localeCompare(he));Fe=I.map(V=>{var he;return((he=F.expectedMap)==null?void 0:he[V])??""}).join("|"),_e=I.map(V=>{var he;return((he=F.answerMap)==null?void 0:he[V])??""}).join("|")}const je=Fe?Aa(Fe,_e,It):new Uint8Array,$e={revisionType:Ue.id,evalType:F.evalType,direction:F.direction,prompt:A??"",expected:se,answer:we,expectedAnswers:F.expectedMap??null,answers:F.answerMap??null,correct:F.correct,maskBase64:je.length?ya(je):null,checkMode:Et,compareMode:It,minCorrectness:$t},Me=new TextEncoder().encode(JSON.stringify($e)),Pe=ce.cardType==="info"?"info":"connection",Qe=F.overrideCheckType??ce.checkType??null,b=F.overrideDirection??ce.direction??null;rn({itemType:Pe,itemId:ce.cardId,checkType:Qe,direction:b,revisionType:Ue.id,evalType:F.evalType,correct:F.correct,maskBase64:je.length?ya(je):null,payloadBase64:ya(Me)}).then(()=>{Ra(Pe,ce.cardId,Qe,b),ia(g)}).catch(()=>{})},jn=(F,se)=>{const we=sa.current.get(se);if(we)return Promise.resolve(we);const Fe=Bt.current.get(se);if(Fe)return Fe;const _e=zr({shareCode:i,infoId:F,key:vt}).then(je=>{var I,V;const $e=je.payload,Me=((I=$e.definition)==null?void 0:I.graph)??null,Pe="",Qe=((V=$e.definition)==null?void 0:V.answerTemplate)??"",b=ar(Me,Pe,Qe);if(b){const me={sample:nr(b),answerTemplate:Qe||null};return sa.current.set(se,me),me}return ls({shareId:i,infoId:F,key:vt}).then(he=>{const me={sample:he,answerTemplate:null};return sa.current.set(se,me),me})}).catch(()=>ls({shareId:i,infoId:F,key:vt}).then(je=>{const $e={sample:je,answerTemplate:null};return sa.current.set(se,$e),$e}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{Bt.current.delete(se)});return Bt.current.set(se,_e),_e},_t=(F,se)=>{var Me;const we=`${Ne(F)}:${se}`,Fe=l.current.get(we);if(Fe)return Promise.resolve(Fe);const _e=q.current.get(we);if(_e)return _e;const je=Pe=>(l.current.set(we,Pe),Pe);let $e;if(F.cardType==="vocab"){if(F.checkType==="translation-match")return $e=Promise.resolve(je({prompt:F.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),$e;const Pe=F.label.split("↔").map(Qe=>Qe.trim()).filter(Boolean);if(Pe.length>=2){const b=(F.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",I=b?Pe[0]:Pe[1],V=b?Pe[1]:Pe[0];$e=Promise.resolve(je({prompt:I,expectedAnswer:V,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else $e=Promise.resolve(je({prompt:F.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(F.cardType==="info"&&F.infoType==="word"){const Pe=(Me=F.description)!=null&&Me.startsWith("Language: ")?F.description.replace("Language: ",""):null;$e=Promise.resolve(je({prompt:F.label,expectedAnswer:Pe,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else F.cardType==="info"&&F.infoType==="computed"?$e=jn(F.cardId,we).then(Pe=>{var he,me;if(!Pe.sample)return je({prompt:F.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const Qe=Pe.sample,b=Qe.expectedAnswers?Object.entries(Qe.expectedAnswers).map(([ie,ve])=>({key:ie,expected:ve})):[],I=b.reduce((ie,ve)=>(ie[ve.key]="",ie),{}),V=Qe.expectedAnswerIsSentence&&((he=Qe.expectedAnswer)==null?void 0:he.trim())||null;return je({prompt:Qe.prompt,expectedAnswer:b.length>0?V:((me=Qe.expectedAnswer)==null?void 0:me.trim())||null,computedExpected:b,computedAnswers:I,answerTemplate:Pe.answerTemplate,outputVariables:Qe.outputVariables??null,variableValues:Qe.variableValues??null})}).catch(()=>je({prompt:F.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{q.current.delete(we)}):$e=Promise.resolve(je({prompt:F.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return q.current.set(we,$e),$e},oa=(F,se,we)=>{const Fe=Object.keys(F.nodes).length,_e=gt.current.size;if(!se){ke({title:we,before:F.text,after:"",fragmentId:null,total:Fe,completed:_e}),ge(null),De(!0);return}const je=F.nodes[se];if(!je)return;const $e=bn(F.text,je);ke({title:we,before:$e.before,after:$e.after,fragmentId:je.id,total:Fe,completed:_e}),ge($e.fragment),De(!1)},Ia=()=>{const F=ht.current;F&&ke(se=>se&&{...se,total:Object.keys(F.nodes).length,completed:gt.current.size})},ja=()=>{const F=g[P+1];F&&_t(F,P+1)},Pa=()=>{if(ja(),ce&&ce.cardType==="vocab"&&ce.checkType==="translation-match"&&ze){if(ze.pairs.length===0){re("incorrect"),De(!0);return}const je=ze.pairs.reduce((V,he)=>(V[he.rightId]=he.rightLabel,V),{});let $e=0;const Me={};ze.pairs.forEach(V=>{const me=ze.selection[V.leftId]===V.rightId;Me[V.leftId]=me?"correct":"incorrect",me&&($e+=1)});const Pe=ze.pairs.length||1,Qe=$e/Pe,b=$e===ze.pairs.length;Ge(V=>({...V,...Me})),b?(re("correct"),De(!0),O(0)):(re("incorrect"),De(!1),O(V=>{const he=V+1;return he>=wt&&(T(!0),De(!0),et(me=>{if(!me)return me;const ie=me.pairs.reduce((ve,Z)=>(ve[Z.leftId]=Z.rightId,ve),{});return{...me,selection:ie}})),he})),Qt(b,Qe);const I="connection";Promise.all(ze.pairs.map(V=>{const he=ze.selection[V.leftId]??null,me=he?je[he]:"",ie={left:V.leftLabel,expected:V.rightLabel,answer:me,checkType:"translation-match"},ve=new TextEncoder().encode(JSON.stringify(ie));return rn({itemType:I,itemId:V.cardId,checkType:"translation-match",direction:null,revisionType:Ue.id,evalType:"translation-match",correct:he===V.rightId,maskBase64:null,payloadBase64:ya(ve)})})).then(()=>{Ra(I,ce.cardId,ce.checkType,ce.direction),ia(g)}).catch(()=>{});return}if(ue.length>0){const je=ue.reduce((Me,Pe)=>{const Qe=Ie[Pe.key]??"";return Me[Pe.key]=Ft(Qe)===Ft(Pe.expected)?"correct":"incorrect",Me},{});ue.every(({key:Me,expected:Pe})=>{const Qe=Ie[Me]??"";return Et==="exact"&&Ft(Qe)===Ft(Pe)})?(re("correct"),Re(je),De(!0),O(0),Qt(!0,1),qt({correct:!0,direction:A?`${A} -> computed`:"computed",expectedMap:ue.reduce((Me,Pe)=>(Me[Pe.key]=Pe.expected,Me),{}),answerMap:Ie,evalType:"computed"})):(re("incorrect"),Re(je),De(!1),O(Me=>{const Pe=Me+1;return Pe>=wt&&ma&&(T(!0),De(!0)),Pe}),Qt(!1,0),window.setTimeout(()=>{var Pe;const Me=dn(Ze,ue,Te);Me&&Le.current[Me]&&((Pe=Le.current[Me])==null||Pe.focus())},40),qt({correct:!1,direction:A?`${A} -> computed`:"computed",expectedMap:ue.reduce((Me,Pe)=>(Me[Pe.key]=Pe.expected,Me),{}),answerMap:Ie,evalType:"computed"}));return}if(ce&&ce.cardType==="info"&&ce.infoType==="citation"&&(ee!=null&&ee.fragmentId)){if(!J)return;const je=Jt(ce.direction),$e=(je==null?void 0:je.fragmentId)??ee.fragmentId,Me=Sa(J,Q,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Pe=Me.mask,Qe=Me.isCorrect,b=Me.percent;Qe?(yt.current[ee.fragmentId]=Math.max(yt.current[ee.fragmentId]??0,b),(yt.current[ee.fragmentId]??0)>=Wt&&gt.current.add(ee.fragmentId),Ia(),re("correct"),Re({}),De(!0),X(Pe),O(0),b<100&&wt<=1&&T(!0),Qt(!0,b/100),qt({correct:!0,direction:`quote:${ee.fragmentId}`,expected:J,answer:Q,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:$e})):(re("incorrect"),Re({}),De(!1),X(Pe),O(I=>{const V=I+1;return V>=wt&&ma&&(T(!0),De(!0)),V}),Qt(!1,b/100),window.setTimeout(()=>{var I;return(I=ne.current)==null?void 0:I.focus()},40),qt({correct:!1,direction:`quote:${ee.fragmentId}`,expected:J,answer:Q,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:$e}));return}if(!J)return;const F=Aa(J,Q,It),se=Et==="exact"&&Ft(Q)===Ft(J),we=ra(F),Fe=se||we,_e=xa(F);Fe?(re("correct"),Re({}),De(!0),X(F),O(0),_e<100&&wt<=1&&T(!0),Qt(!0,_e/100),qt({correct:!0,direction:A?`${A} -> ${J}`:null,expected:J,answer:Q,evalType:"text"})):(re("incorrect"),Re({}),De(!1),X(F),O(je=>{const $e=je+1;return $e>=wt&&ma&&(T(!0),De(!0)),$e}),Qt(!1,_e/100),window.setTimeout(()=>{var je;return(je=ne.current)==null?void 0:je.focus()},40),qt({correct:!1,direction:A?`${A} -> ${J}`:null,expected:J,answer:Q,evalType:"text"}))},kn=F=>{if(ja(),!J)return;const se=Aa(J,F,It),we=Ft(F)===Ft(J),Fe=ra(se),_e=we||Fe,je=xa(se);_e?(re("correct"),Re({}),De(!0),X(se),O(0),je<100&&wt<=1&&T(!0),Qt(!0,je/100),qt({correct:!0,direction:"word->language",expected:J,answer:F,evalType:"language-select"})):(re("incorrect"),Re({}),De(!1),X(se),O($e=>{const Me=$e+1;return Me>=wt&&ma&&(T(!0),De(!0)),Me}),Qt(!1,je/100),qt({correct:!1,direction:"word->language",expected:J,answer:F,evalType:"language-select"}))},Nn=F=>{var we;if(F.key!=="Enter")return;if(F.preventDefault(),F.stopPropagation(),qe){Vt();return}const se=ue.find(Fe=>!(Ie[Fe.key]??"").trim());if(se){(we=Le.current[se.key])==null||we.focus();return}Pa()},Ma=()=>{ja(),re("correct"),De(!0),O(0),Qt(!0,1),J&&qt({correct:!0,direction:"manual",expected:J,answer:Q,evalType:"manual"})},aa=()=>{if(Qt(!1,0),ce&&ce.cardType==="info"&&ce.infoType==="citation"){re(null),xe(""),T(!1),Re({}),De(!1),X(null),O(0),B(F=>Math.min(F+1,g.length));return}Vt()};a.useEffect(()=>{ja()},[P,g]);const Sn=t.cogita.library.revision.revealModeAfterIncorrect,ma=ue.length>0||!!J;return e.jsxs(At,{copy:t,authLabel:n,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:o,onLogout:h,secureMode:d,onNavigate:w,language:f,onLanguageChange:j,children:[(u==="loading"||U==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:u==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${ae.total?Math.min(100,Math.max(0,ae.current/ae.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:ae.total?`${Math.min(ae.current,ae.total)} / ${ae.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:m}),e.jsx("p",{className:"cogita-library-subtitle",children:_}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",Ht).replace("{check}",Kt)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:M?`${M.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Yt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Yt.currentLevel??"-"," / ",Yt.levelsCount]}):null,M?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(M.correct)).replace("{total}",String(M.total))}),M.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(M.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(sr,{outcomes:fe})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[Y?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:Y})}):null,e.jsx(Xn,{feedbackToken:Be?`${Be.kind}-${Be.tick}`:Zt?"idle":Ee??"idle",children:u!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:u==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):ce?e.jsx(e.Fragment,{children:pa?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(Zn,{copy:t,currentCard:ce,currentTypeLabel:pe,prompt:A,languages:D,answer:Q,onAnswerChange:F=>xe(se=>cn(se,F,K)),computedExpected:ue,computedAnswers:Ie,onComputedAnswerChange:(F,se)=>Ae(we=>({...we,[F]:cn(we[F]??"",se,K)})),answerTemplate:Ze,outputVariables:Te,variableValues:ft,computedFieldFeedback:Ke,feedback:Ee,canAdvance:qe,quoteContext:ee,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Pa,onSkip:aa,onLanguageSelect:kn,onMarkReviewed:Ma,onAdvance:Vt,showCorrectAnswer:k,setShowCorrectAnswer:T,onRevealCorrect:()=>De(!0),answerMask:H,expectedAnswer:J,hasExpectedAnswer:ma,handleComputedKeyDown:Nn,answerInputRef:ne,computedInputRefs:Le,scriptMode:K,setScriptMode:R,matchPairs:ze==null?void 0:ze.pairs,matchLeftOrder:ze==null?void 0:ze.leftOrder,matchRightOrder:ze==null?void 0:ze.rightOrder,matchSelection:ze==null?void 0:ze.selection,matchActiveLeft:ze==null?void 0:ze.activeLeft,matchActiveRight:ze==null?void 0:ze.activeRight,matchFeedback:it,onMatchLeftSelect:$a,onMatchRightSelect:wn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:tt?`${lt} / ${tt}`:t.cogita.library.revision.progressUnlimited}),u==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),u==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),u==="ready"&&U==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),u==="ready"&&U==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),u==="ready"&&U==="ready"&&g.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Sn}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",wt]})]})]}),Yt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Yt.activeCount," / ",Yt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Yt.counts.map((F,se)=>{const we=se+1,Fe=Yt.currentLevel===we,_e=Yt.percentages[se]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":Fe,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:we}),e.jsx("strong",{children:F})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,_e))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[_e.toFixed(1),"%"]})]},`level-${we}`)})})]}):null,wa?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:wa.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:wa.dots.map(F=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-F.value))}, ${Math.round(200*F.value)}, 80, 0.9)`}},F.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:wa.knownCount})]})]}):null,jt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Ja})]})}):null]})]})]})})})]})]})}const Io=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:fo},Symbol.toStringTag,{value:"Module"})),da=t=>String(t??"").trim().toLocaleLowerCase(),un=t=>Array.from(new Set(t.map(n=>Number(n)).filter(Number.isFinite))).sort((n,r)=>n-r),Fs=t=>t.map(n=>n.join(",")).sort().join("|");function bo(t){const n=t.split("↔").map(r=>r.trim()).filter(Boolean);return n.length>=2?[n[0],n[1]]:null}function yo(t){if(!t)return null;const n=t.indexOf(":");return n>=0?t.slice(n+1).trim():t.trim()}function xo(t,n,r,s){const o=typeof r.type=="string"?r.type:"",h=typeof r.title=="string"&&r.title.trim()?r.title.trim():n,d=typeof r.question=="string"?r.question:n;if(!o||!d)return null;if(o==="selection"){const w=Array.isArray(r.options)?r.options.filter(j=>typeof j=="string"):[],f=Array.isArray(r.answer)?un(r.answer):[];return{roundIndex:s,cardKey:`info:${t}:question-selection`,publicPrompt:{kind:"selection",title:h,prompt:d,options:w,multiple:!0,cardLabel:"question"},reveal:{kind:"selection",expected:f,title:h},grade:j=>{const i=Array.isArray(j)?un(j):[];return JSON.stringify(i)===JSON.stringify(f)}}}if(o==="truefalse"){const w=!!r.answer;return{roundIndex:s,cardKey:`info:${t}:question-truefalse`,publicPrompt:{kind:"boolean",title:h,prompt:d,cardLabel:"question"},reveal:{kind:"boolean",expected:w,title:h},grade:f=>!!f===w}}if(o==="text"||o==="number"||o==="date"){const w=String(r.answer??"");return{roundIndex:s,cardKey:`info:${t}:question-${o}`,publicPrompt:{kind:"text",title:h,prompt:d,inputType:o==="number"?"number":o==="date"?"date":"text",cardLabel:"question"},reveal:{kind:"text",expected:w,title:h},grade:f=>{if(o==="number"){const j=Number(f),i=Number(w);return Number.isFinite(j)&&Number.isFinite(i)&&Math.abs(j-i)<1e-9}return da(f)===da(w)}}}if(o==="ordering"){const w=Array.isArray(r.options)?r.options.filter(f=>typeof f=="string"):[];return{roundIndex:s,cardKey:`info:${t}:question-ordering`,publicPrompt:{kind:"ordering",title:h,prompt:d,options:w,cardLabel:"question"},reveal:{kind:"ordering",expected:w,title:h},grade:f=>JSON.stringify(Array.isArray(f)?f.map(String):[])===JSON.stringify(w)}}if(o==="matching"){const w=Array.isArray(r.columns)?r.columns.map(i=>Array.isArray(i)?i.filter(p=>typeof p=="string"):[]):[],f=r.answer??{},j=Array.isArray(f.paths)?f.paths.map(i=>Array.isArray(i)?i.map(p=>Number(p)).filter(Number.isFinite):null).filter(i=>Array.isArray(i)):[];return{roundIndex:s,cardKey:`info:${t}:question-matching`,publicPrompt:{kind:"matching",title:h,prompt:d,columns:w,cardLabel:"question"},reveal:{kind:"matching",expected:{paths:j},title:h},grade:i=>{const p=i??{},c=Array.isArray(p.paths)?p.paths.map(u=>Array.isArray(u)?u.map(v=>Number(v)).filter(Number.isFinite):null).filter(u=>Array.isArray(u)):[];return Fs(c)===Fs(j)}}}return null}async function vo(t){const n=await Yn({libraryId:t.libraryId,revisionId:t.revisionId}),s=(await Oa({libraryId:t.libraryId,collectionId:n.collectionId,limit:1e3})).items,o=Array.from(new Set(s.filter(i=>i.cardType==="info").map(i=>i.cardId))),h=new Map;await Promise.all(o.map(async i=>{try{const p=await na({libraryId:t.libraryId,infoId:i});h.set(i,{infoType:p.infoType,payload:p.payload})}catch{}}));const d=new Map;await Promise.all(Array.from(h.entries()).filter(([,i])=>i.infoType==="computed").map(async([i])=>{try{const p=await Vn({libraryId:t.libraryId,infoId:i});d.set(i,p)}catch{}}));const w=Array.from(new Set(s.filter(i=>i.cardType==="vocab").map(i=>i.label))).filter(Boolean),f=[],j=new Set;for(const i of s){if(i.cardType==="vocab"){const c=bo(i.label);if(!c)continue;if(i.checkType==="translation"&&i.direction==="a-to-b"){const[u,v]=c;f.push({roundIndex:f.length,cardKey:`connection:${i.cardId}:translation:a-to-b`,publicPrompt:{kind:"text",title:i.label,prompt:u,cardLabel:i.description??void 0},reveal:{kind:"text",expected:v,title:i.label},grade:m=>da(m)===da(v)})}else if(i.checkType==="translation"&&i.direction==="b-to-a"){const[u,v]=c;f.push({roundIndex:f.length,cardKey:`connection:${i.cardId}:translation:b-to-a`,publicPrompt:{kind:"text",title:i.label,prompt:v,cardLabel:i.description??void 0},reveal:{kind:"text",expected:u,title:i.label},grade:m=>da(m)===da(u)})}else if(i.checkType==="translation-match"){const u=Array.from(new Set([i.label,...w.filter(m=>m!==i.label).slice(0,3)])),v=u.findIndex(m=>m===i.label);f.push({roundIndex:f.length,cardKey:`connection:${i.cardId}:translation-match`,publicPrompt:{kind:"selection",title:i.label,prompt:"Select the matching pair",options:u,multiple:!1,cardLabel:i.description??void 0},reveal:{kind:"selection",expected:[v],title:i.label},grade:m=>{const S=Array.isArray(m)?un(m):un([m]);return S.length===1&&S[0]===v}})}continue}if(i.cardType!=="info")continue;const p=h.get(i.cardId);if(p){if(p.infoType==="word"&&i.checkType==="word-language"){const c=yo(i.description);if(!c)continue;f.push({roundIndex:f.length,cardKey:`info:${i.cardId}:word-language:${i.direction??""}`,publicPrompt:{kind:"text",title:i.label,prompt:`Language of: ${i.label}`,cardLabel:"word-language"},reveal:{kind:"text",expected:c,title:i.label},grade:u=>da(u)===da(c)});continue}if(p.infoType==="computed"&&i.checkType==="computed"){const c=d.get(i.cardId);if(!c)continue;f.push({roundIndex:f.length,cardKey:`info:${i.cardId}:computed`,publicPrompt:{kind:"text",title:i.label,prompt:c.prompt,multiLine:!1,cardLabel:"computed"},reveal:{kind:"text",expected:c.expectedAnswer,title:i.label},grade:u=>da(u)===da(c.expectedAnswer)});continue}if(p.infoType==="question"){const c=p.payload,u=c.definition??c,v=xo(i.cardId,i.label,u,f.length);v&&(v.roundIndex=f.length,f.push(v));continue}if(p.infoType==="citation"&&!j.has(i.cardId)){j.add(i.cardId);const c=p.payload,u=typeof c.text=="string"?c.text:"",v=typeof c.title=="string"&&c.title.trim()?c.title.trim():i.label;if(!u.trim())continue;const m=va(u,{minLen:7,maxLen:13});for(const S of m.order){const _=m.nodes[S];if(!_)continue;const x=bn(u,_);f.push({roundIndex:f.length,cardKey:`info:${i.cardId}:quote-fragment:${S}`,publicPrompt:{kind:"citation-fragment",title:v,before:x.before,after:x.after,fragmentId:S,cardLabel:"quote-fragment"},reveal:{kind:"citation-fragment",expected:x.fragment,title:v},grade:g=>Sa(x.fragment,String(g??""),{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}).isCorrect})}continue}}}return f.map((i,p)=>({...i,roundIndex:p}))}function wo(t){const{libraryId:n,revisionId:r}=t,[s,o]=a.useState(null),[h,d]=a.useState([]),[w,f]=a.useState("loading"),[j,i]=a.useState(null),p=`cogita.live.host.${n}.${r}`,c=s?h[s.currentRoundIndex]??null:null,u=a.useMemo(()=>s!=null&&s.code&&typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision/${encodeURIComponent(s.code)}`:"",[s==null?void 0:s.code]);a.useEffect(()=>{let g=!1;return vo({libraryId:n,revisionId:r}).then(C=>{g||d(C)}).catch(()=>{g||(i("Failed to load revision cards for live session."),f("error"))}),()=>{g=!0}},[n,r]),a.useEffect(()=>{let g=!1;async function C(){try{const D=typeof localStorage<"u"?localStorage.getItem(p):null;if(D){const U=JSON.parse(D),N=await cs({libraryId:n,sessionId:U.sessionId,hostSecret:U.hostSecret});if(g)return;o(N),f("ready");return}const y=await Br({libraryId:n,revisionId:r,title:"Live revision"});if(g)return;o(y),localStorage.setItem(p,JSON.stringify({sessionId:y.sessionId,hostSecret:y.hostSecret})),f("ready")}catch{if(g)return;i("Failed to create live session."),f("error")}}return C(),()=>{g=!0}},[n,r,p]),a.useEffect(()=>{if(!s)return;const g=window.setInterval(async()=>{try{const C=await cs({libraryId:n,sessionId:s.sessionId,hostSecret:s.hostSecret});o(C)}catch{}},1200);return()=>window.clearInterval(g)},[n,s]);const v=async g=>{if(!s)return;const C=await Vr({libraryId:n,sessionId:s.sessionId,hostSecret:s.hostSecret,status:g.status??s.status,currentRoundIndex:g.currentRoundIndex??s.currentRoundIndex,revealVersion:g.revealVersion??s.revealVersion,currentPrompt:g.currentPrompt??s.currentPrompt??null,currentReveal:g.currentReveal??s.currentReveal??null});o(C)},m=async g=>{const C=h[g];!C||!s||await v({status:"running",currentRoundIndex:g,revealVersion:s.revealVersion+1,currentReveal:null,currentPrompt:{...C.publicPrompt,roundIndex:g,cardKey:C.cardKey}})},S=async()=>{h.length&&await m((s==null?void 0:s.currentRoundIndex)??0)},_=async()=>{if(!s||!c)return;const g=new Map(s.currentRoundAnswers.map(y=>[y.participantId,y.answer])),C=s.participants.map(y=>{const U=g.get(y.participantId),N=c.grade(U);return{participantId:y.participantId,isCorrect:N,pointsAwarded:N?1:0}}),D=await Or({libraryId:n,sessionId:s.sessionId,hostSecret:s.hostSecret,scores:C});o(D),await v({status:"revealed",revealVersion:D.revealVersion+1,currentReveal:c.reveal})},x=async()=>{if(!s)return;const g=s.currentRoundIndex+1;if(g>=h.length){await v({status:"finished",currentReveal:null});return}await m(g)};return e.jsx(At,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Live Revision Host"}),e.jsx("h2",{className:"cogita-detail-title",children:"Host session"}),w==="loading"?e.jsx("p",{children:"Loading…"}):null,j?e.jsx("p",{className:"cogita-help",children:j}):null,s?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Join code"}),e.jsx("input",{readOnly:!0,value:s.code})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Join URL"}),e.jsx("input",{readOnly:!0,value:u})]}),u?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"QR"}),e.jsx("div",{style:{display:"inline-flex",padding:"0.75rem",borderRadius:"12px",background:"#fff"},children:e.jsx(cr,{value:u,size:176,marginSize:2})})]}):null,e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Status"}),e.jsx("input",{readOnly:!0,value:s.status})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:S,disabled:!h.length,children:"Publish current round"}),e.jsx("button",{type:"button",className:"cta ghost",onClick:_,disabled:!c,children:"Reveal + score"}),e.jsx("button",{type:"button",className:"cta ghost",onClick:x,disabled:!h.length,children:"Next"})]}),e.jsxs("p",{className:"cogita-help",children:["Rounds: ",h.length]})]}):null]}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Current round"}),e.jsx("h3",{className:"cogita-detail-title",children:(c==null?void 0:c.publicPrompt.title)??"No round selected"}),c?e.jsx("pre",{className:"cogita-json-preview",children:JSON.stringify(c.publicPrompt,null,2)}):e.jsx("p",{className:"cogita-help",children:"No rounds generated from this revision yet."}),s!=null&&s.currentReveal?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Reveal"}),e.jsx("pre",{className:"cogita-json-preview",children:JSON.stringify(s.currentReveal,null,2)})]}):null,e.jsx("p",{className:"cogita-user-kicker",children:"Participants"}),e.jsxs("div",{className:"cogita-share-list",children:[s==null?void 0:s.participants.map(g=>{const C=s.currentRoundAnswers.find(D=>D.participantId===g.participantId);return e.jsx("div",{className:"cogita-share-row",children:e.jsxs("div",{children:[e.jsx("strong",{children:g.displayName}),e.jsxs("div",{className:"cogita-share-meta",children:[g.score," pt · ",C?"answered":"waiting",(C==null?void 0:C.isCorrect)===!0?" · correct":"",(C==null?void 0:C.isCorrect)===!1?" · incorrect":""]})]})},g.participantId)}),s&&s.participants.length===0?e.jsx("p",{className:"cogita-help",children:"No participants yet."}):null]})]})]})})})})})}const Mo=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionHostPage:wo},Symbol.toStringTag,{value:"Module"}));function Ds(t){return`cogita.live.join.${t}`}function jo(t){const{code:n}=t,[r,s]=a.useState(""),[o,h]=a.useState(()=>typeof localStorage>"u"?null:localStorage.getItem(Ds(n))),[d,w]=a.useState(null),[f,j]=a.useState("idle"),[i,p]=a.useState(""),[c,u]=a.useState([]),[v,m]=a.useState(null),[S,_]=a.useState([]),[x,g]=a.useState([]),C=(d==null?void 0:d.currentPrompt)??null,D=a.useMemo(()=>`${(d==null?void 0:d.currentRoundIndex)??0}:${(d==null?void 0:d.revealVersion)??0}:${String((C==null?void 0:C.cardKey)??"")}`,[C==null?void 0:C.cardKey,d==null?void 0:d.currentRoundIndex,d==null?void 0:d.revealVersion]);a.useEffect(()=>{p(""),u([]),m(null),_(Array.isArray(C==null?void 0:C.options)?[...C.options??[]]:[]),g([])},[D,C==null?void 0:C.options]),a.useEffect(()=>{let B=!0;const Q=async()=>{try{const Ee=await ds({code:n,participantToken:o});if(!B)return;w(Ee),o&&j("ready")}catch{B&&f!=="joining"&&j("error")}};Q();const xe=window.setInterval(Q,1200);return()=>{B=!1,window.clearInterval(xe)}},[n,o,f]);const y=async()=>{j("joining");try{const B=await qr({code:n,name:r});h(B.participantToken),localStorage.setItem(Ds(n),B.participantToken),j("ready")}catch{j("error")}},U=B=>{if(!!(C!=null&&C.multiple)){u(xe=>xe.includes(B)?xe.filter(Ee=>Ee!==B):[...xe,B].sort((Ee,re)=>Ee-re));return}u([B])},N=(B,Q)=>{_(xe=>{const Ee=[...xe],re=B+Q;return re<0||re>=Ee.length?xe:([Ee[B],Ee[re]]=[Ee[re],Ee[B]],Ee)})},ae=()=>{const B=Array.isArray(C==null?void 0:C.columns)?C.columns:[];g(Q=>[...Q,B.map(()=>0)])},z=(B,Q,xe)=>{g(Ee=>Ee.map((re,A)=>A!==B?re:re.map((ye,J)=>J===Q?xe:ye)))},P=async()=>{if(!o||!C||typeof C.cardKey!="string")return;let B=null;switch(C.kind){case"selection":B=c;break;case"boolean":B=v;break;case"ordering":B=S;break;case"matching":B={paths:x};break;case"citation-fragment":case"text":default:B=i;break}try{await Ur({code:n,participantToken:o,roundIndex:Number(C.roundIndex??(d==null?void 0:d.currentRoundIndex)??0),cardKey:C.cardKey,answer:B});const Q=await ds({code:n,participantToken:o});w(Q),j("ready")}catch{j("error")}};return e.jsx(At,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Live Revision"}),e.jsx("h2",{className:"cogita-detail-title",children:"Join session"}),o?e.jsx("p",{className:"cogita-help",children:"Joined. Waiting for host."}):e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{value:r,onChange:B=>s(B.target.value)})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:y,disabled:!r.trim()||f==="joining",children:f==="joining"?"Joining…":"Join"})})]}),f==="error"?e.jsx("p",{className:"cogita-help",children:"Connection error or invalid session."}):null,e.jsx("p",{className:"cogita-user-kicker",children:"Scoreboard"}),e.jsxs("div",{className:"cogita-share-list",children:[d==null?void 0:d.scoreboard.map(B=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:B.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[B.score," pt"]})]},B.participantId)),d&&d.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:"No participants yet."}):null]})]}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Question"}),e.jsx("h3",{className:"cogita-detail-title",children:typeof(C==null?void 0:C.title)=="string"?C.title:"Waiting for host"}),C?e.jsxs(e.Fragment,{children:[C.kind==="citation-fragment"?e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("span",{style:{opacity:.7},children:String(C.before??"")}),e.jsx("strong",{children:" [ ... ] "}),e.jsx("span",{style:{opacity:.7},children:String(C.after??"")})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Fragment"}),e.jsx("input",{value:i,onChange:B=>p(B.target.value)})]})]}):null,C.kind==="text"?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(C.prompt??"")}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsx("input",{type:C.inputType==="number"?"number":C.inputType==="date"?"date":"text",value:i,onChange:B=>p(B.target.value)})]})]}):null,C.kind==="boolean"?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(C.prompt??"")}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>m(!0),children:"True"}),e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>m(!1),children:"False"})]})]}):null,C.kind==="selection"?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(C.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:(Array.isArray(C.options)?C.options:[]).map((B,Q)=>e.jsxs("label",{className:"cogita-share-row",children:[e.jsx("span",{children:B}),e.jsx("input",{type:C.multiple?"checkbox":"radio",name:"live-selection",checked:c.includes(Q),onChange:()=>U(Q)})]},`${Q}-${B}`))})]}):null,C.kind==="ordering"?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(C.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:S.map((B,Q)=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("span",{children:B}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>N(Q,-1),children:"↑"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>N(Q,1),children:"↓"})]})]},`${Q}-${B}`))})]}):null,C.kind==="matching"?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(C.prompt??"")}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:ae,children:"Add path"})}),x.map((B,Q)=>e.jsx("div",{className:"cogita-form-actions",children:(Array.isArray(C.columns)?C.columns:[]).map((xe,Ee)=>e.jsx("select",{value:B[Ee]??0,onChange:re=>z(Q,Ee,Number(re.target.value)),children:xe.map((re,A)=>e.jsxs("option",{value:A,children:[A,": ",re]},`${Ee}-${A}`))},`path-${Q}-col-${Ee}`))},`path-${Q}`))]}):null,e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:P,disabled:!o||!C.cardKey||(d==null?void 0:d.answerSubmitted),children:d!=null&&d.answerSubmitted?"Submitted":"Submit answer"})})]}):e.jsx("p",{className:"cogita-help",children:"Waiting for host to publish a question."}),d!=null&&d.currentReveal?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Reveal"}),e.jsx("pre",{className:"cogita-json-preview",children:JSON.stringify(d.currentReveal,null,2)})]}):null]})]})})})})})}const Lo=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionJoinPage:jo},Symbol.toStringTag,{value:"Module"}));export{To as C,Co as a,Io as b,Mo as c,Lo as d};
