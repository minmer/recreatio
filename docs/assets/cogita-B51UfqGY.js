import{r as a,j as e,u as An,a as Ea,b as En,c as Pn,d as Kn,R as nn,B as sn,C as rn}from"./vendor-CL5v9b84.js";import{L as Ns,A as Ss,g as Ts,a as Gs,b as Oa,c as Cs,s as Wn,d as Fn,e as Ys,f as fn,h as aa,i as Qs,j as Xs,k as Ua,l as qa,m as Is,n as Dn,o as $n,p as Zs,u as Gn,q as Ms,r as ei,t as ti,v as ai,w as ni,x as si,y as Ls,z as ii,B as $s,C as Rs,D as ri,E as oi,F as on,G as Ja,H as li,I as As,J as ci,K as di,M as Es,N as ui,O as hi,P as gi,Q as Yn,R as ha,S as mi,T as pi,U as fi,V as bi,W as yi,X as xi,Y as vi,Z as wi,_ as ji,$ as ki,a0 as Ni,a1 as Si,a2 as Ti,a3 as Qn}from"./recreatio-core-ULPb4Sxr.js";import"./vendor-cogita-ui-mbCyoqV0.js";const La={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},Ma={moveMs:900,pauseMs:220,errorMs:900},Ci=(t=11)=>{let n=t;const s=()=>(n=(n*1664525+1013904223)%4294967296,n/4294967296),{width:i,height:r,paddingX:g,paddingY:m,levels:k}=La,j=(r-m*2)/(k.length-1),M=[],o=[],y=[];k.forEach((p,h)=>{const ce=r-m-h*j,P=i-g*2,f=[];for(let V=0;V<p;V+=1){const N=g+(V+1)*P/(p+1),W=(s()-.5)*18,K=Math.max(g,Math.min(i-g,N+W)),I=h===0?3:h<2?2.1:1.4,he=h===0?"root":`l${h}-${V}`;f.push({id:he,x:h===0?i/2:K,y:ce,r:I,level:h,role:h===0?"root":void 0})}y.push(f),M.push(...f)});const l=y[y.length-1];if(l!=null&&l.length){const p=l[Math.floor(l.length/2)];p.role="goal",p.r=2}for(let p=1;p<y.length;p+=1){const h=y[p-1];y[p].forEach(P=>{const f=[...h].sort((K,I)=>Math.abs(K.x-P.x)-Math.abs(I.x-P.x)),V=f[0],N=f[1]&&s()<.45?f[1]:null;(N?[V,N]:[V]).forEach(K=>{o.push({from:K.id,to:P.id,key:`${K.id}-${P.id}`})}),s()<.2&&f[2]&&o.push({from:f[2].id,to:P.id,key:`${f[2].id}-${P.id}`})})}const u=new Map;o.forEach(p=>{const h=u.get(p.to)??[];h.push(p.from),u.set(p.to,h)});const v=new Map,w=new Map,T=new Map;o.forEach(p=>{const h=v.get(p.from)??[];h.push(p.key),v.set(p.from,h);const ce=w.get(p.from)??[];ce.push(p.to),w.set(p.from,ce);const P=T.get(p.from)??[];P.push(p.to),T.set(p.from,P);const f=T.get(p.to)??[];f.push(p.from),T.set(p.to,f)});const D=new Map;return M.forEach(p=>{D.set(p.id,p)}),{nodes:M,links:o,parentsById:u,linksByFrom:v,childrenByFrom:w,neighborsById:T,nodesById:D}};function Ii({slides:t,activeIndex:n,introOpen:s,prefersReducedMotion:i,onNext:r,onPrev:g,onSelect:m,onExit:k,onOpen:j,onRegister:M}){const o=n===t.length-1,y=s&&n===0?"entry":"docked",l=t[t.length-1],[u,v]=a.useState(!1),w=a.useMemo(()=>Array.from({length:20},(A,Y)=>({src:`/cogita/logo/Cogita${String(Y).padStart(2,"0")}.png`,kind:Y<=11?"bubble":Y<=17?"text":"recreatio"})),[]),T=s&&n===0;a.useEffect(()=>{if(!s){v(!1);return}n>0&&!u&&v(!0)},[n,s,u]);const D=a.useRef(0),p=a.useRef(null),h=a.useMemo(()=>{const A={x:40,y:160},Y={x:260,y:48},ne=6,S=Y.x-A.x,U=A.y-Y.y,$=S/ne,H=[.3,.45,.6,.65,1.4,2.2],te=H.reduce((ue,oe)=>ue+oe,0),Ne=H.map(ue=>U*ue/te),Ee=[A];let Ve=A.x,je=A.y;for(let ue=1;ue<=ne;ue+=1){const oe=(Math.random()-.5)*14,Ye=(Math.random()-.5)*28;Ve=Math.max(A.x+ue*14,Math.min(Y.x-(ne-ue)*14,Ve+$+oe));const Ge=Ne[ue-1]??Ne[Ne.length-1];je=je-Ge+Ye;const Oe=Math.max(Y.y,Math.min(A.y-4,je));Ee.push({x:Math.round(Ve),y:Math.round(Oe)})}return Ee[Ee.length-1]=Y,Ee},[]),ce=a.useMemo(()=>{const U=(te,Ne,Ee)=>Math.min(Ee,Math.max(Ne,te)),$=h.map(te=>{const Ne=10+Math.random()*36;return{x:U(te.x,40,260),y:U(te.y-Ne,40,140)}}),H=h.map((te,Ne)=>{var je;const Ee=12+Math.random()*40,Ve=((je=$[Ne])==null?void 0:je.y)??te.y;return{x:U(te.x,40,260),y:U(Math.max(Ve+10,te.y+Ee),60,170)}});return{upper:$,lower:H}},[h]),P=a.useMemo(()=>{var Y;const A=((Y=h[4])==null?void 0:Y.x)??260;return Math.max(0,Math.min(240,A-40))},[h]),f=a.useMemo(()=>{var Ne,Ee;const A=(Ve,je,ue)=>Math.min(ue,Math.max(je,Ve)),Y=(Ve,je,ue)=>h.map((oe,Ye)=>{var bt,It;const Ge=((bt=ce.upper[Ye])==null?void 0:bt.y)??oe.y,Oe=((It=ce.lower[Ye])==null?void 0:It.y)??oe.y,st=(Math.random()-.5)*70,jt=oe.y+Ve+st,Xe=A(oe.y+je,Ge+6,Oe-6),lt=A(oe.y+ue,Ge+6,Oe-6);return{x:oe.x,y:A(jt,Math.min(Xe,lt),Math.max(Xe,lt))}}),ne=-14+Math.random()*28,S=14+Math.random()*28,U=Y(ne,-80,12),$=Y(S,-12,80);for(let Ve=4;Ve<h.length;Ve+=1){const je=h[Ve],ue=((Ne=ce.upper[Ve])==null?void 0:Ne.y)??je.y,oe=((Ee=ce.lower[Ve])==null?void 0:Ee.y)??je.y;U[Ve]={x:je.x,y:A(je.y-12,ue+6,oe-6)},$[Ve]={x:je.x,y:A(je.y+12,ue+6,oe-6)}}const H=ce.upper.length?ce.upper[ce.upper.length-1].y:40,te=ce.lower.length?ce.lower[ce.lower.length-1].y:170;return U[U.length-1]={x:h[h.length-1].x,y:A(h[h.length-1].y-14,H,te)},$[$.length-1]={x:h[h.length-1].x,y:A(h[h.length-1].y+12,H,te)},{higher:U,lower:$}},[h,ce]),V=1e4,N=a.useMemo(()=>{let A=17;const Y=()=>(A=(A*1664525+1013904223)%4294967296,A/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((S,U)=>{const $=(Y()-.5)*240,H=(Y()-.5)*180,te=(Y()-.5)*24;return{id:`card-${U+1}`,throw:{x:`${$.toFixed(0)}px`,y:`${H.toFixed(0)}px`,rot:`${te.toFixed(1)}deg`},grid:{x:`${S.x}px`,y:`${S.y}px`},delay:`${U*.12}s`}})},[]),W=a.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[K,I]=a.useState([]),he=a.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),le=a.useMemo(()=>{const Y=[],S=($,H)=>$+Math.random()*(H-$);for(let $=0;$<6;$+=1){let H=!1;for(let te=0;te<80;te+=1){const Ne=S(14,86),Ee=S(10,34);if(Y.every(je=>{const ue=je.x-Ne,oe=je.y-Ee;return Math.hypot(ue,oe)>=12})){Y.push({x:Ne,y:Ee}),H=!0;break}}H||Y.push({x:S(16,84),y:S(12,32)})}return Y.map(($,H)=>({id:`p${H+1}`,x:`${$.x.toFixed(1)}%`,y:`${$.y.toFixed(1)}%`,xNum:$.x,yNum:$.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[ve,Ce]=a.useState(0),[Z,C]=a.useState(0),[Le,B]=a.useState([]),ee=1e4,q=a.useMemo(()=>{if(le.length<2)return[];const A=H=>{let te=H+1831565813;return te=Math.imul(te^te>>>15,te|1),te^=te+Math.imul(te^te>>>7,te|61),((te^te>>>14)>>>0)/4294967296},Y=(H,te)=>Math.floor(A(H)*te),ne=new Set,S=[],U=Math.min(3,le.length);let $=0;for(;S.length<U&&$<30;){$+=1;const H=Y(ve*13+$*5,le.length),te=Y(ve*29+$*7,le.length);if(H===te)continue;const Ne=H<te?`${H}-${te}`:`${te}-${H}`;ne.has(Ne)||(ne.add(Ne),S.push({id:`link-${Ne}`,from:le[H],to:le[te],delay:`${($*.35).toFixed(2)}s`}))}return S},[ve,le]);a.useEffect(()=>{if(!s||n!==2)return;const A=()=>{const ne=N.map(S=>S.id);for(let S=ne.length-1;S>0;S-=1){const U=Math.floor(Math.random()*(S+1));[ne[S],ne[U]]=[ne[U],ne[S]]}return ne.slice(0,4)};I(A());const Y=window.setInterval(()=>{I(A())},V);return()=>window.clearInterval(Y)},[n,s,N,V]),a.useEffect(()=>{if(!s||n!==3)return;const A=()=>{C(Math.floor(Math.random()*he.length)),B(le.map(()=>Math.random()<.6?"good":"bad")),Ce(ne=>ne+1)};A();const Y=window.setInterval(A,ee);return()=>window.clearInterval(Y)},[n,s,he.length,le,ee]);const ye=a.useMemo(()=>Ci(11),[]),[X,de]=a.useState(new Set(["root"])),[xe,Ke]=a.useState(new Set),[_e,Ie]=a.useState(new Set),[qe,Qe]=a.useState({fromId:"root",toId:"root",key:0}),$e=a.useRef(X),He=a.useRef("root"),rt=a.useRef(0),ot=a.useRef(null),ze=a.useRef(null),ke=a.useRef([]);a.useEffect(()=>{$e.current=X},[X]);const J=a.useMemo(()=>{const A=new Set;return X.forEach(Y=>{const ne=ye.linksByFrom.get(Y);ne&&ne.forEach(S=>A.add(S))}),A},[X,ye]),Re=ye.nodesById.get(qe.toId)??ye.nodesById.get("root"),re=Re?`${Re.x/La.width*100}%`:"50%",_=Re?`${Re.y/La.height*100}%`:"90%";a.useEffect(()=>{if(!s||n!==1||i)return;(()=>{de(new Set(["root"])),Ke(new Set),Ie(new Set),Qe({fromId:"root",toId:"root",key:0}),ze.current=null,rt.current=0,He.current="root",ke.current=[]})();const Y=()=>{const S=He.current,U=$e.current,H=(ye.childrenByFrom.get(S)??[]).filter(oe=>!U.has(oe));if(H.length)return H[Math.floor(Math.random()*H.length)];if(U.size>=ye.nodes.length){const oe=ye.neighborsById.get(S)??[];return oe.length?oe[Math.floor(Math.random()*oe.length)]:null}const te=oe=>(ye.childrenByFrom.get(oe)??[]).some(Ge=>!U.has(Ge)),Ne=[S],Ee=new Set([S]),Ve=new Map;let je=null;for(;Ne.length;){const oe=Ne.shift();if(!oe)break;if(oe!==S&&te(oe)){je=oe;break}(ye.neighborsById.get(oe)??[]).forEach(Ge=>{Ee.has(Ge)||(Ee.add(Ge),Ve.set(Ge,oe),Ne.push(Ge))})}if(!je)return null;let ue=je;for(;Ve.get(ue)&&Ve.get(ue)!==S;)ue=Ve.get(ue)??ue;return ue},ne=(S,U)=>{if(S===U){const $=Y();$&&ne(S,$);return}rt.current+=1,Qe({fromId:S,toId:U,key:rt.current}),He.current=U,ot.current=window.setTimeout(()=>{const $=ye.parentsById.get(U)??[],H=$e.current,te=$.filter(je=>!H.has(je));if(!te.length){const je=new Set(H);je.add(U),de(je),ot.current=window.setTimeout(()=>{for(;ke.current.length;){const oe=ke.current[ke.current.length-1];if(!je.has(oe)){if(oe!==U){ne(U,oe);return}break}ke.current.pop()}const ue=Y();ue&&ne(U,ue)},Ma.pauseMs);return}const Ne=new Set([U,...te]),Ee=new Set(te.map(je=>`${je}-${U}`));Ke(Ne),Ie(Ee),ke.current.includes(U)||ke.current.push(U);const Ve=te[Math.floor(Math.random()*te.length)];ze.current={fromId:U,toId:Ve},ot.current=window.setTimeout(()=>{Ke(new Set),Ie(new Set);const je=ze.current;je&&ne(je.fromId,je.toId)},Ma.errorMs)},Ma.moveMs)};return ot.current=window.setTimeout(()=>{const S=Y();S&&ne(He.current,S)},Ma.pauseMs),()=>{ot.current&&window.clearTimeout(ot.current)}},[n,s,ye,i]);const fe=A=>{if(!s)return;const Y=Date.now();Y-D.current<520||Math.abs(A.deltaY)<10||(D.current=Y,A.deltaY>0?r():g(),A.preventDefault())},We=A=>{if(!s)return;const Y=A.touches[0];Y&&(p.current={x:Y.clientX,y:Y.clientY})},R=A=>{if(!s)return;const Y=p.current;if(p.current=null,!Y)return;const ne=A.changedTouches[0];if(!ne)return;const S=ne.clientX-Y.x,U=ne.clientY-Y.y;Math.abs(U)<40||Math.abs(U)<Math.abs(S)||(U<0?r():g())};return e.jsxs("div",{className:`cogita-intro ${s?"is-open":"is-closed"} ${i?"is-reduced":""} ${o?"is-final":""}`,"data-slide":n+1,onWheel:fe,onTouchStart:We,onTouchEnd:R,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":y,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${T&&!u?"is-entry":""}`,children:w.map((A,Y)=>e.jsx("img",{src:A.src,alt:"",className:`cogita-logo-layer ${Y===0?"is-base":""} ${A.kind==="text"?"is-text":A.kind==="recreatio"?"is-recreatio":""} ${A.kind==="bubble"?"is-bubble":""}`},A.src))})}),s&&t.map((A,Y)=>{const ne=Y===n;return e.jsxs("section",{className:`cogita-intro-slide slide-${Y+1} ${ne?"is-active":""}`,"aria-hidden":!ne,children:[e.jsxs("div",{className:"cogita-intro-text",children:[A.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:A.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:A.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:A.title}),A.body&&e.jsx("p",{children:A.body.split(`
`).map((S,U)=>e.jsxs("span",{children:[S,U===0&&e.jsx("br",{})]},String(U)))})]}),A.micro&&e.jsx("p",{className:"cogita-intro-micro",children:A.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:o?M:r,children:A.cta}),o&&A.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>m(0),children:A.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[Y===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${La.width} ${La.height}`,preserveAspectRatio:"none",children:[ye.links.map(S=>{const U=ye.nodesById.get(S.from),$=ye.nodesById.get(S.to);if(!U||!$)return null;const H=J.has(S.key),te=_e.has(S.key);return e.jsx("line",{className:`map-link ${H?"is-active":""} ${te?"is-error":""}`,x1:U.x,y1:U.y,x2:$.x,y2:$.y},S.key)}),ye.nodes.map(S=>{const U=X.has(S.id),$=xe.has(S.id);return e.jsx("circle",{className:`map-node ${S.role?`is-${S.role}`:""} ${U?"is-active":""} ${$?"is-error":""}`,cx:S.x,cy:S.y,r:S.r},S.id)})]}),Re&&e.jsx("span",{className:"map-explorer-dot",style:{left:re,top:_,"--move":`${Ma.moveMs}ms`}})]}),Y===2&&e.jsx("div",{className:"cogita-index-cards",children:N.map(S=>{const U=K.indexOf(S.id),$=U>=0?W[U]:null,H=($==null?void 0:$.x)??"140px",te=($==null?void 0:$.y)??"140px",Ne=U>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":S.throw.x,"--throw-y":S.throw.y,"--throw-rot":S.throw.rot,"--grid-x":S.grid.x,"--grid-y":S.grid.y,"--stack-x":H,"--stack-y":te,"--stack-opacity":Ne,"--delay":S.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},S.id)})}),Y===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[he.map((S,U)=>e.jsxs("div",{className:`round-card ${U===Z?"is-active":""}`,style:{"--card-x":S.x,"--card-y":S.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},S.id)),he[Z]&&e.jsx("span",{className:"round-ring",style:{"--card-x":he[Z].x,"--card-y":`calc(${he[Z].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:le.map(S=>e.jsx("span",{className:"player-dot",style:{left:S.x,top:S.y,"--jitter-x":S.jitterX,"--jitter-y":S.jitterY,"--breath-delay":S.delay}},S.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:q.map(S=>e.jsx("line",{className:"round-link",x1:S.from.xNum,y1:S.from.yNum,x2:S.to.xNum,y2:S.to.yNum,style:{"--delay":S.delay}},S.id))}),e.jsx("div",{className:"round-flows",children:le.map((S,U)=>{const $=Le[U]??"good",H=he[Z];if(!H)return null;const te=`calc(${H.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":S.x,"--from-y":S.y,"--to-x":H.x,"--to-y":te,"--delay":`${U*.12}s`}}),e.jsx("span",{className:`return-dot is-${$}`,style:{"--from-x":H.x,"--from-y":te,"--to-x":S.x,"--to-y":S.y,"--delay":`${U*.12}s`}}),e.jsx("span",{className:`result-pop is-${$}`,style:{"--at-x":S.x,"--at-y":S.y,"--delay":`${U*.12}s`}})]},`${S.id}-${ve}`)})})]},`round-${ve}`),Y===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${h[0].x} ${h[0].y} L${h[1].x} ${h[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${h[1].x} ${h[1].y} L${h[2].x} ${h[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${h[2].x} ${h[2].y} L${h[3].x} ${h[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${h[3].x} ${h[3].y} L${h[4].x} ${h[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${h[4].x} ${h[4].y} L${h[5].x} ${h[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${h[5].x} ${h[5].y} L${h[6].x} ${h[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${P};${P};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${ce.upper.map((S,U)=>`${U===0?"M":"L"}${S.x} ${S.y}`).join(" ")} ${ce.lower.slice().reverse().map(S=>`L${S.x} ${S.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${ce.upper.map((S,U)=>`${U===0?"M":"L"}${S.x} ${S.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${ce.lower.map((S,U)=>`${U===0?"M":"L"}${S.x} ${S.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[f.higher.slice(0,6).map((S,U)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${U+1}`,d:`M${S.x} ${S.y} L${f.higher[U+1].x} ${f.higher[U+1].y}`,pathLength:"100"},`peer-1-${U}`)),f.lower.slice(0,6).map((S,U)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${U+1}`,d:`M${S.x} ${S.y} L${f.lower[U+1].x} ${f.lower[U+1].y}`,pathLength:"100"},`peer-2-${U}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${h[0].x/300*100}%`,"--p0y":`${h[0].y/200*100}%`,"--p1x":`${h[1].x/300*100}%`,"--p1y":`${h[1].y/200*100}%`,"--p2x":`${h[2].x/300*100}%`,"--p2y":`${h[2].y/200*100}%`,"--p3x":`${h[3].x/300*100}%`,"--p3y":`${h[3].y/200*100}%`,"--p4x":`${h[4].x/300*100}%`,"--p4y":`${h[4].y/200*100}%`,"--p5x":`${h[5].x/300*100}%`,"--p5y":`${h[5].y/200*100}%`,"--p6x":`${h[6].x/300*100}%`,"--p6y":`${h[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${f.higher[0].x/300*100}%`,"--q0y":`${f.higher[0].y/200*100}%`,"--q1x":`${f.higher[1].x/300*100}%`,"--q1y":`${f.higher[1].y/200*100}%`,"--q2x":`${f.higher[2].x/300*100}%`,"--q2y":`${f.higher[2].y/200*100}%`,"--q3x":`${f.higher[3].x/300*100}%`,"--q3y":`${f.higher[3].y/200*100}%`,"--q4x":`${f.higher[4].x/300*100}%`,"--q4y":`${f.higher[4].y/200*100}%`,"--q5x":`${f.higher[5].x/300*100}%`,"--q5y":`${f.higher[5].y/200*100}%`,"--q6x":`${f.higher[6].x/300*100}%`,"--q6y":`${f.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${f.lower[0].x/300*100}%`,"--q0y":`${f.lower[0].y/200*100}%`,"--q1x":`${f.lower[1].x/300*100}%`,"--q1y":`${f.lower[1].y/200*100}%`,"--q2x":`${f.lower[2].x/300*100}%`,"--q2y":`${f.lower[2].y/200*100}%`,"--q3x":`${f.lower[3].x/300*100}%`,"--q3y":`${f.lower[3].y/200*100}%`,"--q4x":`${f.lower[4].x/300*100}%`,"--q4y":`${f.lower[4].y/200*100}%`,"--q5x":`${f.lower[5].x/300*100}%`,"--q5y":`${f.lower[5].y/200*100}%`,"--q6x":`${f.lower[6].x/300*100}%`,"--q6y":`${f.lower[6].y/200*100}%`}})]})})}),Y===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),Y===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},A.id)}),!s&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:l.title}),l.body&&e.jsx("p",{children:l.body}),l.micro&&e.jsx("p",{className:"cogita-intro-micro",children:l.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:M,children:l.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:j,children:"Otwórz pokaz"})]})]})})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((A,Y)=>e.jsx("button",{type:"button",className:`dot ${n===Y?"active":""}`,"aria-label":A.title,onClick:()=>m(Y)},A.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:k,children:"Pomiń"})]})]})}const Mi=6,Li=4;function $i({copy:t,onAuthAction:n,authLabel:s,showProfileMenu:i,onProfileNavigate:r,onToggleSecureMode:g,onLogout:m,secureMode:k,onNavigate:j,language:M,onLanguageChange:o}){const y=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}j("home")},l=a.useRef(null),u=a.useRef([]),v=a.useMemo(()=>{let B=Date.now()%2147483647;const ee=()=>(B=B*48271%2147483647,B/2147483647);return Array.from({length:Mi},(q,ye)=>{const X=6+ee()*8,de=7+ee()*10,xe=6+ee()*9,Ke=-ee()*X,_e=-ee()*de,Ie=-ee()*xe,qe=.18+ee()*.28,Qe=12+ee()*18,$e=4+ee()*8,He=(ee()-.5)*3.2,rt=(ee()-.5)*3.8,ot=ee()>.5?"alternate":"alternate-reverse",ze=ee()>.5?"alternate":"alternate-reverse",ke=ee()>.5?"alternate":"alternate-reverse",J=.18+ee()*.42,Re=30+ee()*60,re=-45-ee()*38,_=188+ee()*32,fe=.1+ee()*.2;return{id:`wave-${ye+1}`,style:{"--wave-sway-duration":`${X}s`,"--wave-scale-duration":`${de}s`,"--wave-drift-duration":`${xe}s`,"--wave-sway-delay":`${Ke}s`,"--wave-scale-delay":`${_e}s`,"--wave-drift-delay":`${Ie}s`,"--wave-sway-dir":ot,"--wave-scale-dir":ze,"--wave-drift-dir":ke,"--wave-scale":`${qe}`,"--wave-shift":`${Qe}%`,"--wave-xshift":`${$e}%`,"--wave-x0":`${He}%`,"--wave-y0":`${rt}%`,"--wave-opacity":`${J}`,"--wave-blur":`${Re}px`,"--wave-bottom":`${re}%`,"--wave-hue":`${_}`,"--wave-glow":`${fe}`}}})},[]),w=a.useMemo(()=>{let B=Date.now()*3%2147483647;const ee=()=>(B=B*48271%2147483647,B/2147483647);return Array.from({length:Li},(q,ye)=>{const X=180+ee()*220,de=220+ee()*280,xe=-ee()*X,Ke=-ee()*de,_e=.12+ee()*.22,Ie=3+ee()*7,qe=1+ee()*3,Qe=(ee()-.5)*2.8,$e=(ee()-.5)*2.2;return{id:`mesh-${ye+1}`,seed:1e3+ye*991+Math.floor(ee()*999),style:{"--mesh-sway-duration":`${X}s`,"--mesh-drift-duration":`${de}s`,"--mesh-sway-delay":`${xe}s`,"--mesh-drift-delay":`${Ke}s`,"--mesh-scale":`${_e}`,"--mesh-shift":`${Ie}%`,"--mesh-xshift":`${qe}%`,"--mesh-x0":`${$e}%`,"--mesh-y0":`${Qe}%`}}})},[]),T=a.useMemo(()=>{const B=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],ee=t.cogita.introSlides,q=new Map(ee.map(ye=>[ye.id,ye]));return B.map(ye=>{var de;const X=q.get(ye.id);return{...ye,...X,title:(X==null?void 0:X.title)??"Cogita",cta:(X==null?void 0:X.cta)??((de=t.cogita.introSlides[0])==null?void 0:de.cta)??t.cogita.loginCta,secondary:X==null?void 0:X.secondary}})},[t.cogita.introSlides]),[D,p]=a.useState(0),[h,ce]=a.useState(!0),[P,f]=a.useState(!1),V=T.length-1,N=a.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),W=a.useCallback(()=>{N(),n()},[N,n]),K=a.useCallback(()=>{ce(!0),p(0)},[]),I=a.useCallback(()=>{ce(!1),p(V)},[V]),he=a.useCallback(B=>{p(Math.max(0,Math.min(V,B)))},[V]),le=a.useCallback(()=>{D>=V?W():he(D+1)},[D,he,W,V]),ve=a.useCallback(()=>{he(D-1)},[D,he]);a.useEffect(()=>{var q;const B=(q=window.matchMedia)==null?void 0:q.call(window,"(prefers-reduced-motion: reduce)");if(!B)return;const ee=()=>f(B.matches);return ee(),B.addEventListener?(B.addEventListener("change",ee),()=>B.removeEventListener("change",ee)):(B.addListener(ee),()=>B.removeListener(ee))},[]),a.useEffect(()=>{if(!h)return;const B=ee=>{const q=ee.target;if(!q)return;const ye=q.tagName;if(!(q.isContentEditable||ye==="INPUT"||ye==="TEXTAREA"||ye==="SELECT"||ye==="BUTTON"||ye==="A"||q.closest('button, a, [role="button"], [role="link"]'))){if(ee.key==="Escape"){I();return}if(ee.key==="ArrowLeft"||ee.key==="ArrowUp"){ve();return}(ee.key==="ArrowRight"||ee.key==="ArrowDown"||ee.code==="Space"||ee.key===" ")&&(ee.preventDefault(),le())}};return window.addEventListener("keydown",B),()=>window.removeEventListener("keydown",B)},[I,le,ve,h]),a.useEffect(()=>{h&&D===V&&N()},[D,h,V,N]),a.useEffect(()=>{const B=l.current;if(!B)return;const ee=u.current.filter(re=>!!re);if(!ee.length)return;const q=1,ye=.6,X=.6,de=Math.max(1,Math.min(q,window.devicePixelRatio||1));let xe=0,Ke=0,_e=ye,Ie=0,qe=0;const Qe=re=>{let _=re%2147483647;return _<=0&&(_+=2147483646),(fe,We)=>{_=_*48271%2147483647;const R=_/2147483647;return fe+R*(We-fe)}},$e={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},He=re=>{const _=Math.sin(re*12.9898)*43758.5453;return _-Math.floor(_)},rt=re=>{const _=He(re+.1)||1e-4,fe=He(re+.7)||1e-4;return Math.sqrt(-2*Math.log(_))*Math.cos(2*Math.PI*fe)},ot=(re,_)=>{const fe=Math.floor(re),We=fe+1,R=re-fe,A=R*R*(3-2*R),Y=He(fe*12.9898+_*78.233),ne=He(We*12.9898+_*78.233);return Y+(ne-Y)*A},ze=re=>{const _=Qe(re),fe=Math.min(4,Math.max(4,Math.floor(xe/1200*$e.filamentCount)));return Array.from({length:fe},(We,R)=>{const A=Math.max(-1,Math.min(1,rt(re+R*.37))),Y=Math.min(1,Math.max(0,He(re+R*1.31))),ne=Math.min($e.depthLayers-1,Math.floor(Y*$e.depthLayers));return{seed:_(0,Math.PI*2)+re*.01,offset:A,freqA:$e.freq1*(.75+_(0,.5)),freqB:$e.freq2*(.75+_(0,.5)),ampA:$e.amp1*(.6+_(0,.7)),ampB:$e.amp2*(.6+_(0,.7)),width:2+R%5*.32,depth:Y,layer:ne}})},ke=(re,_,fe)=>{const We=Math.max(30,Math.floor(xe*Ke/14e4));re.save(),re.globalAlpha=.6;for(let R=0;R<We;R+=1){const A=He(R*9.1+xe*.11)*_+fe,Y=He(R*3.7+Ke*.23)*Ke,ne=1.2+He(R*5.9)*2.4,S=re.createRadialGradient(A,Y,0,A,Y,ne*2);S.addColorStop(0,"rgba(10, 30, 60, 0.45)"),S.addColorStop(1,"rgba(10, 30, 60, 0)"),re.fillStyle=S,re.beginPath(),re.arc(A,Y,ne*2,0,Math.PI*2),re.fill()}re.restore()},J=(re,_)=>{re.clearRect(0,0,xe,Ke);const fe=Ke*$e.waveCenter,We=$e.waveBandPx,R=$e.segments,A=$e.colors.filaments,Y=Ie||xe,ne=0;ke(re,Y,ne),re.strokeStyle=A,re.lineCap="round",re.lineJoin="round";for(let S=0;S<_.length;S+=1){const U=_[S],$=U.offset*We*(.85+He(U.seed)*.4),H=1-Math.min(1,Math.abs($)/We),te=Math.exp(-Math.pow($/$e.crestThickness,2)),Ne=U.layer===0?1.1:U.layer===1?.85:.6,Ee=.35+(1-U.depth)*.65,Ve=H*Ee*Ne*(.34+te*.45);re.globalAlpha=Ve,re.lineWidth=U.width*(1+(1-U.depth)*.8);const je=[];for(let oe=0;oe<=R;oe+=1){const Ye=oe/R*Y+ne,Ge=(ot(Ye*.012,U.seed)-.5)*$e.xJitter,Oe=Ye+Ge,st=(ot(Oe*U.freqA,U.seed)-.5)*$e.jitterA,jt=(ot(Oe*U.freqB,U.seed*1.7)-.5)*$e.jitterB,Xe=fe+Math.sin(Oe*U.freqA+U.seed)*U.ampA+Math.sin(Oe*U.freqB+U.seed*1.3)*U.ampB+$+st+jt;je.push({x:Oe,y:Xe})}re.beginPath(),re.moveTo(je[0].x,je[0].y);for(let oe=1;oe<je.length-1;oe+=1){const Ye=(je[oe].x+je[oe+1].x)/2,Ge=(je[oe].y+je[oe+1].y)/2;re.quadraticCurveTo(je[oe].x,je[oe].y,Ye,Ge)}const ue=je[je.length-1];re.quadraticCurveTo(ue.x,ue.y,ue.x,ue.y),re.stroke()}re.save(),re.globalCompositeOperation="lighter",re.strokeStyle=$e.colors.glow,re.lineCap="round",re.lineJoin="round";for(let S=0;S<_.length;S+=1){const U=_[S];if(Math.abs(U.offset)*We>$e.crestThickness)continue;const $=$e.glowAlpha*(.7+(1-U.depth)*.6);re.globalAlpha=$,re.lineWidth=1.6+(1-U.depth)*1.2;const H=[];for(let Ne=0;Ne<=R;Ne+=1){const Ee=Ne/R*Y+ne,Ve=Math.sin(Ee*.02+U.seed)*3,je=fe+Math.sin(Ee*U.freqA+U.seed)*U.ampA+Math.sin(Ee*U.freqB+U.seed*1.3)*U.ampB+U.offset*We*.35+Ve;H.push({x:Ee,y:je})}re.beginPath(),re.moveTo(H[0].x,H[0].y);for(let Ne=1;Ne<H.length-1;Ne+=1){const Ee=(H[Ne].x+H[Ne+1].x)/2,Ve=(H[Ne].y+H[Ne+1].y)/2;re.quadraticCurveTo(H[Ne].x,H[Ne].y,Ee,Ve)}const te=H[H.length-1];re.quadraticCurveTo(te.x,te.y,te.x,te.y),re.stroke()}re.restore()},Re=()=>{xe=Math.floor(B.clientWidth),Ke=Math.floor(B.clientHeight),Ie=Math.floor(xe*1.8),qe=Ke,_e=xe<820?X:ye,ee.forEach(re=>{const _=re.getContext("2d");if(!_)return;re.width=Math.floor(Ie*de*_e),re.height=Math.floor(qe*de*_e),re.style.width=`${Ie}px`,re.style.height=`${qe}px`,re.style.left=`${-(Ie-xe)/2}px`,_.setTransform(de*_e,0,0,de*_e,0,0);const fe=Number(re.dataset.seed||1),We=ze(fe);J(_,We)})};return Re(),window.addEventListener("resize",Re,{passive:!0}),()=>window.removeEventListener("resize",Re)},[w]);const Ce=T[Math.min(D,T.length-1)],Z=h?Ce:T[T.length-1],C=(Z==null?void 0:Z.theme)??T[0].theme,Le={"--cogita-bg0":C.bg0,"--cogita-bg1":C.bg1,"--cogita-bg2":C.bg2,"--cogita-bloom":C.bloom,"--cogita-sat":C.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:y,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Ns,{value:M,onChange:o}),e.jsx(Ss,{copy:t,label:s,isAuthenticated:i,secureMode:k,onLogin:n,onProfileNavigate:r,onToggleSecureMode:g,onLogout:m,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:l,className:"cogita-section cogita-home",style:Le,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[w.map((B,ee)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:B.style,"data-seed":B.seed,ref:q=>{u.current[ee]=q}},B.id)),v.map(B=>e.jsx("div",{className:"cogita-home-wave",style:B.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},B.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(Ii,{slides:T,activeIndex:D,introOpen:h,prefersReducedMotion:P,onNext:le,onPrev:ve,onSelect:he,onExit:I,onOpen:K,onRegister:W})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const Yr=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:$i},Symbol.toStringTag,{value:"Module"})),Ps=a.createContext(!1);function Pt({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,headerExtra:o,children:y}){if(a.useContext(Ps))return e.jsx(e.Fragment,{children:y});const u=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}k("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:u,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Ns,{value:j,onChange:M}),e.jsxs("div",{className:"cogita-header-right",children:[o,e.jsx(Ss,{copy:t,label:n,isAuthenticated:s,secureMode:m,onLogin:()=>k("home"),onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:y}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function na(t){const[n,s]=a.useState("Cogita library"),[i,r]=a.useState(null);return a.useEffect(()=>{let g=!1;return Ts().then(m=>{if(g)return;const k=m.find(j=>j.libraryId===t);k&&s(k.name)}).catch(()=>{g||s("Cogita library")}),()=>{g=!0}},[t]),a.useEffect(()=>{let g=!1;return Gs(t).then(m=>{g||r(m)}).catch(()=>{g||r(null)}),()=>{g=!0}},[t]),{libraryName:n,stats:i}}function Xn({slices:t}){const n=t.reduce((i,r)=>i+Math.max(0,r.value),0),s=a.useMemo(()=>{if(n<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let i=0;return`conic-gradient(${t.map(g=>{const k=Math.max(0,g.value)/n*360,j=i,M=i+k;return i=M,`${g.color} ${j}deg ${M}deg`}).join(",")})`},[t,n]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:s}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(i=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:i.color}}),e.jsx("strong",{children:i.value}),e.jsx("small",{children:i.label})]},i.label))})]})}function Ri({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o}){const{libraryName:y,stats:l}=na(o),[u,v]=a.useState("infos"),[w,T]=a.useState(0),[D,p]=a.useState(0),[h,ce]=a.useState(0),P=(l==null?void 0:l.totalInfos)??0,f=(l==null?void 0:l.totalCollections)??0,V=0,N=0,W=0,K=Math.max(0,P-W-D),I=Math.max(0,P-D-h);a.useEffect(()=>{let le=!1;return(async()=>{try{const Ce=await Oa({libraryId:o,limit:200}),Z=await Promise.all(Ce.items.map(C=>Cs({libraryId:o,collectionId:C.collectionId}).catch(()=>[])));if(le)return;T(Z.reduce((C,Le)=>C+Le.length,0))}catch{le||T(0)}})(),()=>{le=!0}},[o]),a.useEffect(()=>{let le=!1;return(async()=>{try{const[Ce,Z,C]=await Promise.all([Wn({libraryId:o,type:"computed",limit:1}).catch(()=>({total:0})),Wn({libraryId:o,type:"source",limit:1}).catch(()=>({total:0})),Fn({libraryId:o}).catch(()=>({items:[]}))]);if(le)return;p((Ce.total??0)+(Z.total??0));const Le=new Set(C.items.filter(B=>B.childItemType.toLowerCase()==="info").map(B=>B.childItemId).filter(Boolean));ce(Le.size)}catch{le||(p(0),ce(0))}})(),()=>{le=!0}},[o]);const he=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:P},{key:"collections",label:t.cogita.library.overview.stats.collections,value:f},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:w},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:V},{key:"texts",label:t.cogita.library.overview.stats.texts,value:N}];return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:y})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:he.map(le=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${u===le.key?"active":""}`,onClick:()=>v(le.key),children:[e.jsx("span",{children:le.label}),e.jsx("strong",{children:le.value})]},le.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),u==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(Xn,{slices:[{label:t.cogita.library.overview.known,value:W,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:K,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:D,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(Xn,{slices:[{label:t.cogita.library.overview.availableChecks,value:h,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:I,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const Ze=(t,n)=>{const s=t.cogita.library.infoTypes,i=t.cogita.library.connectionTypes,r=t.cogita.library.groupTypes;return{any:s.any,vocab:s.vocab,book:r.book,citation:r.citation,language:s.language,word:s.word,sentence:s.sentence,topic:s.topic,collection:s.collection,person:s.person,institution:s.institution,collective:s.collective,orcid:s.orcid,address:s.address,email:s.email,phone:s.phone,media:s.media,work:s.work,geo:s.geo,music_piece:s.musicPiece,music_fragment:s.musicFragment,source:s.source,computed:s.computed,"word-language":i.wordLanguage,"citation-language":i.citationLanguage,"language-sentence":i.languageSentence,translation:i.translation,"word-topic":i.wordTopic,reference:i.reference,"source-resource":i.sourceResource,"work-contributor":i.workContributor,"work-medium":i.workMedium,"orcid-link":i.orcidLink}[n]??String(n)},Ai=t=>[{value:"any",label:Ze(t,"any")},{value:"language",label:Ze(t,"language")},{value:"word",label:Ze(t,"word")},{value:"sentence",label:Ze(t,"sentence")},{value:"topic",label:Ze(t,"topic")},{value:"collection",label:Ze(t,"collection")},{value:"person",label:Ze(t,"person")},{value:"institution",label:Ze(t,"institution")},{value:"collective",label:Ze(t,"collective")},{value:"orcid",label:Ze(t,"orcid")},{value:"address",label:Ze(t,"address")},{value:"email",label:Ze(t,"email")},{value:"phone",label:Ze(t,"phone")},{value:"media",label:Ze(t,"media")},{value:"work",label:Ze(t,"work")},{value:"geo",label:Ze(t,"geo")},{value:"music_piece",label:Ze(t,"music_piece")},{value:"music_fragment",label:Ze(t,"music_fragment")},{value:"source",label:Ze(t,"source")},{value:"citation",label:Ze(t,"citation")},{value:"computed",label:Ze(t,"computed")},{value:"vocab",label:Ze(t,"vocab")},{value:"book",label:Ze(t,"book")},{value:"word-language",label:Ze(t,"word-language")},{value:"citation-language",label:Ze(t,"citation-language")},{value:"language-sentence",label:Ze(t,"language-sentence")},{value:"translation",label:Ze(t,"translation")},{value:"word-topic",label:Ze(t,"word-topic")},{value:"reference",label:Ze(t,"reference")},{value:"source-resource",label:Ze(t,"source-resource")},{value:"work-contributor",label:Ze(t,"work-contributor")},{value:"work-medium",label:Ze(t,"work-medium")},{value:"orcid-link",label:Ze(t,"orcid-link")}],Ei=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],bn={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},Pi={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[bn]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[bn]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId"]},filterFields:[bn,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text"],connections:[{relationType:"citation-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"citationText",kind:"text",path:"text",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},Zn={infoType:"default",entityKind:"single",structure:{payloadFields:["label"]},filterFields:[]};function Ki(t){return t?Pi[t]??Zn:Zn}function Fi(t,n){return t.optionsSource==="languages"?n.languages.map(s=>({value:s.infoId,label:s.label})):t.optionsSource==="sourceKinds"?Ei:[]}const Di="cogita.revision.seed:";function Ks(t){return`${Di}${t}`}function zi(t,n){if(typeof window>"u")return null;const s=Array.from(new Set(n.map(g=>g.trim()).filter(Boolean)));if(!s.length)return null;const i=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,r={kind:"info-selection",libraryId:t,infoIds:s,createdAt:new Date().toISOString()};return window.localStorage.setItem(Ks(i),JSON.stringify(r)),i}function es(t,n){if(typeof window>"u")return null;const s=window.localStorage.getItem(Ks(n));if(!s)return null;try{const i=JSON.parse(s);if(i.kind!=="info-selection"||i.libraryId!==t||!Array.isArray(i.infoIds))return null;const r=i.infoIds.map(g=>String(g??"").trim()).filter(Boolean);return r.length?{infoIds:r}:null}catch{return null}}const Bi="cogita.collection-draft:";function Fs(t){return`${Bi}${t}`}function _i(t,n){if(typeof window>"u")return null;const s=Array.from(new Set(n.map(g=>g.trim()).filter(Boolean)));if(!s.length)return null;const i=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,r={kind:"info-selection",libraryId:t,infoIds:s,createdAt:new Date().toISOString()};return window.localStorage.setItem(Fs(i),JSON.stringify(r)),i}function Vi(t,n){if(typeof window>"u")return null;const s=window.localStorage.getItem(Fs(n));if(!s)return null;try{const i=JSON.parse(s);if(i.kind!=="info-selection"||i.libraryId!==t||!Array.isArray(i.infoIds))return null;const r=i.infoIds.map(g=>String(g??"").trim()).filter(Boolean);return r.length?{infoIds:r}:null}catch{return null}}const yn=60,Oi=500;function Ds(t){return`cogita.info-selection:${t}`}function ts(t){if(typeof window>"u")return{};const n=window.localStorage.getItem(Ds(t));if(!n)return{};try{const s=JSON.parse(n);return!s||typeof s!="object"?{}:s}catch{return{}}}function Ui({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o,mode:y}){var Be;const l=An(),u=Ea(),v=t.cogita.library.list,[w,T]=a.useState("any"),[D,p]=a.useState(""),[h,ce]=a.useState("relevance"),[P,f]=a.useState("details"),[V,N]=a.useState(!1),[W,K]=a.useState("idle"),[I,he]=a.useState([]),[le,ve]=a.useState(yn),[Ce,Z]=a.useState(null),[C,Le]=a.useState(()=>ts(o)),[B,ee]=a.useState({}),[q,ye]=a.useState([]),[X,de]=a.useState([]),[xe,Ke]=a.useState(null),[_e,Ie]=a.useState(null),[qe,Qe]=a.useState(null),[$e,He]=a.useState("idle"),[rt,ot]=a.useState([]),[ze,ke]=a.useState(""),[J,Re]=a.useState(null),[re,_]=a.useState("idle"),[fe,We]=a.useState(null),[R,A]=a.useState(null),[Y,ne]=a.useState("idle"),[S,U]=a.useState([]),[$,H]=a.useState("idle"),te=a.useMemo(()=>Ai(t),[t]),Ne=a.useMemo(()=>[{value:"relevance",label:v.sortRelevance},{value:"label_asc",label:v.sortLabelAsc},{value:"label_desc",label:v.sortLabelDesc},{value:"type_asc",label:v.sortTypeAsc},{value:"type_desc",label:v.sortTypeDesc}],[v.sortLabelAsc,v.sortLabelDesc,v.sortRelevance,v.sortTypeAsc,v.sortTypeDesc]);a.useEffect(()=>{Le(ts(o)),ee({}),N(!1)},[o]),a.useEffect(()=>{Fn({libraryId:o}).then(c=>Qe(c)).catch(()=>Qe({items:[]}))},[o]),a.useEffect(()=>{Ys({libraryId:o}).then(c=>ot(c)).catch(()=>ot([]))},[o]),a.useEffect(()=>{fn({libraryId:o,type:"language",filters:{sourceKind:"info"},limit:200}).then(c=>{const pe=c.map(Se=>({infoId:Se.infoId??"",infoType:Se.entityType,label:Se.title})).filter(Se=>Se.infoId.length>0);ye(pe)}).catch(()=>ye([]))},[o]),a.useEffect(()=>{fn({libraryId:o,type:"source",filters:{sourceKind:"info"},limit:200}).then(c=>{const pe=c.map(Se=>({infoId:Se.infoId??"",infoType:Se.entityType,label:Se.title})).filter(Se=>Se.infoId.length>0);de(pe)}).catch(()=>de([]))},[o]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(Ds(o),JSON.stringify(C))},[o,C]);const Ee=a.useMemo(()=>Ki(w==="any"?null:w),[w]),Ve=a.useMemo(()=>new URLSearchParams(u.search),[u.search]),je=a.useMemo(()=>u.pathname.split("/").filter(Boolean),[u.pathname]),ue=je.findIndex(c=>c==="infos"),oe=ue>=0&&(je[ue+1]??"").trim()||null,Ye=ue>=0?(je[ue+2]??"").trim():"",Ge=ue>=0?Ye==="checkcards"?"cards":Ye==="collections"?"collections":"overview":"",Oe=oe??((Ve.get("infoId")??"").trim()||null),st=oe?Ge:(Ve.get("infoView")??"overview").trim(),jt=st==="overview"&&!!Oe,Xe=st==="collections"&&!!Oe,lt=a.useMemo(()=>({language:v.typeFilterLanguage,languageA:v.typeFilterLanguageA,languageB:v.typeFilterLanguageB,originalLanguage:v.typeFilterOriginalLanguage,doi:v.typeFilterDoi,sourceKind:v.typeFilterSourceKind,locator:v.typeFilterLocator,citationText:v.typeFilterCitationText}),[v.typeFilterDoi,v.typeFilterLanguage,v.typeFilterLanguageA,v.typeFilterLanguageB,v.typeFilterLocator,v.typeFilterOriginalLanguage,v.typeFilterCitationText,v.typeFilterSourceKind]),bt=a.useMemo(()=>Ee.filterFields.map(c=>({...c,label:c.labelKey?lt[c.labelKey]:c.label??c.key,options:Fi(c,{languages:q})})),[lt,q,Ee.filterFields]),It=a.useMemo(()=>bt.some(c=>(B[c.key]??"").trim().length>0),[bt,B]);a.useEffect(()=>{ee({})},[w]),a.useEffect(()=>{const c={sourceKind:"info"};if(It)for(const at of bt){const ct=(B[at.key]??"").trim();ct&&(c[at.path??at.key]=ct)}const pe=(B.__referenceId??"").trim();pe&&(c["link.references"]=pe),K("loading");const Se=window.setTimeout(()=>{fn({libraryId:o,type:w==="any"?void 0:w,query:D.trim()||void 0,filters:c,limit:Oi}).then(at=>{const ct=at.map(Ct=>({infoId:Ct.infoId??"",infoType:Ct.entityType,label:Ct.title})).filter(Ct=>Ct.infoId.length>0);he(ct),K("ready")}).catch(()=>{he([]),K("ready")})},240);return()=>window.clearTimeout(Se)},[It,o,D,w,bt,B]),a.useEffect(()=>{if(!Oe||st!=="overview"&&st!=="collections"){Ke(null),Ie(null),He("idle");return}let c=!1;return He("loading"),Promise.all([aa({libraryId:o,infoId:Oe}),Qs({libraryId:o,itemType:"info",itemId:Oe}).catch(()=>null)]).then(([pe,Se])=>{c||(Ke(pe),Ie(Se),He("ready"))}).catch(()=>{c||(Ke(null),Ie(null),He("error"))}),()=>{c=!0}},[o,Oe,st]),a.useEffect(()=>{if(!Oe||st!=="collections"){U([]),H("idle");return}let c=!1;return H("loading"),Xs({libraryId:o,infoId:Oe}).then(pe=>{c||(U(pe),H("ready"))}).catch(()=>{c||(U([]),H("error"))}),()=>{c=!0}},[o,Oe,st]),a.useEffect(()=>{if(!Oe||st!=="overview"){We(null),A(null),ne("idle");return}let c=!1;return ne("loading"),Promise.all([Ua({libraryId:o,infoId:Oe}),qa({libraryId:o,infoId:Oe})]).then(([pe,Se])=>{c||(We(pe),A(Se),ne("ready"))}).catch(()=>{c||(We(null),A(null),ne("error"))}),()=>{c=!0}},[o,Oe,st]);const yt=a.useMemo(()=>xe?rt.filter(c=>c.sourceInfoTypes.some(pe=>pe.toLowerCase()===xe.infoType.toLowerCase())):[],[rt,xe]);a.useEffect(()=>{if(!xe){ke("");return}ke(c=>{var pe;return c&&yt.some(Se=>Se.approachKey===c)?c:((pe=yt[0])==null?void 0:pe.approachKey)??""})},[yt,xe]),a.useEffect(()=>{if(!xe||!ze){Re(null),_("idle");return}let c=!1;return _("loading"),Is({libraryId:o,infoId:xe.infoId,approachKey:ze}).then(pe=>{c||(Re(pe),_("ready"))}).catch(()=>{c||(Re(null),_("error"))}),()=>{c=!0}},[o,ze,xe]);const St=a.useMemo(()=>{const c=I.slice(),pe=Se=>Ze(t,Se);return h==="relevance"?c:h==="label_asc"?c.sort((Se,at)=>Se.label.localeCompare(at.label)):h==="label_desc"?c.sort((Se,at)=>at.label.localeCompare(Se.label)):h==="type_asc"?c.sort((Se,at)=>Se.infoType===at.infoType?Se.label.localeCompare(at.label):pe(Se.infoType).localeCompare(pe(at.infoType))):c.sort((Se,at)=>Se.infoType===at.infoType?Se.label.localeCompare(at.label):pe(at.infoType).localeCompare(pe(Se.infoType)))},[t,I,h]),xt=a.useMemo(()=>St.slice(0,le),[St,le]),sa=xt.length<St.length,mt=a.useMemo(()=>new Set(Object.keys(C)),[C]),At=a.useMemo(()=>Object.values(C),[C]),tt=a.useMemo(()=>{const c=new Map;for(const pe of At)c.set(pe.infoType,(c.get(pe.infoType)??0)+1);return Array.from(c.entries()).sort((pe,Se)=>Se[1]-pe[1]||pe[0].localeCompare(Se[0]))},[At]),Mt=a.useMemo(()=>{if(!Oe||!qe)return 0;const c=new Set;for(const pe of qe.items)pe.childItemType!=="info"||pe.childItemId!==Oe||c.add([pe.parentItemType,pe.parentItemId,pe.parentCheckType??"",pe.parentDirection??""].join("|"));return c.size},[qe,Oe]);a.useEffect(()=>{ve(yn);const c=new Set(I.map(pe=>pe.infoId));Z(pe=>pe&&c.has(pe)?pe:null)},[I]);const Dt=c=>{Le(pe=>({...pe,[c.infoId]:{infoId:c.infoId,infoType:c.infoType,label:c.label}}))},ft=c=>{Le(pe=>{if(!pe[c])return pe;const Se={...pe};return delete Se[c],Se})},et=(c,pe)=>{if(pe){Dt(c);return}ft(c.infoId)},ht=c=>{l(`/cogita/library/${o}/infos/${encodeURIComponent(c)}`,{replace:!0})},Lt=()=>{l(`/cogita/library/${o}/list`,{replace:!0})},Tt=()=>{Oe&&l(`/cogita/library/${o}/edit/${encodeURIComponent(Oe)}`,{replace:!0})},Je=()=>{const c=zi(o,At.map(pe=>pe.infoId));c&&l(`/cogita/library/${o}/revision/run?libraryTarget=revisions&scope=info-selection&seed=${encodeURIComponent(c)}`)},gt=()=>{const c=_i(o,At.map(pe=>pe.infoId));c&&l(`/cogita/library/${o}/collections/new?draft=${encodeURIComponent(c)}&draftType=info-selection`)},kt=At.length===1?((Be=At[0])==null?void 0:Be.infoId)??null:null,Yt=v.selectionCount.replace("{count}",String(At.length)),ia=y==="collection"?"grid":y==="detail"?"wide":P,se=Ji(j),x=_e?Math.max(0,Math.min(100,Math.round((_e.score??0)*100))):0,Me=_e?Hi(_e,se):se.noKnownnessData;return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":ia,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[jt?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:se.kicker}),e.jsx("h2",{className:"cogita-card-title",children:xe?as(xe.payload,xe.infoType,xe.infoId):se.loading}),xe?e.jsxs("p",{className:"cogita-card-subtitle",children:[Ze(t,xe.infoType)," · ",xe.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:Lt,children:se.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:Tt,disabled:!Oe||$e!=="ready",children:v.editInfo})]})]}),$e==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:se.loading})}):$e==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:se.loadError})}):xe?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:se.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[x,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${x}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:Me})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:se.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(_e==null?void 0:_e.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:se.correct.replace("{correct}",String((_e==null?void 0:_e.correctReviews)??0)).replace("{total}",String((_e==null?void 0:_e.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:_e!=null&&_e.lastReviewedUtc?`${se.lastReview}: ${qi(_e.lastReviewedUtc,j)}`:se.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:se.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:Mt}),e.jsx("p",{className:"cogita-library-hint",children:se.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:se.checkcards}),Y==="loading"?e.jsx("p",{className:"cogita-library-hint",children:se.loadingCheckcards}):Y==="error"?e.jsx("p",{className:"cogita-library-hint",children:se.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:se.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(fe==null?void 0:fe.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:se.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(R==null?void 0:R.items.length)??0})]})]})]}),yt.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:se.approach}),e.jsx("select",{value:ze,onChange:c=>ke(c.target.value),"aria-label":se.approach,children:yt.map(c=>e.jsx("option",{value:c.approachKey,children:c.label},c.approachKey))})]}),re==="loading"?e.jsx("p",{className:"cogita-library-hint",children:se.loadingApproach}):re==="error"?e.jsx("p",{className:"cogita-library-hint",children:se.loadApproachError}):J?e.jsx(Ha,{value:J.projection,emptyLabel:se.empty}):e.jsx("p",{className:"cogita-library-hint",children:se.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:se.payload}),e.jsx(Ha,{value:xe.payload,emptyLabel:se.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:se.links}),e.jsx(Wi,{links:xe.links,emptyLabel:se.noLinks})]})]})]}):null]})}):null,Xe?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Informacja"}),e.jsx("h2",{className:"cogita-card-title",children:xe?as(xe.payload,xe.infoType,xe.infoId):Oe??""}),e.jsx("p",{className:"cogita-card-subtitle",children:"Collections using this info"})]}),e.jsx("div",{className:"cogita-info-overview-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:Lt,children:"Back to search"})})]}),$==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading collections..."})}):null,$==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load collections."})}):null,$==="ready"&&S.length===0?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"This info is not used in any collection yet."})}):null,$==="ready"&&S.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:S.map(c=>e.jsx("article",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`/#/cogita/library/${o}/collections/${c.collectionId}?libraryTarget=collections`,children:[e.jsx("div",{className:"cogita-card-type",children:"Collection"}),e.jsx("h3",{className:"cogita-card-title",children:c.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[c.itemCount," items"]})]})},c.collectionId))}):null]})}):null,!jt&&!Xe?e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":v.typeLabel,value:w,onChange:c=>T(c.target.value),children:te.map(c=>e.jsx("option",{value:c.value,children:c.label},c.value))}),e.jsx("input",{type:"text",value:D,onChange:c=>p(c.target.value),placeholder:v.searchPlaceholder}),e.jsx("select",{"aria-label":v.sortLabel,value:h,onChange:c=>ce(c.target.value),children:Ne.map(c=>e.jsx("option",{value:c.value,children:c.label},c.value))}),e.jsxs("select",{"aria-label":v.viewLabel,value:P,onChange:c=>f(c.target.value),children:[e.jsx("option",{value:"details",children:v.viewDetails}),e.jsx("option",{value:"wide",children:v.viewWide}),e.jsx("option",{value:"grid",children:v.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:v.cardCount.replace("{shown}",String(xt.length)).replace("{total}",String(St.length))}),e.jsx("span",{children:W==="loading"?v.loading:v.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>N(c=>!c),children:V?v.hideFilters:v.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:v.filtersOptionalHint})]}),V?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsxs("div",{className:"cogita-filter-grid",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:v.typeLabel}),e.jsx("select",{value:w,onChange:c=>T(c.target.value),children:te.map(c=>e.jsx("option",{value:c.value,children:c.label},`advanced-type:${c.value}`))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Reference"}),e.jsxs("select",{value:B.__referenceId??"",onChange:c=>ee(pe=>({...pe,__referenceId:c.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),X.map(c=>e.jsx("option",{value:c.infoId,children:c.label},`reference:${c.infoId}`))]})]}),bt.map(c=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:c.label}),c.kind==="select"?e.jsxs("select",{value:B[c.key]??"",onChange:pe=>ee(Se=>({...Se,[c.key]:pe.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(c.options??[]).map(pe=>e.jsx("option",{value:pe.value,children:pe.label},`${c.key}:${pe.value}`))]}):e.jsx("input",{type:"text",value:B[c.key]??"",onChange:pe=>ee(Se=>({...Se,[c.key]:pe.target.value}))})]},`type-filter:${c.key}`))]})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:Yt}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{Le(c=>{const pe={...c};for(const Se of xt)pe[Se.infoId]={infoId:Se.infoId,infoType:Se.infoType,label:Se.label};return pe})},disabled:xt.length===0,children:v.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Le({}),disabled:At.length===0,children:v.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>kt&&ht(kt),disabled:!kt,title:kt?void 0:v.openSelectedDisabled,children:v.openSelected})]})]}),ia==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":v.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:v.detailColumnName}),e.jsx("span",{children:v.detailColumnType}),e.jsx("span",{children:v.detailColumnId}),e.jsx("span",{})]}),xt.length?xt.map(c=>{const pe=Ze(t,c.infoType),Se=mt.has(c.infoId),at=Ce===c.infoId;return e.jsxs("div",{className:`cogita-details-row ${at||Se?"active":""}`,role:"row",onClick:()=>Z(c.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:Se,onChange:ct=>et(c,ct.target.checked),onClick:ct=>ct.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:c.label,children:c.label}),e.jsx("span",{title:pe,children:pe}),e.jsx("span",{title:c.infoId,children:c.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:ct=>{ct.stopPropagation(),ht(c.infoId)},"aria-label":v.editInfo,children:">"})]},c.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:v.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${ia}`,"data-view":ia,children:xt.length?xt.map(c=>{const pe=Ze(t,c.infoType),Se=mt.has(c.infoId),at=Ce===c.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":at||Se,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:Se,onChange:ct=>et(c,ct.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>Z(c.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:pe}),e.jsx("h3",{className:"cogita-card-title",children:c.label}),e.jsx("p",{className:"cogita-card-subtitle",children:c.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>ht(c.infoId),children:v.editInfo})]})},c.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:v.noMatch})})}),sa?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>ve(c=>c+yn),children:v.loadMore})}):null,At.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:v.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:v.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:tt.map(([c,pe])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:Ze(t,c)}),e.jsx("span",{className:"cogita-tag-count",children:pe})]},`stack:type:${c}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:Je,disabled:At.length===0,children:"Start revision"}),e.jsx("button",{type:"button",className:"ghost",onClick:gt,disabled:At.length===0,children:"Create collection from selection"})]})]}):null]}):null]})})})})}function as(t,n,s){if(t&&typeof t=="object"&&!Array.isArray(t)){const i=t,r=["title","name","label","value","text","quote","term"];for(const g of r){const m=i[g];if(typeof m=="string"&&m.trim())return m.trim()}}return`${n} · ${s}`}function qi(t,n){try{const s=n==="pl"?"pl-PL":n==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(s,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function Ji(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function Hi(t,n){return t.totalReviews<=0?n.noKnownnessData:t.totalReviews<3||t.score<.35?n.developmentStart:t.totalReviews<8||t.score<.65?n.developmentGrowing:t.score<.85?n.developmentStable:n.developmentStrong}function Wi({links:t,emptyLabel:n}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([s,i])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(i)?i.length?e.jsx("div",{className:"cogita-selection-overview",children:i.map(r=>e.jsx("span",{className:"cogita-tag-chip",children:r},`${s}:${r}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):i?e.jsx("span",{className:"cogita-tag-chip",children:i}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},s))})}function Ha({value:t,emptyLabel:n}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:n});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((s,i)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:i+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(Ha,{value:s,emptyLabel:n})})]},i))});if(typeof t=="object"){const s=Object.entries(t);return s.length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:s.map(([i,r])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:i}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(Ha,{value:r,emptyLabel:n})})]},i))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const ba=5,ns=50,ss=2,is=[];function Ut({libraryId:t,infoType:n,label:s,placeholder:i,value:r,onChange:g,values:m,onChangeMultiple:k,helperText:j,searchFailedText:M,createFailedText:o,createLabel:y,savingLabel:l,loadMoreLabel:u,allowCreate:v=!0,inputRef:w,autoAdvance:T,onCommit:D,multiple:p}){const h=p?m??is:is,[ce,P]=a.useState(p?"":(r==null?void 0:r.label)??""),[f,V]=a.useState([]),[N,W]=a.useState(ba),[K,I]=a.useState(-1),[he,le]=a.useState(!1),[ve,Ce]=a.useState(!1),[Z,C]=a.useState(null),Le=a.useRef(0),B=a.useRef(new Map),ee=a.useMemo(()=>v?p?ce.trim().length>0:ce.trim().length>0&&!r:!1,[v,ce,r,p]);a.useEffect(()=>{p||P((r==null?void 0:r.label)??"")},[r,p]),a.useEffect(()=>{const X=ce.trim();if(!X||X.length<ss){V([]),le(!1),W(ba),I(-1),Ce(!1),C(null);return}const de=X.toLowerCase(),xe=`${t}:${n}:${de}`,Ke=B.current.get(xe);if(Ke){if(p&&h.length>0){const Ie=new Set(h.map(qe=>qe.id));V(Ke.filter(qe=>!Ie.has(qe.id)))}else V(Ke);W(ba),I(-1),le(Ke.length>0),Ce(!1),C(null);return}const _e=window.setTimeout(async()=>{const Ie=Date.now();Le.current=Ie,Ce(!0),C(null);try{const qe=await Dn({libraryId:t,type:n,query:X,limit:ns});if(Le.current!==Ie)return;const Qe=qe.slice(0,ns).map($e=>({id:$e.infoId,label:$e.label,infoType:$e.infoType}));if(B.current.set(xe,Qe),p&&h.length>0){const $e=new Set(h.map(He=>He.id));V(Qe.filter(He=>!$e.has(He.id)))}else V(Qe);W(ba),I(-1),le(!0)}catch{if(Le.current!==Ie)return;C(M??"Search failed.")}finally{Le.current===Ie&&Ce(!1)}},250);return()=>window.clearTimeout(_e)},[t,n,ce,h]);const q=X=>{if(p){const de=h.some(xe=>xe.id===X.id)?h:[...h,X];k==null||k(de),P(""),le(!1),I(-1);return}g==null||g(X),P(X.label),le(!1),I(-1),T&&(D==null||D())},ye=async()=>{const X=ce.trim();if(X){Ce(!0),C(null);try{const de=await $n({libraryId:t,infoType:n,payload:{label:X}}),xe={id:de.infoId,label:X,infoType:de.infoType};if(X.length>=ss){const Ke=`${t}:${n}:${X.toLowerCase()}`,_e=B.current.get(Ke)??[];B.current.set(Ke,[xe,..._e])}if(p){k==null||k([...h,xe]),P(""),le(!1),I(-1);return}g==null||g(xe),le(!1),I(-1),T&&(D==null||D())}catch{C(o??"Create failed.")}finally{Ce(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:s}),e.jsx("input",{value:ce,placeholder:i,onChange:X=>{P(X.target.value),!p&&r&&(g==null||g(null))},onKeyDown:X=>{if(X.key==="ArrowDown"){if(X.preventDefault(),!f.length)return;le(!0),I(de=>{const xe=Math.min(f.length,N)-1,Ke=de<0?0:Math.min(de+1,xe);return Ke===xe&&f.length>N?(W(_e=>Math.min(_e+ba,f.length)),Math.min(de+1,Math.min(f.length,N+ba)-1)):Ke});return}if(X.key==="ArrowUp"){if(X.preventDefault(),!f.length)return;le(!0),I(de=>de<=0?0:de-1);return}if(X.key==="Enter"){if(X.preventDefault(),K>=0&&f[K]){q(f[K]);return}if(ee){ye();return}}},onFocus:()=>{f.length>0&&le(!0)},autoComplete:"off",ref:w})]}),p&&h.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:h.map(X=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>k==null?void 0:k(h.filter(de=>de.id!==X.id)),children:[X.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},X.id))}),j&&e.jsx("p",{className:"cogita-help",children:j}),Z&&e.jsx("p",{className:"cogita-error",children:Z}),he&&f.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[f.slice(0,N).map((X,de)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":de===K,onClick:()=>q(X),children:[e.jsx("strong",{children:X.label}),e.jsx("span",{children:X.infoType})]},X.id)),N<f.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>W(X=>Math.min(X+ba,f.length)),children:u??"Load more"})]}),ee&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:ye,disabled:ve,children:ve?l??"Saving...":y??`Create new ${n}`})]})}const rs=[{id:"gen",la:{abbr:"Gen",name:"Genesis"},en:{abbr:"Gen",name:"Genesis"},de:{abbr:"Gen",name:"Genesis"},pl:{abbr:"Rdz",name:"Księga Rodzaju"}},{id:"ex",la:{abbr:"Ex",name:"Exodus"},en:{abbr:"Ex",name:"Exodus"},de:{abbr:"Ex",name:"Exodus"},pl:{abbr:"Wj",name:"Księga Wyjścia"}},{id:"lev",la:{abbr:"Lev",name:"Leviticus"},en:{abbr:"Lev",name:"Leviticus"},de:{abbr:"Lev",name:"Levitikus"},pl:{abbr:"Kpł",name:"Księga Kapłańska"}},{id:"num",la:{abbr:"Num",name:"Numeri"},en:{abbr:"Num",name:"Numbers"},de:{abbr:"Num",name:"Numeri"},pl:{abbr:"Lb",name:"Księga Liczb"}},{id:"deut",la:{abbr:"Deut",name:"Deuteronomium"},en:{abbr:"Deut",name:"Deuteronomy"},de:{abbr:"Dtn",name:"Deuteronomium"},pl:{abbr:"Pwt",name:"Księga Powtórzonego Prawa"}},{id:"ios",la:{abbr:"Ios",name:"Iosue"},en:{abbr:"Josh",name:"Joshua"},de:{abbr:"Jos",name:"Josua"},pl:{abbr:"Joz",name:"Księga Jozuego"}},{id:"iudg",la:{abbr:"Iudg",name:"Iudicum"},en:{abbr:"Judg",name:"Judges"},de:{abbr:"Ri",name:"Richter"},pl:{abbr:"Sdz",name:"Księga Sędziów"}},{id:"ruth",la:{abbr:"Ruth",name:"Ruth"},en:{abbr:"Ruth",name:"Ruth"},de:{abbr:"Rut",name:"Rut"},pl:{abbr:"Rt",name:"Księga Rut"}},{id:"1sam",la:{abbr:"1 Sam",name:"I Samuelis"},en:{abbr:"1 Sam",name:"1 Samuel"},de:{abbr:"1 Sam",name:"1 Samuel"},pl:{abbr:"1 Sm",name:"1 Księga Samuela"}},{id:"2sam",la:{abbr:"2 Sam",name:"II Samuelis"},en:{abbr:"2 Sam",name:"2 Samuel"},de:{abbr:"2 Sam",name:"2 Samuel"},pl:{abbr:"2 Sm",name:"2 Księga Samuela"}},{id:"1reg",la:{abbr:"1 Reg",name:"I Regum"},en:{abbr:"1 Kgs",name:"1 Kings"},de:{abbr:"1 Kön",name:"1 Könige"},pl:{abbr:"1 Krl",name:"1 Księga Królewska"}},{id:"2reg",la:{abbr:"2 Reg",name:"II Regum"},en:{abbr:"2 Kgs",name:"2 Kings"},de:{abbr:"2 Kön",name:"2 Könige"},pl:{abbr:"2 Krl",name:"2 Księga Królewska"}},{id:"1par",la:{abbr:"1 Par",name:"I Paralipomenon"},en:{abbr:"1 Chr",name:"1 Chronicles"},de:{abbr:"1 Chr",name:"1 Chronik"},pl:{abbr:"1 Krn",name:"1 Księga Kronik"}},{id:"2par",la:{abbr:"2 Par",name:"II Paralipomenon"},en:{abbr:"2 Chr",name:"2 Chronicles"},de:{abbr:"2 Chr",name:"2 Chronik"},pl:{abbr:"2 Krn",name:"2 Księga Kronik"}},{id:"esd",la:{abbr:"Esd",name:"Esdrae"},en:{abbr:"Ezra",name:"Ezra"},de:{abbr:"Esra",name:"Esra"},pl:{abbr:"Ezd",name:"Księga Ezdrasza"}},{id:"neh",la:{abbr:"Neh",name:"Nehemiae"},en:{abbr:"Neh",name:"Nehemiah"},de:{abbr:"Neh",name:"Nehemia"},pl:{abbr:"Ne",name:"Księga Nehemiasza"}},{id:"tob",la:{abbr:"Tob",name:"Tobiae"},en:{abbr:"Tob",name:"Tobit"},de:{abbr:"Tob",name:"Tobit"},pl:{abbr:"Tb",name:"Księga Tobiasza"}},{id:"iudt",la:{abbr:"Iudt",name:"Iudith"},en:{abbr:"Jdt",name:"Judith"},de:{abbr:"Jdt",name:"Judit"},pl:{abbr:"Jdt",name:"Księga Judyty"}},{id:"est",la:{abbr:"Est",name:"Esther"},en:{abbr:"Est",name:"Esther"},de:{abbr:"Est",name:"Ester"},pl:{abbr:"Est",name:"Księga Estery"}},{id:"1macc",la:{abbr:"1 Macc",name:"I Maccabaeorum"},en:{abbr:"1 Mc",name:"1 Maccabees"},de:{abbr:"1 Makk",name:"1 Makkabäer"},pl:{abbr:"1 Mch",name:"1 Księga Machabejska"}},{id:"2macc",la:{abbr:"2 Macc",name:"II Maccabaeorum"},en:{abbr:"2 Mc",name:"2 Maccabees"},de:{abbr:"2 Makk",name:"2 Makkabäer"},pl:{abbr:"2 Mch",name:"2 Księga Machabejska"}},{id:"iob",la:{abbr:"Iob",name:"Iob"},en:{abbr:"Job",name:"Job"},de:{abbr:"Ijob",name:"Ijob"},pl:{abbr:"Hi",name:"Księga Hioba"}},{id:"ps",la:{abbr:"Ps",name:"Psalmi"},en:{abbr:"Ps",name:"Psalms"},de:{abbr:"Ps",name:"Psalmen"},pl:{abbr:"Ps",name:"Księga Psalmów"}},{id:"prov",la:{abbr:"Prov",name:"Proverbia"},en:{abbr:"Prov",name:"Proverbs"},de:{abbr:"Spr",name:"Sprichwörter"},pl:{abbr:"Prz",name:"Księga Przysłów"}},{id:"ecc",la:{abbr:"Ecc",name:"Ecclesiastes"},en:{abbr:"Eccl",name:"Ecclesiastes"},de:{abbr:"Koh",name:"Kohelet"},pl:{abbr:"Koh",name:"Księga Koheleta"}},{id:"cant",la:{abbr:"Cant",name:"Canticum Canticorum"},en:{abbr:"Song",name:"Song of Songs"},de:{abbr:"Hld",name:"Hoheslied"},pl:{abbr:"Pnp",name:"Pieśń nad Pieśniami"}},{id:"sap",la:{abbr:"Sap",name:"Sapientia"},en:{abbr:"Wis",name:"Wisdom"},de:{abbr:"Weish",name:"Weisheit"},pl:{abbr:"Mdr",name:"Księga Mądrości"}},{id:"sir",la:{abbr:"Sir",name:"Ecclesiasticus (Sirach)"},en:{abbr:"Sir",name:"Sirach"},de:{abbr:"Sir",name:"Jesus Sirach"},pl:{abbr:"Syr",name:"Mądrość Syracha"}},{id:"isa",la:{abbr:"Isa",name:"Isaias"},en:{abbr:"Isa",name:"Isaiah"},de:{abbr:"Jes",name:"Jesaja"},pl:{abbr:"Iz",name:"Księga Izajasza"}},{id:"ier",la:{abbr:"Ier",name:"Ieremias"},en:{abbr:"Jer",name:"Jeremiah"},de:{abbr:"Jer",name:"Jeremia"},pl:{abbr:"Jr",name:"Księga Jeremiasza"}},{id:"lam",la:{abbr:"Lam",name:"Lamentationes"},en:{abbr:"Lam",name:"Lamentations"},de:{abbr:"Klgl",name:"Klagelieder"},pl:{abbr:"Lm",name:"Lamentacje"}},{id:"bar",la:{abbr:"Bar",name:"Baruch"},en:{abbr:"Bar",name:"Baruch"},de:{abbr:"Bar",name:"Baruch"},pl:{abbr:"Ba",name:"Księga Barucha"}},{id:"ez",la:{abbr:"Ez",name:"Ezechiel"},en:{abbr:"Ezek",name:"Ezekiel"},de:{abbr:"Ez",name:"Ezechiel"},pl:{abbr:"Ez",name:"Księga Ezechiela"}},{id:"dan",la:{abbr:"Dan",name:"Daniel"},en:{abbr:"Dan",name:"Daniel"},de:{abbr:"Dan",name:"Daniel"},pl:{abbr:"Dn",name:"Księga Daniela"}},{id:"hos",la:{abbr:"Hos",name:"Osee"},en:{abbr:"Hos",name:"Hosea"},de:{abbr:"Hos",name:"Hosea"},pl:{abbr:"Oz",name:"Księga Ozeasza"}},{id:"ioel",la:{abbr:"Ioel",name:"Ioel"},en:{abbr:"Joel",name:"Joel"},de:{abbr:"Joel",name:"Joel"},pl:{abbr:"Jl",name:"Księga Joela"}},{id:"amos",la:{abbr:"Amos",name:"Amos"},en:{abbr:"Am",name:"Amos"},de:{abbr:"Am",name:"Amos"},pl:{abbr:"Am",name:"Księga Amosa"}},{id:"abd",la:{abbr:"Abd",name:"Abdias"},en:{abbr:"Obad",name:"Obadiah"},de:{abbr:"Obd",name:"Obadja"},pl:{abbr:"Abd",name:"Księga Abdiasza"}},{id:"ion",la:{abbr:"Ion",name:"Ionas"},en:{abbr:"Jon",name:"Jonah"},de:{abbr:"Jona",name:"Jona"},pl:{abbr:"Jon",name:"Księga Jonasza"}},{id:"mich",la:{abbr:"Mich",name:"Michaeas"},en:{abbr:"Mic",name:"Micah"},de:{abbr:"Mi",name:"Micha"},pl:{abbr:"Mi",name:"Księga Micheasza"}},{id:"nah",la:{abbr:"Nah",name:"Nahum"},en:{abbr:"Nah",name:"Nahum"},de:{abbr:"Nah",name:"Nahum"},pl:{abbr:"Na",name:"Księga Nahuma"}},{id:"hab",la:{abbr:"Hab",name:"Habacuc"},en:{abbr:"Hab",name:"Habakkuk"},de:{abbr:"Hab",name:"Habakuk"},pl:{abbr:"Ha",name:"Księga Habakuka"}},{id:"soph",la:{abbr:"Soph",name:"Sophonias"},en:{abbr:"Zeph",name:"Zephaniah"},de:{abbr:"Zef",name:"Zefanja"},pl:{abbr:"So",name:"Księga Sofoniasza"}},{id:"agg",la:{abbr:"Agg",name:"Aggaeus"},en:{abbr:"Hag",name:"Haggai"},de:{abbr:"Hag",name:"Haggai"},pl:{abbr:"Ag",name:"Księga Aggeusza"}},{id:"zach",la:{abbr:"Zach",name:"Zacharias"},en:{abbr:"Zech",name:"Zechariah"},de:{abbr:"Sach",name:"Sacharja"},pl:{abbr:"Za",name:"Księga Zachariasza"}},{id:"mal",la:{abbr:"Mal",name:"Malachias"},en:{abbr:"Mal",name:"Malachi"},de:{abbr:"Mal",name:"Maleachi"},pl:{abbr:"Ml",name:"Księga Malachiasza"}},{id:"mt",la:{abbr:"Mt",name:"Matthaeus"},en:{abbr:"Matt",name:"Matthew"},de:{abbr:"Mt",name:"Matthäus"},pl:{abbr:"Mt",name:"Ewangelia wg św. Mateusza"}},{id:"mc",la:{abbr:"Mc",name:"Marcus"},en:{abbr:"Mark",name:"Mark"},de:{abbr:"Mk",name:"Markus"},pl:{abbr:"Mk",name:"Ewangelia wg św. Marka"}},{id:"lc",la:{abbr:"Lc",name:"Lucas"},en:{abbr:"Luke",name:"Luke"},de:{abbr:"Lk",name:"Lukas"},pl:{abbr:"Łk",name:"Ewangelia wg św. Łukasza"}},{id:"io",la:{abbr:"Io",name:"Ioannes"},en:{abbr:"John",name:"John"},de:{abbr:"Joh",name:"Johannes"},pl:{abbr:"J",name:"Ewangelia wg św. Jana"}},{id:"act",la:{abbr:"Act",name:"Actus Apostolorum"},en:{abbr:"Acts",name:"Acts"},de:{abbr:"Apg",name:"Apostelgeschichte"},pl:{abbr:"Dz",name:"Dzieje Apostolskie"}},{id:"rom",la:{abbr:"Rom",name:"ad Romanos"},en:{abbr:"Rom",name:"Romans"},de:{abbr:"Röm",name:"Römer"},pl:{abbr:"Rz",name:"List do Rzymian"}},{id:"1cor",la:{abbr:"1 Cor",name:"I ad Corinthios"},en:{abbr:"1 Cor",name:"1 Corinthians"},de:{abbr:"1 Kor",name:"1 Korinther"},pl:{abbr:"1 Kor",name:"1 List do Koryntian"}},{id:"2cor",la:{abbr:"2 Cor",name:"II ad Corinthios"},en:{abbr:"2 Cor",name:"2 Corinthians"},de:{abbr:"2 Kor",name:"2 Korinther"},pl:{abbr:"2 Kor",name:"2 List do Koryntian"}},{id:"gal",la:{abbr:"Gal",name:"ad Galatas"},en:{abbr:"Gal",name:"Galatians"},de:{abbr:"Gal",name:"Galater"},pl:{abbr:"Ga",name:"List do Galatów"}},{id:"eph",la:{abbr:"Eph",name:"ad Ephesios"},en:{abbr:"Eph",name:"Ephesians"},de:{abbr:"Eph",name:"Epheser"},pl:{abbr:"Ef",name:"List do Efezjan"}},{id:"phil",la:{abbr:"Phil",name:"ad Philippenses"},en:{abbr:"Phil",name:"Philippians"},de:{abbr:"Phil",name:"Philipper"},pl:{abbr:"Flp",name:"List do Filipian"}},{id:"col",la:{abbr:"Col",name:"ad Colossenses"},en:{abbr:"Col",name:"Colossians"},de:{abbr:"Kol",name:"Kolosser"},pl:{abbr:"Kol",name:"List do Kolosan"}},{id:"1thess",la:{abbr:"1 Thess",name:"I ad Thessalonicenses"},en:{abbr:"1 Thess",name:"1 Thessalonians"},de:{abbr:"1 Thess",name:"1 Thessalonicher"},pl:{abbr:"1 Tes",name:"1 List do Tesaloniczan"}},{id:"2thess",la:{abbr:"2 Thess",name:"II ad Thessalonicenses"},en:{abbr:"2 Thess",name:"2 Thessalonians"},de:{abbr:"2 Thess",name:"2 Thessalonicher"},pl:{abbr:"2 Tes",name:"2 List do Tesaloniczan"}},{id:"1tim",la:{abbr:"1 Tim",name:"I ad Timotheum"},en:{abbr:"1 Tim",name:"1 Timothy"},de:{abbr:"1 Tim",name:"1 Timotheus"},pl:{abbr:"1 Tm",name:"1 List do Tymoteusza"}},{id:"2tim",la:{abbr:"2 Tim",name:"II ad Timotheum"},en:{abbr:"2 Tim",name:"2 Timothy"},de:{abbr:"2 Tim",name:"2 Timotheus"},pl:{abbr:"2 Tm",name:"2 List do Tymoteusza"}},{id:"tit",la:{abbr:"Tit",name:"ad Titum"},en:{abbr:"Titus",name:"Titus"},de:{abbr:"Tit",name:"Titus"},pl:{abbr:"Tt",name:"List do Tytusa"}},{id:"phlm",la:{abbr:"Phlm",name:"ad Philemonem"},en:{abbr:"Phlm",name:"Philemon"},de:{abbr:"Phlm",name:"Philemon"},pl:{abbr:"Flm",name:"List do Filemona"}},{id:"heb",la:{abbr:"Heb",name:"ad Hebraeos"},en:{abbr:"Heb",name:"Hebrews"},de:{abbr:"Hebr",name:"Hebräer"},pl:{abbr:"Hbr",name:"List do Hebrajczyków"}},{id:"iac",la:{abbr:"Iac",name:"Iacobi"},en:{abbr:"Jas",name:"James"},de:{abbr:"Jak",name:"Jakobus"},pl:{abbr:"Jk",name:"List św. Jakuba"}},{id:"1pet",la:{abbr:"1 Pet",name:"I Petri"},en:{abbr:"1 Pet",name:"1 Peter"},de:{abbr:"1 Petr",name:"1 Petrus"},pl:{abbr:"1 P",name:"1 List św. Piotra"}},{id:"2pet",la:{abbr:"2 Pet",name:"II Petri"},en:{abbr:"2 Pet",name:"2 Peter"},de:{abbr:"2 Petr",name:"2 Petrus"},pl:{abbr:"2 P",name:"2 List św. Piotra"}},{id:"1io",la:{abbr:"1 Io",name:"I Ioannis"},en:{abbr:"1 John",name:"1 John"},de:{abbr:"1 Joh",name:"1 Johannes"},pl:{abbr:"1 J",name:"1 List św. Jana"}},{id:"2io",la:{abbr:"2 Io",name:"II Ioannis"},en:{abbr:"2 John",name:"2 John"},de:{abbr:"2 Joh",name:"2 Johannes"},pl:{abbr:"2 J",name:"2 List św. Jana"}},{id:"3io",la:{abbr:"3 Io",name:"III Ioannis"},en:{abbr:"3 John",name:"3 John"},de:{abbr:"3 Joh",name:"3 Johannes"},pl:{abbr:"3 J",name:"3 List św. Jana"}},{id:"iud",la:{abbr:"Iud",name:"Iudae"},en:{abbr:"Jude",name:"Jude"},de:{abbr:"Jud",name:"Judas"},pl:{abbr:"Jud",name:"List św. Judy"}},{id:"apoc",la:{abbr:"Apoc",name:"Apocalypsis Ioannis"},en:{abbr:"Rev",name:"Revelation"},de:{abbr:"Offb",name:"Offenbarung"},pl:{abbr:"Ap",name:"Apokalipsa św. Jana"}}],os=8;function ls({libraryId:t,copy:n,language:s,sourceKindOptions:i,value:r,onChange:g,labels:m}){const[k,j]=a.useState(!1),[M,o]=a.useState(-1),y=a.useMemo(()=>{const w=s;return rs.map(T=>{var h;const D=(T==null?void 0:T[w])??(T==null?void 0:T.en)??(T==null?void 0:T.la);return{label:`${D.abbr} — ${D.name}`,latin:((h=T==null?void 0:T.la)==null?void 0:h.abbr)??D.abbr}})},[s]),l=(w,T=!1)=>{const D=w.trim().toLowerCase();return D?y.filter(p=>p.label.toLowerCase().includes(D)).slice(0,os):T?y.slice(0,os):[]},u=(w,T)=>{const D=w.trim().toLowerCase();if(!D)return null;const p=rs;for(const h of p){const ce=h==null?void 0:h.la,P=(h==null?void 0:h[T])??(h==null?void 0:h.en)??ce,f=(P==null?void 0:P.abbr)??"",V=(P==null?void 0:P.name)??"";if(f.toLowerCase()===D||V.toLowerCase()===D||`${f} — ${V}`.toLowerCase()===D)return{book:h,entry:P,la:ce}}return null};a.useEffect(()=>{if(r.sourceKind==="bible"&&r.locatorValue&&!k){const w=u(r.locatorValue,s);if(w){const T=`${w.entry.abbr} — ${w.entry.name}`;T!==r.bibleBookDisplay&&g({...r,bibleBookDisplay:T})}}},[s,r,k,g]);const v=w=>g({...r,...w});return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:m.sourceKindLabel}),e.jsx("select",{value:r.sourceKind,onChange:w=>v({sourceKind:w.target.value,churchDocument:null,bookMedia:null,work:null,locatorValue:"",locatorAux:"",bibleBookDisplay:""}),children:i.map(w=>e.jsx("option",{value:w.value,children:w.label},w.value))})]}),r.sourceKind==="bible"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-lookup full",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:m.bibleBookLabel}),e.jsx("input",{type:"text",value:r.bibleBookDisplay,onChange:w=>{const T=w.target.value;v({bibleBookDisplay:T,locatorValue:""}),j(!0),o(-1)},onKeyDown:w=>{var D;const T=l(r.bibleBookDisplay);if(T.length){if(w.key==="ArrowDown")w.preventDefault(),o(p=>Math.min(p+1,T.length-1));else if(w.key==="ArrowUp")w.preventDefault(),o(p=>Math.max(p-1,0));else if((w.key==="Enter"||w.key==="Tab")&&M>=0&&T[M]){const p=T[M],h=u(p.label,s);if(!h)return;v({bibleBookDisplay:p.label,locatorValue:((D=h.la)==null?void 0:D.abbr)??r.locatorValue}),j(!1)}}},onFocus:()=>j(!0),onBlur:()=>window.setTimeout(()=>j(!1),100),placeholder:m.bibleBookPlaceholder})]}),k&&l(r.bibleBookDisplay,!0).length>0&&e.jsx("div",{className:"cogita-lookup-results",children:l(r.bibleBookDisplay,!0).map((w,T)=>e.jsx("button",{type:"button",className:"cogita-lookup-option","data-active":T===M,tabIndex:-1,onMouseDown:()=>{var p;const D=u(w.label,s);D&&v({bibleBookDisplay:w.label,locatorValue:((p=D.la)==null?void 0:p.abbr)??r.locatorValue})},children:e.jsx("strong",{children:w.label})},w.latin))})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:m.bibleRestLabel}),e.jsx("input",{type:"text",value:r.locatorAux,onChange:w=>v({locatorAux:w.target.value}),placeholder:m.bibleRestPlaceholder})]})]}),r.sourceKind==="website"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceUrlLabel}),e.jsx("input",{type:"text",value:r.sourceUrl,onChange:w=>v({sourceUrl:w.target.value}),placeholder:n.cogita.library.add.info.sourceUrlPlaceholder})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceAccessedDateLabel}),e.jsx("input",{type:"text",value:r.sourceAccessedDate,onChange:w=>v({sourceAccessedDate:w.target.value}),placeholder:n.cogita.library.add.info.sourceAccessedDatePlaceholder})]})]}),r.sourceKind==="number_document"&&e.jsxs(e.Fragment,{children:[e.jsx(Ut,{libraryId:t,infoType:"work",label:m.churchDocumentLabel,placeholder:m.churchDocumentPlaceholder,value:r.churchDocument,onChange:w=>v({churchDocument:w}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:m.locatorLabel}),e.jsx("input",{type:"text",value:r.locatorValue,onChange:w=>v({locatorValue:w.target.value}),placeholder:m.locatorPlaceholder})]})]}),r.sourceKind==="work"&&e.jsx(Ut,{libraryId:t,infoType:"work",label:m.workLabel,placeholder:m.workPlaceholder,value:r.work,onChange:w=>v({work:w}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),r.sourceKind==="book"&&e.jsxs(e.Fragment,{children:[e.jsx(Ut,{libraryId:t,infoType:"media",label:m.bookLabel,placeholder:m.bookPlaceholder,value:r.bookMedia,onChange:w=>v({bookMedia:w}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.media),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:m.locatorLabel}),e.jsx("input",{type:"text",value:r.locatorValue,onChange:w=>v({locatorValue:w.target.value}),placeholder:m.locatorPlaceholder})]})]}),r.sourceKind!=="website"&&r.sourceKind!=="bible"&&r.sourceKind!=="book"&&r.sourceKind!=="number_document"&&e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:m.locatorLabel}),e.jsx("input",{type:"text",value:r.locatorValue,onChange:w=>v({locatorValue:w.target.value}),placeholder:m.locatorPlaceholder})]})]})}const cs=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}];function $a(){return{sourceKind:"string",locatorValue:"",locatorAux:"",bibleBookDisplay:"",sourceUrl:"",sourceAccessedDate:"",churchDocument:null,bookMedia:null,work:null}}function ds(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function us(t,n){if(!t||typeof t!="object")return n;const s=t,i=[s.label,s.name,s.title,s.text,s.orcid,s.email,s.number];for(const r of i)if(typeof r=="string"&&r.trim())return r.trim();return n}function hs(t,n){var i;if(!(t instanceof Ms))return n;const s=(i=t.message)==null?void 0:i.trim();if(!s)return n;try{const r=JSON.parse(s);if(typeof r.error=="string"&&r.error.trim())return r.error.trim()}catch{}return s}function Gi(t){const n=t.trim();if(!n)return null;try{const s=JSON.parse(n);return s&&typeof s=="object"&&!Array.isArray(s)?s:null}catch{return null}}function Xt(t,n){const s=t==null?void 0:t[n];return typeof s=="string"?s:""}function Yi(t,n){return n?t==="book"&&n.infoType==="media"?{bookMedia:n}:t==="work"&&n.infoType==="work"?{work:n}:t==="number_document"&&n.infoType==="work"?{churchDocument:n}:{}:{}}function Qi(t,n){const s=$a(),i=(t.sourceKind??"").trim()||s.sourceKind,r=t.locator??"",g=Gi(r);let m="",k="",j="",M="",o="";return i==="website"?(M=Xt(g,"url"),o=Xt(g,"accessedDate"),m=Xt(g,"value")):i==="bible"?(m=Xt(g,"book")||r.trim(),k=Xt(g,"passage")||Xt(g,"rest"),j=Xt(g,"bookDisplay")):g?(m=Xt(g,"value")||Xt(g,"locator"),k=Xt(g,"aux")):m=r,{...s,sourceKind:i,locatorValue:m,locatorAux:k,bibleBookDisplay:j,sourceUrl:M,sourceAccessedDate:o,...Yi(i,n)}}function xn(t){return t.sourceKind==="book"?t.bookMedia:t.sourceKind==="work"?t.work:t.sourceKind==="number_document"?t.churchDocument:null}function vn(t){const n=t.locatorValue.trim(),s=t.locatorAux.trim(),i=t.sourceUrl.trim(),r=t.sourceAccessedDate.trim();switch(t.sourceKind){case"website":return{url:i,accessedDate:r};case"bible":return{book:n,bookDisplay:t.bibleBookDisplay.trim(),passage:s};case"book":case"work":case"number_document":return s?{value:n,aux:s}:n;default:return s?{value:n,aux:s}:n}}function gs(t){var r,g,m;const n=t.locatorValue.trim(),s=t.locatorAux.trim(),i=[n,s].filter(Boolean).join(" ");switch(t.sourceKind){case"website":return t.sourceUrl.trim()||"website";case"bible":return i||"bible";case"book":return[(r=t.bookMedia)==null?void 0:r.label,i].filter(Boolean).join(" · ")||"book";case"work":return[(g=t.work)==null?void 0:g.label,i].filter(Boolean).join(" · ")||"work";case"number_document":return[(m=t.churchDocument)==null?void 0:m.label,i].filter(Boolean).join(" · ")||"number_document";default:return i||t.sourceKind||"source"}}function ms(t){return t.sourceKind.trim()?t.sourceKind==="website"?!!t.sourceUrl.trim():t.sourceKind==="bible"?!!(t.locatorValue.trim()&&t.locatorAux.trim()):t.sourceKind==="book"?!!t.bookMedia:t.sourceKind==="work"?!!t.work:t.sourceKind==="number_document"?!!(t.churchDocument&&t.locatorValue.trim()):!!t.locatorValue.trim():!1}function Xi({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o,editInfoId:y}){var ot,ze,ke;const{libraryName:l}=na(o),u=!!y,[v,w]=a.useState([]),[T,D]=a.useState("word"),[p,h]=a.useState({}),[ce,P]=a.useState({}),[f,V]=a.useState({}),[N,W]=a.useState({}),[K,I]=a.useState(null),[he,le]=a.useState("idle"),[ve,Ce]=a.useState($a),[Z,C]=a.useState({}),[Le,B]=a.useState({}),[ee,q]=a.useState({}),[ye,X]=a.useState(null),de=a.useMemo(()=>v.find(J=>J.infoType===T),[T,v]),xe=a.useMemo(()=>v.find(J=>J.infoType==="source"),[v]),Ke=a.useMemo(()=>v.map(J=>({value:J.infoType,label:Ze(t,J.infoType)})),[t,v]);a.useEffect(()=>{let J=!1;return Zs({libraryId:o}).then(Re=>{var re;if(!J&&(w(Re),!u)){const _=(re=Re[0])==null?void 0:re.infoType;_&&D(_)}}).catch(()=>{J||w([])}),()=>{J=!0}},[u,o]),a.useEffect(()=>{if(u||!de)return;const J={},Re={},re={},_={};for(const fe of de.payloadFields)J[fe.key]="";for(const fe of de.linkFields)fe.multiple?re[fe.key]=[]:Re[fe.key]=null,fe.targetTypes.length>0&&(_[fe.key]=fe.targetTypes[0]);h(J),P(Re),V(re),W(_)},[de==null?void 0:de.infoType,u]),a.useEffect(()=>{if(!u||!y||v.length===0)return;let J=!1;return le("loading"),I(null),(async()=>{const re=await aa({libraryId:o,infoId:y});if(J)return;const _=re.infoType;D(_);const fe=v.find($=>$.infoType===_);if(!fe){le("idle");return}const We=re.payload??{},R={};for(const $ of fe.payloadFields)R[$.key]=ds(We[$.key]);h(R);const A=re.links??{}??{},Y={},ne={},S={},U=[];for(const $ of fe.linkFields){$.targetTypes.length>0&&(S[$.key]=$.targetTypes[0]);const H=A[$.key];if($.multiple){const te=Array.isArray(H)?H.filter(Ne=>typeof Ne=="string"):[];ne[$.key]=[];for(const Ne of te)U.push(aa({libraryId:o,infoId:Ne}).then(Ee=>{if(J)return;const Ve={id:Ne,infoType:Ee.infoType,label:us(Ee.payload,Ne)};S[$.key]=Ve.infoType,ne[$.key]=[...ne[$.key],Ve]}).catch(()=>{}))}else{const te=typeof H=="string"?H:null;Y[$.key]=null,te&&U.push(aa({libraryId:o,infoId:te}).then(Ne=>{if(J)return;const Ee={id:te,infoType:Ne.infoType,label:us(Ne.payload,te)};S[$.key]=Ee.infoType,Y[$.key]=Ee}).catch(()=>{}))}}await Promise.all(U),!J&&(P(Y),V(ne),W(S),le("idle"))})().catch(()=>{J||(I("Failed to load info details."),le("idle"))}),()=>{J=!0}},[y,u,o,v]),a.useEffect(()=>{T==="source"&&Ce(Qi(p,ce.resource??null))},[T,p.sourceKind,p.locator,(ot=ce.resource)==null?void 0:ot.id,(ze=ce.resource)==null?void 0:ze.infoType,(ke=ce.resource)==null?void 0:ke.label]);const _e=J=>{var fe,We;const Re=((fe=xe==null?void 0:xe.payloadFields.find(R=>R.key==="sourceKind"))==null?void 0:fe.keepOnCreate)??!1,re=((We=xe==null?void 0:xe.linkFields.find(R=>R.key==="resource"))==null?void 0:We.keepOnCreate)??!1,_=$a();return _.sourceKind=Re?J.sourceKind:_.sourceKind,re&&(_.work=J.work,_.bookMedia=J.bookMedia,_.churchDocument=J.churchDocument),Re&&J.sourceKind==="bible"&&(_.locatorValue=J.locatorValue,_.bibleBookDisplay=J.bibleBookDisplay),Re&&J.sourceKind==="website"&&(_.sourceUrl=J.sourceUrl,_.sourceAccessedDate=J.sourceAccessedDate),_},Ie=a.useMemo(()=>({sourceKindLabel:t.cogita.library.add.info.sourceKindLabel,bibleBookLabel:t.cogita.library.add.info.sourceBibleBookLabel,bibleBookPlaceholder:t.cogita.library.add.info.sourceBibleBookPlaceholder,bibleRestLabel:t.cogita.library.add.info.sourceBibleRestLabel,bibleRestPlaceholder:t.cogita.library.add.info.sourceBibleRestPlaceholder,churchDocumentLabel:t.cogita.library.add.info.sourceResourceLabel,churchDocumentPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,workLabel:t.cogita.library.add.info.sourceResourceLabel,workPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,bookLabel:t.cogita.library.add.info.sourceResourceLabel,bookPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,locatorLabel:t.cogita.library.list.typeFilterLocator,locatorPlaceholder:t.cogita.library.list.typeFilterLocator}),[t]),qe=async J=>{const Re=Le[J]??$a();if(!ms(Re)){q(re=>({...re,[J]:t.cogita.library.add.info.referenceMissingSource}));return}X(J),q(re=>({...re,[J]:null}));try{const re=xn(Re),_=re?{resource:re.id}:{},fe={label:gs(Re),sourceKind:Re.sourceKind.trim(),locator:vn(Re)},R={id:(await $n({libraryId:o,infoType:"source",payload:fe,links:_})).infoId,infoType:"source",label:fe.label};if(V(A=>{const Y=A[J]??[];return Y.some(ne=>ne.id===R.id)?A:{...A,[J]:[...Y,R]}}),u&&y){const A=await aa({libraryId:o,infoId:y}),Y=A.links&&typeof A.links=="object"?{...A.links}:{},ne=Y[J],S=Array.isArray(ne)?ne.filter(U=>typeof U=="string"):typeof ne=="string"?[ne]:[];S.includes(R.id)||(Y[J]=[...S,R.id],await Gn({libraryId:o,infoId:y,payload:A.payload,links:Y}))}B(A=>({...A,[J]:_e(Re)})),q(A=>({...A,[J]:null}))}catch(re){q(_=>({..._,[J]:hs(re,t.cogita.library.lookup.createFailed)}))}finally{X(re=>re===J?null:re)}},Qe=async()=>{var re;if(!de)return;const J={};for(const _ of de.payloadFields){if(T==="source"&&(_.key==="sourceKind"||_.key==="locator"))continue;const fe=(p[_.key]??"").trim();if(!fe){if(_.required){I(`Field '${_.label}' is required.`);return}continue}if(_.inputType==="json")try{J[_.key]=JSON.parse(fe)}catch{I(`Field '${_.label}' must be valid JSON.`);return}else J[_.key]=fe}const Re={};for(const _ of de.linkFields)if(!(T==="source"&&_.key==="resource"))if(_.multiple){const fe=(f[_.key]??[]).map(We=>We.id);if(_.required&&fe.length===0){I(`Link '${_.label}' is required.`);return}fe.length>0&&(Re[_.key]=fe)}else{const fe=((re=ce[_.key])==null?void 0:re.id)??null;if(_.required&&!fe){I(`Link '${_.label}' is required.`);return}fe&&(Re[_.key]=fe)}if(T==="source"){if(!ms(ve)){I(t.cogita.library.add.info.referenceMissingSource);return}const _=ve.sourceKind.trim();J.sourceKind=_,J.locator=vn(ve),(typeof J.label!="string"||!J.label.trim())&&(J.label=gs(ve));const fe=xn(ve);fe&&(Re.resource=fe.id)}le("saving"),I(null);try{if(u&&y)await Gn({libraryId:o,infoId:y,payload:J,links:Re}),I("Info updated.");else{await $n({libraryId:o,infoType:T,payload:J,links:Re}),I("Info saved.");const _={};for(const R of de.payloadFields)_[R.key]=R.keepOnCreate?p[R.key]??"":"";h(_);const fe={},We={};for(const R of de.linkFields)R.multiple?We[R.key]=R.keepOnCreate?f[R.key]??[]:[]:fe[R.key]=R.keepOnCreate?ce[R.key]??null:null;P(R=>({...R,...fe})),V(R=>({...R,...We})),T==="source"&&Ce(R=>{const A=_e(R),Y=xn(A);return h(ne=>({...ne,sourceKind:A.sourceKind,locator:ds(vn(A))})),P(ne=>({...ne,resource:Y})),Y&&W(ne=>({...ne,resource:Y.infoType})),A})}}catch(_){I(hs(_,"Failed to save info."))}finally{le("idle")}},$e=J=>{const Re=p[J.key]??"",re=J.inputType==="textarea"||J.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:J.label}),re?e.jsx("textarea",{rows:J.inputType==="json"?8:4,value:Re,onChange:_=>h(fe=>({...fe,[J.key]:_.target.value})),placeholder:J.key}):e.jsx("input",{type:"text",value:Re,onChange:_=>h(fe=>({...fe,[J.key]:_.target.value})),placeholder:J.key})]},`payload:${J.key}`)},He=J=>{const Re=N[J.key]??J.targetTypes[0],re=J.key==="references"&&J.multiple&&J.targetTypes.includes("source"),_=Le[J.key]??$a(),fe=Z[J.key]??!1,We=ee[J.key];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:J.label}),J.targetTypes.length>1?e.jsx("select",{value:Re,onChange:R=>W(A=>({...A,[J.key]:R.target.value})),children:J.targetTypes.map(R=>e.jsx("option",{value:R,children:Ze(t,R)},`${J.key}:${R}`))}):null,J.multiple?e.jsx(Ut,{libraryId:o,infoType:Re,label:J.label,placeholder:J.key,multiple:!0,values:f[J.key]??[],onChangeMultiple:R=>V(A=>({...A,[J.key]:R})),allowCreate:!re,searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(Ut,{libraryId:o,infoType:Re,label:J.label,placeholder:J.key,value:ce[J.key]??null,onChange:R=>P(A=>({...A,[J.key]:R})),searchFailedText:"Search failed",createFailedText:"Create failed"}),re?e.jsxs("div",{children:[e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:fe,onChange:R=>C(A=>({...A,[J.key]:R.target.checked}))}),e.jsx("span",{children:t.cogita.library.add.info.referenceToggle})]}),fe?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(ls,{libraryId:o,copy:t,language:j,sourceKindOptions:[...cs],value:_,onChange:R=>B(A=>({...A,[J.key]:R})),labels:Ie}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>qe(J.key),disabled:ye===J.key,children:ye===J.key?t.cogita.library.lookup.saving:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.source)})}),We?e.jsx("p",{className:"cogita-library-subtitle",children:We}):null]}):null]}):null]},`link:${J.key}`)},rt=()=>e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(ls,{libraryId:o,copy:t,language:j,sourceKindOptions:[...cs],value:ve,onChange:Ce,labels:Ie})]});return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:u?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${o}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[u?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:T,onChange:J=>D(J.target.value),children:Ke.map(J=>e.jsx("option",{value:J.value,children:J.label},J.value))})]}),he==="loading"&&u?e.jsx("p",{children:"Loading..."}):null,de&&!(he==="loading"&&u)?e.jsxs("div",{className:"cogita-form-grid",children:[de.payloadFields.filter(J=>!(T==="source"&&(J.key==="sourceKind"||J.key==="locator"))).map($e),T==="source"?rt():null,de.linkFields.filter(J=>!(T==="source"&&J.key==="resource")).map(He)]}):he==="loading"&&u?null:e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:Qe,disabled:he==="saving"||!de,children:he==="saving"?"Saving...":u?"Update info":"Create info"})}),K?e.jsx("p",{className:"cogita-library-subtitle",children:K}):null]})})})]})})}const ps=t=>/\s/.test(t),Wa=t=>/[\p{L}\p{N}]/u.test(t),fs=(t,n)=>{const s=n>0?t[n-1]:"",i=n<t.length?t[n]:"";if(!s||!i)return 0;const r=ps(s),g=ps(i);if(r||g)return 3;const m=Wa(s),k=Wa(i);return m!==k?2:!m&&!k?1:0},wn=(t,n,s,i,r)=>{const g=Math.max(i-n,s-i);for(let m=0;m<=g;m+=1){const k=i-m;if(k>=n&&k<=s&&fs(t,k)>=r)return k;const j=i+m;if(j>=n&&j<=s&&fs(t,j)>=r)return j}return null},jn=(t,n)=>{const s=n>0?t[n-1]:"",i=n<t.length?t[n]:"";return!s||!i?!0:Wa(s)!==Wa(i)},Zi=(t,n,s,i)=>{const r=s-n,g=n+i,m=s-i;if(r<=i*2||m<=g)return null;const k=Math.floor((n+s)/2),j=wn(t,g,m,k,3);if(j!==null&&jn(t,j))return j;const M=wn(t,g,m,k,2);if(M!==null&&jn(t,M))return M;const o=wn(t,g,m,k,1);return o!==null&&jn(t,o)?o:null},ya=(t,n)=>{const s=Math.max(1,7),i=Math.max(s,13),r={},g=(j,M,o,y,l)=>{const u=String(y),v={id:u,start:j,end:M,text:t.slice(j,M),depth:o,index:y,parentId:l};if(r[u]=v,M-j>i){let T=Zi(t,j,M,s);if(T!==null&&T>j&&T<M){const D=g(j,T,o+1,y*2+1,u),p=g(T,M,o+1,y*2+2,u);v.leftId=D.id,v.rightId=p.id}}return v},m=g(0,t.length,0,0),k=Object.values(r).sort((j,M)=>M.depth-j.depth||j.start-M.start).map(j=>j.id);return{text:t,rootId:m.id,nodes:r,order:k}},Ta=(t,n,s,i,r,g,m)=>{const k=g==="reverse"?t.order.slice().sort((j,M)=>t.nodes[M].start-t.nodes[j].start||t.nodes[M].depth-t.nodes[j].depth):t.order;for(const j of k){if(m&&j===m||n.has(j))continue;const M=t.nodes[j];if(M){if(r&&(M.leftId||M.rightId)){const o=M.leftId?s[M.leftId]??0:i,y=M.rightId?s[M.rightId]??0:i;if((o+y)/2<i)continue}return M}}return null},zn=(t,n)=>({before:t.slice(0,n.start),fragment:t.slice(n.start,n.end),after:t.slice(n.end)});function er({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o}){const y=`/#/cogita/library/${o}`,[l,u,v]=En([]),[w,T,D]=Pn([]),[p,h]=a.useState(null),[ce,P]=a.useState(null),[f,V]=a.useState(null),[N,W]=a.useState(null),K=a.useMemo(()=>l.find(C=>C.id===p)??null,[l,p]);a.useEffect(()=>{let C=!0;return ei({libraryId:o}).then(Le=>{if(!C)return;const B=Le.nodes.map(ee=>{var q,ye,X;return{id:ee.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:ee.payload&&typeof ee.payload=="object"&&"label"in ee.payload?String(ee.payload.label):"Item",nodeType:ee.nodeType,itemType:((q=ee.payload)==null?void 0:q.itemType)??"info",itemId:((ye=ee.payload)==null?void 0:ye.itemId)??null,infoType:((X=ee.payload)==null?void 0:X.infoType)??null}}});u(B),T(Le.edges.map(ee=>({id:ee.edgeId,source:ee.fromNodeId,target:ee.toNodeId})))}).catch(()=>{C&&(u([]),T([]))}),()=>{C=!1}},[o]),a.useEffect(()=>{ti({libraryId:o}).then(P).catch(()=>P(null))},[o,l,w]);const I=a.useCallback(C=>{T(Le=>Kn(C,Le))},[]),he=()=>{const C=crypto.randomUUID();u(Le=>[...Le,{id:C,type:"default",position:{x:140+Le.length*40,y:120+Le.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},le=()=>{const C=crypto.randomUUID();u(Le=>[...Le,{id:C,type:"default",position:{x:180+Le.length*40,y:160+Le.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},ve=async()=>{V(null);try{const C=l.map(B=>({nodeId:B.id,nodeType:B.data.nodeType,payload:{itemType:B.data.itemType,itemId:B.data.itemId??null,label:B.data.label,infoType:B.data.infoType??null}})),Le=w.map(B=>({edgeId:B.id,fromNodeId:B.source,toNodeId:B.target}));await ai({libraryId:o,nodes:C,edges:Le}),V(t.cogita.library.graph.saveSuccess)}catch{V(t.cogita.library.graph.saveFail)}},Ce=C=>{K&&u(Le=>Le.map(B=>B.id===K.id?{...B,data:{...B.data,itemId:(C==null?void 0:C.infoId)??null,itemType:"collection",infoType:"collection",label:(C==null?void 0:C.label)??t.cogita.library.infoTypes.collection}}:B))},Z=C=>{K&&u(Le=>Le.map(B=>B.id===K.id?{...B,data:{...B.data,itemId:(C==null?void 0:C.infoId)??null,itemType:"info",infoType:(C==null?void 0:C.infoType)??null,label:(C==null?void 0:C.label)??t.cogita.library.infoTypes.any}}:B))};return a.useEffect(()=>{if(!K||K.data.nodeType!=="info"||K.data.infoType!=="citation"||!K.data.itemId){W(null);return}let C=!0;return aa({libraryId:o,infoId:K.data.itemId}).then(Le=>{if(!C)return;const B=Le.payload,ee=(B==null?void 0:B.text)??"";if(!ee){W(null);return}const q=ya(ee),ye=Object.values(q.nodes).sort((X,de)=>X.depth-de.depth||X.start-de.start).map(X=>({id:X.id,text:X.text,depth:X.depth}));W({title:(B==null?void 0:B.title)??K.data.label,fragments:ye})}).catch(()=>W(null)),()=>{C=!1}},[o,K]),e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:y,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:ve,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:he,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:le,children:t.cogita.library.actions.addInfo}),ce?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(ce.totalCollections))})}):null,f?e.jsx("p",{className:"cogita-help",children:f}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(nn,{nodes:l,edges:w,onNodesChange:v,onEdgesChange:D,onConnect:I,onNodeClick:(C,Le)=>h(Le.id),fitView:!0,children:[e.jsx(sn,{gap:18,size:1}),e.jsx(rn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),K?e.jsxs("div",{className:"cogita-graph-inspector",children:[K.data.nodeType==="collection"?e.jsx(Ut,{libraryId:o,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:K.data.itemId?{id:K.data.itemId,label:K.data.label,infoType:"collection"}:null,onChange:Ce,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(Ut,{libraryId:o,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:K.data.itemId?{id:K.data.itemId,label:K.data.label,infoType:K.data.infoType??void 0}:null,onChange:Z,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),N?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:N.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:N.fragments.map(C=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:C.id}),e.jsx("span",{children:C.text})]},C.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function Bn({children:t,flashState:n,flashTick:s=0,feedbackToken:i,className:r}){const g=i??(n?`${n}-${s}`:"idle");return e.jsx("section",{className:r?`cogita-revision-card ${r}`:"cogita-revision-card","data-feedback":g,children:t})}function _n({copy:t,currentCard:n,currentTypeLabel:s,prompt:i,languages:r,answer:g,onAnswerChange:m,computedExpected:k,computedAnswers:j,onComputedAnswerChange:M,answerTemplate:o,outputVariables:y,variableValues:l,computedFieldFeedback:u,feedback:v,canAdvance:w,quoteContext:T,quotePlaceholder:D,onCheckAnswer:p,onSkip:h,onLanguageSelect:ce,onMarkReviewed:P,onAdvance:f,showCorrectAnswer:V,setShowCorrectAnswer:N,onRevealCorrect:W,answerMask:K,expectedAnswer:I,hasExpectedAnswer:he,handleComputedKeyDown:le,answerInputRef:ve,computedInputRefs:Ce,scriptMode:Z,setScriptMode:C,matchPairs:Le,matchLeftOrder:B,matchRightOrder:ee,matchSelection:q,matchActiveLeft:ye,matchActiveRight:X,matchFeedback:de,onMatchLeftSelect:xe,onMatchRightSelect:Ke,disableCheckAnswer:_e=!1,hideSkipAction:Ie=!1,allowRevealBeforeCheck:qe=!1,autoRevealAfterAnswer:Qe=!1,disableCheckAfterAnswer:$e=!1}){const He=a.useMemo(()=>{var Ve;const R=!o&&k.length===2?`The {${k[0].key}} is of type {${k[1].key}}`:null,A=o??R;if(!A)return null;const Y=new Map(k.map(je=>[je.key,je.expected])),ne=new Set,S=[],U=/\{([^}]+)\}/g;let $=0,H,te=null;for(;(H=U.exec(A))!==null;){const je=A.slice($,H.index);je&&S.push({type:"text",value:je});const ue=((Ve=H[1])==null?void 0:Ve.trim())??"",oe=ue&&Y.has(ue)?ue:ue&&y&&y[ue]?y[ue]:null;ue&&ne.add(ue),oe&&ne.add(oe),oe&&Y.has(oe)?(S.push({type:"input",value:oe}),te||(te=oe)):ue&&l&&l[ue]!==void 0?S.push({type:"text",value:l[ue]}):S.push({type:"text",value:H[0]}),$=H.index+H[0].length}const Ne=A.slice($);return Ne&&S.push({type:"text",value:Ne}),k.filter(je=>!ne.has(je.key)).length>0?null:{parts:S,expectedByKey:Y,firstInputKey:te}},[o,k,y,l]),rt=()=>{if(!He)return null;const{parts:R,expectedByKey:A,firstInputKey:Y}=He;return e.jsx("div",{className:"cogita-revision-inline-answer",children:R.map((ne,S)=>{var U,$;return ne.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:ne.value},`text-${S}`):e.jsx("input",{ref:H=>{Ce.current[ne.value]=H},autoFocus:ne.value===Y,value:j[ne.value]??"",onChange:H=>M(ne.value,H.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":u[ne.value]??(v==="correct"?"correct":v==="incorrect"?"incorrect":void 0),onKeyDown:H=>J(H)||le(H),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((U=j[ne.value])==null?void 0:U.length)??0,(($=A.get(ne.value))==null?void 0:$.length)??6)}ch`}},`input-${ne.value}-${S}`)})})},ot=a.useMemo(()=>{const R=new Map;return(Le??[]).forEach(A=>R.set(A.leftId,A)),R},[Le]),ze=a.useMemo(()=>{const R=new Map;return(Le??[]).forEach(A=>R.set(A.rightId,A)),R},[Le]);a.useEffect(()=>{var S;if(n.cardType!=="info"||n.infoType!=="computed"||k.length===0)return;const R=typeof document<"u"?document.activeElement:null;if(R&&(R.tagName==="INPUT"||R.tagName==="TEXTAREA"))return;const A=(He==null?void 0:He.firstInputKey)??((S=k[0])==null?void 0:S.key);if(!A)return;const Y=Ce.current[A];if(!Y)return;const ne=requestAnimationFrame(()=>{Y.focus()});return()=>cancelAnimationFrame(ne)},[n,k,He]);const ke=(()=>{const R=[I??"",...k.map(ne=>ne.expected??"")].join(""),A=[g,...Object.values(j)].join(""),Y=`${R}${A}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(Y)})(),J=R=>R.ctrlKey&&(R.key==="^"||R.key==="6")?(R.preventDefault(),C(A=>A==="super"?null:"super"),!0):R.ctrlKey&&(R.key==="_"||R.key==="-")?(R.preventDefault(),C(A=>A==="sub"?null:"sub"),!0):!1,Re=()=>{if(!I||!K)return I??"";const R=I.split(""),A=Array.from(K),Y=A.length>0?A.reduce((ne,S)=>ne+S,0)/A.length:127;return R.map((ne,S)=>{const U=A[S]??Y,$=Math.max(0,Math.min(255,Math.round(U)));let H=255,te=0;return $<=127?te=Math.round($/127*255):(te=255,H=Math.round(255*(1-($-127)/128))),e.jsx("span",{style:{color:`rgb(${H}, ${te}, 0)`},children:ne},`mask-${S}`)})},re=n.cardType==="info"&&n.infoType==="citation"?(T==null?void 0:T.title)||n.label:n.description,_=V||Qe&&v!==null,fe=_e||$e&&(v!==null||_),We=he&&(qe||v==="incorrect"||_);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[s?e.jsx("span",{children:s}):null,e.jsx("strong",{children:re})]}),n.cardType==="vocab"&&n.checkType==="translation-match"&&Le?e.jsxs("div",{className:"cogita-revision-body",children:[i?e.jsx("h2",{children:i}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(B??[]).map(R=>{const A=ot.get(R);if(!A)return null;const Y=(q==null?void 0:q[R])??null,ne=(de==null?void 0:de[R])??null,S=ye===R;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":S,"data-state":ne??void 0,"data-locked":Y?"true":void 0,onClick:()=>xe==null?void 0:xe(R),children:[e.jsx("span",{children:A.leftLabel}),Y&&V?e.jsx("em",{children:"✓"}):null]},R)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(ee??[]).map(R=>{const A=ze.get(R);if(!A)return null;const Y=Object.values(q??{}).includes(R),ne=X===R;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":Y||ne,"data-locked":Y?"true":void 0,onClick:()=>Ke==null?void 0:Ke(R),children:e.jsx("span",{children:A.rightLabel})},R)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:p,disabled:n.checkType==="translation-match"||fe,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):n.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ve,value:g,onChange:R=>m(R.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:R=>{if(R.key==="Enter")if(R.preventDefault(),R.stopPropagation(),w)f();else{if(fe)return;p()}}})]}),ke?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":Z==="super",onClick:()=>C(R=>R==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":Z==="sub",onClick:()=>C(R=>R==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:p,disabled:fe,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[n.label?e.jsx("p",{className:"cogita-revision-hint",children:n.label}):null,o?null:e.jsx(ni,{value:i??"",mode:"auto"}),k.length>0?(()=>{const R=rt();return R?e.jsx("div",{className:"cogita-inline-answer-wrap",children:R}):e.jsx("div",{className:"cogita-form-grid",children:k.map((A,Y)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:A.key}),e.jsx("textarea",{ref:ne=>{Ce.current[A.key]=ne},autoFocus:Y===0,value:j[A.key]??"",onChange:ne=>M(A.key,ne.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":u[A.key]??(v==="correct"?"correct":v==="incorrect"?"incorrect":void 0),onKeyDown:ne=>J(ne)||le(ne)})]},A.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:ve,value:g,onChange:R=>m(R.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:R=>{if(!J(R)&&R.key==="Enter")if(R.preventDefault(),R.stopPropagation(),w)f();else{if(fe)return;p()}}})]})}),ke?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":Z==="super",onClick:()=>C(R=>R==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":Z==="sub",onClick:()=>C(R=>R==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:p,disabled:fe,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="citation"&&T?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(T.completed)).replace("{total}",String(T.total))}),e.jsx("p",{className:"cogita-quote-text",children:T.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ve,value:g,onChange:R=>m(R.target.value),placeholder:D??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":v==="correct"?"correct":v==="incorrect"?"incorrect":void 0,onKeyDown:R=>{if(R.key==="Enter")if(R.preventDefault(),R.stopPropagation(),w)f();else{if(fe)return;p()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:T.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:p,disabled:fe,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:r.length?r.map(R=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>ce(R.label),children:R.label},R.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:P,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}),v&&e.jsx("div",{className:"cogita-revision-feedback","data-state":v,children:v==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),We?e.jsxs("div",{className:"cogita-revision-reveal",children:[_?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>N(R=>{const A=!R;return A&&W(),A}),children:t.cogita.library.revision.showAnswer}),_?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),k.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[k.map(R=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:R.key}),e.jsx("span",{children:R.expected})]},R.key)),I?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:I})]}):null]}):e.jsx("p",{children:K?Re():I})]}):null]}):null,w?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:f,children:t.cogita.library.revision.nextQuestion})}):null]})}const bs={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},tr=(t,n)=>{const s=Math.max(t.length,n.length,1),i=Math.abs(t.length-n.length);return Math.max(0,1-i/s)},ar=(t,n)=>{const s=new Uint8Array(t.length),i=tr(t,n);for(let r=0;r<t.length;r+=1){const g=t[r]===(n[r]??"")?128:0,m=t.length-1-r,k=n.length-1-r,j=t[m]===(n[k]??"")?127:0,M=Math.round((g+j)*i);s[r]=Math.max(0,Math.min(255,M))}return s},nr=(t,n)=>t===n||(bs[t]??[]).includes(n)?!0:(bs[n]??[]).includes(t),Ba=(t,n,s)=>s?nr(t,n):t===n,Ga=(t,n,s)=>{const i=new Uint8Array(t.length);if(!t.length)return i;const r=(s==null?void 0:s.allowSimilarChars)??!0,g=[];for(let k=0;k<=t.length-3;k+=1)g.push({index:k,text:t.slice(k,k+3)});let m=!1;return g.forEach(k=>{for(let j=0;j<=n.length-3;j+=1){const M=n.slice(j,j+3);let o=0;for(let w=0;w<3;w+=1)Ba(k.text[w],M[w],r)&&(o+=1);if(o<2)continue;let y=k.index-1,l=j-1;for(;y>=0&&l>=0;){const w=t[y],T=n[l];if(w===T){i[y]=Math.max(i[y],255),y-=1,l-=1,m=!0;continue}if(Ba(w,T,r)&&w!==T){i[y]=Math.max(i[y],127),y-=1,l-=1,m=!0;continue}if(y>0&&t[y-1]===T){i[y]=Math.max(i[y],0),y-=1,m=!0;continue}if(l>0&&t[y]===n[l-1]){l-=1,m=!0;continue}break}for(let w=0;w<3;w+=1){const T=k.index+w,D=k.text[w],p=M[w],h=D===p?255:Ba(D,p,r)?127:0;i[T]=Math.max(i[T],h),m=!0}let u=k.index+3,v=j+3;for(;u<t.length&&v<n.length;){const w=t[u],T=n[v];if(w===T){i[u]=Math.max(i[u],255),u+=1,v+=1,m=!0;continue}if(Ba(w,T,r)&&w!==T){i[u]=Math.max(i[u],127),u+=1,v+=1,m=!0;continue}if(u+1<t.length&&t[u+1]===T){i[u]=Math.max(i[u],0),u+=1,m=!0;continue}if(v+1<n.length&&t[u]===n[v+1]){v+=1,m=!0;continue}break}}}),m?i:ar(t,n)},kn=t=>/[\p{L}\p{N}]/u.test(t),ys=t=>t.trim().toLowerCase(),ga=(t,n)=>{if(t.length===0)return 100;const s=(n==null?void 0:n.treatSimilarCharsAsSame)??!1,i=Array.from(t).reduce((r,g)=>s&&g===127?r+255:r+g,0);return Math.round(i/(t.length*255)*100)},Ya=(t,n,s)=>{const i=Math.max(0,Math.min(100,(s==null?void 0:s.thresholdPercent)??100)),r=(s==null?void 0:s.treatSimilarCharsAsSame)??!0,g=(s==null?void 0:s.ignorePunctuationAndSpacing)??!1,m=ys(t),k=ys(n);if(!g){const p=Ga(m,k,{allowSimilarChars:r}),h=ga(p,{treatSimilarCharsAsSame:r});return{mask:p,percent:h,isCorrect:h>=i,normalizedExpected:m,normalizedAnswer:k}}const j=Array.from(m),M=Array.from(k),o=[],y=[],l=[];j.forEach((p,h)=>{kn(p)&&(o.push(p),y.push(h))}),M.forEach(p=>{kn(p)&&l.push(p)});const u=o.join(""),v=l.join(""),w=Ga(u,v,{allowSimilarChars:r}),T=new Uint8Array(j.length);for(let p=0;p<T.length;p+=1)T[p]=kn(j[p]??"")?0:255;for(let p=0;p<w.length;p+=1){const h=y[p];h!==void 0&&(T[h]=w[p])}const D=ga(w,{treatSimilarCharsAsSame:r});return{mask:T,percent:D,isCorrect:D>=i,normalizedExpected:u,normalizedAnswer:v}},Ca=(t,n,s)=>{const i=t.trim().toLowerCase(),r=n.trim().toLowerCase();return s==="prefix"||s==="bidirectional"?Ga(i,r,{allowSimilarChars:!0}):Ga(i,r,{allowSimilarChars:!0})};function Zt(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function xs(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function vs(t){const n=t.checkType??"info";return t.direction?`${n} / ${t.direction}`:n}function sr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o,infoId:y,selectedReviewerRoleId:l}){const[u,v]=a.useState(y),[w,T]=a.useState([]),[D,p]=a.useState([]),[h,ce]=a.useState("loading"),[P,f]=a.useState(null),[V,N]=a.useState(null),[W,K]=a.useState(null),[I,he]=a.useState(null),[le,ve]=a.useState(""),[Ce,Z]=a.useState(null),[C,Le]=a.useState(1),[B,ee]=a.useState(null),[q,ye]=a.useState(0),[X,de]=a.useState(!1),[xe,Ke]=a.useState(null),[_e,Ie]=a.useState({}),[qe,Qe]=a.useState({}),[$e]=a.useState({}),[He,rt]=a.useState(null),ot=a.useRef(null),ze=a.useRef({}),ke=An();a.useEffect(()=>{let $=!1;return ce("loading"),Promise.all([aa({libraryId:o,infoId:y}).catch(()=>null),Ua({libraryId:o,infoId:y}),qa({libraryId:o,infoId:y})]).then(([H,te,Ne])=>{if($)return;const Ee=(H==null?void 0:H.payload)??{},Ve=typeof Ee.title=="string"&&Ee.title||typeof Ee.label=="string"&&Ee.label||typeof Ee.name=="string"&&Ee.name||y;v(Ve),N(Ee),K((H==null?void 0:H.infoType)??null),T(te.items),p(Ne.items),ce("ready")}).catch(()=>{$||(N(null),K(null),T([]),p([]),ce("error"))}),()=>{$=!0}},[o,y]),a.useEffect(()=>{if(W!=="translation"){he(null);return}Is({libraryId:o,infoId:y,approachKey:"vocab-card"}).then($=>he($.projection??null)).catch(()=>he(null))},[W,y,o]);const J=a.useMemo(()=>{var je;const $=new Map(w.map(ue=>[Zt(ue),ue])),H=new Map,te=new Map;for(const ue of w)H.set(Zt(ue),0),te.set(Zt(ue),[]);for(const ue of D){const oe=xs({parentItemId:ue.parentItemId,parentCheckType:ue.parentCheckType,parentDirection:ue.parentDirection}),Ye=[ue.childItemId,ue.childCheckType??"",ue.childDirection??""].join("|");!$.has(oe)||!$.has(Ye)||((je=te.get(oe))==null||je.push(Ye),H.set(Ye,(H.get(Ye)??0)+1))}const Ne=Array.from(H.entries()).filter(([,ue])=>ue===0).map(([ue])=>ue),Ee=new Map;for(const ue of Ne)Ee.set(ue,0);for(;Ne.length;){const ue=Ne.shift(),oe=Ee.get(ue)??0;for(const Ye of te.get(ue)??[]){const Ge=Math.max(Ee.get(Ye)??0,oe+1);Ee.set(Ye,Ge),H.set(Ye,(H.get(Ye)??1)-1),(H.get(Ye)??0)<=0&&Ne.push(Ye)}}const Ve=new Map;for(const ue of w){const oe=Zt(ue),Ye=Ee.get(oe)??0,Ge=Ve.get(Ye)??[];Ge.push(oe),Ve.set(Ye,Ge)}return w.map(ue=>{const oe=Zt(ue),Ye=Ee.get(oe)??0,Ge=Ve.get(Ye)??[oe],Oe=Math.max(0,Ge.indexOf(oe));return{id:oe,position:{x:40+Oe*290+(Ye%2?18:0),y:30+Ye*120},draggable:!1,selectable:!0,data:{label:ue.label,subtitle:vs(ue),checkType:ue.checkType??"info",direction:ue.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[w,D]),Re=a.useMemo(()=>new Map(w.map($=>[Zt($),$])),[w]),re=a.useMemo(()=>{const $=[];for(const H of D){const te=xs({parentItemId:H.parentItemId,parentCheckType:H.parentCheckType,parentDirection:H.parentDirection}),Ne=[H.childItemId,H.childCheckType??"",H.childDirection??""].join("|");!Re.has(te)||!Re.has(Ne)||$.push({id:`${te}->${Ne}`,source:te,target:Ne,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return $},[Re,D]),_=a.useMemo(()=>P?Re.get(P)??null:null,[Re,P]);a.useEffect(()=>{ve(""),ee(null),ye(0),de(!1),Ke(null),Z(null),Qe({})},[P]);const fe=a.useMemo(()=>{var Ee,Ve;if(!_)return null;const $=W??_.infoType??null,H=_.checkType??"info",te=_.direction??null,Ne=V??{};if(_.cardType==="vocab"&&I&&Array.isArray(I.words)){const je=I.words,ue=((Ee=je[0])==null?void 0:Ee.label)??"?",oe=((Ve=je[1])==null?void 0:Ve.label)??"?";return te==="a-to-b"?{kind:"vocab",prompt:String(ue),expected:String(oe)}:te==="b-to-a"?{kind:"vocab",prompt:String(oe),expected:String(ue)}:{kind:"generic",prompt:`${ue} ↔ ${oe}`,expected:`${ue} ↔ ${oe}`}}if($==="citation"&&H==="quote-fragment"&&te&&typeof Ne.text=="string"){const je=te,ue=ya(Ne.text),oe=ue.nodes[je];if(oe){const Ye=zn(Ne.text,oe);return{kind:"citation-fragment",expected:oe.text,quoteContext:{title:u,before:Ye.before,after:Ye.after,total:Object.keys(ue.nodes).length,completed:0},quotePlaceholder:oe.text.length>0?".".repeat(Math.max(4,Math.min(18,oe.text.length))):"..."}}}return{kind:"generic",prompt:_.description||_.label,expected:_.label}},[W,V,_,u,I]),We=async $=>{if(_&&l)try{await si({libraryId:o,outcome:{itemType:"info",itemId:_.cardId,checkType:_.checkType??"info",direction:_.direction??null,revisionType:"direct",evalType:"direct-check",correct:$,clientId:"cogita-info-checkcards",clientSequence:C,personRoleId:l}}),Le(H=>H+1),Z($?"Saved as correct.":"Saved as incorrect.")}catch{Z("Failed to save answer.")}},R=_?Zt(_):null,A=R?!!_e[R]:!1,Y=async()=>{if(!_||!fe)return;const $=Zt(_);if(_e[$]){Z("This card was already checked.");return}const H=fe.expected,te=fe.kind==="citation-fragment",Ne=Ya(H,le,{thresholdPercent:te?90:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:te}),Ee=Ne.isCorrect;ee(Ee?"correct":"incorrect"),ye(Ve=>Ve+1),Ke(Ne.mask),de(!0),Z(l?null:"Answer checked locally (not saved: no person selected)."),Ie(Ve=>({...Ve,[$]:!0})),l&&await We(Ee)},ne=()=>{if(!_||!fe)return;const $=Zt(_);_e[$]||(Ie(te=>({...te,[$]:!0})),Z("Answer revealed (not saved)."));const H=Ya(fe.expected,fe.expected,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:fe.kind==="citation-fragment"});Ke(H.mask)},S=a.useMemo(()=>_?_.infoType==="citation"?{..._,description:u}:{..._,description:_.label}:null,[_,u]),U=a.useMemo(()=>W?Ze(t,W):t.cogita.library.infoTypes.any,[t,W]);return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:U}),e.jsx("h2",{className:"cogita-card-title",children:u}),e.jsx("p",{className:"cogita-card-subtitle",children:y})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${w.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${D.length}`}),e.jsx("button",{type:"button",className:"cta",disabled:w.length===0,onClick:()=>ke(`/cogita/library/${o}/revision/run?libraryTarget=revisions&scope=info&infoId=${encodeURIComponent(y)}`),children:"Start revision"})]})]}),h==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):h==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(nn,{nodes:J,edges:re,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:($,H)=>f(H.id),panOnDrag:!0,children:[e.jsx(sn,{}),e.jsx(rn,{showInteractive:!1})]})}),_?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[fe&&S?e.jsx(Bn,{flashState:B,flashTick:q,children:e.jsx(_n,{copy:t,currentCard:S,currentTypeLabel:"",prompt:fe.kind==="citation-fragment"?null:fe.prompt,languages:[],answer:le,onAnswerChange:ve,computedExpected:[],computedAnswers:qe,onComputedAnswerChange:($,H)=>Qe(te=>({...te,[$]:H})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:$e,feedback:B,canAdvance:!1,quoteContext:fe.kind==="citation-fragment"?fe.quoteContext:null,quotePlaceholder:fe.kind==="citation-fragment"?fe.quotePlaceholder:null,onCheckAnswer:()=>void Y(),onSkip:()=>f(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:X,setShowCorrectAnswer:de,onRevealCorrect:ne,answerMask:xe,expectedAnswer:fe.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:ot,computedInputRefs:ze,scriptMode:He,setScriptMode:rt,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:A||X,hideSkipAction:!0,allowRevealBeforeCheck:!0,autoRevealAfterAnswer:!0,disableCheckAfterAnswer:!0})}):null,l?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),Ce?e.jsx("p",{className:"cogita-library-hint",children:Ce}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:w.map($=>{const H=Zt($),te=P===H;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${te?"active":""}`,onClick:()=>f(H),children:[e.jsx("span",{children:$.label}),e.jsx("small",{children:vs($)})]},H)})})]})]})]})})})})})}function _a(t,n){var s,i;return((i=(s=t.fields.find(r=>r.fieldType===n))==null?void 0:s.plainValue)==null?void 0:i.trim())??""}function ir(t){return _a(t,"role_kind").toLowerCase()==="person"}function rr(t){return _a(t,"label")||_a(t,"display_name")||_a(t,"name")||t.roleId}function or({copy:t,onPersonCreated:n}){const[s,i]=a.useState([]),[r,g]=a.useState("loading"),[m,k]=a.useState(null),[j,M]=a.useState(!1),[o,y]=a.useState(""),l=async()=>{g("loading");try{const w=await Ls();i(w),g("ready")}catch{i([]),g("error")}};a.useEffect(()=>{l()},[]);const u=a.useMemo(()=>s.filter(ir).map(w=>({roleId:w.roleId,label:rr(w)})).sort((w,T)=>w.label.localeCompare(T.label)),[s]),v=async()=>{const w=o.trim();if(!w){k("Name is required.");return}M(!0),k(null);try{const T=await ii({fields:[{fieldType:"role_kind",plainValue:"person"},{fieldType:"label",plainValue:w},{fieldType:"display_name",plainValue:w}]});y(""),k("Person role created."),n==null||n(T.roleId),await l()}catch{k("Failed to create person role.")}finally{M(!1)}};return e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-browser-panel",children:[e.jsx("div",{className:"cogita-info-overview-head",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Cogita"}),e.jsx("h2",{className:"cogita-card-title",children:"Persons"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Select reviewer persons in the header and create new person roles here."})]})}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Create"}),e.jsx("h3",{className:"cogita-detail-title",children:"New person role"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{type:"text",value:o,onChange:w=>y(w.target.value),placeholder:"e.g. Anna Kowalska",disabled:j})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:j,children:j?"Creating...":"Create person"})}),m?e.jsx("p",{className:"cogita-library-hint",children:m}):null]})]}),e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Overview"}),e.jsx("h3",{className:"cogita-detail-title",children:"All person roles"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[r==="loading"?e.jsx("p",{children:"Loading persons..."}):null,r==="error"?e.jsx("p",{children:"Failed to load persons."}):null,r==="ready"&&u.length===0?e.jsx("p",{children:"No person roles found."}):null,r==="ready"&&u.length>0?e.jsxs("div",{className:"cogita-details-grid",children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:"Name"}),e.jsx("span",{children:"Type"}),e.jsx("span",{children:"Role ID"}),e.jsx("span",{})]}),u.map(w=>e.jsxs("div",{className:"cogita-details-row",role:"row",children:[e.jsx("span",{}),e.jsx("span",{title:w.label,children:w.label}),e.jsx("span",{children:"person"}),e.jsx("span",{title:w.roleId,children:w.roleId}),e.jsx("span",{})]},w.roleId))]}):null]})]})]})]})})})})}function lr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o,collectionId:y}){const{libraryName:l}=na(o),[u,v]=a.useState([]),[w,T]=a.useState("loading"),[D,p]=a.useState("idle"),h=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),ce=`/#/cogita/library/${o}`,P=()=>{T("loading"),$s({libraryId:o}).then(N=>{v(N),T("idle")}).catch(()=>{v([]),T("error")})};a.useEffect(()=>{P()},[o]);const f=async N=>{try{await Rs({libraryId:o,shareId:N}),P()}catch{P()}},V=async N=>{const W=`${h}/${N}`;try{await navigator.clipboard.writeText(W),p("copied")}catch{p("failed")}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:ce,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${ce}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[w==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):w==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):u.filter(N=>!y||N.collectionId===y).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:u.filter(N=>!y||N.collectionId===y).map(N=>e.jsxs("div",{className:"cogita-share-row","data-state":N.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:N.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(N.createdUtc).toLocaleString(),N.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),N.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${h}/${N.shareCode}`}):null]}),N.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[N.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>V(N.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>f(N.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},N.shareId))}),D==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):D==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function cr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o}){const{libraryName:y}=na(o),[l,u]=a.useState(null),[v,w]=a.useState(null),[T,D]=a.useState(null),[p,h]=a.useState(null),[ce,P]=a.useState(null),[f,V]=a.useState(null),N=a.useRef(null),W=he=>{if(!Number.isFinite(he))return"0 B";if(he<1024)return`${he} B`;const le=he/1024;if(le<1024)return`${le.toFixed(1)} KB`;const ve=le/1024;return ve<1024?`${ve.toFixed(1)} MB`:`${(ve/1024).toFixed(1)} GB`},K=async()=>{u(null),P({loadedBytes:0,totalBytes:null,percent:null});try{u(t.cogita.library.overview.exporting);const he=await ri(o,P),le=URL.createObjectURL(he),ve=document.createElement("a");ve.href=le,ve.download=`cogita-library-${y||o}.json`,ve.click(),URL.revokeObjectURL(le),u(t.cogita.library.overview.exportReady)}catch{u(t.cogita.library.overview.exportFail)}finally{P(he=>he??{loadedBytes:0,totalBytes:null,percent:null})}},I=async he=>{var ve;w(null),D(null),h(null);const le=(ve=he.target.files)==null?void 0:ve[0];if(le)try{w(t.cogita.library.overview.importing),V({loadedBytes:0,totalBytes:le.size,percent:0});const Ce=await oi(o,le,V,Z=>{const C=Z.stage==="infos"?t.cogita.library.overview.importStageInfos:Z.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;h(t.cogita.library.overview.importLiveProgress.replace("{stage}",C).replace("{done}",String(Z.processed)).replace("{total}",String(Z.total)).replace("{infos}",String(Z.infos)).replace("{connections}",String(Z.connections)).replace("{collections}",String(Z.collections)))});D({infos:Ce.infosImported,connections:Ce.connectionsImported,collections:Ce.collectionsImported}),w(t.cogita.library.overview.importDone)}catch(Ce){const Z=Ce instanceof Ms&&Ce.message?` ${Ce.message}`:"";w(`${t.cogita.library.overview.importFail}${Z}`)}finally{N.current&&(N.current.value="")}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:y}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:K,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:N,type:"file",accept:"application/json",onChange:I})]})]}),ce?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:ce.percent??void 0,max:ce.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",W(ce.loadedBytes)).replace("{total}",ce.totalBytes?W(ce.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,f?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:f.percent??void 0,max:f.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",W(f.loadedBytes)).replace("{total}",f.totalBytes?W(f.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,l?e.jsx("p",{className:"cogita-help",children:l}):null,v?e.jsx("p",{className:"cogita-help",children:v}):null,p?e.jsx("p",{className:"cogita-help",children:p}):null,T?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(T.infos)).replace("{connections}",String(T.connections)).replace("{collections}",String(T.collections))}):null]})]})})})]})})}function dr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o}){const{libraryName:y}=na(o),[l,u]=a.useState(""),[v,w]=a.useState([]),T=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:y}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:D=>u(D.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const D=l.trim();D&&(w(p=>[{id:T(),name:D},...p]),u(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[v.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,v.map(D=>e.jsx("button",{type:"button",className:"ghost",children:D.name},D.id))]})]})]})})})]})})}function ur({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o}){const{libraryName:y}=na(o),[l,u]=a.useState(""),[v,w]=a.useState([]),T=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:y}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:D=>u(D.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const D=l.trim();D&&(w(p=>[{id:T(),name:D},...p]),u(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[v.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,v.map(D=>e.jsx("button",{type:"button",className:"ghost",children:D.name},D.id))]})]})]})})})]})})}function hr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o}){const{libraryName:y}=na(o),l=`/#/cogita/library/${o}`,[u,v]=a.useState(""),[w,T]=a.useState([]),[D,p]=a.useState("idle"),[h,ce]=a.useState(0),[P,f]=a.useState(null);a.useEffect(()=>{p("loading");const N=window.setTimeout(()=>{Oa({libraryId:o,query:u.trim()||void 0,limit:30}).then(W=>{T(W.items),ce(W.total),f(W.nextCursor??null),p("ready")}).catch(()=>{T([]),ce(0),f(null),p("ready")})},240);return()=>window.clearTimeout(N)},[o,u]);const V=async()=>{if(P){p("loading");try{const N=await Oa({libraryId:o,query:u.trim()||void 0,limit:30,cursor:P});T(W=>[...W,...N.items]),f(N.nextCursor??null),ce(N.total),p("ready")}catch{p("ready")}}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:y}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${l}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:u,onChange:N=>v(N.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(w.length)).replace("{total}",String(h||w.length))}),e.jsx("span",{children:D==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:w.length?w.map(N=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${l}/collections/${N.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:N.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(N.itemCount))," ·"," ",N.notes||t.cogita.library.collections.noNotes]})]})},N.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${l}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),P?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:V,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const be=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,Jt=(t,n,s,i)=>`${t}:${n}:${s??""}:${i??""}`;function gr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o,collectionId:y}){na(o);const l=`/#/cogita/library/${o}`,[u,v]=a.useState(t.cogita.library.collections.defaultName),[w,T]=a.useState(null),[D,p]=a.useState(0),[h,ce]=a.useState([]),[P,f]=a.useState("idle"),[V,N]=a.useState(null),W=a.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(h.length)).replace("{total}",String(D||h.length)),[t,h.length,D]);a.useEffect(()=>{on(o,y).then(I=>{v(I.name),T(I.notes??null),p(I.itemCount)}).catch(()=>{v(t.cogita.library.collections.defaultName),T(null)})},[o,y]),a.useEffect(()=>{f("loading"),Ja({libraryId:o,collectionId:y,limit:40}).then(I=>{ce(I.items),N(I.nextCursor??null),p(I.total),f("ready")}).catch(()=>{ce([]),N(null),f("ready")})},[o,y]);const K=async()=>{if(V){f("loading");try{const I=await Ja({libraryId:o,collectionId:y,limit:40,cursor:V});ce(he=>[...he,...I.items]),N(I.nextCursor??null),p(I.total),f("ready")}catch{f("ready")}}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:u}),e.jsx("p",{className:"cogita-library-subtitle",children:w||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${l}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${l}/collections/${y}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${l}/collections/${y}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:W}),e.jsx("span",{children:P==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:h.length?h.map(I=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:I.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:I.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:I.label}),e.jsx("p",{className:"cogita-card-subtitle",children:I.description})]})},be(I))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),V?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:K,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${l}/collections/${y}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const ws=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],mr={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},pr=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],fr=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function br({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o,onCreated:y}){const l=Ea(),{libraryName:u}=na(o),v=`/#/cogita/library/${o}`,[w,T]=a.useState(null),[D,p]=a.useState(""),[h,ce]=a.useState(""),[P,f,V]=En([]),[N,W,K]=Pn([]),[I,he]=a.useState(null),[le,ve]=a.useState(null),Ce=a.useRef(null),Z=a.useMemo(()=>P.find(q=>q.id===I)??null,[P,I]);a.useEffect(()=>{const q=new URLSearchParams(l.search),ye=(q.get("draft")??"").trim(),X=(q.get("draftType")??"").trim();if(!ye||X!=="info-selection"||Ce.current===ye)return;const de=Vi(o,ye);if(!de||de.infoIds.length===0)return;const xe=crypto.randomUUID(),Ke=de.infoIds.length>1?crypto.randomUUID():null,_e=de.infoIds.map(($e,He)=>({id:crypto.randomUUID(),type:"default",position:{x:80,y:80+He*100},data:{nodeType:"source.info",label:"Selected info",params:{infoId:$e,infoType:"any"}}})),Ie=Ke?[{id:Ke,type:"default",position:{x:360,y:120+Math.max(0,(de.infoIds.length-1)*50)},data:{nodeType:"logic.or",label:"Selected infos",params:{}}}]:[],qe={id:xe,type:"default",position:{x:660,y:140+Math.max(0,(de.infoIds.length-1)*35)},data:{nodeType:"output.collection",label:"Collection output",params:{}}},Qe=_e.map($e=>({id:crypto.randomUUID(),source:$e.id,target:Ke??xe}));Ke&&Qe.push({id:crypto.randomUUID(),source:Ke,target:xe}),f([..._e,...Ie,qe]),W(Qe),he(xe),ve(`Draft loaded from ${de.infoIds.length} selected infos. Set name and save to create collection.`),Ce.current=ye},[o,l.search,W,f]);const C=q=>{var xe;const ye=crypto.randomUUID(),X=((xe=ws.find(Ke=>Ke.type===q))==null?void 0:xe.label)??q,de={...mr[q]};f(Ke=>[...Ke,{id:ye,type:"default",position:{x:120+Ke.length*40,y:120+Ke.length*40},data:{nodeType:q,label:X,params:de}}]),he(ye)},Le=a.useCallback(q=>{W(ye=>Kn({...q,id:crypto.randomUUID()},ye))},[W]),B=q=>{Z&&f(ye=>ye.map(X=>X.id===Z.id?{...X,data:{...X.data,params:q}}:X))},ee=async()=>{if(ve(null),!D.trim()){ve(t.cogita.library.collections.saveRequiredName);return}try{const q={nodes:P.map(de=>({nodeId:de.id,nodeType:de.data.nodeType,payload:{position:de.position,params:de.data.params}})),edges:N.map(de=>({edgeId:de.id,fromNodeId:de.source,fromPort:de.sourceHandle??null,toNodeId:de.target,toPort:de.targetHandle??null}))};let ye=w,X=!1;if(ye)await As({libraryId:o,collectionId:ye,nodes:q.nodes,edges:q.edges});else{const de=await li({libraryId:o,name:D.trim(),notes:h.trim()||void 0,items:[],graph:q});ye=de.collectionId,X=!0,T(de.collectionId)}ve(X?t.cogita.library.collections.saveSuccess:t.cogita.library.graph.saveSuccess),y(ye)}catch{ve(w?t.cogita.library.graph.saveFail:t.cogita.library.collections.saveFail)}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.createKicker}),e.jsx("h1",{className:"cogita-library-title",children:u}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.createSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${v}/collections`,children:t.cogita.library.actions.collections}),e.jsx("button",{type:"button",className:"cta",onClick:ee,children:t.cogita.library.actions.saveCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.collectionInfoTitle}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{value:D,onChange:q=>p(q.target.value),placeholder:t.cogita.library.collections.namePlaceholder})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.notesLabel}),e.jsx("textarea",{value:h,onChange:q=>ce(q.target.value),placeholder:t.cogita.library.collections.notesPlaceholder})]}),le?e.jsx("p",{className:"cogita-help",children:le}):null,e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:ws.map(q=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>C(q.type),children:q.label},q.type))})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(nn,{nodes:P,edges:N,onNodesChange:V,onEdgesChange:K,onConnect:Le,onNodeClick:(q,ye)=>he(ye.id),fitView:!0,children:[e.jsx(sn,{color:"rgba(120,160,200,0.2)"}),e.jsx(rn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),Z?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:Z.data.label}),Z.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Ut,{libraryId:o,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:Z.data.params.tagId?{id:Z.data.params.tagId,label:Z.data.params.tagLabel??"",infoType:"topic"}:null,onChange:q=>B({...Z.data.params,tagId:(q==null?void 0:q.id)??null,tagLabel:(q==null?void 0:q.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:Z.data.params.scope??"any",onChange:q=>B({...Z.data.params,scope:q.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),Z.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Ut,{libraryId:o,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:Z.data.params.languageId?{id:Z.data.params.languageId,label:Z.data.params.languageLabel??"",infoType:"language"}:null,onChange:q=>B({...Z.data.params,languageId:(q==null?void 0:q.id)??null,languageLabel:(q==null?void 0:q.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:Z.data.params.scope??"any",onChange:q=>B({...Z.data.params,scope:q.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),Z.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:Z.data.params.infoType??"word",onChange:q=>B({...Z.data.params,infoType:q.target.value}),children:fr.map(q=>e.jsx("option",{value:q.value,children:q.label},q.value))})]}),e.jsx(Ut,{libraryId:o,infoType:Z.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:Z.data.params.infoId?{id:Z.data.params.infoId,label:Z.data.params.infoLabel??"",infoType:Z.data.params.infoType??"word"}:null,onChange:q=>B({...Z.data.params,infoId:(q==null?void 0:q.id)??null,infoLabel:(q==null?void 0:q.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),Z.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:Z.data.params.connectionType??"translation",onChange:q=>B({...Z.data.params,connectionType:q.target.value}),children:pr.map(q=>e.jsx("option",{value:q.value,children:q.label},q.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:Z.data.params.connectionId??"",onChange:q=>B({...Z.data.params,connectionId:q.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(Z.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const ea=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const n=t.length,s=t.filter(g=>g.correct).length,i=ln(Vn(t));return{score:Math.round(Math.max(0,Math.min(100,i.knowness*100))*100)/100,total:n,correct:s,lastReviewedUtc:i.lastReviewedUtc??null}},yr=t=>{if(t.maskBase64)try{const n=ci(t.maskBase64);if(!n.length)return t.correct?1:0;const s=n.reduce((i,r)=>i+r,0);return Math.max(0,Math.min(1,s/n.length/255))}catch{return t.correct?1:0}return t.correct?1:0},Vn=t=>t.map(n=>({correctness:yr(n),createdUtc:n.createdUtc})),ln=(t,n=Date.now())=>{var D;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const i=t.slice().sort((p,h)=>p.createdUtc.localeCompare(h.createdUtc)).slice(-5),r=i.reduce((p,h)=>p+h.correctness,0)/i.length,g=5,m=2,k=.15;let j=0,M=0;for(let p=0;p<i.length;p+=1){const h=new Date(i[p].createdUtc).getTime(),ce=p===i.length-1?n:new Date(i[p+1].createdUtc).getTime(),P=Math.max(0,(ce-h)/(1e3*60)),f=1-Math.exp(-P/g);j+=f,i[p].correctness>.5&&(M+=k)}let o=r*j*m+M;const y=((D=i[i.length-1])==null?void 0:D.createdUtc)??null,l=y?Math.max(0,(n-new Date(y).getTime())/(1e3*60)):0,v=1/(1+Math.log1p(l/60));return o*=v,i.length===1&&i[0].correctness>.5&&(o+=5.44*Math.exp(-l/2)),{knowness:o,avgCorrectness:r,lastReviewedUtc:y}},Aa=t=>{const n=t.slice();for(let s=n.length-1;s>0;s-=1){const i=Math.floor(Math.random()*(s+1));[n[s],n[i]]=[n[i],n[s]]}return n},Va=t=>t[Math.floor(Math.random()*t.length)],xr=(t,n)=>{const s=new Map;return t.forEach(i=>s.set(i,Math.random())),t.sort((i,r)=>{const g=n(i)-n(r);return g!==0?g:(s.get(i)??0)-(s.get(r)??0)})},cn=(t,n,s,i,r)=>{if(!t.length)return null;const g=t.filter(k=>!(r!=null&&r.has(be(k))));if(g.length===0)return null;const m=g.filter(k=>be(k)!==s);return Va(m.length?m:g)},vr=(t,n,s,i,r)=>{if(!t.length)return null;let g=Number.POSITIVE_INFINITY;for(const M of t){const o=be(M);if(s.has(o))continue;const y=n[o]??1;y<g&&(g=y)}if(!Number.isFinite(g))return null;const m=t.filter(M=>{const o=be(M);return!s.has(o)&&(n[o]??1)===g}),k=m.filter(M=>!r||be(M)!==r),j=i?k.filter(M=>!i.has(be(M))):k;return j.length>0?Va(j):k.length>0?Va(k):r&&m.some(M=>be(M)===r)?m.find(M=>be(M)===r)??null:m.length?Va(m):null},zs=(t,n,s,i,r)=>{const g=[],m=t.filter(j=>!r.has(be(j))&&!s.has(be(j))&&(n[be(j)]??0)<1),k=xr(m,j=>n[be(j)]??0);for(const j of k){if(g.length>=i)break;g.push(j),r.add(be(j))}if(g.length<i){const j=Aa(t.filter(M=>!r.has(be(M))&&s.has(be(M))));for(const M of j){if(g.length>=i)break;g.push(M),r.add(be(M))}}return g},wr=(t,n,s,i)=>zs(t,n,s,i,new Set),On=(t,n,s,i,r,g)=>{const m=Math.max(1,s.stackSize??n),j=Aa(t).filter((v,w,T)=>T.findIndex(D=>be(D)===be(v))===w),M=wr(j,i,r,m),o=new Set,y=new Set,l=cn(M,{},null,o,y),u=l?[l]:[];return l&&y.add(be(l)),{queue:u,meta:{pool:j,active:M,knownessMap:i,unknownSet:r,outcomesById:g,asked:o,queued:y}}},Rn={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,n)=>{const i=Aa(t).filter((r,g,m)=>m.findIndex(k=>be(k)===be(r))===g);return{queue:i.slice(0,Math.min(n,i.length)),meta:{}}},applyOutcome:t=>t},Un=(t,n,s,i)=>{const r=Math.max(1,s.stackSize??n),m=Aa(t).filter((w,T,D)=>D.findIndex(p=>be(p)===be(w))===T),k={},j=new Set,M=new Set,o=new Set,y=Math.max(1,s.levels??1);m.forEach(w=>{const T=be(w),D=i==null?void 0:i[T],p=typeof D=="number"&&Number.isFinite(D)?D:1;k[T]=Math.min(y,Math.max(1,Math.round(p)))});const l=[];if(m.length>0){const w=new Map;m.forEach(D=>{var h;const p=k[be(D)]??1;w.has(p)||w.set(p,[]),(h=w.get(p))==null||h.push(D)});const T=Array.from(w.keys()).sort((D,p)=>D-p);for(const D of T){if(l.length>=r)break;const p=Aa(w.get(D)??[]);for(const h of p){if(l.length>=r)break;l.push(h)}}}const u=cn(l,k,null,j,M),v=u?[u]:[];return u&&M.add(be(u)),{queue:v,meta:{pool:m,active:l,levelMap:k,asked:j,queued:M,wrongSinceCorrect:o}}},jr={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,s)=>Un(t,n,s),applyOutcome:(t,n,s,i,r)=>{if(!n)return t;const g=Math.max(1,i.levels??1),m=t.meta.pool??[],k=t.meta.active??[],j={...t.meta.levelMap??{}},M=new Set(t.meta.asked??[]),o=new Set(t.meta.queued??[]),y=new Set(t.meta.wrongSinceCorrect??[]),l=be(n);o.delete(l),M.add(l);const u=j[l]??1;r.correct?(j[l]=y.has(l)?1:Math.min(u+1,g),y.delete(l)):(j[l]=1,y.add(l));const v=r.correct?k.filter(D=>be(D)!==l):k.slice();if(r.correct&&v.length<Math.max(1,i.stackSize??1)){const D=new Set(v.map(h=>be(h))),p=vr(m,j,D,M,l);p&&v.push(p)}const w=t.queue.slice(),T=cn(v,j,l,M,o);return T&&(w.push(T),o.add(be(T))),{queue:w,meta:{pool:m,active:v,levelMap:j,asked:M,queued:o,wrongSinceCorrect:y}}}},kr={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,s)=>On(t,n,s,{},new Set,{}),applyOutcome:(t,n,s,i,r)=>{if(!n)return t;const g=t.meta.pool??[],m=t.meta.active??[],k={...t.meta.knownessMap??{}},j=new Set(t.meta.unknownSet??[]),M={...t.meta.outcomesById??{}},o=new Set(t.meta.asked??[]),y=new Set(t.meta.queued??[]),l=be(n);y.delete(l),o.add(l);const u={correctness:Math.max(0,Math.min(1,r.correctness??(r.correct?1:0))),createdUtc:r.createdUtc??new Date().toISOString()},w=(M[l]??[]).concat(u).sort((P,f)=>P.createdUtc.localeCompare(f.createdUtc)).slice(-5);M[l]=w,j.delete(l);const T=Date.now();g.forEach(P=>{const f=be(P),V=M[f]??[];if(V.length===0){k[f]=0,j.add(f);return}const N=ln(V,T);k[f]=N.knowness});const D=m.slice();if((k[l]??0)>=1){const P=D.filter(f=>be(f)!==l);D.length=0,D.push(...P)}const h=Math.max(1,i.stackSize??s);if(D.length<h){const P=new Set(D.map(V=>be(V))),f=zs(g,k,j,h-D.length,P);D.push(...f)}const ce=t.queue.slice();if(ce.length===0||be(ce[ce.length-1])===l){const P=cn(D,{},l,o,y);P&&(ce.push(P),y.add(be(P)))}return{queue:ce,meta:{pool:g,active:D,knownessMap:k,unknownSet:j,outcomesById:M,asked:o,queued:y}}}},Bs={random:Rn,levels:jr,temporal:kr},Nr=Object.values(Bs),qn=t=>{if(!t)return Rn;const n=t.trim().toLowerCase();return n==="random"||n==="levels"||n==="temporal"?Bs[n]:Rn},dn=(t,n)=>{const s={...t.defaultSettings};return n&&Object.entries(n).forEach(([i,r])=>{typeof r=="number"&&Number.isFinite(r)&&(s[i]=r),typeof r=="string"&&(s[i]=r)}),t.settingsFields.forEach(i=>{var g;const r=s[i.key];if(i.type==="number"){if(typeof r!="number"||Number.isNaN(r)){s[i.key]=t.defaultSettings[i.key]??0;return}i.min!==void 0&&(s[i.key]=Math.max(i.min,s[i.key])),i.max!==void 0&&(s[i.key]=Math.min(i.max,s[i.key]));return}if(i.type==="select"){const m=((g=i.options)==null?void 0:g.map(k=>k.value))??[];(typeof r!="string"||m.length>0&&!m.includes(r))&&(s[i.key]=t.defaultSettings[i.key]??m[0]??"")}}),s},_s=(t,n)=>{const s={};return t.settingsFields.forEach(i=>{const r=n.get(i.key);if(r){if(i.type==="number"){const g=Number(r);Number.isNaN(g)||(s[i.key]=g);return}s[i.key]=r}}),dn(t,s)},Sr=(t,n)=>{const s=new URLSearchParams;return t.settingsFields.forEach(i=>{const r=n[i.key];(typeof r=="number"||typeof r=="string")&&s.set(i.key,String(r))}),s};function Tr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o,collectionId:y,revisionId:l}){const{libraryName:u}=na(o),v=`/#/cogita/library/${o}`,[w,T]=a.useState(t.cogita.library.collections.defaultName),[D,p]=a.useState(""),[h,ce]=a.useState(20),[P,f]=a.useState("random"),[V,N]=a.useState({}),[W,K]=a.useState("exact"),[I,he]=a.useState([]),[le,ve]=a.useState(null),[Ce,Z]=a.useState([]),[C,Le]=a.useState("idle"),[B,ee]=a.useState(null),[q,ye]=a.useState("idle"),[X,de]=a.useState("idle"),[xe,Ke]=a.useState("idle"),_e=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),Ie=a.useMemo(()=>qn(P),[P]),qe=a.useMemo(()=>dn(Ie,V),[Ie,V]),Qe=a.useMemo(()=>Sr(Ie,qe).toString(),[Ie,qe]);a.useEffect(()=>{on(o,y).then(ke=>T(ke.name)).catch(()=>T(t.cogita.library.collections.defaultName))},[o,y]),a.useEffect(()=>{l&&di({libraryId:o,collectionId:y,revisionId:l}).then(ke=>{p(ke.name),f(ke.mode||"random"),K(ke.check||"exact"),ce(ke.limit||20),N(ke.revisionSettings??{})}).catch(()=>{p("")})},[y,o,l]),a.useEffect(()=>{Es({libraryId:o}).then(ke=>{he(ke),!le&&ke.length>0&&ve(ke[0].roleId)}).catch(()=>{he([])})},[o]);const $e=()=>{de("loading"),$s({libraryId:o}).then(ke=>{Z(ke),de("idle")}).catch(()=>{Z([]),de("error")})};a.useEffect(()=>{$e()},[o]);const He=async()=>{Le("working"),ye("idle");try{const ke=await hi({libraryId:o,collectionId:y,revisionType:Ie.id,revisionSettings:qe,mode:P,check:W,limit:h});ee(`${_e}/${ke.shareCode}${Qe?`?${Qe}`:""}`),Le("ready"),$e()}catch{Le("error")}},rt=async()=>{if(l){Ke("saving");try{await ui({libraryId:o,collectionId:y,revisionId:l,name:D||w,revisionType:Ie.id,revisionSettings:qe,mode:P,check:W,limit:h}),Ke("saved")}catch{Ke("error")}}},ot=async()=>{if(B)try{await navigator.clipboard.writeText(B),ye("copied")}catch{ye("failed")}},ze=async ke=>{try{await Rs({libraryId:o,shareId:ke}),$e()}catch{$e()}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:w}),e.jsx("p",{className:"cogita-library-subtitle",children:u})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${v}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${v}/collections/${y}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${v}/collections/${y}/revision/run?mode=${encodeURIComponent(P)}&check=${encodeURIComponent(W)}&limit=${h}${Qe?`&${Qe}`:""}${le?`&reviewer=${encodeURIComponent(le)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:D,onChange:ke=>p(ke.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:P,onChange:ke=>f(ke.target.value),children:Nr.map(ke=>e.jsx("option",{value:ke.id,children:t.cogita.library.revision[ke.labelKey]},ke.id))})]}),Ie.settingsFields.map(ke=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[ke.labelKey]}),ke.type==="select"?e.jsx("select",{value:String(qe[ke.key]??""),onChange:J=>N(Re=>({...Re,[ke.key]:J.target.value})),children:(ke.options??[]).map(J=>e.jsx("option",{value:J.value,children:t.cogita.library.revision[J.labelKey]},J.value))}):e.jsx("input",{type:"number",min:ke.min,max:ke.max,step:ke.step,value:qe[ke.key]??0,onChange:J=>N(Re=>({...Re,[ke.key]:Number(J.target.value||0)}))})]},ke.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),Ie.id!=="levels"&&Ie.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:h,onChange:ke=>ce(Number(ke.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:le??"",onChange:ke=>ve(ke.target.value||null),children:I.map(ke=>e.jsx("option",{value:ke.roleId,children:ke.label},ke.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[l?e.jsx("button",{type:"button",className:"cta ghost",onClick:rt,disabled:xe==="saving",children:xe==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${v}/collections/${y}/revision/run?mode=${encodeURIComponent(P)}&check=${encodeURIComponent(W)}&limit=${h}${Qe?`&${Qe}`:""}${le?`&reviewer=${encodeURIComponent(le)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]}),xe==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),B?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:B,readOnly:!0})]}):null,C==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,q==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):q==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:He,disabled:C==="working",children:C==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),B?e.jsx("button",{type:"button",className:"cta ghost",onClick:ot,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),X==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):Ce.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:Ce.map(ke=>e.jsxs("div",{className:"cogita-share-row","data-state":ke.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:ke.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(ke.createdUtc).toLocaleString(),ke.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),ke.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>ze(ke.shareId),children:t.cogita.library.revision.shareRevokeAction})]},ke.shareId))})]})]})]})]})})})]})})}const Nn=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function Vs(t,n,s){if(!t)return null;const i=new Map(t.nodes.map(P=>[P.id,P])),r=new Map,g=new Set,m=P=>{if(typeof P=="number")return P;if(typeof P=="string"){const f=Number(P);return Number.isFinite(f)?f:0}return 0},k=P=>{if(r.has(P))return r.get(P);if(g.has(P))return 0;const f=i.get(P);if(!f)return 0;g.add(P);const V=W=>{var I,he;return(W?((I=f.inputsByHandle)==null?void 0:I[W])??[]:f.inputs??((he=f.inputsByHandle)==null?void 0:he.in)??[]).map(le=>k(le))};let N=0;switch(f.type){case"input.random":{const W=f.min??0,K=f.max??W+10,I=Math.min(W,K),he=Math.max(W,K);N=Math.floor(Math.random()*(he-I+1))+I;break}case"input.const":{N=f.value??0;break}case"input.list":{const W=(f.list??[]).filter(Boolean),K=Math.round(m(V("index")[0]));N=W.length?W[Math.max(0,Math.min(W.length-1,K))]:String(K);break}case"compute.add":{N=V("in").map(K=>m(K)).reduce((K,I)=>K+I,0);break}case"compute.sub":{const W=V("add").map(I=>m(I)),K=V("sub").map(I=>m(I));N=W.reduce((I,he)=>I+he,0)-K.reduce((I,he)=>I+he,0);break}case"compute.mul":{const W=V("in").map(K=>m(K));N=W.length?W.reduce((K,I)=>K*I,1):0;break}case"compute.div":{const W=m(V("num")[0]),K=V("den").map(I=>m(I)).reduce((I,he)=>I+he,0);N=Math.abs(K)<Number.EPSILON?0:W/K;break}case"compute.pow":{const W=m(V("base")[0]),K=m(V("exp")[0]);N=Math.pow(W,K);break}case"compute.exp":{const W=m(V("base")[0]),K=m(V("exp")[0]);N=Math.pow(W,K);break}case"compute.log":{const W=m(V("value")[0]),K=m(V("base")[0]),I=Math.max(W,Number.EPSILON);N=Math.abs(K)<Number.EPSILON?Math.log(I):Math.log(I)/Math.log(K);break}case"compute.abs":{N=Math.abs(m(V("in")[0]));break}case"compute.min":{const W=V("in").map(K=>m(K));N=W.length?Math.min(...W):0;break}case"compute.max":{const W=V("in").map(K=>m(K));N=W.length?Math.max(...W):0;break}case"compute.floor":{N=Math.floor(m(V("in")[0]));break}case"compute.ceil":{N=Math.ceil(m(V("in")[0]));break}case"compute.round":{N=Math.round(m(V("in")[0]));break}case"compute.mod":{const W=m(V("a")[0]),K=m(V("b")[0]);N=Math.abs(K)<Number.EPSILON?0:W%K;break}case"compute.concat":{const K=["in1","in2","in3","in4","in5","in6"].flatMap(ve=>V(ve)),I=K.length?K:V("in");N=(I.length?I:V()).map(ve=>ve==null?"":String(ve)).join("");break}case"compute.trim":{const W=V("text")[0]??V("in")[0]??"",K=W==null?"":String(W),I=Math.max(0,Math.round(m(V("start")[0]))),he=Math.max(0,Math.round(m(V("end")[0])));I+he>=K.length?N="":N=K.substring(I,K.length-he);break}case"output":{N=V("in")[0]??0;break}default:N=0}return g.delete(P),r.set(P,N),N},j=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(P=>P.type==="output").map(P=>P.id);t.nodes.forEach(P=>k(P.id)),j.forEach(P=>k(P));const M=P=>Math.abs(P%1)<1e-5?String(Math.round(P)):P.toFixed(3).replace(/\.?0+$/,""),o=P=>typeof P=="number"?M(P):P??"",y=new Map;j.forEach(P=>{var K,I,he,le;const f=i.get(P);if(!f)return;const V=(I=(K=f.inputsByHandle)==null?void 0:K.name)==null?void 0:I[0],N=V?o(r.get(V)):"",W=(N==null?void 0:N.toString().trim())||((he=f.outputLabel)==null?void 0:he.trim())||((le=f.name)==null?void 0:le.trim())||P;y.set(P,W)});const l={},u={},v={};j.forEach(P=>{var N,W;const f=i.get(P);if(!f)return;const V=y.get(P)??(((N=f.outputLabel)==null?void 0:N.trim())||((W=f.name)==null?void 0:W.trim())||P);l[V]=o(r.get(P)),f.name&&(u[f.name.trim()]=V),u[P]=V});const w=(P,f)=>{let V=P;return t.nodes.forEach(N=>{var le,ve;const W=o(r.get(N.id)),K=j.includes(N.id),I=K?y.get(N.id)??((le=N.outputLabel)==null?void 0:le.trim())??((ve=N.name)==null?void 0:ve.trim())??N.id:"",he=K&&f?I:W;V=V.replace(new RegExp(`\\{\\s*${Nn(N.id)}\\s*\\}`,"gi"),he),N.name&&(V=V.replace(new RegExp(`\\{\\s*${Nn(N.name)}\\s*\\}`,"gi"),he)),K&&N.outputLabel&&(V=V.replace(new RegExp(`\\{\\s*${Nn(N.outputLabel)}\\s*\\}`,"gi"),I))}),V},T=n;let D=T.trim().length>0?T:"";D||(D=j.length?`Compute ${j.join(", ")}`:"Compute"),D=w(D,!0);const p=(s==null?void 0:s.trim())??"",h=p?w(p,!1):"",ce={};return r.forEach((P,f)=>{ce[f]=P,v[f]=o(P);const V=i.get(f);V!=null&&V.name&&(v[V.name.trim()]=o(P))}),{prompt:D,answers:l,values:ce,answerText:h,outputVariables:u,variableValues:v}}function Os(t){var s;const n=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((s=n[0])==null?void 0:s[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const Sn=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function Us({outcomes:t}){const[n,s]=a.useState("day"),i=a.useMemo(()=>{const r=Sn.find(k=>k.id===n)??Sn[1],g=Date.now()-r.ms,m=t.filter(k=>new Date(k.createdUtc).getTime()>=g);return ea(m)},[t,n]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:Sn.map(r=>e.jsx("button",{type:"button",className:"ghost","data-active":n===r.id,onClick:()=>s(r.id),children:r.label},r.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[i.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[i.correct," / ",i.total]})]})}const Cr="cogita-revision",Ir=1,Qa="outcomes",Mr=()=>new Promise((t,n)=>{const s=indexedDB.open(Cr,Ir);s.onupgradeneeded=()=>{const i=s.result;if(!i.objectStoreNames.contains(Qa)){const r=i.createObjectStore(Qa,{keyPath:"id"});r.createIndex("byItem","itemKey",{unique:!1}),r.createIndex("byPending","pending",{unique:!1})}},s.onerror=()=>n(s.error),s.onsuccess=()=>t(s.result)}),Pa=async(t,n)=>{const s=await Mr();return new Promise((i,r)=>{const g=s.transaction(Qa,t),m=g.objectStore(Qa);n(m).then(i).catch(r),g.onerror=()=>r(g.error)})},qs=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const n=Array.from(t).map(s=>s.toString(16).padStart(2,"0"));return`${n.slice(0,4).join("")}-${n.slice(4,6).join("")}-${n.slice(6,8).join("")}-${n.slice(8,10).join("")}-${n.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},Lr=()=>{const t="cogita_revision_client_id",n=localStorage.getItem(t);if(n)return n;const s=qs();return localStorage.setItem(t,s),s},$r=()=>{const t="cogita_revision_client_seq",n=Number(localStorage.getItem(t)??"0"),s=Number.isFinite(n)?n+1:1;return localStorage.setItem(t,String(s)),s},Js=(t,n,s,i)=>Jt(t,n,s,i),Xa=async t=>{const n=Lr(),s=$r(),i=new Date().toISOString(),r={...t,clientId:n,clientSequence:s,createdUtc:i,id:qs(),pending:!0};return await Pa("readwrite",g=>new Promise((m,k)=>{const j={...r,itemKey:Js(r.itemType,r.itemId,r.checkType,r.direction)},M=g.add(j);M.onsuccess=()=>m(),M.onerror=()=>k(M.error)})),r},Za=async(t,n,s,i)=>{if(!n)return[];try{const r=Js(t,n,s,i);return await Pa("readonly",g=>new Promise((m,k)=>{const M=g.index("byItem").getAll(r);M.onsuccess=()=>{const y=(M.result??[]).map(l=>({itemType:l.itemType,itemId:l.itemId,checkType:l.checkType??null,direction:l.direction??null,revisionType:l.revisionType,evalType:l.evalType,correct:l.correct,createdUtc:l.createdUtc,maskBase64:l.maskBase64,payloadBase64:l.payloadBase64,payloadHashBase64:l.payloadHashBase64,clientId:l.clientId,clientSequence:l.clientSequence,personRoleId:l.personRoleId??null})).sort((l,u)=>l.createdUtc.localeCompare(u.createdUtc));m(y)},M.onerror=()=>k(M.error)}))}catch{return[]}},ta=async()=>{try{return await Pa("readonly",t=>new Promise((n,s)=>{const i=t.getAll();i.onsuccess=()=>{const g=(i.result??[]).map(m=>({itemType:m.itemType,itemId:m.itemId,checkType:m.checkType??null,direction:m.direction??null,revisionType:m.revisionType,evalType:m.evalType,correct:m.correct,createdUtc:m.createdUtc,maskBase64:m.maskBase64,payloadBase64:m.payloadBase64,payloadHashBase64:m.payloadHashBase64,clientId:m.clientId,clientSequence:m.clientSequence,personRoleId:m.personRoleId??null}));n(g)},i.onerror=()=>s(i.error)}))}catch{return[]}},Rr=async(t=100)=>{try{return await Pa("readonly",n=>new Promise((s,i)=>{const g=n.index("byPending").getAll(!0);g.onsuccess=()=>{const m=g.result??[];s(m.slice(0,t))},g.onerror=()=>i(g.error)}))}catch{return[]}},Ar=async t=>{if(t.length!==0)try{await Pa("readwrite",n=>new Promise((s,i)=>{let r=t.length;t.forEach(g=>{const m=n.get(g);m.onsuccess=()=>{const k=m.result;if(k){k.pending=!1;const j=n.put(k);j.onsuccess=()=>{r-=1,r===0&&s()},j.onerror=()=>i(j.error)}else r-=1,r===0&&s()},m.onerror=()=>i(m.error)})}))}catch{}},Tn=async(t,n)=>{const s=await Rr(200);if(s.length===0)return;const i=new Map;s.forEach(r=>{var m;const g=r.personRoleId??n??"";i.has(g)||i.set(g,[]),(m=i.get(g))==null||m.push(r)});for(const[r,g]of i.entries()){const m=g.map(k=>({itemType:k.itemType,itemId:k.itemId,checkType:k.checkType??null,direction:k.direction??null,revisionType:k.revisionType,evalType:k.evalType,correct:k.correct,clientId:k.clientId,clientSequence:k.clientSequence,maskBase64:k.maskBase64??null,payloadHashBase64:k.payloadHashBase64??null,payloadBase64:k.payloadBase64??null,personRoleId:r||null}));try{await gi({libraryId:t,outcomes:m}),await Ar(g.map(k=>k.id))}catch{}}},Ft=t=>t.trim().toLowerCase(),Vt=t=>{const n=t==null?void 0:t.trim();return n?{fragmentId:n}:null},en=(t,n)=>{const s=Vt(n);if(!s)return!0;const i=Vt(t);return(i==null?void 0:i.fragmentId)===s.fragmentId},pt=t=>{const n=t==null?void 0:t.trim().toLowerCase();return n||null},Hs=(t,n)=>{if((pt(t.childItemType)??"info")!==(n.cardType??"").toLowerCase()||t.childItemId!==n.cardId)return!1;const i=pt(t.childCheckType),r=pt(t.childDirection),g=pt(n.checkType),m=pt(n.direction);return!(i&&i!==g||r&&r!==m)},Er={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},Pr={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},tn=(t,n,s)=>{if(!s||!n.startsWith(t))return n;const i=n.slice(t.length);if(!i)return n;const r=s==="super"?Er:Pr,g=i.split("").map(m=>r[m]??m).join("");return t+g},an=(t,n,s)=>{var m,k,j;if(!t)return((m=n[0])==null?void 0:m.key)??null;const i=new Set(n.map(M=>M.key)),r=/\{([^}]+)\}/g;let g;for(;(g=r.exec(t))!==null;){const M=((k=g[1])==null?void 0:k.trim())??"";if(!M)continue;if(i.has(M))return M;const o=s==null?void 0:s[M];if(o&&i.has(o))return o}return((j=n[0])==null?void 0:j.key)??null},Ra=t=>(()=>{const n=new Set;return t.flatMap(s=>{if(s.cardType!=="info"||s.infoType!=="citation")return[s];const i=s.description??"";if(!i.trim())return[s];const r=ya(i),g=Object.keys(r.nodes);return g.length===0?[s]:g.map(m=>({...s,checkType:"quote-fragment",direction:m})).filter(m=>{const k=[m.cardId,m.checkType??"",m.direction??""].join("|");return n.has(k)?!1:(n.add(k),!0)})})})();function js({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o,collectionId:y,revisionId:l}){const u=Ea(),v=`/#/cogita/library/${o}`,w=a.useMemo(()=>new URLSearchParams(u.search),[u.search]),T=Math.max(1,Number(w.get("limit")??20)),D=w.get("mode")??"random",p=a.useMemo(()=>qn(D),[D]),h=a.useMemo(()=>dn(p,_s(p,w)),[p,w]),ce=w.get("check")??"exact",P=w.get("reviewer"),f=(w.get("scope")??"").trim(),V=f==="info"||f==="info-selection"?f:"collection",N=V==="info"?(w.get("infoId")??"").trim():"",W=V==="info-selection"?(w.get("seed")??"").trim():"",K=V==="collection"&&!!y,I=a.useMemo(()=>t.cogita.library.revision[p.labelKey]??D,[t,D,p]),he=a.useMemo(()=>ce==="exact"?t.cogita.library.revision.checkValue:ce,[t,ce]),[le,ve]=a.useState(t.cogita.library.collections.defaultName),[Ce,Z]=a.useState([]),[C,Le]=a.useState([]),[B,ee]=a.useState("idle"),[q,ye]=a.useState({current:0,total:0}),[X,de]=a.useState(0),[xe,Ke]=a.useState(""),[_e,Ie]=a.useState(null),[qe,Qe]=a.useState(null),[$e,He]=a.useState(null),[rt,ot]=a.useState(null),[ze,ke]=a.useState([]),[J,Re]=a.useState({}),[re,_]=a.useState({}),[fe,We]=a.useState(null),[R,A]=a.useState(null),[Y,ne]=a.useState(null),[S,U]=a.useState(null),[$,H]=a.useState(null),[te,Ne]=a.useState({}),Ee=a.useRef(0),[Ve,je]=a.useState(null),ue=a.useRef(null),oe=a.useRef(null),[Ye,Ge]=a.useState(null),[Oe,st]=a.useState(!1),[jt,Xe]=a.useState(null),[lt,bt]=a.useState([]),[It,yt]=a.useState(null),St=a.useRef(null),xt=a.useRef(null),[sa,mt]=a.useState(null),[At,tt]=a.useState(0),Mt=a.useRef(null),Dt=a.useRef({}),[ft,et]=a.useState(!1),[ht,Lt]=a.useState({}),[Tt,Je]=a.useState([]),gt=a.useRef(new Map),[kt,Yt]=a.useState(new Set),[ia,se]=a.useState(!1),x=a.useRef(null),Me=a.useRef(new Set),Be=a.useRef({}),c=Ce[X]??null,pe=(c==null?void 0:c.checkType)==="translation-match"&&$,Se=a.useRef(new Map),at=a.useRef(new Map),ct=a.useRef(new Map),Ct=a.useRef(new Map),Et=a.useMemo(()=>c?c.cardType==="vocab"?t.cogita.library.revision.vocabLabel:c.infoType?Ze(t,c.infoType):t.cogita.library.revision.infoLabel:"",[t,c]),oa=a.useMemo(()=>{var b;return p.id!=="levels"?Ce.length:((b=ht.pool)==null?void 0:b.length)??p.getFetchLimit(T,h)},[ht,h,p,Ce.length,T]),Ht=p.getProgressTotal?p.getProgressTotal(Ce,ht,T,h):p.id==="levels"?Math.min(T,oa):Ce.length,vt=Ht?Math.min(X+1,Ht):0,Nt=Math.max(1,Number(h.tries??1)),ra=h.compare??"anchors",$t=Math.max(0,Math.min(100,Number(h.minCorrectness??0))),wt=(h.considerDependencies??"on")==="on",Ot=Math.max(0,Math.min(100,Number(h.dependencyThreshold??85))),Ka=d=>{const b=d.slice();for(let F=b.length-1;F>0;F-=1){const O=Math.floor(Math.random()*(F+1));[b[F],b[O]]=[b[O],b[F]]}return b},xa=d=>ga(d,{treatSimilarCharsAsSame:!0})>=$t,Fa=async()=>{const d=await ta(),b=new Map,F=new Map,O=new Map;d.forEach(E=>{const ae=`${E.itemType}:${E.itemId}`,we=Jt(E.itemType,E.itemId,E.checkType,E.direction);if(b.has(ae)||b.set(ae,[]),b.get(ae).push(E),F.has(we)||F.set(we,[]),F.get(we).push(E),E.itemType==="info"&&E.checkType==="quote-fragment"&&E.direction){const Fe=`${E.itemId}:${E.direction}`;O.has(Fe)||O.set(Fe,[]),O.get(Fe).push(E)}});const Q=new Map,z=new Map,ie=new Map;return b.forEach((E,ae)=>Q.set(ae,ea(E).score)),F.forEach((E,ae)=>z.set(ae,ea(E).score)),O.forEach((E,ae)=>ie.set(ae,ea(E).score)),{itemKnowness:Q,cardKnowness:z,fragmentKnowness:ie}},Wt=async d=>{const b=[];let F=null;for(;;){const O=await Ja({libraryId:o,collectionId:d,limit:200,cursor:F});if(b.push(...O.items),!O.nextCursor)break;F=O.nextCursor}return Ra(b)},va=async(d,b)=>{if(gt.current.has(d))return gt.current.get(d)??0;const F=await Wt(d);if(F.length===0)return gt.current.set(d,0),0;const Q=F.reduce((z,ie)=>{const E=be(ie);return z+(b.get(E)??0)},0)/F.length;return gt.current.set(d,Q),Q},un=(d,b)=>{if(!wt||d.cardType!=="info"||d.infoType!=="citation"||d.checkType!=="quote-fragment")return!0;const F=Vt(d.direction);if(!(F!=null&&F.fragmentId))return!0;const O=d.description??"";if(!O.trim())return!0;const z=ya(O).nodes[F.fragmentId];if(!z||!z.leftId&&!z.rightId)return!0;const ie=[z.leftId,z.rightId].filter(we=>!!we);if(ie.length===0)return!0;const E=ie.map(we=>{const Fe=Jt("info",d.cardId,"quote-fragment",we);return b.get(Fe)??0});return E.reduce((we,Fe)=>we+Fe,0)/E.length>=Ot},zt=async d=>{const b=ht,F=d.concat(b.active??[]).concat(b.pool??[]).filter((E,ae,we)=>we.findIndex(Fe=>be(Fe)===be(E))===ae);if(!wt){Yt(new Set(F.map(be)));return}const{itemKnowness:O,cardKnowness:Q}=await Fa(),z=Tt.filter(E=>pt(E.childItemType)==="collection"&&E.childItemId===y&&!pt(E.childCheckType)&&!pt(E.childDirection)),ie=new Set;for(const E of F){if(E.cardType!=="info"){ie.add(be(E));continue}if(!un(E,Q))continue;const ae=Tt.filter(De=>Hs(De,E)).concat(z);if(ae.length===0){ie.add(be(E));continue}let we=0;for(const De of ae)if(pt(De.parentItemType)==="collection")we+=await va(De.parentItemId,Q);else if(pt(De.parentCheckType)||pt(De.parentDirection)){const Ue=pt(De.parentCheckType),nt=pt(De.parentDirection),it=Jt(De.parentItemType,De.parentItemId,Ue,nt);we+=Q.get(it)??0}else{const Ue=`${De.parentItemType}:${De.parentItemId}`;we+=O.get(Ue)??0}we/ae.length>=Ot&&ie.add(be(E))}Yt(ie)},wa=d=>{for(let b=d;b<Ce.length;b+=1){const F=Ce[b];if(F&&(!wt||F.cardType!=="info"||kt.has(be(F))))return b}return-1},la=d=>!wt||d.cardType!=="info"||kt.has(be(d)),Da=d=>{if(p.id!=="temporal"&&p.id!=="levels")return null;const b=ht,F=(b.active??[]).concat(b.pool??[]),O=new Set;for(const Q of F){const z=be(Q);if(!(O.has(z)||d.has(z))&&(O.add(z),la(Q)))return Q}return null},qt=a.useMemo(()=>{if(p.id!=="levels")return null;const d=ht,b=d.pool??[],F=d.active??[],O=d.levelMap??{},Q=Math.max(1,Number(h.levels??1)),z=Array.from({length:Q},()=>0),ie=new Set(F.map(Fe=>be(Fe)));b.forEach(Fe=>{const De=Math.min(Q,Math.max(1,O[be(Fe)]??1));z[De-1]+=1});const E=b.length||1,ae=z.map(Fe=>Fe/E*100),we=c?O[be(c)]??1:null;return{counts:z,percentages:ae,currentLevel:we,levelsCount:Q,activeCount:F.length,poolCount:b.length,activeSet:ie}},[ht,h,p,c]),ja=a.useMemo(()=>{if(p.id!=="temporal")return null;const d=ht,b=d.pool??[],F=d.active??[],O=d.knownessMap??{},Q=new Set(d.unknownSet??[]);let z=0;b.forEach(ae=>{(O[be(ae)]??0)>1&&(z+=1)});const ie=Q.size,E=F.map(ae=>({id:be(ae),value:Q.has(be(ae))?0:Math.max(0,Math.min(1,O[be(ae)]??0))}));return{knownCount:z,unknownCount:ie,dots:E}},[ht,p]),hn=a.useMemo(()=>{if(!wt)return 0;const d=ht;return Ce.concat(d.active??[]).concat(d.pool??[]).filter((F,O,Q)=>Q.findIndex(z=>be(z)===be(F))===O).filter(F=>F.cardType==="info"&&!kt.has(be(F))).length},[wt,ht,Ce,kt]);a.useEffect(()=>{if(!wt||B!=="ready")return;const d=ht,F=Ce.concat(d.active??[]).concat(d.pool??[]).filter((z,ie,E)=>E.findIndex(ae=>be(ae)===be(z))===ie).filter(z=>z.cardType!=="info"||kt.has(be(z))).length,O=St.current;if(St.current=F,O===null||F<=O)return;const Q=F-O;yt(`New card available (+${Q})`),xt.current&&window.clearTimeout(xt.current),xt.current=window.setTimeout(()=>yt(null),2200)},[wt,B,ht,Ce,kt]),a.useEffect(()=>()=>{xt.current&&window.clearTimeout(xt.current)},[]);const Kt=(d,b)=>{const F=p.applyOutcome({queue:Ce,meta:ht},c,T,h,{correct:d,correctness:b,createdUtc:new Date().toISOString()});Z(F.queue),Lt(F.meta);const O=F.queue[X+1];O&&Ia(O,X+1)};a.useEffect(()=>{if(K&&y){on(o,y).then(d=>ve(d.name)).catch(()=>ve(t.cogita.library.collections.defaultName));return}if(V==="info"&&N){aa({libraryId:o,infoId:N}).then(d=>{const b=d.payload??{};ve(b.title||b.label||b.name||N)}).catch(()=>ve(N||t.cogita.library.revision.runKicker));return}if(V==="info-selection"){const d=W?es(o,W):null,b=(d==null?void 0:d.infoIds.length)??0;ve(b>0?`Selected infos (${b})`:"Selected infos");return}ve(t.cogita.library.collections.defaultName)},[t,K,y,o,V,N,W]),a.useEffect(()=>{Dn({libraryId:o,type:"language"}).then(d=>Le(d)).catch(()=>Le([]))},[o]),a.useEffect(()=>{K&&Fn({libraryId:o}).then(d=>Je(d.items??[])).catch(()=>Je([]))},[K,o]),a.useEffect(()=>{Tn(o,P)},[o,P]),a.useEffect(()=>{zt(Ce)},[Ce,Tt,wt,Ot,y]),a.useEffect(()=>{if(!c||!wt){se(!1);return}if(c.cardType!=="info"||kt.has(be(c))){se(!1);return}const d=wa(X+1);if(d>=0){se(!1),de(d);return}if(p.id==="temporal"||p.id==="levels"){const b=Ce.slice(0,X+1),F=Ce.slice(X+1).filter(la),O=b.concat(F),Q=new Set(O.map(be)),z=Da(Q);if(z){const E=be(z);Q.has(E)||(O.push(z),Q.add(E),Lt(ae=>{const we=ae,Fe=new Set(we.queued??[]);return Fe.add(E),{...we,queued:Fe}}))}const ie=O.findIndex((E,ae)=>ae!==X&&la(E));if(ie>=0){Z(O),de(ie),se(!1);return}}se(!0)},[c,kt,wt,X,Ce,ht,p.id]),a.useEffect(()=>{let d=!0;return(async()=>{ee("loading"),ye({current:0,total:p.id==="levels"?0:p.getFetchLimit(T,h)});try{if(!K){if(Je([]),V==="info"){if(!N){d&&(Z([]),Je([]),Lt({}),de(0),ee("ready"));return}const[De,Ue]=await Promise.all([Ua({libraryId:o,infoId:N}),qa({libraryId:o,infoId:N})]);if(!d)return;const nt=Ra(De.items??[]);Je(Ue.items??[]);const it=p.prepare(nt,T,h);Z(it.queue),Lt(it.meta),de(0),ee("ready"),ye({current:nt.length,total:nt.length});return}if(V==="info-selection"){const De=W?es(o,W):null,Ue=(De==null?void 0:De.infoIds)??[];if(!Ue.length){d&&(Z([]),Je([]),Lt({}),de(0),ee("ready"));return}const nt=await Promise.all(Ue.map(async da=>{const[_t,za]=await Promise.all([Ua({libraryId:o,infoId:da}),qa({libraryId:o,infoId:da})]);return{cards:_t.items??[],deps:za.items??[]}}));if(!d)return;const it=new Map;nt.forEach(da=>{Ra(da.cards).forEach(_t=>{it.set(be(_t),_t)})});const dt=Array.from(it.values()),ut=new Set(dt.map(be)),Rt=new Map;nt.forEach(da=>{(da.deps??[]).forEach(_t=>{const za=Jt(_t.parentItemType,_t.parentItemId,pt(_t.parentCheckType),pt(_t.parentDirection)),Jn=Jt(_t.childItemType,_t.childItemId,pt(_t.childCheckType),pt(_t.childDirection));if(!ut.has(za)||!ut.has(Jn))return;const Hn=`${za}->${Jn}`;Rt.has(Hn)||Rt.set(Hn,_t)})}),Je(Array.from(Rt.values()));const fa=p.prepare(dt,T,h);Z(fa.queue),Lt(fa.meta),de(0),ee("ready"),ye({current:dt.length,total:dt.length});return}}const F=[];let O=null,Q=null;do{const De=await Ja({libraryId:o,collectionId:y,limit:300,cursor:O});if(F.push(...De.items),(p.id==="levels"||p.id==="temporal")&&De.total&&(Q=De.total),ye(Ue=>({current:F.length,total:Ue.total||De.total||p.getFetchLimit(T,h)})),O=De.nextCursor??null,Q!==null&&F.length>=Q||p.id!=="levels"&&p.id!=="temporal"&&F.length>=p.getFetchLimit(T,h))break}while(O);if(!d)return;const z=Ra(F);let ie;if(p.id==="levels"){const De=Math.max(1,Number(h.levels??1)),nt=(await ta()).reduce((it,dt)=>{const ut=Jt(dt.itemType,dt.itemId,dt.checkType,dt.direction);return it[ut]||(it[ut]=[]),it[ut].push(dt),it},{});ie={},z.forEach(it=>{const dt=be(it),ut=nt[dt]??[],Rt=ut.length>0?ea(ut).score:0,fa=Math.max(1,Math.min(De,Math.ceil(Rt/100*De)));ie[dt]=fa})}let E=null,ae=null,we=null;if(p.id==="temporal"){const De=await ta(),Ue=new Set(z.map(dt=>be(dt))),nt=De.reduce((dt,ut)=>{const Rt=Jt(ut.itemType,ut.itemId,ut.checkType,ut.direction);return Ue.has(Rt)&&(dt[Rt]||(dt[Rt]=[]),dt[Rt].push(ut)),dt},{});E={},ae=new Set,we={};const it=Date.now();z.forEach(dt=>{const ut=be(dt),Rt=nt[ut]??[];if(Rt.length===0){E[ut]=0,ae.add(ut),we[ut]=[];return}const fa=Vn(Rt);we[ut]=fa;const da=ln(fa,it);E[ut]=da.knowness})}const Fe=p.id==="levels"?Un(z,T,h,ie):p.id==="temporal"?On(z,T,h,E??{},ae??new Set,we??{}):p.prepare(z,T,h);Z(Fe.queue),Lt(Fe.meta),de(0),ee("ready"),ye(De=>({current:Math.min(De.current,De.total),total:De.total}))}catch{d&&ee("error")}})(),()=>{d=!1}},[y,K,o,T,V,h,p,P,N,W]),a.useEffect(()=>{if(Ke(""),Ie(null),mt(null),tt(0),ke([]),Re({}),_({}),A(null),ne(null),U(null),st(!1),et(!1),Ge(null),H(null),Ne({}),!c){Qe(null),He(null),We(null),Xe(null);return}c.cardType==="info"&&c.infoType==="computed"&&Qe(t.cogita.library.revision.loadingComputed);let d=!0;return Ia(c,X).then(b=>{!d||!b||(Qe(b.prompt),He(b.expectedAnswer),ke(b.computedExpected),Re(b.computedAnswers),We(b.computedValues),A(b.answerTemplate),ne(b.outputVariables),U(b.variableValues))}),()=>{d=!1}},[c,t]),a.useEffect(()=>{if(!c||c.cardType!=="info"||c.infoType!=="citation"){x.current=null,Me.current=new Set,ot(null);return}const d=c.description??"",b=(c.label??"").trim(),F=b.replace(/\s+/g," ").trim(),O=d.replace(/\s+/g," ").trim(),Q=F&&F!==O?b:t.cogita.library.infoTypes.citation;if(!d){ot(null),He(null);return}const z=ya(d);x.current=z,Qe(Q);let ie=!0;return Fa().then(({fragmentKnowness:E})=>{if(!ie)return;const ae=new Set,we={};E.forEach((Ue,nt)=>{const[it,dt]=nt.split(":",2);if(it!==c.cardId)return;const ut=Vt(dt);if(!ut)return;const{fragmentId:Rt}=ut;we[Rt]=Ue,Ue>=Ot&&ae.add(Rt)}),Me.current=ae,Be.current=we;const Fe=Vt(c.direction);if(Fe!=null&&Fe.fragmentId&&z.nodes[Fe.fragmentId]){pa(z,Fe.fragmentId,Q);return}const De=Ta(z,ae,we,Ot,wt,c.direction);pa(z,(De==null?void 0:De.id)??null,Q)}).catch(()=>{Me.current=new Set,Be.current={};const E=Vt(c.direction);if(E!=null&&E.fragmentId&&z.nodes[E.fragmentId]){pa(z,E.fragmentId,Q);return}const ae=Ta(z,Me.current,{},Ot,wt,c.direction);pa(z,(ae==null?void 0:ae.id)??null,Q)}),()=>{ie=!1}},[c,t,wt,Ot]),a.useEffect(()=>{if(!c||c.cardType!=="vocab"||c.checkType!=="translation-match"){H(null),Ne({});return}const F=(ht.pool??ht.active??Ce).filter(E=>E.cardType==="vocab"&&E.checkType==="translation-match").filter((E,ae,we)=>we.findIndex(Fe=>Fe.cardId===E.cardId)===ae);F.some(E=>E.cardId===c.cardId)||F.unshift(c);const Q=Ka(F).slice(0,6).map(E=>{const ae=E.label.split("↔").map(De=>De.trim()).filter(Boolean);if(ae.length<2)return null;const we=`${E.cardId}:L`,Fe=`${E.cardId}:R`;return{cardId:E.cardId,leftId:we,rightId:Fe,leftLabel:ae[0],rightLabel:ae[1]}}).filter(Boolean),z=Q.map(E=>E.leftId),ie=Ka(Q.map(E=>E.rightId));H({pairs:Q,leftOrder:z,rightOrder:ie,selection:{},activeLeft:null,activeRight:null,locked:{}})},[c,Ce,ht]),a.useEffect(()=>()=>{ue.current&&window.clearTimeout(ue.current),oe.current&&window.clearTimeout(oe.current)},[]);const Bt=a.useRef(null);a.useEffect(()=>{if(!c)return;const d=be(c),b=typeof document<"u"?document.activeElement:null;if(Bt.current===d&&b&&(b.tagName==="INPUT"||b.tagName==="TEXTAREA"))return;let F=0;const O=()=>{if(c){if(c.cardType==="info"&&c.infoType==="computed"){if(ze.length>0){const z=an(R,ze,Y),ie=z?Dt.current[z]:null;if(ie&&(ie.focus(),document.activeElement===ie)){Bt.current=d;return}}if(Mt.current&&(Mt.current.focus(),document.activeElement===Mt.current)){Bt.current=d;return}}else if(c.cardType==="vocab"&&Mt.current&&(Mt.current.focus(),document.activeElement===Mt.current)){Bt.current=d;return}F<6&&(F+=1,window.setTimeout(O,40))}},Q=window.setTimeout(O,40);return()=>window.clearTimeout(Q)},[c,ze,R,Y]),a.useEffect(()=>{if(!ft)return;const d=b=>{b.key==="Enter"&&(b.preventDefault(),ma())};return window.addEventListener("keydown",d),()=>window.removeEventListener("keydown",d)},[ft]);const ka=d=>{bt(d),Xe(ea(d))};a.useEffect(()=>{if(!c){Xe(null),bt([]);return}const d=c.cardType==="info"?"info":"connection";if(c.cardType==="info"&&c.infoType==="citation"){ta().then(b=>{const F=b.filter(O=>O.itemType==="info"&&O.itemId===c.cardId&&O.checkType==="quote-fragment"&&en(O.direction,c.direction));ka(F)}).catch(()=>{Xe(null),bt([])});return}Za(d,c.cardId,c.checkType,c.direction).then(b=>ka(b)).catch(()=>{Xe(null),bt([])})},[o,c,P]);const Na=(d,b,F,O)=>{if(d==="info"&&F==="quote-fragment"){ta().then(Q=>{const z=Q.filter(ie=>ie.itemType==="info"&&ie.itemId===b&&ie.checkType==="quote-fragment"&&en(ie.direction,O));ka(z)}).catch(()=>{Xe(null),bt([])});return}Za(d,b,F,O).then(Q=>ka(Q)).catch(()=>{Xe(null),bt([])})},ca=(d,b,F)=>{var ie;const O=((ie=F.pairs.find(E=>E.leftId===d))==null?void 0:ie.rightId)??null;if(!O)return F;const Q=O===b;Ne(E=>({...E,[d]:Q?"correct":"incorrect"})),ue.current&&window.clearTimeout(ue.current),oe.current&&window.clearTimeout(oe.current),Ee.current+=1;const z={kind:Q?"correct":"incorrect",tick:Ee.current};if(je(null),ue.current=window.setTimeout(()=>je(z),0),oe.current=window.setTimeout(()=>je(null),420),Q){const E={...F.locked,[d]:!0};return Object.keys(E).length>=F.pairs.length?(Ie("correct"),et(!0)):Ie("correct"),{...F,selection:{...F.selection,[d]:b},activeLeft:null,activeRight:null,locked:E}}return Ie("incorrect"),{...F,activeLeft:null,activeRight:null}},gn=d=>{H(b=>!b||b.locked[d]?b:b.activeRight?ca(d,b.activeRight,b):{...b,activeLeft:b.activeLeft===d?null:d})},Sa=d=>{H(b=>b&&(b.activeLeft?ca(b.activeLeft,d,b):{...b,activeRight:b.activeRight===d?null:d}))},ma=()=>{var d;if(c&&c.cardType==="info"&&c.infoType==="citation"&&x.current&&rt&&!((d=Vt(c.direction))!=null&&d.fragmentId)){const b=Ta(x.current,Me.current,Be.current,Ot,wt,c.direction,rt.fragmentId);if(b){Ie(null),Ke(""),st(!1),_({}),et(!1),mt(null),tt(0),pa(x.current,b.id,rt.title);return}}Ie(null),Ke(""),st(!1),_({}),et(!1),mt(null),tt(0),de(b=>Math.min(b+1,Ce.length))},Gt=d=>{if(!c)return;const b=d.expected??null,F=d.answer??"";let O=b??"",Q=F;if(!b&&d.expectedMap&&d.answerMap){const De=Object.keys(d.expectedMap).sort((Ue,nt)=>Ue.localeCompare(nt));O=De.map(Ue=>{var nt;return((nt=d.expectedMap)==null?void 0:nt[Ue])??""}).join("|"),Q=De.map(Ue=>{var nt;return((nt=d.answerMap)==null?void 0:nt[Ue])??""}).join("|")}const z=O?Ca(O,Q,ra):new Uint8Array,ie={revisionType:p.id,evalType:d.evalType,direction:d.direction,prompt:qe??"",expected:b,answer:F,expectedAnswers:d.expectedMap??null,answers:d.answerMap??null,correct:d.correct,maskBase64:z.length?ha(z):null,values:fe??null,checkMode:ce,compareMode:ra,minCorrectness:$t},E=new TextEncoder().encode(JSON.stringify(ie)),ae=c.cardType==="info"?"info":"connection",we=d.overrideCheckType??c.checkType??null,Fe=d.overrideDirection??c.direction??null;Xa({itemType:ae,itemId:c.cardId,checkType:we,direction:Fe,revisionType:p.id,evalType:d.evalType,correct:d.correct,maskBase64:z.length?ha(z):null,payloadBase64:ha(E),personRoleId:P??null}).then(()=>{Na(ae,c.cardId,we,Fe),zt(Ce),Tn(o,P)}).catch(()=>{})},mn=(d,b)=>{const F=Se.current.get(b);if(F)return Promise.resolve(F);const O=at.current.get(b);if(O)return O;const Q=aa({libraryId:o,infoId:d}).then(z=>{var De,Ue;const ie=z.payload,E=((De=ie.definition)==null?void 0:De.graph)??null,ae="",we=((Ue=ie.definition)==null?void 0:Ue.answerTemplate)??"",Fe=Vs(E,ae,we);if(Fe){const it={sample:Os(Fe),answerTemplate:we||null};return Se.current.set(b,it),it}return Yn({libraryId:o,infoId:d}).then(nt=>{const it={sample:nt,answerTemplate:null};return Se.current.set(b,it),it})}).catch(()=>Yn({libraryId:o,infoId:d}).then(z=>{const ie={sample:z,answerTemplate:null};return Se.current.set(b,ie),ie}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{at.current.delete(b)});return at.current.set(b,Q),Q},Ia=(d,b)=>{var E;const F=`${be(d)}:${b}`,O=ct.current.get(F);if(O)return Promise.resolve(O);const Q=Ct.current.get(F);if(Q)return Q;const z=ae=>(ct.current.set(F,ae),ae);let ie;if(d.cardType==="vocab"){if(d.checkType==="translation-match")return ie=Promise.resolve(z({prompt:d.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),ie;const ae=d.label.split("↔").map(we=>we.trim()).filter(Boolean);if(ae.length>=2){const Fe=(d.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",De=Fe?ae[0]:ae[1],Ue=Fe?ae[1]:ae[0];ie=Promise.resolve(z({prompt:De,expectedAnswer:Ue,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else ie=Promise.resolve(z({prompt:d.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(d.cardType==="info"&&d.infoType==="word"){const ae=(E=d.description)!=null&&E.startsWith("Language: ")?d.description.replace("Language: ",""):null;ie=Promise.resolve(z({prompt:d.label,expectedAnswer:ae,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else d.cardType==="info"&&d.infoType==="computed"?ie=mn(d.cardId,F).then(ae=>{var nt,it;if(!ae.sample)return z({prompt:d.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const we=ae.sample,Fe=we.expectedAnswers?Object.entries(we.expectedAnswers).map(([dt,ut])=>({key:dt,expected:ut})):[],De=Fe.reduce((dt,ut)=>(dt[ut.key]="",dt),{}),Ue=we.expectedAnswerIsSentence&&((nt=we.expectedAnswer)==null?void 0:nt.trim())||null;return z({prompt:we.prompt,expectedAnswer:Fe.length>0?Ue:((it=we.expectedAnswer)==null?void 0:it.trim())||null,computedExpected:Fe,computedAnswers:De,computedValues:we.values??null,answerTemplate:ae.answerTemplate,outputVariables:we.outputVariables??null,variableValues:we.variableValues??null})}).catch(()=>z({prompt:d.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Ct.current.delete(F)}):ie=Promise.resolve(z({prompt:d.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return Ct.current.set(F,ie),ie},pa=(d,b,F)=>{const O=Object.keys(d.nodes).length,Q=Me.current.size;if(!b){ot({title:F,before:d.text,after:"",fragmentId:null,total:O,completed:Q}),He(null),et(!0);return}const z=d.nodes[b];if(!z)return;const ie=zn(d.text,z);ot({title:F,before:ie.before,after:ie.after,fragmentId:z.id,total:O,completed:Q}),He(ie.fragment),et(!1)},pn=()=>{const d=x.current;d&&ot(b=>b&&{...b,total:Object.keys(d.nodes).length,completed:Me.current.size})},Qt=()=>{const d=Ce[X+1];d&&Ia(d,X+1)},L=()=>{if(Qt(),c&&c.cardType==="vocab"&&c.checkType==="translation-match"&&$){if($.pairs.length===0){Ie("incorrect"),et(!0);return}const z=$.pairs.reduce((Ue,nt)=>(Ue[nt.rightId]=nt.rightLabel,Ue),{});let ie=0;const E={};$.pairs.forEach(Ue=>{const it=$.selection[Ue.leftId]===Ue.rightId;E[Ue.leftId]=it?"correct":"incorrect",it&&(ie+=1)});const ae=$.pairs.length||1,we=ie/ae,Fe=ie===$.pairs.length;Ne(Ue=>({...Ue,...E})),Fe?(Ie("correct"),et(!0),tt(0)):(Ie("incorrect"),et(!1),tt(Ue=>{const nt=Ue+1;return nt>=Nt&&(st(!0),et(!0),H(it=>{if(!it)return it;const dt=it.pairs.reduce((ut,Rt)=>(ut[Rt.leftId]=Rt.rightId,ut),{});return{...it,selection:dt}})),nt})),Kt(Fe,we);const De="connection";Promise.all($.pairs.map(Ue=>{const nt=$.selection[Ue.leftId]??null,it=nt?z[nt]:"",dt={left:Ue.leftLabel,expected:Ue.rightLabel,answer:it,checkType:"translation-match"},ut=new TextEncoder().encode(JSON.stringify(dt));return Xa({itemType:De,itemId:Ue.cardId,checkType:"translation-match",direction:null,revisionType:p.id,evalType:"translation-match",correct:nt===Ue.rightId,maskBase64:null,payloadBase64:ha(ut),personRoleId:P??null})})).then(()=>{Na(De,c.cardId,c.checkType,c.direction),Tn(o,P)}).catch(()=>{});return}if(ze.length>0){const z=ze.reduce((E,ae)=>{const we=J[ae.key]??"";return E[ae.key]=Ft(we)===Ft(ae.expected)?"correct":"incorrect",E},{});ze.every(({key:E,expected:ae})=>{const we=J[E]??"";return ce==="exact"&&Ft(we)===Ft(ae)})?(Ie("correct"),_(z),et(!0),tt(0),Kt(!0,1),Gt({correct:!0,direction:qe?`${qe} -> computed`:"computed",expectedMap:ze.reduce((E,ae)=>(E[ae.key]=ae.expected,E),{}),answerMap:J,evalType:"computed"})):(Ie("incorrect"),_(z),et(!1),tt(E=>{const ae=E+1;return ae>=Nt&&Te&&(st(!0),et(!0)),ae}),Kt(!1,0),window.setTimeout(()=>{var ae;const E=an(R,ze,Y);E&&Dt.current[E]&&((ae=Dt.current[E])==null||ae.focus())},40),Gt({correct:!1,direction:qe?`${qe} -> computed`:"computed",expectedMap:ze.reduce((E,ae)=>(E[ae.key]=ae.expected,E),{}),answerMap:J,evalType:"computed"}));return}if(c&&c.cardType==="info"&&c.infoType==="citation"&&(rt!=null&&rt.fragmentId)){if(!$e)return;const z=Vt(c.direction),ie=(z==null?void 0:z.fragmentId)??rt.fragmentId,E=Ya($e,xe,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),ae=E.mask,we=E.isCorrect,Fe=E.percent;we?(Be.current[rt.fragmentId]=Math.max(Be.current[rt.fragmentId]??0,Fe),(Be.current[rt.fragmentId]??0)>=Ot&&Me.current.add(rt.fragmentId),pn(),Ie("correct"),_({}),et(!0),mt(ae),tt(0),Fe<100&&Nt<=1&&st(!0),Kt(!0,Fe/100),Gt({correct:!0,direction:`quote:${rt.fragmentId}`,expected:$e,answer:xe,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:ie})):(Ie("incorrect"),_({}),et(!1),mt(ae),tt(De=>{const Ue=De+1;return Ue>=Nt&&Te&&(st(!0),et(!0)),Ue}),Kt(!1,Fe/100),window.setTimeout(()=>{var De;return(De=Mt.current)==null?void 0:De.focus()},40),Gt({correct:!1,direction:`quote:${rt.fragmentId}`,expected:$e,answer:xe,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:ie}));return}if(!$e)return;const d=Ca($e,xe,ra),b=ce==="exact"&&Ft(xe)===Ft($e),F=xa(d),O=b||F,Q=ga(d);O?(Ie("correct"),_({}),et(!0),mt(d),tt(0),Q<100&&Nt<=1&&st(!0),Kt(!0,Q/100),Gt({correct:!0,direction:qe?`${qe} -> ${$e}`:null,expected:$e,answer:xe,evalType:"text"})):(Ie("incorrect"),_({}),et(!1),mt(d),tt(z=>{const ie=z+1;return ie>=Nt&&Te&&(st(!0),et(!0)),ie}),Kt(!1,Q/100),window.setTimeout(()=>{var z;return(z=Mt.current)==null?void 0:z.focus()},40),Gt({correct:!1,direction:qe?`${qe} -> ${$e}`:null,expected:$e,answer:xe,evalType:"text"}))},G=d=>{if(Qt(),!$e)return;const b=Ca($e,d,ra),F=Ft(d)===Ft($e),O=xa(b),Q=F||O,z=ga(b);Q?(Ie("correct"),_({}),et(!0),mt(b),tt(0),z<100&&Nt<=1&&st(!0),Kt(!0,z/100),Gt({correct:!0,direction:"word->language",expected:$e,answer:d,evalType:"language-select"})):(Ie("incorrect"),_({}),et(!1),mt(b),tt(ie=>{const E=ie+1;return E>=Nt&&Te&&(st(!0),et(!0)),E}),Kt(!1,z/100),Gt({correct:!1,direction:"word->language",expected:$e,answer:d,evalType:"language-select"}))},me=()=>{Qt(),Ie("correct"),et(!0),tt(0),Kt(!0,1),$e&&Gt({correct:!0,direction:"manual",expected:$e,answer:xe,evalType:"manual"})},Ae=()=>{if(Kt(!1,0),c&&c.cardType==="info"&&c.infoType==="citation"){Ie(null),Ke(""),st(!1),_({}),et(!1),mt(null),tt(0),de(d=>Math.min(d+1,Ce.length));return}ma()};a.useEffect(()=>{Qt()},[X,Ce]);const Pe=d=>{var F;if(d.key!=="Enter")return;if(d.preventDefault(),d.stopPropagation(),ft){ma();return}const b=ze.find(O=>!(J[O.key]??"").trim());if(b){(F=Dt.current[b.key])==null||F.focus();return}L()},ge=t.cogita.library.revision.revealModeAfterIncorrect,Te=ze.length>0||!!$e;return e.jsxs(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:[B==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${q.total?Math.min(100,Math.max(0,q.current/q.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:q.total?`${Math.min(q.current,q.total)} / ${q.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:le}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",I).replace("{check}",he)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),K?e.jsxs(e.Fragment,{children:[e.jsx("a",{className:"cta ghost",href:`${v}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${v}/collections/${y}`,children:t.cogita.library.actions.collectionDetail})]}):e.jsx("a",{className:"cta ghost",href:`${v}/list`,children:t.cogita.library.actions.allCards})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:jt?`${jt.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[qt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",qt.currentLevel??"-"," / ",qt.levelsCount]}):null,jt?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(jt.correct)).replace("{total}",String(jt.total))}),jt.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(jt.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(Us,{outcomes:lt})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[It?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:It})}):null,e.jsx(Bn,{feedbackToken:Ve?`${Ve.kind}-${Ve.tick}`:pe?"idle":_e??"idle",children:c?e.jsx(e.Fragment,{children:ia?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(_n,{copy:t,currentCard:c,currentTypeLabel:Et,prompt:qe,languages:C,answer:xe,onAnswerChange:d=>Ke(b=>tn(b,d,Ye)),computedExpected:ze,computedAnswers:J,onComputedAnswerChange:(d,b)=>Re(F=>({...F,[d]:tn(F[d]??"",b,Ye)})),answerTemplate:R,outputVariables:Y,variableValues:S,computedFieldFeedback:re,feedback:_e,canAdvance:ft,quoteContext:rt,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:L,onSkip:Ae,onLanguageSelect:G,onMarkReviewed:me,onAdvance:ma,showCorrectAnswer:Oe,setShowCorrectAnswer:st,onRevealCorrect:()=>et(!0),answerMask:sa,expectedAnswer:$e,hasExpectedAnswer:Te,handleComputedKeyDown:Pe,answerInputRef:Mt,computedInputRefs:Dt,scriptMode:Ye,setScriptMode:Ge,matchPairs:$==null?void 0:$.pairs,matchLeftOrder:$==null?void 0:$.leftOrder,matchRightOrder:$==null?void 0:$.rightOrder,matchSelection:$==null?void 0:$.selection,matchActiveLeft:$==null?void 0:$.activeLeft,matchActiveRight:$==null?void 0:$.activeRight,matchFeedback:te,onMatchLeftSelect:gn,onMatchRightSelect:Sa})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:K?`${v}/collections/${y}`:`${v}/list`,children:K?t.cogita.library.actions.collectionDetail:t.cogita.library.actions.allCards})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Ht?`${vt} / ${Ht}`:t.cogita.library.revision.progressUnlimited}),B==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),B==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),B==="ready"&&Ce.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:ge}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",Nt]})]})]}),qt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",qt.activeCount," / ",qt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:qt.counts.map((d,b)=>{const F=b+1,O=qt.currentLevel===F,Q=qt.percentages[b]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":O,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:F}),e.jsx("strong",{children:d})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,Q))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[Q.toFixed(1),"%"]})]},`level-${F}`)})})]}):null,ja?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:ja.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:ja.dots.map(d=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,d.value*100))}%`,background:`rgba(${Math.round(255*(1-d.value))}, ${Math.round(200*d.value)}, 80, 0.9)`}},d.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:ja.knownCount})]})]}):null,wt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:hn})]})}):null]})]})]})})})]})]})}const Cn=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],Kr={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},Fr=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Dr=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function zr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:o,collectionId:y}){const[l,u]=a.useState(""),[v,w,T]=En([]),[D,p,h]=Pn([]),[ce,P]=a.useState(null),[f,V]=a.useState(null),[N,W]=a.useState(null),K=`/#/cogita/library/${o}`;a.useEffect(()=>{on(o,y).then(C=>u(C.name)).catch(()=>u(t.cogita.library.collections.defaultName))},[o,y,t]),a.useEffect(()=>{mi({libraryId:o,collectionId:y}).then(C=>{if(!C.graphId||C.graphId==="00000000-0000-0000-0000-000000000000"){w([]),p([]);return}const Le=C.nodes.map(ee=>{var de;const q=ee.payload??{},ye=q.position??{x:120,y:120},X=q.params??{};return{id:ee.nodeId,type:"default",position:ye,data:{nodeType:ee.nodeType,label:((de=Cn.find(xe=>xe.type===ee.nodeType))==null?void 0:de.label)??ee.nodeType,params:X}}}),B=C.edges.map(ee=>({id:ee.edgeId,source:ee.fromNodeId,target:ee.toNodeId,sourceHandle:ee.fromPort??void 0,targetHandle:ee.toPort??void 0}));w(Le),p(B)}).catch(()=>{w([]),p([])})},[o,y,p,w]);const I=a.useMemo(()=>v.find(C=>C.id===ce)??null,[v,ce]),he=C=>{var q;const Le=crypto.randomUUID(),B=((q=Cn.find(ye=>ye.type===C))==null?void 0:q.label)??C,ee={...Kr[C]};w(ye=>[...ye,{id:Le,type:"default",position:{x:120+ye.length*40,y:120+ye.length*40},data:{nodeType:C,label:B,params:ee}}]),P(Le)},le=a.useCallback(C=>{p(Le=>Kn({...C,id:crypto.randomUUID()},Le))},[p]),ve=async()=>{V(null);try{await As({libraryId:o,collectionId:y,nodes:v.map(C=>({nodeId:C.id,nodeType:C.data.nodeType,payload:{position:C.position,params:C.data.params}})),edges:D.map(C=>({edgeId:C.id,fromNodeId:C.source,fromPort:C.sourceHandle??null,toNodeId:C.target,toPort:C.targetHandle??null}))}),V(t.cogita.library.graph.saveSuccess)}catch{V(t.cogita.library.graph.saveFail)}},Ce=async()=>{try{const C=await pi({libraryId:o,collectionId:y});W(C)}catch{W(null)}},Z=C=>{I&&w(Le=>Le.map(B=>B.id===I.id?{...B,data:{...B.data,params:C}}:B))};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${K}/collections/${y}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Ce,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:ve,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Cn.map(C=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>he(C.type),children:C.label},C.type))}),f?e.jsx("p",{className:"cogita-help",children:f}):null,N&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(N.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(N.connections)).replace("{infos}",String(N.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(nn,{nodes:v,edges:D,onNodesChange:T,onEdgesChange:h,onConnect:le,onNodeClick:(C,Le)=>P(Le.id),fitView:!0,children:[e.jsx(sn,{color:"rgba(120,160,200,0.2)"}),e.jsx(rn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),I?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:I.data.label}),I.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Ut,{libraryId:o,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:I.data.params.tagId?{id:I.data.params.tagId,label:I.data.params.tagLabel??"",infoType:"topic"}:null,onChange:C=>Z({...I.data.params,tagId:(C==null?void 0:C.id)??null,tagLabel:(C==null?void 0:C.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:I.data.params.scope??"any",onChange:C=>Z({...I.data.params,scope:C.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),I.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Ut,{libraryId:o,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:I.data.params.languageId?{id:I.data.params.languageId,label:I.data.params.languageLabel??"",infoType:"language"}:null,onChange:C=>Z({...I.data.params,languageId:(C==null?void 0:C.id)??null,languageLabel:(C==null?void 0:C.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:I.data.params.scope??"any",onChange:C=>Z({...I.data.params,scope:C.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),I.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:I.data.params.infoType??"word",onChange:C=>Z({...I.data.params,infoType:C.target.value}),children:Dr.map(C=>e.jsx("option",{value:C.value,children:C.label},C.value))})]}),e.jsx(Ut,{libraryId:o,infoType:I.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:I.data.params.infoId?{id:I.data.params.infoId,label:I.data.params.infoLabel??"",infoType:I.data.params.infoType??"word"}:null,onChange:C=>Z({...I.data.params,infoId:(C==null?void 0:C.id)??null,infoLabel:(C==null?void 0:C.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),I.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:I.data.params.connectionType??"translation",onChange:C=>Z({...I.data.params,connectionType:C.target.value}),children:Fr.map(C=>e.jsx("option",{value:C.value,children:C.label},C.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:I.data.params.connectionId??"",onChange:C=>Z({...I.data.params,connectionId:C.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(I.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const In="cogita.preferences",Mn="cogita.reviewer.preferences",Ws=["library_overview","all_cards","all_collections","all_revisions","storyboards","texts","dependencies","transfer"],Ln={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},all_revisions:{requiresCollection:!0,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},Br=["settings","run","shared"];function _r(t,n=""){const s=t.split("/").filter(Boolean);if(s[0]!=="cogita"||s[1]!=="library")return{};const i=s[2];if(!i)return{};if(!s[3])return{libraryId:i,target:"library_overview"};const r=new URLSearchParams(n),g=r.get("revisionId")??void 0,m=r.get("infoId")??void 0,k=r.get("infoView"),j=k==="cards"?"cards":k==="collections"?"collections":"overview",M=r.get("collectionView")==="overview"?"overview":"infos",o=r.get("collectionAction"),y=r.get("libraryAction"),u=r.get("libraryTarget")==="revisions"?"all_revisions":"all_collections";if(s[3]==="list")return{libraryId:i,target:y==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:g,infoId:m,infoView:j,libraryAction:y==="new-info"?"new-info":void 0};if(s[3]==="detail"||s[3]==="collection")return{libraryId:i,target:"all_cards",cardMode:s[3],revisionId:g,infoId:m,infoView:j};if(s[3]==="new"||s[3]==="add")return{libraryId:i,target:"new_card",revisionId:g,libraryAction:"new-info"};if(s[3]==="edit")return{libraryId:i,target:"new_card",revisionId:g,infoId:s[4]};if(s[3]==="infos"){const w=s[4];return w?s[5]==="checkcards"?{libraryId:i,target:"all_cards",cardMode:"list",revisionId:g,infoId:w,infoView:"cards"}:s[5]==="collections"?{libraryId:i,target:"all_cards",cardMode:"list",revisionId:g,infoId:w,infoView:"collections"}:{libraryId:i,target:"all_cards",cardMode:"list",revisionId:g,infoId:w,infoView:"overview"}:{libraryId:i,target:"all_cards",cardMode:"list",revisionId:g}}if(s[3]==="shared-revisions")return{libraryId:i,target:u,revisionId:g};if(s[3]==="revision"&&s[4]==="run")return{libraryId:i,target:u,revisionView:"run",revisionId:g,infoId:m,infoView:j};if(s[3]==="dependencies")return{libraryId:i,target:"dependencies"};if(s[3]==="transfer")return{libraryId:i,target:"transfer"};if(s[3]==="storyboards")return s[4]==="new"?{libraryId:i,target:"new_storyboard"}:{libraryId:i,target:"storyboards"};if(s[3]==="texts")return s[4]==="new"?{libraryId:i,target:"new_text"}:{libraryId:i,target:"texts"};if(s[3]!=="collections")return{libraryId:i,target:"library_overview"};if(s[4]==="new")return{libraryId:i,target:"new_collection",revisionId:g};const v=s[4];return v?s[5]==="graph"?{libraryId:i,target:u,collectionId:v,revisionId:g,revisionView:"graph"}:s[5]==="shared-revisions"?{libraryId:i,target:u,collectionId:v,revisionId:g,revisionView:"shared"}:s[5]==="revision"?{libraryId:i,target:u,collectionId:v,revisionId:g,revisionView:s[6]==="run"?"run":"settings",collectionView:M}:o==="new-revision"?{libraryId:i,target:u,collectionId:v,revisionId:g,revisionView:"new"}:{libraryId:i,target:u,collectionId:v,revisionId:g,revisionView:"detail",collectionView:M}:o==="new-collection"?{libraryId:i,target:"new_collection",collectionAction:"new-collection"}:{libraryId:i,target:u}}function ks(t,n="library_overview",s,i,r,g,m="overview",k="infos"){const j=(M,o)=>{const y=new URLSearchParams;o!=null&&o.revisionId&&y.set("revisionId",o.revisionId),o!=null&&o.collectionAction&&y.set("collectionAction",o.collectionAction),o!=null&&o.libraryAction&&y.set("libraryAction",o.libraryAction),o!=null&&o.libraryTarget&&y.set("libraryTarget",o.libraryTarget),o!=null&&o.infoId&&y.set("infoId",o.infoId),o!=null&&o.infoView&&(o!=null&&o.infoId)&&y.set("infoView",o.infoView),o!=null&&o.collectionView&&o.collectionView!=="infos"&&y.set("collectionView",o.collectionView);const l=y.toString();return l?`${M}?${l}`:M};if(!t)return"/cogita";if(n==="library_overview")return j(`/cogita/library/${t}`,{revisionId:r});if(n==="all_cards")return g?m==="cards"?j(`/cogita/library/${t}/infos/${g}/checkcards`,{revisionId:r}):m==="collections"?j(`/cogita/library/${t}/infos/${g}/collections`,{revisionId:r}):j(`/cogita/library/${t}/infos/${g}`,{revisionId:r}):j(`/cogita/library/${t}/list`,{revisionId:r,infoId:g,infoView:m});if(n==="new_card")return g?j(`/cogita/library/${t}/edit/${g}`,{revisionId:r}):j(`/cogita/library/${t}/list`,{revisionId:r,libraryAction:"new-info"});if(n==="all_collections"||n==="all_revisions"){const M=n==="all_revisions"?"revisions":void 0;return!s&&i==="run"?j(`/cogita/library/${t}/revision/run`,{revisionId:r,libraryTarget:M}):s?i==="graph"?j(`/cogita/library/${t}/collections/${s}/graph`,{revisionId:r,libraryTarget:M}):i==="settings"?j(`/cogita/library/${t}/collections/${s}/revision`,{revisionId:r,libraryTarget:M}):i==="run"?j(`/cogita/library/${t}/collections/${s}/revision/run`,{revisionId:r,libraryTarget:M}):i==="shared"?j(`/cogita/library/${t}/collections/${s}/shared-revisions`,{revisionId:r,libraryTarget:M}):i==="new"?j(`/cogita/library/${t}/collections/${s}`,{revisionId:r,libraryTarget:M,collectionAction:"new-revision"}):j(`/cogita/library/${t}/collections/${s}`,{revisionId:r,libraryTarget:M,collectionView:k}):j(`/cogita/library/${t}/collections`,{revisionId:r,libraryTarget:M})}return n==="new_collection"?j(`/cogita/library/${t}/collections`,{revisionId:r,collectionAction:"new-collection"}):n==="transfer"?j(`/cogita/library/${t}/transfer`,{revisionId:r}):n==="storyboards"?j(`/cogita/library/${t}/storyboards`,{revisionId:r}):n==="new_storyboard"?j(`/cogita/library/${t}/storyboards/new`,{revisionId:r}):n==="texts"?j(`/cogita/library/${t}/texts`,{revisionId:r}):n==="new_text"?j(`/cogita/library/${t}/texts/new`,{revisionId:r}):n==="dependencies"?j(`/cogita/library/${t}/dependencies`,{revisionId:r}):j(`/cogita/library/${t}`,{revisionId:r})}function ua(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function Vr(t){return typeof t=="string"&&Ws.includes(t)}function Or(t,n){var k;if(!t.length)return null;const s=t.filter(j=>n.has(j.roleId)),i=s.length>0?s:t,r=i.map(j=>{var o,y;const M=((y=(o=j.fields.find(l=>l.fieldType==="role_kind"))==null?void 0:o.plainValue)==null?void 0:y.toLowerCase())??"";return{roleId:j.roleId,roleKind:M}}),g=r.find(j=>j.roleKind.includes("master"));if(g)return g.roleId;const m=r.find(j=>j.roleKind.includes("account")||j.roleKind.includes("user"));return m?m.roleId:((k=i[0])==null?void 0:k.roleId)??null}function Ur(t){if(!t)return{version:1,byLibrary:{}};try{const n=JSON.parse(t);return!n||typeof n!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:n.lastLibraryId,byLibrary:n.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function qr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M}){const o=An(),y=Ea(),l=a.useMemo(()=>_r(y.pathname,y.search),[y.pathname,y.search]),u=t.cogita.workspace,[v,w]=a.useState([]),[T,D]=a.useState([]),[p,h]=a.useState([]),[ce,P]=a.useState([]),[f,V]=a.useState(void 0),[N,W]=a.useState("library_overview"),[K,I]=a.useState(void 0),[he,le]=a.useState(void 0),[ve,Ce]=a.useState("detail"),[Z,C]=a.useState(void 0),[Le,B]=a.useState(!1),[ee,q]=a.useState(!0),[ye,X]=a.useState(!1),[de,xe]=a.useState(!1),[Ke,_e]=a.useState(null),[Ie,qe]=a.useState(0),[Qe,$e]=a.useState(""),[He,rt]=a.useState(""),[ot,ze]=a.useState(""),[ke,J]=a.useState([]),[Re,re]=a.useState(""),[_,fe]=a.useState(0),[We,R]=a.useState(null),[A,Y]=a.useState(null),ne=a.useRef({version:1,byLibrary:{}}),S=a.useRef(!1),U=a.useRef(!1),$=a.useRef(null),H=a.useMemo(()=>v.find(x=>x.libraryId===f)??null,[v,f]),te=a.useMemo(()=>T.find(x=>x.collectionId===K)??null,[T,K]),Ne=ua(y.pathname)==="/cogita/persons";a.useEffect(()=>{if(!f){J([]),re("");return}let x=!1;return Es({libraryId:f}).then(Me=>{if(x)return;const Be=Me.filter(c=>(c.roleKind??"").trim().toLowerCase()==="person");J(Be);try{const c=window.localStorage.getItem(Mn),Se=(c?JSON.parse(c):{})[f]??"",at=Se&&Be.some(ct=>ct.roleId===Se)?Se:"";re(at)}catch{re("")}}).catch(()=>{x||(J([]),re(""))}),()=>{x=!0}},[f,_]),a.useEffect(()=>{if(f)try{const x=window.localStorage.getItem(Mn),Me=x?JSON.parse(x):{};Re?Me[f]=Re:delete Me[f],window.localStorage.setItem(Mn,JSON.stringify(Me))}catch{}},[f,Re]);const Ee=a.useMemo(()=>ce.find(x=>x.revisionId===he)??null,[ce,he]),Ve=a.useMemo(()=>({detail:u.revisions.detail,graph:u.revisions.graph,settings:u.revisions.settings,run:u.revisions.run,shared:u.targets.sharedRevisions,new:u.revisionForm.createAction}),[u.revisions.detail,u.revisions.graph,u.revisions.run,u.revisions.settings,u.targets.sharedRevisions,u.revisionForm.createAction]),je=a.useMemo(()=>N==="new_card"?"all_cards":N==="new_collection"?"all_collections":N==="new_storyboard"?"storyboards":N==="new_text"?"texts":N,[N]),ue=a.useMemo(()=>ve==="new"?"settings":ve,[ve]),oe=N==="all_collections"||N==="all_revisions",Ye=a.useMemo(()=>N==="new_collection"?"create":oe&&K?"selected":"search",[oe,K,N]),Ge=a.useMemo(()=>l.infoId?"selected":N==="new_card"?"create":"search",[l.infoId,N]),Oe=a.useMemo(()=>p.find(x=>x.infoId===l.infoId)??null,[p,l.infoId]),st=a.useMemo(()=>({library_overview:u.targets.libraryOverview,all_cards:u.targets.allCards,new_card:u.targets.newCard,all_collections:u.targets.allCollections,all_revisions:u.targets.allRevisions,new_collection:u.targets.newCollection,transfer:u.targets.transfer,storyboards:u.targets.storyboards,new_storyboard:u.targets.newStoryboard,texts:u.targets.texts,new_text:u.targets.newText,dependencies:u.targets.dependencies}),[u.targets]),jt=a.useMemo(()=>st[je]??je,[je,st]),Xe=Ve[ue],lt=!!f,bt=a.useMemo(()=>{const x=j==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":j==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return j==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:x},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:x},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:x},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:x},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:x},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:x},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:x},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:x},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:x},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:x},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:x},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:x},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:x},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:j==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:x},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:x},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:x},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:x},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:x},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:x},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:x},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:x},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:x},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:x},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:x},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:x},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:x},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:x},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:x},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:x},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:x},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:x},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:x},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:x},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:x},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:x},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:x},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:x},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:x},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:x},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[j]),It=bt.length,yt=Math.max(0,Math.min(Ie,It-1)),St=bt[yt],xt=!!K,sa=lt&&oe,mt=xt&&oe,At=xt&&oe&&(ue==="settings"||ue==="run"||ue==="shared"),tt=a.useCallback(x=>{const Me=!!x.libraryId;let Be=x.target,c=x.collectionId,pe=x.revisionId,Se=x.revisionView,at=x.infoId,ct=x.infoView??l.infoView??"overview",Ct=x.collectionView??l.collectionView??"infos";Me?Ln[Be].requiresCollection&&!c?(Be=Be==="all_revisions"?"all_revisions":"all_collections",pe=void 0,Se="detail"):Be!=="all_collections"&&Be!=="all_revisions"?(c=void 0,pe=void 0,Be!=="new_card"&&Be!=="all_cards"&&(at=void 0,ct="overview"),Be!=="new_collection"&&(Ct="infos")):Ln[Be].allowsRevision?Br.includes(Se)||(pe=void 0):Se="detail":(Be="library_overview",c=void 0,pe=void 0,Se="detail",at=void 0,ct="overview",Ct="infos"),V(x.libraryId),W(Be),I(c),le(pe),Ce(Se),B(!1);const Et=ua(ks(x.libraryId,Be,c,Se,pe,at,ct,Ct));ua(`${y.pathname}${y.search}`)!==Et&&($.current=Et,o(Et))},[y.pathname,y.search,o,l.collectionView,l.infoView]),Mt=a.useMemo(()=>[{key:"library",label:u.layers.library,visible:!0,value:f??"",selectedLabel:(H==null?void 0:H.name)??u.path.noLibrarySelected,disabled:ee||v.length===0,options:v.map(x=>({value:x.libraryId,label:x.name})),emptyOption:u.noLibraryOption,onSelect:x=>{const Me=x||void 0;tt({libraryId:Me,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:u.layers.target,visible:lt,value:je,selectedLabel:jt,disabled:!lt,options:Ws.map(x=>({value:x,label:st[x]})),onSelect:x=>{const Me=x;tt({libraryId:f,target:Me,collectionId:K,revisionId:he,revisionView:ve,infoId:Me==="new_card"?l.infoId:void 0})}},{key:"info_mode",label:u.layers.target,visible:je==="all_cards",value:Ge,selectedLabel:Ge==="create"?u.infoMode.create:Ge==="selected"?(Oe==null?void 0:Oe.label)??Z??t.cogita.library.list.selectedEmpty:u.infoMode.search,disabled:!lt,options:[{value:"search",label:u.infoMode.search},{value:"create",label:u.infoMode.create},...l.infoId?[{value:"selected",label:(Oe==null?void 0:Oe.label)??Z??t.cogita.library.list.selectedEmpty}]:[]],onSelect:x=>{if(x==="selected"){if(!l.infoId)return;tt({libraryId:f,target:"all_cards",collectionId:K,revisionId:he,revisionView:ve,infoId:l.infoId,infoView:"overview"});return}if(x==="create"){tt({libraryId:f,target:"new_card",collectionId:K,revisionId:he,revisionView:ve,infoId:void 0});return}tt({libraryId:f,target:"all_cards",collectionId:K,revisionId:he,revisionView:ve,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:u.layers.target,visible:je==="all_cards"&&!!l.infoId,value:N==="new_card"&&l.infoId?"edit":l.infoView==="cards"?"cards":l.infoView==="collections"?"collections":"overview",selectedLabel:N==="new_card"&&l.infoId?u.infoActions.edit:l.infoView==="cards"?u.infoActions.seeCards:l.infoView==="collections"?"Kolekcje":u.infoActions.overview,disabled:!lt||!l.infoId,options:[{value:"overview",label:u.infoActions.overview},{value:"edit",label:u.infoActions.edit},{value:"cards",label:u.infoActions.seeCards},{value:"collections",label:"Kolekcje"}],onSelect:x=>{if(l.infoId){if(x==="edit"){tt({libraryId:f,target:"new_card",collectionId:K,revisionId:he,revisionView:ve,infoId:l.infoId});return}if(x==="cards"){tt({libraryId:f,target:"all_cards",collectionId:K,revisionId:he,revisionView:ve,infoId:l.infoId,infoView:"cards"});return}tt({libraryId:f,target:"all_cards",collectionId:K,revisionId:he,revisionView:ve,infoId:l.infoId,infoView:"overview"})}}},{key:"collection_mode",label:u.layers.collection,visible:lt&&(oe||N==="new_collection"),value:Ye,selectedLabel:Ye==="create"?t.cogita.library.actions.createCollection:Ye==="selected"?(te==null?void 0:te.name)??u.path.noCollectionSelected:t.cogita.library.actions.collections,disabled:!lt,options:[{value:"search",label:t.cogita.library.actions.collections},{value:"create",label:t.cogita.library.actions.createCollection},...K&&te?[{value:"selected",label:te.name}]:[]],onSelect:x=>{if(x==="create"){tt({libraryId:f,target:"new_collection",collectionId:void 0,revisionId:void 0,revisionView:"detail"});return}if(x==="selected"&&K){tt({libraryId:f,target:oe?N:"all_collections",collectionId:K,revisionId:he,revisionView:"detail"});return}if(x==="collections"){tt({libraryId:f,target:"all_cards",collectionId:K,revisionId:he,revisionView:ve,infoId:l.infoId,infoView:"collections"});return}tt({libraryId:f,target:oe?N:"all_collections",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection",label:u.layers.collection,visible:sa&&Ye!=="create",value:K??"",selectedLabel:(te==null?void 0:te.name)??u.path.noCollectionSelected,disabled:!lt||ye||T.length===0,options:T.map(x=>({value:x.collectionId,label:x.name})),emptyOption:u.selectCollectionOption,onSelect:x=>{tt({libraryId:f,target:oe?N:"all_collections",collectionId:x||void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection_selected_action",label:u.layers.revision,visible:mt,value:ue==="graph"?"edit":ue==="settings"||ue==="run"||ue==="shared"?"revisions":(l.collectionView??"infos")==="overview"?"overview":"infos",selectedLabel:ue==="graph"?"Edytuj":ue==="settings"||ue==="run"||ue==="shared"?u.targets.allRevisions:(l.collectionView??"infos")==="overview"?"Przegląd":"Informacje",disabled:!K,options:[{value:"overview",label:"Przegląd"},{value:"edit",label:"Edytuj"},{value:"infos",label:"Informacje"},{value:"revisions",label:u.targets.allRevisions}],onSelect:x=>{if(K){if(x==="edit"){tt({libraryId:f,target:oe?N:"all_collections",collectionId:K,revisionId:void 0,revisionView:"graph"});return}if(x==="revisions"){tt({libraryId:f,target:oe?N:"all_collections",collectionId:K,revisionId:he,revisionView:"settings"});return}tt({libraryId:f,target:oe?N:"all_collections",collectionId:K,revisionId:void 0,revisionView:"detail",infoId:l.infoId,infoView:l.infoView,collectionView:x==="overview"?"overview":"infos"})}}},{key:"revision_entry",label:u.layers.revision,visible:At,value:he??"",selectedLabel:(Ee==null?void 0:Ee.name)??u.status.noRevisions,disabled:!xt||de||ce.length===0,options:ce.map(x=>({value:x.revisionId,label:x.name})),emptyOption:u.status.noRevisions,onSelect:x=>{tt({libraryId:f,target:oe?N:"all_collections",collectionId:K,revisionId:x||void 0,revisionView:ve})}}],[T,ye,Ge,p,v,ee,tt,ce,de,te,K,Oe,Ee,he,Z,xt,lt,H,oe,f,Xe,ve,N,ue,je,jt,sa,mt,At,st,t.cogita.library.list.selectedEmpty,l.infoId,l.infoView,l.collectionView,u.infoActions.edit,u.infoActions.overview,u.infoActions.seeCards,u.layers.collection,u.layers.library,u.layers.revision,u.layers.target,u.noLibraryOption,u.path.noCollectionSelected,u.path.noLibrarySelected,u.selectCollectionOption,u.targets.allRevisions,Ye]),Dt=a.useMemo(()=>Mt.filter(x=>x.visible),[Mt]),ft=a.useMemo(()=>Dt.filter(x=>x.key!=="library"&&x.key!=="collection"),[Dt]),et=a.useMemo(()=>ft.find(x=>x.key==="target")??null,[ft]),ht=a.useMemo(()=>ft.find(x=>x.key==="info_mode")??null,[ft]),Lt=a.useMemo(()=>ft.find(x=>x.key==="info_selected_action")??null,[ft]),Tt=a.useMemo(()=>ft.find(x=>x.key==="collection_mode")??null,[ft]),Je=a.useMemo(()=>ft.find(x=>x.key==="collection_selected_action")??null,[ft]),gt=a.useMemo(()=>ft.find(x=>x.key==="revision_entry")??null,[ft]),kt=a.useCallback((x,Me)=>x?e.jsx("div",{className:"cogita-sidebar-actions",children:x.options.map(Be=>e.jsx("button",{type:"button",className:`ghost ${String(x.value)===Be.value?"active":""}`,onClick:()=>x.onSelect(Be.value),disabled:x.disabled,children:Be.label},`${Me}:${x.key}:${Be.value}`))}):null,[]),Yt=a.useMemo(()=>{const x=l.libraryId;if(!x||!y.pathname.startsWith("/cogita/library/"))return null;const Me={copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,libraryId:x};if(l.target==="library_overview")return e.jsx(Ri,{...Me});if(l.target==="all_cards")return l.infoId&&l.infoView==="cards"?e.jsx(sr,{...Me,infoId:l.infoId,selectedReviewerRoleId:Re||null}):e.jsx(Ui,{...Me,mode:l.cardMode??"list"});if(l.target==="new_card")return e.jsx(Xi,{...Me,editInfoId:l.infoId});if(l.target==="dependencies")return e.jsx(er,{...Me});if(l.target==="transfer")return e.jsx(cr,{...Me});if(l.target==="storyboards"||l.target==="new_storyboard")return e.jsx(dr,{...Me});if(l.target==="texts"||l.target==="new_text")return e.jsx(ur,{...Me});if(l.target==="all_collections"||l.target==="all_revisions"){if(!l.collectionId&&l.revisionView==="run")return e.jsx(js,{...Me,revisionId:l.revisionId});if(l.collectionId){const Be={...Me,collectionId:l.collectionId};return l.revisionView==="graph"?e.jsx(zr,{...Be}):l.revisionView==="shared"?e.jsx(lr,{...Me,collectionId:l.collectionId}):l.revisionView==="settings"?e.jsx(Tr,{...Be,revisionId:l.revisionId}):l.revisionView==="run"?e.jsx(js,{...Be,revisionId:l.revisionId}):e.jsx(gr,{...Be})}return e.jsx(hr,{...Me})}return l.target==="new_collection"?e.jsx(br,{...Me,onCreated:Be=>{tt({libraryId:x,target:N==="all_revisions"?"all_revisions":"all_collections",collectionId:Be,revisionId:void 0,revisionView:"graph"})}}):null},[n,tt,t,j,y.pathname,o,M,g,k,i,r,l.cardMode,l.collectionId,l.infoId,l.libraryId,l.revisionId,l.revisionView,l.target,m,s,N,Re]);a.useEffect(()=>{let x=!1;return(async()=>{var Be,c,pe,Se,at;q(!0);try{await fi();const[ct,Ct,Et]=await Promise.all([Ts(),Ls(),bi()]);if(x)return;w(ct);const oa=new Set(Et.nodes.filter($t=>$t.nodeType==="role"&&$t.canLink).map($t=>$t.roleId??"")),Ht=Or(Ct,oa);if(R(Ht),Ht){const $t=Et.nodes.find(wt=>wt.nodeType==="data"&&wt.roleId===Ht&&(wt.fieldType===In||wt.label===In));Y(($t==null?void 0:$t.dataKeyId)??null),ne.current=Ur($t==null?void 0:$t.value)}const vt=(Be=ct.find($t=>$t.libraryId===l.libraryId))==null?void 0:Be.libraryId,Nt=vt?(pe=(c=ne.current.byLibrary)==null?void 0:c[vt])==null?void 0:pe.lastTarget:void 0,ra=Vr(Nt)?Nt:"library_overview";V(vt),W(l.target??ra),le(l.revisionId??(vt?(at=(Se=ne.current.byLibrary)==null?void 0:Se[vt])==null?void 0:at.lastRevisionId:void 0)),Ce(l.revisionView??"detail"),S.current=!0}catch{x||_e(u.status.loadFailed)}finally{x||q(!1)}})(),()=>{x=!0}},[u.status.loadFailed]),a.useLayoutEffect(()=>{if(S.current){if(!l.libraryId){V(void 0),W(l.target??"library_overview"),I(void 0),le(void 0),Ce("detail");return}l.libraryId&&v.some(x=>x.libraryId===l.libraryId)&&V(l.libraryId),l.target&&W(l.target),I(l.collectionId),le(l.revisionId),l.revisionView&&Ce(l.revisionView)}},[v,l.collectionId,l.libraryId,l.revisionId,l.revisionView,l.target]),a.useEffect(()=>{if(!f){D([]),I(void 0),h([]),P([]),le(void 0);return}let x=!1;return X(!0),Oa({libraryId:f,limit:200}).then(Me=>{var pe;if(x)return;const Be=Me.items;D(Be);const c=(pe=Be.find(Se=>Se.collectionId===l.collectionId))==null?void 0:pe.collectionId;I(c)}).catch(()=>{x||(D([]),I(void 0))}).finally(()=>{x||X(!1)}),()=>{x=!0}},[l.collectionId,f]),a.useEffect(()=>{if(!f||je!=="all_cards"&&N!=="new_card"){h([]);return}let x=!1;return Dn({libraryId:f,limit:200}).then(Me=>{x||h(Me)}).catch(()=>{x||h([])}),()=>{x=!0}},[je,f,N]),a.useEffect(()=>{if(!f||!K){P([]),le(void 0);return}let x=!1;return xe(!0),Cs({libraryId:f,collectionId:K}).then(Me=>{var pe,Se,at,ct;if(x)return;P(Me);const Be=(Se=(pe=ne.current.byLibrary)==null?void 0:pe[f])==null?void 0:Se.lastRevisionId,c=((at=Me.find(Ct=>Ct.revisionId===l.revisionId))==null?void 0:at.revisionId)??((ct=Me.find(Ct=>Ct.revisionId===Be))==null?void 0:ct.revisionId);le(c)}).catch(()=>{x||(P([]),le(void 0))}).finally(()=>{x||xe(!1)}),()=>{x=!0}},[l.revisionId,K,f]),a.useEffect(()=>{const x=l.infoId;if(!f||!x){C(void 0);return}let Me=!1;return aa({libraryId:f,infoId:x}).then(Be=>{if(Me)return;const c=Be.payload;C((c==null?void 0:c.label)??(c==null?void 0:c.name)??(c==null?void 0:c.title)??Be.infoId)}).catch(()=>{Me||C(x)}),()=>{Me=!0}},[l.infoId,f]),a.useEffect(()=>{if(!S.current||l.libraryId&&v.some(pe=>pe.libraryId===l.libraryId)&&l.libraryId!==f||l.target&&l.target!==N||l.revisionView&&l.revisionView!==ve||l.revisionId&&l.revisionId!==he||Ln[N].requiresCollection&&!K&&(l.target==="all_collections"||l.target==="all_revisions")&&l.collectionId)return;const x=ua(`${y.pathname}${y.search}`);if(ua(y.pathname)==="/cogita"&&!l.libraryId&&!f){$.current=null;return}if(ua(y.pathname)==="/cogita/persons"){$.current=null;return}if(ua(y.pathname)===`/cogita/library/${f}/revision/run`&&l.revisionView==="run"&&!l.collectionId&&(N==="all_collections"||N==="all_revisions")&&ve==="run"&&!K){$.current=null;return}const c=ua(ks(f,N,K,ve,he,l.infoId,l.infoView??"overview",l.collectionView??"infos"));if(x===c){$.current=null;return}$.current!==c&&($.current=c,o(c,{replace:!0}))},[v,y.pathname,y.search,o,l.collectionId,l.infoId,l.infoView,l.collectionView,l.libraryId,l.revisionId,l.revisionView,l.target,K,f,he,ve,N]),a.useEffect(()=>{if(typeof window>"u")return;const x=()=>{window.innerWidth>920&&B(!1)};return window.addEventListener("resize",x),()=>window.removeEventListener("resize",x)},[]),a.useEffect(()=>{if(!S.current||!We||!f||U.current)return;const x=ne.current,Me={...x.byLibrary??{}},Be={...Me[f]??{},lastCollectionId:K,lastRevisionId:he,lastRevisionView:ve,lastTarget:N},c={version:1,lastLibraryId:f,byLibrary:{...Me,[f]:Be}},pe=JSON.stringify(x),Se=JSON.stringify(c);if(pe===Se)return;ne.current=c,U.current=!0,(async()=>{try{if(A)await yi(A,{plainValue:Se});else{const ct=await xi(We,{itemName:In,itemType:"data",plainValue:Se});Y(ct.dataItemId)}}catch{_e(u.status.savePrefsFailed)}finally{U.current=!1}})()},[A,We,K,f,he,ve,N,u.status.savePrefsFailed]);const ia=async()=>{const x=Qe.trim();if(!x){_e(t.cogita.user.libraryNameRequired);return}_e(null);try{const Me=await wi({name:x});w(Be=>[Me,...Be]),V(Me.libraryId),W("library_overview"),I(void 0),$e("")}catch{_e(t.cogita.user.libraryCreateFailed)}},se=async()=>{if(!f||!K){_e(u.status.selectLibraryFirst);return}const x=ot.trim();if(!x){_e(u.revisionForm.nameLabel);return}_e(null);try{const Me=await vi({libraryId:f,collectionId:K,name:x,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});P(Be=>[Me,...Be]),le(Me.revisionId),W(N==="all_revisions"?"all_revisions":"all_collections"),Ce("settings"),ze("")}catch{_e(u.status.loadFailed)}};return e.jsx(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,headerExtra:e.jsxs("div",{className:"cogita-header-reviewer-actions",children:[e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:Re,disabled:!f,onChange:x=>{const Me=x.target.value;if(Me==="__new_person__"){o("/cogita/persons");return}re(Me)},children:[e.jsx("option",{value:"",children:f?"No person":"Select library first"}),ke.map(x=>e.jsx("option",{value:x.roleId,children:x.label},x.roleId)),e.jsx("option",{value:"__new_person__",children:"+ Create new person"})]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>o("/cogita/persons"),children:"Persons"})]}),children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${Le?"open":""}`,"aria-label":u.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{children:(H==null?void 0:H.name)??u.path.noLibrarySelected}),e.jsx("p",{className:"cogita-sidebar-note",children:H?u.sidebar.libraryActionsHint:u.status.selectLibraryFirst}),kt(et,"sidebar"),ht?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:u.sidebar.infoActionsHint}),kt(ht,"sidebar"),Lt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(Oe==null?void 0:Oe.label)??Z??t.cogita.library.list.selectedEmpty}),e.jsx("p",{className:"cogita-sidebar-note",children:u.sidebar.selectedInfoActionsHint}),kt(Lt,"sidebar")]}):null]}):null,Tt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:u.sidebar.collectionActionsHint}),kt(Tt,"sidebar"),te&&Je?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:te.name}),kt(Je,"sidebar"),gt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(Ee==null?void 0:Ee.name)??u.status.noRevisions}),kt(gt,"sidebar")]}):null]}):null]}):null]}),e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:u.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:i,children:u.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{k("cogita"),B(!1)},children:u.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:r,children:m?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),Le?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":u.sidebar.closeMenu,onClick:()=>B(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":u.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>B(x=>!x),"aria-label":Le?u.sidebar.closeMenu:u.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),Dt.map((x,Me)=>e.jsxs("div",{className:"cogita-browser-segment",children:[Me>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,x.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":x.label,children:x.selectedLabel}):e.jsxs("select",{"aria-label":x.label,value:x.value,onChange:Be=>x.onSelect(Be.target.value),disabled:x.disabled,children:[x.emptyOption?e.jsx("option",{value:"",children:x.emptyOption}):null,x.options.map(Be=>e.jsx("option",{value:Be.value,children:Be.label},`${x.key}:${Be.value}`))]})]},`menu:${x.key}`))]}),Yt?e.jsxs(e.Fragment,{children:[(N==="all_collections"||N==="all_revisions")&&K&&ve==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:u.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:u.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:ot,onChange:x=>ze(x.target.value),placeholder:u.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:se,children:u.revisionForm.createAction}),Ke?e.jsx("p",{className:"cogita-form-error",children:Ke}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Ps.Provider,{value:!0,children:Yt})})]}):null,Yt?null:e.jsxs(e.Fragment,{children:[Ne?e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(or,{copy:t,onPersonCreated:x=>{fe(Me=>Me+1)}})}):null,!f&&!Ne?e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:St.step}),e.jsx("h2",{children:St.title})]}),e.jsxs("p",{children:[yt+1," / ",It]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:St.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:St.passages.map(x=>e.jsx("p",{children:x},x))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:St.focus.map(x=>e.jsx("span",{children:x},x))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:St.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:bt.map((x,Me)=>e.jsx("button",{type:"button",className:`ghost ${Me===yt?"active":""}`,onClick:()=>qe(Me),"aria-label":`${Me+1}`,children:Me+1},`tutorial:${x.title}:${Me}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:yt===0,onClick:()=>qe(x=>Math.max(0,x-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:yt===It-1,onClick:()=>qe(x=>Math.min(It-1,x+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:Qe,onChange:x=>$e(x.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:ia,children:t.cogita.user.createLibraryAction}),Ke?e.jsx("p",{className:"cogita-form-error",children:Ke}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),v.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,v.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:v.map(x=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{tt({libraryId:x.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:x.name})]},x.libraryId))}):null]})]})]}):null]})]})]})})}const Qr=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:qr},Symbol.toStringTag,{value:"Module"}));function Jr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,shareId:o}){const[y,l]=a.useState(null),[u,v]=a.useState("loading"),[w,T]=a.useState(t.cogita.library.collections.defaultName),[D,p]=a.useState("Cogita Library"),[h,ce]=a.useState([]),[P,f]=a.useState([]),[V,N]=a.useState("idle"),[W,K]=a.useState({current:0,total:0}),[I,he]=a.useState(0),[le,ve]=a.useState(""),[Ce,Z]=a.useState(null),[C,Le]=a.useState(null),[B,ee]=a.useState(null),[q,ye]=a.useState(null),[X,de]=a.useState([]),[xe,Ke]=a.useState({}),[_e,Ie]=a.useState({}),[qe,Qe]=a.useState(null),[$e,He]=a.useState(null),[rt,ot]=a.useState(null),[ze,ke]=a.useState(null),[J,Re]=a.useState({}),re=a.useRef(0),[_,fe]=a.useState(null),We=a.useRef(null),R=a.useRef(null),[A,Y]=a.useState(null),[ne,S]=a.useState(!1),[U,$]=a.useState(null),[H,te]=a.useState([]),[Ne,Ee]=a.useState(null),Ve=a.useRef(null),je=a.useRef(null),[ue,oe]=a.useState(null),[Ye,Ge]=a.useState(0),Oe=a.useRef(null),st=a.useRef({}),[jt,Xe]=a.useState(!1),[lt,bt]=a.useState({}),It=a.useRef(null),yt=a.useRef(new Set),St=a.useRef({}),[xt,sa]=a.useState([]),[mt,At]=a.useState(new Set),[tt,Mt]=a.useState(!1),Dt=Ea(),ft=a.useMemo(()=>new URLSearchParams(Dt.search),[Dt.search]),et=a.useMemo(()=>ft.get("key")??"",[ft]),ht=(y==null?void 0:y.mode)??"random",Lt=(y==null?void 0:y.check)??"exact",Tt=(y==null?void 0:y.limit)??20,Je=a.useMemo(()=>qn((y==null?void 0:y.revisionType)??ht),[y,ht]),gt=a.useMemo(()=>{const L=y==null?void 0:y.revisionSettings,G=_s(Je,ft);return dn(Je,L??G)},[y,ft,Je]),kt=a.useMemo(()=>t.cogita.library.revision[Je.labelKey]??ht,[t,ht,Je]),Yt=a.useMemo(()=>Lt==="exact"?t.cogita.library.revision.checkValue:Lt,[t,Lt]),se=u==="ready"?h[I]??null:null,x=(se==null?void 0:se.checkType)==="translation-match"&&ze,Me=a.useRef(new Map),Be=a.useRef(new Map),c=a.useRef(new Map),pe=a.useRef(new Map),Se=a.useMemo(()=>se?se.cardType==="vocab"?t.cogita.library.revision.vocabLabel:se.infoType?Ze(t,se.infoType):t.cogita.library.revision.infoLabel:"",[t,se]),at=a.useMemo(()=>{var G;return Je.id!=="levels"?h.length:((G=lt.pool)==null?void 0:G.length)??Je.getFetchLimit(Tt,gt)},[lt,gt,Je,h.length,Tt]),ct=Je.getProgressTotal?Je.getProgressTotal(h,lt,Tt,gt):Je.id==="levels"?Math.min(Tt,at):h.length,Ct=ct?Math.min(I+1,ct):0,Et=Math.max(1,Number(gt.tries??1)),oa=gt.compare??"anchors",Ht=Math.max(0,Math.min(100,Number(gt.minCorrectness??0))),vt=(gt.considerDependencies??"on")==="on",Nt=Math.max(0,Math.min(100,Number(gt.dependencyThreshold??85))),ra=L=>{const G=L.slice();for(let me=G.length-1;me>0;me-=1){const Ae=Math.floor(Math.random()*(me+1));[G[me],G[Ae]]=[G[Ae],G[me]]}return G},$t=L=>ga(L,{treatSimilarCharsAsSame:!0})>=Ht,wt=async()=>{const L=await ta(),G=new Map,me=new Map;L.forEach(ge=>{const Te=`${ge.itemType}:${ge.itemId}`,d=Jt(ge.itemType,ge.itemId,ge.checkType,ge.direction);G.has(Te)||G.set(Te,[]),G.get(Te).push(ge),me.has(d)||me.set(d,[]),me.get(d).push(ge)});const Ae=new Map,Pe=new Map;return G.forEach((ge,Te)=>Ae.set(Te,ea(ge).score)),me.forEach((ge,Te)=>Pe.set(Te,ea(ge).score)),{itemKnowness:Ae,cardKnowness:Pe}},Ot=async L=>{const G=lt,me=L.concat(G.active??[]).concat(G.pool??[]).filter((O,Q,z)=>z.findIndex(ie=>be(ie)===be(O))===Q);if(!vt){At(new Set(me.map(be)));return}const{itemKnowness:Ae,cardKnowness:Pe}=await wt(),ge=O=>{if(O.cardType!=="info"||O.infoType!=="citation"||O.checkType!=="quote-fragment")return!0;const Q=Vt(O.direction);if(!(Q!=null&&Q.fragmentId))return!0;const z=O.description??"";if(!z.trim())return!0;const E=ya(z).nodes[Q.fragmentId];if(!E||!E.leftId&&!E.rightId)return!0;const ae=[E.leftId,E.rightId].filter(De=>!!De);if(ae.length===0)return!0;const we=ae.map(De=>{const Ue=Jt("info",O.cardId,"quote-fragment",De);return Pe.get(Ue)??0});return we.reduce((De,Ue)=>De+Ue,0)/we.length>=Nt},Te=(y==null?void 0:y.collectionId)??null,d=Te?xt.filter(O=>pt(O.childItemType)==="collection"&&O.childItemId===Te&&!pt(O.childCheckType)&&!pt(O.childDirection)):[],b=Te&&me.length>0?me.reduce((O,Q)=>O+(Pe.get(be(Q))??0),0)/me.length:0,F=new Set;for(const O of me){if(O.cardType!=="info"){F.add(be(O));continue}if(!ge(O))continue;const Q=xt.filter(E=>Hs(E,O)).concat(d);if(Q.length===0){F.add(be(O));continue}let z=0;for(const E of Q)if(pt(E.parentItemType)==="collection")z+=E.parentItemId===Te?b:0;else if(pt(E.parentCheckType)||pt(E.parentDirection)){const ae=pt(E.parentCheckType),we=pt(E.parentDirection),Fe=Jt(E.parentItemType,E.parentItemId,ae,we);z+=Pe.get(Fe)??0}else{const ae=`${E.parentItemType}:${E.parentItemId}`;z+=Ae.get(ae)??0}z/Q.length>=Nt&&F.add(be(O))}At(F)},Ka=L=>{for(let G=L;G<h.length;G+=1){const me=h[G];if(me&&(!vt||me.cardType!=="info"||mt.has(be(me))))return G}return-1},xa=L=>!vt||L.cardType!=="info"||mt.has(be(L)),Fa=L=>{if(Je.id!=="temporal"&&Je.id!=="levels")return null;const G=lt,me=(G.active??[]).concat(G.pool??[]),Ae=new Set;for(const Pe of me){const ge=be(Pe);if(!(Ae.has(ge)||L.has(ge))&&(Ae.add(ge),xa(Pe)))return Pe}return null},Wt=a.useMemo(()=>{if(Je.id!=="levels")return null;const L=lt,G=L.pool??[],me=L.active??[],Ae=L.levelMap??{},Pe=Math.max(1,Number(gt.levels??1)),ge=Array.from({length:Pe},()=>0),Te=new Set(me.map(O=>be(O)));G.forEach(O=>{const Q=Math.min(Pe,Math.max(1,Ae[be(O)]??1));ge[Q-1]+=1});const d=G.length||1,b=ge.map(O=>O/d*100),F=se?Ae[be(se)]??1:null;return{counts:ge,percentages:b,currentLevel:F,levelsCount:Pe,activeCount:me.length,poolCount:G.length,activeSet:Te}},[lt,gt,Je,se]),va=a.useMemo(()=>{if(Je.id!=="temporal")return null;const L=lt,G=L.pool??[],me=L.active??[],Ae=L.knownessMap??{},Pe=new Set(L.unknownSet??[]);let ge=0;G.forEach(b=>{(Ae[be(b)]??0)>1&&(ge+=1)});const Te=Pe.size,d=me.map(b=>({id:be(b),value:Pe.has(be(b))?0:Math.max(0,Math.min(1,Ae[be(b)]??0))}));return{knownCount:ge,unknownCount:Te,dots:d}},[lt,Je]),un=a.useMemo(()=>{if(!vt)return 0;const L=lt;return h.concat(L.active??[]).concat(L.pool??[]).filter((me,Ae,Pe)=>Pe.findIndex(ge=>be(ge)===be(me))===Ae).filter(me=>me.cardType==="info"&&!mt.has(be(me))).length},[vt,lt,h,mt]);a.useEffect(()=>{if(!vt||V!=="ready")return;const L=lt,me=h.concat(L.active??[]).concat(L.pool??[]).filter((ge,Te,d)=>d.findIndex(b=>be(b)===be(ge))===Te).filter(ge=>ge.cardType!=="info"||mt.has(be(ge))).length,Ae=Ve.current;if(Ve.current=me,Ae===null||me<=Ae)return;const Pe=me-Ae;Ee(`New card available (+${Pe})`),je.current&&window.clearTimeout(je.current),je.current=window.setTimeout(()=>Ee(null),2200)},[vt,V,lt,h,mt]),a.useEffect(()=>()=>{je.current&&window.clearTimeout(je.current)},[]);const zt=(L,G)=>{const me=Je.applyOutcome({queue:h,meta:lt},se,Tt,gt,{correct:L,correctness:G,createdUtc:new Date().toISOString()});ce(me.queue),bt(me.meta);const Ae=me.queue[I+1];Ae&&Na(Ae,I+1)};a.useEffect(()=>{if(!o){v("error");return}v("loading"),ji({shareId:o,key:et}).then(L=>{l(L),T(L.collectionName),p(L.libraryName),v("ready")}).catch(()=>{v("error")})},[o,et]),a.useEffect(()=>{o&&ki({shareId:o,key:et,type:"language"}).then(L=>f(L)).catch(()=>f([]))},[o,et]),a.useEffect(()=>{!o||u!=="ready"||Ni({shareId:o,key:et}).then(L=>sa(L.items??[])).catch(()=>sa([]))},[o,et,u]),a.useEffect(()=>{if(!o||u!=="ready")return;let L=!0;return(async()=>{N("loading"),K({current:0,total:Je.id==="levels"?0:Je.getFetchLimit(Tt,gt)});try{const me=[];let Ae=null,Pe=null;do{const Q=await Si({shareId:o,key:et,limit:300,cursor:Ae});if(me.push(...Q.items),(Je.id==="levels"||Je.id==="temporal")&&Q.total&&(Pe=Q.total),K(z=>({current:me.length,total:z.total||Q.total||Je.getFetchLimit(Tt,gt)})),Ae=Q.nextCursor??null,Pe!==null&&me.length>=Pe||Je.id!=="levels"&&Je.id!=="temporal"&&me.length>=Je.getFetchLimit(Tt,gt))break}while(Ae);if(!L)return;const ge=Ra(me);let Te;if(Je.id==="levels"){const Q=Math.max(1,Number(gt.levels??1));Te={},ge.forEach(z=>{const ie=be(z);Te[ie]=Math.max(1,Math.min(Q,1))})}let d=null,b=null,F=null;if(Je.id==="temporal"){const Q=await ta(),z=new Set(ge.map(ae=>be(ae))),ie=Q.reduce((ae,we)=>{const Fe=Jt(we.itemType,we.itemId,we.checkType,we.direction);return z.has(Fe)&&(ae[Fe]||(ae[Fe]=[]),ae[Fe].push(we)),ae},{});d={},b=new Set,F={};const E=Date.now();ge.forEach(ae=>{const we=be(ae),Fe=ie[we]??[];if(Fe.length===0){d[we]=0,b.add(we),F[we]=[];return}const De=Vn(Fe);F[we]=De;const Ue=ln(De,E);d[we]=Ue.knowness})}const O=Je.id==="levels"?Un(ge,Tt,gt,Te):Je.id==="temporal"?On(ge,Tt,gt,d??{},b??new Set,F??{}):Je.prepare(ge,Tt,gt);ce(O.queue),bt(O.meta),he(0),N("ready"),K(Q=>({current:Math.min(Q.current,Q.total),total:Q.total}))}catch{L&&N("error")}})(),()=>{L=!1}},[o,et,Tt,Je,gt,u]),a.useEffect(()=>{Ot(h)},[h,xt,vt,Nt,y==null?void 0:y.collectionId]),a.useEffect(()=>{if(!se||!vt){Mt(!1);return}if(se.cardType!=="info"||mt.has(be(se))){Mt(!1);return}const L=Ka(I+1);if(L>=0){Mt(!1),he(L);return}if(Je.id==="temporal"||Je.id==="levels"){const G=h.slice(0,I+1),me=h.slice(I+1).filter(xa),Ae=G.concat(me),Pe=new Set(Ae.map(be)),ge=Fa(Pe);if(ge){const d=be(ge);Pe.has(d)||(Ae.push(ge),Pe.add(d),bt(b=>{const F=b,O=new Set(F.queued??[]);return O.add(d),{...F,queued:O}}))}const Te=Ae.findIndex((d,b)=>b!==I&&xa(d));if(Te>=0){ce(Ae),he(Te),Mt(!1);return}}Mt(!0)},[se,mt,vt,I,h,lt,Je.id]),a.useEffect(()=>{if(ve(""),Z(null),oe(null),Ge(0),de([]),Ke({}),Ie({}),Qe(null),He(null),ot(null),S(!1),Xe(!1),Y(null),ke(null),Re({}),!se){Le(null),ee(null);return}se.cardType==="info"&&se.infoType==="computed"&&Le(t.cogita.library.revision.loadingComputed);let L=!0;return Na(se,I).then(G=>{!L||!G||(Le(G.prompt),ee(G.expectedAnswer),de(G.computedExpected),Ke(G.computedAnswers),Qe(G.answerTemplate),He(G.outputVariables),ot(G.variableValues))}),()=>{L=!1}},[se,o,t]),a.useEffect(()=>{if(!se||se.cardType!=="info"||se.infoType!=="citation"){It.current=null,yt.current=new Set,ye(null);return}const L=se.description??"",G=(se.label??"").trim(),me=G.replace(/\s+/g," ").trim(),Ae=L.replace(/\s+/g," ").trim(),Pe=me&&me!==Ae?G:t.cogita.library.infoTypes.citation;if(!L){ye(null),ee(null);return}const ge=ya(L);It.current=ge,Le(Pe);let Te=!0;return ta().then(d=>{if(!Te)return;const b=new Map;d.forEach(ie=>{if(ie.itemType!=="info"||ie.checkType!=="quote-fragment"||!ie.direction)return;const E=Vt(ie.direction);if(!E)return;const ae=`${ie.itemId}:${E.fragmentId}`;b.has(ae)||b.set(ae,[]),b.get(ae).push(ie)});const F={},O=new Set;b.forEach((ie,E)=>{const[ae,we]=E.split(":",2);if(ae!==se.cardId)return;const Fe=ea(ie).score;F[we]=Fe,Fe>=Nt&&O.add(we)}),yt.current=O,St.current=F;const Q=Vt(se.direction);if(Q!=null&&Q.fragmentId&&ge.nodes[Q.fragmentId]){ca(ge,Q.fragmentId,Pe);return}const z=Ta(ge,O,F,Nt,vt,se.direction);ca(ge,(z==null?void 0:z.id)??null,Pe)}).catch(()=>{yt.current=new Set,St.current={};const d=Vt(se.direction);if(d!=null&&d.fragmentId&&ge.nodes[d.fragmentId]){ca(ge,d.fragmentId,Pe);return}const b=Ta(ge,yt.current,{},Nt,vt,se.direction);ca(ge,(b==null?void 0:b.id)??null,Pe)}),()=>{Te=!1}},[se,t,vt,Nt]),a.useEffect(()=>{if(!se||se.cardType!=="vocab"||se.checkType!=="translation-match"){ke(null),Re({});return}const me=(lt.pool??lt.active??h).filter(d=>d.cardType==="vocab"&&d.checkType==="translation-match").filter((d,b,F)=>F.findIndex(O=>O.cardId===d.cardId)===b);me.some(d=>d.cardId===se.cardId)||me.unshift(se);const Pe=ra(me).slice(0,6).map(d=>{const b=d.label.split("↔").map(Q=>Q.trim()).filter(Boolean);if(b.length<2)return null;const F=`${d.cardId}:L`,O=`${d.cardId}:R`;return{cardId:d.cardId,leftId:F,rightId:O,leftLabel:b[0],rightLabel:b[1]}}).filter(Boolean),ge=Pe.map(d=>d.leftId),Te=ra(Pe.map(d=>d.rightId));ke({pairs:Pe,leftOrder:ge,rightOrder:Te,selection:{},activeLeft:null,activeRight:null,locked:{}})},[se,h,lt]),a.useEffect(()=>()=>{We.current&&window.clearTimeout(We.current),R.current&&window.clearTimeout(R.current)},[]);const wa=a.useRef(null);a.useEffect(()=>{if(!se)return;const L=be(se),G=typeof document<"u"?document.activeElement:null;if(wa.current===L&&G&&(G.tagName==="INPUT"||G.tagName==="TEXTAREA"))return;let me=0;const Ae=()=>{if(se){if(se.cardType==="info"&&se.infoType==="computed"){if(X.length>0){const ge=an(qe,X,$e),Te=ge?st.current[ge]:null;if(Te&&(Te.focus(),document.activeElement===Te)){wa.current=L;return}}if(Oe.current&&(Oe.current.focus(),document.activeElement===Oe.current)){wa.current=L;return}}else if(se.cardType==="vocab"&&Oe.current&&(Oe.current.focus(),document.activeElement===Oe.current)){wa.current=L;return}me<6&&(me+=1,window.setTimeout(Ae,40))}},Pe=window.setTimeout(Ae,40);return()=>window.clearTimeout(Pe)},[se,X,qe,$e]),a.useEffect(()=>{if(!jt)return;const L=G=>{G.key==="Enter"&&(G.preventDefault(),Kt())};return window.addEventListener("keydown",L),()=>window.removeEventListener("keydown",L)},[jt]);const la=L=>{te(L),$(ea(L))};a.useEffect(()=>{if(!se){$(null),te([]);return}const L=se.cardType==="info"?"info":"connection";if(se.cardType==="info"&&se.infoType==="citation"){ta().then(G=>{const me=G.filter(Ae=>Ae.itemType==="info"&&Ae.itemId===se.cardId&&Ae.checkType==="quote-fragment"&&en(Ae.direction,se.direction));la(me)}).catch(()=>{$(null),te([])});return}Za(L,se.cardId,se.checkType,se.direction).then(G=>la(G)).catch(()=>{$(null),te([])})},[se]);const Da=(L,G,me,Ae)=>{if(L==="info"&&me==="quote-fragment"){ta().then(Pe=>{const ge=Pe.filter(Te=>Te.itemType==="info"&&Te.itemId===G&&Te.checkType==="quote-fragment"&&en(Te.direction,Ae));la(ge)}).catch(()=>{$(null),te([])});return}Za(L,G,me,Ae).then(Pe=>la(Pe)).catch(()=>{$(null),te([])})},qt=(L,G,me)=>{var Te;const Ae=((Te=me.pairs.find(d=>d.leftId===L))==null?void 0:Te.rightId)??null;if(!Ae)return me;const Pe=Ae===G;Re(d=>({...d,[L]:Pe?"correct":"incorrect"})),We.current&&window.clearTimeout(We.current),R.current&&window.clearTimeout(R.current),re.current+=1;const ge={kind:Pe?"correct":"incorrect",tick:re.current};if(fe(null),We.current=window.setTimeout(()=>fe(ge),0),R.current=window.setTimeout(()=>fe(null),420),Pe){const d={...me.locked,[L]:!0};return Object.keys(d).length>=me.pairs.length?(Z("correct"),Xe(!0)):Z("correct"),{...me,selection:{...me.selection,[L]:G},activeLeft:null,activeRight:null,locked:d}}return Z("incorrect"),{...me,activeLeft:null,activeRight:null}},ja=L=>{ke(G=>!G||G.locked[L]?G:G.activeRight?qt(L,G.activeRight,G):{...G,activeLeft:G.activeLeft===L?null:L})},hn=L=>{ke(G=>G&&(G.activeLeft?qt(G.activeLeft,L,G):{...G,activeRight:G.activeRight===L?null:L}))},Kt=()=>{var L;if(se&&se.cardType==="info"&&se.infoType==="citation"&&It.current&&q&&!((L=Vt(se.direction))!=null&&L.fragmentId)){const G=Ta(It.current,yt.current,St.current,Nt,vt,se.direction,q.fragmentId);if(G){Z(null),ve(""),S(!1),Ie({}),Xe(!1),oe(null),Ge(0),ca(It.current,G.id,q.title);return}}Z(null),ve(""),S(!1),Ie({}),Xe(!1),oe(null),Ge(0),he(G=>Math.min(G+1,h.length))},Bt=L=>{if(!se)return;const G=L.expected??null,me=L.answer??"";let Ae=G??"",Pe=me;if(!G&&L.expectedMap&&L.answerMap){const Q=Object.keys(L.expectedMap).sort((z,ie)=>z.localeCompare(ie));Ae=Q.map(z=>{var ie;return((ie=L.expectedMap)==null?void 0:ie[z])??""}).join("|"),Pe=Q.map(z=>{var ie;return((ie=L.answerMap)==null?void 0:ie[z])??""}).join("|")}const ge=Ae?Ca(Ae,Pe,oa):new Uint8Array,Te={revisionType:Je.id,evalType:L.evalType,direction:L.direction,prompt:C??"",expected:G,answer:me,expectedAnswers:L.expectedMap??null,answers:L.answerMap??null,correct:L.correct,maskBase64:ge.length?ha(ge):null,checkMode:Lt,compareMode:oa,minCorrectness:Ht},d=new TextEncoder().encode(JSON.stringify(Te)),b=se.cardType==="info"?"info":"connection",F=L.overrideCheckType??se.checkType??null,O=L.overrideDirection??se.direction??null;Xa({itemType:b,itemId:se.cardId,checkType:F,direction:O,revisionType:Je.id,evalType:L.evalType,correct:L.correct,maskBase64:ge.length?ha(ge):null,payloadBase64:ha(d)}).then(()=>{Da(b,se.cardId,F,O),Ot(h)}).catch(()=>{})},ka=(L,G)=>{const me=Me.current.get(G);if(me)return Promise.resolve(me);const Ae=Be.current.get(G);if(Ae)return Ae;const Pe=Ti({shareCode:o,infoId:L,key:et}).then(ge=>{var Q,z;const Te=ge.payload,d=((Q=Te.definition)==null?void 0:Q.graph)??null,b="",F=((z=Te.definition)==null?void 0:z.answerTemplate)??"",O=Vs(d,b,F);if(O){const E={sample:Os(O),answerTemplate:F||null};return Me.current.set(G,E),E}return Qn({shareId:o,infoId:L,key:et}).then(ie=>{const E={sample:ie,answerTemplate:null};return Me.current.set(G,E),E})}).catch(()=>Qn({shareId:o,infoId:L,key:et}).then(ge=>{const Te={sample:ge,answerTemplate:null};return Me.current.set(G,Te),Te}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{Be.current.delete(G)});return Be.current.set(G,Pe),Pe},Na=(L,G)=>{var d;const me=`${be(L)}:${G}`,Ae=c.current.get(me);if(Ae)return Promise.resolve(Ae);const Pe=pe.current.get(me);if(Pe)return Pe;const ge=b=>(c.current.set(me,b),b);let Te;if(L.cardType==="vocab"){if(L.checkType==="translation-match")return Te=Promise.resolve(ge({prompt:L.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),Te;const b=L.label.split("↔").map(F=>F.trim()).filter(Boolean);if(b.length>=2){const O=(L.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",Q=O?b[0]:b[1],z=O?b[1]:b[0];Te=Promise.resolve(ge({prompt:Q,expectedAnswer:z,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else Te=Promise.resolve(ge({prompt:L.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(L.cardType==="info"&&L.infoType==="word"){const b=(d=L.description)!=null&&d.startsWith("Language: ")?L.description.replace("Language: ",""):null;Te=Promise.resolve(ge({prompt:L.label,expectedAnswer:b,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else L.cardType==="info"&&L.infoType==="computed"?Te=ka(L.cardId,me).then(b=>{var ie,E;if(!b.sample)return ge({prompt:L.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const F=b.sample,O=F.expectedAnswers?Object.entries(F.expectedAnswers).map(([ae,we])=>({key:ae,expected:we})):[],Q=O.reduce((ae,we)=>(ae[we.key]="",ae),{}),z=F.expectedAnswerIsSentence&&((ie=F.expectedAnswer)==null?void 0:ie.trim())||null;return ge({prompt:F.prompt,expectedAnswer:O.length>0?z:((E=F.expectedAnswer)==null?void 0:E.trim())||null,computedExpected:O,computedAnswers:Q,answerTemplate:b.answerTemplate,outputVariables:F.outputVariables??null,variableValues:F.variableValues??null})}).catch(()=>ge({prompt:L.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{pe.current.delete(me)}):Te=Promise.resolve(ge({prompt:L.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return pe.current.set(me,Te),Te},ca=(L,G,me)=>{const Ae=Object.keys(L.nodes).length,Pe=yt.current.size;if(!G){ye({title:me,before:L.text,after:"",fragmentId:null,total:Ae,completed:Pe}),ee(null),Xe(!0);return}const ge=L.nodes[G];if(!ge)return;const Te=zn(L.text,ge);ye({title:me,before:Te.before,after:Te.after,fragmentId:ge.id,total:Ae,completed:Pe}),ee(Te.fragment),Xe(!1)},gn=()=>{const L=It.current;L&&ye(G=>G&&{...G,total:Object.keys(L.nodes).length,completed:yt.current.size})},Sa=()=>{const L=h[I+1];L&&Na(L,I+1)},ma=()=>{if(Sa(),se&&se.cardType==="vocab"&&se.checkType==="translation-match"&&ze){if(ze.pairs.length===0){Z("incorrect"),Xe(!0);return}const ge=ze.pairs.reduce((z,ie)=>(z[ie.rightId]=ie.rightLabel,z),{});let Te=0;const d={};ze.pairs.forEach(z=>{const E=ze.selection[z.leftId]===z.rightId;d[z.leftId]=E?"correct":"incorrect",E&&(Te+=1)});const b=ze.pairs.length||1,F=Te/b,O=Te===ze.pairs.length;Re(z=>({...z,...d})),O?(Z("correct"),Xe(!0),Ge(0)):(Z("incorrect"),Xe(!1),Ge(z=>{const ie=z+1;return ie>=Et&&(S(!0),Xe(!0),ke(E=>{if(!E)return E;const ae=E.pairs.reduce((we,Fe)=>(we[Fe.leftId]=Fe.rightId,we),{});return{...E,selection:ae}})),ie})),zt(O,F);const Q="connection";Promise.all(ze.pairs.map(z=>{const ie=ze.selection[z.leftId]??null,E=ie?ge[ie]:"",ae={left:z.leftLabel,expected:z.rightLabel,answer:E,checkType:"translation-match"},we=new TextEncoder().encode(JSON.stringify(ae));return Xa({itemType:Q,itemId:z.cardId,checkType:"translation-match",direction:null,revisionType:Je.id,evalType:"translation-match",correct:ie===z.rightId,maskBase64:null,payloadBase64:ha(we)})})).then(()=>{Da(Q,se.cardId,se.checkType,se.direction),Ot(h)}).catch(()=>{});return}if(X.length>0){const ge=X.reduce((d,b)=>{const F=xe[b.key]??"";return d[b.key]=Ft(F)===Ft(b.expected)?"correct":"incorrect",d},{});X.every(({key:d,expected:b})=>{const F=xe[d]??"";return Lt==="exact"&&Ft(F)===Ft(b)})?(Z("correct"),Ie(ge),Xe(!0),Ge(0),zt(!0,1),Bt({correct:!0,direction:C?`${C} -> computed`:"computed",expectedMap:X.reduce((d,b)=>(d[b.key]=b.expected,d),{}),answerMap:xe,evalType:"computed"})):(Z("incorrect"),Ie(ge),Xe(!1),Ge(d=>{const b=d+1;return b>=Et&&Qt&&(S(!0),Xe(!0)),b}),zt(!1,0),window.setTimeout(()=>{var b;const d=an(qe,X,$e);d&&st.current[d]&&((b=st.current[d])==null||b.focus())},40),Bt({correct:!1,direction:C?`${C} -> computed`:"computed",expectedMap:X.reduce((d,b)=>(d[b.key]=b.expected,d),{}),answerMap:xe,evalType:"computed"}));return}if(se&&se.cardType==="info"&&se.infoType==="citation"&&(q!=null&&q.fragmentId)){if(!B)return;const ge=Vt(se.direction),Te=(ge==null?void 0:ge.fragmentId)??q.fragmentId,d=Ya(B,le,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),b=d.mask,F=d.isCorrect,O=d.percent;F?(St.current[q.fragmentId]=Math.max(St.current[q.fragmentId]??0,O),(St.current[q.fragmentId]??0)>=Nt&&yt.current.add(q.fragmentId),gn(),Z("correct"),Ie({}),Xe(!0),oe(b),Ge(0),O<100&&Et<=1&&S(!0),zt(!0,O/100),Bt({correct:!0,direction:`quote:${q.fragmentId}`,expected:B,answer:le,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Te})):(Z("incorrect"),Ie({}),Xe(!1),oe(b),Ge(Q=>{const z=Q+1;return z>=Et&&Qt&&(S(!0),Xe(!0)),z}),zt(!1,O/100),window.setTimeout(()=>{var Q;return(Q=Oe.current)==null?void 0:Q.focus()},40),Bt({correct:!1,direction:`quote:${q.fragmentId}`,expected:B,answer:le,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Te}));return}if(!B)return;const L=Ca(B,le,oa),G=Lt==="exact"&&Ft(le)===Ft(B),me=$t(L),Ae=G||me,Pe=ga(L);Ae?(Z("correct"),Ie({}),Xe(!0),oe(L),Ge(0),Pe<100&&Et<=1&&S(!0),zt(!0,Pe/100),Bt({correct:!0,direction:C?`${C} -> ${B}`:null,expected:B,answer:le,evalType:"text"})):(Z("incorrect"),Ie({}),Xe(!1),oe(L),Ge(ge=>{const Te=ge+1;return Te>=Et&&Qt&&(S(!0),Xe(!0)),Te}),zt(!1,Pe/100),window.setTimeout(()=>{var ge;return(ge=Oe.current)==null?void 0:ge.focus()},40),Bt({correct:!1,direction:C?`${C} -> ${B}`:null,expected:B,answer:le,evalType:"text"}))},Gt=L=>{if(Sa(),!B)return;const G=Ca(B,L,oa),me=Ft(L)===Ft(B),Ae=$t(G),Pe=me||Ae,ge=ga(G);Pe?(Z("correct"),Ie({}),Xe(!0),oe(G),Ge(0),ge<100&&Et<=1&&S(!0),zt(!0,ge/100),Bt({correct:!0,direction:"word->language",expected:B,answer:L,evalType:"language-select"})):(Z("incorrect"),Ie({}),Xe(!1),oe(G),Ge(Te=>{const d=Te+1;return d>=Et&&Qt&&(S(!0),Xe(!0)),d}),zt(!1,ge/100),Bt({correct:!1,direction:"word->language",expected:B,answer:L,evalType:"language-select"}))},mn=L=>{var me;if(L.key!=="Enter")return;if(L.preventDefault(),L.stopPropagation(),jt){Kt();return}const G=X.find(Ae=>!(xe[Ae.key]??"").trim());if(G){(me=st.current[G.key])==null||me.focus();return}ma()},Ia=()=>{Sa(),Z("correct"),Xe(!0),Ge(0),zt(!0,1),B&&Bt({correct:!0,direction:"manual",expected:B,answer:le,evalType:"manual"})},pa=()=>{if(zt(!1,0),se&&se.cardType==="info"&&se.infoType==="citation"){Z(null),ve(""),S(!1),Ie({}),Xe(!1),oe(null),Ge(0),he(L=>Math.min(L+1,h.length));return}Kt()};a.useEffect(()=>{Sa()},[I,h]);const pn=t.cogita.library.revision.revealModeAfterIncorrect,Qt=X.length>0||!!B;return e.jsxs(Pt,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:r,onLogout:g,secureMode:m,onNavigate:k,language:j,onLanguageChange:M,children:[(u==="loading"||V==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:u==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${W.total?Math.min(100,Math.max(0,W.current/W.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:W.total?`${Math.min(W.current,W.total)} / ${W.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:w}),e.jsx("p",{className:"cogita-library-subtitle",children:D}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",kt).replace("{check}",Yt)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:U?`${U.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Wt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Wt.currentLevel??"-"," / ",Wt.levelsCount]}):null,U?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(U.correct)).replace("{total}",String(U.total))}),U.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(U.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(Us,{outcomes:H})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[Ne?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:Ne})}):null,e.jsx(Bn,{feedbackToken:_?`${_.kind}-${_.tick}`:x?"idle":Ce??"idle",children:u!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:u==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):se?e.jsx(e.Fragment,{children:tt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(_n,{copy:t,currentCard:se,currentTypeLabel:Se,prompt:C,languages:P,answer:le,onAnswerChange:L=>ve(G=>tn(G,L,A)),computedExpected:X,computedAnswers:xe,onComputedAnswerChange:(L,G)=>Ke(me=>({...me,[L]:tn(me[L]??"",G,A)})),answerTemplate:qe,outputVariables:$e,variableValues:rt,computedFieldFeedback:_e,feedback:Ce,canAdvance:jt,quoteContext:q,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:ma,onSkip:pa,onLanguageSelect:Gt,onMarkReviewed:Ia,onAdvance:Kt,showCorrectAnswer:ne,setShowCorrectAnswer:S,onRevealCorrect:()=>Xe(!0),answerMask:ue,expectedAnswer:B,hasExpectedAnswer:Qt,handleComputedKeyDown:mn,answerInputRef:Oe,computedInputRefs:st,scriptMode:A,setScriptMode:Y,matchPairs:ze==null?void 0:ze.pairs,matchLeftOrder:ze==null?void 0:ze.leftOrder,matchRightOrder:ze==null?void 0:ze.rightOrder,matchSelection:ze==null?void 0:ze.selection,matchActiveLeft:ze==null?void 0:ze.activeLeft,matchActiveRight:ze==null?void 0:ze.activeRight,matchFeedback:J,onMatchLeftSelect:ja,onMatchRightSelect:hn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:ct?`${Ct} / ${ct}`:t.cogita.library.revision.progressUnlimited}),u==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),u==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),u==="ready"&&V==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),u==="ready"&&V==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),u==="ready"&&V==="ready"&&h.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:pn}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",Et]})]})]}),Wt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Wt.activeCount," / ",Wt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Wt.counts.map((L,G)=>{const me=G+1,Ae=Wt.currentLevel===me,Pe=Wt.percentages[G]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":Ae,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:me}),e.jsx("strong",{children:L})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,Pe))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[Pe.toFixed(1),"%"]})]},`level-${me}`)})})]}):null,va?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:va.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:va.dots.map(L=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-L.value))}, ${Math.round(200*L.value)}, 80, 0.9)`}},L.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:va.knownCount})]})]}):null,vt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:un})]})}):null]})]})]})})})]})]})}const Xr=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:Jr},Symbol.toStringTag,{value:"Module"}));export{Yr as C,Qr as a,Xr as b};
