import{r as a,j as e,u as Es,a as _a,b as As,c as Fs,d as Ps,R as zs,B as Ks,C as Bs}from"./vendor-CL5v9b84.js";import{L as Ds,A as _s,g as Vs,a as dn,b as wa,c as Os,s as bs,d as us,e as un,f as ys,h as aa,i as hn,j as gn,k as mn,l as pn,m as hs,n as qs,o as fn,u as bn,p as yn,q as xn,r as vn,t as Us,v as Ws,w as wn,x as jn,y as kn,z as Va,B as $a,C as Nn,D as Sn,E as Tn,F as Cn,G as Mn,H as In,I as Ln,J as xs,K as Qt,M as $n,N as Rn,O as En,P as An,Q as Fn,R as Pn,S as zn,T as Kn,U as Bn,V as Dn,W as _n,X as Vn,Y as On,Z as qn,_ as Un,$ as Wn,a0 as vs}from"./recreatio-core-D7iLAa61.js";import"./vendor-cogita-ui-mbCyoqV0.js";const va={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},ya={moveMs:900,pauseMs:220,errorMs:900},Hn=(t=11)=>{let s=t;const n=()=>(s=(s*1664525+1013904223)%4294967296,s/4294967296),{width:i,height:l,paddingX:m,paddingY:p,levels:v}=va,E=(l-p*2)/(v.length-1),N=[],d=[],j=[];v.forEach((k,g)=>{const ue=l-p-g*E,z=i-m*2,f=[];for(let U=0;U<k;U+=1){const $=m+(U+1)*z/(k+1),G=(n()-.5)*18,I=Math.max(m,Math.min(i-m,$+G)),R=g===0?3:g<2?2.1:1.4,ee=g===0?"root":`l${g}-${U}`;f.push({id:ee,x:g===0?i/2:I,y:ue,r:R,level:g,role:g===0?"root":void 0})}j.push(f),N.push(...f)});const c=j[j.length-1];if(c!=null&&c.length){const k=c[Math.floor(c.length/2)];k.role="goal",k.r=2}for(let k=1;k<j.length;k+=1){const g=j[k-1];j[k].forEach(z=>{const f=[...g].sort((I,R)=>Math.abs(I.x-z.x)-Math.abs(R.x-z.x)),U=f[0],$=f[1]&&n()<.45?f[1]:null;($?[U,$]:[U]).forEach(I=>{d.push({from:I.id,to:z.id,key:`${I.id}-${z.id}`})}),n()<.2&&f[2]&&d.push({from:f[2].id,to:z.id,key:`${f[2].id}-${z.id}`})})}const h=new Map;d.forEach(k=>{const g=h.get(k.to)??[];g.push(k.from),h.set(k.to,g)});const S=new Map,se=new Map,Y=new Map;d.forEach(k=>{const g=S.get(k.from)??[];g.push(k.key),S.set(k.from,g);const ue=se.get(k.from)??[];ue.push(k.to),se.set(k.from,ue);const z=Y.get(k.from)??[];z.push(k.to),Y.set(k.from,z);const f=Y.get(k.to)??[];f.push(k.from),Y.set(k.to,f)});const q=new Map;return N.forEach(k=>{q.set(k.id,k)}),{nodes:N,links:d,parentsById:h,linksByFrom:S,childrenByFrom:se,neighborsById:Y,nodesById:q}};function Qn({slides:t,activeIndex:s,introOpen:n,prefersReducedMotion:i,onNext:l,onPrev:m,onSelect:p,onExit:v,onOpen:E,onRegister:N}){const d=s===t.length-1,j=n&&s===0?"entry":"docked",c=t[t.length-1],[h,S]=a.useState(!1),se=a.useMemo(()=>Array.from({length:20},(Q,ce)=>({src:`/cogita/logo/Cogita${String(ce).padStart(2,"0")}.png`,kind:ce<=11?"bubble":ce<=17?"text":"recreatio"})),[]),Y=n&&s===0;a.useEffect(()=>{if(!n){S(!1);return}s>0&&!h&&S(!0)},[s,n,h]);const q=a.useRef(0),k=a.useRef(null),g=a.useMemo(()=>{const Q={x:40,y:160},ce={x:260,y:48},$e=6,L=ce.x-Q.x,V=Q.y-ce.y,ie=L/$e,ke=[.3,.45,.6,.65,1.4,2.2],xe=ke.reduce((Re,ve)=>Re+ve,0),Le=ke.map(Re=>V*Re/xe),Ve=[Q];let He=Q.x,Me=Q.y;for(let Re=1;Re<=$e;Re+=1){const ve=(Math.random()-.5)*14,nt=(Math.random()-.5)*28;He=Math.max(Q.x+Re*14,Math.min(ce.x-($e-Re)*14,He+ie+ve));const Qe=Le[Re-1]??Le[Le.length-1];Me=Me-Qe+nt;const Ye=Math.max(ce.y,Math.min(Q.y-4,Me));Ve.push({x:Math.round(He),y:Math.round(Ye)})}return Ve[Ve.length-1]=ce,Ve},[]),ue=a.useMemo(()=>{const V=(xe,Le,Ve)=>Math.min(Ve,Math.max(Le,xe)),ie=g.map(xe=>{const Le=10+Math.random()*36;return{x:V(xe.x,40,260),y:V(xe.y-Le,40,140)}}),ke=g.map((xe,Le)=>{var Me;const Ve=12+Math.random()*40,He=((Me=ie[Le])==null?void 0:Me.y)??xe.y;return{x:V(xe.x,40,260),y:V(Math.max(He+10,xe.y+Ve),60,170)}});return{upper:ie,lower:ke}},[g]),z=a.useMemo(()=>{var ce;const Q=((ce=g[4])==null?void 0:ce.x)??260;return Math.max(0,Math.min(240,Q-40))},[g]),f=a.useMemo(()=>{var Le,Ve;const Q=(He,Me,Re)=>Math.min(Re,Math.max(Me,He)),ce=(He,Me,Re)=>g.map((ve,nt)=>{var lt,ot;const Qe=((lt=ue.upper[nt])==null?void 0:lt.y)??ve.y,Ye=((ot=ue.lower[nt])==null?void 0:ot.y)??ve.y,pt=(Math.random()-.5)*70,bt=ve.y+He+pt,Je=Q(ve.y+Me,Qe+6,Ye-6),tt=Q(ve.y+Re,Qe+6,Ye-6);return{x:ve.x,y:Q(bt,Math.min(Je,tt),Math.max(Je,tt))}}),$e=-14+Math.random()*28,L=14+Math.random()*28,V=ce($e,-80,12),ie=ce(L,-12,80);for(let He=4;He<g.length;He+=1){const Me=g[He],Re=((Le=ue.upper[He])==null?void 0:Le.y)??Me.y,ve=((Ve=ue.lower[He])==null?void 0:Ve.y)??Me.y;V[He]={x:Me.x,y:Q(Me.y-12,Re+6,ve-6)},ie[He]={x:Me.x,y:Q(Me.y+12,Re+6,ve-6)}}const ke=ue.upper.length?ue.upper[ue.upper.length-1].y:40,xe=ue.lower.length?ue.lower[ue.lower.length-1].y:170;return V[V.length-1]={x:g[g.length-1].x,y:Q(g[g.length-1].y-14,ke,xe)},ie[ie.length-1]={x:g[g.length-1].x,y:Q(g[g.length-1].y+12,ke,xe)},{higher:V,lower:ie}},[g,ue]),U=1e4,$=a.useMemo(()=>{let Q=17;const ce=()=>(Q=(Q*1664525+1013904223)%4294967296,Q/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((L,V)=>{const ie=(ce()-.5)*240,ke=(ce()-.5)*180,xe=(ce()-.5)*24;return{id:`card-${V+1}`,throw:{x:`${ie.toFixed(0)}px`,y:`${ke.toFixed(0)}px`,rot:`${xe.toFixed(1)}deg`},grid:{x:`${L.x}px`,y:`${L.y}px`},delay:`${V*.12}s`}})},[]),G=a.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[I,R]=a.useState([]),ee=a.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),te=a.useMemo(()=>{const ce=[],L=(ie,ke)=>ie+Math.random()*(ke-ie);for(let ie=0;ie<6;ie+=1){let ke=!1;for(let xe=0;xe<80;xe+=1){const Le=L(14,86),Ve=L(10,34);if(ce.every(Me=>{const Re=Me.x-Le,ve=Me.y-Ve;return Math.hypot(Re,ve)>=12})){ce.push({x:Le,y:Ve}),ke=!0;break}}ke||ce.push({x:L(16,84),y:L(12,32)})}return ce.map((ie,ke)=>({id:`p${ke+1}`,x:`${ie.x.toFixed(1)}%`,y:`${ie.y.toFixed(1)}%`,xNum:ie.x,yNum:ie.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[ae,Ke]=a.useState(0),[pe,C]=a.useState(0),[fe,x]=a.useState([]),_=1e4,ge=a.useMemo(()=>{if(te.length<2)return[];const Q=ke=>{let xe=ke+1831565813;return xe=Math.imul(xe^xe>>>15,xe|1),xe^=xe+Math.imul(xe^xe>>>7,xe|61),((xe^xe>>>14)>>>0)/4294967296},ce=(ke,xe)=>Math.floor(Q(ke)*xe),$e=new Set,L=[],V=Math.min(3,te.length);let ie=0;for(;L.length<V&&ie<30;){ie+=1;const ke=ce(ae*13+ie*5,te.length),xe=ce(ae*29+ie*7,te.length);if(ke===xe)continue;const Le=ke<xe?`${ke}-${xe}`:`${xe}-${ke}`;$e.has(Le)||($e.add(Le),L.push({id:`link-${Le}`,from:te[ke],to:te[xe],delay:`${(ie*.35).toFixed(2)}s`}))}return L},[ae,te]);a.useEffect(()=>{if(!n||s!==2)return;const Q=()=>{const $e=$.map(L=>L.id);for(let L=$e.length-1;L>0;L-=1){const V=Math.floor(Math.random()*(L+1));[$e[L],$e[V]]=[$e[V],$e[L]]}return $e.slice(0,4)};R(Q());const ce=window.setInterval(()=>{R(Q())},U);return()=>window.clearInterval(ce)},[s,n,$,U]),a.useEffect(()=>{if(!n||s!==3)return;const Q=()=>{C(Math.floor(Math.random()*ee.length)),x(te.map(()=>Math.random()<.6?"good":"bad")),Ke($e=>$e+1)};Q();const ce=window.setInterval(Q,_);return()=>window.clearInterval(ce)},[s,n,ee.length,te,_]);const W=a.useMemo(()=>Hn(11),[]),[F,ye]=a.useState(new Set(["root"])),[we,je]=a.useState(new Set),[Fe,Te]=a.useState(new Set),[qe,ze]=a.useState({fromId:"root",toId:"root",key:0}),Ne=a.useRef(F),We=a.useRef("root"),et=a.useRef(0),Ze=a.useRef(null),D=a.useRef(null),H=a.useRef([]);a.useEffect(()=>{Ne.current=F},[F]);const Ue=a.useMemo(()=>{const Q=new Set;return F.forEach(ce=>{const $e=W.linksByFrom.get(ce);$e&&$e.forEach(L=>Q.add(L))}),Q},[F,W]),Ce=W.nodesById.get(qe.toId)??W.nodesById.get("root"),ne=Ce?`${Ce.x/va.width*100}%`:"50%",Ae=Ce?`${Ce.y/va.height*100}%`:"90%";a.useEffect(()=>{if(!n||s!==1||i)return;(()=>{ye(new Set(["root"])),je(new Set),Te(new Set),ze({fromId:"root",toId:"root",key:0}),D.current=null,et.current=0,We.current="root",H.current=[]})();const ce=()=>{const L=We.current,V=Ne.current,ke=(W.childrenByFrom.get(L)??[]).filter(ve=>!V.has(ve));if(ke.length)return ke[Math.floor(Math.random()*ke.length)];if(V.size>=W.nodes.length){const ve=W.neighborsById.get(L)??[];return ve.length?ve[Math.floor(Math.random()*ve.length)]:null}const xe=ve=>(W.childrenByFrom.get(ve)??[]).some(Qe=>!V.has(Qe)),Le=[L],Ve=new Set([L]),He=new Map;let Me=null;for(;Le.length;){const ve=Le.shift();if(!ve)break;if(ve!==L&&xe(ve)){Me=ve;break}(W.neighborsById.get(ve)??[]).forEach(Qe=>{Ve.has(Qe)||(Ve.add(Qe),He.set(Qe,ve),Le.push(Qe))})}if(!Me)return null;let Re=Me;for(;He.get(Re)&&He.get(Re)!==L;)Re=He.get(Re)??Re;return Re},$e=(L,V)=>{if(L===V){const ie=ce();ie&&$e(L,ie);return}et.current+=1,ze({fromId:L,toId:V,key:et.current}),We.current=V,Ze.current=window.setTimeout(()=>{const ie=W.parentsById.get(V)??[],ke=Ne.current,xe=ie.filter(Me=>!ke.has(Me));if(!xe.length){const Me=new Set(ke);Me.add(V),ye(Me),Ze.current=window.setTimeout(()=>{for(;H.current.length;){const ve=H.current[H.current.length-1];if(!Me.has(ve)){if(ve!==V){$e(V,ve);return}break}H.current.pop()}const Re=ce();Re&&$e(V,Re)},ya.pauseMs);return}const Le=new Set([V,...xe]),Ve=new Set(xe.map(Me=>`${Me}-${V}`));je(Le),Te(Ve),H.current.includes(V)||H.current.push(V);const He=xe[Math.floor(Math.random()*xe.length)];D.current={fromId:V,toId:He},Ze.current=window.setTimeout(()=>{je(new Set),Te(new Set);const Me=D.current;Me&&$e(Me.fromId,Me.toId)},ya.errorMs)},ya.moveMs)};return Ze.current=window.setTimeout(()=>{const L=ce();L&&$e(We.current,L)},ya.pauseMs),()=>{Ze.current&&window.clearTimeout(Ze.current)}},[s,n,W,i]);const Be=Q=>{if(!n)return;const ce=Date.now();ce-q.current<520||Math.abs(Q.deltaY)<10||(q.current=ce,Q.deltaY>0?l():m(),Q.preventDefault())},De=Q=>{if(!n)return;const ce=Q.touches[0];ce&&(k.current={x:ce.clientX,y:ce.clientY})},_e=Q=>{if(!n)return;const ce=k.current;if(k.current=null,!ce)return;const $e=Q.changedTouches[0];if(!$e)return;const L=$e.clientX-ce.x,V=$e.clientY-ce.y;Math.abs(V)<40||Math.abs(V)<Math.abs(L)||(V<0?l():m())};return e.jsxs("div",{className:`cogita-intro ${n?"is-open":"is-closed"} ${i?"is-reduced":""} ${d?"is-final":""}`,"data-slide":s+1,onWheel:Be,onTouchStart:De,onTouchEnd:_e,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":j,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${Y&&!h?"is-entry":""}`,children:se.map((Q,ce)=>e.jsx("img",{src:Q.src,alt:"",className:`cogita-logo-layer ${ce===0?"is-base":""} ${Q.kind==="text"?"is-text":Q.kind==="recreatio"?"is-recreatio":""} ${Q.kind==="bubble"?"is-bubble":""}`},Q.src))})}),n&&t.map((Q,ce)=>{const $e=ce===s;return e.jsxs("section",{className:`cogita-intro-slide slide-${ce+1} ${$e?"is-active":""}`,"aria-hidden":!$e,children:[e.jsxs("div",{className:"cogita-intro-text",children:[Q.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:Q.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:Q.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:Q.title}),Q.body&&e.jsx("p",{children:Q.body.split(`
`).map((L,V)=>e.jsxs("span",{children:[L,V===0&&e.jsx("br",{})]},String(V)))})]}),Q.micro&&e.jsx("p",{className:"cogita-intro-micro",children:Q.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:d?N:l,children:Q.cta}),d&&Q.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>p(0),children:Q.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[ce===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${va.width} ${va.height}`,preserveAspectRatio:"none",children:[W.links.map(L=>{const V=W.nodesById.get(L.from),ie=W.nodesById.get(L.to);if(!V||!ie)return null;const ke=Ue.has(L.key),xe=Fe.has(L.key);return e.jsx("line",{className:`map-link ${ke?"is-active":""} ${xe?"is-error":""}`,x1:V.x,y1:V.y,x2:ie.x,y2:ie.y},L.key)}),W.nodes.map(L=>{const V=F.has(L.id),ie=we.has(L.id);return e.jsx("circle",{className:`map-node ${L.role?`is-${L.role}`:""} ${V?"is-active":""} ${ie?"is-error":""}`,cx:L.x,cy:L.y,r:L.r},L.id)})]}),Ce&&e.jsx("span",{className:"map-explorer-dot",style:{left:ne,top:Ae,"--move":`${ya.moveMs}ms`}})]}),ce===2&&e.jsx("div",{className:"cogita-index-cards",children:$.map(L=>{const V=I.indexOf(L.id),ie=V>=0?G[V]:null,ke=(ie==null?void 0:ie.x)??"140px",xe=(ie==null?void 0:ie.y)??"140px",Le=V>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":L.throw.x,"--throw-y":L.throw.y,"--throw-rot":L.throw.rot,"--grid-x":L.grid.x,"--grid-y":L.grid.y,"--stack-x":ke,"--stack-y":xe,"--stack-opacity":Le,"--delay":L.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},L.id)})}),ce===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[ee.map((L,V)=>e.jsxs("div",{className:`round-card ${V===pe?"is-active":""}`,style:{"--card-x":L.x,"--card-y":L.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},L.id)),ee[pe]&&e.jsx("span",{className:"round-ring",style:{"--card-x":ee[pe].x,"--card-y":`calc(${ee[pe].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:te.map(L=>e.jsx("span",{className:"player-dot",style:{left:L.x,top:L.y,"--jitter-x":L.jitterX,"--jitter-y":L.jitterY,"--breath-delay":L.delay}},L.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:ge.map(L=>e.jsx("line",{className:"round-link",x1:L.from.xNum,y1:L.from.yNum,x2:L.to.xNum,y2:L.to.yNum,style:{"--delay":L.delay}},L.id))}),e.jsx("div",{className:"round-flows",children:te.map((L,V)=>{const ie=fe[V]??"good",ke=ee[pe];if(!ke)return null;const xe=`calc(${ke.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":L.x,"--from-y":L.y,"--to-x":ke.x,"--to-y":xe,"--delay":`${V*.12}s`}}),e.jsx("span",{className:`return-dot is-${ie}`,style:{"--from-x":ke.x,"--from-y":xe,"--to-x":L.x,"--to-y":L.y,"--delay":`${V*.12}s`}}),e.jsx("span",{className:`result-pop is-${ie}`,style:{"--at-x":L.x,"--at-y":L.y,"--delay":`${V*.12}s`}})]},`${L.id}-${ae}`)})})]},`round-${ae}`),ce===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${g[0].x} ${g[0].y} L${g[1].x} ${g[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${g[1].x} ${g[1].y} L${g[2].x} ${g[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${g[2].x} ${g[2].y} L${g[3].x} ${g[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${g[3].x} ${g[3].y} L${g[4].x} ${g[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${g[4].x} ${g[4].y} L${g[5].x} ${g[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${g[5].x} ${g[5].y} L${g[6].x} ${g[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${z};${z};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${ue.upper.map((L,V)=>`${V===0?"M":"L"}${L.x} ${L.y}`).join(" ")} ${ue.lower.slice().reverse().map(L=>`L${L.x} ${L.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${ue.upper.map((L,V)=>`${V===0?"M":"L"}${L.x} ${L.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${ue.lower.map((L,V)=>`${V===0?"M":"L"}${L.x} ${L.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[f.higher.slice(0,6).map((L,V)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${V+1}`,d:`M${L.x} ${L.y} L${f.higher[V+1].x} ${f.higher[V+1].y}`,pathLength:"100"},`peer-1-${V}`)),f.lower.slice(0,6).map((L,V)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${V+1}`,d:`M${L.x} ${L.y} L${f.lower[V+1].x} ${f.lower[V+1].y}`,pathLength:"100"},`peer-2-${V}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${g[0].x/300*100}%`,"--p0y":`${g[0].y/200*100}%`,"--p1x":`${g[1].x/300*100}%`,"--p1y":`${g[1].y/200*100}%`,"--p2x":`${g[2].x/300*100}%`,"--p2y":`${g[2].y/200*100}%`,"--p3x":`${g[3].x/300*100}%`,"--p3y":`${g[3].y/200*100}%`,"--p4x":`${g[4].x/300*100}%`,"--p4y":`${g[4].y/200*100}%`,"--p5x":`${g[5].x/300*100}%`,"--p5y":`${g[5].y/200*100}%`,"--p6x":`${g[6].x/300*100}%`,"--p6y":`${g[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${f.higher[0].x/300*100}%`,"--q0y":`${f.higher[0].y/200*100}%`,"--q1x":`${f.higher[1].x/300*100}%`,"--q1y":`${f.higher[1].y/200*100}%`,"--q2x":`${f.higher[2].x/300*100}%`,"--q2y":`${f.higher[2].y/200*100}%`,"--q3x":`${f.higher[3].x/300*100}%`,"--q3y":`${f.higher[3].y/200*100}%`,"--q4x":`${f.higher[4].x/300*100}%`,"--q4y":`${f.higher[4].y/200*100}%`,"--q5x":`${f.higher[5].x/300*100}%`,"--q5y":`${f.higher[5].y/200*100}%`,"--q6x":`${f.higher[6].x/300*100}%`,"--q6y":`${f.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${f.lower[0].x/300*100}%`,"--q0y":`${f.lower[0].y/200*100}%`,"--q1x":`${f.lower[1].x/300*100}%`,"--q1y":`${f.lower[1].y/200*100}%`,"--q2x":`${f.lower[2].x/300*100}%`,"--q2y":`${f.lower[2].y/200*100}%`,"--q3x":`${f.lower[3].x/300*100}%`,"--q3y":`${f.lower[3].y/200*100}%`,"--q4x":`${f.lower[4].x/300*100}%`,"--q4y":`${f.lower[4].y/200*100}%`,"--q5x":`${f.lower[5].x/300*100}%`,"--q5y":`${f.lower[5].y/200*100}%`,"--q6x":`${f.lower[6].x/300*100}%`,"--q6y":`${f.lower[6].y/200*100}%`}})]})})}),ce===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),ce===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},Q.id)}),!n&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:c.title}),c.body&&e.jsx("p",{children:c.body}),c.micro&&e.jsx("p",{className:"cogita-intro-micro",children:c.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:N,children:c.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:E,children:"Otwórz pokaz"})]})]})})]}),n&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((Q,ce)=>e.jsx("button",{type:"button",className:`dot ${s===ce?"active":""}`,"aria-label":Q.title,onClick:()=>p(ce)},Q.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:v,children:"Pomiń"})]})]})}const Yn=6,Gn=4;function Xn({copy:t,onAuthAction:s,authLabel:n,showProfileMenu:i,onProfileNavigate:l,onToggleSecureMode:m,onLogout:p,secureMode:v,onNavigate:E,language:N,onLanguageChange:d}){const j=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}E("home")},c=a.useRef(null),h=a.useRef([]),S=a.useMemo(()=>{let x=Date.now()%2147483647;const _=()=>(x=x*48271%2147483647,x/2147483647);return Array.from({length:Yn},(ge,W)=>{const F=6+_()*8,ye=7+_()*10,we=6+_()*9,je=-_()*F,Fe=-_()*ye,Te=-_()*we,qe=.18+_()*.28,ze=12+_()*18,Ne=4+_()*8,We=(_()-.5)*3.2,et=(_()-.5)*3.8,Ze=_()>.5?"alternate":"alternate-reverse",D=_()>.5?"alternate":"alternate-reverse",H=_()>.5?"alternate":"alternate-reverse",Ue=.18+_()*.42,Ce=30+_()*60,ne=-45-_()*38,Ae=188+_()*32,Be=.1+_()*.2;return{id:`wave-${W+1}`,style:{"--wave-sway-duration":`${F}s`,"--wave-scale-duration":`${ye}s`,"--wave-drift-duration":`${we}s`,"--wave-sway-delay":`${je}s`,"--wave-scale-delay":`${Fe}s`,"--wave-drift-delay":`${Te}s`,"--wave-sway-dir":Ze,"--wave-scale-dir":D,"--wave-drift-dir":H,"--wave-scale":`${qe}`,"--wave-shift":`${ze}%`,"--wave-xshift":`${Ne}%`,"--wave-x0":`${We}%`,"--wave-y0":`${et}%`,"--wave-opacity":`${Ue}`,"--wave-blur":`${Ce}px`,"--wave-bottom":`${ne}%`,"--wave-hue":`${Ae}`,"--wave-glow":`${Be}`}}})},[]),se=a.useMemo(()=>{let x=Date.now()*3%2147483647;const _=()=>(x=x*48271%2147483647,x/2147483647);return Array.from({length:Gn},(ge,W)=>{const F=180+_()*220,ye=220+_()*280,we=-_()*F,je=-_()*ye,Fe=.12+_()*.22,Te=3+_()*7,qe=1+_()*3,ze=(_()-.5)*2.8,Ne=(_()-.5)*2.2;return{id:`mesh-${W+1}`,seed:1e3+W*991+Math.floor(_()*999),style:{"--mesh-sway-duration":`${F}s`,"--mesh-drift-duration":`${ye}s`,"--mesh-sway-delay":`${we}s`,"--mesh-drift-delay":`${je}s`,"--mesh-scale":`${Fe}`,"--mesh-shift":`${Te}%`,"--mesh-xshift":`${qe}%`,"--mesh-x0":`${Ne}%`,"--mesh-y0":`${ze}%`}}})},[]),Y=a.useMemo(()=>{const x=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],_=t.cogita.introSlides,ge=new Map(_.map(W=>[W.id,W]));return x.map(W=>{var ye;const F=ge.get(W.id);return{...W,...F,title:(F==null?void 0:F.title)??"Cogita",cta:(F==null?void 0:F.cta)??((ye=t.cogita.introSlides[0])==null?void 0:ye.cta)??t.cogita.loginCta,secondary:F==null?void 0:F.secondary}})},[t.cogita.introSlides]),[q,k]=a.useState(0),[g,ue]=a.useState(!0),[z,f]=a.useState(!1),U=Y.length-1,$=a.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),G=a.useCallback(()=>{$(),s()},[$,s]),I=a.useCallback(()=>{ue(!0),k(0)},[]),R=a.useCallback(()=>{ue(!1),k(U)},[U]),ee=a.useCallback(x=>{k(Math.max(0,Math.min(U,x)))},[U]),te=a.useCallback(()=>{q>=U?G():ee(q+1)},[q,ee,G,U]),ae=a.useCallback(()=>{ee(q-1)},[q,ee]);a.useEffect(()=>{var ge;const x=(ge=window.matchMedia)==null?void 0:ge.call(window,"(prefers-reduced-motion: reduce)");if(!x)return;const _=()=>f(x.matches);return _(),x.addEventListener?(x.addEventListener("change",_),()=>x.removeEventListener("change",_)):(x.addListener(_),()=>x.removeListener(_))},[]),a.useEffect(()=>{if(!g)return;const x=_=>{const ge=_.target;if(!ge)return;const W=ge.tagName;if(!(ge.isContentEditable||W==="INPUT"||W==="TEXTAREA"||W==="SELECT"||W==="BUTTON"||W==="A"||ge.closest('button, a, [role="button"], [role="link"]'))){if(_.key==="Escape"){R();return}if(_.key==="ArrowLeft"||_.key==="ArrowUp"){ae();return}(_.key==="ArrowRight"||_.key==="ArrowDown"||_.code==="Space"||_.key===" ")&&(_.preventDefault(),te())}};return window.addEventListener("keydown",x),()=>window.removeEventListener("keydown",x)},[R,te,ae,g]),a.useEffect(()=>{g&&q===U&&$()},[q,g,U,$]),a.useEffect(()=>{const x=c.current;if(!x)return;const _=h.current.filter(ne=>!!ne);if(!_.length)return;const ge=1,W=.6,F=.6,ye=Math.max(1,Math.min(ge,window.devicePixelRatio||1));let we=0,je=0,Fe=W,Te=0,qe=0;const ze=ne=>{let Ae=ne%2147483647;return Ae<=0&&(Ae+=2147483646),(Be,De)=>{Ae=Ae*48271%2147483647;const _e=Ae/2147483647;return Be+_e*(De-Be)}},Ne={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},We=ne=>{const Ae=Math.sin(ne*12.9898)*43758.5453;return Ae-Math.floor(Ae)},et=ne=>{const Ae=We(ne+.1)||1e-4,Be=We(ne+.7)||1e-4;return Math.sqrt(-2*Math.log(Ae))*Math.cos(2*Math.PI*Be)},Ze=(ne,Ae)=>{const Be=Math.floor(ne),De=Be+1,_e=ne-Be,Q=_e*_e*(3-2*_e),ce=We(Be*12.9898+Ae*78.233),$e=We(De*12.9898+Ae*78.233);return ce+($e-ce)*Q},D=ne=>{const Ae=ze(ne),Be=Math.min(4,Math.max(4,Math.floor(we/1200*Ne.filamentCount)));return Array.from({length:Be},(De,_e)=>{const Q=Math.max(-1,Math.min(1,et(ne+_e*.37))),ce=Math.min(1,Math.max(0,We(ne+_e*1.31))),$e=Math.min(Ne.depthLayers-1,Math.floor(ce*Ne.depthLayers));return{seed:Ae(0,Math.PI*2)+ne*.01,offset:Q,freqA:Ne.freq1*(.75+Ae(0,.5)),freqB:Ne.freq2*(.75+Ae(0,.5)),ampA:Ne.amp1*(.6+Ae(0,.7)),ampB:Ne.amp2*(.6+Ae(0,.7)),width:2+_e%5*.32,depth:ce,layer:$e}})},H=(ne,Ae,Be)=>{const De=Math.max(30,Math.floor(we*je/14e4));ne.save(),ne.globalAlpha=.6;for(let _e=0;_e<De;_e+=1){const Q=We(_e*9.1+we*.11)*Ae+Be,ce=We(_e*3.7+je*.23)*je,$e=1.2+We(_e*5.9)*2.4,L=ne.createRadialGradient(Q,ce,0,Q,ce,$e*2);L.addColorStop(0,"rgba(10, 30, 60, 0.45)"),L.addColorStop(1,"rgba(10, 30, 60, 0)"),ne.fillStyle=L,ne.beginPath(),ne.arc(Q,ce,$e*2,0,Math.PI*2),ne.fill()}ne.restore()},Ue=(ne,Ae)=>{ne.clearRect(0,0,we,je);const Be=je*Ne.waveCenter,De=Ne.waveBandPx,_e=Ne.segments,Q=Ne.colors.filaments,ce=Te||we,$e=0;H(ne,ce,$e),ne.strokeStyle=Q,ne.lineCap="round",ne.lineJoin="round";for(let L=0;L<Ae.length;L+=1){const V=Ae[L],ie=V.offset*De*(.85+We(V.seed)*.4),ke=1-Math.min(1,Math.abs(ie)/De),xe=Math.exp(-Math.pow(ie/Ne.crestThickness,2)),Le=V.layer===0?1.1:V.layer===1?.85:.6,Ve=.35+(1-V.depth)*.65,He=ke*Ve*Le*(.34+xe*.45);ne.globalAlpha=He,ne.lineWidth=V.width*(1+(1-V.depth)*.8);const Me=[];for(let ve=0;ve<=_e;ve+=1){const nt=ve/_e*ce+$e,Qe=(Ze(nt*.012,V.seed)-.5)*Ne.xJitter,Ye=nt+Qe,pt=(Ze(Ye*V.freqA,V.seed)-.5)*Ne.jitterA,bt=(Ze(Ye*V.freqB,V.seed*1.7)-.5)*Ne.jitterB,Je=Be+Math.sin(Ye*V.freqA+V.seed)*V.ampA+Math.sin(Ye*V.freqB+V.seed*1.3)*V.ampB+ie+pt+bt;Me.push({x:Ye,y:Je})}ne.beginPath(),ne.moveTo(Me[0].x,Me[0].y);for(let ve=1;ve<Me.length-1;ve+=1){const nt=(Me[ve].x+Me[ve+1].x)/2,Qe=(Me[ve].y+Me[ve+1].y)/2;ne.quadraticCurveTo(Me[ve].x,Me[ve].y,nt,Qe)}const Re=Me[Me.length-1];ne.quadraticCurveTo(Re.x,Re.y,Re.x,Re.y),ne.stroke()}ne.save(),ne.globalCompositeOperation="lighter",ne.strokeStyle=Ne.colors.glow,ne.lineCap="round",ne.lineJoin="round";for(let L=0;L<Ae.length;L+=1){const V=Ae[L];if(Math.abs(V.offset)*De>Ne.crestThickness)continue;const ie=Ne.glowAlpha*(.7+(1-V.depth)*.6);ne.globalAlpha=ie,ne.lineWidth=1.6+(1-V.depth)*1.2;const ke=[];for(let Le=0;Le<=_e;Le+=1){const Ve=Le/_e*ce+$e,He=Math.sin(Ve*.02+V.seed)*3,Me=Be+Math.sin(Ve*V.freqA+V.seed)*V.ampA+Math.sin(Ve*V.freqB+V.seed*1.3)*V.ampB+V.offset*De*.35+He;ke.push({x:Ve,y:Me})}ne.beginPath(),ne.moveTo(ke[0].x,ke[0].y);for(let Le=1;Le<ke.length-1;Le+=1){const Ve=(ke[Le].x+ke[Le+1].x)/2,He=(ke[Le].y+ke[Le+1].y)/2;ne.quadraticCurveTo(ke[Le].x,ke[Le].y,Ve,He)}const xe=ke[ke.length-1];ne.quadraticCurveTo(xe.x,xe.y,xe.x,xe.y),ne.stroke()}ne.restore()},Ce=()=>{we=Math.floor(x.clientWidth),je=Math.floor(x.clientHeight),Te=Math.floor(we*1.8),qe=je,Fe=we<820?F:W,_.forEach(ne=>{const Ae=ne.getContext("2d");if(!Ae)return;ne.width=Math.floor(Te*ye*Fe),ne.height=Math.floor(qe*ye*Fe),ne.style.width=`${Te}px`,ne.style.height=`${qe}px`,ne.style.left=`${-(Te-we)/2}px`,Ae.setTransform(ye*Fe,0,0,ye*Fe,0,0);const Be=Number(ne.dataset.seed||1),De=D(Be);Ue(Ae,De)})};return Ce(),window.addEventListener("resize",Ce,{passive:!0}),()=>window.removeEventListener("resize",Ce)},[se]);const Ke=Y[Math.min(q,Y.length-1)],pe=g?Ke:Y[Y.length-1],C=(pe==null?void 0:pe.theme)??Y[0].theme,fe={"--cogita-bg0":C.bg0,"--cogita-bg1":C.bg1,"--cogita-bg2":C.bg2,"--cogita-bloom":C.bloom,"--cogita-sat":C.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:j,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Ds,{value:N,onChange:d}),e.jsx(_s,{copy:t,label:n,isAuthenticated:i,secureMode:v,onLogin:s,onProfileNavigate:l,onToggleSecureMode:m,onLogout:p,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:c,className:"cogita-section cogita-home",style:fe,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[se.map((x,_)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:x.style,"data-seed":x.seed,ref:ge=>{h.current[_]=ge}},x.id)),S.map(x=>e.jsx("div",{className:"cogita-home-wave",style:x.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},x.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(Qn,{slides:Y,activeIndex:q,introOpen:g,prefersReducedMotion:z,onNext:te,onPrev:ae,onSelect:ee,onExit:R,onOpen:I,onRegister:G})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const ar=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:Xn},Symbol.toStringTag,{value:"Module"})),Hs=a.createContext(!1);function Tt({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,children:d}){if(a.useContext(Hs))return e.jsx(e.Fragment,{children:d});const c=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}v("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:c,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Ds,{value:E,onChange:N}),e.jsx(_s,{copy:t,label:s,isAuthenticated:n,secureMode:p,onLogin:()=>v("home"),onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:d}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function Ot(t){const[s,n]=a.useState("Cogita library"),[i,l]=a.useState(null);return a.useEffect(()=>{let m=!1;return Vs().then(p=>{if(m)return;const v=p.find(E=>E.libraryId===t);v&&n(v.name)}).catch(()=>{m||n("Cogita library")}),()=>{m=!0}},[t]),a.useEffect(()=>{let m=!1;return dn(t).then(p=>{m||l(p)}).catch(()=>{m||l(null)}),()=>{m=!0}},[t]),{libraryName:s,stats:i}}function ws({slices:t}){const s=t.reduce((i,l)=>i+Math.max(0,l.value),0),n=a.useMemo(()=>{if(s<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let i=0;return`conic-gradient(${t.map(m=>{const v=Math.max(0,m.value)/s*360,E=i,N=i+v;return i=N,`${m.color} ${E}deg ${N}deg`}).join(",")})`},[t,s]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:n}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(i=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:i.color}}),e.jsx("strong",{children:i.value}),e.jsx("small",{children:i.label})]},i.label))})]})}function Jn({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,libraryId:d}){const{libraryName:j,stats:c}=Ot(d),[h,S]=a.useState("infos"),[se,Y]=a.useState(0),[q,k]=a.useState(0),[g,ue]=a.useState(0),z=(c==null?void 0:c.totalInfos)??0,f=(c==null?void 0:c.totalCollections)??0,U=0,$=0,G=0,I=Math.max(0,z-G-q),R=Math.max(0,z-q-g);a.useEffect(()=>{let te=!1;return(async()=>{try{const Ke=await wa({libraryId:d,limit:200}),pe=await Promise.all(Ke.items.map(C=>Os({libraryId:d,collectionId:C.collectionId}).catch(()=>[])));if(te)return;Y(pe.reduce((C,fe)=>C+fe.length,0))}catch{te||Y(0)}})(),()=>{te=!0}},[d]),a.useEffect(()=>{let te=!1;return(async()=>{try{const[Ke,pe,C]=await Promise.all([bs({libraryId:d,type:"computed",limit:1}).catch(()=>({total:0})),bs({libraryId:d,type:"source",limit:1}).catch(()=>({total:0})),us({libraryId:d}).catch(()=>({items:[]}))]);if(te)return;k((Ke.total??0)+(pe.total??0));const fe=new Set(C.items.filter(x=>x.childItemType.toLowerCase()==="info").map(x=>x.childItemId).filter(Boolean));ue(fe.size)}catch{te||(k(0),ue(0))}})(),()=>{te=!0}},[d]);const ee=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:z},{key:"collections",label:t.cogita.library.overview.stats.collections,value:f},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:se},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:U},{key:"texts",label:t.cogita.library.overview.stats.texts,value:$}];return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:j})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:ee.map(te=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${h===te.key?"active":""}`,onClick:()=>S(te.key),children:[e.jsx("span",{children:te.label}),e.jsx("strong",{children:te.value})]},te.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),h==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(ws,{slices:[{label:t.cogita.library.overview.known,value:G,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:I,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:q,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(ws,{slices:[{label:t.cogita.library.overview.availableChecks,value:g,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:R,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const Xe=(t,s)=>{const n=t.cogita.library.infoTypes,i=t.cogita.library.connectionTypes,l=t.cogita.library.groupTypes;return{any:n.any,vocab:n.vocab,book:l.book,citation:l.citation,language:n.language,word:n.word,sentence:n.sentence,topic:n.topic,collection:n.collection,person:n.person,institution:n.institution,collective:n.collective,orcid:n.orcid,address:n.address,email:n.email,phone:n.phone,media:n.media,work:n.work,geo:n.geo,music_piece:n.musicPiece,music_fragment:n.musicFragment,source:n.source,computed:n.computed,"word-language":i.wordLanguage,"quote-language":i.quoteLanguage,"language-sentence":i.languageSentence,translation:i.translation,"word-topic":i.wordTopic,reference:i.reference,"source-resource":i.sourceResource,"work-contributor":i.workContributor,"work-medium":i.workMedium,"orcid-link":i.orcidLink}[s]??String(s)},Zn=t=>[{value:"any",label:Xe(t,"any")},{value:"language",label:Xe(t,"language")},{value:"word",label:Xe(t,"word")},{value:"sentence",label:Xe(t,"sentence")},{value:"topic",label:Xe(t,"topic")},{value:"collection",label:Xe(t,"collection")},{value:"person",label:Xe(t,"person")},{value:"institution",label:Xe(t,"institution")},{value:"collective",label:Xe(t,"collective")},{value:"orcid",label:Xe(t,"orcid")},{value:"address",label:Xe(t,"address")},{value:"email",label:Xe(t,"email")},{value:"phone",label:Xe(t,"phone")},{value:"media",label:Xe(t,"media")},{value:"work",label:Xe(t,"work")},{value:"geo",label:Xe(t,"geo")},{value:"music_piece",label:Xe(t,"music_piece")},{value:"music_fragment",label:Xe(t,"music_fragment")},{value:"source",label:Xe(t,"source")},{value:"citation",label:Xe(t,"citation")},{value:"computed",label:Xe(t,"computed")},{value:"vocab",label:Xe(t,"vocab")},{value:"book",label:Xe(t,"book")},{value:"word-language",label:Xe(t,"word-language")},{value:"quote-language",label:Xe(t,"quote-language")},{value:"language-sentence",label:Xe(t,"language-sentence")},{value:"translation",label:Xe(t,"translation")},{value:"word-topic",label:Xe(t,"word-topic")},{value:"reference",label:Xe(t,"reference")},{value:"source-resource",label:Xe(t,"source-resource")},{value:"work-contributor",label:Xe(t,"work-contributor")},{value:"work-medium",label:Xe(t,"work-medium")},{value:"orcid-link",label:Xe(t,"orcid-link")}],ei=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Ja={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},ti={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code","notes"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","notes","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Ja]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","notes","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Ja]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name","notes"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid","notes"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country","notes"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address","notes"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number","notes"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind","notes"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId","notes"]},filterFields:[Ja,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city","notes"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer","notes"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text","notes"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator","notes"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text","notes"],connections:[{relationType:"quote-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"quote",kind:"text",path:"text",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition","notes"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},js={infoType:"default",entityKind:"single",structure:{payloadFields:["label","notes"]},filterFields:[]};function ai(t){return t?ti[t]??js:js}function si(t,s){return t.optionsSource==="languages"?s.languages.map(n=>({value:n.infoId,label:n.label})):t.optionsSource==="sourceKinds"?ei:[]}const Za=60,ni=500;function Qs(t){return`cogita.info-selection:${t}`}function ks(t){if(typeof window>"u")return{};const s=window.localStorage.getItem(Qs(t));if(!s)return{};try{const n=JSON.parse(s);return!n||typeof n!="object"?{}:n}catch{return{}}}function ii({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,libraryId:d,mode:j}){var Mt,Rt;const c=Es(),h=_a(),S=t.cogita.library.list,[se,Y]=a.useState("any"),[q,k]=a.useState(""),[g,ue]=a.useState("relevance"),[z,f]=a.useState("details"),[U,$]=a.useState(!1),[G,I]=a.useState("idle"),[R,ee]=a.useState([]),[te,ae]=a.useState(Za),[Ke,pe]=a.useState(null),[C,fe]=a.useState(()=>ks(d)),[x,_]=a.useState({}),[ge,W]=a.useState([]),[F,ye]=a.useState(null),[we,je]=a.useState(null),[Fe,Te]=a.useState(null),[qe,ze]=a.useState("idle"),[Ne,We]=a.useState([]),[et,Ze]=a.useState(""),[D,H]=a.useState(null),[Ue,Ce]=a.useState("idle"),[ne,Ae]=a.useState(null),[Be,De]=a.useState(null),[_e,Q]=a.useState("idle"),ce=a.useMemo(()=>Zn(t),[t]),$e=a.useMemo(()=>[{value:"relevance",label:S.sortRelevance},{value:"label_asc",label:S.sortLabelAsc},{value:"label_desc",label:S.sortLabelDesc},{value:"type_asc",label:S.sortTypeAsc},{value:"type_desc",label:S.sortTypeDesc}],[S.sortLabelAsc,S.sortLabelDesc,S.sortRelevance,S.sortTypeAsc,S.sortTypeDesc]);a.useEffect(()=>{fe(ks(d)),_({}),$(!1)},[d]),a.useEffect(()=>{us({libraryId:d}).then(B=>Te(B)).catch(()=>Te({items:[]}))},[d]),a.useEffect(()=>{un({libraryId:d}).then(B=>We(B)).catch(()=>We([]))},[d]),a.useEffect(()=>{ys({libraryId:d,type:"language",filters:{sourceKind:"info"},limit:200}).then(B=>{const be=B.map(o=>({infoId:o.infoId??"",infoType:o.entityType,label:o.title})).filter(o=>o.infoId.length>0);W(be)}).catch(()=>W([]))},[d]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(Qs(d),JSON.stringify(C))},[d,C]);const L=a.useMemo(()=>ai(se==="any"?null:se),[se]),V=a.useMemo(()=>new URLSearchParams(h.search),[h.search]),ie=(V.get("infoId")??"").trim()||null,ke=(V.get("infoView")??"").trim(),xe=ke==="overview"&&!!ie,Le=a.useMemo(()=>({language:S.typeFilterLanguage,languageA:S.typeFilterLanguageA,languageB:S.typeFilterLanguageB,originalLanguage:S.typeFilterOriginalLanguage,doi:S.typeFilterDoi,sourceKind:S.typeFilterSourceKind,locator:S.typeFilterLocator,quote:S.typeFilterQuote}),[S.typeFilterDoi,S.typeFilterLanguage,S.typeFilterLanguageA,S.typeFilterLanguageB,S.typeFilterLocator,S.typeFilterOriginalLanguage,S.typeFilterQuote,S.typeFilterSourceKind]),Ve=a.useMemo(()=>L.filterFields.map(B=>({...B,label:B.labelKey?Le[B.labelKey]:B.label??B.key,options:si(B,{languages:ge})})),[Le,ge,L.filterFields]),He=a.useMemo(()=>Ve.some(B=>(x[B.key]??"").trim().length>0),[Ve,x]);a.useEffect(()=>{_({})},[se]),a.useEffect(()=>{const B={sourceKind:"info"};if(He)for(const o of Ve){const me=(x[o.key]??"").trim();me&&(B[o.path??o.key]=me)}I("loading");const be=window.setTimeout(()=>{ys({libraryId:d,type:se==="any"?void 0:se,query:q.trim()||void 0,filters:B,limit:ni}).then(o=>{const me=o.map(J=>({infoId:J.infoId??"",infoType:J.entityType,label:J.title})).filter(J=>J.infoId.length>0);ee(me),I("ready")}).catch(()=>{ee([]),I("ready")})},240);return()=>window.clearTimeout(be)},[He,d,q,se,Ve,x]),a.useEffect(()=>{if(!ie||ke!=="overview"){ye(null),je(null),ze("idle");return}let B=!1;return ze("loading"),Promise.all([aa({libraryId:d,infoId:ie}),hn({libraryId:d,itemType:"info",itemId:ie}).catch(()=>null)]).then(([be,o])=>{B||(ye(be),je(o),ze("ready"))}).catch(()=>{B||(ye(null),je(null),ze("error"))}),()=>{B=!0}},[d,ie,ke]),a.useEffect(()=>{if(!ie||ke!=="overview"){Ae(null),De(null),Q("idle");return}let B=!1;return Q("loading"),Promise.all([gn({libraryId:d,infoId:ie}),mn({libraryId:d,infoId:ie})]).then(([be,o])=>{B||(Ae(be),De(o),Q("ready"))}).catch(()=>{B||(Ae(null),De(null),Q("error"))}),()=>{B=!0}},[d,ie,ke]);const Me=a.useMemo(()=>F?Ne.filter(B=>B.sourceInfoTypes.some(be=>be.toLowerCase()===F.infoType.toLowerCase())):[],[Ne,F]);a.useEffect(()=>{if(!F){Ze("");return}Ze(B=>{var be;return B&&Me.some(o=>o.approachKey===B)?B:((be=Me[0])==null?void 0:be.approachKey)??""})},[Me,F]),a.useEffect(()=>{if(!F||!et){H(null),Ce("idle");return}let B=!1;return Ce("loading"),pn({libraryId:d,infoId:F.infoId,approachKey:et}).then(be=>{B||(H(be),Ce("ready"))}).catch(()=>{B||(H(null),Ce("error"))}),()=>{B=!0}},[d,et,F]);const Re=a.useMemo(()=>{const B=R.slice(),be=o=>Xe(t,o);return g==="relevance"?B:g==="label_asc"?B.sort((o,me)=>o.label.localeCompare(me.label)):g==="label_desc"?B.sort((o,me)=>me.label.localeCompare(o.label)):g==="type_asc"?B.sort((o,me)=>o.infoType===me.infoType?o.label.localeCompare(me.label):be(o.infoType).localeCompare(be(me.infoType))):B.sort((o,me)=>o.infoType===me.infoType?o.label.localeCompare(me.label):be(me.infoType).localeCompare(be(o.infoType)))},[t,R,g]),ve=a.useMemo(()=>Re.slice(0,te),[Re,te]),nt=ve.length<Re.length,Qe=a.useMemo(()=>new Set(Object.keys(C)),[C]),Ye=a.useMemo(()=>Object.values(C),[C]),pt=a.useMemo(()=>{const B=new Map;for(const be of Ye)B.set(be.infoType,(B.get(be.infoType)??0)+1);return Array.from(B.entries()).sort((be,o)=>o[1]-be[1]||be[0].localeCompare(o[0]))},[Ye]),bt=a.useMemo(()=>{if(!ie||!Fe)return 0;const B=new Set;for(const be of Fe.items)be.childItemType!=="info"||be.childItemId!==ie||B.add([be.parentItemType,be.parentItemId,be.parentCheckType??"",be.parentDirection??""].join("|"));return B.size},[Fe,ie]);a.useEffect(()=>{ae(Za);const B=new Set(R.map(be=>be.infoId));pe(be=>be&&B.has(be)?be:null)},[R]);const Je=B=>{fe(be=>({...be,[B.infoId]:{infoId:B.infoId,infoType:B.infoType,label:B.label}}))},tt=B=>{fe(be=>{if(!be[B])return be;const o={...be};return delete o[B],o})},lt=(B,be)=>{if(be){Je(B);return}tt(B.infoId)},ot=B=>{c(`/cogita/library/${d}/list?infoId=${encodeURIComponent(B)}&infoView=overview`,{replace:!0})},Ct=()=>{c(`/cogita/library/${d}/list`,{replace:!0})},at=()=>{ie&&c(`/cogita/library/${d}/edit/${encodeURIComponent(ie)}`,{replace:!0})},it=Ye.length===1?((Mt=Ye[0])==null?void 0:Mt.infoId)??null:null,$t=S.selectionCount.replace("{count}",String(Ye.length)),ht=j==="collection"?"grid":j==="detail"?"wide":z,Ee=ci(E),ct=we?Math.max(0,Math.min(100,Math.round((we.score??0)*100))):0,yt=we?di(we,Ee):Ee.noKnownnessData;return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":ht,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[xe?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:Ee.kicker}),e.jsx("h2",{className:"cogita-card-title",children:F?ri(F.payload,F.infoType,F.infoId):Ee.loading}),F?e.jsxs("p",{className:"cogita-card-subtitle",children:[Xe(t,F.infoType)," · ",F.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:Ct,children:Ee.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:at,disabled:!ie||qe!=="ready",children:S.editInfo})]})]}),qe==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:Ee.loading})}):qe==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:Ee.loadError})}):F?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Ee.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[ct,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${ct}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:yt})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Ee.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(we==null?void 0:we.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:Ee.correct.replace("{correct}",String((we==null?void 0:we.correctReviews)??0)).replace("{total}",String((we==null?void 0:we.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:we!=null&&we.lastReviewedUtc?`${Ee.lastReview}: ${li(we.lastReviewedUtc,E)}`:Ee.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Ee.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:bt}),e.jsx("p",{className:"cogita-library-hint",children:Ee.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Ee.checkcards}),_e==="loading"?e.jsx("p",{className:"cogita-library-hint",children:Ee.loadingCheckcards}):_e==="error"?e.jsx("p",{className:"cogita-library-hint",children:Ee.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:Ee.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(ne==null?void 0:ne.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:Ee.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(Be==null?void 0:Be.items.length)??0})]}),(Rt=ne==null?void 0:ne.items)!=null&&Rt.length?e.jsx("div",{className:"cogita-selection-overview",children:ne.items.map((B,be)=>e.jsx("span",{className:"cogita-tag-chip",children:oi(B)},`checkcard:${be}:${B.cardId}:${B.checkType??""}:${B.direction??""}`))}):e.jsx("p",{className:"cogita-library-hint",children:Ee.noCheckcards})]})]}),Me.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:Ee.approach}),e.jsx("select",{value:et,onChange:B=>Ze(B.target.value),"aria-label":Ee.approach,children:Me.map(B=>e.jsx("option",{value:B.approachKey,children:B.label},B.approachKey))})]}),Ue==="loading"?e.jsx("p",{className:"cogita-library-hint",children:Ee.loadingApproach}):Ue==="error"?e.jsx("p",{className:"cogita-library-hint",children:Ee.loadApproachError}):D?e.jsx(Ra,{value:D.projection,emptyLabel:Ee.empty}):e.jsx("p",{className:"cogita-library-hint",children:Ee.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Ee.payload}),e.jsx(Ra,{value:F.payload,emptyLabel:Ee.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Ee.links}),e.jsx(ui,{links:F.links,emptyLabel:Ee.noLinks})]})]})]}):null]})}):null,xe?null:e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":S.typeLabel,value:se,onChange:B=>Y(B.target.value),children:ce.map(B=>e.jsx("option",{value:B.value,children:B.label},B.value))}),e.jsx("input",{type:"text",value:q,onChange:B=>k(B.target.value),placeholder:S.searchPlaceholder}),e.jsx("select",{"aria-label":S.sortLabel,value:g,onChange:B=>ue(B.target.value),children:$e.map(B=>e.jsx("option",{value:B.value,children:B.label},B.value))}),e.jsxs("select",{"aria-label":S.viewLabel,value:z,onChange:B=>f(B.target.value),children:[e.jsx("option",{value:"details",children:S.viewDetails}),e.jsx("option",{value:"wide",children:S.viewWide}),e.jsx("option",{value:"grid",children:S.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:S.cardCount.replace("{shown}",String(ve.length)).replace("{total}",String(Re.length))}),e.jsx("span",{children:G==="loading"?S.loading:S.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>$(B=>!B),children:U?S.hideFilters:S.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:S.filtersOptionalHint})]}),U&&Ve.length>0?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsx("div",{className:"cogita-filter-grid",children:Ve.map(B=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:B.label}),B.kind==="select"?e.jsxs("select",{value:x[B.key]??"",onChange:be=>_(o=>({...o,[B.key]:be.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(B.options??[]).map(be=>e.jsx("option",{value:be.value,children:be.label},`${B.key}:${be.value}`))]}):e.jsx("input",{type:"text",value:x[B.key]??"",onChange:be=>_(o=>({...o,[B.key]:be.target.value}))})]},`type-filter:${B.key}`))})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:$t}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{fe(B=>{const be={...B};for(const o of ve)be[o.infoId]={infoId:o.infoId,infoType:o.infoType,label:o.label};return be})},disabled:ve.length===0,children:S.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>fe({}),disabled:Ye.length===0,children:S.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>it&&ot(it),disabled:!it,title:it?void 0:S.openSelectedDisabled,children:S.openSelected})]})]}),Ye.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:S.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:S.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:pt.map(([B,be])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:Xe(t,B)}),e.jsx("span",{className:"cogita-tag-count",children:be})]},`stack:type:${B}`))})]}):null,ht==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":S.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:S.detailColumnName}),e.jsx("span",{children:S.detailColumnType}),e.jsx("span",{children:S.detailColumnId}),e.jsx("span",{})]}),ve.length?ve.map(B=>{const be=Xe(t,B.infoType),o=Qe.has(B.infoId),me=Ke===B.infoId;return e.jsxs("div",{className:`cogita-details-row ${me||o?"active":""}`,role:"row",onClick:()=>pe(B.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:o,onChange:J=>lt(B,J.target.checked),onClick:J=>J.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:B.label,children:B.label}),e.jsx("span",{title:be,children:be}),e.jsx("span",{title:B.infoId,children:B.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:J=>{J.stopPropagation(),ot(B.infoId)},"aria-label":S.editInfo,children:">"})]},B.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:S.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${ht}`,"data-view":ht,children:ve.length?ve.map(B=>{const be=Xe(t,B.infoType),o=Qe.has(B.infoId),me=Ke===B.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":me||o,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:o,onChange:J=>lt(B,J.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>pe(B.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:be}),e.jsx("h3",{className:"cogita-card-title",children:B.label}),e.jsx("p",{className:"cogita-card-subtitle",children:B.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>ot(B.infoId),children:S.editInfo})]})},B.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:S.noMatch})})}),nt?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>ae(B=>B+Za),children:S.loadMore})}):null]})]})})})})}function ri(t,s,n){if(t&&typeof t=="object"&&!Array.isArray(t)){const i=t,l=["title","name","label","value","text","quote","term"];for(const m of l){const p=i[m];if(typeof p=="string"&&p.trim())return p.trim()}}return`${s} · ${n}`}function oi(t){const s=[t.cardType];return t.infoType&&s.push(t.infoType),t.checkType&&s.push(t.checkType),t.direction&&s.push(t.direction),s.join(" · ")}function li(t,s){try{const n=s==="pl"?"pl-PL":s==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(n,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function ci(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function di(t,s){return t.totalReviews<=0?s.noKnownnessData:t.totalReviews<3||t.score<.35?s.developmentStart:t.totalReviews<8||t.score<.65?s.developmentGrowing:t.score<.85?s.developmentStable:s.developmentStrong}function ui({links:t,emptyLabel:s}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:s}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([n,i])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:n}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(i)?i.length?e.jsx("div",{className:"cogita-selection-overview",children:i.map(l=>e.jsx("span",{className:"cogita-tag-chip",children:l},`${n}:${l}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):i?e.jsx("span",{className:"cogita-tag-chip",children:i}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},n))})}function Ra({value:t,emptyLabel:s}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:s});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((n,i)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:i+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(Ra,{value:n,emptyLabel:s})})]},i))});if(typeof t=="object"){const n=Object.entries(t);return n.length===0?e.jsx("p",{className:"cogita-library-hint",children:s}):e.jsx("div",{className:"cogita-info-tree",children:n.map(([i,l])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:i}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(Ra,{value:l,emptyLabel:s})})]},i))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const ta=5,Ns=50,Ss=2,Ts=[];function sa({libraryId:t,infoType:s,label:n,placeholder:i,value:l,onChange:m,values:p,onChangeMultiple:v,helperText:E,searchFailedText:N,createFailedText:d,createLabel:j,savingLabel:c,loadMoreLabel:h,inputRef:S,autoAdvance:se,onCommit:Y,multiple:q}){const k=q?p??Ts:Ts,[g,ue]=a.useState(q?"":(l==null?void 0:l.label)??""),[z,f]=a.useState([]),[U,$]=a.useState(ta),[G,I]=a.useState(-1),[R,ee]=a.useState(!1),[te,ae]=a.useState(!1),[Ke,pe]=a.useState(null),C=a.useRef(0),fe=a.useRef(new Map),x=a.useMemo(()=>q?g.trim().length>0:g.trim().length>0&&!l,[g,l,q]);a.useEffect(()=>{q||ue((l==null?void 0:l.label)??"")},[l,q]),a.useEffect(()=>{const W=g.trim();if(!W||W.length<Ss){f([]),ee(!1),$(ta),I(-1),ae(!1),pe(null);return}const F=W.toLowerCase(),ye=`${t}:${s}:${F}`,we=fe.current.get(ye);if(we){if(q&&k.length>0){const Fe=new Set(k.map(Te=>Te.id));f(we.filter(Te=>!Fe.has(Te.id)))}else f(we);$(ta),I(-1),ee(we.length>0),ae(!1),pe(null);return}const je=window.setTimeout(async()=>{const Fe=Date.now();C.current=Fe,ae(!0),pe(null);try{const Te=await hs({libraryId:t,type:s,query:W,limit:Ns});if(C.current!==Fe)return;const qe=Te.slice(0,Ns).map(ze=>({id:ze.infoId,label:ze.label,infoType:ze.infoType}));if(fe.current.set(ye,qe),q&&k.length>0){const ze=new Set(k.map(Ne=>Ne.id));f(qe.filter(Ne=>!ze.has(Ne.id)))}else f(qe);$(ta),I(-1),ee(!0)}catch{if(C.current!==Fe)return;pe(N??"Search failed.")}finally{C.current===Fe&&ae(!1)}},250);return()=>window.clearTimeout(je)},[t,s,g,k]);const _=W=>{if(q){const F=k.some(ye=>ye.id===W.id)?k:[...k,W];v==null||v(F),ue(""),ee(!1),I(-1);return}m==null||m(W),ue(W.label),ee(!1),I(-1),se&&(Y==null||Y())},ge=async()=>{const W=g.trim();if(W){ae(!0),pe(null);try{const F=await qs({libraryId:t,infoType:s,payload:{label:W}}),ye={id:F.infoId,label:W,infoType:F.infoType};if(W.length>=Ss){const we=`${t}:${s}:${W.toLowerCase()}`,je=fe.current.get(we)??[];fe.current.set(we,[ye,...je])}if(q){v==null||v([...k,ye]),ue(""),ee(!1),I(-1);return}m==null||m(ye),ee(!1),I(-1),se&&(Y==null||Y())}catch{pe(d??"Create failed.")}finally{ae(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:n}),e.jsx("input",{value:g,placeholder:i,onChange:W=>{ue(W.target.value),!q&&l&&(m==null||m(null))},onKeyDown:W=>{if(W.key==="ArrowDown"){if(W.preventDefault(),!z.length)return;ee(!0),I(F=>{const ye=Math.min(z.length,U)-1,we=F<0?0:Math.min(F+1,ye);return we===ye&&z.length>U?($(je=>Math.min(je+ta,z.length)),Math.min(F+1,Math.min(z.length,U+ta)-1)):we});return}if(W.key==="ArrowUp"){if(W.preventDefault(),!z.length)return;ee(!0),I(F=>F<=0?0:F-1);return}if(W.key==="Enter"){if(W.preventDefault(),G>=0&&z[G]){_(z[G]);return}if(x){ge();return}}},onFocus:()=>{z.length>0&&ee(!0)},autoComplete:"off",ref:S})]}),q&&k.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:k.map(W=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>v==null?void 0:v(k.filter(F=>F.id!==W.id)),children:[W.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},W.id))}),E&&e.jsx("p",{className:"cogita-help",children:E}),Ke&&e.jsx("p",{className:"cogita-error",children:Ke}),R&&z.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[z.slice(0,U).map((W,F)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":F===G,onClick:()=>_(W),children:[e.jsx("strong",{children:W.label}),e.jsx("span",{children:W.infoType})]},W.id)),U<z.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>$(W=>Math.min(W+ta,z.length)),children:h??"Load more"})]}),x&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:ge,disabled:te,children:te?c??"Saving...":j??`Create new ${s}`})]})}function hi(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function Cs(t,s){if(!t||typeof t!="object")return s;const n=t,i=[n.label,n.name,n.title,n.text,n.orcid,n.email,n.number];for(const l of i)if(typeof l=="string"&&l.trim())return l.trim();return s}function gi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,libraryId:d,editInfoId:j}){const{libraryName:c}=Ot(d),h=!!j,[S,se]=a.useState([]),[Y,q]=a.useState("word"),[k,g]=a.useState({}),[ue,z]=a.useState({}),[f,U]=a.useState({}),[$,G]=a.useState({}),[I,R]=a.useState(null),[ee,te]=a.useState("idle"),ae=a.useMemo(()=>S.find(x=>x.infoType===Y),[Y,S]),Ke=a.useMemo(()=>S.map(x=>({value:x.infoType,label:Xe(t,x.infoType)})),[t,S]);a.useEffect(()=>{let x=!1;return fn({libraryId:d}).then(_=>{var ge;if(!x&&(se(_),!h)){const W=(ge=_[0])==null?void 0:ge.infoType;W&&q(W)}}).catch(()=>{x||se([])}),()=>{x=!0}},[h,d]),a.useEffect(()=>{if(!ae)return;const x={},_={},ge={},W={};for(const F of ae.payloadFields)x[F.key]="";for(const F of ae.linkFields)F.multiple?ge[F.key]=[]:_[F.key]=null,F.targetTypes.length>0&&(W[F.key]=F.targetTypes[0]);g(x),z(_),U(ge),G(W)},[ae==null?void 0:ae.infoType]),a.useEffect(()=>{if(!h||!j||S.length===0)return;let x=!1;return te("loading"),R(null),(async()=>{const ge=await aa({libraryId:d,infoId:j});if(x)return;const W=ge.infoType;q(W);const F=S.find(Ne=>Ne.infoType===W);if(!F){te("idle");return}const ye=ge.payload??{},we={};for(const Ne of F.payloadFields)we[Ne.key]=hi(ye[Ne.key]);g(we);const je=ge.links??{}??{},Fe={},Te={},qe={},ze=[];for(const Ne of F.linkFields){Ne.targetTypes.length>0&&(qe[Ne.key]=Ne.targetTypes[0]);const We=je[Ne.key];if(Ne.multiple){const et=Array.isArray(We)?We.filter(Ze=>typeof Ze=="string"):[];Te[Ne.key]=[];for(const Ze of et)ze.push(aa({libraryId:d,infoId:Ze}).then(D=>{if(x)return;const H={id:Ze,infoType:D.infoType,label:Cs(D.payload,Ze)};Te[Ne.key]=[...Te[Ne.key],H]}).catch(()=>{}))}else{const et=typeof We=="string"?We:null;Fe[Ne.key]=null,et&&ze.push(aa({libraryId:d,infoId:et}).then(Ze=>{x||(Fe[Ne.key]={id:et,infoType:Ze.infoType,label:Cs(Ze.payload,et)})}).catch(()=>{}))}}await Promise.all(ze),!x&&(z(Fe),U(Te),G(Ne=>({...Ne,...qe})),te("idle"))})().catch(()=>{x||(R("Failed to load info details."),te("idle"))}),()=>{x=!0}},[j,h,d,S]);const pe=async()=>{var W;if(!ae)return;const x={};for(const F of ae.payloadFields){const ye=(k[F.key]??"").trim();if(!ye){if(F.required){R(`Field '${F.label}' is required.`);return}continue}if(F.inputType==="json")try{x[F.key]=JSON.parse(ye)}catch{R(`Field '${F.label}' must be valid JSON.`);return}else x[F.key]=ye}const _={};for(const F of ae.linkFields)if(F.multiple){const ye=(f[F.key]??[]).map(we=>we.id);if(F.required&&ye.length===0){R(`Link '${F.label}' is required.`);return}ye.length>0&&(_[F.key]=ye)}else{const ye=((W=ue[F.key])==null?void 0:W.id)??null;if(F.required&&!ye){R(`Link '${F.label}' is required.`);return}ye&&(_[F.key]=ye)}const ge=Object.keys(_).length>0;te("saving"),R(null);try{if(h&&j)await bn({libraryId:d,infoId:j,payload:x,links:ge?_:void 0}),R("Info updated.");else{await qs({libraryId:d,infoType:Y,payload:x,links:ge?_:void 0}),R("Info saved.");const F={};for(const je of ae.payloadFields)F[je.key]="";g(F);const ye={},we={};for(const je of ae.linkFields)je.multiple?we[je.key]=[]:ye[je.key]=null;z(je=>({...je,...ye})),U(je=>({...je,...we}))}}catch{R("Failed to save info.")}finally{te("idle")}},C=x=>{const _=k[x.key]??"",ge=x.inputType==="textarea"||x.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:x.label}),ge?e.jsx("textarea",{rows:x.inputType==="json"?8:4,value:_,onChange:W=>g(F=>({...F,[x.key]:W.target.value})),placeholder:x.key}):e.jsx("input",{type:"text",value:_,onChange:W=>g(F=>({...F,[x.key]:W.target.value})),placeholder:x.key})]},`payload:${x.key}`)},fe=x=>{const _=$[x.key]??x.targetTypes[0];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:x.label}),x.targetTypes.length>1?e.jsx("select",{value:_,onChange:ge=>G(W=>({...W,[x.key]:ge.target.value})),children:x.targetTypes.map(ge=>e.jsx("option",{value:ge,children:Xe(t,ge)},`${x.key}:${ge}`))}):null,x.multiple?e.jsx(sa,{libraryId:d,infoType:_,label:x.label,placeholder:x.key,multiple:!0,values:f[x.key]??[],onChangeMultiple:ge=>U(W=>({...W,[x.key]:ge})),searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(sa,{libraryId:d,infoType:_,label:x.label,placeholder:x.key,value:ue[x.key]??null,onChange:ge=>z(W=>({...W,[x.key]:ge})),searchFailedText:"Search failed",createFailedText:"Create failed"})]},`link:${x.key}`)};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:h?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${d}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[h?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:Y,onChange:x=>q(x.target.value),children:Ke.map(x=>e.jsx("option",{value:x.value,children:x.label},x.value))})]}),ee==="loading"?e.jsx("p",{children:"Loading..."}):null,ae?e.jsxs("div",{className:"cogita-form-grid",children:[ae.payloadFields.map(C),ae.linkFields.map(fe)]}):e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:pe,disabled:ee==="saving"||!ae,children:ee==="saving"?"Saving...":h?"Update info":"Create info"})}),I?e.jsx("p",{className:"cogita-library-subtitle",children:I}):null]})})})]})})}const Ms=t=>/\s/.test(t),Ea=t=>/[\p{L}\p{N}]/u.test(t),Is=(t,s)=>{const n=s>0?t[s-1]:"",i=s<t.length?t[s]:"";if(!n||!i)return 0;const l=Ms(n),m=Ms(i);if(l||m)return 3;const p=Ea(n),v=Ea(i);return p!==v?2:!p&&!v?1:0},es=(t,s,n,i,l)=>{const m=Math.max(i-s,n-i);for(let p=0;p<=m;p+=1){const v=i-p;if(v>=s&&v<=n&&Is(t,v)>=l)return v;const E=i+p;if(E>=s&&E<=n&&Is(t,E)>=l)return E}return null},ts=(t,s)=>{const n=s>0?t[s-1]:"",i=s<t.length?t[s]:"";return!n||!i?!0:Ea(n)!==Ea(i)},mi=(t,s,n,i)=>{const l=n-s,m=s+i,p=n-i;if(l<=i*2||p<=m)return null;const v=Math.floor((s+n)/2),E=es(t,m,p,v,3);if(E!==null&&ts(t,E))return E;const N=es(t,m,p,v,2);if(N!==null&&ts(t,N))return N;const d=es(t,m,p,v,1);return d!==null&&ts(t,d)?d:null},ma=(t,s)=>{const n=Math.max(1,7),i=Math.max(n,13),l={},m=(E,N,d,j,c)=>{const h=String(j),S={id:h,start:E,end:N,text:t.slice(E,N),depth:d,index:j,parentId:c};if(l[h]=S,N-E>i){let Y=mi(t,E,N,n);if(Y!==null&&Y>E&&Y<N){const q=m(E,Y,d+1,j*2+1,h),k=m(Y,N,d+1,j*2+2,h);S.leftId=q.id,S.rightId=k.id}}return S},p=m(0,t.length,0,0),v=Object.values(l).sort((E,N)=>N.depth-E.depth||E.start-N.start).map(E=>E.id);return{text:t,rootId:p.id,nodes:l,order:v}},ha=(t,s,n,i,l,m,p)=>{const v=m==="reverse"?t.order.slice().sort((E,N)=>t.nodes[N].start-t.nodes[E].start||t.nodes[N].depth-t.nodes[E].depth):t.order;for(const E of v){if(p&&E===p||s.has(E))continue;const N=t.nodes[E];if(N){if(l&&(N.leftId||N.rightId)){const d=N.leftId?n[N.leftId]??0:i,j=N.rightId?n[N.rightId]??0:i;if((d+j)/2<i)continue}return N}}return null},Ys=(t,s)=>({before:t.slice(0,s.start),fragment:t.slice(s.start,s.end),after:t.slice(s.end)});function pi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,libraryId:d}){const j=`/#/cogita/library/${d}`,[c,h,S]=As([]),[se,Y,q]=Fs([]),[k,g]=a.useState(null),[ue,z]=a.useState(null),[f,U]=a.useState(null),[$,G]=a.useState(null),I=a.useMemo(()=>c.find(C=>C.id===k)??null,[c,k]);a.useEffect(()=>{let C=!0;return yn({libraryId:d}).then(fe=>{if(!C)return;const x=fe.nodes.map(_=>{var ge,W,F;return{id:_.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:_.payload&&typeof _.payload=="object"&&"label"in _.payload?String(_.payload.label):"Item",nodeType:_.nodeType,itemType:((ge=_.payload)==null?void 0:ge.itemType)??"info",itemId:((W=_.payload)==null?void 0:W.itemId)??null,infoType:((F=_.payload)==null?void 0:F.infoType)??null}}});h(x),Y(fe.edges.map(_=>({id:_.edgeId,source:_.fromNodeId,target:_.toNodeId})))}).catch(()=>{C&&(h([]),Y([]))}),()=>{C=!1}},[d]),a.useEffect(()=>{xn({libraryId:d}).then(z).catch(()=>z(null))},[d,c,se]);const R=a.useCallback(C=>{Y(fe=>Ps(C,fe))},[]),ee=()=>{const C=crypto.randomUUID();h(fe=>[...fe,{id:C,type:"default",position:{x:140+fe.length*40,y:120+fe.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},te=()=>{const C=crypto.randomUUID();h(fe=>[...fe,{id:C,type:"default",position:{x:180+fe.length*40,y:160+fe.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},ae=async()=>{U(null);try{const C=c.map(x=>({nodeId:x.id,nodeType:x.data.nodeType,payload:{itemType:x.data.itemType,itemId:x.data.itemId??null,label:x.data.label,infoType:x.data.infoType??null}})),fe=se.map(x=>({edgeId:x.id,fromNodeId:x.source,toNodeId:x.target}));await vn({libraryId:d,nodes:C,edges:fe}),U(t.cogita.library.graph.saveSuccess)}catch{U(t.cogita.library.graph.saveFail)}},Ke=C=>{I&&h(fe=>fe.map(x=>x.id===I.id?{...x,data:{...x.data,itemId:(C==null?void 0:C.infoId)??null,itemType:"collection",infoType:"collection",label:(C==null?void 0:C.label)??t.cogita.library.infoTypes.collection}}:x))},pe=C=>{I&&h(fe=>fe.map(x=>x.id===I.id?{...x,data:{...x.data,itemId:(C==null?void 0:C.infoId)??null,itemType:"info",infoType:(C==null?void 0:C.infoType)??null,label:(C==null?void 0:C.label)??t.cogita.library.infoTypes.any}}:x))};return a.useEffect(()=>{if(!I||I.data.nodeType!=="info"||I.data.infoType!=="citation"||!I.data.itemId){G(null);return}let C=!0;return aa({libraryId:d,infoId:I.data.itemId}).then(fe=>{if(!C)return;const x=fe.payload,_=(x==null?void 0:x.text)??"";if(!_){G(null);return}const ge=ma(_),W=Object.values(ge.nodes).sort((F,ye)=>F.depth-ye.depth||F.start-ye.start).map(F=>({id:F.id,text:F.text,depth:F.depth}));G({title:(x==null?void 0:x.title)??I.data.label,fragments:W})}).catch(()=>G(null)),()=>{C=!1}},[d,I]),e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:j,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:ae,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ee,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:te,children:t.cogita.library.actions.addInfo}),ue?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(ue.totalCollections))})}):null,f?e.jsx("p",{className:"cogita-help",children:f}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(zs,{nodes:c,edges:se,onNodesChange:S,onEdgesChange:q,onConnect:R,onNodeClick:(C,fe)=>g(fe.id),fitView:!0,children:[e.jsx(Ks,{gap:18,size:1}),e.jsx(Bs,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),I?e.jsxs("div",{className:"cogita-graph-inspector",children:[I.data.nodeType==="collection"?e.jsx(sa,{libraryId:d,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:I.data.itemId?{id:I.data.itemId,label:I.data.label,infoType:"collection"}:null,onChange:Ke,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(sa,{libraryId:d,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:I.data.itemId?{id:I.data.itemId,label:I.data.label,infoType:I.data.infoType??void 0}:null,onChange:pe,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),$?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:$.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:$.fragments.map(C=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:C.id}),e.jsx("span",{children:C.text})]},C.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function fi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,libraryId:d,collectionId:j}){const{libraryName:c}=Ot(d),[h,S]=a.useState([]),[se,Y]=a.useState("loading"),[q,k]=a.useState("idle"),g=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),ue=`/#/cogita/library/${d}`,z=()=>{Y("loading"),Us({libraryId:d}).then($=>{S($),Y("idle")}).catch(()=>{S([]),Y("error")})};a.useEffect(()=>{z()},[d]);const f=async $=>{try{await Ws({libraryId:d,shareId:$}),z()}catch{z()}},U=async $=>{const G=`${g}/${$}`;try{await navigator.clipboard.writeText(G),k("copied")}catch{k("failed")}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:ue,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${ue}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[se==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):se==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):h.filter($=>!j||$.collectionId===j).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:h.filter($=>!j||$.collectionId===j).map($=>e.jsxs("div",{className:"cogita-share-row","data-state":$.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:$.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date($.createdUtc).toLocaleString(),$.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),$.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${g}/${$.shareCode}`}):null]}),$.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[$.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>U($.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>f($.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},$.shareId))}),q==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):q==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function bi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,libraryId:d}){const{libraryName:j}=Ot(d),[c,h]=a.useState(null),[S,se]=a.useState(null),[Y,q]=a.useState(null),[k,g]=a.useState(null),[ue,z]=a.useState(null),[f,U]=a.useState(null),$=a.useRef(null),G=ee=>{if(!Number.isFinite(ee))return"0 B";if(ee<1024)return`${ee} B`;const te=ee/1024;if(te<1024)return`${te.toFixed(1)} KB`;const ae=te/1024;return ae<1024?`${ae.toFixed(1)} MB`:`${(ae/1024).toFixed(1)} GB`},I=async()=>{h(null),z({loadedBytes:0,totalBytes:null,percent:null});try{h(t.cogita.library.overview.exporting);const ee=await wn(d,z),te=URL.createObjectURL(ee),ae=document.createElement("a");ae.href=te,ae.download=`cogita-library-${j||d}.json`,ae.click(),URL.revokeObjectURL(te),h(t.cogita.library.overview.exportReady)}catch{h(t.cogita.library.overview.exportFail)}finally{z(ee=>ee??{loadedBytes:0,totalBytes:null,percent:null})}},R=async ee=>{var ae;se(null),q(null),g(null);const te=(ae=ee.target.files)==null?void 0:ae[0];if(te)try{se(t.cogita.library.overview.importing),U({loadedBytes:0,totalBytes:te.size,percent:0});const Ke=await jn(d,te,U,pe=>{const C=pe.stage==="infos"?t.cogita.library.overview.importStageInfos:pe.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;g(t.cogita.library.overview.importLiveProgress.replace("{stage}",C).replace("{done}",String(pe.processed)).replace("{total}",String(pe.total)).replace("{infos}",String(pe.infos)).replace("{connections}",String(pe.connections)).replace("{collections}",String(pe.collections)))});q({infos:Ke.infosImported,connections:Ke.connectionsImported,collections:Ke.collectionsImported}),se(t.cogita.library.overview.importDone)}catch(Ke){const pe=Ke instanceof kn&&Ke.message?` ${Ke.message}`:"";se(`${t.cogita.library.overview.importFail}${pe}`)}finally{$.current&&($.current.value="")}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:j}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:I,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:$,type:"file",accept:"application/json",onChange:R})]})]}),ue?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:ue.percent??void 0,max:ue.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",G(ue.loadedBytes)).replace("{total}",ue.totalBytes?G(ue.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,f?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:f.percent??void 0,max:f.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",G(f.loadedBytes)).replace("{total}",f.totalBytes?G(f.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,c?e.jsx("p",{className:"cogita-help",children:c}):null,S?e.jsx("p",{className:"cogita-help",children:S}):null,k?e.jsx("p",{className:"cogita-help",children:k}):null,Y?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(Y.infos)).replace("{connections}",String(Y.connections)).replace("{collections}",String(Y.collections))}):null]})]})})})]})})}function yi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,libraryId:d}){const{libraryName:j}=Ot(d),[c,h]=a.useState(""),[S,se]=a.useState([]),Y=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:j}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:c,onChange:q=>h(q.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const q=c.trim();q&&(se(k=>[{id:Y(),name:q},...k]),h(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[S.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,S.map(q=>e.jsx("button",{type:"button",className:"ghost",children:q.name},q.id))]})]})]})})})]})})}function xi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,libraryId:d}){const{libraryName:j}=Ot(d),[c,h]=a.useState(""),[S,se]=a.useState([]),Y=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:j}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:c,onChange:q=>h(q.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const q=c.trim();q&&(se(k=>[{id:Y(),name:q},...k]),h(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[S.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,S.map(q=>e.jsx("button",{type:"button",className:"ghost",children:q.name},q.id))]})]})]})})})]})})}function Ls({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,libraryId:d}){const{libraryName:j}=Ot(d),c=`/#/cogita/library/${d}`,[h,S]=a.useState(""),[se,Y]=a.useState([]),[q,k]=a.useState("idle"),[g,ue]=a.useState(0),[z,f]=a.useState(null);a.useEffect(()=>{k("loading");const $=window.setTimeout(()=>{wa({libraryId:d,query:h.trim()||void 0,limit:30}).then(G=>{Y(G.items),ue(G.total),f(G.nextCursor??null),k("ready")}).catch(()=>{Y([]),ue(0),f(null),k("ready")})},240);return()=>window.clearTimeout($)},[d,h]);const U=async()=>{if(z){k("loading");try{const $=await wa({libraryId:d,query:h.trim()||void 0,limit:30,cursor:z});Y(G=>[...G,...$.items]),f($.nextCursor??null),ue($.total),k("ready")}catch{k("ready")}}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:j}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:c,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${c}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:h,onChange:$=>S($.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(se.length)).replace("{total}",String(g||se.length))}),e.jsx("span",{children:q==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:se.length?se.map($=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${c}/collections/${$.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:$.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String($.itemCount))," ·"," ",$.notes||t.cogita.library.collections.noNotes]})]})},$.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${c}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),z?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:U,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const le=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,Dt=(t,s,n,i)=>`${t}:${s}:${n??""}:${i??""}`;function vi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,libraryId:d,collectionId:j}){Ot(d);const c=`/#/cogita/library/${d}`,[h,S]=a.useState(t.cogita.library.collections.defaultName),[se,Y]=a.useState(null),[q,k]=a.useState(0),[g,ue]=a.useState([]),[z,f]=a.useState("idle"),[U,$]=a.useState(null),G=a.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(g.length)).replace("{total}",String(q||g.length)),[t,g.length,q]);a.useEffect(()=>{Va(d,j).then(R=>{S(R.name),Y(R.notes??null),k(R.itemCount)}).catch(()=>{S(t.cogita.library.collections.defaultName),Y(null)})},[d,j]),a.useEffect(()=>{f("loading"),$a({libraryId:d,collectionId:j,limit:40}).then(R=>{ue(R.items),$(R.nextCursor??null),k(R.total),f("ready")}).catch(()=>{ue([]),$(null),f("ready")})},[d,j]);const I=async()=>{if(U){f("loading");try{const R=await $a({libraryId:d,collectionId:j,limit:40,cursor:U});ue(ee=>[...ee,...R.items]),$(R.nextCursor??null),k(R.total),f("ready")}catch{f("ready")}}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:h}),e.jsx("p",{className:"cogita-library-subtitle",children:se||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:c,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${c}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${c}/collections/${j}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${c}/collections/${j}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:G}),e.jsx("span",{children:z==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:g.length?g.map(R=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:R.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:R.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:R.label}),e.jsx("p",{className:"cogita-card-subtitle",children:R.description})]})},le(R))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),U?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:I,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${c}/collections/${j}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const _t=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const s=t.length,n=t.filter(m=>m.correct).length,i=Oa(gs(t));return{score:Math.round(Math.max(0,Math.min(100,i.knowness*100))*100)/100,total:s,correct:n,lastReviewedUtc:i.lastReviewedUtc??null}},wi=t=>{if(t.maskBase64)try{const s=Nn(t.maskBase64);if(!s.length)return t.correct?1:0;const n=s.reduce((i,l)=>i+l,0);return Math.max(0,Math.min(1,n/s.length/255))}catch{return t.correct?1:0}return t.correct?1:0},gs=t=>t.map(s=>({correctness:wi(s),createdUtc:s.createdUtc})),Oa=(t,s=Date.now())=>{var q;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const i=t.slice().sort((k,g)=>k.createdUtc.localeCompare(g.createdUtc)).slice(-5),l=i.reduce((k,g)=>k+g.correctness,0)/i.length,m=5,p=2,v=.15;let E=0,N=0;for(let k=0;k<i.length;k+=1){const g=new Date(i[k].createdUtc).getTime(),ue=k===i.length-1?s:new Date(i[k+1].createdUtc).getTime(),z=Math.max(0,(ue-g)/(1e3*60)),f=1-Math.exp(-z/m);E+=f,i[k].correctness>.5&&(N+=v)}let d=l*E*p+N;const j=((q=i[i.length-1])==null?void 0:q.createdUtc)??null,c=j?Math.max(0,(s-new Date(j).getTime())/(1e3*60)):0,S=1/(1+Math.log1p(c/60));return d*=S,i.length===1&&i[0].correctness>.5&&(d+=5.44*Math.exp(-c/2)),{knowness:d,avgCorrectness:l,lastReviewedUtc:j}},ja=t=>{const s=t.slice();for(let n=s.length-1;n>0;n-=1){const i=Math.floor(Math.random()*(n+1));[s[n],s[i]]=[s[i],s[n]]}return s},La=t=>t[Math.floor(Math.random()*t.length)],ji=(t,s)=>{const n=new Map;return t.forEach(i=>n.set(i,Math.random())),t.sort((i,l)=>{const m=s(i)-s(l);return m!==0?m:(n.get(i)??0)-(n.get(l)??0)})},qa=(t,s,n,i,l)=>{if(!t.length)return null;const m=t.filter(v=>!(l!=null&&l.has(le(v))));if(m.length===0)return null;const p=m.filter(v=>le(v)!==n);return La(p.length?p:m)},ki=(t,s,n,i,l)=>{if(!t.length)return null;let m=Number.POSITIVE_INFINITY;for(const N of t){const d=le(N);if(n.has(d))continue;const j=s[d]??1;j<m&&(m=j)}if(!Number.isFinite(m))return null;const p=t.filter(N=>{const d=le(N);return!n.has(d)&&(s[d]??1)===m}),v=p.filter(N=>!l||le(N)!==l),E=i?v.filter(N=>!i.has(le(N))):v;return E.length>0?La(E):v.length>0?La(v):l&&p.some(N=>le(N)===l)?p.find(N=>le(N)===l)??null:p.length?La(p):null},Gs=(t,s,n,i,l)=>{const m=[],p=t.filter(E=>!l.has(le(E))&&!n.has(le(E))&&(s[le(E)]??0)<1),v=ji(p,E=>s[le(E)]??0);for(const E of v){if(m.length>=i)break;m.push(E),l.add(le(E))}if(m.length<i){const E=ja(t.filter(N=>!l.has(le(N))&&n.has(le(N))));for(const N of E){if(m.length>=i)break;m.push(N),l.add(le(N))}}return m},Ni=(t,s,n,i)=>Gs(t,s,n,i,new Set),ms=(t,s,n,i,l,m)=>{const p=Math.max(1,n.stackSize??s),E=ja(t).filter((S,se,Y)=>Y.findIndex(q=>le(q)===le(S))===se),N=Ni(E,i,l,p),d=new Set,j=new Set,c=qa(N,{},null,d,j),h=c?[c]:[];return c&&j.add(le(c)),{queue:h,meta:{pool:E,active:N,knownessMap:i,unknownSet:l,outcomesById:m,asked:d,queued:j}}},cs={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,s)=>{const i=ja(t).filter((l,m,p)=>p.findIndex(v=>le(v)===le(l))===m);return{queue:i.slice(0,Math.min(s,i.length)),meta:{}}},applyOutcome:t=>t},ps=(t,s,n,i)=>{const l=Math.max(1,n.stackSize??s),p=ja(t).filter((se,Y,q)=>q.findIndex(k=>le(k)===le(se))===Y),v={},E=new Set,N=new Set,d=new Set,j=Math.max(1,n.levels??1);p.forEach(se=>{const Y=le(se),q=i==null?void 0:i[Y],k=typeof q=="number"&&Number.isFinite(q)?q:1;v[Y]=Math.min(j,Math.max(1,Math.round(k)))});const c=[];if(p.length>0){const se=new Map;p.forEach(q=>{var g;const k=v[le(q)]??1;se.has(k)||se.set(k,[]),(g=se.get(k))==null||g.push(q)});const Y=Array.from(se.keys()).sort((q,k)=>q-k);for(const q of Y){if(c.length>=l)break;const k=ja(se.get(q)??[]);for(const g of k){if(c.length>=l)break;c.push(g)}}}const h=qa(c,v,null,E,N),S=h?[h]:[];return h&&N.add(le(h)),{queue:S,meta:{pool:p,active:c,levelMap:v,asked:E,queued:N,wrongSinceCorrect:d}}},Si={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,s)=>Math.max(1,s.stackSize??t),getProgressTotal:()=>null,prepare:(t,s,n)=>ps(t,s,n),applyOutcome:(t,s,n,i,l)=>{if(!s)return t;const m=Math.max(1,i.levels??1),p=t.meta.pool??[],v=t.meta.active??[],E={...t.meta.levelMap??{}},N=new Set(t.meta.asked??[]),d=new Set(t.meta.queued??[]),j=new Set(t.meta.wrongSinceCorrect??[]),c=le(s);d.delete(c),N.add(c);const h=E[c]??1;l.correct?(E[c]=j.has(c)?1:Math.min(h+1,m),j.delete(c)):(E[c]=1,j.add(c));const S=l.correct?v.filter(q=>le(q)!==c):v.slice();if(l.correct&&S.length<Math.max(1,i.stackSize??1)){const q=new Set(S.map(g=>le(g))),k=ki(p,E,q,N,c);k&&S.push(k)}const se=t.queue.slice(),Y=qa(S,E,c,N,d);return Y&&(se.push(Y),d.add(le(Y))),{queue:se,meta:{pool:p,active:S,levelMap:E,asked:N,queued:d,wrongSinceCorrect:j}}}},Ti={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,s)=>Math.max(1,s.stackSize??t),getProgressTotal:()=>null,prepare:(t,s,n)=>ms(t,s,n,{},new Set,{}),applyOutcome:(t,s,n,i,l)=>{if(!s)return t;const m=t.meta.pool??[],p=t.meta.active??[],v={...t.meta.knownessMap??{}},E=new Set(t.meta.unknownSet??[]),N={...t.meta.outcomesById??{}},d=new Set(t.meta.asked??[]),j=new Set(t.meta.queued??[]),c=le(s);j.delete(c),d.add(c);const h={correctness:Math.max(0,Math.min(1,l.correctness??(l.correct?1:0))),createdUtc:l.createdUtc??new Date().toISOString()},se=(N[c]??[]).concat(h).sort((z,f)=>z.createdUtc.localeCompare(f.createdUtc)).slice(-5);N[c]=se,E.delete(c);const Y=Date.now();m.forEach(z=>{const f=le(z),U=N[f]??[];if(U.length===0){v[f]=0,E.add(f);return}const $=Oa(U,Y);v[f]=$.knowness});const q=p.slice();if((v[c]??0)>=1){const z=q.filter(f=>le(f)!==c);q.length=0,q.push(...z)}const g=Math.max(1,i.stackSize??n);if(q.length<g){const z=new Set(q.map(U=>le(U))),f=Gs(m,v,E,g-q.length,z);q.push(...f)}const ue=t.queue.slice();if(ue.length===0||le(ue[ue.length-1])===c){const z=qa(q,{},c,d,j);z&&(ue.push(z),j.add(le(z)))}return{queue:ue,meta:{pool:m,active:q,knownessMap:v,unknownSet:E,outcomesById:N,asked:d,queued:j}}}},Xs={random:cs,levels:Si,temporal:Ti},Ci=Object.values(Xs),fs=t=>{if(!t)return cs;const s=t.trim().toLowerCase();return s==="random"||s==="levels"||s==="temporal"?Xs[s]:cs},Ua=(t,s)=>{const n={...t.defaultSettings};return s&&Object.entries(s).forEach(([i,l])=>{typeof l=="number"&&Number.isFinite(l)&&(n[i]=l),typeof l=="string"&&(n[i]=l)}),t.settingsFields.forEach(i=>{var m;const l=n[i.key];if(i.type==="number"){if(typeof l!="number"||Number.isNaN(l)){n[i.key]=t.defaultSettings[i.key]??0;return}i.min!==void 0&&(n[i.key]=Math.max(i.min,n[i.key])),i.max!==void 0&&(n[i.key]=Math.min(i.max,n[i.key]));return}if(i.type==="select"){const p=((m=i.options)==null?void 0:m.map(v=>v.value))??[];(typeof l!="string"||p.length>0&&!p.includes(l))&&(n[i.key]=t.defaultSettings[i.key]??p[0]??"")}}),n},Js=(t,s)=>{const n={};return t.settingsFields.forEach(i=>{const l=s.get(i.key);if(l){if(i.type==="number"){const m=Number(l);Number.isNaN(m)||(n[i.key]=m);return}n[i.key]=l}}),Ua(t,n)},Mi=(t,s)=>{const n=new URLSearchParams;return t.settingsFields.forEach(i=>{const l=s[i.key];(typeof l=="number"||typeof l=="string")&&n.set(i.key,String(l))}),n};function Ii({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,libraryId:d,collectionId:j,revisionId:c}){const{libraryName:h}=Ot(d),S=`/#/cogita/library/${d}`,[se,Y]=a.useState(t.cogita.library.collections.defaultName),[q,k]=a.useState(""),[g,ue]=a.useState(20),[z,f]=a.useState("random"),[U,$]=a.useState({}),[G,I]=a.useState("exact"),[R,ee]=a.useState([]),[te,ae]=a.useState(null),[Ke,pe]=a.useState([]),[C,fe]=a.useState("idle"),[x,_]=a.useState(null),[ge,W]=a.useState("idle"),[F,ye]=a.useState("idle"),[we,je]=a.useState("idle"),Fe=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),Te=a.useMemo(()=>fs(z),[z]),qe=a.useMemo(()=>Ua(Te,U),[Te,U]),ze=a.useMemo(()=>Mi(Te,qe).toString(),[Te,qe]);a.useEffect(()=>{Va(d,j).then(H=>Y(H.name)).catch(()=>Y(t.cogita.library.collections.defaultName))},[d,j]),a.useEffect(()=>{c&&Sn({libraryId:d,collectionId:j,revisionId:c}).then(H=>{k(H.name),f(H.mode||"random"),I(H.check||"exact"),ue(H.limit||20),$(H.revisionSettings??{})}).catch(()=>{k("")})},[j,d,c]),a.useEffect(()=>{Tn({libraryId:d}).then(H=>{ee(H),!te&&H.length>0&&ae(H[0].roleId)}).catch(()=>{ee([])})},[d]);const Ne=()=>{ye("loading"),Us({libraryId:d}).then(H=>{pe(H),ye("idle")}).catch(()=>{pe([]),ye("error")})};a.useEffect(()=>{Ne()},[d]);const We=async()=>{fe("working"),W("idle");try{const H=await Mn({libraryId:d,collectionId:j,revisionType:Te.id,revisionSettings:qe,mode:z,check:G,limit:g});_(`${Fe}/${H.shareCode}${ze?`?${ze}`:""}`),fe("ready"),Ne()}catch{fe("error")}},et=async()=>{if(c){je("saving");try{await Cn({libraryId:d,collectionId:j,revisionId:c,name:q||se,revisionType:Te.id,revisionSettings:qe,mode:z,check:G,limit:g}),je("saved")}catch{je("error")}}},Ze=async()=>{if(x)try{await navigator.clipboard.writeText(x),W("copied")}catch{W("failed")}},D=async H=>{try{await Ws({libraryId:d,shareId:H}),Ne()}catch{Ne()}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:se}),e.jsx("p",{className:"cogita-library-subtitle",children:h})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:S,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${S}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${S}/collections/${j}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${S}/collections/${j}/revision/run?mode=${encodeURIComponent(z)}&check=${encodeURIComponent(G)}&limit=${g}${ze?`&${ze}`:""}${te?`&reviewer=${encodeURIComponent(te)}`:""}${c?`&revisionId=${encodeURIComponent(c)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:q,onChange:H=>k(H.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:z,onChange:H=>f(H.target.value),children:Ci.map(H=>e.jsx("option",{value:H.id,children:t.cogita.library.revision[H.labelKey]},H.id))})]}),Te.settingsFields.map(H=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[H.labelKey]}),H.type==="select"?e.jsx("select",{value:String(qe[H.key]??""),onChange:Ue=>$(Ce=>({...Ce,[H.key]:Ue.target.value})),children:(H.options??[]).map(Ue=>e.jsx("option",{value:Ue.value,children:t.cogita.library.revision[Ue.labelKey]},Ue.value))}):e.jsx("input",{type:"number",min:H.min,max:H.max,step:H.step,value:qe[H.key]??0,onChange:Ue=>$(Ce=>({...Ce,[H.key]:Number(Ue.target.value||0)}))})]},H.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),Te.id!=="levels"&&Te.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:g,onChange:H=>ue(Number(H.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:te??"",onChange:H=>ae(H.target.value||null),children:R.map(H=>e.jsx("option",{value:H.roleId,children:H.label},H.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[c?e.jsx("button",{type:"button",className:"cta ghost",onClick:et,disabled:we==="saving",children:we==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${S}/collections/${j}/revision/run?mode=${encodeURIComponent(z)}&check=${encodeURIComponent(G)}&limit=${g}${ze?`&${ze}`:""}${te?`&reviewer=${encodeURIComponent(te)}`:""}${c?`&revisionId=${encodeURIComponent(c)}`:""}`,children:t.cogita.library.actions.startRevision})]}),we==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),x?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:x,readOnly:!0})]}):null,C==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,ge==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):ge==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:We,disabled:C==="working",children:C==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),x?e.jsx("button",{type:"button",className:"cta ghost",onClick:Ze,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),F==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):Ke.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:Ke.map(H=>e.jsxs("div",{className:"cogita-share-row","data-state":H.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:H.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(H.createdUtc).toLocaleString(),H.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),H.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>D(H.shareId),children:t.cogita.library.revision.shareRevokeAction})]},H.shareId))})]})]})]})]})})})]})})}const as=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function Zs(t,s,n){if(!t)return null;const i=new Map(t.nodes.map(z=>[z.id,z])),l=new Map,m=new Set,p=z=>{if(typeof z=="number")return z;if(typeof z=="string"){const f=Number(z);return Number.isFinite(f)?f:0}return 0},v=z=>{if(l.has(z))return l.get(z);if(m.has(z))return 0;const f=i.get(z);if(!f)return 0;m.add(z);const U=G=>{var R,ee;return(G?((R=f.inputsByHandle)==null?void 0:R[G])??[]:f.inputs??((ee=f.inputsByHandle)==null?void 0:ee.in)??[]).map(te=>v(te))};let $=0;switch(f.type){case"input.random":{const G=f.min??0,I=f.max??G+10,R=Math.min(G,I),ee=Math.max(G,I);$=Math.floor(Math.random()*(ee-R+1))+R;break}case"input.const":{$=f.value??0;break}case"input.list":{const G=(f.list??[]).filter(Boolean),I=Math.round(p(U("index")[0]));$=G.length?G[Math.max(0,Math.min(G.length-1,I))]:String(I);break}case"compute.add":{$=U("in").map(I=>p(I)).reduce((I,R)=>I+R,0);break}case"compute.sub":{const G=U("add").map(R=>p(R)),I=U("sub").map(R=>p(R));$=G.reduce((R,ee)=>R+ee,0)-I.reduce((R,ee)=>R+ee,0);break}case"compute.mul":{const G=U("in").map(I=>p(I));$=G.length?G.reduce((I,R)=>I*R,1):0;break}case"compute.div":{const G=p(U("num")[0]),I=U("den").map(R=>p(R)).reduce((R,ee)=>R+ee,0);$=Math.abs(I)<Number.EPSILON?0:G/I;break}case"compute.pow":{const G=p(U("base")[0]),I=p(U("exp")[0]);$=Math.pow(G,I);break}case"compute.exp":{const G=p(U("base")[0]),I=p(U("exp")[0]);$=Math.pow(G,I);break}case"compute.log":{const G=p(U("value")[0]),I=p(U("base")[0]),R=Math.max(G,Number.EPSILON);$=Math.abs(I)<Number.EPSILON?Math.log(R):Math.log(R)/Math.log(I);break}case"compute.abs":{$=Math.abs(p(U("in")[0]));break}case"compute.min":{const G=U("in").map(I=>p(I));$=G.length?Math.min(...G):0;break}case"compute.max":{const G=U("in").map(I=>p(I));$=G.length?Math.max(...G):0;break}case"compute.floor":{$=Math.floor(p(U("in")[0]));break}case"compute.ceil":{$=Math.ceil(p(U("in")[0]));break}case"compute.round":{$=Math.round(p(U("in")[0]));break}case"compute.mod":{const G=p(U("a")[0]),I=p(U("b")[0]);$=Math.abs(I)<Number.EPSILON?0:G%I;break}case"compute.concat":{const I=["in1","in2","in3","in4","in5","in6"].flatMap(ae=>U(ae)),R=I.length?I:U("in");$=(R.length?R:U()).map(ae=>ae==null?"":String(ae)).join("");break}case"compute.trim":{const G=U("text")[0]??U("in")[0]??"",I=G==null?"":String(G),R=Math.max(0,Math.round(p(U("start")[0]))),ee=Math.max(0,Math.round(p(U("end")[0])));R+ee>=I.length?$="":$=I.substring(R,I.length-ee);break}case"output":{$=U("in")[0]??0;break}default:$=0}return m.delete(z),l.set(z,$),$},E=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(z=>z.type==="output").map(z=>z.id);t.nodes.forEach(z=>v(z.id)),E.forEach(z=>v(z));const N=z=>Math.abs(z%1)<1e-5?String(Math.round(z)):z.toFixed(3).replace(/\.?0+$/,""),d=z=>typeof z=="number"?N(z):z??"",j=new Map;E.forEach(z=>{var I,R,ee,te;const f=i.get(z);if(!f)return;const U=(R=(I=f.inputsByHandle)==null?void 0:I.name)==null?void 0:R[0],$=U?d(l.get(U)):"",G=($==null?void 0:$.toString().trim())||((ee=f.outputLabel)==null?void 0:ee.trim())||((te=f.name)==null?void 0:te.trim())||z;j.set(z,G)});const c={},h={},S={};E.forEach(z=>{var $,G;const f=i.get(z);if(!f)return;const U=j.get(z)??((($=f.outputLabel)==null?void 0:$.trim())||((G=f.name)==null?void 0:G.trim())||z);c[U]=d(l.get(z)),f.name&&(h[f.name.trim()]=U),h[z]=U});const se=(z,f)=>{let U=z;return t.nodes.forEach($=>{var te,ae;const G=d(l.get($.id)),I=E.includes($.id),R=I?j.get($.id)??((te=$.outputLabel)==null?void 0:te.trim())??((ae=$.name)==null?void 0:ae.trim())??$.id:"",ee=I&&f?R:G;U=U.replace(new RegExp(`\\{\\s*${as($.id)}\\s*\\}`,"gi"),ee),$.name&&(U=U.replace(new RegExp(`\\{\\s*${as($.name)}\\s*\\}`,"gi"),ee)),I&&$.outputLabel&&(U=U.replace(new RegExp(`\\{\\s*${as($.outputLabel)}\\s*\\}`,"gi"),R))}),U},Y=s;let q=Y.trim().length>0?Y:"";q||(q=E.length?`Compute ${E.join(", ")}`:"Compute"),q=se(q,!0);const k=(n==null?void 0:n.trim())??"",g=k?se(k,!1):"",ue={};return l.forEach((z,f)=>{ue[f]=z,S[f]=d(z);const U=i.get(f);U!=null&&U.name&&(S[U.name.trim()]=d(z))}),{prompt:q,answers:c,values:ue,answerText:g,outputVariables:h,variableValues:S}}function en(t){var n;const s=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((n=s[0])==null?void 0:n[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}function tn({copy:t,currentCard:s,currentTypeLabel:n,prompt:i,languages:l,answer:m,onAnswerChange:p,computedExpected:v,computedAnswers:E,onComputedAnswerChange:N,answerTemplate:d,outputVariables:j,variableValues:c,computedFieldFeedback:h,feedback:S,canAdvance:se,quoteContext:Y,quotePlaceholder:q,onCheckAnswer:k,onSkip:g,onLanguageSelect:ue,onMarkReviewed:z,onAdvance:f,showCorrectAnswer:U,setShowCorrectAnswer:$,onRevealCorrect:G,answerMask:I,expectedAnswer:R,hasExpectedAnswer:ee,handleComputedKeyDown:te,answerInputRef:ae,computedInputRefs:Ke,scriptMode:pe,setScriptMode:C,matchPairs:fe,matchLeftOrder:x,matchRightOrder:_,matchSelection:ge,matchActiveLeft:W,matchActiveRight:F,matchFeedback:ye,onMatchLeftSelect:we,onMatchRightSelect:je}){const Fe=a.useMemo(()=>{var $e;const D=!d&&v.length===2?`The {${v[0].key}} is of type {${v[1].key}}`:null,H=d??D;if(!H)return null;const Ue=new Map(v.map(L=>[L.key,L.expected])),Ce=new Set,ne=[],Ae=/\{([^}]+)\}/g;let Be=0,De,_e=null;for(;(De=Ae.exec(H))!==null;){const L=H.slice(Be,De.index);L&&ne.push({type:"text",value:L});const V=(($e=De[1])==null?void 0:$e.trim())??"",ie=V&&Ue.has(V)?V:V&&j&&j[V]?j[V]:null;V&&Ce.add(V),ie&&Ce.add(ie),ie&&Ue.has(ie)?(ne.push({type:"input",value:ie}),_e||(_e=ie)):V&&c&&c[V]!==void 0?ne.push({type:"text",value:c[V]}):ne.push({type:"text",value:De[0]}),Be=De.index+De[0].length}const Q=H.slice(Be);return Q&&ne.push({type:"text",value:Q}),v.filter(L=>!Ce.has(L.key)).length>0?null:{parts:ne,expectedByKey:Ue,firstInputKey:_e}},[d,v,j,c]),Te=()=>{if(!Fe)return null;const{parts:D,expectedByKey:H,firstInputKey:Ue}=Fe;return e.jsx("div",{className:"cogita-revision-inline-answer",children:D.map((Ce,ne)=>{var Ae,Be;return Ce.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:Ce.value},`text-${ne}`):e.jsx("input",{ref:De=>{Ke.current[Ce.value]=De},autoFocus:Ce.value===Ue,value:E[Ce.value]??"",onChange:De=>N(Ce.value,De.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":h[Ce.value]??(S==="correct"?"correct":S==="incorrect"?"incorrect":void 0),onKeyDown:De=>We(De)||te(De),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((Ae=E[Ce.value])==null?void 0:Ae.length)??0,((Be=H.get(Ce.value))==null?void 0:Be.length)??6)}ch`}},`input-${Ce.value}-${ne}`)})})},qe=a.useMemo(()=>{const D=new Map;return(fe??[]).forEach(H=>D.set(H.leftId,H)),D},[fe]),ze=a.useMemo(()=>{const D=new Map;return(fe??[]).forEach(H=>D.set(H.rightId,H)),D},[fe]);a.useEffect(()=>{var ne;if(s.cardType!=="info"||s.infoType!=="computed"||v.length===0)return;const D=typeof document<"u"?document.activeElement:null;if(D&&(D.tagName==="INPUT"||D.tagName==="TEXTAREA"))return;const H=(Fe==null?void 0:Fe.firstInputKey)??((ne=v[0])==null?void 0:ne.key);if(!H)return;const Ue=Ke.current[H];if(!Ue)return;const Ce=requestAnimationFrame(()=>{Ue.focus()});return()=>cancelAnimationFrame(Ce)},[s,v,Fe]);const Ne=(()=>{const D=[R??"",...v.map(Ce=>Ce.expected??"")].join(""),H=[m,...Object.values(E)].join(""),Ue=`${D}${H}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(Ue)})(),We=D=>D.ctrlKey&&(D.key==="^"||D.key==="6")?(D.preventDefault(),C(H=>H==="super"?null:"super"),!0):D.ctrlKey&&(D.key==="_"||D.key==="-")?(D.preventDefault(),C(H=>H==="sub"?null:"sub"),!0):!1,et=()=>{if(!R||!I)return R??"";const D=R.split(""),H=Array.from(I),Ue=H.length>0?H.reduce((Ce,ne)=>Ce+ne,0)/H.length:127;return D.map((Ce,ne)=>{const Ae=H[ne]??Ue,Be=Math.max(0,Math.min(255,Math.round(Ae)));let De=255,_e=0;return Be<=127?_e=Math.round(Be/127*255):(_e=255,De=Math.round(255*(1-(Be-127)/128))),e.jsx("span",{style:{color:`rgb(${De}, ${_e}, 0)`},children:Ce},`mask-${ne}`)})},Ze=s.cardType==="info"&&s.infoType==="citation"?(Y==null?void 0:Y.title)||s.label:s.description;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[e.jsx("span",{children:n}),e.jsx("strong",{children:Ze})]}),s.cardType==="vocab"&&s.checkType==="translation-match"&&fe?e.jsxs("div",{className:"cogita-revision-body",children:[i?e.jsx("h2",{children:i}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(x??[]).map(D=>{const H=qe.get(D);if(!H)return null;const Ue=(ge==null?void 0:ge[D])??null,Ce=(ye==null?void 0:ye[D])??null,ne=W===D;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":ne,"data-state":Ce??void 0,"data-locked":Ue?"true":void 0,onClick:()=>we==null?void 0:we(D),children:[e.jsx("span",{children:H.leftLabel}),Ue&&U?e.jsx("em",{children:"✓"}):null]},D)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(_??[]).map(D=>{const H=ze.get(D);if(!H)return null;const Ue=Object.values(ge??{}).includes(D),Ce=F===D;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":Ue||Ce,"data-locked":Ue?"true":void 0,onClick:()=>je==null?void 0:je(D),children:e.jsx("span",{children:H.rightLabel})},D)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:k,disabled:s.checkType==="translation-match",children:t.cogita.library.revision.checkAnswer}),e.jsx("button",{type:"button",className:"ghost",onClick:g,children:t.cogita.library.revision.skip})]})]}):s.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ae,value:m,onChange:D=>p(D.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":S==="correct"?"correct":S==="incorrect"?"incorrect":void 0,onKeyDown:D=>{D.key==="Enter"&&(D.preventDefault(),D.stopPropagation(),se?f():k())}})]}),Ne?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":pe==="super",onClick:()=>C(D=>D==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":pe==="sub",onClick:()=>C(D=>D==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:k,children:t.cogita.library.revision.checkAnswer}),e.jsx("button",{type:"button",className:"ghost",onClick:g,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[s.label?e.jsx("p",{className:"cogita-revision-hint",children:s.label}):null,d?null:e.jsx(In,{value:i??"",mode:"auto"}),v.length>0?(()=>{const D=Te();return D?e.jsx("div",{className:"cogita-inline-answer-wrap",children:D}):e.jsx("div",{className:"cogita-form-grid",children:v.map((H,Ue)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:H.key}),e.jsx("textarea",{ref:Ce=>{Ke.current[H.key]=Ce},autoFocus:Ue===0,value:E[H.key]??"",onChange:Ce=>N(H.key,Ce.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":h[H.key]??(S==="correct"?"correct":S==="incorrect"?"incorrect":void 0),onKeyDown:Ce=>We(Ce)||te(Ce)})]},H.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:ae,value:m,onChange:D=>p(D.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":S==="correct"?"correct":S==="incorrect"?"incorrect":void 0,onKeyDown:D=>{We(D)||D.key==="Enter"&&(D.preventDefault(),D.stopPropagation(),se?f():k())}})]})}),Ne?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":pe==="super",onClick:()=>C(D=>D==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":pe==="sub",onClick:()=>C(D=>D==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:k,children:t.cogita.library.revision.checkAnswer}),e.jsx("button",{type:"button",className:"ghost",onClick:g,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="citation"&&Y?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(Y.completed)).replace("{total}",String(Y.total))}),e.jsx("p",{className:"cogita-quote-text",children:Y.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ae,value:m,onChange:D=>p(D.target.value),placeholder:q??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":S==="correct"?"correct":S==="incorrect"?"incorrect":void 0,onKeyDown:D=>{D.key==="Enter"&&(D.preventDefault(),D.stopPropagation(),se?f():k())}})]}),e.jsx("p",{className:"cogita-quote-text",children:Y.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:k,children:t.cogita.library.revision.checkAnswer}),e.jsx("button",{type:"button",className:"ghost",onClick:g,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:l.length?l.map(D=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>ue(D.label),children:D.label},D.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:g,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:z,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:g,children:t.cogita.library.revision.skip})]})]}),S&&e.jsx("div",{className:"cogita-revision-feedback","data-state":S,children:S==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),S==="incorrect"&&ee?e.jsxs("div",{className:"cogita-revision-reveal",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>$(D=>{const H=!D;return H&&G(),H}),children:t.cogita.library.revision.showAnswer}),U?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),v.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[v.map(D=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:D.key}),e.jsx("span",{children:D.expected})]},D.key)),R?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:R})]}):null]}):e.jsx("p",{children:I?et():R})]}):null]}):null,se?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:f,children:t.cogita.library.revision.nextQuestion})}):null]})}const ss=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function an({outcomes:t}){const[s,n]=a.useState("day"),i=a.useMemo(()=>{const l=ss.find(v=>v.id===s)??ss[1],m=Date.now()-l.ms,p=t.filter(v=>new Date(v.createdUtc).getTime()>=m);return _t(p)},[t,s]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:ss.map(l=>e.jsx("button",{type:"button",className:"ghost","data-active":s===l.id,onClick:()=>n(l.id),children:l.label},l.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[i.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[i.correct," / ",i.total]})]})}const Li="cogita-revision",$i=1,Aa="outcomes",Ri=()=>new Promise((t,s)=>{const n=indexedDB.open(Li,$i);n.onupgradeneeded=()=>{const i=n.result;if(!i.objectStoreNames.contains(Aa)){const l=i.createObjectStore(Aa,{keyPath:"id"});l.createIndex("byItem","itemKey",{unique:!1}),l.createIndex("byPending","pending",{unique:!1})}},n.onerror=()=>s(n.error),n.onsuccess=()=>t(n.result)}),Na=async(t,s)=>{const n=await Ri();return new Promise((i,l)=>{const m=n.transaction(Aa,t),p=m.objectStore(Aa);s(p).then(i).catch(l),m.onerror=()=>l(m.error)})},sn=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const s=Array.from(t).map(n=>n.toString(16).padStart(2,"0"));return`${s.slice(0,4).join("")}-${s.slice(4,6).join("")}-${s.slice(6,8).join("")}-${s.slice(8,10).join("")}-${s.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},Ei=()=>{const t="cogita_revision_client_id",s=localStorage.getItem(t);if(s)return s;const n=sn();return localStorage.setItem(t,n),n},Ai=()=>{const t="cogita_revision_client_seq",s=Number(localStorage.getItem(t)??"0"),n=Number.isFinite(s)?s+1:1;return localStorage.setItem(t,String(n)),n},nn=(t,s,n,i)=>Dt(t,s,n,i),Fa=async t=>{const s=Ei(),n=Ai(),i=new Date().toISOString(),l={...t,clientId:s,clientSequence:n,createdUtc:i,id:sn(),pending:!0};return await Na("readwrite",m=>new Promise((p,v)=>{const E={...l,itemKey:nn(l.itemType,l.itemId,l.checkType,l.direction)},N=m.add(E);N.onsuccess=()=>p(),N.onerror=()=>v(N.error)})),l},Pa=async(t,s,n,i)=>{if(!s)return[];try{const l=nn(t,s,n,i);return await Na("readonly",m=>new Promise((p,v)=>{const N=m.index("byItem").getAll(l);N.onsuccess=()=>{const j=(N.result??[]).map(c=>({itemType:c.itemType,itemId:c.itemId,checkType:c.checkType??null,direction:c.direction??null,revisionType:c.revisionType,evalType:c.evalType,correct:c.correct,createdUtc:c.createdUtc,maskBase64:c.maskBase64,payloadBase64:c.payloadBase64,payloadHashBase64:c.payloadHashBase64,clientId:c.clientId,clientSequence:c.clientSequence,personRoleId:c.personRoleId??null})).sort((c,h)=>c.createdUtc.localeCompare(h.createdUtc));p(j)},N.onerror=()=>v(N.error)}))}catch{return[]}},Vt=async()=>{try{return await Na("readonly",t=>new Promise((s,n)=>{const i=t.getAll();i.onsuccess=()=>{const m=(i.result??[]).map(p=>({itemType:p.itemType,itemId:p.itemId,checkType:p.checkType??null,direction:p.direction??null,revisionType:p.revisionType,evalType:p.evalType,correct:p.correct,createdUtc:p.createdUtc,maskBase64:p.maskBase64,payloadBase64:p.payloadBase64,payloadHashBase64:p.payloadHashBase64,clientId:p.clientId,clientSequence:p.clientSequence,personRoleId:p.personRoleId??null}));s(m)},i.onerror=()=>n(i.error)}))}catch{return[]}},Fi=async(t=100)=>{try{return await Na("readonly",s=>new Promise((n,i)=>{const m=s.index("byPending").getAll(!0);m.onsuccess=()=>{const p=m.result??[];n(p.slice(0,t))},m.onerror=()=>i(m.error)}))}catch{return[]}},Pi=async t=>{if(t.length!==0)try{await Na("readwrite",s=>new Promise((n,i)=>{let l=t.length;t.forEach(m=>{const p=s.get(m);p.onsuccess=()=>{const v=p.result;if(v){v.pending=!1;const E=s.put(v);E.onsuccess=()=>{l-=1,l===0&&n()},E.onerror=()=>i(E.error)}else l-=1,l===0&&n()},p.onerror=()=>i(p.error)})}))}catch{}},ns=async(t,s)=>{const n=await Fi(200);if(n.length===0)return;const i=new Map;n.forEach(l=>{var p;const m=l.personRoleId??s??"";i.has(m)||i.set(m,[]),(p=i.get(m))==null||p.push(l)});for(const[l,m]of i.entries()){const p=m.map(v=>({itemType:v.itemType,itemId:v.itemId,checkType:v.checkType??null,direction:v.direction??null,revisionType:v.revisionType,evalType:v.evalType,correct:v.correct,clientId:v.clientId,clientSequence:v.clientSequence,maskBase64:v.maskBase64??null,payloadHashBase64:v.payloadHashBase64??null,payloadBase64:v.payloadBase64??null,personRoleId:l||null}));try{await Ln({libraryId:t,outcomes:p}),await Pi(m.map(v=>v.id))}catch{}}},$s={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},zi=(t,s)=>{const n=Math.max(t.length,s.length,1),i=Math.abs(t.length-s.length);return Math.max(0,1-i/n)},Ki=(t,s)=>{const n=new Uint8Array(t.length),i=zi(t,s);for(let l=0;l<t.length;l+=1){const m=t[l]===(s[l]??"")?128:0,p=t.length-1-l,v=s.length-1-l,E=t[p]===(s[v]??"")?127:0,N=Math.round((m+E)*i);n[l]=Math.max(0,Math.min(255,N))}return n},Ia=(t,s)=>t===s||($s[t]??[]).includes(s)?!0:($s[s]??[]).includes(t),za=(t,s)=>{const n=new Uint8Array(t.length);if(!t.length)return n;const i=[];for(let m=0;m<=t.length-3;m+=1)i.push({index:m,text:t.slice(m,m+3)});let l=!1;return i.forEach(m=>{for(let p=0;p<=s.length-3;p+=1){const v=s.slice(p,p+3);let E=0;for(let h=0;h<3;h+=1)Ia(m.text[h],v[h])&&(E+=1);if(E<2)continue;let N=m.index-1,d=p-1;for(;N>=0&&d>=0;){const h=t[N],S=s[d];if(h===S){n[N]=Math.max(n[N],255),N-=1,d-=1,l=!0;continue}if(Ia(h,S)){n[N]=Math.max(n[N],127),N-=1,d-=1,l=!0;continue}if(N>0&&t[N-1]===S){n[N]=Math.max(n[N],0),N-=1,l=!0;continue}if(d>0&&t[N]===s[d-1]){d-=1,l=!0;continue}break}for(let h=0;h<3;h+=1){const S=m.index+h,se=m.text[h],Y=v[h],q=se===Y?255:Ia(se,Y)?127:0;n[S]=Math.max(n[S],q),l=!0}let j=m.index+3,c=p+3;for(;j<t.length&&c<s.length;){const h=t[j],S=s[c];if(h===S){n[j]=Math.max(n[j],255),j+=1,c+=1,l=!0;continue}if(Ia(h,S)){n[j]=Math.max(n[j],127),j+=1,c+=1,l=!0;continue}if(j+1<t.length&&t[j+1]===S){n[j]=Math.max(n[j],0),j+=1,l=!0;continue}if(c+1<s.length&&t[j]===s[c+1]){c+=1,l=!0;continue}break}}}),l?n:Ki(t,s)},ga=(t,s,n)=>{const i=t.trim().toLowerCase(),l=s.trim().toLowerCase();return za(i,l)},pa=t=>t.trim().toLowerCase().replace(/[^\p{L}\p{N}]+/gu,""),rn=(t,s,n)=>{const i=pa(t),l=pa(s);return za(i,l)},kt=t=>t.trim().toLowerCase(),Bi=t=>t==="reverse"?"reverse":"forward",ka=(t,s)=>`${t}|${s}`,St=t=>{if(!t)return null;const[s,n]=t.split("|",2);return(s==="forward"||s==="reverse")&&n?{mode:s,fragmentId:n}:{mode:"forward",fragmentId:t}},Ka=(t,s)=>{var i;const n=St(s);return n?n.fragmentId&&s?(t??null)===s:(((i=St(t))==null?void 0:i.mode)??"forward")===n.mode:!0},gt=t=>{const s=t==null?void 0:t.trim().toLowerCase();return s||null},on=(t,s)=>{if((gt(t.childItemType)??"info")!==(s.cardType??"").toLowerCase()||t.childItemId!==s.cardId)return!1;const i=gt(t.childCheckType),l=gt(t.childDirection),m=gt(s.checkType),p=gt(s.direction);return!(i&&i!==m||l&&l!==p)},Di={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},_i={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},Ba=(t,s,n)=>{if(!n||!s.startsWith(t))return s;const i=s.slice(t.length);if(!i)return s;const l=n==="super"?Di:_i,m=i.split("").map(p=>l[p]??p).join("");return t+m},Da=(t,s,n)=>{var p,v,E;if(!t)return((p=s[0])==null?void 0:p.key)??null;const i=new Set(s.map(N=>N.key)),l=/\{([^}]+)\}/g;let m;for(;(m=l.exec(t))!==null;){const N=((v=m[1])==null?void 0:v.trim())??"";if(!N)continue;if(i.has(N))return N;const d=n==null?void 0:n[N];if(d&&i.has(d))return d}return((E=s[0])==null?void 0:E.key)??null},ds=t=>t.flatMap(s=>{if(s.cardType!=="info"||s.infoType!=="citation")return[s];const n=s.description??"";if(!n.trim())return[s];const i=St(s.direction),l=(i==null?void 0:i.mode)??Bi(s.direction),m=ma(n),p=Object.keys(m.nodes);return p.length===0?[s]:p.map(v=>({...s,checkType:"quote-fragment",direction:ka(l,v)}))});function Vi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,libraryId:d,collectionId:j,revisionId:c}){const h=_a(),S=`/#/cogita/library/${d}`,se=a.useMemo(()=>new URLSearchParams(h.search),[h.search]),Y=Math.max(1,Number(se.get("limit")??20)),q=se.get("mode")??"random",k=a.useMemo(()=>fs(q),[q]),g=a.useMemo(()=>Ua(k,Js(k,se)),[k,se]),ue=se.get("check")??"exact",z=se.get("reviewer"),f=a.useMemo(()=>t.cogita.library.revision[k.labelKey]??q,[t,q,k]),U=a.useMemo(()=>ue==="exact"?t.cogita.library.revision.checkValue:ue,[t,ue]),[$,G]=a.useState(t.cogita.library.collections.defaultName),[I,R]=a.useState([]),[ee,te]=a.useState([]),[ae,Ke]=a.useState("idle"),[pe,C]=a.useState({current:0,total:0}),[fe,x]=a.useState(0),[_,ge]=a.useState(""),[W,F]=a.useState(null),[ye,we]=a.useState(null),[je,Fe]=a.useState(null),[Te,qe]=a.useState(null),[ze,Ne]=a.useState([]),[We,et]=a.useState({}),[Ze,D]=a.useState({}),[H,Ue]=a.useState(null),[Ce,ne]=a.useState(null),[Ae,Be]=a.useState(null),[De,_e]=a.useState(null),[Q,ce]=a.useState(null),[$e,L]=a.useState({}),V=a.useRef(0),[ie,ke]=a.useState(null),xe=a.useRef(null),Le=a.useRef(null),[Ve,He]=a.useState(null),[Me,Re]=a.useState(!1),[ve,nt]=a.useState(null),[Qe,Ye]=a.useState([]),[pt,bt]=a.useState(null),Je=a.useRef(null),tt=a.useRef(null),[lt,ot]=a.useState(null),[Ct,at]=a.useState(0),it=a.useRef(null),$t=a.useRef({}),[ht,Ee]=a.useState(!1),[ct,yt]=a.useState({}),[Mt,Rt]=a.useState([]),B=a.useRef(new Map),[be,o]=a.useState(new Set),[me,J]=a.useState(!1),Pe=a.useRef(null),st=a.useRef(new Set),rt=a.useRef({}),de=I[fe]??null,re=(de==null?void 0:de.checkType)==="translation-match"&&Q,xt=a.useRef(new Map),At=a.useRef(new Map),qt=a.useRef(new Map),Kt=a.useRef(new Map),Ft=a.useMemo(()=>de?de.cardType==="vocab"?t.cogita.library.revision.vocabLabel:de.infoType?Xe(t,de.infoType):t.cogita.library.revision.infoLabel:"",[t,de]),na=a.useMemo(()=>{var u;return k.id!=="levels"?I.length:((u=ct.pool)==null?void 0:u.length)??k.getFetchLimit(Y,g)},[ct,g,k,I.length,Y]),Ut=k.getProgressTotal?k.getProgressTotal(I,ct,Y,g):k.id==="levels"?Math.min(Y,na):I.length,mt=Ut?Math.min(fe+1,Ut):0,vt=Math.max(1,Number(g.tries??1)),Nt=g.compare??"anchors",Wt=Math.max(0,Math.min(100,Number(g.minCorrectness??0))),ft=(g.considerDependencies??"on")==="on",dt=Math.max(0,Math.min(100,Number(g.dependencyThreshold??85))),Et=r=>{const u=r.slice();for(let w=u.length-1;w>0;w-=1){const b=Math.floor(Math.random()*(w+1));[u[w],u[b]]=[u[b],u[w]]}return u},Yt=r=>r.length?r.reduce((w,b)=>w+b,0)/r.length/255*100:0,Ht=r=>Yt(r)>=Wt,ia=async()=>{const r=await Vt(),u=new Map,w=new Map,b=new Map;r.forEach(M=>{const P=`${M.itemType}:${M.itemId}`,X=Dt(M.itemType,M.itemId,M.checkType,M.direction);if(u.has(P)||u.set(P,[]),u.get(P).push(M),w.has(X)||w.set(X,[]),w.get(X).push(M),M.itemType==="info"&&M.checkType==="quote-fragment"&&M.direction){const Z=`${M.itemId}:${M.direction}`;b.has(Z)||b.set(Z,[]),b.get(Z).push(M)}});const K=new Map,y=new Map,A=new Map;return u.forEach((M,P)=>K.set(P,_t(M).score)),w.forEach((M,P)=>y.set(P,_t(M).score)),b.forEach((M,P)=>A.set(P,_t(M).score)),{itemKnowness:K,cardKnowness:y,fragmentKnowness:A}},Wa=async r=>{const u=[];let w=null;for(;;){const b=await $a({libraryId:d,collectionId:r,limit:200,cursor:w});if(u.push(...b.items),!b.nextCursor)break;w=b.nextCursor}return ds(u)},fa=async(r,u)=>{if(B.current.has(r))return B.current.get(r)??0;const w=await Wa(r);if(w.length===0)return B.current.set(r,0),0;const K=w.reduce((y,A)=>{const M=le(A);return y+(u.get(M)??0)},0)/w.length;return B.current.set(r,K),K},Ha=(r,u)=>{if(!ft||r.cardType!=="info"||r.infoType!=="citation"||r.checkType!=="quote-fragment")return!0;const w=St(r.direction);if(!(w!=null&&w.fragmentId))return!0;const b=r.description??"";if(!b.trim())return!0;const y=ma(b).nodes[w.fragmentId];if(!y||!y.leftId&&!y.rightId)return!0;const A=[y.leftId,y.rightId].filter(X=>!!X);if(A.length===0)return!0;const M=A.map(X=>{const Z=Dt("info",r.cardId,"quote-fragment",ka(w.mode,X));return u.get(Z)??0});return M.reduce((X,Z)=>X+Z,0)/M.length>=dt},ra=async r=>{const u=ct,w=r.concat(u.active??[]).concat(u.pool??[]).filter((M,P,X)=>X.findIndex(Z=>le(Z)===le(M))===P);if(!ft){o(new Set(w.map(le)));return}const{itemKnowness:b,cardKnowness:K}=await ia(),y=Mt.filter(M=>gt(M.childItemType)==="collection"&&M.childItemId===j&&!gt(M.childCheckType)&&!gt(M.childDirection)),A=new Set;for(const M of w){if(M.cardType!=="info"){A.add(le(M));continue}if(!Ha(M,K))continue;const P=Mt.filter(he=>on(he,M)).concat(y);if(P.length===0){A.add(le(M));continue}let X=0;for(const he of P)if(gt(he.parentItemType)==="collection")X+=await fa(he.parentItemId,K);else if(gt(he.parentCheckType)||gt(he.parentDirection)){const oe=gt(he.parentCheckType),Se=gt(he.parentDirection),Ie=Dt(he.parentItemType,he.parentItemId,oe,Se);X+=K.get(Ie)??0}else{const oe=`${he.parentItemType}:${he.parentItemId}`;X+=b.get(oe)??0}X/P.length>=dt&&A.add(le(M))}o(A)},Qa=r=>{for(let u=r;u<I.length;u+=1){const w=I[u];if(w&&(!ft||w.cardType!=="info"||be.has(le(w))))return u}return-1},It=r=>!ft||r.cardType!=="info"||be.has(le(r)),oa=r=>{if(k.id!=="temporal"&&k.id!=="levels")return null;const u=ct,w=(u.active??[]).concat(u.pool??[]),b=new Set;for(const K of w){const y=le(K);if(!(b.has(y)||r.has(y))&&(b.add(y),It(K)))return K}return null},Pt=a.useMemo(()=>{if(k.id!=="levels")return null;const r=ct,u=r.pool??[],w=r.active??[],b=r.levelMap??{},K=Math.max(1,Number(g.levels??1)),y=Array.from({length:K},()=>0),A=new Set(w.map(Z=>le(Z)));u.forEach(Z=>{const he=Math.min(K,Math.max(1,b[le(Z)]??1));y[he-1]+=1});const M=u.length||1,P=y.map(Z=>Z/M*100),X=de?b[le(de)]??1:null;return{counts:y,percentages:P,currentLevel:X,levelsCount:K,activeCount:w.length,poolCount:u.length,activeSet:A}},[ct,g,k,de]),wt=a.useMemo(()=>{if(k.id!=="temporal")return null;const r=ct,u=r.pool??[],w=r.active??[],b=r.knownessMap??{},K=new Set(r.unknownSet??[]);let y=0;u.forEach(P=>{(b[le(P)]??0)>1&&(y+=1)});const A=K.size,M=w.map(P=>({id:le(P),value:K.has(le(P))?0:Math.max(0,Math.min(1,b[le(P)]??0))}));return{knownCount:y,unknownCount:A,dots:M}},[ct,k]),la=a.useMemo(()=>{if(!ft)return 0;const r=ct;return I.concat(r.active??[]).concat(r.pool??[]).filter((w,b,K)=>K.findIndex(y=>le(y)===le(w))===b).filter(w=>w.cardType==="info"&&!be.has(le(w))).length},[ft,ct,I,be]);a.useEffect(()=>{if(!ft||ae!=="ready")return;const r=ct,w=I.concat(r.active??[]).concat(r.pool??[]).filter((y,A,M)=>M.findIndex(P=>le(P)===le(y))===A).filter(y=>y.cardType!=="info"||be.has(le(y))).length,b=Je.current;if(Je.current=w,b===null||w<=b)return;const K=w-b;bt(`New card available (+${K})`),tt.current&&window.clearTimeout(tt.current),tt.current=window.setTimeout(()=>bt(null),2200)},[ft,ae,ct,I,be]),a.useEffect(()=>()=>{tt.current&&window.clearTimeout(tt.current)},[]);const jt=(r,u)=>{const w=k.applyOutcome({queue:I,meta:ct},de,Y,g,{correct:r,correctness:u,createdUtc:new Date().toISOString()});R(w.queue),yt(w.meta);const b=w.queue[fe+1];b&&ba(b,fe+1)};a.useEffect(()=>{Va(d,j).then(r=>G(r.name)).catch(()=>G(t.cogita.library.collections.defaultName))},[d,j]),a.useEffect(()=>{hs({libraryId:d,type:"language"}).then(r=>te(r)).catch(()=>te([]))},[d]),a.useEffect(()=>{us({libraryId:d}).then(r=>Rt(r.items??[])).catch(()=>Rt([]))},[d]),a.useEffect(()=>{ns(d,z)},[d,z]),a.useEffect(()=>{ra(I)},[I,Mt,ft,dt,j]),a.useEffect(()=>{if(!de||!ft){J(!1);return}if(de.cardType!=="info"||be.has(le(de))){J(!1);return}const r=Qa(fe+1);if(r>=0){J(!1),x(r);return}if(k.id==="temporal"||k.id==="levels"){const u=I.slice(0,fe+1),w=I.slice(fe+1).filter(It),b=u.concat(w),K=new Set(b.map(le)),y=oa(K);if(y){const M=le(y);K.has(M)||(b.push(y),K.add(M),yt(P=>{const X=P,Z=new Set(X.queued??[]);return Z.add(M),{...X,queued:Z}}))}const A=b.findIndex((M,P)=>P!==fe&&It(M));if(A>=0){R(b),x(A),J(!1);return}}J(!0)},[de,be,ft,fe,I,ct,k.id]),a.useEffect(()=>{let r=!0;return(async()=>{Ke("loading"),C({current:0,total:k.id==="levels"?0:k.getFetchLimit(Y,g)});try{const w=[];let b=null,K=null;do{const he=await $a({libraryId:d,collectionId:j,limit:300,cursor:b});if(w.push(...he.items),(k.id==="levels"||k.id==="temporal")&&he.total&&(K=he.total),C(oe=>({current:w.length,total:oe.total||he.total||k.getFetchLimit(Y,g)})),b=he.nextCursor??null,K!==null&&w.length>=K||k.id!=="levels"&&k.id!=="temporal"&&w.length>=k.getFetchLimit(Y,g))break}while(b);if(!r)return;const y=ds(w);let A;if(k.id==="levels"){const he=Math.max(1,Number(g.levels??1)),Se=(await Vt()).reduce((Ie,Oe)=>{const Ge=Dt(Oe.itemType,Oe.itemId,Oe.checkType,Oe.direction);return Ie[Ge]||(Ie[Ge]=[]),Ie[Ge].push(Oe),Ie},{});A={},y.forEach(Ie=>{const Oe=le(Ie),Ge=Se[Oe]??[],ut=Ge.length>0?_t(Ge).score:0,ea=Math.max(1,Math.min(he,Math.ceil(ut/100*he)));A[Oe]=ea})}let M=null,P=null,X=null;if(k.id==="temporal"){const he=await Vt(),oe=new Set(y.map(Oe=>le(Oe))),Se=he.reduce((Oe,Ge)=>{const ut=Dt(Ge.itemType,Ge.itemId,Ge.checkType,Ge.direction);return oe.has(ut)&&(Oe[ut]||(Oe[ut]=[]),Oe[ut].push(Ge)),Oe},{});M={},P=new Set,X={};const Ie=Date.now();y.forEach(Oe=>{const Ge=le(Oe),ut=Se[Ge]??[];if(ut.length===0){M[Ge]=0,P.add(Ge),X[Ge]=[];return}const ea=gs(ut);X[Ge]=ea;const cn=Oa(ea,Ie);M[Ge]=cn.knowness})}const Z=k.id==="levels"?ps(y,Y,g,A):k.id==="temporal"?ms(y,Y,g,M??{},P??new Set,X??{}):k.prepare(y,Y,g);R(Z.queue),yt(Z.meta),x(0),Ke("ready"),C(he=>({current:Math.min(he.current,he.total),total:he.total}))}catch{r&&Ke("error")}})(),()=>{r=!1}},[d,j,Y,g,k,z]),a.useEffect(()=>{if(ge(""),F(null),ot(null),at(0),Ne([]),et({}),D({}),ne(null),Be(null),_e(null),Re(!1),Ee(!1),He(null),ce(null),L({}),!de){we(null),Fe(null),Ue(null),nt(null);return}de.cardType==="info"&&de.infoType==="computed"&&we(t.cogita.library.revision.loadingComputed);let r=!0;return ba(de,fe).then(u=>{!r||!u||(we(u.prompt),Fe(u.expectedAnswer),Ne(u.computedExpected),et(u.computedAnswers),Ue(u.computedValues),ne(u.answerTemplate),Be(u.outputVariables),_e(u.variableValues))}),()=>{r=!1}},[de,t]),a.useEffect(()=>{if(!de||de.cardType!=="info"||de.infoType!=="citation"){Pe.current=null,st.current=new Set,qe(null);return}const r=de.description??"",u=(de.label??"").trim(),w=u.replace(/\s+/g," ").trim(),b=r.replace(/\s+/g," ").trim(),K=w&&w!==b?u:t.cogita.library.infoTypes.citation;if(!r){qe(null),Fe(null);return}const y=ma(r);Pe.current=y,we(K);let A=!0;return ia().then(({fragmentKnowness:M})=>{if(!A)return;const P=getQuoteMode(de.direction),X=new Set,Z={};M.forEach((Se,Ie)=>{const[Oe,Ge]=Ie.split(":",2);if(Oe!==de.cardId)return;const ut=St(Ge);if(!ut||ut.mode!==P)return;const ea=ut.fragmentId;Z[ea]=Se,Se>=dt&&X.add(ea)}),st.current=X,rt.current=Z;const he=St(de.direction);if(he!=null&&he.fragmentId&&y.nodes[he.fragmentId]){Bt(y,he.fragmentId,K);return}const oe=ha(y,X,Z,dt,ft,de.direction);Bt(y,(oe==null?void 0:oe.id)??null,K)}).catch(()=>{st.current=new Set,rt.current={};const M=St(de.direction);if(M!=null&&M.fragmentId&&y.nodes[M.fragmentId]){Bt(y,M.fragmentId,K);return}const P=ha(y,st.current,{},dt,ft,de.direction);Bt(y,(P==null?void 0:P.id)??null,K)}),()=>{A=!1}},[de,t,ft,dt]),a.useEffect(()=>{if(!de||de.cardType!=="vocab"||de.checkType!=="translation-match"){ce(null),L({});return}const w=(ct.pool??ct.active??I).filter(M=>M.cardType==="vocab"&&M.checkType==="translation-match").filter((M,P,X)=>X.findIndex(Z=>Z.cardId===M.cardId)===P);w.some(M=>M.cardId===de.cardId)||w.unshift(de);const K=Et(w).slice(0,6).map(M=>{const P=M.label.split("↔").map(he=>he.trim()).filter(Boolean);if(P.length<2)return null;const X=`${M.cardId}:L`,Z=`${M.cardId}:R`;return{cardId:M.cardId,leftId:X,rightId:Z,leftLabel:P[0],rightLabel:P[1]}}).filter(Boolean),y=K.map(M=>M.leftId),A=Et(K.map(M=>M.rightId));ce({pairs:K,leftOrder:y,rightOrder:A,selection:{},activeLeft:null,activeRight:null,locked:{}})},[de,I,ct]),a.useEffect(()=>()=>{xe.current&&window.clearTimeout(xe.current),Le.current&&window.clearTimeout(Le.current)},[]);const Gt=a.useRef(null);a.useEffect(()=>{if(!de)return;const r=le(de),u=typeof document<"u"?document.activeElement:null;if(Gt.current===r&&u&&(u.tagName==="INPUT"||u.tagName==="TEXTAREA"))return;let w=0;const b=()=>{if(de){if(de.cardType==="info"&&de.infoType==="computed"){if(ze.length>0){const y=Da(Ce,ze,Ae),A=y?$t.current[y]:null;if(A&&(A.focus(),document.activeElement===A)){Gt.current=r;return}}if(it.current&&(it.current.focus(),document.activeElement===it.current)){Gt.current=r;return}}else if(de.cardType==="vocab"&&it.current&&(it.current.focus(),document.activeElement===it.current)){Gt.current=r;return}w<6&&(w+=1,window.setTimeout(b,40))}},K=window.setTimeout(b,40);return()=>window.clearTimeout(K)},[de,ze,Ce,Ae]),a.useEffect(()=>{if(!ht)return;const r=u=>{u.key==="Enter"&&(u.preventDefault(),da())};return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)},[ht]);const Xt=r=>{Ye(r),nt(_t(r))};a.useEffect(()=>{if(!de){nt(null),Ye([]);return}const r=de.cardType==="info"?"info":"connection";if(de.cardType==="info"&&de.infoType==="citation"){Vt().then(u=>{const w=u.filter(b=>b.itemType==="info"&&b.itemId===de.cardId&&b.checkType==="quote-fragment"&&Ka(b.direction,de.direction));Xt(w)}).catch(()=>{nt(null),Ye([])});return}Pa(r,de.cardId,de.checkType,de.direction).then(u=>Xt(u)).catch(()=>{nt(null),Ye([])})},[d,de,z]);const Sa=(r,u,w,b)=>{if(r==="info"&&w==="quote-fragment"){Vt().then(K=>{const y=K.filter(A=>A.itemType==="info"&&A.itemId===u&&A.checkType==="quote-fragment"&&Ka(A.direction,b));Xt(y)}).catch(()=>{nt(null),Ye([])});return}Pa(r,u,w,b).then(K=>Xt(K)).catch(()=>{nt(null),Ye([])})},Ta=(r,u,w)=>{var A;const b=((A=w.pairs.find(M=>M.leftId===r))==null?void 0:A.rightId)??null;if(!b)return w;const K=b===u;L(M=>({...M,[r]:K?"correct":"incorrect"})),xe.current&&window.clearTimeout(xe.current),Le.current&&window.clearTimeout(Le.current),V.current+=1;const y={kind:K?"correct":"incorrect",tick:V.current};if(ke(null),xe.current=window.setTimeout(()=>ke(y),0),Le.current=window.setTimeout(()=>ke(null),420),K){const M={...w.locked,[r]:!0};return Object.keys(M).length>=w.pairs.length?(F("correct"),Ee(!0)):F("correct"),{...w,selection:{...w.selection,[r]:u},activeLeft:null,activeRight:null,locked:M}}return F("incorrect"),{...w,activeLeft:null,activeRight:null}},ca=r=>{ce(u=>!u||u.locked[r]?u:u.activeRight?Ta(r,u.activeRight,u):{...u,activeLeft:u.activeLeft===r?null:r})},zt=r=>{ce(u=>u&&(u.activeLeft?Ta(u.activeLeft,r,u):{...u,activeRight:u.activeRight===r?null:r}))},da=()=>{var r;if(de&&de.cardType==="info"&&de.infoType==="citation"&&Pe.current&&Te&&!((r=St(de.direction))!=null&&r.fragmentId)){const u=ha(Pe.current,st.current,rt.current,dt,ft,de.direction,Te.fragmentId);if(u){F(null),ge(""),Re(!1),D({}),Ee(!1),ot(null),at(0),Bt(Pe.current,u.id,Te.title);return}}F(null),ge(""),Re(!1),D({}),Ee(!1),ot(null),at(0),x(u=>Math.min(u+1,I.length))},Lt=r=>{if(!de)return;const u=r.expected??null,w=r.answer??"";let b=u??"",K=w;if(!u&&r.expectedMap&&r.answerMap){const he=Object.keys(r.expectedMap).sort((oe,Se)=>oe.localeCompare(Se));b=he.map(oe=>{var Se;return((Se=r.expectedMap)==null?void 0:Se[oe])??""}).join("|"),K=he.map(oe=>{var Se;return((Se=r.answerMap)==null?void 0:Se[oe])??""}).join("|")}const y=b?ga(b,K,Nt):new Uint8Array,A={revisionType:k.id,evalType:r.evalType,direction:r.direction,prompt:ye??"",expected:u,answer:w,expectedAnswers:r.expectedMap??null,answers:r.answerMap??null,correct:r.correct,maskBase64:y.length?Qt(y):null,values:H??null,checkMode:ue,compareMode:Nt,minCorrectness:Wt},M=new TextEncoder().encode(JSON.stringify(A)),P=de.cardType==="info"?"info":"connection",X=r.overrideCheckType??de.checkType??null,Z=r.overrideDirection??de.direction??null;Fa({itemType:P,itemId:de.cardId,checkType:X,direction:Z,revisionType:k.id,evalType:r.evalType,correct:r.correct,maskBase64:y.length?Qt(y):null,payloadBase64:Qt(M),personRoleId:z??null}).then(()=>{Sa(P,de.cardId,X,Z),ra(I),ns(d,z)}).catch(()=>{})},Jt=(r,u)=>{const w=xt.current.get(u);if(w)return Promise.resolve(w);const b=At.current.get(u);if(b)return b;const K=aa({libraryId:d,infoId:r}).then(y=>{var he,oe;const A=y.payload,M=((he=A.definition)==null?void 0:he.graph)??null,P="",X=((oe=A.definition)==null?void 0:oe.answerTemplate)??"",Z=Zs(M,P,X);if(Z){const Ie={sample:en(Z),answerTemplate:X||null};return xt.current.set(u,Ie),Ie}return xs({libraryId:d,infoId:r}).then(Se=>{const Ie={sample:Se,answerTemplate:null};return xt.current.set(u,Ie),Ie})}).catch(()=>xs({libraryId:d,infoId:r}).then(y=>{const A={sample:y,answerTemplate:null};return xt.current.set(u,A),A}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{At.current.delete(u)});return At.current.set(u,K),K},ba=(r,u)=>{var M;const w=`${le(r)}:${u}`,b=qt.current.get(w);if(b)return Promise.resolve(b);const K=Kt.current.get(w);if(K)return K;const y=P=>(qt.current.set(w,P),P);let A;if(r.cardType==="vocab"){if(r.checkType==="translation-match")return A=Promise.resolve(y({prompt:r.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),A;const P=r.label.split("↔").map(X=>X.trim()).filter(Boolean);if(P.length>=2){const Z=(r.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",he=Z?P[0]:P[1],oe=Z?P[1]:P[0];A=Promise.resolve(y({prompt:he,expectedAnswer:oe,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else A=Promise.resolve(y({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(r.cardType==="info"&&r.infoType==="word"){const P=(M=r.description)!=null&&M.startsWith("Language: ")?r.description.replace("Language: ",""):null;A=Promise.resolve(y({prompt:r.label,expectedAnswer:P,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else r.cardType==="info"&&r.infoType==="computed"?A=Jt(r.cardId,w).then(P=>{var Se,Ie;if(!P.sample)return y({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const X=P.sample,Z=X.expectedAnswers?Object.entries(X.expectedAnswers).map(([Oe,Ge])=>({key:Oe,expected:Ge})):[],he=Z.reduce((Oe,Ge)=>(Oe[Ge.key]="",Oe),{}),oe=X.expectedAnswerIsSentence&&((Se=X.expectedAnswer)==null?void 0:Se.trim())||null;return y({prompt:X.prompt,expectedAnswer:Z.length>0?oe:((Ie=X.expectedAnswer)==null?void 0:Ie.trim())||null,computedExpected:Z,computedAnswers:he,computedValues:X.values??null,answerTemplate:P.answerTemplate,outputVariables:X.outputVariables??null,variableValues:X.variableValues??null})}).catch(()=>y({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Kt.current.delete(w)}):A=Promise.resolve(y({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return Kt.current.set(w,A),A},Bt=(r,u,w)=>{const b=Object.keys(r.nodes).length,K=st.current.size;if(!u){qe({title:w,before:r.text,after:"",fragmentId:null,total:b,completed:K}),Fe(null),Ee(!0);return}const y=r.nodes[u];if(!y)return;const A=Ys(r.text,y);qe({title:w,before:A.before,after:A.after,fragmentId:y.id,total:b,completed:K}),Fe(A.fragment),Ee(!1)},Ca=()=>{const r=Pe.current;r&&qe(u=>u&&{...u,total:Object.keys(r.nodes).length,completed:st.current.size})},ua=()=>{const r=I[fe+1];r&&ba(r,fe+1)},Ma=()=>{if(ua(),de&&de.cardType==="vocab"&&de.checkType==="translation-match"&&Q){if(Q.pairs.length===0){F("incorrect"),Ee(!0);return}const y=Q.pairs.reduce((oe,Se)=>(oe[Se.rightId]=Se.rightLabel,oe),{});let A=0;const M={};Q.pairs.forEach(oe=>{const Ie=Q.selection[oe.leftId]===oe.rightId;M[oe.leftId]=Ie?"correct":"incorrect",Ie&&(A+=1)});const P=Q.pairs.length||1,X=A/P,Z=A===Q.pairs.length;L(oe=>({...oe,...M})),Z?(F("correct"),Ee(!0),at(0)):(F("incorrect"),Ee(!1),at(oe=>{const Se=oe+1;return Se>=vt&&(Re(!0),Ee(!0),ce(Ie=>{if(!Ie)return Ie;const Oe=Ie.pairs.reduce((Ge,ut)=>(Ge[ut.leftId]=ut.rightId,Ge),{});return{...Ie,selection:Oe}})),Se})),jt(Z,X);const he="connection";Promise.all(Q.pairs.map(oe=>{const Se=Q.selection[oe.leftId]??null,Ie=Se?y[Se]:"",Oe={left:oe.leftLabel,expected:oe.rightLabel,answer:Ie,checkType:"translation-match"},Ge=new TextEncoder().encode(JSON.stringify(Oe));return Fa({itemType:he,itemId:oe.cardId,checkType:"translation-match",direction:null,revisionType:k.id,evalType:"translation-match",correct:Se===oe.rightId,maskBase64:null,payloadBase64:Qt(Ge),personRoleId:z??null})})).then(()=>{Sa(he,de.cardId,de.checkType,de.direction),ns(d,z)}).catch(()=>{});return}if(ze.length>0){const y=ze.reduce((M,P)=>{const X=We[P.key]??"";return M[P.key]=kt(X)===kt(P.expected)?"correct":"incorrect",M},{});ze.every(({key:M,expected:P})=>{const X=We[M]??"";return ue==="exact"&&kt(X)===kt(P)})?(F("correct"),D(y),Ee(!0),at(0),jt(!0,1),Lt({correct:!0,direction:ye?`${ye} -> computed`:"computed",expectedMap:ze.reduce((M,P)=>(M[P.key]=P.expected,M),{}),answerMap:We,evalType:"computed"})):(F("incorrect"),D(y),Ee(!1),at(M=>{const P=M+1;return P>=vt&&O&&(Re(!0),Ee(!0)),P}),jt(!1,0),window.setTimeout(()=>{var P;const M=Da(Ce,ze,Ae);M&&$t.current[M]&&((P=$t.current[M])==null||P.focus())},40),Lt({correct:!1,direction:ye?`${ye} -> computed`:"computed",expectedMap:ze.reduce((M,P)=>(M[P.key]=P.expected,M),{}),answerMap:We,evalType:"computed"}));return}if(de&&de.cardType==="info"&&de.infoType==="citation"&&(Te!=null&&Te.fragmentId)){if(!je)return;const y=St(de.direction),A=(y==null?void 0:y.mode)??getQuoteMode(de.direction),M=y!=null&&y.fragmentId&&de.direction?de.direction:ka(A,Te.fragmentId),P=rn(je,_,Nt),X=ue==="exact"&&pa(_)===pa(je),Z=Ht(P),he=X||Z,oe=Yt(P);he?(rt.current[Te.fragmentId]=Math.max(rt.current[Te.fragmentId]??0,oe),(rt.current[Te.fragmentId]??0)>=dt&&st.current.add(Te.fragmentId),Ca(),F("correct"),D({}),Ee(!0),ot(P),at(0),oe<100&&vt<=1&&Re(!0),jt(!0,oe/100),Lt({correct:!0,direction:`quote:${Te.fragmentId}`,expected:je,answer:_,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:M})):(F("incorrect"),D({}),Ee(!1),ot(P),at(Se=>{const Ie=Se+1;return Ie>=vt&&O&&(Re(!0),Ee(!0)),Ie}),jt(!1,oe/100),window.setTimeout(()=>{var Se;return(Se=it.current)==null?void 0:Se.focus()},40),Lt({correct:!1,direction:`quote:${Te.fragmentId}`,expected:je,answer:_,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:M}));return}if(!je)return;const r=ga(je,_,Nt),u=ue==="exact"&&kt(_)===kt(je),w=Ht(r),b=u||w,K=Yt(r);b?(F("correct"),D({}),Ee(!0),ot(r),at(0),K<100&&vt<=1&&Re(!0),jt(!0,K/100),Lt({correct:!0,direction:ye?`${ye} -> ${je}`:null,expected:je,answer:_,evalType:"text"})):(F("incorrect"),D({}),Ee(!1),ot(r),at(y=>{const A=y+1;return A>=vt&&O&&(Re(!0),Ee(!0)),A}),jt(!1,K/100),window.setTimeout(()=>{var y;return(y=it.current)==null?void 0:y.focus()},40),Lt({correct:!1,direction:ye?`${ye} -> ${je}`:null,expected:je,answer:_,evalType:"text"}))},Ya=r=>{if(ua(),!je)return;const u=ga(je,r,Nt),w=kt(r)===kt(je),b=Ht(u),K=w||b,y=Yt(u);K?(F("correct"),D({}),Ee(!0),ot(u),at(0),y<100&&vt<=1&&Re(!0),jt(!0,y/100),Lt({correct:!0,direction:"word->language",expected:je,answer:r,evalType:"language-select"})):(F("incorrect"),D({}),Ee(!1),ot(u),at(A=>{const M=A+1;return M>=vt&&O&&(Re(!0),Ee(!0)),M}),jt(!1,y/100),Lt({correct:!1,direction:"word->language",expected:je,answer:r,evalType:"language-select"}))},Ga=()=>{ua(),F("correct"),Ee(!0),at(0),jt(!0,1),je&&Lt({correct:!0,direction:"manual",expected:je,answer:_,evalType:"manual"})},Xa=()=>{if(jt(!1,0),de&&de.cardType==="info"&&de.infoType==="citation"){F(null),ge(""),Re(!1),D({}),Ee(!1),ot(null),at(0),x(r=>Math.min(r+1,I.length));return}da()};a.useEffect(()=>{ua()},[fe,I]);const Zt=r=>{var w;if(r.key!=="Enter")return;if(r.preventDefault(),r.stopPropagation(),ht){da();return}const u=ze.find(b=>!(We[b.key]??"").trim());if(u){(w=$t.current[u.key])==null||w.focus();return}Ma()},T=t.cogita.library.revision.revealModeAfterIncorrect,O=ze.length>0||!!je;return e.jsxs(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,children:[ae==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${pe.total?Math.min(100,Math.max(0,pe.current/pe.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:pe.total?`${Math.min(pe.current,pe.total)} / ${pe.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:$}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",f).replace("{check}",U)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:S,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${S}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${S}/collections/${j}`,children:t.cogita.library.actions.collectionDetail})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:ve?`${ve.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Pt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Pt.currentLevel??"-"," / ",Pt.levelsCount]}):null,ve?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(ve.correct)).replace("{total}",String(ve.total))}),ve.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(ve.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(an,{outcomes:Qe})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[pt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:pt})}):null,e.jsx("section",{className:"cogita-revision-card","data-feedback":ie?`${ie.kind}-${ie.tick}`:re?"idle":W??"idle",children:de?e.jsx(e.Fragment,{children:me?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(tn,{copy:t,currentCard:de,currentTypeLabel:Ft,prompt:ye,languages:ee,answer:_,onAnswerChange:r=>ge(u=>Ba(u,r,Ve)),computedExpected:ze,computedAnswers:We,onComputedAnswerChange:(r,u)=>et(w=>({...w,[r]:Ba(w[r]??"",u,Ve)})),answerTemplate:Ce,outputVariables:Ae,variableValues:De,computedFieldFeedback:Ze,feedback:W,canAdvance:ht,quoteContext:Te,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Ma,onSkip:Xa,onLanguageSelect:Ya,onMarkReviewed:Ga,onAdvance:da,showCorrectAnswer:Me,setShowCorrectAnswer:Re,onRevealCorrect:()=>Ee(!0),answerMask:lt,expectedAnswer:je,hasExpectedAnswer:O,handleComputedKeyDown:Zt,answerInputRef:it,computedInputRefs:$t,scriptMode:Ve,setScriptMode:He,matchPairs:Q==null?void 0:Q.pairs,matchLeftOrder:Q==null?void 0:Q.leftOrder,matchRightOrder:Q==null?void 0:Q.rightOrder,matchSelection:Q==null?void 0:Q.selection,matchActiveLeft:Q==null?void 0:Q.activeLeft,matchActiveRight:Q==null?void 0:Q.activeRight,matchFeedback:$e,onMatchLeftSelect:ca,onMatchRightSelect:zt})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${S}/collections/${j}`,children:t.cogita.library.actions.collectionDetail})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Ut?`${mt} / ${Ut}`:t.cogita.library.revision.progressUnlimited}),ae==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),ae==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),ae==="ready"&&I.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:T}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",vt]})]})]}),Pt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Pt.activeCount," / ",Pt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Pt.counts.map((r,u)=>{const w=u+1,b=Pt.currentLevel===w,K=Pt.percentages[u]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":b,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:w}),e.jsx("strong",{children:r})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,K))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[K.toFixed(1),"%"]})]},`level-${w}`)})})]}):null,wt?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:wt.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:wt.dots.map(r=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,r.value*100))}%`,background:`rgba(${Math.round(255*(1-r.value))}, ${Math.round(200*r.value)}, 80, 0.9)`}},r.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:wt.knownCount})]})]}):null,ft?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:la})]})}):null]})]})]})})})]})]})}const is=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],Oi={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},qi=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Ui=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function Wi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,libraryId:d,collectionId:j}){const[c,h]=a.useState(""),[S,se,Y]=As([]),[q,k,g]=Fs([]),[ue,z]=a.useState(null),[f,U]=a.useState(null),[$,G]=a.useState(null),I=`/#/cogita/library/${d}`;a.useEffect(()=>{Va(d,j).then(C=>h(C.name)).catch(()=>h(t.cogita.library.collections.defaultName))},[d,j,t]),a.useEffect(()=>{$n({libraryId:d,collectionId:j}).then(C=>{if(!C.graphId||C.graphId==="00000000-0000-0000-0000-000000000000"){se([]),k([]);return}const fe=C.nodes.map(_=>{var ye;const ge=_.payload??{},W=ge.position??{x:120,y:120},F=ge.params??{};return{id:_.nodeId,type:"default",position:W,data:{nodeType:_.nodeType,label:((ye=is.find(we=>we.type===_.nodeType))==null?void 0:ye.label)??_.nodeType,params:F}}}),x=C.edges.map(_=>({id:_.edgeId,source:_.fromNodeId,target:_.toNodeId,sourceHandle:_.fromPort??void 0,targetHandle:_.toPort??void 0}));se(fe),k(x)}).catch(()=>{se([]),k([])})},[d,j,k,se]);const R=a.useMemo(()=>S.find(C=>C.id===ue)??null,[S,ue]),ee=C=>{var ge;const fe=crypto.randomUUID(),x=((ge=is.find(W=>W.type===C))==null?void 0:ge.label)??C,_={...Oi[C]};se(W=>[...W,{id:fe,type:"default",position:{x:120+W.length*40,y:120+W.length*40},data:{nodeType:C,label:x,params:_}}]),z(fe)},te=a.useCallback(C=>{k(fe=>Ps({...C,id:crypto.randomUUID()},fe))},[k]),ae=async()=>{U(null);try{await En({libraryId:d,collectionId:j,nodes:S.map(C=>({nodeId:C.id,nodeType:C.data.nodeType,payload:{position:C.position,params:C.data.params}})),edges:q.map(C=>({edgeId:C.id,fromNodeId:C.source,fromPort:C.sourceHandle??null,toNodeId:C.target,toPort:C.targetHandle??null}))}),U(t.cogita.library.graph.saveSuccess)}catch{U(t.cogita.library.graph.saveFail)}},Ke=async()=>{try{const C=await Rn({libraryId:d,collectionId:j});G(C)}catch{G(null)}},pe=C=>{R&&se(fe=>fe.map(x=>x.id===R.id?{...x,data:{...x.data,params:C}}:x))};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${I}/collections/${j}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Ke,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:ae,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:is.map(C=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>ee(C.type),children:C.label},C.type))}),f?e.jsx("p",{className:"cogita-help",children:f}):null,$&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String($.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String($.connections)).replace("{infos}",String($.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(zs,{nodes:S,edges:q,onNodesChange:Y,onEdgesChange:g,onConnect:te,onNodeClick:(C,fe)=>z(fe.id),fitView:!0,children:[e.jsx(Ks,{color:"rgba(120,160,200,0.2)"}),e.jsx(Bs,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),R?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:R.data.label}),R.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(sa,{libraryId:d,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:R.data.params.tagId?{id:R.data.params.tagId,label:R.data.params.tagLabel??"",infoType:"topic"}:null,onChange:C=>pe({...R.data.params,tagId:(C==null?void 0:C.id)??null,tagLabel:(C==null?void 0:C.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:R.data.params.scope??"any",onChange:C=>pe({...R.data.params,scope:C.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),R.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(sa,{libraryId:d,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:R.data.params.languageId?{id:R.data.params.languageId,label:R.data.params.languageLabel??"",infoType:"language"}:null,onChange:C=>pe({...R.data.params,languageId:(C==null?void 0:C.id)??null,languageLabel:(C==null?void 0:C.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:R.data.params.scope??"any",onChange:C=>pe({...R.data.params,scope:C.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),R.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:R.data.params.infoType??"word",onChange:C=>pe({...R.data.params,infoType:C.target.value}),children:Ui.map(C=>e.jsx("option",{value:C.value,children:C.label},C.value))})]}),e.jsx(sa,{libraryId:d,infoType:R.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:R.data.params.infoId?{id:R.data.params.infoId,label:R.data.params.infoLabel??"",infoType:R.data.params.infoType??"word"}:null,onChange:C=>pe({...R.data.params,infoId:(C==null?void 0:C.id)??null,infoLabel:(C==null?void 0:C.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),R.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:R.data.params.connectionType??"translation",onChange:C=>pe({...R.data.params,connectionType:C.target.value}),children:qi.map(C=>e.jsx("option",{value:C.value,children:C.label},C.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:R.data.params.connectionId??"",onChange:C=>pe({...R.data.params,connectionId:C.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(R.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const rs="cogita.preferences",ln=["library_overview","all_cards","all_collections","storyboards","texts","dependencies","transfer"],os={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},ls=["settings","run","shared"];function Hi(t,s=""){const n=t.split("/").filter(Boolean);if(n[0]!=="cogita"||n[1]!=="library")return{};const i=n[2];if(!i)return{};if(!n[3])return{libraryId:i,target:"library_overview"};const l=new URLSearchParams(s),m=l.get("revisionId")??void 0,p=l.get("infoId")??void 0,v=l.get("infoView")==="cards"?"cards":"overview",E=l.get("collectionAction"),N=l.get("libraryAction");if(n[3]==="list")return{libraryId:i,target:N==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:m,infoId:p,infoView:v,libraryAction:N==="new-info"?"new-info":void 0};if(n[3]==="detail"||n[3]==="collection")return{libraryId:i,target:"all_cards",cardMode:n[3],revisionId:m,infoId:p,infoView:v};if(n[3]==="new"||n[3]==="add")return{libraryId:i,target:"new_card",revisionId:m,libraryAction:"new-info"};if(n[3]==="edit")return{libraryId:i,target:"new_card",revisionId:m,infoId:n[4]};if(n[3]==="shared-revisions")return{libraryId:i,target:"all_collections",revisionId:m};if(n[3]==="dependencies")return{libraryId:i,target:"dependencies"};if(n[3]==="transfer")return{libraryId:i,target:"transfer"};if(n[3]==="storyboards")return n[4]==="new"?{libraryId:i,target:"new_storyboard"}:{libraryId:i,target:"storyboards"};if(n[3]==="texts")return n[4]==="new"?{libraryId:i,target:"new_text"}:{libraryId:i,target:"texts"};if(n[3]!=="collections")return{libraryId:i,target:"library_overview"};if(n[4]==="new")return{libraryId:i,target:"new_collection",revisionId:m};const d=n[4];return d?n[5]==="graph"?{libraryId:i,target:"all_collections",collectionId:d,revisionId:m,revisionView:"graph"}:n[5]==="shared-revisions"?{libraryId:i,target:"all_collections",collectionId:d,revisionId:m,revisionView:"shared"}:n[5]==="revision"?{libraryId:i,target:"all_collections",collectionId:d,revisionId:m,revisionView:n[6]==="run"?"run":"settings"}:E==="new-revision"?{libraryId:i,target:"all_collections",collectionId:d,revisionId:m,revisionView:"new"}:{libraryId:i,target:"all_collections",collectionId:d,revisionId:m,revisionView:"detail"}:E==="new-collection"?{libraryId:i,target:"new_collection",collectionAction:"new-collection"}:{libraryId:i,target:"all_collections"}}function Rs(t,s="library_overview",n,i,l,m,p="overview"){const v=(E,N)=>{const d=new URLSearchParams;N!=null&&N.revisionId&&d.set("revisionId",N.revisionId),N!=null&&N.collectionAction&&d.set("collectionAction",N.collectionAction),N!=null&&N.libraryAction&&d.set("libraryAction",N.libraryAction),N!=null&&N.infoId&&d.set("infoId",N.infoId),N!=null&&N.infoView&&(N!=null&&N.infoId)&&d.set("infoView",N.infoView);const j=d.toString();return j?`${E}?${j}`:E};return t?s==="library_overview"?v(`/cogita/library/${t}`,{revisionId:l}):s==="all_cards"?v(`/cogita/library/${t}/list`,{revisionId:l,infoId:m,infoView:p}):s==="new_card"?m?v(`/cogita/library/${t}/edit/${m}`,{revisionId:l}):v(`/cogita/library/${t}/list`,{revisionId:l,libraryAction:"new-info"}):s==="all_collections"?n?i==="graph"?v(`/cogita/library/${t}/collections/${n}/graph`,{revisionId:l}):i==="settings"?v(`/cogita/library/${t}/collections/${n}/revision`,{revisionId:l}):i==="run"?v(`/cogita/library/${t}/collections/${n}/revision/run`,{revisionId:l}):i==="shared"?v(`/cogita/library/${t}/collections/${n}/shared-revisions`,{revisionId:l}):i==="new"?v(`/cogita/library/${t}/collections/${n}`,{revisionId:l,collectionAction:"new-revision"}):v(`/cogita/library/${t}/collections/${n}`,{revisionId:l}):v(`/cogita/library/${t}/collections`,{revisionId:l}):s==="new_collection"?v(`/cogita/library/${t}/collections`,{revisionId:l,collectionAction:"new-collection"}):s==="transfer"?v(`/cogita/library/${t}/transfer`,{revisionId:l}):s==="storyboards"?v(`/cogita/library/${t}/storyboards`,{revisionId:l}):s==="new_storyboard"?v(`/cogita/library/${t}/storyboards/new`,{revisionId:l}):s==="texts"?v(`/cogita/library/${t}/texts`,{revisionId:l}):s==="new_text"?v(`/cogita/library/${t}/texts/new`,{revisionId:l}):s==="dependencies"?v(`/cogita/library/${t}/dependencies`,{revisionId:l}):v(`/cogita/library/${t}`,{revisionId:l}):"/cogita"}function xa(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function Qi(t){return typeof t=="string"&&ln.includes(t)}function Yi(t,s){var v;if(!t.length)return null;const n=t.filter(E=>s.has(E.roleId)),i=n.length>0?n:t,l=i.map(E=>{var d,j;const N=((j=(d=E.fields.find(c=>c.fieldType==="role_kind"))==null?void 0:d.plainValue)==null?void 0:j.toLowerCase())??"";return{roleId:E.roleId,roleKind:N}}),m=l.find(E=>E.roleKind.includes("master"));if(m)return m.roleId;const p=l.find(E=>E.roleKind.includes("account")||E.roleKind.includes("user"));return p?p.roleId:((v=i[0])==null?void 0:v.roleId)??null}function Gi(t){if(!t)return{version:1,byLibrary:{}};try{const s=JSON.parse(t);return!s||typeof s!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:s.lastLibraryId,byLibrary:s.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function Xi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N}){const d=Es(),j=_a(),c=a.useMemo(()=>Hi(j.pathname,j.search),[j.pathname,j.search]),h=t.cogita.workspace,[S,se]=a.useState([]),[Y,q]=a.useState([]),[k,g]=a.useState([]),[ue,z]=a.useState([]),[f,U]=a.useState(void 0),[$,G]=a.useState("library_overview"),[I,R]=a.useState(void 0),[ee,te]=a.useState(void 0),[ae,Ke]=a.useState("detail"),[pe,C]=a.useState(void 0),[fe,x]=a.useState(!1),[_,ge]=a.useState(!0),[W,F]=a.useState(!1),[ye,we]=a.useState(!1),[je,Fe]=a.useState(null),[Te,qe]=a.useState(0),[ze,Ne]=a.useState(""),[We,et]=a.useState(""),[Ze,D]=a.useState(""),[H,Ue]=a.useState(null),[Ce,ne]=a.useState(null),Ae=a.useRef({version:1,byLibrary:{}}),Be=a.useRef(!1),De=a.useRef(!1),_e=a.useRef(null),Q=a.useMemo(()=>S.find(o=>o.libraryId===f)??null,[S,f]),ce=a.useMemo(()=>Y.find(o=>o.collectionId===I)??null,[Y,I]),$e=a.useMemo(()=>ue.find(o=>o.revisionId===ee)??null,[ue,ee]),L=a.useMemo(()=>({detail:h.revisions.detail,graph:h.revisions.graph,settings:h.revisions.settings,run:h.revisions.run,shared:h.targets.sharedRevisions,new:h.revisionForm.createAction}),[h.revisions.detail,h.revisions.graph,h.revisions.run,h.revisions.settings,h.targets.sharedRevisions,h.revisionForm.createAction]),V=a.useMemo(()=>[{value:"detail",label:L.detail},{value:"graph",label:L.graph},{value:"settings",label:h.targets.allRevisions},{value:"run",label:L.run},{value:"shared",label:L.shared}],[L.detail,L.graph,L.run,L.shared,h.targets.allRevisions]),ie=a.useMemo(()=>$==="new_card"?"all_cards":$==="new_collection"?"all_collections":$==="new_storyboard"?"storyboards":$==="new_text"?"texts":$,[$]),ke=a.useMemo(()=>ae==="new"?"settings":ae,[ae]),xe=a.useMemo(()=>c.infoId?"selected":$==="new_card"?"create":"search",[c.infoId,$]),Le=a.useMemo(()=>k.find(o=>o.infoId===c.infoId)??null,[k,c.infoId]),Ve=a.useMemo(()=>({library_overview:h.targets.libraryOverview,all_cards:h.targets.allCards,new_card:h.targets.newCard,all_collections:h.targets.allCollections,new_collection:h.targets.newCollection,transfer:h.targets.transfer,storyboards:h.targets.storyboards,new_storyboard:h.targets.newStoryboard,texts:h.targets.texts,new_text:h.targets.newText,dependencies:h.targets.dependencies}),[h.targets]),He=a.useMemo(()=>Ve[ie]??ie,[ie,Ve]),Me=L[ke],Re=!!f,ve=a.useMemo(()=>{const o=E==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":E==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return E==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:o},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:o},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:o},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:o},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:o},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:o},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:o},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:o},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:o},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:o},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:o},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:o},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:o},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:E==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:o},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:o},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:o},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:o},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:o},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:o},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:o},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:o},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:o},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:o},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:o},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:o},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:o},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:o},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:o},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:o},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:o},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:o},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:o},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:o},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:o},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:o},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:o},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:o},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:o},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:o},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[E]),nt=ve.length,Qe=Math.max(0,Math.min(Te,nt-1)),Ye=ve[Qe],pt=!!I,bt=Re&&$==="all_collections",Je=pt&&$==="all_collections",tt=pt&&$==="all_collections"&&ls.includes(ae),lt=a.useCallback(o=>{const me=!!o.libraryId;let J=o.target,Pe=o.collectionId,st=o.revisionId,rt=o.revisionView,de=o.infoId,re=o.infoView??c.infoView??"overview";me?os[J].requiresCollection&&!Pe?(J="all_collections",st=void 0,rt="detail"):J!=="all_collections"?(Pe=void 0,st=void 0,J!=="new_card"&&J!=="all_cards"&&(de=void 0,re="overview")):os[J].allowsRevision?ls.includes(rt)||(st=void 0):rt="detail":(J="library_overview",Pe=void 0,st=void 0,rt="detail",de=void 0,re="overview"),U(o.libraryId),G(J),R(Pe),te(st),Ke(rt),x(!1);const xt=xa(Rs(o.libraryId,J,Pe,rt,st,de,re));xa(`${j.pathname}${j.search}`)!==xt&&(_e.current=xt,d(xt))},[j.pathname,j.search,d,c.infoView]),ot=o=>{lt({libraryId:f,target:"all_collections",collectionId:I,revisionId:ls.includes(o)?ee:void 0,revisionView:o})},Ct=a.useMemo(()=>[{key:"library",label:h.layers.library,visible:!0,value:f??"",selectedLabel:(Q==null?void 0:Q.name)??h.path.noLibrarySelected,disabled:_||S.length===0,options:S.map(o=>({value:o.libraryId,label:o.name})),emptyOption:h.noLibraryOption,onSelect:o=>{const me=o||void 0;lt({libraryId:me,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:h.layers.target,visible:Re,value:ie,selectedLabel:He,disabled:!Re,options:ln.map(o=>({value:o,label:Ve[o]})),onSelect:o=>{const me=o;lt({libraryId:f,target:me,collectionId:I,revisionId:ee,revisionView:ae,infoId:me==="new_card"?c.infoId:void 0})}},{key:"info_mode",label:h.layers.target,visible:ie==="all_cards",value:xe,selectedLabel:xe==="create"?h.infoMode.create:xe==="selected"?(Le==null?void 0:Le.label)??pe??t.cogita.library.list.selectedEmpty:h.infoMode.search,disabled:!Re,options:[{value:"search",label:h.infoMode.search},{value:"create",label:h.infoMode.create},...c.infoId?[{value:"selected",label:(Le==null?void 0:Le.label)??pe??t.cogita.library.list.selectedEmpty}]:[]],onSelect:o=>{if(o==="selected"){if(!c.infoId)return;lt({libraryId:f,target:"all_cards",collectionId:I,revisionId:ee,revisionView:ae,infoId:c.infoId,infoView:"overview"});return}if(o==="create"){lt({libraryId:f,target:"new_card",collectionId:I,revisionId:ee,revisionView:ae,infoId:void 0});return}lt({libraryId:f,target:"all_cards",collectionId:I,revisionId:ee,revisionView:ae,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:h.layers.target,visible:ie==="all_cards"&&!!c.infoId,value:$==="new_card"&&c.infoId?"edit":c.infoView==="cards"?"cards":"overview",selectedLabel:$==="new_card"&&c.infoId?h.infoActions.edit:c.infoView==="cards"?h.infoActions.seeCards:h.infoActions.overview,disabled:!Re||!c.infoId,options:[{value:"overview",label:h.infoActions.overview},{value:"edit",label:h.infoActions.edit},{value:"cards",label:h.infoActions.seeCards}],onSelect:o=>{if(c.infoId){if(o==="edit"){lt({libraryId:f,target:"new_card",collectionId:I,revisionId:ee,revisionView:ae,infoId:c.infoId});return}if(o==="cards"){lt({libraryId:f,target:"all_cards",collectionId:I,revisionId:ee,revisionView:ae,infoId:c.infoId,infoView:"cards"});return}lt({libraryId:f,target:"all_cards",collectionId:I,revisionId:ee,revisionView:ae,infoId:c.infoId,infoView:"overview"})}}},{key:"collection",label:h.layers.collection,visible:bt,value:I??"",selectedLabel:(ce==null?void 0:ce.name)??h.path.noCollectionSelected,disabled:!Re||W||Y.length===0,options:Y.map(o=>({value:o.collectionId,label:o.name})),emptyOption:h.selectCollectionOption,onSelect:o=>{lt({libraryId:f,target:"all_collections",collectionId:o||void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection_action",label:h.layers.revision,visible:Je,value:ke,selectedLabel:Me,disabled:!I,options:V.map(o=>({value:o.value,label:o.label})),onSelect:o=>{ot(o)}},{key:"revision_entry",label:h.layers.revision,visible:tt,value:ee??"",selectedLabel:($e==null?void 0:$e.name)??h.status.noRevisions,disabled:!pt||ye||ue.length===0,options:ue.map(o=>({value:o.revisionId,label:o.name})),emptyOption:h.status.noRevisions,onSelect:o=>{lt({libraryId:f,target:"all_collections",collectionId:I,revisionId:o||void 0,revisionView:ae})}}],[V,Y,W,xe,k,S,_,lt,ue,ye,ce,I,Le,$e,ee,pe,pt,Re,Q,f,Me,ae,$,ke,ie,He,bt,Je,tt,Ve,t.cogita.library.list.selectedEmpty,c.infoId,c.infoView,h.infoActions.edit,h.infoActions.overview,h.infoActions.seeCards,h.layers.collection,h.layers.library,h.layers.revision,h.layers.target,h.noLibraryOption,h.path.noCollectionSelected,h.path.noLibrarySelected,h.selectCollectionOption]),at=a.useMemo(()=>Ct.filter(o=>o.visible),[Ct]),it=a.useMemo(()=>at.filter(o=>o.key!=="library"&&o.key!=="collection"&&o.key!=="revision_entry"),[at]),$t=a.useMemo(()=>it.find(o=>o.key==="target")??null,[it]),ht=a.useMemo(()=>it.find(o=>o.key==="info_mode")??null,[it]),Ee=a.useMemo(()=>it.find(o=>o.key==="info_selected_action")??null,[it]),ct=a.useMemo(()=>it.find(o=>o.key==="collection_action")??null,[it]),yt=a.useCallback((o,me)=>o?e.jsx("div",{className:"cogita-sidebar-actions",children:o.options.map(J=>e.jsx("button",{type:"button",className:`ghost ${String(o.value)===J.value?"active":""}`,onClick:()=>o.onSelect(J.value),disabled:o.disabled,children:J.label},`${me}:${o.key}:${J.value}`))}):null,[]),Mt=a.useMemo(()=>{const o=c.libraryId;if(!o||!j.pathname.startsWith("/cogita/library/"))return null;const me={copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,libraryId:o};if(c.target==="library_overview")return e.jsx(Jn,{...me});if(c.target==="all_cards")return e.jsx(ii,{...me,mode:c.cardMode??"list"});if(c.target==="new_card")return e.jsx(gi,{...me,editInfoId:c.infoId});if(c.target==="dependencies")return e.jsx(pi,{...me});if(c.target==="transfer")return e.jsx(bi,{...me});if(c.target==="storyboards"||c.target==="new_storyboard")return e.jsx(yi,{...me});if(c.target==="texts"||c.target==="new_text")return e.jsx(xi,{...me});if(c.target==="all_collections"){if(c.collectionId){const J={...me,collectionId:c.collectionId};return c.revisionView==="graph"?e.jsx(Wi,{...J}):c.revisionView==="shared"?e.jsx(fi,{...me,collectionId:c.collectionId}):c.revisionView==="settings"?e.jsx(Ii,{...J,revisionId:c.revisionId}):c.revisionView==="run"?e.jsx(Vi,{...J,revisionId:c.revisionId}):e.jsx(vi,{...J})}return e.jsx(Ls,{...me})}return c.target==="new_collection"?e.jsx(Ls,{...me}):null},[s,t,E,j.pathname,d,N,m,v,i,l,c.cardMode,c.collectionId,c.infoId,c.libraryId,c.revisionId,c.revisionView,c.target,p,n]);a.useEffect(()=>{let o=!1;return(async()=>{var J,Pe,st,rt,de;ge(!0);try{await An();const[re,xt,At]=await Promise.all([Vs(),Fn(),Pn()]);if(o)return;se(re);const qt=new Set(At.nodes.filter(mt=>mt.nodeType==="role"&&mt.canLink).map(mt=>mt.roleId??"")),Kt=Yi(xt,qt);if(Ue(Kt),Kt){const mt=At.nodes.find(vt=>vt.nodeType==="data"&&vt.roleId===Kt&&(vt.fieldType===rs||vt.label===rs));ne((mt==null?void 0:mt.dataKeyId)??null),Ae.current=Gi(mt==null?void 0:mt.value)}const Ft=(J=re.find(mt=>mt.libraryId===c.libraryId))==null?void 0:J.libraryId,na=Ft?(st=(Pe=Ae.current.byLibrary)==null?void 0:Pe[Ft])==null?void 0:st.lastTarget:void 0,Ut=Qi(na)?na:"library_overview";U(Ft),G(c.target??Ut),te(c.revisionId??(Ft?(de=(rt=Ae.current.byLibrary)==null?void 0:rt[Ft])==null?void 0:de.lastRevisionId:void 0)),Ke(c.revisionView??"detail"),Be.current=!0}catch{o||Fe(h.status.loadFailed)}finally{o||ge(!1)}})(),()=>{o=!0}},[h.status.loadFailed]),a.useLayoutEffect(()=>{if(Be.current){if(!c.libraryId){U(void 0),G(c.target??"library_overview"),R(void 0),te(void 0),Ke("detail");return}c.libraryId&&S.some(o=>o.libraryId===c.libraryId)&&U(c.libraryId),c.target&&G(c.target),R(c.collectionId),te(c.revisionId),c.revisionView&&Ke(c.revisionView)}},[S,c.collectionId,c.libraryId,c.revisionId,c.revisionView,c.target]),a.useEffect(()=>{if(!f){q([]),R(void 0),g([]),z([]),te(void 0);return}let o=!1;return F(!0),wa({libraryId:f,limit:200}).then(me=>{var st;if(o)return;const J=me.items;q(J);const Pe=(st=J.find(rt=>rt.collectionId===c.collectionId))==null?void 0:st.collectionId;R(Pe)}).catch(()=>{o||(q([]),R(void 0))}).finally(()=>{o||F(!1)}),()=>{o=!0}},[c.collectionId,f]),a.useEffect(()=>{if(!f||ie!=="all_cards"&&$!=="new_card"){g([]);return}let o=!1;return hs({libraryId:f,limit:200}).then(me=>{o||g(me)}).catch(()=>{o||g([])}),()=>{o=!0}},[ie,f,$]),a.useEffect(()=>{if(!f||!I){z([]),te(void 0);return}let o=!1;return we(!0),Os({libraryId:f,collectionId:I}).then(me=>{var st,rt,de,re;if(o)return;z(me);const J=(rt=(st=Ae.current.byLibrary)==null?void 0:st[f])==null?void 0:rt.lastRevisionId,Pe=((de=me.find(xt=>xt.revisionId===c.revisionId))==null?void 0:de.revisionId)??((re=me.find(xt=>xt.revisionId===J))==null?void 0:re.revisionId);te(Pe)}).catch(()=>{o||(z([]),te(void 0))}).finally(()=>{o||we(!1)}),()=>{o=!0}},[c.revisionId,I,f]),a.useEffect(()=>{const o=c.infoId;if(!f||!o){C(void 0);return}let me=!1;return aa({libraryId:f,infoId:o}).then(J=>{if(me)return;const Pe=J.payload;C((Pe==null?void 0:Pe.label)??(Pe==null?void 0:Pe.name)??(Pe==null?void 0:Pe.title)??J.infoId)}).catch(()=>{me||C(o)}),()=>{me=!0}},[c.infoId,f]),a.useEffect(()=>{if(!Be.current||c.libraryId&&S.some(Pe=>Pe.libraryId===c.libraryId)&&c.libraryId!==f||c.target&&c.target!==$||c.revisionView&&c.revisionView!==ae||c.revisionId&&c.revisionId!==ee||os[$].requiresCollection&&!I&&c.target==="all_collections"&&c.collectionId)return;const o=xa(`${j.pathname}${j.search}`);if(xa(j.pathname)==="/cogita"&&!c.libraryId&&!f){_e.current=null;return}const J=xa(Rs(f,$,I,ae,ee,c.infoId,c.infoView??"overview"));if(o===J){_e.current=null;return}_e.current!==J&&(_e.current=J,d(J,{replace:!0}))},[S,j.pathname,j.search,d,c.collectionId,c.infoId,c.infoView,c.libraryId,c.revisionId,c.revisionView,c.target,I,f,ee,ae,$]),a.useEffect(()=>{if(typeof window>"u")return;const o=()=>{window.innerWidth>920&&x(!1)};return window.addEventListener("resize",o),()=>window.removeEventListener("resize",o)},[]),a.useEffect(()=>{if(!Be.current||!H||!f||De.current)return;const o=Ae.current,me={...o.byLibrary??{}},J={...me[f]??{},lastCollectionId:I,lastRevisionId:ee,lastRevisionView:ae,lastTarget:$},Pe={version:1,lastLibraryId:f,byLibrary:{...me,[f]:J}},st=JSON.stringify(o),rt=JSON.stringify(Pe);if(st===rt)return;Ae.current=Pe,De.current=!0,(async()=>{try{if(Ce)await zn(Ce,{plainValue:rt});else{const re=await Kn(H,{itemName:rs,itemType:"data",plainValue:rt});ne(re.dataItemId)}}catch{Fe(h.status.savePrefsFailed)}finally{De.current=!1}})()},[Ce,H,I,f,ee,ae,$,h.status.savePrefsFailed]);const Rt=async()=>{const o=ze.trim();if(!o){Fe(t.cogita.user.libraryNameRequired);return}Fe(null);try{const me=await _n({name:o});se(J=>[me,...J]),U(me.libraryId),G("library_overview"),R(void 0),Ne("")}catch{Fe(t.cogita.user.libraryCreateFailed)}},B=async()=>{if(!f){Fe(h.status.selectLibraryFirst);return}const o=We.trim();if(!o){Fe(t.cogita.library.collections.saveRequiredName);return}Fe(null);try{const me=await Bn({libraryId:f,name:o,items:[]}),J=await wa({libraryId:f,limit:200});q(J.items),R(me.collectionId),te(void 0),G("all_collections"),Ke("detail"),et("")}catch{Fe(t.cogita.library.collections.saveFail)}},be=async()=>{if(!f||!I){Fe(h.status.selectLibraryFirst);return}const o=Ze.trim();if(!o){Fe(h.revisionForm.nameLabel);return}Fe(null);try{const me=await Dn({libraryId:f,collectionId:I,name:o,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});z(J=>[me,...J]),te(me.revisionId),G("all_collections"),Ke("settings"),D("")}catch{Fe(h.status.loadFailed)}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${fe?"open":""}`,"aria-label":h.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{children:(Q==null?void 0:Q.name)??h.path.noLibrarySelected}),e.jsx("p",{className:"cogita-sidebar-note",children:Q?h.sidebar.libraryActionsHint:h.status.selectLibraryFirst}),yt($t,"sidebar")]}),ht?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:h.sidebar.infoActionsHint}),yt(ht,"sidebar"),Ee?e.jsxs("div",{className:"cogita-sidebar-actions-nested",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(Le==null?void 0:Le.label)??pe??t.cogita.library.list.selectedEmpty}),e.jsx("p",{className:"cogita-sidebar-note",children:h.sidebar.selectedInfoActionsHint}),yt(Ee,"sidebar")]}):null]}):null,ce?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:ce.name}),e.jsx("p",{className:"cogita-sidebar-note",children:h.sidebar.collectionActionsHint}),yt(ct,"sidebar")]}):null,e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:h.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:i,children:h.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{v("cogita"),x(!1)},children:h.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:l,children:p?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),fe?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":h.sidebar.closeMenu,onClick:()=>x(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":h.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>x(o=>!o),"aria-label":fe?h.sidebar.closeMenu:h.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),at.map((o,me)=>e.jsxs("div",{className:"cogita-browser-segment",children:[me>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,o.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":o.label,children:o.selectedLabel}):e.jsxs("select",{"aria-label":o.label,value:o.value,onChange:J=>o.onSelect(J.target.value),disabled:o.disabled,children:[o.emptyOption?e.jsx("option",{value:"",children:o.emptyOption}):null,o.options.map(J=>e.jsx("option",{value:J.value,children:J.label},`${o.key}:${J.value}`))]})]},`menu:${o.key}`))]}),Mt?e.jsxs(e.Fragment,{children:[$==="new_collection"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.library.actions.createCollection}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{type:"text",value:We,onChange:o=>et(o.target.value),placeholder:t.cogita.library.collections.namePlaceholder,disabled:!f})]}),e.jsx("button",{type:"button",className:"cta",onClick:B,disabled:!f,children:t.cogita.library.actions.createCollection}),je?e.jsx("p",{className:"cogita-form-error",children:je}):null]}):null,$==="all_collections"&&I&&ae==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:h.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Ze,onChange:o=>D(o.target.value),placeholder:h.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:be,children:h.revisionForm.createAction}),je?e.jsx("p",{className:"cogita-form-error",children:je}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Hs.Provider,{value:!0,children:Mt})})]}):null,Mt?null:e.jsx(e.Fragment,{children:f?null:e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:Ye.step}),e.jsx("h2",{children:Ye.title})]}),e.jsxs("p",{children:[Qe+1," / ",nt]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:Ye.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:Ye.passages.map(o=>e.jsx("p",{children:o},o))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:Ye.focus.map(o=>e.jsx("span",{children:o},o))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:Ye.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:ve.map((o,me)=>e.jsx("button",{type:"button",className:`ghost ${me===Qe?"active":""}`,onClick:()=>qe(me),"aria-label":`${me+1}`,children:me+1},`tutorial:${o.title}:${me}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:Qe===0,onClick:()=>qe(o=>Math.max(0,o-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:Qe===nt-1,onClick:()=>qe(o=>Math.min(nt-1,o+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:ze,onChange:o=>Ne(o.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Rt,children:t.cogita.user.createLibraryAction}),je?e.jsx("p",{className:"cogita-form-error",children:je}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),S.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,S.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:S.map(o=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{lt({libraryId:o.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:o.name})]},o.libraryId))}):null]})]})]})})]})]})})}const sr=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:Xi},Symbol.toStringTag,{value:"Module"}));function Ji({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,shareId:d}){const[j,c]=a.useState(null),[h,S]=a.useState("loading"),[se,Y]=a.useState(t.cogita.library.collections.defaultName),[q,k]=a.useState("Cogita Library"),[g,ue]=a.useState([]),[z,f]=a.useState([]),[U,$]=a.useState("idle"),[G,I]=a.useState({current:0,total:0}),[R,ee]=a.useState(0),[te,ae]=a.useState(""),[Ke,pe]=a.useState(null),[C,fe]=a.useState(null),[x,_]=a.useState(null),[ge,W]=a.useState(null),[F,ye]=a.useState([]),[we,je]=a.useState({}),[Fe,Te]=a.useState({}),[qe,ze]=a.useState(null),[Ne,We]=a.useState(null),[et,Ze]=a.useState(null),[D,H]=a.useState(null),[Ue,Ce]=a.useState({}),ne=a.useRef(0),[Ae,Be]=a.useState(null),De=a.useRef(null),_e=a.useRef(null),[Q,ce]=a.useState(null),[$e,L]=a.useState(!1),[V,ie]=a.useState(null),[ke,xe]=a.useState([]),[Le,Ve]=a.useState(null),He=a.useRef(null),Me=a.useRef(null),[Re,ve]=a.useState(null),[nt,Qe]=a.useState(0),Ye=a.useRef(null),pt=a.useRef({}),[bt,Je]=a.useState(!1),[tt,lt]=a.useState({}),ot=a.useRef(null),Ct=a.useRef(new Set),at=a.useRef({}),[it,$t]=a.useState([]),[ht,Ee]=a.useState(new Set),[ct,yt]=a.useState(!1),Mt=_a(),Rt=a.useMemo(()=>new URLSearchParams(Mt.search),[Mt.search]),B=a.useMemo(()=>Rt.get("key")??"",[Rt]),be=(j==null?void 0:j.mode)??"random",o=(j==null?void 0:j.check)??"exact",me=(j==null?void 0:j.limit)??20,J=a.useMemo(()=>fs((j==null?void 0:j.revisionType)??be),[j,be]),Pe=a.useMemo(()=>{const T=j==null?void 0:j.revisionSettings,O=Js(J,Rt);return Ua(J,T??O)},[j,Rt,J]),st=a.useMemo(()=>t.cogita.library.revision[J.labelKey]??be,[t,be,J]),rt=a.useMemo(()=>o==="exact"?t.cogita.library.revision.checkValue:o,[t,o]),re=h==="ready"?g[R]??null:null,xt=(re==null?void 0:re.checkType)==="translation-match"&&D,At=a.useRef(new Map),qt=a.useRef(new Map),Kt=a.useRef(new Map),Ft=a.useRef(new Map),na=a.useMemo(()=>re?re.cardType==="vocab"?t.cogita.library.revision.vocabLabel:re.infoType?Xe(t,re.infoType):t.cogita.library.revision.infoLabel:"",[t,re]),Ut=a.useMemo(()=>{var O;return J.id!=="levels"?g.length:((O=tt.pool)==null?void 0:O.length)??J.getFetchLimit(me,Pe)},[tt,Pe,J,g.length,me]),mt=J.getProgressTotal?J.getProgressTotal(g,tt,me,Pe):J.id==="levels"?Math.min(me,Ut):g.length,vt=mt?Math.min(R+1,mt):0,Nt=Math.max(1,Number(Pe.tries??1)),Wt=Pe.compare??"anchors",ft=Math.max(0,Math.min(100,Number(Pe.minCorrectness??0))),dt=(Pe.considerDependencies??"on")==="on",Et=Math.max(0,Math.min(100,Number(Pe.dependencyThreshold??85))),Yt=T=>{const O=T.slice();for(let r=O.length-1;r>0;r-=1){const u=Math.floor(Math.random()*(r+1));[O[r],O[u]]=[O[u],O[r]]}return O},Ht=T=>T.length?T.reduce((r,u)=>r+u,0)/T.length/255*100:0,ia=T=>Ht(T)>=ft,Wa=async()=>{const T=await Vt(),O=new Map,r=new Map;T.forEach(b=>{const K=`${b.itemType}:${b.itemId}`,y=Dt(b.itemType,b.itemId,b.checkType,b.direction);O.has(K)||O.set(K,[]),O.get(K).push(b),r.has(y)||r.set(y,[]),r.get(y).push(b)});const u=new Map,w=new Map;return O.forEach((b,K)=>u.set(K,_t(b).score)),r.forEach((b,K)=>w.set(K,_t(b).score)),{itemKnowness:u,cardKnowness:w}},fa=async T=>{const O=tt,r=T.concat(O.active??[]).concat(O.pool??[]).filter((P,X,Z)=>Z.findIndex(he=>le(he)===le(P))===X);if(!dt){Ee(new Set(r.map(le)));return}const{itemKnowness:u,cardKnowness:w}=await Wa(),b=P=>{if(P.cardType!=="info"||P.infoType!=="citation"||P.checkType!=="quote-fragment")return!0;const X=St(P.direction);if(!(X!=null&&X.fragmentId))return!0;const Z=P.description??"";if(!Z.trim())return!0;const oe=ma(Z).nodes[X.fragmentId];if(!oe||!oe.leftId&&!oe.rightId)return!0;const Se=[oe.leftId,oe.rightId].filter(Ge=>!!Ge);if(Se.length===0)return!0;const Ie=Se.map(Ge=>{const ut=Dt("info",P.cardId,"quote-fragment",ka(X.mode,Ge));return w.get(ut)??0});return Ie.reduce((Ge,ut)=>Ge+ut,0)/Ie.length>=Et},K=(j==null?void 0:j.collectionId)??null,y=K?it.filter(P=>gt(P.childItemType)==="collection"&&P.childItemId===K&&!gt(P.childCheckType)&&!gt(P.childDirection)):[],A=K&&r.length>0?r.reduce((P,X)=>P+(w.get(le(X))??0),0)/r.length:0,M=new Set;for(const P of r){if(P.cardType!=="info"){M.add(le(P));continue}if(!b(P))continue;const X=it.filter(oe=>on(oe,P)).concat(y);if(X.length===0){M.add(le(P));continue}let Z=0;for(const oe of X)if(gt(oe.parentItemType)==="collection")Z+=oe.parentItemId===K?A:0;else if(gt(oe.parentCheckType)||gt(oe.parentDirection)){const Se=gt(oe.parentCheckType),Ie=gt(oe.parentDirection),Oe=Dt(oe.parentItemType,oe.parentItemId,Se,Ie);Z+=w.get(Oe)??0}else{const Se=`${oe.parentItemType}:${oe.parentItemId}`;Z+=u.get(Se)??0}Z/X.length>=Et&&M.add(le(P))}Ee(M)},Ha=T=>{for(let O=T;O<g.length;O+=1){const r=g[O];if(r&&(!dt||r.cardType!=="info"||ht.has(le(r))))return O}return-1},ra=T=>!dt||T.cardType!=="info"||ht.has(le(T)),Qa=T=>{if(J.id!=="temporal"&&J.id!=="levels")return null;const O=tt,r=(O.active??[]).concat(O.pool??[]),u=new Set;for(const w of r){const b=le(w);if(!(u.has(b)||T.has(b))&&(u.add(b),ra(w)))return w}return null},It=a.useMemo(()=>{if(J.id!=="levels")return null;const T=tt,O=T.pool??[],r=T.active??[],u=T.levelMap??{},w=Math.max(1,Number(Pe.levels??1)),b=Array.from({length:w},()=>0),K=new Set(r.map(P=>le(P)));O.forEach(P=>{const X=Math.min(w,Math.max(1,u[le(P)]??1));b[X-1]+=1});const y=O.length||1,A=b.map(P=>P/y*100),M=re?u[le(re)]??1:null;return{counts:b,percentages:A,currentLevel:M,levelsCount:w,activeCount:r.length,poolCount:O.length,activeSet:K}},[tt,Pe,J,re]),oa=a.useMemo(()=>{if(J.id!=="temporal")return null;const T=tt,O=T.pool??[],r=T.active??[],u=T.knownessMap??{},w=new Set(T.unknownSet??[]);let b=0;O.forEach(A=>{(u[le(A)]??0)>1&&(b+=1)});const K=w.size,y=r.map(A=>({id:le(A),value:w.has(le(A))?0:Math.max(0,Math.min(1,u[le(A)]??0))}));return{knownCount:b,unknownCount:K,dots:y}},[tt,J]),Pt=a.useMemo(()=>{if(!dt)return 0;const T=tt;return g.concat(T.active??[]).concat(T.pool??[]).filter((r,u,w)=>w.findIndex(b=>le(b)===le(r))===u).filter(r=>r.cardType==="info"&&!ht.has(le(r))).length},[dt,tt,g,ht]);a.useEffect(()=>{if(!dt||U!=="ready")return;const T=tt,r=g.concat(T.active??[]).concat(T.pool??[]).filter((b,K,y)=>y.findIndex(A=>le(A)===le(b))===K).filter(b=>b.cardType!=="info"||ht.has(le(b))).length,u=He.current;if(He.current=r,u===null||r<=u)return;const w=r-u;Ve(`New card available (+${w})`),Me.current&&window.clearTimeout(Me.current),Me.current=window.setTimeout(()=>Ve(null),2200)},[dt,U,tt,g,ht]),a.useEffect(()=>()=>{Me.current&&window.clearTimeout(Me.current)},[]);const wt=(T,O)=>{const r=J.applyOutcome({queue:g,meta:tt},re,me,Pe,{correct:T,correctness:O,createdUtc:new Date().toISOString()});ue(r.queue),lt(r.meta);const u=r.queue[R+1];u&&Lt(u,R+1)};a.useEffect(()=>{if(!d){S("error");return}S("loading"),Vn({shareId:d,key:B}).then(T=>{c(T),Y(T.collectionName),k(T.libraryName),S("ready")}).catch(()=>{S("error")})},[d,B]),a.useEffect(()=>{d&&On({shareId:d,key:B,type:"language"}).then(T=>f(T)).catch(()=>f([]))},[d,B]),a.useEffect(()=>{!d||h!=="ready"||qn({shareId:d,key:B}).then(T=>$t(T.items??[])).catch(()=>$t([]))},[d,B,h]),a.useEffect(()=>{if(!d||h!=="ready")return;let T=!0;return(async()=>{$("loading"),I({current:0,total:J.id==="levels"?0:J.getFetchLimit(me,Pe)});try{const r=[];let u=null,w=null;do{const X=await Un({shareId:d,key:B,limit:300,cursor:u});if(r.push(...X.items),(J.id==="levels"||J.id==="temporal")&&X.total&&(w=X.total),I(Z=>({current:r.length,total:Z.total||X.total||J.getFetchLimit(me,Pe)})),u=X.nextCursor??null,w!==null&&r.length>=w||J.id!=="levels"&&J.id!=="temporal"&&r.length>=J.getFetchLimit(me,Pe))break}while(u);if(!T)return;const b=ds(r);let K;if(J.id==="levels"){const X=Math.max(1,Number(Pe.levels??1));K={},b.forEach(Z=>{const he=le(Z);K[he]=Math.max(1,Math.min(X,1))})}let y=null,A=null,M=null;if(J.id==="temporal"){const X=await Vt(),Z=new Set(b.map(Se=>le(Se))),he=X.reduce((Se,Ie)=>{const Oe=Dt(Ie.itemType,Ie.itemId,Ie.checkType,Ie.direction);return Z.has(Oe)&&(Se[Oe]||(Se[Oe]=[]),Se[Oe].push(Ie)),Se},{});y={},A=new Set,M={};const oe=Date.now();b.forEach(Se=>{const Ie=le(Se),Oe=he[Ie]??[];if(Oe.length===0){y[Ie]=0,A.add(Ie),M[Ie]=[];return}const Ge=gs(Oe);M[Ie]=Ge;const ut=Oa(Ge,oe);y[Ie]=ut.knowness})}const P=J.id==="levels"?ps(b,me,Pe,K):J.id==="temporal"?ms(b,me,Pe,y??{},A??new Set,M??{}):J.prepare(b,me,Pe);ue(P.queue),lt(P.meta),ee(0),$("ready"),I(X=>({current:Math.min(X.current,X.total),total:X.total}))}catch{T&&$("error")}})(),()=>{T=!1}},[d,B,me,J,Pe,h]),a.useEffect(()=>{fa(g)},[g,it,dt,Et,j==null?void 0:j.collectionId]),a.useEffect(()=>{if(!re||!dt){yt(!1);return}if(re.cardType!=="info"||ht.has(le(re))){yt(!1);return}const T=Ha(R+1);if(T>=0){yt(!1),ee(T);return}if(J.id==="temporal"||J.id==="levels"){const O=g.slice(0,R+1),r=g.slice(R+1).filter(ra),u=O.concat(r),w=new Set(u.map(le)),b=Qa(w);if(b){const y=le(b);w.has(y)||(u.push(b),w.add(y),lt(A=>{const M=A,P=new Set(M.queued??[]);return P.add(y),{...M,queued:P}}))}const K=u.findIndex((y,A)=>A!==R&&ra(y));if(K>=0){ue(u),ee(K),yt(!1);return}}yt(!0)},[re,ht,dt,R,g,tt,J.id]),a.useEffect(()=>{if(ae(""),pe(null),ve(null),Qe(0),ye([]),je({}),Te({}),ze(null),We(null),Ze(null),L(!1),Je(!1),ce(null),H(null),Ce({}),!re){fe(null),_(null);return}re.cardType==="info"&&re.infoType==="computed"&&fe(t.cogita.library.revision.loadingComputed);let T=!0;return Lt(re,R).then(O=>{!T||!O||(fe(O.prompt),_(O.expectedAnswer),ye(O.computedExpected),je(O.computedAnswers),ze(O.answerTemplate),We(O.outputVariables),Ze(O.variableValues))}),()=>{T=!1}},[re,d,t]),a.useEffect(()=>{if(!re||re.cardType!=="info"||re.infoType!=="citation"){ot.current=null,Ct.current=new Set,W(null);return}const T=re.description??"",O=(re.label??"").trim(),r=O.replace(/\s+/g," ").trim(),u=T.replace(/\s+/g," ").trim(),w=r&&r!==u?O:t.cogita.library.infoTypes.citation;if(!T){W(null),_(null);return}const b=ma(T);ot.current=b,fe(w);let K=!0;return Vt().then(y=>{if(!K)return;const A=getQuoteMode(re.direction),M=new Map;y.forEach(oe=>{if(oe.itemType!=="info"||oe.checkType!=="quote-fragment"||!oe.direction)return;const Se=St(oe.direction);if(!Se||Se.mode!==A)return;const Ie=`${oe.itemId}:${Se.fragmentId}`;M.has(Ie)||M.set(Ie,[]),M.get(Ie).push(oe)});const P={},X=new Set;M.forEach((oe,Se)=>{const[Ie,Oe]=Se.split(":",2);if(Ie!==re.cardId)return;const Ge=_t(oe).score;P[Oe]=Ge,Ge>=Et&&X.add(Oe)}),Ct.current=X,at.current=P;const Z=St(re.direction);if(Z!=null&&Z.fragmentId&&b.nodes[Z.fragmentId]){Jt(b,Z.fragmentId,w);return}const he=ha(b,X,P,Et,dt,re.direction);Jt(b,(he==null?void 0:he.id)??null,w)}).catch(()=>{Ct.current=new Set,at.current={};const y=St(re.direction);if(y!=null&&y.fragmentId&&b.nodes[y.fragmentId]){Jt(b,y.fragmentId,w);return}const A=ha(b,Ct.current,{},Et,dt,re.direction);Jt(b,(A==null?void 0:A.id)??null,w)}),()=>{K=!1}},[re,t,dt,Et]),a.useEffect(()=>{if(!re||re.cardType!=="vocab"||re.checkType!=="translation-match"){H(null),Ce({});return}const r=(tt.pool??tt.active??g).filter(y=>y.cardType==="vocab"&&y.checkType==="translation-match").filter((y,A,M)=>M.findIndex(P=>P.cardId===y.cardId)===A);r.some(y=>y.cardId===re.cardId)||r.unshift(re);const w=Yt(r).slice(0,6).map(y=>{const A=y.label.split("↔").map(X=>X.trim()).filter(Boolean);if(A.length<2)return null;const M=`${y.cardId}:L`,P=`${y.cardId}:R`;return{cardId:y.cardId,leftId:M,rightId:P,leftLabel:A[0],rightLabel:A[1]}}).filter(Boolean),b=w.map(y=>y.leftId),K=Yt(w.map(y=>y.rightId));H({pairs:w,leftOrder:b,rightOrder:K,selection:{},activeLeft:null,activeRight:null,locked:{}})},[re,g,tt]),a.useEffect(()=>()=>{De.current&&window.clearTimeout(De.current),_e.current&&window.clearTimeout(_e.current)},[]);const la=a.useRef(null);a.useEffect(()=>{if(!re)return;const T=le(re),O=typeof document<"u"?document.activeElement:null;if(la.current===T&&O&&(O.tagName==="INPUT"||O.tagName==="TEXTAREA"))return;let r=0;const u=()=>{if(re){if(re.cardType==="info"&&re.infoType==="computed"){if(F.length>0){const b=Da(qe,F,Ne),K=b?pt.current[b]:null;if(K&&(K.focus(),document.activeElement===K)){la.current=T;return}}if(Ye.current&&(Ye.current.focus(),document.activeElement===Ye.current)){la.current=T;return}}else if(re.cardType==="vocab"&&Ye.current&&(Ye.current.focus(),document.activeElement===Ye.current)){la.current=T;return}r<6&&(r+=1,window.setTimeout(u,40))}},w=window.setTimeout(u,40);return()=>window.clearTimeout(w)},[re,F,qe,Ne]),a.useEffect(()=>{if(!bt)return;const T=O=>{O.key==="Enter"&&(O.preventDefault(),ca())};return window.addEventListener("keydown",T),()=>window.removeEventListener("keydown",T)},[bt]);const jt=T=>{xe(T),ie(_t(T))};a.useEffect(()=>{if(!re){ie(null),xe([]);return}const T=re.cardType==="info"?"info":"connection";if(re.cardType==="info"&&re.infoType==="citation"){Vt().then(O=>{const r=O.filter(u=>u.itemType==="info"&&u.itemId===re.cardId&&u.checkType==="quote-fragment"&&Ka(u.direction,re.direction));jt(r)}).catch(()=>{ie(null),xe([])});return}Pa(T,re.cardId,re.checkType,re.direction).then(O=>jt(O)).catch(()=>{ie(null),xe([])})},[re]);const Gt=(T,O,r,u)=>{if(T==="info"&&r==="quote-fragment"){Vt().then(w=>{const b=w.filter(K=>K.itemType==="info"&&K.itemId===O&&K.checkType==="quote-fragment"&&Ka(K.direction,u));jt(b)}).catch(()=>{ie(null),xe([])});return}Pa(T,O,r,u).then(w=>jt(w)).catch(()=>{ie(null),xe([])})},Xt=(T,O,r)=>{var K;const u=((K=r.pairs.find(y=>y.leftId===T))==null?void 0:K.rightId)??null;if(!u)return r;const w=u===O;Ce(y=>({...y,[T]:w?"correct":"incorrect"})),De.current&&window.clearTimeout(De.current),_e.current&&window.clearTimeout(_e.current),ne.current+=1;const b={kind:w?"correct":"incorrect",tick:ne.current};if(Be(null),De.current=window.setTimeout(()=>Be(b),0),_e.current=window.setTimeout(()=>Be(null),420),w){const y={...r.locked,[T]:!0};return Object.keys(y).length>=r.pairs.length?(pe("correct"),Je(!0)):pe("correct"),{...r,selection:{...r.selection,[T]:O},activeLeft:null,activeRight:null,locked:y}}return pe("incorrect"),{...r,activeLeft:null,activeRight:null}},Sa=T=>{H(O=>!O||O.locked[T]?O:O.activeRight?Xt(T,O.activeRight,O):{...O,activeLeft:O.activeLeft===T?null:T})},Ta=T=>{H(O=>O&&(O.activeLeft?Xt(O.activeLeft,T,O):{...O,activeRight:O.activeRight===T?null:T}))},ca=()=>{var T;if(re&&re.cardType==="info"&&re.infoType==="citation"&&ot.current&&ge&&!((T=St(re.direction))!=null&&T.fragmentId)){const O=ha(ot.current,Ct.current,at.current,Et,dt,re.direction,ge.fragmentId);if(O){pe(null),ae(""),L(!1),Te({}),Je(!1),ve(null),Qe(0),Jt(ot.current,O.id,ge.title);return}}pe(null),ae(""),L(!1),Te({}),Je(!1),ve(null),Qe(0),ee(O=>Math.min(O+1,g.length))},zt=T=>{if(!re)return;const O=T.expected??null,r=T.answer??"";let u=O??"",w=r;if(!O&&T.expectedMap&&T.answerMap){const X=Object.keys(T.expectedMap).sort((Z,he)=>Z.localeCompare(he));u=X.map(Z=>{var he;return((he=T.expectedMap)==null?void 0:he[Z])??""}).join("|"),w=X.map(Z=>{var he;return((he=T.answerMap)==null?void 0:he[Z])??""}).join("|")}const b=u?ga(u,w,Wt):new Uint8Array,K={revisionType:J.id,evalType:T.evalType,direction:T.direction,prompt:C??"",expected:O,answer:r,expectedAnswers:T.expectedMap??null,answers:T.answerMap??null,correct:T.correct,maskBase64:b.length?Qt(b):null,checkMode:o,compareMode:Wt,minCorrectness:ft},y=new TextEncoder().encode(JSON.stringify(K)),A=re.cardType==="info"?"info":"connection",M=T.overrideCheckType??re.checkType??null,P=T.overrideDirection??re.direction??null;Fa({itemType:A,itemId:re.cardId,checkType:M,direction:P,revisionType:J.id,evalType:T.evalType,correct:T.correct,maskBase64:b.length?Qt(b):null,payloadBase64:Qt(y)}).then(()=>{Gt(A,re.cardId,M,P),fa(g)}).catch(()=>{})},da=(T,O)=>{const r=At.current.get(O);if(r)return Promise.resolve(r);const u=qt.current.get(O);if(u)return u;const w=Wn({shareCode:d,infoId:T,key:B}).then(b=>{var X,Z;const K=b.payload,y=((X=K.definition)==null?void 0:X.graph)??null,A="",M=((Z=K.definition)==null?void 0:Z.answerTemplate)??"",P=Zs(y,A,M);if(P){const oe={sample:en(P),answerTemplate:M||null};return At.current.set(O,oe),oe}return vs({shareId:d,infoId:T,key:B}).then(he=>{const oe={sample:he,answerTemplate:null};return At.current.set(O,oe),oe})}).catch(()=>vs({shareId:d,infoId:T,key:B}).then(b=>{const K={sample:b,answerTemplate:null};return At.current.set(O,K),K}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{qt.current.delete(O)});return qt.current.set(O,w),w},Lt=(T,O)=>{var y;const r=`${le(T)}:${O}`,u=Kt.current.get(r);if(u)return Promise.resolve(u);const w=Ft.current.get(r);if(w)return w;const b=A=>(Kt.current.set(r,A),A);let K;if(T.cardType==="vocab"){if(T.checkType==="translation-match")return K=Promise.resolve(b({prompt:T.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),K;const A=T.label.split("↔").map(M=>M.trim()).filter(Boolean);if(A.length>=2){const P=(T.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",X=P?A[0]:A[1],Z=P?A[1]:A[0];K=Promise.resolve(b({prompt:X,expectedAnswer:Z,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else K=Promise.resolve(b({prompt:T.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(T.cardType==="info"&&T.infoType==="word"){const A=(y=T.description)!=null&&y.startsWith("Language: ")?T.description.replace("Language: ",""):null;K=Promise.resolve(b({prompt:T.label,expectedAnswer:A,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else T.cardType==="info"&&T.infoType==="computed"?K=da(T.cardId,r).then(A=>{var he,oe;if(!A.sample)return b({prompt:T.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const M=A.sample,P=M.expectedAnswers?Object.entries(M.expectedAnswers).map(([Se,Ie])=>({key:Se,expected:Ie})):[],X=P.reduce((Se,Ie)=>(Se[Ie.key]="",Se),{}),Z=M.expectedAnswerIsSentence&&((he=M.expectedAnswer)==null?void 0:he.trim())||null;return b({prompt:M.prompt,expectedAnswer:P.length>0?Z:((oe=M.expectedAnswer)==null?void 0:oe.trim())||null,computedExpected:P,computedAnswers:X,answerTemplate:A.answerTemplate,outputVariables:M.outputVariables??null,variableValues:M.variableValues??null})}).catch(()=>b({prompt:T.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Ft.current.delete(r)}):K=Promise.resolve(b({prompt:T.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return Ft.current.set(r,K),K},Jt=(T,O,r)=>{const u=Object.keys(T.nodes).length,w=Ct.current.size;if(!O){W({title:r,before:T.text,after:"",fragmentId:null,total:u,completed:w}),_(null),Je(!0);return}const b=T.nodes[O];if(!b)return;const K=Ys(T.text,b);W({title:r,before:K.before,after:K.after,fragmentId:b.id,total:u,completed:w}),_(K.fragment),Je(!1)},ba=()=>{const T=ot.current;T&&W(O=>O&&{...O,total:Object.keys(T.nodes).length,completed:Ct.current.size})},Bt=()=>{const T=g[R+1];T&&Lt(T,R+1)},Ca=()=>{if(Bt(),re&&re.cardType==="vocab"&&re.checkType==="translation-match"&&D){if(D.pairs.length===0){pe("incorrect"),Je(!0);return}const b=D.pairs.reduce((Z,he)=>(Z[he.rightId]=he.rightLabel,Z),{});let K=0;const y={};D.pairs.forEach(Z=>{const oe=D.selection[Z.leftId]===Z.rightId;y[Z.leftId]=oe?"correct":"incorrect",oe&&(K+=1)});const A=D.pairs.length||1,M=K/A,P=K===D.pairs.length;Ce(Z=>({...Z,...y})),P?(pe("correct"),Je(!0),Qe(0)):(pe("incorrect"),Je(!1),Qe(Z=>{const he=Z+1;return he>=Nt&&(L(!0),Je(!0),H(oe=>{if(!oe)return oe;const Se=oe.pairs.reduce((Ie,Oe)=>(Ie[Oe.leftId]=Oe.rightId,Ie),{});return{...oe,selection:Se}})),he})),wt(P,M);const X="connection";Promise.all(D.pairs.map(Z=>{const he=D.selection[Z.leftId]??null,oe=he?b[he]:"",Se={left:Z.leftLabel,expected:Z.rightLabel,answer:oe,checkType:"translation-match"},Ie=new TextEncoder().encode(JSON.stringify(Se));return Fa({itemType:X,itemId:Z.cardId,checkType:"translation-match",direction:null,revisionType:J.id,evalType:"translation-match",correct:he===Z.rightId,maskBase64:null,payloadBase64:Qt(Ie)})})).then(()=>{Gt(X,re.cardId,re.checkType,re.direction),fa(g)}).catch(()=>{});return}if(F.length>0){const b=F.reduce((y,A)=>{const M=we[A.key]??"";return y[A.key]=kt(M)===kt(A.expected)?"correct":"incorrect",y},{});F.every(({key:y,expected:A})=>{const M=we[y]??"";return o==="exact"&&kt(M)===kt(A)})?(pe("correct"),Te(b),Je(!0),Qe(0),wt(!0,1),zt({correct:!0,direction:C?`${C} -> computed`:"computed",expectedMap:F.reduce((y,A)=>(y[A.key]=A.expected,y),{}),answerMap:we,evalType:"computed"})):(pe("incorrect"),Te(b),Je(!1),Qe(y=>{const A=y+1;return A>=Nt&&Zt&&(L(!0),Je(!0)),A}),wt(!1,0),window.setTimeout(()=>{var A;const y=Da(qe,F,Ne);y&&pt.current[y]&&((A=pt.current[y])==null||A.focus())},40),zt({correct:!1,direction:C?`${C} -> computed`:"computed",expectedMap:F.reduce((y,A)=>(y[A.key]=A.expected,y),{}),answerMap:we,evalType:"computed"}));return}if(re&&re.cardType==="info"&&re.infoType==="citation"&&(ge!=null&&ge.fragmentId)){if(!x)return;const b=St(re.direction),K=(b==null?void 0:b.mode)??getQuoteMode(re.direction),y=b!=null&&b.fragmentId&&re.direction?re.direction:ka(K,ge.fragmentId),A=rn(x,te,Wt),M=o==="exact"&&pa(te)===pa(x),P=ia(A),X=M||P,Z=Ht(A);X?(at.current[ge.fragmentId]=Math.max(at.current[ge.fragmentId]??0,Z),(at.current[ge.fragmentId]??0)>=Et&&Ct.current.add(ge.fragmentId),ba(),pe("correct"),Te({}),Je(!0),ve(A),Qe(0),Z<100&&Nt<=1&&L(!0),wt(!0,Z/100),zt({correct:!0,direction:`quote:${ge.fragmentId}`,expected:x,answer:te,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:y})):(pe("incorrect"),Te({}),Je(!1),ve(A),Qe(he=>{const oe=he+1;return oe>=Nt&&Zt&&(L(!0),Je(!0)),oe}),wt(!1,Z/100),window.setTimeout(()=>{var he;return(he=Ye.current)==null?void 0:he.focus()},40),zt({correct:!1,direction:`quote:${ge.fragmentId}`,expected:x,answer:te,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:y}));return}if(!x)return;const T=ga(x,te,Wt),O=o==="exact"&&kt(te)===kt(x),r=ia(T),u=O||r,w=Ht(T);u?(pe("correct"),Te({}),Je(!0),ve(T),Qe(0),w<100&&Nt<=1&&L(!0),wt(!0,w/100),zt({correct:!0,direction:C?`${C} -> ${x}`:null,expected:x,answer:te,evalType:"text"})):(pe("incorrect"),Te({}),Je(!1),ve(T),Qe(b=>{const K=b+1;return K>=Nt&&Zt&&(L(!0),Je(!0)),K}),wt(!1,w/100),window.setTimeout(()=>{var b;return(b=Ye.current)==null?void 0:b.focus()},40),zt({correct:!1,direction:C?`${C} -> ${x}`:null,expected:x,answer:te,evalType:"text"}))},ua=T=>{if(Bt(),!x)return;const O=ga(x,T,Wt),r=kt(T)===kt(x),u=ia(O),w=r||u,b=Ht(O);w?(pe("correct"),Te({}),Je(!0),ve(O),Qe(0),b<100&&Nt<=1&&L(!0),wt(!0,b/100),zt({correct:!0,direction:"word->language",expected:x,answer:T,evalType:"language-select"})):(pe("incorrect"),Te({}),Je(!1),ve(O),Qe(K=>{const y=K+1;return y>=Nt&&Zt&&(L(!0),Je(!0)),y}),wt(!1,b/100),zt({correct:!1,direction:"word->language",expected:x,answer:T,evalType:"language-select"}))},Ma=T=>{var r;if(T.key!=="Enter")return;if(T.preventDefault(),T.stopPropagation(),bt){ca();return}const O=F.find(u=>!(we[u.key]??"").trim());if(O){(r=pt.current[O.key])==null||r.focus();return}Ca()},Ya=()=>{Bt(),pe("correct"),Je(!0),Qe(0),wt(!0,1),x&&zt({correct:!0,direction:"manual",expected:x,answer:te,evalType:"manual"})},Ga=()=>{if(wt(!1,0),re&&re.cardType==="info"&&re.infoType==="citation"){pe(null),ae(""),L(!1),Te({}),Je(!1),ve(null),Qe(0),ee(T=>Math.min(T+1,g.length));return}ca()};a.useEffect(()=>{Bt()},[R,g]);const Xa=t.cogita.library.revision.revealModeAfterIncorrect,Zt=F.length>0||!!x;return e.jsxs(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:m,secureMode:p,onNavigate:v,language:E,onLanguageChange:N,children:[(h==="loading"||U==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:h==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${G.total?Math.min(100,Math.max(0,G.current/G.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:G.total?`${Math.min(G.current,G.total)} / ${G.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:se}),e.jsx("p",{className:"cogita-library-subtitle",children:q}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",st).replace("{check}",rt)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:V?`${V.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[It?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",It.currentLevel??"-"," / ",It.levelsCount]}):null,V?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(V.correct)).replace("{total}",String(V.total))}),V.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(V.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(an,{outcomes:ke})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[Le?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:Le})}):null,e.jsx("section",{className:"cogita-revision-card","data-feedback":Ae?`${Ae.kind}-${Ae.tick}`:xt?"idle":Ke??"idle",children:h!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:h==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):re?e.jsx(e.Fragment,{children:ct?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(tn,{copy:t,currentCard:re,currentTypeLabel:na,prompt:C,languages:z,answer:te,onAnswerChange:T=>ae(O=>Ba(O,T,Q)),computedExpected:F,computedAnswers:we,onComputedAnswerChange:(T,O)=>je(r=>({...r,[T]:Ba(r[T]??"",O,Q)})),answerTemplate:qe,outputVariables:Ne,variableValues:et,computedFieldFeedback:Fe,feedback:Ke,canAdvance:bt,quoteContext:ge,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Ca,onSkip:Ga,onLanguageSelect:ua,onMarkReviewed:Ya,onAdvance:ca,showCorrectAnswer:$e,setShowCorrectAnswer:L,onRevealCorrect:()=>Je(!0),answerMask:Re,expectedAnswer:x,hasExpectedAnswer:Zt,handleComputedKeyDown:Ma,answerInputRef:Ye,computedInputRefs:pt,scriptMode:Q,setScriptMode:ce,matchPairs:D==null?void 0:D.pairs,matchLeftOrder:D==null?void 0:D.leftOrder,matchRightOrder:D==null?void 0:D.rightOrder,matchSelection:D==null?void 0:D.selection,matchActiveLeft:D==null?void 0:D.activeLeft,matchActiveRight:D==null?void 0:D.activeRight,matchFeedback:Ue,onMatchLeftSelect:Sa,onMatchRightSelect:Ta})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:mt?`${vt} / ${mt}`:t.cogita.library.revision.progressUnlimited}),h==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),h==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),h==="ready"&&U==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),h==="ready"&&U==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),h==="ready"&&U==="ready"&&g.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Xa}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",Nt]})]})]}),It?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",It.activeCount," / ",It.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:It.counts.map((T,O)=>{const r=O+1,u=It.currentLevel===r,w=It.percentages[O]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":u,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:r}),e.jsx("strong",{children:T})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,w))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[w.toFixed(1),"%"]})]},`level-${r}`)})})]}):null,oa?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:oa.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:oa.dots.map(T=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-T.value))}, ${Math.round(200*T.value)}, 80, 0.9)`}},T.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:oa.knownCount})]})]}):null,dt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Pt})]})}):null]})]})]})})})]})]})}const nr=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:Ji},Symbol.toStringTag,{value:"Module"}));export{ar as C,sr as a,nr as b};
