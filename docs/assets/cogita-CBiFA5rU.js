import{r as n,j as e,u as sn,a as Ua,b as pi,c as fi,d as bi,R as fs,B as bs,C as ys,Q as yi}from"./vendor-CAC2WLor.js";import{L as vi,A as xi,g as za,a as zi,b as wi,c as vs,s as Rs,d as xs,e as ji,f as Oi,h as On,i as la,j as Ui,k as Ji,l as xn,m as wn,n as ki,o as ws,p as ls,q as Qi,u as $s,r as js,t as Hi,v as Wi,w as Gi,x as Yi,y as Xi,z as Ni,B as Zi,C as er,D as tr,E as ks,F as tn,G as ar,H as Si,I as Rn,J as nr,K as sr,M as ir,N as rr,O as or,P as lr,Q as cs,R as Ca,S as Ns,T as Ti,U as ds,V as cr,W as Ci,X as dr,Y as ur,Z as hr,_ as mr,$ as gr,a0 as pr,a1 as fr,a2 as br,a3 as Ps,a4 as yr,a5 as Es,a6 as Ks,a7 as vr,a8 as xr,a9 as wr,aa as jr,ab as kr,ac as us,ad as Nr,ae as Sr,af as Tr,ag as Cr}from"./recreatio-core-Bk2wOwh7.js";import"./vendor-cogita-ui-DTaQ_FiW.js";const Xa={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},Wa={moveMs:900,pauseMs:220,errorMs:900},Ir=(t=11)=>{let a=t;const s=()=>(a=(a*1664525+1013904223)%4294967296,a/4294967296),{width:i,height:l,paddingX:h,paddingY:o,levels:f}=Xa,g=(l-o*2)/(f.length-1),j=[],u=[],v=[];f.forEach((w,y)=>{const Q=l-o-y*g,R=i-h*2,b=[];for(let P=0;P<w;P+=1){const _=h+(P+1)*R/(w+1),re=(s()-.5)*18,C=Math.max(h,Math.min(i-h,_+re)),z=y===0?3:y<2?2.1:1.4,A=y===0?"root":`l${y}-${P}`;b.push({id:A,x:y===0?i/2:C,y:Q,r:z,level:y,role:y===0?"root":void 0})}v.push(b),j.push(...b)});const r=v[v.length-1];if(r!=null&&r.length){const w=r[Math.floor(r.length/2)];w.role="goal",w.r=2}for(let w=1;w<v.length;w+=1){const y=v[w-1];v[w].forEach(R=>{const b=[...y].sort((C,z)=>Math.abs(C.x-R.x)-Math.abs(z.x-R.x)),P=b[0],_=b[1]&&s()<.45?b[1]:null;(_?[P,_]:[P]).forEach(C=>{u.push({from:C.id,to:R.id,key:`${C.id}-${R.id}`})}),s()<.2&&b[2]&&u.push({from:b[2].id,to:R.id,key:`${b[2].id}-${R.id}`})})}const c=new Map;u.forEach(w=>{const y=c.get(w.to)??[];y.push(w.from),c.set(w.to,y)});const E=new Map,m=new Map,k=new Map;u.forEach(w=>{const y=E.get(w.from)??[];y.push(w.key),E.set(w.from,y);const Q=m.get(w.from)??[];Q.push(w.to),m.set(w.from,Q);const R=k.get(w.from)??[];R.push(w.to),k.set(w.from,R);const b=k.get(w.to)??[];b.push(w.from),k.set(w.to,b)});const S=new Map;return j.forEach(w=>{S.set(w.id,w)}),{nodes:j,links:u,parentsById:c,linksByFrom:E,childrenByFrom:m,neighborsById:k,nodesById:S}};function Mr({slides:t,activeIndex:a,introOpen:s,prefersReducedMotion:i,onNext:l,onPrev:h,onSelect:o,onExit:f,onOpen:g,onRegister:j}){const u=a===t.length-1,v=s&&a===0?"entry":"docked",r=t[t.length-1],[c,E]=n.useState(!1),m=n.useMemo(()=>Array.from({length:20},(we,Me)=>({src:`/cogita/logo/Cogita${String(Me).padStart(2,"0")}.png`,kind:Me<=11?"bubble":Me<=17?"text":"recreatio"})),[]),k=s&&a===0;n.useEffect(()=>{if(!s){E(!1);return}a>0&&!c&&E(!0)},[a,s,c]);const S=n.useRef(0),w=n.useRef(null),y=n.useMemo(()=>{const we={x:40,y:160},Me={x:260,y:48},$=6,K=Me.x-we.x,q=we.y-Me.y,J=K/$,G=[.3,.45,.6,.65,1.4,2.2],ce=G.reduce((B,te)=>B+te,0),I=G.map(B=>q*B/ce),N=[we];let Z=we.x,F=we.y;for(let B=1;B<=$;B+=1){const te=(Math.random()-.5)*14,ye=(Math.random()-.5)*28;Z=Math.max(we.x+B*14,Math.min(Me.x-($-B)*14,Z+J+te));const le=I[B-1]??I[I.length-1];F=F-le+ye;const pe=Math.max(Me.y,Math.min(we.y-4,F));N.push({x:Math.round(Z),y:Math.round(pe)})}return N[N.length-1]=Me,N},[]),Q=n.useMemo(()=>{const q=(ce,I,N)=>Math.min(N,Math.max(I,ce)),J=y.map(ce=>{const I=10+Math.random()*36;return{x:q(ce.x,40,260),y:q(ce.y-I,40,140)}}),G=y.map((ce,I)=>{var F;const N=12+Math.random()*40,Z=((F=J[I])==null?void 0:F.y)??ce.y;return{x:q(ce.x,40,260),y:q(Math.max(Z+10,ce.y+N),60,170)}});return{upper:J,lower:G}},[y]),R=n.useMemo(()=>{var Me;const we=((Me=y[4])==null?void 0:Me.x)??260;return Math.max(0,Math.min(240,we-40))},[y]),b=n.useMemo(()=>{var I,N;const we=(Z,F,B)=>Math.min(B,Math.max(F,Z)),Me=(Z,F,B)=>y.map((te,ye)=>{var lt,vt;const le=((lt=Q.upper[ye])==null?void 0:lt.y)??te.y,pe=((vt=Q.lower[ye])==null?void 0:vt.y)??te.y,Re=(Math.random()-.5)*70,nt=te.y+Z+Re,rt=we(te.y+F,le+6,pe-6),He=we(te.y+B,le+6,pe-6);return{x:te.x,y:we(nt,Math.min(rt,He),Math.max(rt,He))}}),$=-14+Math.random()*28,K=14+Math.random()*28,q=Me($,-80,12),J=Me(K,-12,80);for(let Z=4;Z<y.length;Z+=1){const F=y[Z],B=((I=Q.upper[Z])==null?void 0:I.y)??F.y,te=((N=Q.lower[Z])==null?void 0:N.y)??F.y;q[Z]={x:F.x,y:we(F.y-12,B+6,te-6)},J[Z]={x:F.x,y:we(F.y+12,B+6,te-6)}}const G=Q.upper.length?Q.upper[Q.upper.length-1].y:40,ce=Q.lower.length?Q.lower[Q.lower.length-1].y:170;return q[q.length-1]={x:y[y.length-1].x,y:we(y[y.length-1].y-14,G,ce)},J[J.length-1]={x:y[y.length-1].x,y:we(y[y.length-1].y+12,G,ce)},{higher:q,lower:J}},[y,Q]),P=1e4,_=n.useMemo(()=>{let we=17;const Me=()=>(we=(we*1664525+1013904223)%4294967296,we/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((K,q)=>{const J=(Me()-.5)*240,G=(Me()-.5)*180,ce=(Me()-.5)*24;return{id:`card-${q+1}`,throw:{x:`${J.toFixed(0)}px`,y:`${G.toFixed(0)}px`,rot:`${ce.toFixed(1)}deg`},grid:{x:`${K.x}px`,y:`${K.y}px`},delay:`${q*.12}s`}})},[]),re=n.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[C,z]=n.useState([]),A=n.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),ne=n.useMemo(()=>{const Me=[],K=(J,G)=>J+Math.random()*(G-J);for(let J=0;J<6;J+=1){let G=!1;for(let ce=0;ce<80;ce+=1){const I=K(14,86),N=K(10,34);if(Me.every(F=>{const B=F.x-I,te=F.y-N;return Math.hypot(B,te)>=12})){Me.push({x:I,y:N}),G=!0;break}}G||Me.push({x:K(16,84),y:K(12,32)})}return Me.map((J,G)=>({id:`p${G+1}`,x:`${J.x.toFixed(1)}%`,y:`${J.y.toFixed(1)}%`,xNum:J.x,yNum:J.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[ke,Le]=n.useState(0),[$e,de]=n.useState(0),[ge,M]=n.useState([]),ae=1e4,Ve=n.useMemo(()=>{if(ne.length<2)return[];const we=G=>{let ce=G+1831565813;return ce=Math.imul(ce^ce>>>15,ce|1),ce^=ce+Math.imul(ce^ce>>>7,ce|61),((ce^ce>>>14)>>>0)/4294967296},Me=(G,ce)=>Math.floor(we(G)*ce),$=new Set,K=[],q=Math.min(3,ne.length);let J=0;for(;K.length<q&&J<30;){J+=1;const G=Me(ke*13+J*5,ne.length),ce=Me(ke*29+J*7,ne.length);if(G===ce)continue;const I=G<ce?`${G}-${ce}`:`${ce}-${G}`;$.has(I)||($.add(I),K.push({id:`link-${I}`,from:ne[G],to:ne[ce],delay:`${(J*.35).toFixed(2)}s`}))}return K},[ke,ne]);n.useEffect(()=>{if(!s||a!==2)return;const we=()=>{const $=_.map(K=>K.id);for(let K=$.length-1;K>0;K-=1){const q=Math.floor(Math.random()*(K+1));[$[K],$[q]]=[$[q],$[K]]}return $.slice(0,4)};z(we());const Me=window.setInterval(()=>{z(we())},P);return()=>window.clearInterval(Me)},[a,s,_,P]),n.useEffect(()=>{if(!s||a!==3)return;const we=()=>{de(Math.floor(Math.random()*A.length)),M(ne.map(()=>Math.random()<.6?"good":"bad")),Le($=>$+1)};we();const Me=window.setInterval(we,ae);return()=>window.clearInterval(Me)},[a,s,A.length,ne,ae]);const Se=n.useMemo(()=>Ir(11),[]),[oe,H]=n.useState(new Set(["root"])),[Oe,W]=n.useState(new Set),[ze,Te]=n.useState(new Set),[Ee,st]=n.useState({fromId:"root",toId:"root",key:0}),D=n.useRef(oe),he=n.useRef("root"),Ye=n.useRef(0),U=n.useRef(null),qe=n.useRef(null),at=n.useRef([]);n.useEffect(()=>{D.current=oe},[oe]);const wt=n.useMemo(()=>{const we=new Set;return oe.forEach(Me=>{const $=Se.linksByFrom.get(Me);$&&$.forEach(K=>we.add(K))}),we},[oe,Se]),yt=Se.nodesById.get(Ee.toId)??Se.nodesById.get("root"),Fe=yt?`${yt.x/Xa.width*100}%`:"50%",ve=yt?`${yt.y/Xa.height*100}%`:"90%";n.useEffect(()=>{if(!s||a!==1||i)return;(()=>{H(new Set(["root"])),W(new Set),Te(new Set),st({fromId:"root",toId:"root",key:0}),qe.current=null,Ye.current=0,he.current="root",at.current=[]})();const Me=()=>{const K=he.current,q=D.current,G=(Se.childrenByFrom.get(K)??[]).filter(te=>!q.has(te));if(G.length)return G[Math.floor(Math.random()*G.length)];if(q.size>=Se.nodes.length){const te=Se.neighborsById.get(K)??[];return te.length?te[Math.floor(Math.random()*te.length)]:null}const ce=te=>(Se.childrenByFrom.get(te)??[]).some(le=>!q.has(le)),I=[K],N=new Set([K]),Z=new Map;let F=null;for(;I.length;){const te=I.shift();if(!te)break;if(te!==K&&ce(te)){F=te;break}(Se.neighborsById.get(te)??[]).forEach(le=>{N.has(le)||(N.add(le),Z.set(le,te),I.push(le))})}if(!F)return null;let B=F;for(;Z.get(B)&&Z.get(B)!==K;)B=Z.get(B)??B;return B},$=(K,q)=>{if(K===q){const J=Me();J&&$(K,J);return}Ye.current+=1,st({fromId:K,toId:q,key:Ye.current}),he.current=q,U.current=window.setTimeout(()=>{const J=Se.parentsById.get(q)??[],G=D.current,ce=J.filter(F=>!G.has(F));if(!ce.length){const F=new Set(G);F.add(q),H(F),U.current=window.setTimeout(()=>{for(;at.current.length;){const te=at.current[at.current.length-1];if(!F.has(te)){if(te!==q){$(q,te);return}break}at.current.pop()}const B=Me();B&&$(q,B)},Wa.pauseMs);return}const I=new Set([q,...ce]),N=new Set(ce.map(F=>`${F}-${q}`));W(I),Te(N),at.current.includes(q)||at.current.push(q);const Z=ce[Math.floor(Math.random()*ce.length)];qe.current={fromId:q,toId:Z},U.current=window.setTimeout(()=>{W(new Set),Te(new Set);const F=qe.current;F&&$(F.fromId,F.toId)},Wa.errorMs)},Wa.moveMs)};return U.current=window.setTimeout(()=>{const K=Me();K&&$(he.current,K)},Wa.pauseMs),()=>{U.current&&window.clearTimeout(U.current)}},[a,s,Se,i]);const Je=we=>{if(!s)return;const Me=Date.now();Me-S.current<520||Math.abs(we.deltaY)<10||(S.current=Me,we.deltaY>0?l():h(),we.preventDefault())},Ue=we=>{if(!s)return;const Me=we.touches[0];Me&&(w.current={x:Me.clientX,y:Me.clientY})},je=we=>{if(!s)return;const Me=w.current;if(w.current=null,!Me)return;const $=we.changedTouches[0];if(!$)return;const K=$.clientX-Me.x,q=$.clientY-Me.y;Math.abs(q)<40||Math.abs(q)<Math.abs(K)||(q<0?l():h())};return e.jsxs("div",{className:`cogita-intro ${s?"is-open":"is-closed"} ${i?"is-reduced":""} ${u?"is-final":""}`,"data-slide":a+1,onWheel:Je,onTouchStart:Ue,onTouchEnd:je,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":v,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${k&&!c?"is-entry":""}`,children:m.map((we,Me)=>e.jsx("img",{src:we.src,alt:"",className:`cogita-logo-layer ${Me===0?"is-base":""} ${we.kind==="text"?"is-text":we.kind==="recreatio"?"is-recreatio":""} ${we.kind==="bubble"?"is-bubble":""}`},we.src))})}),s&&t.map((we,Me)=>{const $=Me===a;return e.jsxs("section",{className:`cogita-intro-slide slide-${Me+1} ${$?"is-active":""}`,"aria-hidden":!$,children:[e.jsxs("div",{className:"cogita-intro-text",children:[we.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:we.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:we.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:we.title}),we.body&&e.jsx("p",{children:we.body.split(`
`).map((K,q)=>e.jsxs("span",{children:[K,q===0&&e.jsx("br",{})]},String(q)))})]}),we.micro&&e.jsx("p",{className:"cogita-intro-micro",children:we.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:u?j:l,children:we.cta}),u&&we.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>o(0),children:we.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[Me===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${Xa.width} ${Xa.height}`,preserveAspectRatio:"none",children:[Se.links.map(K=>{const q=Se.nodesById.get(K.from),J=Se.nodesById.get(K.to);if(!q||!J)return null;const G=wt.has(K.key),ce=ze.has(K.key);return e.jsx("line",{className:`map-link ${G?"is-active":""} ${ce?"is-error":""}`,x1:q.x,y1:q.y,x2:J.x,y2:J.y},K.key)}),Se.nodes.map(K=>{const q=oe.has(K.id),J=Oe.has(K.id);return e.jsx("circle",{className:`map-node ${K.role?`is-${K.role}`:""} ${q?"is-active":""} ${J?"is-error":""}`,cx:K.x,cy:K.y,r:K.r},K.id)})]}),yt&&e.jsx("span",{className:"map-explorer-dot",style:{left:Fe,top:ve,"--move":`${Wa.moveMs}ms`}})]}),Me===2&&e.jsx("div",{className:"cogita-index-cards",children:_.map(K=>{const q=C.indexOf(K.id),J=q>=0?re[q]:null,G=(J==null?void 0:J.x)??"140px",ce=(J==null?void 0:J.y)??"140px",I=q>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":K.throw.x,"--throw-y":K.throw.y,"--throw-rot":K.throw.rot,"--grid-x":K.grid.x,"--grid-y":K.grid.y,"--stack-x":G,"--stack-y":ce,"--stack-opacity":I,"--delay":K.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},K.id)})}),Me===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[A.map((K,q)=>e.jsxs("div",{className:`round-card ${q===$e?"is-active":""}`,style:{"--card-x":K.x,"--card-y":K.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},K.id)),A[$e]&&e.jsx("span",{className:"round-ring",style:{"--card-x":A[$e].x,"--card-y":`calc(${A[$e].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:ne.map(K=>e.jsx("span",{className:"player-dot",style:{left:K.x,top:K.y,"--jitter-x":K.jitterX,"--jitter-y":K.jitterY,"--breath-delay":K.delay}},K.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:Ve.map(K=>e.jsx("line",{className:"round-link",x1:K.from.xNum,y1:K.from.yNum,x2:K.to.xNum,y2:K.to.yNum,style:{"--delay":K.delay}},K.id))}),e.jsx("div",{className:"round-flows",children:ne.map((K,q)=>{const J=ge[q]??"good",G=A[$e];if(!G)return null;const ce=`calc(${G.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":K.x,"--from-y":K.y,"--to-x":G.x,"--to-y":ce,"--delay":`${q*.12}s`}}),e.jsx("span",{className:`return-dot is-${J}`,style:{"--from-x":G.x,"--from-y":ce,"--to-x":K.x,"--to-y":K.y,"--delay":`${q*.12}s`}}),e.jsx("span",{className:`result-pop is-${J}`,style:{"--at-x":K.x,"--at-y":K.y,"--delay":`${q*.12}s`}})]},`${K.id}-${ke}`)})})]},`round-${ke}`),Me===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${y[0].x} ${y[0].y} L${y[1].x} ${y[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${y[1].x} ${y[1].y} L${y[2].x} ${y[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${y[2].x} ${y[2].y} L${y[3].x} ${y[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${y[3].x} ${y[3].y} L${y[4].x} ${y[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${y[4].x} ${y[4].y} L${y[5].x} ${y[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${y[5].x} ${y[5].y} L${y[6].x} ${y[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${R};${R};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${Q.upper.map((K,q)=>`${q===0?"M":"L"}${K.x} ${K.y}`).join(" ")} ${Q.lower.slice().reverse().map(K=>`L${K.x} ${K.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${Q.upper.map((K,q)=>`${q===0?"M":"L"}${K.x} ${K.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${Q.lower.map((K,q)=>`${q===0?"M":"L"}${K.x} ${K.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[b.higher.slice(0,6).map((K,q)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${q+1}`,d:`M${K.x} ${K.y} L${b.higher[q+1].x} ${b.higher[q+1].y}`,pathLength:"100"},`peer-1-${q}`)),b.lower.slice(0,6).map((K,q)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${q+1}`,d:`M${K.x} ${K.y} L${b.lower[q+1].x} ${b.lower[q+1].y}`,pathLength:"100"},`peer-2-${q}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${y[0].x/300*100}%`,"--p0y":`${y[0].y/200*100}%`,"--p1x":`${y[1].x/300*100}%`,"--p1y":`${y[1].y/200*100}%`,"--p2x":`${y[2].x/300*100}%`,"--p2y":`${y[2].y/200*100}%`,"--p3x":`${y[3].x/300*100}%`,"--p3y":`${y[3].y/200*100}%`,"--p4x":`${y[4].x/300*100}%`,"--p4y":`${y[4].y/200*100}%`,"--p5x":`${y[5].x/300*100}%`,"--p5y":`${y[5].y/200*100}%`,"--p6x":`${y[6].x/300*100}%`,"--p6y":`${y[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${b.higher[0].x/300*100}%`,"--q0y":`${b.higher[0].y/200*100}%`,"--q1x":`${b.higher[1].x/300*100}%`,"--q1y":`${b.higher[1].y/200*100}%`,"--q2x":`${b.higher[2].x/300*100}%`,"--q2y":`${b.higher[2].y/200*100}%`,"--q3x":`${b.higher[3].x/300*100}%`,"--q3y":`${b.higher[3].y/200*100}%`,"--q4x":`${b.higher[4].x/300*100}%`,"--q4y":`${b.higher[4].y/200*100}%`,"--q5x":`${b.higher[5].x/300*100}%`,"--q5y":`${b.higher[5].y/200*100}%`,"--q6x":`${b.higher[6].x/300*100}%`,"--q6y":`${b.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${b.lower[0].x/300*100}%`,"--q0y":`${b.lower[0].y/200*100}%`,"--q1x":`${b.lower[1].x/300*100}%`,"--q1y":`${b.lower[1].y/200*100}%`,"--q2x":`${b.lower[2].x/300*100}%`,"--q2y":`${b.lower[2].y/200*100}%`,"--q3x":`${b.lower[3].x/300*100}%`,"--q3y":`${b.lower[3].y/200*100}%`,"--q4x":`${b.lower[4].x/300*100}%`,"--q4y":`${b.lower[4].y/200*100}%`,"--q5x":`${b.lower[5].x/300*100}%`,"--q5y":`${b.lower[5].y/200*100}%`,"--q6x":`${b.lower[6].x/300*100}%`,"--q6y":`${b.lower[6].y/200*100}%`}})]})})}),Me===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),Me===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},we.id)}),!s&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:r.title}),r.body&&e.jsx("p",{children:r.body}),r.micro&&e.jsx("p",{className:"cogita-intro-micro",children:r.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:j,children:r.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:g,children:"Otwórz pokaz"})]})]})})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((we,Me)=>e.jsx("button",{type:"button",className:`dot ${a===Me?"active":""}`,"aria-label":we.title,onClick:()=>o(Me)},we.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:f,children:"Pomiń"})]})]})}const Lr=6,Ar=4;function Rr({copy:t,onAuthAction:a,authLabel:s,showProfileMenu:i,onProfileNavigate:l,onToggleSecureMode:h,onLogout:o,secureMode:f,onNavigate:g,language:j,onLanguageChange:u}){const v=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}g("home")},r=n.useRef(null),c=n.useRef([]),E=n.useMemo(()=>{let M=Date.now()%2147483647;const ae=()=>(M=M*48271%2147483647,M/2147483647);return Array.from({length:Lr},(Ve,Se)=>{const oe=6+ae()*8,H=7+ae()*10,Oe=6+ae()*9,W=-ae()*oe,ze=-ae()*H,Te=-ae()*Oe,Ee=.18+ae()*.28,st=12+ae()*18,D=4+ae()*8,he=(ae()-.5)*3.2,Ye=(ae()-.5)*3.8,U=ae()>.5?"alternate":"alternate-reverse",qe=ae()>.5?"alternate":"alternate-reverse",at=ae()>.5?"alternate":"alternate-reverse",wt=.18+ae()*.42,yt=30+ae()*60,Fe=-45-ae()*38,ve=188+ae()*32,Je=.1+ae()*.2;return{id:`wave-${Se+1}`,style:{"--wave-sway-duration":`${oe}s`,"--wave-scale-duration":`${H}s`,"--wave-drift-duration":`${Oe}s`,"--wave-sway-delay":`${W}s`,"--wave-scale-delay":`${ze}s`,"--wave-drift-delay":`${Te}s`,"--wave-sway-dir":U,"--wave-scale-dir":qe,"--wave-drift-dir":at,"--wave-scale":`${Ee}`,"--wave-shift":`${st}%`,"--wave-xshift":`${D}%`,"--wave-x0":`${he}%`,"--wave-y0":`${Ye}%`,"--wave-opacity":`${wt}`,"--wave-blur":`${yt}px`,"--wave-bottom":`${Fe}%`,"--wave-hue":`${ve}`,"--wave-glow":`${Je}`}}})},[]),m=n.useMemo(()=>{let M=Date.now()*3%2147483647;const ae=()=>(M=M*48271%2147483647,M/2147483647);return Array.from({length:Ar},(Ve,Se)=>{const oe=180+ae()*220,H=220+ae()*280,Oe=-ae()*oe,W=-ae()*H,ze=.12+ae()*.22,Te=3+ae()*7,Ee=1+ae()*3,st=(ae()-.5)*2.8,D=(ae()-.5)*2.2;return{id:`mesh-${Se+1}`,seed:1e3+Se*991+Math.floor(ae()*999),style:{"--mesh-sway-duration":`${oe}s`,"--mesh-drift-duration":`${H}s`,"--mesh-sway-delay":`${Oe}s`,"--mesh-drift-delay":`${W}s`,"--mesh-scale":`${ze}`,"--mesh-shift":`${Te}%`,"--mesh-xshift":`${Ee}%`,"--mesh-x0":`${D}%`,"--mesh-y0":`${st}%`}}})},[]),k=n.useMemo(()=>{const M=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],ae=t.cogita.introSlides,Ve=new Map(ae.map(Se=>[Se.id,Se]));return M.map(Se=>{var H;const oe=Ve.get(Se.id);return{...Se,...oe,title:(oe==null?void 0:oe.title)??"Cogita",cta:(oe==null?void 0:oe.cta)??((H=t.cogita.introSlides[0])==null?void 0:H.cta)??t.cogita.loginCta,secondary:oe==null?void 0:oe.secondary}})},[t.cogita.introSlides]),[S,w]=n.useState(0),[y,Q]=n.useState(!0),[R,b]=n.useState(!1),P=k.length-1,_=n.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),re=n.useCallback(()=>{_(),a()},[_,a]),C=n.useCallback(()=>{Q(!0),w(0)},[]),z=n.useCallback(()=>{Q(!1),w(P)},[P]),A=n.useCallback(M=>{w(Math.max(0,Math.min(P,M)))},[P]),ne=n.useCallback(()=>{S>=P?re():A(S+1)},[S,A,re,P]),ke=n.useCallback(()=>{A(S-1)},[S,A]);n.useEffect(()=>{var Ve;const M=(Ve=window.matchMedia)==null?void 0:Ve.call(window,"(prefers-reduced-motion: reduce)");if(!M)return;const ae=()=>b(M.matches);return ae(),M.addEventListener?(M.addEventListener("change",ae),()=>M.removeEventListener("change",ae)):(M.addListener(ae),()=>M.removeListener(ae))},[]),n.useEffect(()=>{if(!y)return;const M=ae=>{const Ve=ae.target;if(!Ve)return;const Se=Ve.tagName;if(!(Ve.isContentEditable||Se==="INPUT"||Se==="TEXTAREA"||Se==="SELECT"||Se==="BUTTON"||Se==="A"||Ve.closest('button, a, [role="button"], [role="link"]'))){if(ae.key==="Escape"){z();return}if(ae.key==="ArrowLeft"||ae.key==="ArrowUp"){ke();return}(ae.key==="ArrowRight"||ae.key==="ArrowDown"||ae.code==="Space"||ae.key===" ")&&(ae.preventDefault(),ne())}};return window.addEventListener("keydown",M),()=>window.removeEventListener("keydown",M)},[z,ne,ke,y]),n.useEffect(()=>{y&&S===P&&_()},[S,y,P,_]),n.useEffect(()=>{const M=r.current;if(!M)return;const ae=c.current.filter(Fe=>!!Fe);if(!ae.length)return;const Ve=1,Se=.6,oe=.6,H=Math.max(1,Math.min(Ve,window.devicePixelRatio||1));let Oe=0,W=0,ze=Se,Te=0,Ee=0;const st=Fe=>{let ve=Fe%2147483647;return ve<=0&&(ve+=2147483646),(Je,Ue)=>{ve=ve*48271%2147483647;const je=ve/2147483647;return Je+je*(Ue-Je)}},D={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},he=Fe=>{const ve=Math.sin(Fe*12.9898)*43758.5453;return ve-Math.floor(ve)},Ye=Fe=>{const ve=he(Fe+.1)||1e-4,Je=he(Fe+.7)||1e-4;return Math.sqrt(-2*Math.log(ve))*Math.cos(2*Math.PI*Je)},U=(Fe,ve)=>{const Je=Math.floor(Fe),Ue=Je+1,je=Fe-Je,we=je*je*(3-2*je),Me=he(Je*12.9898+ve*78.233),$=he(Ue*12.9898+ve*78.233);return Me+($-Me)*we},qe=Fe=>{const ve=st(Fe),Je=Math.min(4,Math.max(4,Math.floor(Oe/1200*D.filamentCount)));return Array.from({length:Je},(Ue,je)=>{const we=Math.max(-1,Math.min(1,Ye(Fe+je*.37))),Me=Math.min(1,Math.max(0,he(Fe+je*1.31))),$=Math.min(D.depthLayers-1,Math.floor(Me*D.depthLayers));return{seed:ve(0,Math.PI*2)+Fe*.01,offset:we,freqA:D.freq1*(.75+ve(0,.5)),freqB:D.freq2*(.75+ve(0,.5)),ampA:D.amp1*(.6+ve(0,.7)),ampB:D.amp2*(.6+ve(0,.7)),width:2+je%5*.32,depth:Me,layer:$}})},at=(Fe,ve,Je)=>{const Ue=Math.max(30,Math.floor(Oe*W/14e4));Fe.save(),Fe.globalAlpha=.6;for(let je=0;je<Ue;je+=1){const we=he(je*9.1+Oe*.11)*ve+Je,Me=he(je*3.7+W*.23)*W,$=1.2+he(je*5.9)*2.4,K=Fe.createRadialGradient(we,Me,0,we,Me,$*2);K.addColorStop(0,"rgba(10, 30, 60, 0.45)"),K.addColorStop(1,"rgba(10, 30, 60, 0)"),Fe.fillStyle=K,Fe.beginPath(),Fe.arc(we,Me,$*2,0,Math.PI*2),Fe.fill()}Fe.restore()},wt=(Fe,ve)=>{Fe.clearRect(0,0,Oe,W);const Je=W*D.waveCenter,Ue=D.waveBandPx,je=D.segments,we=D.colors.filaments,Me=Te||Oe,$=0;at(Fe,Me,$),Fe.strokeStyle=we,Fe.lineCap="round",Fe.lineJoin="round";for(let K=0;K<ve.length;K+=1){const q=ve[K],J=q.offset*Ue*(.85+he(q.seed)*.4),G=1-Math.min(1,Math.abs(J)/Ue),ce=Math.exp(-Math.pow(J/D.crestThickness,2)),I=q.layer===0?1.1:q.layer===1?.85:.6,N=.35+(1-q.depth)*.65,Z=G*N*I*(.34+ce*.45);Fe.globalAlpha=Z,Fe.lineWidth=q.width*(1+(1-q.depth)*.8);const F=[];for(let te=0;te<=je;te+=1){const ye=te/je*Me+$,le=(U(ye*.012,q.seed)-.5)*D.xJitter,pe=ye+le,Re=(U(pe*q.freqA,q.seed)-.5)*D.jitterA,nt=(U(pe*q.freqB,q.seed*1.7)-.5)*D.jitterB,rt=Je+Math.sin(pe*q.freqA+q.seed)*q.ampA+Math.sin(pe*q.freqB+q.seed*1.3)*q.ampB+J+Re+nt;F.push({x:pe,y:rt})}Fe.beginPath(),Fe.moveTo(F[0].x,F[0].y);for(let te=1;te<F.length-1;te+=1){const ye=(F[te].x+F[te+1].x)/2,le=(F[te].y+F[te+1].y)/2;Fe.quadraticCurveTo(F[te].x,F[te].y,ye,le)}const B=F[F.length-1];Fe.quadraticCurveTo(B.x,B.y,B.x,B.y),Fe.stroke()}Fe.save(),Fe.globalCompositeOperation="lighter",Fe.strokeStyle=D.colors.glow,Fe.lineCap="round",Fe.lineJoin="round";for(let K=0;K<ve.length;K+=1){const q=ve[K];if(Math.abs(q.offset)*Ue>D.crestThickness)continue;const J=D.glowAlpha*(.7+(1-q.depth)*.6);Fe.globalAlpha=J,Fe.lineWidth=1.6+(1-q.depth)*1.2;const G=[];for(let I=0;I<=je;I+=1){const N=I/je*Me+$,Z=Math.sin(N*.02+q.seed)*3,F=Je+Math.sin(N*q.freqA+q.seed)*q.ampA+Math.sin(N*q.freqB+q.seed*1.3)*q.ampB+q.offset*Ue*.35+Z;G.push({x:N,y:F})}Fe.beginPath(),Fe.moveTo(G[0].x,G[0].y);for(let I=1;I<G.length-1;I+=1){const N=(G[I].x+G[I+1].x)/2,Z=(G[I].y+G[I+1].y)/2;Fe.quadraticCurveTo(G[I].x,G[I].y,N,Z)}const ce=G[G.length-1];Fe.quadraticCurveTo(ce.x,ce.y,ce.x,ce.y),Fe.stroke()}Fe.restore()},yt=()=>{Oe=Math.floor(M.clientWidth),W=Math.floor(M.clientHeight),Te=Math.floor(Oe*1.8),Ee=W,ze=Oe<820?oe:Se,ae.forEach(Fe=>{const ve=Fe.getContext("2d");if(!ve)return;Fe.width=Math.floor(Te*H*ze),Fe.height=Math.floor(Ee*H*ze),Fe.style.width=`${Te}px`,Fe.style.height=`${Ee}px`,Fe.style.left=`${-(Te-Oe)/2}px`,ve.setTransform(H*ze,0,0,H*ze,0,0);const Je=Number(Fe.dataset.seed||1),Ue=qe(Je);wt(ve,Ue)})};return yt(),window.addEventListener("resize",yt,{passive:!0}),()=>window.removeEventListener("resize",yt)},[m]);const Le=k[Math.min(S,k.length-1)],$e=y?Le:k[k.length-1],de=($e==null?void 0:$e.theme)??k[0].theme,ge={"--cogita-bg0":de.bg0,"--cogita-bg1":de.bg1,"--cogita-bg2":de.bg2,"--cogita-bloom":de.bloom,"--cogita-sat":de.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:v,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(vi,{value:j,onChange:u}),e.jsx(xi,{copy:t,label:s,isAuthenticated:i,secureMode:f,onLogin:a,onProfileNavigate:l,onToggleSecureMode:h,onLogout:o,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:r,className:"cogita-section cogita-home",style:ge,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[m.map((M,ae)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:M.style,"data-seed":M.seed,ref:Ve=>{c.current[ae]=Ve}},M.id)),E.map(M=>e.jsx("div",{className:"cogita-home-wave",style:M.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},M.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(Mr,{slides:k,activeIndex:S,introOpen:y,prefersReducedMotion:R,onNext:ne,onPrev:ke,onSelect:A,onExit:z,onOpen:C,onRegister:re})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const gl=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:Rr},Symbol.toStringTag,{value:"Module"})),Ii=n.createContext(!1);function Ft({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,headerExtra:u,children:v}){if(n.useContext(Ii))return e.jsx(e.Fragment,{children:v});const c=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}f("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:c,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(vi,{value:g,onChange:j}),e.jsxs("div",{className:"cogita-header-right",children:[u,e.jsx(xi,{copy:t,label:a,isAuthenticated:s,secureMode:o,onLogin:()=>f("home"),onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:v}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const hs=new Map;let Ga=null;const gn=new Map,Un=new Map,ms=new Map,Jn=new Map;async function $r(){if(Ga){await Ga;return}Ga=wi().then(t=>{t.forEach(a=>{hs.set(a.libraryId,a.name)})}).catch(()=>{}).finally(()=>{Ga=null}),await Ga}async function Pr(t){const a=hs.get(t);return a||(await $r(),hs.get(t)??null)}async function Er(t){if(gn.has(t))return gn.get(t)??null;const a=Un.get(t);if(a)return a;const s=zi(t).then(i=>(gn.set(t,i),i)).catch(()=>(gn.set(t,null),null)).finally(()=>{Un.delete(t)});return Un.set(t,s),s}async function Kr(t){const a=ms.get(t);if(a)return a;const s=Jn.get(t);if(s)return s;const i=za({libraryId:t,limit:200}).then(l=>(ms.set(t,l.items),l.items)).catch(()=>[]).finally(()=>{Jn.delete(t)});return Jn.set(t,i),i}function Fs(t,a){ms.set(t,a)}function rn(t){const[a,s]=n.useState("Cogita library"),[i,l]=n.useState(null);return n.useEffect(()=>{let h=!1;return Pr(t).then(o=>{h||!o||s(o)}).catch(()=>{h||s("Cogita library")}),()=>{h=!0}},[t]),n.useEffect(()=>{let h=!1;return Er(t).then(o=>{h||l(o)}).catch(()=>{h||l(null)}),()=>{h=!0}},[t]),{libraryName:a,stats:i}}function _s({slices:t}){const a=t.reduce((i,l)=>i+Math.max(0,l.value),0),s=n.useMemo(()=>{if(a<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let i=0;return`conic-gradient(${t.map(h=>{const f=Math.max(0,h.value)/a*360,g=i,j=i+f;return i=j,`${h.color} ${g}deg ${j}deg`}).join(",")})`},[t,a]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:s}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(i=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:i.color}}),e.jsx("strong",{children:i.value}),e.jsx("small",{children:i.label})]},i.label))})]})}function Fr({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,libraryId:u}){const{libraryName:v,stats:r}=rn(u),[c,E]=n.useState("infos"),[m,k]=n.useState(0),[S,w]=n.useState(0),[y,Q]=n.useState(0),R=(r==null?void 0:r.totalInfos)??0,b=(r==null?void 0:r.totalCollections)??0,P=0,_=0,re=0,C=Math.max(0,R-re-S),z=Math.max(0,R-S-y);n.useEffect(()=>{let ne=!1;return(async()=>{try{const Le=await za({libraryId:u,limit:200}),$e=await Promise.all(Le.items.map(de=>vs({libraryId:u,collectionId:de.collectionId}).catch(()=>[])));if(ne)return;k($e.reduce((de,ge)=>de+ge.length,0))}catch{ne||k(0)}})(),()=>{ne=!0}},[u]),n.useEffect(()=>{let ne=!1;return(async()=>{try{const[Le,$e,de]=await Promise.all([Rs({libraryId:u,type:"computed",limit:1}).catch(()=>({total:0})),Rs({libraryId:u,type:"source",limit:1}).catch(()=>({total:0})),xs({libraryId:u}).catch(()=>({items:[]}))]);if(ne)return;w((Le.total??0)+($e.total??0));const ge=new Set(de.items.filter(M=>M.childItemType.toLowerCase()==="info").map(M=>M.childItemId).filter(Boolean));Q(ge.size)}catch{ne||(w(0),Q(0))}})(),()=>{ne=!0}},[u]);const A=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:R},{key:"collections",label:t.cogita.library.overview.stats.collections,value:b},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:m},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:P},{key:"texts",label:t.cogita.library.overview.stats.texts,value:_}];return e.jsx(Ft,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:v})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:A.map(ne=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${c===ne.key?"active":""}`,onClick:()=>E(ne.key),children:[e.jsx("span",{children:ne.label}),e.jsx("strong",{children:ne.value})]},ne.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),c==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(_s,{slices:[{label:t.cogita.library.overview.known,value:re,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:C,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:S,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(_s,{slices:[{label:t.cogita.library.overview.availableChecks,value:y,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:z,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const ft=(t,a)=>{const s=t.cogita.library.infoTypes,i=t.cogita.library.connectionTypes,l=t.cogita.library.groupTypes;return{any:s.any,vocab:s.vocab,book:l.book,citation:l.citation,language:s.language,word:s.word,sentence:s.sentence,topic:s.topic,collection:s.collection,person:s.person,institution:s.institution,collective:s.collective,orcid:s.orcid,address:s.address,email:s.email,phone:s.phone,media:s.media,work:s.work,geo:s.geo,music_piece:s.musicPiece,music_fragment:s.musicFragment,source:s.source,question:s.question,computed:s.computed,"word-language":i.wordLanguage,"citation-language":i.citationLanguage,"language-sentence":i.languageSentence,translation:i.translation,"word-topic":i.wordTopic,reference:i.reference,"source-resource":i.sourceResource,"work-contributor":i.workContributor,"work-medium":i.workMedium,"orcid-link":i.orcidLink}[a]??String(a)},_r=t=>[{value:"any",label:ft(t,"any")},{value:"language",label:ft(t,"language")},{value:"word",label:ft(t,"word")},{value:"sentence",label:ft(t,"sentence")},{value:"topic",label:ft(t,"topic")},{value:"collection",label:ft(t,"collection")},{value:"person",label:ft(t,"person")},{value:"institution",label:ft(t,"institution")},{value:"collective",label:ft(t,"collective")},{value:"orcid",label:ft(t,"orcid")},{value:"address",label:ft(t,"address")},{value:"email",label:ft(t,"email")},{value:"phone",label:ft(t,"phone")},{value:"media",label:ft(t,"media")},{value:"work",label:ft(t,"work")},{value:"geo",label:ft(t,"geo")},{value:"music_piece",label:ft(t,"music_piece")},{value:"music_fragment",label:ft(t,"music_fragment")},{value:"source",label:ft(t,"source")},{value:"question",label:ft(t,"question")},{value:"citation",label:ft(t,"citation")},{value:"computed",label:ft(t,"computed")},{value:"vocab",label:ft(t,"vocab")},{value:"book",label:ft(t,"book")},{value:"word-language",label:ft(t,"word-language")},{value:"citation-language",label:ft(t,"citation-language")},{value:"language-sentence",label:ft(t,"language-sentence")},{value:"translation",label:ft(t,"translation")},{value:"word-topic",label:ft(t,"word-topic")},{value:"reference",label:ft(t,"reference")},{value:"source-resource",label:ft(t,"source-resource")},{value:"work-contributor",label:ft(t,"work-contributor")},{value:"work-medium",label:ft(t,"work-medium")},{value:"orcid-link",label:ft(t,"orcid-link")}],Vr=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Qn={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},qr={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Qn]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Qn]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId"]},filterFields:[Qn,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text"],connections:[{relationType:"citation-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"citationText",kind:"text",path:"text",matcher:"contains"}]},question:{infoType:"question",entityKind:"single",structure:{payloadFields:["definition"]},filterFields:[{key:"questionType",labelKey:"type",kind:"text",path:"definition.type",matcher:"contains"},{key:"questionText",labelKey:"text",kind:"text",path:"definition.question",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},Vs={infoType:"default",entityKind:"single",structure:{payloadFields:["label"]},filterFields:[]};function Dr(t){return t?qr[t]??Vs:Vs}function Br(t,a){return t.optionsSource==="languages"?a.languages.map(s=>({value:s.infoId,label:s.label})):t.optionsSource==="sourceKinds"?Vr:[]}const zr="cogita.revision.seed:";function Mi(t){return`${zr}${t}`}function Or(t,a){if(typeof window>"u")return null;const s=Array.from(new Set(a.map(h=>h.trim()).filter(Boolean)));if(!s.length)return null;const i=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,l={kind:"info-selection",libraryId:t,infoIds:s,createdAt:new Date().toISOString()};return window.localStorage.setItem(Mi(i),JSON.stringify(l)),i}function qs(t,a){if(typeof window>"u")return null;const s=window.localStorage.getItem(Mi(a));if(!s)return null;try{const i=JSON.parse(s);if(i.kind!=="info-selection"||i.libraryId!==t||!Array.isArray(i.infoIds))return null;const l=i.infoIds.map(h=>String(h??"").trim()).filter(Boolean);return l.length?{infoIds:l}:null}catch{return null}}const Ur="cogita.collection-draft:";function Li(t){return`${Ur}${t}`}function Jr(t,a){if(typeof window>"u")return null;const s=Array.from(new Set(a.map(h=>h.trim()).filter(Boolean)));if(!s.length)return null;const i=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,l={kind:"info-selection",libraryId:t,infoIds:s,createdAt:new Date().toISOString()};return window.localStorage.setItem(Li(i),JSON.stringify(l)),i}function Qr(t,a){if(typeof window>"u")return null;const s=window.localStorage.getItem(Li(a));if(!s)return null;try{const i=JSON.parse(s);if(i.kind!=="info-selection"||i.libraryId!==t||!Array.isArray(i.infoIds))return null;const l=i.infoIds.map(h=>String(h??"").trim()).filter(Boolean);return l.length?{infoIds:l}:null}catch{return null}}const Hn=60,Hr=500;function Ai(t){return`cogita.info-selection:${t}`}function Ds(t){if(typeof window>"u")return{};const a=window.localStorage.getItem(Ai(t));if(!a)return{};try{const s=JSON.parse(a);return!s||typeof s!="object"?{}:s}catch{return{}}}function Wr({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,libraryId:u,mode:v,filterCollectionId:r}){var Ne;const c=sn(),E=Ua(),m=t.cogita.library.list,[k,S]=n.useState("any"),[w,y]=n.useState(""),[Q,R]=n.useState("relevance"),[b,P]=n.useState("details"),[_,re]=n.useState(!1),[C,z]=n.useState("idle"),[A,ne]=n.useState([]),[ke,Le]=n.useState(Hn),[$e,de]=n.useState(null),[ge,M]=n.useState(()=>Ds(u)),[ae,Ve]=n.useState({}),[Se,oe]=n.useState([]),[H,Oe]=n.useState([]),[W,ze]=n.useState(null),[Te,Ee]=n.useState(null),[st,D]=n.useState(null),[he,Ye]=n.useState("idle"),[U,qe]=n.useState([]),[at,wt]=n.useState(""),[yt,Fe]=n.useState(null),[ve,Je]=n.useState("idle"),[Ue,je]=n.useState(null),[we,Me]=n.useState(null),[$,K]=n.useState("idle"),[q,J]=n.useState([]),[G,ce]=n.useState("idle"),[I,N]=n.useState(null),[Z,F]=n.useState(!0),B=n.useMemo(()=>_r(t),[t]),te=n.useMemo(()=>[{value:"relevance",label:m.sortRelevance},{value:"label_asc",label:m.sortLabelAsc},{value:"label_desc",label:m.sortLabelDesc},{value:"type_asc",label:m.sortTypeAsc},{value:"type_desc",label:m.sortTypeDesc}],[m.sortLabelAsc,m.sortLabelDesc,m.sortRelevance,m.sortTypeAsc,m.sortTypeDesc]);n.useEffect(()=>{M(Ds(u)),Ve({}),re(!1)},[u]),n.useEffect(()=>{if(!r){N(null),F(!0);return}let d=!1;return F(!1),ji({libraryId:u,collectionId:r}).then(se=>{var dt;if(d)return;let me=!1;const Ge=new Set;for(const mt of se.nodes??[]){if(mt.nodeType==="source.info.all"){me=!0;break}if(mt.nodeType!=="source.info")continue;const Et=mt.payload??{},Ce=(((dt=Et.params)==null?void 0:dt.infoId)??Et.infoId??"").trim();Ce&&Ge.add(Ce)}N(me?null:Ge),F(!0)}).catch(()=>{d||(N(new Set),F(!0))}),()=>{d=!0}},[r,u]),n.useEffect(()=>{xs({libraryId:u}).then(d=>D(d)).catch(()=>D({items:[]}))},[u]),n.useEffect(()=>{Oi({libraryId:u}).then(d=>qe(d)).catch(()=>qe([]))},[u]),n.useEffect(()=>{On({libraryId:u,type:"language",filters:{sourceKind:"info"},limit:200}).then(d=>{const se=d.map(me=>({infoId:me.infoId??"",infoType:me.entityType,label:me.title})).filter(me=>me.infoId.length>0);oe(se)}).catch(()=>oe([]))},[u]),n.useEffect(()=>{On({libraryId:u,type:"source",filters:{sourceKind:"info"},limit:200}).then(d=>{const se=d.map(me=>({infoId:me.infoId??"",infoType:me.entityType,label:me.title})).filter(me=>me.infoId.length>0);Oe(se)}).catch(()=>Oe([]))},[u]),n.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(Ai(u),JSON.stringify(ge))},[u,ge]);const ye=n.useMemo(()=>Dr(k==="any"?null:k),[k]),le=n.useMemo(()=>E.pathname.split("/").filter(Boolean),[E.pathname]),pe=le.findIndex(d=>d==="infos"),Re=pe>=0&&(le[pe+1]??"").trim()||null,nt=pe>=0?(le[pe+2]??"").trim():"",rt=pe>=0?nt==="checkcards"?"cards":nt==="collections"?"collections":"overview":"",He=Re,lt=Re?rt:"",vt=lt==="overview"&&!!He,gt=lt==="collections"&&!!He,tt=n.useMemo(()=>({language:m.typeFilterLanguage,languageA:m.typeFilterLanguageA,languageB:m.typeFilterLanguageB,originalLanguage:m.typeFilterOriginalLanguage,doi:m.typeFilterDoi,sourceKind:m.typeFilterSourceKind,locator:m.typeFilterLocator,citationText:m.typeFilterCitationText}),[m.typeFilterDoi,m.typeFilterLanguage,m.typeFilterLanguageA,m.typeFilterLanguageB,m.typeFilterLocator,m.typeFilterOriginalLanguage,m.typeFilterCitationText,m.typeFilterSourceKind]),Qe=n.useMemo(()=>ye.filterFields.map(d=>({...d,label:d.labelKey?tt[d.labelKey]:d.label??d.key,options:Br(d,{languages:Se})})),[tt,Se,ye.filterFields]),bt=n.useMemo(()=>Qe.some(d=>(ae[d.key]??"").trim().length>0),[Qe,ae]);n.useEffect(()=>{Ve({})},[k]),n.useEffect(()=>{if(r&&!Z){z("loading");return}const d={sourceKind:"info"};if(bt)for(const Ge of Qe){const dt=(ae[Ge.key]??"").trim();dt&&(d[Ge.path??Ge.key]=dt)}const se=(ae.__referenceId??"").trim();se&&(d["link.references"]=se),z("loading");const me=window.setTimeout(()=>{On({libraryId:u,type:k==="any"?void 0:k,query:w.trim()||void 0,filters:d,limit:Hr}).then(Ge=>{const dt=Ge.map(mt=>({infoId:mt.infoId??"",infoType:mt.entityType,label:mt.title})).filter(mt=>mt.infoId.length>0);ne(r&&I?dt.filter(mt=>I.has(mt.infoId)):dt),z("ready")}).catch(()=>{ne([]),z("ready")})},240);return()=>window.clearTimeout(me)},[I,Z,r,bt,u,w,k,Qe,ae]),n.useEffect(()=>{if(!He||lt!=="overview"&&lt!=="collections"){ze(null),Ee(null),Ye("idle");return}let d=!1;return Ye("loading"),Promise.all([la({libraryId:u,infoId:He}),Ui({libraryId:u,itemType:"info",itemId:He}).catch(()=>null)]).then(([se,me])=>{d||(ze(se),Ee(me),Ye("ready"))}).catch(()=>{d||(ze(null),Ee(null),Ye("error"))}),()=>{d=!0}},[u,He,lt]),n.useEffect(()=>{if(!He||lt!=="collections"){J([]),ce("idle");return}let d=!1;return ce("loading"),Ji({libraryId:u,infoId:He}).then(se=>{d||(J(se),ce("ready"))}).catch(()=>{d||(J([]),ce("error"))}),()=>{d=!0}},[u,He,lt]),n.useEffect(()=>{if(!He||lt!=="overview"){je(null),Me(null),K("idle");return}let d=!1;return K("loading"),Promise.all([xn({libraryId:u,infoId:He}),wn({libraryId:u,infoId:He})]).then(([se,me])=>{d||(je(se),Me(me),K("ready"))}).catch(()=>{d||(je(null),Me(null),K("error"))}),()=>{d=!0}},[u,He,lt]);const We=n.useMemo(()=>W?U.filter(d=>d.sourceInfoTypes.some(se=>se.toLowerCase()===W.infoType.toLowerCase())):[],[U,W]);n.useEffect(()=>{if(!W){wt("");return}wt(d=>{var se;return d&&We.some(me=>me.approachKey===d)?d:((se=We[0])==null?void 0:se.approachKey)??""})},[We,W]),n.useEffect(()=>{if(!W||!at){Fe(null),Je("idle");return}let d=!1;return Je("loading"),ki({libraryId:u,infoId:W.infoId,approachKey:at}).then(se=>{d||(Fe(se),Je("ready"))}).catch(()=>{d||(Fe(null),Je("error"))}),()=>{d=!0}},[u,at,W]);const ut=n.useMemo(()=>{const d=A.slice(),se=me=>ft(t,me);return Q==="relevance"?d:Q==="label_asc"?d.sort((me,Ge)=>me.label.localeCompare(Ge.label)):Q==="label_desc"?d.sort((me,Ge)=>Ge.label.localeCompare(me.label)):Q==="type_asc"?d.sort((me,Ge)=>me.infoType===Ge.infoType?me.label.localeCompare(Ge.label):se(me.infoType).localeCompare(se(Ge.infoType))):d.sort((me,Ge)=>me.infoType===Ge.infoType?me.label.localeCompare(Ge.label):se(Ge.infoType).localeCompare(se(me.infoType)))},[t,A,Q]),Tt=n.useMemo(()=>ut.slice(0,ke),[ut,ke]),Mt=Tt.length<ut.length,pt=n.useMemo(()=>new Set(Object.keys(ge)),[ge]),Ct=n.useMemo(()=>Object.values(ge),[ge]),Jt=n.useMemo(()=>{const d=new Map;for(const se of Ct)d.set(se.infoType,(d.get(se.infoType)??0)+1);return Array.from(d.entries()).sort((se,me)=>me[1]-se[1]||se[0].localeCompare(me[0]))},[Ct]),jt=n.useMemo(()=>{if(!He||!st)return 0;const d=new Set;for(const se of st.items)se.childItemType!=="info"||se.childItemId!==He||d.add([se.parentItemType,se.parentItemId,se.parentCheckType??"",se.parentDirection??""].join("|"));return d.size},[st,He]);n.useEffect(()=>{Le(Hn);const d=new Set(A.map(se=>se.infoId));de(se=>se&&d.has(se)?se:null)},[A]);const Bt=d=>{M(se=>({...se,[d.infoId]:{infoId:d.infoId,infoType:d.infoType,label:d.label}}))},ea=d=>{M(se=>{if(!se[d])return se;const me={...se};return delete me[d],me})},xa=(d,se)=>{if(se){Bt(d);return}ea(d.infoId)},$t=d=>{c(`/cogita/library/${u}/infos/${encodeURIComponent(d)}`,{replace:!0})},aa=()=>{c(`/cogita/library/${u}/infos`,{replace:!0})},Lt=()=>{He&&c(`/cogita/library/${u}/infos/${encodeURIComponent(He)}/edit`,{replace:!0})},It=()=>{const d=Or(u,Ct.map(se=>se.infoId));d&&c(`/cogita/library/${u}/revisions/run?scope=info-selection&seed=${encodeURIComponent(d)}`)},zt=()=>{const d=Jr(u,Ct.map(se=>se.infoId));d&&c(`/cogita/library/${u}/collections/new?draft=${encodeURIComponent(d)}&draftType=info-selection`)},Pt=Ct.length===1?((Ne=Ct[0])==null?void 0:Ne.infoId)??null:null,ct=m.selectionCount.replace("{count}",String(Ct.length)),Ze=v==="collection"?"grid":v==="detail"?"wide":b,it=Yr(g),ma=Te?Math.max(0,Math.min(100,Math.round((Te.score??0)*100))):0,x=Te?Xr(Te,it):it.noKnownnessData;return e.jsx(Ft,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":Ze,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[vt?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:it.kicker}),e.jsx("h2",{className:"cogita-card-title",children:W?Bs(W.payload,W.infoType,W.infoId):it.loading}),W?e.jsxs("p",{className:"cogita-card-subtitle",children:[ft(t,W.infoType)," · ",W.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:aa,children:it.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:Lt,disabled:!He||he!=="ready",children:m.editInfo})]})]}),he==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:it.loading})}):he==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:it.loadError})}):W?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:it.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[ma,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${ma}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:x})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:it.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(Te==null?void 0:Te.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:it.correct.replace("{correct}",String((Te==null?void 0:Te.correctReviews)??0)).replace("{total}",String((Te==null?void 0:Te.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:Te!=null&&Te.lastReviewedUtc?`${it.lastReview}: ${Gr(Te.lastReviewedUtc,g)}`:it.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:it.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:jt}),e.jsx("p",{className:"cogita-library-hint",children:it.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:it.checkcards}),$==="loading"?e.jsx("p",{className:"cogita-library-hint",children:it.loadingCheckcards}):$==="error"?e.jsx("p",{className:"cogita-library-hint",children:it.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:it.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(Ue==null?void 0:Ue.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:it.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(we==null?void 0:we.items.length)??0})]})]})]}),We.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:it.approach}),e.jsx("select",{value:at,onChange:d=>wt(d.target.value),"aria-label":it.approach,children:We.map(d=>e.jsx("option",{value:d.approachKey,children:d.label},d.approachKey))})]}),ve==="loading"?e.jsx("p",{className:"cogita-library-hint",children:it.loadingApproach}):ve==="error"?e.jsx("p",{className:"cogita-library-hint",children:it.loadApproachError}):yt?e.jsx(jn,{value:yt.projection,emptyLabel:it.empty}):e.jsx("p",{className:"cogita-library-hint",children:it.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:it.payload}),e.jsx(jn,{value:W.payload,emptyLabel:it.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:it.links}),e.jsx(Zr,{links:W.links,emptyLabel:it.noLinks})]})]})]}):null]})}):null,gt?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Informacja"}),e.jsx("h2",{className:"cogita-card-title",children:W?Bs(W.payload,W.infoType,W.infoId):He??""}),e.jsx("p",{className:"cogita-card-subtitle",children:"Collections using this info"})]}),e.jsx("div",{className:"cogita-info-overview-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:aa,children:"Back to search"})})]}),G==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading collections..."})}):null,G==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load collections."})}):null,G==="ready"&&q.length===0?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"This info is not used in any collection yet."})}):null,G==="ready"&&q.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:q.map(d=>e.jsx("article",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`/#/cogita/library/${u}/collections/${d.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:"Collection"}),e.jsx("h3",{className:"cogita-card-title",children:d.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[d.itemCount," items"]})]})},d.collectionId))}):null]})}):null,!vt&&!gt?e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":m.typeLabel,value:k,onChange:d=>S(d.target.value),children:B.map(d=>e.jsx("option",{value:d.value,children:d.label},d.value))}),e.jsx("input",{type:"text",value:w,onChange:d=>y(d.target.value),placeholder:m.searchPlaceholder}),e.jsx("select",{"aria-label":m.sortLabel,value:Q,onChange:d=>R(d.target.value),children:te.map(d=>e.jsx("option",{value:d.value,children:d.label},d.value))}),e.jsxs("select",{"aria-label":m.viewLabel,value:b,onChange:d=>P(d.target.value),children:[e.jsx("option",{value:"details",children:m.viewDetails}),e.jsx("option",{value:"wide",children:m.viewWide}),e.jsx("option",{value:"grid",children:m.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:m.cardCount.replace("{shown}",String(Tt.length)).replace("{total}",String(ut.length))}),e.jsx("span",{children:C==="loading"?m.loading:m.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>re(d=>!d),children:_?m.hideFilters:m.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:m.filtersOptionalHint})]}),_?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsxs("div",{className:"cogita-filter-grid",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:m.typeLabel}),e.jsx("select",{value:k,onChange:d=>S(d.target.value),children:B.map(d=>e.jsx("option",{value:d.value,children:d.label},`advanced-type:${d.value}`))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Reference"}),e.jsxs("select",{value:ae.__referenceId??"",onChange:d=>Ve(se=>({...se,__referenceId:d.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),H.map(d=>e.jsx("option",{value:d.infoId,children:d.label},`reference:${d.infoId}`))]})]}),Qe.map(d=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:d.label}),d.kind==="select"?e.jsxs("select",{value:ae[d.key]??"",onChange:se=>Ve(me=>({...me,[d.key]:se.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(d.options??[]).map(se=>e.jsx("option",{value:se.value,children:se.label},`${d.key}:${se.value}`))]}):e.jsx("input",{type:"text",value:ae[d.key]??"",onChange:se=>Ve(me=>({...me,[d.key]:se.target.value}))})]},`type-filter:${d.key}`))]})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:ct}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{M(d=>{const se={...d};for(const me of Tt)se[me.infoId]={infoId:me.infoId,infoType:me.infoType,label:me.label};return se})},disabled:Tt.length===0,children:m.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>M({}),disabled:Ct.length===0,children:m.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Pt&&$t(Pt),disabled:!Pt,title:Pt?void 0:m.openSelectedDisabled,children:m.openSelected})]})]}),Ze==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":m.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:m.detailColumnName}),e.jsx("span",{children:m.detailColumnType}),e.jsx("span",{children:m.detailColumnId}),e.jsx("span",{})]}),Tt.length?Tt.map(d=>{const se=ft(t,d.infoType),me=pt.has(d.infoId),Ge=$e===d.infoId;return e.jsxs("div",{className:`cogita-details-row ${Ge||me?"active":""}`,role:"row",onClick:()=>de(d.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:me,onChange:dt=>xa(d,dt.target.checked),onClick:dt=>dt.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:d.label,children:d.label}),e.jsx("span",{title:se,children:se}),e.jsx("span",{title:d.infoId,children:d.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:dt=>{dt.stopPropagation(),$t(d.infoId)},"aria-label":m.editInfo,children:">"})]},d.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:m.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${Ze}`,"data-view":Ze,children:Tt.length?Tt.map(d=>{const se=ft(t,d.infoType),me=pt.has(d.infoId),Ge=$e===d.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":Ge||me,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:me,onChange:dt=>xa(d,dt.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>de(d.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:se}),e.jsx("h3",{className:"cogita-card-title",children:d.label}),e.jsx("p",{className:"cogita-card-subtitle",children:d.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>$t(d.infoId),children:m.editInfo})]})},d.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:m.noMatch})})}),Mt?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>Le(d=>d+Hn),children:m.loadMore})}):null,Ct.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:m.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:m.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:Jt.map(([d,se])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:ft(t,d)}),e.jsx("span",{className:"cogita-tag-count",children:se})]},`stack:type:${d}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:It,disabled:Ct.length===0,children:"Start revision"}),e.jsx("button",{type:"button",className:"ghost",onClick:zt,disabled:Ct.length===0,children:"Create collection from selection"})]})]}):null]}):null]})})})})}function Bs(t,a,s){if(t&&typeof t=="object"&&!Array.isArray(t)){const i=t,l=["title","name","label","value","text","quote","term"];for(const h of l){const o=i[h];if(typeof o=="string"&&o.trim())return o.trim()}}return`${a} · ${s}`}function Gr(t,a){try{const s=a==="pl"?"pl-PL":a==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(s,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function Yr(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function Xr(t,a){return t.totalReviews<=0?a.noKnownnessData:t.totalReviews<3||t.score<.35?a.developmentStart:t.totalReviews<8||t.score<.65?a.developmentGrowing:t.score<.85?a.developmentStable:a.developmentStrong}function Zr({links:t,emptyLabel:a}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:a}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([s,i])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(i)?i.length?e.jsx("div",{className:"cogita-selection-overview",children:i.map(l=>e.jsx("span",{className:"cogita-tag-chip",children:l},`${s}:${l}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):i?e.jsx("span",{className:"cogita-tag-chip",children:i}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},s))})}function jn({value:t,emptyLabel:a}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:a});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((s,i)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:i+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(jn,{value:s,emptyLabel:a})})]},i))});if(typeof t=="object"){const s=Object.entries(t);return s.length===0?e.jsx("p",{className:"cogita-library-hint",children:a}):e.jsx("div",{className:"cogita-info-tree",children:s.map(([i,l])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:i}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(jn,{value:l,emptyLabel:a})})]},i))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const Ra=5,zs=50,Os=2,Us=[];function va({libraryId:t,infoType:a,label:s,placeholder:i,value:l,onChange:h,values:o,onChangeMultiple:f,helperText:g,searchFailedText:j,createFailedText:u,createLabel:v,savingLabel:r,loadMoreLabel:c,allowCreate:E=!0,inputRef:m,autoAdvance:k,onCommit:S,multiple:w}){const y=w?o??Us:Us,[Q,R]=n.useState(w?"":(l==null?void 0:l.label)??""),[b,P]=n.useState([]),[_,re]=n.useState(Ra),[C,z]=n.useState(-1),[A,ne]=n.useState(!1),[ke,Le]=n.useState(!1),[$e,de]=n.useState(null),ge=n.useRef(0),M=n.useRef(new Map),ae=n.useMemo(()=>E?w?Q.trim().length>0:Q.trim().length>0&&!l:!1,[E,Q,l,w]);n.useEffect(()=>{w||R((l==null?void 0:l.label)??"")},[l,w]),n.useEffect(()=>{const oe=Q.trim();if(!oe||oe.length<Os){P([]),ne(!1),re(Ra),z(-1),Le(!1),de(null);return}const H=oe.toLowerCase(),Oe=`${t}:${a}:${H}`,W=M.current.get(Oe);if(W){if(w&&y.length>0){const Te=new Set(y.map(Ee=>Ee.id));P(W.filter(Ee=>!Te.has(Ee.id)))}else P(W);re(Ra),z(-1),ne(W.length>0),Le(!1),de(null);return}const ze=window.setTimeout(async()=>{const Te=Date.now();ge.current=Te,Le(!0),de(null);try{const Ee=await ws({libraryId:t,type:a,query:oe,limit:zs});if(ge.current!==Te)return;const st=Ee.slice(0,zs).map(D=>({id:D.infoId,label:D.label,infoType:D.infoType}));if(M.current.set(Oe,st),w&&y.length>0){const D=new Set(y.map(he=>he.id));P(st.filter(he=>!D.has(he.id)))}else P(st);re(Ra),z(-1),ne(!0)}catch{if(ge.current!==Te)return;de(j??"Search failed.")}finally{ge.current===Te&&Le(!1)}},250);return()=>window.clearTimeout(ze)},[t,a,Q,y]);const Ve=oe=>{if(w){const H=y.some(Oe=>Oe.id===oe.id)?y:[...y,oe];f==null||f(H),R(""),ne(!1),z(-1);return}h==null||h(oe),R(oe.label),ne(!1),z(-1),k&&(S==null||S())},Se=async()=>{const oe=Q.trim();if(oe){Le(!0),de(null);try{const H=await ls({libraryId:t,infoType:a,payload:{label:oe}}),Oe={id:H.infoId,label:oe,infoType:H.infoType};if(oe.length>=Os){const W=`${t}:${a}:${oe.toLowerCase()}`,ze=M.current.get(W)??[];M.current.set(W,[Oe,...ze])}if(w){f==null||f([...y,Oe]),R(""),ne(!1),z(-1);return}h==null||h(Oe),ne(!1),z(-1),k&&(S==null||S())}catch{de(u??"Create failed.")}finally{Le(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:s}),e.jsx("input",{value:Q,placeholder:i,onChange:oe=>{R(oe.target.value),!w&&l&&(h==null||h(null))},onKeyDown:oe=>{if(oe.key==="ArrowDown"){if(oe.preventDefault(),!b.length)return;ne(!0),z(H=>{const Oe=Math.min(b.length,_)-1,W=H<0?0:Math.min(H+1,Oe);return W===Oe&&b.length>_?(re(ze=>Math.min(ze+Ra,b.length)),Math.min(H+1,Math.min(b.length,_+Ra)-1)):W});return}if(oe.key==="ArrowUp"){if(oe.preventDefault(),!b.length)return;ne(!0),z(H=>H<=0?0:H-1);return}if(oe.key==="Enter"){if(oe.preventDefault(),C>=0&&b[C]){Ve(b[C]);return}if(ae){Se();return}}},onFocus:()=>{b.length>0&&ne(!0)},autoComplete:"off",ref:m})]}),w&&y.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:y.map(oe=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>f==null?void 0:f(y.filter(H=>H.id!==oe.id)),children:[oe.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},oe.id))}),g&&e.jsx("p",{className:"cogita-help",children:g}),$e&&e.jsx("p",{className:"cogita-error",children:$e}),A&&b.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[b.slice(0,_).map((oe,H)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":H===C,onClick:()=>Ve(oe),children:[e.jsx("strong",{children:oe.label}),e.jsx("span",{children:oe.infoType})]},oe.id)),_<b.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>re(oe=>Math.min(oe+Ra,b.length)),children:c??"Load more"})]}),ae&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:Se,disabled:ke,children:ke?r??"Saving...":v??`Create new ${a}`})]})}const Js=[{id:"gen",la:{abbr:"Gen",name:"Genesis"},en:{abbr:"Gen",name:"Genesis"},de:{abbr:"Gen",name:"Genesis"},pl:{abbr:"Rdz",name:"Księga Rodzaju"}},{id:"ex",la:{abbr:"Ex",name:"Exodus"},en:{abbr:"Ex",name:"Exodus"},de:{abbr:"Ex",name:"Exodus"},pl:{abbr:"Wj",name:"Księga Wyjścia"}},{id:"lev",la:{abbr:"Lev",name:"Leviticus"},en:{abbr:"Lev",name:"Leviticus"},de:{abbr:"Lev",name:"Levitikus"},pl:{abbr:"Kpł",name:"Księga Kapłańska"}},{id:"num",la:{abbr:"Num",name:"Numeri"},en:{abbr:"Num",name:"Numbers"},de:{abbr:"Num",name:"Numeri"},pl:{abbr:"Lb",name:"Księga Liczb"}},{id:"deut",la:{abbr:"Deut",name:"Deuteronomium"},en:{abbr:"Deut",name:"Deuteronomy"},de:{abbr:"Dtn",name:"Deuteronomium"},pl:{abbr:"Pwt",name:"Księga Powtórzonego Prawa"}},{id:"ios",la:{abbr:"Ios",name:"Iosue"},en:{abbr:"Josh",name:"Joshua"},de:{abbr:"Jos",name:"Josua"},pl:{abbr:"Joz",name:"Księga Jozuego"}},{id:"iudg",la:{abbr:"Iudg",name:"Iudicum"},en:{abbr:"Judg",name:"Judges"},de:{abbr:"Ri",name:"Richter"},pl:{abbr:"Sdz",name:"Księga Sędziów"}},{id:"ruth",la:{abbr:"Ruth",name:"Ruth"},en:{abbr:"Ruth",name:"Ruth"},de:{abbr:"Rut",name:"Rut"},pl:{abbr:"Rt",name:"Księga Rut"}},{id:"1sam",la:{abbr:"1 Sam",name:"I Samuelis"},en:{abbr:"1 Sam",name:"1 Samuel"},de:{abbr:"1 Sam",name:"1 Samuel"},pl:{abbr:"1 Sm",name:"1 Księga Samuela"}},{id:"2sam",la:{abbr:"2 Sam",name:"II Samuelis"},en:{abbr:"2 Sam",name:"2 Samuel"},de:{abbr:"2 Sam",name:"2 Samuel"},pl:{abbr:"2 Sm",name:"2 Księga Samuela"}},{id:"1reg",la:{abbr:"1 Reg",name:"I Regum"},en:{abbr:"1 Kgs",name:"1 Kings"},de:{abbr:"1 Kön",name:"1 Könige"},pl:{abbr:"1 Krl",name:"1 Księga Królewska"}},{id:"2reg",la:{abbr:"2 Reg",name:"II Regum"},en:{abbr:"2 Kgs",name:"2 Kings"},de:{abbr:"2 Kön",name:"2 Könige"},pl:{abbr:"2 Krl",name:"2 Księga Królewska"}},{id:"1par",la:{abbr:"1 Par",name:"I Paralipomenon"},en:{abbr:"1 Chr",name:"1 Chronicles"},de:{abbr:"1 Chr",name:"1 Chronik"},pl:{abbr:"1 Krn",name:"1 Księga Kronik"}},{id:"2par",la:{abbr:"2 Par",name:"II Paralipomenon"},en:{abbr:"2 Chr",name:"2 Chronicles"},de:{abbr:"2 Chr",name:"2 Chronik"},pl:{abbr:"2 Krn",name:"2 Księga Kronik"}},{id:"esd",la:{abbr:"Esd",name:"Esdrae"},en:{abbr:"Ezra",name:"Ezra"},de:{abbr:"Esra",name:"Esra"},pl:{abbr:"Ezd",name:"Księga Ezdrasza"}},{id:"neh",la:{abbr:"Neh",name:"Nehemiae"},en:{abbr:"Neh",name:"Nehemiah"},de:{abbr:"Neh",name:"Nehemia"},pl:{abbr:"Ne",name:"Księga Nehemiasza"}},{id:"tob",la:{abbr:"Tob",name:"Tobiae"},en:{abbr:"Tob",name:"Tobit"},de:{abbr:"Tob",name:"Tobit"},pl:{abbr:"Tb",name:"Księga Tobiasza"}},{id:"iudt",la:{abbr:"Iudt",name:"Iudith"},en:{abbr:"Jdt",name:"Judith"},de:{abbr:"Jdt",name:"Judit"},pl:{abbr:"Jdt",name:"Księga Judyty"}},{id:"est",la:{abbr:"Est",name:"Esther"},en:{abbr:"Est",name:"Esther"},de:{abbr:"Est",name:"Ester"},pl:{abbr:"Est",name:"Księga Estery"}},{id:"1macc",la:{abbr:"1 Macc",name:"I Maccabaeorum"},en:{abbr:"1 Mc",name:"1 Maccabees"},de:{abbr:"1 Makk",name:"1 Makkabäer"},pl:{abbr:"1 Mch",name:"1 Księga Machabejska"}},{id:"2macc",la:{abbr:"2 Macc",name:"II Maccabaeorum"},en:{abbr:"2 Mc",name:"2 Maccabees"},de:{abbr:"2 Makk",name:"2 Makkabäer"},pl:{abbr:"2 Mch",name:"2 Księga Machabejska"}},{id:"iob",la:{abbr:"Iob",name:"Iob"},en:{abbr:"Job",name:"Job"},de:{abbr:"Ijob",name:"Ijob"},pl:{abbr:"Hi",name:"Księga Hioba"}},{id:"ps",la:{abbr:"Ps",name:"Psalmi"},en:{abbr:"Ps",name:"Psalms"},de:{abbr:"Ps",name:"Psalmen"},pl:{abbr:"Ps",name:"Księga Psalmów"}},{id:"prov",la:{abbr:"Prov",name:"Proverbia"},en:{abbr:"Prov",name:"Proverbs"},de:{abbr:"Spr",name:"Sprichwörter"},pl:{abbr:"Prz",name:"Księga Przysłów"}},{id:"ecc",la:{abbr:"Ecc",name:"Ecclesiastes"},en:{abbr:"Eccl",name:"Ecclesiastes"},de:{abbr:"Koh",name:"Kohelet"},pl:{abbr:"Koh",name:"Księga Koheleta"}},{id:"cant",la:{abbr:"Cant",name:"Canticum Canticorum"},en:{abbr:"Song",name:"Song of Songs"},de:{abbr:"Hld",name:"Hoheslied"},pl:{abbr:"Pnp",name:"Pieśń nad Pieśniami"}},{id:"sap",la:{abbr:"Sap",name:"Sapientia"},en:{abbr:"Wis",name:"Wisdom"},de:{abbr:"Weish",name:"Weisheit"},pl:{abbr:"Mdr",name:"Księga Mądrości"}},{id:"sir",la:{abbr:"Sir",name:"Ecclesiasticus (Sirach)"},en:{abbr:"Sir",name:"Sirach"},de:{abbr:"Sir",name:"Jesus Sirach"},pl:{abbr:"Syr",name:"Mądrość Syracha"}},{id:"isa",la:{abbr:"Isa",name:"Isaias"},en:{abbr:"Isa",name:"Isaiah"},de:{abbr:"Jes",name:"Jesaja"},pl:{abbr:"Iz",name:"Księga Izajasza"}},{id:"ier",la:{abbr:"Ier",name:"Ieremias"},en:{abbr:"Jer",name:"Jeremiah"},de:{abbr:"Jer",name:"Jeremia"},pl:{abbr:"Jr",name:"Księga Jeremiasza"}},{id:"lam",la:{abbr:"Lam",name:"Lamentationes"},en:{abbr:"Lam",name:"Lamentations"},de:{abbr:"Klgl",name:"Klagelieder"},pl:{abbr:"Lm",name:"Lamentacje"}},{id:"bar",la:{abbr:"Bar",name:"Baruch"},en:{abbr:"Bar",name:"Baruch"},de:{abbr:"Bar",name:"Baruch"},pl:{abbr:"Ba",name:"Księga Barucha"}},{id:"ez",la:{abbr:"Ez",name:"Ezechiel"},en:{abbr:"Ezek",name:"Ezekiel"},de:{abbr:"Ez",name:"Ezechiel"},pl:{abbr:"Ez",name:"Księga Ezechiela"}},{id:"dan",la:{abbr:"Dan",name:"Daniel"},en:{abbr:"Dan",name:"Daniel"},de:{abbr:"Dan",name:"Daniel"},pl:{abbr:"Dn",name:"Księga Daniela"}},{id:"hos",la:{abbr:"Hos",name:"Osee"},en:{abbr:"Hos",name:"Hosea"},de:{abbr:"Hos",name:"Hosea"},pl:{abbr:"Oz",name:"Księga Ozeasza"}},{id:"ioel",la:{abbr:"Ioel",name:"Ioel"},en:{abbr:"Joel",name:"Joel"},de:{abbr:"Joel",name:"Joel"},pl:{abbr:"Jl",name:"Księga Joela"}},{id:"amos",la:{abbr:"Amos",name:"Amos"},en:{abbr:"Am",name:"Amos"},de:{abbr:"Am",name:"Amos"},pl:{abbr:"Am",name:"Księga Amosa"}},{id:"abd",la:{abbr:"Abd",name:"Abdias"},en:{abbr:"Obad",name:"Obadiah"},de:{abbr:"Obd",name:"Obadja"},pl:{abbr:"Abd",name:"Księga Abdiasza"}},{id:"ion",la:{abbr:"Ion",name:"Ionas"},en:{abbr:"Jon",name:"Jonah"},de:{abbr:"Jona",name:"Jona"},pl:{abbr:"Jon",name:"Księga Jonasza"}},{id:"mich",la:{abbr:"Mich",name:"Michaeas"},en:{abbr:"Mic",name:"Micah"},de:{abbr:"Mi",name:"Micha"},pl:{abbr:"Mi",name:"Księga Micheasza"}},{id:"nah",la:{abbr:"Nah",name:"Nahum"},en:{abbr:"Nah",name:"Nahum"},de:{abbr:"Nah",name:"Nahum"},pl:{abbr:"Na",name:"Księga Nahuma"}},{id:"hab",la:{abbr:"Hab",name:"Habacuc"},en:{abbr:"Hab",name:"Habakkuk"},de:{abbr:"Hab",name:"Habakuk"},pl:{abbr:"Ha",name:"Księga Habakuka"}},{id:"soph",la:{abbr:"Soph",name:"Sophonias"},en:{abbr:"Zeph",name:"Zephaniah"},de:{abbr:"Zef",name:"Zefanja"},pl:{abbr:"So",name:"Księga Sofoniasza"}},{id:"agg",la:{abbr:"Agg",name:"Aggaeus"},en:{abbr:"Hag",name:"Haggai"},de:{abbr:"Hag",name:"Haggai"},pl:{abbr:"Ag",name:"Księga Aggeusza"}},{id:"zach",la:{abbr:"Zach",name:"Zacharias"},en:{abbr:"Zech",name:"Zechariah"},de:{abbr:"Sach",name:"Sacharja"},pl:{abbr:"Za",name:"Księga Zachariasza"}},{id:"mal",la:{abbr:"Mal",name:"Malachias"},en:{abbr:"Mal",name:"Malachi"},de:{abbr:"Mal",name:"Maleachi"},pl:{abbr:"Ml",name:"Księga Malachiasza"}},{id:"mt",la:{abbr:"Mt",name:"Matthaeus"},en:{abbr:"Matt",name:"Matthew"},de:{abbr:"Mt",name:"Matthäus"},pl:{abbr:"Mt",name:"Ewangelia wg św. Mateusza"}},{id:"mc",la:{abbr:"Mc",name:"Marcus"},en:{abbr:"Mark",name:"Mark"},de:{abbr:"Mk",name:"Markus"},pl:{abbr:"Mk",name:"Ewangelia wg św. Marka"}},{id:"lc",la:{abbr:"Lc",name:"Lucas"},en:{abbr:"Luke",name:"Luke"},de:{abbr:"Lk",name:"Lukas"},pl:{abbr:"Łk",name:"Ewangelia wg św. Łukasza"}},{id:"io",la:{abbr:"Io",name:"Ioannes"},en:{abbr:"John",name:"John"},de:{abbr:"Joh",name:"Johannes"},pl:{abbr:"J",name:"Ewangelia wg św. Jana"}},{id:"act",la:{abbr:"Act",name:"Actus Apostolorum"},en:{abbr:"Acts",name:"Acts"},de:{abbr:"Apg",name:"Apostelgeschichte"},pl:{abbr:"Dz",name:"Dzieje Apostolskie"}},{id:"rom",la:{abbr:"Rom",name:"ad Romanos"},en:{abbr:"Rom",name:"Romans"},de:{abbr:"Röm",name:"Römer"},pl:{abbr:"Rz",name:"List do Rzymian"}},{id:"1cor",la:{abbr:"1 Cor",name:"I ad Corinthios"},en:{abbr:"1 Cor",name:"1 Corinthians"},de:{abbr:"1 Kor",name:"1 Korinther"},pl:{abbr:"1 Kor",name:"1 List do Koryntian"}},{id:"2cor",la:{abbr:"2 Cor",name:"II ad Corinthios"},en:{abbr:"2 Cor",name:"2 Corinthians"},de:{abbr:"2 Kor",name:"2 Korinther"},pl:{abbr:"2 Kor",name:"2 List do Koryntian"}},{id:"gal",la:{abbr:"Gal",name:"ad Galatas"},en:{abbr:"Gal",name:"Galatians"},de:{abbr:"Gal",name:"Galater"},pl:{abbr:"Ga",name:"List do Galatów"}},{id:"eph",la:{abbr:"Eph",name:"ad Ephesios"},en:{abbr:"Eph",name:"Ephesians"},de:{abbr:"Eph",name:"Epheser"},pl:{abbr:"Ef",name:"List do Efezjan"}},{id:"phil",la:{abbr:"Phil",name:"ad Philippenses"},en:{abbr:"Phil",name:"Philippians"},de:{abbr:"Phil",name:"Philipper"},pl:{abbr:"Flp",name:"List do Filipian"}},{id:"col",la:{abbr:"Col",name:"ad Colossenses"},en:{abbr:"Col",name:"Colossians"},de:{abbr:"Kol",name:"Kolosser"},pl:{abbr:"Kol",name:"List do Kolosan"}},{id:"1thess",la:{abbr:"1 Thess",name:"I ad Thessalonicenses"},en:{abbr:"1 Thess",name:"1 Thessalonians"},de:{abbr:"1 Thess",name:"1 Thessalonicher"},pl:{abbr:"1 Tes",name:"1 List do Tesaloniczan"}},{id:"2thess",la:{abbr:"2 Thess",name:"II ad Thessalonicenses"},en:{abbr:"2 Thess",name:"2 Thessalonians"},de:{abbr:"2 Thess",name:"2 Thessalonicher"},pl:{abbr:"2 Tes",name:"2 List do Tesaloniczan"}},{id:"1tim",la:{abbr:"1 Tim",name:"I ad Timotheum"},en:{abbr:"1 Tim",name:"1 Timothy"},de:{abbr:"1 Tim",name:"1 Timotheus"},pl:{abbr:"1 Tm",name:"1 List do Tymoteusza"}},{id:"2tim",la:{abbr:"2 Tim",name:"II ad Timotheum"},en:{abbr:"2 Tim",name:"2 Timothy"},de:{abbr:"2 Tim",name:"2 Timotheus"},pl:{abbr:"2 Tm",name:"2 List do Tymoteusza"}},{id:"tit",la:{abbr:"Tit",name:"ad Titum"},en:{abbr:"Titus",name:"Titus"},de:{abbr:"Tit",name:"Titus"},pl:{abbr:"Tt",name:"List do Tytusa"}},{id:"phlm",la:{abbr:"Phlm",name:"ad Philemonem"},en:{abbr:"Phlm",name:"Philemon"},de:{abbr:"Phlm",name:"Philemon"},pl:{abbr:"Flm",name:"List do Filemona"}},{id:"heb",la:{abbr:"Heb",name:"ad Hebraeos"},en:{abbr:"Heb",name:"Hebrews"},de:{abbr:"Hebr",name:"Hebräer"},pl:{abbr:"Hbr",name:"List do Hebrajczyków"}},{id:"iac",la:{abbr:"Iac",name:"Iacobi"},en:{abbr:"Jas",name:"James"},de:{abbr:"Jak",name:"Jakobus"},pl:{abbr:"Jk",name:"List św. Jakuba"}},{id:"1pet",la:{abbr:"1 Pet",name:"I Petri"},en:{abbr:"1 Pet",name:"1 Peter"},de:{abbr:"1 Petr",name:"1 Petrus"},pl:{abbr:"1 P",name:"1 List św. Piotra"}},{id:"2pet",la:{abbr:"2 Pet",name:"II Petri"},en:{abbr:"2 Pet",name:"2 Peter"},de:{abbr:"2 Petr",name:"2 Petrus"},pl:{abbr:"2 P",name:"2 List św. Piotra"}},{id:"1io",la:{abbr:"1 Io",name:"I Ioannis"},en:{abbr:"1 John",name:"1 John"},de:{abbr:"1 Joh",name:"1 Johannes"},pl:{abbr:"1 J",name:"1 List św. Jana"}},{id:"2io",la:{abbr:"2 Io",name:"II Ioannis"},en:{abbr:"2 John",name:"2 John"},de:{abbr:"2 Joh",name:"2 Johannes"},pl:{abbr:"2 J",name:"2 List św. Jana"}},{id:"3io",la:{abbr:"3 Io",name:"III Ioannis"},en:{abbr:"3 John",name:"3 John"},de:{abbr:"3 Joh",name:"3 Johannes"},pl:{abbr:"3 J",name:"3 List św. Jana"}},{id:"iud",la:{abbr:"Iud",name:"Iudae"},en:{abbr:"Jude",name:"Jude"},de:{abbr:"Jud",name:"Judas"},pl:{abbr:"Jud",name:"List św. Judy"}},{id:"apoc",la:{abbr:"Apoc",name:"Apocalypsis Ioannis"},en:{abbr:"Rev",name:"Revelation"},de:{abbr:"Offb",name:"Offenbarung"},pl:{abbr:"Ap",name:"Apokalipsa św. Jana"}}],Qs=8;function Hs({libraryId:t,copy:a,language:s,sourceKindOptions:i,value:l,onChange:h,labels:o}){const[f,g]=n.useState(!1),[j,u]=n.useState(-1),v=n.useMemo(()=>{const m=s;return Js.map(k=>{var y;const S=(k==null?void 0:k[m])??(k==null?void 0:k.en)??(k==null?void 0:k.la);return{label:`${S.abbr} — ${S.name}`,latin:((y=k==null?void 0:k.la)==null?void 0:y.abbr)??S.abbr}})},[s]),r=(m,k=!1)=>{const S=m.trim().toLowerCase();return S?v.filter(w=>w.label.toLowerCase().includes(S)).slice(0,Qs):k?v.slice(0,Qs):[]},c=(m,k)=>{const S=m.trim().toLowerCase();if(!S)return null;const w=Js;for(const y of w){const Q=y==null?void 0:y.la,R=(y==null?void 0:y[k])??(y==null?void 0:y.en)??Q,b=(R==null?void 0:R.abbr)??"",P=(R==null?void 0:R.name)??"";if(b.toLowerCase()===S||P.toLowerCase()===S||`${b} — ${P}`.toLowerCase()===S)return{book:y,entry:R,la:Q}}return null};n.useEffect(()=>{if(l.sourceKind==="bible"&&l.locatorValue&&!f){const m=c(l.locatorValue,s);if(m){const k=`${m.entry.abbr} — ${m.entry.name}`;k!==l.bibleBookDisplay&&h({...l,bibleBookDisplay:k})}}},[s,l,f,h]);const E=m=>h({...l,...m});return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.sourceKindLabel}),e.jsx("select",{value:l.sourceKind,onChange:m=>E({sourceKind:m.target.value,churchDocument:null,bookMedia:null,work:null,locatorValue:"",locatorAux:"",bibleBookDisplay:""}),children:i.map(m=>e.jsx("option",{value:m.value,children:m.label},m.value))})]}),l.sourceKind==="bible"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-lookup full",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.bibleBookLabel}),e.jsx("input",{type:"text",value:l.bibleBookDisplay,onChange:m=>{const k=m.target.value;E({bibleBookDisplay:k,locatorValue:""}),g(!0),u(-1)},onKeyDown:m=>{var S;const k=r(l.bibleBookDisplay);if(k.length){if(m.key==="ArrowDown")m.preventDefault(),u(w=>Math.min(w+1,k.length-1));else if(m.key==="ArrowUp")m.preventDefault(),u(w=>Math.max(w-1,0));else if((m.key==="Enter"||m.key==="Tab")&&j>=0&&k[j]){const w=k[j],y=c(w.label,s);if(!y)return;E({bibleBookDisplay:w.label,locatorValue:((S=y.la)==null?void 0:S.abbr)??l.locatorValue}),g(!1)}}},onFocus:()=>g(!0),onBlur:()=>window.setTimeout(()=>g(!1),100),placeholder:o.bibleBookPlaceholder})]}),f&&r(l.bibleBookDisplay,!0).length>0&&e.jsx("div",{className:"cogita-lookup-results",children:r(l.bibleBookDisplay,!0).map((m,k)=>e.jsx("button",{type:"button",className:"cogita-lookup-option","data-active":k===j,tabIndex:-1,onMouseDown:()=>{var w;const S=c(m.label,s);S&&E({bibleBookDisplay:m.label,locatorValue:((w=S.la)==null?void 0:w.abbr)??l.locatorValue})},children:e.jsx("strong",{children:m.label})},m.latin))})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.bibleRestLabel}),e.jsx("input",{type:"text",value:l.locatorAux,onChange:m=>E({locatorAux:m.target.value}),placeholder:o.bibleRestPlaceholder})]})]}),l.sourceKind==="website"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:a.cogita.library.add.info.sourceUrlLabel}),e.jsx("input",{type:"text",value:l.sourceUrl,onChange:m=>E({sourceUrl:m.target.value}),placeholder:a.cogita.library.add.info.sourceUrlPlaceholder})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:a.cogita.library.add.info.sourceAccessedDateLabel}),e.jsx("input",{type:"text",value:l.sourceAccessedDate,onChange:m=>E({sourceAccessedDate:m.target.value}),placeholder:a.cogita.library.add.info.sourceAccessedDatePlaceholder})]})]}),l.sourceKind==="number_document"&&e.jsxs(e.Fragment,{children:[e.jsx(va,{libraryId:t,infoType:"work",label:o.churchDocumentLabel,placeholder:o.churchDocumentPlaceholder,value:l.churchDocument,onChange:m=>E({churchDocument:m}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.work),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.locatorLabel}),e.jsx("input",{type:"text",value:l.locatorValue,onChange:m=>E({locatorValue:m.target.value}),placeholder:o.locatorPlaceholder})]})]}),l.sourceKind==="work"&&e.jsx(va,{libraryId:t,infoType:"work",label:o.workLabel,placeholder:o.workPlaceholder,value:l.work,onChange:m=>E({work:m}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.work),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),l.sourceKind==="book"&&e.jsxs(e.Fragment,{children:[e.jsx(va,{libraryId:t,infoType:"media",label:o.bookLabel,placeholder:o.bookPlaceholder,value:l.bookMedia,onChange:m=>E({bookMedia:m}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.media),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.locatorLabel}),e.jsx("input",{type:"text",value:l.locatorValue,onChange:m=>E({locatorValue:m.target.value}),placeholder:o.locatorPlaceholder})]})]}),l.sourceKind!=="website"&&l.sourceKind!=="bible"&&l.sourceKind!=="book"&&l.sourceKind!=="number_document"&&e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.locatorLabel}),e.jsx("input",{type:"text",value:l.locatorValue,onChange:m=>E({locatorValue:m.target.value}),placeholder:o.locatorPlaceholder})]})]})}const Ya=JSON.stringify({type:"selection",title:"Question title",question:"Question text",options:["Option A","Option B","Option C"],answer:[0]},null,2);function pn(t="selection"){return t==="matching"?{type:t,title:"",question:"",columns:[[""],[""]],answer:{paths:[]},matchingPaths:[["",""]]}:t==="ordering"?{type:t,title:"",question:"",options:[""]}:t==="truefalse"?{type:t,title:"",question:"",answer:!0}:t==="text"||t==="date"?{type:t,title:"",question:"",answer:""}:t==="number"?{type:t,title:"",question:"",answer:""}:{type:t,title:"",question:"",options:[""],answer:[]}}function eo(t){return["selection","truefalse","text","number","date","matching","ordering"].includes(t)}function qa(t){if(!t||typeof t!="object")return null;const a=t,s=typeof a.type=="string"?a.type:typeof a.kind=="string"?a.kind:"selection",i=s==="multi_select"||s==="single_select"?"selection":s==="boolean"?"truefalse":s==="order"?"ordering":s==="short"||s==="open"||s==="short_text"?"text":s,l=eo(i)?i:"selection",h=typeof a.title=="string"?a.title:"",o=typeof a.question=="string"?a.question:"";if(l==="matching"){let j=[];Array.isArray(a.columns)?j=a.columns.map(m=>Array.isArray(m)?m.map(k=>typeof k=="string"?k:""):[""]):Array.isArray(a.left)&&Array.isArray(a.right)&&(j=[a.left.map(m=>typeof m=="string"?m:""),a.right.map(m=>typeof m=="string"?m:"")]),j.length<2&&(j=[[""],[""]]);const u=a.answer&&typeof a.answer=="object"?a.answer:null,r=(Array.isArray(u==null?void 0:u.paths)?u==null?void 0:u.paths:Array.isArray(a.correctPairs)?a.correctPairs:[]).map(m=>Array.isArray(m)?m.map(k=>Number(k)).filter(k=>Number.isInteger(k)&&k>=0):[]).filter(m=>m.length>0),c=Array.isArray(a.matchingPaths)?a.matchingPaths.map(m=>Array.isArray(m)?Array.from({length:j.length},(k,S)=>String(m[S]??"")):new Array(j.length).fill("")):null,E=c&&c.length>0?c:[...r.map(m=>m.map(String)),new Array(j.length).fill("")];return{type:l,title:h,question:o,columns:j,answer:{paths:r},matchingPaths:E}}if(l==="ordering"){const j=Array.isArray(a.options)?a.options.map(u=>typeof u=="string"?u:""):Array.isArray(a.items)?a.items.map(u=>typeof u=="string"?u:""):[""];return{type:l,title:h,question:o,options:j.length?j:[""]}}if(l==="truefalse"){const j=typeof a.answer=="boolean"?a.answer:typeof a.expected=="boolean"?a.expected:!0;return{type:l,title:h,question:o,answer:j}}if(l==="number")return typeof a.answer=="number"?{type:l,title:h,question:o,answer:a.answer}:typeof a.answer=="string"?{type:l,title:h,question:o,answer:a.answer}:typeof a.expected=="number"?{type:l,title:h,question:o,answer:a.expected}:{type:l,title:h,question:o,answer:""};if(l==="text"||l==="date"){const j=typeof a.answer=="string"?a.answer:typeof a.expected=="string"?a.expected:"";return{type:l,title:h,question:o,answer:j}}const f=Array.isArray(a.options)?a.options.map(j=>typeof j=="string"?j:""):[""],g=Array.isArray(a.answer)?a.answer.map(j=>Number(j)).filter(j=>Number.isInteger(j)&&j>=0):Array.isArray(a.correct)?a.correct.map(j=>Number(j)).filter(j=>Number.isInteger(j)&&j>=0):[];return{type:l,title:h,question:o,options:f.length?f:[""],answer:g}}function Wn(t){const a=(t.title??"").trim(),s=(t.question??"").trim();switch(t.type){case"matching":{const i=(t.columns??[[""],[""]]).map(v=>v.map(r=>r.trim()).filter(Boolean)).filter(v=>v.length>0),l=i.length>=2?i:[[""],[""]],h=t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[],o=(t.matchingPaths??[]).map(v=>v.map(r=>String(r??""))),f=l.length,g=o.map(v=>v.slice(0,f).map(r=>r.trim())).filter(v=>v.some(Boolean)).map(v=>v.map(r=>Number(r))).filter(v=>v.length===f&&v.every(r=>Number.isInteger(r)&&r>=0)),j=(Array.isArray(h)?h:[]).map(v=>Array.isArray(v)?v.map(r=>Number(r)).filter(r=>Number.isInteger(r)&&r>=0):[]).filter(v=>v.length===f),u=Array.from(new Set([...j,...g].map(v=>JSON.stringify(v)))).map(v=>JSON.parse(v));return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,columns:l,answer:{paths:u}},null,2)}case"ordering":{const i=(t.options??[]).map(l=>l.trim()).filter(Boolean);return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,options:i},null,2)}case"truefalse":return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,answer:!!t.answer},null,2);case"number":return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,answer:typeof t.answer=="number"||typeof t.answer=="string"?t.answer:""},null,2);case"date":case"text":return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,answer:String(t.answer??"")},null,2);case"selection":default:{const i=(t.options??[]).map(o=>o.trim()).filter(Boolean),l=Array.isArray(t.answer)?t.answer:[],h=Array.from(new Set(l.filter(o=>Number.isInteger(o)&&o>=0&&o<i.length))).sort((o,f)=>o-f);return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,options:i,answer:h},null,2)}}}const Ws=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}];function Za(){return{sourceKind:"string",locatorValue:"",locatorAux:"",bibleBookDisplay:"",sourceUrl:"",sourceAccessedDate:"",churchDocument:null,bookMedia:null,work:null}}function Gs(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function Ys(t,a){if(!t||typeof t!="object")return a;const s=t,i=s.definition&&typeof s.definition=="object"?s.definition:null,l=[s.label,s.name,s.title,s.text,s.orcid,s.email,s.number];i&&l.unshift(i.title,i.question);for(const h of l)if(typeof h=="string"&&h.trim())return h.trim();return a}function Xs(t,a){var i;if(!(t instanceof js))return a;const s=(i=t.message)==null?void 0:i.trim();if(!s)return a;try{const l=JSON.parse(s);if(typeof l.error=="string"&&l.error.trim())return l.error.trim()}catch{}return s}function to(t){const a=t.trim();if(!a)return null;try{const s=JSON.parse(a);return s&&typeof s=="object"&&!Array.isArray(s)?s:null}catch{return null}}function ga(t,a){const s=t==null?void 0:t[a];return typeof s=="string"?s:""}function ao(t,a){return a?t==="book"&&a.infoType==="media"?{bookMedia:a}:t==="work"&&a.infoType==="work"?{work:a}:t==="number_document"&&a.infoType==="work"?{churchDocument:a}:{}:{}}function no(t,a){const s=Za(),i=(t.sourceKind??"").trim()||s.sourceKind,l=t.locator??"",h=to(l);let o="",f="",g="",j="",u="";return i==="website"?(j=ga(h,"url"),u=ga(h,"accessedDate"),o=ga(h,"value")):i==="bible"?(o=ga(h,"book")||l.trim(),f=ga(h,"passage")||ga(h,"rest"),g=ga(h,"bookDisplay")):h?(o=ga(h,"value")||ga(h,"locator"),f=ga(h,"aux")):o=l,{...s,sourceKind:i,locatorValue:o,locatorAux:f,bibleBookDisplay:g,sourceUrl:j,sourceAccessedDate:u,...ao(i,a)}}function Gn(t){return t.sourceKind==="book"?t.bookMedia:t.sourceKind==="work"?t.work:t.sourceKind==="number_document"?t.churchDocument:null}function Yn(t){const a=t.locatorValue.trim(),s=t.locatorAux.trim(),i=t.sourceUrl.trim(),l=t.sourceAccessedDate.trim();switch(t.sourceKind){case"website":return{url:i,accessedDate:l};case"bible":return{book:a,bookDisplay:t.bibleBookDisplay.trim(),passage:s};case"book":case"work":case"number_document":return s?{value:a,aux:s}:a;default:return s?{value:a,aux:s}:a}}function Zs(t){var l,h,o;const a=t.locatorValue.trim(),s=t.locatorAux.trim(),i=[a,s].filter(Boolean).join(" ");switch(t.sourceKind){case"website":return t.sourceUrl.trim()||"website";case"bible":return i||"bible";case"book":return[(l=t.bookMedia)==null?void 0:l.label,i].filter(Boolean).join(" · ")||"book";case"work":return[(h=t.work)==null?void 0:h.label,i].filter(Boolean).join(" · ")||"work";case"number_document":return[(o=t.churchDocument)==null?void 0:o.label,i].filter(Boolean).join(" · ")||"number_document";default:return i||t.sourceKind||"source"}}function ei(t){return t.sourceKind.trim()?t.sourceKind==="website"?!!t.sourceUrl.trim():t.sourceKind==="bible"?!!(t.locatorValue.trim()&&t.locatorAux.trim()):t.sourceKind==="book"?!!t.bookMedia:t.sourceKind==="work"?!!t.work:t.sourceKind==="number_document"?!!(t.churchDocument&&t.locatorValue.trim()):!!t.locatorValue.trim():!1}function so({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,libraryId:u,editInfoId:v}){var je,we,Me;const{libraryName:r}=rn(u),c=!!v,[E,m]=n.useState([]),[k,S]=n.useState("word"),[w,y]=n.useState({}),[Q,R]=n.useState({}),[b,P]=n.useState({}),[_,re]=n.useState({}),[C,z]=n.useState(null),[A,ne]=n.useState("idle"),[ke,Le]=n.useState(Za),[$e,de]=n.useState({}),[ge,M]=n.useState({}),[ae,Ve]=n.useState({}),[Se,oe]=n.useState(null),[H,Oe]=n.useState(()=>qa(JSON.parse(Ya))??pn()),[W,ze]=n.useState(Ya),[Te,Ee]=n.useState([]),[st,D]=n.useState(0),he=n.useMemo(()=>E.find($=>$.infoType===k),[k,E]),Ye=n.useMemo(()=>E.find($=>$.infoType==="source"),[E]),U=n.useMemo(()=>E.map($=>({value:$.infoType,label:ft(t,$.infoType)})),[t,E]),qe=$=>{const K=qa($)??pn(),q=Wn(K);Oe(K),y(J=>({...J,definition:q}))};n.useEffect(()=>{let $=!1;return Qi({libraryId:u}).then(K=>{var q;if(!$&&(m(K),!c)){const J=(q=K[0])==null?void 0:q.infoType;J&&S(J)}}).catch(()=>{$||m([])}),()=>{$=!0}},[c,u]),n.useEffect(()=>{if(c||!he)return;const $={},K={},q={},J={};for(const G of he.payloadFields)he.infoType==="question"&&G.key==="definition"&&G.inputType==="json"?$[G.key]=Ya:$[G.key]="";for(const G of he.linkFields)G.multiple?q[G.key]=[]:K[G.key]=null,G.targetTypes.length>0&&(J[G.key]=G.targetTypes[0]);y($),R(K),P(q),re(J)},[he==null?void 0:he.infoType,c]),n.useEffect(()=>{if(k!=="question")return;const $=w.definition??"";if(!$.trim()){const K=qa(JSON.parse(Ya))??pn();Oe(K),ze(Ya);return}try{const K=JSON.parse($),q=qa(K);if(!q)return;Oe(q),Te.length===0&&ze(JSON.stringify(K,null,2))}catch{}},[w.definition,Te.length,k]),n.useEffect(()=>{if(!c||!v||E.length===0)return;let $=!1;return ne("loading"),z(null),(async()=>{const q=await la({libraryId:u,infoId:v});if($)return;const J=q.infoType;S(J);const G=E.find(ye=>ye.infoType===J);if(!G){ne("idle");return}const ce=q.payload??{},I={};for(const ye of G.payloadFields)I[ye.key]=Gs(ce[ye.key]);y(I);const N=q.links??{}??{},Z={},F={},B={},te=[];for(const ye of G.linkFields){ye.targetTypes.length>0&&(B[ye.key]=ye.targetTypes[0]);const le=N[ye.key];if(ye.multiple){const pe=Array.isArray(le)?le.filter(Re=>typeof Re=="string"):[];F[ye.key]=[];for(const Re of pe)te.push(la({libraryId:u,infoId:Re}).then(nt=>{if($)return;const rt={id:Re,infoType:nt.infoType,label:Ys(nt.payload,Re)};B[ye.key]=rt.infoType,F[ye.key]=[...F[ye.key],rt]}).catch(()=>{}))}else{const pe=typeof le=="string"?le:null;Z[ye.key]=null,pe&&te.push(la({libraryId:u,infoId:pe}).then(Re=>{if($)return;const nt={id:pe,infoType:Re.infoType,label:Ys(Re.payload,pe)};B[ye.key]=nt.infoType,Z[ye.key]=nt}).catch(()=>{}))}}await Promise.all(te),!$&&(R(Z),P(F),re(B),ne("idle"))})().catch(()=>{$||(z("Failed to load info details."),ne("idle"))}),()=>{$=!0}},[v,c,u,E]),n.useEffect(()=>{k==="source"&&Le(no(w,Q.resource??null))},[k,w.sourceKind,w.locator,(je=Q.resource)==null?void 0:je.id,(we=Q.resource)==null?void 0:we.infoType,(Me=Q.resource)==null?void 0:Me.label]);const at=$=>{var G,ce;const K=((G=Ye==null?void 0:Ye.payloadFields.find(I=>I.key==="sourceKind"))==null?void 0:G.keepOnCreate)??!1,q=((ce=Ye==null?void 0:Ye.linkFields.find(I=>I.key==="resource"))==null?void 0:ce.keepOnCreate)??!1,J=Za();return J.sourceKind=K?$.sourceKind:J.sourceKind,q&&(J.work=$.work,J.bookMedia=$.bookMedia,J.churchDocument=$.churchDocument),K&&$.sourceKind==="bible"&&(J.locatorValue=$.locatorValue,J.bibleBookDisplay=$.bibleBookDisplay),K&&$.sourceKind==="website"&&(J.sourceUrl=$.sourceUrl,J.sourceAccessedDate=$.sourceAccessedDate),J},wt=n.useMemo(()=>({sourceKindLabel:t.cogita.library.add.info.sourceKindLabel,bibleBookLabel:t.cogita.library.add.info.sourceBibleBookLabel,bibleBookPlaceholder:t.cogita.library.add.info.sourceBibleBookPlaceholder,bibleRestLabel:t.cogita.library.add.info.sourceBibleRestLabel,bibleRestPlaceholder:t.cogita.library.add.info.sourceBibleRestPlaceholder,churchDocumentLabel:t.cogita.library.add.info.sourceResourceLabel,churchDocumentPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,workLabel:t.cogita.library.add.info.sourceResourceLabel,workPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,bookLabel:t.cogita.library.add.info.sourceResourceLabel,bookPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,locatorLabel:t.cogita.library.list.typeFilterLocator,locatorPlaceholder:t.cogita.library.list.typeFilterLocator}),[t]),yt=async $=>{const K=ge[$]??Za();if(!ei(K)){Ve(q=>({...q,[$]:t.cogita.library.add.info.referenceMissingSource}));return}oe($),Ve(q=>({...q,[$]:null}));try{const q=Gn(K),J=q?{resource:q.id}:{},G={label:Zs(K),sourceKind:K.sourceKind.trim(),locator:Yn(K)},I={id:(await ls({libraryId:u,infoType:"source",payload:G,links:J})).infoId,infoType:"source",label:G.label};if(P(N=>{const Z=N[$]??[];return Z.some(F=>F.id===I.id)?N:{...N,[$]:[...Z,I]}}),c&&v){const N=await la({libraryId:u,infoId:v}),Z=N.links&&typeof N.links=="object"?{...N.links}:{},F=Z[$],B=Array.isArray(F)?F.filter(te=>typeof te=="string"):typeof F=="string"?[F]:[];B.includes(I.id)||(Z[$]=[...B,I.id],await $s({libraryId:u,infoId:v,payload:N.payload,links:Z}))}M(N=>({...N,[$]:at(K)})),Ve(N=>({...N,[$]:null}))}catch(q){Ve(J=>({...J,[$]:Xs(q,t.cogita.library.lookup.createFailed)}))}finally{oe(q=>q===$?null:q)}},Fe=async()=>{var q;if(!he)return;const $={};for(const J of he.payloadFields){if(k==="source"&&(J.key==="sourceKind"||J.key==="locator"))continue;const G=(w[J.key]??"").trim();if(!G){if(J.required){z(`Field '${J.label}' is required.`);return}continue}if(J.inputType==="json")try{$[J.key]=JSON.parse(G)}catch{z(`Field '${J.label}' must be valid JSON.`);return}else $[J.key]=G}const K={};for(const J of he.linkFields)if(!(k==="source"&&J.key==="resource"))if(J.multiple){const G=(b[J.key]??[]).map(ce=>ce.id);if(J.required&&G.length===0){z(`Link '${J.label}' is required.`);return}G.length>0&&(K[J.key]=G)}else{const G=((q=Q[J.key])==null?void 0:q.id)??null;if(J.required&&!G){z(`Link '${J.label}' is required.`);return}G&&(K[J.key]=G)}if(k==="source"){if(!ei(ke)){z(t.cogita.library.add.info.referenceMissingSource);return}const J=ke.sourceKind.trim();$.sourceKind=J,$.locator=Yn(ke),(typeof $.label!="string"||!$.label.trim())&&($.label=Zs(ke));const G=Gn(ke);G&&(K.resource=G.id)}ne("saving"),z(null);try{if(c&&v)await $s({libraryId:u,infoId:v,payload:$,links:K}),z("Info updated.");else{await ls({libraryId:u,infoType:k,payload:$,links:K});const J=k==="question"&&Te.length>0&&st<Te.length-1;if(J){const N=st+1,Z=Te[N]??null;if(Z){const F=Wn(Z);D(N),Oe(Z),y(B=>({...B,definition:F})),z(`Info saved. Loaded next question (${N+1}/${Te.length}).`)}else z("Info saved.")}else k==="question"&&Te.length>0&&(Ee([]),D(0)),z("Info saved.");const G={};for(const N of he.payloadFields)G[N.key]=N.keepOnCreate?w[N.key]??"":"";if(J){const N=Te[Math.min(st+1,Te.length-1)];N&&(G.definition=Wn(N))}y(G);const ce={},I={};for(const N of he.linkFields)N.multiple?I[N.key]=N.keepOnCreate?b[N.key]??[]:[]:ce[N.key]=N.keepOnCreate?Q[N.key]??null:null;R(N=>({...N,...ce})),P(N=>({...N,...I})),k==="source"&&Le(N=>{const Z=at(N),F=Gn(Z);return y(B=>({...B,sourceKind:Z.sourceKind,locator:Gs(Yn(Z))})),R(B=>({...B,resource:F})),F&&re(B=>({...B,resource:F.infoType})),Z})}}catch(J){z(Xs(J,"Failed to save info."))}finally{ne("idle")}},ve=$=>{const K=w[$.key]??"";if(k==="question"&&$.key==="definition"&&$.inputType==="json"){const J=H.type,G=te=>{const ye=H.title??"",le=H.question??"";qe({...pn(te),title:ye,question:le})},ce=te=>te.length===0?[""]:te[te.length-1].trim()?[...te,""]:te,I=te=>{const ye=(te.length?te:[[""],[""]]).map(le=>ce(le));return ye.length>=2?ye:[...ye,[""]]},N=(te,ye)=>{const le=te.map(Re=>Array.from({length:ye},(nt,rt)=>Re[rt]??"")).filter(Re=>Re.some(nt=>nt.trim())||Re===te[te.length-1]);return le.length===0?[new Array(ye).fill("")]:le[le.length-1].some(Re=>Re.trim())?[...le,new Array(ye).fill("")]:le},Z=Array.isArray(H.answer)?H.answer:[],F=I(H.columns??[[""],[""]]),B=N(H.matchingPaths??[[]],F.length);return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:$.label}),e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.8rem"},children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question type"}),e.jsxs("select",{value:J,onChange:te=>G(te.target.value),children:[e.jsx("option",{value:"selection",children:"Selection"}),e.jsx("option",{value:"truefalse",children:"True / false"}),e.jsx("option",{value:"text",children:"Text answer"}),e.jsx("option",{value:"number",children:"Number answer"}),e.jsx("option",{value:"date",children:"Date answer"}),e.jsx("option",{value:"matching",children:"Matching"}),e.jsx("option",{value:"ordering",children:"Right order"})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Title"}),e.jsx("input",{type:"text",value:H.title??"",onChange:te=>qe({...H,title:te.target.value}),placeholder:"Optional title"})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question"}),e.jsx("textarea",{rows:3,value:H.question??"",onChange:te=>qe({...H,question:te.target.value}),placeholder:"Question text"})]}),J==="selection"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Options / correct indices"}),ce(H.options??[""]).map((te,ye,le)=>{const pe=new Set(Z.filter(nt=>Number.isInteger(nt))),Re=ye===le.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:pe.has(ye),disabled:!te.trim(),onChange:nt=>{const rt=nt.target.checked?[...pe,ye]:[...pe].filter(He=>He!==ye);qe({...H,answer:rt})}}),e.jsx("input",{type:"text",value:te,placeholder:`Answer ${ye+1}`,onChange:nt=>{const rt=[...H.options??[""]];rt[ye]=nt.target.value;const He=ce(rt),lt=He.length-1,vt=Z.filter(gt=>gt>=0&&gt<lt);qe({...H,options:He,answer:vt})}}),Re?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const rt=(H.options??[""]).filter((lt,vt)=>vt!==ye),He=Z.filter(lt=>lt!==ye).map(lt=>lt>ye?lt-1:lt);qe({...H,options:ce(rt),answer:He})},children:"Remove"})]},`question-option:${ye}`)})]}):null,J==="text"||J==="date"||J==="number"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsx("input",{type:J==="date"?"date":"text",value:typeof H.answer=="string"||typeof H.answer=="number"?String(H.answer):"",onChange:te=>qe({...H,answer:te.target.value})})]}):null,J==="truefalse"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsxs("select",{value:String(!!H.answer),onChange:te=>qe({...H,answer:te.target.value==="true"}),children:[e.jsx("option",{value:"true",children:"True"}),e.jsx("option",{value:"false",children:"False"})]})]}):null,J==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Columns"}),F.map((te,ye)=>e.jsxs("div",{style:{display:"grid",gap:"0.35rem",border:"1px solid rgba(120,170,220,0.22)",borderRadius:"0.6rem",padding:"0.55rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"0.5rem"},children:[e.jsxs("span",{style:{fontSize:"0.8rem",color:"rgba(184,209,234,0.85)"},children:["Column ",ye+1]}),F.length>2?e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const le=F.filter((Re,nt)=>nt!==ye),pe=B.map(Re=>Re.filter((nt,rt)=>rt!==ye));qe({...H,columns:I(le),matchingPaths:N(pe,Math.max(2,le.length))})},children:"Remove column"}):null]}),te.map((le,pe)=>{const Re=pe===te.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",gap:"0.4rem",alignItems:"center"},children:[e.jsx("input",{type:"text",value:le,placeholder:`Option ${pe+1}`,onChange:nt=>{const rt=F.map(He=>[...He]);rt[ye][pe]=nt.target.value,qe({...H,columns:I(rt),matchingPaths:N(B,F.length)})}}),Re?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const nt=F.map(rt=>[...rt]);nt[ye]=nt[ye].filter((rt,He)=>He!==pe),qe({...H,columns:I(nt),matchingPaths:N(B,F.length)})},children:"Remove"})]},`question-column:${ye}:row:${pe}`)})]},`question-column:${ye}`)),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{const te=[...F.map(le=>[...le]),[""]],ye=B.map(le=>[...le,""]);qe({...H,columns:I(te),matchingPaths:N(ye,te.length)})},children:"Add column"})}),e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Correct paths (0-based indices)"}),B.map((te,ye)=>{const le=ye===B.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:`repeat(${F.length}, minmax(0,1fr)) auto`,gap:"0.35rem",alignItems:"center"},children:[te.map((pe,Re)=>e.jsx("input",{type:"number",min:0,step:1,value:pe,placeholder:`${Re}`,onChange:nt=>{const rt=B.map(vt=>[...vt]);rt[ye][Re]=nt.target.value;const He=N(rt,F.length),lt=He.map(vt=>vt.map(gt=>gt.trim())).filter(vt=>vt.every(gt=>gt!=="")).map(vt=>vt.map(gt=>Number(gt))).filter(vt=>vt.every(gt=>Number.isInteger(gt)&&gt>=0));qe({...H,matchingPaths:He,answer:{paths:lt}})}},`question-path:${ye}:${Re}`)),le?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const pe=B.filter((rt,He)=>He!==ye),Re=N(pe,F.length),nt=Re.map(rt=>rt.map(He=>He.trim())).filter(rt=>rt.every(He=>He!=="")).map(rt=>rt.map(He=>Number(He))).filter(rt=>rt.every(He=>Number.isInteger(He)&&He>=0));qe({...H,matchingPaths:Re,answer:{paths:nt}})},children:"Remove"})]},`question-path:${ye}`)})]}):null,J==="ordering"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Ordered options (correct order = listed order)"}),ce(H.options??[""]).map((te,ye,le)=>{const pe=ye===le.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)",minWidth:"1.5rem"},children:[ye+1,"."]}),e.jsx("input",{type:"text",value:te,placeholder:`Step ${ye+1}`,onChange:Re=>{const nt=[...H.options??[""]];nt[ye]=Re.target.value,qe({...H,options:ce(nt)})}}),pe?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>qe({...H,options:ce((H.options??[]).filter((Re,nt)=>nt!==ye))}),children:"Remove"})]},`question-order:${ye}`)})]}):null,e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"JSON import"}),e.jsx("textarea",{rows:8,value:W,onChange:te=>ze(te.target.value),placeholder:"Paste question JSON"}),e.jsxs("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:[e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{try{const te=JSON.parse(W);if(Array.isArray(te)){const le=te.map(Re=>qa(Re)).filter(Re=>!!Re);if(le.length===0){z("Question JSON array must contain at least one valid question object.");return}const pe=le[0];Ee(le),D(0),qe(pe),z(`Loaded question array (${le.length} items).`);return}const ye=qa(te);if(!ye){z("Question JSON must be an object or an array of question objects.");return}Ee([]),D(0),qe(ye),z(null)}catch{z("Question JSON is invalid.")}},children:"Interpret JSON"}),Te.length>0?e.jsxs("span",{className:"cogita-library-hint",children:["Queue: ",Math.min(st+1,Te.length)," / ",Te.length]}):null]})]})]})]},`payload:${$.key}`)}const q=$.inputType==="textarea"||$.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:$.label}),q?e.jsx("textarea",{rows:$.inputType==="json"?8:4,value:K,onChange:J=>y(G=>({...G,[$.key]:J.target.value})),placeholder:$.key}):e.jsx("input",{type:"text",value:K,onChange:J=>y(G=>({...G,[$.key]:J.target.value})),placeholder:$.key})]},`payload:${$.key}`)},Je=$=>{const K=_[$.key]??$.targetTypes[0],q=$.key==="references"&&$.multiple&&$.targetTypes.includes("source"),J=ge[$.key]??Za(),G=$e[$.key]??!1,ce=ae[$.key];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:$.label}),$.targetTypes.length>1?e.jsx("select",{value:K,onChange:I=>re(N=>({...N,[$.key]:I.target.value})),children:$.targetTypes.map(I=>e.jsx("option",{value:I,children:ft(t,I)},`${$.key}:${I}`))}):null,$.multiple?e.jsx(va,{libraryId:u,infoType:K,label:$.label,placeholder:$.key,multiple:!0,values:b[$.key]??[],onChangeMultiple:I=>P(N=>({...N,[$.key]:I})),allowCreate:!q,searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(va,{libraryId:u,infoType:K,label:$.label,placeholder:$.key,value:Q[$.key]??null,onChange:I=>R(N=>({...N,[$.key]:I})),searchFailedText:"Search failed",createFailedText:"Create failed"}),q?e.jsxs("div",{children:[e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:G,onChange:I=>de(N=>({...N,[$.key]:I.target.checked}))}),e.jsx("span",{children:t.cogita.library.add.info.referenceToggle})]}),G?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(Hs,{libraryId:u,copy:t,language:g,sourceKindOptions:[...Ws],value:J,onChange:I=>M(N=>({...N,[$.key]:I})),labels:wt}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>yt($.key),disabled:Se===$.key,children:Se===$.key?t.cogita.library.lookup.saving:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.source)})}),ce?e.jsx("p",{className:"cogita-library-subtitle",children:ce}):null]}):null]}):null]},`link:${$.key}`)},Ue=()=>e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(Hs,{libraryId:u,copy:t,language:g,sourceKindOptions:[...Ws],value:ke,onChange:Le,labels:wt})]});return e.jsx(Ft,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:c?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:r}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${u}/infos`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[c?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:k,onChange:$=>S($.target.value),children:U.map($=>e.jsx("option",{value:$.value,children:$.label},$.value))})]}),A==="loading"&&c?e.jsx("p",{children:"Loading..."}):null,he&&!(A==="loading"&&c)?e.jsxs("div",{className:"cogita-form-grid",children:[he.payloadFields.filter($=>!(k==="source"&&($.key==="sourceKind"||$.key==="locator"))).map(ve),k==="source"?Ue():null,he.linkFields.filter($=>!(k==="source"&&$.key==="resource")).map(Je)]}):A==="loading"&&c?null:e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:Fe,disabled:A==="saving"||!he,children:A==="saving"?"Saving...":c?"Update info":"Create info"})}),C?e.jsx("p",{className:"cogita-library-subtitle",children:C}):null]})})})]})})}const ti=t=>/\s/.test(t),kn=t=>/[\p{L}\p{N}]/u.test(t),ai=(t,a)=>{const s=a>0?t[a-1]:"",i=a<t.length?t[a]:"";if(!s||!i)return 0;const l=ti(s),h=ti(i);if(l||h)return 3;const o=kn(s),f=kn(i);return o!==f?2:!o&&!f?1:0},Xn=(t,a,s,i,l)=>{const h=Math.max(i-a,s-i);for(let o=0;o<=h;o+=1){const f=i-o;if(f>=a&&f<=s&&ai(t,f)>=l)return f;const g=i+o;if(g>=a&&g<=s&&ai(t,g)>=l)return g}return null},Zn=(t,a)=>{const s=a>0?t[a-1]:"",i=a<t.length?t[a]:"";return!s||!i?!0:kn(s)!==kn(i)},io=(t,a,s,i)=>{const l=s-a,h=a+i,o=s-i;if(l<=i*2||o<=h)return null;const f=Math.floor((a+s)/2),g=Xn(t,h,o,f,3);if(g!==null&&Zn(t,g))return g;const j=Xn(t,h,o,f,2);if(j!==null&&Zn(t,j))return j;const u=Xn(t,h,o,f,1);return u!==null&&Zn(t,u)?u:null},Ia=(t,a)=>{const s=Math.max(1,(a==null?void 0:a.minLen)??7),i=Math.max(s,(a==null?void 0:a.maxLen)??13),l={},h=(g,j,u,v,r)=>{const c=String(v),E={id:c,start:g,end:j,text:t.slice(g,j),depth:u,index:v,parentId:r};if(l[c]=E,j-g>i){let k=io(t,g,j,s);if(k!==null&&k>g&&k<j){const S=h(g,k,u+1,v*2+1,c),w=h(k,j,u+1,v*2+2,c);E.leftId=S.id,E.rightId=w.id}}return E},o=h(0,t.length,0,0),f=Object.values(l).sort((g,j)=>j.depth-g.depth||g.start-j.start).map(g=>g.id);return{text:t,rootId:o.id,nodes:l,order:f}},Da=(t,a,s,i,l,h,o)=>{const f=h==="reverse"?t.order.slice().sort((g,j)=>t.nodes[j].start-t.nodes[g].start||t.nodes[j].depth-t.nodes[g].depth):t.order;for(const g of f){if(o&&g===o||a.has(g))continue;const j=t.nodes[g];if(j){if(l&&(j.leftId||j.rightId)){const u=j.leftId?s[j.leftId]??0:i,v=j.rightId?s[j.rightId]??0:i;if((u+v)/2<i)continue}return j}}return null},$n=(t,a)=>({before:t.slice(0,a.start),fragment:t.slice(a.start,a.end),after:t.slice(a.end)});function ro({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,libraryId:u}){const v=`/#/cogita/library/${u}`,[r,c,E]=pi([]),[m,k,S]=fi([]),[w,y]=n.useState(null),[Q,R]=n.useState(null),[b,P]=n.useState(null),[_,re]=n.useState(null),C=n.useMemo(()=>r.find(de=>de.id===w)??null,[r,w]);n.useEffect(()=>{let de=!0;return Hi({libraryId:u}).then(ge=>{if(!de)return;const M=ge.nodes.map(ae=>{var Ve,Se,oe;return{id:ae.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:ae.payload&&typeof ae.payload=="object"&&"label"in ae.payload?String(ae.payload.label):"Item",nodeType:ae.nodeType,itemType:((Ve=ae.payload)==null?void 0:Ve.itemType)??"info",itemId:((Se=ae.payload)==null?void 0:Se.itemId)??null,infoType:((oe=ae.payload)==null?void 0:oe.infoType)??null}}});c(M),k(ge.edges.map(ae=>({id:ae.edgeId,source:ae.fromNodeId,target:ae.toNodeId})))}).catch(()=>{de&&(c([]),k([]))}),()=>{de=!1}},[u]),n.useEffect(()=>{Wi({libraryId:u}).then(R).catch(()=>R(null))},[u,r,m]);const z=n.useCallback(de=>{k(ge=>bi(de,ge))},[]),A=()=>{const de=crypto.randomUUID();c(ge=>[...ge,{id:de,type:"default",position:{x:140+ge.length*40,y:120+ge.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},ne=()=>{const de=crypto.randomUUID();c(ge=>[...ge,{id:de,type:"default",position:{x:180+ge.length*40,y:160+ge.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},ke=async()=>{P(null);try{const de=r.map(M=>({nodeId:M.id,nodeType:M.data.nodeType,payload:{itemType:M.data.itemType,itemId:M.data.itemId??null,label:M.data.label,infoType:M.data.infoType??null}})),ge=m.map(M=>({edgeId:M.id,fromNodeId:M.source,toNodeId:M.target}));await Gi({libraryId:u,nodes:de,edges:ge}),P(t.cogita.library.graph.saveSuccess)}catch{P(t.cogita.library.graph.saveFail)}},Le=de=>{C&&c(ge=>ge.map(M=>M.id===C.id?{...M,data:{...M.data,itemId:(de==null?void 0:de.infoId)??null,itemType:"collection",infoType:"collection",label:(de==null?void 0:de.label)??t.cogita.library.infoTypes.collection}}:M))},$e=de=>{C&&c(ge=>ge.map(M=>M.id===C.id?{...M,data:{...M.data,itemId:(de==null?void 0:de.infoId)??null,itemType:"info",infoType:(de==null?void 0:de.infoType)??null,label:(de==null?void 0:de.label)??t.cogita.library.infoTypes.any}}:M))};return n.useEffect(()=>{if(!C||C.data.nodeType!=="info"||C.data.infoType!=="citation"||!C.data.itemId){re(null);return}let de=!0;return la({libraryId:u,infoId:C.data.itemId}).then(ge=>{if(!de)return;const M=ge.payload,ae=(M==null?void 0:M.text)??"";if(!ae){re(null);return}const Ve=Ia(ae),Se=Object.values(Ve.nodes).sort((oe,H)=>oe.depth-H.depth||oe.start-H.start).map(oe=>({id:oe.id,text:oe.text,depth:oe.depth}));re({title:(M==null?void 0:M.title)??C.data.label,fragments:Se})}).catch(()=>re(null)),()=>{de=!1}},[u,C]),e.jsx(Ft,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:v,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:ke,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:A,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ne,children:t.cogita.library.actions.addInfo}),Q?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(Q.totalCollections))})}):null,b?e.jsx("p",{className:"cogita-help",children:b}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(fs,{nodes:r,edges:m,onNodesChange:E,onEdgesChange:S,onConnect:z,onNodeClick:(de,ge)=>y(ge.id),fitView:!0,children:[e.jsx(bs,{gap:18,size:1}),e.jsx(ys,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),C?e.jsxs("div",{className:"cogita-graph-inspector",children:[C.data.nodeType==="collection"?e.jsx(va,{libraryId:u,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:C.data.itemId?{id:C.data.itemId,label:C.data.label,infoType:"collection"}:null,onChange:Le,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(va,{libraryId:u,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:C.data.itemId?{id:C.data.itemId,label:C.data.label,infoType:C.data.infoType??void 0}:null,onChange:$e,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),_?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:_.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:_.fragments.map(de=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:de.id}),e.jsx("span",{children:de.text})]},de.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function Ja({children:t,flashState:a,flashTick:s=0,feedbackToken:i,className:l}){const h=i??(a?`${a}-${s}`:"idle"),[o,f]=n.useState("a"),g=n.useRef(h);return n.useEffect(()=>{g.current!==h&&(g.current=h,f(j=>j==="a"?"b":"a"))},[h]),e.jsx("section",{className:l?`cogita-revision-card ${l}`:"cogita-revision-card","data-feedback":h,"data-feedback-variant":o,children:t})}const oo={answerLabel:"Answer",correctAnswerLabel:"Correct answer",trueLabel:"True",falseLabel:"False",fragmentLabel:"Fragment",correctFragmentLabel:"Correct fragment",participantAnswerPlaceholder:"",unsupportedPromptType:"Unsupported prompt type",waitingForReveal:"Waiting for reveal.",selectedPaths:"Selected paths",removePath:"Remove",columnPrefix:"Column"};function Pn({prompt:t,revealExpected:a,mode:s,labels:i,answers:l,onTextChange:h,onSelectionToggle:o,onBooleanChange:f,onOrderingMove:g,onMatchingPick:j,onMatchingRemovePath:u}){var w;if(!t)return null;const v={...oo,...i??{}},r=typeof a<"u",c=String(t.kind??""),E=Array.isArray(a)?a.map(y=>Number(y)).filter(Number.isFinite):[],m=(y,Q,R)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:r?v.correctAnswerLabel:v.answerLabel}),e.jsx("input",{type:y==="number"?"number":y==="date"?"date":"text",value:Q??"",onChange:b=>R==null?void 0:R(b.target.value),readOnly:s==="readonly"||r,placeholder:v.participantAnswerPlaceholder})]}),k=(y,Q)=>Q.map((R,b)=>{const P=Array.isArray(y[b])?y[b]:[];return`${b>0?" -> ":""}${String(P[R]??R)}`}).join(""),S=y=>e.jsx("div",{className:"cogita-live-card-surface","data-state":r?"correct":"idle",children:y});if(c==="citation-fragment")return S(e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("span",{style:{opacity:.7},children:String(t.before??"")}),e.jsx("strong",{children:" [ ... ] "}),e.jsx("span",{style:{opacity:.7},children:String(t.after??"")})]}),m("text",r?String(a??""):(l==null?void 0:l.text)??"",h)]}));if(c==="text")return S(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),m(String(t.inputType??"text"),r?String(a??""):(l==null?void 0:l.text)??"",h)]}));if(c==="boolean"){const y=!!a,Q=l==null?void 0:l.booleanAnswer;return S(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:`cta ghost ${r&&y?"live-correct-answer":""}`,"data-active":!r&&Q===!0?"true":void 0,onClick:()=>f==null?void 0:f(!0),disabled:s==="readonly"||r,children:v.trueLabel}),e.jsx("button",{type:"button",className:`cta ghost ${r&&!y?"live-correct-answer":""}`,"data-active":!r&&Q===!1?"true":void 0,onClick:()=>f==null?void 0:f(!1),disabled:s==="readonly"||r,children:v.falseLabel})]})]}))}if(c==="selection"){const y=Array.isArray(t.options)?t.options:[],Q=!!t.multiple,R=(l==null?void 0:l.selection)??[];return S(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:y.map((b,P)=>e.jsxs("label",{className:"cogita-share-row","data-state":r&&E.includes(P)?"correct":void 0,children:[e.jsx("span",{children:b}),e.jsx("input",{type:Q?"checkbox":"radio",name:"live-selection",checked:r?E.includes(P):R.includes(P),onChange:()=>o==null?void 0:o(P),disabled:s==="readonly"||r})]},`${P}-${b}`))})]}))}if(c==="ordering"){const y=Array.isArray(r?a:l==null?void 0:l.ordering)?(r?a:(l==null?void 0:l.ordering)??[]).map(String):[];return S(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:y.map((Q,R)=>e.jsxs("div",{className:"cogita-share-row","data-state":r?"correct":void 0,children:[e.jsx("span",{children:Q}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>g==null?void 0:g(R,-1),disabled:s==="readonly"||r,children:"↑"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>g==null?void 0:g(R,1),disabled:s==="readonly"||r,children:"↓"})]})]},`${R}-${Q}`))})]}))}if(c==="matching"){const y=Array.isArray(t.columns)?t.columns:[],Q=(a==null?void 0:a.paths)??[],R=Math.max(2,y.length),b=Array.from({length:R},(P,_)=>(l==null?void 0:l.matchingSelection[_])??null);return S(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),e.jsx("div",{style:{display:"grid",gap:"0.65rem",gridTemplateColumns:`repeat(${R}, minmax(0, 1fr))`,alignItems:"start"},children:y.map((P,_)=>e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.35rem",padding:"0.6rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:`${v.columnPrefix} ${_+1}`}),P.map((re,C)=>e.jsxs("button",{type:"button",className:"ghost cogita-checkcard-row",style:{textAlign:"left"},"data-active":!r&&b[_]===C?"true":void 0,onClick:()=>j==null?void 0:j(_,C),disabled:s==="readonly"||r,children:[e.jsx("span",{children:re}),e.jsx("small",{children:C})]},`live-col:${_}:${C}`))]},`live-col:${_}`))}),e.jsxs("div",{style:{display:"grid",gap:"0.4rem",marginTop:"0.65rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:v.selectedPaths}),r?e.jsx("div",{className:"cogita-share-list",children:Q.map((P,_)=>e.jsx("div",{className:"cogita-share-row","data-state":"correct",children:e.jsx("span",{children:k(y,P)})},`path-${_}`))}):(((w=l==null?void 0:l.matchingRows)==null?void 0:w.length)??0)>0?e.jsx("div",{className:"cogita-share-list",children:((l==null?void 0:l.matchingRows)??[]).map((P,_)=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("span",{children:k(y,P)}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>u==null?void 0:u(_),disabled:s==="readonly",children:v.removePath})]},`path-${_}`))}):e.jsx("p",{className:"cogita-library-hint",children:v.waitingForReveal})]})]}))}return e.jsx("p",{className:"cogita-help",children:v.unsupportedPromptType})}function Ss({copy:t,currentCard:a,currentTypeLabel:s,prompt:i,languages:l,answer:h,onAnswerChange:o,computedExpected:f,computedAnswers:g,onComputedAnswerChange:j,answerTemplate:u,outputVariables:v,variableValues:r,computedFieldFeedback:c,feedback:E,canAdvance:m,quoteContext:k,quotePlaceholder:S,onCheckAnswer:w,onSkip:y,onLanguageSelect:Q,onMarkReviewed:R,onAdvance:b,showCorrectAnswer:P,setShowCorrectAnswer:_,onRevealCorrect:re,answerMask:C,expectedAnswer:z,hasExpectedAnswer:A,handleComputedKeyDown:ne,answerInputRef:ke,computedInputRefs:Le,scriptMode:$e,setScriptMode:de,matchPairs:ge,matchLeftOrder:M,matchRightOrder:ae,matchSelection:Ve,matchActiveLeft:Se,matchActiveRight:oe,matchFeedback:H,onMatchLeftSelect:Oe,onMatchRightSelect:W,questionPrompt:ze,questionAnswers:Te,questionRevealExpected:Ee,onQuestionTextChange:st,onQuestionSelectionToggle:D,onQuestionBooleanChange:he,onQuestionOrderingMove:Ye,onQuestionMatchingPick:U,onQuestionMatchingRemovePath:qe,disableCheckAnswer:at=!1,hideSkipAction:wt=!1,allowRevealBeforeCheck:yt=!1,autoRevealAfterAnswer:Fe=!1,disableCheckAfterAnswer:ve=!1}){const Je=n.useMemo(()=>{var rt;const I=!u&&f.length===2?`The {${f[0].key}} is of type {${f[1].key}}`:null,N=u??I;if(!N)return null;const Z=new Map(f.map(He=>[He.key,He.expected])),F=new Set,B=[],te=/\{([^}]+)\}/g;let ye=0,le,pe=null;for(;(le=te.exec(N))!==null;){const He=N.slice(ye,le.index);He&&B.push({type:"text",value:He});const lt=((rt=le[1])==null?void 0:rt.trim())??"",vt=lt&&Z.has(lt)?lt:lt&&v&&v[lt]?v[lt]:null;lt&&F.add(lt),vt&&F.add(vt),vt&&Z.has(vt)?(B.push({type:"input",value:vt}),pe||(pe=vt)):lt&&r&&r[lt]!==void 0?B.push({type:"text",value:r[lt]}):B.push({type:"text",value:le[0]}),ye=le.index+le[0].length}const Re=N.slice(ye);return Re&&B.push({type:"text",value:Re}),f.filter(He=>!F.has(He.key)).length>0?null:{parts:B,expectedByKey:Z,firstInputKey:pe}},[u,f,v,r]),Ue=()=>{if(!Je)return null;const{parts:I,expectedByKey:N,firstInputKey:Z}=Je;return e.jsx("div",{className:"cogita-revision-inline-answer",children:I.map((F,B)=>{var te,ye;return F.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:F.value},`text-${B}`):e.jsx("input",{ref:le=>{Le.current[F.value]=le},autoFocus:F.value===Z,value:g[F.value]??"",onChange:le=>j(F.value,le.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":c[F.value]??(E==="correct"?"correct":E==="incorrect"?"incorrect":void 0),onKeyDown:le=>$(le)||ne(le),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((te=g[F.value])==null?void 0:te.length)??0,((ye=N.get(F.value))==null?void 0:ye.length)??6)}ch`}},`input-${F.value}-${B}`)})})},je=n.useMemo(()=>{const I=new Map;return(ge??[]).forEach(N=>I.set(N.leftId,N)),I},[ge]),we=n.useMemo(()=>{const I=new Map;return(ge??[]).forEach(N=>I.set(N.rightId,N)),I},[ge]);n.useEffect(()=>{var B;if(a.cardType!=="info"||a.infoType!=="computed"||f.length===0)return;const I=typeof document<"u"?document.activeElement:null;if(I&&(I.tagName==="INPUT"||I.tagName==="TEXTAREA"))return;const N=(Je==null?void 0:Je.firstInputKey)??((B=f[0])==null?void 0:B.key);if(!N)return;const Z=Le.current[N];if(!Z)return;const F=requestAnimationFrame(()=>{Z.focus()});return()=>cancelAnimationFrame(F)},[a,f,Je]);const Me=(()=>{const I=[z??"",...f.map(F=>F.expected??"")].join(""),N=[h,...Object.values(g)].join(""),Z=`${I}${N}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(Z)})(),$=I=>I.ctrlKey&&(I.key==="^"||I.key==="6")?(I.preventDefault(),de(N=>N==="super"?null:"super"),!0):I.ctrlKey&&(I.key==="_"||I.key==="-")?(I.preventDefault(),de(N=>N==="sub"?null:"sub"),!0):!1,K=()=>{if(!z||!C)return z??"";const I=z.split(""),N=Array.from(C),Z=N.length>0?N.reduce((F,B)=>F+B,0)/N.length:127;return I.map((F,B)=>{const te=N[B]??Z,ye=Math.max(0,Math.min(255,Math.round(te)));let le=255,pe=0;return ye<=127?pe=Math.round(ye/127*255):(pe=255,le=Math.round(255*(1-(ye-127)/128))),e.jsx("span",{style:{color:`rgb(${le}, ${pe}, 0)`},children:F},`mask-${B}`)})},q=a.cardType==="info"&&a.infoType==="citation"?(k==null?void 0:k.title)||a.label:a.description,J=P||Fe&&E!==null,G=at||ve&&(E!==null||J),ce=A&&(yt||E==="incorrect"||J);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[s?e.jsx("span",{children:s}):null,e.jsx("strong",{children:q})]}),a.cardType==="vocab"&&a.checkType==="translation-match"&&ge?e.jsxs("div",{className:"cogita-revision-body",children:[i?e.jsx("h2",{children:i}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(M??[]).map(I=>{const N=je.get(I);if(!N)return null;const Z=(Ve==null?void 0:Ve[I])??null,F=(H==null?void 0:H[I])??null,B=Se===I;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":B,"data-state":F??void 0,"data-locked":Z?"true":void 0,onClick:()=>Oe==null?void 0:Oe(I),children:[e.jsx("span",{children:N.leftLabel}),Z&&P?e.jsx("em",{children:"✓"}):null]},I)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(ae??[]).map(I=>{const N=we.get(I);if(!N)return null;const Z=Object.values(Ve??{}).includes(I),F=oe===I;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":Z||F,"data-locked":Z?"true":void 0,onClick:()=>W==null?void 0:W(I),children:e.jsx("span",{children:N.rightLabel})},I)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:w,disabled:a.checkType==="translation-match"||G,children:t.cogita.library.revision.checkAnswer}),wt?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):a.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ke,value:h,onChange:I=>o(I.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":E==="correct"?"correct":E==="incorrect"?"incorrect":void 0,onKeyDown:I=>{if(I.key==="Enter")if(I.preventDefault(),I.stopPropagation(),m)b();else{if(G)return;w()}}})]}),Me?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":$e==="super",onClick:()=>de(I=>I==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":$e==="sub",onClick:()=>de(I=>I==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:w,disabled:G,children:t.cogita.library.revision.checkAnswer}),wt?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="question"?e.jsxs("div",{className:"cogita-revision-body",children:[ze?e.jsx(Pn,{prompt:ze,revealExpected:Ee,mode:"interactive",labels:{answerLabel:t.cogita.library.revision.answerLabel,correctAnswerLabel:t.cogita.library.revision.correctAnswerLabel,participantAnswerPlaceholder:t.cogita.library.revision.answerPlaceholder},answers:Te,onTextChange:st,onSelectionToggle:D,onBooleanChange:he,onOrderingMove:Ye,onMatchingPick:U,onMatchingRemovePath:qe}):e.jsxs(e.Fragment,{children:[e.jsx("h2",{children:i}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ke,value:h,onChange:I=>o(I.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":E==="correct"?"correct":E==="incorrect"?"incorrect":void 0,onKeyDown:I=>{if(I.key==="Enter")if(I.preventDefault(),I.stopPropagation(),m)b();else{if(G)return;w()}}})]})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:w,disabled:G,children:t.cogita.library.revision.checkAnswer}),wt?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[a.label?e.jsx("p",{className:"cogita-revision-hint",children:a.label}):null,u?null:e.jsx(Yi,{value:i??"",mode:"auto"}),f.length>0?(()=>{const I=Ue();return I?e.jsx("div",{className:"cogita-inline-answer-wrap",children:I}):e.jsx("div",{className:"cogita-form-grid",children:f.map((N,Z)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:N.key}),e.jsx("textarea",{ref:F=>{Le.current[N.key]=F},autoFocus:Z===0,value:g[N.key]??"",onChange:F=>j(N.key,F.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":c[N.key]??(E==="correct"?"correct":E==="incorrect"?"incorrect":void 0),onKeyDown:F=>$(F)||ne(F)})]},N.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:ke,value:h,onChange:I=>o(I.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":E==="correct"?"correct":E==="incorrect"?"incorrect":void 0,onKeyDown:I=>{if(!$(I)&&I.key==="Enter")if(I.preventDefault(),I.stopPropagation(),m)b();else{if(G)return;w()}}})]})}),Me?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":$e==="super",onClick:()=>de(I=>I==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":$e==="sub",onClick:()=>de(I=>I==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:w,disabled:G,children:t.cogita.library.revision.checkAnswer}),wt?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="citation"&&k?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(k.completed)).replace("{total}",String(k.total))}),e.jsx("p",{className:"cogita-quote-text",children:k.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ke,value:h,onChange:I=>o(I.target.value),placeholder:S??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":E==="correct"?"correct":E==="incorrect"?"incorrect":void 0,onKeyDown:I=>{if(I.key==="Enter")if(I.preventDefault(),I.stopPropagation(),m)b();else{if(G)return;w()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:k.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:w,disabled:G,children:t.cogita.library.revision.checkAnswer}),wt?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:l.length?l.map(I=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>Q(I.label),children:I.label},I.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:R,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}),E&&e.jsx("div",{className:"cogita-revision-feedback","data-state":E,children:E==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),ce?e.jsxs("div",{className:"cogita-revision-reveal",children:[J?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>_(I=>{const N=!I;return N&&re(),N}),children:t.cogita.library.revision.showAnswer}),J?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),f.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[f.map(I=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:I.key}),e.jsx("span",{children:I.expected})]},I.key)),z?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:z})]}):null]}):e.jsx("p",{children:C?K():z})]}):null]}):null,m?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:b,children:t.cogita.library.revision.nextQuestion})}):null]})}const ni={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},lo=(t,a)=>{const s=Math.max(t.length,a.length,1),i=Math.abs(t.length-a.length);return Math.max(0,1-i/s)},co=(t,a)=>{const s=new Uint8Array(t.length),i=lo(t,a);for(let l=0;l<t.length;l+=1){const h=t[l]===(a[l]??"")?128:0,o=t.length-1-l,f=a.length-1-l,g=t[o]===(a[f]??"")?127:0,j=Math.round((h+g)*i);s[l]=Math.max(0,Math.min(255,j))}return s},uo=(t,a)=>t===a||(ni[t]??[]).includes(a)?!0:(ni[a]??[]).includes(t),fn=(t,a,s)=>s?uo(t,a):t===a,Nn=(t,a,s)=>{const i=new Uint8Array(t.length);if(!t.length)return i;const l=(s==null?void 0:s.allowSimilarChars)??!0,h=[];for(let f=0;f<=t.length-3;f+=1)h.push({index:f,text:t.slice(f,f+3)});let o=!1;return h.forEach(f=>{for(let g=0;g<=a.length-3;g+=1){const j=a.slice(g,g+3);let u=0;for(let m=0;m<3;m+=1)fn(f.text[m],j[m],l)&&(u+=1);if(u<2)continue;let v=f.index-1,r=g-1;for(;v>=0&&r>=0;){const m=t[v],k=a[r];if(m===k){i[v]=Math.max(i[v],255),v-=1,r-=1,o=!0;continue}if(fn(m,k,l)&&m!==k){i[v]=Math.max(i[v],127),v-=1,r-=1,o=!0;continue}if(v>0&&t[v-1]===k){i[v]=Math.max(i[v],0),v-=1,o=!0;continue}if(r>0&&t[v]===a[r-1]){r-=1,o=!0;continue}break}for(let m=0;m<3;m+=1){const k=f.index+m,S=f.text[m],w=j[m],y=S===w?255:fn(S,w,l)?127:0;i[k]=Math.max(i[k],y),o=!0}let c=f.index+3,E=g+3;for(;c<t.length&&E<a.length;){const m=t[c],k=a[E];if(m===k){i[c]=Math.max(i[c],255),c+=1,E+=1,o=!0;continue}if(fn(m,k,l)&&m!==k){i[c]=Math.max(i[c],127),c+=1,E+=1,o=!0;continue}if(c+1<t.length&&t[c+1]===k){i[c]=Math.max(i[c],0),c+=1,o=!0;continue}if(E+1<a.length&&t[c]===a[E+1]){E+=1,o=!0;continue}break}}}),o?i:co(t,a)},es=t=>/[\p{L}\p{N}]/u.test(t),si=t=>t.trim().toLowerCase(),ya=(t,a)=>{if(t.length===0)return 100;const s=(a==null?void 0:a.treatSimilarCharsAsSame)??!1,i=Array.from(t).reduce((l,h)=>s&&h===127?l+255:l+h,0);return Math.round(i/(t.length*255)*100)},an=(t,a,s)=>{const i=Math.max(0,Math.min(100,(s==null?void 0:s.thresholdPercent)??100)),l=(s==null?void 0:s.treatSimilarCharsAsSame)??!0,h=(s==null?void 0:s.ignorePunctuationAndSpacing)??!1,o=si(t),f=si(a);if(!h){const w=Nn(o,f,{allowSimilarChars:l}),y=ya(w,{treatSimilarCharsAsSame:l});return{mask:w,percent:y,isCorrect:y>=i,normalizedExpected:o,normalizedAnswer:f}}const g=Array.from(o),j=Array.from(f),u=[],v=[],r=[];g.forEach((w,y)=>{es(w)&&(u.push(w),v.push(y))}),j.forEach(w=>{es(w)&&r.push(w)});const c=u.join(""),E=r.join(""),m=Nn(c,E,{allowSimilarChars:l}),k=new Uint8Array(g.length);for(let w=0;w<k.length;w+=1)k[w]=es(g[w]??"")?0:255;for(let w=0;w<m.length;w+=1){const y=v[w];y!==void 0&&(k[y]=m[w])}const S=ya(m,{treatSimilarCharsAsSame:l});return{mask:k,percent:S,isCorrect:S>=i,normalizedExpected:c,normalizedAnswer:E}},Ba=(t,a,s)=>{const i=t.trim().toLowerCase(),l=a.trim().toLowerCase();return s==="prefix"||s==="bidirectional"?Nn(i,l,{allowSimilarChars:!0}):Nn(i,l,{allowSimilarChars:!0})},ho=t=>{if(typeof t!="string")return"";const a=t.trim().toLowerCase();return a==="selection"||a==="truefalse"||a==="text"||a==="number"||a==="date"||a==="ordering"||a==="matching"?a:""};function Ts(t){if(!t||typeof t!="object")return null;const a=t,s=a.definition&&typeof a.definition=="object"?a.definition:a,i=ho(s.type);if(!i)return null;const l=typeof s.title=="string"?s.title:void 0,h=typeof s.question=="string"?s.question:"";if(!h.trim())return null;const o=Array.isArray(s.options)?s.options.map(j=>typeof j=="string"?j:"").filter(Boolean):void 0,f=Array.isArray(s.columns)?s.columns.map(j=>Array.isArray(j)?j.map(u=>typeof u=="string"?u:"").filter(Boolean):[]).filter(j=>j.length>0):void 0,g=(()=>{if(i==="selection")return(Array.isArray(s.answer)?s.answer:[]).map(u=>Number(u)).filter(u=>Number.isInteger(u)&&u>=0).sort((u,v)=>u-v);if(i==="truefalse")return typeof s.answer=="boolean"?s.answer:!1;if(i==="matching"){const j=s.answer&&typeof s.answer=="object"?s.answer:null;return{paths:(Array.isArray(j==null?void 0:j.paths)?j.paths:[]).map(r=>Array.isArray(r)?r.map(c=>Number(c)).filter(c=>Number.isInteger(c)&&c>=0):[]).filter(r=>r.length>0)}}if(typeof s.answer=="string"||typeof s.answer=="number")return s.answer})();return{type:i,title:l,question:h,options:o,answer:g,columns:f}}function ii(t){const a=t.map((l,h)=>({value:l,oldIndex:h}));for(let l=a.length-1;l>0;l-=1){const h=Math.floor(Math.random()*(l+1));[a[l],a[h]]=[a[h],a[l]]}const s=a.map(l=>l.value),i=new Map;return a.forEach((l,h)=>i.set(l.oldIndex,h)),{values:s,oldToNew:i}}function Ri(t){if(t.type==="selection"){const a=t.options??[],s=ii(a),i=Array.isArray(t.answer)?t.answer:[];return{...t,options:s.values,answer:i.map(l=>s.oldToNew.get(l)).filter(l=>Number.isInteger(l)).sort((l,h)=>l-h)}}if(t.type==="matching"){const s=(t.columns??[]).map(h=>ii(h)),l=(t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[]).map(h=>h.map((o,f)=>{var g;return((g=s[f])==null?void 0:g.oldToNew.get(o))??o}));return{...t,columns:s.map(h=>h.values),answer:{paths:l}}}return t}function bn(t){return t.map(a=>Number(a)).filter(a=>Number.isInteger(a)&&a>=0).sort((a,s)=>a-s)}function ri(t){return t.join("|")}function Xt(t){const{prompt:a,expected:s,answer:i}=t;if(a.kind==="selection"){const g=Array.isArray(s)?bn(s):[],j=bn(i.selection??[]);return{correct:g.length===j.length&&g.every((v,r)=>v===j[r]),mask:null}}if(a.kind==="boolean")return{correct:typeof s=="boolean"&&i.booleanAnswer!=null&&s===i.booleanAnswer,mask:null};if(a.kind==="ordering"){const g=Array.isArray(s)?s.map(String).join(`
`):Array.isArray(a.options)?a.options.map(String).join(`
`):"",j=Array.isArray(i.ordering)?i.ordering.map(String).join(`
`):"",u=an(g,j,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});return{correct:u.isCorrect,mask:u.mask}}if(a.kind==="matching"){const g=s&&typeof s=="object"&&"paths"in s&&Array.isArray(s.paths)?s.paths.map(c=>Array.isArray(c)?bn(c):[]).filter(c=>c.length>0).map(ri):[],j=(i.matchingPaths??[]).map(c=>Array.isArray(c)?bn(c):[]).filter(c=>c.length>0).map(ri),u=Array.from(new Set(g)).sort(),v=Array.from(new Set(j)).sort();return{correct:u.length===v.length&&u.every((c,E)=>c===v[E]),mask:null}}if(a.kind==="text"&&a.inputType==="number"){const g=Number(s),j=Number(i.text??"");return{correct:Number.isFinite(g)&&Number.isFinite(j)&&Math.abs(g-j)<1e-9,mask:null}}const l=typeof s=="string"||typeof s=="number"?String(s):"",h=String(i.text??""),o=a.kind==="citation-fragment",f=an(l,h,{thresholdPercent:o?90:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:o});return{correct:f.isCorrect,mask:f.mask}}function mo(t){const a=[...t];for(let s=a.length-1;s>0;s-=1){const i=Math.floor(Math.random()*(s+1));[a[s],a[i]]=[a[i],a[s]]}return a}function pa(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function oi(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function li(t){const a=t.checkType??"info",s=a.startsWith("question-")?`question / ${a.slice(9)}`:a;return t.direction?`${s} / ${t.direction}`:s}function go({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,libraryId:u,infoId:v,selectedReviewerRoleId:r}){const[c,E]=n.useState(v),[m,k]=n.useState([]),[S,w]=n.useState([]),[y,Q]=n.useState("loading"),[R,b]=n.useState(null),[P,_]=n.useState(null),[re,C]=n.useState(null),[z,A]=n.useState(null),[ne,ke]=n.useState(""),[Le,$e]=n.useState(null),[de,ge]=n.useState(1),[M,ae]=n.useState(null),[Ve,Se]=n.useState(0),[oe,H]=n.useState(!1),[Oe,W]=n.useState(null),[ze,Te]=n.useState({}),[Ee,st]=n.useState({}),[D]=n.useState({}),[he,Ye]=n.useState(null),[U,qe]=n.useState({selection:[],booleanAnswer:null,ordering:[],matchingRows:[],matchingSelection:[]}),at=n.useRef(null),wt=n.useRef({}),yt=sn();n.useEffect(()=>{let I=!1;return Q("loading"),Promise.all([la({libraryId:u,infoId:v}).catch(()=>null),xn({libraryId:u,infoId:v}),wn({libraryId:u,infoId:v})]).then(([N,Z,F])=>{if(I)return;const B=(N==null?void 0:N.payload)??{},te=typeof B.title=="string"&&B.title||typeof B.label=="string"&&B.label||typeof B.name=="string"&&B.name||v;E(te),_(B),C((N==null?void 0:N.infoType)??null),k(Z.items),w(F.items),Q("ready")}).catch(()=>{I||(_(null),C(null),k([]),w([]),Q("error"))}),()=>{I=!0}},[u,v]),n.useEffect(()=>{if(re!=="translation"){A(null);return}ki({libraryId:u,infoId:v,approachKey:"vocab-card"}).then(I=>A(I.projection??null)).catch(()=>A(null))},[re,v,u]);const Fe=n.useMemo(()=>{var ye;const I=new Map(m.map(le=>[pa(le),le])),N=new Map,Z=new Map;for(const le of m)N.set(pa(le),0),Z.set(pa(le),[]);for(const le of S){const pe=oi({parentItemId:le.parentItemId,parentCheckType:le.parentCheckType,parentDirection:le.parentDirection}),Re=[le.childItemId,le.childCheckType??"",le.childDirection??""].join("|");!I.has(pe)||!I.has(Re)||((ye=Z.get(pe))==null||ye.push(Re),N.set(Re,(N.get(Re)??0)+1))}const F=Array.from(N.entries()).filter(([,le])=>le===0).map(([le])=>le),B=new Map;for(const le of F)B.set(le,0);for(;F.length;){const le=F.shift(),pe=B.get(le)??0;for(const Re of Z.get(le)??[]){const nt=Math.max(B.get(Re)??0,pe+1);B.set(Re,nt),N.set(Re,(N.get(Re)??1)-1),(N.get(Re)??0)<=0&&F.push(Re)}}const te=new Map;for(const le of m){const pe=pa(le),Re=B.get(pe)??0,nt=te.get(Re)??[];nt.push(pe),te.set(Re,nt)}return m.map(le=>{const pe=pa(le),Re=B.get(pe)??0,nt=te.get(Re)??[pe],rt=Math.max(0,nt.indexOf(pe));return{id:pe,position:{x:40+rt*290+(Re%2?18:0),y:30+Re*120},draggable:!1,selectable:!0,data:{label:le.label,subtitle:li(le),checkType:le.checkType??"info",direction:le.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[m,S]),ve=n.useMemo(()=>new Map(m.map(I=>[pa(I),I])),[m]),Je=n.useMemo(()=>{const I=[];for(const N of S){const Z=oi({parentItemId:N.parentItemId,parentCheckType:N.parentCheckType,parentDirection:N.parentDirection}),F=[N.childItemId,N.childCheckType??"",N.childDirection??""].join("|");!ve.has(Z)||!ve.has(F)||I.push({id:`${Z}->${F}`,source:Z,target:F,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return I},[ve,S]),Ue=n.useMemo(()=>R?ve.get(R)??null:null,[ve,R]);n.useEffect(()=>{ke(""),ae(null),Se(0),H(!1),W(null),$e(null),st({}),qe({selection:[],booleanAnswer:null,ordering:[],matchingRows:[],matchingSelection:[]})},[R]);const je=n.useMemo(()=>{var B,te;if(!Ue)return null;const I=re??Ue.infoType??null,N=Ue.checkType??"info",Z=Ue.direction??null,F=P??{};if(Ue.cardType==="vocab"&&z&&Array.isArray(z.words)){const ye=z.words,le=((B=ye[0])==null?void 0:B.label)??"?",pe=((te=ye[1])==null?void 0:te.label)??"?";return Z==="a-to-b"?{kind:"vocab",prompt:String(le),expected:String(pe)}:Z==="b-to-a"?{kind:"vocab",prompt:String(pe),expected:String(le)}:{kind:"generic",prompt:`${le} ↔ ${pe}`,expected:`${le} ↔ ${pe}`}}if(I==="citation"&&N==="quote-fragment"&&Z&&typeof F.text=="string"){const ye=Z,le=Ia(F.text),pe=le.nodes[ye];if(pe){const Re=$n(F.text,pe);return{kind:"citation-fragment",expected:pe.text,quoteContext:{title:c,before:Re.before,after:Re.after,total:Object.keys(le.nodes).length,completed:0},quotePlaceholder:pe.text.length>0?".".repeat(Math.max(4,Math.min(18,pe.text.length))):"..."}}}if(I==="question"){const ye=Ts(F);if(ye)return{kind:"question",definition:Ri(ye)}}return{kind:"generic",prompt:Ue.description||Ue.label,expected:Ue.label}},[re,P,Ue,c,z]);n.useEffect(()=>{var N;if(!je||je.kind!=="question")return;const I=je.definition;qe({selection:[],booleanAnswer:null,ordering:I.type==="ordering"?mo(I.options??[]):[],matchingRows:[],matchingSelection:I.type==="matching"?new Array(Math.max(2,((N=I.columns)==null?void 0:N.length)??2)).fill(null):[]})},[je,R]);const we=async I=>{if(Ue&&r)try{await Xi({libraryId:u,outcome:{itemType:"info",itemId:Ue.cardId,checkType:Ue.checkType??"info",direction:Ue.direction??null,revisionType:"direct",evalType:"direct-check",correct:I,clientId:"cogita-info-checkcards",clientSequence:de,personRoleId:r}}),ge(N=>N+1),$e(I?"Saved as correct.":"Saved as incorrect.")}catch{$e("Failed to save answer.")}},Me=Ue?pa(Ue):null,$=Me?!!ze[Me]:!1,K=async()=>{if(!Ue||!je)return;const I=pa(Ue);if(ze[I]){$e("This card was already checked.");return}const N=je.kind==="question"?je.definition.type==="selection"?{kind:"selection",options:je.definition.options??[]}:je.definition.type==="truefalse"?{kind:"boolean"}:je.definition.type==="ordering"?{kind:"ordering",options:je.definition.options??[]}:je.definition.type==="matching"?{kind:"matching",columns:je.definition.columns??[]}:{kind:"text",inputType:je.definition.type==="number"?"number":je.definition.type==="date"?"date":"text"}:{kind:je.kind==="citation-fragment"?"citation-fragment":"text",inputType:"text"},Z=je.kind==="question"?je.definition.answer:je.expected,F=Xt({prompt:N,expected:Z,answer:{text:ne,selection:U.selection,booleanAnswer:U.booleanAnswer,ordering:U.ordering,matchingPaths:U.matchingRows}}),B=F.correct;W(F.mask),H(!0),ae(B?"correct":"incorrect"),Se(te=>te+1),$e(r?null:"Answer checked locally (not saved: no person selected)."),Te(te=>({...te,[I]:!0})),r&&await we(B)},q=()=>{if(!Ue||!je)return;const I=pa(Ue);if(ze[I]||(Te(Z=>({...Z,[I]:!0})),$e("Answer revealed (not saved).")),je.kind==="question"){W(null);return}const N=an(je.expected,je.expected,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:je.kind==="citation-fragment"});W(N.mask)},J=n.useMemo(()=>Ue?Ue.infoType==="question"?{...Ue,description:Ue.label}:Ue.infoType==="citation"?{...Ue,description:c}:{...Ue,description:Ue.label}:null,[Ue,c]),G=I=>{var vt,gt;const N=I.definition,Z=$||oe,F=Array.isArray(N.answer)?N.answer:[],B=N.answer&&typeof N.answer=="object"&&"paths"in N.answer?N.answer.paths:[],te=Math.max(2,((vt=N.columns)==null?void 0:vt.length)??2),ye=N.type==="matching"?U.matchingRows.filter(tt=>tt.length===te&&tt.every(Qe=>Number.isInteger(Qe)&&Qe>=0)):[],le=Array.from({length:te},(tt,Qe)=>U.matchingSelection[Qe]??null),pe=tt=>tt.join("|"),Re=new Map;for(const tt of B){const Qe=pe(tt);Re.set(Qe,(Re.get(Qe)??0)+1)}const nt=new Map;for(const tt of ye){const Qe=pe(tt);nt.set(Qe,(nt.get(Qe)??0)+1)}const rt=B.filter(tt=>{const Qe=pe(tt),bt=nt.get(Qe)??0;return bt>0?(nt.set(Qe,bt-1),!1):!0}),He=new Map;for(const tt of rt)tt.forEach((Qe,bt)=>{const We=He.get(bt)??new Map;We.set(Qe,(We.get(Qe)??0)+1),He.set(bt,We)});const lt=(tt,Qe)=>{Z||qe(bt=>{var Jt;const We=Math.max(2,((Jt=N.columns)==null?void 0:Jt.length)??2),ut=Array.from({length:We},(jt,Bt)=>bt.matchingSelection[Bt]??null);if(ut[tt]=ut[tt]===Qe?null:Qe,ut.some(jt=>jt==null))return{...bt,matchingSelection:ut};const Tt=ut.map(jt=>Number(jt)),Mt=pe(Tt),pt=bt.matchingRows.filter(jt=>pe(jt)===Mt).length;return(Re.get(Mt)??0)>pt?(ae("correct"),Se(jt=>jt+1),$e(null),{...bt,matchingRows:[...bt.matchingRows,Tt],matchingSelection:new Array(We).fill(null)}):(ae("incorrect"),Se(jt=>jt+1),$e("This path is not valid or has already been used."),{...bt,matchingSelection:new Array(We).fill(null)})})};return e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:N.question||(Ue==null?void 0:Ue.label)}),N.title?e.jsx("p",{className:"cogita-revision-hint",children:N.title}):null,N.type==="selection"?e.jsx("div",{className:"cogita-choice-grid",style:{gridTemplateColumns:"1fr"},children:(N.options??[]).map((tt,Qe)=>e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.6rem"},children:[e.jsx("input",{type:"checkbox",checked:U.selection.includes(Qe),disabled:Z,onChange:bt=>qe(We=>({...We,selection:bt.target.checked?Array.from(new Set([...We.selection,Qe])):We.selection.filter(ut=>ut!==Qe)}))}),e.jsx("span",{children:tt})]},`q-opt:${Qe}`))}):null,N.type==="truefalse"?e.jsxs("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:[e.jsx("button",{type:"button",className:"ghost","data-active":U.booleanAnswer===!0,disabled:Z,onClick:()=>qe(tt=>({...tt,booleanAnswer:!0})),children:"True"}),e.jsx("button",{type:"button",className:"ghost","data-active":U.booleanAnswer===!1,disabled:Z,onClick:()=>qe(tt=>({...tt,booleanAnswer:!1})),children:"False"})]}):null,N.type==="text"||N.type==="number"||N.type==="date"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:at,type:N.type==="date"?"date":"text",value:ne,onChange:tt=>ke(tt.target.value),disabled:Z,"data-state":M==="correct"?"correct":M==="incorrect"?"incorrect":void 0})]}):null,N.type==="ordering"?e.jsx("div",{style:{display:"grid",gap:"0.45rem"},children:U.ordering.map((tt,Qe)=>e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)"},children:[Qe+1,"."]}),e.jsx("span",{children:tt}),e.jsx("button",{type:"button",className:"ghost",disabled:Z||Qe===0,onClick:()=>qe(bt=>{const We=[...bt.ordering];return[We[Qe-1],We[Qe]]=[We[Qe],We[Qe-1]],{...bt,ordering:We}}),children:"Up"}),e.jsx("button",{type:"button",className:"ghost",disabled:Z||Qe>=U.ordering.length-1,onClick:()=>qe(bt=>{const We=[...bt.ordering];return[We[Qe+1],We[Qe]]=[We[Qe],We[Qe+1]],{...bt,ordering:We}}),children:"Down"})]},`q-order:${Qe}:${tt}`))}):null,N.type==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.65rem"},children:[e.jsx("div",{style:{display:"grid",gap:"0.65rem",gridTemplateColumns:`repeat(${Math.max(2,((gt=N.columns)==null?void 0:gt.length)??2)}, minmax(0, 1fr))`,alignItems:"start"},children:(N.columns??[]).map((tt,Qe)=>e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.35rem",padding:"0.6rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:`Column ${Qe+1}`}),tt.map((bt,We)=>{var ut;return e.jsxs("button",{type:"button",className:"ghost cogita-checkcard-row",style:{textAlign:"left"},disabled:Z||le[Qe]!==We&&(((ut=He.get(Qe))==null?void 0:ut.get(We))??0)<=0,"data-active":le[Qe]===We?"true":void 0,onClick:()=>lt(Qe,We),children:[e.jsx("span",{children:bt}),e.jsx("small",{children:We})]},`q-col:${Qe}:${We}`)})]},`q-col:${Qe}`))}),e.jsxs("div",{style:{display:"grid",gap:"0.4rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:"Selected paths"}),ye.length?ye.map((tt,Qe)=>e.jsxs("div",{className:"cogita-share-row",style:{alignItems:"center"},children:[e.jsx("span",{children:tt.map((bt,We)=>{var Tt,Mt;const ut=String(((Mt=(Tt=N.columns)==null?void 0:Tt[We])==null?void 0:Mt[bt])??bt);return`${We>0?" -> ":""}${ut}`})}),Z?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>qe(bt=>({...bt,matchingRows:bt.matchingRows.filter((We,ut)=>ut!==Qe)})),children:"Remove"})]},`q-path:${Qe}`)):e.jsx("p",{className:"cogita-library-hint",children:"Choose one option in each column. After the last column is selected, the path is checked automatically."})]})]}):null,e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>void K(),disabled:Z,children:t.cogita.library.revision.checkAnswer})}),oe?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),N.type==="selection"?e.jsx("p",{children:F.length?F.map(tt=>{var Qe;return`${tt}${(Qe=N.options)!=null&&Qe[tt]?`: ${N.options[tt]}`:""}`}).join(", "):"-"}):N.type==="truefalse"?e.jsx("p",{children:String(!!N.answer)}):N.type==="ordering"?e.jsx("ol",{children:(N.options??[]).map((tt,Qe)=>e.jsx("li",{children:tt},`ans-order:${Qe}`))}):N.type==="matching"?e.jsx("div",{style:{display:"grid",gap:"0.35rem"},children:B.length?B.map((tt,Qe)=>e.jsx("p",{children:tt.join(" → ")},`ans-path:${Qe}`)):e.jsx("p",{children:"-"})}):e.jsx("p",{children:String(N.answer??"")})]}):e.jsx("div",{className:"cogita-revision-reveal",children:e.jsx("button",{type:"button",className:"ghost",onClick:()=>{H(!0),q()},children:t.cogita.library.revision.showAnswer})})]})},ce=n.useMemo(()=>re?ft(t,re):t.cogita.library.infoTypes.any,[t,re]);return e.jsx(Ft,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:ce}),e.jsx("h2",{className:"cogita-card-title",children:c}),e.jsx("p",{className:"cogita-card-subtitle",children:v})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${m.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${S.length}`}),e.jsx("button",{type:"button",className:"cta",disabled:m.length===0,onClick:()=>yt(`/cogita/library/${u}/revisions/run?scope=info&infoId=${encodeURIComponent(v)}`),children:"Start revision"})]})]}),y==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):y==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(fs,{nodes:Fe,edges:Je,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:(I,N)=>b(N.id),panOnDrag:!0,children:[e.jsx(bs,{}),e.jsx(ys,{showInteractive:!1})]})}),Ue?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[je&&J?e.jsx(Ja,{flashState:M,flashTick:Ve,children:je.kind==="question"?G(je):e.jsx(Ss,{copy:t,currentCard:J,currentTypeLabel:"",prompt:je.kind==="citation-fragment"?null:je.prompt,languages:[],answer:ne,onAnswerChange:ke,computedExpected:[],computedAnswers:Ee,onComputedAnswerChange:(I,N)=>st(Z=>({...Z,[I]:N})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:D,feedback:M,canAdvance:!1,quoteContext:je.kind==="citation-fragment"?je.quoteContext:null,quotePlaceholder:je.kind==="citation-fragment"?je.quotePlaceholder:null,onCheckAnswer:()=>void K(),onSkip:()=>b(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:oe,setShowCorrectAnswer:H,onRevealCorrect:q,answerMask:Oe,expectedAnswer:je.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:at,computedInputRefs:wt,scriptMode:he,setScriptMode:Ye,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:$||oe,hideSkipAction:!0,allowRevealBeforeCheck:!0,autoRevealAfterAnswer:!0,disableCheckAfterAnswer:!0})}):null,r?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),Le?e.jsx("p",{className:"cogita-library-hint",children:Le}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:m.map(I=>{const N=pa(I),Z=R===N;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${Z?"active":""}`,onClick:()=>b(N),children:[e.jsx("span",{children:I.label}),e.jsx("small",{children:li(I)})]},N)})})]})]})]})})})})})}function yn(t,a){var s,i;return((i=(s=t.fields.find(l=>l.fieldType===a))==null?void 0:s.plainValue)==null?void 0:i.trim())??""}function po(t){return yn(t,"role_kind").toLowerCase()==="person"}function fo(t){return yn(t,"label")||yn(t,"display_name")||yn(t,"name")||t.roleId}function bo({copy:t,onPersonCreated:a}){const[s,i]=n.useState([]),[l,h]=n.useState("loading"),[o,f]=n.useState(null),[g,j]=n.useState(!1),[u,v]=n.useState(""),r=async()=>{h("loading");try{const m=await Ni();i(m),h("ready")}catch{i([]),h("error")}};n.useEffect(()=>{r()},[]);const c=n.useMemo(()=>s.filter(po).map(m=>({roleId:m.roleId,label:fo(m)})).sort((m,k)=>m.label.localeCompare(k.label)),[s]),E=async()=>{const m=u.trim();if(!m){f("Name is required.");return}j(!0),f(null);try{const k=await Zi({fields:[{fieldType:"nick",plainValue:m},{fieldType:"role_kind",plainValue:"person"},{fieldType:"label",plainValue:m},{fieldType:"display_name",plainValue:m}]});v(""),f("Person role created."),a==null||a(k.roleId),await r()}catch{f("Failed to create person role.")}finally{j(!1)}};return e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-browser-panel",children:[e.jsx("div",{className:"cogita-info-overview-head",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Cogita"}),e.jsx("h2",{className:"cogita-card-title",children:"Persons"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Select reviewer persons in the header and create new person roles here."})]})}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Create"}),e.jsx("h3",{className:"cogita-detail-title",children:"New person role"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{type:"text",value:u,onChange:m=>v(m.target.value),placeholder:"e.g. Anna Kowalska",disabled:g})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:E,disabled:g,children:g?"Creating...":"Create person"})}),o?e.jsx("p",{className:"cogita-library-hint",children:o}):null]})]}),e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Overview"}),e.jsx("h3",{className:"cogita-detail-title",children:"All person roles"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[l==="loading"?e.jsx("p",{children:"Loading persons..."}):null,l==="error"?e.jsx("p",{children:"Failed to load persons."}):null,l==="ready"&&c.length===0?e.jsx("p",{children:"No person roles found."}):null,l==="ready"&&c.length>0?e.jsxs("div",{className:"cogita-details-grid",children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:"Name"}),e.jsx("span",{children:"Type"}),e.jsx("span",{children:"Role ID"}),e.jsx("span",{})]}),c.map(m=>e.jsxs("div",{className:"cogita-details-row",role:"row",children:[e.jsx("span",{}),e.jsx("span",{title:m.label,children:m.label}),e.jsx("span",{children:"person"}),e.jsx("span",{title:m.roleId,children:m.roleId}),e.jsx("span",{})]},m.roleId))]}):null]})]})]})]})})})})}function yo({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,libraryId:u}){const{libraryName:v}=rn(u),[r,c]=n.useState(null),[E,m]=n.useState(null),[k,S]=n.useState(null),[w,y]=n.useState(null),[Q,R]=n.useState(null),[b,P]=n.useState(null),_=n.useRef(null),re=A=>{if(!Number.isFinite(A))return"0 B";if(A<1024)return`${A} B`;const ne=A/1024;if(ne<1024)return`${ne.toFixed(1)} KB`;const ke=ne/1024;return ke<1024?`${ke.toFixed(1)} MB`:`${(ke/1024).toFixed(1)} GB`},C=async()=>{c(null),R({loadedBytes:0,totalBytes:null,percent:null});try{c(t.cogita.library.overview.exporting);const A=await er(u,R),ne=URL.createObjectURL(A),ke=document.createElement("a");ke.href=ne,ke.download=`cogita-library-${v||u}.json`,ke.click(),URL.revokeObjectURL(ne),c(t.cogita.library.overview.exportReady)}catch{c(t.cogita.library.overview.exportFail)}finally{R(A=>A??{loadedBytes:0,totalBytes:null,percent:null})}},z=async A=>{var ke;m(null),S(null),y(null);const ne=(ke=A.target.files)==null?void 0:ke[0];if(ne)try{m(t.cogita.library.overview.importing),P({loadedBytes:0,totalBytes:ne.size,percent:0});const Le=await tr(u,ne,P,$e=>{const de=$e.stage==="infos"?t.cogita.library.overview.importStageInfos:$e.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;y(t.cogita.library.overview.importLiveProgress.replace("{stage}",de).replace("{done}",String($e.processed)).replace("{total}",String($e.total)).replace("{infos}",String($e.infos)).replace("{connections}",String($e.connections)).replace("{collections}",String($e.collections)))});S({infos:Le.infosImported,connections:Le.connectionsImported,collections:Le.collectionsImported}),m(t.cogita.library.overview.importDone)}catch(Le){const $e=Le instanceof js&&Le.message?` ${Le.message}`:"";m(`${t.cogita.library.overview.importFail}${$e}`)}finally{_.current&&(_.current.value="")}};return e.jsx(Ft,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:v}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:C,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:_,type:"file",accept:"application/json",onChange:z})]})]}),Q?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:Q.percent??void 0,max:Q.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",re(Q.loadedBytes)).replace("{total}",Q.totalBytes?re(Q.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,b?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:b.percent??void 0,max:b.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",re(b.loadedBytes)).replace("{total}",b.totalBytes?re(b.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,r?e.jsx("p",{className:"cogita-help",children:r}):null,E?e.jsx("p",{className:"cogita-help",children:E}):null,w?e.jsx("p",{className:"cogita-help",children:w}):null,k?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(k.infos)).replace("{connections}",String(k.connections)).replace("{collections}",String(k.collections))}):null]})]})})})]})})}function vo({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,libraryId:u}){const{libraryName:v}=rn(u),[r,c]=n.useState(""),[E,m]=n.useState([]),k=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Ft,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:v}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:r,onChange:S=>c(S.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const S=r.trim();S&&(m(w=>[{id:k(),name:S},...w]),c(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[E.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,E.map(S=>e.jsx("button",{type:"button",className:"ghost",children:S.name},S.id))]})]})]})})})]})})}function xo({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,libraryId:u}){const{libraryName:v}=rn(u),[r,c]=n.useState(""),[E,m]=n.useState([]),k=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Ft,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:v}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:r,onChange:S=>c(S.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const S=r.trim();S&&(m(w=>[{id:k(),name:S},...w]),c(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[E.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,E.map(S=>e.jsx("button",{type:"button",className:"ghost",children:S.name},S.id))]})]})]})})})]})})}function wo({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,libraryId:u}){const v=`/#/cogita/library/${u}`,[r,c]=n.useState(""),[E,m]=n.useState([]),[k,S]=n.useState("idle"),[w,y]=n.useState(0),[Q,R]=n.useState(null);n.useEffect(()=>{S("loading");const P=window.setTimeout(()=>{za({libraryId:u,query:r.trim()||void 0,limit:30}).then(_=>{m(_.items),y(_.total),R(_.nextCursor??null),S("ready")}).catch(()=>{m([]),y(0),R(null),S("ready")})},240);return()=>window.clearTimeout(P)},[u,r]);const b=async()=>{if(Q){S("loading");try{const P=await za({libraryId:u,query:r.trim()||void 0,limit:30,cursor:Q});m(_=>[..._,...P.items]),R(P.nextCursor??null),y(P.total),S("ready")}catch{S("ready")}}};return e.jsx(Ft,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"list",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:r,onChange:P=>c(P.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(E.length)).replace("{total}",String(w||E.length))}),e.jsx("span",{children:k==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:E.length?E.map(P=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${v}/collections/${P.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:P.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(P.itemCount))," ·"," ",P.notes||t.cogita.library.collections.noNotes]})]})},P.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${v}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),Q?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:b,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})})})}const Ie=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,oa=(t,a,s,i)=>`${t}:${a}:${s??""}:${i??""}`;function jo({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,libraryId:u,collectionId:v}){const r=`/#/cogita/library/${u}`,[c,E]=n.useState(0),[m,k]=n.useState([]),[S,w]=n.useState("idle"),[y,Q]=n.useState(null),R=n.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(m.length)).replace("{total}",String(c||m.length)),[t,m.length,c]);n.useEffect(()=>{ks(u,v).then(P=>{E(P.itemCount)}).catch(()=>{})},[u,v]),n.useEffect(()=>{w("loading"),tn({libraryId:u,collectionId:v,limit:40}).then(P=>{k(P.items),Q(P.nextCursor??null),E(P.total),w("ready")}).catch(()=>{k([]),Q(null),w("ready")})},[u,v]);const b=async()=>{if(y){w("loading");try{const P=await tn({libraryId:u,collectionId:v,limit:40,cursor:y});k(_=>[..._,...P.items]),Q(P.nextCursor??null),E(P.total),w("ready")}catch{w("ready")}}};return e.jsx(Ft,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:R}),e.jsx("span",{children:S==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:m.length?m.map(P=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:P.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:P.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:P.label}),e.jsx("p",{className:"cogita-card-subtitle",children:P.description})]})},Ie(P))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),y?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:b,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${r}/revisions`,children:t.cogita.library.actions.startRevision})})]})})]})})})})})}const ts=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],ko={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},No=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],So=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function ci({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,libraryId:u,collectionId:v,onCreated:r}){const c=Ua(),[E,m]=n.useState(v??null),[k,S]=n.useState(""),[w,y]=n.useState(""),[Q,R,b]=pi([]),[P,_,re]=fi([]),[C,z]=n.useState(null),[A,ne]=n.useState(null),ke=n.useRef(null),Le=n.useMemo(()=>Q.find(M=>M.id===C)??null,[Q,C]);n.useEffect(()=>{m(v??null)},[v]),n.useEffect(()=>{if(!v)return;let M=!1;return Promise.all([ks(u,v),ji({libraryId:u,collectionId:v})]).then(([ae,Ve])=>{if(!M){if(S(ae.name??""),y(ae.notes??""),!Ve.graphId||Ve.graphId==="00000000-0000-0000-0000-000000000000"){R([]),_([]);return}R(Ve.nodes.map(Se=>{var H;const oe=Se.payload??{};return{id:Se.nodeId,type:"default",position:oe.position??{x:120,y:120},data:{nodeType:Se.nodeType,label:((H=ts.find(Oe=>Oe.type===Se.nodeType))==null?void 0:H.label)??Se.nodeType,params:oe.params??{}}}})),_(Ve.edges.map(Se=>({id:Se.edgeId,source:Se.fromNodeId,target:Se.toNodeId,sourceHandle:Se.fromPort??void 0,targetHandle:Se.toPort??void 0})))}}).catch(()=>{M||ne(t.cogita.library.collections.saveFail)}),()=>{M=!0}},[v,t.cogita.library.collections.saveFail,u,_,R]),n.useEffect(()=>{if(v)return;const M=new URLSearchParams(c.search),ae=(M.get("draft")??"").trim(),Ve=(M.get("draftType")??"").trim();if(!ae||Ve!=="info-selection"||ke.current===ae)return;const Se=Qr(u,ae);if(!Se||Se.infoIds.length===0)return;const oe=crypto.randomUUID(),H=Se.infoIds.length>1?crypto.randomUUID():null,Oe=Se.infoIds.map((Ee,st)=>({id:crypto.randomUUID(),type:"default",position:{x:80,y:80+st*100},data:{nodeType:"source.info",label:"Selected info",params:{infoId:Ee,infoType:"any"}}})),W=H?[{id:H,type:"default",position:{x:360,y:120+Math.max(0,(Se.infoIds.length-1)*50)},data:{nodeType:"logic.or",label:"Selected infos",params:{}}}]:[],ze={id:oe,type:"default",position:{x:660,y:140+Math.max(0,(Se.infoIds.length-1)*35)},data:{nodeType:"output.collection",label:"Collection output",params:{}}},Te=Oe.map(Ee=>({id:crypto.randomUUID(),source:Ee.id,target:H??oe}));H&&Te.push({id:crypto.randomUUID(),source:H,target:oe}),R([...Oe,...W,ze]),_(Te),z(oe),ne(`Draft loaded from ${Se.infoIds.length} selected infos. Set name and save to create collection.`),ke.current=ae},[v,u,c.search,_,R]);const $e=M=>{var oe;const ae=crypto.randomUUID(),Ve=((oe=ts.find(H=>H.type===M))==null?void 0:oe.label)??M,Se={...ko[M]};R(H=>[...H,{id:ae,type:"default",position:{x:120+H.length*40,y:120+H.length*40},data:{nodeType:M,label:Ve,params:Se}}]),z(ae)},de=n.useCallback(M=>{_(ae=>bi({...M,id:crypto.randomUUID()},ae))},[_]),ge=M=>{Le&&R(ae=>ae.map(Ve=>Ve.id===Le.id?{...Ve,data:{...Ve.data,params:M}}:Ve))};return e.jsx(Ft,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.collectionInfoTitle}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{value:k,onChange:M=>S(M.target.value),placeholder:t.cogita.library.collections.namePlaceholder})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.notesLabel}),e.jsx("textarea",{value:w,onChange:M=>y(M.target.value),placeholder:t.cogita.library.collections.notesPlaceholder})]}),A?e.jsx("p",{className:"cogita-help",children:A}):null,e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:ts.map(M=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>$e(M.type),children:M.label},M.type))})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(fs,{nodes:Q,edges:P,onNodesChange:b,onEdgesChange:re,onConnect:de,onNodeClick:(M,ae)=>z(ae.id),fitView:!0,children:[e.jsx(bs,{color:"rgba(120,160,200,0.2)"}),e.jsx(ys,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),Le?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:Le.data.label}),Le.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(va,{libraryId:u,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:Le.data.params.tagId?{id:Le.data.params.tagId,label:Le.data.params.tagLabel??"",infoType:"topic"}:null,onChange:M=>ge({...Le.data.params,tagId:(M==null?void 0:M.id)??null,tagLabel:(M==null?void 0:M.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:Le.data.params.scope??"any",onChange:M=>ge({...Le.data.params,scope:M.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),Le.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(va,{libraryId:u,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:Le.data.params.languageId?{id:Le.data.params.languageId,label:Le.data.params.languageLabel??"",infoType:"language"}:null,onChange:M=>ge({...Le.data.params,languageId:(M==null?void 0:M.id)??null,languageLabel:(M==null?void 0:M.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:Le.data.params.scope??"any",onChange:M=>ge({...Le.data.params,scope:M.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),Le.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:Le.data.params.infoType??"word",onChange:M=>ge({...Le.data.params,infoType:M.target.value}),children:So.map(M=>e.jsx("option",{value:M.value,children:M.label},M.value))})]}),e.jsx(va,{libraryId:u,infoType:Le.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:Le.data.params.infoId?{id:Le.data.params.infoId,label:Le.data.params.infoLabel??"",infoType:Le.data.params.infoType??"word"}:null,onChange:M=>ge({...Le.data.params,infoId:(M==null?void 0:M.id)??null,infoLabel:(M==null?void 0:M.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),Le.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:Le.data.params.connectionType??"translation",onChange:M=>ge({...Le.data.params,connectionType:M.target.value}),children:No.map(M=>e.jsx("option",{value:M.value,children:M.label},M.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:Le.data.params.connectionId??"",onChange:M=>ge({...Le.data.params,connectionId:M.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(Le.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})})})}const fa=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const a=t.length,s=t.filter(h=>h.correct).length,i=En(Cs(t));return{score:Math.round(Math.max(0,Math.min(100,i.knowness*100))*100)/100,total:a,correct:s,lastReviewedUtc:i.lastReviewedUtc??null}},To=t=>{if(t.maskBase64)try{const a=ar(t.maskBase64);if(!a.length)return t.correct?1:0;const s=a.reduce((i,l)=>i+l,0);return Math.max(0,Math.min(1,s/a.length/255))}catch{return t.correct?1:0}return t.correct?1:0},Cs=t=>t.map(a=>({correctness:To(a),createdUtc:a.createdUtc})),En=(t,a=Date.now())=>{var S;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const i=t.slice().sort((w,y)=>w.createdUtc.localeCompare(y.createdUtc)).slice(-5),l=i.reduce((w,y)=>w+y.correctness,0)/i.length,h=5,o=2,f=.15;let g=0,j=0;for(let w=0;w<i.length;w+=1){const y=new Date(i[w].createdUtc).getTime(),Q=w===i.length-1?a:new Date(i[w+1].createdUtc).getTime(),R=Math.max(0,(Q-y)/(1e3*60)),b=1-Math.exp(-R/h);g+=b,i[w].correctness>.5&&(j+=f)}let u=l*g*o+j;const v=((S=i[i.length-1])==null?void 0:S.createdUtc)??null,r=v?Math.max(0,(a-new Date(v).getTime())/(1e3*60)):0,E=1/(1+Math.log1p(r/60));return u*=E,i.length===1&&i[0].correctness>.5&&(u+=5.44*Math.exp(-r/2)),{knowness:u,avgCorrectness:l,lastReviewedUtc:v}},Oa=t=>{const a=t.slice();for(let s=a.length-1;s>0;s-=1){const i=Math.floor(Math.random()*(s+1));[a[s],a[i]]=[a[i],a[s]]}return a},vn=t=>t[Math.floor(Math.random()*t.length)],Co=(t,a)=>{const s=new Map;return t.forEach(i=>s.set(i,Math.random())),t.sort((i,l)=>{const h=a(i)-a(l);return h!==0?h:(s.get(i)??0)-(s.get(l)??0)})},Kn=(t,a,s,i,l)=>{if(!t.length)return null;const h=t.filter(f=>!(l!=null&&l.has(Ie(f))));if(h.length===0)return null;const o=h.filter(f=>Ie(f)!==s);return vn(o.length?o:h)},Io=(t,a,s,i,l)=>{if(!t.length)return null;let h=Number.POSITIVE_INFINITY;for(const j of t){const u=Ie(j);if(s.has(u))continue;const v=a[u]??1;v<h&&(h=v)}if(!Number.isFinite(h))return null;const o=t.filter(j=>{const u=Ie(j);return!s.has(u)&&(a[u]??1)===h}),f=o.filter(j=>!l||Ie(j)!==l),g=i?f.filter(j=>!i.has(Ie(j))):f;return g.length>0?vn(g):f.length>0?vn(f):l&&o.some(j=>Ie(j)===l)?o.find(j=>Ie(j)===l)??null:o.length?vn(o):null},$i=(t,a,s,i,l)=>{const h=[],o=t.filter(g=>!l.has(Ie(g))&&!s.has(Ie(g))&&(a[Ie(g)]??0)<1),f=Co(o,g=>a[Ie(g)]??0);for(const g of f){if(h.length>=i)break;h.push(g),l.add(Ie(g))}if(h.length<i){const g=Oa(t.filter(j=>!l.has(Ie(j))&&s.has(Ie(j))));for(const j of g){if(h.length>=i)break;h.push(j),l.add(Ie(j))}}return h},Mo=(t,a,s,i)=>$i(t,a,s,i,new Set),Is=(t,a,s,i,l,h)=>{const o=Math.max(1,s.stackSize??a),g=Oa(t).filter((E,m,k)=>k.findIndex(S=>Ie(S)===Ie(E))===m),j=Mo(g,i,l,o),u=new Set,v=new Set,r=Kn(j,{},null,u,v),c=r?[r]:[];return r&&v.add(Ie(r)),{queue:c,meta:{pool:g,active:j,knownessMap:i,unknownSet:l,outcomesById:h,asked:u,queued:v}}},gs={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,a)=>{const i=Oa(t).filter((l,h,o)=>o.findIndex(f=>Ie(f)===Ie(l))===h);return{queue:i.slice(0,Math.min(a,i.length)),meta:{}}},applyOutcome:t=>t},Lo={id:"random-once",labelKey:"modeValueRandomOnce",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:()=>Number.MAX_SAFE_INTEGER,prepare:t=>({queue:Oa(t).filter((i,l,h)=>h.findIndex(o=>Ie(o)===Ie(i))===l),meta:{}}),applyOutcome:t=>t},Ms=(t,a,s,i)=>{const l=Math.max(1,s.stackSize??a),o=Oa(t).filter((m,k,S)=>S.findIndex(w=>Ie(w)===Ie(m))===k),f={},g=new Set,j=new Set,u=new Set,v=Math.max(1,s.levels??1);o.forEach(m=>{const k=Ie(m),S=i==null?void 0:i[k],w=typeof S=="number"&&Number.isFinite(S)?S:1;f[k]=Math.min(v,Math.max(1,Math.round(w)))});const r=[];if(o.length>0){const m=new Map;o.forEach(S=>{var y;const w=f[Ie(S)]??1;m.has(w)||m.set(w,[]),(y=m.get(w))==null||y.push(S)});const k=Array.from(m.keys()).sort((S,w)=>S-w);for(const S of k){if(r.length>=l)break;const w=Oa(m.get(S)??[]);for(const y of w){if(r.length>=l)break;r.push(y)}}}const c=Kn(r,f,null,g,j),E=c?[c]:[];return c&&j.add(Ie(c)),{queue:E,meta:{pool:o,active:r,levelMap:f,asked:g,queued:j,wrongSinceCorrect:u}}},Ao={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,a)=>Math.max(1,a.stackSize??t),getProgressTotal:()=>null,prepare:(t,a,s)=>Ms(t,a,s),applyOutcome:(t,a,s,i,l)=>{if(!a)return t;const h=Math.max(1,i.levels??1),o=t.meta.pool??[],f=t.meta.active??[],g={...t.meta.levelMap??{}},j=new Set(t.meta.asked??[]),u=new Set(t.meta.queued??[]),v=new Set(t.meta.wrongSinceCorrect??[]),r=Ie(a);u.delete(r),j.add(r);const c=g[r]??1;l.correct?(g[r]=v.has(r)?1:Math.min(c+1,h),v.delete(r)):(g[r]=1,v.add(r));const E=l.correct?f.filter(S=>Ie(S)!==r):f.slice();if(l.correct&&E.length<Math.max(1,i.stackSize??1)){const S=new Set(E.map(y=>Ie(y))),w=Io(o,g,S,j,r);w&&E.push(w)}const m=t.queue.slice(),k=Kn(E,g,r,j,u);return k&&(m.push(k),u.add(Ie(k))),{queue:m,meta:{pool:o,active:E,levelMap:g,asked:j,queued:u,wrongSinceCorrect:v}}}},Ro={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,a)=>Math.max(1,a.stackSize??t),getProgressTotal:()=>null,prepare:(t,a,s)=>Is(t,a,s,{},new Set,{}),applyOutcome:(t,a,s,i,l)=>{if(!a)return t;const h=t.meta.pool??[],o=t.meta.active??[],f={...t.meta.knownessMap??{}},g=new Set(t.meta.unknownSet??[]),j={...t.meta.outcomesById??{}},u=new Set(t.meta.asked??[]),v=new Set(t.meta.queued??[]),r=Ie(a);v.delete(r),u.add(r);const c={correctness:Math.max(0,Math.min(1,l.correctness??(l.correct?1:0))),createdUtc:l.createdUtc??new Date().toISOString()},m=(j[r]??[]).concat(c).sort((R,b)=>R.createdUtc.localeCompare(b.createdUtc)).slice(-5);j[r]=m,g.delete(r);const k=Date.now();h.forEach(R=>{const b=Ie(R),P=j[b]??[];if(P.length===0){f[b]=0,g.add(b);return}const _=En(P,k);f[b]=_.knowness});const S=o.slice();if((f[r]??0)>=1){const R=S.filter(b=>Ie(b)!==r);S.length=0,S.push(...R)}const y=Math.max(1,i.stackSize??s);if(S.length<y){const R=new Set(S.map(P=>Ie(P))),b=$i(h,f,g,y-S.length,R);S.push(...b)}const Q=t.queue.slice();if(Q.length===0||Ie(Q[Q.length-1])===r){const R=Kn(S,{},r,u,v);R&&(Q.push(R),v.add(Ie(R)))}return{queue:Q,meta:{pool:h,active:S,knownessMap:f,unknownSet:g,outcomesById:j,asked:u,queued:v}}}},ps={random:gs,"random-once":Lo,levels:Ao,temporal:Ro},Pi=Object.values(ps),nn=t=>{if(!t)return gs;const a=t.trim().toLowerCase();return a==="random"||a==="levels"||a==="temporal"||a==="random-once"?ps[a]:a==="random_once"?ps["random-once"]:gs},Fn=(t,a)=>{const s={...t.defaultSettings};return a&&Object.entries(a).forEach(([i,l])=>{typeof l=="number"&&Number.isFinite(l)&&(s[i]=l),typeof l=="string"&&(s[i]=l)}),t.settingsFields.forEach(i=>{var h;const l=s[i.key];if(i.type==="number"){if(typeof l!="number"||Number.isNaN(l)){s[i.key]=t.defaultSettings[i.key]??0;return}i.min!==void 0&&(s[i.key]=Math.max(i.min,s[i.key])),i.max!==void 0&&(s[i.key]=Math.min(i.max,s[i.key]));return}if(i.type==="select"){const o=((h=i.options)==null?void 0:h.map(f=>f.value))??[];(typeof l!="string"||o.length>0&&!o.includes(l))&&(s[i.key]=t.defaultSettings[i.key]??o[0]??"")}}),s},Ei=(t,a)=>{const s={};return t.settingsFields.forEach(i=>{const l=a.get(i.key);if(l){if(i.type==="number"){const h=Number(l);Number.isNaN(h)||(s[i.key]=h);return}s[i.key]=l}}),Fn(t,s)},$o=(t,a)=>{const s=new URLSearchParams;return t.settingsFields.forEach(i=>{const l=a[i.key];(typeof l=="number"||typeof l=="string")&&s.set(i.key,String(l))}),s};function di({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,libraryId:u,collectionId:v}){const r=`/#/cogita/library/${u}`,[c,E]=n.useState(""),[m,k]=n.useState("all"),[S,w]=n.useState([]),[y,Q]=n.useState("idle"),[R,b]=n.useState({});n.useEffect(()=>{Kr(u).then(C=>{const z=C.reduce((A,ne)=>(A[ne.collectionId]=ne.name,A),{});b(z)}).catch(()=>b({}))},[u]),n.useEffect(()=>{Q("loading"),vs({libraryId:u,collectionId:v}).then(C=>{w(C),Q("ready")}).catch(()=>{w([]),Q("ready")})},[u,v]);const P=n.useMemo(()=>Pi.map(C=>C.id),[]),_=n.useMemo(()=>{const C=c.trim().toLocaleLowerCase();return S.filter(z=>{const A=(z.revisionType??z.mode??"random").toLowerCase();if(m!=="all"&&A!==m)return!1;if(!C)return!0;const ne=R[z.collectionId]??"";return z.name.toLocaleLowerCase().includes(C)||A.includes(C)||ne.toLocaleLowerCase().includes(C)})},[R,c,S,m]),re=`${r}/revisions/new`;return e.jsx(Ft,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"list",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.workspace.infoMode.search}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:c,onChange:C=>E(C.target.value),placeholder:t.cogita.workspace.revisionForm.namePlaceholder})}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsxs("select",{value:m,onChange:C=>k(C.target.value),children:[e.jsx("option",{value:"all",children:t.cogita.library.infoTypes.any}),P.map(C=>e.jsx("option",{value:C,children:t.cogita.library.revision[nn(C).labelKey]},`type:${C}`))]})]})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:`${_.length} / ${S.length}`}),e.jsx("span",{children:y==="loading"?t.cogita.library.revision.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:_.length?_.map(C=>{const z=(C.revisionType??C.mode??"random").toLowerCase(),A=`${r}/revisions/${encodeURIComponent(C.revisionId)}`;return e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:A,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.revision[nn(z).labelKey]}),e.jsx("h3",{className:"cogita-card-title",children:C.name}),e.jsx("p",{className:"cogita-card-subtitle",children:R[C.collectionId]??C.collectionId})]})},C.revisionId)}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.workspace.status.noRevisions}),e.jsx("a",{className:"ghost",href:re,children:t.cogita.workspace.revisionForm.createAction})]})})]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.workspace.targets.allRevisions}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.workspace.infoMode.search})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]})]})})]})})})})})}function Po({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,libraryId:u,collectionId:v,revisionId:r}){const c=sn(),E=`/#/cogita/library/${u}`,[m,k]=n.useState([]),[S,w]=n.useState(v??""),[y,Q]=n.useState(""),[R,b]=n.useState(20),[P,_]=n.useState("random"),[re,C]=n.useState({}),[z]=n.useState("exact"),[A,ne]=n.useState([]),[ke,Le]=n.useState(null),[$e,de]=n.useState("idle"),[ge,M]=n.useState(null),[ae,Ve]=n.useState("idle"),[Se,oe]=n.useState("idle"),H=!r,Oe=n.useMemo(()=>nn(P),[P]),W=n.useMemo(()=>Fn(Oe,re),[Oe,re]),ze=n.useMemo(()=>$o(Oe,W).toString(),[Oe,W]),Te=n.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]);n.useEffect(()=>{w(v??"")},[v]),n.useEffect(()=>{za({libraryId:u,limit:200}).then(U=>{k(U.items.map(qe=>({collectionId:qe.collectionId,name:qe.name}))),!S&&U.items.length>0&&w(U.items[0].collectionId)}).catch(()=>k([]))},[u,S]),n.useEffect(()=>{Si({libraryId:u}).then(U=>{ne(U),!ke&&U.length>0&&Le(U[0].roleId)}).catch(()=>ne([]))},[u,ke]),n.useEffect(()=>{if(!r){Q(""),_("random"),b(20),C({}),M(null);return}Rn({libraryId:u,revisionId:r}).then(U=>{w(U.collectionId),Q(U.name),_(U.mode||"random"),b(U.limit||20),C(U.revisionSettings??{})}).catch(()=>{Q("")}),nr({libraryId:u}).then(U=>{const qe=U.find(at=>at.revisionId===r&&!at.revokedUtc)??null;M(qe)}).catch(()=>M(null))},[u,r]);const Ee=n.useMemo(()=>ge!=null&&ge.shareCode?`${Te}/${ge.shareCode}${ze?`?${ze}`:""}`:null,[ge==null?void 0:ge.shareCode,ze,Te]),st=async()=>{if(!S){de("error");return}if(!y.trim()){de("error");return}de("saving");try{if(r){await sr({libraryId:u,collectionId:S,revisionId:r,targetCollectionId:S,name:y.trim(),revisionType:Oe.id,revisionSettings:W,mode:P,check:z,limit:R}),de("saved");return}const U=await ir({libraryId:u,collectionId:S,name:y.trim(),revisionType:Oe.id,revisionSettings:W,mode:P,check:z,limit:R});de("saved"),c(`/cogita/library/${u}/revisions/${encodeURIComponent(U.revisionId)}`,{replace:!0})}catch{de("error")}},D=async()=>{if(r){Ve("working"),oe("idle");try{const U=await rr({libraryId:u,revisionId:r});M({shareId:U.shareId,revisionId:U.revisionId,revisionName:U.revisionName,collectionId:U.collectionId,collectionName:U.collectionName,shareCode:U.shareCode,revisionType:U.revisionType??null,revisionSettings:U.revisionSettings??null,mode:U.mode,check:U.check,limit:U.limit,createdUtc:U.createdUtc,revokedUtc:null}),Ve("ready")}catch{Ve("error")}}},he=async()=>{if(ge)try{await or({libraryId:u,shareId:ge.shareId}),M(null),Ve("idle"),oe("idle")}catch{Ve("error")}},Ye=async()=>{if(Ee)try{await navigator.clipboard.writeText(Ee),oe("copied")}catch{oe("failed")}};return e.jsx(Ft,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:H?t.cogita.workspace.revisionForm.createAction:t.cogita.workspace.infoActions.edit}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsxs("select",{value:S,onChange:U=>w(U.target.value),children:[e.jsx("option",{value:"",children:t.cogita.workspace.selectCollectionOption}),m.map(U=>e.jsx("option",{value:U.collectionId,children:U.name},U.collectionId))]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:y,onChange:U=>Q(U.target.value),placeholder:t.cogita.workspace.revisionForm.namePlaceholder})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:P,onChange:U=>_(U.target.value),children:Pi.map(U=>e.jsx("option",{value:U.id,children:t.cogita.library.revision[U.labelKey]},U.id))})]}),Oe.settingsFields.map(U=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[U.labelKey]}),U.type==="select"?e.jsx("select",{value:String(W[U.key]??""),onChange:qe=>C(at=>({...at,[U.key]:qe.target.value})),children:(U.options??[]).map(qe=>e.jsx("option",{value:qe.value,children:t.cogita.library.revision[qe.labelKey]},qe.value))}):e.jsx("input",{type:"number",min:U.min,max:U.max,step:U.step,value:Number(W[U.key]??0),onChange:qe=>C(at=>({...at,[U.key]:Number(qe.target.value||0)}))})]},U.key)),Oe.id==="random"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:R,onChange:U=>b(Number(U.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:ke??"",onChange:U=>Le(U.target.value||null),children:A.map(U=>e.jsx("option",{value:U.roleId,children:U.label},U.roleId))})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:st,disabled:$e==="saving",children:$e==="saving"?"...":H?t.cogita.workspace.revisionForm.createAction:t.cogita.workspace.infoActions.edit})}),$e==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.error}):null]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[!H&&r?e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),Ee?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:Ee,readOnly:!0})]}):e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}),ae==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,Se==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):Se==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:D,disabled:ae==="working",children:ae==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),Ee?e.jsx("button",{type:"button",className:"cta ghost",onClick:Ye,children:t.cogita.library.revision.shareCopyAction}):null,ge?e.jsx("button",{type:"button",className:"cta ghost",onClick:he,children:t.cogita.library.revision.shareRevokeAction}):null]})]}):null,!H&&r?e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.workspace.revisions.live}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.workspace.infoMode.search})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.revision.live.hostTitle})}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("a",{className:"cta ghost",href:`${E}/revisions/${encodeURIComponent(r)}/live-sessions`,children:t.cogita.workspace.revisions.live}),e.jsx("a",{className:"cta ghost",href:`/#/cogita/live-revision-host/${encodeURIComponent(u)}/${encodeURIComponent(r)}`,children:t.cogita.library.revision.live.hostTitle})]})]}):null]})]})})})})})}const as=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function Ki(t,a,s){if(!t)return null;const i=new Map(t.nodes.map(R=>[R.id,R])),l=new Map,h=new Set,o=R=>{if(typeof R=="number")return R;if(typeof R=="string"){const b=Number(R);return Number.isFinite(b)?b:0}return 0},f=R=>{if(l.has(R))return l.get(R);if(h.has(R))return 0;const b=i.get(R);if(!b)return 0;h.add(R);const P=re=>{var z,A;return(re?((z=b.inputsByHandle)==null?void 0:z[re])??[]:b.inputs??((A=b.inputsByHandle)==null?void 0:A.in)??[]).map(ne=>f(ne))};let _=0;switch(b.type){case"input.random":{const re=b.min??0,C=b.max??re+10,z=Math.min(re,C),A=Math.max(re,C);_=Math.floor(Math.random()*(A-z+1))+z;break}case"input.const":{_=b.value??0;break}case"input.list":{const re=(b.list??[]).filter(Boolean),C=Math.round(o(P("index")[0]));_=re.length?re[Math.max(0,Math.min(re.length-1,C))]:String(C);break}case"compute.add":{_=P("in").map(C=>o(C)).reduce((C,z)=>C+z,0);break}case"compute.sub":{const re=P("add").map(z=>o(z)),C=P("sub").map(z=>o(z));_=re.reduce((z,A)=>z+A,0)-C.reduce((z,A)=>z+A,0);break}case"compute.mul":{const re=P("in").map(C=>o(C));_=re.length?re.reduce((C,z)=>C*z,1):0;break}case"compute.div":{const re=o(P("num")[0]),C=P("den").map(z=>o(z)).reduce((z,A)=>z+A,0);_=Math.abs(C)<Number.EPSILON?0:re/C;break}case"compute.pow":{const re=o(P("base")[0]),C=o(P("exp")[0]);_=Math.pow(re,C);break}case"compute.exp":{const re=o(P("base")[0]),C=o(P("exp")[0]);_=Math.pow(re,C);break}case"compute.log":{const re=o(P("value")[0]),C=o(P("base")[0]),z=Math.max(re,Number.EPSILON);_=Math.abs(C)<Number.EPSILON?Math.log(z):Math.log(z)/Math.log(C);break}case"compute.abs":{_=Math.abs(o(P("in")[0]));break}case"compute.min":{const re=P("in").map(C=>o(C));_=re.length?Math.min(...re):0;break}case"compute.max":{const re=P("in").map(C=>o(C));_=re.length?Math.max(...re):0;break}case"compute.floor":{_=Math.floor(o(P("in")[0]));break}case"compute.ceil":{_=Math.ceil(o(P("in")[0]));break}case"compute.round":{_=Math.round(o(P("in")[0]));break}case"compute.mod":{const re=o(P("a")[0]),C=o(P("b")[0]);_=Math.abs(C)<Number.EPSILON?0:re%C;break}case"compute.concat":{const C=["in1","in2","in3","in4","in5","in6"].flatMap(ke=>P(ke)),z=C.length?C:P("in");_=(z.length?z:P()).map(ke=>ke==null?"":String(ke)).join("");break}case"compute.trim":{const re=P("text")[0]??P("in")[0]??"",C=re==null?"":String(re),z=Math.max(0,Math.round(o(P("start")[0]))),A=Math.max(0,Math.round(o(P("end")[0])));z+A>=C.length?_="":_=C.substring(z,C.length-A);break}case"output":{_=P("in")[0]??0;break}default:_=0}return h.delete(R),l.set(R,_),_},g=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(R=>R.type==="output").map(R=>R.id);t.nodes.forEach(R=>f(R.id)),g.forEach(R=>f(R));const j=R=>Math.abs(R%1)<1e-5?String(Math.round(R)):R.toFixed(3).replace(/\.?0+$/,""),u=R=>typeof R=="number"?j(R):R??"",v=new Map;g.forEach(R=>{var C,z,A,ne;const b=i.get(R);if(!b)return;const P=(z=(C=b.inputsByHandle)==null?void 0:C.name)==null?void 0:z[0],_=P?u(l.get(P)):"",re=(_==null?void 0:_.toString().trim())||((A=b.outputLabel)==null?void 0:A.trim())||((ne=b.name)==null?void 0:ne.trim())||R;v.set(R,re)});const r={},c={},E={};g.forEach(R=>{var _,re;const b=i.get(R);if(!b)return;const P=v.get(R)??(((_=b.outputLabel)==null?void 0:_.trim())||((re=b.name)==null?void 0:re.trim())||R);r[P]=u(l.get(R)),b.name&&(c[b.name.trim()]=P),c[R]=P});const m=(R,b)=>{let P=R;return t.nodes.forEach(_=>{var ne,ke;const re=u(l.get(_.id)),C=g.includes(_.id),z=C?v.get(_.id)??((ne=_.outputLabel)==null?void 0:ne.trim())??((ke=_.name)==null?void 0:ke.trim())??_.id:"",A=C&&b?z:re;P=P.replace(new RegExp(`\\{\\s*${as(_.id)}\\s*\\}`,"gi"),A),_.name&&(P=P.replace(new RegExp(`\\{\\s*${as(_.name)}\\s*\\}`,"gi"),A)),C&&_.outputLabel&&(P=P.replace(new RegExp(`\\{\\s*${as(_.outputLabel)}\\s*\\}`,"gi"),z))}),P},k=a;let S=k.trim().length>0?k:"";S||(S=g.length?`Compute ${g.join(", ")}`:"Compute"),S=m(S,!0);const w=(s==null?void 0:s.trim())??"",y=w?m(w,!1):"",Q={};return l.forEach((R,b)=>{Q[b]=R,E[b]=u(R);const P=i.get(b);P!=null&&P.name&&(E[P.name.trim()]=u(R))}),{prompt:S,answers:r,values:Q,answerText:y,outputVariables:c,variableValues:E}}function Fi(t){var s;const a=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((s=a[0])==null?void 0:s[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const ns=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function _i({outcomes:t}){const[a,s]=n.useState("day"),i=n.useMemo(()=>{const l=ns.find(f=>f.id===a)??ns[1],h=Date.now()-l.ms,o=t.filter(f=>new Date(f.createdUtc).getTime()>=h);return fa(o)},[t,a]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:ns.map(l=>e.jsx("button",{type:"button",className:"ghost","data-active":a===l.id,onClick:()=>s(l.id),children:l.label},l.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[i.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[i.correct," / ",i.total]})]})}const Eo="cogita-revision",Ko=1,Sn="outcomes",Fo=()=>new Promise((t,a)=>{const s=indexedDB.open(Eo,Ko);s.onupgradeneeded=()=>{const i=s.result;if(!i.objectStoreNames.contains(Sn)){const l=i.createObjectStore(Sn,{keyPath:"id"});l.createIndex("byItem","itemKey",{unique:!1}),l.createIndex("byPending","pending",{unique:!1})}},s.onerror=()=>a(s.error),s.onsuccess=()=>t(s.result)}),on=async(t,a)=>{const s=await Fo();return new Promise((i,l)=>{const h=s.transaction(Sn,t),o=h.objectStore(Sn);a(o).then(i).catch(l),h.onerror=()=>l(h.error)})},Vi=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const a=Array.from(t).map(s=>s.toString(16).padStart(2,"0"));return`${a.slice(0,4).join("")}-${a.slice(4,6).join("")}-${a.slice(6,8).join("")}-${a.slice(8,10).join("")}-${a.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},_o=()=>{const t="cogita_revision_client_id",a=localStorage.getItem(t);if(a)return a;const s=Vi();return localStorage.setItem(t,s),s},Vo=()=>{const t="cogita_revision_client_seq",a=Number(localStorage.getItem(t)??"0"),s=Number.isFinite(a)?a+1:1;return localStorage.setItem(t,String(s)),s},qi=(t,a,s,i)=>oa(t,a,s,i),Tn=async t=>{const a=_o(),s=Vo(),i=new Date().toISOString(),l={...t,clientId:a,clientSequence:s,createdUtc:i,id:Vi(),pending:!0};return await on("readwrite",h=>new Promise((o,f)=>{const g={...l,itemKey:qi(l.itemType,l.itemId,l.checkType,l.direction)},j=h.add(g);j.onsuccess=()=>o(),j.onerror=()=>f(j.error)})),l},Cn=async(t,a,s,i)=>{if(!a)return[];try{const l=qi(t,a,s,i);return await on("readonly",h=>new Promise((o,f)=>{const j=h.index("byItem").getAll(l);j.onsuccess=()=>{const v=(j.result??[]).map(r=>({itemType:r.itemType,itemId:r.itemId,checkType:r.checkType??null,direction:r.direction??null,revisionType:r.revisionType,evalType:r.evalType,correct:r.correct,createdUtc:r.createdUtc,maskBase64:r.maskBase64,payloadBase64:r.payloadBase64,payloadHashBase64:r.payloadHashBase64,clientId:r.clientId,clientSequence:r.clientSequence,personRoleId:r.personRoleId??null})).sort((r,c)=>r.createdUtc.localeCompare(c.createdUtc));o(v)},j.onerror=()=>f(j.error)}))}catch{return[]}},ba=async()=>{try{return await on("readonly",t=>new Promise((a,s)=>{const i=t.getAll();i.onsuccess=()=>{const h=(i.result??[]).map(o=>({itemType:o.itemType,itemId:o.itemId,checkType:o.checkType??null,direction:o.direction??null,revisionType:o.revisionType,evalType:o.evalType,correct:o.correct,createdUtc:o.createdUtc,maskBase64:o.maskBase64,payloadBase64:o.payloadBase64,payloadHashBase64:o.payloadHashBase64,clientId:o.clientId,clientSequence:o.clientSequence,personRoleId:o.personRoleId??null}));a(h)},i.onerror=()=>s(i.error)}))}catch{return[]}},qo=async(t=100)=>{try{return await on("readonly",a=>new Promise((s,i)=>{const h=a.index("byPending").getAll(!0);h.onsuccess=()=>{const o=h.result??[];s(o.slice(0,t))},h.onerror=()=>i(h.error)}))}catch{return[]}},Do=async t=>{if(t.length!==0)try{await on("readwrite",a=>new Promise((s,i)=>{let l=t.length;t.forEach(h=>{const o=a.get(h);o.onsuccess=()=>{const f=o.result;if(f){f.pending=!1;const g=a.put(f);g.onsuccess=()=>{l-=1,l===0&&s()},g.onerror=()=>i(g.error)}else l-=1,l===0&&s()},o.onerror=()=>i(o.error)})}))}catch{}},ss=async(t,a)=>{const s=await qo(200);if(s.length===0)return;const i=new Map;s.forEach(l=>{var o;const h=l.personRoleId??a??"";i.has(h)||i.set(h,[]),(o=i.get(h))==null||o.push(l)});for(const[l,h]of i.entries()){const o=h.map(f=>({itemType:f.itemType,itemId:f.itemId,checkType:f.checkType??null,direction:f.direction??null,revisionType:f.revisionType,evalType:f.evalType,correct:f.correct,clientId:f.clientId,clientSequence:f.clientSequence,maskBase64:f.maskBase64??null,payloadHashBase64:f.payloadHashBase64??null,payloadBase64:f.payloadBase64??null,personRoleId:l||null}));try{await lr({libraryId:t,outcomes:o}),await Do(h.map(f=>f.id))}catch{}}},ta=()=>({text:"",selection:[],booleanAnswer:null,ordering:[],matchingRows:[],matchingSelection:[]});function Bo(t){const a=[...t];for(let s=a.length-1;s>0;s-=1){const i=Math.floor(Math.random()*(s+1));[a[s],a[i]]=[a[i],a[s]]}return a}function In(t,a){const s=Ts(t);if(!s)return null;const i=Ri(s),l=(i.question||i.title||a||"").trim();if(i.type==="selection"){const f=i.options??[],g=Array.isArray(i.answer)?i.answer:[];return{promptText:l,promptModel:{kind:"selection",options:f},expectedModel:g,promptPayload:{kind:"selection",prompt:l,options:f,multiple:g.length!==1},initialAnswers:ta()}}if(i.type==="truefalse"){const f=typeof i.answer=="boolean"?i.answer:!1;return{promptText:l,promptModel:{kind:"boolean"},expectedModel:f,promptPayload:{kind:"boolean",prompt:l},initialAnswers:ta()}}if(i.type==="ordering"){const f=i.options??[];return{promptText:l,promptModel:{kind:"ordering",options:f},expectedModel:f,promptPayload:{kind:"ordering",prompt:l,options:f},initialAnswers:{...ta(),ordering:Bo(f)}}}if(i.type==="matching"){const f=i.columns??[],g=i.answer&&typeof i.answer=="object"&&"paths"in i.answer?{paths:Array.isArray(i.answer.paths)?i.answer.paths:[]}:{paths:[]};return{promptText:l,promptModel:{kind:"matching",columns:f},expectedModel:g,promptPayload:{kind:"matching",prompt:l,columns:f},initialAnswers:{...ta(),matchingSelection:new Array(Math.max(2,f.length)).fill(null)}}}const h=typeof i.answer=="string"||typeof i.answer=="number"?i.answer:"",o=i.type==="number"?"number":i.type==="date"?"date":"text";return{promptText:l,promptModel:{kind:"text",inputType:o},expectedModel:h,promptPayload:{kind:"text",prompt:l,inputType:o},initialAnswers:ta()}}const Ut=t=>t.trim().toLowerCase(),Zt=t=>{const a=t==null?void 0:t.trim();return a?{fragmentId:a}:null},Mn=(t,a)=>{const s=Zt(a);if(!s)return!0;const i=Zt(t);return(i==null?void 0:i.fragmentId)===s.fragmentId},Rt=t=>{const a=t==null?void 0:t.trim().toLowerCase();return a||null},Di=(t,a)=>{if((Rt(t.childItemType)??"info")!==(a.cardType??"").toLowerCase()||t.childItemId!==a.cardId)return!1;const i=Rt(t.childCheckType),l=Rt(t.childDirection),h=Rt(a.checkType),o=Rt(a.direction);return!(i&&i!==h||l&&l!==o)},zo={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},Oo={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},Ln=(t,a,s)=>{if(!s||!a.startsWith(t))return a;const i=a.slice(t.length);if(!i)return a;const l=s==="super"?zo:Oo,h=i.split("").map(o=>l[o]??o).join("");return t+h},An=(t,a,s)=>{var o,f,g;if(!t)return((o=a[0])==null?void 0:o.key)??null;const i=new Set(a.map(j=>j.key)),l=/\{([^}]+)\}/g;let h;for(;(h=l.exec(t))!==null;){const j=((f=h[1])==null?void 0:f.trim())??"";if(!j)continue;if(i.has(j))return j;const u=s==null?void 0:s[j];if(u&&i.has(u))return u}return((g=a[0])==null?void 0:g.key)??null},en=t=>(()=>{const a=new Set;return t.flatMap(s=>{if(s.cardType!=="info"||s.infoType!=="citation")return[s];const i=s.description??"";if(!i.trim())return[s];const l=Ia(i),h=Object.keys(l.nodes);return h.length===0?[s]:h.map(o=>({...s,checkType:"quote-fragment",direction:o})).filter(o=>{const f=[o.cardId,o.checkType??"",o.direction??""].join("|");return a.has(f)?!1:(a.add(f),!0)})})})();function Uo({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,libraryId:u,collectionId:v,revisionId:r}){const c=Ua(),E=`/#/cogita/library/${u}`,m=n.useMemo(()=>new URLSearchParams(c.search),[c.search]),k=Math.max(1,Number(m.get("limit")??20)),S=m.get("mode")??"random",w=n.useMemo(()=>nn(S),[S]),y=n.useMemo(()=>Fn(w,Ei(w,m)),[w,m]),Q=m.get("check")??"exact",R=m.get("reviewer"),b=(m.get("scope")??"").trim(),P=b==="info"||b==="info-selection"?b:"collection",_=P==="info"?(m.get("infoId")??"").trim():"",re=P==="info-selection"?(m.get("seed")??"").trim():"",[C,z]=n.useState(null),A=v??C??void 0,ne=P==="collection"&&!!A,ke=n.useMemo(()=>t.cogita.library.revision[w.labelKey]??S,[t,S,w]),Le=n.useMemo(()=>Q==="exact"?t.cogita.library.revision.checkValue:Q,[t,Q]),[$e,de]=n.useState(t.cogita.library.collections.defaultName),[ge,M]=n.useState([]),[ae,Ve]=n.useState([]),[Se,oe]=n.useState("idle"),[H,Oe]=n.useState({current:0,total:0}),[W,ze]=n.useState(0),[Te,Ee]=n.useState(""),[st,D]=n.useState(null),[he,Ye]=n.useState(null),[U,qe]=n.useState(null),[at,wt]=n.useState(null),[yt,Fe]=n.useState(null),[ve,Je]=n.useState(null),[Ue,je]=n.useState(()=>ta()),[we,Me]=n.useState(null),[$,K]=n.useState([]),[q,J]=n.useState({}),[G,ce]=n.useState({}),[I,N]=n.useState(null),[Z,F]=n.useState(null),[B,te]=n.useState(null),[ye,le]=n.useState(null),[pe,Re]=n.useState(null),[nt,rt]=n.useState({}),He=n.useRef(0),[lt,vt]=n.useState(null),gt=n.useRef(null),tt=n.useRef(null),[Qe,bt]=n.useState(null),[We,ut]=n.useState(!1),[Tt,Mt]=n.useState(null),[pt,Ct]=n.useState([]),[Jt,jt]=n.useState(null),Bt=n.useRef(null),ea=n.useRef(null),[xa,$t]=n.useState(null),[aa,Lt]=n.useState(0),It=n.useRef(null),zt=n.useRef({}),[Pt,ct]=n.useState(!1),[Ze,it]=n.useState({}),[ma,x]=n.useState([]),Ne=n.useRef(new Map),[d,se]=n.useState(new Set),[me,Ge]=n.useState(!1),dt=n.useRef(null),mt=n.useRef(new Set),Et=n.useRef({});n.useEffect(()=>{if(!r||v){z(null);return}Rn({libraryId:u,revisionId:r}).then(p=>z(p.collectionId)).catch(()=>z(null))},[v,u,r]);const Ce=ge[W]??null,Gt=(Ce==null?void 0:Ce.checkType)==="translation-match"&&pe,Qt=n.useRef(new Map),_t=n.useRef(new Map),Kt=n.useRef(new Map),na=n.useRef(new Map),Ot=n.useMemo(()=>Ce?Ce.cardType==="vocab"?t.cogita.library.revision.vocabLabel:Ce.infoType?ft(t,Ce.infoType):t.cogita.library.revision.infoLabel:"",[t,Ce]),ca=n.useMemo(()=>{var T;return w.id!=="levels"?ge.length:((T=Ze.pool)==null?void 0:T.length)??w.getFetchLimit(k,y)},[Ze,y,w,ge.length,k]),Ma=w.getProgressTotal?w.getProgressTotal(ge,Ze,k,y):w.id==="levels"?Math.min(k,ca):ge.length,ln=Ma?Math.min(W+1,Ma):0,sa=Math.max(1,Number(y.tries??1)),Na=y.compare??"anchors",cn=Math.max(0,Math.min(100,Number(y.minCorrectness??0))),Vt=(y.considerDependencies??"on")==="on",da=Math.max(0,Math.min(100,Number(y.dependencyThreshold??85))),ia=p=>{const T=p.slice();for(let V=T.length-1;V>0;V-=1){const ee=Math.floor(Math.random()*(V+1));[T[V],T[ee]]=[T[ee],T[V]]}return T},La=p=>ya(p,{treatSimilarCharsAsSame:!0})>=cn,dn=async()=>{const p=await ba(),T=new Map,V=new Map,ee=new Map;p.forEach(Y=>{const fe=`${Y.itemType}:${Y.itemId}`,Be=oa(Y.itemType,Y.itemId,Y.checkType,Y.direction);if(T.has(fe)||T.set(fe,[]),T.get(fe).push(Y),V.has(Be)||V.set(Be,[]),V.get(Be).push(Y),Y.itemType==="info"&&Y.checkType==="quote-fragment"&&Y.direction){const et=`${Y.itemId}:${Y.direction}`;ee.has(et)||ee.set(et,[]),ee.get(et).push(Y)}});const ie=new Map,X=new Map,be=new Map;return T.forEach((Y,fe)=>ie.set(fe,fa(Y).score)),V.forEach((Y,fe)=>X.set(fe,fa(Y).score)),ee.forEach((Y,fe)=>be.set(fe,fa(Y).score)),{itemKnowness:ie,cardKnowness:X,fragmentKnowness:be}},Ht=async p=>{const T=[];let V=null;for(;;){const ee=await tn({libraryId:u,collectionId:p,limit:200,cursor:V});if(T.push(...ee.items),!ee.nextCursor)break;V=ee.nextCursor}return en(T)},$a=async(p,T)=>{if(Ne.current.has(p))return Ne.current.get(p)??0;const V=await Ht(p);if(V.length===0)return Ne.current.set(p,0),0;const ie=V.reduce((X,be)=>{const Y=Ie(be);return X+(T.get(Y)??0)},0)/V.length;return Ne.current.set(p,ie),ie},Pa=(p,T)=>{if(!Vt||p.cardType!=="info"||p.infoType!=="citation"||p.checkType!=="quote-fragment")return!0;const V=Zt(p.direction);if(!(V!=null&&V.fragmentId))return!0;const ee=p.description??"";if(!ee.trim())return!0;const X=Ia(ee).nodes[V.fragmentId];if(!X||!X.leftId&&!X.rightId)return!0;const be=[X.leftId,X.rightId].filter(Be=>!!Be);if(be.length===0)return!0;const Y=be.map(Be=>{const et=oa("info",p.cardId,"quote-fragment",Be);return T.get(et)??0});return Y.reduce((Be,et)=>Be+et,0)/Y.length>=da},Qa=async p=>{const T=Ze,V=p.concat(T.active??[]).concat(T.pool??[]).filter((Y,fe,Be)=>Be.findIndex(et=>Ie(et)===Ie(Y))===fe);if(!Vt){se(new Set(V.map(Ie)));return}const{itemKnowness:ee,cardKnowness:ie}=await dn(),X=ma.filter(Y=>Rt(Y.childItemType)==="collection"&&Y.childItemId===v&&!Rt(Y.childCheckType)&&!Rt(Y.childDirection)),be=new Set;for(const Y of V){if(Y.cardType!=="info"){be.add(Ie(Y));continue}if(!Pa(Y,ie))continue;const fe=ma.filter(ot=>Di(ot,Y)).concat(X);if(fe.length===0){be.add(Ie(Y));continue}let Be=0;for(const ot of fe)if(Rt(ot.parentItemType)==="collection")Be+=await $a(ot.parentItemId,ie);else if(Rt(ot.parentCheckType)||Rt(ot.parentDirection)){const ht=Rt(ot.parentCheckType),xt=Rt(ot.parentDirection),kt=oa(ot.parentItemType,ot.parentItemId,ht,xt);Be+=ie.get(kt)??0}else{const ht=`${ot.parentItemType}:${ot.parentItemId}`;Be+=ee.get(ht)??0}Be/fe.length>=da&&be.add(Ie(Y))}se(be)},un=p=>{for(let T=p;T<ge.length;T+=1){const V=ge[T];if(V&&(!Vt||V.cardType!=="info"||d.has(Ie(V))))return T}return-1},Ha=p=>!Vt||p.cardType!=="info"||d.has(Ie(p)),_n=p=>{if(w.id!=="temporal"&&w.id!=="levels")return null;const T=Ze,V=(T.active??[]).concat(T.pool??[]),ee=new Set;for(const ie of V){const X=Ie(ie);if(!(ee.has(X)||p.has(X))&&(ee.add(X),Ha(ie)))return ie}return null},ua=n.useMemo(()=>{if(w.id!=="levels")return null;const p=Ze,T=p.pool??[],V=p.active??[],ee=p.levelMap??{},ie=Math.max(1,Number(y.levels??1)),X=Array.from({length:ie},()=>0),be=new Set(V.map(et=>Ie(et)));T.forEach(et=>{const ot=Math.min(ie,Math.max(1,ee[Ie(et)]??1));X[ot-1]+=1});const Y=T.length||1,fe=X.map(et=>et/Y*100),Be=Ce?ee[Ie(Ce)]??1:null;return{counts:X,percentages:fe,currentLevel:Be,levelsCount:ie,activeCount:V.length,poolCount:T.length,activeSet:be}},[Ze,y,w,Ce]),Ea=n.useMemo(()=>{if(w.id!=="temporal")return null;const p=Ze,T=p.pool??[],V=p.active??[],ee=p.knownessMap??{},ie=new Set(p.unknownSet??[]);let X=0;T.forEach(fe=>{(ee[Ie(fe)]??0)>1&&(X+=1)});const be=ie.size,Y=V.map(fe=>({id:Ie(fe),value:ie.has(Ie(fe))?0:Math.max(0,Math.min(1,ee[Ie(fe)]??0))}));return{knownCount:X,unknownCount:be,dots:Y}},[Ze,w]),Vn=n.useMemo(()=>{if(!Vt)return 0;const p=Ze;return ge.concat(p.active??[]).concat(p.pool??[]).filter((V,ee,ie)=>ie.findIndex(X=>Ie(X)===Ie(V))===ee).filter(V=>V.cardType==="info"&&!d.has(Ie(V))).length},[Vt,Ze,ge,d]);n.useEffect(()=>{if(!Vt||Se!=="ready")return;const p=Ze,V=ge.concat(p.active??[]).concat(p.pool??[]).filter((X,be,Y)=>Y.findIndex(fe=>Ie(fe)===Ie(X))===be).filter(X=>X.cardType!=="info"||d.has(Ie(X))).length,ee=Bt.current;if(Bt.current=V,ee===null||V<=ee)return;const ie=V-ee;jt(`New card available (+${ie})`),ea.current&&window.clearTimeout(ea.current),ea.current=window.setTimeout(()=>jt(null),2200)},[Vt,Se,Ze,ge,d]),n.useEffect(()=>()=>{ea.current&&window.clearTimeout(ea.current)},[]);const Dt=(p,T)=>{const V=w.applyOutcome({queue:ge,meta:Ze},Ce,k,y,{correct:p,correctness:T,createdUtc:new Date().toISOString()});M(V.queue),it(V.meta);const ee=V.queue[W+1];ee&&wa(ee,W+1)};n.useEffect(()=>{if(ne&&A){ks(u,A).then(p=>de(p.name)).catch(()=>de(t.cogita.library.collections.defaultName));return}if(P==="info"&&_){la({libraryId:u,infoId:_}).then(p=>{const T=p.payload??{};de(T.title||T.label||T.name||_)}).catch(()=>de(_||t.cogita.library.revision.runKicker));return}if(P==="info-selection"){const p=re?qs(u,re):null,T=(p==null?void 0:p.infoIds.length)??0;de(T>0?`Selected infos (${T})`:"Selected infos");return}de(t.cogita.library.collections.defaultName)},[t,A,ne,u,P,_,re]),n.useEffect(()=>{ws({libraryId:u,type:"language"}).then(p=>Ve(p)).catch(()=>Ve([]))},[u]),n.useEffect(()=>{ne&&xs({libraryId:u}).then(p=>x(p.items??[])).catch(()=>x([]))},[ne,u]),n.useEffect(()=>{ss(u,R)},[u,R]),n.useEffect(()=>{Qa(ge)},[ge,ma,Vt,da,A]),n.useEffect(()=>{if(!Ce||!Vt){Ge(!1);return}if(Ce.cardType!=="info"||d.has(Ie(Ce))){Ge(!1);return}const p=un(W+1);if(p>=0){Ge(!1),ze(p);return}if(w.id==="temporal"||w.id==="levels"){const T=ge.slice(0,W+1),V=ge.slice(W+1).filter(Ha),ee=T.concat(V),ie=new Set(ee.map(Ie)),X=_n(ie);if(X){const Y=Ie(X);ie.has(Y)||(ee.push(X),ie.add(Y),it(fe=>{const Be=fe,et=new Set(Be.queued??[]);return et.add(Y),{...Be,queued:et}}))}const be=ee.findIndex((Y,fe)=>fe!==W&&Ha(Y));if(be>=0){M(ee),ze(be),Ge(!1);return}}Ge(!0)},[Ce,d,Vt,W,ge,Ze,w.id]),n.useEffect(()=>{let p=!0;return(async()=>{oe("loading"),Oe({current:0,total:w.id==="levels"||w.id==="random-once"?0:w.getFetchLimit(k,y)});try{if(!ne){if(x([]),P==="info"){if(!_){p&&(M([]),x([]),it({}),ze(0),oe("ready"));return}const[ot,ht]=await Promise.all([xn({libraryId:u,infoId:_}),wn({libraryId:u,infoId:_})]);if(!p)return;const xt=en(ot.items??[]);x(ht.items??[]);const kt=w.prepare(xt,k,y);M(kt.queue),it(kt.meta),ze(0),oe("ready"),Oe({current:xt.length,total:xt.length});return}if(P==="info-selection"){const ot=re?qs(u,re):null,ht=(ot==null?void 0:ot.infoIds)??[];if(!ht.length){p&&(M([]),x([]),it({}),ze(0),oe("ready"));return}const xt=await Promise.all(ht.map(async Ta=>{const[Yt,mn]=await Promise.all([xn({libraryId:u,infoId:Ta}),wn({libraryId:u,infoId:Ta})]);return{cards:Yt.items??[],deps:mn.items??[]}}));if(!p)return;const kt=new Map;xt.forEach(Ta=>{en(Ta.cards).forEach(Yt=>{kt.set(Ie(Yt),Yt)})});const Nt=Array.from(kt.values()),St=new Set(Nt.map(Ie)),qt=new Map;xt.forEach(Ta=>{(Ta.deps??[]).forEach(Yt=>{const mn=oa(Yt.parentItemType,Yt.parentItemId,Rt(Yt.parentCheckType),Rt(Yt.parentDirection)),Ls=oa(Yt.childItemType,Yt.childItemId,Rt(Yt.childCheckType),Rt(Yt.childDirection));if(!St.has(mn)||!St.has(Ls))return;const As=`${mn}->${Ls}`;qt.has(As)||qt.set(As,Yt)})}),x(Array.from(qt.values()));const Aa=w.prepare(Nt,k,y);M(Aa.queue),it(Aa.meta),ze(0),oe("ready"),Oe({current:Nt.length,total:Nt.length});return}}const V=[];let ee=null,ie=null;do{const ot=await tn({libraryId:u,collectionId:A,limit:300,cursor:ee});if(V.push(...ot.items),(w.id==="levels"||w.id==="temporal"||w.id==="random-once")&&ot.total&&(ie=ot.total),Oe(ht=>({current:V.length,total:ht.total||ot.total||w.getFetchLimit(k,y)})),ee=ot.nextCursor??null,ie!==null&&V.length>=ie||w.id!=="levels"&&w.id!=="temporal"&&w.id!=="random-once"&&V.length>=w.getFetchLimit(k,y))break}while(ee);if(!p)return;const X=en(V);let be;if(w.id==="levels"){const ot=Math.max(1,Number(y.levels??1)),xt=(await ba()).reduce((kt,Nt)=>{const St=oa(Nt.itemType,Nt.itemId,Nt.checkType,Nt.direction);return kt[St]||(kt[St]=[]),kt[St].push(Nt),kt},{});be={},X.forEach(kt=>{const Nt=Ie(kt),St=xt[Nt]??[],qt=St.length>0?fa(St).score:0,Aa=Math.max(1,Math.min(ot,Math.ceil(qt/100*ot)));be[Nt]=Aa})}let Y=null,fe=null,Be=null;if(w.id==="temporal"){const ot=await ba(),ht=new Set(X.map(Nt=>Ie(Nt))),xt=ot.reduce((Nt,St)=>{const qt=oa(St.itemType,St.itemId,St.checkType,St.direction);return ht.has(qt)&&(Nt[qt]||(Nt[qt]=[]),Nt[qt].push(St)),Nt},{});Y={},fe=new Set,Be={};const kt=Date.now();X.forEach(Nt=>{const St=Ie(Nt),qt=xt[St]??[];if(qt.length===0){Y[St]=0,fe.add(St),Be[St]=[];return}const Aa=Cs(qt);Be[St]=Aa;const Ta=En(Aa,kt);Y[St]=Ta.knowness})}const et=w.id==="levels"?Ms(X,k,y,be):w.id==="temporal"?Is(X,k,y,Y??{},fe??new Set,Be??{}):w.prepare(X,k,y);M(et.queue),it(et.meta),ze(0),oe("ready"),Oe(ot=>({current:Math.min(ot.current,ot.total),total:ot.total}))}catch{p&&oe("error")}})(),()=>{p=!1}},[A,ne,u,k,P,y,w,R,_,re]),n.useEffect(()=>{if(Ee(""),D(null),$t(null),Lt(0),K([]),J({}),ce({}),F(null),te(null),le(null),wt(null),Fe(null),Je(null),je(ta()),ut(!1),ct(!1),bt(null),Re(null),rt({}),!Ce){Ye(null),qe(null),N(null),wt(null),Fe(null),Je(null),je(ta()),Mt(null);return}Ce.cardType==="info"&&Ce.infoType==="computed"&&Ye(t.cogita.library.revision.loadingComputed);let p=!0;return wa(Ce,W).then(T=>{!p||!T||(Ye(T.prompt),qe(T.expectedAnswer),K(T.computedExpected),J(T.computedAnswers),N(T.computedValues),F(T.answerTemplate),te(T.outputVariables),le(T.variableValues),wt(T.questionPrompt),Fe(T.questionPromptModel),Je(T.questionExpectedModel),je(T.questionInitialAnswers))}),()=>{p=!1}},[Ce,t]),n.useEffect(()=>{if(!Ce||Ce.cardType!=="info"||Ce.infoType!=="citation"){dt.current=null,mt.current=new Set,Me(null);return}const p=Ce.description??"",T=(Ce.label??"").trim(),V=T.replace(/\s+/g," ").trim(),ee=p.replace(/\s+/g," ").trim(),ie=V&&V!==ee?T:t.cogita.library.infoTypes.citation;if(!p){Me(null),qe(null);return}const X=Ia(p);dt.current=X,Ye(ie);let be=!0;return dn().then(({fragmentKnowness:Y})=>{if(!be)return;const fe=new Set,Be={};Y.forEach((ht,xt)=>{const[kt,Nt]=xt.split(":",2);if(kt!==Ce.cardId)return;const St=Zt(Nt);if(!St)return;const{fragmentId:qt}=St;Be[qt]=ht,ht>=da&&fe.add(qt)}),mt.current=fe,Et.current=Be;const et=Zt(Ce.direction);if(et!=null&&et.fragmentId&&X.nodes[et.fragmentId]){L(X,et.fragmentId,ie);return}const ot=Da(X,fe,Be,da,Vt,Ce.direction);L(X,(ot==null?void 0:ot.id)??null,ie)}).catch(()=>{mt.current=new Set,Et.current={};const Y=Zt(Ce.direction);if(Y!=null&&Y.fragmentId&&X.nodes[Y.fragmentId]){L(X,Y.fragmentId,ie);return}const fe=Da(X,mt.current,{},da,Vt,Ce.direction);L(X,(fe==null?void 0:fe.id)??null,ie)}),()=>{be=!1}},[Ce,t,Vt,da]),n.useEffect(()=>{if(!Ce||Ce.cardType!=="vocab"||Ce.checkType!=="translation-match"){Re(null),rt({});return}const V=(Ze.pool??Ze.active??ge).filter(Y=>Y.cardType==="vocab"&&Y.checkType==="translation-match").filter((Y,fe,Be)=>Be.findIndex(et=>et.cardId===Y.cardId)===fe);V.some(Y=>Y.cardId===Ce.cardId)||V.unshift(Ce);const ie=ia(V).slice(0,6).map(Y=>{const fe=Y.label.split("↔").map(ot=>ot.trim()).filter(Boolean);if(fe.length<2)return null;const Be=`${Y.cardId}:L`,et=`${Y.cardId}:R`;return{cardId:Y.cardId,leftId:Be,rightId:et,leftLabel:fe[0],rightLabel:fe[1]}}).filter(Boolean),X=ie.map(Y=>Y.leftId),be=ia(ie.map(Y=>Y.rightId));Re({pairs:ie,leftOrder:X,rightOrder:be,selection:{},activeLeft:null,activeRight:null,locked:{}})},[Ce,ge,Ze]),n.useEffect(()=>()=>{gt.current&&window.clearTimeout(gt.current),tt.current&&window.clearTimeout(tt.current)},[]);const Wt=n.useRef(null);n.useEffect(()=>{if(!Ce)return;const p=Ie(Ce),T=typeof document<"u"?document.activeElement:null;if(Wt.current===p&&T&&(T.tagName==="INPUT"||T.tagName==="TEXTAREA"))return;let V=0;const ee=()=>{if(Ce){if(Ce.cardType==="info"&&Ce.infoType==="computed"){if($.length>0){const X=An(Z,$,B),be=X?zt.current[X]:null;if(be&&(be.focus(),document.activeElement===be)){Wt.current=p;return}}if(It.current&&(It.current.focus(),document.activeElement===It.current)){Wt.current=p;return}}else if(Ce.cardType==="vocab"&&It.current&&(It.current.focus(),document.activeElement===It.current)){Wt.current=p;return}V<6&&(V+=1,window.setTimeout(ee,40))}},ie=window.setTimeout(ee,40);return()=>window.clearTimeout(ie)},[Ce,$,Z,B]),n.useEffect(()=>{if(!Pt)return;const p=T=>{T.key==="Enter"&&(T.preventDefault(),Va())};return window.addEventListener("keydown",p),()=>window.removeEventListener("keydown",p)},[Pt]);const Ka=p=>{Ct(p),Mt(fa(p))};n.useEffect(()=>{if(!Ce){Mt(null),Ct([]);return}const p=Ce.cardType==="info"?"info":"connection";if(Ce.cardType==="info"&&Ce.infoType==="citation"){ba().then(T=>{const V=T.filter(ee=>ee.itemType==="info"&&ee.itemId===Ce.cardId&&ee.checkType==="quote-fragment"&&Mn(ee.direction,Ce.direction));Ka(V)}).catch(()=>{Mt(null),Ct([])});return}Cn(p,Ce.cardId,Ce.checkType,Ce.direction).then(T=>Ka(T)).catch(()=>{Mt(null),Ct([])})},[u,Ce,R]);const Fa=(p,T,V,ee)=>{if(p==="info"&&V==="quote-fragment"){ba().then(ie=>{const X=ie.filter(be=>be.itemType==="info"&&be.itemId===T&&be.checkType==="quote-fragment"&&Mn(be.direction,ee));Ka(X)}).catch(()=>{Mt(null),Ct([])});return}Cn(p,T,V,ee).then(ie=>Ka(ie)).catch(()=>{Mt(null),Ct([])})},Sa=(p,T,V)=>{var be;const ee=((be=V.pairs.find(Y=>Y.leftId===p))==null?void 0:be.rightId)??null;if(!ee)return V;const ie=ee===T;rt(Y=>({...Y,[p]:ie?"correct":"incorrect"})),gt.current&&window.clearTimeout(gt.current),tt.current&&window.clearTimeout(tt.current),He.current+=1;const X={kind:ie?"correct":"incorrect",tick:He.current};if(vt(null),gt.current=window.setTimeout(()=>vt(X),0),tt.current=window.setTimeout(()=>vt(null),420),ie){const Y={...V.locked,[p]:!0};return Object.keys(Y).length>=V.pairs.length?(D("correct"),ct(!0)):D("correct"),{...V,selection:{...V.selection,[p]:T},activeLeft:null,activeRight:null,locked:Y}}return D("incorrect"),{...V,activeLeft:null,activeRight:null}},qn=p=>{Re(T=>!T||T.locked[p]?T:T.activeRight?Sa(p,T.activeRight,T):{...T,activeLeft:T.activeLeft===p?null:p})},_a=p=>{Re(T=>T&&(T.activeLeft?Sa(T.activeLeft,p,T):{...T,activeRight:T.activeRight===p?null:p}))},hn=p=>{je(T=>{if(at!=null&&at.multiple){const V=T.selection.includes(p)?T.selection.filter(ee=>ee!==p):Array.from(new Set([...T.selection,p]));return{...T,selection:V}}return{...T,selection:T.selection[0]===p?[]:[p]}})},Dn=(p,T)=>{je(V=>{var fe;const ee=Math.max(2,((fe=at==null?void 0:at.columns)==null?void 0:fe.length)??2),ie=Array.from({length:ee},(Be,et)=>V.matchingSelection[et]??null);if(ie[p]=ie[p]===T?null:T,ie.some(Be=>Be==null))return{...V,matchingSelection:ie};const X=ie.map(Be=>Number(Be)),be=X.join("|"),Y=V.matchingRows.some(Be=>Be.join("|")===be);return{...V,matchingRows:Y?V.matchingRows:[...V.matchingRows,X],matchingSelection:new Array(ee).fill(null)}})},Bn=(p,T)=>{je(V=>{const ee=[...V.ordering],ie=p+T;return ie<0||ie>=ee.length?V:([ee[p],ee[ie]]=[ee[ie],ee[p]],{...V,ordering:ee})})},Va=()=>{var p;if(Ce&&Ce.cardType==="info"&&Ce.infoType==="citation"&&dt.current&&we&&!((p=Zt(Ce.direction))!=null&&p.fragmentId)){const T=Da(dt.current,mt.current,Et.current,da,Vt,Ce.direction,we.fragmentId);if(T){D(null),Ee(""),ut(!1),ce({}),ct(!1),$t(null),Lt(0),L(dt.current,T.id,we.title);return}}D(null),Ee(""),ut(!1),ce({}),ct(!1),$t(null),Lt(0),ze(T=>Math.min(T+1,ge.length))},ra=p=>{if(!Ce)return;const T=p.expected??null,V=p.answer??"";let ee=T??"",ie=V;if(!T&&p.expectedMap&&p.answerMap){const ot=Object.keys(p.expectedMap).sort((ht,xt)=>ht.localeCompare(xt));ee=ot.map(ht=>{var xt;return((xt=p.expectedMap)==null?void 0:xt[ht])??""}).join("|"),ie=ot.map(ht=>{var xt;return((xt=p.answerMap)==null?void 0:xt[ht])??""}).join("|")}const X=ee?Ba(ee,ie,Na):new Uint8Array,be={revisionType:w.id,evalType:p.evalType,direction:p.direction,prompt:he??"",expected:T,answer:V,expectedAnswers:p.expectedMap??null,answers:p.answerMap??null,correct:p.correct,maskBase64:X.length?Ca(X):null,values:I??null,checkMode:Q,compareMode:Na,minCorrectness:cn},Y=new TextEncoder().encode(JSON.stringify(be)),fe=Ce.cardType==="info"?"info":"connection",Be=p.overrideCheckType??Ce.checkType??null,et=p.overrideDirection??Ce.direction??null;Tn({itemType:fe,itemId:Ce.cardId,checkType:Be,direction:et,revisionType:w.id,evalType:p.evalType,correct:p.correct,maskBase64:X.length?Ca(X):null,payloadBase64:Ca(Y),personRoleId:R??null}).then(()=>{Fa(fe,Ce.cardId,Be,et),Qa(ge),ss(u,R)}).catch(()=>{})},zn=(p,T)=>{const V=Qt.current.get(T);if(V)return Promise.resolve(V);const ee=_t.current.get(T);if(ee)return ee;const ie=la({libraryId:u,infoId:p}).then(X=>{var ot,ht;const be=X.payload,Y=((ot=be.definition)==null?void 0:ot.graph)??null,fe="",Be=((ht=be.definition)==null?void 0:ht.answerTemplate)??"",et=Ki(Y,fe,Be);if(et){const kt={sample:Fi(et),answerTemplate:Be||null};return Qt.current.set(T,kt),kt}return cs({libraryId:u,infoId:p}).then(xt=>{const kt={sample:xt,answerTemplate:null};return Qt.current.set(T,kt),kt})}).catch(()=>cs({libraryId:u,infoId:p}).then(X=>{const be={sample:X,answerTemplate:null};return Qt.current.set(T,be),be}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{_t.current.delete(T)});return _t.current.set(T,ie),ie},wa=(p,T)=>{var Y;const V=`${Ie(p)}:${T}`,ee=Kt.current.get(V);if(ee)return Promise.resolve(ee);const ie=na.current.get(V);if(ie)return ie;const X=fe=>{const Be={...fe,questionPrompt:fe.questionPrompt??null,questionPromptModel:fe.questionPromptModel??null,questionExpectedModel:fe.questionExpectedModel??null,questionInitialAnswers:fe.questionInitialAnswers??ta()};return Kt.current.set(V,Be),Be};let be;if(p.cardType==="vocab"){if(p.checkType==="translation-match")return be=Promise.resolve(X({prompt:p.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),be;const fe=p.label.split("↔").map(Be=>Be.trim()).filter(Boolean);if(fe.length>=2){const et=(p.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",ot=et?fe[0]:fe[1],ht=et?fe[1]:fe[0];be=Promise.resolve(X({prompt:ot,expectedAnswer:ht,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else be=Promise.resolve(X({prompt:p.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(p.cardType==="info"&&p.infoType==="word"){const fe=(Y=p.description)!=null&&Y.startsWith("Language: ")?p.description.replace("Language: ",""):null;be=Promise.resolve(X({prompt:p.label,expectedAnswer:fe,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(p.cardType==="info"&&p.infoType==="question"){const fe=In(p.payload??null,p.label);fe?be=Promise.resolve(X({prompt:fe.promptText,expectedAnswer:fe.promptModel.kind==="text"&&(typeof fe.expectedModel=="string"||typeof fe.expectedModel=="number")?String(fe.expectedModel):null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null,questionPrompt:fe.promptPayload,questionPromptModel:fe.promptModel,questionExpectedModel:fe.expectedModel,questionInitialAnswers:fe.initialAnswers})):be=la({libraryId:u,infoId:p.cardId}).then(Be=>{const et=In(Be.payload??{},p.label);return X(et?{prompt:et.promptText,expectedAnswer:et.promptModel.kind==="text"&&(typeof et.expectedModel=="string"||typeof et.expectedModel=="number")?String(et.expectedModel):null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null,questionPrompt:et.promptPayload,questionPromptModel:et.promptModel,questionExpectedModel:et.expectedModel,questionInitialAnswers:et.initialAnswers}:{prompt:p.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})}).catch(()=>X({prompt:p.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{na.current.delete(V)})}else p.cardType==="info"&&p.infoType==="computed"?be=zn(p.cardId,V).then(fe=>{var xt,kt;if(!fe.sample)return X({prompt:p.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const Be=fe.sample,et=Be.expectedAnswers?Object.entries(Be.expectedAnswers).map(([Nt,St])=>({key:Nt,expected:St})):[],ot=et.reduce((Nt,St)=>(Nt[St.key]="",Nt),{}),ht=Be.expectedAnswerIsSentence&&((xt=Be.expectedAnswer)==null?void 0:xt.trim())||null;return X({prompt:Be.prompt,expectedAnswer:et.length>0?ht:((kt=Be.expectedAnswer)==null?void 0:kt.trim())||null,computedExpected:et,computedAnswers:ot,computedValues:Be.values??null,answerTemplate:fe.answerTemplate,outputVariables:Be.outputVariables??null,variableValues:Be.variableValues??null})}).catch(()=>X({prompt:p.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{na.current.delete(V)}):be=Promise.resolve(X({prompt:p.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return na.current.set(V,be),be},L=(p,T,V)=>{const ee=Object.keys(p.nodes).length,ie=mt.current.size;if(!T){Me({title:V,before:p.text,after:"",fragmentId:null,total:ee,completed:ie}),qe(null),ct(!0);return}const X=p.nodes[T];if(!X)return;const be=$n(p.text,X);Me({title:V,before:be.before,after:be.after,fragmentId:X.id,total:ee,completed:ie}),qe(be.fragment),ct(!1)},O=()=>{const p=dt.current;p&&Me(T=>T&&{...T,total:Object.keys(p.nodes).length,completed:mt.current.size})},ue=()=>{const p=ge[W+1];p&&wa(p,W+1)},_e=()=>{if(ue(),Ce&&Ce.cardType==="vocab"&&Ce.checkType==="translation-match"&&pe){if(pe.pairs.length===0){D("incorrect"),ct(!0);return}const X=pe.pairs.reduce((ht,xt)=>(ht[xt.rightId]=xt.rightLabel,ht),{});let be=0;const Y={};pe.pairs.forEach(ht=>{const kt=pe.selection[ht.leftId]===ht.rightId;Y[ht.leftId]=kt?"correct":"incorrect",kt&&(be+=1)});const fe=pe.pairs.length||1,Be=be/fe,et=be===pe.pairs.length;rt(ht=>({...ht,...Y})),et?(D("correct"),ct(!0),Lt(0)):(D("incorrect"),ct(!1),Lt(ht=>{const xt=ht+1;return xt>=sa&&(ut(!0),ct(!0),Re(kt=>{if(!kt)return kt;const Nt=kt.pairs.reduce((St,qt)=>(St[qt.leftId]=qt.rightId,St),{});return{...kt,selection:Nt}})),xt})),Dt(et,Be);const ot="connection";Promise.all(pe.pairs.map(ht=>{const xt=pe.selection[ht.leftId]??null,kt=xt?X[xt]:"",Nt={left:ht.leftLabel,expected:ht.rightLabel,answer:kt,checkType:"translation-match"},St=new TextEncoder().encode(JSON.stringify(Nt));return Tn({itemType:ot,itemId:ht.cardId,checkType:"translation-match",direction:null,revisionType:w.id,evalType:"translation-match",correct:xt===ht.rightId,maskBase64:null,payloadBase64:Ca(St),personRoleId:R??null})})).then(()=>{Fa(ot,Ce.cardId,Ce.checkType,Ce.direction),ss(u,R)}).catch(()=>{});return}if(Ce&&Ce.cardType==="info"&&Ce.infoType==="question"&&yt){const X={text:Ue.text,selection:Ue.selection,booleanAnswer:Ue.booleanAnswer,ordering:Ue.ordering,matchingPaths:Ue.matchingRows},be=Xt({prompt:yt,expected:ve,answer:X}),Y=be.mask?ya(be.mask):be.correct?100:0;$t(be.mask),be.correct?(D("correct"),ce({}),ct(!0),Lt(0),Dt(!0,Y/100)):(D("incorrect"),ce({}),ct(!1),Lt(fe=>{const Be=fe+1;return Be>=sa&&(ut(!0),ct(!0)),Be}),Dt(!1,Y/100)),ra({correct:be.correct,direction:he?`${he} -> question`:"question",expected:JSON.stringify(ve??null),answer:JSON.stringify(X),evalType:`question:${yt.kind}`});return}if($.length>0){const X=$.reduce((Y,fe)=>{const Be=q[fe.key]??"";return Y[fe.key]=Ut(Be)===Ut(fe.expected)?"correct":"incorrect",Y},{});$.every(({key:Y,expected:fe})=>{const Be=q[Y]??"";return Q==="exact"&&Ut(Be)===Ut(fe)})?(D("correct"),ce(X),ct(!0),Lt(0),Dt(!0,1),ra({correct:!0,direction:he?`${he} -> computed`:"computed",expectedMap:$.reduce((Y,fe)=>(Y[fe.key]=fe.expected,Y),{}),answerMap:q,evalType:"computed"})):(D("incorrect"),ce(X),ct(!1),Lt(Y=>{const fe=Y+1;return fe>=sa&&Xe&&(ut(!0),ct(!0)),fe}),Dt(!1,0),window.setTimeout(()=>{var fe;const Y=An(Z,$,B);Y&&zt.current[Y]&&((fe=zt.current[Y])==null||fe.focus())},40),ra({correct:!1,direction:he?`${he} -> computed`:"computed",expectedMap:$.reduce((Y,fe)=>(Y[fe.key]=fe.expected,Y),{}),answerMap:q,evalType:"computed"}));return}if(Ce&&Ce.cardType==="info"&&Ce.infoType==="citation"&&(we!=null&&we.fragmentId)){if(!U)return;const X=Zt(Ce.direction),be=(X==null?void 0:X.fragmentId)??we.fragmentId,Y=an(U,Te,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),fe=Y.mask,Be=Y.isCorrect,et=Y.percent;Be?(Et.current[we.fragmentId]=Math.max(Et.current[we.fragmentId]??0,et),(Et.current[we.fragmentId]??0)>=da&&mt.current.add(we.fragmentId),O(),D("correct"),ce({}),ct(!0),$t(fe),Lt(0),et<100&&sa<=1&&ut(!0),Dt(!0,et/100),ra({correct:!0,direction:`quote:${we.fragmentId}`,expected:U,answer:Te,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:be})):(D("incorrect"),ce({}),ct(!1),$t(fe),Lt(ot=>{const ht=ot+1;return ht>=sa&&Xe&&(ut(!0),ct(!0)),ht}),Dt(!1,et/100),window.setTimeout(()=>{var ot;return(ot=It.current)==null?void 0:ot.focus()},40),ra({correct:!1,direction:`quote:${we.fragmentId}`,expected:U,answer:Te,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:be}));return}if(!U)return;const p=Ba(U,Te,Na),T=Q==="exact"&&Ut(Te)===Ut(U),V=La(p),ee=T||V,ie=ya(p);ee?(D("correct"),ce({}),ct(!0),$t(p),Lt(0),ie<100&&sa<=1&&ut(!0),Dt(!0,ie/100),ra({correct:!0,direction:he?`${he} -> ${U}`:null,expected:U,answer:Te,evalType:"text"})):(D("incorrect"),ce({}),ct(!1),$t(p),Lt(X=>{const be=X+1;return be>=sa&&Xe&&(ut(!0),ct(!0)),be}),Dt(!1,ie/100),window.setTimeout(()=>{var X;return(X=It.current)==null?void 0:X.focus()},40),ra({correct:!1,direction:he?`${he} -> ${U}`:null,expected:U,answer:Te,evalType:"text"}))},De=p=>{if(ue(),!U)return;const T=Ba(U,p,Na),V=Ut(p)===Ut(U),ee=La(T),ie=V||ee,X=ya(T);ie?(D("correct"),ce({}),ct(!0),$t(T),Lt(0),X<100&&sa<=1&&ut(!0),Dt(!0,X/100),ra({correct:!0,direction:"word->language",expected:U,answer:p,evalType:"language-select"})):(D("incorrect"),ce({}),ct(!1),$t(T),Lt(be=>{const Y=be+1;return Y>=sa&&Xe&&(ut(!0),ct(!0)),Y}),Dt(!1,X/100),ra({correct:!1,direction:"word->language",expected:U,answer:p,evalType:"language-select"}))},xe=()=>{ue(),D("correct"),ct(!0),Lt(0),Dt(!0,1),U&&ra({correct:!0,direction:"manual",expected:U,answer:Te,evalType:"manual"})},Ke=()=>{if(Dt(!1,0),Ce&&Ce.cardType==="info"&&Ce.infoType==="citation"){D(null),Ee(""),ut(!1),ce({}),ct(!1),$t(null),Lt(0),ze(p=>Math.min(p+1,ge.length));return}Va()};n.useEffect(()=>{ue()},[W,ge]);const Pe=p=>{var V;if(p.key!=="Enter")return;if(p.preventDefault(),p.stopPropagation(),Pt){Va();return}const T=$.find(ee=>!(q[ee.key]??"").trim());if(T){(V=zt.current[T.key])==null||V.focus();return}_e()},Ae=t.cogita.library.revision.revealModeAfterIncorrect,Xe=$.length>0||!!U||(Ce==null?void 0:Ce.cardType)==="info"&&Ce.infoType==="question"&&yt!==null;return e.jsxs(Ft,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,children:[Se==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${H.total?Math.min(100,Math.max(0,H.current/H.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:H.total?`${Math.min(H.current,H.total)} / ${H.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:$e}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",ke).replace("{check}",Le)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:E,children:t.cogita.library.actions.libraryOverview}),ne?e.jsxs(e.Fragment,{children:[e.jsx("a",{className:"cta ghost",href:`${E}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${E}/collections/${A}`,children:t.cogita.library.actions.collectionDetail})]}):e.jsx("a",{className:"cta ghost",href:`${E}/infos`,children:t.cogita.library.actions.allCards})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Tt?`${Tt.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[ua?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",ua.currentLevel??"-"," / ",ua.levelsCount]}):null,Tt?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(Tt.correct)).replace("{total}",String(Tt.total))}),Tt.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(Tt.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(_i,{outcomes:pt})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[Jt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:Jt})}):null,e.jsx(Ja,{feedbackToken:lt?`${lt.kind}-${lt.tick}`:Gt?"idle":st?`${st}-${W}-${aa}`:"idle",children:Ce?e.jsx(e.Fragment,{children:me?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(Ss,{copy:t,currentCard:Ce,currentTypeLabel:Ot,prompt:he,languages:ae,answer:Te,onAnswerChange:p=>Ee(T=>Ln(T,p,Qe)),computedExpected:$,computedAnswers:q,onComputedAnswerChange:(p,T)=>J(V=>({...V,[p]:Ln(V[p]??"",T,Qe)})),answerTemplate:Z,outputVariables:B,variableValues:ye,computedFieldFeedback:G,feedback:st,canAdvance:Pt,quoteContext:we,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:_e,onSkip:Ke,onLanguageSelect:De,onMarkReviewed:xe,onAdvance:Va,showCorrectAnswer:We,setShowCorrectAnswer:ut,onRevealCorrect:()=>ct(!0),answerMask:xa,expectedAnswer:U,hasExpectedAnswer:Xe,handleComputedKeyDown:Pe,answerInputRef:It,computedInputRefs:zt,scriptMode:Qe,setScriptMode:bt,matchPairs:pe==null?void 0:pe.pairs,matchLeftOrder:pe==null?void 0:pe.leftOrder,matchRightOrder:pe==null?void 0:pe.rightOrder,matchSelection:pe==null?void 0:pe.selection,matchActiveLeft:pe==null?void 0:pe.activeLeft,matchActiveRight:pe==null?void 0:pe.activeRight,matchFeedback:nt,onMatchLeftSelect:qn,onMatchRightSelect:_a,questionPrompt:at,questionAnswers:Ue,questionRevealExpected:We?ve:void 0,onQuestionTextChange:p=>{Ee(p),je(T=>({...T,text:p}))},onQuestionSelectionToggle:hn,onQuestionBooleanChange:p=>je(T=>({...T,booleanAnswer:p})),onQuestionOrderingMove:Bn,onQuestionMatchingPick:Dn,onQuestionMatchingRemovePath:p=>je(T=>({...T,matchingRows:T.matchingRows.filter((V,ee)=>ee!==p)}))})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:ne?`${E}/collections/${A}`:`${E}/infos`,children:ne?t.cogita.library.actions.collectionDetail:t.cogita.library.actions.allCards})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Ma?`${ln} / ${Ma}`:t.cogita.library.revision.progressUnlimited}),Se==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),Se==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),Se==="ready"&&ge.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Ae}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",sa]})]})]}),ua?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",ua.activeCount," / ",ua.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:ua.counts.map((p,T)=>{const V=T+1,ee=ua.currentLevel===V,ie=ua.percentages[T]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":ee,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:V}),e.jsx("strong",{children:p})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,ie))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[ie.toFixed(1),"%"]})]},`level-${V}`)})})]}):null,Ea?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:Ea.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:Ea.dots.map(p=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,p.value*100))}%`,background:`rgba(${Math.round(255*(1-p.value))}, ${Math.round(200*p.value)}, 80, 0.9)`}},p.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:Ea.knownCount})]})]}):null,Vt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Vn})]})}):null]})]})]})})})]})]})}function Jo(t){if(t==null)return"";try{return JSON.stringify(t,null,2)}catch{return""}}function ui(t){const a=t.trim();if(!a)return{value:null,error:null};try{const s=JSON.parse(a);return!s||typeof s!="object"||Array.isArray(s)?{value:null,error:"Settings JSON must be an object."}:{value:s,error:null}}catch{return{value:null,error:"Invalid settings JSON."}}}function Qo({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,libraryId:u,revisionId:v,mode:r="search",sessionId:c,onCreated:E,onOpenSession:m,onRequestEdit:k,onRequestOverview:S}){const[w,y]=n.useState(""),[Q,R]=n.useState(""),[b,P]=n.useState("all"),[_,re]=n.useState([]),[C,z]=n.useState("loading"),[A,ne]=n.useState(""),[ke,Le]=n.useState("simultaneous"),[$e,de]=n.useState("panel"),[ge,M]=n.useState("question"),[ae,Ve]=n.useState(""),[Se,oe]=n.useState("idle"),[H,Oe]=n.useState(null),[W,ze]=n.useState("none"),[Te,Ee]=n.useState(null),st=`/#/cogita/library/${u}`,D=async()=>{z("loading");try{const ve=await Ti({libraryId:u,revisionId:v});re(ve),z("ready")}catch{re([]),z("error")}};n.useEffect(()=>{Rn({libraryId:u,revisionId:v}).then(ve=>{y(ve.name),A.trim()||ne(ve.name)}).catch(()=>y(v))},[A,u,v]),n.useEffect(()=>{D()},[u,v]);const he=n.useMemo(()=>c?_.find(ve=>ve.sessionId===c)??null:null,[_,c]);n.useEffect(()=>{if(!c||r!=="detail"&&r!=="edit"){Oe(null),oe("idle");return}let ve=!1;return oe("loading"),Ns({libraryId:u,sessionId:c}).then(Je=>{if(ve)return;Oe(Je);const Ue=Je.sessionSettings&&typeof Je.sessionSettings=="object"?Je.sessionSettings:null,je=typeof(Ue==null?void 0:Ue.title)=="string"?Ue.title:null;ne(je??(he==null?void 0:he.title)??w),Le(Je.sessionMode==="asynchronous"?"asynchronous":"simultaneous"),de(Je.hostViewMode==="question"||Je.hostViewMode==="score"?Je.hostViewMode:"panel"),M(Je.participantViewMode==="score"||Je.participantViewMode==="fullscreen"?Je.participantViewMode:"question"),Ve(Jo(Je.sessionSettings)),oe("ready")}).catch(()=>{ve||(Oe(null),oe("error"))}),()=>{ve=!0}},[u,r,w,he==null?void 0:he.title,c]),n.useEffect(()=>{r==="create"&&(Ee(null),Le("simultaneous"),de("panel"),M("question"),Ve(""),A.trim()||ne(w||t.cogita.library.revision.live.hostKicker))},[t.cogita.library.revision.live.hostKicker,A,r,w]);const Ye=n.useMemo(()=>{const ve=new Set;return _.forEach(Je=>ve.add(Je.status)),Array.from(ve).sort((Je,Ue)=>Je.localeCompare(Ue))},[_]),U=n.useMemo(()=>{const ve=Q.trim().toLocaleLowerCase();return _.filter(Je=>b!=="all"&&Je.status!==b?!1:ve?`${Je.title??""} ${Je.sessionId} ${Je.status}`.toLocaleLowerCase().includes(ve):!0)},[_,Q,b]),qe=async()=>{const ve=ui(ae);if(ve.error){Ee(ve.error);return}ze("create"),Ee(null);try{const Je=await ds({libraryId:u,revisionId:v,title:A.trim()||null,sessionMode:ke,hostViewMode:$e,participantViewMode:ge,sessionSettings:ve.value});await D(),E==null||E(Je.sessionId)}catch{Ee(t.cogita.library.revision.live.createSessionError)}finally{ze("none")}},at=async()=>{if(!c)return;const ve=ui(ae);if(ve.error){Ee(ve.error);return}ze("save"),Ee(null);try{await cr({libraryId:u,revisionId:v,sessionId:c,title:A.trim()||null,sessionMode:ke,hostViewMode:$e,participantViewMode:ge,sessionSettings:ve.value}),await D(),r==="edit"&&(S==null||S(c))}catch{Ee(t.cogita.library.revision.shareError)}finally{ze("none")}},wt=H!=null&&H.code&&typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision/${encodeURIComponent(H.code)}`:"",yt=H!=null&&H.code&&typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision-screen/${encodeURIComponent(H.code)}`:"",Fe=H!=null&&H.sessionId&&(H!=null&&H.hostSecret)&&typeof window<"u"?`${window.location.origin}/#/cogita/live-revision-host/${encodeURIComponent(u)}/${encodeURIComponent(v)}?sessionId=${encodeURIComponent(H.sessionId)}&hostSecret=${encodeURIComponent(H.hostSecret)}&code=${encodeURIComponent(H.code)}`:"";return e.jsx(Ft,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"list",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[r==="search"?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.workspace.infoMode.search}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:Q,onChange:ve=>R(ve.target.value),placeholder:t.cogita.workspace.revisionForm.namePlaceholder})}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.live.statusLabel}),e.jsxs("select",{value:b,onChange:ve=>P(ve.target.value),children:[e.jsx("option",{value:"all",children:t.cogita.library.infoTypes.any}),Ye.map(ve=>e.jsx("option",{value:ve,children:ve},`status:${ve}`))]})]})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:`${U.length} / ${_.length}`}),e.jsx("span",{children:C==="loading"?t.cogita.library.collections.loading:C==="error"?t.cogita.library.revision.shareError:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:U.length?U.map(ve=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${st}/revisions/${encodeURIComponent(v)}/live-sessions/${encodeURIComponent(ve.sessionId)}`,onClick:Je=>{Je.metaKey||Je.ctrlKey||Je.shiftKey||Je.altKey||Je.button!==0||(Je.preventDefault(),m==null||m(ve.sessionId))},children:[e.jsx("div",{className:"cogita-card-type",children:ve.status}),e.jsx("h3",{className:"cogita-card-title",children:ve.title||ve.sessionId}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.revision.live.participantsTitle,": ",ve.participantCount]})]})},ve.sessionId)):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.revision.shareListEmpty})})})]}):null,r==="create"||r==="edit"?e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.workspace.revisions.live}),e.jsx("h3",{className:"cogita-detail-title",children:r==="create"?t.cogita.workspace.infoMode.create:t.cogita.workspace.infoActions.edit})]})}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.nameLabel}),e.jsx("input",{value:A,onChange:ve=>ne(ve.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.live.sessionModeLabel}),e.jsxs("select",{value:ke,onChange:ve=>Le(ve.target.value),children:[e.jsx("option",{value:"simultaneous",children:t.cogita.library.revision.live.modeSimultaneous}),e.jsx("option",{value:"asynchronous",children:t.cogita.library.revision.live.modeAsynchronous})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.live.hostViewModeLabel}),e.jsxs("select",{value:$e,onChange:ve=>de(ve.target.value),children:[e.jsx("option",{value:"panel",children:t.cogita.library.revision.live.hostViewPanel}),e.jsx("option",{value:"question",children:t.cogita.library.revision.live.hostViewQuestion}),e.jsx("option",{value:"score",children:t.cogita.library.revision.live.hostViewScore})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.live.participantViewModeLabel}),e.jsxs("select",{value:ge,onChange:ve=>M(ve.target.value),children:[e.jsx("option",{value:"question",children:t.cogita.library.revision.live.participantViewQuestion}),e.jsx("option",{value:"score",children:t.cogita.library.revision.live.participantViewScore}),e.jsx("option",{value:"fullscreen",children:t.cogita.library.revision.live.participantViewFullscreen})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.live.sessionSettingsLabel}),e.jsx("textarea",{value:ae,onChange:ve=>Ve(ve.target.value),rows:6})]}),Te?e.jsx("p",{className:"cogita-form-error",children:Te}):null,e.jsx("div",{className:"cogita-form-actions",children:r==="create"?e.jsx("button",{type:"button",className:"cta",onClick:()=>void qe(),disabled:W!=="none",children:t.cogita.workspace.infoMode.create}):e.jsx("button",{type:"button",className:"cta",onClick:()=>void at(),disabled:W!=="none"||!c,children:t.cogita.workspace.infoActions.edit})})]}):null,r==="detail"?e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.workspace.infoActions.overview}),e.jsx("h3",{className:"cogita-detail-title",children:(he==null?void 0:he.title)||c||""})]})}),Se==="loading"?e.jsx("p",{children:t.cogita.library.collections.loading}):null,Se==="error"?e.jsx("p",{className:"cogita-form-error",children:t.cogita.library.revision.shareError}):null,Se==="ready"&&H?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:t.cogita.library.revision.live.statusLabel}),e.jsx("div",{className:"cogita-info-tree-value",children:(he==null?void 0:he.status)??H.status})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:t.cogita.library.revision.live.participantsTitle}),e.jsx("div",{className:"cogita-info-tree-value",children:H.participants.length})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:t.cogita.library.revision.live.joinCodeLabel}),e.jsx("div",{className:"cogita-info-tree-value",children:H.code})]})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>k==null?void 0:k(H.sessionId),children:t.cogita.workspace.infoActions.edit}),Fe?e.jsx("a",{className:"ghost",href:Fe,children:"Host"}):null,yt?e.jsx("a",{className:"ghost",href:yt,target:"_blank",rel:"noreferrer",children:"Screen"}):null,wt?e.jsx("a",{className:"ghost",href:wt,target:"_blank",rel:"noreferrer",children:"Login"}):null]})]}):null]}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.workspace.revisions.live}),e.jsx("h3",{className:"cogita-detail-title",children:r==="search"?t.cogita.workspace.infoMode.search:r==="create"?t.cogita.workspace.infoMode.create:r==="edit"?t.cogita.workspace.infoActions.edit:t.cogita.workspace.infoActions.overview})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.live.hostTitle}),e.jsx("p",{children:t.cogita.library.revision.live.participantsTitle})]})]})})]})})})})})}const is="cogita.preferences",rs="cogita.reviewer.preferences",Bi=["library_overview","all_cards","all_collections","all_revisions","storyboards","texts","dependencies","transfer"],os={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},all_revisions:{requiresCollection:!1,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},Ho=["settings","run","shared","live"],ja=30,hi=42;function ha(t,a){const s=(t??"").trim();return s.length<=a?s:a<=1?s.slice(0,a):`${s.slice(0,Math.max(1,a-1)).trimEnd()}…`}function Wo(t,a=""){const s=t.split("/").filter(Boolean);if(s[0]!=="cogita"||s[1]!=="library")return{};const i=s[2];if(!i)return{};const h=(new URLSearchParams(a).get("filterCollectionId")??"").trim()||void 0;if(!s[3])return{libraryId:i,target:"library_overview"};if(s[3]==="infos"){const f=s[4];return f?f==="new"?{libraryId:i,target:"new_card"}:s[5]==="edit"?{libraryId:i,target:"new_card",infoId:f}:s[5]==="checkcards"?{libraryId:i,target:"all_cards",cardMode:"list",infoId:f,infoView:"cards"}:s[5]==="collections"?{libraryId:i,target:"all_cards",cardMode:"list",infoId:f,infoView:"collections"}:{libraryId:i,target:"all_cards",cardMode:"list",infoId:f,infoView:"overview"}:{libraryId:i,target:"all_cards",cardMode:"list"}}if(s[3]==="revisions"){const f=s[4];if(!f)return{libraryId:i,target:"all_revisions",filterCollectionId:h};if(f==="new")return{libraryId:i,target:"all_revisions",revisionView:"new",filterCollectionId:h};if(f==="run")return{libraryId:i,target:"all_revisions",revisionView:"run",filterCollectionId:h};if(s[5]==="run")return{libraryId:i,target:"all_revisions",revisionId:f,revisionView:"run",filterCollectionId:h};if(s[5]==="shared")return{libraryId:i,target:"all_revisions",revisionId:f,revisionView:"shared",filterCollectionId:h};if(s[5]==="live-sessions"){const g=s[6];return g?g==="new"?{libraryId:i,target:"all_revisions",revisionId:f,revisionView:"live",liveSessionView:"new",filterCollectionId:h}:s[7]==="edit"?{libraryId:i,target:"all_revisions",revisionId:f,revisionView:"live",liveSessionId:g,liveSessionView:"edit",filterCollectionId:h}:{libraryId:i,target:"all_revisions",revisionId:f,revisionView:"live",liveSessionId:g,liveSessionView:"detail",filterCollectionId:h}:{libraryId:i,target:"all_revisions",revisionId:f,revisionView:"live",liveSessionView:"list",filterCollectionId:h}}return{libraryId:i,target:"all_revisions",revisionId:f,revisionView:"settings",filterCollectionId:h}}if(s[3]==="dependencies")return{libraryId:i,target:"dependencies"};if(s[3]==="transfer")return{libraryId:i,target:"transfer"};if(s[3]==="storyboards")return s[4]==="new"?{libraryId:i,target:"new_storyboard"}:{libraryId:i,target:"storyboards"};if(s[3]==="texts")return s[4]==="new"?{libraryId:i,target:"new_text"}:{libraryId:i,target:"texts"};if(s[3]!=="collections")return{libraryId:i,target:"library_overview"};const o=s[4];return o?o==="new"?{libraryId:i,target:"new_collection"}:s[5]==="edit"?{libraryId:i,target:"all_collections",collectionId:o,revisionView:"graph"}:s[5]==="revisions"?{libraryId:i,target:"all_revisions",collectionId:o,filterCollectionId:o}:s[5]==="infos"?{libraryId:i,target:"all_cards",collectionId:o,cardMode:"list",filterCollectionId:o}:{libraryId:i,target:"all_collections",collectionId:o,revisionView:"detail",collectionView:"overview"}:{libraryId:i,target:"all_collections"}}function At(t,a="library_overview",s,i,l,h,o="list",f,g="overview",j="infos",u){const v=(r,c)=>r?c==="run"?`/cogita/library/${t}/revisions/${r}/run`:c==="shared"?`/cogita/library/${t}/revisions/${r}/shared`:c==="live"?o==="new"?`/cogita/library/${t}/revisions/${r}/live-sessions/new`:h?o==="edit"?`/cogita/library/${t}/revisions/${r}/live-sessions/${h}/edit`:`/cogita/library/${t}/revisions/${r}/live-sessions/${h}`:`/cogita/library/${t}/revisions/${r}/live-sessions`:`/cogita/library/${t}/revisions/${r}`:c==="new"||c==="run"?`/cogita/library/${t}/revisions/${c}`:`/cogita/library/${t}/revisions`;return t?a==="library_overview"?`/cogita/library/${t}`:a==="all_cards"?u&&!f?`/cogita/library/${t}/collections/${u}/infos`:f?g==="cards"?`/cogita/library/${t}/infos/${f}/checkcards`:g==="collections"?`/cogita/library/${t}/infos/${f}/collections`:`/cogita/library/${t}/infos/${f}`:`/cogita/library/${t}/infos`:a==="new_card"?f?`/cogita/library/${t}/infos/${f}/edit`:`/cogita/library/${t}/infos/new`:a==="all_revisions"?u&&!l&&(!i||i==="settings")?`/cogita/library/${t}/collections/${u}/revisions`:v(l,i):a==="all_collections"?i==="settings"||i==="run"||i==="shared"||i==="live"||i==="new"?v(l,i):s?i==="graph"?`/cogita/library/${t}/collections/${s}/edit`:j==="infos"?`/cogita/library/${t}/collections/${s}/infos`:`/cogita/library/${t}/collections/${s}`:`/cogita/library/${t}/collections`:a==="new_collection"?`/cogita/library/${t}/collections/new`:a==="transfer"?`/cogita/library/${t}/transfer`:a==="storyboards"?`/cogita/library/${t}/storyboards`:a==="new_storyboard"?`/cogita/library/${t}/storyboards/new`:a==="texts"?`/cogita/library/${t}/texts`:a==="new_text"?`/cogita/library/${t}/texts/new`:a==="dependencies"?`/cogita/library/${t}/dependencies`:`/cogita/library/${t}`:"/cogita"}function ka(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function Go(t){return typeof t=="string"&&Bi.includes(t)}function Yo(t,a){var f;if(!t.length)return null;const s=t.filter(g=>a.has(g.roleId)),i=s.length>0?s:t,l=i.map(g=>{var u,v;const j=((v=(u=g.fields.find(r=>r.fieldType==="role_kind"))==null?void 0:u.plainValue)==null?void 0:v.toLowerCase())??"";return{roleId:g.roleId,roleKind:j}}),h=l.find(g=>g.roleKind.includes("master"));if(h)return h.roleId;const o=l.find(g=>g.roleKind.includes("account")||g.roleKind.includes("user"));return o?o.roleId:((f=i[0])==null?void 0:f.roleId)??null}function Xo(t){if(!t)return{version:1,byLibrary:{}};try{const a=JSON.parse(t);return!a||typeof a!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:a.lastLibraryId,byLibrary:a.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function Zo({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j}){const u=sn(),v=Ua(),r=n.useMemo(()=>Wo(v.pathname,v.search),[v.pathname,v.search]),c=t.cogita.workspace,[E,m]=n.useState([]),[k,S]=n.useState([]),[w,y]=n.useState([]),[Q,R]=n.useState([]),[b,P]=n.useState(void 0),[_,re]=n.useState("library_overview"),[C,z]=n.useState(void 0),[A,ne]=n.useState(void 0),[ke,Le]=n.useState("detail"),[$e,de]=n.useState(void 0),[ge,M]=n.useState(!1),[ae,Ve]=n.useState(!0),[Se,oe]=n.useState(null),[H,Oe]=n.useState(0),[W,ze]=n.useState(""),[Te,Ee]=n.useState([]),[st,D]=n.useState(""),[he,Ye]=n.useState(0),[U,qe]=n.useState([]),[at,wt]=n.useState([]),[yt,Fe]=n.useState(null),[ve,Je]=n.useState(null),Ue=n.useRef({version:1,byLibrary:{}}),je=n.useRef({}),we=n.useRef({}),Me=n.useRef({}),$=n.useRef({}),K=n.useRef(!1),q=n.useRef(!1),J=n.useRef(null),G=n.useMemo(()=>E.find(x=>x.libraryId===b)??null,[E,b]),ce=n.useMemo(()=>k.find(x=>x.collectionId===C)??null,[k,C]),I=ka(v.pathname)==="/cogita/persons";n.useEffect(()=>{if(!b){Ee([]),D("");return}let x=!1;return Si({libraryId:b}).then(Ne=>{if(x)return;const d=Ne.filter(se=>(se.roleKind??"").trim().toLowerCase()==="person");Ee(d);try{const se=window.localStorage.getItem(rs),Ge=(se?JSON.parse(se):{})[b]??"",dt=Ge&&d.some(mt=>mt.roleId===Ge)?Ge:"";D(dt)}catch{D("")}}).catch(()=>{x||(Ee([]),D(""))}),()=>{x=!0}},[b,he]),n.useEffect(()=>{if(!b){qe([]);return}let x=!1;return Ci({libraryId:b}).then(Ne=>{x||qe(Ne)}).catch(()=>{x||qe([])}),()=>{x=!0}},[b,he]),n.useEffect(()=>{if(b)try{const x=window.localStorage.getItem(rs),Ne=x?JSON.parse(x):{};st?Ne[b]=st:delete Ne[b],window.localStorage.setItem(rs,JSON.stringify(Ne))}catch{}},[b,st]);const N=n.useMemo(()=>Q.find(x=>x.revisionId===A)??null,[Q,A]),Z=n.useMemo(()=>at.find(x=>x.sessionId===r.liveSessionId)??null,[r.liveSessionId,at]),F=n.useMemo(()=>_==="new_card"?"all_cards":_==="new_collection"?"all_collections":_==="new_storyboard"?"storyboards":_==="new_text"?"texts":_,[_]),B=n.useMemo(()=>ke==="new"?"settings":ke,[ke]),te=n.useMemo(()=>_==="new_collection"?"create":_==="all_collections"&&C?"selected":"search",[C,_]),ye=n.useMemo(()=>r.infoId?"selected":_==="new_card"?"create":"search",[r.infoId,_]),le=n.useMemo(()=>ke==="new"?"create":!A&&B==="shared"?"shared":A?"selected":"search",[B,A,ke]),pe=n.useMemo(()=>B!=="live"?"search":r.liveSessionView==="new"?"create":r.liveSessionId?"selected":"search",[B,r.liveSessionId,r.liveSessionView]),Re=n.useMemo(()=>w.find(x=>x.infoId===r.infoId)??null,[w,r.infoId]),nt=n.useMemo(()=>({library_overview:c.targets.libraryOverview,all_cards:c.targets.allCards,new_card:c.targets.newCard,all_collections:c.targets.allCollections,all_revisions:c.targets.allRevisions,new_collection:c.targets.newCollection,transfer:c.targets.transfer,storyboards:c.targets.storyboards,new_storyboard:c.targets.newStoryboard,texts:c.targets.texts,new_text:c.targets.newText,dependencies:c.targets.dependencies}),[c.targets]),rt=n.useMemo(()=>nt[F]??F,[F,nt]),He=!!b,lt=n.useMemo(()=>{const x=g==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":g==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return g==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:x},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:x},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:x},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:x},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:x},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:x},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:x},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:x},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:x},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:x},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:x},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:x},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:x},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:g==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:x},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:x},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:x},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:x},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:x},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:x},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:x},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:x},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:x},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:x},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:x},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:x},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:x},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:x},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:x},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:x},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:x},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:x},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:x},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:x},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:x},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:x},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:x},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:x},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:x},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:x},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[g]),vt=lt.length,gt=Math.max(0,Math.min(H,vt-1)),tt=lt[gt],Qe=!!C,bt=He&&F==="all_collections",We=bt&&_==="all_collections"&&Qe,ut=He&&(F==="all_revisions"||F==="all_collections"&&Qe&&(ke==="new"||!!A||B==="settings"||B==="run"||B==="shared"||B==="live")),Tt=ut,Mt=ut&&!!A,pt=n.useCallback(x=>{const Ne=!!x.libraryId;let d=x.target,se=x.collectionId,me=x.revisionId,Ge=x.revisionView,dt=x.liveSessionId,mt=x.liveSessionView??r.liveSessionView??"list",Et=x.infoId,Ce=x.infoView??r.infoView??"overview",Gt=x.collectionView??r.collectionView??"infos",Qt=x.filterCollectionId??r.filterCollectionId;Ne?os[d].requiresCollection&&!se?(d=d==="all_revisions"?"all_revisions":"all_collections",me=void 0,Ge="detail",dt=void 0,mt="list",Qt=void 0):d!=="all_collections"&&d!=="all_revisions"?(se=void 0,me=void 0,dt=void 0,mt="list",d!=="new_card"&&d!=="all_cards"&&(Et=void 0,Ce="overview"),d!=="new_collection"&&(Gt="infos"),Qt=void 0):os[d].allowsRevision?Ho.includes(Ge)||(me=void 0,dt=void 0,mt="list"):Ge="detail":(d="library_overview",se=void 0,me=void 0,Ge="detail",dt=void 0,mt="list",Et=void 0,Ce="overview",Gt="infos",Qt=void 0),d!=="all_cards"&&d!=="all_revisions"&&(Qt=void 0),Ge!=="live"&&(dt=void 0,mt="list"),!me&&Ge==="live"&&(Ge="settings",dt=void 0,mt="list"),P(x.libraryId),re(d),z(se),ne(me),Le(Ge),M(!1);const _t=ka(At(x.libraryId,d,se,Ge,me,dt,mt,Et,Ce,Gt,Qt));ka(v.pathname)!==_t&&(J.current=_t,u(_t))},[v.pathname,u,r.collectionView,r.filterCollectionId,r.infoView,r.liveSessionView]),Ct=n.useMemo(()=>[{key:"library",label:c.layers.library,visible:!0,value:b??"",selectedLabel:(G==null?void 0:G.name)??c.path.noLibrarySelected,disabled:ae||E.length===0,options:E.map(x=>({value:x.libraryId,label:x.name})),emptyOption:c.noLibraryOption,onSelect:x=>{const Ne=x||void 0;pt({libraryId:Ne,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:c.layers.target,visible:He,value:F,selectedLabel:rt,disabled:!He,options:Bi.map(x=>({value:x,label:nt[x]})),onSelect:x=>{const Ne=x;pt({libraryId:b,target:Ne,collectionId:C,revisionId:A,revisionView:ke,infoId:Ne==="new_card"?r.infoId:void 0})}},{key:"info_mode",label:c.layers.target,visible:F==="all_cards",value:ye,selectedLabel:ye==="create"?c.infoMode.create:ye==="selected"?(Re==null?void 0:Re.label)??$e??t.cogita.library.list.selectedEmpty:c.infoMode.search,disabled:!He,options:[{value:"search",label:c.infoMode.search},{value:"create",label:c.infoMode.create},...r.infoId?[{value:"selected",label:(Re==null?void 0:Re.label)??$e??t.cogita.library.list.selectedEmpty}]:[]],onSelect:x=>{if(x==="selected"){if(!r.infoId)return;pt({libraryId:b,target:"all_cards",collectionId:C,revisionId:A,revisionView:ke,infoId:r.infoId,infoView:"overview"});return}if(x==="create"){pt({libraryId:b,target:"new_card",collectionId:C,revisionId:A,revisionView:ke,infoId:void 0});return}pt({libraryId:b,target:"all_cards",collectionId:C,revisionId:A,revisionView:ke,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:c.layers.target,visible:F==="all_cards"&&!!r.infoId,value:_==="new_card"&&r.infoId?"edit":r.infoView==="cards"?"cards":r.infoView==="collections"?"collections":"overview",selectedLabel:_==="new_card"&&r.infoId?c.infoActions.edit:r.infoView==="cards"?c.infoActions.seeCards:r.infoView==="collections"?"Kolekcje":c.infoActions.overview,disabled:!He||!r.infoId,options:[{value:"overview",label:c.infoActions.overview},{value:"edit",label:c.infoActions.edit},{value:"cards",label:c.infoActions.seeCards},{value:"collections",label:"Kolekcje"}],onSelect:x=>{if(r.infoId){if(x==="edit"){pt({libraryId:b,target:"new_card",collectionId:C,revisionId:A,revisionView:ke,infoId:r.infoId});return}if(x==="cards"){pt({libraryId:b,target:"all_cards",collectionId:C,revisionId:A,revisionView:ke,infoId:r.infoId,infoView:"cards"});return}pt({libraryId:b,target:"all_cards",collectionId:C,revisionId:A,revisionView:ke,infoId:r.infoId,infoView:"overview"})}}},{key:"collection_mode",label:c.layers.collection,visible:bt,value:te,selectedLabel:te==="create"?t.cogita.library.actions.createCollection:te==="selected"?(ce==null?void 0:ce.name)??c.path.noCollectionSelected:c.infoMode.search,disabled:!He,options:[{value:"search",label:c.infoMode.search},{value:"create",label:t.cogita.library.actions.createCollection},...C?[{value:"selected",label:(ce==null?void 0:ce.name)??c.path.noCollectionSelected}]:[]],onSelect:x=>{if(x==="selected"&&C){pt({libraryId:b,target:"all_collections",collectionId:C,revisionId:void 0,revisionView:"detail"});return}if(x==="create"){pt({libraryId:b,target:"new_collection",collectionId:void 0,revisionId:void 0,revisionView:"detail"});return}pt({libraryId:b,target:"all_collections",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection_selected_action",label:c.layers.collection,visible:We,value:B==="graph"?"edit":B==="settings"||B==="run"||B==="shared"||B==="live"?"revisions":(r.collectionView??"infos")==="overview"?"overview":"infos",selectedLabel:B==="graph"?c.infoActions.edit:B==="settings"||B==="run"||B==="shared"||B==="live"?c.targets.allRevisions:(r.collectionView??"infos")==="overview"?c.infoActions.overview:c.targets.allCards,disabled:!C,options:[{value:"overview",label:c.infoActions.overview},{value:"edit",label:c.infoActions.edit},{value:"infos",label:c.targets.allCards},{value:"revisions",label:c.targets.allRevisions}],onSelect:x=>{if(C){if(x==="edit"){pt({libraryId:b,target:"all_collections",collectionId:C,revisionId:void 0,revisionView:"graph"});return}if(x==="revisions"){pt({libraryId:b,target:"all_revisions",collectionId:void 0,revisionId:void 0,revisionView:"settings",filterCollectionId:C});return}if(x==="infos"){pt({libraryId:b,target:"all_cards",collectionId:C,revisionId:void 0,revisionView:"detail",filterCollectionId:C});return}pt({libraryId:b,target:"all_collections",collectionId:C,revisionId:void 0,revisionView:"detail",infoId:r.infoId,infoView:r.infoView,collectionView:x==="overview"?"overview":"infos"})}}},{key:"revision_mode",label:c.layers.revision,visible:Tt,value:le,selectedLabel:le==="create"?c.revisionForm.createAction:le==="shared"?c.targets.sharedRevisions:le==="selected"?(N==null?void 0:N.name)??c.status.noRevisions:c.infoMode.search,disabled:F==="all_revisions"?!He:!Qe,options:[{value:"search",label:c.infoMode.search},{value:"create",label:c.revisionForm.createAction},{value:"shared",label:c.targets.sharedRevisions},...A?[{value:"selected",label:(N==null?void 0:N.name)??c.status.noRevisions}]:[]],onSelect:x=>{const Ne=F==="all_revisions",d=Ne?"all_revisions":"all_collections",se=Ne?void 0:C;if(x==="selected"&&A){pt({libraryId:b,target:d,collectionId:se,revisionId:A,revisionView:B==="run"||B==="shared"||B==="live"?B:"settings"});return}pt({libraryId:b,target:d,collectionId:se,revisionId:void 0,revisionView:x==="create"?"new":x==="shared"?"shared":"settings"})}},{key:"revision_selected_action",label:c.layers.revision,visible:Mt,value:B==="run"?"run":B==="shared"?"shared":B==="live"?"live":"settings",selectedLabel:B==="run"?c.revisions.run:B==="shared"?c.targets.sharedRevisions:B==="live"?c.revisions.live:c.infoActions.edit,disabled:!A,options:[{value:"settings",label:c.infoActions.edit},{value:"run",label:c.revisions.run},{value:"shared",label:c.targets.sharedRevisions},{value:"live",label:c.revisions.live}],onSelect:x=>{if(!A)return;const Ne=F==="all_revisions";pt({libraryId:b,target:Ne?"all_revisions":"all_collections",collectionId:Ne?void 0:C,revisionId:A,revisionView:x==="run"?"run":x==="shared"?"shared":x==="live"?"live":"settings"})}},{key:"live_mode",label:c.revisions.live,visible:Mt&&B==="live",value:pe,selectedLabel:pe==="create"?c.infoMode.create:pe==="selected"?(Z==null?void 0:Z.title)??r.liveSessionId??c.status.noRevisions:c.infoMode.search,disabled:!A,options:[{value:"search",label:c.infoMode.search},{value:"create",label:c.infoMode.create},...r.liveSessionId?[{value:"selected",label:(Z==null?void 0:Z.title)??r.liveSessionId}]:[]],onSelect:x=>{if(!A)return;const Ne=F==="all_revisions";if(x==="create"){pt({libraryId:b,target:Ne?"all_revisions":"all_collections",collectionId:Ne?void 0:C,revisionId:A,revisionView:"live",liveSessionId:void 0,liveSessionView:"new"});return}if(x==="selected"&&r.liveSessionId){pt({libraryId:b,target:Ne?"all_revisions":"all_collections",collectionId:Ne?void 0:C,revisionId:A,revisionView:"live",liveSessionId:r.liveSessionId,liveSessionView:"detail"});return}pt({libraryId:b,target:Ne?"all_revisions":"all_collections",collectionId:Ne?void 0:C,revisionId:A,revisionView:"live",liveSessionId:void 0,liveSessionView:"list"})}},{key:"live_selected_action",label:c.revisions.live,visible:Mt&&B==="live"&&!!r.liveSessionId,value:r.liveSessionView==="edit"?"edit":"overview",selectedLabel:r.liveSessionView==="edit"?c.infoActions.edit:c.infoActions.overview,disabled:!A||!r.liveSessionId,options:[{value:"overview",label:c.infoActions.overview},{value:"edit",label:c.infoActions.edit}],onSelect:x=>{if(!A||!r.liveSessionId)return;const Ne=F==="all_revisions";pt({libraryId:b,target:Ne?"all_revisions":"all_collections",collectionId:Ne?void 0:C,revisionId:A,revisionView:"live",liveSessionId:r.liveSessionId,liveSessionView:x==="edit"?"edit":"detail"})}}],[k,ye,w,E,ae,pt,Q,ce,C,Re,N,A,Z,$e,Qe,He,G,b,ke,_,B,F,rt,bt,We,Tt,Mt,nt,t.cogita.library.list.selectedEmpty,r.infoId,r.infoView,r.collectionView,r.filterCollectionId,r.liveSessionId,r.liveSessionView,c.infoActions.edit,c.infoActions.overview,c.infoActions.seeCards,c.layers.collection,c.layers.library,c.layers.revision,c.layers.target,c.noLibraryOption,c.path.noCollectionSelected,c.path.noLibrarySelected,c.targets.allCards,c.targets.allRevisions,c.infoMode.search,c.revisionForm.createAction,c.revisions.run,c.revisions.live,c.targets.sharedRevisions,te,le,pe]),Jt=n.useMemo(()=>Ct.filter(x=>x.visible),[Ct]),jt=n.useMemo(()=>Jt.filter(x=>x.key!=="library"&&x.key!=="collection"),[Jt]),Bt=n.useMemo(()=>jt.find(x=>x.key==="target")??null,[jt]),ea=n.useMemo(()=>jt.find(x=>x.key==="info_mode")??null,[jt]),xa=n.useMemo(()=>jt.find(x=>x.key==="info_selected_action")??null,[jt]),$t=n.useMemo(()=>jt.find(x=>x.key==="collection_mode")??null,[jt]),aa=n.useMemo(()=>jt.find(x=>x.key==="revision_mode")??null,[jt]),Lt=n.useMemo(()=>jt.find(x=>x.key==="collection_selected_action")??null,[jt]),It=n.useMemo(()=>jt.find(x=>x.key==="revision_selected_action")??null,[jt]),zt=n.useMemo(()=>jt.find(x=>x.key==="live_mode")??null,[jt]),Pt=n.useMemo(()=>jt.find(x=>x.key==="live_selected_action")??null,[jt]),ct=n.useCallback((x,Ne)=>x?e.jsx("div",{className:"cogita-sidebar-actions",children:x.options.map(d=>{const se=ka((()=>{if(x.key==="library")return At(d.value||void 0,"library_overview",void 0,"detail");if(x.key==="target"){const me=d.value;return At(b,me,C,ke,A,r.liveSessionId,r.liveSessionView??"list",me==="new_card"?r.infoId:void 0,r.infoView??"overview",r.collectionView??"infos")}if(x.key==="info_mode")return d.value==="create"?At(b,"new_card",C,ke,A):d.value==="selected"&&r.infoId?At(b,"all_cards",C,ke,A,r.liveSessionId,r.liveSessionView??"list",r.infoId,"overview"):At(b,"all_cards",C,ke,A);if(x.key==="info_selected_action"&&r.infoId)return d.value==="edit"?At(b,"new_card",C,ke,A,r.liveSessionId,r.liveSessionView??"list",r.infoId):At(b,"all_cards",C,ke,A,r.liveSessionId,r.liveSessionView??"list",r.infoId,d.value==="cards"?"cards":d.value==="collections"?"collections":"overview");if(x.key==="collection_mode")return d.value==="create"?At(b,"new_collection",void 0,"detail"):d.value==="selected"&&C?At(b,"all_collections",C,"detail"):At(b,"all_collections",void 0,"detail");if(x.key==="collection_selected_action"&&C)return d.value==="edit"?At(b,"all_collections",C,"graph"):d.value==="revisions"?At(b,"all_revisions",void 0,"settings",void 0,void 0,"list",void 0,"overview","infos",C):d.value==="infos"?At(b,"all_cards",C,"detail",void 0,void 0,"list",void 0,"overview","infos",C):At(b,"all_collections",C,"detail",void 0,void 0,"list",r.infoId,r.infoView??"overview",d.value==="overview"?"overview":"infos",r.filterCollectionId);if(x.key==="revision_mode"){const me=F==="all_revisions",Ge=me?"all_revisions":"all_collections",dt=me?void 0:C;return d.value==="create"?At(b,Ge,dt,"new",void 0,void 0,"list",void 0,"overview","infos",r.filterCollectionId):d.value==="shared"?At(b,Ge,dt,"shared",void 0,void 0,"list",void 0,"overview","infos",r.filterCollectionId):d.value==="selected"&&A?At(b,Ge,dt,B==="run"||B==="shared"||B==="live"?B:"settings",A,void 0,"list",void 0,"overview","infos",r.filterCollectionId):At(b,Ge,dt,"settings",void 0,void 0,"list",void 0,"overview","infos",r.filterCollectionId)}if(x.key==="revision_selected_action"&&A){const me=F==="all_revisions";return At(b,me?"all_revisions":"all_collections",me?void 0:C,d.value==="run"?"run":d.value==="shared"?"shared":d.value==="live"?"live":"settings",A,r.liveSessionId,r.liveSessionView??"list")}if(x.key==="live_mode"&&A){const me=F==="all_revisions",Ge=me?"all_revisions":"all_collections",dt=me?void 0:C;return d.value==="create"?At(b,Ge,dt,"live",A,void 0,"new"):d.value==="selected"&&r.liveSessionId?At(b,Ge,dt,"live",A,r.liveSessionId,"detail"):At(b,Ge,dt,"live",A)}if(x.key==="live_selected_action"&&A&&r.liveSessionId){const me=F==="all_revisions";return At(b,me?"all_revisions":"all_collections",me?void 0:C,"live",A,r.liveSessionId,d.value==="edit"?"edit":"detail")}return ka(v.pathname)})());return e.jsx("a",{href:`/#${se}`,className:`ghost ${String(x.value)===d.value?"active":""}`,onClick:me=>{if(x.disabled){me.preventDefault();return}me.metaKey||me.ctrlKey||me.shiftKey||me.altKey||me.button!==0||(me.preventDefault(),x.onSelect(d.value))},"aria-disabled":x.disabled,title:d.label,children:ha(d.label,ja)},`${Ne}:${x.key}:${d.value}`)})}):null,[B,F,v.pathname,r.collectionView,r.filterCollectionId,r.infoId,r.infoView,r.liveSessionId,r.liveSessionView,C,b,A,ke]),Ze=n.useMemo(()=>b?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.sidebar.revisionLiveSessionsHint}),U.length>0?e.jsx("div",{className:"cogita-sidebar-actions",children:U.map(x=>e.jsx("a",{className:`ghost ${A===x.revisionId?"active":""}`,title:x.title||x.sessionId,href:`/#/cogita/library/${encodeURIComponent(b)}/revisions/${encodeURIComponent(x.revisionId)}/live-sessions/${encodeURIComponent(x.sessionId)}`,onClick:Ne=>{Ne.metaKey||Ne.ctrlKey||Ne.shiftKey||Ne.altKey||Ne.button!==0||(Ne.preventDefault(),u(`/cogita/library/${encodeURIComponent(b)}/revisions/${encodeURIComponent(x.revisionId)}/live-sessions/${encodeURIComponent(x.sessionId)}`),M(!1))},children:ha(x.title||x.sessionId,ja)},`sidebar:live:${x.sessionId}`))}):e.jsx("p",{className:"cogita-sidebar-note",children:c.sidebar.noRevisionLiveSessions})]}):null,[u,U,b,A,c.sidebar.noRevisionLiveSessions,c.sidebar.revisionLiveSessionsHint]),it=n.useMemo(()=>{const x=r.libraryId;if(!x||!v.pathname.startsWith("/cogita/library/"))return null;const Ne={copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,libraryId:x};if(r.target==="library_overview")return e.jsx(Fr,{...Ne});if(r.target==="all_cards")return r.infoId&&r.infoView==="cards"?e.jsx(go,{...Ne,infoId:r.infoId,selectedReviewerRoleId:st||null}):e.jsx(Wr,{...Ne,mode:r.cardMode??"list",filterCollectionId:r.filterCollectionId});if(r.target==="new_card")return e.jsx(so,{...Ne,editInfoId:r.infoId});if(r.target==="dependencies")return e.jsx(ro,{...Ne});if(r.target==="transfer")return e.jsx(yo,{...Ne});if(r.target==="storyboards"||r.target==="new_storyboard")return e.jsx(vo,{...Ne});if(r.target==="texts"||r.target==="new_text")return e.jsx(xo,{...Ne});if(r.target==="all_revisions")return!r.revisionId&&!r.revisionView?e.jsx(di,{...Ne,collectionId:r.filterCollectionId}):r.revisionView==="run"?e.jsx(Uo,{...Ne,revisionId:r.revisionId}):r.revisionView==="live"&&r.revisionId?e.jsx(Qo,{...Ne,revisionId:r.revisionId,mode:r.liveSessionView==="new"?"create":r.liveSessionView==="edit"?"edit":r.liveSessionView==="detail"?"detail":"search",sessionId:r.liveSessionId,onCreated:d=>{pt({libraryId:x,target:r.target??"all_revisions",collectionId:C,revisionId:r.revisionId,revisionView:"live",liveSessionId:d,liveSessionView:"detail"})},onOpenSession:d=>{pt({libraryId:x,target:r.target??"all_revisions",collectionId:C,revisionId:r.revisionId,revisionView:"live",liveSessionId:d,liveSessionView:"detail"})},onRequestEdit:d=>{pt({libraryId:x,target:r.target??"all_revisions",collectionId:C,revisionId:r.revisionId,revisionView:"live",liveSessionId:d,liveSessionView:"edit"})},onRequestOverview:d=>{pt({libraryId:x,target:r.target??"all_revisions",collectionId:C,revisionId:r.revisionId,revisionView:"live",liveSessionId:d,liveSessionView:"detail"})}}):!r.revisionId&&(r.revisionView==="settings"||r.revisionView==="live"||r.revisionView==="shared")?e.jsx(di,{...Ne,collectionId:r.filterCollectionId}):e.jsx(Po,{...Ne,revisionId:r.revisionId});if(r.target==="all_collections"){if(r.collectionId){const d={...Ne,collectionId:r.collectionId};return r.revisionView==="graph"?e.jsx(ci,{...d,collectionId:r.collectionId,onCreated:()=>{}}):e.jsx(jo,{...d})}return e.jsx(wo,{...Ne})}return r.target==="new_collection"?e.jsx(ci,{...Ne,onCreated:d=>{pt({libraryId:x,target:"all_collections",collectionId:d,revisionId:void 0,revisionView:"graph"})}}):null},[a,pt,t,g,v.pathname,u,j,h,f,i,l,r.cardMode,r.collectionId,r.infoId,r.libraryId,r.liveSessionId,r.liveSessionView,r.revisionId,r.revisionView,r.target,o,s,C,_,st]);n.useEffect(()=>{let x=!1;return(async()=>{var d,se,me;Ve(!0);try{await dr();const[Ge,dt,mt]=await Promise.all([wi(),Ni(),ur()]);if(x)return;m(Ge);const Et=new Set(mt.nodes.filter(Kt=>Kt.nodeType==="role"&&Kt.canLink).map(Kt=>Kt.roleId??"")),Ce=Yo(dt,Et);if(Fe(Ce),Ce){const Kt=mt.nodes.find(na=>na.nodeType==="data"&&na.roleId===Ce&&(na.fieldType===is||na.label===is));Je((Kt==null?void 0:Kt.dataKeyId)??null),Ue.current=Xo(Kt==null?void 0:Kt.value)}const Gt=(d=Ge.find(Kt=>Kt.libraryId===r.libraryId))==null?void 0:d.libraryId,Qt=Gt?(me=(se=Ue.current.byLibrary)==null?void 0:se[Gt])==null?void 0:me.lastTarget:void 0,_t=Go(Qt)?Qt:"library_overview";P(Gt),re(r.target??_t),ne(r.revisionId),Le(r.revisionView??"detail"),K.current=!0}catch{x||oe(c.status.loadFailed)}finally{x||Ve(!1)}})(),()=>{x=!0}},[c.status.loadFailed]),n.useLayoutEffect(()=>{if(K.current){if(!r.libraryId){P(void 0),re(r.target??"library_overview"),z(void 0),ne(void 0),Le("detail");return}r.libraryId&&E.some(x=>x.libraryId===r.libraryId)&&P(r.libraryId),r.target&&re(r.target),z(r.collectionId),ne(r.revisionId),r.revisionView&&Le(r.revisionView)}},[E,r.collectionId,r.libraryId,r.revisionId,r.revisionView,r.target]),n.useEffect(()=>{var d;if(!b){S([]),z(void 0),y([]),R([]),ne(void 0);return}const x=je.current[b];if(x){S(x),Fs(b,x);const se=(d=x.find(me=>me.collectionId===r.collectionId))==null?void 0:d.collectionId;if(z(se),!r.collectionId||se)return}let Ne=!1;return za({libraryId:b,limit:200}).then(se=>{var dt;if(Ne)return;const me=se.items;je.current[b]=me,Fs(b,me),S(me);const Ge=(dt=me.find(mt=>mt.collectionId===r.collectionId))==null?void 0:dt.collectionId;z(Ge)}).catch(()=>{Ne||(S([]),z(void 0))}),()=>{Ne=!0}},[r.collectionId,b]),n.useEffect(()=>{if(!b){y([]);return}if(F!=="all_cards"&&_!=="new_card")return;const x=we.current[b];if(x&&(y(x),!r.infoId||x.some(d=>d.infoId===r.infoId)))return;let Ne=!1;return ws({libraryId:b,limit:200}).then(d=>{Ne||(we.current[b]=d,y(d))}).catch(()=>{Ne||y([])}),()=>{Ne=!0}},[F,r.infoId,b,_]),n.useEffect(()=>{var me;if(!b||_!=="all_revisions"&&!C){R([]),_!=="all_revisions"&&ne(void 0);return}const x=_==="all_revisions"?r.filterCollectionId:C,Ne=`${b}:${x??"__library__"}`,d=Me.current[Ne];if(d){R(d);const Ge=(me=d.find(dt=>dt.revisionId===r.revisionId))==null?void 0:me.revisionId;if(ne(Ge),!r.revisionId||Ge)return}let se=!1;return vs({libraryId:b,collectionId:x}).then(Ge=>{var mt;if(se)return;Me.current[Ne]=Ge,R(Ge);const dt=(mt=Ge.find(Et=>Et.revisionId===r.revisionId))==null?void 0:mt.revisionId;ne(dt)}).catch(()=>{se||(R([]),ne(void 0))}),()=>{se=!0}},[r.filterCollectionId,r.revisionId,C,b,_]),n.useEffect(()=>{if(!b||!A||B!=="live"){wt([]);return}const x=`${b}:${A}`,Ne=$.current[x];if(Ne&&(wt(Ne),!r.liveSessionId||Ne.some(se=>se.sessionId===r.liveSessionId)))return;let d=!1;return Ti({libraryId:b,revisionId:A}).then(se=>{d||($.current[x]=se,wt(se))}).catch(()=>{d||wt([])}),()=>{d=!0}},[B,r.liveSessionId,b,A]),n.useEffect(()=>{const x=r.infoId;if(!b||!x){de(void 0);return}let Ne=!1;return la({libraryId:b,infoId:x}).then(d=>{if(Ne)return;const se=d.payload??{},me=se.definition&&typeof se.definition=="object"?se.definition:null,Ge=typeof(me==null?void 0:me.title)=="string"?me.title:void 0,dt=typeof(me==null?void 0:me.question)=="string"?me.question:void 0,mt=typeof se.label=="string"?se.label:void 0,Et=typeof se.name=="string"?se.name:void 0,Ce=typeof se.title=="string"?se.title:void 0;de(Ge??dt??mt??Et??Ce??d.infoId)}).catch(()=>{Ne||de(x)}),()=>{Ne=!0}},[r.infoId,b]),n.useEffect(()=>{if(!K.current||r.libraryId&&E.some(se=>se.libraryId===r.libraryId)&&r.libraryId!==b||r.target&&r.target!==_||r.revisionView&&r.revisionView!==ke||r.revisionId&&r.revisionId!==A||os[_].requiresCollection&&!C&&(r.target==="all_collections"||r.target==="all_revisions")&&r.collectionId)return;const x=ka(v.pathname);if(ka(v.pathname)==="/cogita"&&!r.libraryId&&!b){J.current=null;return}if(ka(v.pathname)==="/cogita/persons"){J.current=null;return}const d=ka(At(b,_,C,ke,A,r.liveSessionId,r.liveSessionView??"list",r.infoId,r.infoView??"overview",r.collectionView??"infos",r.filterCollectionId));if(x===d){J.current=null;return}J.current!==d&&(J.current=d,u(d,{replace:!0}))},[E,v.pathname,u,r.collectionId,r.infoId,r.infoView,r.collectionView,r.filterCollectionId,r.liveSessionId,r.liveSessionView,r.libraryId,r.revisionId,r.revisionView,r.target,C,b,A,ke,_]),n.useEffect(()=>{if(typeof window>"u")return;const x=()=>{window.innerWidth>920&&M(!1)};return window.addEventListener("resize",x),()=>window.removeEventListener("resize",x)},[]),n.useEffect(()=>{if(!K.current||!yt||!b||q.current)return;const x=Ue.current,Ne={...x.byLibrary??{}},d={...Ne[b]??{},lastCollectionId:C,lastRevisionId:A,lastRevisionView:ke,lastTarget:_},se={version:1,lastLibraryId:b,byLibrary:{...Ne,[b]:d}},me=JSON.stringify(x),Ge=JSON.stringify(se);if(me===Ge)return;Ue.current=se,q.current=!0,(async()=>{try{if(ve)await hr(ve,{plainValue:Ge});else{const mt=await mr(yt,{itemName:is,itemType:"data",plainValue:Ge});Je(mt.dataItemId)}}catch{oe(c.status.savePrefsFailed)}finally{q.current=!1}})()},[ve,yt,C,b,A,ke,_,c.status.savePrefsFailed]);const ma=async()=>{const x=W.trim();if(!x){oe(t.cogita.user.libraryNameRequired);return}oe(null);try{const Ne=await gr({name:x});m(d=>[Ne,...d]),P(Ne.libraryId),re("library_overview"),z(void 0),ze("")}catch{oe(t.cogita.user.libraryCreateFailed)}};return e.jsx(Ft,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,headerExtra:e.jsxs("div",{className:"cogita-header-reviewer-actions",children:[e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:st,disabled:!b,onChange:x=>{const Ne=x.target.value;if(Ne==="__new_person__"){u("/cogita/persons");return}D(Ne)},children:[e.jsx("option",{value:"",children:b?"No person":"Select library first"}),Te.map(x=>e.jsx("option",{value:x.roleId,children:x.label},x.roleId)),e.jsx("option",{value:"__new_person__",children:"+ Create new person"})]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>u("/cogita/persons"),children:"Persons"})]}),children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${ge?"open":""}`,"aria-label":c.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{title:(G==null?void 0:G.name)??c.path.noLibrarySelected,children:ha((G==null?void 0:G.name)??c.path.noLibrarySelected,ja)}),e.jsx("p",{className:"cogita-sidebar-note",children:G?c.sidebar.libraryActionsHint:c.status.selectLibraryFirst}),ct(Bt,"sidebar"),_==="all_revisions"&&aa?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.targets.allRevisions}),ct(aa,"sidebar"),It?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(N==null?void 0:N.name)??c.status.noRevisions,children:ha((N==null?void 0:N.name)??c.status.noRevisions,ja)}),ct(It,"sidebar"),zt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.revisions.live}),ct(zt,"sidebar"),Pt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(Z==null?void 0:Z.title)??r.liveSessionId??"",children:ha((Z==null?void 0:Z.title)??r.liveSessionId??"",ja)}),ct(Pt,"sidebar")]}):null]}):null]}):null,Ze]}):null,ea?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.sidebar.infoActionsHint}),ct(ea,"sidebar"),xa?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(Re==null?void 0:Re.label)??$e??t.cogita.library.list.selectedEmpty,children:ha((Re==null?void 0:Re.label)??$e??t.cogita.library.list.selectedEmpty,ja)}),e.jsx("p",{className:"cogita-sidebar-note",children:c.sidebar.selectedInfoActionsHint}),ct(xa,"sidebar")]}):null]}):null,$t?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.sidebar.collectionActionsHint}),ct($t,"sidebar"),ce&&Lt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:ce.name,children:ha(ce.name,ja)}),ct(Lt,"sidebar"),_!=="all_revisions"&&aa?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.targets.allRevisions}),ct(aa,"sidebar"),It?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(N==null?void 0:N.name)??c.status.noRevisions,children:ha((N==null?void 0:N.name)??c.status.noRevisions,ja)}),ct(It,"sidebar"),zt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.revisions.live}),ct(zt,"sidebar"),Pt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(Z==null?void 0:Z.title)??r.liveSessionId??"",children:ha((Z==null?void 0:Z.title)??r.liveSessionId??"",ja)}),ct(Pt,"sidebar")]}):null]}):null]}):null,Ze]}):null]}):null]}):null]}),e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:c.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("a",{href:"/#/account",className:"ghost",onClick:x=>{x.metaKey||x.ctrlKey||x.shiftKey||x.altKey||x.button!==0||(x.preventDefault(),i())},children:c.sidebar.accountSettings}),e.jsx("a",{href:"/#/cogita",className:"ghost",onClick:x=>{x.metaKey||x.ctrlKey||x.shiftKey||x.altKey||x.button!==0||(x.preventDefault(),f("cogita"),M(!1))},children:c.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:l,children:o?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),ge?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":c.sidebar.closeMenu,onClick:()=>M(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":c.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>M(x=>!x),"aria-label":ge?c.sidebar.closeMenu:c.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),Jt.map((x,Ne)=>e.jsxs("div",{className:"cogita-browser-segment",children:[Ne>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,x.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":x.label,title:x.selectedLabel,children:ha(x.selectedLabel,hi)}):e.jsxs("select",{"aria-label":x.label,value:x.value,onChange:d=>x.onSelect(d.target.value),disabled:x.disabled,children:[x.emptyOption?e.jsx("option",{value:"",children:x.emptyOption}):null,x.options.map(d=>e.jsx("option",{value:d.value,title:d.label,children:ha(d.label,hi)},`${x.key}:${d.value}`))]})]},`menu:${x.key}`))]}),it?e.jsx(e.Fragment,{children:e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Ii.Provider,{value:!0,children:it})})}):null,it?null:e.jsxs(e.Fragment,{children:[I?e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(bo,{copy:t,onPersonCreated:x=>{Ye(Ne=>Ne+1)}})}):null,!b&&!I?e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:tt.step}),e.jsx("h2",{children:tt.title})]}),e.jsxs("p",{children:[gt+1," / ",vt]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:tt.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:tt.passages.map(x=>e.jsx("p",{children:x},x))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:tt.focus.map(x=>e.jsx("span",{children:x},x))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:tt.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:lt.map((x,Ne)=>e.jsx("button",{type:"button",className:`ghost ${Ne===gt?"active":""}`,onClick:()=>Oe(Ne),"aria-label":`${Ne+1}`,children:Ne+1},`tutorial:${x.title}:${Ne}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:gt===0,onClick:()=>Oe(x=>Math.max(0,x-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:gt===vt-1,onClick:()=>Oe(x=>Math.min(vt-1,x+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:W,onChange:x=>ze(x.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:ma,children:t.cogita.user.createLibraryAction}),Se?e.jsx("p",{className:"cogita-form-error",children:Se}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),E.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,E.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:E.map(x=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{pt({libraryId:x.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:x.name})]},x.libraryId))}):null]})]})]}):null]})]})]})})}const pl=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:Zo},Symbol.toStringTag,{value:"Module"}));function el({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,shareId:u}){const[v,r]=n.useState(null),[c,E]=n.useState("loading"),[m,k]=n.useState(t.cogita.library.collections.defaultName),[S,w]=n.useState("Cogita Library"),[y,Q]=n.useState([]),[R,b]=n.useState([]),[P,_]=n.useState("idle"),[re,C]=n.useState({current:0,total:0}),[z,A]=n.useState(0),[ne,ke]=n.useState(""),[Le,$e]=n.useState(null),[de,ge]=n.useState(null),[M,ae]=n.useState(null),[Ve,Se]=n.useState(null),[oe,H]=n.useState(null),[Oe,W]=n.useState(null),[ze,Te]=n.useState(()=>ta()),[Ee,st]=n.useState(null),[D,he]=n.useState([]),[Ye,U]=n.useState({}),[qe,at]=n.useState({}),[wt,yt]=n.useState(null),[Fe,ve]=n.useState(null),[Je,Ue]=n.useState(null),[je,we]=n.useState(null),[Me,$]=n.useState({}),K=n.useRef(0),[q,J]=n.useState(null),G=n.useRef(null),ce=n.useRef(null),[I,N]=n.useState(null),[Z,F]=n.useState(!1),[B,te]=n.useState(null),[ye,le]=n.useState([]),[pe,Re]=n.useState(null),nt=n.useRef(null),rt=n.useRef(null),[He,lt]=n.useState(null),[vt,gt]=n.useState(0),tt=n.useRef(null),Qe=n.useRef({}),[bt,We]=n.useState(!1),[ut,Tt]=n.useState({}),Mt=n.useRef(null),pt=n.useRef(new Set),Ct=n.useRef({}),[Jt,jt]=n.useState([]),[Bt,ea]=n.useState(new Set),[xa,$t]=n.useState(!1),aa=Ua(),Lt=n.useMemo(()=>new URLSearchParams(aa.search),[aa.search]),It=n.useMemo(()=>Lt.get("key")??"",[Lt]),zt=(v==null?void 0:v.mode)??"random",Pt=(v==null?void 0:v.check)??"exact",ct=(v==null?void 0:v.limit)??20,Ze=n.useMemo(()=>nn((v==null?void 0:v.revisionType)??zt),[v,zt]),it=n.useMemo(()=>{const L=v==null?void 0:v.revisionSettings,O=Ei(Ze,Lt);return Fn(Ze,L??O)},[v,Lt,Ze]),ma=n.useMemo(()=>t.cogita.library.revision[Ze.labelKey]??zt,[t,zt,Ze]),x=n.useMemo(()=>Pt==="exact"?t.cogita.library.revision.checkValue:Pt,[t,Pt]),d=c==="ready"?y[z]??null:null,se=(d==null?void 0:d.checkType)==="translation-match"&&je,me=n.useRef(new Map),Ge=n.useRef(new Map),dt=n.useRef(new Map),mt=n.useRef(new Map),Et=n.useMemo(()=>d?d.cardType==="vocab"?t.cogita.library.revision.vocabLabel:d.infoType?ft(t,d.infoType):t.cogita.library.revision.infoLabel:"",[t,d]),Ce=n.useMemo(()=>{var O;return Ze.id!=="levels"?y.length:((O=ut.pool)==null?void 0:O.length)??Ze.getFetchLimit(ct,it)},[ut,it,Ze,y.length,ct]),Gt=Ze.getProgressTotal?Ze.getProgressTotal(y,ut,ct,it):Ze.id==="levels"?Math.min(ct,Ce):y.length,Qt=Gt?Math.min(z+1,Gt):0,_t=Math.max(1,Number(it.tries??1)),Kt=it.compare??"anchors",na=Math.max(0,Math.min(100,Number(it.minCorrectness??0))),Ot=(it.considerDependencies??"on")==="on",ca=Math.max(0,Math.min(100,Number(it.dependencyThreshold??85))),Ma=L=>{const O=L.slice();for(let ue=O.length-1;ue>0;ue-=1){const _e=Math.floor(Math.random()*(ue+1));[O[ue],O[_e]]=[O[_e],O[ue]]}return O},ln=L=>ya(L,{treatSimilarCharsAsSame:!0})>=na,sa=async()=>{const L=await ba(),O=new Map,ue=new Map;L.forEach(xe=>{const Ke=`${xe.itemType}:${xe.itemId}`,Pe=oa(xe.itemType,xe.itemId,xe.checkType,xe.direction);O.has(Ke)||O.set(Ke,[]),O.get(Ke).push(xe),ue.has(Pe)||ue.set(Pe,[]),ue.get(Pe).push(xe)});const _e=new Map,De=new Map;return O.forEach((xe,Ke)=>_e.set(Ke,fa(xe).score)),ue.forEach((xe,Ke)=>De.set(Ke,fa(xe).score)),{itemKnowness:_e,cardKnowness:De}},Na=async L=>{const O=ut,ue=L.concat(O.active??[]).concat(O.pool??[]).filter((p,T,V)=>V.findIndex(ee=>Ie(ee)===Ie(p))===T);if(!Ot){ea(new Set(ue.map(Ie)));return}const{itemKnowness:_e,cardKnowness:De}=await sa(),xe=p=>{if(p.cardType!=="info"||p.infoType!=="citation"||p.checkType!=="quote-fragment")return!0;const T=Zt(p.direction);if(!(T!=null&&T.fragmentId))return!0;const V=p.description??"";if(!V.trim())return!0;const ie=Ia(V).nodes[T.fragmentId];if(!ie||!ie.leftId&&!ie.rightId)return!0;const X=[ie.leftId,ie.rightId].filter(fe=>!!fe);if(X.length===0)return!0;const be=X.map(fe=>{const Be=oa("info",p.cardId,"quote-fragment",fe);return De.get(Be)??0});return be.reduce((fe,Be)=>fe+Be,0)/be.length>=ca},Ke=(v==null?void 0:v.collectionId)??null,Pe=Ke?Jt.filter(p=>Rt(p.childItemType)==="collection"&&p.childItemId===Ke&&!Rt(p.childCheckType)&&!Rt(p.childDirection)):[],Ae=Ke&&ue.length>0?ue.reduce((p,T)=>p+(De.get(Ie(T))??0),0)/ue.length:0,Xe=new Set;for(const p of ue){if(p.cardType!=="info"){Xe.add(Ie(p));continue}if(!xe(p))continue;const T=Jt.filter(ie=>Di(ie,p)).concat(Pe);if(T.length===0){Xe.add(Ie(p));continue}let V=0;for(const ie of T)if(Rt(ie.parentItemType)==="collection")V+=ie.parentItemId===Ke?Ae:0;else if(Rt(ie.parentCheckType)||Rt(ie.parentDirection)){const X=Rt(ie.parentCheckType),be=Rt(ie.parentDirection),Y=oa(ie.parentItemType,ie.parentItemId,X,be);V+=De.get(Y)??0}else{const X=`${ie.parentItemType}:${ie.parentItemId}`;V+=_e.get(X)??0}V/T.length>=ca&&Xe.add(Ie(p))}ea(Xe)},cn=L=>{for(let O=L;O<y.length;O+=1){const ue=y[O];if(ue&&(!Ot||ue.cardType!=="info"||Bt.has(Ie(ue))))return O}return-1},Vt=L=>!Ot||L.cardType!=="info"||Bt.has(Ie(L)),da=L=>{if(Ze.id!=="temporal"&&Ze.id!=="levels")return null;const O=ut,ue=(O.active??[]).concat(O.pool??[]),_e=new Set;for(const De of ue){const xe=Ie(De);if(!(_e.has(xe)||L.has(xe))&&(_e.add(xe),Vt(De)))return De}return null},ia=n.useMemo(()=>{if(Ze.id!=="levels")return null;const L=ut,O=L.pool??[],ue=L.active??[],_e=L.levelMap??{},De=Math.max(1,Number(it.levels??1)),xe=Array.from({length:De},()=>0),Ke=new Set(ue.map(p=>Ie(p)));O.forEach(p=>{const T=Math.min(De,Math.max(1,_e[Ie(p)]??1));xe[T-1]+=1});const Pe=O.length||1,Ae=xe.map(p=>p/Pe*100),Xe=d?_e[Ie(d)]??1:null;return{counts:xe,percentages:Ae,currentLevel:Xe,levelsCount:De,activeCount:ue.length,poolCount:O.length,activeSet:Ke}},[ut,it,Ze,d]),La=n.useMemo(()=>{if(Ze.id!=="temporal")return null;const L=ut,O=L.pool??[],ue=L.active??[],_e=L.knownessMap??{},De=new Set(L.unknownSet??[]);let xe=0;O.forEach(Ae=>{(_e[Ie(Ae)]??0)>1&&(xe+=1)});const Ke=De.size,Pe=ue.map(Ae=>({id:Ie(Ae),value:De.has(Ie(Ae))?0:Math.max(0,Math.min(1,_e[Ie(Ae)]??0))}));return{knownCount:xe,unknownCount:Ke,dots:Pe}},[ut,Ze]),dn=n.useMemo(()=>{if(!Ot)return 0;const L=ut;return y.concat(L.active??[]).concat(L.pool??[]).filter((ue,_e,De)=>De.findIndex(xe=>Ie(xe)===Ie(ue))===_e).filter(ue=>ue.cardType==="info"&&!Bt.has(Ie(ue))).length},[Ot,ut,y,Bt]);n.useEffect(()=>{if(!Ot||P!=="ready")return;const L=ut,ue=y.concat(L.active??[]).concat(L.pool??[]).filter((xe,Ke,Pe)=>Pe.findIndex(Ae=>Ie(Ae)===Ie(xe))===Ke).filter(xe=>xe.cardType!=="info"||Bt.has(Ie(xe))).length,_e=nt.current;if(nt.current=ue,_e===null||ue<=_e)return;const De=ue-_e;Re(`New card available (+${De})`),rt.current&&window.clearTimeout(rt.current),rt.current=window.setTimeout(()=>Re(null),2200)},[Ot,P,ut,y,Bt]),n.useEffect(()=>()=>{rt.current&&window.clearTimeout(rt.current)},[]);const Ht=(L,O)=>{const ue=Ze.applyOutcome({queue:y,meta:ut},d,ct,it,{correct:L,correctness:O,createdUtc:new Date().toISOString()});Q(ue.queue),Tt(ue.meta);const _e=ue.queue[z+1];_e&&Fa(_e,z+1)};n.useEffect(()=>{if(!u){E("error");return}E("loading"),pr({shareId:u,key:It}).then(L=>{r(L),k(L.collectionName),w(L.libraryName),E("ready")}).catch(()=>{E("error")})},[u,It]),n.useEffect(()=>{u&&fr({shareId:u,key:It,type:"language"}).then(L=>b(L)).catch(()=>b([]))},[u,It]),n.useEffect(()=>{!u||c!=="ready"||br({shareId:u,key:It}).then(L=>jt(L.items??[])).catch(()=>jt([]))},[u,It,c]),n.useEffect(()=>{if(!u||c!=="ready")return;let L=!0;return(async()=>{_("loading"),C({current:0,total:Ze.id==="levels"||Ze.id==="random-once"?0:Ze.getFetchLimit(ct,it)});try{const ue=[];let _e=null,De=null;do{const T=await yr({shareId:u,key:It,limit:300,cursor:_e});if(ue.push(...T.items),(Ze.id==="levels"||Ze.id==="temporal"||Ze.id==="random-once")&&T.total&&(De=T.total),C(V=>({current:ue.length,total:V.total||T.total||Ze.getFetchLimit(ct,it)})),_e=T.nextCursor??null,De!==null&&ue.length>=De||Ze.id!=="levels"&&Ze.id!=="temporal"&&Ze.id!=="random-once"&&ue.length>=Ze.getFetchLimit(ct,it))break}while(_e);if(!L)return;const xe=en(ue);let Ke;if(Ze.id==="levels"){const T=Math.max(1,Number(it.levels??1));Ke={},xe.forEach(V=>{const ee=Ie(V);Ke[ee]=Math.max(1,Math.min(T,1))})}let Pe=null,Ae=null,Xe=null;if(Ze.id==="temporal"){const T=await ba(),V=new Set(xe.map(X=>Ie(X))),ee=T.reduce((X,be)=>{const Y=oa(be.itemType,be.itemId,be.checkType,be.direction);return V.has(Y)&&(X[Y]||(X[Y]=[]),X[Y].push(be)),X},{});Pe={},Ae=new Set,Xe={};const ie=Date.now();xe.forEach(X=>{const be=Ie(X),Y=ee[be]??[];if(Y.length===0){Pe[be]=0,Ae.add(be),Xe[be]=[];return}const fe=Cs(Y);Xe[be]=fe;const Be=En(fe,ie);Pe[be]=Be.knowness})}const p=Ze.id==="levels"?Ms(xe,ct,it,Ke):Ze.id==="temporal"?Is(xe,ct,it,Pe??{},Ae??new Set,Xe??{}):Ze.prepare(xe,ct,it);Q(p.queue),Tt(p.meta),A(0),_("ready"),C(T=>({current:Math.min(T.current,T.total),total:T.total}))}catch{L&&_("error")}})(),()=>{L=!1}},[u,It,ct,Ze,it,c]),n.useEffect(()=>{Na(y)},[y,Jt,Ot,ca,v==null?void 0:v.collectionId]),n.useEffect(()=>{if(!d||!Ot){$t(!1);return}if(d.cardType!=="info"||Bt.has(Ie(d))){$t(!1);return}const L=cn(z+1);if(L>=0){$t(!1),A(L);return}if(Ze.id==="temporal"||Ze.id==="levels"){const O=y.slice(0,z+1),ue=y.slice(z+1).filter(Vt),_e=O.concat(ue),De=new Set(_e.map(Ie)),xe=da(De);if(xe){const Pe=Ie(xe);De.has(Pe)||(_e.push(xe),De.add(Pe),Tt(Ae=>{const Xe=Ae,p=new Set(Xe.queued??[]);return p.add(Pe),{...Xe,queued:p}}))}const Ke=_e.findIndex((Pe,Ae)=>Ae!==z&&Vt(Pe));if(Ke>=0){Q(_e),A(Ke),$t(!1);return}}$t(!0)},[d,Bt,Ot,z,y,ut,Ze.id]),n.useEffect(()=>{if(ke(""),$e(null),lt(null),gt(0),he([]),U({}),at({}),yt(null),ve(null),Ue(null),Se(null),H(null),W(null),Te(ta()),F(!1),We(!1),N(null),we(null),$({}),!d){ge(null),ae(null),Se(null),H(null),W(null),Te(ta());return}d.cardType==="info"&&d.infoType==="computed"&&ge(t.cogita.library.revision.loadingComputed);let L=!0;return Fa(d,z).then(O=>{!L||!O||(ge(O.prompt),ae(O.expectedAnswer),he(O.computedExpected),U(O.computedAnswers),yt(O.answerTemplate),ve(O.outputVariables),Ue(O.variableValues),Se(O.questionPrompt),H(O.questionPromptModel),W(O.questionExpectedModel),Te(O.questionInitialAnswers))}),()=>{L=!1}},[d,u,t]),n.useEffect(()=>{if(!d||d.cardType!=="info"||d.infoType!=="citation"){Mt.current=null,pt.current=new Set,st(null);return}const L=d.description??"",O=(d.label??"").trim(),ue=O.replace(/\s+/g," ").trim(),_e=L.replace(/\s+/g," ").trim(),De=ue&&ue!==_e?O:t.cogita.library.infoTypes.citation;if(!L){st(null),ae(null);return}const xe=Ia(L);Mt.current=xe,ge(De);let Ke=!0;return ba().then(Pe=>{if(!Ke)return;const Ae=new Map;Pe.forEach(ee=>{if(ee.itemType!=="info"||ee.checkType!=="quote-fragment"||!ee.direction)return;const ie=Zt(ee.direction);if(!ie)return;const X=`${ee.itemId}:${ie.fragmentId}`;Ae.has(X)||Ae.set(X,[]),Ae.get(X).push(ee)});const Xe={},p=new Set;Ae.forEach((ee,ie)=>{const[X,be]=ie.split(":",2);if(X!==d.cardId)return;const Y=fa(ee).score;Xe[be]=Y,Y>=ca&&p.add(be)}),pt.current=p,Ct.current=Xe;const T=Zt(d.direction);if(T!=null&&T.fragmentId&&xe.nodes[T.fragmentId]){Sa(xe,T.fragmentId,De);return}const V=Da(xe,p,Xe,ca,Ot,d.direction);Sa(xe,(V==null?void 0:V.id)??null,De)}).catch(()=>{pt.current=new Set,Ct.current={};const Pe=Zt(d.direction);if(Pe!=null&&Pe.fragmentId&&xe.nodes[Pe.fragmentId]){Sa(xe,Pe.fragmentId,De);return}const Ae=Da(xe,pt.current,{},ca,Ot,d.direction);Sa(xe,(Ae==null?void 0:Ae.id)??null,De)}),()=>{Ke=!1}},[d,t,Ot,ca]),n.useEffect(()=>{if(!d||d.cardType!=="vocab"||d.checkType!=="translation-match"){we(null),$({});return}const ue=(ut.pool??ut.active??y).filter(Pe=>Pe.cardType==="vocab"&&Pe.checkType==="translation-match").filter((Pe,Ae,Xe)=>Xe.findIndex(p=>p.cardId===Pe.cardId)===Ae);ue.some(Pe=>Pe.cardId===d.cardId)||ue.unshift(d);const De=Ma(ue).slice(0,6).map(Pe=>{const Ae=Pe.label.split("↔").map(T=>T.trim()).filter(Boolean);if(Ae.length<2)return null;const Xe=`${Pe.cardId}:L`,p=`${Pe.cardId}:R`;return{cardId:Pe.cardId,leftId:Xe,rightId:p,leftLabel:Ae[0],rightLabel:Ae[1]}}).filter(Boolean),xe=De.map(Pe=>Pe.leftId),Ke=Ma(De.map(Pe=>Pe.rightId));we({pairs:De,leftOrder:xe,rightOrder:Ke,selection:{},activeLeft:null,activeRight:null,locked:{}})},[d,y,ut]),n.useEffect(()=>()=>{G.current&&window.clearTimeout(G.current),ce.current&&window.clearTimeout(ce.current)},[]);const $a=n.useRef(null);n.useEffect(()=>{if(!d)return;const L=Ie(d),O=typeof document<"u"?document.activeElement:null;if($a.current===L&&O&&(O.tagName==="INPUT"||O.tagName==="TEXTAREA"))return;let ue=0;const _e=()=>{if(d){if(d.cardType==="info"&&d.infoType==="computed"){if(D.length>0){const xe=An(wt,D,Fe),Ke=xe?Qe.current[xe]:null;if(Ke&&(Ke.focus(),document.activeElement===Ke)){$a.current=L;return}}if(tt.current&&(tt.current.focus(),document.activeElement===tt.current)){$a.current=L;return}}else if(d.cardType==="vocab"&&tt.current&&(tt.current.focus(),document.activeElement===tt.current)){$a.current=L;return}ue<6&&(ue+=1,window.setTimeout(_e,40))}},De=window.setTimeout(_e,40);return()=>window.clearTimeout(De)},[d,D,wt,Fe]),n.useEffect(()=>{if(!bt)return;const L=O=>{O.key==="Enter"&&(O.preventDefault(),Dt())};return window.addEventListener("keydown",L),()=>window.removeEventListener("keydown",L)},[bt]);const Pa=L=>{le(L),te(fa(L))};n.useEffect(()=>{if(!d){te(null),le([]);return}const L=d.cardType==="info"?"info":"connection";if(d.cardType==="info"&&d.infoType==="citation"){ba().then(O=>{const ue=O.filter(_e=>_e.itemType==="info"&&_e.itemId===d.cardId&&_e.checkType==="quote-fragment"&&Mn(_e.direction,d.direction));Pa(ue)}).catch(()=>{te(null),le([])});return}Cn(L,d.cardId,d.checkType,d.direction).then(O=>Pa(O)).catch(()=>{te(null),le([])})},[d]);const Qa=(L,O,ue,_e)=>{if(L==="info"&&ue==="quote-fragment"){ba().then(De=>{const xe=De.filter(Ke=>Ke.itemType==="info"&&Ke.itemId===O&&Ke.checkType==="quote-fragment"&&Mn(Ke.direction,_e));Pa(xe)}).catch(()=>{te(null),le([])});return}Cn(L,O,ue,_e).then(De=>Pa(De)).catch(()=>{te(null),le([])})},un=(L,O,ue)=>{var Ke;const _e=((Ke=ue.pairs.find(Pe=>Pe.leftId===L))==null?void 0:Ke.rightId)??null;if(!_e)return ue;const De=_e===O;$(Pe=>({...Pe,[L]:De?"correct":"incorrect"})),G.current&&window.clearTimeout(G.current),ce.current&&window.clearTimeout(ce.current),K.current+=1;const xe={kind:De?"correct":"incorrect",tick:K.current};if(J(null),G.current=window.setTimeout(()=>J(xe),0),ce.current=window.setTimeout(()=>J(null),420),De){const Pe={...ue.locked,[L]:!0};return Object.keys(Pe).length>=ue.pairs.length?($e("correct"),We(!0)):$e("correct"),{...ue,selection:{...ue.selection,[L]:O},activeLeft:null,activeRight:null,locked:Pe}}return $e("incorrect"),{...ue,activeLeft:null,activeRight:null}},Ha=L=>{we(O=>!O||O.locked[L]?O:O.activeRight?un(L,O.activeRight,O):{...O,activeLeft:O.activeLeft===L?null:L})},_n=L=>{we(O=>O&&(O.activeLeft?un(O.activeLeft,L,O):{...O,activeRight:O.activeRight===L?null:L}))},ua=L=>{Te(O=>{if(Ve!=null&&Ve.multiple){const ue=O.selection.includes(L)?O.selection.filter(_e=>_e!==L):Array.from(new Set([...O.selection,L]));return{...O,selection:ue}}return{...O,selection:O.selection[0]===L?[]:[L]}})},Ea=(L,O)=>{Te(ue=>{var Ae;const _e=Math.max(2,((Ae=Ve==null?void 0:Ve.columns)==null?void 0:Ae.length)??2),De=Array.from({length:_e},(Xe,p)=>ue.matchingSelection[p]??null);if(De[L]=De[L]===O?null:O,De.some(Xe=>Xe==null))return{...ue,matchingSelection:De};const xe=De.map(Xe=>Number(Xe)),Ke=xe.join("|"),Pe=ue.matchingRows.some(Xe=>Xe.join("|")===Ke);return{...ue,matchingRows:Pe?ue.matchingRows:[...ue.matchingRows,xe],matchingSelection:new Array(_e).fill(null)}})},Vn=(L,O)=>{Te(ue=>{const _e=[...ue.ordering],De=L+O;return De<0||De>=_e.length?ue:([_e[L],_e[De]]=[_e[De],_e[L]],{...ue,ordering:_e})})},Dt=()=>{var L;if(d&&d.cardType==="info"&&d.infoType==="citation"&&Mt.current&&Ee&&!((L=Zt(d.direction))!=null&&L.fragmentId)){const O=Da(Mt.current,pt.current,Ct.current,ca,Ot,d.direction,Ee.fragmentId);if(O){$e(null),ke(""),F(!1),at({}),We(!1),lt(null),gt(0),Sa(Mt.current,O.id,Ee.title);return}}$e(null),ke(""),F(!1),at({}),We(!1),lt(null),gt(0),A(O=>Math.min(O+1,y.length))},Wt=L=>{if(!d)return;const O=L.expected??null,ue=L.answer??"";let _e=O??"",De=ue;if(!O&&L.expectedMap&&L.answerMap){const T=Object.keys(L.expectedMap).sort((V,ee)=>V.localeCompare(ee));_e=T.map(V=>{var ee;return((ee=L.expectedMap)==null?void 0:ee[V])??""}).join("|"),De=T.map(V=>{var ee;return((ee=L.answerMap)==null?void 0:ee[V])??""}).join("|")}const xe=_e?Ba(_e,De,Kt):new Uint8Array,Ke={revisionType:Ze.id,evalType:L.evalType,direction:L.direction,prompt:de??"",expected:O,answer:ue,expectedAnswers:L.expectedMap??null,answers:L.answerMap??null,correct:L.correct,maskBase64:xe.length?Ca(xe):null,checkMode:Pt,compareMode:Kt,minCorrectness:na},Pe=new TextEncoder().encode(JSON.stringify(Ke)),Ae=d.cardType==="info"?"info":"connection",Xe=L.overrideCheckType??d.checkType??null,p=L.overrideDirection??d.direction??null;Tn({itemType:Ae,itemId:d.cardId,checkType:Xe,direction:p,revisionType:Ze.id,evalType:L.evalType,correct:L.correct,maskBase64:xe.length?Ca(xe):null,payloadBase64:Ca(Pe)}).then(()=>{Qa(Ae,d.cardId,Xe,p),Na(y)}).catch(()=>{})},Ka=(L,O)=>{const ue=me.current.get(O);if(ue)return Promise.resolve(ue);const _e=Ge.current.get(O);if(_e)return _e;const De=Ps({shareCode:u,infoId:L,key:It}).then(xe=>{var T,V;const Ke=xe.payload,Pe=((T=Ke.definition)==null?void 0:T.graph)??null,Ae="",Xe=((V=Ke.definition)==null?void 0:V.answerTemplate)??"",p=Ki(Pe,Ae,Xe);if(p){const ie={sample:Fi(p),answerTemplate:Xe||null};return me.current.set(O,ie),ie}return Es({shareId:u,infoId:L,key:It}).then(ee=>{const ie={sample:ee,answerTemplate:null};return me.current.set(O,ie),ie})}).catch(()=>Es({shareId:u,infoId:L,key:It}).then(xe=>{const Ke={sample:xe,answerTemplate:null};return me.current.set(O,Ke),Ke}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{Ge.current.delete(O)});return Ge.current.set(O,De),De},Fa=(L,O)=>{var Pe;const ue=`${Ie(L)}:${O}`,_e=dt.current.get(ue);if(_e)return Promise.resolve(_e);const De=mt.current.get(ue);if(De)return De;const xe=Ae=>{const Xe={...Ae,questionPrompt:Ae.questionPrompt??null,questionPromptModel:Ae.questionPromptModel??null,questionExpectedModel:Ae.questionExpectedModel??null,questionInitialAnswers:Ae.questionInitialAnswers??ta()};return dt.current.set(ue,Xe),Xe};let Ke;if(L.cardType==="vocab"){if(L.checkType==="translation-match")return Ke=Promise.resolve(xe({prompt:L.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),Ke;const Ae=L.label.split("↔").map(Xe=>Xe.trim()).filter(Boolean);if(Ae.length>=2){const p=(L.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",T=p?Ae[0]:Ae[1],V=p?Ae[1]:Ae[0];Ke=Promise.resolve(xe({prompt:T,expectedAnswer:V,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else Ke=Promise.resolve(xe({prompt:L.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(L.cardType==="info"&&L.infoType==="word"){const Ae=(Pe=L.description)!=null&&Pe.startsWith("Language: ")?L.description.replace("Language: ",""):null;Ke=Promise.resolve(xe({prompt:L.label,expectedAnswer:Ae,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(L.cardType==="info"&&L.infoType==="question"){const Ae=In(L.payload??null,L.label);Ae?Ke=Promise.resolve(xe({prompt:Ae.promptText,expectedAnswer:Ae.promptModel.kind==="text"&&(typeof Ae.expectedModel=="string"||typeof Ae.expectedModel=="number")?String(Ae.expectedModel):null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null,questionPrompt:Ae.promptPayload,questionPromptModel:Ae.promptModel,questionExpectedModel:Ae.expectedModel,questionInitialAnswers:Ae.initialAnswers})):Ke=Ps({shareCode:u,infoId:L.cardId,key:It}).then(Xe=>{const p=In(Xe.payload??{},L.label);return xe(p?{prompt:p.promptText,expectedAnswer:p.promptModel.kind==="text"&&(typeof p.expectedModel=="string"||typeof p.expectedModel=="number")?String(p.expectedModel):null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null,questionPrompt:p.promptPayload,questionPromptModel:p.promptModel,questionExpectedModel:p.expectedModel,questionInitialAnswers:p.initialAnswers}:{prompt:L.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})}).catch(()=>xe({prompt:L.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{mt.current.delete(ue)})}else L.cardType==="info"&&L.infoType==="computed"?Ke=Ka(L.cardId,ue).then(Ae=>{var ee,ie;if(!Ae.sample)return xe({prompt:L.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const Xe=Ae.sample,p=Xe.expectedAnswers?Object.entries(Xe.expectedAnswers).map(([X,be])=>({key:X,expected:be})):[],T=p.reduce((X,be)=>(X[be.key]="",X),{}),V=Xe.expectedAnswerIsSentence&&((ee=Xe.expectedAnswer)==null?void 0:ee.trim())||null;return xe({prompt:Xe.prompt,expectedAnswer:p.length>0?V:((ie=Xe.expectedAnswer)==null?void 0:ie.trim())||null,computedExpected:p,computedAnswers:T,computedValues:Xe.values??null,answerTemplate:Ae.answerTemplate,outputVariables:Xe.outputVariables??null,variableValues:Xe.variableValues??null})}).catch(()=>xe({prompt:L.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{mt.current.delete(ue)}):Ke=Promise.resolve(xe({prompt:L.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return mt.current.set(ue,Ke),Ke},Sa=(L,O,ue)=>{const _e=Object.keys(L.nodes).length,De=pt.current.size;if(!O){st({title:ue,before:L.text,after:"",fragmentId:null,total:_e,completed:De}),ae(null),We(!0);return}const xe=L.nodes[O];if(!xe)return;const Ke=$n(L.text,xe);st({title:ue,before:Ke.before,after:Ke.after,fragmentId:xe.id,total:_e,completed:De}),ae(Ke.fragment),We(!1)},qn=()=>{const L=Mt.current;L&&st(O=>O&&{...O,total:Object.keys(L.nodes).length,completed:pt.current.size})},_a=()=>{const L=y[z+1];L&&Fa(L,z+1)},hn=()=>{if(_a(),d&&d.cardType==="vocab"&&d.checkType==="translation-match"&&je){if(je.pairs.length===0){$e("incorrect"),We(!0);return}const xe=je.pairs.reduce((V,ee)=>(V[ee.rightId]=ee.rightLabel,V),{});let Ke=0;const Pe={};je.pairs.forEach(V=>{const ie=je.selection[V.leftId]===V.rightId;Pe[V.leftId]=ie?"correct":"incorrect",ie&&(Ke+=1)});const Ae=je.pairs.length||1,Xe=Ke/Ae,p=Ke===je.pairs.length;$(V=>({...V,...Pe})),p?($e("correct"),We(!0),gt(0)):($e("incorrect"),We(!1),gt(V=>{const ee=V+1;return ee>=_t&&(F(!0),We(!0),we(ie=>{if(!ie)return ie;const X=ie.pairs.reduce((be,Y)=>(be[Y.leftId]=Y.rightId,be),{});return{...ie,selection:X}})),ee})),Ht(p,Xe);const T="connection";Promise.all(je.pairs.map(V=>{const ee=je.selection[V.leftId]??null,ie=ee?xe[ee]:"",X={left:V.leftLabel,expected:V.rightLabel,answer:ie,checkType:"translation-match"},be=new TextEncoder().encode(JSON.stringify(X));return Tn({itemType:T,itemId:V.cardId,checkType:"translation-match",direction:null,revisionType:Ze.id,evalType:"translation-match",correct:ee===V.rightId,maskBase64:null,payloadBase64:Ca(be)})})).then(()=>{Qa(T,d.cardId,d.checkType,d.direction),Na(y)}).catch(()=>{});return}if(d&&d.cardType==="info"&&d.infoType==="question"&&oe){const xe={text:ze.text,selection:ze.selection,booleanAnswer:ze.booleanAnswer,ordering:ze.ordering,matchingPaths:ze.matchingRows},Ke=Xt({prompt:oe,expected:Oe,answer:xe}),Pe=Ke.mask?ya(Ke.mask):Ke.correct?100:0;lt(Ke.mask),Ke.correct?($e("correct"),at({}),We(!0),gt(0),Ht(!0,Pe/100)):($e("incorrect"),at({}),We(!1),gt(Ae=>{const Xe=Ae+1;return Xe>=_t&&(F(!0),We(!0)),Xe}),Ht(!1,Pe/100)),Wt({correct:Ke.correct,direction:de?`${de} -> question`:"question",expected:JSON.stringify(Oe??null),answer:JSON.stringify(xe),evalType:`question:${oe.kind}`});return}if(D.length>0){const xe=D.reduce((Pe,Ae)=>{const Xe=Ye[Ae.key]??"";return Pe[Ae.key]=Ut(Xe)===Ut(Ae.expected)?"correct":"incorrect",Pe},{});D.every(({key:Pe,expected:Ae})=>{const Xe=Ye[Pe]??"";return Pt==="exact"&&Ut(Xe)===Ut(Ae)})?($e("correct"),at(xe),We(!0),gt(0),Ht(!0,1),Wt({correct:!0,direction:de?`${de} -> computed`:"computed",expectedMap:D.reduce((Pe,Ae)=>(Pe[Ae.key]=Ae.expected,Pe),{}),answerMap:Ye,evalType:"computed"})):($e("incorrect"),at(xe),We(!1),gt(Pe=>{const Ae=Pe+1;return Ae>=_t&&wa&&(F(!0),We(!0)),Ae}),Ht(!1,0),window.setTimeout(()=>{var Ae;const Pe=An(wt,D,Fe);Pe&&Qe.current[Pe]&&((Ae=Qe.current[Pe])==null||Ae.focus())},40),Wt({correct:!1,direction:de?`${de} -> computed`:"computed",expectedMap:D.reduce((Pe,Ae)=>(Pe[Ae.key]=Ae.expected,Pe),{}),answerMap:Ye,evalType:"computed"}));return}if(d&&d.cardType==="info"&&d.infoType==="citation"&&(Ee!=null&&Ee.fragmentId)){if(!M)return;const xe=Zt(d.direction),Ke=(xe==null?void 0:xe.fragmentId)??Ee.fragmentId,Pe=an(M,ne,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Ae=Pe.mask,Xe=Pe.isCorrect,p=Pe.percent;Xe?(Ct.current[Ee.fragmentId]=Math.max(Ct.current[Ee.fragmentId]??0,p),(Ct.current[Ee.fragmentId]??0)>=ca&&pt.current.add(Ee.fragmentId),qn(),$e("correct"),at({}),We(!0),lt(Ae),gt(0),p<100&&_t<=1&&F(!0),Ht(!0,p/100),Wt({correct:!0,direction:`quote:${Ee.fragmentId}`,expected:M,answer:ne,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Ke})):($e("incorrect"),at({}),We(!1),lt(Ae),gt(T=>{const V=T+1;return V>=_t&&wa&&(F(!0),We(!0)),V}),Ht(!1,p/100),window.setTimeout(()=>{var T;return(T=tt.current)==null?void 0:T.focus()},40),Wt({correct:!1,direction:`quote:${Ee.fragmentId}`,expected:M,answer:ne,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Ke}));return}if(!M)return;const L=Ba(M,ne,Kt),O=Pt==="exact"&&Ut(ne)===Ut(M),ue=ln(L),_e=O||ue,De=ya(L);_e?($e("correct"),at({}),We(!0),lt(L),gt(0),De<100&&_t<=1&&F(!0),Ht(!0,De/100),Wt({correct:!0,direction:de?`${de} -> ${M}`:null,expected:M,answer:ne,evalType:"text"})):($e("incorrect"),at({}),We(!1),lt(L),gt(xe=>{const Ke=xe+1;return Ke>=_t&&wa&&(F(!0),We(!0)),Ke}),Ht(!1,De/100),window.setTimeout(()=>{var xe;return(xe=tt.current)==null?void 0:xe.focus()},40),Wt({correct:!1,direction:de?`${de} -> ${M}`:null,expected:M,answer:ne,evalType:"text"}))},Dn=L=>{if(_a(),!M)return;const O=Ba(M,L,Kt),ue=Ut(L)===Ut(M),_e=ln(O),De=ue||_e,xe=ya(O);De?($e("correct"),at({}),We(!0),lt(O),gt(0),xe<100&&_t<=1&&F(!0),Ht(!0,xe/100),Wt({correct:!0,direction:"word->language",expected:M,answer:L,evalType:"language-select"})):($e("incorrect"),at({}),We(!1),lt(O),gt(Ke=>{const Pe=Ke+1;return Pe>=_t&&wa&&(F(!0),We(!0)),Pe}),Ht(!1,xe/100),Wt({correct:!1,direction:"word->language",expected:M,answer:L,evalType:"language-select"}))},Bn=L=>{var ue;if(L.key!=="Enter")return;if(L.preventDefault(),L.stopPropagation(),bt){Dt();return}const O=D.find(_e=>!(Ye[_e.key]??"").trim());if(O){(ue=Qe.current[O.key])==null||ue.focus();return}hn()},Va=()=>{_a(),$e("correct"),We(!0),gt(0),Ht(!0,1),M&&Wt({correct:!0,direction:"manual",expected:M,answer:ne,evalType:"manual"})},ra=()=>{if(Ht(!1,0),d&&d.cardType==="info"&&d.infoType==="citation"){$e(null),ke(""),F(!1),at({}),We(!1),lt(null),gt(0),A(L=>Math.min(L+1,y.length));return}Dt()};n.useEffect(()=>{_a()},[z,y]);const zn=t.cogita.library.revision.revealModeAfterIncorrect,wa=D.length>0||!!M||(d==null?void 0:d.cardType)==="info"&&d.infoType==="question"&&oe!==null;return e.jsxs(Ft,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:l,onLogout:h,secureMode:o,onNavigate:f,language:g,onLanguageChange:j,children:[(c==="loading"||P==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:c==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${re.total?Math.min(100,Math.max(0,re.current/re.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:re.total?`${Math.min(re.current,re.total)} / ${re.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:m}),e.jsx("p",{className:"cogita-library-subtitle",children:S}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",ma).replace("{check}",x)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:B?`${B.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[ia?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",ia.currentLevel??"-"," / ",ia.levelsCount]}):null,B?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(B.correct)).replace("{total}",String(B.total))}),B.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(B.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(_i,{outcomes:ye})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[pe?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:pe})}):null,e.jsx(Ja,{feedbackToken:q?`${q.kind}-${q.tick}`:se?"idle":Le?`${Le}-${z}-${vt}`:"idle",children:c!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:c==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):d?e.jsx(e.Fragment,{children:xa?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(Ss,{copy:t,currentCard:d,currentTypeLabel:Et,prompt:de,languages:R,answer:ne,onAnswerChange:L=>ke(O=>Ln(O,L,I)),computedExpected:D,computedAnswers:Ye,onComputedAnswerChange:(L,O)=>U(ue=>({...ue,[L]:Ln(ue[L]??"",O,I)})),answerTemplate:wt,outputVariables:Fe,variableValues:Je,computedFieldFeedback:qe,feedback:Le,canAdvance:bt,quoteContext:Ee,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:hn,onSkip:ra,onLanguageSelect:Dn,onMarkReviewed:Va,onAdvance:Dt,showCorrectAnswer:Z,setShowCorrectAnswer:F,onRevealCorrect:()=>We(!0),answerMask:He,expectedAnswer:M,hasExpectedAnswer:wa,handleComputedKeyDown:Bn,answerInputRef:tt,computedInputRefs:Qe,scriptMode:I,setScriptMode:N,matchPairs:je==null?void 0:je.pairs,matchLeftOrder:je==null?void 0:je.leftOrder,matchRightOrder:je==null?void 0:je.rightOrder,matchSelection:je==null?void 0:je.selection,matchActiveLeft:je==null?void 0:je.activeLeft,matchActiveRight:je==null?void 0:je.activeRight,matchFeedback:Me,onMatchLeftSelect:Ha,onMatchRightSelect:_n,questionPrompt:Ve,questionAnswers:ze,questionRevealExpected:Z?Oe:void 0,onQuestionTextChange:L=>{ke(L),Te(O=>({...O,text:L}))},onQuestionSelectionToggle:ua,onQuestionBooleanChange:L=>Te(O=>({...O,booleanAnswer:L})),onQuestionOrderingMove:Vn,onQuestionMatchingPick:Ea,onQuestionMatchingRemovePath:L=>Te(O=>({...O,matchingRows:O.matchingRows.filter((ue,_e)=>_e!==L)}))})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Gt?`${Qt} / ${Gt}`:t.cogita.library.revision.progressUnlimited}),c==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),c==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),c==="ready"&&P==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),c==="ready"&&P==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),c==="ready"&&P==="ready"&&y.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:zn}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",_t]})]})]}),ia?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",ia.activeCount," / ",ia.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:ia.counts.map((L,O)=>{const ue=O+1,_e=ia.currentLevel===ue,De=ia.percentages[O]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":_e,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:ue}),e.jsx("strong",{children:L})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,De))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[De.toFixed(1),"%"]})]},`level-${ue}`)})})]}):null,La?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:La.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:La.dots.map(L=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-L.value))}, ${Math.round(200*L.value)}, 80, 0.9)`}},L.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:La.knownCount})]})]}):null,Ot?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:dn})]})}):null]})]})]})})})]})]})}const fl=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:el},Symbol.toStringTag,{value:"Module"})),tl=t=>Array.from(new Set(t.map(a=>Number(a)).filter(Number.isFinite))).sort((a,s)=>a-s);function al(t){const a=[...t];for(let s=a.length-1;s>0;s-=1){const i=Math.floor(Math.random()*(s+1));[a[s],a[i]]=[a[i],a[s]]}return a}function mi(t){const a=t.map((l,h)=>({value:l,oldIndex:h}));for(let l=a.length-1;l>0;l-=1){const h=Math.floor(Math.random()*(l+1));[a[l],a[h]]=[a[h],a[l]]}const s=a.map(l=>l.value),i=new Map;return a.forEach((l,h)=>i.set(l.oldIndex,h)),{values:s,oldToNew:i}}function nl(t){const a=t.split("↔").map(s=>s.trim()).filter(Boolean);return a.length>=2?[a[0],a[1]]:null}function sl(t){if(!t)return null;const a=t.indexOf(":");return a>=0?t.slice(a+1).trim():t.trim()}function il(t,a,s,i){const l=typeof s.title=="string"&&s.title.trim()?s.title.trim():a,h=typeof s.question=="string"?s.question:a,o=s.type;if(!h)return null;if(o==="selection"){const f=Array.isArray(s.options)?s.options.filter(r=>typeof r=="string"):[],g=Array.isArray(s.answer)?tl(s.answer):[],j=g.length!==1,u=mi(f),v=g.map(r=>u.oldToNew.get(r)).filter(r=>Number.isInteger(r)).sort((r,c)=>r-c);return{roundIndex:i,cardKey:`info:${t}:question-selection`,publicPrompt:{kind:"selection",title:l,prompt:h,options:u.values,multiple:j,cardLabel:"question"},reveal:{kind:"selection",expected:v,title:l},grade:r=>Xt({prompt:{kind:"selection",options:u.values},expected:v,answer:{selection:Array.isArray(r)?r:[]}}).correct}}if(o==="truefalse"){const f=!!s.answer;return{roundIndex:i,cardKey:`info:${t}:question-truefalse`,publicPrompt:{kind:"boolean",title:l,prompt:h,cardLabel:"question"},reveal:{kind:"boolean",expected:f,title:l},grade:g=>Xt({prompt:{kind:"boolean"},expected:f,answer:{booleanAnswer:g==null?null:!!g}}).correct}}if(o==="text"||o==="number"||o==="date"){const f=String(s.answer??"");return{roundIndex:i,cardKey:`info:${t}:question-${o}`,publicPrompt:{kind:"text",title:l,prompt:h,inputType:o==="number"?"number":o==="date"?"date":"text",cardLabel:"question"},reveal:{kind:"text",expected:f,title:l},grade:g=>Xt({prompt:{kind:"text",inputType:o==="number"?"number":o==="date"?"date":"text"},expected:f,answer:{text:String(g??"")}}).correct}}if(o==="ordering"){const f=Array.isArray(s.options)?s.options.filter(j=>typeof j=="string"):[],g=al(f);return{roundIndex:i,cardKey:`info:${t}:question-ordering`,publicPrompt:{kind:"ordering",title:l,prompt:h,options:g,cardLabel:"question"},reveal:{kind:"ordering",expected:f,title:l},grade:j=>Xt({prompt:{kind:"ordering",options:f},expected:f,answer:{ordering:Array.isArray(j)?j.map(String):[]}}).correct}}if(o==="matching"){const g=(Array.isArray(s.columns)?s.columns.map(r=>Array.isArray(r)?r.filter(c=>typeof c=="string"):[]):[]).map(r=>mi(r)),j=s.answer??{},v=(Array.isArray(j.paths)?j.paths.map(r=>Array.isArray(r)?r.map(c=>Number(c)).filter(Number.isFinite):null).filter(r=>Array.isArray(r)):[]).map(r=>r.map((c,E)=>{var m;return((m=g[E])==null?void 0:m.oldToNew.get(c))??c}));return{roundIndex:i,cardKey:`info:${t}:question-matching`,publicPrompt:{kind:"matching",title:l,prompt:h,columns:g.map(r=>r.values),cardLabel:"question"},reveal:{kind:"matching",expected:{paths:v},title:l},grade:r=>{const c=r??{},E=Array.isArray(c.paths)?c.paths.map(m=>Array.isArray(m)?m.map(k=>Number(k)).filter(Number.isFinite):null).filter(m=>Array.isArray(m)):[];return Xt({prompt:{kind:"matching",columns:g.map(m=>m.values)},expected:{paths:v},answer:{matchingPaths:E}}).correct}}}return null}async function rl(t){var v,r;const a=await Rn({libraryId:t.libraryId,revisionId:t.revisionId}),i=(await tn({libraryId:t.libraryId,collectionId:a.collectionId,limit:1e3})).items,l=Array.from(new Set(i.filter(c=>c.cardType==="info").map(c=>c.cardId))),h=new Map;await Promise.all(l.map(async c=>{try{const E=await la({libraryId:t.libraryId,infoId:c});h.set(c,{infoType:E.infoType,payload:E.payload})}catch{}}));const o=new Map;await Promise.all(Array.from(h.entries()).filter(([,c])=>c.infoType==="computed").map(async([c])=>{try{const E=await cs({libraryId:t.libraryId,infoId:c});o.set(c,E)}catch{}}));const f=Array.from(new Set(i.filter(c=>c.cardType==="vocab").map(c=>c.label))).filter(Boolean),g={selectMatchingPairPrompt:((v=t.labels)==null?void 0:v.selectMatchingPairPrompt)??"Select the matching pair",wordLanguagePromptPrefix:((r=t.labels)==null?void 0:r.wordLanguagePromptPrefix)??"Language of"},j=[],u=new Set;for(const c of i){if(c.cardType==="vocab"){const m=nl(c.label);if(!m)continue;if(c.checkType==="translation"&&c.direction==="a-to-b"){const[k,S]=m;j.push({roundIndex:j.length,cardKey:`connection:${c.cardId}:translation:a-to-b`,publicPrompt:{kind:"text",title:c.label,prompt:k,cardLabel:c.description??void 0},reveal:{kind:"text",expected:S,title:c.label},grade:w=>Xt({prompt:{kind:"text",inputType:"text"},expected:S,answer:{text:String(w??"")}}).correct})}else if(c.checkType==="translation"&&c.direction==="b-to-a"){const[k,S]=m;j.push({roundIndex:j.length,cardKey:`connection:${c.cardId}:translation:b-to-a`,publicPrompt:{kind:"text",title:c.label,prompt:S,cardLabel:c.description??void 0},reveal:{kind:"text",expected:k,title:c.label},grade:w=>Xt({prompt:{kind:"text",inputType:"text"},expected:k,answer:{text:String(w??"")}}).correct})}else if(c.checkType==="translation-match"){const k=Array.from(new Set([c.label,...f.filter(w=>w!==c.label).slice(0,3)])),S=k.findIndex(w=>w===c.label);j.push({roundIndex:j.length,cardKey:`connection:${c.cardId}:translation-match`,publicPrompt:{kind:"selection",title:c.label,prompt:g.selectMatchingPairPrompt,options:k,multiple:!1,cardLabel:c.description??void 0},reveal:{kind:"selection",expected:[S],title:c.label},grade:w=>Xt({prompt:{kind:"selection",options:k},expected:[S],answer:{selection:Array.isArray(w)?w.map(y=>Number(y)).filter(Number.isFinite):[Number(w)].filter(Number.isFinite)}}).correct})}continue}if(c.cardType!=="info")continue;const E=h.get(c.cardId);if(E){if(E.infoType==="word"&&c.checkType==="word-language"){const m=sl(c.description);if(!m)continue;j.push({roundIndex:j.length,cardKey:`info:${c.cardId}:word-language:${c.direction??""}`,publicPrompt:{kind:"text",title:c.label,prompt:`${g.wordLanguagePromptPrefix}: ${c.label}`,cardLabel:"word-language"},reveal:{kind:"text",expected:m,title:c.label},grade:k=>Xt({prompt:{kind:"text",inputType:"text"},expected:m,answer:{text:String(k??"")}}).correct});continue}if(E.infoType==="computed"&&c.checkType==="computed"){const m=o.get(c.cardId);if(!m)continue;j.push({roundIndex:j.length,cardKey:`info:${c.cardId}:computed`,publicPrompt:{kind:"text",title:c.label,prompt:m.prompt,multiLine:!1,cardLabel:"computed"},reveal:{kind:"text",expected:m.expectedAnswer,title:c.label},grade:k=>Xt({prompt:{kind:"text",inputType:"text"},expected:m.expectedAnswer,answer:{text:String(k??"")}}).correct});continue}if(E.infoType==="question"){const m=Ts(E.payload),k=m?il(c.cardId,c.label,m,j.length):null;k&&(k.roundIndex=j.length,j.push(k));continue}if(E.infoType==="citation"&&!u.has(c.cardId)){u.add(c.cardId);const m=E.payload,k=typeof m.text=="string"?m.text:"",S=typeof m.title=="string"&&m.title.trim()?m.title.trim():c.label;if(!k.trim())continue;const w=Ia(k,{minLen:7,maxLen:13});for(const y of w.order){const Q=w.nodes[y];if(!Q)continue;const R=$n(k,Q);j.push({roundIndex:j.length,cardKey:`info:${c.cardId}:quote-fragment:${y}`,publicPrompt:{kind:"citation-fragment",title:S,before:R.before,after:R.after,fragmentId:y,cardLabel:"quote-fragment"},reveal:{kind:"citation-fragment",expected:R.fragment,title:S},grade:b=>Xt({prompt:{kind:"citation-fragment"},expected:R.fragment,answer:{text:String(b??"")}}).correct})}continue}}}return j.map((c,E)=>({...c,roundIndex:E}))}function ol(t){var st;const{libraryId:a,revisionId:s}=t,i=Ua(),l=t.copy.cogita.library.revision,h=l.live,[o,f]=n.useState(null),[g,j]=n.useState([]),[u,v]=n.useState("loading"),[r,c]=n.useState(null),[E,m]=n.useState("simultaneous"),[k,S]=n.useState("panel"),[w,y]=n.useState("question"),Q=`cogita.live.host.${a}.${s}`,R=o?g[o.currentRoundIndex]??null:null,b=o!=null&&o.status&&o.status!=="lobby"?o.currentPrompt??null:null,P=(o==null?void 0:o.currentReveal)??null,_=n.useMemo(()=>o!=null&&o.code&&typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision/${encodeURIComponent(o.code)}`:"",[o==null?void 0:o.code]),re=n.useMemo(()=>o!=null&&o.code&&typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision-screen/${encodeURIComponent(o.code)}`:"",[o==null?void 0:o.code]),C=n.useMemo(()=>{if(!(o!=null&&o.sessionId)||!(o!=null&&o.hostSecret)||typeof window>"u")return"";const D=`${window.location.origin}/#/cogita/live-revision-host/${encodeURIComponent(a)}/${encodeURIComponent(s)}`,he=new URLSearchParams({sessionId:o.sessionId,hostSecret:o.hostSecret,code:o.code});return`${D}?${he.toString()}`},[a,s,o==null?void 0:o.code,o==null?void 0:o.hostSecret,o==null?void 0:o.sessionId]),z=(o==null?void 0:o.status)==="finished"||(o==null?void 0:o.status)==="closed"?"finished":o!=null&&o.status&&o.status!=="lobby"?"active":"lobby",A=k==="panel",ne=k==="panel"||k==="question",ke=k==="panel"||k==="score",Le=(D,he)=>D.replace(/\{(\w+)\}/g,(Ye,U)=>String(he[U]??"")),$e={lobby:h.statusLobby,running:h.statusRunning,revealed:h.statusRevealed,finished:h.statusFinished,closed:"Closed"},de=(D,he,Ye)=>({...D,hostSecret:D.hostSecret||(he==null?void 0:he.hostSecret)||(Ye==null?void 0:Ye.hostSecret)||"",code:D.code||(he==null?void 0:he.code)||(Ye==null?void 0:Ye.code)||""}),ge=n.useRef(null),M=async()=>{const D=await ds({libraryId:a,revisionId:s,title:h.hostKicker,sessionMode:E,hostViewMode:k,participantViewMode:w,sessionSettings:{mode:E,hostViewMode:k,participantViewMode:w}});f(D),typeof localStorage<"u"&&localStorage.setItem(Q,JSON.stringify({sessionId:D.sessionId,hostSecret:D.hostSecret,code:D.code}))};n.useEffect(()=>{o!=null&&o.sessionId&&(m(o.sessionMode==="asynchronous"?"asynchronous":"simultaneous"),S(o.hostViewMode==="question"||o.hostViewMode==="score"?o.hostViewMode:"panel"),y(o.participantViewMode==="score"||o.participantViewMode==="fullscreen"?o.participantViewMode:"question"))},[o==null?void 0:o.sessionId]),n.useEffect(()=>{let D=!1;return rl({libraryId:a,revisionId:s,labels:{selectMatchingPairPrompt:h.selectMatchingPairPrompt,wordLanguagePromptPrefix:h.wordLanguagePromptPrefix}}).then(he=>{D||j(he)}).catch(()=>{D||(c(h.loadRoundsError),v("error"))}),()=>{D=!0}},[a,h.selectMatchingPairPrompt,h.wordLanguagePromptPrefix,s]),n.useEffect(()=>{let D=!1;async function he(){try{const Ye=new URLSearchParams(i.search),U=Ye.get("sessionId"),qe=Ye.get("hostSecret"),at=Ye.get("code");if(!!(U&&qe)&&U&&qe){const Fe=await Ks({libraryId:a,sessionId:U,hostSecret:qe});if(D)return;const ve=de(Fe,null,{hostSecret:qe,code:at??void 0});f(ve),typeof localStorage<"u"&&localStorage.setItem(Q,JSON.stringify({sessionId:ve.sessionId,hostSecret:ve.hostSecret,code:ve.code})),v("ready");return}const yt=await ds({libraryId:a,revisionId:s,title:h.hostKicker,sessionMode:E,hostViewMode:k,participantViewMode:w,sessionSettings:{mode:E,hostViewMode:k,participantViewMode:w}});if(D)return;f(yt),localStorage.setItem(Q,JSON.stringify({sessionId:yt.sessionId,hostSecret:yt.hostSecret,code:yt.code})),v("ready")}catch{if(D)return;c(h.createSessionError),v("error")}}return he(),()=>{D=!0}},[a,h.hostKicker,i.search,s,Q]),n.useEffect(()=>{if(!o)return;const D=window.setInterval(async()=>{try{const he=await Ks({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret});f(Ye=>de(he,Ye))}catch{}},1200);return()=>window.clearInterval(D)},[a,o]),n.useEffect(()=>{if(!o||!R||o.status!=="running"||o.sessionMode!=="simultaneous")return;const D=o.participants.filter(qe=>qe.isConnected);if(D.length===0)return;const he=new Set(o.currentRoundAnswers.filter(qe=>qe.roundIndex===o.currentRoundIndex&&(qe.cardKey??"")===R.cardKey).map(qe=>qe.participantId));if(!D.every(qe=>he.has(qe.participantId)))return;const U=`${o.sessionId}:${o.currentRoundIndex}:${R.cardKey}:running`;ge.current!==U&&(ge.current=U,oe().catch(()=>{ge.current=null}))},[R,o]);const ae=async D=>{if(!o)return;const he=Object.prototype.hasOwnProperty.call(D,"currentPrompt"),Ye=Object.prototype.hasOwnProperty.call(D,"currentReveal"),U=await xr({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret,status:D.status??o.status,currentRoundIndex:D.currentRoundIndex??o.currentRoundIndex,revealVersion:D.revealVersion??o.revealVersion,currentPrompt:he?D.currentPrompt??null:o.currentPrompt??null,currentReveal:Ye?D.currentReveal??null:o.currentReveal??null});f(qe=>de(U,qe))},Ve=async D=>{const he=g[D];!he||!o||await ae({status:"running",currentRoundIndex:D,revealVersion:o.revealVersion+1,currentReveal:null,currentPrompt:{...he.publicPrompt,roundIndex:D,cardKey:he.cardKey}})},Se=async()=>{g.length&&await Ve((o==null?void 0:o.currentRoundIndex)??0)},oe=async()=>{if(!o||!R)return;const D=new Map(o.currentRoundAnswers.filter(U=>U.roundIndex===o.currentRoundIndex&&(U.cardKey??"")===R.cardKey).map(U=>[U.participantId,U.answer])),he=o.participants.map(U=>{const qe=D.get(U.participantId),at=R.grade(qe);return{participantId:U.participantId,isCorrect:at,pointsAwarded:at?1:0}}),Ye=await vr({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret,scores:he});f(U=>de(Ye,U)),await ae({status:"revealed",revealVersion:Ye.revealVersion+1,currentReveal:R.reveal})},H=async()=>{if(!o)return;const D=o.currentRoundIndex+1;if(D>=g.length){await ae({status:"finished",currentReveal:null});return}await Ve(D)},Oe=async()=>{if(o){if(o.status==="running"){await oe();return}if(o.status==="revealed"){await H();return}o.status==="lobby"&&await Se()}},W=async D=>{if(o!=null&&o.hostSecret)try{const he=await jr({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret,requestId:D});f(Ye=>de(he,Ye))}catch{}},ze=async()=>{if(o)try{const D=await Ns({libraryId:a,sessionId:o.sessionId});f(D),typeof localStorage<"u"&&localStorage.setItem(Q,JSON.stringify({sessionId:D.sessionId,hostSecret:D.hostSecret,code:D.code}))}catch{}},Te=async()=>{try{v("loading"),await M(),v("ready")}catch{c(h.createSessionError),v("error")}},Ee=async()=>{if(o)try{const D=await wr({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret});f(he=>de(D,he))}catch{}};return e.jsx(Ft,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":z,children:[A?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:h.hostKicker}),e.jsx("h2",{className:"cogita-detail-title",children:h.hostTitle}),u==="loading"?e.jsx("p",{children:h.loading}):null,r?e.jsx("p",{className:"cogita-help",children:r}):null,o?e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Session mode"}),e.jsxs("select",{value:E,onChange:D=>m(D.target.value),children:[e.jsx("option",{value:"simultaneous",children:"Simultaneous"}),e.jsx("option",{value:"asynchronous",children:"Asynchronous"})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Host view"}),e.jsxs("select",{value:k,onChange:D=>S(D.target.value),children:[e.jsx("option",{value:"panel",children:"Panel"}),e.jsx("option",{value:"question",children:"Question"}),e.jsx("option",{value:"score",children:"Score"})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Participant view"}),e.jsxs("select",{value:w,onChange:D=>y(D.target.value),children:[e.jsx("option",{value:"question",children:"Question"}),e.jsx("option",{value:"score",children:"Score"}),e.jsx("option",{value:"fullscreen",children:"Fullscreen"})]})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:h.joinCodeLabel}),e.jsx("input",{readOnly:!0,value:o.code})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:h.joinUrlLabel}),e.jsx("input",{readOnly:!0,value:_})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Host URL"}),e.jsx("input",{readOnly:!0,value:C})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Presenter URL"}),e.jsx("input",{readOnly:!0,value:re})]}),_?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:h.qrLabel}),e.jsx("div",{style:{display:"inline-flex",padding:"0.75rem",borderRadius:"12px",background:"#fff"},children:e.jsx(yi,{value:_,size:176,marginSize:2})})]}):null,e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:h.statusLabel}),e.jsx("input",{readOnly:!0,value:$e[o.status]??o.status})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:Se,disabled:!g.length,children:h.publishCurrentRound}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Te,children:"New session"}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ze,children:"Refresh links"}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Ee,disabled:o.status==="closed",children:"Close session"})]}),e.jsx("p",{className:"cogita-help",children:Le(h.roundsLabel,{count:g.length})})]}):null]}):null,ne?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:h.currentRoundTitle}),e.jsx("h3",{className:"cogita-detail-title",children:b&&typeof b.title=="string"?b.title:(o==null?void 0:o.status)==="lobby"?h.sessionNotStarted:h.waitingForPublishedRound}),(o==null?void 0:o.status)==="lobby"?e.jsx("p",{className:"cogita-help",children:h.hiddenBeforeStart}):e.jsx(Ja,{className:"cogita-live-card-container",feedbackToken:P?`correct-${(o==null?void 0:o.revealVersion)??0}`:"idle",children:e.jsx(Pn,{prompt:b,revealExpected:P==null?void 0:P.expected,mode:"readonly",labels:{answerLabel:l.answerLabel,correctAnswerLabel:l.correctAnswerLabel,trueLabel:h.trueLabel,falseLabel:h.falseLabel,fragmentLabel:h.fragmentLabel,correctFragmentLabel:h.correctFragmentLabel,participantAnswerPlaceholder:h.participantAnswerPlaceholder,unsupportedPromptType:h.unsupportedPromptType,waitingForReveal:"Waiting for reveal.",selectedPaths:"Selected paths",removePath:"Remove",columnPrefix:"Column"}})}),z!=="lobby"?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:Oe,disabled:!g.length||!R||o.status==="finished"||o.status==="closed",children:o.status==="revealed"?l.nextQuestion:l.checkAnswer})}):null,z!=="finished"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:h.participantsTitle}),e.jsxs("div",{className:"cogita-share-list",children:[o==null?void 0:o.participants.map(D=>{const he=o.currentRoundAnswers.find(Ye=>Ye.participantId===D.participantId);return e.jsx("div",{className:"cogita-share-row",children:e.jsxs("div",{children:[e.jsx("strong",{children:D.displayName}),e.jsxs("div",{className:"cogita-share-meta",children:[he?h.answerStatusAnswered:h.answerStatusWaiting,(he==null?void 0:he.isCorrect)===!0?` · ${h.answerStatusCorrect}`:"",(he==null?void 0:he.isCorrect)===!1?` · ${h.answerStatusIncorrect}`:""]})]})},D.participantId)}),o&&o.participants.length===0?e.jsx("p",{className:"cogita-help",children:h.noParticipants}):null]}),o&&(((st=o.pendingReloginRequests)==null?void 0:st.length)??0)>0?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Relogin requests"}),e.jsx("div",{className:"cogita-share-list",children:(o.pendingReloginRequests??[]).map(D=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsxs("div",{children:[e.jsx("strong",{children:D.displayName}),e.jsx("div",{className:"cogita-share-meta",children:new Date(D.requestedUtc).toLocaleTimeString()})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>W(D.requestId),children:"Allow relogin"})]},D.requestId))})]}):null]}):null]}):null,z!=="lobby"&&ke?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:z==="finished"?h.finalScoreTitle:h.pointsTitle}),e.jsx("div",{className:"cogita-share-list",children:((o==null?void 0:o.scoreboard)??[]).map(D=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:D.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[D.score," ",h.scoreUnit]})]},`score:${D.participantId}`))})]}):null]})})})})})}const bl=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionHostPage:ol},Symbol.toStringTag,{value:"Module"}));function gi(t){return`cogita.live.join.${t}`}function ll(t){const{code:a}=t,s=t.copy.cogita.library.revision,i=s.live,[l,h]=n.useState(""),[o,f]=n.useState(()=>typeof localStorage>"u"?null:localStorage.getItem(gi(a))),[g,j]=n.useState(null),[u,v]=n.useState("idle"),[r,c]=n.useState(""),[E,m]=n.useState([]),[k,S]=n.useState(null),[w,y]=n.useState([]),[Q,R]=n.useState([]),[b,P]=n.useState([]),[_,re]=n.useState(null),[C,z]=n.useState(!1),A=(g==null?void 0:g.currentPrompt)??null,ne=(g==null?void 0:g.currentReveal)??null,ke=ne==null?void 0:ne.expected,Le=(g==null?void 0:g.status)==="finished"||(g==null?void 0:g.status)==="closed"?"finished":g!=null&&g.status&&g.status!=="lobby"?"active":"lobby",$e=(g==null?void 0:g.participantViewMode)??"question",de=$e!=="fullscreen"||Le==="lobby"||!o,ge=$e!=="score",M=$e!=="question"||Le==="finished",ae=n.useMemo(()=>`${(g==null?void 0:g.currentRoundIndex)??0}:${(g==null?void 0:g.revealVersion)??0}:${String((A==null?void 0:A.cardKey)??"")}`,[A==null?void 0:A.cardKey,g==null?void 0:g.currentRoundIndex,g==null?void 0:g.revealVersion]);n.useEffect(()=>{c(""),m([]),S(null),y(Array.isArray(A==null?void 0:A.options)?[...A.options??[]]:[]);const W=Array.isArray(A==null?void 0:A.columns)?Math.max(2,A.columns.length):0;R([]),P(W>0?new Array(W).fill(null):[])},[ae]),n.useEffect(()=>{let W=!0;const ze=async()=>{try{const Ee=await us({code:a,participantToken:o});if(!W)return;j(Ee),o&&v("ready")}catch{W&&u!=="joining"&&v("error")}};ze();const Te=window.setInterval(ze,1200);return()=>{W=!1,window.clearInterval(Te)}},[a,o,u]),n.useEffect(()=>{if(!_||!C||o)return;let W=!1;const ze=window.setInterval(async()=>{try{const Te=await kr({code:a,requestId:_});if(W)return;Te.status==="approved"&&(z(!1),v("idle"))}catch{}},1200);return()=>{W=!0,window.clearInterval(ze)}},[a,o,C,_]);const Ve=async()=>{v("joining");try{const W=await Nr({code:a,name:l});f(W.participantToken),localStorage.setItem(gi(a),W.participantToken),z(!1),re(null),v("ready")}catch(W){if(W instanceof js&&W.status===409)try{const ze=await Sr({code:a,name:l});re(ze.requestId),z(!0),v("ready");return}catch{v("error");return}v("error")}},Se=W=>{if(!!(A!=null&&A.multiple)){m(Te=>Te.includes(W)?Te.filter(Ee=>Ee!==W):[...Te,W].sort((Ee,st)=>Ee-st));return}m([W])},oe=(W,ze)=>{y(Te=>{const Ee=[...Te],st=W+ze;return st<0||st>=Ee.length?Te:([Ee[W],Ee[st]]=[Ee[st],Ee[W]],Ee)})},H=(W,ze)=>{const Te=Array.isArray(A==null?void 0:A.columns)?A.columns:[],Ee=Math.max(2,Te.length);P(st=>{const D=Array.from({length:Ee},(Ye,U)=>st[U]??null);if(D[W]=D[W]===ze?null:ze,D.some(Ye=>Ye==null))return D;const he=D.map(Ye=>Number(Ye));return R(Ye=>[...Ye,he]),new Array(Ee).fill(null)})},Oe=async()=>{if(!o||!A||typeof A.cardKey!="string")return;let W=null;switch(A.kind){case"selection":W=E;break;case"boolean":W=k;break;case"ordering":W=w;break;case"matching":W={paths:Q};break;case"citation-fragment":case"text":default:W=r;break}try{await Tr({code:a,participantToken:o,roundIndex:Number(A.roundIndex??(g==null?void 0:g.currentRoundIndex)??0),cardKey:A.cardKey,answer:W});const ze=await us({code:a,participantToken:o});j(ze),v("ready")}catch{v("error")}};return e.jsx(Ft,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":Le,"data-participant-view":$e,children:[de?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:i.joinKicker}),e.jsx("h2",{className:"cogita-detail-title",children:i.joinTitle}),o?e.jsx("p",{className:"cogita-help",children:i.joinedWaiting}):e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:i.participantNameLabel}),e.jsx("input",{value:l,onChange:W=>h(W.target.value)})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:Ve,disabled:!l.trim()||u==="joining",children:u==="joining"?i.joiningAction:i.joinAction})})]}),C?e.jsx("p",{className:"cogita-help",children:"Relogin request sent. Wait for host approval and join again."}):null,u==="error"?e.jsx("p",{className:"cogita-help",children:i.connectionError}):null,Le==="lobby"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:i.scoreboardTitle}),e.jsxs("div",{className:"cogita-share-list",children:[g==null?void 0:g.scoreboard.map(W=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:W.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[W.score," ",i.scoreUnit]})]},W.participantId)),g&&g.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:i.noParticipants}):null]})]}):null]}):null,ge?e.jsxs("div",{className:`cogita-library-panel ${$e==="fullscreen"?"cogita-live-fullscreen-panel":""}`,children:[e.jsx("p",{className:"cogita-user-kicker",children:i.questionTitle}),e.jsx("h3",{className:"cogita-detail-title",children:typeof(A==null?void 0:A.title)=="string"?A.title:i.waitingForPublishedRound}),A?e.jsxs(e.Fragment,{children:[e.jsx(Ja,{className:"cogita-live-card-container",feedbackToken:ne?`correct-${(g==null?void 0:g.revealVersion)??0}`:"idle",children:e.jsx(Pn,{prompt:A,revealExpected:ke,mode:"interactive",labels:{answerLabel:s.answerLabel,correctAnswerLabel:s.correctAnswerLabel,trueLabel:i.trueLabel,falseLabel:i.falseLabel,fragmentLabel:i.fragmentLabel,correctFragmentLabel:i.correctFragmentLabel,participantAnswerPlaceholder:i.participantAnswerPlaceholder,unsupportedPromptType:i.unsupportedPromptType,waitingForReveal:"Waiting for reveal.",selectedPaths:"Selected paths",removePath:"Remove",columnPrefix:"Column"},answers:{text:r,selection:E,booleanAnswer:k,ordering:w,matchingRows:Q,matchingSelection:b},onTextChange:c,onSelectionToggle:Se,onBooleanChange:S,onOrderingMove:oe,onMatchingPick:H,onMatchingRemovePath:W=>R(ze=>ze.filter((Te,Ee)=>Ee!==W))})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:Oe,disabled:!o||!A.cardKey||(g==null?void 0:g.answerSubmitted),children:g!=null&&g.answerSubmitted?i.submitted:i.submitAnswer})})]}):e.jsx("p",{className:"cogita-help",children:i.waitingForHostQuestion})]}):null,Le!=="lobby"&&M?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:Le==="finished"?i.finalScoreTitle:i.pointsTitle}),e.jsxs("div",{className:"cogita-share-list",children:[g==null?void 0:g.scoreboard.map(W=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:W.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[W.score," ",i.scoreUnit]})]},`score:${W.participantId}`)),g&&g.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:i.noParticipants}):null]})]}):null]})})})})})}const yl=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionJoinPage:ll},Symbol.toStringTag,{value:"Module"}));function cl(t){const{code:a}=t,s=t.copy.cogita.library.revision.live,[i,l]=n.useState(null),[h,o]=n.useState("loading"),f=(i==null?void 0:i.currentPrompt)??null,g=(i==null?void 0:i.currentReveal)??null,j=g==null?void 0:g.expected,u=(i==null?void 0:i.participantViewMode)??"question",v=(i==null?void 0:i.status)==="finished"||(i==null?void 0:i.status)==="closed"?"finished":i!=null&&i.status&&i.status!=="lobby"?"active":"lobby",r=u!=="score",c=u!=="question"||v==="finished",E=n.useMemo(()=>typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision/${encodeURIComponent(a)}`:"",[a]);return n.useEffect(()=>{let m=!0;const k=async()=>{try{const w=await us({code:a});if(!m)return;l(w),o("ready")}catch{if(!m)return;o("error")}};k();const S=window.setInterval(k,1200);return()=>{m=!1,window.clearInterval(S)}},[a]),e.jsx(Ft,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":v,"data-participant-view":u,children:[r?e.jsxs("div",{className:`cogita-library-panel ${u==="fullscreen"?"cogita-live-fullscreen-panel":""}`,children:[e.jsx("p",{className:"cogita-user-kicker",children:s.hostKicker}),e.jsx("h2",{className:"cogita-detail-title",children:h==="error"?s.connectionError:s.statusLobby}),(i==null?void 0:i.status)==="lobby"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:s.joinCodeLabel}),e.jsx("input",{readOnly:!0,value:a})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:s.joinUrlLabel}),e.jsx("input",{readOnly:!0,value:E})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:s.qrLabel}),e.jsx("div",{style:{display:"inline-flex",padding:"0.75rem",borderRadius:"12px",background:"#fff"},children:e.jsx(yi,{value:E,size:176,marginSize:2})})]})]}):e.jsx(Ja,{className:"cogita-live-card-container",feedbackToken:g?`correct-${(i==null?void 0:i.revealVersion)??0}`:"idle",children:e.jsx(Pn,{prompt:f,revealExpected:j,mode:"readonly",labels:{answerLabel:t.copy.cogita.library.revision.answerLabel,correctAnswerLabel:t.copy.cogita.library.revision.correctAnswerLabel,trueLabel:s.trueLabel,falseLabel:s.falseLabel,fragmentLabel:s.fragmentLabel,correctFragmentLabel:s.correctFragmentLabel,participantAnswerPlaceholder:s.participantAnswerPlaceholder,unsupportedPromptType:s.unsupportedPromptType,waitingForReveal:"Waiting for reveal.",selectedPaths:"Selected paths",removePath:"Remove",columnPrefix:"Column"}})})]}):null,c?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:(i==null?void 0:i.status)==="finished"?s.finalScoreTitle:s.pointsTitle}),e.jsxs("div",{className:"cogita-share-list",children:[((i==null?void 0:i.scoreboard)??[]).map(m=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:m.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[m.score," ",s.scoreUnit]})]},`presenter-score:${m.participantId}`)),i&&i.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:s.noParticipants}):null]})]}):null]})})})})})}const vl=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionPresenterPage:cl},Symbol.toStringTag,{value:"Module"}));function dl(t){const a=sn(),s=t.copy.cogita.library.revision.live,{libraryId:i}=t,[l,h]=n.useState([]),[o,f]=n.useState([]),[g,j]=n.useState("loading"),[u,v]=n.useState(null),[r,c]=n.useState({}),E=n.useMemo(()=>({lobby:s.statusLobby,running:s.statusRunning,revealed:s.statusRevealed,finished:s.statusFinished,closed:"Closed"}),[s.statusFinished,s.statusLobby,s.statusRevealed,s.statusRunning]),m=async()=>{j("loading");try{const[S,w]=await Promise.all([Cr({libraryId:i}),Ci({libraryId:i})]);h(S),f(w),j("ready")}catch{h([]),f([]),j("error")}};n.useEffect(()=>{m()},[i]);const k=async(S,w)=>{v(S.sessionId);try{const y=r[S.sessionId]??await Ns({libraryId:i,sessionId:S.sessionId});r[S.sessionId]||c(b=>({...b,[S.sessionId]:{sessionId:y.sessionId,code:y.code,hostSecret:y.hostSecret}}));const Q=encodeURIComponent(y.code);if(w==="host"){a(`/cogita/live-revision-host/${encodeURIComponent(i)}/${encodeURIComponent(S.revisionId)}?sessionId=${encodeURIComponent(y.sessionId)}&hostSecret=${encodeURIComponent(y.hostSecret)}&code=${Q}`);return}const R=w==="presenter"?`${window.location.origin}/#/cogita/public/live-revision-screen/${Q}`:`${window.location.origin}/#/cogita/public/live-revision/${Q}`;window.open(R,"_blank","noopener")}finally{v(null)}};return e.jsx(Ft,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("div",{className:"cogita-detail-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:s.hostKicker}),e.jsx("h2",{className:"cogita-detail-title",children:"Active live sessions"})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:m,children:"Refresh"})})]}),g==="loading"?e.jsx("p",{children:s.loading}):null,g==="error"?e.jsx("p",{className:"cogita-help",children:s.connectionError}):null,g==="ready"&&l.length===0?e.jsx("p",{className:"cogita-help",children:"No active sessions."}):null,e.jsx("div",{className:"cogita-share-list",children:l.map(S=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsxs("div",{children:[e.jsx("strong",{children:S.title||S.sessionId}),e.jsxs("div",{className:"cogita-share-meta",children:[E[S.status]??S.status," · ",s.participantsTitle,": ",S.participantCount]})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>k(S,"host"),disabled:u===S.sessionId,children:"Host"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>k(S,"presenter"),disabled:u===S.sessionId,children:"Screen"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>k(S,"login"),disabled:u===S.sessionId,children:"Login panel"})]})]},S.sessionId))}),e.jsx("div",{className:"cogita-detail-header",style:{marginTop:"1rem"},children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Participant sessions"}),e.jsx("h3",{className:"cogita-detail-title",children:"Sessions where you participate"})]})}),g==="ready"&&o.length===0?e.jsx("p",{className:"cogita-help",children:"No participant sessions."}):null,e.jsx("div",{className:"cogita-share-list",children:o.map(S=>e.jsx("div",{className:"cogita-share-row",children:e.jsxs("div",{children:[e.jsx("strong",{children:S.title||S.sessionId}),e.jsxs("div",{className:"cogita-share-meta",children:[E[S.status]??S.status," · ",s.participantsTitle,": ",S.participantCount]}),e.jsxs("div",{className:"cogita-share-meta",children:["Score: ",S.participantScore," · ",S.isConnected?"Connected":"Disconnected"]})]})},`participating:${S.sessionId}`))})]})})})})})}const xl=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveSessionsPage:dl},Symbol.toStringTag,{value:"Module"}));export{gl as C,pl as a,fl as b,bl as c,yl as d,vl as e,xl as f};
