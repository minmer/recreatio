import{r as a,j as e,u as Os,a as Va,b as qs,c as Us,d as Ws,R as gs,B as ms,C as ps}from"./vendor-CL5v9b84.js";import{L as Hs,A as Qs,g as Ys,a as xn,b as ja,c as Gs,s as Ns,d as fs,e as vn,f as Ss,h as Gt,i as wn,j as Js,k as Xs,l as Zs,m as bs,n as en,o as jn,u as kn,p as Nn,q as Sn,r as Tn,t as Cn,v as Mn,w as tn,x as an,y as In,z as Ln,B as $n,C as Oa,D as Ra,E as Rn,F as En,G as sn,H as An,I as Pn,J as Fn,K as Ts,M as Yt,N as Kn,O as zn,P as Bn,Q as Dn,R as _n,S as Vn,T as On,U as qn,V as Un,W as Wn,X as Hn,Y as Qn,Z as Yn,_ as Gn,$ as Jn,a0 as Xn,a1 as Cs}from"./recreatio-core-r39TKt4X.js";import"./vendor-cogita-ui-mbCyoqV0.js";const wa={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},xa={moveMs:900,pauseMs:220,errorMs:900},Zn=(t=11)=>{let s=t;const n=()=>(s=(s*1664525+1013904223)%4294967296,s/4294967296),{width:i,height:o,paddingX:g,paddingY:f,levels:x}=wa,A=(o-f*2)/(x.length-1),N=[],l=[],b=[];x.forEach((k,m)=>{const ce=o-f-m*A,P=i-g*2,p=[];for(let H=0;H<k;H+=1){const R=g+(H+1)*P/(k+1),X=(n()-.5)*18,L=Math.max(g,Math.min(i-g,R+X)),E=m===0?3:m<2?2.1:1.4,se=m===0?"root":`l${m}-${H}`;p.push({id:se,x:m===0?i/2:L,y:ce,r:E,level:m,role:m===0?"root":void 0})}b.push(p),N.push(...p)});const c=b[b.length-1];if(c!=null&&c.length){const k=c[Math.floor(c.length/2)];k.role="goal",k.r=2}for(let k=1;k<b.length;k+=1){const m=b[k-1];b[k].forEach(P=>{const p=[...m].sort((L,E)=>Math.abs(L.x-P.x)-Math.abs(E.x-P.x)),H=p[0],R=p[1]&&n()<.45?p[1]:null;(R?[H,R]:[H]).forEach(L=>{l.push({from:L.id,to:P.id,key:`${L.id}-${P.id}`})}),n()<.2&&p[2]&&l.push({from:p[2].id,to:P.id,key:`${p[2].id}-${P.id}`})})}const u=new Map;l.forEach(k=>{const m=u.get(k.to)??[];m.push(k.from),u.set(k.to,m)});const S=new Map,ae=new Map,J=new Map;l.forEach(k=>{const m=S.get(k.from)??[];m.push(k.key),S.set(k.from,m);const ce=ae.get(k.from)??[];ce.push(k.to),ae.set(k.from,ce);const P=J.get(k.from)??[];P.push(k.to),J.set(k.from,P);const p=J.get(k.to)??[];p.push(k.from),J.set(k.to,p)});const W=new Map;return N.forEach(k=>{W.set(k.id,k)}),{nodes:N,links:l,parentsById:u,linksByFrom:S,childrenByFrom:ae,neighborsById:J,nodesById:W}};function ei({slides:t,activeIndex:s,introOpen:n,prefersReducedMotion:i,onNext:o,onPrev:g,onSelect:f,onExit:x,onOpen:A,onRegister:N}){const l=s===t.length-1,b=n&&s===0?"entry":"docked",c=t[t.length-1],[u,S]=a.useState(!1),ae=a.useMemo(()=>Array.from({length:20},($,q)=>({src:`/cogita/logo/Cogita${String(q).padStart(2,"0")}.png`,kind:q<=11?"bubble":q<=17?"text":"recreatio"})),[]),J=n&&s===0;a.useEffect(()=>{if(!n){S(!1);return}s>0&&!u&&S(!0)},[s,n,u]);const W=a.useRef(0),k=a.useRef(null),m=a.useMemo(()=>{const $={x:40,y:160},q={x:260,y:48},je=6,M=q.x-$.x,K=$.y-q.y,ue=M/je,pe=[.3,.45,.6,.65,1.4,2.2],Q=pe.reduce((Pe,Me)=>Pe+Me,0),Ce=pe.map(Pe=>K*Pe/Q),ke=[$];let ze=$.x,Re=$.y;for(let Pe=1;Pe<=je;Pe+=1){const Me=(Math.random()-.5)*14,ct=(Math.random()-.5)*28;ze=Math.max($.x+Pe*14,Math.min(q.x-(je-Pe)*14,ze+ue+Me));const Ue=Ce[Pe-1]??Ce[Ce.length-1];Re=Re-Ue+ct;const Xe=Math.max(q.y,Math.min($.y-4,Re));ke.push({x:Math.round(ze),y:Math.round(Xe)})}return ke[ke.length-1]=q,ke},[]),ce=a.useMemo(()=>{const K=(Q,Ce,ke)=>Math.min(ke,Math.max(Ce,Q)),ue=m.map(Q=>{const Ce=10+Math.random()*36;return{x:K(Q.x,40,260),y:K(Q.y-Ce,40,140)}}),pe=m.map((Q,Ce)=>{var Re;const ke=12+Math.random()*40,ze=((Re=ue[Ce])==null?void 0:Re.y)??Q.y;return{x:K(Q.x,40,260),y:K(Math.max(ze+10,Q.y+ke),60,170)}});return{upper:ue,lower:pe}},[m]),P=a.useMemo(()=>{var q;const $=((q=m[4])==null?void 0:q.x)??260;return Math.max(0,Math.min(240,$-40))},[m]),p=a.useMemo(()=>{var Ce,ke;const $=(ze,Re,Pe)=>Math.min(Pe,Math.max(Re,ze)),q=(ze,Re,Pe)=>m.map((Me,ct)=>{var Ct,dt;const Ue=((Ct=ce.upper[ct])==null?void 0:Ct.y)??Me.y,Xe=((dt=ce.lower[ct])==null?void 0:dt.y)??Me.y,lt=(Math.random()-.5)*70,yt=Me.y+ze+lt,We=$(Me.y+Re,Ue+6,Xe-6),He=$(Me.y+Pe,Ue+6,Xe-6);return{x:Me.x,y:$(yt,Math.min(We,He),Math.max(We,He))}}),je=-14+Math.random()*28,M=14+Math.random()*28,K=q(je,-80,12),ue=q(M,-12,80);for(let ze=4;ze<m.length;ze+=1){const Re=m[ze],Pe=((Ce=ce.upper[ze])==null?void 0:Ce.y)??Re.y,Me=((ke=ce.lower[ze])==null?void 0:ke.y)??Re.y;K[ze]={x:Re.x,y:$(Re.y-12,Pe+6,Me-6)},ue[ze]={x:Re.x,y:$(Re.y+12,Pe+6,Me-6)}}const pe=ce.upper.length?ce.upper[ce.upper.length-1].y:40,Q=ce.lower.length?ce.lower[ce.lower.length-1].y:170;return K[K.length-1]={x:m[m.length-1].x,y:$(m[m.length-1].y-14,pe,Q)},ue[ue.length-1]={x:m[m.length-1].x,y:$(m[m.length-1].y+12,pe,Q)},{higher:K,lower:ue}},[m,ce]),H=1e4,R=a.useMemo(()=>{let $=17;const q=()=>($=($*1664525+1013904223)%4294967296,$/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((M,K)=>{const ue=(q()-.5)*240,pe=(q()-.5)*180,Q=(q()-.5)*24;return{id:`card-${K+1}`,throw:{x:`${ue.toFixed(0)}px`,y:`${pe.toFixed(0)}px`,rot:`${Q.toFixed(1)}deg`},grid:{x:`${M.x}px`,y:`${M.y}px`},delay:`${K*.12}s`}})},[]),X=a.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[L,E]=a.useState([]),se=a.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),ie=a.useMemo(()=>{const q=[],M=(ue,pe)=>ue+Math.random()*(pe-ue);for(let ue=0;ue<6;ue+=1){let pe=!1;for(let Q=0;Q<80;Q+=1){const Ce=M(14,86),ke=M(10,34);if(q.every(Re=>{const Pe=Re.x-Ce,Me=Re.y-ke;return Math.hypot(Pe,Me)>=12})){q.push({x:Ce,y:ke}),pe=!0;break}}pe||q.push({x:M(16,84),y:M(12,32)})}return q.map((ue,pe)=>({id:`p${pe+1}`,x:`${ue.x.toFixed(1)}%`,y:`${ue.y.toFixed(1)}%`,xNum:ue.x,yNum:ue.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[re,De]=a.useState(0),[he,T]=a.useState(0),[be,y]=a.useState([]),V=1e4,me=a.useMemo(()=>{if(ie.length<2)return[];const $=pe=>{let Q=pe+1831565813;return Q=Math.imul(Q^Q>>>15,Q|1),Q^=Q+Math.imul(Q^Q>>>7,Q|61),((Q^Q>>>14)>>>0)/4294967296},q=(pe,Q)=>Math.floor($(pe)*Q),je=new Set,M=[],K=Math.min(3,ie.length);let ue=0;for(;M.length<K&&ue<30;){ue+=1;const pe=q(re*13+ue*5,ie.length),Q=q(re*29+ue*7,ie.length);if(pe===Q)continue;const Ce=pe<Q?`${pe}-${Q}`:`${Q}-${pe}`;je.has(Ce)||(je.add(Ce),M.push({id:`link-${Ce}`,from:ie[pe],to:ie[Q],delay:`${(ue*.35).toFixed(2)}s`}))}return M},[re,ie]);a.useEffect(()=>{if(!n||s!==2)return;const $=()=>{const je=R.map(M=>M.id);for(let M=je.length-1;M>0;M-=1){const K=Math.floor(Math.random()*(M+1));[je[M],je[K]]=[je[K],je[M]]}return je.slice(0,4)};E($());const q=window.setInterval(()=>{E($())},H);return()=>window.clearInterval(q)},[s,n,R,H]),a.useEffect(()=>{if(!n||s!==3)return;const $=()=>{T(Math.floor(Math.random()*se.length)),y(ie.map(()=>Math.random()<.6?"good":"bad")),De(je=>je+1)};$();const q=window.setInterval($,V);return()=>window.clearInterval(q)},[s,n,se.length,ie,V]);const Y=a.useMemo(()=>Zn(11),[]),[F,we]=a.useState(new Set(["root"])),[Ne,Te]=a.useState(new Set),[Fe,Ie]=a.useState(new Set),[_e,Be]=a.useState({fromId:"root",toId:"root",key:0}),Le=a.useRef(F),qe=a.useRef("root"),et=a.useRef(0),Ge=a.useRef(null),Ee=a.useRef(null),xe=a.useRef([]);a.useEffect(()=>{Le.current=F},[F]);const G=a.useMemo(()=>{const $=new Set;return F.forEach(q=>{const je=Y.linksByFrom.get(q);je&&je.forEach(M=>$.add(M))}),$},[F,Y]),fe=Y.nodesById.get(_e.toId)??Y.nodesById.get("root"),oe=fe?`${fe.x/wa.width*100}%`:"50%",ye=fe?`${fe.y/wa.height*100}%`:"90%";a.useEffect(()=>{if(!n||s!==1||i)return;(()=>{we(new Set(["root"])),Te(new Set),Ie(new Set),Be({fromId:"root",toId:"root",key:0}),Ee.current=null,et.current=0,qe.current="root",xe.current=[]})();const q=()=>{const M=qe.current,K=Le.current,pe=(Y.childrenByFrom.get(M)??[]).filter(Me=>!K.has(Me));if(pe.length)return pe[Math.floor(Math.random()*pe.length)];if(K.size>=Y.nodes.length){const Me=Y.neighborsById.get(M)??[];return Me.length?Me[Math.floor(Math.random()*Me.length)]:null}const Q=Me=>(Y.childrenByFrom.get(Me)??[]).some(Ue=>!K.has(Ue)),Ce=[M],ke=new Set([M]),ze=new Map;let Re=null;for(;Ce.length;){const Me=Ce.shift();if(!Me)break;if(Me!==M&&Q(Me)){Re=Me;break}(Y.neighborsById.get(Me)??[]).forEach(Ue=>{ke.has(Ue)||(ke.add(Ue),ze.set(Ue,Me),Ce.push(Ue))})}if(!Re)return null;let Pe=Re;for(;ze.get(Pe)&&ze.get(Pe)!==M;)Pe=ze.get(Pe)??Pe;return Pe},je=(M,K)=>{if(M===K){const ue=q();ue&&je(M,ue);return}et.current+=1,Be({fromId:M,toId:K,key:et.current}),qe.current=K,Ge.current=window.setTimeout(()=>{const ue=Y.parentsById.get(K)??[],pe=Le.current,Q=ue.filter(Re=>!pe.has(Re));if(!Q.length){const Re=new Set(pe);Re.add(K),we(Re),Ge.current=window.setTimeout(()=>{for(;xe.current.length;){const Me=xe.current[xe.current.length-1];if(!Re.has(Me)){if(Me!==K){je(K,Me);return}break}xe.current.pop()}const Pe=q();Pe&&je(K,Pe)},xa.pauseMs);return}const Ce=new Set([K,...Q]),ke=new Set(Q.map(Re=>`${Re}-${K}`));Te(Ce),Ie(ke),xe.current.includes(K)||xe.current.push(K);const ze=Q[Math.floor(Math.random()*Q.length)];Ee.current={fromId:K,toId:ze},Ge.current=window.setTimeout(()=>{Te(new Set),Ie(new Set);const Re=Ee.current;Re&&je(Re.fromId,Re.toId)},xa.errorMs)},xa.moveMs)};return Ge.current=window.setTimeout(()=>{const M=q();M&&je(qe.current,M)},xa.pauseMs),()=>{Ge.current&&window.clearTimeout(Ge.current)}},[s,n,Y,i]);const Ke=$=>{if(!n)return;const q=Date.now();q-W.current<520||Math.abs($.deltaY)<10||(W.current=q,$.deltaY>0?o():g(),$.preventDefault())},Je=$=>{if(!n)return;const q=$.touches[0];q&&(k.current={x:q.clientX,y:q.clientY})},Ve=$=>{if(!n)return;const q=k.current;if(k.current=null,!q)return;const je=$.changedTouches[0];if(!je)return;const M=je.clientX-q.x,K=je.clientY-q.y;Math.abs(K)<40||Math.abs(K)<Math.abs(M)||(K<0?o():g())};return e.jsxs("div",{className:`cogita-intro ${n?"is-open":"is-closed"} ${i?"is-reduced":""} ${l?"is-final":""}`,"data-slide":s+1,onWheel:Ke,onTouchStart:Je,onTouchEnd:Ve,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":b,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${J&&!u?"is-entry":""}`,children:ae.map(($,q)=>e.jsx("img",{src:$.src,alt:"",className:`cogita-logo-layer ${q===0?"is-base":""} ${$.kind==="text"?"is-text":$.kind==="recreatio"?"is-recreatio":""} ${$.kind==="bubble"?"is-bubble":""}`},$.src))})}),n&&t.map(($,q)=>{const je=q===s;return e.jsxs("section",{className:`cogita-intro-slide slide-${q+1} ${je?"is-active":""}`,"aria-hidden":!je,children:[e.jsxs("div",{className:"cogita-intro-text",children:[$.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:$.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:$.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:$.title}),$.body&&e.jsx("p",{children:$.body.split(`
`).map((M,K)=>e.jsxs("span",{children:[M,K===0&&e.jsx("br",{})]},String(K)))})]}),$.micro&&e.jsx("p",{className:"cogita-intro-micro",children:$.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:l?N:o,children:$.cta}),l&&$.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>f(0),children:$.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[q===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${wa.width} ${wa.height}`,preserveAspectRatio:"none",children:[Y.links.map(M=>{const K=Y.nodesById.get(M.from),ue=Y.nodesById.get(M.to);if(!K||!ue)return null;const pe=G.has(M.key),Q=Fe.has(M.key);return e.jsx("line",{className:`map-link ${pe?"is-active":""} ${Q?"is-error":""}`,x1:K.x,y1:K.y,x2:ue.x,y2:ue.y},M.key)}),Y.nodes.map(M=>{const K=F.has(M.id),ue=Ne.has(M.id);return e.jsx("circle",{className:`map-node ${M.role?`is-${M.role}`:""} ${K?"is-active":""} ${ue?"is-error":""}`,cx:M.x,cy:M.y,r:M.r},M.id)})]}),fe&&e.jsx("span",{className:"map-explorer-dot",style:{left:oe,top:ye,"--move":`${xa.moveMs}ms`}})]}),q===2&&e.jsx("div",{className:"cogita-index-cards",children:R.map(M=>{const K=L.indexOf(M.id),ue=K>=0?X[K]:null,pe=(ue==null?void 0:ue.x)??"140px",Q=(ue==null?void 0:ue.y)??"140px",Ce=K>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":M.throw.x,"--throw-y":M.throw.y,"--throw-rot":M.throw.rot,"--grid-x":M.grid.x,"--grid-y":M.grid.y,"--stack-x":pe,"--stack-y":Q,"--stack-opacity":Ce,"--delay":M.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},M.id)})}),q===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[se.map((M,K)=>e.jsxs("div",{className:`round-card ${K===he?"is-active":""}`,style:{"--card-x":M.x,"--card-y":M.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},M.id)),se[he]&&e.jsx("span",{className:"round-ring",style:{"--card-x":se[he].x,"--card-y":`calc(${se[he].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:ie.map(M=>e.jsx("span",{className:"player-dot",style:{left:M.x,top:M.y,"--jitter-x":M.jitterX,"--jitter-y":M.jitterY,"--breath-delay":M.delay}},M.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:me.map(M=>e.jsx("line",{className:"round-link",x1:M.from.xNum,y1:M.from.yNum,x2:M.to.xNum,y2:M.to.yNum,style:{"--delay":M.delay}},M.id))}),e.jsx("div",{className:"round-flows",children:ie.map((M,K)=>{const ue=be[K]??"good",pe=se[he];if(!pe)return null;const Q=`calc(${pe.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":M.x,"--from-y":M.y,"--to-x":pe.x,"--to-y":Q,"--delay":`${K*.12}s`}}),e.jsx("span",{className:`return-dot is-${ue}`,style:{"--from-x":pe.x,"--from-y":Q,"--to-x":M.x,"--to-y":M.y,"--delay":`${K*.12}s`}}),e.jsx("span",{className:`result-pop is-${ue}`,style:{"--at-x":M.x,"--at-y":M.y,"--delay":`${K*.12}s`}})]},`${M.id}-${re}`)})})]},`round-${re}`),q===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${m[0].x} ${m[0].y} L${m[1].x} ${m[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${m[1].x} ${m[1].y} L${m[2].x} ${m[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${m[2].x} ${m[2].y} L${m[3].x} ${m[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${m[3].x} ${m[3].y} L${m[4].x} ${m[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${m[4].x} ${m[4].y} L${m[5].x} ${m[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${m[5].x} ${m[5].y} L${m[6].x} ${m[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${P};${P};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${ce.upper.map((M,K)=>`${K===0?"M":"L"}${M.x} ${M.y}`).join(" ")} ${ce.lower.slice().reverse().map(M=>`L${M.x} ${M.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${ce.upper.map((M,K)=>`${K===0?"M":"L"}${M.x} ${M.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${ce.lower.map((M,K)=>`${K===0?"M":"L"}${M.x} ${M.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[p.higher.slice(0,6).map((M,K)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${K+1}`,d:`M${M.x} ${M.y} L${p.higher[K+1].x} ${p.higher[K+1].y}`,pathLength:"100"},`peer-1-${K}`)),p.lower.slice(0,6).map((M,K)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${K+1}`,d:`M${M.x} ${M.y} L${p.lower[K+1].x} ${p.lower[K+1].y}`,pathLength:"100"},`peer-2-${K}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${m[0].x/300*100}%`,"--p0y":`${m[0].y/200*100}%`,"--p1x":`${m[1].x/300*100}%`,"--p1y":`${m[1].y/200*100}%`,"--p2x":`${m[2].x/300*100}%`,"--p2y":`${m[2].y/200*100}%`,"--p3x":`${m[3].x/300*100}%`,"--p3y":`${m[3].y/200*100}%`,"--p4x":`${m[4].x/300*100}%`,"--p4y":`${m[4].y/200*100}%`,"--p5x":`${m[5].x/300*100}%`,"--p5y":`${m[5].y/200*100}%`,"--p6x":`${m[6].x/300*100}%`,"--p6y":`${m[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${p.higher[0].x/300*100}%`,"--q0y":`${p.higher[0].y/200*100}%`,"--q1x":`${p.higher[1].x/300*100}%`,"--q1y":`${p.higher[1].y/200*100}%`,"--q2x":`${p.higher[2].x/300*100}%`,"--q2y":`${p.higher[2].y/200*100}%`,"--q3x":`${p.higher[3].x/300*100}%`,"--q3y":`${p.higher[3].y/200*100}%`,"--q4x":`${p.higher[4].x/300*100}%`,"--q4y":`${p.higher[4].y/200*100}%`,"--q5x":`${p.higher[5].x/300*100}%`,"--q5y":`${p.higher[5].y/200*100}%`,"--q6x":`${p.higher[6].x/300*100}%`,"--q6y":`${p.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${p.lower[0].x/300*100}%`,"--q0y":`${p.lower[0].y/200*100}%`,"--q1x":`${p.lower[1].x/300*100}%`,"--q1y":`${p.lower[1].y/200*100}%`,"--q2x":`${p.lower[2].x/300*100}%`,"--q2y":`${p.lower[2].y/200*100}%`,"--q3x":`${p.lower[3].x/300*100}%`,"--q3y":`${p.lower[3].y/200*100}%`,"--q4x":`${p.lower[4].x/300*100}%`,"--q4y":`${p.lower[4].y/200*100}%`,"--q5x":`${p.lower[5].x/300*100}%`,"--q5y":`${p.lower[5].y/200*100}%`,"--q6x":`${p.lower[6].x/300*100}%`,"--q6y":`${p.lower[6].y/200*100}%`}})]})})}),q===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),q===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},$.id)}),!n&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:c.title}),c.body&&e.jsx("p",{children:c.body}),c.micro&&e.jsx("p",{className:"cogita-intro-micro",children:c.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:N,children:c.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:A,children:"Otwórz pokaz"})]})]})})]}),n&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map(($,q)=>e.jsx("button",{type:"button",className:`dot ${s===q?"active":""}`,"aria-label":$.title,onClick:()=>f(q)},$.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:x,children:"Pomiń"})]})]})}const ti=6,ai=4;function si({copy:t,onAuthAction:s,authLabel:n,showProfileMenu:i,onProfileNavigate:o,onToggleSecureMode:g,onLogout:f,secureMode:x,onNavigate:A,language:N,onLanguageChange:l}){const b=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}A("home")},c=a.useRef(null),u=a.useRef([]),S=a.useMemo(()=>{let y=Date.now()%2147483647;const V=()=>(y=y*48271%2147483647,y/2147483647);return Array.from({length:ti},(me,Y)=>{const F=6+V()*8,we=7+V()*10,Ne=6+V()*9,Te=-V()*F,Fe=-V()*we,Ie=-V()*Ne,_e=.18+V()*.28,Be=12+V()*18,Le=4+V()*8,qe=(V()-.5)*3.2,et=(V()-.5)*3.8,Ge=V()>.5?"alternate":"alternate-reverse",Ee=V()>.5?"alternate":"alternate-reverse",xe=V()>.5?"alternate":"alternate-reverse",G=.18+V()*.42,fe=30+V()*60,oe=-45-V()*38,ye=188+V()*32,Ke=.1+V()*.2;return{id:`wave-${Y+1}`,style:{"--wave-sway-duration":`${F}s`,"--wave-scale-duration":`${we}s`,"--wave-drift-duration":`${Ne}s`,"--wave-sway-delay":`${Te}s`,"--wave-scale-delay":`${Fe}s`,"--wave-drift-delay":`${Ie}s`,"--wave-sway-dir":Ge,"--wave-scale-dir":Ee,"--wave-drift-dir":xe,"--wave-scale":`${_e}`,"--wave-shift":`${Be}%`,"--wave-xshift":`${Le}%`,"--wave-x0":`${qe}%`,"--wave-y0":`${et}%`,"--wave-opacity":`${G}`,"--wave-blur":`${fe}px`,"--wave-bottom":`${oe}%`,"--wave-hue":`${ye}`,"--wave-glow":`${Ke}`}}})},[]),ae=a.useMemo(()=>{let y=Date.now()*3%2147483647;const V=()=>(y=y*48271%2147483647,y/2147483647);return Array.from({length:ai},(me,Y)=>{const F=180+V()*220,we=220+V()*280,Ne=-V()*F,Te=-V()*we,Fe=.12+V()*.22,Ie=3+V()*7,_e=1+V()*3,Be=(V()-.5)*2.8,Le=(V()-.5)*2.2;return{id:`mesh-${Y+1}`,seed:1e3+Y*991+Math.floor(V()*999),style:{"--mesh-sway-duration":`${F}s`,"--mesh-drift-duration":`${we}s`,"--mesh-sway-delay":`${Ne}s`,"--mesh-drift-delay":`${Te}s`,"--mesh-scale":`${Fe}`,"--mesh-shift":`${Ie}%`,"--mesh-xshift":`${_e}%`,"--mesh-x0":`${Le}%`,"--mesh-y0":`${Be}%`}}})},[]),J=a.useMemo(()=>{const y=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],V=t.cogita.introSlides,me=new Map(V.map(Y=>[Y.id,Y]));return y.map(Y=>{var we;const F=me.get(Y.id);return{...Y,...F,title:(F==null?void 0:F.title)??"Cogita",cta:(F==null?void 0:F.cta)??((we=t.cogita.introSlides[0])==null?void 0:we.cta)??t.cogita.loginCta,secondary:F==null?void 0:F.secondary}})},[t.cogita.introSlides]),[W,k]=a.useState(0),[m,ce]=a.useState(!0),[P,p]=a.useState(!1),H=J.length-1,R=a.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),X=a.useCallback(()=>{R(),s()},[R,s]),L=a.useCallback(()=>{ce(!0),k(0)},[]),E=a.useCallback(()=>{ce(!1),k(H)},[H]),se=a.useCallback(y=>{k(Math.max(0,Math.min(H,y)))},[H]),ie=a.useCallback(()=>{W>=H?X():se(W+1)},[W,se,X,H]),re=a.useCallback(()=>{se(W-1)},[W,se]);a.useEffect(()=>{var me;const y=(me=window.matchMedia)==null?void 0:me.call(window,"(prefers-reduced-motion: reduce)");if(!y)return;const V=()=>p(y.matches);return V(),y.addEventListener?(y.addEventListener("change",V),()=>y.removeEventListener("change",V)):(y.addListener(V),()=>y.removeListener(V))},[]),a.useEffect(()=>{if(!m)return;const y=V=>{const me=V.target;if(!me)return;const Y=me.tagName;if(!(me.isContentEditable||Y==="INPUT"||Y==="TEXTAREA"||Y==="SELECT"||Y==="BUTTON"||Y==="A"||me.closest('button, a, [role="button"], [role="link"]'))){if(V.key==="Escape"){E();return}if(V.key==="ArrowLeft"||V.key==="ArrowUp"){re();return}(V.key==="ArrowRight"||V.key==="ArrowDown"||V.code==="Space"||V.key===" ")&&(V.preventDefault(),ie())}};return window.addEventListener("keydown",y),()=>window.removeEventListener("keydown",y)},[E,ie,re,m]),a.useEffect(()=>{m&&W===H&&R()},[W,m,H,R]),a.useEffect(()=>{const y=c.current;if(!y)return;const V=u.current.filter(oe=>!!oe);if(!V.length)return;const me=1,Y=.6,F=.6,we=Math.max(1,Math.min(me,window.devicePixelRatio||1));let Ne=0,Te=0,Fe=Y,Ie=0,_e=0;const Be=oe=>{let ye=oe%2147483647;return ye<=0&&(ye+=2147483646),(Ke,Je)=>{ye=ye*48271%2147483647;const Ve=ye/2147483647;return Ke+Ve*(Je-Ke)}},Le={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},qe=oe=>{const ye=Math.sin(oe*12.9898)*43758.5453;return ye-Math.floor(ye)},et=oe=>{const ye=qe(oe+.1)||1e-4,Ke=qe(oe+.7)||1e-4;return Math.sqrt(-2*Math.log(ye))*Math.cos(2*Math.PI*Ke)},Ge=(oe,ye)=>{const Ke=Math.floor(oe),Je=Ke+1,Ve=oe-Ke,$=Ve*Ve*(3-2*Ve),q=qe(Ke*12.9898+ye*78.233),je=qe(Je*12.9898+ye*78.233);return q+(je-q)*$},Ee=oe=>{const ye=Be(oe),Ke=Math.min(4,Math.max(4,Math.floor(Ne/1200*Le.filamentCount)));return Array.from({length:Ke},(Je,Ve)=>{const $=Math.max(-1,Math.min(1,et(oe+Ve*.37))),q=Math.min(1,Math.max(0,qe(oe+Ve*1.31))),je=Math.min(Le.depthLayers-1,Math.floor(q*Le.depthLayers));return{seed:ye(0,Math.PI*2)+oe*.01,offset:$,freqA:Le.freq1*(.75+ye(0,.5)),freqB:Le.freq2*(.75+ye(0,.5)),ampA:Le.amp1*(.6+ye(0,.7)),ampB:Le.amp2*(.6+ye(0,.7)),width:2+Ve%5*.32,depth:q,layer:je}})},xe=(oe,ye,Ke)=>{const Je=Math.max(30,Math.floor(Ne*Te/14e4));oe.save(),oe.globalAlpha=.6;for(let Ve=0;Ve<Je;Ve+=1){const $=qe(Ve*9.1+Ne*.11)*ye+Ke,q=qe(Ve*3.7+Te*.23)*Te,je=1.2+qe(Ve*5.9)*2.4,M=oe.createRadialGradient($,q,0,$,q,je*2);M.addColorStop(0,"rgba(10, 30, 60, 0.45)"),M.addColorStop(1,"rgba(10, 30, 60, 0)"),oe.fillStyle=M,oe.beginPath(),oe.arc($,q,je*2,0,Math.PI*2),oe.fill()}oe.restore()},G=(oe,ye)=>{oe.clearRect(0,0,Ne,Te);const Ke=Te*Le.waveCenter,Je=Le.waveBandPx,Ve=Le.segments,$=Le.colors.filaments,q=Ie||Ne,je=0;xe(oe,q,je),oe.strokeStyle=$,oe.lineCap="round",oe.lineJoin="round";for(let M=0;M<ye.length;M+=1){const K=ye[M],ue=K.offset*Je*(.85+qe(K.seed)*.4),pe=1-Math.min(1,Math.abs(ue)/Je),Q=Math.exp(-Math.pow(ue/Le.crestThickness,2)),Ce=K.layer===0?1.1:K.layer===1?.85:.6,ke=.35+(1-K.depth)*.65,ze=pe*ke*Ce*(.34+Q*.45);oe.globalAlpha=ze,oe.lineWidth=K.width*(1+(1-K.depth)*.8);const Re=[];for(let Me=0;Me<=Ve;Me+=1){const ct=Me/Ve*q+je,Ue=(Ge(ct*.012,K.seed)-.5)*Le.xJitter,Xe=ct+Ue,lt=(Ge(Xe*K.freqA,K.seed)-.5)*Le.jitterA,yt=(Ge(Xe*K.freqB,K.seed*1.7)-.5)*Le.jitterB,We=Ke+Math.sin(Xe*K.freqA+K.seed)*K.ampA+Math.sin(Xe*K.freqB+K.seed*1.3)*K.ampB+ue+lt+yt;Re.push({x:Xe,y:We})}oe.beginPath(),oe.moveTo(Re[0].x,Re[0].y);for(let Me=1;Me<Re.length-1;Me+=1){const ct=(Re[Me].x+Re[Me+1].x)/2,Ue=(Re[Me].y+Re[Me+1].y)/2;oe.quadraticCurveTo(Re[Me].x,Re[Me].y,ct,Ue)}const Pe=Re[Re.length-1];oe.quadraticCurveTo(Pe.x,Pe.y,Pe.x,Pe.y),oe.stroke()}oe.save(),oe.globalCompositeOperation="lighter",oe.strokeStyle=Le.colors.glow,oe.lineCap="round",oe.lineJoin="round";for(let M=0;M<ye.length;M+=1){const K=ye[M];if(Math.abs(K.offset)*Je>Le.crestThickness)continue;const ue=Le.glowAlpha*(.7+(1-K.depth)*.6);oe.globalAlpha=ue,oe.lineWidth=1.6+(1-K.depth)*1.2;const pe=[];for(let Ce=0;Ce<=Ve;Ce+=1){const ke=Ce/Ve*q+je,ze=Math.sin(ke*.02+K.seed)*3,Re=Ke+Math.sin(ke*K.freqA+K.seed)*K.ampA+Math.sin(ke*K.freqB+K.seed*1.3)*K.ampB+K.offset*Je*.35+ze;pe.push({x:ke,y:Re})}oe.beginPath(),oe.moveTo(pe[0].x,pe[0].y);for(let Ce=1;Ce<pe.length-1;Ce+=1){const ke=(pe[Ce].x+pe[Ce+1].x)/2,ze=(pe[Ce].y+pe[Ce+1].y)/2;oe.quadraticCurveTo(pe[Ce].x,pe[Ce].y,ke,ze)}const Q=pe[pe.length-1];oe.quadraticCurveTo(Q.x,Q.y,Q.x,Q.y),oe.stroke()}oe.restore()},fe=()=>{Ne=Math.floor(y.clientWidth),Te=Math.floor(y.clientHeight),Ie=Math.floor(Ne*1.8),_e=Te,Fe=Ne<820?F:Y,V.forEach(oe=>{const ye=oe.getContext("2d");if(!ye)return;oe.width=Math.floor(Ie*we*Fe),oe.height=Math.floor(_e*we*Fe),oe.style.width=`${Ie}px`,oe.style.height=`${_e}px`,oe.style.left=`${-(Ie-Ne)/2}px`,ye.setTransform(we*Fe,0,0,we*Fe,0,0);const Ke=Number(oe.dataset.seed||1),Je=Ee(Ke);G(ye,Je)})};return fe(),window.addEventListener("resize",fe,{passive:!0}),()=>window.removeEventListener("resize",fe)},[ae]);const De=J[Math.min(W,J.length-1)],he=m?De:J[J.length-1],T=(he==null?void 0:he.theme)??J[0].theme,be={"--cogita-bg0":T.bg0,"--cogita-bg1":T.bg1,"--cogita-bg2":T.bg2,"--cogita-bloom":T.bloom,"--cogita-sat":T.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:b,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Hs,{value:N,onChange:l}),e.jsx(Qs,{copy:t,label:n,isAuthenticated:i,secureMode:x,onLogin:s,onProfileNavigate:o,onToggleSecureMode:g,onLogout:f,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:c,className:"cogita-section cogita-home",style:be,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[ae.map((y,V)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:y.style,"data-seed":y.seed,ref:me=>{u.current[V]=me}},y.id)),S.map(y=>e.jsx("div",{className:"cogita-home-wave",style:y.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},y.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(ei,{slides:J,activeIndex:W,introOpen:m,prefersReducedMotion:P,onNext:ie,onPrev:re,onSelect:se,onExit:E,onOpen:L,onRegister:X})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const lr=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:si},Symbol.toStringTag,{value:"Module"})),nn=a.createContext(!1);function Tt({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,headerExtra:l,children:b}){if(a.useContext(nn))return e.jsx(e.Fragment,{children:b});const u=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}x("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:u,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Hs,{value:A,onChange:N}),e.jsxs("div",{className:"cogita-header-right",children:[l,e.jsx(Qs,{copy:t,label:s,isAuthenticated:n,secureMode:f,onLogin:()=>x("home"),onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:b}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function Wt(t){const[s,n]=a.useState("Cogita library"),[i,o]=a.useState(null);return a.useEffect(()=>{let g=!1;return Ys().then(f=>{if(g)return;const x=f.find(A=>A.libraryId===t);x&&n(x.name)}).catch(()=>{g||n("Cogita library")}),()=>{g=!0}},[t]),a.useEffect(()=>{let g=!1;return xn(t).then(f=>{g||o(f)}).catch(()=>{g||o(null)}),()=>{g=!0}},[t]),{libraryName:s,stats:i}}function Ms({slices:t}){const s=t.reduce((i,o)=>i+Math.max(0,o.value),0),n=a.useMemo(()=>{if(s<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let i=0;return`conic-gradient(${t.map(g=>{const x=Math.max(0,g.value)/s*360,A=i,N=i+x;return i=N,`${g.color} ${A}deg ${N}deg`}).join(",")})`},[t,s]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:n}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(i=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:i.color}}),e.jsx("strong",{children:i.value}),e.jsx("small",{children:i.label})]},i.label))})]})}function ni({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,libraryId:l}){const{libraryName:b,stats:c}=Wt(l),[u,S]=a.useState("infos"),[ae,J]=a.useState(0),[W,k]=a.useState(0),[m,ce]=a.useState(0),P=(c==null?void 0:c.totalInfos)??0,p=(c==null?void 0:c.totalCollections)??0,H=0,R=0,X=0,L=Math.max(0,P-X-W),E=Math.max(0,P-W-m);a.useEffect(()=>{let ie=!1;return(async()=>{try{const De=await ja({libraryId:l,limit:200}),he=await Promise.all(De.items.map(T=>Gs({libraryId:l,collectionId:T.collectionId}).catch(()=>[])));if(ie)return;J(he.reduce((T,be)=>T+be.length,0))}catch{ie||J(0)}})(),()=>{ie=!0}},[l]),a.useEffect(()=>{let ie=!1;return(async()=>{try{const[De,he,T]=await Promise.all([Ns({libraryId:l,type:"computed",limit:1}).catch(()=>({total:0})),Ns({libraryId:l,type:"source",limit:1}).catch(()=>({total:0})),fs({libraryId:l}).catch(()=>({items:[]}))]);if(ie)return;k((De.total??0)+(he.total??0));const be=new Set(T.items.filter(y=>y.childItemType.toLowerCase()==="info").map(y=>y.childItemId).filter(Boolean));ce(be.size)}catch{ie||(k(0),ce(0))}})(),()=>{ie=!0}},[l]);const se=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:P},{key:"collections",label:t.cogita.library.overview.stats.collections,value:p},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:ae},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:H},{key:"texts",label:t.cogita.library.overview.stats.texts,value:R}];return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:b})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:se.map(ie=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${u===ie.key?"active":""}`,onClick:()=>S(ie.key),children:[e.jsx("span",{children:ie.label}),e.jsx("strong",{children:ie.value})]},ie.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),u==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(Ms,{slices:[{label:t.cogita.library.overview.known,value:X,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:L,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:W,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(Ms,{slices:[{label:t.cogita.library.overview.availableChecks,value:m,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:E,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const Ye=(t,s)=>{const n=t.cogita.library.infoTypes,i=t.cogita.library.connectionTypes,o=t.cogita.library.groupTypes;return{any:n.any,vocab:n.vocab,book:o.book,citation:o.citation,language:n.language,word:n.word,sentence:n.sentence,topic:n.topic,collection:n.collection,person:n.person,institution:n.institution,collective:n.collective,orcid:n.orcid,address:n.address,email:n.email,phone:n.phone,media:n.media,work:n.work,geo:n.geo,music_piece:n.musicPiece,music_fragment:n.musicFragment,source:n.source,computed:n.computed,"word-language":i.wordLanguage,"quote-language":i.quoteLanguage,"language-sentence":i.languageSentence,translation:i.translation,"word-topic":i.wordTopic,reference:i.reference,"source-resource":i.sourceResource,"work-contributor":i.workContributor,"work-medium":i.workMedium,"orcid-link":i.orcidLink}[s]??String(s)},ii=t=>[{value:"any",label:Ye(t,"any")},{value:"language",label:Ye(t,"language")},{value:"word",label:Ye(t,"word")},{value:"sentence",label:Ye(t,"sentence")},{value:"topic",label:Ye(t,"topic")},{value:"collection",label:Ye(t,"collection")},{value:"person",label:Ye(t,"person")},{value:"institution",label:Ye(t,"institution")},{value:"collective",label:Ye(t,"collective")},{value:"orcid",label:Ye(t,"orcid")},{value:"address",label:Ye(t,"address")},{value:"email",label:Ye(t,"email")},{value:"phone",label:Ye(t,"phone")},{value:"media",label:Ye(t,"media")},{value:"work",label:Ye(t,"work")},{value:"geo",label:Ye(t,"geo")},{value:"music_piece",label:Ye(t,"music_piece")},{value:"music_fragment",label:Ye(t,"music_fragment")},{value:"source",label:Ye(t,"source")},{value:"citation",label:Ye(t,"citation")},{value:"computed",label:Ye(t,"computed")},{value:"vocab",label:Ye(t,"vocab")},{value:"book",label:Ye(t,"book")},{value:"word-language",label:Ye(t,"word-language")},{value:"quote-language",label:Ye(t,"quote-language")},{value:"language-sentence",label:Ye(t,"language-sentence")},{value:"translation",label:Ye(t,"translation")},{value:"word-topic",label:Ye(t,"word-topic")},{value:"reference",label:Ye(t,"reference")},{value:"source-resource",label:Ye(t,"source-resource")},{value:"work-contributor",label:Ye(t,"work-contributor")},{value:"work-medium",label:Ye(t,"work-medium")},{value:"orcid-link",label:Ye(t,"orcid-link")}],ri=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Za={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},oi={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code","notes"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","notes","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Za]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","notes","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Za]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name","notes"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid","notes"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country","notes"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address","notes"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number","notes"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind","notes"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId","notes"]},filterFields:[Za,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city","notes"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer","notes"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text","notes"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator","notes"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text","notes"],connections:[{relationType:"quote-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"quote",kind:"text",path:"text",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition","notes"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},Is={infoType:"default",entityKind:"single",structure:{payloadFields:["label","notes"]},filterFields:[]};function ci(t){return t?oi[t]??Is:Is}function li(t,s){return t.optionsSource==="languages"?s.languages.map(n=>({value:n.infoId,label:n.label})):t.optionsSource==="sourceKinds"?ri:[]}const es=60,di=500;function rn(t){return`cogita.info-selection:${t}`}function Ls(t){if(typeof window>"u")return{};const s=window.localStorage.getItem(rn(t));if(!s)return{};try{const n=JSON.parse(s);return!n||typeof n!="object"?{}:n}catch{return{}}}function ui({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,libraryId:l,mode:b}){var wt;const c=Os(),u=Va(),S=t.cogita.library.list,[ae,J]=a.useState("any"),[W,k]=a.useState(""),[m,ce]=a.useState("relevance"),[P,p]=a.useState("details"),[H,R]=a.useState(!1),[X,L]=a.useState("idle"),[E,se]=a.useState([]),[ie,re]=a.useState(es),[De,he]=a.useState(null),[T,be]=a.useState(()=>Ls(l)),[y,V]=a.useState({}),[me,Y]=a.useState([]),[F,we]=a.useState(null),[Ne,Te]=a.useState(null),[Fe,Ie]=a.useState(null),[_e,Be]=a.useState("idle"),[Le,qe]=a.useState([]),[et,Ge]=a.useState(""),[Ee,xe]=a.useState(null),[G,fe]=a.useState("idle"),[oe,ye]=a.useState(null),[Ke,Je]=a.useState(null),[Ve,$]=a.useState("idle"),q=a.useMemo(()=>ii(t),[t]),je=a.useMemo(()=>[{value:"relevance",label:S.sortRelevance},{value:"label_asc",label:S.sortLabelAsc},{value:"label_desc",label:S.sortLabelDesc},{value:"type_asc",label:S.sortTypeAsc},{value:"type_desc",label:S.sortTypeDesc}],[S.sortLabelAsc,S.sortLabelDesc,S.sortRelevance,S.sortTypeAsc,S.sortTypeDesc]);a.useEffect(()=>{be(Ls(l)),V({}),R(!1)},[l]),a.useEffect(()=>{fs({libraryId:l}).then(_=>Ie(_)).catch(()=>Ie({items:[]}))},[l]),a.useEffect(()=>{vn({libraryId:l}).then(_=>qe(_)).catch(()=>qe([]))},[l]),a.useEffect(()=>{Ss({libraryId:l,type:"language",filters:{sourceKind:"info"},limit:200}).then(_=>{const te=_.map(Se=>({infoId:Se.infoId??"",infoType:Se.entityType,label:Se.title})).filter(Se=>Se.infoId.length>0);Y(te)}).catch(()=>Y([]))},[l]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(rn(l),JSON.stringify(T))},[l,T]);const M=a.useMemo(()=>ci(ae==="any"?null:ae),[ae]),K=a.useMemo(()=>new URLSearchParams(u.search),[u.search]),ue=a.useMemo(()=>u.pathname.split("/").filter(Boolean),[u.pathname]),pe=ue.findIndex(_=>_==="infos"),Q=pe>=0&&(ue[pe+1]??"").trim()||null,Ce=pe>=0?(ue[pe+2]??"").trim()==="checkcards"?"cards":"overview":"",ke=Q??((K.get("infoId")??"").trim()||null),ze=Q?Ce:(K.get("infoView")??"overview").trim(),Re=ze==="overview"&&!!ke,Pe=a.useMemo(()=>({language:S.typeFilterLanguage,languageA:S.typeFilterLanguageA,languageB:S.typeFilterLanguageB,originalLanguage:S.typeFilterOriginalLanguage,doi:S.typeFilterDoi,sourceKind:S.typeFilterSourceKind,locator:S.typeFilterLocator,quote:S.typeFilterQuote}),[S.typeFilterDoi,S.typeFilterLanguage,S.typeFilterLanguageA,S.typeFilterLanguageB,S.typeFilterLocator,S.typeFilterOriginalLanguage,S.typeFilterQuote,S.typeFilterSourceKind]),Me=a.useMemo(()=>M.filterFields.map(_=>({..._,label:_.labelKey?Pe[_.labelKey]:_.label??_.key,options:li(_,{languages:me})})),[Pe,me,M.filterFields]),ct=a.useMemo(()=>Me.some(_=>(y[_.key]??"").trim().length>0),[Me,y]);a.useEffect(()=>{V({})},[ae]),a.useEffect(()=>{const _={sourceKind:"info"};if(ct)for(const Se of Me){const d=(y[Se.key]??"").trim();d&&(_[Se.path??Se.key]=d)}L("loading");const te=window.setTimeout(()=>{Ss({libraryId:l,type:ae==="any"?void 0:ae,query:W.trim()||void 0,filters:_,limit:di}).then(Se=>{const d=Se.map(ve=>({infoId:ve.infoId??"",infoType:ve.entityType,label:ve.title})).filter(ve=>ve.infoId.length>0);se(d),L("ready")}).catch(()=>{se([]),L("ready")})},240);return()=>window.clearTimeout(te)},[ct,l,W,ae,Me,y]),a.useEffect(()=>{if(!ke||ze!=="overview"){we(null),Te(null),Be("idle");return}let _=!1;return Be("loading"),Promise.all([Gt({libraryId:l,infoId:ke}),wn({libraryId:l,itemType:"info",itemId:ke}).catch(()=>null)]).then(([te,Se])=>{_||(we(te),Te(Se),Be("ready"))}).catch(()=>{_||(we(null),Te(null),Be("error"))}),()=>{_=!0}},[l,ke,ze]),a.useEffect(()=>{if(!ke||ze!=="overview"){ye(null),Je(null),$("idle");return}let _=!1;return $("loading"),Promise.all([Js({libraryId:l,infoId:ke}),Xs({libraryId:l,infoId:ke})]).then(([te,Se])=>{_||(ye(te),Je(Se),$("ready"))}).catch(()=>{_||(ye(null),Je(null),$("error"))}),()=>{_=!0}},[l,ke,ze]);const Ue=a.useMemo(()=>F?Le.filter(_=>_.sourceInfoTypes.some(te=>te.toLowerCase()===F.infoType.toLowerCase())):[],[Le,F]);a.useEffect(()=>{if(!F){Ge("");return}Ge(_=>{var te;return _&&Ue.some(Se=>Se.approachKey===_)?_:((te=Ue[0])==null?void 0:te.approachKey)??""})},[Ue,F]),a.useEffect(()=>{if(!F||!et){xe(null),fe("idle");return}let _=!1;return fe("loading"),Zs({libraryId:l,infoId:F.infoId,approachKey:et}).then(te=>{_||(xe(te),fe("ready"))}).catch(()=>{_||(xe(null),fe("error"))}),()=>{_=!0}},[l,et,F]);const Xe=a.useMemo(()=>{const _=E.slice(),te=Se=>Ye(t,Se);return m==="relevance"?_:m==="label_asc"?_.sort((Se,d)=>Se.label.localeCompare(d.label)):m==="label_desc"?_.sort((Se,d)=>d.label.localeCompare(Se.label)):m==="type_asc"?_.sort((Se,d)=>Se.infoType===d.infoType?Se.label.localeCompare(d.label):te(Se.infoType).localeCompare(te(d.infoType))):_.sort((Se,d)=>Se.infoType===d.infoType?Se.label.localeCompare(d.label):te(d.infoType).localeCompare(te(Se.infoType)))},[t,E,m]),lt=a.useMemo(()=>Xe.slice(0,ie),[Xe,ie]),yt=lt.length<Xe.length,We=a.useMemo(()=>new Set(Object.keys(T)),[T]),He=a.useMemo(()=>Object.values(T),[T]),Ct=a.useMemo(()=>{const _=new Map;for(const te of He)_.set(te.infoType,(_.get(te.infoType)??0)+1);return Array.from(_.entries()).sort((te,Se)=>Se[1]-te[1]||te[0].localeCompare(Se[0]))},[He]),dt=a.useMemo(()=>{if(!ke||!Fe)return 0;const _=new Set;for(const te of Fe.items)te.childItemType!=="info"||te.childItemId!==ke||_.add([te.parentItemType,te.parentItemId,te.parentCheckType??"",te.parentDirection??""].join("|"));return _.size},[Fe,ke]);a.useEffect(()=>{re(es);const _=new Set(E.map(te=>te.infoId));he(te=>te&&_.has(te)?te:null)},[E]);const Lt=_=>{be(te=>({...te,[_.infoId]:{infoId:_.infoId,infoType:_.infoType,label:_.label}}))},ot=_=>{be(te=>{if(!te[_])return te;const Se={...te};return delete Se[_],Se})},it=(_,te)=>{if(te){Lt(_);return}ot(_.infoId)},$t=_=>{c(`/cogita/library/${l}/infos/${encodeURIComponent(_)}`,{replace:!0})},xt=()=>{c(`/cogita/library/${l}/list`,{replace:!0})},tt=()=>{ke&&c(`/cogita/library/${l}/edit/${encodeURIComponent(ke)}`,{replace:!0})},at=He.length===1?((wt=He[0])==null?void 0:wt.infoId)??null:null,Et=S.selectionCount.replace("{count}",String(He.length)),Rt=b==="collection"?"grid":b==="detail"?"wide":P,Ze=mi(A),gt=Ne?Math.max(0,Math.min(100,Math.round((Ne.score??0)*100))):0,pt=Ne?pi(Ne,Ze):Ze.noKnownnessData;return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":Rt,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[Re?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:Ze.kicker}),e.jsx("h2",{className:"cogita-card-title",children:F?hi(F.payload,F.infoType,F.infoId):Ze.loading}),F?e.jsxs("p",{className:"cogita-card-subtitle",children:[Ye(t,F.infoType)," · ",F.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:xt,children:Ze.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:tt,disabled:!ke||_e!=="ready",children:S.editInfo})]})]}),_e==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:Ze.loading})}):_e==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:Ze.loadError})}):F?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Ze.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[gt,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${gt}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:pt})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Ze.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(Ne==null?void 0:Ne.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:Ze.correct.replace("{correct}",String((Ne==null?void 0:Ne.correctReviews)??0)).replace("{total}",String((Ne==null?void 0:Ne.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:Ne!=null&&Ne.lastReviewedUtc?`${Ze.lastReview}: ${gi(Ne.lastReviewedUtc,A)}`:Ze.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Ze.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:dt}),e.jsx("p",{className:"cogita-library-hint",children:Ze.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Ze.checkcards}),Ve==="loading"?e.jsx("p",{className:"cogita-library-hint",children:Ze.loadingCheckcards}):Ve==="error"?e.jsx("p",{className:"cogita-library-hint",children:Ze.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:Ze.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(oe==null?void 0:oe.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:Ze.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(Ke==null?void 0:Ke.items.length)??0})]})]})]}),Ue.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:Ze.approach}),e.jsx("select",{value:et,onChange:_=>Ge(_.target.value),"aria-label":Ze.approach,children:Ue.map(_=>e.jsx("option",{value:_.approachKey,children:_.label},_.approachKey))})]}),G==="loading"?e.jsx("p",{className:"cogita-library-hint",children:Ze.loadingApproach}):G==="error"?e.jsx("p",{className:"cogita-library-hint",children:Ze.loadApproachError}):Ee?e.jsx(Ea,{value:Ee.projection,emptyLabel:Ze.empty}):e.jsx("p",{className:"cogita-library-hint",children:Ze.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Ze.payload}),e.jsx(Ea,{value:F.payload,emptyLabel:Ze.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Ze.links}),e.jsx(fi,{links:F.links,emptyLabel:Ze.noLinks})]})]})]}):null]})}):null,Re?null:e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":S.typeLabel,value:ae,onChange:_=>J(_.target.value),children:q.map(_=>e.jsx("option",{value:_.value,children:_.label},_.value))}),e.jsx("input",{type:"text",value:W,onChange:_=>k(_.target.value),placeholder:S.searchPlaceholder}),e.jsx("select",{"aria-label":S.sortLabel,value:m,onChange:_=>ce(_.target.value),children:je.map(_=>e.jsx("option",{value:_.value,children:_.label},_.value))}),e.jsxs("select",{"aria-label":S.viewLabel,value:P,onChange:_=>p(_.target.value),children:[e.jsx("option",{value:"details",children:S.viewDetails}),e.jsx("option",{value:"wide",children:S.viewWide}),e.jsx("option",{value:"grid",children:S.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:S.cardCount.replace("{shown}",String(lt.length)).replace("{total}",String(Xe.length))}),e.jsx("span",{children:X==="loading"?S.loading:S.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>R(_=>!_),children:H?S.hideFilters:S.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:S.filtersOptionalHint})]}),H&&Me.length>0?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsx("div",{className:"cogita-filter-grid",children:Me.map(_=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:_.label}),_.kind==="select"?e.jsxs("select",{value:y[_.key]??"",onChange:te=>V(Se=>({...Se,[_.key]:te.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(_.options??[]).map(te=>e.jsx("option",{value:te.value,children:te.label},`${_.key}:${te.value}`))]}):e.jsx("input",{type:"text",value:y[_.key]??"",onChange:te=>V(Se=>({...Se,[_.key]:te.target.value}))})]},`type-filter:${_.key}`))})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:Et}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{be(_=>{const te={..._};for(const Se of lt)te[Se.infoId]={infoId:Se.infoId,infoType:Se.infoType,label:Se.label};return te})},disabled:lt.length===0,children:S.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>be({}),disabled:He.length===0,children:S.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>at&&$t(at),disabled:!at,title:at?void 0:S.openSelectedDisabled,children:S.openSelected})]})]}),He.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:S.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:S.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:Ct.map(([_,te])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:Ye(t,_)}),e.jsx("span",{className:"cogita-tag-count",children:te})]},`stack:type:${_}`))})]}):null,Rt==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":S.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:S.detailColumnName}),e.jsx("span",{children:S.detailColumnType}),e.jsx("span",{children:S.detailColumnId}),e.jsx("span",{})]}),lt.length?lt.map(_=>{const te=Ye(t,_.infoType),Se=We.has(_.infoId),d=De===_.infoId;return e.jsxs("div",{className:`cogita-details-row ${d||Se?"active":""}`,role:"row",onClick:()=>he(_.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:Se,onChange:ve=>it(_,ve.target.checked),onClick:ve=>ve.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:_.label,children:_.label}),e.jsx("span",{title:te,children:te}),e.jsx("span",{title:_.infoId,children:_.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:ve=>{ve.stopPropagation(),$t(_.infoId)},"aria-label":S.editInfo,children:">"})]},_.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:S.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${Rt}`,"data-view":Rt,children:lt.length?lt.map(_=>{const te=Ye(t,_.infoType),Se=We.has(_.infoId),d=De===_.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":d||Se,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:Se,onChange:ve=>it(_,ve.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>he(_.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:te}),e.jsx("h3",{className:"cogita-card-title",children:_.label}),e.jsx("p",{className:"cogita-card-subtitle",children:_.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>$t(_.infoId),children:S.editInfo})]})},_.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:S.noMatch})})}),yt?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>re(_=>_+es),children:S.loadMore})}):null]})]})})})})}function hi(t,s,n){if(t&&typeof t=="object"&&!Array.isArray(t)){const i=t,o=["title","name","label","value","text","quote","term"];for(const g of o){const f=i[g];if(typeof f=="string"&&f.trim())return f.trim()}}return`${s} · ${n}`}function gi(t,s){try{const n=s==="pl"?"pl-PL":s==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(n,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function mi(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function pi(t,s){return t.totalReviews<=0?s.noKnownnessData:t.totalReviews<3||t.score<.35?s.developmentStart:t.totalReviews<8||t.score<.65?s.developmentGrowing:t.score<.85?s.developmentStable:s.developmentStrong}function fi({links:t,emptyLabel:s}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:s}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([n,i])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:n}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(i)?i.length?e.jsx("div",{className:"cogita-selection-overview",children:i.map(o=>e.jsx("span",{className:"cogita-tag-chip",children:o},`${n}:${o}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):i?e.jsx("span",{className:"cogita-tag-chip",children:i}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},n))})}function Ea({value:t,emptyLabel:s}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:s});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((n,i)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:i+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(Ea,{value:n,emptyLabel:s})})]},i))});if(typeof t=="object"){const n=Object.entries(t);return n.length===0?e.jsx("p",{className:"cogita-library-hint",children:s}):e.jsx("div",{className:"cogita-info-tree",children:n.map(([i,o])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:i}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(Ea,{value:o,emptyLabel:s})})]},i))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const sa=5,$s=50,Rs=2,Es=[];function na({libraryId:t,infoType:s,label:n,placeholder:i,value:o,onChange:g,values:f,onChangeMultiple:x,helperText:A,searchFailedText:N,createFailedText:l,createLabel:b,savingLabel:c,loadMoreLabel:u,inputRef:S,autoAdvance:ae,onCommit:J,multiple:W}){const k=W?f??Es:Es,[m,ce]=a.useState(W?"":(o==null?void 0:o.label)??""),[P,p]=a.useState([]),[H,R]=a.useState(sa),[X,L]=a.useState(-1),[E,se]=a.useState(!1),[ie,re]=a.useState(!1),[De,he]=a.useState(null),T=a.useRef(0),be=a.useRef(new Map),y=a.useMemo(()=>W?m.trim().length>0:m.trim().length>0&&!o,[m,o,W]);a.useEffect(()=>{W||ce((o==null?void 0:o.label)??"")},[o,W]),a.useEffect(()=>{const Y=m.trim();if(!Y||Y.length<Rs){p([]),se(!1),R(sa),L(-1),re(!1),he(null);return}const F=Y.toLowerCase(),we=`${t}:${s}:${F}`,Ne=be.current.get(we);if(Ne){if(W&&k.length>0){const Fe=new Set(k.map(Ie=>Ie.id));p(Ne.filter(Ie=>!Fe.has(Ie.id)))}else p(Ne);R(sa),L(-1),se(Ne.length>0),re(!1),he(null);return}const Te=window.setTimeout(async()=>{const Fe=Date.now();T.current=Fe,re(!0),he(null);try{const Ie=await bs({libraryId:t,type:s,query:Y,limit:$s});if(T.current!==Fe)return;const _e=Ie.slice(0,$s).map(Be=>({id:Be.infoId,label:Be.label,infoType:Be.infoType}));if(be.current.set(we,_e),W&&k.length>0){const Be=new Set(k.map(Le=>Le.id));p(_e.filter(Le=>!Be.has(Le.id)))}else p(_e);R(sa),L(-1),se(!0)}catch{if(T.current!==Fe)return;he(N??"Search failed.")}finally{T.current===Fe&&re(!1)}},250);return()=>window.clearTimeout(Te)},[t,s,m,k]);const V=Y=>{if(W){const F=k.some(we=>we.id===Y.id)?k:[...k,Y];x==null||x(F),ce(""),se(!1),L(-1);return}g==null||g(Y),ce(Y.label),se(!1),L(-1),ae&&(J==null||J())},me=async()=>{const Y=m.trim();if(Y){re(!0),he(null);try{const F=await en({libraryId:t,infoType:s,payload:{label:Y}}),we={id:F.infoId,label:Y,infoType:F.infoType};if(Y.length>=Rs){const Ne=`${t}:${s}:${Y.toLowerCase()}`,Te=be.current.get(Ne)??[];be.current.set(Ne,[we,...Te])}if(W){x==null||x([...k,we]),ce(""),se(!1),L(-1);return}g==null||g(we),se(!1),L(-1),ae&&(J==null||J())}catch{he(l??"Create failed.")}finally{re(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:n}),e.jsx("input",{value:m,placeholder:i,onChange:Y=>{ce(Y.target.value),!W&&o&&(g==null||g(null))},onKeyDown:Y=>{if(Y.key==="ArrowDown"){if(Y.preventDefault(),!P.length)return;se(!0),L(F=>{const we=Math.min(P.length,H)-1,Ne=F<0?0:Math.min(F+1,we);return Ne===we&&P.length>H?(R(Te=>Math.min(Te+sa,P.length)),Math.min(F+1,Math.min(P.length,H+sa)-1)):Ne});return}if(Y.key==="ArrowUp"){if(Y.preventDefault(),!P.length)return;se(!0),L(F=>F<=0?0:F-1);return}if(Y.key==="Enter"){if(Y.preventDefault(),X>=0&&P[X]){V(P[X]);return}if(y){me();return}}},onFocus:()=>{P.length>0&&se(!0)},autoComplete:"off",ref:S})]}),W&&k.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:k.map(Y=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>x==null?void 0:x(k.filter(F=>F.id!==Y.id)),children:[Y.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},Y.id))}),A&&e.jsx("p",{className:"cogita-help",children:A}),De&&e.jsx("p",{className:"cogita-error",children:De}),E&&P.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[P.slice(0,H).map((Y,F)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":F===X,onClick:()=>V(Y),children:[e.jsx("strong",{children:Y.label}),e.jsx("span",{children:Y.infoType})]},Y.id)),H<P.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>R(Y=>Math.min(Y+sa,P.length)),children:u??"Load more"})]}),y&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:me,disabled:ie,children:ie?c??"Saving...":b??`Create new ${s}`})]})}function bi(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function As(t,s){if(!t||typeof t!="object")return s;const n=t,i=[n.label,n.name,n.title,n.text,n.orcid,n.email,n.number];for(const o of i)if(typeof o=="string"&&o.trim())return o.trim();return s}function yi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,libraryId:l,editInfoId:b}){const{libraryName:c}=Wt(l),u=!!b,[S,ae]=a.useState([]),[J,W]=a.useState("word"),[k,m]=a.useState({}),[ce,P]=a.useState({}),[p,H]=a.useState({}),[R,X]=a.useState({}),[L,E]=a.useState(null),[se,ie]=a.useState("idle"),re=a.useMemo(()=>S.find(y=>y.infoType===J),[J,S]),De=a.useMemo(()=>S.map(y=>({value:y.infoType,label:Ye(t,y.infoType)})),[t,S]);a.useEffect(()=>{let y=!1;return jn({libraryId:l}).then(V=>{var me;if(!y&&(ae(V),!u)){const Y=(me=V[0])==null?void 0:me.infoType;Y&&W(Y)}}).catch(()=>{y||ae([])}),()=>{y=!0}},[u,l]),a.useEffect(()=>{if(!re)return;const y={},V={},me={},Y={};for(const F of re.payloadFields)y[F.key]="";for(const F of re.linkFields)F.multiple?me[F.key]=[]:V[F.key]=null,F.targetTypes.length>0&&(Y[F.key]=F.targetTypes[0]);m(y),P(V),H(me),X(Y)},[re==null?void 0:re.infoType]),a.useEffect(()=>{if(!u||!b||S.length===0)return;let y=!1;return ie("loading"),E(null),(async()=>{const me=await Gt({libraryId:l,infoId:b});if(y)return;const Y=me.infoType;W(Y);const F=S.find(Le=>Le.infoType===Y);if(!F){ie("idle");return}const we=me.payload??{},Ne={};for(const Le of F.payloadFields)Ne[Le.key]=bi(we[Le.key]);m(Ne);const Te=me.links??{}??{},Fe={},Ie={},_e={},Be=[];for(const Le of F.linkFields){Le.targetTypes.length>0&&(_e[Le.key]=Le.targetTypes[0]);const qe=Te[Le.key];if(Le.multiple){const et=Array.isArray(qe)?qe.filter(Ge=>typeof Ge=="string"):[];Ie[Le.key]=[];for(const Ge of et)Be.push(Gt({libraryId:l,infoId:Ge}).then(Ee=>{if(y)return;const xe={id:Ge,infoType:Ee.infoType,label:As(Ee.payload,Ge)};Ie[Le.key]=[...Ie[Le.key],xe]}).catch(()=>{}))}else{const et=typeof qe=="string"?qe:null;Fe[Le.key]=null,et&&Be.push(Gt({libraryId:l,infoId:et}).then(Ge=>{y||(Fe[Le.key]={id:et,infoType:Ge.infoType,label:As(Ge.payload,et)})}).catch(()=>{}))}}await Promise.all(Be),!y&&(P(Fe),H(Ie),X(Le=>({...Le,..._e})),ie("idle"))})().catch(()=>{y||(E("Failed to load info details."),ie("idle"))}),()=>{y=!0}},[b,u,l,S]);const he=async()=>{var Y;if(!re)return;const y={};for(const F of re.payloadFields){const we=(k[F.key]??"").trim();if(!we){if(F.required){E(`Field '${F.label}' is required.`);return}continue}if(F.inputType==="json")try{y[F.key]=JSON.parse(we)}catch{E(`Field '${F.label}' must be valid JSON.`);return}else y[F.key]=we}const V={};for(const F of re.linkFields)if(F.multiple){const we=(p[F.key]??[]).map(Ne=>Ne.id);if(F.required&&we.length===0){E(`Link '${F.label}' is required.`);return}we.length>0&&(V[F.key]=we)}else{const we=((Y=ce[F.key])==null?void 0:Y.id)??null;if(F.required&&!we){E(`Link '${F.label}' is required.`);return}we&&(V[F.key]=we)}const me=Object.keys(V).length>0;ie("saving"),E(null);try{if(u&&b)await kn({libraryId:l,infoId:b,payload:y,links:me?V:void 0}),E("Info updated.");else{await en({libraryId:l,infoType:J,payload:y,links:me?V:void 0}),E("Info saved.");const F={};for(const Te of re.payloadFields)F[Te.key]="";m(F);const we={},Ne={};for(const Te of re.linkFields)Te.multiple?Ne[Te.key]=[]:we[Te.key]=null;P(Te=>({...Te,...we})),H(Te=>({...Te,...Ne}))}}catch{E("Failed to save info.")}finally{ie("idle")}},T=y=>{const V=k[y.key]??"",me=y.inputType==="textarea"||y.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:y.label}),me?e.jsx("textarea",{rows:y.inputType==="json"?8:4,value:V,onChange:Y=>m(F=>({...F,[y.key]:Y.target.value})),placeholder:y.key}):e.jsx("input",{type:"text",value:V,onChange:Y=>m(F=>({...F,[y.key]:Y.target.value})),placeholder:y.key})]},`payload:${y.key}`)},be=y=>{const V=R[y.key]??y.targetTypes[0];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:y.label}),y.targetTypes.length>1?e.jsx("select",{value:V,onChange:me=>X(Y=>({...Y,[y.key]:me.target.value})),children:y.targetTypes.map(me=>e.jsx("option",{value:me,children:Ye(t,me)},`${y.key}:${me}`))}):null,y.multiple?e.jsx(na,{libraryId:l,infoType:V,label:y.label,placeholder:y.key,multiple:!0,values:p[y.key]??[],onChangeMultiple:me=>H(Y=>({...Y,[y.key]:me})),searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(na,{libraryId:l,infoType:V,label:y.label,placeholder:y.key,value:ce[y.key]??null,onChange:me=>P(Y=>({...Y,[y.key]:me})),searchFailedText:"Search failed",createFailedText:"Create failed"})]},`link:${y.key}`)};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:u?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${l}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[u?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:J,onChange:y=>W(y.target.value),children:De.map(y=>e.jsx("option",{value:y.value,children:y.label},y.value))})]}),se==="loading"?e.jsx("p",{children:"Loading..."}):null,re?e.jsxs("div",{className:"cogita-form-grid",children:[re.payloadFields.map(T),re.linkFields.map(be)]}):e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:he,disabled:se==="saving"||!re,children:se==="saving"?"Saving...":u?"Update info":"Create info"})}),L?e.jsx("p",{className:"cogita-library-subtitle",children:L}):null]})})})]})})}const Ps=t=>/\s/.test(t),Aa=t=>/[\p{L}\p{N}]/u.test(t),Fs=(t,s)=>{const n=s>0?t[s-1]:"",i=s<t.length?t[s]:"";if(!n||!i)return 0;const o=Ps(n),g=Ps(i);if(o||g)return 3;const f=Aa(n),x=Aa(i);return f!==x?2:!f&&!x?1:0},ts=(t,s,n,i,o)=>{const g=Math.max(i-s,n-i);for(let f=0;f<=g;f+=1){const x=i-f;if(x>=s&&x<=n&&Fs(t,x)>=o)return x;const A=i+f;if(A>=s&&A<=n&&Fs(t,A)>=o)return A}return null},as=(t,s)=>{const n=s>0?t[s-1]:"",i=s<t.length?t[s]:"";return!n||!i?!0:Aa(n)!==Aa(i)},xi=(t,s,n,i)=>{const o=n-s,g=s+i,f=n-i;if(o<=i*2||f<=g)return null;const x=Math.floor((s+n)/2),A=ts(t,g,f,x,3);if(A!==null&&as(t,A))return A;const N=ts(t,g,f,x,2);if(N!==null&&as(t,N))return N;const l=ts(t,g,f,x,1);return l!==null&&as(t,l)?l:null},ia=(t,s)=>{const n=Math.max(1,7),i=Math.max(n,13),o={},g=(A,N,l,b,c)=>{const u=String(b),S={id:u,start:A,end:N,text:t.slice(A,N),depth:l,index:b,parentId:c};if(o[u]=S,N-A>i){let J=xi(t,A,N,n);if(J!==null&&J>A&&J<N){const W=g(A,J,l+1,b*2+1,u),k=g(J,N,l+1,b*2+2,u);S.leftId=W.id,S.rightId=k.id}}return S},f=g(0,t.length,0,0),x=Object.values(o).sort((A,N)=>N.depth-A.depth||A.start-N.start).map(A=>A.id);return{text:t,rootId:f.id,nodes:o,order:x}},ma=(t,s,n,i,o,g,f)=>{const x=g==="reverse"?t.order.slice().sort((A,N)=>t.nodes[N].start-t.nodes[A].start||t.nodes[N].depth-t.nodes[A].depth):t.order;for(const A of x){if(f&&A===f||s.has(A))continue;const N=t.nodes[A];if(N){if(o&&(N.leftId||N.rightId)){const l=N.leftId?n[N.leftId]??0:i,b=N.rightId?n[N.rightId]??0:i;if((l+b)/2<i)continue}return N}}return null},ys=(t,s)=>({before:t.slice(0,s.start),fragment:t.slice(s.start,s.end),after:t.slice(s.end)});function vi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,libraryId:l}){const b=`/#/cogita/library/${l}`,[c,u,S]=qs([]),[ae,J,W]=Us([]),[k,m]=a.useState(null),[ce,P]=a.useState(null),[p,H]=a.useState(null),[R,X]=a.useState(null),L=a.useMemo(()=>c.find(T=>T.id===k)??null,[c,k]);a.useEffect(()=>{let T=!0;return Nn({libraryId:l}).then(be=>{if(!T)return;const y=be.nodes.map(V=>{var me,Y,F;return{id:V.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:V.payload&&typeof V.payload=="object"&&"label"in V.payload?String(V.payload.label):"Item",nodeType:V.nodeType,itemType:((me=V.payload)==null?void 0:me.itemType)??"info",itemId:((Y=V.payload)==null?void 0:Y.itemId)??null,infoType:((F=V.payload)==null?void 0:F.infoType)??null}}});u(y),J(be.edges.map(V=>({id:V.edgeId,source:V.fromNodeId,target:V.toNodeId})))}).catch(()=>{T&&(u([]),J([]))}),()=>{T=!1}},[l]),a.useEffect(()=>{Sn({libraryId:l}).then(P).catch(()=>P(null))},[l,c,ae]);const E=a.useCallback(T=>{J(be=>Ws(T,be))},[]),se=()=>{const T=crypto.randomUUID();u(be=>[...be,{id:T,type:"default",position:{x:140+be.length*40,y:120+be.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},ie=()=>{const T=crypto.randomUUID();u(be=>[...be,{id:T,type:"default",position:{x:180+be.length*40,y:160+be.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},re=async()=>{H(null);try{const T=c.map(y=>({nodeId:y.id,nodeType:y.data.nodeType,payload:{itemType:y.data.itemType,itemId:y.data.itemId??null,label:y.data.label,infoType:y.data.infoType??null}})),be=ae.map(y=>({edgeId:y.id,fromNodeId:y.source,toNodeId:y.target}));await Tn({libraryId:l,nodes:T,edges:be}),H(t.cogita.library.graph.saveSuccess)}catch{H(t.cogita.library.graph.saveFail)}},De=T=>{L&&u(be=>be.map(y=>y.id===L.id?{...y,data:{...y.data,itemId:(T==null?void 0:T.infoId)??null,itemType:"collection",infoType:"collection",label:(T==null?void 0:T.label)??t.cogita.library.infoTypes.collection}}:y))},he=T=>{L&&u(be=>be.map(y=>y.id===L.id?{...y,data:{...y.data,itemId:(T==null?void 0:T.infoId)??null,itemType:"info",infoType:(T==null?void 0:T.infoType)??null,label:(T==null?void 0:T.label)??t.cogita.library.infoTypes.any}}:y))};return a.useEffect(()=>{if(!L||L.data.nodeType!=="info"||L.data.infoType!=="citation"||!L.data.itemId){X(null);return}let T=!0;return Gt({libraryId:l,infoId:L.data.itemId}).then(be=>{if(!T)return;const y=be.payload,V=(y==null?void 0:y.text)??"";if(!V){X(null);return}const me=ia(V),Y=Object.values(me.nodes).sort((F,we)=>F.depth-we.depth||F.start-we.start).map(F=>({id:F.id,text:F.text,depth:F.depth}));X({title:(y==null?void 0:y.title)??L.data.label,fragments:Y})}).catch(()=>X(null)),()=>{T=!1}},[l,L]),e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:b,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:re,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:se,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ie,children:t.cogita.library.actions.addInfo}),ce?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(ce.totalCollections))})}):null,p?e.jsx("p",{className:"cogita-help",children:p}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(gs,{nodes:c,edges:ae,onNodesChange:S,onEdgesChange:W,onConnect:E,onNodeClick:(T,be)=>m(be.id),fitView:!0,children:[e.jsx(ms,{gap:18,size:1}),e.jsx(ps,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),L?e.jsxs("div",{className:"cogita-graph-inspector",children:[L.data.nodeType==="collection"?e.jsx(na,{libraryId:l,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:L.data.itemId?{id:L.data.itemId,label:L.data.label,infoType:"collection"}:null,onChange:De,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(na,{libraryId:l,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:L.data.itemId?{id:L.data.itemId,label:L.data.label,infoType:L.data.infoType??void 0}:null,onChange:he,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),R?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:R.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:R.fragments.map(T=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:T.id}),e.jsx("span",{children:T.text})]},T.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function wi({children:t,flashState:s,flashTick:n=0,className:i}){const o=s?`${s}-${n}`:"idle";return e.jsx("section",{className:i?`cogita-revision-card ${i}`:"cogita-revision-card","data-feedback":o,children:t})}function xs({copy:t,currentCard:s,currentTypeLabel:n,prompt:i,languages:o,answer:g,onAnswerChange:f,computedExpected:x,computedAnswers:A,onComputedAnswerChange:N,answerTemplate:l,outputVariables:b,variableValues:c,computedFieldFeedback:u,feedback:S,canAdvance:ae,quoteContext:J,quotePlaceholder:W,onCheckAnswer:k,onSkip:m,onLanguageSelect:ce,onMarkReviewed:P,onAdvance:p,showCorrectAnswer:H,setShowCorrectAnswer:R,onRevealCorrect:X,answerMask:L,expectedAnswer:E,hasExpectedAnswer:se,handleComputedKeyDown:ie,answerInputRef:re,computedInputRefs:De,scriptMode:he,setScriptMode:T,matchPairs:be,matchLeftOrder:y,matchRightOrder:V,matchSelection:me,matchActiveLeft:Y,matchActiveRight:F,matchFeedback:we,onMatchLeftSelect:Ne,onMatchRightSelect:Te,disableCheckAnswer:Fe=!1,hideSkipAction:Ie=!1}){const _e=a.useMemo(()=>{var K;const G=!l&&x.length===2?`The {${x[0].key}} is of type {${x[1].key}}`:null,fe=l??G;if(!fe)return null;const oe=new Map(x.map(ue=>[ue.key,ue.expected])),ye=new Set,Ke=[],Je=/\{([^}]+)\}/g;let Ve=0,$,q=null;for(;($=Je.exec(fe))!==null;){const ue=fe.slice(Ve,$.index);ue&&Ke.push({type:"text",value:ue});const pe=((K=$[1])==null?void 0:K.trim())??"",Q=pe&&oe.has(pe)?pe:pe&&b&&b[pe]?b[pe]:null;pe&&ye.add(pe),Q&&ye.add(Q),Q&&oe.has(Q)?(Ke.push({type:"input",value:Q}),q||(q=Q)):pe&&c&&c[pe]!==void 0?Ke.push({type:"text",value:c[pe]}):Ke.push({type:"text",value:$[0]}),Ve=$.index+$[0].length}const je=fe.slice(Ve);return je&&Ke.push({type:"text",value:je}),x.filter(ue=>!ye.has(ue.key)).length>0?null:{parts:Ke,expectedByKey:oe,firstInputKey:q}},[l,x,b,c]),Be=()=>{if(!_e)return null;const{parts:G,expectedByKey:fe,firstInputKey:oe}=_e;return e.jsx("div",{className:"cogita-revision-inline-answer",children:G.map((ye,Ke)=>{var Je,Ve;return ye.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:ye.value},`text-${Ke}`):e.jsx("input",{ref:$=>{De.current[ye.value]=$},autoFocus:ye.value===oe,value:A[ye.value]??"",onChange:$=>N(ye.value,$.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":u[ye.value]??(S==="correct"?"correct":S==="incorrect"?"incorrect":void 0),onKeyDown:$=>Ge($)||ie($),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((Je=A[ye.value])==null?void 0:Je.length)??0,((Ve=fe.get(ye.value))==null?void 0:Ve.length)??6)}ch`}},`input-${ye.value}-${Ke}`)})})},Le=a.useMemo(()=>{const G=new Map;return(be??[]).forEach(fe=>G.set(fe.leftId,fe)),G},[be]),qe=a.useMemo(()=>{const G=new Map;return(be??[]).forEach(fe=>G.set(fe.rightId,fe)),G},[be]);a.useEffect(()=>{var Ke;if(s.cardType!=="info"||s.infoType!=="computed"||x.length===0)return;const G=typeof document<"u"?document.activeElement:null;if(G&&(G.tagName==="INPUT"||G.tagName==="TEXTAREA"))return;const fe=(_e==null?void 0:_e.firstInputKey)??((Ke=x[0])==null?void 0:Ke.key);if(!fe)return;const oe=De.current[fe];if(!oe)return;const ye=requestAnimationFrame(()=>{oe.focus()});return()=>cancelAnimationFrame(ye)},[s,x,_e]);const et=(()=>{const G=[E??"",...x.map(ye=>ye.expected??"")].join(""),fe=[g,...Object.values(A)].join(""),oe=`${G}${fe}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(oe)})(),Ge=G=>G.ctrlKey&&(G.key==="^"||G.key==="6")?(G.preventDefault(),T(fe=>fe==="super"?null:"super"),!0):G.ctrlKey&&(G.key==="_"||G.key==="-")?(G.preventDefault(),T(fe=>fe==="sub"?null:"sub"),!0):!1,Ee=()=>{if(!E||!L)return E??"";const G=E.split(""),fe=Array.from(L),oe=fe.length>0?fe.reduce((ye,Ke)=>ye+Ke,0)/fe.length:127;return G.map((ye,Ke)=>{const Je=fe[Ke]??oe,Ve=Math.max(0,Math.min(255,Math.round(Je)));let $=255,q=0;return Ve<=127?q=Math.round(Ve/127*255):(q=255,$=Math.round(255*(1-(Ve-127)/128))),e.jsx("span",{style:{color:`rgb(${$}, ${q}, 0)`},children:ye},`mask-${Ke}`)})},xe=s.cardType==="info"&&s.infoType==="citation"?(J==null?void 0:J.title)||s.label:s.description;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[n?e.jsx("span",{children:n}):null,e.jsx("strong",{children:xe})]}),s.cardType==="vocab"&&s.checkType==="translation-match"&&be?e.jsxs("div",{className:"cogita-revision-body",children:[i?e.jsx("h2",{children:i}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(y??[]).map(G=>{const fe=Le.get(G);if(!fe)return null;const oe=(me==null?void 0:me[G])??null,ye=(we==null?void 0:we[G])??null,Ke=Y===G;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":Ke,"data-state":ye??void 0,"data-locked":oe?"true":void 0,onClick:()=>Ne==null?void 0:Ne(G),children:[e.jsx("span",{children:fe.leftLabel}),oe&&H?e.jsx("em",{children:"✓"}):null]},G)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(V??[]).map(G=>{const fe=qe.get(G);if(!fe)return null;const oe=Object.values(me??{}).includes(G),ye=F===G;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":oe||ye,"data-locked":oe?"true":void 0,onClick:()=>Te==null?void 0:Te(G),children:e.jsx("span",{children:fe.rightLabel})},G)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:k,disabled:s.checkType==="translation-match"||Fe,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:m,children:t.cogita.library.revision.skip})]})]}):s.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:re,value:g,onChange:G=>f(G.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":S==="correct"?"correct":S==="incorrect"?"incorrect":void 0,onKeyDown:G=>{if(G.key==="Enter")if(G.preventDefault(),G.stopPropagation(),ae)p();else{if(Fe)return;k()}}})]}),et?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":he==="super",onClick:()=>T(G=>G==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":he==="sub",onClick:()=>T(G=>G==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:k,disabled:Fe,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:m,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[s.label?e.jsx("p",{className:"cogita-revision-hint",children:s.label}):null,l?null:e.jsx(Cn,{value:i??"",mode:"auto"}),x.length>0?(()=>{const G=Be();return G?e.jsx("div",{className:"cogita-inline-answer-wrap",children:G}):e.jsx("div",{className:"cogita-form-grid",children:x.map((fe,oe)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:fe.key}),e.jsx("textarea",{ref:ye=>{De.current[fe.key]=ye},autoFocus:oe===0,value:A[fe.key]??"",onChange:ye=>N(fe.key,ye.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":u[fe.key]??(S==="correct"?"correct":S==="incorrect"?"incorrect":void 0),onKeyDown:ye=>Ge(ye)||ie(ye)})]},fe.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:re,value:g,onChange:G=>f(G.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":S==="correct"?"correct":S==="incorrect"?"incorrect":void 0,onKeyDown:G=>{if(!Ge(G)&&G.key==="Enter")if(G.preventDefault(),G.stopPropagation(),ae)p();else{if(Fe)return;k()}}})]})}),et?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":he==="super",onClick:()=>T(G=>G==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":he==="sub",onClick:()=>T(G=>G==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:k,disabled:Fe,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:m,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="citation"&&J?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(J.completed)).replace("{total}",String(J.total))}),e.jsx("p",{className:"cogita-quote-text",children:J.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:re,value:g,onChange:G=>f(G.target.value),placeholder:W??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":S==="correct"?"correct":S==="incorrect"?"incorrect":void 0,onKeyDown:G=>{if(G.key==="Enter")if(G.preventDefault(),G.stopPropagation(),ae)p();else{if(Fe)return;k()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:J.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:k,disabled:Fe,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:m,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:o.length?o.map(G=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>ce(G.label),children:G.label},G.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:m,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:P,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:m,children:t.cogita.library.revision.skip})]})]}),S&&e.jsx("div",{className:"cogita-revision-feedback","data-state":S,children:S==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),S==="incorrect"&&se?e.jsxs("div",{className:"cogita-revision-reveal",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>R(G=>{const fe=!G;return fe&&X(),fe}),children:t.cogita.library.revision.showAnswer}),H?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),x.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[x.map(G=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:G.key}),e.jsx("span",{children:G.expected})]},G.key)),E?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:E})]}):null]}):e.jsx("p",{children:L?Ee():E})]}):null]}):null,ae?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:p,children:t.cogita.library.revision.nextQuestion})}):null]})}function Ut(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function Ks(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function zs(t){const s=t.checkType??"info";return t.direction?`${s} / ${t.direction}`:s}function Bs(t){return t.trim().replace(/\s+/g," ").toLocaleLowerCase()}function ji({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,libraryId:l,infoId:b,selectedReviewerRoleId:c}){const[u,S]=a.useState(b),[ae,J]=a.useState([]),[W,k]=a.useState([]),[m,ce]=a.useState("loading"),[P,p]=a.useState(null),[H,R]=a.useState(null),[X,L]=a.useState(null),[E,se]=a.useState(null),[ie,re]=a.useState(""),[De,he]=a.useState(null),[T,be]=a.useState(1),[y,V]=a.useState(null),[me,Y]=a.useState(0),[F,we]=a.useState(!1),[Ne,Te]=a.useState({}),[Fe,Ie]=a.useState({}),[_e]=a.useState({}),[Be,Le]=a.useState(null),qe=a.useRef(null),et=a.useRef({});a.useEffect(()=>{let $=!1;return ce("loading"),Promise.all([Gt({libraryId:l,infoId:b}).catch(()=>null),Js({libraryId:l,infoId:b}),Xs({libraryId:l,infoId:b})]).then(([q,je,M])=>{if($)return;const K=(q==null?void 0:q.payload)??{},ue=typeof K.title=="string"&&K.title||typeof K.label=="string"&&K.label||typeof K.name=="string"&&K.name||b;S(ue),R(K),L((q==null?void 0:q.infoType)??null),J(je.items),k(M.items),ce("ready")}).catch(()=>{$||(R(null),L(null),J([]),k([]),ce("error"))}),()=>{$=!0}},[l,b]),a.useEffect(()=>{if(X!=="translation"){se(null);return}Zs({libraryId:l,infoId:b,approachKey:"vocab-card"}).then($=>se($.projection??null)).catch(()=>se(null))},[X,b,l]);const Ge=a.useMemo(()=>{var pe;const $=new Map(ae.map(Q=>[Ut(Q),Q])),q=new Map,je=new Map;for(const Q of ae)q.set(Ut(Q),0),je.set(Ut(Q),[]);for(const Q of W){const Ce=Ks({parentItemId:Q.parentItemId,parentCheckType:Q.parentCheckType,parentDirection:Q.parentDirection}),ke=[Q.childItemId,Q.childCheckType??"",Q.childDirection??""].join("|");!$.has(Ce)||!$.has(ke)||((pe=je.get(Ce))==null||pe.push(ke),q.set(ke,(q.get(ke)??0)+1))}const M=Array.from(q.entries()).filter(([,Q])=>Q===0).map(([Q])=>Q),K=new Map;for(const Q of M)K.set(Q,0);for(;M.length;){const Q=M.shift(),Ce=K.get(Q)??0;for(const ke of je.get(Q)??[]){const ze=Math.max(K.get(ke)??0,Ce+1);K.set(ke,ze),q.set(ke,(q.get(ke)??1)-1),(q.get(ke)??0)<=0&&M.push(ke)}}const ue=new Map;for(const Q of ae){const Ce=Ut(Q),ke=K.get(Ce)??0,ze=ue.get(ke)??[];ze.push(Ce),ue.set(ke,ze)}return ae.map(Q=>{const Ce=Ut(Q),ke=K.get(Ce)??0,ze=ue.get(ke)??[Ce],Re=Math.max(0,ze.indexOf(Ce));return{id:Ce,position:{x:40+Re*290+(ke%2?18:0),y:30+ke*120},draggable:!1,selectable:!0,data:{label:Q.label,subtitle:zs(Q),checkType:Q.checkType??"info",direction:Q.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[ae,W]),Ee=a.useMemo(()=>new Map(ae.map($=>[Ut($),$])),[ae]),xe=a.useMemo(()=>{const $=[];for(const q of W){const je=Ks({parentItemId:q.parentItemId,parentCheckType:q.parentCheckType,parentDirection:q.parentDirection}),M=[q.childItemId,q.childCheckType??"",q.childDirection??""].join("|");!Ee.has(je)||!Ee.has(M)||$.push({id:`${je}->${M}`,source:je,target:M,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return $},[Ee,W]),G=a.useMemo(()=>P?Ee.get(P)??null:null,[Ee,P]);a.useEffect(()=>{re(""),V(null),Y(0),we(!1),he(null),Ie({})},[P]);const fe=a.useMemo(()=>{var K,ue;if(!G)return null;const $=X??G.infoType??null,q=G.checkType??"info",je=G.direction??null,M=H??{};if(G.cardType==="vocab"&&E&&Array.isArray(E.words)){const pe=E.words,Q=((K=pe[0])==null?void 0:K.label)??"?",Ce=((ue=pe[1])==null?void 0:ue.label)??"?";return je==="a-to-b"?{kind:"vocab",prompt:String(Q),expected:String(Ce)}:je==="b-to-a"?{kind:"vocab",prompt:String(Ce),expected:String(Q)}:{kind:"generic",prompt:`${Q} ↔ ${Ce}`,expected:`${Q} ↔ ${Ce}`}}if($==="citation"&&q==="quote-fragment"&&je&&typeof M.text=="string"){const pe=je,Q=ia(M.text),Ce=Q.nodes[pe];if(Ce){const ke=ys(M.text,Ce);return{kind:"citation-fragment",expected:Ce.text,quoteContext:{title:u,before:ke.before,after:ke.after,total:Object.keys(Q.nodes).length,completed:0},quotePlaceholder:Ce.text.length>0?".".repeat(Math.max(4,Math.min(18,Ce.text.length))):"..."}}}return{kind:"generic",prompt:G.description||G.label,expected:G.label}},[X,H,G,u,E]),oe=async $=>{if(G&&c)try{await Mn({libraryId:l,outcome:{itemType:"info",itemId:G.cardId,checkType:G.checkType??"info",direction:G.direction??null,revisionType:"direct",evalType:"direct-check",correct:$,clientId:"cogita-info-checkcards",clientSequence:T,personRoleId:c}}),be(q=>q+1),he($?"Saved as correct.":"Saved as incorrect.")}catch{he("Failed to save answer.")}},ye=G?Ut(G):null,Ke=ye?!!Ne[ye]:!1,Je=async()=>{if(!G||!fe)return;const $=Ut(G);if(Ne[$]){he("This card was already checked.");return}const q=fe.expected,je=Bs(ie)===Bs(q);V(je?"correct":"incorrect"),Y(M=>M+1),he(c?null:"Answer checked locally (not saved: no person selected)."),Te(M=>({...M,[$]:!0})),c&&await oe(je)},Ve=a.useMemo(()=>G?G.infoType==="citation"?{...G,description:u}:{...G,description:G.label}:null,[G,u]);return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.infoTypes.citation}),e.jsx("h2",{className:"cogita-card-title",children:u}),e.jsx("p",{className:"cogita-card-subtitle",children:b})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${ae.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${W.length}`})]})]}),m==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):m==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(gs,{nodes:Ge,edges:xe,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:($,q)=>p(q.id),panOnDrag:!0,children:[e.jsx(ms,{}),e.jsx(ps,{showInteractive:!1})]})}),G?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[fe&&Ve?e.jsx(wi,{flashState:y,flashTick:me,children:e.jsx(xs,{copy:t,currentCard:Ve,currentTypeLabel:"",prompt:fe.kind==="citation-fragment"?null:fe.prompt,languages:[],answer:ie,onAnswerChange:re,computedExpected:[],computedAnswers:Fe,onComputedAnswerChange:($,q)=>Ie(je=>({...je,[$]:q})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:_e,feedback:y,canAdvance:!1,quoteContext:fe.kind==="citation-fragment"?fe.quoteContext:null,quotePlaceholder:fe.kind==="citation-fragment"?fe.quotePlaceholder:null,onCheckAnswer:()=>void Je(),onSkip:()=>p(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:F,setShowCorrectAnswer:we,onRevealCorrect:()=>{},answerMask:null,expectedAnswer:fe.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:qe,computedInputRefs:et,scriptMode:Be,setScriptMode:Le,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:Ke,hideSkipAction:!0})}):null,c?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),De?e.jsx("p",{className:"cogita-library-hint",children:De}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:ae.map($=>{const q=Ut($),je=P===q;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${je?"active":""}`,onClick:()=>p(q),children:[e.jsx("span",{children:$.label}),e.jsx("small",{children:zs($)})]},q)})})]})]})]})})})})})}function ki({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,libraryId:l,collectionId:b}){const{libraryName:c}=Wt(l),[u,S]=a.useState([]),[ae,J]=a.useState("loading"),[W,k]=a.useState("idle"),m=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),ce=`/#/cogita/library/${l}`,P=()=>{J("loading"),tn({libraryId:l}).then(R=>{S(R),J("idle")}).catch(()=>{S([]),J("error")})};a.useEffect(()=>{P()},[l]);const p=async R=>{try{await an({libraryId:l,shareId:R}),P()}catch{P()}},H=async R=>{const X=`${m}/${R}`;try{await navigator.clipboard.writeText(X),k("copied")}catch{k("failed")}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:ce,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${ce}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[ae==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):ae==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):u.filter(R=>!b||R.collectionId===b).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:u.filter(R=>!b||R.collectionId===b).map(R=>e.jsxs("div",{className:"cogita-share-row","data-state":R.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:R.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(R.createdUtc).toLocaleString(),R.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),R.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${m}/${R.shareCode}`}):null]}),R.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[R.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>H(R.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>p(R.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},R.shareId))}),W==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):W==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function Ni({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,libraryId:l}){const{libraryName:b}=Wt(l),[c,u]=a.useState(null),[S,ae]=a.useState(null),[J,W]=a.useState(null),[k,m]=a.useState(null),[ce,P]=a.useState(null),[p,H]=a.useState(null),R=a.useRef(null),X=se=>{if(!Number.isFinite(se))return"0 B";if(se<1024)return`${se} B`;const ie=se/1024;if(ie<1024)return`${ie.toFixed(1)} KB`;const re=ie/1024;return re<1024?`${re.toFixed(1)} MB`:`${(re/1024).toFixed(1)} GB`},L=async()=>{u(null),P({loadedBytes:0,totalBytes:null,percent:null});try{u(t.cogita.library.overview.exporting);const se=await In(l,P),ie=URL.createObjectURL(se),re=document.createElement("a");re.href=ie,re.download=`cogita-library-${b||l}.json`,re.click(),URL.revokeObjectURL(ie),u(t.cogita.library.overview.exportReady)}catch{u(t.cogita.library.overview.exportFail)}finally{P(se=>se??{loadedBytes:0,totalBytes:null,percent:null})}},E=async se=>{var re;ae(null),W(null),m(null);const ie=(re=se.target.files)==null?void 0:re[0];if(ie)try{ae(t.cogita.library.overview.importing),H({loadedBytes:0,totalBytes:ie.size,percent:0});const De=await Ln(l,ie,H,he=>{const T=he.stage==="infos"?t.cogita.library.overview.importStageInfos:he.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;m(t.cogita.library.overview.importLiveProgress.replace("{stage}",T).replace("{done}",String(he.processed)).replace("{total}",String(he.total)).replace("{infos}",String(he.infos)).replace("{connections}",String(he.connections)).replace("{collections}",String(he.collections)))});W({infos:De.infosImported,connections:De.connectionsImported,collections:De.collectionsImported}),ae(t.cogita.library.overview.importDone)}catch(De){const he=De instanceof $n&&De.message?` ${De.message}`:"";ae(`${t.cogita.library.overview.importFail}${he}`)}finally{R.current&&(R.current.value="")}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:b}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:L,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:R,type:"file",accept:"application/json",onChange:E})]})]}),ce?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:ce.percent??void 0,max:ce.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",X(ce.loadedBytes)).replace("{total}",ce.totalBytes?X(ce.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,p?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:p.percent??void 0,max:p.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",X(p.loadedBytes)).replace("{total}",p.totalBytes?X(p.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,c?e.jsx("p",{className:"cogita-help",children:c}):null,S?e.jsx("p",{className:"cogita-help",children:S}):null,k?e.jsx("p",{className:"cogita-help",children:k}):null,J?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(J.infos)).replace("{connections}",String(J.connections)).replace("{collections}",String(J.collections))}):null]})]})})})]})})}function Si({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,libraryId:l}){const{libraryName:b}=Wt(l),[c,u]=a.useState(""),[S,ae]=a.useState([]),J=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:b}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:c,onChange:W=>u(W.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const W=c.trim();W&&(ae(k=>[{id:J(),name:W},...k]),u(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[S.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,S.map(W=>e.jsx("button",{type:"button",className:"ghost",children:W.name},W.id))]})]})]})})})]})})}function Ti({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,libraryId:l}){const{libraryName:b}=Wt(l),[c,u]=a.useState(""),[S,ae]=a.useState([]),J=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:b}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:c,onChange:W=>u(W.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const W=c.trim();W&&(ae(k=>[{id:J(),name:W},...k]),u(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[S.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,S.map(W=>e.jsx("button",{type:"button",className:"ghost",children:W.name},W.id))]})]})]})})})]})})}function Ds({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,libraryId:l}){const{libraryName:b}=Wt(l),c=`/#/cogita/library/${l}`,[u,S]=a.useState(""),[ae,J]=a.useState([]),[W,k]=a.useState("idle"),[m,ce]=a.useState(0),[P,p]=a.useState(null);a.useEffect(()=>{k("loading");const R=window.setTimeout(()=>{ja({libraryId:l,query:u.trim()||void 0,limit:30}).then(X=>{J(X.items),ce(X.total),p(X.nextCursor??null),k("ready")}).catch(()=>{J([]),ce(0),p(null),k("ready")})},240);return()=>window.clearTimeout(R)},[l,u]);const H=async()=>{if(P){k("loading");try{const R=await ja({libraryId:l,query:u.trim()||void 0,limit:30,cursor:P});J(X=>[...X,...R.items]),p(R.nextCursor??null),ce(R.total),k("ready")}catch{k("ready")}}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:b}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:c,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${c}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:u,onChange:R=>S(R.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(ae.length)).replace("{total}",String(m||ae.length))}),e.jsx("span",{children:W==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:ae.length?ae.map(R=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${c}/collections/${R.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:R.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(R.itemCount))," ·"," ",R.notes||t.cogita.library.collections.noNotes]})]})},R.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${c}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),P?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:H,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const de=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,Vt=(t,s,n,i)=>`${t}:${s}:${n??""}:${i??""}`;function Ci({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,libraryId:l,collectionId:b}){Wt(l);const c=`/#/cogita/library/${l}`,[u,S]=a.useState(t.cogita.library.collections.defaultName),[ae,J]=a.useState(null),[W,k]=a.useState(0),[m,ce]=a.useState([]),[P,p]=a.useState("idle"),[H,R]=a.useState(null),X=a.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(m.length)).replace("{total}",String(W||m.length)),[t,m.length,W]);a.useEffect(()=>{Oa(l,b).then(E=>{S(E.name),J(E.notes??null),k(E.itemCount)}).catch(()=>{S(t.cogita.library.collections.defaultName),J(null)})},[l,b]),a.useEffect(()=>{p("loading"),Ra({libraryId:l,collectionId:b,limit:40}).then(E=>{ce(E.items),R(E.nextCursor??null),k(E.total),p("ready")}).catch(()=>{ce([]),R(null),p("ready")})},[l,b]);const L=async()=>{if(H){p("loading");try{const E=await Ra({libraryId:l,collectionId:b,limit:40,cursor:H});ce(se=>[...se,...E.items]),R(E.nextCursor??null),k(E.total),p("ready")}catch{p("ready")}}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:u}),e.jsx("p",{className:"cogita-library-subtitle",children:ae||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:c,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${c}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${c}/collections/${b}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${c}/collections/${b}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:X}),e.jsx("span",{children:P==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:m.length?m.map(E=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:E.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:E.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:E.label}),e.jsx("p",{className:"cogita-card-subtitle",children:E.description})]})},de(E))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),H?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:L,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${c}/collections/${b}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const Ot=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const s=t.length,n=t.filter(g=>g.correct).length,i=qa(vs(t));return{score:Math.round(Math.max(0,Math.min(100,i.knowness*100))*100)/100,total:s,correct:n,lastReviewedUtc:i.lastReviewedUtc??null}},Mi=t=>{if(t.maskBase64)try{const s=Rn(t.maskBase64);if(!s.length)return t.correct?1:0;const n=s.reduce((i,o)=>i+o,0);return Math.max(0,Math.min(1,n/s.length/255))}catch{return t.correct?1:0}return t.correct?1:0},vs=t=>t.map(s=>({correctness:Mi(s),createdUtc:s.createdUtc})),qa=(t,s=Date.now())=>{var W;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const i=t.slice().sort((k,m)=>k.createdUtc.localeCompare(m.createdUtc)).slice(-5),o=i.reduce((k,m)=>k+m.correctness,0)/i.length,g=5,f=2,x=.15;let A=0,N=0;for(let k=0;k<i.length;k+=1){const m=new Date(i[k].createdUtc).getTime(),ce=k===i.length-1?s:new Date(i[k+1].createdUtc).getTime(),P=Math.max(0,(ce-m)/(1e3*60)),p=1-Math.exp(-P/g);A+=p,i[k].correctness>.5&&(N+=x)}let l=o*A*f+N;const b=((W=i[i.length-1])==null?void 0:W.createdUtc)??null,c=b?Math.max(0,(s-new Date(b).getTime())/(1e3*60)):0,S=1/(1+Math.log1p(c/60));return l*=S,i.length===1&&i[0].correctness>.5&&(l+=5.44*Math.exp(-c/2)),{knowness:l,avgCorrectness:o,lastReviewedUtc:b}},ka=t=>{const s=t.slice();for(let n=s.length-1;n>0;n-=1){const i=Math.floor(Math.random()*(n+1));[s[n],s[i]]=[s[i],s[n]]}return s},$a=t=>t[Math.floor(Math.random()*t.length)],Ii=(t,s)=>{const n=new Map;return t.forEach(i=>n.set(i,Math.random())),t.sort((i,o)=>{const g=s(i)-s(o);return g!==0?g:(n.get(i)??0)-(n.get(o)??0)})},Ua=(t,s,n,i,o)=>{if(!t.length)return null;const g=t.filter(x=>!(o!=null&&o.has(de(x))));if(g.length===0)return null;const f=g.filter(x=>de(x)!==n);return $a(f.length?f:g)},Li=(t,s,n,i,o)=>{if(!t.length)return null;let g=Number.POSITIVE_INFINITY;for(const N of t){const l=de(N);if(n.has(l))continue;const b=s[l]??1;b<g&&(g=b)}if(!Number.isFinite(g))return null;const f=t.filter(N=>{const l=de(N);return!n.has(l)&&(s[l]??1)===g}),x=f.filter(N=>!o||de(N)!==o),A=i?x.filter(N=>!i.has(de(N))):x;return A.length>0?$a(A):x.length>0?$a(x):o&&f.some(N=>de(N)===o)?f.find(N=>de(N)===o)??null:f.length?$a(f):null},on=(t,s,n,i,o)=>{const g=[],f=t.filter(A=>!o.has(de(A))&&!n.has(de(A))&&(s[de(A)]??0)<1),x=Ii(f,A=>s[de(A)]??0);for(const A of x){if(g.length>=i)break;g.push(A),o.add(de(A))}if(g.length<i){const A=ka(t.filter(N=>!o.has(de(N))&&n.has(de(N))));for(const N of A){if(g.length>=i)break;g.push(N),o.add(de(N))}}return g},$i=(t,s,n,i)=>on(t,s,n,i,new Set),ws=(t,s,n,i,o,g)=>{const f=Math.max(1,n.stackSize??s),A=ka(t).filter((S,ae,J)=>J.findIndex(W=>de(W)===de(S))===ae),N=$i(A,i,o,f),l=new Set,b=new Set,c=Ua(N,{},null,l,b),u=c?[c]:[];return c&&b.add(de(c)),{queue:u,meta:{pool:A,active:N,knownessMap:i,unknownSet:o,outcomesById:g,asked:l,queued:b}}},us={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,s)=>{const i=ka(t).filter((o,g,f)=>f.findIndex(x=>de(x)===de(o))===g);return{queue:i.slice(0,Math.min(s,i.length)),meta:{}}},applyOutcome:t=>t},js=(t,s,n,i)=>{const o=Math.max(1,n.stackSize??s),f=ka(t).filter((ae,J,W)=>W.findIndex(k=>de(k)===de(ae))===J),x={},A=new Set,N=new Set,l=new Set,b=Math.max(1,n.levels??1);f.forEach(ae=>{const J=de(ae),W=i==null?void 0:i[J],k=typeof W=="number"&&Number.isFinite(W)?W:1;x[J]=Math.min(b,Math.max(1,Math.round(k)))});const c=[];if(f.length>0){const ae=new Map;f.forEach(W=>{var m;const k=x[de(W)]??1;ae.has(k)||ae.set(k,[]),(m=ae.get(k))==null||m.push(W)});const J=Array.from(ae.keys()).sort((W,k)=>W-k);for(const W of J){if(c.length>=o)break;const k=ka(ae.get(W)??[]);for(const m of k){if(c.length>=o)break;c.push(m)}}}const u=Ua(c,x,null,A,N),S=u?[u]:[];return u&&N.add(de(u)),{queue:S,meta:{pool:f,active:c,levelMap:x,asked:A,queued:N,wrongSinceCorrect:l}}},Ri={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,s)=>Math.max(1,s.stackSize??t),getProgressTotal:()=>null,prepare:(t,s,n)=>js(t,s,n),applyOutcome:(t,s,n,i,o)=>{if(!s)return t;const g=Math.max(1,i.levels??1),f=t.meta.pool??[],x=t.meta.active??[],A={...t.meta.levelMap??{}},N=new Set(t.meta.asked??[]),l=new Set(t.meta.queued??[]),b=new Set(t.meta.wrongSinceCorrect??[]),c=de(s);l.delete(c),N.add(c);const u=A[c]??1;o.correct?(A[c]=b.has(c)?1:Math.min(u+1,g),b.delete(c)):(A[c]=1,b.add(c));const S=o.correct?x.filter(W=>de(W)!==c):x.slice();if(o.correct&&S.length<Math.max(1,i.stackSize??1)){const W=new Set(S.map(m=>de(m))),k=Li(f,A,W,N,c);k&&S.push(k)}const ae=t.queue.slice(),J=Ua(S,A,c,N,l);return J&&(ae.push(J),l.add(de(J))),{queue:ae,meta:{pool:f,active:S,levelMap:A,asked:N,queued:l,wrongSinceCorrect:b}}}},Ei={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,s)=>Math.max(1,s.stackSize??t),getProgressTotal:()=>null,prepare:(t,s,n)=>ws(t,s,n,{},new Set,{}),applyOutcome:(t,s,n,i,o)=>{if(!s)return t;const g=t.meta.pool??[],f=t.meta.active??[],x={...t.meta.knownessMap??{}},A=new Set(t.meta.unknownSet??[]),N={...t.meta.outcomesById??{}},l=new Set(t.meta.asked??[]),b=new Set(t.meta.queued??[]),c=de(s);b.delete(c),l.add(c);const u={correctness:Math.max(0,Math.min(1,o.correctness??(o.correct?1:0))),createdUtc:o.createdUtc??new Date().toISOString()},ae=(N[c]??[]).concat(u).sort((P,p)=>P.createdUtc.localeCompare(p.createdUtc)).slice(-5);N[c]=ae,A.delete(c);const J=Date.now();g.forEach(P=>{const p=de(P),H=N[p]??[];if(H.length===0){x[p]=0,A.add(p);return}const R=qa(H,J);x[p]=R.knowness});const W=f.slice();if((x[c]??0)>=1){const P=W.filter(p=>de(p)!==c);W.length=0,W.push(...P)}const m=Math.max(1,i.stackSize??n);if(W.length<m){const P=new Set(W.map(H=>de(H))),p=on(g,x,A,m-W.length,P);W.push(...p)}const ce=t.queue.slice();if(ce.length===0||de(ce[ce.length-1])===c){const P=Ua(W,{},c,l,b);P&&(ce.push(P),b.add(de(P)))}return{queue:ce,meta:{pool:g,active:W,knownessMap:x,unknownSet:A,outcomesById:N,asked:l,queued:b}}}},cn={random:us,levels:Ri,temporal:Ei},Ai=Object.values(cn),ks=t=>{if(!t)return us;const s=t.trim().toLowerCase();return s==="random"||s==="levels"||s==="temporal"?cn[s]:us},Wa=(t,s)=>{const n={...t.defaultSettings};return s&&Object.entries(s).forEach(([i,o])=>{typeof o=="number"&&Number.isFinite(o)&&(n[i]=o),typeof o=="string"&&(n[i]=o)}),t.settingsFields.forEach(i=>{var g;const o=n[i.key];if(i.type==="number"){if(typeof o!="number"||Number.isNaN(o)){n[i.key]=t.defaultSettings[i.key]??0;return}i.min!==void 0&&(n[i.key]=Math.max(i.min,n[i.key])),i.max!==void 0&&(n[i.key]=Math.min(i.max,n[i.key]));return}if(i.type==="select"){const f=((g=i.options)==null?void 0:g.map(x=>x.value))??[];(typeof o!="string"||f.length>0&&!f.includes(o))&&(n[i.key]=t.defaultSettings[i.key]??f[0]??"")}}),n},ln=(t,s)=>{const n={};return t.settingsFields.forEach(i=>{const o=s.get(i.key);if(o){if(i.type==="number"){const g=Number(o);Number.isNaN(g)||(n[i.key]=g);return}n[i.key]=o}}),Wa(t,n)},Pi=(t,s)=>{const n=new URLSearchParams;return t.settingsFields.forEach(i=>{const o=s[i.key];(typeof o=="number"||typeof o=="string")&&n.set(i.key,String(o))}),n};function Fi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,libraryId:l,collectionId:b,revisionId:c}){const{libraryName:u}=Wt(l),S=`/#/cogita/library/${l}`,[ae,J]=a.useState(t.cogita.library.collections.defaultName),[W,k]=a.useState(""),[m,ce]=a.useState(20),[P,p]=a.useState("random"),[H,R]=a.useState({}),[X,L]=a.useState("exact"),[E,se]=a.useState([]),[ie,re]=a.useState(null),[De,he]=a.useState([]),[T,be]=a.useState("idle"),[y,V]=a.useState(null),[me,Y]=a.useState("idle"),[F,we]=a.useState("idle"),[Ne,Te]=a.useState("idle"),Fe=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),Ie=a.useMemo(()=>ks(P),[P]),_e=a.useMemo(()=>Wa(Ie,H),[Ie,H]),Be=a.useMemo(()=>Pi(Ie,_e).toString(),[Ie,_e]);a.useEffect(()=>{Oa(l,b).then(xe=>J(xe.name)).catch(()=>J(t.cogita.library.collections.defaultName))},[l,b]),a.useEffect(()=>{c&&En({libraryId:l,collectionId:b,revisionId:c}).then(xe=>{k(xe.name),p(xe.mode||"random"),L(xe.check||"exact"),ce(xe.limit||20),R(xe.revisionSettings??{})}).catch(()=>{k("")})},[b,l,c]),a.useEffect(()=>{sn({libraryId:l}).then(xe=>{se(xe),!ie&&xe.length>0&&re(xe[0].roleId)}).catch(()=>{se([])})},[l]);const Le=()=>{we("loading"),tn({libraryId:l}).then(xe=>{he(xe),we("idle")}).catch(()=>{he([]),we("error")})};a.useEffect(()=>{Le()},[l]);const qe=async()=>{be("working"),Y("idle");try{const xe=await Pn({libraryId:l,collectionId:b,revisionType:Ie.id,revisionSettings:_e,mode:P,check:X,limit:m});V(`${Fe}/${xe.shareCode}${Be?`?${Be}`:""}`),be("ready"),Le()}catch{be("error")}},et=async()=>{if(c){Te("saving");try{await An({libraryId:l,collectionId:b,revisionId:c,name:W||ae,revisionType:Ie.id,revisionSettings:_e,mode:P,check:X,limit:m}),Te("saved")}catch{Te("error")}}},Ge=async()=>{if(y)try{await navigator.clipboard.writeText(y),Y("copied")}catch{Y("failed")}},Ee=async xe=>{try{await an({libraryId:l,shareId:xe}),Le()}catch{Le()}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:ae}),e.jsx("p",{className:"cogita-library-subtitle",children:u})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:S,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${S}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${S}/collections/${b}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${S}/collections/${b}/revision/run?mode=${encodeURIComponent(P)}&check=${encodeURIComponent(X)}&limit=${m}${Be?`&${Be}`:""}${ie?`&reviewer=${encodeURIComponent(ie)}`:""}${c?`&revisionId=${encodeURIComponent(c)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:W,onChange:xe=>k(xe.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:P,onChange:xe=>p(xe.target.value),children:Ai.map(xe=>e.jsx("option",{value:xe.id,children:t.cogita.library.revision[xe.labelKey]},xe.id))})]}),Ie.settingsFields.map(xe=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[xe.labelKey]}),xe.type==="select"?e.jsx("select",{value:String(_e[xe.key]??""),onChange:G=>R(fe=>({...fe,[xe.key]:G.target.value})),children:(xe.options??[]).map(G=>e.jsx("option",{value:G.value,children:t.cogita.library.revision[G.labelKey]},G.value))}):e.jsx("input",{type:"number",min:xe.min,max:xe.max,step:xe.step,value:_e[xe.key]??0,onChange:G=>R(fe=>({...fe,[xe.key]:Number(G.target.value||0)}))})]},xe.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),Ie.id!=="levels"&&Ie.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:m,onChange:xe=>ce(Number(xe.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:ie??"",onChange:xe=>re(xe.target.value||null),children:E.map(xe=>e.jsx("option",{value:xe.roleId,children:xe.label},xe.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[c?e.jsx("button",{type:"button",className:"cta ghost",onClick:et,disabled:Ne==="saving",children:Ne==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${S}/collections/${b}/revision/run?mode=${encodeURIComponent(P)}&check=${encodeURIComponent(X)}&limit=${m}${Be?`&${Be}`:""}${ie?`&reviewer=${encodeURIComponent(ie)}`:""}${c?`&revisionId=${encodeURIComponent(c)}`:""}`,children:t.cogita.library.actions.startRevision})]}),Ne==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),y?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:y,readOnly:!0})]}):null,T==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,me==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):me==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:qe,disabled:T==="working",children:T==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),y?e.jsx("button",{type:"button",className:"cta ghost",onClick:Ge,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),F==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):De.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:De.map(xe=>e.jsxs("div",{className:"cogita-share-row","data-state":xe.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:xe.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(xe.createdUtc).toLocaleString(),xe.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),xe.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ee(xe.shareId),children:t.cogita.library.revision.shareRevokeAction})]},xe.shareId))})]})]})]})]})})})]})})}const ss=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function dn(t,s,n){if(!t)return null;const i=new Map(t.nodes.map(P=>[P.id,P])),o=new Map,g=new Set,f=P=>{if(typeof P=="number")return P;if(typeof P=="string"){const p=Number(P);return Number.isFinite(p)?p:0}return 0},x=P=>{if(o.has(P))return o.get(P);if(g.has(P))return 0;const p=i.get(P);if(!p)return 0;g.add(P);const H=X=>{var E,se;return(X?((E=p.inputsByHandle)==null?void 0:E[X])??[]:p.inputs??((se=p.inputsByHandle)==null?void 0:se.in)??[]).map(ie=>x(ie))};let R=0;switch(p.type){case"input.random":{const X=p.min??0,L=p.max??X+10,E=Math.min(X,L),se=Math.max(X,L);R=Math.floor(Math.random()*(se-E+1))+E;break}case"input.const":{R=p.value??0;break}case"input.list":{const X=(p.list??[]).filter(Boolean),L=Math.round(f(H("index")[0]));R=X.length?X[Math.max(0,Math.min(X.length-1,L))]:String(L);break}case"compute.add":{R=H("in").map(L=>f(L)).reduce((L,E)=>L+E,0);break}case"compute.sub":{const X=H("add").map(E=>f(E)),L=H("sub").map(E=>f(E));R=X.reduce((E,se)=>E+se,0)-L.reduce((E,se)=>E+se,0);break}case"compute.mul":{const X=H("in").map(L=>f(L));R=X.length?X.reduce((L,E)=>L*E,1):0;break}case"compute.div":{const X=f(H("num")[0]),L=H("den").map(E=>f(E)).reduce((E,se)=>E+se,0);R=Math.abs(L)<Number.EPSILON?0:X/L;break}case"compute.pow":{const X=f(H("base")[0]),L=f(H("exp")[0]);R=Math.pow(X,L);break}case"compute.exp":{const X=f(H("base")[0]),L=f(H("exp")[0]);R=Math.pow(X,L);break}case"compute.log":{const X=f(H("value")[0]),L=f(H("base")[0]),E=Math.max(X,Number.EPSILON);R=Math.abs(L)<Number.EPSILON?Math.log(E):Math.log(E)/Math.log(L);break}case"compute.abs":{R=Math.abs(f(H("in")[0]));break}case"compute.min":{const X=H("in").map(L=>f(L));R=X.length?Math.min(...X):0;break}case"compute.max":{const X=H("in").map(L=>f(L));R=X.length?Math.max(...X):0;break}case"compute.floor":{R=Math.floor(f(H("in")[0]));break}case"compute.ceil":{R=Math.ceil(f(H("in")[0]));break}case"compute.round":{R=Math.round(f(H("in")[0]));break}case"compute.mod":{const X=f(H("a")[0]),L=f(H("b")[0]);R=Math.abs(L)<Number.EPSILON?0:X%L;break}case"compute.concat":{const L=["in1","in2","in3","in4","in5","in6"].flatMap(re=>H(re)),E=L.length?L:H("in");R=(E.length?E:H()).map(re=>re==null?"":String(re)).join("");break}case"compute.trim":{const X=H("text")[0]??H("in")[0]??"",L=X==null?"":String(X),E=Math.max(0,Math.round(f(H("start")[0]))),se=Math.max(0,Math.round(f(H("end")[0])));E+se>=L.length?R="":R=L.substring(E,L.length-se);break}case"output":{R=H("in")[0]??0;break}default:R=0}return g.delete(P),o.set(P,R),R},A=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(P=>P.type==="output").map(P=>P.id);t.nodes.forEach(P=>x(P.id)),A.forEach(P=>x(P));const N=P=>Math.abs(P%1)<1e-5?String(Math.round(P)):P.toFixed(3).replace(/\.?0+$/,""),l=P=>typeof P=="number"?N(P):P??"",b=new Map;A.forEach(P=>{var L,E,se,ie;const p=i.get(P);if(!p)return;const H=(E=(L=p.inputsByHandle)==null?void 0:L.name)==null?void 0:E[0],R=H?l(o.get(H)):"",X=(R==null?void 0:R.toString().trim())||((se=p.outputLabel)==null?void 0:se.trim())||((ie=p.name)==null?void 0:ie.trim())||P;b.set(P,X)});const c={},u={},S={};A.forEach(P=>{var R,X;const p=i.get(P);if(!p)return;const H=b.get(P)??(((R=p.outputLabel)==null?void 0:R.trim())||((X=p.name)==null?void 0:X.trim())||P);c[H]=l(o.get(P)),p.name&&(u[p.name.trim()]=H),u[P]=H});const ae=(P,p)=>{let H=P;return t.nodes.forEach(R=>{var ie,re;const X=l(o.get(R.id)),L=A.includes(R.id),E=L?b.get(R.id)??((ie=R.outputLabel)==null?void 0:ie.trim())??((re=R.name)==null?void 0:re.trim())??R.id:"",se=L&&p?E:X;H=H.replace(new RegExp(`\\{\\s*${ss(R.id)}\\s*\\}`,"gi"),se),R.name&&(H=H.replace(new RegExp(`\\{\\s*${ss(R.name)}\\s*\\}`,"gi"),se)),L&&R.outputLabel&&(H=H.replace(new RegExp(`\\{\\s*${ss(R.outputLabel)}\\s*\\}`,"gi"),E))}),H},J=s;let W=J.trim().length>0?J:"";W||(W=A.length?`Compute ${A.join(", ")}`:"Compute"),W=ae(W,!0);const k=(n==null?void 0:n.trim())??"",m=k?ae(k,!1):"",ce={};return o.forEach((P,p)=>{ce[p]=P,S[p]=l(P);const H=i.get(p);H!=null&&H.name&&(S[H.name.trim()]=l(P))}),{prompt:W,answers:c,values:ce,answerText:m,outputVariables:u,variableValues:S}}function un(t){var n;const s=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((n=s[0])==null?void 0:n[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const ns=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function hn({outcomes:t}){const[s,n]=a.useState("day"),i=a.useMemo(()=>{const o=ns.find(x=>x.id===s)??ns[1],g=Date.now()-o.ms,f=t.filter(x=>new Date(x.createdUtc).getTime()>=g);return Ot(f)},[t,s]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:ns.map(o=>e.jsx("button",{type:"button",className:"ghost","data-active":s===o.id,onClick:()=>n(o.id),children:o.label},o.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[i.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[i.correct," / ",i.total]})]})}const Ki="cogita-revision",zi=1,Pa="outcomes",Bi=()=>new Promise((t,s)=>{const n=indexedDB.open(Ki,zi);n.onupgradeneeded=()=>{const i=n.result;if(!i.objectStoreNames.contains(Pa)){const o=i.createObjectStore(Pa,{keyPath:"id"});o.createIndex("byItem","itemKey",{unique:!1}),o.createIndex("byPending","pending",{unique:!1})}},n.onerror=()=>s(n.error),n.onsuccess=()=>t(n.result)}),Sa=async(t,s)=>{const n=await Bi();return new Promise((i,o)=>{const g=n.transaction(Pa,t),f=g.objectStore(Pa);s(f).then(i).catch(o),g.onerror=()=>o(g.error)})},gn=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const s=Array.from(t).map(n=>n.toString(16).padStart(2,"0"));return`${s.slice(0,4).join("")}-${s.slice(4,6).join("")}-${s.slice(6,8).join("")}-${s.slice(8,10).join("")}-${s.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},Di=()=>{const t="cogita_revision_client_id",s=localStorage.getItem(t);if(s)return s;const n=gn();return localStorage.setItem(t,n),n},_i=()=>{const t="cogita_revision_client_seq",s=Number(localStorage.getItem(t)??"0"),n=Number.isFinite(s)?s+1:1;return localStorage.setItem(t,String(n)),n},mn=(t,s,n,i)=>Vt(t,s,n,i),Fa=async t=>{const s=Di(),n=_i(),i=new Date().toISOString(),o={...t,clientId:s,clientSequence:n,createdUtc:i,id:gn(),pending:!0};return await Sa("readwrite",g=>new Promise((f,x)=>{const A={...o,itemKey:mn(o.itemType,o.itemId,o.checkType,o.direction)},N=g.add(A);N.onsuccess=()=>f(),N.onerror=()=>x(N.error)})),o},Ka=async(t,s,n,i)=>{if(!s)return[];try{const o=mn(t,s,n,i);return await Sa("readonly",g=>new Promise((f,x)=>{const N=g.index("byItem").getAll(o);N.onsuccess=()=>{const b=(N.result??[]).map(c=>({itemType:c.itemType,itemId:c.itemId,checkType:c.checkType??null,direction:c.direction??null,revisionType:c.revisionType,evalType:c.evalType,correct:c.correct,createdUtc:c.createdUtc,maskBase64:c.maskBase64,payloadBase64:c.payloadBase64,payloadHashBase64:c.payloadHashBase64,clientId:c.clientId,clientSequence:c.clientSequence,personRoleId:c.personRoleId??null})).sort((c,u)=>c.createdUtc.localeCompare(u.createdUtc));f(b)},N.onerror=()=>x(N.error)}))}catch{return[]}},qt=async()=>{try{return await Sa("readonly",t=>new Promise((s,n)=>{const i=t.getAll();i.onsuccess=()=>{const g=(i.result??[]).map(f=>({itemType:f.itemType,itemId:f.itemId,checkType:f.checkType??null,direction:f.direction??null,revisionType:f.revisionType,evalType:f.evalType,correct:f.correct,createdUtc:f.createdUtc,maskBase64:f.maskBase64,payloadBase64:f.payloadBase64,payloadHashBase64:f.payloadHashBase64,clientId:f.clientId,clientSequence:f.clientSequence,personRoleId:f.personRoleId??null}));s(g)},i.onerror=()=>n(i.error)}))}catch{return[]}},Vi=async(t=100)=>{try{return await Sa("readonly",s=>new Promise((n,i)=>{const g=s.index("byPending").getAll(!0);g.onsuccess=()=>{const f=g.result??[];n(f.slice(0,t))},g.onerror=()=>i(g.error)}))}catch{return[]}},Oi=async t=>{if(t.length!==0)try{await Sa("readwrite",s=>new Promise((n,i)=>{let o=t.length;t.forEach(g=>{const f=s.get(g);f.onsuccess=()=>{const x=f.result;if(x){x.pending=!1;const A=s.put(x);A.onsuccess=()=>{o-=1,o===0&&n()},A.onerror=()=>i(A.error)}else o-=1,o===0&&n()},f.onerror=()=>i(f.error)})}))}catch{}},is=async(t,s)=>{const n=await Vi(200);if(n.length===0)return;const i=new Map;n.forEach(o=>{var f;const g=o.personRoleId??s??"";i.has(g)||i.set(g,[]),(f=i.get(g))==null||f.push(o)});for(const[o,g]of i.entries()){const f=g.map(x=>({itemType:x.itemType,itemId:x.itemId,checkType:x.checkType??null,direction:x.direction??null,revisionType:x.revisionType,evalType:x.evalType,correct:x.correct,clientId:x.clientId,clientSequence:x.clientSequence,maskBase64:x.maskBase64??null,payloadHashBase64:x.payloadHashBase64??null,payloadBase64:x.payloadBase64??null,personRoleId:o||null}));try{await Fn({libraryId:t,outcomes:f}),await Oi(g.map(x=>x.id))}catch{}}},_s={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},qi=(t,s)=>{const n=Math.max(t.length,s.length,1),i=Math.abs(t.length-s.length);return Math.max(0,1-i/n)},Ui=(t,s)=>{const n=new Uint8Array(t.length),i=qi(t,s);for(let o=0;o<t.length;o+=1){const g=t[o]===(s[o]??"")?128:0,f=t.length-1-o,x=s.length-1-o,A=t[f]===(s[x]??"")?127:0,N=Math.round((g+A)*i);n[o]=Math.max(0,Math.min(255,N))}return n},La=(t,s)=>t===s||(_s[t]??[]).includes(s)?!0:(_s[s]??[]).includes(t),za=(t,s)=>{const n=new Uint8Array(t.length);if(!t.length)return n;const i=[];for(let g=0;g<=t.length-3;g+=1)i.push({index:g,text:t.slice(g,g+3)});let o=!1;return i.forEach(g=>{for(let f=0;f<=s.length-3;f+=1){const x=s.slice(f,f+3);let A=0;for(let u=0;u<3;u+=1)La(g.text[u],x[u])&&(A+=1);if(A<2)continue;let N=g.index-1,l=f-1;for(;N>=0&&l>=0;){const u=t[N],S=s[l];if(u===S){n[N]=Math.max(n[N],255),N-=1,l-=1,o=!0;continue}if(La(u,S)){n[N]=Math.max(n[N],127),N-=1,l-=1,o=!0;continue}if(N>0&&t[N-1]===S){n[N]=Math.max(n[N],0),N-=1,o=!0;continue}if(l>0&&t[N]===s[l-1]){l-=1,o=!0;continue}break}for(let u=0;u<3;u+=1){const S=g.index+u,ae=g.text[u],J=x[u],W=ae===J?255:La(ae,J)?127:0;n[S]=Math.max(n[S],W),o=!0}let b=g.index+3,c=f+3;for(;b<t.length&&c<s.length;){const u=t[b],S=s[c];if(u===S){n[b]=Math.max(n[b],255),b+=1,c+=1,o=!0;continue}if(La(u,S)){n[b]=Math.max(n[b],127),b+=1,c+=1,o=!0;continue}if(b+1<t.length&&t[b+1]===S){n[b]=Math.max(n[b],0),b+=1,o=!0;continue}if(c+1<s.length&&t[b]===s[c+1]){c+=1,o=!0;continue}break}}}),o?n:Ui(t,s)},pa=(t,s,n)=>{const i=t.trim().toLowerCase(),o=s.trim().toLowerCase();return za(i,o)},fa=t=>t.trim().toLowerCase().replace(/[^\p{L}\p{N}]+/gu,""),pn=(t,s,n)=>{const i=fa(t),o=fa(s);return za(i,o)},St=t=>t.trim().toLowerCase(),Wi=t=>t==="reverse"?"reverse":"forward",Na=(t,s)=>`${t}|${s}`,It=t=>{if(!t)return null;const[s,n]=t.split("|",2);return(s==="forward"||s==="reverse")&&n?{mode:s,fragmentId:n}:{mode:"forward",fragmentId:t}},Ba=(t,s)=>{var i;const n=It(s);return n?n.fragmentId&&s?(t??null)===s:(((i=It(t))==null?void 0:i.mode)??"forward")===n.mode:!0},mt=t=>{const s=t==null?void 0:t.trim().toLowerCase();return s||null},fn=(t,s)=>{if((mt(t.childItemType)??"info")!==(s.cardType??"").toLowerCase()||t.childItemId!==s.cardId)return!1;const i=mt(t.childCheckType),o=mt(t.childDirection),g=mt(s.checkType),f=mt(s.direction);return!(i&&i!==g||o&&o!==f)},Hi={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},Qi={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},Da=(t,s,n)=>{if(!n||!s.startsWith(t))return s;const i=s.slice(t.length);if(!i)return s;const o=n==="super"?Hi:Qi,g=i.split("").map(f=>o[f]??f).join("");return t+g},_a=(t,s,n)=>{var f,x,A;if(!t)return((f=s[0])==null?void 0:f.key)??null;const i=new Set(s.map(N=>N.key)),o=/\{([^}]+)\}/g;let g;for(;(g=o.exec(t))!==null;){const N=((x=g[1])==null?void 0:x.trim())??"";if(!N)continue;if(i.has(N))return N;const l=n==null?void 0:n[N];if(l&&i.has(l))return l}return((A=s[0])==null?void 0:A.key)??null},hs=t=>t.flatMap(s=>{if(s.cardType!=="info"||s.infoType!=="citation")return[s];const n=s.description??"";if(!n.trim())return[s];const i=It(s.direction),o=(i==null?void 0:i.mode)??Wi(s.direction),g=ia(n),f=Object.keys(g.nodes);return f.length===0?[s]:f.map(x=>({...s,checkType:"quote-fragment",direction:Na(o,x)}))});function Yi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,libraryId:l,collectionId:b,revisionId:c}){const u=Va(),S=`/#/cogita/library/${l}`,ae=a.useMemo(()=>new URLSearchParams(u.search),[u.search]),J=Math.max(1,Number(ae.get("limit")??20)),W=ae.get("mode")??"random",k=a.useMemo(()=>ks(W),[W]),m=a.useMemo(()=>Wa(k,ln(k,ae)),[k,ae]),ce=ae.get("check")??"exact",P=ae.get("reviewer"),p=a.useMemo(()=>t.cogita.library.revision[k.labelKey]??W,[t,W,k]),H=a.useMemo(()=>ce==="exact"?t.cogita.library.revision.checkValue:ce,[t,ce]),[R,X]=a.useState(t.cogita.library.collections.defaultName),[L,E]=a.useState([]),[se,ie]=a.useState([]),[re,De]=a.useState("idle"),[he,T]=a.useState({current:0,total:0}),[be,y]=a.useState(0),[V,me]=a.useState(""),[Y,F]=a.useState(null),[we,Ne]=a.useState(null),[Te,Fe]=a.useState(null),[Ie,_e]=a.useState(null),[Be,Le]=a.useState([]),[qe,et]=a.useState({}),[Ge,Ee]=a.useState({}),[xe,G]=a.useState(null),[fe,oe]=a.useState(null),[ye,Ke]=a.useState(null),[Je,Ve]=a.useState(null),[$,q]=a.useState(null),[je,M]=a.useState({}),K=a.useRef(0),[ue,pe]=a.useState(null),Q=a.useRef(null),Ce=a.useRef(null),[ke,ze]=a.useState(null),[Re,Pe]=a.useState(!1),[Me,ct]=a.useState(null),[Ue,Xe]=a.useState([]),[lt,yt]=a.useState(null),We=a.useRef(null),He=a.useRef(null),[Ct,dt]=a.useState(null),[Lt,ot]=a.useState(0),it=a.useRef(null),$t=a.useRef({}),[xt,tt]=a.useState(!1),[at,Et]=a.useState({}),[Rt,Ze]=a.useState([]),gt=a.useRef(new Map),[pt,wt]=a.useState(new Set),[_,te]=a.useState(!1),Se=a.useRef(null),d=a.useRef(new Set),ve=a.useRef({}),O=L[be]??null,Z=(O==null?void 0:O.checkType)==="translation-match"&&$,ut=a.useRef(new Map),nt=a.useRef(new Map),bt=a.useRef(new Map),ft=a.useRef(new Map),Mt=a.useMemo(()=>O?O.cardType==="vocab"?t.cogita.library.revision.vocabLabel:O.infoType?Ye(t,O.infoType):t.cogita.library.revision.infoLabel:"",[t,O]),ra=a.useMemo(()=>{var h;return k.id!=="levels"?L.length:((h=at.pool)==null?void 0:h.length)??k.getFetchLimit(J,m)},[at,m,k,L.length,J]),Ht=k.getProgressTotal?k.getProgressTotal(L,at,J,m):k.id==="levels"?Math.min(J,ra):L.length,Bt=Ht?Math.min(be+1,Ht):0,jt=Math.max(1,Number(m.tries??1)),vt=m.compare??"anchors",Dt=Math.max(0,Math.min(100,Number(m.minCorrectness??0))),st=(m.considerDependencies??"on")==="on",rt=Math.max(0,Math.min(100,Number(m.dependencyThreshold??85))),Ft=r=>{const h=r.slice();for(let j=h.length-1;j>0;j-=1){const v=Math.floor(Math.random()*(j+1));[h[j],h[v]]=[h[v],h[j]]}return h},Jt=r=>r.length?r.reduce((j,v)=>j+v,0)/r.length/255*100:0,Qt=r=>Jt(r)>=Dt,oa=async()=>{const r=await qt(),h=new Map,j=new Map,v=new Map;r.forEach(I=>{const B=`${I.itemType}:${I.itemId}`,ee=Vt(I.itemType,I.itemId,I.checkType,I.direction);if(h.has(B)||h.set(B,[]),h.get(B).push(I),j.has(ee)||j.set(ee,[]),j.get(ee).push(I),I.itemType==="info"&&I.checkType==="quote-fragment"&&I.direction){const ne=`${I.itemId}:${I.direction}`;v.has(ne)||v.set(ne,[]),v.get(ne).push(I)}});const D=new Map,w=new Map,z=new Map;return h.forEach((I,B)=>D.set(B,Ot(I).score)),j.forEach((I,B)=>w.set(B,Ot(I).score)),v.forEach((I,B)=>z.set(B,Ot(I).score)),{itemKnowness:D,cardKnowness:w,fragmentKnowness:z}},Ha=async r=>{const h=[];let j=null;for(;;){const v=await Ra({libraryId:l,collectionId:r,limit:200,cursor:j});if(h.push(...v.items),!v.nextCursor)break;j=v.nextCursor}return hs(h)},ba=async(r,h)=>{if(gt.current.has(r))return gt.current.get(r)??0;const j=await Ha(r);if(j.length===0)return gt.current.set(r,0),0;const D=j.reduce((w,z)=>{const I=de(z);return w+(h.get(I)??0)},0)/j.length;return gt.current.set(r,D),D},Qa=(r,h)=>{if(!st||r.cardType!=="info"||r.infoType!=="citation"||r.checkType!=="quote-fragment")return!0;const j=It(r.direction);if(!(j!=null&&j.fragmentId))return!0;const v=r.description??"";if(!v.trim())return!0;const w=ia(v).nodes[j.fragmentId];if(!w||!w.leftId&&!w.rightId)return!0;const z=[w.leftId,w.rightId].filter(ee=>!!ee);if(z.length===0)return!0;const I=z.map(ee=>{const ne=Vt("info",r.cardId,"quote-fragment",Na(j.mode,ee));return h.get(ne)??0});return I.reduce((ee,ne)=>ee+ne,0)/I.length>=rt},ca=async r=>{const h=at,j=r.concat(h.active??[]).concat(h.pool??[]).filter((I,B,ee)=>ee.findIndex(ne=>de(ne)===de(I))===B);if(!st){wt(new Set(j.map(de)));return}const{itemKnowness:v,cardKnowness:D}=await oa(),w=Rt.filter(I=>mt(I.childItemType)==="collection"&&I.childItemId===b&&!mt(I.childCheckType)&&!mt(I.childDirection)),z=new Set;for(const I of j){if(I.cardType!=="info"){z.add(de(I));continue}if(!Qa(I,D))continue;const B=Rt.filter(ge=>fn(ge,I)).concat(w);if(B.length===0){z.add(de(I));continue}let ee=0;for(const ge of B)if(mt(ge.parentItemType)==="collection")ee+=await ba(ge.parentItemId,D);else if(mt(ge.parentCheckType)||mt(ge.parentDirection)){const le=mt(ge.parentCheckType),$e=mt(ge.parentDirection),Ae=Vt(ge.parentItemType,ge.parentItemId,le,$e);ee+=D.get(Ae)??0}else{const le=`${ge.parentItemType}:${ge.parentItemId}`;ee+=v.get(le)??0}ee/B.length>=rt&&z.add(de(I))}wt(z)},Ya=r=>{for(let h=r;h<L.length;h+=1){const j=L[h];if(j&&(!st||j.cardType!=="info"||pt.has(de(j))))return h}return-1},At=r=>!st||r.cardType!=="info"||pt.has(de(r)),la=r=>{if(k.id!=="temporal"&&k.id!=="levels")return null;const h=at,j=(h.active??[]).concat(h.pool??[]),v=new Set;for(const D of j){const w=de(D);if(!(v.has(w)||r.has(w))&&(v.add(w),At(D)))return D}return null},Kt=a.useMemo(()=>{if(k.id!=="levels")return null;const r=at,h=r.pool??[],j=r.active??[],v=r.levelMap??{},D=Math.max(1,Number(m.levels??1)),w=Array.from({length:D},()=>0),z=new Set(j.map(ne=>de(ne)));h.forEach(ne=>{const ge=Math.min(D,Math.max(1,v[de(ne)]??1));w[ge-1]+=1});const I=h.length||1,B=w.map(ne=>ne/I*100),ee=O?v[de(O)]??1:null;return{counts:w,percentages:B,currentLevel:ee,levelsCount:D,activeCount:j.length,poolCount:h.length,activeSet:z}},[at,m,k,O]),kt=a.useMemo(()=>{if(k.id!=="temporal")return null;const r=at,h=r.pool??[],j=r.active??[],v=r.knownessMap??{},D=new Set(r.unknownSet??[]);let w=0;h.forEach(B=>{(v[de(B)]??0)>1&&(w+=1)});const z=D.size,I=j.map(B=>({id:de(B),value:D.has(de(B))?0:Math.max(0,Math.min(1,v[de(B)]??0))}));return{knownCount:w,unknownCount:z,dots:I}},[at,k]),da=a.useMemo(()=>{if(!st)return 0;const r=at;return L.concat(r.active??[]).concat(r.pool??[]).filter((j,v,D)=>D.findIndex(w=>de(w)===de(j))===v).filter(j=>j.cardType==="info"&&!pt.has(de(j))).length},[st,at,L,pt]);a.useEffect(()=>{if(!st||re!=="ready")return;const r=at,j=L.concat(r.active??[]).concat(r.pool??[]).filter((w,z,I)=>I.findIndex(B=>de(B)===de(w))===z).filter(w=>w.cardType!=="info"||pt.has(de(w))).length,v=We.current;if(We.current=j,v===null||j<=v)return;const D=j-v;yt(`New card available (+${D})`),He.current&&window.clearTimeout(He.current),He.current=window.setTimeout(()=>yt(null),2200)},[st,re,at,L,pt]),a.useEffect(()=>()=>{He.current&&window.clearTimeout(He.current)},[]);const Nt=(r,h)=>{const j=k.applyOutcome({queue:L,meta:at},O,J,m,{correct:r,correctness:h,createdUtc:new Date().toISOString()});E(j.queue),Et(j.meta);const v=j.queue[be+1];v&&ya(v,be+1)};a.useEffect(()=>{Oa(l,b).then(r=>X(r.name)).catch(()=>X(t.cogita.library.collections.defaultName))},[l,b]),a.useEffect(()=>{bs({libraryId:l,type:"language"}).then(r=>ie(r)).catch(()=>ie([]))},[l]),a.useEffect(()=>{fs({libraryId:l}).then(r=>Ze(r.items??[])).catch(()=>Ze([]))},[l]),a.useEffect(()=>{is(l,P)},[l,P]),a.useEffect(()=>{ca(L)},[L,Rt,st,rt,b]),a.useEffect(()=>{if(!O||!st){te(!1);return}if(O.cardType!=="info"||pt.has(de(O))){te(!1);return}const r=Ya(be+1);if(r>=0){te(!1),y(r);return}if(k.id==="temporal"||k.id==="levels"){const h=L.slice(0,be+1),j=L.slice(be+1).filter(At),v=h.concat(j),D=new Set(v.map(de)),w=la(D);if(w){const I=de(w);D.has(I)||(v.push(w),D.add(I),Et(B=>{const ee=B,ne=new Set(ee.queued??[]);return ne.add(I),{...ee,queued:ne}}))}const z=v.findIndex((I,B)=>B!==be&&At(I));if(z>=0){E(v),y(z),te(!1);return}}te(!0)},[O,pt,st,be,L,at,k.id]),a.useEffect(()=>{let r=!0;return(async()=>{De("loading"),T({current:0,total:k.id==="levels"?0:k.getFetchLimit(J,m)});try{const j=[];let v=null,D=null;do{const ge=await Ra({libraryId:l,collectionId:b,limit:300,cursor:v});if(j.push(...ge.items),(k.id==="levels"||k.id==="temporal")&&ge.total&&(D=ge.total),T(le=>({current:j.length,total:le.total||ge.total||k.getFetchLimit(J,m)})),v=ge.nextCursor??null,D!==null&&j.length>=D||k.id!=="levels"&&k.id!=="temporal"&&j.length>=k.getFetchLimit(J,m))break}while(v);if(!r)return;const w=hs(j);let z;if(k.id==="levels"){const ge=Math.max(1,Number(m.levels??1)),$e=(await qt()).reduce((Ae,Oe)=>{const Qe=Vt(Oe.itemType,Oe.itemId,Oe.checkType,Oe.direction);return Ae[Qe]||(Ae[Qe]=[]),Ae[Qe].push(Oe),Ae},{});z={},w.forEach(Ae=>{const Oe=de(Ae),Qe=$e[Oe]??[],ht=Qe.length>0?Ot(Qe).score:0,aa=Math.max(1,Math.min(ge,Math.ceil(ht/100*ge)));z[Oe]=aa})}let I=null,B=null,ee=null;if(k.id==="temporal"){const ge=await qt(),le=new Set(w.map(Oe=>de(Oe))),$e=ge.reduce((Oe,Qe)=>{const ht=Vt(Qe.itemType,Qe.itemId,Qe.checkType,Qe.direction);return le.has(ht)&&(Oe[ht]||(Oe[ht]=[]),Oe[ht].push(Qe)),Oe},{});I={},B=new Set,ee={};const Ae=Date.now();w.forEach(Oe=>{const Qe=de(Oe),ht=$e[Qe]??[];if(ht.length===0){I[Qe]=0,B.add(Qe),ee[Qe]=[];return}const aa=vs(ht);ee[Qe]=aa;const yn=qa(aa,Ae);I[Qe]=yn.knowness})}const ne=k.id==="levels"?js(w,J,m,z):k.id==="temporal"?ws(w,J,m,I??{},B??new Set,ee??{}):k.prepare(w,J,m);E(ne.queue),Et(ne.meta),y(0),De("ready"),T(ge=>({current:Math.min(ge.current,ge.total),total:ge.total}))}catch{r&&De("error")}})(),()=>{r=!1}},[l,b,J,m,k,P]),a.useEffect(()=>{if(me(""),F(null),dt(null),ot(0),Le([]),et({}),Ee({}),oe(null),Ke(null),Ve(null),Pe(!1),tt(!1),ze(null),q(null),M({}),!O){Ne(null),Fe(null),G(null),ct(null);return}O.cardType==="info"&&O.infoType==="computed"&&Ne(t.cogita.library.revision.loadingComputed);let r=!0;return ya(O,be).then(h=>{!r||!h||(Ne(h.prompt),Fe(h.expectedAnswer),Le(h.computedExpected),et(h.computedAnswers),G(h.computedValues),oe(h.answerTemplate),Ke(h.outputVariables),Ve(h.variableValues))}),()=>{r=!1}},[O,t]),a.useEffect(()=>{if(!O||O.cardType!=="info"||O.infoType!=="citation"){Se.current=null,d.current=new Set,_e(null);return}const r=O.description??"",h=(O.label??"").trim(),j=h.replace(/\s+/g," ").trim(),v=r.replace(/\s+/g," ").trim(),D=j&&j!==v?h:t.cogita.library.infoTypes.citation;if(!r){_e(null),Fe(null);return}const w=ia(r);Se.current=w,Ne(D);let z=!0;return oa().then(({fragmentKnowness:I})=>{if(!z)return;const B=getQuoteMode(O.direction),ee=new Set,ne={};I.forEach(($e,Ae)=>{const[Oe,Qe]=Ae.split(":",2);if(Oe!==O.cardId)return;const ht=It(Qe);if(!ht||ht.mode!==B)return;const aa=ht.fragmentId;ne[aa]=$e,$e>=rt&&ee.add(aa)}),d.current=ee,ve.current=ne;const ge=It(O.direction);if(ge!=null&&ge.fragmentId&&w.nodes[ge.fragmentId]){_t(w,ge.fragmentId,D);return}const le=ma(w,ee,ne,rt,st,O.direction);_t(w,(le==null?void 0:le.id)??null,D)}).catch(()=>{d.current=new Set,ve.current={};const I=It(O.direction);if(I!=null&&I.fragmentId&&w.nodes[I.fragmentId]){_t(w,I.fragmentId,D);return}const B=ma(w,d.current,{},rt,st,O.direction);_t(w,(B==null?void 0:B.id)??null,D)}),()=>{z=!1}},[O,t,st,rt]),a.useEffect(()=>{if(!O||O.cardType!=="vocab"||O.checkType!=="translation-match"){q(null),M({});return}const j=(at.pool??at.active??L).filter(I=>I.cardType==="vocab"&&I.checkType==="translation-match").filter((I,B,ee)=>ee.findIndex(ne=>ne.cardId===I.cardId)===B);j.some(I=>I.cardId===O.cardId)||j.unshift(O);const D=Ft(j).slice(0,6).map(I=>{const B=I.label.split("↔").map(ge=>ge.trim()).filter(Boolean);if(B.length<2)return null;const ee=`${I.cardId}:L`,ne=`${I.cardId}:R`;return{cardId:I.cardId,leftId:ee,rightId:ne,leftLabel:B[0],rightLabel:B[1]}}).filter(Boolean),w=D.map(I=>I.leftId),z=Ft(D.map(I=>I.rightId));q({pairs:D,leftOrder:w,rightOrder:z,selection:{},activeLeft:null,activeRight:null,locked:{}})},[O,L,at]),a.useEffect(()=>()=>{Q.current&&window.clearTimeout(Q.current),Ce.current&&window.clearTimeout(Ce.current)},[]);const Xt=a.useRef(null);a.useEffect(()=>{if(!O)return;const r=de(O),h=typeof document<"u"?document.activeElement:null;if(Xt.current===r&&h&&(h.tagName==="INPUT"||h.tagName==="TEXTAREA"))return;let j=0;const v=()=>{if(O){if(O.cardType==="info"&&O.infoType==="computed"){if(Be.length>0){const w=_a(fe,Be,ye),z=w?$t.current[w]:null;if(z&&(z.focus(),document.activeElement===z)){Xt.current=r;return}}if(it.current&&(it.current.focus(),document.activeElement===it.current)){Xt.current=r;return}}else if(O.cardType==="vocab"&&it.current&&(it.current.focus(),document.activeElement===it.current)){Xt.current=r;return}j<6&&(j+=1,window.setTimeout(v,40))}},D=window.setTimeout(v,40);return()=>window.clearTimeout(D)},[O,Be,fe,ye]),a.useEffect(()=>{if(!xt)return;const r=h=>{h.key==="Enter"&&(h.preventDefault(),ha())};return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)},[xt]);const Zt=r=>{Xe(r),ct(Ot(r))};a.useEffect(()=>{if(!O){ct(null),Xe([]);return}const r=O.cardType==="info"?"info":"connection";if(O.cardType==="info"&&O.infoType==="citation"){qt().then(h=>{const j=h.filter(v=>v.itemType==="info"&&v.itemId===O.cardId&&v.checkType==="quote-fragment"&&Ba(v.direction,O.direction));Zt(j)}).catch(()=>{ct(null),Xe([])});return}Ka(r,O.cardId,O.checkType,O.direction).then(h=>Zt(h)).catch(()=>{ct(null),Xe([])})},[l,O,P]);const Ta=(r,h,j,v)=>{if(r==="info"&&j==="quote-fragment"){qt().then(D=>{const w=D.filter(z=>z.itemType==="info"&&z.itemId===h&&z.checkType==="quote-fragment"&&Ba(z.direction,v));Zt(w)}).catch(()=>{ct(null),Xe([])});return}Ka(r,h,j,v).then(D=>Zt(D)).catch(()=>{ct(null),Xe([])})},Ca=(r,h,j)=>{var z;const v=((z=j.pairs.find(I=>I.leftId===r))==null?void 0:z.rightId)??null;if(!v)return j;const D=v===h;M(I=>({...I,[r]:D?"correct":"incorrect"})),Q.current&&window.clearTimeout(Q.current),Ce.current&&window.clearTimeout(Ce.current),K.current+=1;const w={kind:D?"correct":"incorrect",tick:K.current};if(pe(null),Q.current=window.setTimeout(()=>pe(w),0),Ce.current=window.setTimeout(()=>pe(null),420),D){const I={...j.locked,[r]:!0};return Object.keys(I).length>=j.pairs.length?(F("correct"),tt(!0)):F("correct"),{...j,selection:{...j.selection,[r]:h},activeLeft:null,activeRight:null,locked:I}}return F("incorrect"),{...j,activeLeft:null,activeRight:null}},ua=r=>{q(h=>!h||h.locked[r]?h:h.activeRight?Ca(r,h.activeRight,h):{...h,activeLeft:h.activeLeft===r?null:r})},zt=r=>{q(h=>h&&(h.activeLeft?Ca(h.activeLeft,r,h):{...h,activeRight:h.activeRight===r?null:r}))},ha=()=>{var r;if(O&&O.cardType==="info"&&O.infoType==="citation"&&Se.current&&Ie&&!((r=It(O.direction))!=null&&r.fragmentId)){const h=ma(Se.current,d.current,ve.current,rt,st,O.direction,Ie.fragmentId);if(h){F(null),me(""),Pe(!1),Ee({}),tt(!1),dt(null),ot(0),_t(Se.current,h.id,Ie.title);return}}F(null),me(""),Pe(!1),Ee({}),tt(!1),dt(null),ot(0),y(h=>Math.min(h+1,L.length))},Pt=r=>{if(!O)return;const h=r.expected??null,j=r.answer??"";let v=h??"",D=j;if(!h&&r.expectedMap&&r.answerMap){const ge=Object.keys(r.expectedMap).sort((le,$e)=>le.localeCompare($e));v=ge.map(le=>{var $e;return(($e=r.expectedMap)==null?void 0:$e[le])??""}).join("|"),D=ge.map(le=>{var $e;return(($e=r.answerMap)==null?void 0:$e[le])??""}).join("|")}const w=v?pa(v,D,vt):new Uint8Array,z={revisionType:k.id,evalType:r.evalType,direction:r.direction,prompt:we??"",expected:h,answer:j,expectedAnswers:r.expectedMap??null,answers:r.answerMap??null,correct:r.correct,maskBase64:w.length?Yt(w):null,values:xe??null,checkMode:ce,compareMode:vt,minCorrectness:Dt},I=new TextEncoder().encode(JSON.stringify(z)),B=O.cardType==="info"?"info":"connection",ee=r.overrideCheckType??O.checkType??null,ne=r.overrideDirection??O.direction??null;Fa({itemType:B,itemId:O.cardId,checkType:ee,direction:ne,revisionType:k.id,evalType:r.evalType,correct:r.correct,maskBase64:w.length?Yt(w):null,payloadBase64:Yt(I),personRoleId:P??null}).then(()=>{Ta(B,O.cardId,ee,ne),ca(L),is(l,P)}).catch(()=>{})},ea=(r,h)=>{const j=ut.current.get(h);if(j)return Promise.resolve(j);const v=nt.current.get(h);if(v)return v;const D=Gt({libraryId:l,infoId:r}).then(w=>{var ge,le;const z=w.payload,I=((ge=z.definition)==null?void 0:ge.graph)??null,B="",ee=((le=z.definition)==null?void 0:le.answerTemplate)??"",ne=dn(I,B,ee);if(ne){const Ae={sample:un(ne),answerTemplate:ee||null};return ut.current.set(h,Ae),Ae}return Ts({libraryId:l,infoId:r}).then($e=>{const Ae={sample:$e,answerTemplate:null};return ut.current.set(h,Ae),Ae})}).catch(()=>Ts({libraryId:l,infoId:r}).then(w=>{const z={sample:w,answerTemplate:null};return ut.current.set(h,z),z}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{nt.current.delete(h)});return nt.current.set(h,D),D},ya=(r,h)=>{var I;const j=`${de(r)}:${h}`,v=bt.current.get(j);if(v)return Promise.resolve(v);const D=ft.current.get(j);if(D)return D;const w=B=>(bt.current.set(j,B),B);let z;if(r.cardType==="vocab"){if(r.checkType==="translation-match")return z=Promise.resolve(w({prompt:r.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),z;const B=r.label.split("↔").map(ee=>ee.trim()).filter(Boolean);if(B.length>=2){const ne=(r.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",ge=ne?B[0]:B[1],le=ne?B[1]:B[0];z=Promise.resolve(w({prompt:ge,expectedAnswer:le,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else z=Promise.resolve(w({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(r.cardType==="info"&&r.infoType==="word"){const B=(I=r.description)!=null&&I.startsWith("Language: ")?r.description.replace("Language: ",""):null;z=Promise.resolve(w({prompt:r.label,expectedAnswer:B,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else r.cardType==="info"&&r.infoType==="computed"?z=ea(r.cardId,j).then(B=>{var $e,Ae;if(!B.sample)return w({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const ee=B.sample,ne=ee.expectedAnswers?Object.entries(ee.expectedAnswers).map(([Oe,Qe])=>({key:Oe,expected:Qe})):[],ge=ne.reduce((Oe,Qe)=>(Oe[Qe.key]="",Oe),{}),le=ee.expectedAnswerIsSentence&&(($e=ee.expectedAnswer)==null?void 0:$e.trim())||null;return w({prompt:ee.prompt,expectedAnswer:ne.length>0?le:((Ae=ee.expectedAnswer)==null?void 0:Ae.trim())||null,computedExpected:ne,computedAnswers:ge,computedValues:ee.values??null,answerTemplate:B.answerTemplate,outputVariables:ee.outputVariables??null,variableValues:ee.variableValues??null})}).catch(()=>w({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{ft.current.delete(j)}):z=Promise.resolve(w({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return ft.current.set(j,z),z},_t=(r,h,j)=>{const v=Object.keys(r.nodes).length,D=d.current.size;if(!h){_e({title:j,before:r.text,after:"",fragmentId:null,total:v,completed:D}),Fe(null),tt(!0);return}const w=r.nodes[h];if(!w)return;const z=ys(r.text,w);_e({title:j,before:z.before,after:z.after,fragmentId:w.id,total:v,completed:D}),Fe(z.fragment),tt(!1)},Ma=()=>{const r=Se.current;r&&_e(h=>h&&{...h,total:Object.keys(r.nodes).length,completed:d.current.size})},ga=()=>{const r=L[be+1];r&&ya(r,be+1)},Ia=()=>{if(ga(),O&&O.cardType==="vocab"&&O.checkType==="translation-match"&&$){if($.pairs.length===0){F("incorrect"),tt(!0);return}const w=$.pairs.reduce((le,$e)=>(le[$e.rightId]=$e.rightLabel,le),{});let z=0;const I={};$.pairs.forEach(le=>{const Ae=$.selection[le.leftId]===le.rightId;I[le.leftId]=Ae?"correct":"incorrect",Ae&&(z+=1)});const B=$.pairs.length||1,ee=z/B,ne=z===$.pairs.length;M(le=>({...le,...I})),ne?(F("correct"),tt(!0),ot(0)):(F("incorrect"),tt(!1),ot(le=>{const $e=le+1;return $e>=jt&&(Pe(!0),tt(!0),q(Ae=>{if(!Ae)return Ae;const Oe=Ae.pairs.reduce((Qe,ht)=>(Qe[ht.leftId]=ht.rightId,Qe),{});return{...Ae,selection:Oe}})),$e})),Nt(ne,ee);const ge="connection";Promise.all($.pairs.map(le=>{const $e=$.selection[le.leftId]??null,Ae=$e?w[$e]:"",Oe={left:le.leftLabel,expected:le.rightLabel,answer:Ae,checkType:"translation-match"},Qe=new TextEncoder().encode(JSON.stringify(Oe));return Fa({itemType:ge,itemId:le.cardId,checkType:"translation-match",direction:null,revisionType:k.id,evalType:"translation-match",correct:$e===le.rightId,maskBase64:null,payloadBase64:Yt(Qe),personRoleId:P??null})})).then(()=>{Ta(ge,O.cardId,O.checkType,O.direction),is(l,P)}).catch(()=>{});return}if(Be.length>0){const w=Be.reduce((I,B)=>{const ee=qe[B.key]??"";return I[B.key]=St(ee)===St(B.expected)?"correct":"incorrect",I},{});Be.every(({key:I,expected:B})=>{const ee=qe[I]??"";return ce==="exact"&&St(ee)===St(B)})?(F("correct"),Ee(w),tt(!0),ot(0),Nt(!0,1),Pt({correct:!0,direction:we?`${we} -> computed`:"computed",expectedMap:Be.reduce((I,B)=>(I[B.key]=B.expected,I),{}),answerMap:qe,evalType:"computed"})):(F("incorrect"),Ee(w),tt(!1),ot(I=>{const B=I+1;return B>=jt&&U&&(Pe(!0),tt(!0)),B}),Nt(!1,0),window.setTimeout(()=>{var B;const I=_a(fe,Be,ye);I&&$t.current[I]&&((B=$t.current[I])==null||B.focus())},40),Pt({correct:!1,direction:we?`${we} -> computed`:"computed",expectedMap:Be.reduce((I,B)=>(I[B.key]=B.expected,I),{}),answerMap:qe,evalType:"computed"}));return}if(O&&O.cardType==="info"&&O.infoType==="citation"&&(Ie!=null&&Ie.fragmentId)){if(!Te)return;const w=It(O.direction),z=(w==null?void 0:w.mode)??getQuoteMode(O.direction),I=w!=null&&w.fragmentId&&O.direction?O.direction:Na(z,Ie.fragmentId),B=pn(Te,V,vt),ee=ce==="exact"&&fa(V)===fa(Te),ne=Qt(B),ge=ee||ne,le=Jt(B);ge?(ve.current[Ie.fragmentId]=Math.max(ve.current[Ie.fragmentId]??0,le),(ve.current[Ie.fragmentId]??0)>=rt&&d.current.add(Ie.fragmentId),Ma(),F("correct"),Ee({}),tt(!0),dt(B),ot(0),le<100&&jt<=1&&Pe(!0),Nt(!0,le/100),Pt({correct:!0,direction:`quote:${Ie.fragmentId}`,expected:Te,answer:V,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:I})):(F("incorrect"),Ee({}),tt(!1),dt(B),ot($e=>{const Ae=$e+1;return Ae>=jt&&U&&(Pe(!0),tt(!0)),Ae}),Nt(!1,le/100),window.setTimeout(()=>{var $e;return($e=it.current)==null?void 0:$e.focus()},40),Pt({correct:!1,direction:`quote:${Ie.fragmentId}`,expected:Te,answer:V,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:I}));return}if(!Te)return;const r=pa(Te,V,vt),h=ce==="exact"&&St(V)===St(Te),j=Qt(r),v=h||j,D=Jt(r);v?(F("correct"),Ee({}),tt(!0),dt(r),ot(0),D<100&&jt<=1&&Pe(!0),Nt(!0,D/100),Pt({correct:!0,direction:we?`${we} -> ${Te}`:null,expected:Te,answer:V,evalType:"text"})):(F("incorrect"),Ee({}),tt(!1),dt(r),ot(w=>{const z=w+1;return z>=jt&&U&&(Pe(!0),tt(!0)),z}),Nt(!1,D/100),window.setTimeout(()=>{var w;return(w=it.current)==null?void 0:w.focus()},40),Pt({correct:!1,direction:we?`${we} -> ${Te}`:null,expected:Te,answer:V,evalType:"text"}))},Ga=r=>{if(ga(),!Te)return;const h=pa(Te,r,vt),j=St(r)===St(Te),v=Qt(h),D=j||v,w=Jt(h);D?(F("correct"),Ee({}),tt(!0),dt(h),ot(0),w<100&&jt<=1&&Pe(!0),Nt(!0,w/100),Pt({correct:!0,direction:"word->language",expected:Te,answer:r,evalType:"language-select"})):(F("incorrect"),Ee({}),tt(!1),dt(h),ot(z=>{const I=z+1;return I>=jt&&U&&(Pe(!0),tt(!0)),I}),Nt(!1,w/100),Pt({correct:!1,direction:"word->language",expected:Te,answer:r,evalType:"language-select"}))},Ja=()=>{ga(),F("correct"),tt(!0),ot(0),Nt(!0,1),Te&&Pt({correct:!0,direction:"manual",expected:Te,answer:V,evalType:"manual"})},Xa=()=>{if(Nt(!1,0),O&&O.cardType==="info"&&O.infoType==="citation"){F(null),me(""),Pe(!1),Ee({}),tt(!1),dt(null),ot(0),y(r=>Math.min(r+1,L.length));return}ha()};a.useEffect(()=>{ga()},[be,L]);const ta=r=>{var j;if(r.key!=="Enter")return;if(r.preventDefault(),r.stopPropagation(),xt){ha();return}const h=Be.find(v=>!(qe[v.key]??"").trim());if(h){(j=$t.current[h.key])==null||j.focus();return}Ia()},C=t.cogita.library.revision.revealModeAfterIncorrect,U=Be.length>0||!!Te;return e.jsxs(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,children:[re==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${he.total?Math.min(100,Math.max(0,he.current/he.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:he.total?`${Math.min(he.current,he.total)} / ${he.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:R}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",p).replace("{check}",H)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:S,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${S}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${S}/collections/${b}`,children:t.cogita.library.actions.collectionDetail})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Me?`${Me.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Kt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Kt.currentLevel??"-"," / ",Kt.levelsCount]}):null,Me?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(Me.correct)).replace("{total}",String(Me.total))}),Me.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(Me.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(hn,{outcomes:Ue})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[lt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:lt})}):null,e.jsx("section",{className:"cogita-revision-card","data-feedback":ue?`${ue.kind}-${ue.tick}`:Z?"idle":Y??"idle",children:O?e.jsx(e.Fragment,{children:_?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(xs,{copy:t,currentCard:O,currentTypeLabel:Mt,prompt:we,languages:se,answer:V,onAnswerChange:r=>me(h=>Da(h,r,ke)),computedExpected:Be,computedAnswers:qe,onComputedAnswerChange:(r,h)=>et(j=>({...j,[r]:Da(j[r]??"",h,ke)})),answerTemplate:fe,outputVariables:ye,variableValues:Je,computedFieldFeedback:Ge,feedback:Y,canAdvance:xt,quoteContext:Ie,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Ia,onSkip:Xa,onLanguageSelect:Ga,onMarkReviewed:Ja,onAdvance:ha,showCorrectAnswer:Re,setShowCorrectAnswer:Pe,onRevealCorrect:()=>tt(!0),answerMask:Ct,expectedAnswer:Te,hasExpectedAnswer:U,handleComputedKeyDown:ta,answerInputRef:it,computedInputRefs:$t,scriptMode:ke,setScriptMode:ze,matchPairs:$==null?void 0:$.pairs,matchLeftOrder:$==null?void 0:$.leftOrder,matchRightOrder:$==null?void 0:$.rightOrder,matchSelection:$==null?void 0:$.selection,matchActiveLeft:$==null?void 0:$.activeLeft,matchActiveRight:$==null?void 0:$.activeRight,matchFeedback:je,onMatchLeftSelect:ua,onMatchRightSelect:zt})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${S}/collections/${b}`,children:t.cogita.library.actions.collectionDetail})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Ht?`${Bt} / ${Ht}`:t.cogita.library.revision.progressUnlimited}),re==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),re==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),re==="ready"&&L.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:C}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",jt]})]})]}),Kt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Kt.activeCount," / ",Kt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Kt.counts.map((r,h)=>{const j=h+1,v=Kt.currentLevel===j,D=Kt.percentages[h]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":v,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:j}),e.jsx("strong",{children:r})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,D))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[D.toFixed(1),"%"]})]},`level-${j}`)})})]}):null,kt?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:kt.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:kt.dots.map(r=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,r.value*100))}%`,background:`rgba(${Math.round(255*(1-r.value))}, ${Math.round(200*r.value)}, 80, 0.9)`}},r.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:kt.knownCount})]})]}):null,st?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:da})]})}):null]})]})]})})})]})]})}const rs=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],Gi={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},Ji=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Xi=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function Zi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,libraryId:l,collectionId:b}){const[c,u]=a.useState(""),[S,ae,J]=qs([]),[W,k,m]=Us([]),[ce,P]=a.useState(null),[p,H]=a.useState(null),[R,X]=a.useState(null),L=`/#/cogita/library/${l}`;a.useEffect(()=>{Oa(l,b).then(T=>u(T.name)).catch(()=>u(t.cogita.library.collections.defaultName))},[l,b,t]),a.useEffect(()=>{Kn({libraryId:l,collectionId:b}).then(T=>{if(!T.graphId||T.graphId==="00000000-0000-0000-0000-000000000000"){ae([]),k([]);return}const be=T.nodes.map(V=>{var we;const me=V.payload??{},Y=me.position??{x:120,y:120},F=me.params??{};return{id:V.nodeId,type:"default",position:Y,data:{nodeType:V.nodeType,label:((we=rs.find(Ne=>Ne.type===V.nodeType))==null?void 0:we.label)??V.nodeType,params:F}}}),y=T.edges.map(V=>({id:V.edgeId,source:V.fromNodeId,target:V.toNodeId,sourceHandle:V.fromPort??void 0,targetHandle:V.toPort??void 0}));ae(be),k(y)}).catch(()=>{ae([]),k([])})},[l,b,k,ae]);const E=a.useMemo(()=>S.find(T=>T.id===ce)??null,[S,ce]),se=T=>{var me;const be=crypto.randomUUID(),y=((me=rs.find(Y=>Y.type===T))==null?void 0:me.label)??T,V={...Gi[T]};ae(Y=>[...Y,{id:be,type:"default",position:{x:120+Y.length*40,y:120+Y.length*40},data:{nodeType:T,label:y,params:V}}]),P(be)},ie=a.useCallback(T=>{k(be=>Ws({...T,id:crypto.randomUUID()},be))},[k]),re=async()=>{H(null);try{await Bn({libraryId:l,collectionId:b,nodes:S.map(T=>({nodeId:T.id,nodeType:T.data.nodeType,payload:{position:T.position,params:T.data.params}})),edges:W.map(T=>({edgeId:T.id,fromNodeId:T.source,fromPort:T.sourceHandle??null,toNodeId:T.target,toPort:T.targetHandle??null}))}),H(t.cogita.library.graph.saveSuccess)}catch{H(t.cogita.library.graph.saveFail)}},De=async()=>{try{const T=await zn({libraryId:l,collectionId:b});X(T)}catch{X(null)}},he=T=>{E&&ae(be=>be.map(y=>y.id===E.id?{...y,data:{...y.data,params:T}}:y))};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${L}/collections/${b}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:De,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:re,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:rs.map(T=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>se(T.type),children:T.label},T.type))}),p?e.jsx("p",{className:"cogita-help",children:p}):null,R&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(R.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(R.connections)).replace("{infos}",String(R.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(gs,{nodes:S,edges:W,onNodesChange:J,onEdgesChange:m,onConnect:ie,onNodeClick:(T,be)=>P(be.id),fitView:!0,children:[e.jsx(ms,{color:"rgba(120,160,200,0.2)"}),e.jsx(ps,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),E?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:E.data.label}),E.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(na,{libraryId:l,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:E.data.params.tagId?{id:E.data.params.tagId,label:E.data.params.tagLabel??"",infoType:"topic"}:null,onChange:T=>he({...E.data.params,tagId:(T==null?void 0:T.id)??null,tagLabel:(T==null?void 0:T.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:E.data.params.scope??"any",onChange:T=>he({...E.data.params,scope:T.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),E.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(na,{libraryId:l,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:E.data.params.languageId?{id:E.data.params.languageId,label:E.data.params.languageLabel??"",infoType:"language"}:null,onChange:T=>he({...E.data.params,languageId:(T==null?void 0:T.id)??null,languageLabel:(T==null?void 0:T.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:E.data.params.scope??"any",onChange:T=>he({...E.data.params,scope:T.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),E.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:E.data.params.infoType??"word",onChange:T=>he({...E.data.params,infoType:T.target.value}),children:Xi.map(T=>e.jsx("option",{value:T.value,children:T.label},T.value))})]}),e.jsx(na,{libraryId:l,infoType:E.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:E.data.params.infoId?{id:E.data.params.infoId,label:E.data.params.infoLabel??"",infoType:E.data.params.infoType??"word"}:null,onChange:T=>he({...E.data.params,infoId:(T==null?void 0:T.id)??null,infoLabel:(T==null?void 0:T.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),E.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:E.data.params.connectionType??"translation",onChange:T=>he({...E.data.params,connectionType:T.target.value}),children:Ji.map(T=>e.jsx("option",{value:T.value,children:T.label},T.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:E.data.params.connectionId??"",onChange:T=>he({...E.data.params,connectionId:T.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(E.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const os="cogita.preferences",cs="cogita.reviewer.preferences",bn=["library_overview","all_cards","all_collections","storyboards","texts","dependencies","transfer"],ls={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},ds=["settings","run","shared"];function er(t,s=""){const n=t.split("/").filter(Boolean);if(n[0]!=="cogita"||n[1]!=="library")return{};const i=n[2];if(!i)return{};if(!n[3])return{libraryId:i,target:"library_overview"};const o=new URLSearchParams(s),g=o.get("revisionId")??void 0,f=o.get("infoId")??void 0,x=o.get("infoView")==="cards"?"cards":"overview",A=o.get("collectionAction"),N=o.get("libraryAction");if(n[3]==="list")return{libraryId:i,target:N==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:g,infoId:f,infoView:x,libraryAction:N==="new-info"?"new-info":void 0};if(n[3]==="detail"||n[3]==="collection")return{libraryId:i,target:"all_cards",cardMode:n[3],revisionId:g,infoId:f,infoView:x};if(n[3]==="new"||n[3]==="add")return{libraryId:i,target:"new_card",revisionId:g,libraryAction:"new-info"};if(n[3]==="edit")return{libraryId:i,target:"new_card",revisionId:g,infoId:n[4]};if(n[3]==="infos"){const b=n[4];return b?n[5]==="checkcards"?{libraryId:i,target:"all_cards",cardMode:"list",revisionId:g,infoId:b,infoView:"cards"}:{libraryId:i,target:"all_cards",cardMode:"list",revisionId:g,infoId:b,infoView:"overview"}:{libraryId:i,target:"all_cards",cardMode:"list",revisionId:g}}if(n[3]==="shared-revisions")return{libraryId:i,target:"all_collections",revisionId:g};if(n[3]==="dependencies")return{libraryId:i,target:"dependencies"};if(n[3]==="transfer")return{libraryId:i,target:"transfer"};if(n[3]==="storyboards")return n[4]==="new"?{libraryId:i,target:"new_storyboard"}:{libraryId:i,target:"storyboards"};if(n[3]==="texts")return n[4]==="new"?{libraryId:i,target:"new_text"}:{libraryId:i,target:"texts"};if(n[3]!=="collections")return{libraryId:i,target:"library_overview"};if(n[4]==="new")return{libraryId:i,target:"new_collection",revisionId:g};const l=n[4];return l?n[5]==="graph"?{libraryId:i,target:"all_collections",collectionId:l,revisionId:g,revisionView:"graph"}:n[5]==="shared-revisions"?{libraryId:i,target:"all_collections",collectionId:l,revisionId:g,revisionView:"shared"}:n[5]==="revision"?{libraryId:i,target:"all_collections",collectionId:l,revisionId:g,revisionView:n[6]==="run"?"run":"settings"}:A==="new-revision"?{libraryId:i,target:"all_collections",collectionId:l,revisionId:g,revisionView:"new"}:{libraryId:i,target:"all_collections",collectionId:l,revisionId:g,revisionView:"detail"}:A==="new-collection"?{libraryId:i,target:"new_collection",collectionAction:"new-collection"}:{libraryId:i,target:"all_collections"}}function Vs(t,s="library_overview",n,i,o,g,f="overview"){const x=(A,N)=>{const l=new URLSearchParams;N!=null&&N.revisionId&&l.set("revisionId",N.revisionId),N!=null&&N.collectionAction&&l.set("collectionAction",N.collectionAction),N!=null&&N.libraryAction&&l.set("libraryAction",N.libraryAction),N!=null&&N.infoId&&l.set("infoId",N.infoId),N!=null&&N.infoView&&(N!=null&&N.infoId)&&l.set("infoView",N.infoView);const b=l.toString();return b?`${A}?${b}`:A};return t?s==="library_overview"?x(`/cogita/library/${t}`,{revisionId:o}):s==="all_cards"?g?f==="cards"?x(`/cogita/library/${t}/infos/${g}/checkcards`,{revisionId:o}):x(`/cogita/library/${t}/infos/${g}`,{revisionId:o}):x(`/cogita/library/${t}/list`,{revisionId:o,infoId:g,infoView:f}):s==="new_card"?g?x(`/cogita/library/${t}/edit/${g}`,{revisionId:o}):x(`/cogita/library/${t}/list`,{revisionId:o,libraryAction:"new-info"}):s==="all_collections"?n?i==="graph"?x(`/cogita/library/${t}/collections/${n}/graph`,{revisionId:o}):i==="settings"?x(`/cogita/library/${t}/collections/${n}/revision`,{revisionId:o}):i==="run"?x(`/cogita/library/${t}/collections/${n}/revision/run`,{revisionId:o}):i==="shared"?x(`/cogita/library/${t}/collections/${n}/shared-revisions`,{revisionId:o}):i==="new"?x(`/cogita/library/${t}/collections/${n}`,{revisionId:o,collectionAction:"new-revision"}):x(`/cogita/library/${t}/collections/${n}`,{revisionId:o}):x(`/cogita/library/${t}/collections`,{revisionId:o}):s==="new_collection"?x(`/cogita/library/${t}/collections`,{revisionId:o,collectionAction:"new-collection"}):s==="transfer"?x(`/cogita/library/${t}/transfer`,{revisionId:o}):s==="storyboards"?x(`/cogita/library/${t}/storyboards`,{revisionId:o}):s==="new_storyboard"?x(`/cogita/library/${t}/storyboards/new`,{revisionId:o}):s==="texts"?x(`/cogita/library/${t}/texts`,{revisionId:o}):s==="new_text"?x(`/cogita/library/${t}/texts/new`,{revisionId:o}):s==="dependencies"?x(`/cogita/library/${t}/dependencies`,{revisionId:o}):x(`/cogita/library/${t}`,{revisionId:o}):"/cogita"}function va(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function tr(t){return typeof t=="string"&&bn.includes(t)}function ar(t,s){var x;if(!t.length)return null;const n=t.filter(A=>s.has(A.roleId)),i=n.length>0?n:t,o=i.map(A=>{var l,b;const N=((b=(l=A.fields.find(c=>c.fieldType==="role_kind"))==null?void 0:l.plainValue)==null?void 0:b.toLowerCase())??"";return{roleId:A.roleId,roleKind:N}}),g=o.find(A=>A.roleKind.includes("master"));if(g)return g.roleId;const f=o.find(A=>A.roleKind.includes("account")||A.roleKind.includes("user"));return f?f.roleId:((x=i[0])==null?void 0:x.roleId)??null}function sr(t){if(!t)return{version:1,byLibrary:{}};try{const s=JSON.parse(t);return!s||typeof s!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:s.lastLibraryId,byLibrary:s.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function nr({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N}){const l=Os(),b=Va(),c=a.useMemo(()=>er(b.pathname,b.search),[b.pathname,b.search]),u=t.cogita.workspace,[S,ae]=a.useState([]),[J,W]=a.useState([]),[k,m]=a.useState([]),[ce,P]=a.useState([]),[p,H]=a.useState(void 0),[R,X]=a.useState("library_overview"),[L,E]=a.useState(void 0),[se,ie]=a.useState(void 0),[re,De]=a.useState("detail"),[he,T]=a.useState(void 0),[be,y]=a.useState(!1),[V,me]=a.useState(!0),[Y,F]=a.useState(!1),[we,Ne]=a.useState(!1),[Te,Fe]=a.useState(null),[Ie,_e]=a.useState(0),[Be,Le]=a.useState(""),[qe,et]=a.useState(""),[Ge,Ee]=a.useState(""),[xe,G]=a.useState([]),[fe,oe]=a.useState(""),[ye,Ke]=a.useState(null),[Je,Ve]=a.useState(null),$=a.useRef({version:1,byLibrary:{}}),q=a.useRef(!1),je=a.useRef(!1),M=a.useRef(null),K=a.useMemo(()=>S.find(d=>d.libraryId===p)??null,[S,p]),ue=a.useMemo(()=>J.find(d=>d.collectionId===L)??null,[J,L]);a.useEffect(()=>{if(!p){G([]),oe("");return}let d=!1;return sn({libraryId:p}).then(ve=>{if(d)return;const O=ve.filter(Z=>(Z.roleKind??"").trim().toLowerCase()==="person");G(O);try{const Z=window.localStorage.getItem(cs),nt=(Z?JSON.parse(Z):{})[p]??"",bt=nt&&O.some(ft=>ft.roleId===nt)?nt:"";oe(bt)}catch{oe("")}}).catch(()=>{d||(G([]),oe(""))}),()=>{d=!0}},[p]),a.useEffect(()=>{if(p)try{const d=window.localStorage.getItem(cs),ve=d?JSON.parse(d):{};fe?ve[p]=fe:delete ve[p],window.localStorage.setItem(cs,JSON.stringify(ve))}catch{}},[p,fe]);const pe=a.useMemo(()=>ce.find(d=>d.revisionId===se)??null,[ce,se]),Q=a.useMemo(()=>({detail:u.revisions.detail,graph:u.revisions.graph,settings:u.revisions.settings,run:u.revisions.run,shared:u.targets.sharedRevisions,new:u.revisionForm.createAction}),[u.revisions.detail,u.revisions.graph,u.revisions.run,u.revisions.settings,u.targets.sharedRevisions,u.revisionForm.createAction]),Ce=a.useMemo(()=>[{value:"detail",label:Q.detail},{value:"graph",label:Q.graph},{value:"settings",label:u.targets.allRevisions},{value:"run",label:Q.run},{value:"shared",label:Q.shared}],[Q.detail,Q.graph,Q.run,Q.shared,u.targets.allRevisions]),ke=a.useMemo(()=>R==="new_card"?"all_cards":R==="new_collection"?"all_collections":R==="new_storyboard"?"storyboards":R==="new_text"?"texts":R,[R]),ze=a.useMemo(()=>re==="new"?"settings":re,[re]),Re=a.useMemo(()=>c.infoId?"selected":R==="new_card"?"create":"search",[c.infoId,R]),Pe=a.useMemo(()=>k.find(d=>d.infoId===c.infoId)??null,[k,c.infoId]),Me=a.useMemo(()=>({library_overview:u.targets.libraryOverview,all_cards:u.targets.allCards,new_card:u.targets.newCard,all_collections:u.targets.allCollections,new_collection:u.targets.newCollection,transfer:u.targets.transfer,storyboards:u.targets.storyboards,new_storyboard:u.targets.newStoryboard,texts:u.targets.texts,new_text:u.targets.newText,dependencies:u.targets.dependencies}),[u.targets]),ct=a.useMemo(()=>Me[ke]??ke,[ke,Me]),Ue=Q[ze],Xe=!!p,lt=a.useMemo(()=>{const d=A==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":A==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return A==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:d},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:d},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:d},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:d},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:d},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:d},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:d},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:d},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:d},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:d},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:d},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:d},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:d},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:A==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:d},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:d},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:d},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:d},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:d},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:d},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:d},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:d},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:d},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:d},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:d},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:d},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:d},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:d},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:d},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:d},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:d},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:d},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:d},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:d},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:d},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:d},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:d},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:d},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:d},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:d},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[A]),yt=lt.length,We=Math.max(0,Math.min(Ie,yt-1)),He=lt[We],Ct=!!L,dt=Xe&&R==="all_collections",Lt=Ct&&R==="all_collections",ot=Ct&&R==="all_collections"&&ds.includes(re),it=a.useCallback(d=>{const ve=!!d.libraryId;let O=d.target,Z=d.collectionId,ut=d.revisionId,nt=d.revisionView,bt=d.infoId,ft=d.infoView??c.infoView??"overview";ve?ls[O].requiresCollection&&!Z?(O="all_collections",ut=void 0,nt="detail"):O!=="all_collections"?(Z=void 0,ut=void 0,O!=="new_card"&&O!=="all_cards"&&(bt=void 0,ft="overview")):ls[O].allowsRevision?ds.includes(nt)||(ut=void 0):nt="detail":(O="library_overview",Z=void 0,ut=void 0,nt="detail",bt=void 0,ft="overview"),H(d.libraryId),X(O),E(Z),ie(ut),De(nt),y(!1);const Mt=va(Vs(d.libraryId,O,Z,nt,ut,bt,ft));va(`${b.pathname}${b.search}`)!==Mt&&(M.current=Mt,l(Mt))},[b.pathname,b.search,l,c.infoView]),$t=d=>{it({libraryId:p,target:"all_collections",collectionId:L,revisionId:ds.includes(d)?se:void 0,revisionView:d})},xt=a.useMemo(()=>[{key:"library",label:u.layers.library,visible:!0,value:p??"",selectedLabel:(K==null?void 0:K.name)??u.path.noLibrarySelected,disabled:V||S.length===0,options:S.map(d=>({value:d.libraryId,label:d.name})),emptyOption:u.noLibraryOption,onSelect:d=>{const ve=d||void 0;it({libraryId:ve,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:u.layers.target,visible:Xe,value:ke,selectedLabel:ct,disabled:!Xe,options:bn.map(d=>({value:d,label:Me[d]})),onSelect:d=>{const ve=d;it({libraryId:p,target:ve,collectionId:L,revisionId:se,revisionView:re,infoId:ve==="new_card"?c.infoId:void 0})}},{key:"info_mode",label:u.layers.target,visible:ke==="all_cards",value:Re,selectedLabel:Re==="create"?u.infoMode.create:Re==="selected"?(Pe==null?void 0:Pe.label)??he??t.cogita.library.list.selectedEmpty:u.infoMode.search,disabled:!Xe,options:[{value:"search",label:u.infoMode.search},{value:"create",label:u.infoMode.create},...c.infoId?[{value:"selected",label:(Pe==null?void 0:Pe.label)??he??t.cogita.library.list.selectedEmpty}]:[]],onSelect:d=>{if(d==="selected"){if(!c.infoId)return;it({libraryId:p,target:"all_cards",collectionId:L,revisionId:se,revisionView:re,infoId:c.infoId,infoView:"overview"});return}if(d==="create"){it({libraryId:p,target:"new_card",collectionId:L,revisionId:se,revisionView:re,infoId:void 0});return}it({libraryId:p,target:"all_cards",collectionId:L,revisionId:se,revisionView:re,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:u.layers.target,visible:ke==="all_cards"&&!!c.infoId,value:R==="new_card"&&c.infoId?"edit":c.infoView==="cards"?"cards":"overview",selectedLabel:R==="new_card"&&c.infoId?u.infoActions.edit:c.infoView==="cards"?u.infoActions.seeCards:u.infoActions.overview,disabled:!Xe||!c.infoId,options:[{value:"overview",label:u.infoActions.overview},{value:"edit",label:u.infoActions.edit},{value:"cards",label:u.infoActions.seeCards}],onSelect:d=>{if(c.infoId){if(d==="edit"){it({libraryId:p,target:"new_card",collectionId:L,revisionId:se,revisionView:re,infoId:c.infoId});return}if(d==="cards"){it({libraryId:p,target:"all_cards",collectionId:L,revisionId:se,revisionView:re,infoId:c.infoId,infoView:"cards"});return}it({libraryId:p,target:"all_cards",collectionId:L,revisionId:se,revisionView:re,infoId:c.infoId,infoView:"overview"})}}},{key:"collection",label:u.layers.collection,visible:dt,value:L??"",selectedLabel:(ue==null?void 0:ue.name)??u.path.noCollectionSelected,disabled:!Xe||Y||J.length===0,options:J.map(d=>({value:d.collectionId,label:d.name})),emptyOption:u.selectCollectionOption,onSelect:d=>{it({libraryId:p,target:"all_collections",collectionId:d||void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection_action",label:u.layers.revision,visible:Lt,value:ze,selectedLabel:Ue,disabled:!L,options:Ce.map(d=>({value:d.value,label:d.label})),onSelect:d=>{$t(d)}},{key:"revision_entry",label:u.layers.revision,visible:ot,value:se??"",selectedLabel:(pe==null?void 0:pe.name)??u.status.noRevisions,disabled:!Ct||we||ce.length===0,options:ce.map(d=>({value:d.revisionId,label:d.name})),emptyOption:u.status.noRevisions,onSelect:d=>{it({libraryId:p,target:"all_collections",collectionId:L,revisionId:d||void 0,revisionView:re})}}],[Ce,J,Y,Re,k,S,V,it,ce,we,ue,L,Pe,pe,se,he,Ct,Xe,K,p,Ue,re,R,ze,ke,ct,dt,Lt,ot,Me,t.cogita.library.list.selectedEmpty,c.infoId,c.infoView,u.infoActions.edit,u.infoActions.overview,u.infoActions.seeCards,u.layers.collection,u.layers.library,u.layers.revision,u.layers.target,u.noLibraryOption,u.path.noCollectionSelected,u.path.noLibrarySelected,u.selectCollectionOption]),tt=a.useMemo(()=>xt.filter(d=>d.visible),[xt]),at=a.useMemo(()=>tt.filter(d=>d.key!=="library"&&d.key!=="collection"&&d.key!=="revision_entry"),[tt]),Et=a.useMemo(()=>at.find(d=>d.key==="target")??null,[at]),Rt=a.useMemo(()=>at.find(d=>d.key==="info_mode")??null,[at]),Ze=a.useMemo(()=>at.find(d=>d.key==="info_selected_action")??null,[at]),gt=a.useMemo(()=>at.find(d=>d.key==="collection_action")??null,[at]),pt=a.useCallback((d,ve)=>d?e.jsx("div",{className:"cogita-sidebar-actions",children:d.options.map(O=>e.jsx("button",{type:"button",className:`ghost ${String(d.value)===O.value?"active":""}`,onClick:()=>d.onSelect(O.value),disabled:d.disabled,children:O.label},`${ve}:${d.key}:${O.value}`))}):null,[]),wt=a.useMemo(()=>{const d=c.libraryId;if(!d||!b.pathname.startsWith("/cogita/library/"))return null;const ve={copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,libraryId:d};if(c.target==="library_overview")return e.jsx(ni,{...ve});if(c.target==="all_cards")return c.infoId&&c.infoView==="cards"?e.jsx(ji,{...ve,infoId:c.infoId,selectedReviewerRoleId:fe||null}):e.jsx(ui,{...ve,mode:c.cardMode??"list"});if(c.target==="new_card")return e.jsx(yi,{...ve,editInfoId:c.infoId});if(c.target==="dependencies")return e.jsx(vi,{...ve});if(c.target==="transfer")return e.jsx(Ni,{...ve});if(c.target==="storyboards"||c.target==="new_storyboard")return e.jsx(Si,{...ve});if(c.target==="texts"||c.target==="new_text")return e.jsx(Ti,{...ve});if(c.target==="all_collections"){if(c.collectionId){const O={...ve,collectionId:c.collectionId};return c.revisionView==="graph"?e.jsx(Zi,{...O}):c.revisionView==="shared"?e.jsx(ki,{...ve,collectionId:c.collectionId}):c.revisionView==="settings"?e.jsx(Fi,{...O,revisionId:c.revisionId}):c.revisionView==="run"?e.jsx(Yi,{...O,revisionId:c.revisionId}):e.jsx(Ci,{...O})}return e.jsx(Ds,{...ve})}return c.target==="new_collection"?e.jsx(Ds,{...ve}):null},[s,t,A,b.pathname,l,N,g,x,i,o,c.cardMode,c.collectionId,c.infoId,c.libraryId,c.revisionId,c.revisionView,c.target,f,n,fe]);a.useEffect(()=>{let d=!1;return(async()=>{var O,Z,ut,nt,bt;me(!0);try{await Dn();const[ft,Mt,ra]=await Promise.all([Ys(),_n(),Vn()]);if(d)return;ae(ft);const Ht=new Set(ra.nodes.filter(st=>st.nodeType==="role"&&st.canLink).map(st=>st.roleId??"")),Bt=ar(Mt,Ht);if(Ke(Bt),Bt){const st=ra.nodes.find(rt=>rt.nodeType==="data"&&rt.roleId===Bt&&(rt.fieldType===os||rt.label===os));Ve((st==null?void 0:st.dataKeyId)??null),$.current=sr(st==null?void 0:st.value)}const jt=(O=ft.find(st=>st.libraryId===c.libraryId))==null?void 0:O.libraryId,vt=jt?(ut=(Z=$.current.byLibrary)==null?void 0:Z[jt])==null?void 0:ut.lastTarget:void 0,Dt=tr(vt)?vt:"library_overview";H(jt),X(c.target??Dt),ie(c.revisionId??(jt?(bt=(nt=$.current.byLibrary)==null?void 0:nt[jt])==null?void 0:bt.lastRevisionId:void 0)),De(c.revisionView??"detail"),q.current=!0}catch{d||Fe(u.status.loadFailed)}finally{d||me(!1)}})(),()=>{d=!0}},[u.status.loadFailed]),a.useLayoutEffect(()=>{if(q.current){if(!c.libraryId){H(void 0),X(c.target??"library_overview"),E(void 0),ie(void 0),De("detail");return}c.libraryId&&S.some(d=>d.libraryId===c.libraryId)&&H(c.libraryId),c.target&&X(c.target),E(c.collectionId),ie(c.revisionId),c.revisionView&&De(c.revisionView)}},[S,c.collectionId,c.libraryId,c.revisionId,c.revisionView,c.target]),a.useEffect(()=>{if(!p){W([]),E(void 0),m([]),P([]),ie(void 0);return}let d=!1;return F(!0),ja({libraryId:p,limit:200}).then(ve=>{var ut;if(d)return;const O=ve.items;W(O);const Z=(ut=O.find(nt=>nt.collectionId===c.collectionId))==null?void 0:ut.collectionId;E(Z)}).catch(()=>{d||(W([]),E(void 0))}).finally(()=>{d||F(!1)}),()=>{d=!0}},[c.collectionId,p]),a.useEffect(()=>{if(!p||ke!=="all_cards"&&R!=="new_card"){m([]);return}let d=!1;return bs({libraryId:p,limit:200}).then(ve=>{d||m(ve)}).catch(()=>{d||m([])}),()=>{d=!0}},[ke,p,R]),a.useEffect(()=>{if(!p||!L){P([]),ie(void 0);return}let d=!1;return Ne(!0),Gs({libraryId:p,collectionId:L}).then(ve=>{var ut,nt,bt,ft;if(d)return;P(ve);const O=(nt=(ut=$.current.byLibrary)==null?void 0:ut[p])==null?void 0:nt.lastRevisionId,Z=((bt=ve.find(Mt=>Mt.revisionId===c.revisionId))==null?void 0:bt.revisionId)??((ft=ve.find(Mt=>Mt.revisionId===O))==null?void 0:ft.revisionId);ie(Z)}).catch(()=>{d||(P([]),ie(void 0))}).finally(()=>{d||Ne(!1)}),()=>{d=!0}},[c.revisionId,L,p]),a.useEffect(()=>{const d=c.infoId;if(!p||!d){T(void 0);return}let ve=!1;return Gt({libraryId:p,infoId:d}).then(O=>{if(ve)return;const Z=O.payload;T((Z==null?void 0:Z.label)??(Z==null?void 0:Z.name)??(Z==null?void 0:Z.title)??O.infoId)}).catch(()=>{ve||T(d)}),()=>{ve=!0}},[c.infoId,p]),a.useEffect(()=>{if(!q.current||c.libraryId&&S.some(Z=>Z.libraryId===c.libraryId)&&c.libraryId!==p||c.target&&c.target!==R||c.revisionView&&c.revisionView!==re||c.revisionId&&c.revisionId!==se||ls[R].requiresCollection&&!L&&c.target==="all_collections"&&c.collectionId)return;const d=va(`${b.pathname}${b.search}`);if(va(b.pathname)==="/cogita"&&!c.libraryId&&!p){M.current=null;return}const O=va(Vs(p,R,L,re,se,c.infoId,c.infoView??"overview"));if(d===O){M.current=null;return}M.current!==O&&(M.current=O,l(O,{replace:!0}))},[S,b.pathname,b.search,l,c.collectionId,c.infoId,c.infoView,c.libraryId,c.revisionId,c.revisionView,c.target,L,p,se,re,R]),a.useEffect(()=>{if(typeof window>"u")return;const d=()=>{window.innerWidth>920&&y(!1)};return window.addEventListener("resize",d),()=>window.removeEventListener("resize",d)},[]),a.useEffect(()=>{if(!q.current||!ye||!p||je.current)return;const d=$.current,ve={...d.byLibrary??{}},O={...ve[p]??{},lastCollectionId:L,lastRevisionId:se,lastRevisionView:re,lastTarget:R},Z={version:1,lastLibraryId:p,byLibrary:{...ve,[p]:O}},ut=JSON.stringify(d),nt=JSON.stringify(Z);if(ut===nt)return;$.current=Z,je.current=!0,(async()=>{try{if(Je)await On(Je,{plainValue:nt});else{const ft=await qn(ye,{itemName:os,itemType:"data",plainValue:nt});Ve(ft.dataItemId)}}catch{Fe(u.status.savePrefsFailed)}finally{je.current=!1}})()},[Je,ye,L,p,se,re,R,u.status.savePrefsFailed]);const _=async()=>{const d=Be.trim();if(!d){Fe(t.cogita.user.libraryNameRequired);return}Fe(null);try{const ve=await Hn({name:d});ae(O=>[ve,...O]),H(ve.libraryId),X("library_overview"),E(void 0),Le("")}catch{Fe(t.cogita.user.libraryCreateFailed)}},te=async()=>{if(!p){Fe(u.status.selectLibraryFirst);return}const d=qe.trim();if(!d){Fe(t.cogita.library.collections.saveRequiredName);return}Fe(null);try{const ve=await Un({libraryId:p,name:d,items:[]}),O=await ja({libraryId:p,limit:200});W(O.items),E(ve.collectionId),ie(void 0),X("all_collections"),De("detail"),et("")}catch{Fe(t.cogita.library.collections.saveFail)}},Se=async()=>{if(!p||!L){Fe(u.status.selectLibraryFirst);return}const d=Ge.trim();if(!d){Fe(u.revisionForm.nameLabel);return}Fe(null);try{const ve=await Wn({libraryId:p,collectionId:L,name:d,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});P(O=>[ve,...O]),ie(ve.revisionId),X("all_collections"),De("settings"),Ee("")}catch{Fe(u.status.loadFailed)}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,headerExtra:p?e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:fe,onChange:d=>oe(d.target.value),children:[e.jsx("option",{value:"",children:"No person"}),xe.map(d=>e.jsx("option",{value:d.roleId,children:d.label},d.roleId))]})]}):null,children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${be?"open":""}`,"aria-label":u.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{children:(K==null?void 0:K.name)??u.path.noLibrarySelected}),e.jsx("p",{className:"cogita-sidebar-note",children:K?u.sidebar.libraryActionsHint:u.status.selectLibraryFirst}),pt(Et,"sidebar")]}),Rt?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:u.sidebar.infoActionsHint}),pt(Rt,"sidebar"),Ze?e.jsxs("div",{className:"cogita-sidebar-actions-nested",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(Pe==null?void 0:Pe.label)??he??t.cogita.library.list.selectedEmpty}),e.jsx("p",{className:"cogita-sidebar-note",children:u.sidebar.selectedInfoActionsHint}),pt(Ze,"sidebar")]}):null]}):null,ue?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:ue.name}),e.jsx("p",{className:"cogita-sidebar-note",children:u.sidebar.collectionActionsHint}),pt(gt,"sidebar")]}):null,e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:u.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:i,children:u.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{x("cogita"),y(!1)},children:u.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:o,children:f?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),be?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":u.sidebar.closeMenu,onClick:()=>y(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":u.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>y(d=>!d),"aria-label":be?u.sidebar.closeMenu:u.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),tt.map((d,ve)=>e.jsxs("div",{className:"cogita-browser-segment",children:[ve>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,d.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":d.label,children:d.selectedLabel}):e.jsxs("select",{"aria-label":d.label,value:d.value,onChange:O=>d.onSelect(O.target.value),disabled:d.disabled,children:[d.emptyOption?e.jsx("option",{value:"",children:d.emptyOption}):null,d.options.map(O=>e.jsx("option",{value:O.value,children:O.label},`${d.key}:${O.value}`))]})]},`menu:${d.key}`))]}),wt?e.jsxs(e.Fragment,{children:[R==="new_collection"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.library.actions.createCollection}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{type:"text",value:qe,onChange:d=>et(d.target.value),placeholder:t.cogita.library.collections.namePlaceholder,disabled:!p})]}),e.jsx("button",{type:"button",className:"cta",onClick:te,disabled:!p,children:t.cogita.library.actions.createCollection}),Te?e.jsx("p",{className:"cogita-form-error",children:Te}):null]}):null,R==="all_collections"&&L&&re==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:u.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:u.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Ge,onChange:d=>Ee(d.target.value),placeholder:u.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Se,children:u.revisionForm.createAction}),Te?e.jsx("p",{className:"cogita-form-error",children:Te}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(nn.Provider,{value:!0,children:wt})})]}):null,wt?null:e.jsx(e.Fragment,{children:p?null:e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:He.step}),e.jsx("h2",{children:He.title})]}),e.jsxs("p",{children:[We+1," / ",yt]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:He.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:He.passages.map(d=>e.jsx("p",{children:d},d))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:He.focus.map(d=>e.jsx("span",{children:d},d))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:He.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:lt.map((d,ve)=>e.jsx("button",{type:"button",className:`ghost ${ve===We?"active":""}`,onClick:()=>_e(ve),"aria-label":`${ve+1}`,children:ve+1},`tutorial:${d.title}:${ve}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:We===0,onClick:()=>_e(d=>Math.max(0,d-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:We===yt-1,onClick:()=>_e(d=>Math.min(yt-1,d+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:Be,onChange:d=>Le(d.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:_,children:t.cogita.user.createLibraryAction}),Te?e.jsx("p",{className:"cogita-form-error",children:Te}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),S.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,S.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:S.map(d=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{it({libraryId:d.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:d.name})]},d.libraryId))}):null]})]})]})})]})]})})}const dr=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:nr},Symbol.toStringTag,{value:"Module"}));function ir({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,shareId:l}){const[b,c]=a.useState(null),[u,S]=a.useState("loading"),[ae,J]=a.useState(t.cogita.library.collections.defaultName),[W,k]=a.useState("Cogita Library"),[m,ce]=a.useState([]),[P,p]=a.useState([]),[H,R]=a.useState("idle"),[X,L]=a.useState({current:0,total:0}),[E,se]=a.useState(0),[ie,re]=a.useState(""),[De,he]=a.useState(null),[T,be]=a.useState(null),[y,V]=a.useState(null),[me,Y]=a.useState(null),[F,we]=a.useState([]),[Ne,Te]=a.useState({}),[Fe,Ie]=a.useState({}),[_e,Be]=a.useState(null),[Le,qe]=a.useState(null),[et,Ge]=a.useState(null),[Ee,xe]=a.useState(null),[G,fe]=a.useState({}),oe=a.useRef(0),[ye,Ke]=a.useState(null),Je=a.useRef(null),Ve=a.useRef(null),[$,q]=a.useState(null),[je,M]=a.useState(!1),[K,ue]=a.useState(null),[pe,Q]=a.useState([]),[Ce,ke]=a.useState(null),ze=a.useRef(null),Re=a.useRef(null),[Pe,Me]=a.useState(null),[ct,Ue]=a.useState(0),Xe=a.useRef(null),lt=a.useRef({}),[yt,We]=a.useState(!1),[He,Ct]=a.useState({}),dt=a.useRef(null),Lt=a.useRef(new Set),ot=a.useRef({}),[it,$t]=a.useState([]),[xt,tt]=a.useState(new Set),[at,Et]=a.useState(!1),Rt=Va(),Ze=a.useMemo(()=>new URLSearchParams(Rt.search),[Rt.search]),gt=a.useMemo(()=>Ze.get("key")??"",[Ze]),pt=(b==null?void 0:b.mode)??"random",wt=(b==null?void 0:b.check)??"exact",_=(b==null?void 0:b.limit)??20,te=a.useMemo(()=>ks((b==null?void 0:b.revisionType)??pt),[b,pt]),Se=a.useMemo(()=>{const C=b==null?void 0:b.revisionSettings,U=ln(te,Ze);return Wa(te,C??U)},[b,Ze,te]),d=a.useMemo(()=>t.cogita.library.revision[te.labelKey]??pt,[t,pt,te]),ve=a.useMemo(()=>wt==="exact"?t.cogita.library.revision.checkValue:wt,[t,wt]),Z=u==="ready"?m[E]??null:null,ut=(Z==null?void 0:Z.checkType)==="translation-match"&&Ee,nt=a.useRef(new Map),bt=a.useRef(new Map),ft=a.useRef(new Map),Mt=a.useRef(new Map),ra=a.useMemo(()=>Z?Z.cardType==="vocab"?t.cogita.library.revision.vocabLabel:Z.infoType?Ye(t,Z.infoType):t.cogita.library.revision.infoLabel:"",[t,Z]),Ht=a.useMemo(()=>{var U;return te.id!=="levels"?m.length:((U=He.pool)==null?void 0:U.length)??te.getFetchLimit(_,Se)},[He,Se,te,m.length,_]),Bt=te.getProgressTotal?te.getProgressTotal(m,He,_,Se):te.id==="levels"?Math.min(_,Ht):m.length,jt=Bt?Math.min(E+1,Bt):0,vt=Math.max(1,Number(Se.tries??1)),Dt=Se.compare??"anchors",st=Math.max(0,Math.min(100,Number(Se.minCorrectness??0))),rt=(Se.considerDependencies??"on")==="on",Ft=Math.max(0,Math.min(100,Number(Se.dependencyThreshold??85))),Jt=C=>{const U=C.slice();for(let r=U.length-1;r>0;r-=1){const h=Math.floor(Math.random()*(r+1));[U[r],U[h]]=[U[h],U[r]]}return U},Qt=C=>C.length?C.reduce((r,h)=>r+h,0)/C.length/255*100:0,oa=C=>Qt(C)>=st,Ha=async()=>{const C=await qt(),U=new Map,r=new Map;C.forEach(v=>{const D=`${v.itemType}:${v.itemId}`,w=Vt(v.itemType,v.itemId,v.checkType,v.direction);U.has(D)||U.set(D,[]),U.get(D).push(v),r.has(w)||r.set(w,[]),r.get(w).push(v)});const h=new Map,j=new Map;return U.forEach((v,D)=>h.set(D,Ot(v).score)),r.forEach((v,D)=>j.set(D,Ot(v).score)),{itemKnowness:h,cardKnowness:j}},ba=async C=>{const U=He,r=C.concat(U.active??[]).concat(U.pool??[]).filter((B,ee,ne)=>ne.findIndex(ge=>de(ge)===de(B))===ee);if(!rt){tt(new Set(r.map(de)));return}const{itemKnowness:h,cardKnowness:j}=await Ha(),v=B=>{if(B.cardType!=="info"||B.infoType!=="citation"||B.checkType!=="quote-fragment")return!0;const ee=It(B.direction);if(!(ee!=null&&ee.fragmentId))return!0;const ne=B.description??"";if(!ne.trim())return!0;const le=ia(ne).nodes[ee.fragmentId];if(!le||!le.leftId&&!le.rightId)return!0;const $e=[le.leftId,le.rightId].filter(Qe=>!!Qe);if($e.length===0)return!0;const Ae=$e.map(Qe=>{const ht=Vt("info",B.cardId,"quote-fragment",Na(ee.mode,Qe));return j.get(ht)??0});return Ae.reduce((Qe,ht)=>Qe+ht,0)/Ae.length>=Ft},D=(b==null?void 0:b.collectionId)??null,w=D?it.filter(B=>mt(B.childItemType)==="collection"&&B.childItemId===D&&!mt(B.childCheckType)&&!mt(B.childDirection)):[],z=D&&r.length>0?r.reduce((B,ee)=>B+(j.get(de(ee))??0),0)/r.length:0,I=new Set;for(const B of r){if(B.cardType!=="info"){I.add(de(B));continue}if(!v(B))continue;const ee=it.filter(le=>fn(le,B)).concat(w);if(ee.length===0){I.add(de(B));continue}let ne=0;for(const le of ee)if(mt(le.parentItemType)==="collection")ne+=le.parentItemId===D?z:0;else if(mt(le.parentCheckType)||mt(le.parentDirection)){const $e=mt(le.parentCheckType),Ae=mt(le.parentDirection),Oe=Vt(le.parentItemType,le.parentItemId,$e,Ae);ne+=j.get(Oe)??0}else{const $e=`${le.parentItemType}:${le.parentItemId}`;ne+=h.get($e)??0}ne/ee.length>=Ft&&I.add(de(B))}tt(I)},Qa=C=>{for(let U=C;U<m.length;U+=1){const r=m[U];if(r&&(!rt||r.cardType!=="info"||xt.has(de(r))))return U}return-1},ca=C=>!rt||C.cardType!=="info"||xt.has(de(C)),Ya=C=>{if(te.id!=="temporal"&&te.id!=="levels")return null;const U=He,r=(U.active??[]).concat(U.pool??[]),h=new Set;for(const j of r){const v=de(j);if(!(h.has(v)||C.has(v))&&(h.add(v),ca(j)))return j}return null},At=a.useMemo(()=>{if(te.id!=="levels")return null;const C=He,U=C.pool??[],r=C.active??[],h=C.levelMap??{},j=Math.max(1,Number(Se.levels??1)),v=Array.from({length:j},()=>0),D=new Set(r.map(B=>de(B)));U.forEach(B=>{const ee=Math.min(j,Math.max(1,h[de(B)]??1));v[ee-1]+=1});const w=U.length||1,z=v.map(B=>B/w*100),I=Z?h[de(Z)]??1:null;return{counts:v,percentages:z,currentLevel:I,levelsCount:j,activeCount:r.length,poolCount:U.length,activeSet:D}},[He,Se,te,Z]),la=a.useMemo(()=>{if(te.id!=="temporal")return null;const C=He,U=C.pool??[],r=C.active??[],h=C.knownessMap??{},j=new Set(C.unknownSet??[]);let v=0;U.forEach(z=>{(h[de(z)]??0)>1&&(v+=1)});const D=j.size,w=r.map(z=>({id:de(z),value:j.has(de(z))?0:Math.max(0,Math.min(1,h[de(z)]??0))}));return{knownCount:v,unknownCount:D,dots:w}},[He,te]),Kt=a.useMemo(()=>{if(!rt)return 0;const C=He;return m.concat(C.active??[]).concat(C.pool??[]).filter((r,h,j)=>j.findIndex(v=>de(v)===de(r))===h).filter(r=>r.cardType==="info"&&!xt.has(de(r))).length},[rt,He,m,xt]);a.useEffect(()=>{if(!rt||H!=="ready")return;const C=He,r=m.concat(C.active??[]).concat(C.pool??[]).filter((v,D,w)=>w.findIndex(z=>de(z)===de(v))===D).filter(v=>v.cardType!=="info"||xt.has(de(v))).length,h=ze.current;if(ze.current=r,h===null||r<=h)return;const j=r-h;ke(`New card available (+${j})`),Re.current&&window.clearTimeout(Re.current),Re.current=window.setTimeout(()=>ke(null),2200)},[rt,H,He,m,xt]),a.useEffect(()=>()=>{Re.current&&window.clearTimeout(Re.current)},[]);const kt=(C,U)=>{const r=te.applyOutcome({queue:m,meta:He},Z,_,Se,{correct:C,correctness:U,createdUtc:new Date().toISOString()});ce(r.queue),Ct(r.meta);const h=r.queue[E+1];h&&Pt(h,E+1)};a.useEffect(()=>{if(!l){S("error");return}S("loading"),Qn({shareId:l,key:gt}).then(C=>{c(C),J(C.collectionName),k(C.libraryName),S("ready")}).catch(()=>{S("error")})},[l,gt]),a.useEffect(()=>{l&&Yn({shareId:l,key:gt,type:"language"}).then(C=>p(C)).catch(()=>p([]))},[l,gt]),a.useEffect(()=>{!l||u!=="ready"||Gn({shareId:l,key:gt}).then(C=>$t(C.items??[])).catch(()=>$t([]))},[l,gt,u]),a.useEffect(()=>{if(!l||u!=="ready")return;let C=!0;return(async()=>{R("loading"),L({current:0,total:te.id==="levels"?0:te.getFetchLimit(_,Se)});try{const r=[];let h=null,j=null;do{const ee=await Jn({shareId:l,key:gt,limit:300,cursor:h});if(r.push(...ee.items),(te.id==="levels"||te.id==="temporal")&&ee.total&&(j=ee.total),L(ne=>({current:r.length,total:ne.total||ee.total||te.getFetchLimit(_,Se)})),h=ee.nextCursor??null,j!==null&&r.length>=j||te.id!=="levels"&&te.id!=="temporal"&&r.length>=te.getFetchLimit(_,Se))break}while(h);if(!C)return;const v=hs(r);let D;if(te.id==="levels"){const ee=Math.max(1,Number(Se.levels??1));D={},v.forEach(ne=>{const ge=de(ne);D[ge]=Math.max(1,Math.min(ee,1))})}let w=null,z=null,I=null;if(te.id==="temporal"){const ee=await qt(),ne=new Set(v.map($e=>de($e))),ge=ee.reduce(($e,Ae)=>{const Oe=Vt(Ae.itemType,Ae.itemId,Ae.checkType,Ae.direction);return ne.has(Oe)&&($e[Oe]||($e[Oe]=[]),$e[Oe].push(Ae)),$e},{});w={},z=new Set,I={};const le=Date.now();v.forEach($e=>{const Ae=de($e),Oe=ge[Ae]??[];if(Oe.length===0){w[Ae]=0,z.add(Ae),I[Ae]=[];return}const Qe=vs(Oe);I[Ae]=Qe;const ht=qa(Qe,le);w[Ae]=ht.knowness})}const B=te.id==="levels"?js(v,_,Se,D):te.id==="temporal"?ws(v,_,Se,w??{},z??new Set,I??{}):te.prepare(v,_,Se);ce(B.queue),Ct(B.meta),se(0),R("ready"),L(ee=>({current:Math.min(ee.current,ee.total),total:ee.total}))}catch{C&&R("error")}})(),()=>{C=!1}},[l,gt,_,te,Se,u]),a.useEffect(()=>{ba(m)},[m,it,rt,Ft,b==null?void 0:b.collectionId]),a.useEffect(()=>{if(!Z||!rt){Et(!1);return}if(Z.cardType!=="info"||xt.has(de(Z))){Et(!1);return}const C=Qa(E+1);if(C>=0){Et(!1),se(C);return}if(te.id==="temporal"||te.id==="levels"){const U=m.slice(0,E+1),r=m.slice(E+1).filter(ca),h=U.concat(r),j=new Set(h.map(de)),v=Ya(j);if(v){const w=de(v);j.has(w)||(h.push(v),j.add(w),Ct(z=>{const I=z,B=new Set(I.queued??[]);return B.add(w),{...I,queued:B}}))}const D=h.findIndex((w,z)=>z!==E&&ca(w));if(D>=0){ce(h),se(D),Et(!1);return}}Et(!0)},[Z,xt,rt,E,m,He,te.id]),a.useEffect(()=>{if(re(""),he(null),Me(null),Ue(0),we([]),Te({}),Ie({}),Be(null),qe(null),Ge(null),M(!1),We(!1),q(null),xe(null),fe({}),!Z){be(null),V(null);return}Z.cardType==="info"&&Z.infoType==="computed"&&be(t.cogita.library.revision.loadingComputed);let C=!0;return Pt(Z,E).then(U=>{!C||!U||(be(U.prompt),V(U.expectedAnswer),we(U.computedExpected),Te(U.computedAnswers),Be(U.answerTemplate),qe(U.outputVariables),Ge(U.variableValues))}),()=>{C=!1}},[Z,l,t]),a.useEffect(()=>{if(!Z||Z.cardType!=="info"||Z.infoType!=="citation"){dt.current=null,Lt.current=new Set,Y(null);return}const C=Z.description??"",U=(Z.label??"").trim(),r=U.replace(/\s+/g," ").trim(),h=C.replace(/\s+/g," ").trim(),j=r&&r!==h?U:t.cogita.library.infoTypes.citation;if(!C){Y(null),V(null);return}const v=ia(C);dt.current=v,be(j);let D=!0;return qt().then(w=>{if(!D)return;const z=getQuoteMode(Z.direction),I=new Map;w.forEach(le=>{if(le.itemType!=="info"||le.checkType!=="quote-fragment"||!le.direction)return;const $e=It(le.direction);if(!$e||$e.mode!==z)return;const Ae=`${le.itemId}:${$e.fragmentId}`;I.has(Ae)||I.set(Ae,[]),I.get(Ae).push(le)});const B={},ee=new Set;I.forEach((le,$e)=>{const[Ae,Oe]=$e.split(":",2);if(Ae!==Z.cardId)return;const Qe=Ot(le).score;B[Oe]=Qe,Qe>=Ft&&ee.add(Oe)}),Lt.current=ee,ot.current=B;const ne=It(Z.direction);if(ne!=null&&ne.fragmentId&&v.nodes[ne.fragmentId]){ea(v,ne.fragmentId,j);return}const ge=ma(v,ee,B,Ft,rt,Z.direction);ea(v,(ge==null?void 0:ge.id)??null,j)}).catch(()=>{Lt.current=new Set,ot.current={};const w=It(Z.direction);if(w!=null&&w.fragmentId&&v.nodes[w.fragmentId]){ea(v,w.fragmentId,j);return}const z=ma(v,Lt.current,{},Ft,rt,Z.direction);ea(v,(z==null?void 0:z.id)??null,j)}),()=>{D=!1}},[Z,t,rt,Ft]),a.useEffect(()=>{if(!Z||Z.cardType!=="vocab"||Z.checkType!=="translation-match"){xe(null),fe({});return}const r=(He.pool??He.active??m).filter(w=>w.cardType==="vocab"&&w.checkType==="translation-match").filter((w,z,I)=>I.findIndex(B=>B.cardId===w.cardId)===z);r.some(w=>w.cardId===Z.cardId)||r.unshift(Z);const j=Jt(r).slice(0,6).map(w=>{const z=w.label.split("↔").map(ee=>ee.trim()).filter(Boolean);if(z.length<2)return null;const I=`${w.cardId}:L`,B=`${w.cardId}:R`;return{cardId:w.cardId,leftId:I,rightId:B,leftLabel:z[0],rightLabel:z[1]}}).filter(Boolean),v=j.map(w=>w.leftId),D=Jt(j.map(w=>w.rightId));xe({pairs:j,leftOrder:v,rightOrder:D,selection:{},activeLeft:null,activeRight:null,locked:{}})},[Z,m,He]),a.useEffect(()=>()=>{Je.current&&window.clearTimeout(Je.current),Ve.current&&window.clearTimeout(Ve.current)},[]);const da=a.useRef(null);a.useEffect(()=>{if(!Z)return;const C=de(Z),U=typeof document<"u"?document.activeElement:null;if(da.current===C&&U&&(U.tagName==="INPUT"||U.tagName==="TEXTAREA"))return;let r=0;const h=()=>{if(Z){if(Z.cardType==="info"&&Z.infoType==="computed"){if(F.length>0){const v=_a(_e,F,Le),D=v?lt.current[v]:null;if(D&&(D.focus(),document.activeElement===D)){da.current=C;return}}if(Xe.current&&(Xe.current.focus(),document.activeElement===Xe.current)){da.current=C;return}}else if(Z.cardType==="vocab"&&Xe.current&&(Xe.current.focus(),document.activeElement===Xe.current)){da.current=C;return}r<6&&(r+=1,window.setTimeout(h,40))}},j=window.setTimeout(h,40);return()=>window.clearTimeout(j)},[Z,F,_e,Le]),a.useEffect(()=>{if(!yt)return;const C=U=>{U.key==="Enter"&&(U.preventDefault(),ua())};return window.addEventListener("keydown",C),()=>window.removeEventListener("keydown",C)},[yt]);const Nt=C=>{Q(C),ue(Ot(C))};a.useEffect(()=>{if(!Z){ue(null),Q([]);return}const C=Z.cardType==="info"?"info":"connection";if(Z.cardType==="info"&&Z.infoType==="citation"){qt().then(U=>{const r=U.filter(h=>h.itemType==="info"&&h.itemId===Z.cardId&&h.checkType==="quote-fragment"&&Ba(h.direction,Z.direction));Nt(r)}).catch(()=>{ue(null),Q([])});return}Ka(C,Z.cardId,Z.checkType,Z.direction).then(U=>Nt(U)).catch(()=>{ue(null),Q([])})},[Z]);const Xt=(C,U,r,h)=>{if(C==="info"&&r==="quote-fragment"){qt().then(j=>{const v=j.filter(D=>D.itemType==="info"&&D.itemId===U&&D.checkType==="quote-fragment"&&Ba(D.direction,h));Nt(v)}).catch(()=>{ue(null),Q([])});return}Ka(C,U,r,h).then(j=>Nt(j)).catch(()=>{ue(null),Q([])})},Zt=(C,U,r)=>{var D;const h=((D=r.pairs.find(w=>w.leftId===C))==null?void 0:D.rightId)??null;if(!h)return r;const j=h===U;fe(w=>({...w,[C]:j?"correct":"incorrect"})),Je.current&&window.clearTimeout(Je.current),Ve.current&&window.clearTimeout(Ve.current),oe.current+=1;const v={kind:j?"correct":"incorrect",tick:oe.current};if(Ke(null),Je.current=window.setTimeout(()=>Ke(v),0),Ve.current=window.setTimeout(()=>Ke(null),420),j){const w={...r.locked,[C]:!0};return Object.keys(w).length>=r.pairs.length?(he("correct"),We(!0)):he("correct"),{...r,selection:{...r.selection,[C]:U},activeLeft:null,activeRight:null,locked:w}}return he("incorrect"),{...r,activeLeft:null,activeRight:null}},Ta=C=>{xe(U=>!U||U.locked[C]?U:U.activeRight?Zt(C,U.activeRight,U):{...U,activeLeft:U.activeLeft===C?null:C})},Ca=C=>{xe(U=>U&&(U.activeLeft?Zt(U.activeLeft,C,U):{...U,activeRight:U.activeRight===C?null:C}))},ua=()=>{var C;if(Z&&Z.cardType==="info"&&Z.infoType==="citation"&&dt.current&&me&&!((C=It(Z.direction))!=null&&C.fragmentId)){const U=ma(dt.current,Lt.current,ot.current,Ft,rt,Z.direction,me.fragmentId);if(U){he(null),re(""),M(!1),Ie({}),We(!1),Me(null),Ue(0),ea(dt.current,U.id,me.title);return}}he(null),re(""),M(!1),Ie({}),We(!1),Me(null),Ue(0),se(U=>Math.min(U+1,m.length))},zt=C=>{if(!Z)return;const U=C.expected??null,r=C.answer??"";let h=U??"",j=r;if(!U&&C.expectedMap&&C.answerMap){const ee=Object.keys(C.expectedMap).sort((ne,ge)=>ne.localeCompare(ge));h=ee.map(ne=>{var ge;return((ge=C.expectedMap)==null?void 0:ge[ne])??""}).join("|"),j=ee.map(ne=>{var ge;return((ge=C.answerMap)==null?void 0:ge[ne])??""}).join("|")}const v=h?pa(h,j,Dt):new Uint8Array,D={revisionType:te.id,evalType:C.evalType,direction:C.direction,prompt:T??"",expected:U,answer:r,expectedAnswers:C.expectedMap??null,answers:C.answerMap??null,correct:C.correct,maskBase64:v.length?Yt(v):null,checkMode:wt,compareMode:Dt,minCorrectness:st},w=new TextEncoder().encode(JSON.stringify(D)),z=Z.cardType==="info"?"info":"connection",I=C.overrideCheckType??Z.checkType??null,B=C.overrideDirection??Z.direction??null;Fa({itemType:z,itemId:Z.cardId,checkType:I,direction:B,revisionType:te.id,evalType:C.evalType,correct:C.correct,maskBase64:v.length?Yt(v):null,payloadBase64:Yt(w)}).then(()=>{Xt(z,Z.cardId,I,B),ba(m)}).catch(()=>{})},ha=(C,U)=>{const r=nt.current.get(U);if(r)return Promise.resolve(r);const h=bt.current.get(U);if(h)return h;const j=Xn({shareCode:l,infoId:C,key:gt}).then(v=>{var ee,ne;const D=v.payload,w=((ee=D.definition)==null?void 0:ee.graph)??null,z="",I=((ne=D.definition)==null?void 0:ne.answerTemplate)??"",B=dn(w,z,I);if(B){const le={sample:un(B),answerTemplate:I||null};return nt.current.set(U,le),le}return Cs({shareId:l,infoId:C,key:gt}).then(ge=>{const le={sample:ge,answerTemplate:null};return nt.current.set(U,le),le})}).catch(()=>Cs({shareId:l,infoId:C,key:gt}).then(v=>{const D={sample:v,answerTemplate:null};return nt.current.set(U,D),D}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{bt.current.delete(U)});return bt.current.set(U,j),j},Pt=(C,U)=>{var w;const r=`${de(C)}:${U}`,h=ft.current.get(r);if(h)return Promise.resolve(h);const j=Mt.current.get(r);if(j)return j;const v=z=>(ft.current.set(r,z),z);let D;if(C.cardType==="vocab"){if(C.checkType==="translation-match")return D=Promise.resolve(v({prompt:C.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),D;const z=C.label.split("↔").map(I=>I.trim()).filter(Boolean);if(z.length>=2){const B=(C.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",ee=B?z[0]:z[1],ne=B?z[1]:z[0];D=Promise.resolve(v({prompt:ee,expectedAnswer:ne,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else D=Promise.resolve(v({prompt:C.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(C.cardType==="info"&&C.infoType==="word"){const z=(w=C.description)!=null&&w.startsWith("Language: ")?C.description.replace("Language: ",""):null;D=Promise.resolve(v({prompt:C.label,expectedAnswer:z,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else C.cardType==="info"&&C.infoType==="computed"?D=ha(C.cardId,r).then(z=>{var ge,le;if(!z.sample)return v({prompt:C.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const I=z.sample,B=I.expectedAnswers?Object.entries(I.expectedAnswers).map(([$e,Ae])=>({key:$e,expected:Ae})):[],ee=B.reduce(($e,Ae)=>($e[Ae.key]="",$e),{}),ne=I.expectedAnswerIsSentence&&((ge=I.expectedAnswer)==null?void 0:ge.trim())||null;return v({prompt:I.prompt,expectedAnswer:B.length>0?ne:((le=I.expectedAnswer)==null?void 0:le.trim())||null,computedExpected:B,computedAnswers:ee,answerTemplate:z.answerTemplate,outputVariables:I.outputVariables??null,variableValues:I.variableValues??null})}).catch(()=>v({prompt:C.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Mt.current.delete(r)}):D=Promise.resolve(v({prompt:C.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return Mt.current.set(r,D),D},ea=(C,U,r)=>{const h=Object.keys(C.nodes).length,j=Lt.current.size;if(!U){Y({title:r,before:C.text,after:"",fragmentId:null,total:h,completed:j}),V(null),We(!0);return}const v=C.nodes[U];if(!v)return;const D=ys(C.text,v);Y({title:r,before:D.before,after:D.after,fragmentId:v.id,total:h,completed:j}),V(D.fragment),We(!1)},ya=()=>{const C=dt.current;C&&Y(U=>U&&{...U,total:Object.keys(C.nodes).length,completed:Lt.current.size})},_t=()=>{const C=m[E+1];C&&Pt(C,E+1)},Ma=()=>{if(_t(),Z&&Z.cardType==="vocab"&&Z.checkType==="translation-match"&&Ee){if(Ee.pairs.length===0){he("incorrect"),We(!0);return}const v=Ee.pairs.reduce((ne,ge)=>(ne[ge.rightId]=ge.rightLabel,ne),{});let D=0;const w={};Ee.pairs.forEach(ne=>{const le=Ee.selection[ne.leftId]===ne.rightId;w[ne.leftId]=le?"correct":"incorrect",le&&(D+=1)});const z=Ee.pairs.length||1,I=D/z,B=D===Ee.pairs.length;fe(ne=>({...ne,...w})),B?(he("correct"),We(!0),Ue(0)):(he("incorrect"),We(!1),Ue(ne=>{const ge=ne+1;return ge>=vt&&(M(!0),We(!0),xe(le=>{if(!le)return le;const $e=le.pairs.reduce((Ae,Oe)=>(Ae[Oe.leftId]=Oe.rightId,Ae),{});return{...le,selection:$e}})),ge})),kt(B,I);const ee="connection";Promise.all(Ee.pairs.map(ne=>{const ge=Ee.selection[ne.leftId]??null,le=ge?v[ge]:"",$e={left:ne.leftLabel,expected:ne.rightLabel,answer:le,checkType:"translation-match"},Ae=new TextEncoder().encode(JSON.stringify($e));return Fa({itemType:ee,itemId:ne.cardId,checkType:"translation-match",direction:null,revisionType:te.id,evalType:"translation-match",correct:ge===ne.rightId,maskBase64:null,payloadBase64:Yt(Ae)})})).then(()=>{Xt(ee,Z.cardId,Z.checkType,Z.direction),ba(m)}).catch(()=>{});return}if(F.length>0){const v=F.reduce((w,z)=>{const I=Ne[z.key]??"";return w[z.key]=St(I)===St(z.expected)?"correct":"incorrect",w},{});F.every(({key:w,expected:z})=>{const I=Ne[w]??"";return wt==="exact"&&St(I)===St(z)})?(he("correct"),Ie(v),We(!0),Ue(0),kt(!0,1),zt({correct:!0,direction:T?`${T} -> computed`:"computed",expectedMap:F.reduce((w,z)=>(w[z.key]=z.expected,w),{}),answerMap:Ne,evalType:"computed"})):(he("incorrect"),Ie(v),We(!1),Ue(w=>{const z=w+1;return z>=vt&&ta&&(M(!0),We(!0)),z}),kt(!1,0),window.setTimeout(()=>{var z;const w=_a(_e,F,Le);w&&lt.current[w]&&((z=lt.current[w])==null||z.focus())},40),zt({correct:!1,direction:T?`${T} -> computed`:"computed",expectedMap:F.reduce((w,z)=>(w[z.key]=z.expected,w),{}),answerMap:Ne,evalType:"computed"}));return}if(Z&&Z.cardType==="info"&&Z.infoType==="citation"&&(me!=null&&me.fragmentId)){if(!y)return;const v=It(Z.direction),D=(v==null?void 0:v.mode)??getQuoteMode(Z.direction),w=v!=null&&v.fragmentId&&Z.direction?Z.direction:Na(D,me.fragmentId),z=pn(y,ie,Dt),I=wt==="exact"&&fa(ie)===fa(y),B=oa(z),ee=I||B,ne=Qt(z);ee?(ot.current[me.fragmentId]=Math.max(ot.current[me.fragmentId]??0,ne),(ot.current[me.fragmentId]??0)>=Ft&&Lt.current.add(me.fragmentId),ya(),he("correct"),Ie({}),We(!0),Me(z),Ue(0),ne<100&&vt<=1&&M(!0),kt(!0,ne/100),zt({correct:!0,direction:`quote:${me.fragmentId}`,expected:y,answer:ie,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:w})):(he("incorrect"),Ie({}),We(!1),Me(z),Ue(ge=>{const le=ge+1;return le>=vt&&ta&&(M(!0),We(!0)),le}),kt(!1,ne/100),window.setTimeout(()=>{var ge;return(ge=Xe.current)==null?void 0:ge.focus()},40),zt({correct:!1,direction:`quote:${me.fragmentId}`,expected:y,answer:ie,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:w}));return}if(!y)return;const C=pa(y,ie,Dt),U=wt==="exact"&&St(ie)===St(y),r=oa(C),h=U||r,j=Qt(C);h?(he("correct"),Ie({}),We(!0),Me(C),Ue(0),j<100&&vt<=1&&M(!0),kt(!0,j/100),zt({correct:!0,direction:T?`${T} -> ${y}`:null,expected:y,answer:ie,evalType:"text"})):(he("incorrect"),Ie({}),We(!1),Me(C),Ue(v=>{const D=v+1;return D>=vt&&ta&&(M(!0),We(!0)),D}),kt(!1,j/100),window.setTimeout(()=>{var v;return(v=Xe.current)==null?void 0:v.focus()},40),zt({correct:!1,direction:T?`${T} -> ${y}`:null,expected:y,answer:ie,evalType:"text"}))},ga=C=>{if(_t(),!y)return;const U=pa(y,C,Dt),r=St(C)===St(y),h=oa(U),j=r||h,v=Qt(U);j?(he("correct"),Ie({}),We(!0),Me(U),Ue(0),v<100&&vt<=1&&M(!0),kt(!0,v/100),zt({correct:!0,direction:"word->language",expected:y,answer:C,evalType:"language-select"})):(he("incorrect"),Ie({}),We(!1),Me(U),Ue(D=>{const w=D+1;return w>=vt&&ta&&(M(!0),We(!0)),w}),kt(!1,v/100),zt({correct:!1,direction:"word->language",expected:y,answer:C,evalType:"language-select"}))},Ia=C=>{var r;if(C.key!=="Enter")return;if(C.preventDefault(),C.stopPropagation(),yt){ua();return}const U=F.find(h=>!(Ne[h.key]??"").trim());if(U){(r=lt.current[U.key])==null||r.focus();return}Ma()},Ga=()=>{_t(),he("correct"),We(!0),Ue(0),kt(!0,1),y&&zt({correct:!0,direction:"manual",expected:y,answer:ie,evalType:"manual"})},Ja=()=>{if(kt(!1,0),Z&&Z.cardType==="info"&&Z.infoType==="citation"){he(null),re(""),M(!1),Ie({}),We(!1),Me(null),Ue(0),se(C=>Math.min(C+1,m.length));return}ua()};a.useEffect(()=>{_t()},[E,m]);const Xa=t.cogita.library.revision.revealModeAfterIncorrect,ta=F.length>0||!!y;return e.jsxs(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:x,language:A,onLanguageChange:N,children:[(u==="loading"||H==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:u==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${X.total?Math.min(100,Math.max(0,X.current/X.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:X.total?`${Math.min(X.current,X.total)} / ${X.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:ae}),e.jsx("p",{className:"cogita-library-subtitle",children:W}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",d).replace("{check}",ve)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:K?`${K.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[At?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",At.currentLevel??"-"," / ",At.levelsCount]}):null,K?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(K.correct)).replace("{total}",String(K.total))}),K.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(K.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(hn,{outcomes:pe})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[Ce?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:Ce})}):null,e.jsx("section",{className:"cogita-revision-card","data-feedback":ye?`${ye.kind}-${ye.tick}`:ut?"idle":De??"idle",children:u!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:u==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):Z?e.jsx(e.Fragment,{children:at?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(xs,{copy:t,currentCard:Z,currentTypeLabel:ra,prompt:T,languages:P,answer:ie,onAnswerChange:C=>re(U=>Da(U,C,$)),computedExpected:F,computedAnswers:Ne,onComputedAnswerChange:(C,U)=>Te(r=>({...r,[C]:Da(r[C]??"",U,$)})),answerTemplate:_e,outputVariables:Le,variableValues:et,computedFieldFeedback:Fe,feedback:De,canAdvance:yt,quoteContext:me,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Ma,onSkip:Ja,onLanguageSelect:ga,onMarkReviewed:Ga,onAdvance:ua,showCorrectAnswer:je,setShowCorrectAnswer:M,onRevealCorrect:()=>We(!0),answerMask:Pe,expectedAnswer:y,hasExpectedAnswer:ta,handleComputedKeyDown:Ia,answerInputRef:Xe,computedInputRefs:lt,scriptMode:$,setScriptMode:q,matchPairs:Ee==null?void 0:Ee.pairs,matchLeftOrder:Ee==null?void 0:Ee.leftOrder,matchRightOrder:Ee==null?void 0:Ee.rightOrder,matchSelection:Ee==null?void 0:Ee.selection,matchActiveLeft:Ee==null?void 0:Ee.activeLeft,matchActiveRight:Ee==null?void 0:Ee.activeRight,matchFeedback:G,onMatchLeftSelect:Ta,onMatchRightSelect:Ca})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Bt?`${jt} / ${Bt}`:t.cogita.library.revision.progressUnlimited}),u==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),u==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),u==="ready"&&H==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),u==="ready"&&H==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),u==="ready"&&H==="ready"&&m.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Xa}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",vt]})]})]}),At?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",At.activeCount," / ",At.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:At.counts.map((C,U)=>{const r=U+1,h=At.currentLevel===r,j=At.percentages[U]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":h,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:r}),e.jsx("strong",{children:C})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,j))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[j.toFixed(1),"%"]})]},`level-${r}`)})})]}):null,la?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:la.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:la.dots.map(C=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-C.value))}, ${Math.round(200*C.value)}, 80, 0.9)`}},C.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:la.knownCount})]})]}):null,rt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Kt})]})}):null]})]})]})})})]})]})}const ur=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:ir},Symbol.toStringTag,{value:"Module"}));export{lr as C,dr as a,ur as b};
