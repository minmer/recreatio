import{r as a,j as e,u as $s,a as Rs,b as Es,c as As,R as Fs,B as Ps,C as Bs,d as ds}from"./vendor-B-s_ukyJ.js";import{L as _s,A as Ks,g as qs,a as cn,b as va,c as Ds,s as ps,d as Vs,e as bs,f as us,h as Os,i as dn,j as ua,u as un,k as hn,p as gn,l as mn,m as Us,r as zs,n as fn,o as pn,q as bn,t as qa,v as $a,w as yn,x as xn,y as vn,z as wn,B as jn,C as kn,D as Nn,E as ys,F as Ht,G as Tn,H as Sn,I as Cn,J as Mn,K as In,M as Ln,N as $n,O as Rn,P as En,Q as An,R as Fn,S as Pn,T as Bn,U as _n,V as Kn,W as qn,X as xs}from"./recreatio-core-B7V_U7t3.js";import"./vendor-cogita-ui-BuvhRVJJ.js";const xa={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},ya={moveMs:900,pauseMs:220,errorMs:900},Dn=(t=11)=>{let s=t;const n=()=>(s=(s*1664525+1013904223)%4294967296,s/4294967296),{width:r,height:l,paddingX:m,paddingY:b,levels:y}=xa,E=(l-b*2)/(y.length-1),j=[],d=[],k=[];y.forEach((v,h)=>{const re=l-b-h*E,B=r-m*2,g=[];for(let z=0;z<v;z+=1){const L=m+(z+1)*B/(v+1),G=(n()-.5)*18,S=Math.max(m,Math.min(r-m,L+G)),R=h===0?3:h<2?2.1:1.4,ee=h===0?"root":`l${h}-${z}`;g.push({id:ee,x:h===0?r/2:S,y:re,r:R,level:h,role:h===0?"root":void 0})}k.push(g),j.push(...g)});const c=k[k.length-1];if(c!=null&&c.length){const v=c[Math.floor(c.length/2)];v.role="goal",v.r=2}for(let v=1;v<k.length;v+=1){const h=k[v-1];k[v].forEach(B=>{const g=[...h].sort((S,R)=>Math.abs(S.x-B.x)-Math.abs(R.x-B.x)),z=g[0],L=g[1]&&n()<.45?g[1]:null;(L?[z,L]:[z]).forEach(S=>{d.push({from:S.id,to:B.id,key:`${S.id}-${B.id}`})}),n()<.2&&g[2]&&d.push({from:g[2].id,to:B.id,key:`${g[2].id}-${B.id}`})})}const o=new Map;d.forEach(v=>{const h=o.get(v.to)??[];h.push(v.from),o.set(v.to,h)});const U=new Map,de=new Map,Y=new Map;d.forEach(v=>{const h=U.get(v.from)??[];h.push(v.key),U.set(v.from,h);const re=de.get(v.from)??[];re.push(v.to),de.set(v.from,re);const B=Y.get(v.from)??[];B.push(v.to),Y.set(v.from,B);const g=Y.get(v.to)??[];g.push(v.from),Y.set(v.to,g)});const W=new Map;return j.forEach(v=>{W.set(v.id,v)}),{nodes:j,links:d,parentsById:o,linksByFrom:U,childrenByFrom:de,neighborsById:Y,nodesById:W}};function Vn({slides:t,activeIndex:s,introOpen:n,prefersReducedMotion:r,onNext:l,onPrev:m,onSelect:b,onExit:y,onOpen:E,onRegister:j}){const d=s===t.length-1,k=n&&s===0?"entry":"docked",c=t[t.length-1],[o,U]=a.useState(!1),de=a.useMemo(()=>Array.from({length:20},(I,X)=>({src:`/cogita/logo/Cogita${String(X).padStart(2,"0")}.png`,kind:X<=11?"bubble":X<=17?"text":"recreatio"})),[]),Y=n&&s===0;a.useEffect(()=>{if(!n){U(!1);return}s>0&&!o&&U(!0)},[s,n,o]);const W=a.useRef(0),v=a.useRef(null),h=a.useMemo(()=>{const I={x:40,y:160},X={x:260,y:48},xe=6,$=X.x-I.x,O=I.y-X.y,pe=$/xe,Me=[.3,.45,.6,.65,1.4,2.2],be=Me.reduce((Ee,Ne)=>Ee+Ne,0),$e=Me.map(Ee=>O*Ee/be),ze=[I];let We=I.x,Re=I.y;for(let Ee=1;Ee<=xe;Ee+=1){const Ne=(Math.random()-.5)*14,st=(Math.random()-.5)*28;We=Math.max(I.x+Ee*14,Math.min(X.x-(xe-Ee)*14,We+pe+Ne));const He=$e[Ee-1]??$e[$e.length-1];Re=Re-He+st;const Je=Math.max(X.y,Math.min(I.y-4,Re));ze.push({x:Math.round(We),y:Math.round(Je)})}return ze[ze.length-1]=X,ze},[]),re=a.useMemo(()=>{const O=(be,$e,ze)=>Math.min(ze,Math.max($e,be)),pe=h.map(be=>{const $e=10+Math.random()*36;return{x:O(be.x,40,260),y:O(be.y-$e,40,140)}}),Me=h.map((be,$e)=>{var Re;const ze=12+Math.random()*40,We=((Re=pe[$e])==null?void 0:Re.y)??be.y;return{x:O(be.x,40,260),y:O(Math.max(We+10,be.y+ze),60,170)}});return{upper:pe,lower:Me}},[h]),B=a.useMemo(()=>{var X;const I=((X=h[4])==null?void 0:X.x)??260;return Math.max(0,Math.min(240,I-40))},[h]),g=a.useMemo(()=>{var $e,ze;const I=(We,Re,Ee)=>Math.min(Ee,Math.max(Re,We)),X=(We,Re,Ee)=>h.map((Ne,st)=>{var ht,ot;const He=((ht=re.upper[st])==null?void 0:ht.y)??Ne.y,Je=((ot=re.lower[st])==null?void 0:ot.y)??Ne.y,mt=(Math.random()-.5)*70,jt=Ne.y+We+mt,Ye=I(Ne.y+Re,He+6,Je-6),Ze=I(Ne.y+Ee,He+6,Je-6);return{x:Ne.x,y:I(jt,Math.min(Ye,Ze),Math.max(Ye,Ze))}}),xe=-14+Math.random()*28,$=14+Math.random()*28,O=X(xe,-80,12),pe=X($,-12,80);for(let We=4;We<h.length;We+=1){const Re=h[We],Ee=(($e=re.upper[We])==null?void 0:$e.y)??Re.y,Ne=((ze=re.lower[We])==null?void 0:ze.y)??Re.y;O[We]={x:Re.x,y:I(Re.y-12,Ee+6,Ne-6)},pe[We]={x:Re.x,y:I(Re.y+12,Ee+6,Ne-6)}}const Me=re.upper.length?re.upper[re.upper.length-1].y:40,be=re.lower.length?re.lower[re.lower.length-1].y:170;return O[O.length-1]={x:h[h.length-1].x,y:I(h[h.length-1].y-14,Me,be)},pe[pe.length-1]={x:h[h.length-1].x,y:I(h[h.length-1].y+12,Me,be)},{higher:O,lower:pe}},[h,re]),z=1e4,L=a.useMemo(()=>{let I=17;const X=()=>(I=(I*1664525+1013904223)%4294967296,I/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map(($,O)=>{const pe=(X()-.5)*240,Me=(X()-.5)*180,be=(X()-.5)*24;return{id:`card-${O+1}`,throw:{x:`${pe.toFixed(0)}px`,y:`${Me.toFixed(0)}px`,rot:`${be.toFixed(1)}deg`},grid:{x:`${$.x}px`,y:`${$.y}px`},delay:`${O*.12}s`}})},[]),G=a.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[S,R]=a.useState([]),ee=a.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),te=a.useMemo(()=>{const X=[],$=(pe,Me)=>pe+Math.random()*(Me-pe);for(let pe=0;pe<6;pe+=1){let Me=!1;for(let be=0;be<80;be+=1){const $e=$(14,86),ze=$(10,34);if(X.every(Re=>{const Ee=Re.x-$e,Ne=Re.y-ze;return Math.hypot(Ee,Ne)>=12})){X.push({x:$e,y:ze}),Me=!0;break}}Me||X.push({x:$(16,84),y:$(12,32)})}return X.map((pe,Me)=>({id:`p${Me+1}`,x:`${pe.x.toFixed(1)}%`,y:`${pe.y.toFixed(1)}%`,xNum:pe.x,yNum:pe.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[ae,Pe]=a.useState(0),[ue,C]=a.useState(0),[fe,x]=a.useState([]),V=1e4,he=a.useMemo(()=>{if(te.length<2)return[];const I=Me=>{let be=Me+1831565813;return be=Math.imul(be^be>>>15,be|1),be^=be+Math.imul(be^be>>>7,be|61),((be^be>>>14)>>>0)/4294967296},X=(Me,be)=>Math.floor(I(Me)*be),xe=new Set,$=[],O=Math.min(3,te.length);let pe=0;for(;$.length<O&&pe<30;){pe+=1;const Me=X(ae*13+pe*5,te.length),be=X(ae*29+pe*7,te.length);if(Me===be)continue;const $e=Me<be?`${Me}-${be}`:`${be}-${Me}`;xe.has($e)||(xe.add($e),$.push({id:`link-${$e}`,from:te[Me],to:te[be],delay:`${(pe*.35).toFixed(2)}s`}))}return $},[ae,te]);a.useEffect(()=>{if(!n||s!==2)return;const I=()=>{const xe=L.map($=>$.id);for(let $=xe.length-1;$>0;$-=1){const O=Math.floor(Math.random()*($+1));[xe[$],xe[O]]=[xe[O],xe[$]]}return xe.slice(0,4)};R(I());const X=window.setInterval(()=>{R(I())},z);return()=>window.clearInterval(X)},[s,n,L,z]),a.useEffect(()=>{if(!n||s!==3)return;const I=()=>{C(Math.floor(Math.random()*ee.length)),x(te.map(()=>Math.random()<.6?"good":"bad")),Pe(xe=>xe+1)};I();const X=window.setInterval(I,V);return()=>window.clearInterval(X)},[s,n,ee.length,te,V]);const _=a.useMemo(()=>Dn(11),[]),[H,ke]=a.useState(new Set(["root"])),[Se,ve]=a.useState(new Set),[Ae,we]=a.useState(new Set),[Be,_e]=a.useState({fromId:"root",toId:"root",key:0}),je=a.useRef(H),Ke=a.useRef("root"),Xe=a.useRef(0),Qe=a.useRef(null),K=a.useRef(null),Q=a.useRef([]);a.useEffect(()=>{je.current=H},[H]);const Ve=a.useMemo(()=>{const I=new Set;return H.forEach(X=>{const xe=_.linksByFrom.get(X);xe&&xe.forEach($=>I.add($))}),I},[H,_]),Ce=_.nodesById.get(Be.toId)??_.nodesById.get("root"),le=Ce?`${Ce.x/xa.width*100}%`:"50%",Le=Ce?`${Ce.y/xa.height*100}%`:"90%";a.useEffect(()=>{if(!n||s!==1||r)return;(()=>{ke(new Set(["root"])),ve(new Set),we(new Set),_e({fromId:"root",toId:"root",key:0}),K.current=null,Xe.current=0,Ke.current="root",Q.current=[]})();const X=()=>{const $=Ke.current,O=je.current,Me=(_.childrenByFrom.get($)??[]).filter(Ne=>!O.has(Ne));if(Me.length)return Me[Math.floor(Math.random()*Me.length)];if(O.size>=_.nodes.length){const Ne=_.neighborsById.get($)??[];return Ne.length?Ne[Math.floor(Math.random()*Ne.length)]:null}const be=Ne=>(_.childrenByFrom.get(Ne)??[]).some(He=>!O.has(He)),$e=[$],ze=new Set([$]),We=new Map;let Re=null;for(;$e.length;){const Ne=$e.shift();if(!Ne)break;if(Ne!==$&&be(Ne)){Re=Ne;break}(_.neighborsById.get(Ne)??[]).forEach(He=>{ze.has(He)||(ze.add(He),We.set(He,Ne),$e.push(He))})}if(!Re)return null;let Ee=Re;for(;We.get(Ee)&&We.get(Ee)!==$;)Ee=We.get(Ee)??Ee;return Ee},xe=($,O)=>{if($===O){const pe=X();pe&&xe($,pe);return}Xe.current+=1,_e({fromId:$,toId:O,key:Xe.current}),Ke.current=O,Qe.current=window.setTimeout(()=>{const pe=_.parentsById.get(O)??[],Me=je.current,be=pe.filter(Re=>!Me.has(Re));if(!be.length){const Re=new Set(Me);Re.add(O),ke(Re),Qe.current=window.setTimeout(()=>{for(;Q.current.length;){const Ne=Q.current[Q.current.length-1];if(!Re.has(Ne)){if(Ne!==O){xe(O,Ne);return}break}Q.current.pop()}const Ee=X();Ee&&xe(O,Ee)},ya.pauseMs);return}const $e=new Set([O,...be]),ze=new Set(be.map(Re=>`${Re}-${O}`));ve($e),we(ze),Q.current.includes(O)||Q.current.push(O);const We=be[Math.floor(Math.random()*be.length)];K.current={fromId:O,toId:We},Qe.current=window.setTimeout(()=>{ve(new Set),we(new Set);const Re=K.current;Re&&xe(Re.fromId,Re.toId)},ya.errorMs)},ya.moveMs)};return Qe.current=window.setTimeout(()=>{const $=X();$&&xe(Ke.current,$)},ya.pauseMs),()=>{Qe.current&&window.clearTimeout(Qe.current)}},[s,n,_,r]);const qe=I=>{if(!n)return;const X=Date.now();X-W.current<520||Math.abs(I.deltaY)<10||(W.current=X,I.deltaY>0?l():m(),I.preventDefault())},q=I=>{if(!n)return;const X=I.touches[0];X&&(v.current={x:X.clientX,y:X.clientY})},ge=I=>{if(!n)return;const X=v.current;if(v.current=null,!X)return;const xe=I.changedTouches[0];if(!xe)return;const $=xe.clientX-X.x,O=xe.clientY-X.y;Math.abs(O)<40||Math.abs(O)<Math.abs($)||(O<0?l():m())};return e.jsxs("div",{className:`cogita-intro ${n?"is-open":"is-closed"} ${r?"is-reduced":""} ${d?"is-final":""}`,"data-slide":s+1,onWheel:qe,onTouchStart:q,onTouchEnd:ge,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":k,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${Y&&!o?"is-entry":""}`,children:de.map((I,X)=>e.jsx("img",{src:I.src,alt:"",className:`cogita-logo-layer ${X===0?"is-base":""} ${I.kind==="text"?"is-text":I.kind==="recreatio"?"is-recreatio":""} ${I.kind==="bubble"?"is-bubble":""}`},I.src))})}),n&&t.map((I,X)=>{const xe=X===s;return e.jsxs("section",{className:`cogita-intro-slide slide-${X+1} ${xe?"is-active":""}`,"aria-hidden":!xe,children:[e.jsxs("div",{className:"cogita-intro-text",children:[I.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:I.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:I.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:I.title}),I.body&&e.jsx("p",{children:I.body.split(`
`).map(($,O)=>e.jsxs("span",{children:[$,O===0&&e.jsx("br",{})]},String(O)))})]}),I.micro&&e.jsx("p",{className:"cogita-intro-micro",children:I.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:d?j:l,children:I.cta}),d&&I.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>b(0),children:I.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[X===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${xa.width} ${xa.height}`,preserveAspectRatio:"none",children:[_.links.map($=>{const O=_.nodesById.get($.from),pe=_.nodesById.get($.to);if(!O||!pe)return null;const Me=Ve.has($.key),be=Ae.has($.key);return e.jsx("line",{className:`map-link ${Me?"is-active":""} ${be?"is-error":""}`,x1:O.x,y1:O.y,x2:pe.x,y2:pe.y},$.key)}),_.nodes.map($=>{const O=H.has($.id),pe=Se.has($.id);return e.jsx("circle",{className:`map-node ${$.role?`is-${$.role}`:""} ${O?"is-active":""} ${pe?"is-error":""}`,cx:$.x,cy:$.y,r:$.r},$.id)})]}),Ce&&e.jsx("span",{className:"map-explorer-dot",style:{left:le,top:Le,"--move":`${ya.moveMs}ms`}})]}),X===2&&e.jsx("div",{className:"cogita-index-cards",children:L.map($=>{const O=S.indexOf($.id),pe=O>=0?G[O]:null,Me=(pe==null?void 0:pe.x)??"140px",be=(pe==null?void 0:pe.y)??"140px",$e=O>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":$.throw.x,"--throw-y":$.throw.y,"--throw-rot":$.throw.rot,"--grid-x":$.grid.x,"--grid-y":$.grid.y,"--stack-x":Me,"--stack-y":be,"--stack-opacity":$e,"--delay":$.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},$.id)})}),X===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[ee.map(($,O)=>e.jsxs("div",{className:`round-card ${O===ue?"is-active":""}`,style:{"--card-x":$.x,"--card-y":$.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},$.id)),ee[ue]&&e.jsx("span",{className:"round-ring",style:{"--card-x":ee[ue].x,"--card-y":`calc(${ee[ue].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:te.map($=>e.jsx("span",{className:"player-dot",style:{left:$.x,top:$.y,"--jitter-x":$.jitterX,"--jitter-y":$.jitterY,"--breath-delay":$.delay}},$.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:he.map($=>e.jsx("line",{className:"round-link",x1:$.from.xNum,y1:$.from.yNum,x2:$.to.xNum,y2:$.to.yNum,style:{"--delay":$.delay}},$.id))}),e.jsx("div",{className:"round-flows",children:te.map(($,O)=>{const pe=fe[O]??"good",Me=ee[ue];if(!Me)return null;const be=`calc(${Me.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":$.x,"--from-y":$.y,"--to-x":Me.x,"--to-y":be,"--delay":`${O*.12}s`}}),e.jsx("span",{className:`return-dot is-${pe}`,style:{"--from-x":Me.x,"--from-y":be,"--to-x":$.x,"--to-y":$.y,"--delay":`${O*.12}s`}}),e.jsx("span",{className:`result-pop is-${pe}`,style:{"--at-x":$.x,"--at-y":$.y,"--delay":`${O*.12}s`}})]},`${$.id}-${ae}`)})})]},`round-${ae}`),X===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${h[0].x} ${h[0].y} L${h[1].x} ${h[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${h[1].x} ${h[1].y} L${h[2].x} ${h[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${h[2].x} ${h[2].y} L${h[3].x} ${h[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${h[3].x} ${h[3].y} L${h[4].x} ${h[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${h[4].x} ${h[4].y} L${h[5].x} ${h[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${h[5].x} ${h[5].y} L${h[6].x} ${h[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${B};${B};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${re.upper.map(($,O)=>`${O===0?"M":"L"}${$.x} ${$.y}`).join(" ")} ${re.lower.slice().reverse().map($=>`L${$.x} ${$.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${re.upper.map(($,O)=>`${O===0?"M":"L"}${$.x} ${$.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${re.lower.map(($,O)=>`${O===0?"M":"L"}${$.x} ${$.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[g.higher.slice(0,6).map(($,O)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${O+1}`,d:`M${$.x} ${$.y} L${g.higher[O+1].x} ${g.higher[O+1].y}`,pathLength:"100"},`peer-1-${O}`)),g.lower.slice(0,6).map(($,O)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${O+1}`,d:`M${$.x} ${$.y} L${g.lower[O+1].x} ${g.lower[O+1].y}`,pathLength:"100"},`peer-2-${O}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${h[0].x/300*100}%`,"--p0y":`${h[0].y/200*100}%`,"--p1x":`${h[1].x/300*100}%`,"--p1y":`${h[1].y/200*100}%`,"--p2x":`${h[2].x/300*100}%`,"--p2y":`${h[2].y/200*100}%`,"--p3x":`${h[3].x/300*100}%`,"--p3y":`${h[3].y/200*100}%`,"--p4x":`${h[4].x/300*100}%`,"--p4y":`${h[4].y/200*100}%`,"--p5x":`${h[5].x/300*100}%`,"--p5y":`${h[5].y/200*100}%`,"--p6x":`${h[6].x/300*100}%`,"--p6y":`${h[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${g.higher[0].x/300*100}%`,"--q0y":`${g.higher[0].y/200*100}%`,"--q1x":`${g.higher[1].x/300*100}%`,"--q1y":`${g.higher[1].y/200*100}%`,"--q2x":`${g.higher[2].x/300*100}%`,"--q2y":`${g.higher[2].y/200*100}%`,"--q3x":`${g.higher[3].x/300*100}%`,"--q3y":`${g.higher[3].y/200*100}%`,"--q4x":`${g.higher[4].x/300*100}%`,"--q4y":`${g.higher[4].y/200*100}%`,"--q5x":`${g.higher[5].x/300*100}%`,"--q5y":`${g.higher[5].y/200*100}%`,"--q6x":`${g.higher[6].x/300*100}%`,"--q6y":`${g.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${g.lower[0].x/300*100}%`,"--q0y":`${g.lower[0].y/200*100}%`,"--q1x":`${g.lower[1].x/300*100}%`,"--q1y":`${g.lower[1].y/200*100}%`,"--q2x":`${g.lower[2].x/300*100}%`,"--q2y":`${g.lower[2].y/200*100}%`,"--q3x":`${g.lower[3].x/300*100}%`,"--q3y":`${g.lower[3].y/200*100}%`,"--q4x":`${g.lower[4].x/300*100}%`,"--q4y":`${g.lower[4].y/200*100}%`,"--q5x":`${g.lower[5].x/300*100}%`,"--q5y":`${g.lower[5].y/200*100}%`,"--q6x":`${g.lower[6].x/300*100}%`,"--q6y":`${g.lower[6].y/200*100}%`}})]})})}),X===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),X===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},I.id)}),!n&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:c.title}),c.body&&e.jsx("p",{children:c.body}),c.micro&&e.jsx("p",{className:"cogita-intro-micro",children:c.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:j,children:c.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:E,children:"Otwórz pokaz"})]})]})})]}),n&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((I,X)=>e.jsx("button",{type:"button",className:`dot ${s===X?"active":""}`,"aria-label":I.title,onClick:()=>b(X)},I.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:y,children:"Pomiń"})]})]})}const On=6,Un=4;function zn({copy:t,onAuthAction:s,authLabel:n,showProfileMenu:r,onProfileNavigate:l,onToggleSecureMode:m,onLogout:b,secureMode:y,onNavigate:E,language:j,onLanguageChange:d}){const k=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}E("home")},c=a.useRef(null),o=a.useRef([]),U=a.useMemo(()=>{let x=Date.now()%2147483647;const V=()=>(x=x*48271%2147483647,x/2147483647);return Array.from({length:On},(he,_)=>{const H=6+V()*8,ke=7+V()*10,Se=6+V()*9,ve=-V()*H,Ae=-V()*ke,we=-V()*Se,Be=.18+V()*.28,_e=12+V()*18,je=4+V()*8,Ke=(V()-.5)*3.2,Xe=(V()-.5)*3.8,Qe=V()>.5?"alternate":"alternate-reverse",K=V()>.5?"alternate":"alternate-reverse",Q=V()>.5?"alternate":"alternate-reverse",Ve=.18+V()*.42,Ce=30+V()*60,le=-45-V()*38,Le=188+V()*32,qe=.1+V()*.2;return{id:`wave-${_+1}`,style:{"--wave-sway-duration":`${H}s`,"--wave-scale-duration":`${ke}s`,"--wave-drift-duration":`${Se}s`,"--wave-sway-delay":`${ve}s`,"--wave-scale-delay":`${Ae}s`,"--wave-drift-delay":`${we}s`,"--wave-sway-dir":Qe,"--wave-scale-dir":K,"--wave-drift-dir":Q,"--wave-scale":`${Be}`,"--wave-shift":`${_e}%`,"--wave-xshift":`${je}%`,"--wave-x0":`${Ke}%`,"--wave-y0":`${Xe}%`,"--wave-opacity":`${Ve}`,"--wave-blur":`${Ce}px`,"--wave-bottom":`${le}%`,"--wave-hue":`${Le}`,"--wave-glow":`${qe}`}}})},[]),de=a.useMemo(()=>{let x=Date.now()*3%2147483647;const V=()=>(x=x*48271%2147483647,x/2147483647);return Array.from({length:Un},(he,_)=>{const H=180+V()*220,ke=220+V()*280,Se=-V()*H,ve=-V()*ke,Ae=.12+V()*.22,we=3+V()*7,Be=1+V()*3,_e=(V()-.5)*2.8,je=(V()-.5)*2.2;return{id:`mesh-${_+1}`,seed:1e3+_*991+Math.floor(V()*999),style:{"--mesh-sway-duration":`${H}s`,"--mesh-drift-duration":`${ke}s`,"--mesh-sway-delay":`${Se}s`,"--mesh-drift-delay":`${ve}s`,"--mesh-scale":`${Ae}`,"--mesh-shift":`${we}%`,"--mesh-xshift":`${Be}%`,"--mesh-x0":`${je}%`,"--mesh-y0":`${_e}%`}}})},[]),Y=a.useMemo(()=>{const x=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],V=t.cogita.introSlides,he=new Map(V.map(_=>[_.id,_]));return x.map(_=>{var ke;const H=he.get(_.id);return{..._,...H,title:(H==null?void 0:H.title)??"Cogita",cta:(H==null?void 0:H.cta)??((ke=t.cogita.introSlides[0])==null?void 0:ke.cta)??t.cogita.loginCta,secondary:H==null?void 0:H.secondary}})},[t.cogita.introSlides]),[W,v]=a.useState(0),[h,re]=a.useState(!0),[B,g]=a.useState(!1),z=Y.length-1,L=a.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),G=a.useCallback(()=>{L(),s()},[L,s]),S=a.useCallback(()=>{re(!0),v(0)},[]),R=a.useCallback(()=>{re(!1),v(z)},[z]),ee=a.useCallback(x=>{v(Math.max(0,Math.min(z,x)))},[z]),te=a.useCallback(()=>{W>=z?G():ee(W+1)},[W,ee,G,z]),ae=a.useCallback(()=>{ee(W-1)},[W,ee]);a.useEffect(()=>{var he;const x=(he=window.matchMedia)==null?void 0:he.call(window,"(prefers-reduced-motion: reduce)");if(!x)return;const V=()=>g(x.matches);return V(),x.addEventListener?(x.addEventListener("change",V),()=>x.removeEventListener("change",V)):(x.addListener(V),()=>x.removeListener(V))},[]),a.useEffect(()=>{if(!h)return;const x=V=>{const he=V.target;if(!he)return;const _=he.tagName;if(!(he.isContentEditable||_==="INPUT"||_==="TEXTAREA"||_==="SELECT"||_==="BUTTON"||_==="A"||he.closest('button, a, [role="button"], [role="link"]'))){if(V.key==="Escape"){R();return}if(V.key==="ArrowLeft"||V.key==="ArrowUp"){ae();return}(V.key==="ArrowRight"||V.key==="ArrowDown"||V.code==="Space"||V.key===" ")&&(V.preventDefault(),te())}};return window.addEventListener("keydown",x),()=>window.removeEventListener("keydown",x)},[R,te,ae,h]),a.useEffect(()=>{h&&W===z&&L()},[W,h,z,L]),a.useEffect(()=>{const x=c.current;if(!x)return;const V=o.current.filter(le=>!!le);if(!V.length)return;const he=1,_=.6,H=.6,ke=Math.max(1,Math.min(he,window.devicePixelRatio||1));let Se=0,ve=0,Ae=_,we=0,Be=0;const _e=le=>{let Le=le%2147483647;return Le<=0&&(Le+=2147483646),(qe,q)=>{Le=Le*48271%2147483647;const ge=Le/2147483647;return qe+ge*(q-qe)}},je={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},Ke=le=>{const Le=Math.sin(le*12.9898)*43758.5453;return Le-Math.floor(Le)},Xe=le=>{const Le=Ke(le+.1)||1e-4,qe=Ke(le+.7)||1e-4;return Math.sqrt(-2*Math.log(Le))*Math.cos(2*Math.PI*qe)},Qe=(le,Le)=>{const qe=Math.floor(le),q=qe+1,ge=le-qe,I=ge*ge*(3-2*ge),X=Ke(qe*12.9898+Le*78.233),xe=Ke(q*12.9898+Le*78.233);return X+(xe-X)*I},K=le=>{const Le=_e(le),qe=Math.min(4,Math.max(4,Math.floor(Se/1200*je.filamentCount)));return Array.from({length:qe},(q,ge)=>{const I=Math.max(-1,Math.min(1,Xe(le+ge*.37))),X=Math.min(1,Math.max(0,Ke(le+ge*1.31))),xe=Math.min(je.depthLayers-1,Math.floor(X*je.depthLayers));return{seed:Le(0,Math.PI*2)+le*.01,offset:I,freqA:je.freq1*(.75+Le(0,.5)),freqB:je.freq2*(.75+Le(0,.5)),ampA:je.amp1*(.6+Le(0,.7)),ampB:je.amp2*(.6+Le(0,.7)),width:2+ge%5*.32,depth:X,layer:xe}})},Q=(le,Le,qe)=>{const q=Math.max(30,Math.floor(Se*ve/14e4));le.save(),le.globalAlpha=.6;for(let ge=0;ge<q;ge+=1){const I=Ke(ge*9.1+Se*.11)*Le+qe,X=Ke(ge*3.7+ve*.23)*ve,xe=1.2+Ke(ge*5.9)*2.4,$=le.createRadialGradient(I,X,0,I,X,xe*2);$.addColorStop(0,"rgba(10, 30, 60, 0.45)"),$.addColorStop(1,"rgba(10, 30, 60, 0)"),le.fillStyle=$,le.beginPath(),le.arc(I,X,xe*2,0,Math.PI*2),le.fill()}le.restore()},Ve=(le,Le)=>{le.clearRect(0,0,Se,ve);const qe=ve*je.waveCenter,q=je.waveBandPx,ge=je.segments,I=je.colors.filaments,X=we||Se,xe=0;Q(le,X,xe),le.strokeStyle=I,le.lineCap="round",le.lineJoin="round";for(let $=0;$<Le.length;$+=1){const O=Le[$],pe=O.offset*q*(.85+Ke(O.seed)*.4),Me=1-Math.min(1,Math.abs(pe)/q),be=Math.exp(-Math.pow(pe/je.crestThickness,2)),$e=O.layer===0?1.1:O.layer===1?.85:.6,ze=.35+(1-O.depth)*.65,We=Me*ze*$e*(.34+be*.45);le.globalAlpha=We,le.lineWidth=O.width*(1+(1-O.depth)*.8);const Re=[];for(let Ne=0;Ne<=ge;Ne+=1){const st=Ne/ge*X+xe,He=(Qe(st*.012,O.seed)-.5)*je.xJitter,Je=st+He,mt=(Qe(Je*O.freqA,O.seed)-.5)*je.jitterA,jt=(Qe(Je*O.freqB,O.seed*1.7)-.5)*je.jitterB,Ye=qe+Math.sin(Je*O.freqA+O.seed)*O.ampA+Math.sin(Je*O.freqB+O.seed*1.3)*O.ampB+pe+mt+jt;Re.push({x:Je,y:Ye})}le.beginPath(),le.moveTo(Re[0].x,Re[0].y);for(let Ne=1;Ne<Re.length-1;Ne+=1){const st=(Re[Ne].x+Re[Ne+1].x)/2,He=(Re[Ne].y+Re[Ne+1].y)/2;le.quadraticCurveTo(Re[Ne].x,Re[Ne].y,st,He)}const Ee=Re[Re.length-1];le.quadraticCurveTo(Ee.x,Ee.y,Ee.x,Ee.y),le.stroke()}le.save(),le.globalCompositeOperation="lighter",le.strokeStyle=je.colors.glow,le.lineCap="round",le.lineJoin="round";for(let $=0;$<Le.length;$+=1){const O=Le[$];if(Math.abs(O.offset)*q>je.crestThickness)continue;const pe=je.glowAlpha*(.7+(1-O.depth)*.6);le.globalAlpha=pe,le.lineWidth=1.6+(1-O.depth)*1.2;const Me=[];for(let $e=0;$e<=ge;$e+=1){const ze=$e/ge*X+xe,We=Math.sin(ze*.02+O.seed)*3,Re=qe+Math.sin(ze*O.freqA+O.seed)*O.ampA+Math.sin(ze*O.freqB+O.seed*1.3)*O.ampB+O.offset*q*.35+We;Me.push({x:ze,y:Re})}le.beginPath(),le.moveTo(Me[0].x,Me[0].y);for(let $e=1;$e<Me.length-1;$e+=1){const ze=(Me[$e].x+Me[$e+1].x)/2,We=(Me[$e].y+Me[$e+1].y)/2;le.quadraticCurveTo(Me[$e].x,Me[$e].y,ze,We)}const be=Me[Me.length-1];le.quadraticCurveTo(be.x,be.y,be.x,be.y),le.stroke()}le.restore()},Ce=()=>{Se=Math.floor(x.clientWidth),ve=Math.floor(x.clientHeight),we=Math.floor(Se*1.8),Be=ve,Ae=Se<820?H:_,V.forEach(le=>{const Le=le.getContext("2d");if(!Le)return;le.width=Math.floor(we*ke*Ae),le.height=Math.floor(Be*ke*Ae),le.style.width=`${we}px`,le.style.height=`${Be}px`,le.style.left=`${-(we-Se)/2}px`,Le.setTransform(ke*Ae,0,0,ke*Ae,0,0);const qe=Number(le.dataset.seed||1),q=K(qe);Ve(Le,q)})};return Ce(),window.addEventListener("resize",Ce,{passive:!0}),()=>window.removeEventListener("resize",Ce)},[de]);const Pe=Y[Math.min(W,Y.length-1)],ue=h?Pe:Y[Y.length-1],C=(ue==null?void 0:ue.theme)??Y[0].theme,fe={"--cogita-bg0":C.bg0,"--cogita-bg1":C.bg1,"--cogita-bg2":C.bg2,"--cogita-bloom":C.bloom,"--cogita-sat":C.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:k,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(_s,{value:j,onChange:d}),e.jsx(Ks,{copy:t,label:n,isAuthenticated:r,secureMode:y,onLogin:s,onProfileNavigate:l,onToggleSecureMode:m,onLogout:b,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:c,className:"cogita-section cogita-home",style:fe,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[de.map((x,V)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:x.style,"data-seed":x.seed,ref:he=>{o.current[V]=he}},x.id)),U.map(x=>e.jsx("div",{className:"cogita-home-wave",style:x.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},x.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(Vn,{slides:Y,activeIndex:W,introOpen:h,prefersReducedMotion:B,onNext:te,onPrev:ae,onSelect:ee,onExit:R,onOpen:S,onRegister:G})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const Ui=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:zn},Symbol.toStringTag,{value:"Module"})),Ws=a.createContext(!1);function Tt({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,children:d}){if(a.useContext(Ws))return e.jsx(e.Fragment,{children:d});const c=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}y("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:c,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(_s,{value:E,onChange:j}),e.jsx(Ks,{copy:t,label:s,isAuthenticated:n,secureMode:b,onLogin:()=>y("home"),onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:d}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function Ot(t){const[s,n]=a.useState("Cogita library"),[r,l]=a.useState(null);return a.useEffect(()=>{let m=!1;return qs().then(b=>{if(m)return;const y=b.find(E=>E.libraryId===t);y&&n(y.name)}).catch(()=>{m||n("Cogita library")}),()=>{m=!0}},[t]),a.useEffect(()=>{let m=!1;return cn(t).then(b=>{m||l(b)}).catch(()=>{m||l(null)}),()=>{m=!0}},[t]),{libraryName:s,stats:r}}function vs({slices:t}){const s=t.reduce((r,l)=>r+Math.max(0,l.value),0),n=a.useMemo(()=>{if(s<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let r=0;return`conic-gradient(${t.map(m=>{const y=Math.max(0,m.value)/s*360,E=r,j=r+y;return r=j,`${m.color} ${E}deg ${j}deg`}).join(",")})`},[t,s]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:n}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(r=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:r.color}}),e.jsx("strong",{children:r.value}),e.jsx("small",{children:r.label})]},r.label))})]})}function Wn({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,libraryId:d}){const{libraryName:k,stats:c}=Ot(d),[o,U]=a.useState("infos"),[de,Y]=a.useState(0),[W,v]=a.useState(0),[h,re]=a.useState(0),B=(c==null?void 0:c.totalInfos)??0,g=(c==null?void 0:c.totalCollections)??0,z=0,L=0,G=0,S=Math.max(0,B-G-W),R=Math.max(0,B-W-h);a.useEffect(()=>{let te=!1;return(async()=>{try{const Pe=await va({libraryId:d,limit:200}),ue=await Promise.all(Pe.items.map(C=>Ds({libraryId:d,collectionId:C.collectionId}).catch(()=>[])));if(te)return;Y(ue.reduce((C,fe)=>C+fe.length,0))}catch{te||Y(0)}})(),()=>{te=!0}},[d]),a.useEffect(()=>{let te=!1;return(async()=>{try{const[Pe,ue,C]=await Promise.all([ps({libraryId:d,type:"computed",limit:1}).catch(()=>({total:0})),ps({libraryId:d,type:"source",limit:1}).catch(()=>({total:0})),Vs({libraryId:d}).catch(()=>({items:[]}))]);if(te)return;v((Pe.total??0)+(ue.total??0));const fe=new Set(C.items.filter(x=>x.childItemType.toLowerCase()==="info").map(x=>x.childItemId).filter(Boolean));re(fe.size)}catch{te||(v(0),re(0))}})(),()=>{te=!0}},[d]);const ee=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:B},{key:"collections",label:t.cogita.library.overview.stats.collections,value:g},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:de},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:z},{key:"texts",label:t.cogita.library.overview.stats.texts,value:L}];return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:k})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:ee.map(te=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${o===te.key?"active":""}`,onClick:()=>U(te.key),children:[e.jsx("span",{children:te.label}),e.jsx("strong",{children:te.value})]},te.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),o==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(vs,{slices:[{label:t.cogita.library.overview.known,value:G,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:S,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:W,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(vs,{slices:[{label:t.cogita.library.overview.availableChecks,value:h,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:R,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const Ue=(t,s)=>{const n=t.cogita.library.infoTypes,r=t.cogita.library.connectionTypes,l=t.cogita.library.groupTypes;return{any:n.any,vocab:n.vocab,book:l.book,citation:l.citation,language:n.language,word:n.word,sentence:n.sentence,topic:n.topic,collection:n.collection,person:n.person,institution:n.institution,collective:n.collective,orcid:n.orcid,address:n.address,email:n.email,phone:n.phone,media:n.media,work:n.work,geo:n.geo,music_piece:n.musicPiece,music_fragment:n.musicFragment,source:n.source,quote:n.quote,computed:n.computed,"word-language":r.wordLanguage,"quote-language":r.quoteLanguage,"language-sentence":r.languageSentence,translation:r.translation,"word-topic":r.wordTopic,reference:r.reference,"source-resource":r.sourceResource,"work-contributor":r.workContributor,"work-medium":r.workMedium,"orcid-link":r.orcidLink}[s]??String(s)},Hn=t=>[{value:"any",label:Ue(t,"any")},{value:"language",label:Ue(t,"language")},{value:"word",label:Ue(t,"word")},{value:"sentence",label:Ue(t,"sentence")},{value:"topic",label:Ue(t,"topic")},{value:"collection",label:Ue(t,"collection")},{value:"person",label:Ue(t,"person")},{value:"institution",label:Ue(t,"institution")},{value:"collective",label:Ue(t,"collective")},{value:"orcid",label:Ue(t,"orcid")},{value:"address",label:Ue(t,"address")},{value:"email",label:Ue(t,"email")},{value:"phone",label:Ue(t,"phone")},{value:"media",label:Ue(t,"media")},{value:"work",label:Ue(t,"work")},{value:"geo",label:Ue(t,"geo")},{value:"music_piece",label:Ue(t,"music_piece")},{value:"music_fragment",label:Ue(t,"music_fragment")},{value:"source",label:Ue(t,"source")},{value:"quote",label:Ue(t,"quote")},{value:"citation",label:Ue(t,"citation")},{value:"computed",label:Ue(t,"computed")},{value:"vocab",label:Ue(t,"vocab")},{value:"book",label:Ue(t,"book")},{value:"word-language",label:Ue(t,"word-language")},{value:"quote-language",label:Ue(t,"quote-language")},{value:"language-sentence",label:Ue(t,"language-sentence")},{value:"translation",label:Ue(t,"translation")},{value:"word-topic",label:Ue(t,"word-topic")},{value:"reference",label:Ue(t,"reference")},{value:"source-resource",label:Ue(t,"source-resource")},{value:"work-contributor",label:Ue(t,"work-contributor")},{value:"work-medium",label:Ue(t,"work-medium")},{value:"orcid-link",label:Ue(t,"orcid-link")}],Qn=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Ga={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},Yn={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code","notes"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","notes","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Ga]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","notes","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Ga]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name","notes"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid","notes"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country","notes"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address","notes"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number","notes"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind","notes"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId","notes"]},filterFields:[Ga,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city","notes"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer","notes"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text","notes"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator","notes"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},quote:{infoType:"quote",entityKind:"single",structure:{payloadFields:["title","text","notes"],connections:[{relationType:"quote-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"quote",kind:"text",path:"text",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition","notes"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},ws={infoType:"default",entityKind:"single",structure:{payloadFields:["label","notes"]},filterFields:[]};function Gn(t){return t?Yn[t]??ws:ws}function Xn(t,s){return t.optionsSource==="languages"?s.languages.map(n=>({value:n.infoId,label:n.label})):t.optionsSource==="sourceKinds"?Qn:[]}const Xa=60,Jn=500;function Hs(t){return`cogita.info-selection:${t}`}function js(t){if(typeof window>"u")return{};const s=window.localStorage.getItem(Hs(t));if(!s)return{};try{const n=JSON.parse(s);return!n||typeof n!="object"?{}:n}catch{return{}}}function Zn({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,libraryId:d,mode:k}){var qe;const c=$s(),o=t.cogita.library.list,[U,de]=a.useState("any"),[Y,W]=a.useState(""),[v,h]=a.useState("relevance"),[re,B]=a.useState("details"),[g,z]=a.useState(!1),[L,G]=a.useState("idle"),[S,R]=a.useState([]),[ee,te]=a.useState(Xa),[ae,Pe]=a.useState(null),[ue,C]=a.useState(()=>js(d)),[fe,x]=a.useState({}),[V,he]=a.useState([]),_=a.useMemo(()=>Hn(t),[t]),H=a.useMemo(()=>[{value:"relevance",label:o.sortRelevance},{value:"label_asc",label:o.sortLabelAsc},{value:"label_desc",label:o.sortLabelDesc},{value:"type_asc",label:o.sortTypeAsc},{value:"type_desc",label:o.sortTypeDesc}],[o.sortLabelAsc,o.sortLabelDesc,o.sortRelevance,o.sortTypeAsc,o.sortTypeDesc]);a.useEffect(()=>{C(js(d)),x({}),z(!1)},[d]),a.useEffect(()=>{bs({libraryId:d,type:"language",filters:{sourceKind:"info"},limit:200}).then(q=>{const ge=q.map(I=>({infoId:I.infoId??"",infoType:I.entityType,label:I.title})).filter(I=>I.infoId.length>0);he(ge)}).catch(()=>he([]))},[d]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(Hs(d),JSON.stringify(ue))},[d,ue]);const ke=a.useMemo(()=>Gn(U==="any"?null:U),[U]),Se=a.useMemo(()=>({language:o.typeFilterLanguage,languageA:o.typeFilterLanguageA,languageB:o.typeFilterLanguageB,originalLanguage:o.typeFilterOriginalLanguage,doi:o.typeFilterDoi,sourceKind:o.typeFilterSourceKind,locator:o.typeFilterLocator,quote:o.typeFilterQuote}),[o.typeFilterDoi,o.typeFilterLanguage,o.typeFilterLanguageA,o.typeFilterLanguageB,o.typeFilterLocator,o.typeFilterOriginalLanguage,o.typeFilterQuote,o.typeFilterSourceKind]),ve=a.useMemo(()=>ke.filterFields.map(q=>({...q,label:q.labelKey?Se[q.labelKey]:q.label??q.key,options:Xn(q,{languages:V})})),[Se,V,ke.filterFields]),Ae=a.useMemo(()=>ve.some(q=>(fe[q.key]??"").trim().length>0),[ve,fe]);a.useEffect(()=>{x({})},[U]),a.useEffect(()=>{const q={sourceKind:"info"};if(Ae)for(const I of ve){const X=(fe[I.key]??"").trim();X&&(q[I.path??I.key]=X)}G("loading");const ge=window.setTimeout(()=>{bs({libraryId:d,type:U==="any"?void 0:U,query:Y.trim()||void 0,filters:q,limit:Jn}).then(I=>{const X=I.map(xe=>({infoId:xe.infoId??"",infoType:xe.entityType,label:xe.title})).filter(xe=>xe.infoId.length>0);R(X),G("ready")}).catch(()=>{R([]),G("ready")})},240);return()=>window.clearTimeout(ge)},[Ae,d,Y,U,ve,fe]);const we=a.useMemo(()=>{const q=S.slice(),ge=I=>Ue(t,I);return v==="relevance"?q:v==="label_asc"?q.sort((I,X)=>I.label.localeCompare(X.label)):v==="label_desc"?q.sort((I,X)=>X.label.localeCompare(I.label)):v==="type_asc"?q.sort((I,X)=>I.infoType===X.infoType?I.label.localeCompare(X.label):ge(I.infoType).localeCompare(ge(X.infoType))):q.sort((I,X)=>I.infoType===X.infoType?I.label.localeCompare(X.label):ge(X.infoType).localeCompare(ge(I.infoType)))},[t,S,v]),Be=a.useMemo(()=>we.slice(0,ee),[we,ee]),_e=Be.length<we.length,je=a.useMemo(()=>new Set(Object.keys(ue)),[ue]),Ke=a.useMemo(()=>Object.values(ue),[ue]),Xe=a.useMemo(()=>{const q=new Map;for(const ge of Ke)q.set(ge.infoType,(q.get(ge.infoType)??0)+1);return Array.from(q.entries()).sort((ge,I)=>I[1]-ge[1]||ge[0].localeCompare(I[0]))},[Ke]);a.useEffect(()=>{te(Xa);const q=new Set(S.map(ge=>ge.infoId));Pe(ge=>ge&&q.has(ge)?ge:null)},[S]);const Qe=q=>{C(ge=>({...ge,[q.infoId]:{infoId:q.infoId,infoType:q.infoType,label:q.label}}))},K=q=>{C(ge=>{if(!ge[q])return ge;const I={...ge};return delete I[q],I})},Q=(q,ge)=>{if(ge){Qe(q);return}K(q.infoId)},Ve=q=>{c(`/cogita/library/${d}/list?infoId=${encodeURIComponent(q)}&infoView=overview`,{replace:!0})},Ce=Ke.length===1?((qe=Ke[0])==null?void 0:qe.infoId)??null:null,le=o.selectionCount.replace("{count}",String(Ke.length)),Le=k==="collection"?"grid":k==="detail"?"wide":re;return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":Le,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":o.typeLabel,value:U,onChange:q=>de(q.target.value),children:_.map(q=>e.jsx("option",{value:q.value,children:q.label},q.value))}),e.jsx("input",{type:"text",value:Y,onChange:q=>W(q.target.value),placeholder:o.searchPlaceholder}),e.jsx("select",{"aria-label":o.sortLabel,value:v,onChange:q=>h(q.target.value),children:H.map(q=>e.jsx("option",{value:q.value,children:q.label},q.value))}),e.jsxs("select",{"aria-label":o.viewLabel,value:re,onChange:q=>B(q.target.value),children:[e.jsx("option",{value:"details",children:o.viewDetails}),e.jsx("option",{value:"wide",children:o.viewWide}),e.jsx("option",{value:"grid",children:o.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:o.cardCount.replace("{shown}",String(Be.length)).replace("{total}",String(we.length))}),e.jsx("span",{children:L==="loading"?o.loading:o.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>z(q=>!q),children:g?o.hideFilters:o.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:o.filtersOptionalHint})]}),g&&ve.length>0?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsx("div",{className:"cogita-filter-grid",children:ve.map(q=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:q.label}),q.kind==="select"?e.jsxs("select",{value:fe[q.key]??"",onChange:ge=>x(I=>({...I,[q.key]:ge.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(q.options??[]).map(ge=>e.jsx("option",{value:ge.value,children:ge.label},`${q.key}:${ge.value}`))]}):e.jsx("input",{type:"text",value:fe[q.key]??"",onChange:ge=>x(I=>({...I,[q.key]:ge.target.value}))})]},`type-filter:${q.key}`))})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:le}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{C(q=>{const ge={...q};for(const I of Be)ge[I.infoId]={infoId:I.infoId,infoType:I.infoType,label:I.label};return ge})},disabled:Be.length===0,children:o.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>C({}),disabled:Ke.length===0,children:o.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ce&&Ve(Ce),disabled:!Ce,title:Ce?void 0:o.openSelectedDisabled,children:o.openSelected})]})]}),Ke.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:o.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:o.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:Xe.map(([q,ge])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:Ue(t,q)}),e.jsx("span",{className:"cogita-tag-count",children:ge})]},`stack:type:${q}`))})]}):null,Le==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":o.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:o.detailColumnName}),e.jsx("span",{children:o.detailColumnType}),e.jsx("span",{children:o.detailColumnId}),e.jsx("span",{})]}),Be.length?Be.map(q=>{const ge=Ue(t,q.infoType),I=je.has(q.infoId),X=ae===q.infoId;return e.jsxs("div",{className:`cogita-details-row ${X||I?"active":""}`,role:"row",onClick:()=>Pe(q.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:I,onChange:xe=>Q(q,xe.target.checked),onClick:xe=>xe.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:q.label,children:q.label}),e.jsx("span",{title:ge,children:ge}),e.jsx("span",{title:q.infoId,children:q.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:xe=>{xe.stopPropagation(),Ve(q.infoId)},"aria-label":o.editInfo,children:">"})]},q.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:o.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${Le}`,"data-view":Le,children:Be.length?Be.map(q=>{const ge=Ue(t,q.infoType),I=je.has(q.infoId),X=ae===q.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":X||I,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:I,onChange:xe=>Q(q,xe.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>Pe(q.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:ge}),e.jsx("h3",{className:"cogita-card-title",children:q.label}),e.jsx("p",{className:"cogita-card-subtitle",children:q.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ve(q.infoId),children:o.editInfo})]})},q.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:o.noMatch})})}),_e?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>te(q=>q+Xa),children:o.loadMore})}):null]})})})})})}const aa=5,ks=50,Ns=2,Ts=[];function sa({libraryId:t,infoType:s,label:n,placeholder:r,value:l,onChange:m,values:b,onChangeMultiple:y,helperText:E,searchFailedText:j,createFailedText:d,createLabel:k,savingLabel:c,loadMoreLabel:o,inputRef:U,autoAdvance:de,onCommit:Y,multiple:W}){const v=W?b??Ts:Ts,[h,re]=a.useState(W?"":(l==null?void 0:l.label)??""),[B,g]=a.useState([]),[z,L]=a.useState(aa),[G,S]=a.useState(-1),[R,ee]=a.useState(!1),[te,ae]=a.useState(!1),[Pe,ue]=a.useState(null),C=a.useRef(0),fe=a.useRef(new Map),x=a.useMemo(()=>W?h.trim().length>0:h.trim().length>0&&!l,[h,l,W]);a.useEffect(()=>{W||re((l==null?void 0:l.label)??"")},[l,W]),a.useEffect(()=>{const _=h.trim();if(!_||_.length<Ns){g([]),ee(!1),L(aa),S(-1),ae(!1),ue(null);return}const H=_.toLowerCase(),ke=`${t}:${s}:${H}`,Se=fe.current.get(ke);if(Se){if(W&&v.length>0){const Ae=new Set(v.map(we=>we.id));g(Se.filter(we=>!Ae.has(we.id)))}else g(Se);L(aa),S(-1),ee(Se.length>0),ae(!1),ue(null);return}const ve=window.setTimeout(async()=>{const Ae=Date.now();C.current=Ae,ae(!0),ue(null);try{const we=await us({libraryId:t,type:s,query:_,limit:ks});if(C.current!==Ae)return;const Be=we.slice(0,ks).map(_e=>({id:_e.infoId,label:_e.label,infoType:_e.infoType}));if(fe.current.set(ke,Be),W&&v.length>0){const _e=new Set(v.map(je=>je.id));g(Be.filter(je=>!_e.has(je.id)))}else g(Be);L(aa),S(-1),ee(!0)}catch{if(C.current!==Ae)return;ue(j??"Search failed.")}finally{C.current===Ae&&ae(!1)}},250);return()=>window.clearTimeout(ve)},[t,s,h,v]);const V=_=>{if(W){const H=v.some(ke=>ke.id===_.id)?v:[...v,_];y==null||y(H),re(""),ee(!1),S(-1);return}m==null||m(_),re(_.label),ee(!1),S(-1),de&&(Y==null||Y())},he=async()=>{const _=h.trim();if(_){ae(!0),ue(null);try{const H=await Os({libraryId:t,infoType:s,payload:{label:_}}),ke={id:H.infoId,label:_,infoType:H.infoType};if(_.length>=Ns){const Se=`${t}:${s}:${_.toLowerCase()}`,ve=fe.current.get(Se)??[];fe.current.set(Se,[ke,...ve])}if(W){y==null||y([...v,ke]),re(""),ee(!1),S(-1);return}m==null||m(ke),ee(!1),S(-1),de&&(Y==null||Y())}catch{ue(d??"Create failed.")}finally{ae(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:n}),e.jsx("input",{value:h,placeholder:r,onChange:_=>{re(_.target.value),!W&&l&&(m==null||m(null))},onKeyDown:_=>{if(_.key==="ArrowDown"){if(_.preventDefault(),!B.length)return;ee(!0),S(H=>{const ke=Math.min(B.length,z)-1,Se=H<0?0:Math.min(H+1,ke);return Se===ke&&B.length>z?(L(ve=>Math.min(ve+aa,B.length)),Math.min(H+1,Math.min(B.length,z+aa)-1)):Se});return}if(_.key==="ArrowUp"){if(_.preventDefault(),!B.length)return;ee(!0),S(H=>H<=0?0:H-1);return}if(_.key==="Enter"){if(_.preventDefault(),G>=0&&B[G]){V(B[G]);return}if(x){he();return}}},onFocus:()=>{B.length>0&&ee(!0)},autoComplete:"off",ref:U})]}),W&&v.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:v.map(_=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>y==null?void 0:y(v.filter(H=>H.id!==_.id)),children:[_.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},_.id))}),E&&e.jsx("p",{className:"cogita-help",children:E}),Pe&&e.jsx("p",{className:"cogita-error",children:Pe}),R&&B.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[B.slice(0,z).map((_,H)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":H===G,onClick:()=>V(_),children:[e.jsx("strong",{children:_.label}),e.jsx("span",{children:_.infoType})]},_.id)),z<B.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>L(_=>Math.min(_+aa,B.length)),children:o??"Load more"})]}),x&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:he,disabled:te,children:te?c??"Saving...":k??`Create new ${s}`})]})}function ei(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function Ss(t,s){if(!t||typeof t!="object")return s;const n=t,r=[n.label,n.name,n.title,n.text,n.orcid,n.email,n.number];for(const l of r)if(typeof l=="string"&&l.trim())return l.trim();return s}function ti({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,libraryId:d,editInfoId:k}){const{libraryName:c}=Ot(d),o=!!k,[U,de]=a.useState([]),[Y,W]=a.useState("word"),[v,h]=a.useState({}),[re,B]=a.useState({}),[g,z]=a.useState({}),[L,G]=a.useState({}),[S,R]=a.useState(null),[ee,te]=a.useState("idle"),ae=a.useMemo(()=>U.find(x=>x.infoType===Y),[Y,U]),Pe=a.useMemo(()=>U.map(x=>({value:x.infoType,label:Ue(t,x.infoType)})),[t,U]);a.useEffect(()=>{let x=!1;return dn({libraryId:d}).then(V=>{var he;if(!x&&(de(V),!o)){const _=(he=V[0])==null?void 0:he.infoType;_&&W(_)}}).catch(()=>{x||de([])}),()=>{x=!0}},[o,d]),a.useEffect(()=>{if(!ae)return;const x={},V={},he={},_={};for(const H of ae.payloadFields)x[H.key]="";for(const H of ae.linkFields)H.multiple?he[H.key]=[]:V[H.key]=null,H.targetTypes.length>0&&(_[H.key]=H.targetTypes[0]);h(x),B(V),z(he),G(_)},[ae==null?void 0:ae.infoType]),a.useEffect(()=>{if(!o||!k||U.length===0)return;let x=!1;return te("loading"),R(null),(async()=>{const he=await ua({libraryId:d,infoId:k});if(x)return;const _=he.infoType;W(_);const H=U.find(je=>je.infoType===_);if(!H){te("idle");return}const ke=he.payload??{},Se={};for(const je of H.payloadFields)Se[je.key]=ei(ke[je.key]);h(Se);const ve=he.links??{}??{},Ae={},we={},Be={},_e=[];for(const je of H.linkFields){je.targetTypes.length>0&&(Be[je.key]=je.targetTypes[0]);const Ke=ve[je.key];if(je.multiple){const Xe=Array.isArray(Ke)?Ke.filter(Qe=>typeof Qe=="string"):[];we[je.key]=[];for(const Qe of Xe)_e.push(ua({libraryId:d,infoId:Qe}).then(K=>{if(x)return;const Q={id:Qe,infoType:K.infoType,label:Ss(K.payload,Qe)};we[je.key]=[...we[je.key],Q]}).catch(()=>{}))}else{const Xe=typeof Ke=="string"?Ke:null;Ae[je.key]=null,Xe&&_e.push(ua({libraryId:d,infoId:Xe}).then(Qe=>{x||(Ae[je.key]={id:Xe,infoType:Qe.infoType,label:Ss(Qe.payload,Xe)})}).catch(()=>{}))}}await Promise.all(_e),!x&&(B(Ae),z(we),G(je=>({...je,...Be})),te("idle"))})().catch(()=>{x||(R("Failed to load info details."),te("idle"))}),()=>{x=!0}},[k,o,d,U]);const ue=async()=>{var he;if(!ae)return;const x={};for(const _ of ae.payloadFields){const H=(v[_.key]??"").trim();if(!H){if(_.required){R(`Field '${_.label}' is required.`);return}continue}if(_.inputType==="json")try{x[_.key]=JSON.parse(H)}catch{R(`Field '${_.label}' must be valid JSON.`);return}else x[_.key]=H}const V={};for(const _ of ae.linkFields)if(_.multiple){const H=(g[_.key]??[]).map(ke=>ke.id);if(_.required&&H.length===0){R(`Link '${_.label}' is required.`);return}V[_.key]=H}else{const H=((he=re[_.key])==null?void 0:he.id)??null;if(_.required&&!H){R(`Link '${_.label}' is required.`);return}V[_.key]=H}te("saving"),R(null);try{if(o&&k)await un({libraryId:d,infoId:k,payload:x,links:V}),R("Info updated.");else{await Os({libraryId:d,infoType:Y,payload:x,links:V}),R("Info saved.");const _={};for(const Se of ae.payloadFields)_[Se.key]="";h(_);const H={},ke={};for(const Se of ae.linkFields)Se.multiple?ke[Se.key]=[]:H[Se.key]=null;B(Se=>({...Se,...H})),z(Se=>({...Se,...ke}))}}catch{R("Failed to save info.")}finally{te("idle")}},C=x=>{const V=v[x.key]??"",he=x.inputType==="textarea"||x.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:x.label}),he?e.jsx("textarea",{rows:x.inputType==="json"?8:4,value:V,onChange:_=>h(H=>({...H,[x.key]:_.target.value})),placeholder:x.key}):e.jsx("input",{type:"text",value:V,onChange:_=>h(H=>({...H,[x.key]:_.target.value})),placeholder:x.key})]},`payload:${x.key}`)},fe=x=>{const V=L[x.key]??x.targetTypes[0];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:x.label}),x.targetTypes.length>1?e.jsx("select",{value:V,onChange:he=>G(_=>({..._,[x.key]:he.target.value})),children:x.targetTypes.map(he=>e.jsx("option",{value:he,children:Ue(t,he)},`${x.key}:${he}`))}):null,x.multiple?e.jsx(sa,{libraryId:d,infoType:V,label:x.label,placeholder:x.key,multiple:!0,values:g[x.key]??[],onChangeMultiple:he=>z(_=>({..._,[x.key]:he})),searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(sa,{libraryId:d,infoType:V,label:x.label,placeholder:x.key,value:re[x.key]??null,onChange:he=>B(_=>({..._,[x.key]:he})),searchFailedText:"Search failed",createFailedText:"Create failed"})]},`link:${x.key}`)};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:o?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${d}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[o?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:Y,onChange:x=>W(x.target.value),children:Pe.map(x=>e.jsx("option",{value:x.value,children:x.label},x.value))})]}),ee==="loading"?e.jsx("p",{children:"Loading..."}):null,ae?e.jsxs("div",{className:"cogita-form-grid",children:[ae.payloadFields.map(C),ae.linkFields.map(fe)]}):e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:ue,disabled:ee==="saving"||!ae,children:ee==="saving"?"Saving...":o?"Update info":"Create info"})}),S?e.jsx("p",{className:"cogita-library-subtitle",children:S}):null]})})})]})})}const Cs=t=>/\s/.test(t),Ra=t=>/[\p{L}\p{N}]/u.test(t),Ms=(t,s)=>{const n=s>0?t[s-1]:"",r=s<t.length?t[s]:"";if(!n||!r)return 0;const l=Cs(n),m=Cs(r);if(l||m)return 3;const b=Ra(n),y=Ra(r);return b!==y?2:!b&&!y?1:0},Ja=(t,s,n,r,l)=>{const m=Math.max(r-s,n-r);for(let b=0;b<=m;b+=1){const y=r-b;if(y>=s&&y<=n&&Ms(t,y)>=l)return y;const E=r+b;if(E>=s&&E<=n&&Ms(t,E)>=l)return E}return null},Za=(t,s)=>{const n=s>0?t[s-1]:"",r=s<t.length?t[s]:"";return!n||!r?!0:Ra(n)!==Ra(r)},ai=(t,s,n,r)=>{const l=n-s,m=s+r,b=n-r;if(l<=r*2||b<=m)return null;const y=Math.floor((s+n)/2),E=Ja(t,m,b,y,3);if(E!==null&&Za(t,E))return E;const j=Ja(t,m,b,y,2);if(j!==null&&Za(t,j))return j;const d=Ja(t,m,b,y,1);return d!==null&&Za(t,d)?d:null},ma=(t,s)=>{const n=Math.max(1,7),r=Math.max(n,13),l={},m=(E,j,d,k,c)=>{const o=String(k),U={id:o,start:E,end:j,text:t.slice(E,j),depth:d,index:k,parentId:c};if(l[o]=U,j-E>r){let Y=ai(t,E,j,n);if(Y!==null&&Y>E&&Y<j){const W=m(E,Y,d+1,k*2+1,o),v=m(Y,j,d+1,k*2+2,o);U.leftId=W.id,U.rightId=v.id}}return U},b=m(0,t.length,0,0),y=Object.values(l).sort((E,j)=>j.depth-E.depth||E.start-j.start).map(E=>E.id);return{text:t,rootId:b.id,nodes:l,order:y}},ha=(t,s,n,r,l,m,b)=>{const y=m==="reverse"?t.order.slice().sort((E,j)=>t.nodes[j].start-t.nodes[E].start||t.nodes[j].depth-t.nodes[E].depth):t.order;for(const E of y){if(b&&E===b||s.has(E))continue;const j=t.nodes[E];if(j){if(l&&(j.leftId||j.rightId)){const d=j.leftId?n[j.leftId]??0:r,k=j.rightId?n[j.rightId]??0:r;if((d+k)/2<r)continue}return j}}return null},Qs=(t,s)=>({before:t.slice(0,s.start),fragment:t.slice(s.start,s.end),after:t.slice(s.end)});function si({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,libraryId:d}){const k=`/#/cogita/library/${d}`,[c,o,U]=Rs([]),[de,Y,W]=Es([]),[v,h]=a.useState(null),[re,B]=a.useState(null),[g,z]=a.useState(null),[L,G]=a.useState(null),S=a.useMemo(()=>c.find(C=>C.id===v)??null,[c,v]);a.useEffect(()=>{let C=!0;return hn({libraryId:d}).then(fe=>{if(!C)return;const x=fe.nodes.map(V=>{var he,_,H;return{id:V.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:V.payload&&typeof V.payload=="object"&&"label"in V.payload?String(V.payload.label):"Item",nodeType:V.nodeType,itemType:((he=V.payload)==null?void 0:he.itemType)??"info",itemId:((_=V.payload)==null?void 0:_.itemId)??null,infoType:((H=V.payload)==null?void 0:H.infoType)??null}}});o(x),Y(fe.edges.map(V=>({id:V.edgeId,source:V.fromNodeId,target:V.toNodeId})))}).catch(()=>{C&&(o([]),Y([]))}),()=>{C=!1}},[d]),a.useEffect(()=>{gn({libraryId:d}).then(B).catch(()=>B(null))},[d,c,de]);const R=a.useCallback(C=>{Y(fe=>As(C,fe))},[]),ee=()=>{const C=crypto.randomUUID();o(fe=>[...fe,{id:C,type:"default",position:{x:140+fe.length*40,y:120+fe.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},te=()=>{const C=crypto.randomUUID();o(fe=>[...fe,{id:C,type:"default",position:{x:180+fe.length*40,y:160+fe.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},ae=async()=>{z(null);try{const C=c.map(x=>({nodeId:x.id,nodeType:x.data.nodeType,payload:{itemType:x.data.itemType,itemId:x.data.itemId??null,label:x.data.label,infoType:x.data.infoType??null}})),fe=de.map(x=>({edgeId:x.id,fromNodeId:x.source,toNodeId:x.target}));await mn({libraryId:d,nodes:C,edges:fe}),z(t.cogita.library.graph.saveSuccess)}catch{z(t.cogita.library.graph.saveFail)}},Pe=C=>{S&&o(fe=>fe.map(x=>x.id===S.id?{...x,data:{...x.data,itemId:(C==null?void 0:C.infoId)??null,itemType:"collection",infoType:"collection",label:(C==null?void 0:C.label)??t.cogita.library.infoTypes.collection}}:x))},ue=C=>{S&&o(fe=>fe.map(x=>x.id===S.id?{...x,data:{...x.data,itemId:(C==null?void 0:C.infoId)??null,itemType:"info",infoType:(C==null?void 0:C.infoType)??null,label:(C==null?void 0:C.label)??t.cogita.library.infoTypes.any}}:x))};return a.useEffect(()=>{if(!S||S.data.nodeType!=="info"||S.data.infoType!=="quote"||!S.data.itemId){G(null);return}let C=!0;return ua({libraryId:d,infoId:S.data.itemId}).then(fe=>{if(!C)return;const x=fe.payload,V=(x==null?void 0:x.text)??"";if(!V){G(null);return}const he=ma(V),_=Object.values(he.nodes).sort((H,ke)=>H.depth-ke.depth||H.start-ke.start).map(H=>({id:H.id,text:H.text,depth:H.depth}));G({title:(x==null?void 0:x.title)??S.data.label,fragments:_})}).catch(()=>G(null)),()=>{C=!1}},[d,S]),e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:k,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:ae,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ee,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:te,children:t.cogita.library.actions.addInfo}),re?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(re.totalCollections))})}):null,g?e.jsx("p",{className:"cogita-help",children:g}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(Fs,{nodes:c,edges:de,onNodesChange:U,onEdgesChange:W,onConnect:R,onNodeClick:(C,fe)=>h(fe.id),fitView:!0,children:[e.jsx(Ps,{gap:18,size:1}),e.jsx(Bs,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),S?e.jsxs("div",{className:"cogita-graph-inspector",children:[S.data.nodeType==="collection"?e.jsx(sa,{libraryId:d,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:S.data.itemId?{id:S.data.itemId,label:S.data.label,infoType:"collection"}:null,onChange:Pe,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(sa,{libraryId:d,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:S.data.itemId?{id:S.data.itemId,label:S.data.label,infoType:S.data.infoType??void 0}:null,onChange:ue,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),L?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:L.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:L.fragments.map(C=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:C.id}),e.jsx("span",{children:C.text})]},C.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function ni({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,libraryId:d,collectionId:k}){const{libraryName:c}=Ot(d),[o,U]=a.useState([]),[de,Y]=a.useState("loading"),[W,v]=a.useState("idle"),h=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),re=`/#/cogita/library/${d}`,B=()=>{Y("loading"),Us({libraryId:d}).then(L=>{U(L),Y("idle")}).catch(()=>{U([]),Y("error")})};a.useEffect(()=>{B()},[d]);const g=async L=>{try{await zs({libraryId:d,shareId:L}),B()}catch{B()}},z=async L=>{const G=`${h}/${L}`;try{await navigator.clipboard.writeText(G),v("copied")}catch{v("failed")}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:re,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${re}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[de==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):de==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):o.filter(L=>!k||L.collectionId===k).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:o.filter(L=>!k||L.collectionId===k).map(L=>e.jsxs("div",{className:"cogita-share-row","data-state":L.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:L.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(L.createdUtc).toLocaleString(),L.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),L.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${h}/${L.shareCode}`}):null]}),L.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[L.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>z(L.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>g(L.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},L.shareId))}),W==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):W==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function ii({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,libraryId:d}){const{libraryName:k}=Ot(d),[c,o]=a.useState(null),[U,de]=a.useState(null),[Y,W]=a.useState(null),[v,h]=a.useState(null),[re,B]=a.useState(null),[g,z]=a.useState(null),L=a.useRef(null),G=ee=>{if(!Number.isFinite(ee))return"0 B";if(ee<1024)return`${ee} B`;const te=ee/1024;if(te<1024)return`${te.toFixed(1)} KB`;const ae=te/1024;return ae<1024?`${ae.toFixed(1)} MB`:`${(ae/1024).toFixed(1)} GB`},S=async()=>{o(null),B({loadedBytes:0,totalBytes:null,percent:null});try{o(t.cogita.library.overview.exporting);const ee=await fn(d,B),te=URL.createObjectURL(ee),ae=document.createElement("a");ae.href=te,ae.download=`cogita-library-${k||d}.json`,ae.click(),URL.revokeObjectURL(te),o(t.cogita.library.overview.exportReady)}catch{o(t.cogita.library.overview.exportFail)}finally{B(ee=>ee??{loadedBytes:0,totalBytes:null,percent:null})}},R=async ee=>{var ae;de(null),W(null),h(null);const te=(ae=ee.target.files)==null?void 0:ae[0];if(te)try{de(t.cogita.library.overview.importing),z({loadedBytes:0,totalBytes:te.size,percent:0});const Pe=await pn(d,te,z,ue=>{const C=ue.stage==="infos"?t.cogita.library.overview.importStageInfos:ue.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;h(t.cogita.library.overview.importLiveProgress.replace("{stage}",C).replace("{done}",String(ue.processed)).replace("{total}",String(ue.total)).replace("{infos}",String(ue.infos)).replace("{connections}",String(ue.connections)).replace("{collections}",String(ue.collections)))});W({infos:Pe.infosImported,connections:Pe.connectionsImported,collections:Pe.collectionsImported}),de(t.cogita.library.overview.importDone)}catch(Pe){const ue=Pe instanceof bn&&Pe.message?` ${Pe.message}`:"";de(`${t.cogita.library.overview.importFail}${ue}`)}finally{L.current&&(L.current.value="")}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:k}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:S,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:L,type:"file",accept:"application/json",onChange:R})]})]}),re?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:re.percent??void 0,max:re.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",G(re.loadedBytes)).replace("{total}",re.totalBytes?G(re.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,g?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:g.percent??void 0,max:g.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",G(g.loadedBytes)).replace("{total}",g.totalBytes?G(g.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,c?e.jsx("p",{className:"cogita-help",children:c}):null,U?e.jsx("p",{className:"cogita-help",children:U}):null,v?e.jsx("p",{className:"cogita-help",children:v}):null,Y?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(Y.infos)).replace("{connections}",String(Y.connections)).replace("{collections}",String(Y.collections))}):null]})]})})})]})})}function ri({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,libraryId:d}){const{libraryName:k}=Ot(d),[c,o]=a.useState(""),[U,de]=a.useState([]),Y=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:k}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:c,onChange:W=>o(W.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const W=c.trim();W&&(de(v=>[{id:Y(),name:W},...v]),o(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[U.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,U.map(W=>e.jsx("button",{type:"button",className:"ghost",children:W.name},W.id))]})]})]})})})]})})}function oi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,libraryId:d}){const{libraryName:k}=Ot(d),[c,o]=a.useState(""),[U,de]=a.useState([]),Y=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:k}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:c,onChange:W=>o(W.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const W=c.trim();W&&(de(v=>[{id:Y(),name:W},...v]),o(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[U.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,U.map(W=>e.jsx("button",{type:"button",className:"ghost",children:W.name},W.id))]})]})]})})})]})})}function Is({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,libraryId:d}){const{libraryName:k}=Ot(d),c=`/#/cogita/library/${d}`,[o,U]=a.useState(""),[de,Y]=a.useState([]),[W,v]=a.useState("idle"),[h,re]=a.useState(0),[B,g]=a.useState(null);a.useEffect(()=>{v("loading");const L=window.setTimeout(()=>{va({libraryId:d,query:o.trim()||void 0,limit:30}).then(G=>{Y(G.items),re(G.total),g(G.nextCursor??null),v("ready")}).catch(()=>{Y([]),re(0),g(null),v("ready")})},240);return()=>window.clearTimeout(L)},[d,o]);const z=async()=>{if(B){v("loading");try{const L=await va({libraryId:d,query:o.trim()||void 0,limit:30,cursor:B});Y(G=>[...G,...L.items]),g(L.nextCursor??null),re(L.total),v("ready")}catch{v("ready")}}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:k}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:c,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${c}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:o,onChange:L=>U(L.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(de.length)).replace("{total}",String(h||de.length))}),e.jsx("span",{children:W==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:de.length?de.map(L=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${c}/collections/${L.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:L.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(L.itemCount))," ·"," ",L.notes||t.cogita.library.collections.noNotes]})]})},L.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${c}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),B?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:z,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const ie=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,Kt=(t,s,n,r)=>`${t}:${s}:${n??""}:${r??""}`;function li({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,libraryId:d,collectionId:k}){Ot(d);const c=`/#/cogita/library/${d}`,[o,U]=a.useState(t.cogita.library.collections.defaultName),[de,Y]=a.useState(null),[W,v]=a.useState(0),[h,re]=a.useState([]),[B,g]=a.useState("idle"),[z,L]=a.useState(null),G=a.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(h.length)).replace("{total}",String(W||h.length)),[t,h.length,W]);a.useEffect(()=>{qa(d,k).then(R=>{U(R.name),Y(R.notes??null),v(R.itemCount)}).catch(()=>{U(t.cogita.library.collections.defaultName),Y(null)})},[d,k]),a.useEffect(()=>{g("loading"),$a({libraryId:d,collectionId:k,limit:40}).then(R=>{re(R.items),L(R.nextCursor??null),v(R.total),g("ready")}).catch(()=>{re([]),L(null),g("ready")})},[d,k]);const S=async()=>{if(z){g("loading");try{const R=await $a({libraryId:d,collectionId:k,limit:40,cursor:z});re(ee=>[...ee,...R.items]),L(R.nextCursor??null),v(R.total),g("ready")}catch{g("ready")}}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:o}),e.jsx("p",{className:"cogita-library-subtitle",children:de||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:c,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${c}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${c}/collections/${k}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${c}/collections/${k}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:G}),e.jsx("span",{children:B==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:h.length?h.map(R=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:R.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:R.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:R.label}),e.jsx("p",{className:"cogita-card-subtitle",children:R.description})]})},ie(R))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),z?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:S,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${c}/collections/${k}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const qt=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const s=t.length,n=t.filter(m=>m.correct).length,r=Da(hs(t));return{score:Math.round(Math.max(0,Math.min(100,r.knowness*100))*100)/100,total:s,correct:n,lastReviewedUtc:r.lastReviewedUtc??null}},ci=t=>{if(t.maskBase64)try{const s=yn(t.maskBase64);if(!s.length)return t.correct?1:0;const n=s.reduce((r,l)=>r+l,0);return Math.max(0,Math.min(1,n/s.length/255))}catch{return t.correct?1:0}return t.correct?1:0},hs=t=>t.map(s=>({correctness:ci(s),createdUtc:s.createdUtc})),Da=(t,s=Date.now())=>{var W;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const r=t.slice().sort((v,h)=>v.createdUtc.localeCompare(h.createdUtc)).slice(-5),l=r.reduce((v,h)=>v+h.correctness,0)/r.length,m=5,b=2,y=.15;let E=0,j=0;for(let v=0;v<r.length;v+=1){const h=new Date(r[v].createdUtc).getTime(),re=v===r.length-1?s:new Date(r[v+1].createdUtc).getTime(),B=Math.max(0,(re-h)/(1e3*60)),g=1-Math.exp(-B/m);E+=g,r[v].correctness>.5&&(j+=y)}let d=l*E*b+j;const k=((W=r[r.length-1])==null?void 0:W.createdUtc)??null,c=k?Math.max(0,(s-new Date(k).getTime())/(1e3*60)):0,U=1/(1+Math.log1p(c/60));return d*=U,r.length===1&&r[0].correctness>.5&&(d+=5.44*Math.exp(-c/2)),{knowness:d,avgCorrectness:l,lastReviewedUtc:k}},wa=t=>{const s=t.slice();for(let n=s.length-1;n>0;n-=1){const r=Math.floor(Math.random()*(n+1));[s[n],s[r]]=[s[r],s[n]]}return s},La=t=>t[Math.floor(Math.random()*t.length)],di=(t,s)=>{const n=new Map;return t.forEach(r=>n.set(r,Math.random())),t.sort((r,l)=>{const m=s(r)-s(l);return m!==0?m:(n.get(r)??0)-(n.get(l)??0)})},Va=(t,s,n,r,l)=>{if(!t.length)return null;const m=t.filter(y=>!(l!=null&&l.has(ie(y))));if(m.length===0)return null;const b=m.filter(y=>ie(y)!==n);return La(b.length?b:m)},ui=(t,s,n,r,l)=>{if(!t.length)return null;let m=Number.POSITIVE_INFINITY;for(const j of t){const d=ie(j);if(n.has(d))continue;const k=s[d]??1;k<m&&(m=k)}if(!Number.isFinite(m))return null;const b=t.filter(j=>{const d=ie(j);return!n.has(d)&&(s[d]??1)===m}),y=b.filter(j=>!l||ie(j)!==l),E=r?y.filter(j=>!r.has(ie(j))):y;return E.length>0?La(E):y.length>0?La(y):l&&b.some(j=>ie(j)===l)?b.find(j=>ie(j)===l)??null:b.length?La(b):null},Ys=(t,s,n,r,l)=>{const m=[],b=t.filter(E=>!l.has(ie(E))&&!n.has(ie(E))&&(s[ie(E)]??0)<1),y=di(b,E=>s[ie(E)]??0);for(const E of y){if(m.length>=r)break;m.push(E),l.add(ie(E))}if(m.length<r){const E=wa(t.filter(j=>!l.has(ie(j))&&n.has(ie(j))));for(const j of E){if(m.length>=r)break;m.push(j),l.add(ie(j))}}return m},hi=(t,s,n,r)=>Ys(t,s,n,r,new Set),gs=(t,s,n,r,l,m)=>{const b=Math.max(1,n.stackSize??s),E=wa(t).filter((U,de,Y)=>Y.findIndex(W=>ie(W)===ie(U))===de),j=hi(E,r,l,b),d=new Set,k=new Set,c=Va(j,{},null,d,k),o=c?[c]:[];return c&&k.add(ie(c)),{queue:o,meta:{pool:E,active:j,knownessMap:r,unknownSet:l,outcomesById:m,asked:d,queued:k}}},ls={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,s)=>{const r=wa(t).filter((l,m,b)=>b.findIndex(y=>ie(y)===ie(l))===m);return{queue:r.slice(0,Math.min(s,r.length)),meta:{}}},applyOutcome:t=>t},ms=(t,s,n,r)=>{const l=Math.max(1,n.stackSize??s),b=wa(t).filter((de,Y,W)=>W.findIndex(v=>ie(v)===ie(de))===Y),y={},E=new Set,j=new Set,d=new Set,k=Math.max(1,n.levels??1);b.forEach(de=>{const Y=ie(de),W=r==null?void 0:r[Y],v=typeof W=="number"&&Number.isFinite(W)?W:1;y[Y]=Math.min(k,Math.max(1,Math.round(v)))});const c=[];if(b.length>0){const de=new Map;b.forEach(W=>{var h;const v=y[ie(W)]??1;de.has(v)||de.set(v,[]),(h=de.get(v))==null||h.push(W)});const Y=Array.from(de.keys()).sort((W,v)=>W-v);for(const W of Y){if(c.length>=l)break;const v=wa(de.get(W)??[]);for(const h of v){if(c.length>=l)break;c.push(h)}}}const o=Va(c,y,null,E,j),U=o?[o]:[];return o&&j.add(ie(o)),{queue:U,meta:{pool:b,active:c,levelMap:y,asked:E,queued:j,wrongSinceCorrect:d}}},gi={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,s)=>Math.max(1,s.stackSize??t),getProgressTotal:()=>null,prepare:(t,s,n)=>ms(t,s,n),applyOutcome:(t,s,n,r,l)=>{if(!s)return t;const m=Math.max(1,r.levels??1),b=t.meta.pool??[],y=t.meta.active??[],E={...t.meta.levelMap??{}},j=new Set(t.meta.asked??[]),d=new Set(t.meta.queued??[]),k=new Set(t.meta.wrongSinceCorrect??[]),c=ie(s);d.delete(c),j.add(c);const o=E[c]??1;l.correct?(E[c]=k.has(c)?1:Math.min(o+1,m),k.delete(c)):(E[c]=1,k.add(c));const U=l.correct?y.filter(W=>ie(W)!==c):y.slice();if(l.correct&&U.length<Math.max(1,r.stackSize??1)){const W=new Set(U.map(h=>ie(h))),v=ui(b,E,W,j,c);v&&U.push(v)}const de=t.queue.slice(),Y=Va(U,E,c,j,d);return Y&&(de.push(Y),d.add(ie(Y))),{queue:de,meta:{pool:b,active:U,levelMap:E,asked:j,queued:d,wrongSinceCorrect:k}}}},mi={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,s)=>Math.max(1,s.stackSize??t),getProgressTotal:()=>null,prepare:(t,s,n)=>gs(t,s,n,{},new Set,{}),applyOutcome:(t,s,n,r,l)=>{if(!s)return t;const m=t.meta.pool??[],b=t.meta.active??[],y={...t.meta.knownessMap??{}},E=new Set(t.meta.unknownSet??[]),j={...t.meta.outcomesById??{}},d=new Set(t.meta.asked??[]),k=new Set(t.meta.queued??[]),c=ie(s);k.delete(c),d.add(c);const o={correctness:Math.max(0,Math.min(1,l.correctness??(l.correct?1:0))),createdUtc:l.createdUtc??new Date().toISOString()},de=(j[c]??[]).concat(o).sort((B,g)=>B.createdUtc.localeCompare(g.createdUtc)).slice(-5);j[c]=de,E.delete(c);const Y=Date.now();m.forEach(B=>{const g=ie(B),z=j[g]??[];if(z.length===0){y[g]=0,E.add(g);return}const L=Da(z,Y);y[g]=L.knowness});const W=b.slice();if((y[c]??0)>=1){const B=W.filter(g=>ie(g)!==c);W.length=0,W.push(...B)}const h=Math.max(1,r.stackSize??n);if(W.length<h){const B=new Set(W.map(z=>ie(z))),g=Ys(m,y,E,h-W.length,B);W.push(...g)}const re=t.queue.slice();if(re.length===0||ie(re[re.length-1])===c){const B=Va(W,{},c,d,k);B&&(re.push(B),k.add(ie(B)))}return{queue:re,meta:{pool:m,active:W,knownessMap:y,unknownSet:E,outcomesById:j,asked:d,queued:k}}}},Gs={random:ls,levels:gi,temporal:mi},fi=Object.values(Gs),fs=t=>{if(!t)return ls;const s=t.trim().toLowerCase();return s==="random"||s==="levels"||s==="temporal"?Gs[s]:ls},Oa=(t,s)=>{const n={...t.defaultSettings};return s&&Object.entries(s).forEach(([r,l])=>{typeof l=="number"&&Number.isFinite(l)&&(n[r]=l),typeof l=="string"&&(n[r]=l)}),t.settingsFields.forEach(r=>{var m;const l=n[r.key];if(r.type==="number"){if(typeof l!="number"||Number.isNaN(l)){n[r.key]=t.defaultSettings[r.key]??0;return}r.min!==void 0&&(n[r.key]=Math.max(r.min,n[r.key])),r.max!==void 0&&(n[r.key]=Math.min(r.max,n[r.key]));return}if(r.type==="select"){const b=((m=r.options)==null?void 0:m.map(y=>y.value))??[];(typeof l!="string"||b.length>0&&!b.includes(l))&&(n[r.key]=t.defaultSettings[r.key]??b[0]??"")}}),n},Xs=(t,s)=>{const n={};return t.settingsFields.forEach(r=>{const l=s.get(r.key);if(l){if(r.type==="number"){const m=Number(l);Number.isNaN(m)||(n[r.key]=m);return}n[r.key]=l}}),Oa(t,n)},pi=(t,s)=>{const n=new URLSearchParams;return t.settingsFields.forEach(r=>{const l=s[r.key];(typeof l=="number"||typeof l=="string")&&n.set(r.key,String(l))}),n};function bi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,libraryId:d,collectionId:k,revisionId:c}){const{libraryName:o}=Ot(d),U=`/#/cogita/library/${d}`,[de,Y]=a.useState(t.cogita.library.collections.defaultName),[W,v]=a.useState(""),[h,re]=a.useState(20),[B,g]=a.useState("random"),[z,L]=a.useState({}),[G,S]=a.useState("exact"),[R,ee]=a.useState([]),[te,ae]=a.useState(null),[Pe,ue]=a.useState([]),[C,fe]=a.useState("idle"),[x,V]=a.useState(null),[he,_]=a.useState("idle"),[H,ke]=a.useState("idle"),[Se,ve]=a.useState("idle"),Ae=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),we=a.useMemo(()=>fs(B),[B]),Be=a.useMemo(()=>Oa(we,z),[we,z]),_e=a.useMemo(()=>pi(we,Be).toString(),[we,Be]);a.useEffect(()=>{qa(d,k).then(Q=>Y(Q.name)).catch(()=>Y(t.cogita.library.collections.defaultName))},[d,k]),a.useEffect(()=>{c&&xn({libraryId:d,collectionId:k,revisionId:c}).then(Q=>{v(Q.name),g(Q.mode||"random"),S(Q.check||"exact"),re(Q.limit||20),L(Q.revisionSettings??{})}).catch(()=>{v("")})},[k,d,c]),a.useEffect(()=>{vn({libraryId:d}).then(Q=>{ee(Q),!te&&Q.length>0&&ae(Q[0].roleId)}).catch(()=>{ee([])})},[d]);const je=()=>{ke("loading"),Us({libraryId:d}).then(Q=>{ue(Q),ke("idle")}).catch(()=>{ue([]),ke("error")})};a.useEffect(()=>{je()},[d]);const Ke=async()=>{fe("working"),_("idle");try{const Q=await jn({libraryId:d,collectionId:k,revisionType:we.id,revisionSettings:Be,mode:B,check:G,limit:h});V(`${Ae}/${Q.shareCode}${_e?`?${_e}`:""}`),fe("ready"),je()}catch{fe("error")}},Xe=async()=>{if(c){ve("saving");try{await wn({libraryId:d,collectionId:k,revisionId:c,name:W||de,revisionType:we.id,revisionSettings:Be,mode:B,check:G,limit:h}),ve("saved")}catch{ve("error")}}},Qe=async()=>{if(x)try{await navigator.clipboard.writeText(x),_("copied")}catch{_("failed")}},K=async Q=>{try{await zs({libraryId:d,shareId:Q}),je()}catch{je()}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:de}),e.jsx("p",{className:"cogita-library-subtitle",children:o})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:U,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${U}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${U}/collections/${k}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${U}/collections/${k}/revision/run?mode=${encodeURIComponent(B)}&check=${encodeURIComponent(G)}&limit=${h}${_e?`&${_e}`:""}${te?`&reviewer=${encodeURIComponent(te)}`:""}${c?`&revisionId=${encodeURIComponent(c)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:W,onChange:Q=>v(Q.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:B,onChange:Q=>g(Q.target.value),children:fi.map(Q=>e.jsx("option",{value:Q.id,children:t.cogita.library.revision[Q.labelKey]},Q.id))})]}),we.settingsFields.map(Q=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[Q.labelKey]}),Q.type==="select"?e.jsx("select",{value:String(Be[Q.key]??""),onChange:Ve=>L(Ce=>({...Ce,[Q.key]:Ve.target.value})),children:(Q.options??[]).map(Ve=>e.jsx("option",{value:Ve.value,children:t.cogita.library.revision[Ve.labelKey]},Ve.value))}):e.jsx("input",{type:"number",min:Q.min,max:Q.max,step:Q.step,value:Be[Q.key]??0,onChange:Ve=>L(Ce=>({...Ce,[Q.key]:Number(Ve.target.value||0)}))})]},Q.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),we.id!=="levels"&&we.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:h,onChange:Q=>re(Number(Q.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:te??"",onChange:Q=>ae(Q.target.value||null),children:R.map(Q=>e.jsx("option",{value:Q.roleId,children:Q.label},Q.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[c?e.jsx("button",{type:"button",className:"cta ghost",onClick:Xe,disabled:Se==="saving",children:Se==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${U}/collections/${k}/revision/run?mode=${encodeURIComponent(B)}&check=${encodeURIComponent(G)}&limit=${h}${_e?`&${_e}`:""}${te?`&reviewer=${encodeURIComponent(te)}`:""}${c?`&revisionId=${encodeURIComponent(c)}`:""}`,children:t.cogita.library.actions.startRevision})]}),Se==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),x?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:x,readOnly:!0})]}):null,C==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,he==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):he==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:Ke,disabled:C==="working",children:C==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),x?e.jsx("button",{type:"button",className:"cta ghost",onClick:Qe,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),H==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):Pe.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:Pe.map(Q=>e.jsxs("div",{className:"cogita-share-row","data-state":Q.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:Q.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(Q.createdUtc).toLocaleString(),Q.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),Q.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>K(Q.shareId),children:t.cogita.library.revision.shareRevokeAction})]},Q.shareId))})]})]})]})]})})})]})})}const es=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function Js(t,s,n){if(!t)return null;const r=new Map(t.nodes.map(B=>[B.id,B])),l=new Map,m=new Set,b=B=>{if(typeof B=="number")return B;if(typeof B=="string"){const g=Number(B);return Number.isFinite(g)?g:0}return 0},y=B=>{if(l.has(B))return l.get(B);if(m.has(B))return 0;const g=r.get(B);if(!g)return 0;m.add(B);const z=G=>{var R,ee;return(G?((R=g.inputsByHandle)==null?void 0:R[G])??[]:g.inputs??((ee=g.inputsByHandle)==null?void 0:ee.in)??[]).map(te=>y(te))};let L=0;switch(g.type){case"input.random":{const G=g.min??0,S=g.max??G+10,R=Math.min(G,S),ee=Math.max(G,S);L=Math.floor(Math.random()*(ee-R+1))+R;break}case"input.const":{L=g.value??0;break}case"input.list":{const G=(g.list??[]).filter(Boolean),S=Math.round(b(z("index")[0]));L=G.length?G[Math.max(0,Math.min(G.length-1,S))]:String(S);break}case"compute.add":{L=z("in").map(S=>b(S)).reduce((S,R)=>S+R,0);break}case"compute.sub":{const G=z("add").map(R=>b(R)),S=z("sub").map(R=>b(R));L=G.reduce((R,ee)=>R+ee,0)-S.reduce((R,ee)=>R+ee,0);break}case"compute.mul":{const G=z("in").map(S=>b(S));L=G.length?G.reduce((S,R)=>S*R,1):0;break}case"compute.div":{const G=b(z("num")[0]),S=z("den").map(R=>b(R)).reduce((R,ee)=>R+ee,0);L=Math.abs(S)<Number.EPSILON?0:G/S;break}case"compute.pow":{const G=b(z("base")[0]),S=b(z("exp")[0]);L=Math.pow(G,S);break}case"compute.exp":{const G=b(z("base")[0]),S=b(z("exp")[0]);L=Math.pow(G,S);break}case"compute.log":{const G=b(z("value")[0]),S=b(z("base")[0]),R=Math.max(G,Number.EPSILON);L=Math.abs(S)<Number.EPSILON?Math.log(R):Math.log(R)/Math.log(S);break}case"compute.abs":{L=Math.abs(b(z("in")[0]));break}case"compute.min":{const G=z("in").map(S=>b(S));L=G.length?Math.min(...G):0;break}case"compute.max":{const G=z("in").map(S=>b(S));L=G.length?Math.max(...G):0;break}case"compute.floor":{L=Math.floor(b(z("in")[0]));break}case"compute.ceil":{L=Math.ceil(b(z("in")[0]));break}case"compute.round":{L=Math.round(b(z("in")[0]));break}case"compute.mod":{const G=b(z("a")[0]),S=b(z("b")[0]);L=Math.abs(S)<Number.EPSILON?0:G%S;break}case"compute.concat":{const S=["in1","in2","in3","in4","in5","in6"].flatMap(ae=>z(ae)),R=S.length?S:z("in");L=(R.length?R:z()).map(ae=>ae==null?"":String(ae)).join("");break}case"compute.trim":{const G=z("text")[0]??z("in")[0]??"",S=G==null?"":String(G),R=Math.max(0,Math.round(b(z("start")[0]))),ee=Math.max(0,Math.round(b(z("end")[0])));R+ee>=S.length?L="":L=S.substring(R,S.length-ee);break}case"output":{L=z("in")[0]??0;break}default:L=0}return m.delete(B),l.set(B,L),L},E=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(B=>B.type==="output").map(B=>B.id);t.nodes.forEach(B=>y(B.id)),E.forEach(B=>y(B));const j=B=>Math.abs(B%1)<1e-5?String(Math.round(B)):B.toFixed(3).replace(/\.?0+$/,""),d=B=>typeof B=="number"?j(B):B??"",k=new Map;E.forEach(B=>{var S,R,ee,te;const g=r.get(B);if(!g)return;const z=(R=(S=g.inputsByHandle)==null?void 0:S.name)==null?void 0:R[0],L=z?d(l.get(z)):"",G=(L==null?void 0:L.toString().trim())||((ee=g.outputLabel)==null?void 0:ee.trim())||((te=g.name)==null?void 0:te.trim())||B;k.set(B,G)});const c={},o={},U={};E.forEach(B=>{var L,G;const g=r.get(B);if(!g)return;const z=k.get(B)??(((L=g.outputLabel)==null?void 0:L.trim())||((G=g.name)==null?void 0:G.trim())||B);c[z]=d(l.get(B)),g.name&&(o[g.name.trim()]=z),o[B]=z});const de=(B,g)=>{let z=B;return t.nodes.forEach(L=>{var te,ae;const G=d(l.get(L.id)),S=E.includes(L.id),R=S?k.get(L.id)??((te=L.outputLabel)==null?void 0:te.trim())??((ae=L.name)==null?void 0:ae.trim())??L.id:"",ee=S&&g?R:G;z=z.replace(new RegExp(`\\{\\s*${es(L.id)}\\s*\\}`,"gi"),ee),L.name&&(z=z.replace(new RegExp(`\\{\\s*${es(L.name)}\\s*\\}`,"gi"),ee)),S&&L.outputLabel&&(z=z.replace(new RegExp(`\\{\\s*${es(L.outputLabel)}\\s*\\}`,"gi"),R))}),z},Y=s;let W=Y.trim().length>0?Y:"";W||(W=E.length?`Compute ${E.join(", ")}`:"Compute"),W=de(W,!0);const v=(n==null?void 0:n.trim())??"",h=v?de(v,!1):"",re={};return l.forEach((B,g)=>{re[g]=B,U[g]=d(B);const z=r.get(g);z!=null&&z.name&&(U[z.name.trim()]=d(B))}),{prompt:W,answers:c,values:re,answerText:h,outputVariables:o,variableValues:U}}function Zs(t){var n;const s=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((n=s[0])==null?void 0:n[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}function en({copy:t,currentCard:s,currentTypeLabel:n,prompt:r,languages:l,answer:m,onAnswerChange:b,computedExpected:y,computedAnswers:E,onComputedAnswerChange:j,answerTemplate:d,outputVariables:k,variableValues:c,computedFieldFeedback:o,feedback:U,canAdvance:de,quoteContext:Y,quotePlaceholder:W,onCheckAnswer:v,onSkip:h,onLanguageSelect:re,onMarkReviewed:B,onAdvance:g,showCorrectAnswer:z,setShowCorrectAnswer:L,onRevealCorrect:G,answerMask:S,expectedAnswer:R,hasExpectedAnswer:ee,handleComputedKeyDown:te,answerInputRef:ae,computedInputRefs:Pe,scriptMode:ue,setScriptMode:C,matchPairs:fe,matchLeftOrder:x,matchRightOrder:V,matchSelection:he,matchActiveLeft:_,matchActiveRight:H,matchFeedback:ke,onMatchLeftSelect:Se,onMatchRightSelect:ve}){const Ae=a.useMemo(()=>{var xe;const K=!d&&y.length===2?`The {${y[0].key}} is of type {${y[1].key}}`:null,Q=d??K;if(!Q)return null;const Ve=new Map(y.map($=>[$.key,$.expected])),Ce=new Set,le=[],Le=/\{([^}]+)\}/g;let qe=0,q,ge=null;for(;(q=Le.exec(Q))!==null;){const $=Q.slice(qe,q.index);$&&le.push({type:"text",value:$});const O=((xe=q[1])==null?void 0:xe.trim())??"",pe=O&&Ve.has(O)?O:O&&k&&k[O]?k[O]:null;O&&Ce.add(O),pe&&Ce.add(pe),pe&&Ve.has(pe)?(le.push({type:"input",value:pe}),ge||(ge=pe)):O&&c&&c[O]!==void 0?le.push({type:"text",value:c[O]}):le.push({type:"text",value:q[0]}),qe=q.index+q[0].length}const I=Q.slice(qe);return I&&le.push({type:"text",value:I}),y.filter($=>!Ce.has($.key)).length>0?null:{parts:le,expectedByKey:Ve,firstInputKey:ge}},[d,y,k,c]),we=()=>{if(!Ae)return null;const{parts:K,expectedByKey:Q,firstInputKey:Ve}=Ae;return e.jsx("div",{className:"cogita-revision-inline-answer",children:K.map((Ce,le)=>{var Le,qe;return Ce.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:Ce.value},`text-${le}`):e.jsx("input",{ref:q=>{Pe.current[Ce.value]=q},autoFocus:Ce.value===Ve,value:E[Ce.value]??"",onChange:q=>j(Ce.value,q.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":o[Ce.value]??(U==="correct"?"correct":U==="incorrect"?"incorrect":void 0),onKeyDown:q=>Ke(q)||te(q),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((Le=E[Ce.value])==null?void 0:Le.length)??0,((qe=Q.get(Ce.value))==null?void 0:qe.length)??6)}ch`}},`input-${Ce.value}-${le}`)})})},Be=a.useMemo(()=>{const K=new Map;return(fe??[]).forEach(Q=>K.set(Q.leftId,Q)),K},[fe]),_e=a.useMemo(()=>{const K=new Map;return(fe??[]).forEach(Q=>K.set(Q.rightId,Q)),K},[fe]);a.useEffect(()=>{var le;if(s.cardType!=="info"||s.infoType!=="computed"||y.length===0)return;const K=typeof document<"u"?document.activeElement:null;if(K&&(K.tagName==="INPUT"||K.tagName==="TEXTAREA"))return;const Q=(Ae==null?void 0:Ae.firstInputKey)??((le=y[0])==null?void 0:le.key);if(!Q)return;const Ve=Pe.current[Q];if(!Ve)return;const Ce=requestAnimationFrame(()=>{Ve.focus()});return()=>cancelAnimationFrame(Ce)},[s,y,Ae]);const je=(()=>{const K=[R??"",...y.map(Ce=>Ce.expected??"")].join(""),Q=[m,...Object.values(E)].join(""),Ve=`${K}${Q}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(Ve)})(),Ke=K=>K.ctrlKey&&(K.key==="^"||K.key==="6")?(K.preventDefault(),C(Q=>Q==="super"?null:"super"),!0):K.ctrlKey&&(K.key==="_"||K.key==="-")?(K.preventDefault(),C(Q=>Q==="sub"?null:"sub"),!0):!1,Xe=()=>{if(!R||!S)return R??"";const K=R.split(""),Q=Array.from(S),Ve=Q.length>0?Q.reduce((Ce,le)=>Ce+le,0)/Q.length:127;return K.map((Ce,le)=>{const Le=Q[le]??Ve,qe=Math.max(0,Math.min(255,Math.round(Le)));let q=255,ge=0;return qe<=127?ge=Math.round(qe/127*255):(ge=255,q=Math.round(255*(1-(qe-127)/128))),e.jsx("span",{style:{color:`rgb(${q}, ${ge}, 0)`},children:Ce},`mask-${le}`)})},Qe=s.cardType==="info"&&s.infoType==="quote"?(Y==null?void 0:Y.title)||s.label:s.description;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[e.jsx("span",{children:n}),e.jsx("strong",{children:Qe})]}),s.cardType==="vocab"&&s.checkType==="translation-match"&&fe?e.jsxs("div",{className:"cogita-revision-body",children:[r?e.jsx("h2",{children:r}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(x??[]).map(K=>{const Q=Be.get(K);if(!Q)return null;const Ve=(he==null?void 0:he[K])??null,Ce=(ke==null?void 0:ke[K])??null,le=_===K;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":le,"data-state":Ce??void 0,"data-locked":Ve?"true":void 0,onClick:()=>Se==null?void 0:Se(K),children:[e.jsx("span",{children:Q.leftLabel}),Ve&&z?e.jsx("em",{children:"✓"}):null]},K)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(V??[]).map(K=>{const Q=_e.get(K);if(!Q)return null;const Ve=Object.values(he??{}).includes(K),Ce=H===K;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":Ve||Ce,"data-locked":Ve?"true":void 0,onClick:()=>ve==null?void 0:ve(K),children:e.jsx("span",{children:Q.rightLabel})},K)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:s.checkType==="translation-match",children:t.cogita.library.revision.checkAnswer}),e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):s.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ae,value:m,onChange:K=>b(K.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":U==="correct"?"correct":U==="incorrect"?"incorrect":void 0,onKeyDown:K=>{K.key==="Enter"&&(K.preventDefault(),K.stopPropagation(),de?g():v())}})]}),je?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":ue==="super",onClick:()=>C(K=>K==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":ue==="sub",onClick:()=>C(K=>K==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,children:t.cogita.library.revision.checkAnswer}),e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[s.label?e.jsx("p",{className:"cogita-revision-hint",children:s.label}):null,d?null:e.jsx(kn,{value:r??"",mode:"auto"}),y.length>0?(()=>{const K=we();return K?e.jsx("div",{className:"cogita-inline-answer-wrap",children:K}):e.jsx("div",{className:"cogita-form-grid",children:y.map((Q,Ve)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:Q.key}),e.jsx("textarea",{ref:Ce=>{Pe.current[Q.key]=Ce},autoFocus:Ve===0,value:E[Q.key]??"",onChange:Ce=>j(Q.key,Ce.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":o[Q.key]??(U==="correct"?"correct":U==="incorrect"?"incorrect":void 0),onKeyDown:Ce=>Ke(Ce)||te(Ce)})]},Q.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:ae,value:m,onChange:K=>b(K.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":U==="correct"?"correct":U==="incorrect"?"incorrect":void 0,onKeyDown:K=>{Ke(K)||K.key==="Enter"&&(K.preventDefault(),K.stopPropagation(),de?g():v())}})]})}),je?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":ue==="super",onClick:()=>C(K=>K==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":ue==="sub",onClick:()=>C(K=>K==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,children:t.cogita.library.revision.checkAnswer}),e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="quote"&&Y?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(Y.completed)).replace("{total}",String(Y.total))}),e.jsx("p",{className:"cogita-quote-text",children:Y.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ae,value:m,onChange:K=>b(K.target.value),placeholder:W??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":U==="correct"?"correct":U==="incorrect"?"incorrect":void 0,onKeyDown:K=>{K.key==="Enter"&&(K.preventDefault(),K.stopPropagation(),de?g():v())}})]}),e.jsx("p",{className:"cogita-quote-text",children:Y.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,children:t.cogita.library.revision.checkAnswer}),e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:l.length?l.map(K=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>re(K.label),children:K.label},K.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:B,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}),U&&e.jsx("div",{className:"cogita-revision-feedback","data-state":U,children:U==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),U==="incorrect"&&ee?e.jsxs("div",{className:"cogita-revision-reveal",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>L(K=>{const Q=!K;return Q&&G(),Q}),children:t.cogita.library.revision.showAnswer}),z?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),y.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[y.map(K=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:K.key}),e.jsx("span",{children:K.expected})]},K.key)),R?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:R})]}):null]}):e.jsx("p",{children:S?Xe():R})]}):null]}):null,de?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:g,children:t.cogita.library.revision.nextQuestion})}):null]})}const ts=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function tn({outcomes:t}){const[s,n]=a.useState("day"),r=a.useMemo(()=>{const l=ts.find(y=>y.id===s)??ts[1],m=Date.now()-l.ms,b=t.filter(y=>new Date(y.createdUtc).getTime()>=m);return qt(b)},[t,s]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:ts.map(l=>e.jsx("button",{type:"button",className:"ghost","data-active":s===l.id,onClick:()=>n(l.id),children:l.label},l.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[r.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[r.correct," / ",r.total]})]})}const yi="cogita-revision",xi=1,Ea="outcomes",vi=()=>new Promise((t,s)=>{const n=indexedDB.open(yi,xi);n.onupgradeneeded=()=>{const r=n.result;if(!r.objectStoreNames.contains(Ea)){const l=r.createObjectStore(Ea,{keyPath:"id"});l.createIndex("byItem","itemKey",{unique:!1}),l.createIndex("byPending","pending",{unique:!1})}},n.onerror=()=>s(n.error),n.onsuccess=()=>t(n.result)}),ka=async(t,s)=>{const n=await vi();return new Promise((r,l)=>{const m=n.transaction(Ea,t),b=m.objectStore(Ea);s(b).then(r).catch(l),m.onerror=()=>l(m.error)})},an=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const s=Array.from(t).map(n=>n.toString(16).padStart(2,"0"));return`${s.slice(0,4).join("")}-${s.slice(4,6).join("")}-${s.slice(6,8).join("")}-${s.slice(8,10).join("")}-${s.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},wi=()=>{const t="cogita_revision_client_id",s=localStorage.getItem(t);if(s)return s;const n=an();return localStorage.setItem(t,n),n},ji=()=>{const t="cogita_revision_client_seq",s=Number(localStorage.getItem(t)??"0"),n=Number.isFinite(s)?s+1:1;return localStorage.setItem(t,String(n)),n},sn=(t,s,n,r)=>Kt(t,s,n,r),Aa=async t=>{const s=wi(),n=ji(),r=new Date().toISOString(),l={...t,clientId:s,clientSequence:n,createdUtc:r,id:an(),pending:!0};return await ka("readwrite",m=>new Promise((b,y)=>{const E={...l,itemKey:sn(l.itemType,l.itemId,l.checkType,l.direction)},j=m.add(E);j.onsuccess=()=>b(),j.onerror=()=>y(j.error)})),l},Fa=async(t,s,n,r)=>{if(!s)return[];try{const l=sn(t,s,n,r);return await ka("readonly",m=>new Promise((b,y)=>{const j=m.index("byItem").getAll(l);j.onsuccess=()=>{const k=(j.result??[]).map(c=>({itemType:c.itemType,itemId:c.itemId,checkType:c.checkType??null,direction:c.direction??null,revisionType:c.revisionType,evalType:c.evalType,correct:c.correct,createdUtc:c.createdUtc,maskBase64:c.maskBase64,payloadBase64:c.payloadBase64,payloadHashBase64:c.payloadHashBase64,clientId:c.clientId,clientSequence:c.clientSequence,personRoleId:c.personRoleId??null})).sort((c,o)=>c.createdUtc.localeCompare(o.createdUtc));b(k)},j.onerror=()=>y(j.error)}))}catch{return[]}},Dt=async()=>{try{return await ka("readonly",t=>new Promise((s,n)=>{const r=t.getAll();r.onsuccess=()=>{const m=(r.result??[]).map(b=>({itemType:b.itemType,itemId:b.itemId,checkType:b.checkType??null,direction:b.direction??null,revisionType:b.revisionType,evalType:b.evalType,correct:b.correct,createdUtc:b.createdUtc,maskBase64:b.maskBase64,payloadBase64:b.payloadBase64,payloadHashBase64:b.payloadHashBase64,clientId:b.clientId,clientSequence:b.clientSequence,personRoleId:b.personRoleId??null}));s(m)},r.onerror=()=>n(r.error)}))}catch{return[]}},ki=async(t=100)=>{try{return await ka("readonly",s=>new Promise((n,r)=>{const m=s.index("byPending").getAll(!0);m.onsuccess=()=>{const b=m.result??[];n(b.slice(0,t))},m.onerror=()=>r(m.error)}))}catch{return[]}},Ni=async t=>{if(t.length!==0)try{await ka("readwrite",s=>new Promise((n,r)=>{let l=t.length;t.forEach(m=>{const b=s.get(m);b.onsuccess=()=>{const y=b.result;if(y){y.pending=!1;const E=s.put(y);E.onsuccess=()=>{l-=1,l===0&&n()},E.onerror=()=>r(E.error)}else l-=1,l===0&&n()},b.onerror=()=>r(b.error)})}))}catch{}},as=async(t,s)=>{const n=await ki(200);if(n.length===0)return;const r=new Map;n.forEach(l=>{var b;const m=l.personRoleId??s??"";r.has(m)||r.set(m,[]),(b=r.get(m))==null||b.push(l)});for(const[l,m]of r.entries()){const b=m.map(y=>({itemType:y.itemType,itemId:y.itemId,checkType:y.checkType??null,direction:y.direction??null,revisionType:y.revisionType,evalType:y.evalType,correct:y.correct,clientId:y.clientId,clientSequence:y.clientSequence,maskBase64:y.maskBase64??null,payloadHashBase64:y.payloadHashBase64??null,payloadBase64:y.payloadBase64??null,personRoleId:l||null}));try{await Nn({libraryId:t,outcomes:b}),await Ni(m.map(y=>y.id))}catch{}}},Ls={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},Ti=(t,s)=>{const n=Math.max(t.length,s.length,1),r=Math.abs(t.length-s.length);return Math.max(0,1-r/n)},Si=(t,s)=>{const n=new Uint8Array(t.length),r=Ti(t,s);for(let l=0;l<t.length;l+=1){const m=t[l]===(s[l]??"")?128:0,b=t.length-1-l,y=s.length-1-l,E=t[b]===(s[y]??"")?127:0,j=Math.round((m+E)*r);n[l]=Math.max(0,Math.min(255,j))}return n},Ma=(t,s)=>t===s||(Ls[t]??[]).includes(s)?!0:(Ls[s]??[]).includes(t),Pa=(t,s)=>{const n=new Uint8Array(t.length);if(!t.length)return n;const r=[];for(let m=0;m<=t.length-3;m+=1)r.push({index:m,text:t.slice(m,m+3)});let l=!1;return r.forEach(m=>{for(let b=0;b<=s.length-3;b+=1){const y=s.slice(b,b+3);let E=0;for(let o=0;o<3;o+=1)Ma(m.text[o],y[o])&&(E+=1);if(E<2)continue;let j=m.index-1,d=b-1;for(;j>=0&&d>=0;){const o=t[j],U=s[d];if(o===U){n[j]=Math.max(n[j],255),j-=1,d-=1,l=!0;continue}if(Ma(o,U)){n[j]=Math.max(n[j],127),j-=1,d-=1,l=!0;continue}if(j>0&&t[j-1]===U){n[j]=Math.max(n[j],0),j-=1,l=!0;continue}if(d>0&&t[j]===s[d-1]){d-=1,l=!0;continue}break}for(let o=0;o<3;o+=1){const U=m.index+o,de=m.text[o],Y=y[o],W=de===Y?255:Ma(de,Y)?127:0;n[U]=Math.max(n[U],W),l=!0}let k=m.index+3,c=b+3;for(;k<t.length&&c<s.length;){const o=t[k],U=s[c];if(o===U){n[k]=Math.max(n[k],255),k+=1,c+=1,l=!0;continue}if(Ma(o,U)){n[k]=Math.max(n[k],127),k+=1,c+=1,l=!0;continue}if(k+1<t.length&&t[k+1]===U){n[k]=Math.max(n[k],0),k+=1,l=!0;continue}if(c+1<s.length&&t[k]===s[c+1]){c+=1,l=!0;continue}break}}}),l?n:Si(t,s)},ga=(t,s,n)=>{const r=t.trim().toLowerCase(),l=s.trim().toLowerCase();return Pa(r,l)},fa=t=>t.trim().toLowerCase().replace(/[^\p{L}\p{N}]+/gu,""),nn=(t,s,n)=>{const r=fa(t),l=fa(s);return Pa(r,l)},wt=t=>t.trim().toLowerCase(),Ci=t=>t==="reverse"?"reverse":"forward",ja=(t,s)=>`${t}|${s}`,Nt=t=>{if(!t)return null;const[s,n]=t.split("|",2);return(s==="forward"||s==="reverse")&&n?{mode:s,fragmentId:n}:{mode:"forward",fragmentId:t}},Ba=(t,s)=>{var r;const n=Nt(s);return n?n.fragmentId&&s?(t??null)===s:(((r=Nt(t))==null?void 0:r.mode)??"forward")===n.mode:!0},ut=t=>{const s=t==null?void 0:t.trim().toLowerCase();return s||null},rn=(t,s)=>{if((ut(t.childItemType)??"info")!==(s.cardType??"").toLowerCase()||t.childItemId!==s.cardId)return!1;const r=ut(t.childCheckType),l=ut(t.childDirection),m=ut(s.checkType),b=ut(s.direction);return!(r&&r!==m||l&&l!==b)},Mi={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},Ii={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},_a=(t,s,n)=>{if(!n||!s.startsWith(t))return s;const r=s.slice(t.length);if(!r)return s;const l=n==="super"?Mi:Ii,m=r.split("").map(b=>l[b]??b).join("");return t+m},Ka=(t,s,n)=>{var b,y,E;if(!t)return((b=s[0])==null?void 0:b.key)??null;const r=new Set(s.map(j=>j.key)),l=/\{([^}]+)\}/g;let m;for(;(m=l.exec(t))!==null;){const j=((y=m[1])==null?void 0:y.trim())??"";if(!j)continue;if(r.has(j))return j;const d=n==null?void 0:n[j];if(d&&r.has(d))return d}return((E=s[0])==null?void 0:E.key)??null},cs=t=>t.flatMap(s=>{if(s.cardType!=="info"||s.infoType!=="quote")return[s];const n=s.description??"";if(!n.trim())return[s];const r=Nt(s.direction),l=(r==null?void 0:r.mode)??Ci(s.direction),m=ma(n),b=Object.keys(m.nodes);return b.length===0?[s]:b.map(y=>({...s,checkType:"quote-fragment",direction:ja(l,y)}))});function Li({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,libraryId:d,collectionId:k,revisionId:c}){const o=ds(),U=`/#/cogita/library/${d}`,de=a.useMemo(()=>new URLSearchParams(o.search),[o.search]),Y=Math.max(1,Number(de.get("limit")??20)),W=de.get("mode")??"random",v=a.useMemo(()=>fs(W),[W]),h=a.useMemo(()=>Oa(v,Xs(v,de)),[v,de]),re=de.get("check")??"exact",B=de.get("reviewer"),g=a.useMemo(()=>t.cogita.library.revision[v.labelKey]??W,[t,W,v]),z=a.useMemo(()=>re==="exact"?t.cogita.library.revision.checkValue:re,[t,re]),[L,G]=a.useState(t.cogita.library.collections.defaultName),[S,R]=a.useState([]),[ee,te]=a.useState([]),[ae,Pe]=a.useState("idle"),[ue,C]=a.useState({current:0,total:0}),[fe,x]=a.useState(0),[V,he]=a.useState(""),[_,H]=a.useState(null),[ke,Se]=a.useState(null),[ve,Ae]=a.useState(null),[we,Be]=a.useState(null),[_e,je]=a.useState([]),[Ke,Xe]=a.useState({}),[Qe,K]=a.useState({}),[Q,Ve]=a.useState(null),[Ce,le]=a.useState(null),[Le,qe]=a.useState(null),[q,ge]=a.useState(null),[I,X]=a.useState(null),[xe,$]=a.useState({}),O=a.useRef(0),[pe,Me]=a.useState(null),be=a.useRef(null),$e=a.useRef(null),[ze,We]=a.useState(null),[Re,Ee]=a.useState(!1),[Ne,st]=a.useState(null),[He,Je]=a.useState([]),[mt,jt]=a.useState(null),Ye=a.useRef(null),Ze=a.useRef(null),[ht,ot]=a.useState(null),[Lt,tt]=a.useState(0),lt=a.useRef(null),Ft=a.useRef({}),[bt,Ge]=a.useState(!1),[ct,St]=a.useState({}),[Pt,Bt]=a.useState([]),gt=a.useRef(new Map),[yt,N]=a.useState(new Set),[ye,me]=a.useState(!1),Fe=a.useRef(null),et=a.useRef(new Set),at=a.useRef({}),oe=S[fe]??null,se=(oe==null?void 0:oe.checkType)==="translation-match"&&I,ft=a.useRef(new Map),kt=a.useRef(new Map),Ut=a.useRef(new Map),Vt=a.useRef(new Map),Qt=a.useMemo(()=>oe?oe.cardType==="vocab"?t.cogita.library.revision.vocabLabel:oe.infoType?Ue(t,oe.infoType):t.cogita.library.revision.infoLabel:"",[t,oe]),Yt=a.useMemo(()=>{var u;return v.id!=="levels"?S.length:((u=ct.pool)==null?void 0:u.length)??v.getFetchLimit(Y,h)},[ct,h,v,S.length,Y]),zt=v.getProgressTotal?v.getProgressTotal(S,ct,Y,h):v.id==="levels"?Math.min(Y,Yt):S.length,$t=zt?Math.min(fe+1,zt):0,Ct=Math.max(1,Number(h.tries??1)),pt=h.compare??"anchors",it=Math.max(0,Math.min(100,Number(h.minCorrectness??0))),rt=(h.considerDependencies??"on")==="on",nt=Math.max(0,Math.min(100,Number(h.dependencyThreshold??85))),Rt=i=>{const u=i.slice();for(let w=u.length-1;w>0;w-=1){const f=Math.floor(Math.random()*(w+1));[u[w],u[f]]=[u[f],u[w]]}return u},Gt=i=>i.length?i.reduce((w,f)=>w+f,0)/i.length/255*100:0,Wt=i=>Gt(i)>=it,na=async()=>{const i=await Dt(),u=new Map,w=new Map,f=new Map;i.forEach(M=>{const F=`${M.itemType}:${M.itemId}`,J=Kt(M.itemType,M.itemId,M.checkType,M.direction);if(u.has(F)||u.set(F,[]),u.get(F).push(M),w.has(J)||w.set(J,[]),w.get(J).push(M),M.itemType==="info"&&M.checkType==="quote-fragment"&&M.direction){const Z=`${M.itemId}:${M.direction}`;f.has(Z)||f.set(Z,[]),f.get(Z).push(M)}});const P=new Map,p=new Map,A=new Map;return u.forEach((M,F)=>P.set(F,qt(M).score)),w.forEach((M,F)=>p.set(F,qt(M).score)),f.forEach((M,F)=>A.set(F,qt(M).score)),{itemKnowness:P,cardKnowness:p,fragmentKnowness:A}},Ua=async i=>{const u=[];let w=null;for(;;){const f=await $a({libraryId:d,collectionId:i,limit:200,cursor:w});if(u.push(...f.items),!f.nextCursor)break;w=f.nextCursor}return cs(u)},pa=async(i,u)=>{if(gt.current.has(i))return gt.current.get(i)??0;const w=await Ua(i);if(w.length===0)return gt.current.set(i,0),0;const P=w.reduce((p,A)=>{const M=ie(A);return p+(u.get(M)??0)},0)/w.length;return gt.current.set(i,P),P},za=(i,u)=>{if(!rt||i.cardType!=="info"||i.infoType!=="quote"||i.checkType!=="quote-fragment")return!0;const w=Nt(i.direction);if(!(w!=null&&w.fragmentId))return!0;const f=i.description??"";if(!f.trim())return!0;const p=ma(f).nodes[w.fragmentId];if(!p||!p.leftId&&!p.rightId)return!0;const A=[p.leftId,p.rightId].filter(J=>!!J);if(A.length===0)return!0;const M=A.map(J=>{const Z=Kt("info",i.cardId,"quote-fragment",ja(w.mode,J));return u.get(Z)??0});return M.reduce((J,Z)=>J+Z,0)/M.length>=nt},ia=async i=>{const u=ct,w=i.concat(u.active??[]).concat(u.pool??[]).filter((M,F,J)=>J.findIndex(Z=>ie(Z)===ie(M))===F);if(!rt){N(new Set(w.map(ie)));return}const{itemKnowness:f,cardKnowness:P}=await na(),p=Pt.filter(M=>ut(M.childItemType)==="collection"&&M.childItemId===k&&!ut(M.childCheckType)&&!ut(M.childDirection)),A=new Set;for(const M of w){if(M.cardType!=="info"){A.add(ie(M));continue}if(!za(M,P))continue;const F=Pt.filter(ce=>rn(ce,M)).concat(p);if(F.length===0){A.add(ie(M));continue}let J=0;for(const ce of F)if(ut(ce.parentItemType)==="collection")J+=await pa(ce.parentItemId,P);else if(ut(ce.parentCheckType)||ut(ce.parentDirection)){const ne=ut(ce.parentCheckType),Te=ut(ce.parentDirection),Ie=Kt(ce.parentItemType,ce.parentItemId,ne,Te);J+=P.get(Ie)??0}else{const ne=`${ce.parentItemType}:${ce.parentItemId}`;J+=f.get(ne)??0}J/F.length>=nt&&A.add(ie(M))}N(A)},Wa=i=>{for(let u=i;u<S.length;u+=1){const w=S[u];if(w&&(!rt||w.cardType!=="info"||yt.has(ie(w))))return u}return-1},Mt=i=>!rt||i.cardType!=="info"||yt.has(ie(i)),ra=i=>{if(v.id!=="temporal"&&v.id!=="levels")return null;const u=ct,w=(u.active??[]).concat(u.pool??[]),f=new Set;for(const P of w){const p=ie(P);if(!(f.has(p)||i.has(p))&&(f.add(p),Mt(P)))return P}return null},Et=a.useMemo(()=>{if(v.id!=="levels")return null;const i=ct,u=i.pool??[],w=i.active??[],f=i.levelMap??{},P=Math.max(1,Number(h.levels??1)),p=Array.from({length:P},()=>0),A=new Set(w.map(Z=>ie(Z)));u.forEach(Z=>{const ce=Math.min(P,Math.max(1,f[ie(Z)]??1));p[ce-1]+=1});const M=u.length||1,F=p.map(Z=>Z/M*100),J=oe?f[ie(oe)]??1:null;return{counts:p,percentages:F,currentLevel:J,levelsCount:P,activeCount:w.length,poolCount:u.length,activeSet:A}},[ct,h,v,oe]),xt=a.useMemo(()=>{if(v.id!=="temporal")return null;const i=ct,u=i.pool??[],w=i.active??[],f=i.knownessMap??{},P=new Set(i.unknownSet??[]);let p=0;u.forEach(F=>{(f[ie(F)]??0)>1&&(p+=1)});const A=P.size,M=w.map(F=>({id:ie(F),value:P.has(ie(F))?0:Math.max(0,Math.min(1,f[ie(F)]??0))}));return{knownCount:p,unknownCount:A,dots:M}},[ct,v]),oa=a.useMemo(()=>{if(!rt)return 0;const i=ct;return S.concat(i.active??[]).concat(i.pool??[]).filter((w,f,P)=>P.findIndex(p=>ie(p)===ie(w))===f).filter(w=>w.cardType==="info"&&!yt.has(ie(w))).length},[rt,ct,S,yt]);a.useEffect(()=>{if(!rt||ae!=="ready")return;const i=ct,w=S.concat(i.active??[]).concat(i.pool??[]).filter((p,A,M)=>M.findIndex(F=>ie(F)===ie(p))===A).filter(p=>p.cardType!=="info"||yt.has(ie(p))).length,f=Ye.current;if(Ye.current=w,f===null||w<=f)return;const P=w-f;jt(`New card available (+${P})`),Ze.current&&window.clearTimeout(Ze.current),Ze.current=window.setTimeout(()=>jt(null),2200)},[rt,ae,ct,S,yt]),a.useEffect(()=>()=>{Ze.current&&window.clearTimeout(Ze.current)},[]);const vt=(i,u)=>{const w=v.applyOutcome({queue:S,meta:ct},oe,Y,h,{correct:i,correctness:u,createdUtc:new Date().toISOString()});R(w.queue),St(w.meta);const f=w.queue[fe+1];f&&ba(f,fe+1)};a.useEffect(()=>{qa(d,k).then(i=>G(i.name)).catch(()=>G(t.cogita.library.collections.defaultName))},[d,k]),a.useEffect(()=>{us({libraryId:d,type:"language"}).then(i=>te(i)).catch(()=>te([]))},[d]),a.useEffect(()=>{Vs({libraryId:d}).then(i=>Bt(i.items??[])).catch(()=>Bt([]))},[d]),a.useEffect(()=>{as(d,B)},[d,B]),a.useEffect(()=>{ia(S)},[S,Pt,rt,nt,k]),a.useEffect(()=>{if(!oe||!rt){me(!1);return}if(oe.cardType!=="info"||yt.has(ie(oe))){me(!1);return}const i=Wa(fe+1);if(i>=0){me(!1),x(i);return}if(v.id==="temporal"||v.id==="levels"){const u=S.slice(0,fe+1),w=S.slice(fe+1).filter(Mt),f=u.concat(w),P=new Set(f.map(ie)),p=ra(P);if(p){const M=ie(p);P.has(M)||(f.push(p),P.add(M),St(F=>{const J=F,Z=new Set(J.queued??[]);return Z.add(M),{...J,queued:Z}}))}const A=f.findIndex((M,F)=>F!==fe&&Mt(M));if(A>=0){R(f),x(A),me(!1);return}}me(!0)},[oe,yt,rt,fe,S,ct,v.id]),a.useEffect(()=>{let i=!0;return(async()=>{Pe("loading"),C({current:0,total:v.id==="levels"?0:v.getFetchLimit(Y,h)});try{const w=[];let f=null,P=null;do{const ce=await $a({libraryId:d,collectionId:k,limit:300,cursor:f});if(w.push(...ce.items),(v.id==="levels"||v.id==="temporal")&&ce.total&&(P=ce.total),C(ne=>({current:w.length,total:ne.total||ce.total||v.getFetchLimit(Y,h)})),f=ce.nextCursor??null,P!==null&&w.length>=P||v.id!=="levels"&&v.id!=="temporal"&&w.length>=v.getFetchLimit(Y,h))break}while(f);if(!i)return;const p=cs(w);let A;if(v.id==="levels"){const ce=Math.max(1,Number(h.levels??1)),Te=(await Dt()).reduce((Ie,De)=>{const Oe=Kt(De.itemType,De.itemId,De.checkType,De.direction);return Ie[Oe]||(Ie[Oe]=[]),Ie[Oe].push(De),Ie},{});A={},p.forEach(Ie=>{const De=ie(Ie),Oe=Te[De]??[],dt=Oe.length>0?qt(Oe).score:0,ta=Math.max(1,Math.min(ce,Math.ceil(dt/100*ce)));A[De]=ta})}let M=null,F=null,J=null;if(v.id==="temporal"){const ce=await Dt(),ne=new Set(p.map(De=>ie(De))),Te=ce.reduce((De,Oe)=>{const dt=Kt(Oe.itemType,Oe.itemId,Oe.checkType,Oe.direction);return ne.has(dt)&&(De[dt]||(De[dt]=[]),De[dt].push(Oe)),De},{});M={},F=new Set,J={};const Ie=Date.now();p.forEach(De=>{const Oe=ie(De),dt=Te[Oe]??[];if(dt.length===0){M[Oe]=0,F.add(Oe),J[Oe]=[];return}const ta=hs(dt);J[Oe]=ta;const ln=Da(ta,Ie);M[Oe]=ln.knowness})}const Z=v.id==="levels"?ms(p,Y,h,A):v.id==="temporal"?gs(p,Y,h,M??{},F??new Set,J??{}):v.prepare(p,Y,h);R(Z.queue),St(Z.meta),x(0),Pe("ready"),C(ce=>({current:Math.min(ce.current,ce.total),total:ce.total}))}catch{i&&Pe("error")}})(),()=>{i=!1}},[d,k,Y,h,v,B]),a.useEffect(()=>{if(he(""),H(null),ot(null),tt(0),je([]),Xe({}),K({}),le(null),qe(null),ge(null),Ee(!1),Ge(!1),We(null),X(null),$({}),!oe){Se(null),Ae(null),Ve(null),st(null);return}oe.cardType==="info"&&oe.infoType==="computed"&&Se(t.cogita.library.revision.loadingComputed);let i=!0;return ba(oe,fe).then(u=>{!i||!u||(Se(u.prompt),Ae(u.expectedAnswer),je(u.computedExpected),Xe(u.computedAnswers),Ve(u.computedValues),le(u.answerTemplate),qe(u.outputVariables),ge(u.variableValues))}),()=>{i=!1}},[oe,t]),a.useEffect(()=>{if(!oe||oe.cardType!=="info"||oe.infoType!=="quote"){Fe.current=null,et.current=new Set,Be(null);return}const i=oe.description??"",u=(oe.label??"").trim(),w=u.replace(/\s+/g," ").trim(),f=i.replace(/\s+/g," ").trim(),P=w&&w!==f?u:t.cogita.library.infoTypes.quote;if(!i){Be(null),Ae(null);return}const p=ma(i);Fe.current=p,Se(P);let A=!0;return na().then(({fragmentKnowness:M})=>{if(!A)return;const F=getQuoteMode(oe.direction),J=new Set,Z={};M.forEach((Te,Ie)=>{const[De,Oe]=Ie.split(":",2);if(De!==oe.cardId)return;const dt=Nt(Oe);if(!dt||dt.mode!==F)return;const ta=dt.fragmentId;Z[ta]=Te,Te>=nt&&J.add(ta)}),et.current=J,at.current=Z;const ce=Nt(oe.direction);if(ce!=null&&ce.fragmentId&&p.nodes[ce.fragmentId]){_t(p,ce.fragmentId,P);return}const ne=ha(p,J,Z,nt,rt,oe.direction);_t(p,(ne==null?void 0:ne.id)??null,P)}).catch(()=>{et.current=new Set,at.current={};const M=Nt(oe.direction);if(M!=null&&M.fragmentId&&p.nodes[M.fragmentId]){_t(p,M.fragmentId,P);return}const F=ha(p,et.current,{},nt,rt,oe.direction);_t(p,(F==null?void 0:F.id)??null,P)}),()=>{A=!1}},[oe,t,rt,nt]),a.useEffect(()=>{if(!oe||oe.cardType!=="vocab"||oe.checkType!=="translation-match"){X(null),$({});return}const w=(ct.pool??ct.active??S).filter(M=>M.cardType==="vocab"&&M.checkType==="translation-match").filter((M,F,J)=>J.findIndex(Z=>Z.cardId===M.cardId)===F);w.some(M=>M.cardId===oe.cardId)||w.unshift(oe);const P=Rt(w).slice(0,6).map(M=>{const F=M.label.split("↔").map(ce=>ce.trim()).filter(Boolean);if(F.length<2)return null;const J=`${M.cardId}:L`,Z=`${M.cardId}:R`;return{cardId:M.cardId,leftId:J,rightId:Z,leftLabel:F[0],rightLabel:F[1]}}).filter(Boolean),p=P.map(M=>M.leftId),A=Rt(P.map(M=>M.rightId));X({pairs:P,leftOrder:p,rightOrder:A,selection:{},activeLeft:null,activeRight:null,locked:{}})},[oe,S,ct]),a.useEffect(()=>()=>{be.current&&window.clearTimeout(be.current),$e.current&&window.clearTimeout($e.current)},[]);const Xt=a.useRef(null);a.useEffect(()=>{if(!oe)return;const i=ie(oe),u=typeof document<"u"?document.activeElement:null;if(Xt.current===i&&u&&(u.tagName==="INPUT"||u.tagName==="TEXTAREA"))return;let w=0;const f=()=>{if(oe){if(oe.cardType==="info"&&oe.infoType==="computed"){if(_e.length>0){const p=Ka(Ce,_e,Le),A=p?Ft.current[p]:null;if(A&&(A.focus(),document.activeElement===A)){Xt.current=i;return}}if(lt.current&&(lt.current.focus(),document.activeElement===lt.current)){Xt.current=i;return}}else if(oe.cardType==="vocab"&&lt.current&&(lt.current.focus(),document.activeElement===lt.current)){Xt.current=i;return}w<6&&(w+=1,window.setTimeout(f,40))}},P=window.setTimeout(f,40);return()=>window.clearTimeout(P)},[oe,_e,Ce,Le]),a.useEffect(()=>{if(!bt)return;const i=u=>{u.key==="Enter"&&(u.preventDefault(),ca())};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[bt]);const Jt=i=>{Je(i),st(qt(i))};a.useEffect(()=>{if(!oe){st(null),Je([]);return}const i=oe.cardType==="info"?"info":"connection";if(oe.cardType==="info"&&oe.infoType==="quote"){Dt().then(u=>{const w=u.filter(f=>f.itemType==="info"&&f.itemId===oe.cardId&&f.checkType==="quote-fragment"&&Ba(f.direction,oe.direction));Jt(w)}).catch(()=>{st(null),Je([])});return}Fa(i,oe.cardId,oe.checkType,oe.direction).then(u=>Jt(u)).catch(()=>{st(null),Je([])})},[d,oe,B]);const Na=(i,u,w,f)=>{if(i==="info"&&w==="quote-fragment"){Dt().then(P=>{const p=P.filter(A=>A.itemType==="info"&&A.itemId===u&&A.checkType==="quote-fragment"&&Ba(A.direction,f));Jt(p)}).catch(()=>{st(null),Je([])});return}Fa(i,u,w,f).then(P=>Jt(P)).catch(()=>{st(null),Je([])})},Ta=(i,u,w)=>{var A;const f=((A=w.pairs.find(M=>M.leftId===i))==null?void 0:A.rightId)??null;if(!f)return w;const P=f===u;$(M=>({...M,[i]:P?"correct":"incorrect"})),be.current&&window.clearTimeout(be.current),$e.current&&window.clearTimeout($e.current),O.current+=1;const p={kind:P?"correct":"incorrect",tick:O.current};if(Me(null),be.current=window.setTimeout(()=>Me(p),0),$e.current=window.setTimeout(()=>Me(null),420),P){const M={...w.locked,[i]:!0};return Object.keys(M).length>=w.pairs.length?(H("correct"),Ge(!0)):H("correct"),{...w,selection:{...w.selection,[i]:u},activeLeft:null,activeRight:null,locked:M}}return H("incorrect"),{...w,activeLeft:null,activeRight:null}},la=i=>{X(u=>!u||u.locked[i]?u:u.activeRight?Ta(i,u.activeRight,u):{...u,activeLeft:u.activeLeft===i?null:i})},At=i=>{X(u=>u&&(u.activeLeft?Ta(u.activeLeft,i,u):{...u,activeRight:u.activeRight===i?null:i}))},ca=()=>{var i;if(oe&&oe.cardType==="info"&&oe.infoType==="quote"&&Fe.current&&we&&!((i=Nt(oe.direction))!=null&&i.fragmentId)){const u=ha(Fe.current,et.current,at.current,nt,rt,oe.direction,we.fragmentId);if(u){H(null),he(""),Ee(!1),K({}),Ge(!1),ot(null),tt(0),_t(Fe.current,u.id,we.title);return}}H(null),he(""),Ee(!1),K({}),Ge(!1),ot(null),tt(0),x(u=>Math.min(u+1,S.length))},It=i=>{if(!oe)return;const u=i.expected??null,w=i.answer??"";let f=u??"",P=w;if(!u&&i.expectedMap&&i.answerMap){const ce=Object.keys(i.expectedMap).sort((ne,Te)=>ne.localeCompare(Te));f=ce.map(ne=>{var Te;return((Te=i.expectedMap)==null?void 0:Te[ne])??""}).join("|"),P=ce.map(ne=>{var Te;return((Te=i.answerMap)==null?void 0:Te[ne])??""}).join("|")}const p=f?ga(f,P,pt):new Uint8Array,A={revisionType:v.id,evalType:i.evalType,direction:i.direction,prompt:ke??"",expected:u,answer:w,expectedAnswers:i.expectedMap??null,answers:i.answerMap??null,correct:i.correct,maskBase64:p.length?Ht(p):null,values:Q??null,checkMode:re,compareMode:pt,minCorrectness:it},M=new TextEncoder().encode(JSON.stringify(A)),F=oe.cardType==="info"?"info":"connection",J=i.overrideCheckType??oe.checkType??null,Z=i.overrideDirection??oe.direction??null;Aa({itemType:F,itemId:oe.cardId,checkType:J,direction:Z,revisionType:v.id,evalType:i.evalType,correct:i.correct,maskBase64:p.length?Ht(p):null,payloadBase64:Ht(M),personRoleId:B??null}).then(()=>{Na(F,oe.cardId,J,Z),ia(S),as(d,B)}).catch(()=>{})},Zt=(i,u)=>{const w=ft.current.get(u);if(w)return Promise.resolve(w);const f=kt.current.get(u);if(f)return f;const P=ua({libraryId:d,infoId:i}).then(p=>{var ce,ne;const A=p.payload,M=((ce=A.definition)==null?void 0:ce.graph)??null,F="",J=((ne=A.definition)==null?void 0:ne.answerTemplate)??"",Z=Js(M,F,J);if(Z){const Ie={sample:Zs(Z),answerTemplate:J||null};return ft.current.set(u,Ie),Ie}return ys({libraryId:d,infoId:i}).then(Te=>{const Ie={sample:Te,answerTemplate:null};return ft.current.set(u,Ie),Ie})}).catch(()=>ys({libraryId:d,infoId:i}).then(p=>{const A={sample:p,answerTemplate:null};return ft.current.set(u,A),A}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{kt.current.delete(u)});return kt.current.set(u,P),P},ba=(i,u)=>{var M;const w=`${ie(i)}:${u}`,f=Ut.current.get(w);if(f)return Promise.resolve(f);const P=Vt.current.get(w);if(P)return P;const p=F=>(Ut.current.set(w,F),F);let A;if(i.cardType==="vocab"){if(i.checkType==="translation-match")return A=Promise.resolve(p({prompt:i.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),A;const F=i.label.split("↔").map(J=>J.trim()).filter(Boolean);if(F.length>=2){const Z=(i.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",ce=Z?F[0]:F[1],ne=Z?F[1]:F[0];A=Promise.resolve(p({prompt:ce,expectedAnswer:ne,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else A=Promise.resolve(p({prompt:i.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(i.cardType==="info"&&i.infoType==="word"){const F=(M=i.description)!=null&&M.startsWith("Language: ")?i.description.replace("Language: ",""):null;A=Promise.resolve(p({prompt:i.label,expectedAnswer:F,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else i.cardType==="info"&&i.infoType==="computed"?A=Zt(i.cardId,w).then(F=>{var Te,Ie;if(!F.sample)return p({prompt:i.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const J=F.sample,Z=J.expectedAnswers?Object.entries(J.expectedAnswers).map(([De,Oe])=>({key:De,expected:Oe})):[],ce=Z.reduce((De,Oe)=>(De[Oe.key]="",De),{}),ne=J.expectedAnswerIsSentence&&((Te=J.expectedAnswer)==null?void 0:Te.trim())||null;return p({prompt:J.prompt,expectedAnswer:Z.length>0?ne:((Ie=J.expectedAnswer)==null?void 0:Ie.trim())||null,computedExpected:Z,computedAnswers:ce,computedValues:J.values??null,answerTemplate:F.answerTemplate,outputVariables:J.outputVariables??null,variableValues:J.variableValues??null})}).catch(()=>p({prompt:i.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Vt.current.delete(w)}):A=Promise.resolve(p({prompt:i.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return Vt.current.set(w,A),A},_t=(i,u,w)=>{const f=Object.keys(i.nodes).length,P=et.current.size;if(!u){Be({title:w,before:i.text,after:"",fragmentId:null,total:f,completed:P}),Ae(null),Ge(!0);return}const p=i.nodes[u];if(!p)return;const A=Qs(i.text,p);Be({title:w,before:A.before,after:A.after,fragmentId:p.id,total:f,completed:P}),Ae(A.fragment),Ge(!1)},Sa=()=>{const i=Fe.current;i&&Be(u=>u&&{...u,total:Object.keys(i.nodes).length,completed:et.current.size})},da=()=>{const i=S[fe+1];i&&ba(i,fe+1)},Ca=()=>{if(da(),oe&&oe.cardType==="vocab"&&oe.checkType==="translation-match"&&I){if(I.pairs.length===0){H("incorrect"),Ge(!0);return}const p=I.pairs.reduce((ne,Te)=>(ne[Te.rightId]=Te.rightLabel,ne),{});let A=0;const M={};I.pairs.forEach(ne=>{const Ie=I.selection[ne.leftId]===ne.rightId;M[ne.leftId]=Ie?"correct":"incorrect",Ie&&(A+=1)});const F=I.pairs.length||1,J=A/F,Z=A===I.pairs.length;$(ne=>({...ne,...M})),Z?(H("correct"),Ge(!0),tt(0)):(H("incorrect"),Ge(!1),tt(ne=>{const Te=ne+1;return Te>=Ct&&(Ee(!0),Ge(!0),X(Ie=>{if(!Ie)return Ie;const De=Ie.pairs.reduce((Oe,dt)=>(Oe[dt.leftId]=dt.rightId,Oe),{});return{...Ie,selection:De}})),Te})),vt(Z,J);const ce="connection";Promise.all(I.pairs.map(ne=>{const Te=I.selection[ne.leftId]??null,Ie=Te?p[Te]:"",De={left:ne.leftLabel,expected:ne.rightLabel,answer:Ie,checkType:"translation-match"},Oe=new TextEncoder().encode(JSON.stringify(De));return Aa({itemType:ce,itemId:ne.cardId,checkType:"translation-match",direction:null,revisionType:v.id,evalType:"translation-match",correct:Te===ne.rightId,maskBase64:null,payloadBase64:Ht(Oe),personRoleId:B??null})})).then(()=>{Na(ce,oe.cardId,oe.checkType,oe.direction),as(d,B)}).catch(()=>{});return}if(_e.length>0){const p=_e.reduce((M,F)=>{const J=Ke[F.key]??"";return M[F.key]=wt(J)===wt(F.expected)?"correct":"incorrect",M},{});_e.every(({key:M,expected:F})=>{const J=Ke[M]??"";return re==="exact"&&wt(J)===wt(F)})?(H("correct"),K(p),Ge(!0),tt(0),vt(!0,1),It({correct:!0,direction:ke?`${ke} -> computed`:"computed",expectedMap:_e.reduce((M,F)=>(M[F.key]=F.expected,M),{}),answerMap:Ke,evalType:"computed"})):(H("incorrect"),K(p),Ge(!1),tt(M=>{const F=M+1;return F>=Ct&&D&&(Ee(!0),Ge(!0)),F}),vt(!1,0),window.setTimeout(()=>{var F;const M=Ka(Ce,_e,Le);M&&Ft.current[M]&&((F=Ft.current[M])==null||F.focus())},40),It({correct:!1,direction:ke?`${ke} -> computed`:"computed",expectedMap:_e.reduce((M,F)=>(M[F.key]=F.expected,M),{}),answerMap:Ke,evalType:"computed"}));return}if(oe&&oe.cardType==="info"&&oe.infoType==="quote"&&(we!=null&&we.fragmentId)){if(!ve)return;const p=Nt(oe.direction),A=(p==null?void 0:p.mode)??getQuoteMode(oe.direction),M=p!=null&&p.fragmentId&&oe.direction?oe.direction:ja(A,we.fragmentId),F=nn(ve,V,pt),J=re==="exact"&&fa(V)===fa(ve),Z=Wt(F),ce=J||Z,ne=Gt(F);ce?(at.current[we.fragmentId]=Math.max(at.current[we.fragmentId]??0,ne),(at.current[we.fragmentId]??0)>=nt&&et.current.add(we.fragmentId),Sa(),H("correct"),K({}),Ge(!0),ot(F),tt(0),ne<100&&Ct<=1&&Ee(!0),vt(!0,ne/100),It({correct:!0,direction:`quote:${we.fragmentId}`,expected:ve,answer:V,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:M})):(H("incorrect"),K({}),Ge(!1),ot(F),tt(Te=>{const Ie=Te+1;return Ie>=Ct&&D&&(Ee(!0),Ge(!0)),Ie}),vt(!1,ne/100),window.setTimeout(()=>{var Te;return(Te=lt.current)==null?void 0:Te.focus()},40),It({correct:!1,direction:`quote:${we.fragmentId}`,expected:ve,answer:V,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:M}));return}if(!ve)return;const i=ga(ve,V,pt),u=re==="exact"&&wt(V)===wt(ve),w=Wt(i),f=u||w,P=Gt(i);f?(H("correct"),K({}),Ge(!0),ot(i),tt(0),P<100&&Ct<=1&&Ee(!0),vt(!0,P/100),It({correct:!0,direction:ke?`${ke} -> ${ve}`:null,expected:ve,answer:V,evalType:"text"})):(H("incorrect"),K({}),Ge(!1),ot(i),tt(p=>{const A=p+1;return A>=Ct&&D&&(Ee(!0),Ge(!0)),A}),vt(!1,P/100),window.setTimeout(()=>{var p;return(p=lt.current)==null?void 0:p.focus()},40),It({correct:!1,direction:ke?`${ke} -> ${ve}`:null,expected:ve,answer:V,evalType:"text"}))},Ha=i=>{if(da(),!ve)return;const u=ga(ve,i,pt),w=wt(i)===wt(ve),f=Wt(u),P=w||f,p=Gt(u);P?(H("correct"),K({}),Ge(!0),ot(u),tt(0),p<100&&Ct<=1&&Ee(!0),vt(!0,p/100),It({correct:!0,direction:"word->language",expected:ve,answer:i,evalType:"language-select"})):(H("incorrect"),K({}),Ge(!1),ot(u),tt(A=>{const M=A+1;return M>=Ct&&D&&(Ee(!0),Ge(!0)),M}),vt(!1,p/100),It({correct:!1,direction:"word->language",expected:ve,answer:i,evalType:"language-select"}))},Qa=()=>{da(),H("correct"),Ge(!0),tt(0),vt(!0,1),ve&&It({correct:!0,direction:"manual",expected:ve,answer:V,evalType:"manual"})},Ya=()=>{if(vt(!1,0),oe&&oe.cardType==="info"&&oe.infoType==="quote"){H(null),he(""),Ee(!1),K({}),Ge(!1),ot(null),tt(0),x(i=>Math.min(i+1,S.length));return}ca()};a.useEffect(()=>{da()},[fe,S]);const ea=i=>{var w;if(i.key!=="Enter")return;if(i.preventDefault(),i.stopPropagation(),bt){ca();return}const u=_e.find(f=>!(Ke[f.key]??"").trim());if(u){(w=Ft.current[u.key])==null||w.focus();return}Ca()},T=t.cogita.library.revision.revealModeAfterIncorrect,D=_e.length>0||!!ve;return e.jsxs(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,children:[ae==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${ue.total?Math.min(100,Math.max(0,ue.current/ue.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:ue.total?`${Math.min(ue.current,ue.total)} / ${ue.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:L}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",g).replace("{check}",z)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:U,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${U}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${U}/collections/${k}`,children:t.cogita.library.actions.collectionDetail})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Ne?`${Ne.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Et?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Et.currentLevel??"-"," / ",Et.levelsCount]}):null,Ne?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(Ne.correct)).replace("{total}",String(Ne.total))}),Ne.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(Ne.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(tn,{outcomes:He})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[mt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:mt})}):null,e.jsx("section",{className:"cogita-revision-card","data-feedback":pe?`${pe.kind}-${pe.tick}`:se?"idle":_??"idle",children:oe?e.jsx(e.Fragment,{children:ye?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(en,{copy:t,currentCard:oe,currentTypeLabel:Qt,prompt:ke,languages:ee,answer:V,onAnswerChange:i=>he(u=>_a(u,i,ze)),computedExpected:_e,computedAnswers:Ke,onComputedAnswerChange:(i,u)=>Xe(w=>({...w,[i]:_a(w[i]??"",u,ze)})),answerTemplate:Ce,outputVariables:Le,variableValues:q,computedFieldFeedback:Qe,feedback:_,canAdvance:bt,quoteContext:we,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Ca,onSkip:Ya,onLanguageSelect:Ha,onMarkReviewed:Qa,onAdvance:ca,showCorrectAnswer:Re,setShowCorrectAnswer:Ee,onRevealCorrect:()=>Ge(!0),answerMask:ht,expectedAnswer:ve,hasExpectedAnswer:D,handleComputedKeyDown:ea,answerInputRef:lt,computedInputRefs:Ft,scriptMode:ze,setScriptMode:We,matchPairs:I==null?void 0:I.pairs,matchLeftOrder:I==null?void 0:I.leftOrder,matchRightOrder:I==null?void 0:I.rightOrder,matchSelection:I==null?void 0:I.selection,matchActiveLeft:I==null?void 0:I.activeLeft,matchActiveRight:I==null?void 0:I.activeRight,matchFeedback:xe,onMatchLeftSelect:la,onMatchRightSelect:At})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${U}/collections/${k}`,children:t.cogita.library.actions.collectionDetail})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:zt?`${$t} / ${zt}`:t.cogita.library.revision.progressUnlimited}),ae==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),ae==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),ae==="ready"&&S.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:T}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",Ct]})]})]}),Et?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Et.activeCount," / ",Et.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Et.counts.map((i,u)=>{const w=u+1,f=Et.currentLevel===w,P=Et.percentages[u]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":f,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:w}),e.jsx("strong",{children:i})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,P))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[P.toFixed(1),"%"]})]},`level-${w}`)})})]}):null,xt?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:xt.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:xt.dots.map(i=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,i.value*100))}%`,background:`rgba(${Math.round(255*(1-i.value))}, ${Math.round(200*i.value)}, 80, 0.9)`}},i.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:xt.knownCount})]})]}):null,rt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:oa})]})}):null]})]})]})})})]})]})}const ss=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],$i={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},Ri=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Ei=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function Ai({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,libraryId:d,collectionId:k}){const[c,o]=a.useState(""),[U,de,Y]=Rs([]),[W,v,h]=Es([]),[re,B]=a.useState(null),[g,z]=a.useState(null),[L,G]=a.useState(null),S=`/#/cogita/library/${d}`;a.useEffect(()=>{qa(d,k).then(C=>o(C.name)).catch(()=>o(t.cogita.library.collections.defaultName))},[d,k,t]),a.useEffect(()=>{Tn({libraryId:d,collectionId:k}).then(C=>{if(!C.graphId||C.graphId==="00000000-0000-0000-0000-000000000000"){de([]),v([]);return}const fe=C.nodes.map(V=>{var ke;const he=V.payload??{},_=he.position??{x:120,y:120},H=he.params??{};return{id:V.nodeId,type:"default",position:_,data:{nodeType:V.nodeType,label:((ke=ss.find(Se=>Se.type===V.nodeType))==null?void 0:ke.label)??V.nodeType,params:H}}}),x=C.edges.map(V=>({id:V.edgeId,source:V.fromNodeId,target:V.toNodeId,sourceHandle:V.fromPort??void 0,targetHandle:V.toPort??void 0}));de(fe),v(x)}).catch(()=>{de([]),v([])})},[d,k,v,de]);const R=a.useMemo(()=>U.find(C=>C.id===re)??null,[U,re]),ee=C=>{var he;const fe=crypto.randomUUID(),x=((he=ss.find(_=>_.type===C))==null?void 0:he.label)??C,V={...$i[C]};de(_=>[..._,{id:fe,type:"default",position:{x:120+_.length*40,y:120+_.length*40},data:{nodeType:C,label:x,params:V}}]),B(fe)},te=a.useCallback(C=>{v(fe=>As({...C,id:crypto.randomUUID()},fe))},[v]),ae=async()=>{z(null);try{await Cn({libraryId:d,collectionId:k,nodes:U.map(C=>({nodeId:C.id,nodeType:C.data.nodeType,payload:{position:C.position,params:C.data.params}})),edges:W.map(C=>({edgeId:C.id,fromNodeId:C.source,fromPort:C.sourceHandle??null,toNodeId:C.target,toPort:C.targetHandle??null}))}),z(t.cogita.library.graph.saveSuccess)}catch{z(t.cogita.library.graph.saveFail)}},Pe=async()=>{try{const C=await Sn({libraryId:d,collectionId:k});G(C)}catch{G(null)}},ue=C=>{R&&de(fe=>fe.map(x=>x.id===R.id?{...x,data:{...x.data,params:C}}:x))};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${S}/collections/${k}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Pe,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:ae,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:ss.map(C=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>ee(C.type),children:C.label},C.type))}),g?e.jsx("p",{className:"cogita-help",children:g}):null,L&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(L.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(L.connections)).replace("{infos}",String(L.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(Fs,{nodes:U,edges:W,onNodesChange:Y,onEdgesChange:h,onConnect:te,onNodeClick:(C,fe)=>B(fe.id),fitView:!0,children:[e.jsx(Ps,{color:"rgba(120,160,200,0.2)"}),e.jsx(Bs,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),R?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:R.data.label}),R.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(sa,{libraryId:d,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:R.data.params.tagId?{id:R.data.params.tagId,label:R.data.params.tagLabel??"",infoType:"topic"}:null,onChange:C=>ue({...R.data.params,tagId:(C==null?void 0:C.id)??null,tagLabel:(C==null?void 0:C.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:R.data.params.scope??"any",onChange:C=>ue({...R.data.params,scope:C.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),R.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(sa,{libraryId:d,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:R.data.params.languageId?{id:R.data.params.languageId,label:R.data.params.languageLabel??"",infoType:"language"}:null,onChange:C=>ue({...R.data.params,languageId:(C==null?void 0:C.id)??null,languageLabel:(C==null?void 0:C.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:R.data.params.scope??"any",onChange:C=>ue({...R.data.params,scope:C.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),R.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:R.data.params.infoType??"word",onChange:C=>ue({...R.data.params,infoType:C.target.value}),children:Ei.map(C=>e.jsx("option",{value:C.value,children:C.label},C.value))})]}),e.jsx(sa,{libraryId:d,infoType:R.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:R.data.params.infoId?{id:R.data.params.infoId,label:R.data.params.infoLabel??"",infoType:R.data.params.infoType??"word"}:null,onChange:C=>ue({...R.data.params,infoId:(C==null?void 0:C.id)??null,infoLabel:(C==null?void 0:C.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),R.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:R.data.params.connectionType??"translation",onChange:C=>ue({...R.data.params,connectionType:C.target.value}),children:Ri.map(C=>e.jsx("option",{value:C.value,children:C.label},C.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:R.data.params.connectionId??"",onChange:C=>ue({...R.data.params,connectionId:C.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(R.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const ns="cogita.preferences",on=["library_overview","all_cards","all_collections","storyboards","texts","dependencies","transfer"],is={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},rs=["settings","run","shared"];function Fi(t,s=""){const n=t.split("/").filter(Boolean);if(n[0]!=="cogita"||n[1]!=="library")return{};const r=n[2];if(!r)return{};if(!n[3])return{libraryId:r,target:"library_overview"};const l=new URLSearchParams(s),m=l.get("revisionId")??void 0,b=l.get("infoId")??void 0,y=l.get("infoView")==="cards"?"cards":"overview",E=l.get("collectionAction"),j=l.get("libraryAction");if(n[3]==="list")return{libraryId:r,target:j==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:m,infoId:b,infoView:y,libraryAction:j==="new-info"?"new-info":void 0};if(n[3]==="detail"||n[3]==="collection")return{libraryId:r,target:"all_cards",cardMode:n[3],revisionId:m,infoId:b,infoView:y};if(n[3]==="new"||n[3]==="add")return{libraryId:r,target:"new_card",revisionId:m,libraryAction:"new-info"};if(n[3]==="edit")return{libraryId:r,target:"new_card",revisionId:m,infoId:n[4]};if(n[3]==="shared-revisions")return{libraryId:r,target:"all_collections",revisionId:m};if(n[3]==="dependencies")return{libraryId:r,target:"dependencies"};if(n[3]==="transfer")return{libraryId:r,target:"transfer"};if(n[3]==="storyboards")return n[4]==="new"?{libraryId:r,target:"new_storyboard"}:{libraryId:r,target:"storyboards"};if(n[3]==="texts")return n[4]==="new"?{libraryId:r,target:"new_text"}:{libraryId:r,target:"texts"};if(n[3]!=="collections")return{libraryId:r,target:"library_overview"};if(n[4]==="new")return{libraryId:r,target:"new_collection",revisionId:m};const d=n[4];return d?n[5]==="graph"?{libraryId:r,target:"all_collections",collectionId:d,revisionId:m,revisionView:"graph"}:n[5]==="shared-revisions"?{libraryId:r,target:"all_collections",collectionId:d,revisionId:m,revisionView:"shared"}:n[5]==="revision"?{libraryId:r,target:"all_collections",collectionId:d,revisionId:m,revisionView:n[6]==="run"?"run":"settings"}:E==="new-revision"?{libraryId:r,target:"all_collections",collectionId:d,revisionId:m,revisionView:"new"}:{libraryId:r,target:"all_collections",collectionId:d,revisionId:m,revisionView:"detail"}:E==="new-collection"?{libraryId:r,target:"new_collection",collectionAction:"new-collection"}:{libraryId:r,target:"all_collections"}}function os(t,s="library_overview",n,r,l,m,b="overview"){const y=(E,j)=>{const d=new URLSearchParams;j!=null&&j.revisionId&&d.set("revisionId",j.revisionId),j!=null&&j.collectionAction&&d.set("collectionAction",j.collectionAction),j!=null&&j.libraryAction&&d.set("libraryAction",j.libraryAction),j!=null&&j.infoId&&d.set("infoId",j.infoId),j!=null&&j.infoView&&(j!=null&&j.infoId)&&d.set("infoView",j.infoView);const k=d.toString();return k?`${E}?${k}`:E};return t?s==="library_overview"?y(`/cogita/library/${t}`,{revisionId:l}):s==="all_cards"?y(`/cogita/library/${t}/list`,{revisionId:l,infoId:m,infoView:b}):s==="new_card"?m?y(`/cogita/library/${t}/edit/${m}`,{revisionId:l}):y(`/cogita/library/${t}/list`,{revisionId:l,libraryAction:"new-info"}):s==="all_collections"?n?r==="graph"?y(`/cogita/library/${t}/collections/${n}/graph`,{revisionId:l}):r==="settings"?y(`/cogita/library/${t}/collections/${n}/revision`,{revisionId:l}):r==="run"?y(`/cogita/library/${t}/collections/${n}/revision/run`,{revisionId:l}):r==="shared"?y(`/cogita/library/${t}/collections/${n}/shared-revisions`,{revisionId:l}):r==="new"?y(`/cogita/library/${t}/collections/${n}`,{revisionId:l,collectionAction:"new-revision"}):y(`/cogita/library/${t}/collections/${n}`,{revisionId:l}):y(`/cogita/library/${t}/collections`,{revisionId:l}):s==="new_collection"?y(`/cogita/library/${t}/collections`,{revisionId:l,collectionAction:"new-collection"}):s==="transfer"?y(`/cogita/library/${t}/transfer`,{revisionId:l}):s==="storyboards"?y(`/cogita/library/${t}/storyboards`,{revisionId:l}):s==="new_storyboard"?y(`/cogita/library/${t}/storyboards/new`,{revisionId:l}):s==="texts"?y(`/cogita/library/${t}/texts`,{revisionId:l}):s==="new_text"?y(`/cogita/library/${t}/texts/new`,{revisionId:l}):s==="dependencies"?y(`/cogita/library/${t}/dependencies`,{revisionId:l}):y(`/cogita/library/${t}`,{revisionId:l}):"/cogita"}function Ia(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function Pi(t){return typeof t=="string"&&on.includes(t)}function Bi(t,s){var y;if(!t.length)return null;const n=t.filter(E=>s.has(E.roleId)),r=n.length>0?n:t,l=r.map(E=>{var d,k;const j=((k=(d=E.fields.find(c=>c.fieldType==="role_kind"))==null?void 0:d.plainValue)==null?void 0:k.toLowerCase())??"";return{roleId:E.roleId,roleKind:j}}),m=l.find(E=>E.roleKind.includes("master"));if(m)return m.roleId;const b=l.find(E=>E.roleKind.includes("account")||E.roleKind.includes("user"));return b?b.roleId:((y=r[0])==null?void 0:y.roleId)??null}function _i(t){if(!t)return{version:1,byLibrary:{}};try{const s=JSON.parse(t);return!s||typeof s!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:s.lastLibraryId,byLibrary:s.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function Ki({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j}){const d=$s(),k=ds(),c=a.useMemo(()=>Fi(k.pathname,k.search),[k.pathname,k.search]),o=t.cogita.workspace,[U,de]=a.useState([]),[Y,W]=a.useState([]),[v,h]=a.useState([]),[re,B]=a.useState([]),[g,z]=a.useState(void 0),[L,G]=a.useState("library_overview"),[S,R]=a.useState(void 0),[ee,te]=a.useState(void 0),[ae,Pe]=a.useState("detail"),[ue,C]=a.useState(void 0),[fe,x]=a.useState(!1),[V,he]=a.useState(!0),[_,H]=a.useState(!1),[ke,Se]=a.useState(!1),[ve,Ae]=a.useState(null),[we,Be]=a.useState(0),[_e,je]=a.useState(""),[Ke,Xe]=a.useState(""),[Qe,K]=a.useState(""),[Q,Ve]=a.useState(null),[Ce,le]=a.useState(null),Le=a.useRef({version:1,byLibrary:{}}),qe=a.useRef(!1),q=a.useRef(!1),ge=a.useRef(null),I=a.useMemo(()=>U.find(N=>N.libraryId===g)??null,[U,g]),X=a.useMemo(()=>Y.find(N=>N.collectionId===S)??null,[Y,S]),xe=a.useMemo(()=>re.find(N=>N.revisionId===ee)??null,[re,ee]),$=a.useMemo(()=>({detail:o.revisions.detail,graph:o.revisions.graph,settings:o.revisions.settings,run:o.revisions.run,shared:o.targets.sharedRevisions,new:o.revisionForm.createAction}),[o.revisions.detail,o.revisions.graph,o.revisions.run,o.revisions.settings,o.targets.sharedRevisions,o.revisionForm.createAction]),O=a.useMemo(()=>[{value:"detail",label:$.detail},{value:"graph",label:$.graph},{value:"settings",label:o.targets.allRevisions},{value:"run",label:$.run},{value:"shared",label:$.shared}],[$.detail,$.graph,$.run,$.shared,o.targets.allRevisions]),pe=a.useMemo(()=>L==="new_card"?"all_cards":L==="new_collection"?"all_collections":L==="new_storyboard"?"storyboards":L==="new_text"?"texts":L,[L]),Me=a.useMemo(()=>ae==="new"?"settings":ae,[ae]),be=a.useMemo(()=>c.infoId?"selected":L==="new_card"?"create":"search",[c.infoId,L]),$e=a.useMemo(()=>v.find(N=>N.infoId===c.infoId)??null,[v,c.infoId]),ze=a.useMemo(()=>({library_overview:o.targets.libraryOverview,all_cards:o.targets.allCards,new_card:o.targets.newCard,all_collections:o.targets.allCollections,new_collection:o.targets.newCollection,transfer:o.targets.transfer,storyboards:o.targets.storyboards,new_storyboard:o.targets.newStoryboard,texts:o.targets.texts,new_text:o.targets.newText,dependencies:o.targets.dependencies}),[o.targets]),We=a.useMemo(()=>ze[pe]??pe,[pe,ze]),Re=$[Me],Ee=!!g,Ne=a.useMemo(()=>E==="pl"?[{title:"Witamy w Cogita",body:"To miejsce pracy z bibliotekami, kolekcjami, powtórkami i informacjami."},{title:"1. Biblioteka",body:"Najpierw tworzysz bibliotekę. To główny kontener dla całej wiedzy."},{title:"2. Informacje",body:"Informacje są podstawowymi elementami. Każdy typ ma własną strukturę."},{title:"3. Typy informacji",body:"Możesz dodawać słowa, osoby, źródła, cytaty i inne typy opisane w specyfikacji."},{title:"4. Linki",body:"Informacje łączysz linkami, np. tematy i referencje, także między różnymi typami."},{title:"5. Kolekcje",body:"Kolekcja grupuje wybrane informacje do konkretnego celu nauki."},{title:"6. Powtórki",body:"Dla kolekcji tworzysz powtórki z własnymi ustawieniami i trybem sprawdzania."},{title:"7. Karty",body:"Karty to widok sprawdzania informacji. Informacja i karta to nie to samo."},{title:"8. Graf zależności",body:"Graf pokazuje relacje i wpływ jednych elementów na drugie."},{title:"9. Storyboardy",body:"Storyboardy służą do szkicowania przebiegu i kontekstu nauki."},{title:"10. Teksty",body:"Moduł tekstów łączy notatki z biblioteką jako materiał roboczy."},{title:"11. Udostępnianie",body:"Biblioteki i powtórki możesz udostępniać do odczytu bez pełnej edycji."},{title:"12. Nawigacja",body:"Breadcrumb pokazuje aktualną ścieżkę, a sidebar pokazuje akcje dla poziomu."},{title:"13. Zacznij teraz",body:"Utwórz pierwszą bibliotekę. Pozostałe działania odblokują się automatycznie."}]:E==="de"?[{title:"Willkommen bei Cogita",body:"Dies ist der Arbeitsbereich für Bibliotheken, Sammlungen, Wiederholungen und Informationen."},{title:"1. Bibliothek",body:"Zuerst erstellst du eine Bibliothek. Sie ist der Hauptcontainer für dein Wissen."},{title:"2. Informationen",body:"Informationen sind die Basiseinheiten. Jeder Typ hat eine eigene Struktur."},{title:"3. Informationstypen",body:"Du kannst Wörter, Personen, Quellen, Zitate und weitere Typen anlegen."},{title:"4. Verknüpfungen",body:"Informationen werden verlinkt, z. B. mit Themen und Referenzen."},{title:"5. Sammlungen",body:"Eine Sammlung bündelt ausgewählte Informationen für ein Lernziel."},{title:"6. Wiederholungen",body:"Für eine Sammlung erstellst du Wiederholungen mit eigenen Einstellungen."},{title:"7. Karten",body:"Karten sind die Prüfansicht. Information und Karte sind unterschiedlich."},{title:"8. Abhängigkeitsgraph",body:"Der Graph zeigt Beziehungen und Abhängigkeiten zwischen Elementen."},{title:"9. Storyboards",body:"Storyboards helfen beim Entwurf von Lernablauf und Kontext."},{title:"10. Texte",body:"Das Textmodul verbindet Notizen direkt mit der Bibliothek."},{title:"11. Teilen",body:"Bibliotheken und Wiederholungen können schreibgeschützt geteilt werden."},{title:"12. Navigation",body:"Breadcrumb zeigt den Pfad, die Sidebar zeigt Aktionen pro Ebene."},{title:"13. Jetzt starten",body:"Erstelle deine erste Bibliothek. Weitere Aktionen werden danach verfügbar."}]:[{title:"Welcome to Cogita",body:"This workspace organizes libraries, collections, revisions, and information."},{title:"1. Library first",body:"Start by creating a library. It is the root container for your knowledge."},{title:"2. Information model",body:"Information entries are the core units. Each type has its own structure."},{title:"3. Type-driven forms",body:"Create and edit screens are generated from type specifications."},{title:"4. Links between infos",body:"Link fields connect info entries, including references and topics."},{title:"5. Collections",body:"Collections gather selected info entries for a specific learning goal."},{title:"6. Revisions",body:"Revisions belong to collections and define how review sessions run."},{title:"7. Cards vs info",body:"A card is a checking view of an info, not the info object itself."},{title:"8. Dependency graph",body:"Graphs show dependencies and relation flow across your knowledge."},{title:"9. Storyboards",body:"Storyboards support visual planning and structured learning context."},{title:"10. Text workspace",body:"Texts module keeps writing and notes connected to the same library."},{title:"11. Sharing",body:"Libraries can be shared for reading while keeping personal checks private."},{title:"12. Navigation logic",body:"Breadcrumb shows current path, sidebar shows actions for current level."},{title:"13. Next step",body:"Create your first library now. Everything else unlocks from there."}],[E]),st=Ne.length,He=Math.max(0,Math.min(we,st-1)),Je=Ne[He],mt=!!S,jt=Ee&&L==="all_collections",Ye=mt&&L==="all_collections",Ze=mt&&L==="all_collections"&&rs.includes(ae),ht=a.useCallback(N=>{const ye=!!N.libraryId;let me=N.target,Fe=N.collectionId,et=N.revisionId,at=N.revisionView,oe=N.infoId,se=N.infoView??c.infoView??"overview";ye?is[me].requiresCollection&&!Fe?(me="all_collections",et=void 0,at="detail"):me!=="all_collections"?(Fe=void 0,et=void 0,me!=="new_card"&&me!=="all_cards"&&(oe=void 0,se="overview")):is[me].allowsRevision?rs.includes(at)||(et=void 0):at="detail":(me="library_overview",Fe=void 0,et=void 0,at="detail",oe=void 0,se="overview"),z(N.libraryId),G(me),R(Fe),te(et),Pe(at),x(!1);const ft=Ia(os(N.libraryId,me,Fe,at,et,oe,se));Ia(`${k.pathname}${k.search}`)!==ft&&(ge.current=ft,d(ft))},[k.pathname,k.search,d,c.infoView]),ot=N=>{ht({libraryId:g,target:"all_collections",collectionId:S,revisionId:rs.includes(N)?ee:void 0,revisionView:N})},Lt=a.useMemo(()=>[{key:"library",label:o.layers.library,visible:!0,value:g??"",selectedLabel:(I==null?void 0:I.name)??o.path.noLibrarySelected,disabled:V||U.length===0,options:U.map(N=>({value:N.libraryId,label:N.name})),emptyOption:o.noLibraryOption,onSelect:N=>{const ye=N||void 0;ht({libraryId:ye,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:o.layers.target,visible:Ee,value:pe,selectedLabel:We,disabled:!Ee,options:on.map(N=>({value:N,label:ze[N]})),onSelect:N=>{const ye=N;ht({libraryId:g,target:ye,collectionId:S,revisionId:ee,revisionView:ae,infoId:ye==="new_card"?c.infoId:void 0})}},{key:"info_mode",label:o.layers.target,visible:pe==="all_cards",value:be,selectedLabel:be==="create"?o.infoMode.create:be==="selected"?($e==null?void 0:$e.label)??ue??t.cogita.library.list.selectedEmpty:o.infoMode.search,disabled:!Ee,options:[{value:"search",label:o.infoMode.search},{value:"create",label:o.infoMode.create},...c.infoId?[{value:"selected",label:($e==null?void 0:$e.label)??ue??t.cogita.library.list.selectedEmpty}]:[]],onSelect:N=>{if(N!=="selected"){if(N==="create"){ht({libraryId:g,target:"new_card",collectionId:S,revisionId:ee,revisionView:ae,infoId:void 0});return}ht({libraryId:g,target:"all_cards",collectionId:S,revisionId:ee,revisionView:ae,infoId:void 0,infoView:"overview"})}}},{key:"info_selected_action",label:o.layers.target,visible:pe==="all_cards"&&!!c.infoId,value:L==="new_card"&&c.infoId?"edit":c.infoView==="cards"?"cards":"overview",selectedLabel:L==="new_card"&&c.infoId?o.infoActions.edit:c.infoView==="cards"?o.infoActions.seeCards:o.infoActions.overview,disabled:!Ee||!c.infoId,options:[{value:"overview",label:o.infoActions.overview},{value:"edit",label:o.infoActions.edit},{value:"cards",label:o.infoActions.seeCards}],onSelect:N=>{if(c.infoId){if(N==="edit"){ht({libraryId:g,target:"new_card",collectionId:S,revisionId:ee,revisionView:ae,infoId:c.infoId});return}if(N==="cards"){ht({libraryId:g,target:"all_cards",collectionId:S,revisionId:ee,revisionView:ae,infoId:c.infoId,infoView:"cards"});return}ht({libraryId:g,target:"all_cards",collectionId:S,revisionId:ee,revisionView:ae,infoId:c.infoId,infoView:"overview"})}}},{key:"collection",label:o.layers.collection,visible:jt,value:S??"",selectedLabel:(X==null?void 0:X.name)??o.path.noCollectionSelected,disabled:!Ee||_||Y.length===0,options:Y.map(N=>({value:N.collectionId,label:N.name})),emptyOption:o.selectCollectionOption,onSelect:N=>{ht({libraryId:g,target:"all_collections",collectionId:N||void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection_action",label:o.layers.revision,visible:Ye,value:Me,selectedLabel:Re,disabled:!S,options:O.map(N=>({value:N.value,label:N.label})),onSelect:N=>{ot(N)}},{key:"revision_entry",label:o.layers.revision,visible:Ze,value:ee??"",selectedLabel:(xe==null?void 0:xe.name)??o.status.noRevisions,disabled:!mt||ke||re.length===0,options:re.map(N=>({value:N.revisionId,label:N.name})),emptyOption:o.status.noRevisions,onSelect:N=>{ht({libraryId:g,target:"all_collections",collectionId:S,revisionId:N||void 0,revisionView:ae})}}],[O,Y,_,be,v,U,V,ht,re,ke,X,S,$e,xe,ee,ue,mt,Ee,I,g,Re,ae,L,Me,pe,We,jt,Ye,Ze,ze,t.cogita.library.list.selectedEmpty,c.infoId,c.infoView,o.infoActions.edit,o.infoActions.overview,o.infoActions.seeCards,o.layers.collection,o.layers.library,o.layers.revision,o.layers.target,o.noLibraryOption,o.path.noCollectionSelected,o.path.noLibrarySelected,o.selectCollectionOption]),tt=a.useMemo(()=>Lt.filter(N=>N.visible),[Lt]),lt=a.useMemo(()=>tt.filter(N=>N.key!=="library"&&N.key!=="collection"&&N.key!=="revision_entry"),[tt]),Ft=a.useMemo(()=>lt.find(N=>N.key==="target")??null,[lt]),bt=a.useMemo(()=>lt.find(N=>N.key==="info_mode")??null,[lt]),Ge=a.useMemo(()=>lt.find(N=>N.key==="info_selected_action")??null,[lt]),ct=a.useMemo(()=>lt.find(N=>N.key==="collection_action")??null,[lt]),St=a.useCallback((N,ye)=>N?e.jsx("div",{className:"cogita-sidebar-actions",children:N.options.map(me=>e.jsx("button",{type:"button",className:`ghost ${String(N.value)===me.value?"active":""}`,onClick:()=>N.onSelect(me.value),disabled:N.disabled,children:me.label},`${ye}:${N.key}:${me.value}`))}):null,[]),Pt=a.useMemo(()=>{const N=c.libraryId;if(!N||!k.pathname.startsWith("/cogita/library/"))return null;const ye={copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,libraryId:N};if(c.target==="library_overview")return e.jsx(Wn,{...ye});if(c.target==="all_cards")return e.jsx(Zn,{...ye,mode:c.cardMode??"list"});if(c.target==="new_card")return e.jsx(ti,{...ye,editInfoId:c.infoId});if(c.target==="dependencies")return e.jsx(si,{...ye});if(c.target==="transfer")return e.jsx(ii,{...ye});if(c.target==="storyboards"||c.target==="new_storyboard")return e.jsx(ri,{...ye});if(c.target==="texts"||c.target==="new_text")return e.jsx(oi,{...ye});if(c.target==="all_collections"){if(c.collectionId){const me={...ye,collectionId:c.collectionId};return c.revisionView==="graph"?e.jsx(Ai,{...me}):c.revisionView==="shared"?e.jsx(ni,{...ye,collectionId:c.collectionId}):c.revisionView==="settings"?e.jsx(bi,{...me,revisionId:c.revisionId}):c.revisionView==="run"?e.jsx(Li,{...me,revisionId:c.revisionId}):e.jsx(li,{...me})}return e.jsx(Is,{...ye})}return c.target==="new_collection"?e.jsx(Is,{...ye}):null},[s,t,E,k.pathname,d,j,m,y,r,l,c.cardMode,c.collectionId,c.infoId,c.libraryId,c.revisionId,c.revisionView,c.target,b,n]);a.useEffect(()=>{let N=!1;return(async()=>{var me,Fe,et,at,oe,se,ft;he(!0);try{await Mn();const[kt,Ut,Vt]=await Promise.all([qs(),In(),Ln()]);if(N)return;de(kt);const Qt=new Set(Vt.nodes.filter(it=>it.nodeType==="role"&&it.canLink).map(it=>it.roleId??"")),Yt=Bi(Ut,Qt);if(Ve(Yt),Yt){const it=Vt.nodes.find(rt=>rt.nodeType==="data"&&rt.roleId===Yt&&(rt.fieldType===ns||rt.label===ns));le((it==null?void 0:it.dataKeyId)??null),Le.current=_i(it==null?void 0:it.value)}const zt=Le.current.lastLibraryId,$t=((me=kt.find(it=>it.libraryId===c.libraryId))==null?void 0:me.libraryId)??(kt.length===1?kt[0].libraryId:void 0)??((Fe=kt.find(it=>it.libraryId===zt))==null?void 0:Fe.libraryId)??((et=kt[0])==null?void 0:et.libraryId),Ct=$t?(oe=(at=Le.current.byLibrary)==null?void 0:at[$t])==null?void 0:oe.lastTarget:void 0,pt=Pi(Ct)?Ct:"library_overview";z($t),G(c.target??pt),te(c.revisionId??($t?(ft=(se=Le.current.byLibrary)==null?void 0:se[$t])==null?void 0:ft.lastRevisionId:void 0)),Pe(c.revisionView??"detail"),qe.current=!0}catch{N||Ae(o.status.loadFailed)}finally{N||he(!1)}})(),()=>{N=!0}},[o.status.loadFailed]),a.useLayoutEffect(()=>{qe.current&&(c.libraryId&&U.some(N=>N.libraryId===c.libraryId)&&z(c.libraryId),c.target&&G(c.target),R(c.collectionId),te(c.revisionId),c.revisionView&&Pe(c.revisionView))},[U,c.collectionId,c.libraryId,c.revisionId,c.revisionView,c.target]),a.useEffect(()=>{if(!g){W([]),R(void 0),h([]),B([]),te(void 0);return}let N=!1;return H(!0),va({libraryId:g,limit:200}).then(ye=>{var et;if(N)return;const me=ye.items;W(me);const Fe=(et=me.find(at=>at.collectionId===c.collectionId))==null?void 0:et.collectionId;R(Fe)}).catch(()=>{N||(W([]),R(void 0))}).finally(()=>{N||H(!1)}),()=>{N=!0}},[c.collectionId,g]),a.useEffect(()=>{if(!g||pe!=="all_cards"&&L!=="new_card"){h([]);return}let N=!1;return us({libraryId:g,limit:200}).then(ye=>{N||h(ye)}).catch(()=>{N||h([])}),()=>{N=!0}},[pe,g,L]),a.useEffect(()=>{if(!g||!S){B([]),te(void 0);return}let N=!1;return Se(!0),Ds({libraryId:g,collectionId:S}).then(ye=>{var et,at,oe,se;if(N)return;B(ye);const me=(at=(et=Le.current.byLibrary)==null?void 0:et[g])==null?void 0:at.lastRevisionId,Fe=((oe=ye.find(ft=>ft.revisionId===c.revisionId))==null?void 0:oe.revisionId)??((se=ye.find(ft=>ft.revisionId===me))==null?void 0:se.revisionId);te(Fe)}).catch(()=>{N||(B([]),te(void 0))}).finally(()=>{N||Se(!1)}),()=>{N=!0}},[c.revisionId,S,g]),a.useEffect(()=>{const N=c.infoId;if(!g||!N){C(void 0);return}let ye=!1;return ua({libraryId:g,infoId:N}).then(me=>{if(ye)return;const Fe=me.payload;C((Fe==null?void 0:Fe.label)??(Fe==null?void 0:Fe.name)??(Fe==null?void 0:Fe.title)??me.infoId)}).catch(()=>{ye||C(N)}),()=>{ye=!0}},[c.infoId,g]),a.useEffect(()=>{if(!qe.current||c.libraryId&&U.some(me=>me.libraryId===c.libraryId)&&c.libraryId!==g||c.target&&c.target!==L||c.revisionView&&c.revisionView!==ae||c.revisionId&&c.revisionId!==ee||is[L].requiresCollection&&!S&&c.target==="all_collections"&&c.collectionId)return;const N=Ia(`${k.pathname}${k.search}`),ye=Ia(os(g,L,S,ae,ee,c.infoId,c.infoView??"overview"));if(N===ye){ge.current=null;return}ge.current!==ye&&(ge.current=ye,d(ye,{replace:!0}))},[U,k.pathname,k.search,d,c.collectionId,c.infoId,c.infoView,c.libraryId,c.revisionId,c.revisionView,c.target,S,g,ee,ae,L]),a.useEffect(()=>{if(typeof window>"u")return;const N=()=>{window.innerWidth>920&&x(!1)};return window.addEventListener("resize",N),()=>window.removeEventListener("resize",N)},[]),a.useEffect(()=>{if(!qe.current||!Q||!g||q.current)return;const N=Le.current,ye={...N.byLibrary??{}},me={...ye[g]??{},lastCollectionId:S,lastRevisionId:ee,lastRevisionView:ae,lastTarget:L},Fe={version:1,lastLibraryId:g,byLibrary:{...ye,[g]:me}},et=JSON.stringify(N),at=JSON.stringify(Fe);if(et===at)return;Le.current=Fe,q.current=!0,(async()=>{try{if(Ce)await $n(Ce,{plainValue:at});else{const se=await Rn(Q,{itemName:ns,itemType:"data",plainValue:at});le(se.dataItemId)}}catch{Ae(o.status.savePrefsFailed)}finally{q.current=!1}})()},[Ce,Q,S,g,ee,ae,L,o.status.savePrefsFailed]);const Bt=async()=>{const N=_e.trim();if(!N){Ae(t.cogita.user.libraryNameRequired);return}Ae(null);try{const ye=await Fn({name:N});de(me=>[ye,...me]),z(ye.libraryId),G("library_overview"),R(void 0),je("")}catch{Ae(t.cogita.user.libraryCreateFailed)}},gt=async()=>{if(!g){Ae(o.status.selectLibraryFirst);return}const N=Ke.trim();if(!N){Ae(t.cogita.library.collections.saveRequiredName);return}Ae(null);try{const ye=await En({libraryId:g,name:N,items:[]}),me=await va({libraryId:g,limit:200});W(me.items),R(ye.collectionId),te(void 0),G("all_collections"),Pe("detail"),Xe("")}catch{Ae(t.cogita.library.collections.saveFail)}},yt=async()=>{if(!g||!S){Ae(o.status.selectLibraryFirst);return}const N=Qe.trim();if(!N){Ae(o.revisionForm.nameLabel);return}Ae(null);try{const ye=await An({libraryId:g,collectionId:S,name:N,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});B(me=>[ye,...me]),te(ye.revisionId),G("all_collections"),Pe("settings"),K("")}catch{Ae(o.status.loadFailed)}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${fe?"open":""}`,"aria-label":o.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{children:(I==null?void 0:I.name)??o.path.noLibrarySelected}),e.jsx("p",{className:"cogita-sidebar-note",children:I?o.sidebar.libraryActionsHint:o.status.selectLibraryFirst}),St(Ft,"sidebar")]}),bt?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:o.sidebar.infoActionsHint}),St(bt,"sidebar"),Ge?e.jsxs("div",{className:"cogita-sidebar-actions-nested",children:[e.jsx("p",{className:"cogita-sidebar-note",children:($e==null?void 0:$e.label)??ue??t.cogita.library.list.selectedEmpty}),e.jsx("p",{className:"cogita-sidebar-note",children:o.sidebar.selectedInfoActionsHint}),St(Ge,"sidebar")]}):null]}):null,X?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:X.name}),e.jsx("p",{className:"cogita-sidebar-note",children:o.sidebar.collectionActionsHint}),St(ct,"sidebar")]}):null,e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:o.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:r,children:o.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{y("cogita"),x(!1)},children:o.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:l,children:b?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),fe?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":o.sidebar.closeMenu,onClick:()=>x(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":o.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>x(N=>!N),"aria-label":fe?o.sidebar.closeMenu:o.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),tt.map((N,ye)=>e.jsxs("div",{className:"cogita-browser-segment",children:[ye>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,N.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":N.label,children:N.selectedLabel}):e.jsxs("select",{"aria-label":N.label,value:N.value,onChange:me=>N.onSelect(me.target.value),disabled:N.disabled,children:[N.emptyOption?e.jsx("option",{value:"",children:N.emptyOption}):null,N.options.map(me=>e.jsx("option",{value:me.value,children:me.label},`${N.key}:${me.value}`))]})]},`menu:${N.key}`))]}),Pt?e.jsxs(e.Fragment,{children:[L==="new_collection"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.library.actions.createCollection}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{type:"text",value:Ke,onChange:N=>Xe(N.target.value),placeholder:t.cogita.library.collections.namePlaceholder,disabled:!g})]}),e.jsx("button",{type:"button",className:"cta",onClick:gt,disabled:!g,children:t.cogita.library.actions.createCollection}),ve?e.jsx("p",{className:"cogita-form-error",children:ve}):null]}):null,L==="all_collections"&&S&&ae==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:o.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Qe,onChange:N=>K(N.target.value),placeholder:o.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:yt,children:o.revisionForm.createAction}),ve?e.jsx("p",{className:"cogita-form-error",children:ve}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Ws.Provider,{value:!0,children:Pt})})]}):null,Pt?null:e.jsxs(e.Fragment,{children:[g?null:e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsx("h2",{children:Je.title}),e.jsxs("p",{children:[He+1," / ",st]})]}),e.jsx("p",{className:"cogita-browser-note",children:Je.body}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:Ne.map((N,ye)=>e.jsx("button",{type:"button",className:`ghost ${ye===He?"active":""}`,onClick:()=>Be(ye),"aria-label":`${ye+1}`,children:ye+1},`tutorial:${N.title}:${ye}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:He===0,onClick:()=>Be(N=>Math.max(0,N-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:He===st-1,onClick:()=>Be(N=>Math.min(st-1,N+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:_e,onChange:N=>je(N.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Bt,children:t.cogita.user.createLibraryAction}),ve?e.jsx("p",{className:"cogita-form-error",children:ve}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),U.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,U.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:U.map(N=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{z(N.libraryId),G("library_overview"),R(void 0),te(void 0),Pe("detail")},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:N.name})]},N.libraryId))}):null]})]})]}),g?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-browser-layout",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:o.panels.currentPosition}),e.jsxs("p",{className:"cogita-browser-path",children:[tt.map((N,ye)=>e.jsxs("span",{children:[ye>0?e.jsx("span",{children:" / "}):null,e.jsx("strong",{children:N.selectedLabel})]},`path:${N.key}`)),jt?null:e.jsxs("span",{children:[e.jsx("span",{children:" / "}),e.jsx("strong",{children:o.path.noCollectionLayer})]})]}),e.jsxs("p",{className:"cogita-browser-note",children:[o.path.currentRoute," ",e.jsx("code",{children:os(g,L,S,ae,ee,c.infoId,c.infoView??"overview")})]}),g?e.jsxs("div",{className:"cogita-browser-links",children:[e.jsx("a",{className:"ghost",href:`/#/cogita/library/${g}`,children:o.links.libraryOverview}),e.jsx("a",{className:"ghost",href:`/#/cogita/library/${g}/list`,children:o.links.allCards}),S?e.jsx("a",{className:"ghost",href:`/#/cogita/library/${g}/collections/${S}/shared-revisions`,children:o.links.sharedRevisions}):null]}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:o.panels.quickCreate}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:_e,onChange:N=>je(N.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Bt,children:t.cogita.user.createLibraryAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{type:"text",value:Ke,onChange:N=>Xe(N.target.value),placeholder:t.cogita.library.collections.namePlaceholder,disabled:!g})]}),e.jsx("button",{type:"button",className:"cta",onClick:gt,disabled:!g,children:t.cogita.library.actions.createCollection}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Qe,onChange:N=>K(N.target.value),placeholder:o.revisionForm.namePlaceholder,disabled:!S})]}),e.jsx("button",{type:"button",className:"cta",onClick:yt,disabled:!S,children:o.revisionForm.createAction}),ve?e.jsx("p",{className:"cogita-form-error",children:ve}):null]})]}),e.jsxs("section",{className:"cogita-browser-collections",children:[e.jsx("h2",{children:o.panels.collections}),_?e.jsx("p",{className:"cogita-library-subtitle",children:o.status.loadingCollections}):null,!_&&Y.length===0?e.jsx("p",{className:"cogita-library-subtitle",children:o.status.noCollections}):null,Y.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:Y.map(N=>e.jsxs("button",{type:"button",className:`cogita-card-item ${N.collectionId===S?"active":""}`,onClick:()=>{R(N.collectionId),te(void 0),Pe("detail")},children:[e.jsx("div",{className:"cogita-card-type",children:o.cards.collectionType}),e.jsx("h3",{className:"cogita-card-title",children:N.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[N.itemCount," ",o.cards.itemsSuffix]})]},N.collectionId))}):null]})]}):null]})]})]})})}const zi=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:Ki},Symbol.toStringTag,{value:"Module"}));function qi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,shareId:d}){const[k,c]=a.useState(null),[o,U]=a.useState("loading"),[de,Y]=a.useState(t.cogita.library.collections.defaultName),[W,v]=a.useState("Cogita Library"),[h,re]=a.useState([]),[B,g]=a.useState([]),[z,L]=a.useState("idle"),[G,S]=a.useState({current:0,total:0}),[R,ee]=a.useState(0),[te,ae]=a.useState(""),[Pe,ue]=a.useState(null),[C,fe]=a.useState(null),[x,V]=a.useState(null),[he,_]=a.useState(null),[H,ke]=a.useState([]),[Se,ve]=a.useState({}),[Ae,we]=a.useState({}),[Be,_e]=a.useState(null),[je,Ke]=a.useState(null),[Xe,Qe]=a.useState(null),[K,Q]=a.useState(null),[Ve,Ce]=a.useState({}),le=a.useRef(0),[Le,qe]=a.useState(null),q=a.useRef(null),ge=a.useRef(null),[I,X]=a.useState(null),[xe,$]=a.useState(!1),[O,pe]=a.useState(null),[Me,be]=a.useState([]),[$e,ze]=a.useState(null),We=a.useRef(null),Re=a.useRef(null),[Ee,Ne]=a.useState(null),[st,He]=a.useState(0),Je=a.useRef(null),mt=a.useRef({}),[jt,Ye]=a.useState(!1),[Ze,ht]=a.useState({}),ot=a.useRef(null),Lt=a.useRef(new Set),tt=a.useRef({}),[lt,Ft]=a.useState([]),[bt,Ge]=a.useState(new Set),[ct,St]=a.useState(!1),Pt=ds(),Bt=a.useMemo(()=>new URLSearchParams(Pt.search),[Pt.search]),gt=a.useMemo(()=>Bt.get("key")??"",[Bt]),yt=(k==null?void 0:k.mode)??"random",N=(k==null?void 0:k.check)??"exact",ye=(k==null?void 0:k.limit)??20,me=a.useMemo(()=>fs((k==null?void 0:k.revisionType)??yt),[k,yt]),Fe=a.useMemo(()=>{const T=k==null?void 0:k.revisionSettings,D=Xs(me,Bt);return Oa(me,T??D)},[k,Bt,me]),et=a.useMemo(()=>t.cogita.library.revision[me.labelKey]??yt,[t,yt,me]),at=a.useMemo(()=>N==="exact"?t.cogita.library.revision.checkValue:N,[t,N]),se=o==="ready"?h[R]??null:null,ft=(se==null?void 0:se.checkType)==="translation-match"&&K,kt=a.useRef(new Map),Ut=a.useRef(new Map),Vt=a.useRef(new Map),Qt=a.useRef(new Map),Yt=a.useMemo(()=>se?se.cardType==="vocab"?t.cogita.library.revision.vocabLabel:se.infoType?Ue(t,se.infoType):t.cogita.library.revision.infoLabel:"",[t,se]),zt=a.useMemo(()=>{var D;return me.id!=="levels"?h.length:((D=Ze.pool)==null?void 0:D.length)??me.getFetchLimit(ye,Fe)},[Ze,Fe,me,h.length,ye]),$t=me.getProgressTotal?me.getProgressTotal(h,Ze,ye,Fe):me.id==="levels"?Math.min(ye,zt):h.length,Ct=$t?Math.min(R+1,$t):0,pt=Math.max(1,Number(Fe.tries??1)),it=Fe.compare??"anchors",rt=Math.max(0,Math.min(100,Number(Fe.minCorrectness??0))),nt=(Fe.considerDependencies??"on")==="on",Rt=Math.max(0,Math.min(100,Number(Fe.dependencyThreshold??85))),Gt=T=>{const D=T.slice();for(let i=D.length-1;i>0;i-=1){const u=Math.floor(Math.random()*(i+1));[D[i],D[u]]=[D[u],D[i]]}return D},Wt=T=>T.length?T.reduce((i,u)=>i+u,0)/T.length/255*100:0,na=T=>Wt(T)>=rt,Ua=async()=>{const T=await Dt(),D=new Map,i=new Map;T.forEach(f=>{const P=`${f.itemType}:${f.itemId}`,p=Kt(f.itemType,f.itemId,f.checkType,f.direction);D.has(P)||D.set(P,[]),D.get(P).push(f),i.has(p)||i.set(p,[]),i.get(p).push(f)});const u=new Map,w=new Map;return D.forEach((f,P)=>u.set(P,qt(f).score)),i.forEach((f,P)=>w.set(P,qt(f).score)),{itemKnowness:u,cardKnowness:w}},pa=async T=>{const D=Ze,i=T.concat(D.active??[]).concat(D.pool??[]).filter((F,J,Z)=>Z.findIndex(ce=>ie(ce)===ie(F))===J);if(!nt){Ge(new Set(i.map(ie)));return}const{itemKnowness:u,cardKnowness:w}=await Ua(),f=F=>{if(F.cardType!=="info"||F.infoType!=="quote"||F.checkType!=="quote-fragment")return!0;const J=Nt(F.direction);if(!(J!=null&&J.fragmentId))return!0;const Z=F.description??"";if(!Z.trim())return!0;const ne=ma(Z).nodes[J.fragmentId];if(!ne||!ne.leftId&&!ne.rightId)return!0;const Te=[ne.leftId,ne.rightId].filter(Oe=>!!Oe);if(Te.length===0)return!0;const Ie=Te.map(Oe=>{const dt=Kt("info",F.cardId,"quote-fragment",ja(J.mode,Oe));return w.get(dt)??0});return Ie.reduce((Oe,dt)=>Oe+dt,0)/Ie.length>=Rt},P=(k==null?void 0:k.collectionId)??null,p=P?lt.filter(F=>ut(F.childItemType)==="collection"&&F.childItemId===P&&!ut(F.childCheckType)&&!ut(F.childDirection)):[],A=P&&i.length>0?i.reduce((F,J)=>F+(w.get(ie(J))??0),0)/i.length:0,M=new Set;for(const F of i){if(F.cardType!=="info"){M.add(ie(F));continue}if(!f(F))continue;const J=lt.filter(ne=>rn(ne,F)).concat(p);if(J.length===0){M.add(ie(F));continue}let Z=0;for(const ne of J)if(ut(ne.parentItemType)==="collection")Z+=ne.parentItemId===P?A:0;else if(ut(ne.parentCheckType)||ut(ne.parentDirection)){const Te=ut(ne.parentCheckType),Ie=ut(ne.parentDirection),De=Kt(ne.parentItemType,ne.parentItemId,Te,Ie);Z+=w.get(De)??0}else{const Te=`${ne.parentItemType}:${ne.parentItemId}`;Z+=u.get(Te)??0}Z/J.length>=Rt&&M.add(ie(F))}Ge(M)},za=T=>{for(let D=T;D<h.length;D+=1){const i=h[D];if(i&&(!nt||i.cardType!=="info"||bt.has(ie(i))))return D}return-1},ia=T=>!nt||T.cardType!=="info"||bt.has(ie(T)),Wa=T=>{if(me.id!=="temporal"&&me.id!=="levels")return null;const D=Ze,i=(D.active??[]).concat(D.pool??[]),u=new Set;for(const w of i){const f=ie(w);if(!(u.has(f)||T.has(f))&&(u.add(f),ia(w)))return w}return null},Mt=a.useMemo(()=>{if(me.id!=="levels")return null;const T=Ze,D=T.pool??[],i=T.active??[],u=T.levelMap??{},w=Math.max(1,Number(Fe.levels??1)),f=Array.from({length:w},()=>0),P=new Set(i.map(F=>ie(F)));D.forEach(F=>{const J=Math.min(w,Math.max(1,u[ie(F)]??1));f[J-1]+=1});const p=D.length||1,A=f.map(F=>F/p*100),M=se?u[ie(se)]??1:null;return{counts:f,percentages:A,currentLevel:M,levelsCount:w,activeCount:i.length,poolCount:D.length,activeSet:P}},[Ze,Fe,me,se]),ra=a.useMemo(()=>{if(me.id!=="temporal")return null;const T=Ze,D=T.pool??[],i=T.active??[],u=T.knownessMap??{},w=new Set(T.unknownSet??[]);let f=0;D.forEach(A=>{(u[ie(A)]??0)>1&&(f+=1)});const P=w.size,p=i.map(A=>({id:ie(A),value:w.has(ie(A))?0:Math.max(0,Math.min(1,u[ie(A)]??0))}));return{knownCount:f,unknownCount:P,dots:p}},[Ze,me]),Et=a.useMemo(()=>{if(!nt)return 0;const T=Ze;return h.concat(T.active??[]).concat(T.pool??[]).filter((i,u,w)=>w.findIndex(f=>ie(f)===ie(i))===u).filter(i=>i.cardType==="info"&&!bt.has(ie(i))).length},[nt,Ze,h,bt]);a.useEffect(()=>{if(!nt||z!=="ready")return;const T=Ze,i=h.concat(T.active??[]).concat(T.pool??[]).filter((f,P,p)=>p.findIndex(A=>ie(A)===ie(f))===P).filter(f=>f.cardType!=="info"||bt.has(ie(f))).length,u=We.current;if(We.current=i,u===null||i<=u)return;const w=i-u;ze(`New card available (+${w})`),Re.current&&window.clearTimeout(Re.current),Re.current=window.setTimeout(()=>ze(null),2200)},[nt,z,Ze,h,bt]),a.useEffect(()=>()=>{Re.current&&window.clearTimeout(Re.current)},[]);const xt=(T,D)=>{const i=me.applyOutcome({queue:h,meta:Ze},se,ye,Fe,{correct:T,correctness:D,createdUtc:new Date().toISOString()});re(i.queue),ht(i.meta);const u=i.queue[R+1];u&&It(u,R+1)};a.useEffect(()=>{if(!d){U("error");return}U("loading"),Pn({shareId:d,key:gt}).then(T=>{c(T),Y(T.collectionName),v(T.libraryName),U("ready")}).catch(()=>{U("error")})},[d,gt]),a.useEffect(()=>{d&&Bn({shareId:d,key:gt,type:"language"}).then(T=>g(T)).catch(()=>g([]))},[d,gt]),a.useEffect(()=>{!d||o!=="ready"||_n({shareId:d,key:gt}).then(T=>Ft(T.items??[])).catch(()=>Ft([]))},[d,gt,o]),a.useEffect(()=>{if(!d||o!=="ready")return;let T=!0;return(async()=>{L("loading"),S({current:0,total:me.id==="levels"?0:me.getFetchLimit(ye,Fe)});try{const i=[];let u=null,w=null;do{const J=await Kn({shareId:d,key:gt,limit:300,cursor:u});if(i.push(...J.items),(me.id==="levels"||me.id==="temporal")&&J.total&&(w=J.total),S(Z=>({current:i.length,total:Z.total||J.total||me.getFetchLimit(ye,Fe)})),u=J.nextCursor??null,w!==null&&i.length>=w||me.id!=="levels"&&me.id!=="temporal"&&i.length>=me.getFetchLimit(ye,Fe))break}while(u);if(!T)return;const f=cs(i);let P;if(me.id==="levels"){const J=Math.max(1,Number(Fe.levels??1));P={},f.forEach(Z=>{const ce=ie(Z);P[ce]=Math.max(1,Math.min(J,1))})}let p=null,A=null,M=null;if(me.id==="temporal"){const J=await Dt(),Z=new Set(f.map(Te=>ie(Te))),ce=J.reduce((Te,Ie)=>{const De=Kt(Ie.itemType,Ie.itemId,Ie.checkType,Ie.direction);return Z.has(De)&&(Te[De]||(Te[De]=[]),Te[De].push(Ie)),Te},{});p={},A=new Set,M={};const ne=Date.now();f.forEach(Te=>{const Ie=ie(Te),De=ce[Ie]??[];if(De.length===0){p[Ie]=0,A.add(Ie),M[Ie]=[];return}const Oe=hs(De);M[Ie]=Oe;const dt=Da(Oe,ne);p[Ie]=dt.knowness})}const F=me.id==="levels"?ms(f,ye,Fe,P):me.id==="temporal"?gs(f,ye,Fe,p??{},A??new Set,M??{}):me.prepare(f,ye,Fe);re(F.queue),ht(F.meta),ee(0),L("ready"),S(J=>({current:Math.min(J.current,J.total),total:J.total}))}catch{T&&L("error")}})(),()=>{T=!1}},[d,gt,ye,me,Fe,o]),a.useEffect(()=>{pa(h)},[h,lt,nt,Rt,k==null?void 0:k.collectionId]),a.useEffect(()=>{if(!se||!nt){St(!1);return}if(se.cardType!=="info"||bt.has(ie(se))){St(!1);return}const T=za(R+1);if(T>=0){St(!1),ee(T);return}if(me.id==="temporal"||me.id==="levels"){const D=h.slice(0,R+1),i=h.slice(R+1).filter(ia),u=D.concat(i),w=new Set(u.map(ie)),f=Wa(w);if(f){const p=ie(f);w.has(p)||(u.push(f),w.add(p),ht(A=>{const M=A,F=new Set(M.queued??[]);return F.add(p),{...M,queued:F}}))}const P=u.findIndex((p,A)=>A!==R&&ia(p));if(P>=0){re(u),ee(P),St(!1);return}}St(!0)},[se,bt,nt,R,h,Ze,me.id]),a.useEffect(()=>{if(ae(""),ue(null),Ne(null),He(0),ke([]),ve({}),we({}),_e(null),Ke(null),Qe(null),$(!1),Ye(!1),X(null),Q(null),Ce({}),!se){fe(null),V(null);return}se.cardType==="info"&&se.infoType==="computed"&&fe(t.cogita.library.revision.loadingComputed);let T=!0;return It(se,R).then(D=>{!T||!D||(fe(D.prompt),V(D.expectedAnswer),ke(D.computedExpected),ve(D.computedAnswers),_e(D.answerTemplate),Ke(D.outputVariables),Qe(D.variableValues))}),()=>{T=!1}},[se,d,t]),a.useEffect(()=>{if(!se||se.cardType!=="info"||se.infoType!=="quote"){ot.current=null,Lt.current=new Set,_(null);return}const T=se.description??"",D=(se.label??"").trim(),i=D.replace(/\s+/g," ").trim(),u=T.replace(/\s+/g," ").trim(),w=i&&i!==u?D:t.cogita.library.infoTypes.quote;if(!T){_(null),V(null);return}const f=ma(T);ot.current=f,fe(w);let P=!0;return Dt().then(p=>{if(!P)return;const A=getQuoteMode(se.direction),M=new Map;p.forEach(ne=>{if(ne.itemType!=="info"||ne.checkType!=="quote-fragment"||!ne.direction)return;const Te=Nt(ne.direction);if(!Te||Te.mode!==A)return;const Ie=`${ne.itemId}:${Te.fragmentId}`;M.has(Ie)||M.set(Ie,[]),M.get(Ie).push(ne)});const F={},J=new Set;M.forEach((ne,Te)=>{const[Ie,De]=Te.split(":",2);if(Ie!==se.cardId)return;const Oe=qt(ne).score;F[De]=Oe,Oe>=Rt&&J.add(De)}),Lt.current=J,tt.current=F;const Z=Nt(se.direction);if(Z!=null&&Z.fragmentId&&f.nodes[Z.fragmentId]){Zt(f,Z.fragmentId,w);return}const ce=ha(f,J,F,Rt,nt,se.direction);Zt(f,(ce==null?void 0:ce.id)??null,w)}).catch(()=>{Lt.current=new Set,tt.current={};const p=Nt(se.direction);if(p!=null&&p.fragmentId&&f.nodes[p.fragmentId]){Zt(f,p.fragmentId,w);return}const A=ha(f,Lt.current,{},Rt,nt,se.direction);Zt(f,(A==null?void 0:A.id)??null,w)}),()=>{P=!1}},[se,t,nt,Rt]),a.useEffect(()=>{if(!se||se.cardType!=="vocab"||se.checkType!=="translation-match"){Q(null),Ce({});return}const i=(Ze.pool??Ze.active??h).filter(p=>p.cardType==="vocab"&&p.checkType==="translation-match").filter((p,A,M)=>M.findIndex(F=>F.cardId===p.cardId)===A);i.some(p=>p.cardId===se.cardId)||i.unshift(se);const w=Gt(i).slice(0,6).map(p=>{const A=p.label.split("↔").map(J=>J.trim()).filter(Boolean);if(A.length<2)return null;const M=`${p.cardId}:L`,F=`${p.cardId}:R`;return{cardId:p.cardId,leftId:M,rightId:F,leftLabel:A[0],rightLabel:A[1]}}).filter(Boolean),f=w.map(p=>p.leftId),P=Gt(w.map(p=>p.rightId));Q({pairs:w,leftOrder:f,rightOrder:P,selection:{},activeLeft:null,activeRight:null,locked:{}})},[se,h,Ze]),a.useEffect(()=>()=>{q.current&&window.clearTimeout(q.current),ge.current&&window.clearTimeout(ge.current)},[]);const oa=a.useRef(null);a.useEffect(()=>{if(!se)return;const T=ie(se),D=typeof document<"u"?document.activeElement:null;if(oa.current===T&&D&&(D.tagName==="INPUT"||D.tagName==="TEXTAREA"))return;let i=0;const u=()=>{if(se){if(se.cardType==="info"&&se.infoType==="computed"){if(H.length>0){const f=Ka(Be,H,je),P=f?mt.current[f]:null;if(P&&(P.focus(),document.activeElement===P)){oa.current=T;return}}if(Je.current&&(Je.current.focus(),document.activeElement===Je.current)){oa.current=T;return}}else if(se.cardType==="vocab"&&Je.current&&(Je.current.focus(),document.activeElement===Je.current)){oa.current=T;return}i<6&&(i+=1,window.setTimeout(u,40))}},w=window.setTimeout(u,40);return()=>window.clearTimeout(w)},[se,H,Be,je]),a.useEffect(()=>{if(!jt)return;const T=D=>{D.key==="Enter"&&(D.preventDefault(),la())};return window.addEventListener("keydown",T),()=>window.removeEventListener("keydown",T)},[jt]);const vt=T=>{be(T),pe(qt(T))};a.useEffect(()=>{if(!se){pe(null),be([]);return}const T=se.cardType==="info"?"info":"connection";if(se.cardType==="info"&&se.infoType==="quote"){Dt().then(D=>{const i=D.filter(u=>u.itemType==="info"&&u.itemId===se.cardId&&u.checkType==="quote-fragment"&&Ba(u.direction,se.direction));vt(i)}).catch(()=>{pe(null),be([])});return}Fa(T,se.cardId,se.checkType,se.direction).then(D=>vt(D)).catch(()=>{pe(null),be([])})},[se]);const Xt=(T,D,i,u)=>{if(T==="info"&&i==="quote-fragment"){Dt().then(w=>{const f=w.filter(P=>P.itemType==="info"&&P.itemId===D&&P.checkType==="quote-fragment"&&Ba(P.direction,u));vt(f)}).catch(()=>{pe(null),be([])});return}Fa(T,D,i,u).then(w=>vt(w)).catch(()=>{pe(null),be([])})},Jt=(T,D,i)=>{var P;const u=((P=i.pairs.find(p=>p.leftId===T))==null?void 0:P.rightId)??null;if(!u)return i;const w=u===D;Ce(p=>({...p,[T]:w?"correct":"incorrect"})),q.current&&window.clearTimeout(q.current),ge.current&&window.clearTimeout(ge.current),le.current+=1;const f={kind:w?"correct":"incorrect",tick:le.current};if(qe(null),q.current=window.setTimeout(()=>qe(f),0),ge.current=window.setTimeout(()=>qe(null),420),w){const p={...i.locked,[T]:!0};return Object.keys(p).length>=i.pairs.length?(ue("correct"),Ye(!0)):ue("correct"),{...i,selection:{...i.selection,[T]:D},activeLeft:null,activeRight:null,locked:p}}return ue("incorrect"),{...i,activeLeft:null,activeRight:null}},Na=T=>{Q(D=>!D||D.locked[T]?D:D.activeRight?Jt(T,D.activeRight,D):{...D,activeLeft:D.activeLeft===T?null:T})},Ta=T=>{Q(D=>D&&(D.activeLeft?Jt(D.activeLeft,T,D):{...D,activeRight:D.activeRight===T?null:T}))},la=()=>{var T;if(se&&se.cardType==="info"&&se.infoType==="quote"&&ot.current&&he&&!((T=Nt(se.direction))!=null&&T.fragmentId)){const D=ha(ot.current,Lt.current,tt.current,Rt,nt,se.direction,he.fragmentId);if(D){ue(null),ae(""),$(!1),we({}),Ye(!1),Ne(null),He(0),Zt(ot.current,D.id,he.title);return}}ue(null),ae(""),$(!1),we({}),Ye(!1),Ne(null),He(0),ee(D=>Math.min(D+1,h.length))},At=T=>{if(!se)return;const D=T.expected??null,i=T.answer??"";let u=D??"",w=i;if(!D&&T.expectedMap&&T.answerMap){const J=Object.keys(T.expectedMap).sort((Z,ce)=>Z.localeCompare(ce));u=J.map(Z=>{var ce;return((ce=T.expectedMap)==null?void 0:ce[Z])??""}).join("|"),w=J.map(Z=>{var ce;return((ce=T.answerMap)==null?void 0:ce[Z])??""}).join("|")}const f=u?ga(u,w,it):new Uint8Array,P={revisionType:me.id,evalType:T.evalType,direction:T.direction,prompt:C??"",expected:D,answer:i,expectedAnswers:T.expectedMap??null,answers:T.answerMap??null,correct:T.correct,maskBase64:f.length?Ht(f):null,checkMode:N,compareMode:it,minCorrectness:rt},p=new TextEncoder().encode(JSON.stringify(P)),A=se.cardType==="info"?"info":"connection",M=T.overrideCheckType??se.checkType??null,F=T.overrideDirection??se.direction??null;Aa({itemType:A,itemId:se.cardId,checkType:M,direction:F,revisionType:me.id,evalType:T.evalType,correct:T.correct,maskBase64:f.length?Ht(f):null,payloadBase64:Ht(p)}).then(()=>{Xt(A,se.cardId,M,F),pa(h)}).catch(()=>{})},ca=(T,D)=>{const i=kt.current.get(D);if(i)return Promise.resolve(i);const u=Ut.current.get(D);if(u)return u;const w=qn({shareCode:d,infoId:T,key:gt}).then(f=>{var J,Z;const P=f.payload,p=((J=P.definition)==null?void 0:J.graph)??null,A="",M=((Z=P.definition)==null?void 0:Z.answerTemplate)??"",F=Js(p,A,M);if(F){const ne={sample:Zs(F),answerTemplate:M||null};return kt.current.set(D,ne),ne}return xs({shareId:d,infoId:T,key:gt}).then(ce=>{const ne={sample:ce,answerTemplate:null};return kt.current.set(D,ne),ne})}).catch(()=>xs({shareId:d,infoId:T,key:gt}).then(f=>{const P={sample:f,answerTemplate:null};return kt.current.set(D,P),P}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{Ut.current.delete(D)});return Ut.current.set(D,w),w},It=(T,D)=>{var p;const i=`${ie(T)}:${D}`,u=Vt.current.get(i);if(u)return Promise.resolve(u);const w=Qt.current.get(i);if(w)return w;const f=A=>(Vt.current.set(i,A),A);let P;if(T.cardType==="vocab"){if(T.checkType==="translation-match")return P=Promise.resolve(f({prompt:T.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),P;const A=T.label.split("↔").map(M=>M.trim()).filter(Boolean);if(A.length>=2){const F=(T.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",J=F?A[0]:A[1],Z=F?A[1]:A[0];P=Promise.resolve(f({prompt:J,expectedAnswer:Z,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else P=Promise.resolve(f({prompt:T.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(T.cardType==="info"&&T.infoType==="word"){const A=(p=T.description)!=null&&p.startsWith("Language: ")?T.description.replace("Language: ",""):null;P=Promise.resolve(f({prompt:T.label,expectedAnswer:A,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else T.cardType==="info"&&T.infoType==="computed"?P=ca(T.cardId,i).then(A=>{var ce,ne;if(!A.sample)return f({prompt:T.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const M=A.sample,F=M.expectedAnswers?Object.entries(M.expectedAnswers).map(([Te,Ie])=>({key:Te,expected:Ie})):[],J=F.reduce((Te,Ie)=>(Te[Ie.key]="",Te),{}),Z=M.expectedAnswerIsSentence&&((ce=M.expectedAnswer)==null?void 0:ce.trim())||null;return f({prompt:M.prompt,expectedAnswer:F.length>0?Z:((ne=M.expectedAnswer)==null?void 0:ne.trim())||null,computedExpected:F,computedAnswers:J,answerTemplate:A.answerTemplate,outputVariables:M.outputVariables??null,variableValues:M.variableValues??null})}).catch(()=>f({prompt:T.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Qt.current.delete(i)}):P=Promise.resolve(f({prompt:T.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return Qt.current.set(i,P),P},Zt=(T,D,i)=>{const u=Object.keys(T.nodes).length,w=Lt.current.size;if(!D){_({title:i,before:T.text,after:"",fragmentId:null,total:u,completed:w}),V(null),Ye(!0);return}const f=T.nodes[D];if(!f)return;const P=Qs(T.text,f);_({title:i,before:P.before,after:P.after,fragmentId:f.id,total:u,completed:w}),V(P.fragment),Ye(!1)},ba=()=>{const T=ot.current;T&&_(D=>D&&{...D,total:Object.keys(T.nodes).length,completed:Lt.current.size})},_t=()=>{const T=h[R+1];T&&It(T,R+1)},Sa=()=>{if(_t(),se&&se.cardType==="vocab"&&se.checkType==="translation-match"&&K){if(K.pairs.length===0){ue("incorrect"),Ye(!0);return}const f=K.pairs.reduce((Z,ce)=>(Z[ce.rightId]=ce.rightLabel,Z),{});let P=0;const p={};K.pairs.forEach(Z=>{const ne=K.selection[Z.leftId]===Z.rightId;p[Z.leftId]=ne?"correct":"incorrect",ne&&(P+=1)});const A=K.pairs.length||1,M=P/A,F=P===K.pairs.length;Ce(Z=>({...Z,...p})),F?(ue("correct"),Ye(!0),He(0)):(ue("incorrect"),Ye(!1),He(Z=>{const ce=Z+1;return ce>=pt&&($(!0),Ye(!0),Q(ne=>{if(!ne)return ne;const Te=ne.pairs.reduce((Ie,De)=>(Ie[De.leftId]=De.rightId,Ie),{});return{...ne,selection:Te}})),ce})),xt(F,M);const J="connection";Promise.all(K.pairs.map(Z=>{const ce=K.selection[Z.leftId]??null,ne=ce?f[ce]:"",Te={left:Z.leftLabel,expected:Z.rightLabel,answer:ne,checkType:"translation-match"},Ie=new TextEncoder().encode(JSON.stringify(Te));return Aa({itemType:J,itemId:Z.cardId,checkType:"translation-match",direction:null,revisionType:me.id,evalType:"translation-match",correct:ce===Z.rightId,maskBase64:null,payloadBase64:Ht(Ie)})})).then(()=>{Xt(J,se.cardId,se.checkType,se.direction),pa(h)}).catch(()=>{});return}if(H.length>0){const f=H.reduce((p,A)=>{const M=Se[A.key]??"";return p[A.key]=wt(M)===wt(A.expected)?"correct":"incorrect",p},{});H.every(({key:p,expected:A})=>{const M=Se[p]??"";return N==="exact"&&wt(M)===wt(A)})?(ue("correct"),we(f),Ye(!0),He(0),xt(!0,1),At({correct:!0,direction:C?`${C} -> computed`:"computed",expectedMap:H.reduce((p,A)=>(p[A.key]=A.expected,p),{}),answerMap:Se,evalType:"computed"})):(ue("incorrect"),we(f),Ye(!1),He(p=>{const A=p+1;return A>=pt&&ea&&($(!0),Ye(!0)),A}),xt(!1,0),window.setTimeout(()=>{var A;const p=Ka(Be,H,je);p&&mt.current[p]&&((A=mt.current[p])==null||A.focus())},40),At({correct:!1,direction:C?`${C} -> computed`:"computed",expectedMap:H.reduce((p,A)=>(p[A.key]=A.expected,p),{}),answerMap:Se,evalType:"computed"}));return}if(se&&se.cardType==="info"&&se.infoType==="quote"&&(he!=null&&he.fragmentId)){if(!x)return;const f=Nt(se.direction),P=(f==null?void 0:f.mode)??getQuoteMode(se.direction),p=f!=null&&f.fragmentId&&se.direction?se.direction:ja(P,he.fragmentId),A=nn(x,te,it),M=N==="exact"&&fa(te)===fa(x),F=na(A),J=M||F,Z=Wt(A);J?(tt.current[he.fragmentId]=Math.max(tt.current[he.fragmentId]??0,Z),(tt.current[he.fragmentId]??0)>=Rt&&Lt.current.add(he.fragmentId),ba(),ue("correct"),we({}),Ye(!0),Ne(A),He(0),Z<100&&pt<=1&&$(!0),xt(!0,Z/100),At({correct:!0,direction:`quote:${he.fragmentId}`,expected:x,answer:te,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:p})):(ue("incorrect"),we({}),Ye(!1),Ne(A),He(ce=>{const ne=ce+1;return ne>=pt&&ea&&($(!0),Ye(!0)),ne}),xt(!1,Z/100),window.setTimeout(()=>{var ce;return(ce=Je.current)==null?void 0:ce.focus()},40),At({correct:!1,direction:`quote:${he.fragmentId}`,expected:x,answer:te,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:p}));return}if(!x)return;const T=ga(x,te,it),D=N==="exact"&&wt(te)===wt(x),i=na(T),u=D||i,w=Wt(T);u?(ue("correct"),we({}),Ye(!0),Ne(T),He(0),w<100&&pt<=1&&$(!0),xt(!0,w/100),At({correct:!0,direction:C?`${C} -> ${x}`:null,expected:x,answer:te,evalType:"text"})):(ue("incorrect"),we({}),Ye(!1),Ne(T),He(f=>{const P=f+1;return P>=pt&&ea&&($(!0),Ye(!0)),P}),xt(!1,w/100),window.setTimeout(()=>{var f;return(f=Je.current)==null?void 0:f.focus()},40),At({correct:!1,direction:C?`${C} -> ${x}`:null,expected:x,answer:te,evalType:"text"}))},da=T=>{if(_t(),!x)return;const D=ga(x,T,it),i=wt(T)===wt(x),u=na(D),w=i||u,f=Wt(D);w?(ue("correct"),we({}),Ye(!0),Ne(D),He(0),f<100&&pt<=1&&$(!0),xt(!0,f/100),At({correct:!0,direction:"word->language",expected:x,answer:T,evalType:"language-select"})):(ue("incorrect"),we({}),Ye(!1),Ne(D),He(P=>{const p=P+1;return p>=pt&&ea&&($(!0),Ye(!0)),p}),xt(!1,f/100),At({correct:!1,direction:"word->language",expected:x,answer:T,evalType:"language-select"}))},Ca=T=>{var i;if(T.key!=="Enter")return;if(T.preventDefault(),T.stopPropagation(),jt){la();return}const D=H.find(u=>!(Se[u.key]??"").trim());if(D){(i=mt.current[D.key])==null||i.focus();return}Sa()},Ha=()=>{_t(),ue("correct"),Ye(!0),He(0),xt(!0,1),x&&At({correct:!0,direction:"manual",expected:x,answer:te,evalType:"manual"})},Qa=()=>{if(xt(!1,0),se&&se.cardType==="info"&&se.infoType==="quote"){ue(null),ae(""),$(!1),we({}),Ye(!1),Ne(null),He(0),ee(T=>Math.min(T+1,h.length));return}la()};a.useEffect(()=>{_t()},[R,h]);const Ya=t.cogita.library.revision.revealModeAfterIncorrect,ea=H.length>0||!!x;return e.jsxs(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:r,onToggleSecureMode:l,onLogout:m,secureMode:b,onNavigate:y,language:E,onLanguageChange:j,children:[(o==="loading"||z==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:o==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${G.total?Math.min(100,Math.max(0,G.current/G.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:G.total?`${Math.min(G.current,G.total)} / ${G.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:de}),e.jsx("p",{className:"cogita-library-subtitle",children:W}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",et).replace("{check}",at)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:O?`${O.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Mt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Mt.currentLevel??"-"," / ",Mt.levelsCount]}):null,O?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(O.correct)).replace("{total}",String(O.total))}),O.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(O.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(tn,{outcomes:Me})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[$e?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:$e})}):null,e.jsx("section",{className:"cogita-revision-card","data-feedback":Le?`${Le.kind}-${Le.tick}`:ft?"idle":Pe??"idle",children:o!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:o==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):se?e.jsx(e.Fragment,{children:ct?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(en,{copy:t,currentCard:se,currentTypeLabel:Yt,prompt:C,languages:B,answer:te,onAnswerChange:T=>ae(D=>_a(D,T,I)),computedExpected:H,computedAnswers:Se,onComputedAnswerChange:(T,D)=>ve(i=>({...i,[T]:_a(i[T]??"",D,I)})),answerTemplate:Be,outputVariables:je,variableValues:Xe,computedFieldFeedback:Ae,feedback:Pe,canAdvance:jt,quoteContext:he,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Sa,onSkip:Qa,onLanguageSelect:da,onMarkReviewed:Ha,onAdvance:la,showCorrectAnswer:xe,setShowCorrectAnswer:$,onRevealCorrect:()=>Ye(!0),answerMask:Ee,expectedAnswer:x,hasExpectedAnswer:ea,handleComputedKeyDown:Ca,answerInputRef:Je,computedInputRefs:mt,scriptMode:I,setScriptMode:X,matchPairs:K==null?void 0:K.pairs,matchLeftOrder:K==null?void 0:K.leftOrder,matchRightOrder:K==null?void 0:K.rightOrder,matchSelection:K==null?void 0:K.selection,matchActiveLeft:K==null?void 0:K.activeLeft,matchActiveRight:K==null?void 0:K.activeRight,matchFeedback:Ve,onMatchLeftSelect:Na,onMatchRightSelect:Ta})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:$t?`${Ct} / ${$t}`:t.cogita.library.revision.progressUnlimited}),o==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),o==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),o==="ready"&&z==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),o==="ready"&&z==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),o==="ready"&&z==="ready"&&h.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Ya}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",pt]})]})]}),Mt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Mt.activeCount," / ",Mt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Mt.counts.map((T,D)=>{const i=D+1,u=Mt.currentLevel===i,w=Mt.percentages[D]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":u,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:i}),e.jsx("strong",{children:T})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,w))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[w.toFixed(1),"%"]})]},`level-${i}`)})})]}):null,ra?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:ra.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:ra.dots.map(T=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-T.value))}, ${Math.round(200*T.value)}, 80, 0.9)`}},T.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:ra.knownCount})]})]}):null,nt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Et})]})}):null]})]})]})})})]})]})}const Wi=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:qi},Symbol.toStringTag,{value:"Module"}));export{Ui as C,zi as a,Wi as b};
