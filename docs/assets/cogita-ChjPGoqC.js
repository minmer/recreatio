import{r as a,j as e,u as qs,a as _a,b as Us,c as Ws,d as Hs,R as gs,B as ms,C as ps}from"./vendor-CL5v9b84.js";import{L as Ys,A as Qs,g as Gs,a as xn,b as va,c as Js,s as Ss,d as fs,e as vn,f as Ts,h as Qt,i as wn,j as Xs,k as Zs,l as en,m as bs,n as tn,o as jn,u as kn,p as Nn,q as Sn,r as Tn,t as Cn,v as Mn,w as an,x as sn,y as In,z as Ln,B as $n,C as Va,D as La,E as Rn,F as An,G as nn,H as En,I as Pn,J as Fn,K as Cs,M as Yt,N as Kn,O as zn,P as Dn,Q as Bn,R as _n,S as Vn,T as On,U as qn,V as Un,W as Wn,X as Hn,Y as Yn,Z as Qn,_ as Gn,$ as Jn,a0 as Xn,a1 as Ms}from"./recreatio-core-r39TKt4X.js";import"./vendor-cogita-ui-mbCyoqV0.js";const xa={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},ba={moveMs:900,pauseMs:220,errorMs:900},Zn=(t=11)=>{let s=t;const n=()=>(s=(s*1664525+1013904223)%4294967296,s/4294967296),{width:i,height:l,paddingX:p,paddingY:m,levels:f}=xa,R=(l-m*2)/(f.length-1),I=[],c=[],x=[];f.forEach((b,h)=>{const he=l-m-h*R,F=i-p*2,y=[];for(let H=0;H<b;H+=1){const E=p+(H+1)*F/(b+1),J=(n()-.5)*18,L=Math.max(p,Math.min(i-p,E+J)),P=h===0?3:h<2?2.1:1.4,re=h===0?"root":`l${h}-${H}`;y.push({id:re,x:h===0?i/2:L,y:he,r:P,level:h,role:h===0?"root":void 0})}x.push(y),I.push(...y)});const o=x[x.length-1];if(o!=null&&o.length){const b=o[Math.floor(o.length/2)];b.role="goal",b.r=2}for(let b=1;b<x.length;b+=1){const h=x[b-1];x[b].forEach(F=>{const y=[...h].sort((L,P)=>Math.abs(L.x-F.x)-Math.abs(P.x-F.x)),H=y[0],E=y[1]&&n()<.45?y[1]:null;(E?[H,E]:[H]).forEach(L=>{c.push({from:L.id,to:F.id,key:`${L.id}-${F.id}`})}),n()<.2&&y[2]&&c.push({from:y[2].id,to:F.id,key:`${y[2].id}-${F.id}`})})}const u=new Map;c.forEach(b=>{const h=u.get(b.to)??[];h.push(b.from),u.set(b.to,h)});const k=new Map,Y=new Map,q=new Map;c.forEach(b=>{const h=k.get(b.from)??[];h.push(b.key),k.set(b.from,h);const he=Y.get(b.from)??[];he.push(b.to),Y.set(b.from,he);const F=q.get(b.from)??[];F.push(b.to),q.set(b.from,F);const y=q.get(b.to)??[];y.push(b.from),q.set(b.to,y)});const V=new Map;return I.forEach(b=>{V.set(b.id,b)}),{nodes:I,links:c,parentsById:u,linksByFrom:k,childrenByFrom:Y,neighborsById:q,nodesById:V}};function ei({slides:t,activeIndex:s,introOpen:n,prefersReducedMotion:i,onNext:l,onPrev:p,onSelect:m,onExit:f,onOpen:R,onRegister:I}){const c=s===t.length-1,x=n&&s===0?"entry":"docked",o=t[t.length-1],[u,k]=a.useState(!1),Y=a.useMemo(()=>Array.from({length:20},(A,Z)=>({src:`/cogita/logo/Cogita${String(Z).padStart(2,"0")}.png`,kind:Z<=11?"bubble":Z<=17?"text":"recreatio"})),[]),q=n&&s===0;a.useEffect(()=>{if(!n){k(!1);return}s>0&&!u&&k(!0)},[s,n,u]);const V=a.useRef(0),b=a.useRef(null),h=a.useMemo(()=>{const A={x:40,y:160},Z={x:260,y:48},fe=6,T=Z.x-A.x,C=A.y-Z.y,G=T/fe,ae=[.3,.45,.6,.65,1.4,2.2],ne=ae.reduce((ge,le)=>ge+le,0),Ce=ae.map(ge=>C*ge/ne),Ie=[A];let Pe=A.x,se=A.y;for(let ge=1;ge<=fe;ge+=1){const le=(Math.random()-.5)*14,st=(Math.random()-.5)*28;Pe=Math.max(A.x+ge*14,Math.min(Z.x-(fe-ge)*14,Pe+G+le));const Oe=Ce[ge-1]??Ce[Ce.length-1];se=se-Oe+st;const Ye=Math.max(Z.y,Math.min(A.y-4,se));Ie.push({x:Math.round(Pe),y:Math.round(Ye)})}return Ie[Ie.length-1]=Z,Ie},[]),he=a.useMemo(()=>{const C=(ne,Ce,Ie)=>Math.min(Ie,Math.max(Ce,ne)),G=h.map(ne=>{const Ce=10+Math.random()*36;return{x:C(ne.x,40,260),y:C(ne.y-Ce,40,140)}}),ae=h.map((ne,Ce)=>{var se;const Ie=12+Math.random()*40,Pe=((se=G[Ce])==null?void 0:se.y)??ne.y;return{x:C(ne.x,40,260),y:C(Math.max(Pe+10,ne.y+Ie),60,170)}});return{upper:G,lower:ae}},[h]),F=a.useMemo(()=>{var Z;const A=((Z=h[4])==null?void 0:Z.x)??260;return Math.max(0,Math.min(240,A-40))},[h]),y=a.useMemo(()=>{var Ce,Ie;const A=(Pe,se,ge)=>Math.min(ge,Math.max(se,Pe)),Z=(Pe,se,ge)=>h.map((le,st)=>{var Ct,dt;const Oe=((Ct=he.upper[st])==null?void 0:Ct.y)??le.y,Ye=((dt=he.lower[st])==null?void 0:dt.y)??le.y,ct=(Math.random()-.5)*70,yt=le.y+Pe+ct,Ue=A(le.y+se,Oe+6,Ye-6),We=A(le.y+ge,Oe+6,Ye-6);return{x:le.x,y:A(yt,Math.min(Ue,We),Math.max(Ue,We))}}),fe=-14+Math.random()*28,T=14+Math.random()*28,C=Z(fe,-80,12),G=Z(T,-12,80);for(let Pe=4;Pe<h.length;Pe+=1){const se=h[Pe],ge=((Ce=he.upper[Pe])==null?void 0:Ce.y)??se.y,le=((Ie=he.lower[Pe])==null?void 0:Ie.y)??se.y;C[Pe]={x:se.x,y:A(se.y-12,ge+6,le-6)},G[Pe]={x:se.x,y:A(se.y+12,ge+6,le-6)}}const ae=he.upper.length?he.upper[he.upper.length-1].y:40,ne=he.lower.length?he.lower[he.lower.length-1].y:170;return C[C.length-1]={x:h[h.length-1].x,y:A(h[h.length-1].y-14,ae,ne)},G[G.length-1]={x:h[h.length-1].x,y:A(h[h.length-1].y+12,ae,ne)},{higher:C,lower:G}},[h,he]),H=1e4,E=a.useMemo(()=>{let A=17;const Z=()=>(A=(A*1664525+1013904223)%4294967296,A/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((T,C)=>{const G=(Z()-.5)*240,ae=(Z()-.5)*180,ne=(Z()-.5)*24;return{id:`card-${C+1}`,throw:{x:`${G.toFixed(0)}px`,y:`${ae.toFixed(0)}px`,rot:`${ne.toFixed(1)}deg`},grid:{x:`${T.x}px`,y:`${T.y}px`},delay:`${C*.12}s`}})},[]),J=a.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[L,P]=a.useState([]),re=a.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),ue=a.useMemo(()=>{const Z=[],T=(G,ae)=>G+Math.random()*(ae-G);for(let G=0;G<6;G+=1){let ae=!1;for(let ne=0;ne<80;ne+=1){const Ce=T(14,86),Ie=T(10,34);if(Z.every(se=>{const ge=se.x-Ce,le=se.y-Ie;return Math.hypot(ge,le)>=12})){Z.push({x:Ce,y:Ie}),ae=!0;break}}ae||Z.push({x:T(16,84),y:T(12,32)})}return Z.map((G,ae)=>({id:`p${ae+1}`,x:`${G.x.toFixed(1)}%`,y:`${G.y.toFixed(1)}%`,xNum:G.x,yNum:G.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[de,ze]=a.useState(0),[pe,S]=a.useState(0),[xe,v]=a.useState([]),O=1e4,ye=a.useMemo(()=>{if(ue.length<2)return[];const A=ae=>{let ne=ae+1831565813;return ne=Math.imul(ne^ne>>>15,ne|1),ne^=ne+Math.imul(ne^ne>>>7,ne|61),((ne^ne>>>14)>>>0)/4294967296},Z=(ae,ne)=>Math.floor(A(ae)*ne),fe=new Set,T=[],C=Math.min(3,ue.length);let G=0;for(;T.length<C&&G<30;){G+=1;const ae=Z(de*13+G*5,ue.length),ne=Z(de*29+G*7,ue.length);if(ae===ne)continue;const Ce=ae<ne?`${ae}-${ne}`:`${ne}-${ae}`;fe.has(Ce)||(fe.add(Ce),T.push({id:`link-${Ce}`,from:ue[ae],to:ue[ne],delay:`${(G*.35).toFixed(2)}s`}))}return T},[de,ue]);a.useEffect(()=>{if(!n||s!==2)return;const A=()=>{const fe=E.map(T=>T.id);for(let T=fe.length-1;T>0;T-=1){const C=Math.floor(Math.random()*(T+1));[fe[T],fe[C]]=[fe[C],fe[T]]}return fe.slice(0,4)};P(A());const Z=window.setInterval(()=>{P(A())},H);return()=>window.clearInterval(Z)},[s,n,E,H]),a.useEffect(()=>{if(!n||s!==3)return;const A=()=>{S(Math.floor(Math.random()*re.length)),v(ue.map(()=>Math.random()<.6?"good":"bad")),ze(fe=>fe+1)};A();const Z=window.setInterval(A,O);return()=>window.clearInterval(Z)},[s,n,re.length,ue,O]);const Q=a.useMemo(()=>Zn(11),[]),[K,je]=a.useState(new Set(["root"])),[Te,Ne]=a.useState(new Set),[Fe,Me]=a.useState(new Set),[Be,Ke]=a.useState({fromId:"root",toId:"root",key:0}),$e=a.useRef(K),De=a.useRef("root"),et=a.useRef(0),Je=a.useRef(null),Re=a.useRef(null),we=a.useRef([]);a.useEffect(()=>{$e.current=K},[K]);const Ze=a.useMemo(()=>{const A=new Set;return K.forEach(Z=>{const fe=Q.linksByFrom.get(Z);fe&&fe.forEach(T=>A.add(T))}),A},[K,Q]),He=Q.nodesById.get(Be.toId)??Q.nodesById.get("root"),oe=He?`${He.x/xa.width*100}%`:"50%",Le=He?`${He.y/xa.height*100}%`:"90%";a.useEffect(()=>{if(!n||s!==1||i)return;(()=>{je(new Set(["root"])),Ne(new Set),Me(new Set),Ke({fromId:"root",toId:"root",key:0}),Re.current=null,et.current=0,De.current="root",we.current=[]})();const Z=()=>{const T=De.current,C=$e.current,ae=(Q.childrenByFrom.get(T)??[]).filter(le=>!C.has(le));if(ae.length)return ae[Math.floor(Math.random()*ae.length)];if(C.size>=Q.nodes.length){const le=Q.neighborsById.get(T)??[];return le.length?le[Math.floor(Math.random()*le.length)]:null}const ne=le=>(Q.childrenByFrom.get(le)??[]).some(Oe=>!C.has(Oe)),Ce=[T],Ie=new Set([T]),Pe=new Map;let se=null;for(;Ce.length;){const le=Ce.shift();if(!le)break;if(le!==T&&ne(le)){se=le;break}(Q.neighborsById.get(le)??[]).forEach(Oe=>{Ie.has(Oe)||(Ie.add(Oe),Pe.set(Oe,le),Ce.push(Oe))})}if(!se)return null;let ge=se;for(;Pe.get(ge)&&Pe.get(ge)!==T;)ge=Pe.get(ge)??ge;return ge},fe=(T,C)=>{if(T===C){const G=Z();G&&fe(T,G);return}et.current+=1,Ke({fromId:T,toId:C,key:et.current}),De.current=C,Je.current=window.setTimeout(()=>{const G=Q.parentsById.get(C)??[],ae=$e.current,ne=G.filter(se=>!ae.has(se));if(!ne.length){const se=new Set(ae);se.add(C),je(se),Je.current=window.setTimeout(()=>{for(;we.current.length;){const le=we.current[we.current.length-1];if(!se.has(le)){if(le!==C){fe(C,le);return}break}we.current.pop()}const ge=Z();ge&&fe(C,ge)},ba.pauseMs);return}const Ce=new Set([C,...ne]),Ie=new Set(ne.map(se=>`${se}-${C}`));Ne(Ce),Me(Ie),we.current.includes(C)||we.current.push(C);const Pe=ne[Math.floor(Math.random()*ne.length)];Re.current={fromId:C,toId:Pe},Je.current=window.setTimeout(()=>{Ne(new Set),Me(new Set);const se=Re.current;se&&fe(se.fromId,se.toId)},ba.errorMs)},ba.moveMs)};return Je.current=window.setTimeout(()=>{const T=Z();T&&fe(De.current,T)},ba.pauseMs),()=>{Je.current&&window.clearTimeout(Je.current)}},[s,n,Q,i]);const Ve=A=>{if(!n)return;const Z=Date.now();Z-V.current<520||Math.abs(A.deltaY)<10||(V.current=Z,A.deltaY>0?l():p(),A.preventDefault())},Xe=A=>{if(!n)return;const Z=A.touches[0];Z&&(b.current={x:Z.clientX,y:Z.clientY})},X=A=>{if(!n)return;const Z=b.current;if(b.current=null,!Z)return;const fe=A.changedTouches[0];if(!fe)return;const T=fe.clientX-Z.x,C=fe.clientY-Z.y;Math.abs(C)<40||Math.abs(C)<Math.abs(T)||(C<0?l():p())};return e.jsxs("div",{className:`cogita-intro ${n?"is-open":"is-closed"} ${i?"is-reduced":""} ${c?"is-final":""}`,"data-slide":s+1,onWheel:Ve,onTouchStart:Xe,onTouchEnd:X,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":x,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${q&&!u?"is-entry":""}`,children:Y.map((A,Z)=>e.jsx("img",{src:A.src,alt:"",className:`cogita-logo-layer ${Z===0?"is-base":""} ${A.kind==="text"?"is-text":A.kind==="recreatio"?"is-recreatio":""} ${A.kind==="bubble"?"is-bubble":""}`},A.src))})}),n&&t.map((A,Z)=>{const fe=Z===s;return e.jsxs("section",{className:`cogita-intro-slide slide-${Z+1} ${fe?"is-active":""}`,"aria-hidden":!fe,children:[e.jsxs("div",{className:"cogita-intro-text",children:[A.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:A.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:A.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:A.title}),A.body&&e.jsx("p",{children:A.body.split(`
`).map((T,C)=>e.jsxs("span",{children:[T,C===0&&e.jsx("br",{})]},String(C)))})]}),A.micro&&e.jsx("p",{className:"cogita-intro-micro",children:A.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:c?I:l,children:A.cta}),c&&A.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>m(0),children:A.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[Z===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${xa.width} ${xa.height}`,preserveAspectRatio:"none",children:[Q.links.map(T=>{const C=Q.nodesById.get(T.from),G=Q.nodesById.get(T.to);if(!C||!G)return null;const ae=Ze.has(T.key),ne=Fe.has(T.key);return e.jsx("line",{className:`map-link ${ae?"is-active":""} ${ne?"is-error":""}`,x1:C.x,y1:C.y,x2:G.x,y2:G.y},T.key)}),Q.nodes.map(T=>{const C=K.has(T.id),G=Te.has(T.id);return e.jsx("circle",{className:`map-node ${T.role?`is-${T.role}`:""} ${C?"is-active":""} ${G?"is-error":""}`,cx:T.x,cy:T.y,r:T.r},T.id)})]}),He&&e.jsx("span",{className:"map-explorer-dot",style:{left:oe,top:Le,"--move":`${ba.moveMs}ms`}})]}),Z===2&&e.jsx("div",{className:"cogita-index-cards",children:E.map(T=>{const C=L.indexOf(T.id),G=C>=0?J[C]:null,ae=(G==null?void 0:G.x)??"140px",ne=(G==null?void 0:G.y)??"140px",Ce=C>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":T.throw.x,"--throw-y":T.throw.y,"--throw-rot":T.throw.rot,"--grid-x":T.grid.x,"--grid-y":T.grid.y,"--stack-x":ae,"--stack-y":ne,"--stack-opacity":Ce,"--delay":T.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},T.id)})}),Z===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[re.map((T,C)=>e.jsxs("div",{className:`round-card ${C===pe?"is-active":""}`,style:{"--card-x":T.x,"--card-y":T.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},T.id)),re[pe]&&e.jsx("span",{className:"round-ring",style:{"--card-x":re[pe].x,"--card-y":`calc(${re[pe].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:ue.map(T=>e.jsx("span",{className:"player-dot",style:{left:T.x,top:T.y,"--jitter-x":T.jitterX,"--jitter-y":T.jitterY,"--breath-delay":T.delay}},T.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:ye.map(T=>e.jsx("line",{className:"round-link",x1:T.from.xNum,y1:T.from.yNum,x2:T.to.xNum,y2:T.to.yNum,style:{"--delay":T.delay}},T.id))}),e.jsx("div",{className:"round-flows",children:ue.map((T,C)=>{const G=xe[C]??"good",ae=re[pe];if(!ae)return null;const ne=`calc(${ae.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":T.x,"--from-y":T.y,"--to-x":ae.x,"--to-y":ne,"--delay":`${C*.12}s`}}),e.jsx("span",{className:`return-dot is-${G}`,style:{"--from-x":ae.x,"--from-y":ne,"--to-x":T.x,"--to-y":T.y,"--delay":`${C*.12}s`}}),e.jsx("span",{className:`result-pop is-${G}`,style:{"--at-x":T.x,"--at-y":T.y,"--delay":`${C*.12}s`}})]},`${T.id}-${de}`)})})]},`round-${de}`),Z===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${h[0].x} ${h[0].y} L${h[1].x} ${h[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${h[1].x} ${h[1].y} L${h[2].x} ${h[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${h[2].x} ${h[2].y} L${h[3].x} ${h[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${h[3].x} ${h[3].y} L${h[4].x} ${h[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${h[4].x} ${h[4].y} L${h[5].x} ${h[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${h[5].x} ${h[5].y} L${h[6].x} ${h[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${F};${F};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${he.upper.map((T,C)=>`${C===0?"M":"L"}${T.x} ${T.y}`).join(" ")} ${he.lower.slice().reverse().map(T=>`L${T.x} ${T.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${he.upper.map((T,C)=>`${C===0?"M":"L"}${T.x} ${T.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${he.lower.map((T,C)=>`${C===0?"M":"L"}${T.x} ${T.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[y.higher.slice(0,6).map((T,C)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${C+1}`,d:`M${T.x} ${T.y} L${y.higher[C+1].x} ${y.higher[C+1].y}`,pathLength:"100"},`peer-1-${C}`)),y.lower.slice(0,6).map((T,C)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${C+1}`,d:`M${T.x} ${T.y} L${y.lower[C+1].x} ${y.lower[C+1].y}`,pathLength:"100"},`peer-2-${C}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${h[0].x/300*100}%`,"--p0y":`${h[0].y/200*100}%`,"--p1x":`${h[1].x/300*100}%`,"--p1y":`${h[1].y/200*100}%`,"--p2x":`${h[2].x/300*100}%`,"--p2y":`${h[2].y/200*100}%`,"--p3x":`${h[3].x/300*100}%`,"--p3y":`${h[3].y/200*100}%`,"--p4x":`${h[4].x/300*100}%`,"--p4y":`${h[4].y/200*100}%`,"--p5x":`${h[5].x/300*100}%`,"--p5y":`${h[5].y/200*100}%`,"--p6x":`${h[6].x/300*100}%`,"--p6y":`${h[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${y.higher[0].x/300*100}%`,"--q0y":`${y.higher[0].y/200*100}%`,"--q1x":`${y.higher[1].x/300*100}%`,"--q1y":`${y.higher[1].y/200*100}%`,"--q2x":`${y.higher[2].x/300*100}%`,"--q2y":`${y.higher[2].y/200*100}%`,"--q3x":`${y.higher[3].x/300*100}%`,"--q3y":`${y.higher[3].y/200*100}%`,"--q4x":`${y.higher[4].x/300*100}%`,"--q4y":`${y.higher[4].y/200*100}%`,"--q5x":`${y.higher[5].x/300*100}%`,"--q5y":`${y.higher[5].y/200*100}%`,"--q6x":`${y.higher[6].x/300*100}%`,"--q6y":`${y.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${y.lower[0].x/300*100}%`,"--q0y":`${y.lower[0].y/200*100}%`,"--q1x":`${y.lower[1].x/300*100}%`,"--q1y":`${y.lower[1].y/200*100}%`,"--q2x":`${y.lower[2].x/300*100}%`,"--q2y":`${y.lower[2].y/200*100}%`,"--q3x":`${y.lower[3].x/300*100}%`,"--q3y":`${y.lower[3].y/200*100}%`,"--q4x":`${y.lower[4].x/300*100}%`,"--q4y":`${y.lower[4].y/200*100}%`,"--q5x":`${y.lower[5].x/300*100}%`,"--q5y":`${y.lower[5].y/200*100}%`,"--q6x":`${y.lower[6].x/300*100}%`,"--q6y":`${y.lower[6].y/200*100}%`}})]})})}),Z===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),Z===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},A.id)}),!n&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:o.title}),o.body&&e.jsx("p",{children:o.body}),o.micro&&e.jsx("p",{className:"cogita-intro-micro",children:o.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:I,children:o.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:R,children:"Otwórz pokaz"})]})]})})]}),n&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((A,Z)=>e.jsx("button",{type:"button",className:`dot ${s===Z?"active":""}`,"aria-label":A.title,onClick:()=>m(Z)},A.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:f,children:"Pomiń"})]})]})}const ti=6,ai=4;function si({copy:t,onAuthAction:s,authLabel:n,showProfileMenu:i,onProfileNavigate:l,onToggleSecureMode:p,onLogout:m,secureMode:f,onNavigate:R,language:I,onLanguageChange:c}){const x=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}R("home")},o=a.useRef(null),u=a.useRef([]),k=a.useMemo(()=>{let v=Date.now()%2147483647;const O=()=>(v=v*48271%2147483647,v/2147483647);return Array.from({length:ti},(ye,Q)=>{const K=6+O()*8,je=7+O()*10,Te=6+O()*9,Ne=-O()*K,Fe=-O()*je,Me=-O()*Te,Be=.18+O()*.28,Ke=12+O()*18,$e=4+O()*8,De=(O()-.5)*3.2,et=(O()-.5)*3.8,Je=O()>.5?"alternate":"alternate-reverse",Re=O()>.5?"alternate":"alternate-reverse",we=O()>.5?"alternate":"alternate-reverse",Ze=.18+O()*.42,He=30+O()*60,oe=-45-O()*38,Le=188+O()*32,Ve=.1+O()*.2;return{id:`wave-${Q+1}`,style:{"--wave-sway-duration":`${K}s`,"--wave-scale-duration":`${je}s`,"--wave-drift-duration":`${Te}s`,"--wave-sway-delay":`${Ne}s`,"--wave-scale-delay":`${Fe}s`,"--wave-drift-delay":`${Me}s`,"--wave-sway-dir":Je,"--wave-scale-dir":Re,"--wave-drift-dir":we,"--wave-scale":`${Be}`,"--wave-shift":`${Ke}%`,"--wave-xshift":`${$e}%`,"--wave-x0":`${De}%`,"--wave-y0":`${et}%`,"--wave-opacity":`${Ze}`,"--wave-blur":`${He}px`,"--wave-bottom":`${oe}%`,"--wave-hue":`${Le}`,"--wave-glow":`${Ve}`}}})},[]),Y=a.useMemo(()=>{let v=Date.now()*3%2147483647;const O=()=>(v=v*48271%2147483647,v/2147483647);return Array.from({length:ai},(ye,Q)=>{const K=180+O()*220,je=220+O()*280,Te=-O()*K,Ne=-O()*je,Fe=.12+O()*.22,Me=3+O()*7,Be=1+O()*3,Ke=(O()-.5)*2.8,$e=(O()-.5)*2.2;return{id:`mesh-${Q+1}`,seed:1e3+Q*991+Math.floor(O()*999),style:{"--mesh-sway-duration":`${K}s`,"--mesh-drift-duration":`${je}s`,"--mesh-sway-delay":`${Te}s`,"--mesh-drift-delay":`${Ne}s`,"--mesh-scale":`${Fe}`,"--mesh-shift":`${Me}%`,"--mesh-xshift":`${Be}%`,"--mesh-x0":`${$e}%`,"--mesh-y0":`${Ke}%`}}})},[]),q=a.useMemo(()=>{const v=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],O=t.cogita.introSlides,ye=new Map(O.map(Q=>[Q.id,Q]));return v.map(Q=>{var je;const K=ye.get(Q.id);return{...Q,...K,title:(K==null?void 0:K.title)??"Cogita",cta:(K==null?void 0:K.cta)??((je=t.cogita.introSlides[0])==null?void 0:je.cta)??t.cogita.loginCta,secondary:K==null?void 0:K.secondary}})},[t.cogita.introSlides]),[V,b]=a.useState(0),[h,he]=a.useState(!0),[F,y]=a.useState(!1),H=q.length-1,E=a.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),J=a.useCallback(()=>{E(),s()},[E,s]),L=a.useCallback(()=>{he(!0),b(0)},[]),P=a.useCallback(()=>{he(!1),b(H)},[H]),re=a.useCallback(v=>{b(Math.max(0,Math.min(H,v)))},[H]),ue=a.useCallback(()=>{V>=H?J():re(V+1)},[V,re,J,H]),de=a.useCallback(()=>{re(V-1)},[V,re]);a.useEffect(()=>{var ye;const v=(ye=window.matchMedia)==null?void 0:ye.call(window,"(prefers-reduced-motion: reduce)");if(!v)return;const O=()=>y(v.matches);return O(),v.addEventListener?(v.addEventListener("change",O),()=>v.removeEventListener("change",O)):(v.addListener(O),()=>v.removeListener(O))},[]),a.useEffect(()=>{if(!h)return;const v=O=>{const ye=O.target;if(!ye)return;const Q=ye.tagName;if(!(ye.isContentEditable||Q==="INPUT"||Q==="TEXTAREA"||Q==="SELECT"||Q==="BUTTON"||Q==="A"||ye.closest('button, a, [role="button"], [role="link"]'))){if(O.key==="Escape"){P();return}if(O.key==="ArrowLeft"||O.key==="ArrowUp"){de();return}(O.key==="ArrowRight"||O.key==="ArrowDown"||O.code==="Space"||O.key===" ")&&(O.preventDefault(),ue())}};return window.addEventListener("keydown",v),()=>window.removeEventListener("keydown",v)},[P,ue,de,h]),a.useEffect(()=>{h&&V===H&&E()},[V,h,H,E]),a.useEffect(()=>{const v=o.current;if(!v)return;const O=u.current.filter(oe=>!!oe);if(!O.length)return;const ye=1,Q=.6,K=.6,je=Math.max(1,Math.min(ye,window.devicePixelRatio||1));let Te=0,Ne=0,Fe=Q,Me=0,Be=0;const Ke=oe=>{let Le=oe%2147483647;return Le<=0&&(Le+=2147483646),(Ve,Xe)=>{Le=Le*48271%2147483647;const X=Le/2147483647;return Ve+X*(Xe-Ve)}},$e={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},De=oe=>{const Le=Math.sin(oe*12.9898)*43758.5453;return Le-Math.floor(Le)},et=oe=>{const Le=De(oe+.1)||1e-4,Ve=De(oe+.7)||1e-4;return Math.sqrt(-2*Math.log(Le))*Math.cos(2*Math.PI*Ve)},Je=(oe,Le)=>{const Ve=Math.floor(oe),Xe=Ve+1,X=oe-Ve,A=X*X*(3-2*X),Z=De(Ve*12.9898+Le*78.233),fe=De(Xe*12.9898+Le*78.233);return Z+(fe-Z)*A},Re=oe=>{const Le=Ke(oe),Ve=Math.min(4,Math.max(4,Math.floor(Te/1200*$e.filamentCount)));return Array.from({length:Ve},(Xe,X)=>{const A=Math.max(-1,Math.min(1,et(oe+X*.37))),Z=Math.min(1,Math.max(0,De(oe+X*1.31))),fe=Math.min($e.depthLayers-1,Math.floor(Z*$e.depthLayers));return{seed:Le(0,Math.PI*2)+oe*.01,offset:A,freqA:$e.freq1*(.75+Le(0,.5)),freqB:$e.freq2*(.75+Le(0,.5)),ampA:$e.amp1*(.6+Le(0,.7)),ampB:$e.amp2*(.6+Le(0,.7)),width:2+X%5*.32,depth:Z,layer:fe}})},we=(oe,Le,Ve)=>{const Xe=Math.max(30,Math.floor(Te*Ne/14e4));oe.save(),oe.globalAlpha=.6;for(let X=0;X<Xe;X+=1){const A=De(X*9.1+Te*.11)*Le+Ve,Z=De(X*3.7+Ne*.23)*Ne,fe=1.2+De(X*5.9)*2.4,T=oe.createRadialGradient(A,Z,0,A,Z,fe*2);T.addColorStop(0,"rgba(10, 30, 60, 0.45)"),T.addColorStop(1,"rgba(10, 30, 60, 0)"),oe.fillStyle=T,oe.beginPath(),oe.arc(A,Z,fe*2,0,Math.PI*2),oe.fill()}oe.restore()},Ze=(oe,Le)=>{oe.clearRect(0,0,Te,Ne);const Ve=Ne*$e.waveCenter,Xe=$e.waveBandPx,X=$e.segments,A=$e.colors.filaments,Z=Me||Te,fe=0;we(oe,Z,fe),oe.strokeStyle=A,oe.lineCap="round",oe.lineJoin="round";for(let T=0;T<Le.length;T+=1){const C=Le[T],G=C.offset*Xe*(.85+De(C.seed)*.4),ae=1-Math.min(1,Math.abs(G)/Xe),ne=Math.exp(-Math.pow(G/$e.crestThickness,2)),Ce=C.layer===0?1.1:C.layer===1?.85:.6,Ie=.35+(1-C.depth)*.65,Pe=ae*Ie*Ce*(.34+ne*.45);oe.globalAlpha=Pe,oe.lineWidth=C.width*(1+(1-C.depth)*.8);const se=[];for(let le=0;le<=X;le+=1){const st=le/X*Z+fe,Oe=(Je(st*.012,C.seed)-.5)*$e.xJitter,Ye=st+Oe,ct=(Je(Ye*C.freqA,C.seed)-.5)*$e.jitterA,yt=(Je(Ye*C.freqB,C.seed*1.7)-.5)*$e.jitterB,Ue=Ve+Math.sin(Ye*C.freqA+C.seed)*C.ampA+Math.sin(Ye*C.freqB+C.seed*1.3)*C.ampB+G+ct+yt;se.push({x:Ye,y:Ue})}oe.beginPath(),oe.moveTo(se[0].x,se[0].y);for(let le=1;le<se.length-1;le+=1){const st=(se[le].x+se[le+1].x)/2,Oe=(se[le].y+se[le+1].y)/2;oe.quadraticCurveTo(se[le].x,se[le].y,st,Oe)}const ge=se[se.length-1];oe.quadraticCurveTo(ge.x,ge.y,ge.x,ge.y),oe.stroke()}oe.save(),oe.globalCompositeOperation="lighter",oe.strokeStyle=$e.colors.glow,oe.lineCap="round",oe.lineJoin="round";for(let T=0;T<Le.length;T+=1){const C=Le[T];if(Math.abs(C.offset)*Xe>$e.crestThickness)continue;const G=$e.glowAlpha*(.7+(1-C.depth)*.6);oe.globalAlpha=G,oe.lineWidth=1.6+(1-C.depth)*1.2;const ae=[];for(let Ce=0;Ce<=X;Ce+=1){const Ie=Ce/X*Z+fe,Pe=Math.sin(Ie*.02+C.seed)*3,se=Ve+Math.sin(Ie*C.freqA+C.seed)*C.ampA+Math.sin(Ie*C.freqB+C.seed*1.3)*C.ampB+C.offset*Xe*.35+Pe;ae.push({x:Ie,y:se})}oe.beginPath(),oe.moveTo(ae[0].x,ae[0].y);for(let Ce=1;Ce<ae.length-1;Ce+=1){const Ie=(ae[Ce].x+ae[Ce+1].x)/2,Pe=(ae[Ce].y+ae[Ce+1].y)/2;oe.quadraticCurveTo(ae[Ce].x,ae[Ce].y,Ie,Pe)}const ne=ae[ae.length-1];oe.quadraticCurveTo(ne.x,ne.y,ne.x,ne.y),oe.stroke()}oe.restore()},He=()=>{Te=Math.floor(v.clientWidth),Ne=Math.floor(v.clientHeight),Me=Math.floor(Te*1.8),Be=Ne,Fe=Te<820?K:Q,O.forEach(oe=>{const Le=oe.getContext("2d");if(!Le)return;oe.width=Math.floor(Me*je*Fe),oe.height=Math.floor(Be*je*Fe),oe.style.width=`${Me}px`,oe.style.height=`${Be}px`,oe.style.left=`${-(Me-Te)/2}px`,Le.setTransform(je*Fe,0,0,je*Fe,0,0);const Ve=Number(oe.dataset.seed||1),Xe=Re(Ve);Ze(Le,Xe)})};return He(),window.addEventListener("resize",He,{passive:!0}),()=>window.removeEventListener("resize",He)},[Y]);const ze=q[Math.min(V,q.length-1)],pe=h?ze:q[q.length-1],S=(pe==null?void 0:pe.theme)??q[0].theme,xe={"--cogita-bg0":S.bg0,"--cogita-bg1":S.bg1,"--cogita-bg2":S.bg2,"--cogita-bloom":S.bloom,"--cogita-sat":S.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:x,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Ys,{value:I,onChange:c}),e.jsx(Qs,{copy:t,label:n,isAuthenticated:i,secureMode:f,onLogin:s,onProfileNavigate:l,onToggleSecureMode:p,onLogout:m,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:o,className:"cogita-section cogita-home",style:xe,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[Y.map((v,O)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:v.style,"data-seed":v.seed,ref:ye=>{u.current[O]=ye}},v.id)),k.map(v=>e.jsx("div",{className:"cogita-home-wave",style:v.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},v.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(ei,{slides:q,activeIndex:V,introOpen:h,prefersReducedMotion:F,onNext:ue,onPrev:de,onSelect:re,onExit:P,onOpen:L,onRegister:J})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const lr=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:si},Symbol.toStringTag,{value:"Module"})),rn=a.createContext(!1);function Tt({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,headerExtra:c,children:x}){if(a.useContext(rn))return e.jsx(e.Fragment,{children:x});const u=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}f("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:u,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Ys,{value:R,onChange:I}),e.jsxs("div",{className:"cogita-header-right",children:[c,e.jsx(Qs,{copy:t,label:s,isAuthenticated:n,secureMode:m,onLogin:()=>f("home"),onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:x}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function Wt(t){const[s,n]=a.useState("Cogita library"),[i,l]=a.useState(null);return a.useEffect(()=>{let p=!1;return Gs().then(m=>{if(p)return;const f=m.find(R=>R.libraryId===t);f&&n(f.name)}).catch(()=>{p||n("Cogita library")}),()=>{p=!0}},[t]),a.useEffect(()=>{let p=!1;return xn(t).then(m=>{p||l(m)}).catch(()=>{p||l(null)}),()=>{p=!0}},[t]),{libraryName:s,stats:i}}function Is({slices:t}){const s=t.reduce((i,l)=>i+Math.max(0,l.value),0),n=a.useMemo(()=>{if(s<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let i=0;return`conic-gradient(${t.map(p=>{const f=Math.max(0,p.value)/s*360,R=i,I=i+f;return i=I,`${p.color} ${R}deg ${I}deg`}).join(",")})`},[t,s]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:n}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(i=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:i.color}}),e.jsx("strong",{children:i.value}),e.jsx("small",{children:i.label})]},i.label))})]})}function ni({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,libraryId:c}){const{libraryName:x,stats:o}=Wt(c),[u,k]=a.useState("infos"),[Y,q]=a.useState(0),[V,b]=a.useState(0),[h,he]=a.useState(0),F=(o==null?void 0:o.totalInfos)??0,y=(o==null?void 0:o.totalCollections)??0,H=0,E=0,J=0,L=Math.max(0,F-J-V),P=Math.max(0,F-V-h);a.useEffect(()=>{let ue=!1;return(async()=>{try{const ze=await va({libraryId:c,limit:200}),pe=await Promise.all(ze.items.map(S=>Js({libraryId:c,collectionId:S.collectionId}).catch(()=>[])));if(ue)return;q(pe.reduce((S,xe)=>S+xe.length,0))}catch{ue||q(0)}})(),()=>{ue=!0}},[c]),a.useEffect(()=>{let ue=!1;return(async()=>{try{const[ze,pe,S]=await Promise.all([Ss({libraryId:c,type:"computed",limit:1}).catch(()=>({total:0})),Ss({libraryId:c,type:"source",limit:1}).catch(()=>({total:0})),fs({libraryId:c}).catch(()=>({items:[]}))]);if(ue)return;b((ze.total??0)+(pe.total??0));const xe=new Set(S.items.filter(v=>v.childItemType.toLowerCase()==="info").map(v=>v.childItemId).filter(Boolean));he(xe.size)}catch{ue||(b(0),he(0))}})(),()=>{ue=!0}},[c]);const re=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:F},{key:"collections",label:t.cogita.library.overview.stats.collections,value:y},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:Y},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:H},{key:"texts",label:t.cogita.library.overview.stats.texts,value:E}];return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:x})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:re.map(ue=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${u===ue.key?"active":""}`,onClick:()=>k(ue.key),children:[e.jsx("span",{children:ue.label}),e.jsx("strong",{children:ue.value})]},ue.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),u==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(Is,{slices:[{label:t.cogita.library.overview.known,value:J,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:L,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:V,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(Is,{slices:[{label:t.cogita.library.overview.availableChecks,value:h,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:P,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const qe=(t,s)=>{const n=t.cogita.library.infoTypes,i=t.cogita.library.connectionTypes,l=t.cogita.library.groupTypes;return{any:n.any,vocab:n.vocab,book:l.book,citation:l.citation,language:n.language,word:n.word,sentence:n.sentence,topic:n.topic,collection:n.collection,person:n.person,institution:n.institution,collective:n.collective,orcid:n.orcid,address:n.address,email:n.email,phone:n.phone,media:n.media,work:n.work,geo:n.geo,music_piece:n.musicPiece,music_fragment:n.musicFragment,source:n.source,computed:n.computed,"word-language":i.wordLanguage,"citation-language":i.citationLanguage,"language-sentence":i.languageSentence,translation:i.translation,"word-topic":i.wordTopic,reference:i.reference,"source-resource":i.sourceResource,"work-contributor":i.workContributor,"work-medium":i.workMedium,"orcid-link":i.orcidLink}[s]??String(s)},ii=t=>[{value:"any",label:qe(t,"any")},{value:"language",label:qe(t,"language")},{value:"word",label:qe(t,"word")},{value:"sentence",label:qe(t,"sentence")},{value:"topic",label:qe(t,"topic")},{value:"collection",label:qe(t,"collection")},{value:"person",label:qe(t,"person")},{value:"institution",label:qe(t,"institution")},{value:"collective",label:qe(t,"collective")},{value:"orcid",label:qe(t,"orcid")},{value:"address",label:qe(t,"address")},{value:"email",label:qe(t,"email")},{value:"phone",label:qe(t,"phone")},{value:"media",label:qe(t,"media")},{value:"work",label:qe(t,"work")},{value:"geo",label:qe(t,"geo")},{value:"music_piece",label:qe(t,"music_piece")},{value:"music_fragment",label:qe(t,"music_fragment")},{value:"source",label:qe(t,"source")},{value:"citation",label:qe(t,"citation")},{value:"computed",label:qe(t,"computed")},{value:"vocab",label:qe(t,"vocab")},{value:"book",label:qe(t,"book")},{value:"word-language",label:qe(t,"word-language")},{value:"citation-language",label:qe(t,"citation-language")},{value:"language-sentence",label:qe(t,"language-sentence")},{value:"translation",label:qe(t,"translation")},{value:"word-topic",label:qe(t,"word-topic")},{value:"reference",label:qe(t,"reference")},{value:"source-resource",label:qe(t,"source-resource")},{value:"work-contributor",label:qe(t,"work-contributor")},{value:"work-medium",label:qe(t,"work-medium")},{value:"orcid-link",label:qe(t,"orcid-link")}],ri=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Xa={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},oi={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Xa]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Xa]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId"]},filterFields:[Xa,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text"],connections:[{relationType:"citation-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"citationText",kind:"text",path:"text",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},Ls={infoType:"default",entityKind:"single",structure:{payloadFields:["label"]},filterFields:[]};function li(t){return t?oi[t]??Ls:Ls}function ci(t,s){return t.optionsSource==="languages"?s.languages.map(n=>({value:n.infoId,label:n.label})):t.optionsSource==="sourceKinds"?ri:[]}const Za=60,di=500;function on(t){return`cogita.info-selection:${t}`}function $s(t){if(typeof window>"u")return{};const s=window.localStorage.getItem(on(t));if(!s)return{};try{const n=JSON.parse(s);return!n||typeof n!="object"?{}:n}catch{return{}}}function ui({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,libraryId:c,mode:x}){var jt;const o=qs(),u=_a(),k=t.cogita.library.list,[Y,q]=a.useState("any"),[V,b]=a.useState(""),[h,he]=a.useState("relevance"),[F,y]=a.useState("details"),[H,E]=a.useState(!1),[J,L]=a.useState("idle"),[P,re]=a.useState([]),[ue,de]=a.useState(Za),[ze,pe]=a.useState(null),[S,xe]=a.useState(()=>$s(c)),[v,O]=a.useState({}),[ye,Q]=a.useState([]),[K,je]=a.useState(null),[Te,Ne]=a.useState(null),[Fe,Me]=a.useState(null),[Be,Ke]=a.useState("idle"),[$e,De]=a.useState([]),[et,Je]=a.useState(""),[Re,we]=a.useState(null),[Ze,He]=a.useState("idle"),[oe,Le]=a.useState(null),[Ve,Xe]=a.useState(null),[X,A]=a.useState("idle"),Z=a.useMemo(()=>ii(t),[t]),fe=a.useMemo(()=>[{value:"relevance",label:k.sortRelevance},{value:"label_asc",label:k.sortLabelAsc},{value:"label_desc",label:k.sortLabelDesc},{value:"type_asc",label:k.sortTypeAsc},{value:"type_desc",label:k.sortTypeDesc}],[k.sortLabelAsc,k.sortLabelDesc,k.sortRelevance,k.sortTypeAsc,k.sortTypeDesc]);a.useEffect(()=>{xe($s(c)),O({}),E(!1)},[c]),a.useEffect(()=>{fs({libraryId:c}).then(_=>Me(_)).catch(()=>Me({items:[]}))},[c]),a.useEffect(()=>{vn({libraryId:c}).then(_=>De(_)).catch(()=>De([]))},[c]),a.useEffect(()=>{Ts({libraryId:c,type:"language",filters:{sourceKind:"info"},limit:200}).then(_=>{const ie=_.map(Se=>({infoId:Se.infoId??"",infoType:Se.entityType,label:Se.title})).filter(Se=>Se.infoId.length>0);Q(ie)}).catch(()=>Q([]))},[c]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(on(c),JSON.stringify(S))},[c,S]);const T=a.useMemo(()=>li(Y==="any"?null:Y),[Y]),C=a.useMemo(()=>new URLSearchParams(u.search),[u.search]),G=a.useMemo(()=>u.pathname.split("/").filter(Boolean),[u.pathname]),ae=G.findIndex(_=>_==="infos"),ne=ae>=0&&(G[ae+1]??"").trim()||null,Ce=ae>=0?(G[ae+2]??"").trim()==="checkcards"?"cards":"overview":"",Ie=ne??((C.get("infoId")??"").trim()||null),Pe=ne?Ce:(C.get("infoView")??"overview").trim(),se=Pe==="overview"&&!!Ie,ge=a.useMemo(()=>({language:k.typeFilterLanguage,languageA:k.typeFilterLanguageA,languageB:k.typeFilterLanguageB,originalLanguage:k.typeFilterOriginalLanguage,doi:k.typeFilterDoi,sourceKind:k.typeFilterSourceKind,locator:k.typeFilterLocator,citationText:k.typeFilterCitationText}),[k.typeFilterDoi,k.typeFilterLanguage,k.typeFilterLanguageA,k.typeFilterLanguageB,k.typeFilterLocator,k.typeFilterOriginalLanguage,k.typeFilterCitationText,k.typeFilterSourceKind]),le=a.useMemo(()=>T.filterFields.map(_=>({..._,label:_.labelKey?ge[_.labelKey]:_.label??_.key,options:ci(_,{languages:ye})})),[ge,ye,T.filterFields]),st=a.useMemo(()=>le.some(_=>(v[_.key]??"").trim().length>0),[le,v]);a.useEffect(()=>{O({})},[Y]),a.useEffect(()=>{const _={sourceKind:"info"};if(st)for(const Se of le){const d=(v[Se.key]??"").trim();d&&(_[Se.path??Se.key]=d)}L("loading");const ie=window.setTimeout(()=>{Ts({libraryId:c,type:Y==="any"?void 0:Y,query:V.trim()||void 0,filters:_,limit:di}).then(Se=>{const d=Se.map(ke=>({infoId:ke.infoId??"",infoType:ke.entityType,label:ke.title})).filter(ke=>ke.infoId.length>0);re(d),L("ready")}).catch(()=>{re([]),L("ready")})},240);return()=>window.clearTimeout(ie)},[st,c,V,Y,le,v]),a.useEffect(()=>{if(!Ie||Pe!=="overview"){je(null),Ne(null),Ke("idle");return}let _=!1;return Ke("loading"),Promise.all([Qt({libraryId:c,infoId:Ie}),wn({libraryId:c,itemType:"info",itemId:Ie}).catch(()=>null)]).then(([ie,Se])=>{_||(je(ie),Ne(Se),Ke("ready"))}).catch(()=>{_||(je(null),Ne(null),Ke("error"))}),()=>{_=!0}},[c,Ie,Pe]),a.useEffect(()=>{if(!Ie||Pe!=="overview"){Le(null),Xe(null),A("idle");return}let _=!1;return A("loading"),Promise.all([Xs({libraryId:c,infoId:Ie}),Zs({libraryId:c,infoId:Ie})]).then(([ie,Se])=>{_||(Le(ie),Xe(Se),A("ready"))}).catch(()=>{_||(Le(null),Xe(null),A("error"))}),()=>{_=!0}},[c,Ie,Pe]);const Oe=a.useMemo(()=>K?$e.filter(_=>_.sourceInfoTypes.some(ie=>ie.toLowerCase()===K.infoType.toLowerCase())):[],[$e,K]);a.useEffect(()=>{if(!K){Je("");return}Je(_=>{var ie;return _&&Oe.some(Se=>Se.approachKey===_)?_:((ie=Oe[0])==null?void 0:ie.approachKey)??""})},[Oe,K]),a.useEffect(()=>{if(!K||!et){we(null),He("idle");return}let _=!1;return He("loading"),en({libraryId:c,infoId:K.infoId,approachKey:et}).then(ie=>{_||(we(ie),He("ready"))}).catch(()=>{_||(we(null),He("error"))}),()=>{_=!0}},[c,et,K]);const Ye=a.useMemo(()=>{const _=P.slice(),ie=Se=>qe(t,Se);return h==="relevance"?_:h==="label_asc"?_.sort((Se,d)=>Se.label.localeCompare(d.label)):h==="label_desc"?_.sort((Se,d)=>d.label.localeCompare(Se.label)):h==="type_asc"?_.sort((Se,d)=>Se.infoType===d.infoType?Se.label.localeCompare(d.label):ie(Se.infoType).localeCompare(ie(d.infoType))):_.sort((Se,d)=>Se.infoType===d.infoType?Se.label.localeCompare(d.label):ie(d.infoType).localeCompare(ie(Se.infoType)))},[t,P,h]),ct=a.useMemo(()=>Ye.slice(0,ue),[Ye,ue]),yt=ct.length<Ye.length,Ue=a.useMemo(()=>new Set(Object.keys(S)),[S]),We=a.useMemo(()=>Object.values(S),[S]),Ct=a.useMemo(()=>{const _=new Map;for(const ie of We)_.set(ie.infoType,(_.get(ie.infoType)??0)+1);return Array.from(_.entries()).sort((ie,Se)=>Se[1]-ie[1]||ie[0].localeCompare(Se[0]))},[We]),dt=a.useMemo(()=>{if(!Ie||!Fe)return 0;const _=new Set;for(const ie of Fe.items)ie.childItemType!=="info"||ie.childItemId!==Ie||_.add([ie.parentItemType,ie.parentItemId,ie.parentCheckType??"",ie.parentDirection??""].join("|"));return _.size},[Fe,Ie]);a.useEffect(()=>{de(Za);const _=new Set(P.map(ie=>ie.infoId));pe(ie=>ie&&_.has(ie)?ie:null)},[P]);const It=_=>{xe(ie=>({...ie,[_.infoId]:{infoId:_.infoId,infoType:_.infoType,label:_.label}}))},lt=_=>{xe(ie=>{if(!ie[_])return ie;const Se={...ie};return delete Se[_],Se})},rt=(_,ie)=>{if(ie){It(_);return}lt(_.infoId)},Lt=_=>{o(`/cogita/library/${c}/infos/${encodeURIComponent(_)}`,{replace:!0})},xt=()=>{o(`/cogita/library/${c}/list`,{replace:!0})},tt=()=>{Ie&&o(`/cogita/library/${c}/edit/${encodeURIComponent(Ie)}`,{replace:!0})},at=We.length===1?((jt=We[0])==null?void 0:jt.infoId)??null:null,At=k.selectionCount.replace("{count}",String(We.length)),$t=x==="collection"?"grid":x==="detail"?"wide":F,Qe=mi(R),ht=Te?Math.max(0,Math.min(100,Math.round((Te.score??0)*100))):0,pt=Te?pi(Te,Qe):Qe.noKnownnessData;return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":$t,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[se?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:Qe.kicker}),e.jsx("h2",{className:"cogita-card-title",children:K?hi(K.payload,K.infoType,K.infoId):Qe.loading}),K?e.jsxs("p",{className:"cogita-card-subtitle",children:[qe(t,K.infoType)," · ",K.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:xt,children:Qe.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:tt,disabled:!Ie||Be!=="ready",children:k.editInfo})]})]}),Be==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:Qe.loading})}):Be==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:Qe.loadError})}):K?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Qe.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[ht,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${ht}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:pt})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Qe.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(Te==null?void 0:Te.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:Qe.correct.replace("{correct}",String((Te==null?void 0:Te.correctReviews)??0)).replace("{total}",String((Te==null?void 0:Te.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:Te!=null&&Te.lastReviewedUtc?`${Qe.lastReview}: ${gi(Te.lastReviewedUtc,R)}`:Qe.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Qe.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:dt}),e.jsx("p",{className:"cogita-library-hint",children:Qe.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Qe.checkcards}),X==="loading"?e.jsx("p",{className:"cogita-library-hint",children:Qe.loadingCheckcards}):X==="error"?e.jsx("p",{className:"cogita-library-hint",children:Qe.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:Qe.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(oe==null?void 0:oe.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:Qe.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(Ve==null?void 0:Ve.items.length)??0})]})]})]}),Oe.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:Qe.approach}),e.jsx("select",{value:et,onChange:_=>Je(_.target.value),"aria-label":Qe.approach,children:Oe.map(_=>e.jsx("option",{value:_.approachKey,children:_.label},_.approachKey))})]}),Ze==="loading"?e.jsx("p",{className:"cogita-library-hint",children:Qe.loadingApproach}):Ze==="error"?e.jsx("p",{className:"cogita-library-hint",children:Qe.loadApproachError}):Re?e.jsx($a,{value:Re.projection,emptyLabel:Qe.empty}):e.jsx("p",{className:"cogita-library-hint",children:Qe.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Qe.payload}),e.jsx($a,{value:K.payload,emptyLabel:Qe.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Qe.links}),e.jsx(fi,{links:K.links,emptyLabel:Qe.noLinks})]})]})]}):null]})}):null,se?null:e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":k.typeLabel,value:Y,onChange:_=>q(_.target.value),children:Z.map(_=>e.jsx("option",{value:_.value,children:_.label},_.value))}),e.jsx("input",{type:"text",value:V,onChange:_=>b(_.target.value),placeholder:k.searchPlaceholder}),e.jsx("select",{"aria-label":k.sortLabel,value:h,onChange:_=>he(_.target.value),children:fe.map(_=>e.jsx("option",{value:_.value,children:_.label},_.value))}),e.jsxs("select",{"aria-label":k.viewLabel,value:F,onChange:_=>y(_.target.value),children:[e.jsx("option",{value:"details",children:k.viewDetails}),e.jsx("option",{value:"wide",children:k.viewWide}),e.jsx("option",{value:"grid",children:k.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:k.cardCount.replace("{shown}",String(ct.length)).replace("{total}",String(Ye.length))}),e.jsx("span",{children:J==="loading"?k.loading:k.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>E(_=>!_),children:H?k.hideFilters:k.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:k.filtersOptionalHint})]}),H&&le.length>0?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsx("div",{className:"cogita-filter-grid",children:le.map(_=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:_.label}),_.kind==="select"?e.jsxs("select",{value:v[_.key]??"",onChange:ie=>O(Se=>({...Se,[_.key]:ie.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(_.options??[]).map(ie=>e.jsx("option",{value:ie.value,children:ie.label},`${_.key}:${ie.value}`))]}):e.jsx("input",{type:"text",value:v[_.key]??"",onChange:ie=>O(Se=>({...Se,[_.key]:ie.target.value}))})]},`type-filter:${_.key}`))})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:At}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{xe(_=>{const ie={..._};for(const Se of ct)ie[Se.infoId]={infoId:Se.infoId,infoType:Se.infoType,label:Se.label};return ie})},disabled:ct.length===0,children:k.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>xe({}),disabled:We.length===0,children:k.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>at&&Lt(at),disabled:!at,title:at?void 0:k.openSelectedDisabled,children:k.openSelected})]})]}),We.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:k.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:k.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:Ct.map(([_,ie])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:qe(t,_)}),e.jsx("span",{className:"cogita-tag-count",children:ie})]},`stack:type:${_}`))})]}):null,$t==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":k.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:k.detailColumnName}),e.jsx("span",{children:k.detailColumnType}),e.jsx("span",{children:k.detailColumnId}),e.jsx("span",{})]}),ct.length?ct.map(_=>{const ie=qe(t,_.infoType),Se=Ue.has(_.infoId),d=ze===_.infoId;return e.jsxs("div",{className:`cogita-details-row ${d||Se?"active":""}`,role:"row",onClick:()=>pe(_.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:Se,onChange:ke=>rt(_,ke.target.checked),onClick:ke=>ke.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:_.label,children:_.label}),e.jsx("span",{title:ie,children:ie}),e.jsx("span",{title:_.infoId,children:_.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:ke=>{ke.stopPropagation(),Lt(_.infoId)},"aria-label":k.editInfo,children:">"})]},_.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:k.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${$t}`,"data-view":$t,children:ct.length?ct.map(_=>{const ie=qe(t,_.infoType),Se=Ue.has(_.infoId),d=ze===_.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":d||Se,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:Se,onChange:ke=>rt(_,ke.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>pe(_.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:ie}),e.jsx("h3",{className:"cogita-card-title",children:_.label}),e.jsx("p",{className:"cogita-card-subtitle",children:_.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Lt(_.infoId),children:k.editInfo})]})},_.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:k.noMatch})})}),yt?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>de(_=>_+Za),children:k.loadMore})}):null]})]})})})})}function hi(t,s,n){if(t&&typeof t=="object"&&!Array.isArray(t)){const i=t,l=["title","name","label","value","text","quote","term"];for(const p of l){const m=i[p];if(typeof m=="string"&&m.trim())return m.trim()}}return`${s} · ${n}`}function gi(t,s){try{const n=s==="pl"?"pl-PL":s==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(n,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function mi(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function pi(t,s){return t.totalReviews<=0?s.noKnownnessData:t.totalReviews<3||t.score<.35?s.developmentStart:t.totalReviews<8||t.score<.65?s.developmentGrowing:t.score<.85?s.developmentStable:s.developmentStrong}function fi({links:t,emptyLabel:s}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:s}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([n,i])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:n}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(i)?i.length?e.jsx("div",{className:"cogita-selection-overview",children:i.map(l=>e.jsx("span",{className:"cogita-tag-chip",children:l},`${n}:${l}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):i?e.jsx("span",{className:"cogita-tag-chip",children:i}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},n))})}function $a({value:t,emptyLabel:s}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:s});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((n,i)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:i+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx($a,{value:n,emptyLabel:s})})]},i))});if(typeof t=="object"){const n=Object.entries(t);return n.length===0?e.jsx("p",{className:"cogita-library-hint",children:s}):e.jsx("div",{className:"cogita-info-tree",children:n.map(([i,l])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:i}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx($a,{value:l,emptyLabel:s})})]},i))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const ta=5,Rs=50,As=2,Es=[];function aa({libraryId:t,infoType:s,label:n,placeholder:i,value:l,onChange:p,values:m,onChangeMultiple:f,helperText:R,searchFailedText:I,createFailedText:c,createLabel:x,savingLabel:o,loadMoreLabel:u,inputRef:k,autoAdvance:Y,onCommit:q,multiple:V}){const b=V?m??Es:Es,[h,he]=a.useState(V?"":(l==null?void 0:l.label)??""),[F,y]=a.useState([]),[H,E]=a.useState(ta),[J,L]=a.useState(-1),[P,re]=a.useState(!1),[ue,de]=a.useState(!1),[ze,pe]=a.useState(null),S=a.useRef(0),xe=a.useRef(new Map),v=a.useMemo(()=>V?h.trim().length>0:h.trim().length>0&&!l,[h,l,V]);a.useEffect(()=>{V||he((l==null?void 0:l.label)??"")},[l,V]),a.useEffect(()=>{const Q=h.trim();if(!Q||Q.length<As){y([]),re(!1),E(ta),L(-1),de(!1),pe(null);return}const K=Q.toLowerCase(),je=`${t}:${s}:${K}`,Te=xe.current.get(je);if(Te){if(V&&b.length>0){const Fe=new Set(b.map(Me=>Me.id));y(Te.filter(Me=>!Fe.has(Me.id)))}else y(Te);E(ta),L(-1),re(Te.length>0),de(!1),pe(null);return}const Ne=window.setTimeout(async()=>{const Fe=Date.now();S.current=Fe,de(!0),pe(null);try{const Me=await bs({libraryId:t,type:s,query:Q,limit:Rs});if(S.current!==Fe)return;const Be=Me.slice(0,Rs).map(Ke=>({id:Ke.infoId,label:Ke.label,infoType:Ke.infoType}));if(xe.current.set(je,Be),V&&b.length>0){const Ke=new Set(b.map($e=>$e.id));y(Be.filter($e=>!Ke.has($e.id)))}else y(Be);E(ta),L(-1),re(!0)}catch{if(S.current!==Fe)return;pe(I??"Search failed.")}finally{S.current===Fe&&de(!1)}},250);return()=>window.clearTimeout(Ne)},[t,s,h,b]);const O=Q=>{if(V){const K=b.some(je=>je.id===Q.id)?b:[...b,Q];f==null||f(K),he(""),re(!1),L(-1);return}p==null||p(Q),he(Q.label),re(!1),L(-1),Y&&(q==null||q())},ye=async()=>{const Q=h.trim();if(Q){de(!0),pe(null);try{const K=await tn({libraryId:t,infoType:s,payload:{label:Q}}),je={id:K.infoId,label:Q,infoType:K.infoType};if(Q.length>=As){const Te=`${t}:${s}:${Q.toLowerCase()}`,Ne=xe.current.get(Te)??[];xe.current.set(Te,[je,...Ne])}if(V){f==null||f([...b,je]),he(""),re(!1),L(-1);return}p==null||p(je),re(!1),L(-1),Y&&(q==null||q())}catch{pe(c??"Create failed.")}finally{de(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:n}),e.jsx("input",{value:h,placeholder:i,onChange:Q=>{he(Q.target.value),!V&&l&&(p==null||p(null))},onKeyDown:Q=>{if(Q.key==="ArrowDown"){if(Q.preventDefault(),!F.length)return;re(!0),L(K=>{const je=Math.min(F.length,H)-1,Te=K<0?0:Math.min(K+1,je);return Te===je&&F.length>H?(E(Ne=>Math.min(Ne+ta,F.length)),Math.min(K+1,Math.min(F.length,H+ta)-1)):Te});return}if(Q.key==="ArrowUp"){if(Q.preventDefault(),!F.length)return;re(!0),L(K=>K<=0?0:K-1);return}if(Q.key==="Enter"){if(Q.preventDefault(),J>=0&&F[J]){O(F[J]);return}if(v){ye();return}}},onFocus:()=>{F.length>0&&re(!0)},autoComplete:"off",ref:k})]}),V&&b.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:b.map(Q=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>f==null?void 0:f(b.filter(K=>K.id!==Q.id)),children:[Q.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},Q.id))}),R&&e.jsx("p",{className:"cogita-help",children:R}),ze&&e.jsx("p",{className:"cogita-error",children:ze}),P&&F.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[F.slice(0,H).map((Q,K)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":K===J,onClick:()=>O(Q),children:[e.jsx("strong",{children:Q.label}),e.jsx("span",{children:Q.infoType})]},Q.id)),H<F.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>E(Q=>Math.min(Q+ta,F.length)),children:u??"Load more"})]}),v&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:ye,disabled:ue,children:ue?o??"Saving...":x??`Create new ${s}`})]})}function bi(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function Ps(t,s){if(!t||typeof t!="object")return s;const n=t,i=[n.label,n.name,n.title,n.text,n.orcid,n.email,n.number];for(const l of i)if(typeof l=="string"&&l.trim())return l.trim();return s}function yi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,libraryId:c,editInfoId:x}){const{libraryName:o}=Wt(c),u=!!x,[k,Y]=a.useState([]),[q,V]=a.useState("word"),[b,h]=a.useState({}),[he,F]=a.useState({}),[y,H]=a.useState({}),[E,J]=a.useState({}),[L,P]=a.useState(null),[re,ue]=a.useState("idle"),de=a.useMemo(()=>k.find(v=>v.infoType===q),[q,k]),ze=a.useMemo(()=>k.map(v=>({value:v.infoType,label:qe(t,v.infoType)})),[t,k]);a.useEffect(()=>{let v=!1;return jn({libraryId:c}).then(O=>{var ye;if(!v&&(Y(O),!u)){const Q=(ye=O[0])==null?void 0:ye.infoType;Q&&V(Q)}}).catch(()=>{v||Y([])}),()=>{v=!0}},[u,c]),a.useEffect(()=>{if(!de)return;const v={},O={},ye={},Q={};for(const K of de.payloadFields)v[K.key]="";for(const K of de.linkFields)K.multiple?ye[K.key]=[]:O[K.key]=null,K.targetTypes.length>0&&(Q[K.key]=K.targetTypes[0]);h(v),F(O),H(ye),J(Q)},[de==null?void 0:de.infoType]),a.useEffect(()=>{if(!u||!x||k.length===0)return;let v=!1;return ue("loading"),P(null),(async()=>{const ye=await Qt({libraryId:c,infoId:x});if(v)return;const Q=ye.infoType;V(Q);const K=k.find($e=>$e.infoType===Q);if(!K){ue("idle");return}const je=ye.payload??{},Te={};for(const $e of K.payloadFields)Te[$e.key]=bi(je[$e.key]);h(Te);const Ne=ye.links??{}??{},Fe={},Me={},Be={},Ke=[];for(const $e of K.linkFields){$e.targetTypes.length>0&&(Be[$e.key]=$e.targetTypes[0]);const De=Ne[$e.key];if($e.multiple){const et=Array.isArray(De)?De.filter(Je=>typeof Je=="string"):[];Me[$e.key]=[];for(const Je of et)Ke.push(Qt({libraryId:c,infoId:Je}).then(Re=>{if(v)return;const we={id:Je,infoType:Re.infoType,label:Ps(Re.payload,Je)};Me[$e.key]=[...Me[$e.key],we]}).catch(()=>{}))}else{const et=typeof De=="string"?De:null;Fe[$e.key]=null,et&&Ke.push(Qt({libraryId:c,infoId:et}).then(Je=>{v||(Fe[$e.key]={id:et,infoType:Je.infoType,label:Ps(Je.payload,et)})}).catch(()=>{}))}}await Promise.all(Ke),!v&&(F(Fe),H(Me),J($e=>({...$e,...Be})),ue("idle"))})().catch(()=>{v||(P("Failed to load info details."),ue("idle"))}),()=>{v=!0}},[x,u,c,k]);const pe=async()=>{var Q;if(!de)return;const v={};for(const K of de.payloadFields){const je=(b[K.key]??"").trim();if(!je){if(K.required){P(`Field '${K.label}' is required.`);return}continue}if(K.inputType==="json")try{v[K.key]=JSON.parse(je)}catch{P(`Field '${K.label}' must be valid JSON.`);return}else v[K.key]=je}const O={};for(const K of de.linkFields)if(K.multiple){const je=(y[K.key]??[]).map(Te=>Te.id);if(K.required&&je.length===0){P(`Link '${K.label}' is required.`);return}je.length>0&&(O[K.key]=je)}else{const je=((Q=he[K.key])==null?void 0:Q.id)??null;if(K.required&&!je){P(`Link '${K.label}' is required.`);return}je&&(O[K.key]=je)}const ye=Object.keys(O).length>0;ue("saving"),P(null);try{if(u&&x)await kn({libraryId:c,infoId:x,payload:v,links:ye?O:void 0}),P("Info updated.");else{await tn({libraryId:c,infoType:q,payload:v,links:ye?O:void 0}),P("Info saved.");const K={};for(const Ne of de.payloadFields)K[Ne.key]="";h(K);const je={},Te={};for(const Ne of de.linkFields)Ne.multiple?Te[Ne.key]=[]:je[Ne.key]=null;F(Ne=>({...Ne,...je})),H(Ne=>({...Ne,...Te}))}}catch{P("Failed to save info.")}finally{ue("idle")}},S=v=>{const O=b[v.key]??"",ye=v.inputType==="textarea"||v.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:v.label}),ye?e.jsx("textarea",{rows:v.inputType==="json"?8:4,value:O,onChange:Q=>h(K=>({...K,[v.key]:Q.target.value})),placeholder:v.key}):e.jsx("input",{type:"text",value:O,onChange:Q=>h(K=>({...K,[v.key]:Q.target.value})),placeholder:v.key})]},`payload:${v.key}`)},xe=v=>{const O=E[v.key]??v.targetTypes[0];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:v.label}),v.targetTypes.length>1?e.jsx("select",{value:O,onChange:ye=>J(Q=>({...Q,[v.key]:ye.target.value})),children:v.targetTypes.map(ye=>e.jsx("option",{value:ye,children:qe(t,ye)},`${v.key}:${ye}`))}):null,v.multiple?e.jsx(aa,{libraryId:c,infoType:O,label:v.label,placeholder:v.key,multiple:!0,values:y[v.key]??[],onChangeMultiple:ye=>H(Q=>({...Q,[v.key]:ye})),searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(aa,{libraryId:c,infoType:O,label:v.label,placeholder:v.key,value:he[v.key]??null,onChange:ye=>F(Q=>({...Q,[v.key]:ye})),searchFailedText:"Search failed",createFailedText:"Create failed"})]},`link:${v.key}`)};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:u?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:o}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${c}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[u?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:q,onChange:v=>V(v.target.value),children:ze.map(v=>e.jsx("option",{value:v.value,children:v.label},v.value))})]}),re==="loading"?e.jsx("p",{children:"Loading..."}):null,de?e.jsxs("div",{className:"cogita-form-grid",children:[de.payloadFields.map(S),de.linkFields.map(xe)]}):e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:pe,disabled:re==="saving"||!de,children:re==="saving"?"Saving...":u?"Update info":"Create info"})}),L?e.jsx("p",{className:"cogita-library-subtitle",children:L}):null]})})})]})})}const Fs=t=>/\s/.test(t),Ra=t=>/[\p{L}\p{N}]/u.test(t),Ks=(t,s)=>{const n=s>0?t[s-1]:"",i=s<t.length?t[s]:"";if(!n||!i)return 0;const l=Fs(n),p=Fs(i);if(l||p)return 3;const m=Ra(n),f=Ra(i);return m!==f?2:!m&&!f?1:0},es=(t,s,n,i,l)=>{const p=Math.max(i-s,n-i);for(let m=0;m<=p;m+=1){const f=i-m;if(f>=s&&f<=n&&Ks(t,f)>=l)return f;const R=i+m;if(R>=s&&R<=n&&Ks(t,R)>=l)return R}return null},ts=(t,s)=>{const n=s>0?t[s-1]:"",i=s<t.length?t[s]:"";return!n||!i?!0:Ra(n)!==Ra(i)},xi=(t,s,n,i)=>{const l=n-s,p=s+i,m=n-i;if(l<=i*2||m<=p)return null;const f=Math.floor((s+n)/2),R=es(t,p,m,f,3);if(R!==null&&ts(t,R))return R;const I=es(t,p,m,f,2);if(I!==null&&ts(t,I))return I;const c=es(t,p,m,f,1);return c!==null&&ts(t,c)?c:null},sa=(t,s)=>{const n=Math.max(1,7),i=Math.max(n,13),l={},p=(R,I,c,x,o)=>{const u=String(x),k={id:u,start:R,end:I,text:t.slice(R,I),depth:c,index:x,parentId:o};if(l[u]=k,I-R>i){let q=xi(t,R,I,n);if(q!==null&&q>R&&q<I){const V=p(R,q,c+1,x*2+1,u),b=p(q,I,c+1,x*2+2,u);k.leftId=V.id,k.rightId=b.id}}return k},m=p(0,t.length,0,0),f=Object.values(l).sort((R,I)=>I.depth-R.depth||R.start-I.start).map(R=>R.id);return{text:t,rootId:m.id,nodes:l,order:f}},ua=(t,s,n,i,l,p,m)=>{const f=p==="reverse"?t.order.slice().sort((R,I)=>t.nodes[I].start-t.nodes[R].start||t.nodes[I].depth-t.nodes[R].depth):t.order;for(const R of f){if(m&&R===m||s.has(R))continue;const I=t.nodes[R];if(I){if(l&&(I.leftId||I.rightId)){const c=I.leftId?n[I.leftId]??0:i,x=I.rightId?n[I.rightId]??0:i;if((c+x)/2<i)continue}return I}}return null},ys=(t,s)=>({before:t.slice(0,s.start),fragment:t.slice(s.start,s.end),after:t.slice(s.end)});function vi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,libraryId:c}){const x=`/#/cogita/library/${c}`,[o,u,k]=Us([]),[Y,q,V]=Ws([]),[b,h]=a.useState(null),[he,F]=a.useState(null),[y,H]=a.useState(null),[E,J]=a.useState(null),L=a.useMemo(()=>o.find(S=>S.id===b)??null,[o,b]);a.useEffect(()=>{let S=!0;return Nn({libraryId:c}).then(xe=>{if(!S)return;const v=xe.nodes.map(O=>{var ye,Q,K;return{id:O.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:O.payload&&typeof O.payload=="object"&&"label"in O.payload?String(O.payload.label):"Item",nodeType:O.nodeType,itemType:((ye=O.payload)==null?void 0:ye.itemType)??"info",itemId:((Q=O.payload)==null?void 0:Q.itemId)??null,infoType:((K=O.payload)==null?void 0:K.infoType)??null}}});u(v),q(xe.edges.map(O=>({id:O.edgeId,source:O.fromNodeId,target:O.toNodeId})))}).catch(()=>{S&&(u([]),q([]))}),()=>{S=!1}},[c]),a.useEffect(()=>{Sn({libraryId:c}).then(F).catch(()=>F(null))},[c,o,Y]);const P=a.useCallback(S=>{q(xe=>Hs(S,xe))},[]),re=()=>{const S=crypto.randomUUID();u(xe=>[...xe,{id:S,type:"default",position:{x:140+xe.length*40,y:120+xe.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},ue=()=>{const S=crypto.randomUUID();u(xe=>[...xe,{id:S,type:"default",position:{x:180+xe.length*40,y:160+xe.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},de=async()=>{H(null);try{const S=o.map(v=>({nodeId:v.id,nodeType:v.data.nodeType,payload:{itemType:v.data.itemType,itemId:v.data.itemId??null,label:v.data.label,infoType:v.data.infoType??null}})),xe=Y.map(v=>({edgeId:v.id,fromNodeId:v.source,toNodeId:v.target}));await Tn({libraryId:c,nodes:S,edges:xe}),H(t.cogita.library.graph.saveSuccess)}catch{H(t.cogita.library.graph.saveFail)}},ze=S=>{L&&u(xe=>xe.map(v=>v.id===L.id?{...v,data:{...v.data,itemId:(S==null?void 0:S.infoId)??null,itemType:"collection",infoType:"collection",label:(S==null?void 0:S.label)??t.cogita.library.infoTypes.collection}}:v))},pe=S=>{L&&u(xe=>xe.map(v=>v.id===L.id?{...v,data:{...v.data,itemId:(S==null?void 0:S.infoId)??null,itemType:"info",infoType:(S==null?void 0:S.infoType)??null,label:(S==null?void 0:S.label)??t.cogita.library.infoTypes.any}}:v))};return a.useEffect(()=>{if(!L||L.data.nodeType!=="info"||L.data.infoType!=="citation"||!L.data.itemId){J(null);return}let S=!0;return Qt({libraryId:c,infoId:L.data.itemId}).then(xe=>{if(!S)return;const v=xe.payload,O=(v==null?void 0:v.text)??"";if(!O){J(null);return}const ye=sa(O),Q=Object.values(ye.nodes).sort((K,je)=>K.depth-je.depth||K.start-je.start).map(K=>({id:K.id,text:K.text,depth:K.depth}));J({title:(v==null?void 0:v.title)??L.data.label,fragments:Q})}).catch(()=>J(null)),()=>{S=!1}},[c,L]),e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:x,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:de,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:re,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ue,children:t.cogita.library.actions.addInfo}),he?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(he.totalCollections))})}):null,y?e.jsx("p",{className:"cogita-help",children:y}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(gs,{nodes:o,edges:Y,onNodesChange:k,onEdgesChange:V,onConnect:P,onNodeClick:(S,xe)=>h(xe.id),fitView:!0,children:[e.jsx(ms,{gap:18,size:1}),e.jsx(ps,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),L?e.jsxs("div",{className:"cogita-graph-inspector",children:[L.data.nodeType==="collection"?e.jsx(aa,{libraryId:c,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:L.data.itemId?{id:L.data.itemId,label:L.data.label,infoType:"collection"}:null,onChange:ze,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(aa,{libraryId:c,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:L.data.itemId?{id:L.data.itemId,label:L.data.label,infoType:L.data.infoType??void 0}:null,onChange:pe,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),E?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:E.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:E.fragments.map(S=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:S.id}),e.jsx("span",{children:S.text})]},S.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function xs({children:t,flashState:s,flashTick:n=0,feedbackToken:i,className:l}){const p=i??(s?`${s}-${n}`:"idle");return e.jsx("section",{className:l?`cogita-revision-card ${l}`:"cogita-revision-card","data-feedback":p,children:t})}function vs({copy:t,currentCard:s,currentTypeLabel:n,prompt:i,languages:l,answer:p,onAnswerChange:m,computedExpected:f,computedAnswers:R,onComputedAnswerChange:I,answerTemplate:c,outputVariables:x,variableValues:o,computedFieldFeedback:u,feedback:k,canAdvance:Y,quoteContext:q,quotePlaceholder:V,onCheckAnswer:b,onSkip:h,onLanguageSelect:he,onMarkReviewed:F,onAdvance:y,showCorrectAnswer:H,setShowCorrectAnswer:E,onRevealCorrect:J,answerMask:L,expectedAnswer:P,hasExpectedAnswer:re,handleComputedKeyDown:ue,answerInputRef:de,computedInputRefs:ze,scriptMode:pe,setScriptMode:S,matchPairs:xe,matchLeftOrder:v,matchRightOrder:O,matchSelection:ye,matchActiveLeft:Q,matchActiveRight:K,matchFeedback:je,onMatchLeftSelect:Te,onMatchRightSelect:Ne,disableCheckAnswer:Fe=!1,hideSkipAction:Me=!1,allowRevealBeforeCheck:Be=!1,autoRevealAfterAnswer:Ke=!1,disableCheckAfterAnswer:$e=!1}){const De=a.useMemo(()=>{var Pe;const X=!c&&f.length===2?`The {${f[0].key}} is of type {${f[1].key}}`:null,A=c??X;if(!A)return null;const Z=new Map(f.map(se=>[se.key,se.expected])),fe=new Set,T=[],C=/\{([^}]+)\}/g;let G=0,ae,ne=null;for(;(ae=C.exec(A))!==null;){const se=A.slice(G,ae.index);se&&T.push({type:"text",value:se});const ge=((Pe=ae[1])==null?void 0:Pe.trim())??"",le=ge&&Z.has(ge)?ge:ge&&x&&x[ge]?x[ge]:null;ge&&fe.add(ge),le&&fe.add(le),le&&Z.has(le)?(T.push({type:"input",value:le}),ne||(ne=le)):ge&&o&&o[ge]!==void 0?T.push({type:"text",value:o[ge]}):T.push({type:"text",value:ae[0]}),G=ae.index+ae[0].length}const Ce=A.slice(G);return Ce&&T.push({type:"text",value:Ce}),f.filter(se=>!fe.has(se.key)).length>0?null:{parts:T,expectedByKey:Z,firstInputKey:ne}},[c,f,x,o]),et=()=>{if(!De)return null;const{parts:X,expectedByKey:A,firstInputKey:Z}=De;return e.jsx("div",{className:"cogita-revision-inline-answer",children:X.map((fe,T)=>{var C,G;return fe.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:fe.value},`text-${T}`):e.jsx("input",{ref:ae=>{ze.current[fe.value]=ae},autoFocus:fe.value===Z,value:R[fe.value]??"",onChange:ae=>I(fe.value,ae.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":u[fe.value]??(k==="correct"?"correct":k==="incorrect"?"incorrect":void 0),onKeyDown:ae=>Ze(ae)||ue(ae),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((C=R[fe.value])==null?void 0:C.length)??0,((G=A.get(fe.value))==null?void 0:G.length)??6)}ch`}},`input-${fe.value}-${T}`)})})},Je=a.useMemo(()=>{const X=new Map;return(xe??[]).forEach(A=>X.set(A.leftId,A)),X},[xe]),Re=a.useMemo(()=>{const X=new Map;return(xe??[]).forEach(A=>X.set(A.rightId,A)),X},[xe]);a.useEffect(()=>{var T;if(s.cardType!=="info"||s.infoType!=="computed"||f.length===0)return;const X=typeof document<"u"?document.activeElement:null;if(X&&(X.tagName==="INPUT"||X.tagName==="TEXTAREA"))return;const A=(De==null?void 0:De.firstInputKey)??((T=f[0])==null?void 0:T.key);if(!A)return;const Z=ze.current[A];if(!Z)return;const fe=requestAnimationFrame(()=>{Z.focus()});return()=>cancelAnimationFrame(fe)},[s,f,De]);const we=(()=>{const X=[P??"",...f.map(fe=>fe.expected??"")].join(""),A=[p,...Object.values(R)].join(""),Z=`${X}${A}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(Z)})(),Ze=X=>X.ctrlKey&&(X.key==="^"||X.key==="6")?(X.preventDefault(),S(A=>A==="super"?null:"super"),!0):X.ctrlKey&&(X.key==="_"||X.key==="-")?(X.preventDefault(),S(A=>A==="sub"?null:"sub"),!0):!1,He=()=>{if(!P||!L)return P??"";const X=P.split(""),A=Array.from(L),Z=A.length>0?A.reduce((fe,T)=>fe+T,0)/A.length:127;return X.map((fe,T)=>{const C=A[T]??Z,G=Math.max(0,Math.min(255,Math.round(C)));let ae=255,ne=0;return G<=127?ne=Math.round(G/127*255):(ne=255,ae=Math.round(255*(1-(G-127)/128))),e.jsx("span",{style:{color:`rgb(${ae}, ${ne}, 0)`},children:fe},`mask-${T}`)})},oe=s.cardType==="info"&&s.infoType==="citation"?(q==null?void 0:q.title)||s.label:s.description,Le=H||Ke&&k!==null,Ve=Fe||$e&&(k!==null||Le),Xe=re&&(Be||k==="incorrect"||Le);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[n?e.jsx("span",{children:n}):null,e.jsx("strong",{children:oe})]}),s.cardType==="vocab"&&s.checkType==="translation-match"&&xe?e.jsxs("div",{className:"cogita-revision-body",children:[i?e.jsx("h2",{children:i}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(v??[]).map(X=>{const A=Je.get(X);if(!A)return null;const Z=(ye==null?void 0:ye[X])??null,fe=(je==null?void 0:je[X])??null,T=Q===X;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":T,"data-state":fe??void 0,"data-locked":Z?"true":void 0,onClick:()=>Te==null?void 0:Te(X),children:[e.jsx("span",{children:A.leftLabel}),Z&&H?e.jsx("em",{children:"✓"}):null]},X)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(O??[]).map(X=>{const A=Re.get(X);if(!A)return null;const Z=Object.values(ye??{}).includes(X),fe=K===X;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":Z||fe,"data-locked":Z?"true":void 0,onClick:()=>Ne==null?void 0:Ne(X),children:e.jsx("span",{children:A.rightLabel})},X)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:b,disabled:s.checkType==="translation-match"||Ve,children:t.cogita.library.revision.checkAnswer}),Me?null:e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):s.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:de,value:p,onChange:X=>m(X.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":k==="correct"?"correct":k==="incorrect"?"incorrect":void 0,onKeyDown:X=>{if(X.key==="Enter")if(X.preventDefault(),X.stopPropagation(),Y)y();else{if(Ve)return;b()}}})]}),we?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":pe==="super",onClick:()=>S(X=>X==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":pe==="sub",onClick:()=>S(X=>X==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:b,disabled:Ve,children:t.cogita.library.revision.checkAnswer}),Me?null:e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[s.label?e.jsx("p",{className:"cogita-revision-hint",children:s.label}):null,c?null:e.jsx(Cn,{value:i??"",mode:"auto"}),f.length>0?(()=>{const X=et();return X?e.jsx("div",{className:"cogita-inline-answer-wrap",children:X}):e.jsx("div",{className:"cogita-form-grid",children:f.map((A,Z)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:A.key}),e.jsx("textarea",{ref:fe=>{ze.current[A.key]=fe},autoFocus:Z===0,value:R[A.key]??"",onChange:fe=>I(A.key,fe.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":u[A.key]??(k==="correct"?"correct":k==="incorrect"?"incorrect":void 0),onKeyDown:fe=>Ze(fe)||ue(fe)})]},A.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:de,value:p,onChange:X=>m(X.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":k==="correct"?"correct":k==="incorrect"?"incorrect":void 0,onKeyDown:X=>{if(!Ze(X)&&X.key==="Enter")if(X.preventDefault(),X.stopPropagation(),Y)y();else{if(Ve)return;b()}}})]})}),we?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":pe==="super",onClick:()=>S(X=>X==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":pe==="sub",onClick:()=>S(X=>X==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:b,disabled:Ve,children:t.cogita.library.revision.checkAnswer}),Me?null:e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="citation"&&q?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(q.completed)).replace("{total}",String(q.total))}),e.jsx("p",{className:"cogita-quote-text",children:q.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:de,value:p,onChange:X=>m(X.target.value),placeholder:V??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":k==="correct"?"correct":k==="incorrect"?"incorrect":void 0,onKeyDown:X=>{if(X.key==="Enter")if(X.preventDefault(),X.stopPropagation(),Y)y();else{if(Ve)return;b()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:q.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:b,disabled:Ve,children:t.cogita.library.revision.checkAnswer}),Me?null:e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:l.length?l.map(X=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>he(X.label),children:X.label},X.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:F,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:h,children:t.cogita.library.revision.skip})]})]}),k&&e.jsx("div",{className:"cogita-revision-feedback","data-state":k,children:k==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),Xe?e.jsxs("div",{className:"cogita-revision-reveal",children:[Le?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>E(X=>{const A=!X;return A&&J(),A}),children:t.cogita.library.revision.showAnswer}),Le?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),f.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[f.map(X=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:X.key}),e.jsx("span",{children:X.expected})]},X.key)),P?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:P})]}):null]}):e.jsx("p",{children:L?He():P})]}):null]}):null,Y?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:y,children:t.cogita.library.revision.nextQuestion})}):null]})}const zs={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},wi=(t,s)=>{const n=Math.max(t.length,s.length,1),i=Math.abs(t.length-s.length);return Math.max(0,1-i/n)},ji=(t,s)=>{const n=new Uint8Array(t.length),i=wi(t,s);for(let l=0;l<t.length;l+=1){const p=t[l]===(s[l]??"")?128:0,m=t.length-1-l,f=s.length-1-l,R=t[m]===(s[f]??"")?127:0,I=Math.round((p+R)*i);n[l]=Math.max(0,Math.min(255,I))}return n},ki=(t,s)=>t===s||(zs[t]??[]).includes(s)?!0:(zs[s]??[]).includes(t),Ma=(t,s,n)=>n?ki(t,s):t===s,Aa=(t,s,n)=>{const i=new Uint8Array(t.length);if(!t.length)return i;const l=(n==null?void 0:n.allowSimilarChars)??!0,p=[];for(let f=0;f<=t.length-3;f+=1)p.push({index:f,text:t.slice(f,f+3)});let m=!1;return p.forEach(f=>{for(let R=0;R<=s.length-3;R+=1){const I=s.slice(R,R+3);let c=0;for(let Y=0;Y<3;Y+=1)Ma(f.text[Y],I[Y],l)&&(c+=1);if(c<2)continue;let x=f.index-1,o=R-1;for(;x>=0&&o>=0;){const Y=t[x],q=s[o];if(Y===q){i[x]=Math.max(i[x],255),x-=1,o-=1,m=!0;continue}if(Ma(Y,q,l)&&Y!==q){i[x]=Math.max(i[x],127),x-=1,o-=1,m=!0;continue}if(x>0&&t[x-1]===q){i[x]=Math.max(i[x],0),x-=1,m=!0;continue}if(o>0&&t[x]===s[o-1]){o-=1,m=!0;continue}break}for(let Y=0;Y<3;Y+=1){const q=f.index+Y,V=f.text[Y],b=I[Y],h=V===b?255:Ma(V,b,l)?127:0;i[q]=Math.max(i[q],h),m=!0}let u=f.index+3,k=R+3;for(;u<t.length&&k<s.length;){const Y=t[u],q=s[k];if(Y===q){i[u]=Math.max(i[u],255),u+=1,k+=1,m=!0;continue}if(Ma(Y,q,l)&&Y!==q){i[u]=Math.max(i[u],127),u+=1,k+=1,m=!0;continue}if(u+1<t.length&&t[u+1]===q){i[u]=Math.max(i[u],0),u+=1,m=!0;continue}if(k+1<s.length&&t[u]===s[k+1]){k+=1,m=!0;continue}break}}}),m?i:ji(t,s)},as=t=>/[\p{L}\p{N}]/u.test(t),Ds=t=>t.trim().toLowerCase(),Gt=(t,s)=>{if(t.length===0)return 100;const n=(s==null?void 0:s.treatSimilarCharsAsSame)??!1,i=Array.from(t).reduce((l,p)=>n&&p===127?l+255:l+p,0);return Math.round(i/(t.length*255)*100)},Ea=(t,s,n)=>{const i=Math.max(0,Math.min(100,(n==null?void 0:n.thresholdPercent)??100)),l=(n==null?void 0:n.treatSimilarCharsAsSame)??!0,p=(n==null?void 0:n.ignorePunctuationAndSpacing)??!1,m=Ds(t),f=Ds(s);if(!p){const b=Aa(m,f,{allowSimilarChars:l}),h=Gt(b,{treatSimilarCharsAsSame:l});return{mask:b,percent:h,isCorrect:h>=i,normalizedExpected:m,normalizedAnswer:f}}const R=Array.from(m),I=Array.from(f),c=[],x=[],o=[];R.forEach((b,h)=>{as(b)&&(c.push(b),x.push(h))}),I.forEach(b=>{as(b)&&o.push(b)});const u=c.join(""),k=o.join(""),Y=Aa(u,k,{allowSimilarChars:l}),q=new Uint8Array(R.length);for(let b=0;b<q.length;b+=1)q[b]=as(R[b]??"")?0:255;for(let b=0;b<Y.length;b+=1){const h=x[b];h!==void 0&&(q[h]=Y[b])}const V=Gt(Y,{treatSimilarCharsAsSame:l});return{mask:q,percent:V,isCorrect:V>=i,normalizedExpected:u,normalizedAnswer:k}},ha=(t,s,n)=>{const i=t.trim().toLowerCase(),l=s.trim().toLowerCase();return n==="prefix"||n==="bidirectional"?Aa(i,l,{allowSimilarChars:!0}):Aa(i,l,{allowSimilarChars:!0})};function _t(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function Bs(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function _s(t){const s=t.checkType??"info";return t.direction?`${s} / ${t.direction}`:s}function Ni({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,libraryId:c,infoId:x,selectedReviewerRoleId:o}){const[u,k]=a.useState(x),[Y,q]=a.useState([]),[V,b]=a.useState([]),[h,he]=a.useState("loading"),[F,y]=a.useState(null),[H,E]=a.useState(null),[J,L]=a.useState(null),[P,re]=a.useState(null),[ue,de]=a.useState(""),[ze,pe]=a.useState(null),[S,xe]=a.useState(1),[v,O]=a.useState(null),[ye,Q]=a.useState(0),[K,je]=a.useState(!1),[Te,Ne]=a.useState(null),[Fe,Me]=a.useState({}),[Be,Ke]=a.useState({}),[$e]=a.useState({}),[De,et]=a.useState(null),Je=a.useRef(null),Re=a.useRef({});a.useEffect(()=>{let C=!1;return he("loading"),Promise.all([Qt({libraryId:c,infoId:x}).catch(()=>null),Xs({libraryId:c,infoId:x}),Zs({libraryId:c,infoId:x})]).then(([G,ae,ne])=>{if(C)return;const Ce=(G==null?void 0:G.payload)??{},Ie=typeof Ce.title=="string"&&Ce.title||typeof Ce.label=="string"&&Ce.label||typeof Ce.name=="string"&&Ce.name||x;k(Ie),E(Ce),L((G==null?void 0:G.infoType)??null),q(ae.items),b(ne.items),he("ready")}).catch(()=>{C||(E(null),L(null),q([]),b([]),he("error"))}),()=>{C=!0}},[c,x]),a.useEffect(()=>{if(J!=="translation"){re(null);return}en({libraryId:c,infoId:x,approachKey:"vocab-card"}).then(C=>re(C.projection??null)).catch(()=>re(null))},[J,x,c]);const we=a.useMemo(()=>{var Pe;const C=new Map(Y.map(se=>[_t(se),se])),G=new Map,ae=new Map;for(const se of Y)G.set(_t(se),0),ae.set(_t(se),[]);for(const se of V){const ge=Bs({parentItemId:se.parentItemId,parentCheckType:se.parentCheckType,parentDirection:se.parentDirection}),le=[se.childItemId,se.childCheckType??"",se.childDirection??""].join("|");!C.has(ge)||!C.has(le)||((Pe=ae.get(ge))==null||Pe.push(le),G.set(le,(G.get(le)??0)+1))}const ne=Array.from(G.entries()).filter(([,se])=>se===0).map(([se])=>se),Ce=new Map;for(const se of ne)Ce.set(se,0);for(;ne.length;){const se=ne.shift(),ge=Ce.get(se)??0;for(const le of ae.get(se)??[]){const st=Math.max(Ce.get(le)??0,ge+1);Ce.set(le,st),G.set(le,(G.get(le)??1)-1),(G.get(le)??0)<=0&&ne.push(le)}}const Ie=new Map;for(const se of Y){const ge=_t(se),le=Ce.get(ge)??0,st=Ie.get(le)??[];st.push(ge),Ie.set(le,st)}return Y.map(se=>{const ge=_t(se),le=Ce.get(ge)??0,st=Ie.get(le)??[ge],Oe=Math.max(0,st.indexOf(ge));return{id:ge,position:{x:40+Oe*290+(le%2?18:0),y:30+le*120},draggable:!1,selectable:!0,data:{label:se.label,subtitle:_s(se),checkType:se.checkType??"info",direction:se.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[Y,V]),Ze=a.useMemo(()=>new Map(Y.map(C=>[_t(C),C])),[Y]),He=a.useMemo(()=>{const C=[];for(const G of V){const ae=Bs({parentItemId:G.parentItemId,parentCheckType:G.parentCheckType,parentDirection:G.parentDirection}),ne=[G.childItemId,G.childCheckType??"",G.childDirection??""].join("|");!Ze.has(ae)||!Ze.has(ne)||C.push({id:`${ae}->${ne}`,source:ae,target:ne,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return C},[Ze,V]),oe=a.useMemo(()=>F?Ze.get(F)??null:null,[Ze,F]);a.useEffect(()=>{de(""),O(null),Q(0),je(!1),Ne(null),pe(null),Ke({})},[F]);const Le=a.useMemo(()=>{var Ce,Ie;if(!oe)return null;const C=J??oe.infoType??null,G=oe.checkType??"info",ae=oe.direction??null,ne=H??{};if(oe.cardType==="vocab"&&P&&Array.isArray(P.words)){const Pe=P.words,se=((Ce=Pe[0])==null?void 0:Ce.label)??"?",ge=((Ie=Pe[1])==null?void 0:Ie.label)??"?";return ae==="a-to-b"?{kind:"vocab",prompt:String(se),expected:String(ge)}:ae==="b-to-a"?{kind:"vocab",prompt:String(ge),expected:String(se)}:{kind:"generic",prompt:`${se} ↔ ${ge}`,expected:`${se} ↔ ${ge}`}}if(C==="citation"&&G==="quote-fragment"&&ae&&typeof ne.text=="string"){const Pe=ae,se=sa(ne.text),ge=se.nodes[Pe];if(ge){const le=ys(ne.text,ge);return{kind:"citation-fragment",expected:ge.text,quoteContext:{title:u,before:le.before,after:le.after,total:Object.keys(se.nodes).length,completed:0},quotePlaceholder:ge.text.length>0?".".repeat(Math.max(4,Math.min(18,ge.text.length))):"..."}}}return{kind:"generic",prompt:oe.description||oe.label,expected:oe.label}},[J,H,oe,u,P]),Ve=async C=>{if(oe&&o)try{await Mn({libraryId:c,outcome:{itemType:"info",itemId:oe.cardId,checkType:oe.checkType??"info",direction:oe.direction??null,revisionType:"direct",evalType:"direct-check",correct:C,clientId:"cogita-info-checkcards",clientSequence:S,personRoleId:o}}),xe(G=>G+1),pe(C?"Saved as correct.":"Saved as incorrect.")}catch{pe("Failed to save answer.")}},Xe=oe?_t(oe):null,X=Xe?!!Fe[Xe]:!1,A=async()=>{if(!oe||!Le)return;const C=_t(oe);if(Fe[C]){pe("This card was already checked.");return}const G=Le.expected,ae=Le.kind==="citation-fragment",ne=Ea(G,ue,{thresholdPercent:ae?90:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:ae}),Ce=ne.isCorrect;O(Ce?"correct":"incorrect"),Q(Ie=>Ie+1),Ne(ne.mask),je(!0),pe(o?null:"Answer checked locally (not saved: no person selected)."),Me(Ie=>({...Ie,[C]:!0})),o&&await Ve(Ce)},Z=()=>{if(!oe||!Le)return;const C=_t(oe);Fe[C]||(Me(ae=>({...ae,[C]:!0})),pe("Answer revealed (not saved)."));const G=Ea(Le.expected,Le.expected,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:Le.kind==="citation-fragment"});Ne(G.mask)},fe=a.useMemo(()=>oe?oe.infoType==="citation"?{...oe,description:u}:{...oe,description:oe.label}:null,[oe,u]),T=a.useMemo(()=>J?qe(t,J):t.cogita.library.infoTypes.any,[t,J]);return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:T}),e.jsx("h2",{className:"cogita-card-title",children:u}),e.jsx("p",{className:"cogita-card-subtitle",children:x})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${Y.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${V.length}`})]})]}),h==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):h==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(gs,{nodes:we,edges:He,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:(C,G)=>y(G.id),panOnDrag:!0,children:[e.jsx(ms,{}),e.jsx(ps,{showInteractive:!1})]})}),oe?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[Le&&fe?e.jsx(xs,{flashState:v,flashTick:ye,children:e.jsx(vs,{copy:t,currentCard:fe,currentTypeLabel:"",prompt:Le.kind==="citation-fragment"?null:Le.prompt,languages:[],answer:ue,onAnswerChange:de,computedExpected:[],computedAnswers:Be,onComputedAnswerChange:(C,G)=>Ke(ae=>({...ae,[C]:G})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:$e,feedback:v,canAdvance:!1,quoteContext:Le.kind==="citation-fragment"?Le.quoteContext:null,quotePlaceholder:Le.kind==="citation-fragment"?Le.quotePlaceholder:null,onCheckAnswer:()=>void A(),onSkip:()=>y(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:K,setShowCorrectAnswer:je,onRevealCorrect:Z,answerMask:Te,expectedAnswer:Le.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:Je,computedInputRefs:Re,scriptMode:De,setScriptMode:et,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:X||K,hideSkipAction:!0,allowRevealBeforeCheck:!0,autoRevealAfterAnswer:!0,disableCheckAfterAnswer:!0})}):null,o?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),ze?e.jsx("p",{className:"cogita-library-hint",children:ze}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:Y.map(C=>{const G=_t(C),ae=F===G;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${ae?"active":""}`,onClick:()=>y(G),children:[e.jsx("span",{children:C.label}),e.jsx("small",{children:_s(C)})]},G)})})]})]})]})})})})})}function Si({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,libraryId:c,collectionId:x}){const{libraryName:o}=Wt(c),[u,k]=a.useState([]),[Y,q]=a.useState("loading"),[V,b]=a.useState("idle"),h=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),he=`/#/cogita/library/${c}`,F=()=>{q("loading"),an({libraryId:c}).then(E=>{k(E),q("idle")}).catch(()=>{k([]),q("error")})};a.useEffect(()=>{F()},[c]);const y=async E=>{try{await sn({libraryId:c,shareId:E}),F()}catch{F()}},H=async E=>{const J=`${h}/${E}`;try{await navigator.clipboard.writeText(J),b("copied")}catch{b("failed")}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:o}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:he,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${he}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Y==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):Y==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):u.filter(E=>!x||E.collectionId===x).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:u.filter(E=>!x||E.collectionId===x).map(E=>e.jsxs("div",{className:"cogita-share-row","data-state":E.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:E.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(E.createdUtc).toLocaleString(),E.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),E.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${h}/${E.shareCode}`}):null]}),E.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[E.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>H(E.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>y(E.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},E.shareId))}),V==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):V==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function Ti({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,libraryId:c}){const{libraryName:x}=Wt(c),[o,u]=a.useState(null),[k,Y]=a.useState(null),[q,V]=a.useState(null),[b,h]=a.useState(null),[he,F]=a.useState(null),[y,H]=a.useState(null),E=a.useRef(null),J=re=>{if(!Number.isFinite(re))return"0 B";if(re<1024)return`${re} B`;const ue=re/1024;if(ue<1024)return`${ue.toFixed(1)} KB`;const de=ue/1024;return de<1024?`${de.toFixed(1)} MB`:`${(de/1024).toFixed(1)} GB`},L=async()=>{u(null),F({loadedBytes:0,totalBytes:null,percent:null});try{u(t.cogita.library.overview.exporting);const re=await In(c,F),ue=URL.createObjectURL(re),de=document.createElement("a");de.href=ue,de.download=`cogita-library-${x||c}.json`,de.click(),URL.revokeObjectURL(ue),u(t.cogita.library.overview.exportReady)}catch{u(t.cogita.library.overview.exportFail)}finally{F(re=>re??{loadedBytes:0,totalBytes:null,percent:null})}},P=async re=>{var de;Y(null),V(null),h(null);const ue=(de=re.target.files)==null?void 0:de[0];if(ue)try{Y(t.cogita.library.overview.importing),H({loadedBytes:0,totalBytes:ue.size,percent:0});const ze=await Ln(c,ue,H,pe=>{const S=pe.stage==="infos"?t.cogita.library.overview.importStageInfos:pe.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;h(t.cogita.library.overview.importLiveProgress.replace("{stage}",S).replace("{done}",String(pe.processed)).replace("{total}",String(pe.total)).replace("{infos}",String(pe.infos)).replace("{connections}",String(pe.connections)).replace("{collections}",String(pe.collections)))});V({infos:ze.infosImported,connections:ze.connectionsImported,collections:ze.collectionsImported}),Y(t.cogita.library.overview.importDone)}catch(ze){const pe=ze instanceof $n&&ze.message?` ${ze.message}`:"";Y(`${t.cogita.library.overview.importFail}${pe}`)}finally{E.current&&(E.current.value="")}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:L,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:E,type:"file",accept:"application/json",onChange:P})]})]}),he?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:he.percent??void 0,max:he.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",J(he.loadedBytes)).replace("{total}",he.totalBytes?J(he.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,y?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:y.percent??void 0,max:y.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",J(y.loadedBytes)).replace("{total}",y.totalBytes?J(y.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,o?e.jsx("p",{className:"cogita-help",children:o}):null,k?e.jsx("p",{className:"cogita-help",children:k}):null,b?e.jsx("p",{className:"cogita-help",children:b}):null,q?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(q.infos)).replace("{connections}",String(q.connections)).replace("{collections}",String(q.collections))}):null]})]})})})]})})}function Ci({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,libraryId:c}){const{libraryName:x}=Wt(c),[o,u]=a.useState(""),[k,Y]=a.useState([]),q=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:o,onChange:V=>u(V.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const V=o.trim();V&&(Y(b=>[{id:q(),name:V},...b]),u(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[k.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,k.map(V=>e.jsx("button",{type:"button",className:"ghost",children:V.name},V.id))]})]})]})})})]})})}function Mi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,libraryId:c}){const{libraryName:x}=Wt(c),[o,u]=a.useState(""),[k,Y]=a.useState([]),q=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:o,onChange:V=>u(V.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const V=o.trim();V&&(Y(b=>[{id:q(),name:V},...b]),u(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[k.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,k.map(V=>e.jsx("button",{type:"button",className:"ghost",children:V.name},V.id))]})]})]})})})]})})}function Vs({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,libraryId:c}){const{libraryName:x}=Wt(c),o=`/#/cogita/library/${c}`,[u,k]=a.useState(""),[Y,q]=a.useState([]),[V,b]=a.useState("idle"),[h,he]=a.useState(0),[F,y]=a.useState(null);a.useEffect(()=>{b("loading");const E=window.setTimeout(()=>{va({libraryId:c,query:u.trim()||void 0,limit:30}).then(J=>{q(J.items),he(J.total),y(J.nextCursor??null),b("ready")}).catch(()=>{q([]),he(0),y(null),b("ready")})},240);return()=>window.clearTimeout(E)},[c,u]);const H=async()=>{if(F){b("loading");try{const E=await va({libraryId:c,query:u.trim()||void 0,limit:30,cursor:F});q(J=>[...J,...E.items]),y(E.nextCursor??null),he(E.total),b("ready")}catch{b("ready")}}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:x}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:o,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${o}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:u,onChange:E=>k(E.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(Y.length)).replace("{total}",String(h||Y.length))}),e.jsx("span",{children:V==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:Y.length?Y.map(E=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${o}/collections/${E.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:E.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(E.itemCount))," ·"," ",E.notes||t.cogita.library.collections.noNotes]})]})},E.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${o}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),F?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:H,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const me=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,Vt=(t,s,n,i)=>`${t}:${s}:${n??""}:${i??""}`;function Ii({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,libraryId:c,collectionId:x}){Wt(c);const o=`/#/cogita/library/${c}`,[u,k]=a.useState(t.cogita.library.collections.defaultName),[Y,q]=a.useState(null),[V,b]=a.useState(0),[h,he]=a.useState([]),[F,y]=a.useState("idle"),[H,E]=a.useState(null),J=a.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(h.length)).replace("{total}",String(V||h.length)),[t,h.length,V]);a.useEffect(()=>{Va(c,x).then(P=>{k(P.name),q(P.notes??null),b(P.itemCount)}).catch(()=>{k(t.cogita.library.collections.defaultName),q(null)})},[c,x]),a.useEffect(()=>{y("loading"),La({libraryId:c,collectionId:x,limit:40}).then(P=>{he(P.items),E(P.nextCursor??null),b(P.total),y("ready")}).catch(()=>{he([]),E(null),y("ready")})},[c,x]);const L=async()=>{if(H){y("loading");try{const P=await La({libraryId:c,collectionId:x,limit:40,cursor:H});he(re=>[...re,...P.items]),E(P.nextCursor??null),b(P.total),y("ready")}catch{y("ready")}}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:u}),e.jsx("p",{className:"cogita-library-subtitle",children:Y||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:o,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${o}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${o}/collections/${x}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${o}/collections/${x}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:J}),e.jsx("span",{children:F==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:h.length?h.map(P=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:P.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:P.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:P.label}),e.jsx("p",{className:"cogita-card-subtitle",children:P.description})]})},me(P))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),H?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:L,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${o}/collections/${x}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const Ot=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const s=t.length,n=t.filter(p=>p.correct).length,i=Oa(ws(t));return{score:Math.round(Math.max(0,Math.min(100,i.knowness*100))*100)/100,total:s,correct:n,lastReviewedUtc:i.lastReviewedUtc??null}},Li=t=>{if(t.maskBase64)try{const s=Rn(t.maskBase64);if(!s.length)return t.correct?1:0;const n=s.reduce((i,l)=>i+l,0);return Math.max(0,Math.min(1,n/s.length/255))}catch{return t.correct?1:0}return t.correct?1:0},ws=t=>t.map(s=>({correctness:Li(s),createdUtc:s.createdUtc})),Oa=(t,s=Date.now())=>{var V;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const i=t.slice().sort((b,h)=>b.createdUtc.localeCompare(h.createdUtc)).slice(-5),l=i.reduce((b,h)=>b+h.correctness,0)/i.length,p=5,m=2,f=.15;let R=0,I=0;for(let b=0;b<i.length;b+=1){const h=new Date(i[b].createdUtc).getTime(),he=b===i.length-1?s:new Date(i[b+1].createdUtc).getTime(),F=Math.max(0,(he-h)/(1e3*60)),y=1-Math.exp(-F/p);R+=y,i[b].correctness>.5&&(I+=f)}let c=l*R*m+I;const x=((V=i[i.length-1])==null?void 0:V.createdUtc)??null,o=x?Math.max(0,(s-new Date(x).getTime())/(1e3*60)):0,k=1/(1+Math.log1p(o/60));return c*=k,i.length===1&&i[0].correctness>.5&&(c+=5.44*Math.exp(-o/2)),{knowness:c,avgCorrectness:l,lastReviewedUtc:x}},wa=t=>{const s=t.slice();for(let n=s.length-1;n>0;n-=1){const i=Math.floor(Math.random()*(n+1));[s[n],s[i]]=[s[i],s[n]]}return s},Ia=t=>t[Math.floor(Math.random()*t.length)],$i=(t,s)=>{const n=new Map;return t.forEach(i=>n.set(i,Math.random())),t.sort((i,l)=>{const p=s(i)-s(l);return p!==0?p:(n.get(i)??0)-(n.get(l)??0)})},qa=(t,s,n,i,l)=>{if(!t.length)return null;const p=t.filter(f=>!(l!=null&&l.has(me(f))));if(p.length===0)return null;const m=p.filter(f=>me(f)!==n);return Ia(m.length?m:p)},Ri=(t,s,n,i,l)=>{if(!t.length)return null;let p=Number.POSITIVE_INFINITY;for(const I of t){const c=me(I);if(n.has(c))continue;const x=s[c]??1;x<p&&(p=x)}if(!Number.isFinite(p))return null;const m=t.filter(I=>{const c=me(I);return!n.has(c)&&(s[c]??1)===p}),f=m.filter(I=>!l||me(I)!==l),R=i?f.filter(I=>!i.has(me(I))):f;return R.length>0?Ia(R):f.length>0?Ia(f):l&&m.some(I=>me(I)===l)?m.find(I=>me(I)===l)??null:m.length?Ia(m):null},ln=(t,s,n,i,l)=>{const p=[],m=t.filter(R=>!l.has(me(R))&&!n.has(me(R))&&(s[me(R)]??0)<1),f=$i(m,R=>s[me(R)]??0);for(const R of f){if(p.length>=i)break;p.push(R),l.add(me(R))}if(p.length<i){const R=wa(t.filter(I=>!l.has(me(I))&&n.has(me(I))));for(const I of R){if(p.length>=i)break;p.push(I),l.add(me(I))}}return p},Ai=(t,s,n,i)=>ln(t,s,n,i,new Set),js=(t,s,n,i,l,p)=>{const m=Math.max(1,n.stackSize??s),R=wa(t).filter((k,Y,q)=>q.findIndex(V=>me(V)===me(k))===Y),I=Ai(R,i,l,m),c=new Set,x=new Set,o=qa(I,{},null,c,x),u=o?[o]:[];return o&&x.add(me(o)),{queue:u,meta:{pool:R,active:I,knownessMap:i,unknownSet:l,outcomesById:p,asked:c,queued:x}}},us={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,s)=>{const i=wa(t).filter((l,p,m)=>m.findIndex(f=>me(f)===me(l))===p);return{queue:i.slice(0,Math.min(s,i.length)),meta:{}}},applyOutcome:t=>t},ks=(t,s,n,i)=>{const l=Math.max(1,n.stackSize??s),m=wa(t).filter((Y,q,V)=>V.findIndex(b=>me(b)===me(Y))===q),f={},R=new Set,I=new Set,c=new Set,x=Math.max(1,n.levels??1);m.forEach(Y=>{const q=me(Y),V=i==null?void 0:i[q],b=typeof V=="number"&&Number.isFinite(V)?V:1;f[q]=Math.min(x,Math.max(1,Math.round(b)))});const o=[];if(m.length>0){const Y=new Map;m.forEach(V=>{var h;const b=f[me(V)]??1;Y.has(b)||Y.set(b,[]),(h=Y.get(b))==null||h.push(V)});const q=Array.from(Y.keys()).sort((V,b)=>V-b);for(const V of q){if(o.length>=l)break;const b=wa(Y.get(V)??[]);for(const h of b){if(o.length>=l)break;o.push(h)}}}const u=qa(o,f,null,R,I),k=u?[u]:[];return u&&I.add(me(u)),{queue:k,meta:{pool:m,active:o,levelMap:f,asked:R,queued:I,wrongSinceCorrect:c}}},Ei={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,s)=>Math.max(1,s.stackSize??t),getProgressTotal:()=>null,prepare:(t,s,n)=>ks(t,s,n),applyOutcome:(t,s,n,i,l)=>{if(!s)return t;const p=Math.max(1,i.levels??1),m=t.meta.pool??[],f=t.meta.active??[],R={...t.meta.levelMap??{}},I=new Set(t.meta.asked??[]),c=new Set(t.meta.queued??[]),x=new Set(t.meta.wrongSinceCorrect??[]),o=me(s);c.delete(o),I.add(o);const u=R[o]??1;l.correct?(R[o]=x.has(o)?1:Math.min(u+1,p),x.delete(o)):(R[o]=1,x.add(o));const k=l.correct?f.filter(V=>me(V)!==o):f.slice();if(l.correct&&k.length<Math.max(1,i.stackSize??1)){const V=new Set(k.map(h=>me(h))),b=Ri(m,R,V,I,o);b&&k.push(b)}const Y=t.queue.slice(),q=qa(k,R,o,I,c);return q&&(Y.push(q),c.add(me(q))),{queue:Y,meta:{pool:m,active:k,levelMap:R,asked:I,queued:c,wrongSinceCorrect:x}}}},Pi={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,s)=>Math.max(1,s.stackSize??t),getProgressTotal:()=>null,prepare:(t,s,n)=>js(t,s,n,{},new Set,{}),applyOutcome:(t,s,n,i,l)=>{if(!s)return t;const p=t.meta.pool??[],m=t.meta.active??[],f={...t.meta.knownessMap??{}},R=new Set(t.meta.unknownSet??[]),I={...t.meta.outcomesById??{}},c=new Set(t.meta.asked??[]),x=new Set(t.meta.queued??[]),o=me(s);x.delete(o),c.add(o);const u={correctness:Math.max(0,Math.min(1,l.correctness??(l.correct?1:0))),createdUtc:l.createdUtc??new Date().toISOString()},Y=(I[o]??[]).concat(u).sort((F,y)=>F.createdUtc.localeCompare(y.createdUtc)).slice(-5);I[o]=Y,R.delete(o);const q=Date.now();p.forEach(F=>{const y=me(F),H=I[y]??[];if(H.length===0){f[y]=0,R.add(y);return}const E=Oa(H,q);f[y]=E.knowness});const V=m.slice();if((f[o]??0)>=1){const F=V.filter(y=>me(y)!==o);V.length=0,V.push(...F)}const h=Math.max(1,i.stackSize??n);if(V.length<h){const F=new Set(V.map(H=>me(H))),y=ln(p,f,R,h-V.length,F);V.push(...y)}const he=t.queue.slice();if(he.length===0||me(he[he.length-1])===o){const F=qa(V,{},o,c,x);F&&(he.push(F),x.add(me(F)))}return{queue:he,meta:{pool:p,active:V,knownessMap:f,unknownSet:R,outcomesById:I,asked:c,queued:x}}}},cn={random:us,levels:Ei,temporal:Pi},Fi=Object.values(cn),Ns=t=>{if(!t)return us;const s=t.trim().toLowerCase();return s==="random"||s==="levels"||s==="temporal"?cn[s]:us},Ua=(t,s)=>{const n={...t.defaultSettings};return s&&Object.entries(s).forEach(([i,l])=>{typeof l=="number"&&Number.isFinite(l)&&(n[i]=l),typeof l=="string"&&(n[i]=l)}),t.settingsFields.forEach(i=>{var p;const l=n[i.key];if(i.type==="number"){if(typeof l!="number"||Number.isNaN(l)){n[i.key]=t.defaultSettings[i.key]??0;return}i.min!==void 0&&(n[i.key]=Math.max(i.min,n[i.key])),i.max!==void 0&&(n[i.key]=Math.min(i.max,n[i.key]));return}if(i.type==="select"){const m=((p=i.options)==null?void 0:p.map(f=>f.value))??[];(typeof l!="string"||m.length>0&&!m.includes(l))&&(n[i.key]=t.defaultSettings[i.key]??m[0]??"")}}),n},dn=(t,s)=>{const n={};return t.settingsFields.forEach(i=>{const l=s.get(i.key);if(l){if(i.type==="number"){const p=Number(l);Number.isNaN(p)||(n[i.key]=p);return}n[i.key]=l}}),Ua(t,n)},Ki=(t,s)=>{const n=new URLSearchParams;return t.settingsFields.forEach(i=>{const l=s[i.key];(typeof l=="number"||typeof l=="string")&&n.set(i.key,String(l))}),n};function zi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,libraryId:c,collectionId:x,revisionId:o}){const{libraryName:u}=Wt(c),k=`/#/cogita/library/${c}`,[Y,q]=a.useState(t.cogita.library.collections.defaultName),[V,b]=a.useState(""),[h,he]=a.useState(20),[F,y]=a.useState("random"),[H,E]=a.useState({}),[J,L]=a.useState("exact"),[P,re]=a.useState([]),[ue,de]=a.useState(null),[ze,pe]=a.useState([]),[S,xe]=a.useState("idle"),[v,O]=a.useState(null),[ye,Q]=a.useState("idle"),[K,je]=a.useState("idle"),[Te,Ne]=a.useState("idle"),Fe=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),Me=a.useMemo(()=>Ns(F),[F]),Be=a.useMemo(()=>Ua(Me,H),[Me,H]),Ke=a.useMemo(()=>Ki(Me,Be).toString(),[Me,Be]);a.useEffect(()=>{Va(c,x).then(we=>q(we.name)).catch(()=>q(t.cogita.library.collections.defaultName))},[c,x]),a.useEffect(()=>{o&&An({libraryId:c,collectionId:x,revisionId:o}).then(we=>{b(we.name),y(we.mode||"random"),L(we.check||"exact"),he(we.limit||20),E(we.revisionSettings??{})}).catch(()=>{b("")})},[x,c,o]),a.useEffect(()=>{nn({libraryId:c}).then(we=>{re(we),!ue&&we.length>0&&de(we[0].roleId)}).catch(()=>{re([])})},[c]);const $e=()=>{je("loading"),an({libraryId:c}).then(we=>{pe(we),je("idle")}).catch(()=>{pe([]),je("error")})};a.useEffect(()=>{$e()},[c]);const De=async()=>{xe("working"),Q("idle");try{const we=await Pn({libraryId:c,collectionId:x,revisionType:Me.id,revisionSettings:Be,mode:F,check:J,limit:h});O(`${Fe}/${we.shareCode}${Ke?`?${Ke}`:""}`),xe("ready"),$e()}catch{xe("error")}},et=async()=>{if(o){Ne("saving");try{await En({libraryId:c,collectionId:x,revisionId:o,name:V||Y,revisionType:Me.id,revisionSettings:Be,mode:F,check:J,limit:h}),Ne("saved")}catch{Ne("error")}}},Je=async()=>{if(v)try{await navigator.clipboard.writeText(v),Q("copied")}catch{Q("failed")}},Re=async we=>{try{await sn({libraryId:c,shareId:we}),$e()}catch{$e()}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:Y}),e.jsx("p",{className:"cogita-library-subtitle",children:u})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:k,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${k}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${k}/collections/${x}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${k}/collections/${x}/revision/run?mode=${encodeURIComponent(F)}&check=${encodeURIComponent(J)}&limit=${h}${Ke?`&${Ke}`:""}${ue?`&reviewer=${encodeURIComponent(ue)}`:""}${o?`&revisionId=${encodeURIComponent(o)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:V,onChange:we=>b(we.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:F,onChange:we=>y(we.target.value),children:Fi.map(we=>e.jsx("option",{value:we.id,children:t.cogita.library.revision[we.labelKey]},we.id))})]}),Me.settingsFields.map(we=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[we.labelKey]}),we.type==="select"?e.jsx("select",{value:String(Be[we.key]??""),onChange:Ze=>E(He=>({...He,[we.key]:Ze.target.value})),children:(we.options??[]).map(Ze=>e.jsx("option",{value:Ze.value,children:t.cogita.library.revision[Ze.labelKey]},Ze.value))}):e.jsx("input",{type:"number",min:we.min,max:we.max,step:we.step,value:Be[we.key]??0,onChange:Ze=>E(He=>({...He,[we.key]:Number(Ze.target.value||0)}))})]},we.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),Me.id!=="levels"&&Me.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:h,onChange:we=>he(Number(we.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:ue??"",onChange:we=>de(we.target.value||null),children:P.map(we=>e.jsx("option",{value:we.roleId,children:we.label},we.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[o?e.jsx("button",{type:"button",className:"cta ghost",onClick:et,disabled:Te==="saving",children:Te==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${k}/collections/${x}/revision/run?mode=${encodeURIComponent(F)}&check=${encodeURIComponent(J)}&limit=${h}${Ke?`&${Ke}`:""}${ue?`&reviewer=${encodeURIComponent(ue)}`:""}${o?`&revisionId=${encodeURIComponent(o)}`:""}`,children:t.cogita.library.actions.startRevision})]}),Te==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),v?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:v,readOnly:!0})]}):null,S==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,ye==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):ye==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:De,disabled:S==="working",children:S==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),v?e.jsx("button",{type:"button",className:"cta ghost",onClick:Je,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),K==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):ze.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:ze.map(we=>e.jsxs("div",{className:"cogita-share-row","data-state":we.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:we.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(we.createdUtc).toLocaleString(),we.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),we.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>Re(we.shareId),children:t.cogita.library.revision.shareRevokeAction})]},we.shareId))})]})]})]})]})})})]})})}const ss=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function un(t,s,n){if(!t)return null;const i=new Map(t.nodes.map(F=>[F.id,F])),l=new Map,p=new Set,m=F=>{if(typeof F=="number")return F;if(typeof F=="string"){const y=Number(F);return Number.isFinite(y)?y:0}return 0},f=F=>{if(l.has(F))return l.get(F);if(p.has(F))return 0;const y=i.get(F);if(!y)return 0;p.add(F);const H=J=>{var P,re;return(J?((P=y.inputsByHandle)==null?void 0:P[J])??[]:y.inputs??((re=y.inputsByHandle)==null?void 0:re.in)??[]).map(ue=>f(ue))};let E=0;switch(y.type){case"input.random":{const J=y.min??0,L=y.max??J+10,P=Math.min(J,L),re=Math.max(J,L);E=Math.floor(Math.random()*(re-P+1))+P;break}case"input.const":{E=y.value??0;break}case"input.list":{const J=(y.list??[]).filter(Boolean),L=Math.round(m(H("index")[0]));E=J.length?J[Math.max(0,Math.min(J.length-1,L))]:String(L);break}case"compute.add":{E=H("in").map(L=>m(L)).reduce((L,P)=>L+P,0);break}case"compute.sub":{const J=H("add").map(P=>m(P)),L=H("sub").map(P=>m(P));E=J.reduce((P,re)=>P+re,0)-L.reduce((P,re)=>P+re,0);break}case"compute.mul":{const J=H("in").map(L=>m(L));E=J.length?J.reduce((L,P)=>L*P,1):0;break}case"compute.div":{const J=m(H("num")[0]),L=H("den").map(P=>m(P)).reduce((P,re)=>P+re,0);E=Math.abs(L)<Number.EPSILON?0:J/L;break}case"compute.pow":{const J=m(H("base")[0]),L=m(H("exp")[0]);E=Math.pow(J,L);break}case"compute.exp":{const J=m(H("base")[0]),L=m(H("exp")[0]);E=Math.pow(J,L);break}case"compute.log":{const J=m(H("value")[0]),L=m(H("base")[0]),P=Math.max(J,Number.EPSILON);E=Math.abs(L)<Number.EPSILON?Math.log(P):Math.log(P)/Math.log(L);break}case"compute.abs":{E=Math.abs(m(H("in")[0]));break}case"compute.min":{const J=H("in").map(L=>m(L));E=J.length?Math.min(...J):0;break}case"compute.max":{const J=H("in").map(L=>m(L));E=J.length?Math.max(...J):0;break}case"compute.floor":{E=Math.floor(m(H("in")[0]));break}case"compute.ceil":{E=Math.ceil(m(H("in")[0]));break}case"compute.round":{E=Math.round(m(H("in")[0]));break}case"compute.mod":{const J=m(H("a")[0]),L=m(H("b")[0]);E=Math.abs(L)<Number.EPSILON?0:J%L;break}case"compute.concat":{const L=["in1","in2","in3","in4","in5","in6"].flatMap(de=>H(de)),P=L.length?L:H("in");E=(P.length?P:H()).map(de=>de==null?"":String(de)).join("");break}case"compute.trim":{const J=H("text")[0]??H("in")[0]??"",L=J==null?"":String(J),P=Math.max(0,Math.round(m(H("start")[0]))),re=Math.max(0,Math.round(m(H("end")[0])));P+re>=L.length?E="":E=L.substring(P,L.length-re);break}case"output":{E=H("in")[0]??0;break}default:E=0}return p.delete(F),l.set(F,E),E},R=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(F=>F.type==="output").map(F=>F.id);t.nodes.forEach(F=>f(F.id)),R.forEach(F=>f(F));const I=F=>Math.abs(F%1)<1e-5?String(Math.round(F)):F.toFixed(3).replace(/\.?0+$/,""),c=F=>typeof F=="number"?I(F):F??"",x=new Map;R.forEach(F=>{var L,P,re,ue;const y=i.get(F);if(!y)return;const H=(P=(L=y.inputsByHandle)==null?void 0:L.name)==null?void 0:P[0],E=H?c(l.get(H)):"",J=(E==null?void 0:E.toString().trim())||((re=y.outputLabel)==null?void 0:re.trim())||((ue=y.name)==null?void 0:ue.trim())||F;x.set(F,J)});const o={},u={},k={};R.forEach(F=>{var E,J;const y=i.get(F);if(!y)return;const H=x.get(F)??(((E=y.outputLabel)==null?void 0:E.trim())||((J=y.name)==null?void 0:J.trim())||F);o[H]=c(l.get(F)),y.name&&(u[y.name.trim()]=H),u[F]=H});const Y=(F,y)=>{let H=F;return t.nodes.forEach(E=>{var ue,de;const J=c(l.get(E.id)),L=R.includes(E.id),P=L?x.get(E.id)??((ue=E.outputLabel)==null?void 0:ue.trim())??((de=E.name)==null?void 0:de.trim())??E.id:"",re=L&&y?P:J;H=H.replace(new RegExp(`\\{\\s*${ss(E.id)}\\s*\\}`,"gi"),re),E.name&&(H=H.replace(new RegExp(`\\{\\s*${ss(E.name)}\\s*\\}`,"gi"),re)),L&&E.outputLabel&&(H=H.replace(new RegExp(`\\{\\s*${ss(E.outputLabel)}\\s*\\}`,"gi"),P))}),H},q=s;let V=q.trim().length>0?q:"";V||(V=R.length?`Compute ${R.join(", ")}`:"Compute"),V=Y(V,!0);const b=(n==null?void 0:n.trim())??"",h=b?Y(b,!1):"",he={};return l.forEach((F,y)=>{he[y]=F,k[y]=c(F);const H=i.get(y);H!=null&&H.name&&(k[H.name.trim()]=c(F))}),{prompt:V,answers:o,values:he,answerText:h,outputVariables:u,variableValues:k}}function hn(t){var n;const s=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((n=s[0])==null?void 0:n[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const ns=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function gn({outcomes:t}){const[s,n]=a.useState("day"),i=a.useMemo(()=>{const l=ns.find(f=>f.id===s)??ns[1],p=Date.now()-l.ms,m=t.filter(f=>new Date(f.createdUtc).getTime()>=p);return Ot(m)},[t,s]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:ns.map(l=>e.jsx("button",{type:"button",className:"ghost","data-active":s===l.id,onClick:()=>n(l.id),children:l.label},l.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[i.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[i.correct," / ",i.total]})]})}const Di="cogita-revision",Bi=1,Pa="outcomes",_i=()=>new Promise((t,s)=>{const n=indexedDB.open(Di,Bi);n.onupgradeneeded=()=>{const i=n.result;if(!i.objectStoreNames.contains(Pa)){const l=i.createObjectStore(Pa,{keyPath:"id"});l.createIndex("byItem","itemKey",{unique:!1}),l.createIndex("byPending","pending",{unique:!1})}},n.onerror=()=>s(n.error),n.onsuccess=()=>t(n.result)}),ja=async(t,s)=>{const n=await _i();return new Promise((i,l)=>{const p=n.transaction(Pa,t),m=p.objectStore(Pa);s(m).then(i).catch(l),p.onerror=()=>l(p.error)})},mn=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const s=Array.from(t).map(n=>n.toString(16).padStart(2,"0"));return`${s.slice(0,4).join("")}-${s.slice(4,6).join("")}-${s.slice(6,8).join("")}-${s.slice(8,10).join("")}-${s.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},Vi=()=>{const t="cogita_revision_client_id",s=localStorage.getItem(t);if(s)return s;const n=mn();return localStorage.setItem(t,n),n},Oi=()=>{const t="cogita_revision_client_seq",s=Number(localStorage.getItem(t)??"0"),n=Number.isFinite(s)?s+1:1;return localStorage.setItem(t,String(n)),n},pn=(t,s,n,i)=>Vt(t,s,n,i),Fa=async t=>{const s=Vi(),n=Oi(),i=new Date().toISOString(),l={...t,clientId:s,clientSequence:n,createdUtc:i,id:mn(),pending:!0};return await ja("readwrite",p=>new Promise((m,f)=>{const R={...l,itemKey:pn(l.itemType,l.itemId,l.checkType,l.direction)},I=p.add(R);I.onsuccess=()=>m(),I.onerror=()=>f(I.error)})),l},Ka=async(t,s,n,i)=>{if(!s)return[];try{const l=pn(t,s,n,i);return await ja("readonly",p=>new Promise((m,f)=>{const I=p.index("byItem").getAll(l);I.onsuccess=()=>{const x=(I.result??[]).map(o=>({itemType:o.itemType,itemId:o.itemId,checkType:o.checkType??null,direction:o.direction??null,revisionType:o.revisionType,evalType:o.evalType,correct:o.correct,createdUtc:o.createdUtc,maskBase64:o.maskBase64,payloadBase64:o.payloadBase64,payloadHashBase64:o.payloadHashBase64,clientId:o.clientId,clientSequence:o.clientSequence,personRoleId:o.personRoleId??null})).sort((o,u)=>o.createdUtc.localeCompare(u.createdUtc));m(x)},I.onerror=()=>f(I.error)}))}catch{return[]}},qt=async()=>{try{return await ja("readonly",t=>new Promise((s,n)=>{const i=t.getAll();i.onsuccess=()=>{const p=(i.result??[]).map(m=>({itemType:m.itemType,itemId:m.itemId,checkType:m.checkType??null,direction:m.direction??null,revisionType:m.revisionType,evalType:m.evalType,correct:m.correct,createdUtc:m.createdUtc,maskBase64:m.maskBase64,payloadBase64:m.payloadBase64,payloadHashBase64:m.payloadHashBase64,clientId:m.clientId,clientSequence:m.clientSequence,personRoleId:m.personRoleId??null}));s(p)},i.onerror=()=>n(i.error)}))}catch{return[]}},qi=async(t=100)=>{try{return await ja("readonly",s=>new Promise((n,i)=>{const p=s.index("byPending").getAll(!0);p.onsuccess=()=>{const m=p.result??[];n(m.slice(0,t))},p.onerror=()=>i(p.error)}))}catch{return[]}},Ui=async t=>{if(t.length!==0)try{await ja("readwrite",s=>new Promise((n,i)=>{let l=t.length;t.forEach(p=>{const m=s.get(p);m.onsuccess=()=>{const f=m.result;if(f){f.pending=!1;const R=s.put(f);R.onsuccess=()=>{l-=1,l===0&&n()},R.onerror=()=>i(R.error)}else l-=1,l===0&&n()},m.onerror=()=>i(m.error)})}))}catch{}},is=async(t,s)=>{const n=await qi(200);if(n.length===0)return;const i=new Map;n.forEach(l=>{var m;const p=l.personRoleId??s??"";i.has(p)||i.set(p,[]),(m=i.get(p))==null||m.push(l)});for(const[l,p]of i.entries()){const m=p.map(f=>({itemType:f.itemType,itemId:f.itemId,checkType:f.checkType??null,direction:f.direction??null,revisionType:f.revisionType,evalType:f.evalType,correct:f.correct,clientId:f.clientId,clientSequence:f.clientSequence,maskBase64:f.maskBase64??null,payloadHashBase64:f.payloadHashBase64??null,payloadBase64:f.payloadBase64??null,personRoleId:l||null}));try{await Fn({libraryId:t,outcomes:m}),await Ui(p.map(f=>f.id))}catch{}}},St=t=>t.trim().toLowerCase(),Rt=t=>{const s=t==null?void 0:t.trim();return s?{fragmentId:s}:null},za=(t,s)=>{const n=Rt(s);if(!n)return!0;const i=Rt(t);return(i==null?void 0:i.fragmentId)===n.fragmentId},mt=t=>{const s=t==null?void 0:t.trim().toLowerCase();return s||null},fn=(t,s)=>{if((mt(t.childItemType)??"info")!==(s.cardType??"").toLowerCase()||t.childItemId!==s.cardId)return!1;const i=mt(t.childCheckType),l=mt(t.childDirection),p=mt(s.checkType),m=mt(s.direction);return!(i&&i!==p||l&&l!==m)},Wi={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},Hi={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},Da=(t,s,n)=>{if(!n||!s.startsWith(t))return s;const i=s.slice(t.length);if(!i)return s;const l=n==="super"?Wi:Hi,p=i.split("").map(m=>l[m]??m).join("");return t+p},Ba=(t,s,n)=>{var m,f,R;if(!t)return((m=s[0])==null?void 0:m.key)??null;const i=new Set(s.map(I=>I.key)),l=/\{([^}]+)\}/g;let p;for(;(p=l.exec(t))!==null;){const I=((f=p[1])==null?void 0:f.trim())??"";if(!I)continue;if(i.has(I))return I;const c=n==null?void 0:n[I];if(c&&i.has(c))return c}return((R=s[0])==null?void 0:R.key)??null},hs=t=>(()=>{const s=new Set;return t.flatMap(n=>{if(n.cardType!=="info"||n.infoType!=="citation")return[n];const i=n.description??"";if(!i.trim())return[n];const l=sa(i),p=Object.keys(l.nodes);return p.length===0?[n]:p.map(m=>({...n,checkType:"quote-fragment",direction:m})).filter(m=>{const f=[m.cardId,m.checkType??"",m.direction??""].join("|");return s.has(f)?!1:(s.add(f),!0)})})})();function Yi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,libraryId:c,collectionId:x,revisionId:o}){const u=_a(),k=`/#/cogita/library/${c}`,Y=a.useMemo(()=>new URLSearchParams(u.search),[u.search]),q=Math.max(1,Number(Y.get("limit")??20)),V=Y.get("mode")??"random",b=a.useMemo(()=>Ns(V),[V]),h=a.useMemo(()=>Ua(b,dn(b,Y)),[b,Y]),he=Y.get("check")??"exact",F=Y.get("reviewer"),y=a.useMemo(()=>t.cogita.library.revision[b.labelKey]??V,[t,V,b]),H=a.useMemo(()=>he==="exact"?t.cogita.library.revision.checkValue:he,[t,he]),[E,J]=a.useState(t.cogita.library.collections.defaultName),[L,P]=a.useState([]),[re,ue]=a.useState([]),[de,ze]=a.useState("idle"),[pe,S]=a.useState({current:0,total:0}),[xe,v]=a.useState(0),[O,ye]=a.useState(""),[Q,K]=a.useState(null),[je,Te]=a.useState(null),[Ne,Fe]=a.useState(null),[Me,Be]=a.useState(null),[Ke,$e]=a.useState([]),[De,et]=a.useState({}),[Je,Re]=a.useState({}),[we,Ze]=a.useState(null),[He,oe]=a.useState(null),[Le,Ve]=a.useState(null),[Xe,X]=a.useState(null),[A,Z]=a.useState(null),[fe,T]=a.useState({}),C=a.useRef(0),[G,ae]=a.useState(null),ne=a.useRef(null),Ce=a.useRef(null),[Ie,Pe]=a.useState(null),[se,ge]=a.useState(!1),[le,st]=a.useState(null),[Oe,Ye]=a.useState([]),[ct,yt]=a.useState(null),Ue=a.useRef(null),We=a.useRef(null),[Ct,dt]=a.useState(null),[It,lt]=a.useState(0),rt=a.useRef(null),Lt=a.useRef({}),[xt,tt]=a.useState(!1),[at,At]=a.useState({}),[$t,Qe]=a.useState([]),ht=a.useRef(new Map),[pt,jt]=a.useState(new Set),[_,ie]=a.useState(!1),Se=a.useRef(null),d=a.useRef(new Set),ke=a.useRef({}),W=L[xe]??null,te=(W==null?void 0:W.checkType)==="translation-match"&&A,ut=a.useRef(new Map),it=a.useRef(new Map),bt=a.useRef(new Map),ft=a.useRef(new Map),Mt=a.useMemo(()=>W?W.cardType==="vocab"?t.cogita.library.revision.vocabLabel:W.infoType?qe(t,W.infoType):t.cogita.library.revision.infoLabel:"",[t,W]),na=a.useMemo(()=>{var g;return b.id!=="levels"?L.length:((g=at.pool)==null?void 0:g.length)??b.getFetchLimit(q,h)},[at,h,b,L.length,q]),Ht=b.getProgressTotal?b.getProgressTotal(L,at,q,h):b.id==="levels"?Math.min(q,na):L.length,Dt=Ht?Math.min(xe+1,Ht):0,vt=Math.max(1,Number(h.tries??1)),wt=h.compare??"anchors",Ut=Math.max(0,Math.min(100,Number(h.minCorrectness??0))),nt=(h.considerDependencies??"on")==="on",ot=Math.max(0,Math.min(100,Number(h.dependencyThreshold??85))),Ft=r=>{const g=r.slice();for(let N=g.length-1;N>0;N-=1){const j=Math.floor(Math.random()*(N+1));[g[N],g[j]]=[g[j],g[N]]}return g},ga=r=>Gt(r,{treatSimilarCharsAsSame:!0})>=Ut,ma=async()=>{const r=await qt(),g=new Map,N=new Map,j=new Map;r.forEach(M=>{const D=`${M.itemType}:${M.itemId}`,ee=Vt(M.itemType,M.itemId,M.checkType,M.direction);if(g.has(D)||g.set(D,[]),g.get(D).push(M),N.has(ee)||N.set(ee,[]),N.get(ee).push(M),M.itemType==="info"&&M.checkType==="quote-fragment"&&M.direction){const ce=`${M.itemId}:${M.direction}`;j.has(ce)||j.set(ce,[]),j.get(ce).push(M)}});const B=new Map,w=new Map,z=new Map;return g.forEach((M,D)=>B.set(D,Ot(M).score)),N.forEach((M,D)=>w.set(D,Ot(M).score)),j.forEach((M,D)=>z.set(D,Ot(M).score)),{itemKnowness:B,cardKnowness:w,fragmentKnowness:z}},Wa=async r=>{const g=[];let N=null;for(;;){const j=await La({libraryId:c,collectionId:r,limit:200,cursor:N});if(g.push(...j.items),!j.nextCursor)break;N=j.nextCursor}return hs(g)},pa=async(r,g)=>{if(ht.current.has(r))return ht.current.get(r)??0;const N=await Wa(r);if(N.length===0)return ht.current.set(r,0),0;const B=N.reduce((w,z)=>{const M=me(z);return w+(g.get(M)??0)},0)/N.length;return ht.current.set(r,B),B},Ha=(r,g)=>{if(!nt||r.cardType!=="info"||r.infoType!=="citation"||r.checkType!=="quote-fragment")return!0;const N=Rt(r.direction);if(!(N!=null&&N.fragmentId))return!0;const j=r.description??"";if(!j.trim())return!0;const w=sa(j).nodes[N.fragmentId];if(!w||!w.leftId&&!w.rightId)return!0;const z=[w.leftId,w.rightId].filter(ee=>!!ee);if(z.length===0)return!0;const M=z.map(ee=>{const ce=Vt("info",r.cardId,"quote-fragment",ee);return g.get(ce)??0});return M.reduce((ee,ce)=>ee+ce,0)/M.length>=ot},ia=async r=>{const g=at,N=r.concat(g.active??[]).concat(g.pool??[]).filter((M,D,ee)=>ee.findIndex(ce=>me(ce)===me(M))===D);if(!nt){jt(new Set(N.map(me)));return}const{itemKnowness:j,cardKnowness:B}=await ma(),w=$t.filter(M=>mt(M.childItemType)==="collection"&&M.childItemId===x&&!mt(M.childCheckType)&&!mt(M.childDirection)),z=new Set;for(const M of N){if(M.cardType!=="info"){z.add(me(M));continue}if(!Ha(M,B))continue;const D=$t.filter(be=>fn(be,M)).concat(w);if(D.length===0){z.add(me(M));continue}let ee=0;for(const be of D)if(mt(be.parentItemType)==="collection")ee+=await pa(be.parentItemId,B);else if(mt(be.parentCheckType)||mt(be.parentDirection)){const ve=mt(be.parentCheckType),Ae=mt(be.parentDirection),Ee=Vt(be.parentItemType,be.parentItemId,ve,Ae);ee+=B.get(Ee)??0}else{const ve=`${be.parentItemType}:${be.parentItemId}`;ee+=j.get(ve)??0}ee/D.length>=ot&&z.add(me(M))}jt(z)},Ya=r=>{for(let g=r;g<L.length;g+=1){const N=L[g];if(N&&(!nt||N.cardType!=="info"||pt.has(me(N))))return g}return-1},Et=r=>!nt||r.cardType!=="info"||pt.has(me(r)),ra=r=>{if(b.id!=="temporal"&&b.id!=="levels")return null;const g=at,N=(g.active??[]).concat(g.pool??[]),j=new Set;for(const B of N){const w=me(B);if(!(j.has(w)||r.has(w))&&(j.add(w),Et(B)))return B}return null},Kt=a.useMemo(()=>{if(b.id!=="levels")return null;const r=at,g=r.pool??[],N=r.active??[],j=r.levelMap??{},B=Math.max(1,Number(h.levels??1)),w=Array.from({length:B},()=>0),z=new Set(N.map(ce=>me(ce)));g.forEach(ce=>{const be=Math.min(B,Math.max(1,j[me(ce)]??1));w[be-1]+=1});const M=g.length||1,D=w.map(ce=>ce/M*100),ee=W?j[me(W)]??1:null;return{counts:w,percentages:D,currentLevel:ee,levelsCount:B,activeCount:N.length,poolCount:g.length,activeSet:z}},[at,h,b,W]),kt=a.useMemo(()=>{if(b.id!=="temporal")return null;const r=at,g=r.pool??[],N=r.active??[],j=r.knownessMap??{},B=new Set(r.unknownSet??[]);let w=0;g.forEach(D=>{(j[me(D)]??0)>1&&(w+=1)});const z=B.size,M=N.map(D=>({id:me(D),value:B.has(me(D))?0:Math.max(0,Math.min(1,j[me(D)]??0))}));return{knownCount:w,unknownCount:z,dots:M}},[at,b]),oa=a.useMemo(()=>{if(!nt)return 0;const r=at;return L.concat(r.active??[]).concat(r.pool??[]).filter((N,j,B)=>B.findIndex(w=>me(w)===me(N))===j).filter(N=>N.cardType==="info"&&!pt.has(me(N))).length},[nt,at,L,pt]);a.useEffect(()=>{if(!nt||de!=="ready")return;const r=at,N=L.concat(r.active??[]).concat(r.pool??[]).filter((w,z,M)=>M.findIndex(D=>me(D)===me(w))===z).filter(w=>w.cardType!=="info"||pt.has(me(w))).length,j=Ue.current;if(Ue.current=N,j===null||N<=j)return;const B=N-j;yt(`New card available (+${B})`),We.current&&window.clearTimeout(We.current),We.current=window.setTimeout(()=>yt(null),2200)},[nt,de,at,L,pt]),a.useEffect(()=>()=>{We.current&&window.clearTimeout(We.current)},[]);const Nt=(r,g)=>{const N=b.applyOutcome({queue:L,meta:at},W,q,h,{correct:r,correctness:g,createdUtc:new Date().toISOString()});P(N.queue),At(N.meta);const j=N.queue[xe+1];j&&fa(j,xe+1)};a.useEffect(()=>{Va(c,x).then(r=>J(r.name)).catch(()=>J(t.cogita.library.collections.defaultName))},[c,x]),a.useEffect(()=>{bs({libraryId:c,type:"language"}).then(r=>ue(r)).catch(()=>ue([]))},[c]),a.useEffect(()=>{fs({libraryId:c}).then(r=>Qe(r.items??[])).catch(()=>Qe([]))},[c]),a.useEffect(()=>{is(c,F)},[c,F]),a.useEffect(()=>{ia(L)},[L,$t,nt,ot,x]),a.useEffect(()=>{if(!W||!nt){ie(!1);return}if(W.cardType!=="info"||pt.has(me(W))){ie(!1);return}const r=Ya(xe+1);if(r>=0){ie(!1),v(r);return}if(b.id==="temporal"||b.id==="levels"){const g=L.slice(0,xe+1),N=L.slice(xe+1).filter(Et),j=g.concat(N),B=new Set(j.map(me)),w=ra(B);if(w){const M=me(w);B.has(M)||(j.push(w),B.add(M),At(D=>{const ee=D,ce=new Set(ee.queued??[]);return ce.add(M),{...ee,queued:ce}}))}const z=j.findIndex((M,D)=>D!==xe&&Et(M));if(z>=0){P(j),v(z),ie(!1);return}}ie(!0)},[W,pt,nt,xe,L,at,b.id]),a.useEffect(()=>{let r=!0;return(async()=>{ze("loading"),S({current:0,total:b.id==="levels"?0:b.getFetchLimit(q,h)});try{const N=[];let j=null,B=null;do{const be=await La({libraryId:c,collectionId:x,limit:300,cursor:j});if(N.push(...be.items),(b.id==="levels"||b.id==="temporal")&&be.total&&(B=be.total),S(ve=>({current:N.length,total:ve.total||be.total||b.getFetchLimit(q,h)})),j=be.nextCursor??null,B!==null&&N.length>=B||b.id!=="levels"&&b.id!=="temporal"&&N.length>=b.getFetchLimit(q,h))break}while(j);if(!r)return;const w=hs(N);let z;if(b.id==="levels"){const be=Math.max(1,Number(h.levels??1)),Ae=(await qt()).reduce((Ee,_e)=>{const Ge=Vt(_e.itemType,_e.itemId,_e.checkType,_e.direction);return Ee[Ge]||(Ee[Ge]=[]),Ee[Ge].push(_e),Ee},{});z={},w.forEach(Ee=>{const _e=me(Ee),Ge=Ae[_e]??[],gt=Ge.length>0?Ot(Ge).score:0,Ca=Math.max(1,Math.min(be,Math.ceil(gt/100*be)));z[_e]=Ca})}let M=null,D=null,ee=null;if(b.id==="temporal"){const be=await qt(),ve=new Set(w.map(_e=>me(_e))),Ae=be.reduce((_e,Ge)=>{const gt=Vt(Ge.itemType,Ge.itemId,Ge.checkType,Ge.direction);return ve.has(gt)&&(_e[gt]||(_e[gt]=[]),_e[gt].push(Ge)),_e},{});M={},D=new Set,ee={};const Ee=Date.now();w.forEach(_e=>{const Ge=me(_e),gt=Ae[Ge]??[];if(gt.length===0){M[Ge]=0,D.add(Ge),ee[Ge]=[];return}const Ca=ws(gt);ee[Ge]=Ca;const yn=Oa(Ca,Ee);M[Ge]=yn.knowness})}const ce=b.id==="levels"?ks(w,q,h,z):b.id==="temporal"?js(w,q,h,M??{},D??new Set,ee??{}):b.prepare(w,q,h);P(ce.queue),At(ce.meta),v(0),ze("ready"),S(be=>({current:Math.min(be.current,be.total),total:be.total}))}catch{r&&ze("error")}})(),()=>{r=!1}},[c,x,q,h,b,F]),a.useEffect(()=>{if(ye(""),K(null),dt(null),lt(0),$e([]),et({}),Re({}),oe(null),Ve(null),X(null),ge(!1),tt(!1),Pe(null),Z(null),T({}),!W){Te(null),Fe(null),Ze(null),st(null);return}W.cardType==="info"&&W.infoType==="computed"&&Te(t.cogita.library.revision.loadingComputed);let r=!0;return fa(W,xe).then(g=>{!r||!g||(Te(g.prompt),Fe(g.expectedAnswer),$e(g.computedExpected),et(g.computedAnswers),Ze(g.computedValues),oe(g.answerTemplate),Ve(g.outputVariables),X(g.variableValues))}),()=>{r=!1}},[W,t]),a.useEffect(()=>{if(!W||W.cardType!=="info"||W.infoType!=="citation"){Se.current=null,d.current=new Set,Be(null);return}const r=W.description??"",g=(W.label??"").trim(),N=g.replace(/\s+/g," ").trim(),j=r.replace(/\s+/g," ").trim(),B=N&&N!==j?g:t.cogita.library.infoTypes.citation;if(!r){Be(null),Fe(null);return}const w=sa(r);Se.current=w,Te(B);let z=!0;return ma().then(({fragmentKnowness:M})=>{if(!z)return;const D=new Set,ee={};M.forEach((ve,Ae)=>{const[Ee,_e]=Ae.split(":",2);if(Ee!==W.cardId)return;const Ge=Rt(_e);if(!Ge)return;const{fragmentId:gt}=Ge;ee[gt]=ve,ve>=ot&&D.add(gt)}),d.current=D,ke.current=ee;const ce=Rt(W.direction);if(ce!=null&&ce.fragmentId&&w.nodes[ce.fragmentId]){Bt(w,ce.fragmentId,B);return}const be=ua(w,D,ee,ot,nt,W.direction);Bt(w,(be==null?void 0:be.id)??null,B)}).catch(()=>{d.current=new Set,ke.current={};const M=Rt(W.direction);if(M!=null&&M.fragmentId&&w.nodes[M.fragmentId]){Bt(w,M.fragmentId,B);return}const D=ua(w,d.current,{},ot,nt,W.direction);Bt(w,(D==null?void 0:D.id)??null,B)}),()=>{z=!1}},[W,t,nt,ot]),a.useEffect(()=>{if(!W||W.cardType!=="vocab"||W.checkType!=="translation-match"){Z(null),T({});return}const N=(at.pool??at.active??L).filter(M=>M.cardType==="vocab"&&M.checkType==="translation-match").filter((M,D,ee)=>ee.findIndex(ce=>ce.cardId===M.cardId)===D);N.some(M=>M.cardId===W.cardId)||N.unshift(W);const B=Ft(N).slice(0,6).map(M=>{const D=M.label.split("↔").map(be=>be.trim()).filter(Boolean);if(D.length<2)return null;const ee=`${M.cardId}:L`,ce=`${M.cardId}:R`;return{cardId:M.cardId,leftId:ee,rightId:ce,leftLabel:D[0],rightLabel:D[1]}}).filter(Boolean),w=B.map(M=>M.leftId),z=Ft(B.map(M=>M.rightId));Z({pairs:B,leftOrder:w,rightOrder:z,selection:{},activeLeft:null,activeRight:null,locked:{}})},[W,L,at]),a.useEffect(()=>()=>{ne.current&&window.clearTimeout(ne.current),Ce.current&&window.clearTimeout(Ce.current)},[]);const Jt=a.useRef(null);a.useEffect(()=>{if(!W)return;const r=me(W),g=typeof document<"u"?document.activeElement:null;if(Jt.current===r&&g&&(g.tagName==="INPUT"||g.tagName==="TEXTAREA"))return;let N=0;const j=()=>{if(W){if(W.cardType==="info"&&W.infoType==="computed"){if(Ke.length>0){const w=Ba(He,Ke,Le),z=w?Lt.current[w]:null;if(z&&(z.focus(),document.activeElement===z)){Jt.current=r;return}}if(rt.current&&(rt.current.focus(),document.activeElement===rt.current)){Jt.current=r;return}}else if(W.cardType==="vocab"&&rt.current&&(rt.current.focus(),document.activeElement===rt.current)){Jt.current=r;return}N<6&&(N+=1,window.setTimeout(j,40))}},B=window.setTimeout(j,40);return()=>window.clearTimeout(B)},[W,Ke,He,Le]),a.useEffect(()=>{if(!xt)return;const r=g=>{g.key==="Enter"&&(g.preventDefault(),ca())};return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)},[xt]);const Xt=r=>{Ye(r),st(Ot(r))};a.useEffect(()=>{if(!W){st(null),Ye([]);return}const r=W.cardType==="info"?"info":"connection";if(W.cardType==="info"&&W.infoType==="citation"){qt().then(g=>{const N=g.filter(j=>j.itemType==="info"&&j.itemId===W.cardId&&j.checkType==="quote-fragment"&&za(j.direction,W.direction));Xt(N)}).catch(()=>{st(null),Ye([])});return}Ka(r,W.cardId,W.checkType,W.direction).then(g=>Xt(g)).catch(()=>{st(null),Ye([])})},[c,W,F]);const ka=(r,g,N,j)=>{if(r==="info"&&N==="quote-fragment"){qt().then(B=>{const w=B.filter(z=>z.itemType==="info"&&z.itemId===g&&z.checkType==="quote-fragment"&&za(z.direction,j));Xt(w)}).catch(()=>{st(null),Ye([])});return}Ka(r,g,N,j).then(B=>Xt(B)).catch(()=>{st(null),Ye([])})},Na=(r,g,N)=>{var z;const j=((z=N.pairs.find(M=>M.leftId===r))==null?void 0:z.rightId)??null;if(!j)return N;const B=j===g;T(M=>({...M,[r]:B?"correct":"incorrect"})),ne.current&&window.clearTimeout(ne.current),Ce.current&&window.clearTimeout(Ce.current),C.current+=1;const w={kind:B?"correct":"incorrect",tick:C.current};if(ae(null),ne.current=window.setTimeout(()=>ae(w),0),Ce.current=window.setTimeout(()=>ae(null),420),B){const M={...N.locked,[r]:!0};return Object.keys(M).length>=N.pairs.length?(K("correct"),tt(!0)):K("correct"),{...N,selection:{...N.selection,[r]:g},activeLeft:null,activeRight:null,locked:M}}return K("incorrect"),{...N,activeLeft:null,activeRight:null}},la=r=>{Z(g=>!g||g.locked[r]?g:g.activeRight?Na(r,g.activeRight,g):{...g,activeLeft:g.activeLeft===r?null:r})},zt=r=>{Z(g=>g&&(g.activeLeft?Na(g.activeLeft,r,g):{...g,activeRight:g.activeRight===r?null:r}))},ca=()=>{var r;if(W&&W.cardType==="info"&&W.infoType==="citation"&&Se.current&&Me&&!((r=Rt(W.direction))!=null&&r.fragmentId)){const g=ua(Se.current,d.current,ke.current,ot,nt,W.direction,Me.fragmentId);if(g){K(null),ye(""),ge(!1),Re({}),tt(!1),dt(null),lt(0),Bt(Se.current,g.id,Me.title);return}}K(null),ye(""),ge(!1),Re({}),tt(!1),dt(null),lt(0),v(g=>Math.min(g+1,L.length))},Pt=r=>{if(!W)return;const g=r.expected??null,N=r.answer??"";let j=g??"",B=N;if(!g&&r.expectedMap&&r.answerMap){const be=Object.keys(r.expectedMap).sort((ve,Ae)=>ve.localeCompare(Ae));j=be.map(ve=>{var Ae;return((Ae=r.expectedMap)==null?void 0:Ae[ve])??""}).join("|"),B=be.map(ve=>{var Ae;return((Ae=r.answerMap)==null?void 0:Ae[ve])??""}).join("|")}const w=j?ha(j,B,wt):new Uint8Array,z={revisionType:b.id,evalType:r.evalType,direction:r.direction,prompt:je??"",expected:g,answer:N,expectedAnswers:r.expectedMap??null,answers:r.answerMap??null,correct:r.correct,maskBase64:w.length?Yt(w):null,values:we??null,checkMode:he,compareMode:wt,minCorrectness:Ut},M=new TextEncoder().encode(JSON.stringify(z)),D=W.cardType==="info"?"info":"connection",ee=r.overrideCheckType??W.checkType??null,ce=r.overrideDirection??W.direction??null;Fa({itemType:D,itemId:W.cardId,checkType:ee,direction:ce,revisionType:b.id,evalType:r.evalType,correct:r.correct,maskBase64:w.length?Yt(w):null,payloadBase64:Yt(M),personRoleId:F??null}).then(()=>{ka(D,W.cardId,ee,ce),ia(L),is(c,F)}).catch(()=>{})},Zt=(r,g)=>{const N=ut.current.get(g);if(N)return Promise.resolve(N);const j=it.current.get(g);if(j)return j;const B=Qt({libraryId:c,infoId:r}).then(w=>{var be,ve;const z=w.payload,M=((be=z.definition)==null?void 0:be.graph)??null,D="",ee=((ve=z.definition)==null?void 0:ve.answerTemplate)??"",ce=un(M,D,ee);if(ce){const Ee={sample:hn(ce),answerTemplate:ee||null};return ut.current.set(g,Ee),Ee}return Cs({libraryId:c,infoId:r}).then(Ae=>{const Ee={sample:Ae,answerTemplate:null};return ut.current.set(g,Ee),Ee})}).catch(()=>Cs({libraryId:c,infoId:r}).then(w=>{const z={sample:w,answerTemplate:null};return ut.current.set(g,z),z}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{it.current.delete(g)});return it.current.set(g,B),B},fa=(r,g)=>{var M;const N=`${me(r)}:${g}`,j=bt.current.get(N);if(j)return Promise.resolve(j);const B=ft.current.get(N);if(B)return B;const w=D=>(bt.current.set(N,D),D);let z;if(r.cardType==="vocab"){if(r.checkType==="translation-match")return z=Promise.resolve(w({prompt:r.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),z;const D=r.label.split("↔").map(ee=>ee.trim()).filter(Boolean);if(D.length>=2){const ce=(r.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",be=ce?D[0]:D[1],ve=ce?D[1]:D[0];z=Promise.resolve(w({prompt:be,expectedAnswer:ve,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else z=Promise.resolve(w({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(r.cardType==="info"&&r.infoType==="word"){const D=(M=r.description)!=null&&M.startsWith("Language: ")?r.description.replace("Language: ",""):null;z=Promise.resolve(w({prompt:r.label,expectedAnswer:D,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else r.cardType==="info"&&r.infoType==="computed"?z=Zt(r.cardId,N).then(D=>{var Ae,Ee;if(!D.sample)return w({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const ee=D.sample,ce=ee.expectedAnswers?Object.entries(ee.expectedAnswers).map(([_e,Ge])=>({key:_e,expected:Ge})):[],be=ce.reduce((_e,Ge)=>(_e[Ge.key]="",_e),{}),ve=ee.expectedAnswerIsSentence&&((Ae=ee.expectedAnswer)==null?void 0:Ae.trim())||null;return w({prompt:ee.prompt,expectedAnswer:ce.length>0?ve:((Ee=ee.expectedAnswer)==null?void 0:Ee.trim())||null,computedExpected:ce,computedAnswers:be,computedValues:ee.values??null,answerTemplate:D.answerTemplate,outputVariables:ee.outputVariables??null,variableValues:ee.variableValues??null})}).catch(()=>w({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{ft.current.delete(N)}):z=Promise.resolve(w({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return ft.current.set(N,z),z},Bt=(r,g,N)=>{const j=Object.keys(r.nodes).length,B=d.current.size;if(!g){Be({title:N,before:r.text,after:"",fragmentId:null,total:j,completed:B}),Fe(null),tt(!0);return}const w=r.nodes[g];if(!w)return;const z=ys(r.text,w);Be({title:N,before:z.before,after:z.after,fragmentId:w.id,total:j,completed:B}),Fe(z.fragment),tt(!1)},Sa=()=>{const r=Se.current;r&&Be(g=>g&&{...g,total:Object.keys(r.nodes).length,completed:d.current.size})},da=()=>{const r=L[xe+1];r&&fa(r,xe+1)},Ta=()=>{if(da(),W&&W.cardType==="vocab"&&W.checkType==="translation-match"&&A){if(A.pairs.length===0){K("incorrect"),tt(!0);return}const w=A.pairs.reduce((ve,Ae)=>(ve[Ae.rightId]=Ae.rightLabel,ve),{});let z=0;const M={};A.pairs.forEach(ve=>{const Ee=A.selection[ve.leftId]===ve.rightId;M[ve.leftId]=Ee?"correct":"incorrect",Ee&&(z+=1)});const D=A.pairs.length||1,ee=z/D,ce=z===A.pairs.length;T(ve=>({...ve,...M})),ce?(K("correct"),tt(!0),lt(0)):(K("incorrect"),tt(!1),lt(ve=>{const Ae=ve+1;return Ae>=vt&&(ge(!0),tt(!0),Z(Ee=>{if(!Ee)return Ee;const _e=Ee.pairs.reduce((Ge,gt)=>(Ge[gt.leftId]=gt.rightId,Ge),{});return{...Ee,selection:_e}})),Ae})),Nt(ce,ee);const be="connection";Promise.all(A.pairs.map(ve=>{const Ae=A.selection[ve.leftId]??null,Ee=Ae?w[Ae]:"",_e={left:ve.leftLabel,expected:ve.rightLabel,answer:Ee,checkType:"translation-match"},Ge=new TextEncoder().encode(JSON.stringify(_e));return Fa({itemType:be,itemId:ve.cardId,checkType:"translation-match",direction:null,revisionType:b.id,evalType:"translation-match",correct:Ae===ve.rightId,maskBase64:null,payloadBase64:Yt(Ge),personRoleId:F??null})})).then(()=>{ka(be,W.cardId,W.checkType,W.direction),is(c,F)}).catch(()=>{});return}if(Ke.length>0){const w=Ke.reduce((M,D)=>{const ee=De[D.key]??"";return M[D.key]=St(ee)===St(D.expected)?"correct":"incorrect",M},{});Ke.every(({key:M,expected:D})=>{const ee=De[M]??"";return he==="exact"&&St(ee)===St(D)})?(K("correct"),Re(w),tt(!0),lt(0),Nt(!0,1),Pt({correct:!0,direction:je?`${je} -> computed`:"computed",expectedMap:Ke.reduce((M,D)=>(M[D.key]=D.expected,M),{}),answerMap:De,evalType:"computed"})):(K("incorrect"),Re(w),tt(!1),lt(M=>{const D=M+1;return D>=vt&&U&&(ge(!0),tt(!0)),D}),Nt(!1,0),window.setTimeout(()=>{var D;const M=Ba(He,Ke,Le);M&&Lt.current[M]&&((D=Lt.current[M])==null||D.focus())},40),Pt({correct:!1,direction:je?`${je} -> computed`:"computed",expectedMap:Ke.reduce((M,D)=>(M[D.key]=D.expected,M),{}),answerMap:De,evalType:"computed"}));return}if(W&&W.cardType==="info"&&W.infoType==="citation"&&(Me!=null&&Me.fragmentId)){if(!Ne)return;const w=Rt(W.direction),z=(w==null?void 0:w.fragmentId)??Me.fragmentId,M=Ea(Ne,O,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),D=M.mask,ee=M.isCorrect,ce=M.percent;ee?(ke.current[Me.fragmentId]=Math.max(ke.current[Me.fragmentId]??0,ce),(ke.current[Me.fragmentId]??0)>=ot&&d.current.add(Me.fragmentId),Sa(),K("correct"),Re({}),tt(!0),dt(D),lt(0),ce<100&&vt<=1&&ge(!0),Nt(!0,ce/100),Pt({correct:!0,direction:`quote:${Me.fragmentId}`,expected:Ne,answer:O,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:z})):(K("incorrect"),Re({}),tt(!1),dt(D),lt(be=>{const ve=be+1;return ve>=vt&&U&&(ge(!0),tt(!0)),ve}),Nt(!1,ce/100),window.setTimeout(()=>{var be;return(be=rt.current)==null?void 0:be.focus()},40),Pt({correct:!1,direction:`quote:${Me.fragmentId}`,expected:Ne,answer:O,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:z}));return}if(!Ne)return;const r=ha(Ne,O,wt),g=he==="exact"&&St(O)===St(Ne),N=ga(r),j=g||N,B=Gt(r);j?(K("correct"),Re({}),tt(!0),dt(r),lt(0),B<100&&vt<=1&&ge(!0),Nt(!0,B/100),Pt({correct:!0,direction:je?`${je} -> ${Ne}`:null,expected:Ne,answer:O,evalType:"text"})):(K("incorrect"),Re({}),tt(!1),dt(r),lt(w=>{const z=w+1;return z>=vt&&U&&(ge(!0),tt(!0)),z}),Nt(!1,B/100),window.setTimeout(()=>{var w;return(w=rt.current)==null?void 0:w.focus()},40),Pt({correct:!1,direction:je?`${je} -> ${Ne}`:null,expected:Ne,answer:O,evalType:"text"}))},Qa=r=>{if(da(),!Ne)return;const g=ha(Ne,r,wt),N=St(r)===St(Ne),j=ga(g),B=N||j,w=Gt(g);B?(K("correct"),Re({}),tt(!0),dt(g),lt(0),w<100&&vt<=1&&ge(!0),Nt(!0,w/100),Pt({correct:!0,direction:"word->language",expected:Ne,answer:r,evalType:"language-select"})):(K("incorrect"),Re({}),tt(!1),dt(g),lt(z=>{const M=z+1;return M>=vt&&U&&(ge(!0),tt(!0)),M}),Nt(!1,w/100),Pt({correct:!1,direction:"word->language",expected:Ne,answer:r,evalType:"language-select"}))},Ga=()=>{da(),K("correct"),tt(!0),lt(0),Nt(!0,1),Ne&&Pt({correct:!0,direction:"manual",expected:Ne,answer:O,evalType:"manual"})},Ja=()=>{if(Nt(!1,0),W&&W.cardType==="info"&&W.infoType==="citation"){K(null),ye(""),ge(!1),Re({}),tt(!1),dt(null),lt(0),v(r=>Math.min(r+1,L.length));return}ca()};a.useEffect(()=>{da()},[xe,L]);const ea=r=>{var N;if(r.key!=="Enter")return;if(r.preventDefault(),r.stopPropagation(),xt){ca();return}const g=Ke.find(j=>!(De[j.key]??"").trim());if(g){(N=Lt.current[g.key])==null||N.focus();return}Ta()},$=t.cogita.library.revision.revealModeAfterIncorrect,U=Ke.length>0||!!Ne;return e.jsxs(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,children:[de==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${pe.total?Math.min(100,Math.max(0,pe.current/pe.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:pe.total?`${Math.min(pe.current,pe.total)} / ${pe.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:E}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",y).replace("{check}",H)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:k,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${k}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${k}/collections/${x}`,children:t.cogita.library.actions.collectionDetail})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:le?`${le.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Kt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Kt.currentLevel??"-"," / ",Kt.levelsCount]}):null,le?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(le.correct)).replace("{total}",String(le.total))}),le.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(le.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(gn,{outcomes:Oe})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[ct?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:ct})}):null,e.jsx(xs,{feedbackToken:G?`${G.kind}-${G.tick}`:te?"idle":Q??"idle",children:W?e.jsx(e.Fragment,{children:_?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(vs,{copy:t,currentCard:W,currentTypeLabel:Mt,prompt:je,languages:re,answer:O,onAnswerChange:r=>ye(g=>Da(g,r,Ie)),computedExpected:Ke,computedAnswers:De,onComputedAnswerChange:(r,g)=>et(N=>({...N,[r]:Da(N[r]??"",g,Ie)})),answerTemplate:He,outputVariables:Le,variableValues:Xe,computedFieldFeedback:Je,feedback:Q,canAdvance:xt,quoteContext:Me,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Ta,onSkip:Ja,onLanguageSelect:Qa,onMarkReviewed:Ga,onAdvance:ca,showCorrectAnswer:se,setShowCorrectAnswer:ge,onRevealCorrect:()=>tt(!0),answerMask:Ct,expectedAnswer:Ne,hasExpectedAnswer:U,handleComputedKeyDown:ea,answerInputRef:rt,computedInputRefs:Lt,scriptMode:Ie,setScriptMode:Pe,matchPairs:A==null?void 0:A.pairs,matchLeftOrder:A==null?void 0:A.leftOrder,matchRightOrder:A==null?void 0:A.rightOrder,matchSelection:A==null?void 0:A.selection,matchActiveLeft:A==null?void 0:A.activeLeft,matchActiveRight:A==null?void 0:A.activeRight,matchFeedback:fe,onMatchLeftSelect:la,onMatchRightSelect:zt})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${k}/collections/${x}`,children:t.cogita.library.actions.collectionDetail})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Ht?`${Dt} / ${Ht}`:t.cogita.library.revision.progressUnlimited}),de==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),de==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),de==="ready"&&L.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:$}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",vt]})]})]}),Kt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Kt.activeCount," / ",Kt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Kt.counts.map((r,g)=>{const N=g+1,j=Kt.currentLevel===N,B=Kt.percentages[g]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":j,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:N}),e.jsx("strong",{children:r})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,B))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[B.toFixed(1),"%"]})]},`level-${N}`)})})]}):null,kt?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:kt.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:kt.dots.map(r=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,r.value*100))}%`,background:`rgba(${Math.round(255*(1-r.value))}, ${Math.round(200*r.value)}, 80, 0.9)`}},r.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:kt.knownCount})]})]}):null,nt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:oa})]})}):null]})]})]})})})]})]})}const rs=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],Qi={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},Gi=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Ji=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function Xi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,libraryId:c,collectionId:x}){const[o,u]=a.useState(""),[k,Y,q]=Us([]),[V,b,h]=Ws([]),[he,F]=a.useState(null),[y,H]=a.useState(null),[E,J]=a.useState(null),L=`/#/cogita/library/${c}`;a.useEffect(()=>{Va(c,x).then(S=>u(S.name)).catch(()=>u(t.cogita.library.collections.defaultName))},[c,x,t]),a.useEffect(()=>{Kn({libraryId:c,collectionId:x}).then(S=>{if(!S.graphId||S.graphId==="00000000-0000-0000-0000-000000000000"){Y([]),b([]);return}const xe=S.nodes.map(O=>{var je;const ye=O.payload??{},Q=ye.position??{x:120,y:120},K=ye.params??{};return{id:O.nodeId,type:"default",position:Q,data:{nodeType:O.nodeType,label:((je=rs.find(Te=>Te.type===O.nodeType))==null?void 0:je.label)??O.nodeType,params:K}}}),v=S.edges.map(O=>({id:O.edgeId,source:O.fromNodeId,target:O.toNodeId,sourceHandle:O.fromPort??void 0,targetHandle:O.toPort??void 0}));Y(xe),b(v)}).catch(()=>{Y([]),b([])})},[c,x,b,Y]);const P=a.useMemo(()=>k.find(S=>S.id===he)??null,[k,he]),re=S=>{var ye;const xe=crypto.randomUUID(),v=((ye=rs.find(Q=>Q.type===S))==null?void 0:ye.label)??S,O={...Qi[S]};Y(Q=>[...Q,{id:xe,type:"default",position:{x:120+Q.length*40,y:120+Q.length*40},data:{nodeType:S,label:v,params:O}}]),F(xe)},ue=a.useCallback(S=>{b(xe=>Hs({...S,id:crypto.randomUUID()},xe))},[b]),de=async()=>{H(null);try{await Dn({libraryId:c,collectionId:x,nodes:k.map(S=>({nodeId:S.id,nodeType:S.data.nodeType,payload:{position:S.position,params:S.data.params}})),edges:V.map(S=>({edgeId:S.id,fromNodeId:S.source,fromPort:S.sourceHandle??null,toNodeId:S.target,toPort:S.targetHandle??null}))}),H(t.cogita.library.graph.saveSuccess)}catch{H(t.cogita.library.graph.saveFail)}},ze=async()=>{try{const S=await zn({libraryId:c,collectionId:x});J(S)}catch{J(null)}},pe=S=>{P&&Y(xe=>xe.map(v=>v.id===P.id?{...v,data:{...v.data,params:S}}:v))};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:o}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${L}/collections/${x}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ze,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:de,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:rs.map(S=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>re(S.type),children:S.label},S.type))}),y?e.jsx("p",{className:"cogita-help",children:y}):null,E&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(E.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(E.connections)).replace("{infos}",String(E.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(gs,{nodes:k,edges:V,onNodesChange:q,onEdgesChange:h,onConnect:ue,onNodeClick:(S,xe)=>F(xe.id),fitView:!0,children:[e.jsx(ms,{color:"rgba(120,160,200,0.2)"}),e.jsx(ps,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),P?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:P.data.label}),P.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(aa,{libraryId:c,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:P.data.params.tagId?{id:P.data.params.tagId,label:P.data.params.tagLabel??"",infoType:"topic"}:null,onChange:S=>pe({...P.data.params,tagId:(S==null?void 0:S.id)??null,tagLabel:(S==null?void 0:S.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:P.data.params.scope??"any",onChange:S=>pe({...P.data.params,scope:S.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),P.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(aa,{libraryId:c,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:P.data.params.languageId?{id:P.data.params.languageId,label:P.data.params.languageLabel??"",infoType:"language"}:null,onChange:S=>pe({...P.data.params,languageId:(S==null?void 0:S.id)??null,languageLabel:(S==null?void 0:S.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:P.data.params.scope??"any",onChange:S=>pe({...P.data.params,scope:S.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),P.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:P.data.params.infoType??"word",onChange:S=>pe({...P.data.params,infoType:S.target.value}),children:Ji.map(S=>e.jsx("option",{value:S.value,children:S.label},S.value))})]}),e.jsx(aa,{libraryId:c,infoType:P.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:P.data.params.infoId?{id:P.data.params.infoId,label:P.data.params.infoLabel??"",infoType:P.data.params.infoType??"word"}:null,onChange:S=>pe({...P.data.params,infoId:(S==null?void 0:S.id)??null,infoLabel:(S==null?void 0:S.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),P.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:P.data.params.connectionType??"translation",onChange:S=>pe({...P.data.params,connectionType:S.target.value}),children:Gi.map(S=>e.jsx("option",{value:S.value,children:S.label},S.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:P.data.params.connectionId??"",onChange:S=>pe({...P.data.params,connectionId:S.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(P.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const os="cogita.preferences",ls="cogita.reviewer.preferences",bn=["library_overview","all_cards","all_collections","storyboards","texts","dependencies","transfer"],cs={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},ds=["settings","run","shared"];function Zi(t,s=""){const n=t.split("/").filter(Boolean);if(n[0]!=="cogita"||n[1]!=="library")return{};const i=n[2];if(!i)return{};if(!n[3])return{libraryId:i,target:"library_overview"};const l=new URLSearchParams(s),p=l.get("revisionId")??void 0,m=l.get("infoId")??void 0,f=l.get("infoView")==="cards"?"cards":"overview",R=l.get("collectionAction"),I=l.get("libraryAction");if(n[3]==="list")return{libraryId:i,target:I==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:p,infoId:m,infoView:f,libraryAction:I==="new-info"?"new-info":void 0};if(n[3]==="detail"||n[3]==="collection")return{libraryId:i,target:"all_cards",cardMode:n[3],revisionId:p,infoId:m,infoView:f};if(n[3]==="new"||n[3]==="add")return{libraryId:i,target:"new_card",revisionId:p,libraryAction:"new-info"};if(n[3]==="edit")return{libraryId:i,target:"new_card",revisionId:p,infoId:n[4]};if(n[3]==="infos"){const x=n[4];return x?n[5]==="checkcards"?{libraryId:i,target:"all_cards",cardMode:"list",revisionId:p,infoId:x,infoView:"cards"}:{libraryId:i,target:"all_cards",cardMode:"list",revisionId:p,infoId:x,infoView:"overview"}:{libraryId:i,target:"all_cards",cardMode:"list",revisionId:p}}if(n[3]==="shared-revisions")return{libraryId:i,target:"all_collections",revisionId:p};if(n[3]==="dependencies")return{libraryId:i,target:"dependencies"};if(n[3]==="transfer")return{libraryId:i,target:"transfer"};if(n[3]==="storyboards")return n[4]==="new"?{libraryId:i,target:"new_storyboard"}:{libraryId:i,target:"storyboards"};if(n[3]==="texts")return n[4]==="new"?{libraryId:i,target:"new_text"}:{libraryId:i,target:"texts"};if(n[3]!=="collections")return{libraryId:i,target:"library_overview"};if(n[4]==="new")return{libraryId:i,target:"new_collection",revisionId:p};const c=n[4];return c?n[5]==="graph"?{libraryId:i,target:"all_collections",collectionId:c,revisionId:p,revisionView:"graph"}:n[5]==="shared-revisions"?{libraryId:i,target:"all_collections",collectionId:c,revisionId:p,revisionView:"shared"}:n[5]==="revision"?{libraryId:i,target:"all_collections",collectionId:c,revisionId:p,revisionView:n[6]==="run"?"run":"settings"}:R==="new-revision"?{libraryId:i,target:"all_collections",collectionId:c,revisionId:p,revisionView:"new"}:{libraryId:i,target:"all_collections",collectionId:c,revisionId:p,revisionView:"detail"}:R==="new-collection"?{libraryId:i,target:"new_collection",collectionAction:"new-collection"}:{libraryId:i,target:"all_collections"}}function Os(t,s="library_overview",n,i,l,p,m="overview"){const f=(R,I)=>{const c=new URLSearchParams;I!=null&&I.revisionId&&c.set("revisionId",I.revisionId),I!=null&&I.collectionAction&&c.set("collectionAction",I.collectionAction),I!=null&&I.libraryAction&&c.set("libraryAction",I.libraryAction),I!=null&&I.infoId&&c.set("infoId",I.infoId),I!=null&&I.infoView&&(I!=null&&I.infoId)&&c.set("infoView",I.infoView);const x=c.toString();return x?`${R}?${x}`:R};return t?s==="library_overview"?f(`/cogita/library/${t}`,{revisionId:l}):s==="all_cards"?p?m==="cards"?f(`/cogita/library/${t}/infos/${p}/checkcards`,{revisionId:l}):f(`/cogita/library/${t}/infos/${p}`,{revisionId:l}):f(`/cogita/library/${t}/list`,{revisionId:l,infoId:p,infoView:m}):s==="new_card"?p?f(`/cogita/library/${t}/edit/${p}`,{revisionId:l}):f(`/cogita/library/${t}/list`,{revisionId:l,libraryAction:"new-info"}):s==="all_collections"?n?i==="graph"?f(`/cogita/library/${t}/collections/${n}/graph`,{revisionId:l}):i==="settings"?f(`/cogita/library/${t}/collections/${n}/revision`,{revisionId:l}):i==="run"?f(`/cogita/library/${t}/collections/${n}/revision/run`,{revisionId:l}):i==="shared"?f(`/cogita/library/${t}/collections/${n}/shared-revisions`,{revisionId:l}):i==="new"?f(`/cogita/library/${t}/collections/${n}`,{revisionId:l,collectionAction:"new-revision"}):f(`/cogita/library/${t}/collections/${n}`,{revisionId:l}):f(`/cogita/library/${t}/collections`,{revisionId:l}):s==="new_collection"?f(`/cogita/library/${t}/collections`,{revisionId:l,collectionAction:"new-collection"}):s==="transfer"?f(`/cogita/library/${t}/transfer`,{revisionId:l}):s==="storyboards"?f(`/cogita/library/${t}/storyboards`,{revisionId:l}):s==="new_storyboard"?f(`/cogita/library/${t}/storyboards/new`,{revisionId:l}):s==="texts"?f(`/cogita/library/${t}/texts`,{revisionId:l}):s==="new_text"?f(`/cogita/library/${t}/texts/new`,{revisionId:l}):s==="dependencies"?f(`/cogita/library/${t}/dependencies`,{revisionId:l}):f(`/cogita/library/${t}`,{revisionId:l}):"/cogita"}function ya(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function er(t){return typeof t=="string"&&bn.includes(t)}function tr(t,s){var f;if(!t.length)return null;const n=t.filter(R=>s.has(R.roleId)),i=n.length>0?n:t,l=i.map(R=>{var c,x;const I=((x=(c=R.fields.find(o=>o.fieldType==="role_kind"))==null?void 0:c.plainValue)==null?void 0:x.toLowerCase())??"";return{roleId:R.roleId,roleKind:I}}),p=l.find(R=>R.roleKind.includes("master"));if(p)return p.roleId;const m=l.find(R=>R.roleKind.includes("account")||R.roleKind.includes("user"));return m?m.roleId:((f=i[0])==null?void 0:f.roleId)??null}function ar(t){if(!t)return{version:1,byLibrary:{}};try{const s=JSON.parse(t);return!s||typeof s!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:s.lastLibraryId,byLibrary:s.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function sr({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I}){const c=qs(),x=_a(),o=a.useMemo(()=>Zi(x.pathname,x.search),[x.pathname,x.search]),u=t.cogita.workspace,[k,Y]=a.useState([]),[q,V]=a.useState([]),[b,h]=a.useState([]),[he,F]=a.useState([]),[y,H]=a.useState(void 0),[E,J]=a.useState("library_overview"),[L,P]=a.useState(void 0),[re,ue]=a.useState(void 0),[de,ze]=a.useState("detail"),[pe,S]=a.useState(void 0),[xe,v]=a.useState(!1),[O,ye]=a.useState(!0),[Q,K]=a.useState(!1),[je,Te]=a.useState(!1),[Ne,Fe]=a.useState(null),[Me,Be]=a.useState(0),[Ke,$e]=a.useState(""),[De,et]=a.useState(""),[Je,Re]=a.useState(""),[we,Ze]=a.useState([]),[He,oe]=a.useState(""),[Le,Ve]=a.useState(null),[Xe,X]=a.useState(null),A=a.useRef({version:1,byLibrary:{}}),Z=a.useRef(!1),fe=a.useRef(!1),T=a.useRef(null),C=a.useMemo(()=>k.find(d=>d.libraryId===y)??null,[k,y]),G=a.useMemo(()=>q.find(d=>d.collectionId===L)??null,[q,L]);a.useEffect(()=>{if(!y){Ze([]),oe("");return}let d=!1;return nn({libraryId:y}).then(ke=>{if(d)return;const W=ke.filter(te=>(te.roleKind??"").trim().toLowerCase()==="person");Ze(W);try{const te=window.localStorage.getItem(ls),it=(te?JSON.parse(te):{})[y]??"",bt=it&&W.some(ft=>ft.roleId===it)?it:"";oe(bt)}catch{oe("")}}).catch(()=>{d||(Ze([]),oe(""))}),()=>{d=!0}},[y]),a.useEffect(()=>{if(y)try{const d=window.localStorage.getItem(ls),ke=d?JSON.parse(d):{};He?ke[y]=He:delete ke[y],window.localStorage.setItem(ls,JSON.stringify(ke))}catch{}},[y,He]);const ae=a.useMemo(()=>he.find(d=>d.revisionId===re)??null,[he,re]),ne=a.useMemo(()=>({detail:u.revisions.detail,graph:u.revisions.graph,settings:u.revisions.settings,run:u.revisions.run,shared:u.targets.sharedRevisions,new:u.revisionForm.createAction}),[u.revisions.detail,u.revisions.graph,u.revisions.run,u.revisions.settings,u.targets.sharedRevisions,u.revisionForm.createAction]),Ce=a.useMemo(()=>[{value:"detail",label:ne.detail},{value:"graph",label:ne.graph},{value:"settings",label:u.targets.allRevisions},{value:"run",label:ne.run},{value:"shared",label:ne.shared}],[ne.detail,ne.graph,ne.run,ne.shared,u.targets.allRevisions]),Ie=a.useMemo(()=>E==="new_card"?"all_cards":E==="new_collection"?"all_collections":E==="new_storyboard"?"storyboards":E==="new_text"?"texts":E,[E]),Pe=a.useMemo(()=>de==="new"?"settings":de,[de]),se=a.useMemo(()=>o.infoId?"selected":E==="new_card"?"create":"search",[o.infoId,E]),ge=a.useMemo(()=>b.find(d=>d.infoId===o.infoId)??null,[b,o.infoId]),le=a.useMemo(()=>({library_overview:u.targets.libraryOverview,all_cards:u.targets.allCards,new_card:u.targets.newCard,all_collections:u.targets.allCollections,new_collection:u.targets.newCollection,transfer:u.targets.transfer,storyboards:u.targets.storyboards,new_storyboard:u.targets.newStoryboard,texts:u.targets.texts,new_text:u.targets.newText,dependencies:u.targets.dependencies}),[u.targets]),st=a.useMemo(()=>le[Ie]??Ie,[Ie,le]),Oe=ne[Pe],Ye=!!y,ct=a.useMemo(()=>{const d=R==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":R==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return R==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:d},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:d},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:d},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:d},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:d},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:d},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:d},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:d},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:d},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:d},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:d},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:d},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:d},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:R==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:d},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:d},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:d},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:d},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:d},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:d},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:d},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:d},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:d},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:d},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:d},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:d},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:d},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:d},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:d},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:d},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:d},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:d},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:d},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:d},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:d},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:d},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:d},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:d},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:d},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:d},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[R]),yt=ct.length,Ue=Math.max(0,Math.min(Me,yt-1)),We=ct[Ue],Ct=!!L,dt=Ye&&E==="all_collections",It=Ct&&E==="all_collections",lt=Ct&&E==="all_collections"&&ds.includes(de),rt=a.useCallback(d=>{const ke=!!d.libraryId;let W=d.target,te=d.collectionId,ut=d.revisionId,it=d.revisionView,bt=d.infoId,ft=d.infoView??o.infoView??"overview";ke?cs[W].requiresCollection&&!te?(W="all_collections",ut=void 0,it="detail"):W!=="all_collections"?(te=void 0,ut=void 0,W!=="new_card"&&W!=="all_cards"&&(bt=void 0,ft="overview")):cs[W].allowsRevision?ds.includes(it)||(ut=void 0):it="detail":(W="library_overview",te=void 0,ut=void 0,it="detail",bt=void 0,ft="overview"),H(d.libraryId),J(W),P(te),ue(ut),ze(it),v(!1);const Mt=ya(Os(d.libraryId,W,te,it,ut,bt,ft));ya(`${x.pathname}${x.search}`)!==Mt&&(T.current=Mt,c(Mt))},[x.pathname,x.search,c,o.infoView]),Lt=d=>{rt({libraryId:y,target:"all_collections",collectionId:L,revisionId:ds.includes(d)?re:void 0,revisionView:d})},xt=a.useMemo(()=>[{key:"library",label:u.layers.library,visible:!0,value:y??"",selectedLabel:(C==null?void 0:C.name)??u.path.noLibrarySelected,disabled:O||k.length===0,options:k.map(d=>({value:d.libraryId,label:d.name})),emptyOption:u.noLibraryOption,onSelect:d=>{const ke=d||void 0;rt({libraryId:ke,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:u.layers.target,visible:Ye,value:Ie,selectedLabel:st,disabled:!Ye,options:bn.map(d=>({value:d,label:le[d]})),onSelect:d=>{const ke=d;rt({libraryId:y,target:ke,collectionId:L,revisionId:re,revisionView:de,infoId:ke==="new_card"?o.infoId:void 0})}},{key:"info_mode",label:u.layers.target,visible:Ie==="all_cards",value:se,selectedLabel:se==="create"?u.infoMode.create:se==="selected"?(ge==null?void 0:ge.label)??pe??t.cogita.library.list.selectedEmpty:u.infoMode.search,disabled:!Ye,options:[{value:"search",label:u.infoMode.search},{value:"create",label:u.infoMode.create},...o.infoId?[{value:"selected",label:(ge==null?void 0:ge.label)??pe??t.cogita.library.list.selectedEmpty}]:[]],onSelect:d=>{if(d==="selected"){if(!o.infoId)return;rt({libraryId:y,target:"all_cards",collectionId:L,revisionId:re,revisionView:de,infoId:o.infoId,infoView:"overview"});return}if(d==="create"){rt({libraryId:y,target:"new_card",collectionId:L,revisionId:re,revisionView:de,infoId:void 0});return}rt({libraryId:y,target:"all_cards",collectionId:L,revisionId:re,revisionView:de,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:u.layers.target,visible:Ie==="all_cards"&&!!o.infoId,value:E==="new_card"&&o.infoId?"edit":o.infoView==="cards"?"cards":"overview",selectedLabel:E==="new_card"&&o.infoId?u.infoActions.edit:o.infoView==="cards"?u.infoActions.seeCards:u.infoActions.overview,disabled:!Ye||!o.infoId,options:[{value:"overview",label:u.infoActions.overview},{value:"edit",label:u.infoActions.edit},{value:"cards",label:u.infoActions.seeCards}],onSelect:d=>{if(o.infoId){if(d==="edit"){rt({libraryId:y,target:"new_card",collectionId:L,revisionId:re,revisionView:de,infoId:o.infoId});return}if(d==="cards"){rt({libraryId:y,target:"all_cards",collectionId:L,revisionId:re,revisionView:de,infoId:o.infoId,infoView:"cards"});return}rt({libraryId:y,target:"all_cards",collectionId:L,revisionId:re,revisionView:de,infoId:o.infoId,infoView:"overview"})}}},{key:"collection",label:u.layers.collection,visible:dt,value:L??"",selectedLabel:(G==null?void 0:G.name)??u.path.noCollectionSelected,disabled:!Ye||Q||q.length===0,options:q.map(d=>({value:d.collectionId,label:d.name})),emptyOption:u.selectCollectionOption,onSelect:d=>{rt({libraryId:y,target:"all_collections",collectionId:d||void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection_action",label:u.layers.revision,visible:It,value:Pe,selectedLabel:Oe,disabled:!L,options:Ce.map(d=>({value:d.value,label:d.label})),onSelect:d=>{Lt(d)}},{key:"revision_entry",label:u.layers.revision,visible:lt,value:re??"",selectedLabel:(ae==null?void 0:ae.name)??u.status.noRevisions,disabled:!Ct||je||he.length===0,options:he.map(d=>({value:d.revisionId,label:d.name})),emptyOption:u.status.noRevisions,onSelect:d=>{rt({libraryId:y,target:"all_collections",collectionId:L,revisionId:d||void 0,revisionView:de})}}],[Ce,q,Q,se,b,k,O,rt,he,je,G,L,ge,ae,re,pe,Ct,Ye,C,y,Oe,de,E,Pe,Ie,st,dt,It,lt,le,t.cogita.library.list.selectedEmpty,o.infoId,o.infoView,u.infoActions.edit,u.infoActions.overview,u.infoActions.seeCards,u.layers.collection,u.layers.library,u.layers.revision,u.layers.target,u.noLibraryOption,u.path.noCollectionSelected,u.path.noLibrarySelected,u.selectCollectionOption]),tt=a.useMemo(()=>xt.filter(d=>d.visible),[xt]),at=a.useMemo(()=>tt.filter(d=>d.key!=="library"&&d.key!=="collection"&&d.key!=="revision_entry"),[tt]),At=a.useMemo(()=>at.find(d=>d.key==="target")??null,[at]),$t=a.useMemo(()=>at.find(d=>d.key==="info_mode")??null,[at]),Qe=a.useMemo(()=>at.find(d=>d.key==="info_selected_action")??null,[at]),ht=a.useMemo(()=>at.find(d=>d.key==="collection_action")??null,[at]),pt=a.useCallback((d,ke)=>d?e.jsx("div",{className:"cogita-sidebar-actions",children:d.options.map(W=>e.jsx("button",{type:"button",className:`ghost ${String(d.value)===W.value?"active":""}`,onClick:()=>d.onSelect(W.value),disabled:d.disabled,children:W.label},`${ke}:${d.key}:${W.value}`))}):null,[]),jt=a.useMemo(()=>{const d=o.libraryId;if(!d||!x.pathname.startsWith("/cogita/library/"))return null;const ke={copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,libraryId:d};if(o.target==="library_overview")return e.jsx(ni,{...ke});if(o.target==="all_cards")return o.infoId&&o.infoView==="cards"?e.jsx(Ni,{...ke,infoId:o.infoId,selectedReviewerRoleId:He||null}):e.jsx(ui,{...ke,mode:o.cardMode??"list"});if(o.target==="new_card")return e.jsx(yi,{...ke,editInfoId:o.infoId});if(o.target==="dependencies")return e.jsx(vi,{...ke});if(o.target==="transfer")return e.jsx(Ti,{...ke});if(o.target==="storyboards"||o.target==="new_storyboard")return e.jsx(Ci,{...ke});if(o.target==="texts"||o.target==="new_text")return e.jsx(Mi,{...ke});if(o.target==="all_collections"){if(o.collectionId){const W={...ke,collectionId:o.collectionId};return o.revisionView==="graph"?e.jsx(Xi,{...W}):o.revisionView==="shared"?e.jsx(Si,{...ke,collectionId:o.collectionId}):o.revisionView==="settings"?e.jsx(zi,{...W,revisionId:o.revisionId}):o.revisionView==="run"?e.jsx(Yi,{...W,revisionId:o.revisionId}):e.jsx(Ii,{...W})}return e.jsx(Vs,{...ke})}return o.target==="new_collection"?e.jsx(Vs,{...ke}):null},[s,t,R,x.pathname,c,I,p,f,i,l,o.cardMode,o.collectionId,o.infoId,o.libraryId,o.revisionId,o.revisionView,o.target,m,n,He]);a.useEffect(()=>{let d=!1;return(async()=>{var W,te,ut,it,bt;ye(!0);try{await Bn();const[ft,Mt,na]=await Promise.all([Gs(),_n(),Vn()]);if(d)return;Y(ft);const Ht=new Set(na.nodes.filter(nt=>nt.nodeType==="role"&&nt.canLink).map(nt=>nt.roleId??"")),Dt=tr(Mt,Ht);if(Ve(Dt),Dt){const nt=na.nodes.find(ot=>ot.nodeType==="data"&&ot.roleId===Dt&&(ot.fieldType===os||ot.label===os));X((nt==null?void 0:nt.dataKeyId)??null),A.current=ar(nt==null?void 0:nt.value)}const vt=(W=ft.find(nt=>nt.libraryId===o.libraryId))==null?void 0:W.libraryId,wt=vt?(ut=(te=A.current.byLibrary)==null?void 0:te[vt])==null?void 0:ut.lastTarget:void 0,Ut=er(wt)?wt:"library_overview";H(vt),J(o.target??Ut),ue(o.revisionId??(vt?(bt=(it=A.current.byLibrary)==null?void 0:it[vt])==null?void 0:bt.lastRevisionId:void 0)),ze(o.revisionView??"detail"),Z.current=!0}catch{d||Fe(u.status.loadFailed)}finally{d||ye(!1)}})(),()=>{d=!0}},[u.status.loadFailed]),a.useLayoutEffect(()=>{if(Z.current){if(!o.libraryId){H(void 0),J(o.target??"library_overview"),P(void 0),ue(void 0),ze("detail");return}o.libraryId&&k.some(d=>d.libraryId===o.libraryId)&&H(o.libraryId),o.target&&J(o.target),P(o.collectionId),ue(o.revisionId),o.revisionView&&ze(o.revisionView)}},[k,o.collectionId,o.libraryId,o.revisionId,o.revisionView,o.target]),a.useEffect(()=>{if(!y){V([]),P(void 0),h([]),F([]),ue(void 0);return}let d=!1;return K(!0),va({libraryId:y,limit:200}).then(ke=>{var ut;if(d)return;const W=ke.items;V(W);const te=(ut=W.find(it=>it.collectionId===o.collectionId))==null?void 0:ut.collectionId;P(te)}).catch(()=>{d||(V([]),P(void 0))}).finally(()=>{d||K(!1)}),()=>{d=!0}},[o.collectionId,y]),a.useEffect(()=>{if(!y||Ie!=="all_cards"&&E!=="new_card"){h([]);return}let d=!1;return bs({libraryId:y,limit:200}).then(ke=>{d||h(ke)}).catch(()=>{d||h([])}),()=>{d=!0}},[Ie,y,E]),a.useEffect(()=>{if(!y||!L){F([]),ue(void 0);return}let d=!1;return Te(!0),Js({libraryId:y,collectionId:L}).then(ke=>{var ut,it,bt,ft;if(d)return;F(ke);const W=(it=(ut=A.current.byLibrary)==null?void 0:ut[y])==null?void 0:it.lastRevisionId,te=((bt=ke.find(Mt=>Mt.revisionId===o.revisionId))==null?void 0:bt.revisionId)??((ft=ke.find(Mt=>Mt.revisionId===W))==null?void 0:ft.revisionId);ue(te)}).catch(()=>{d||(F([]),ue(void 0))}).finally(()=>{d||Te(!1)}),()=>{d=!0}},[o.revisionId,L,y]),a.useEffect(()=>{const d=o.infoId;if(!y||!d){S(void 0);return}let ke=!1;return Qt({libraryId:y,infoId:d}).then(W=>{if(ke)return;const te=W.payload;S((te==null?void 0:te.label)??(te==null?void 0:te.name)??(te==null?void 0:te.title)??W.infoId)}).catch(()=>{ke||S(d)}),()=>{ke=!0}},[o.infoId,y]),a.useEffect(()=>{if(!Z.current||o.libraryId&&k.some(te=>te.libraryId===o.libraryId)&&o.libraryId!==y||o.target&&o.target!==E||o.revisionView&&o.revisionView!==de||o.revisionId&&o.revisionId!==re||cs[E].requiresCollection&&!L&&o.target==="all_collections"&&o.collectionId)return;const d=ya(`${x.pathname}${x.search}`);if(ya(x.pathname)==="/cogita"&&!o.libraryId&&!y){T.current=null;return}const W=ya(Os(y,E,L,de,re,o.infoId,o.infoView??"overview"));if(d===W){T.current=null;return}T.current!==W&&(T.current=W,c(W,{replace:!0}))},[k,x.pathname,x.search,c,o.collectionId,o.infoId,o.infoView,o.libraryId,o.revisionId,o.revisionView,o.target,L,y,re,de,E]),a.useEffect(()=>{if(typeof window>"u")return;const d=()=>{window.innerWidth>920&&v(!1)};return window.addEventListener("resize",d),()=>window.removeEventListener("resize",d)},[]),a.useEffect(()=>{if(!Z.current||!Le||!y||fe.current)return;const d=A.current,ke={...d.byLibrary??{}},W={...ke[y]??{},lastCollectionId:L,lastRevisionId:re,lastRevisionView:de,lastTarget:E},te={version:1,lastLibraryId:y,byLibrary:{...ke,[y]:W}},ut=JSON.stringify(d),it=JSON.stringify(te);if(ut===it)return;A.current=te,fe.current=!0,(async()=>{try{if(Xe)await On(Xe,{plainValue:it});else{const ft=await qn(Le,{itemName:os,itemType:"data",plainValue:it});X(ft.dataItemId)}}catch{Fe(u.status.savePrefsFailed)}finally{fe.current=!1}})()},[Xe,Le,L,y,re,de,E,u.status.savePrefsFailed]);const _=async()=>{const d=Ke.trim();if(!d){Fe(t.cogita.user.libraryNameRequired);return}Fe(null);try{const ke=await Hn({name:d});Y(W=>[ke,...W]),H(ke.libraryId),J("library_overview"),P(void 0),$e("")}catch{Fe(t.cogita.user.libraryCreateFailed)}},ie=async()=>{if(!y){Fe(u.status.selectLibraryFirst);return}const d=De.trim();if(!d){Fe(t.cogita.library.collections.saveRequiredName);return}Fe(null);try{const ke=await Un({libraryId:y,name:d,items:[]}),W=await va({libraryId:y,limit:200});V(W.items),P(ke.collectionId),ue(void 0),J("all_collections"),ze("detail"),et("")}catch{Fe(t.cogita.library.collections.saveFail)}},Se=async()=>{if(!y||!L){Fe(u.status.selectLibraryFirst);return}const d=Je.trim();if(!d){Fe(u.revisionForm.nameLabel);return}Fe(null);try{const ke=await Wn({libraryId:y,collectionId:L,name:d,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});F(W=>[ke,...W]),ue(ke.revisionId),J("all_collections"),ze("settings"),Re("")}catch{Fe(u.status.loadFailed)}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,headerExtra:y?e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:He,onChange:d=>oe(d.target.value),children:[e.jsx("option",{value:"",children:"No person"}),we.map(d=>e.jsx("option",{value:d.roleId,children:d.label},d.roleId))]})]}):null,children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${xe?"open":""}`,"aria-label":u.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{children:(C==null?void 0:C.name)??u.path.noLibrarySelected}),e.jsx("p",{className:"cogita-sidebar-note",children:C?u.sidebar.libraryActionsHint:u.status.selectLibraryFirst}),pt(At,"sidebar")]}),$t?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:u.sidebar.infoActionsHint}),pt($t,"sidebar"),Qe?e.jsxs("div",{className:"cogita-sidebar-actions-nested",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(ge==null?void 0:ge.label)??pe??t.cogita.library.list.selectedEmpty}),e.jsx("p",{className:"cogita-sidebar-note",children:u.sidebar.selectedInfoActionsHint}),pt(Qe,"sidebar")]}):null]}):null,G?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:G.name}),e.jsx("p",{className:"cogita-sidebar-note",children:u.sidebar.collectionActionsHint}),pt(ht,"sidebar")]}):null,e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:u.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:i,children:u.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{f("cogita"),v(!1)},children:u.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:l,children:m?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),xe?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":u.sidebar.closeMenu,onClick:()=>v(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":u.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>v(d=>!d),"aria-label":xe?u.sidebar.closeMenu:u.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),tt.map((d,ke)=>e.jsxs("div",{className:"cogita-browser-segment",children:[ke>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,d.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":d.label,children:d.selectedLabel}):e.jsxs("select",{"aria-label":d.label,value:d.value,onChange:W=>d.onSelect(W.target.value),disabled:d.disabled,children:[d.emptyOption?e.jsx("option",{value:"",children:d.emptyOption}):null,d.options.map(W=>e.jsx("option",{value:W.value,children:W.label},`${d.key}:${W.value}`))]})]},`menu:${d.key}`))]}),jt?e.jsxs(e.Fragment,{children:[E==="new_collection"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.library.actions.createCollection}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{type:"text",value:De,onChange:d=>et(d.target.value),placeholder:t.cogita.library.collections.namePlaceholder,disabled:!y})]}),e.jsx("button",{type:"button",className:"cta",onClick:ie,disabled:!y,children:t.cogita.library.actions.createCollection}),Ne?e.jsx("p",{className:"cogita-form-error",children:Ne}):null]}):null,E==="all_collections"&&L&&de==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:u.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:u.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Je,onChange:d=>Re(d.target.value),placeholder:u.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Se,children:u.revisionForm.createAction}),Ne?e.jsx("p",{className:"cogita-form-error",children:Ne}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(rn.Provider,{value:!0,children:jt})})]}):null,jt?null:e.jsx(e.Fragment,{children:y?null:e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:We.step}),e.jsx("h2",{children:We.title})]}),e.jsxs("p",{children:[Ue+1," / ",yt]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:We.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:We.passages.map(d=>e.jsx("p",{children:d},d))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:We.focus.map(d=>e.jsx("span",{children:d},d))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:We.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:ct.map((d,ke)=>e.jsx("button",{type:"button",className:`ghost ${ke===Ue?"active":""}`,onClick:()=>Be(ke),"aria-label":`${ke+1}`,children:ke+1},`tutorial:${d.title}:${ke}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:Ue===0,onClick:()=>Be(d=>Math.max(0,d-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:Ue===yt-1,onClick:()=>Be(d=>Math.min(yt-1,d+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:Ke,onChange:d=>$e(d.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:_,children:t.cogita.user.createLibraryAction}),Ne?e.jsx("p",{className:"cogita-form-error",children:Ne}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),k.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,k.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:k.map(d=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{rt({libraryId:d.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:d.name})]},d.libraryId))}):null]})]})]})})]})]})})}const cr=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:sr},Symbol.toStringTag,{value:"Module"}));function nr({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,shareId:c}){const[x,o]=a.useState(null),[u,k]=a.useState("loading"),[Y,q]=a.useState(t.cogita.library.collections.defaultName),[V,b]=a.useState("Cogita Library"),[h,he]=a.useState([]),[F,y]=a.useState([]),[H,E]=a.useState("idle"),[J,L]=a.useState({current:0,total:0}),[P,re]=a.useState(0),[ue,de]=a.useState(""),[ze,pe]=a.useState(null),[S,xe]=a.useState(null),[v,O]=a.useState(null),[ye,Q]=a.useState(null),[K,je]=a.useState([]),[Te,Ne]=a.useState({}),[Fe,Me]=a.useState({}),[Be,Ke]=a.useState(null),[$e,De]=a.useState(null),[et,Je]=a.useState(null),[Re,we]=a.useState(null),[Ze,He]=a.useState({}),oe=a.useRef(0),[Le,Ve]=a.useState(null),Xe=a.useRef(null),X=a.useRef(null),[A,Z]=a.useState(null),[fe,T]=a.useState(!1),[C,G]=a.useState(null),[ae,ne]=a.useState([]),[Ce,Ie]=a.useState(null),Pe=a.useRef(null),se=a.useRef(null),[ge,le]=a.useState(null),[st,Oe]=a.useState(0),Ye=a.useRef(null),ct=a.useRef({}),[yt,Ue]=a.useState(!1),[We,Ct]=a.useState({}),dt=a.useRef(null),It=a.useRef(new Set),lt=a.useRef({}),[rt,Lt]=a.useState([]),[xt,tt]=a.useState(new Set),[at,At]=a.useState(!1),$t=_a(),Qe=a.useMemo(()=>new URLSearchParams($t.search),[$t.search]),ht=a.useMemo(()=>Qe.get("key")??"",[Qe]),pt=(x==null?void 0:x.mode)??"random",jt=(x==null?void 0:x.check)??"exact",_=(x==null?void 0:x.limit)??20,ie=a.useMemo(()=>Ns((x==null?void 0:x.revisionType)??pt),[x,pt]),Se=a.useMemo(()=>{const $=x==null?void 0:x.revisionSettings,U=dn(ie,Qe);return Ua(ie,$??U)},[x,Qe,ie]),d=a.useMemo(()=>t.cogita.library.revision[ie.labelKey]??pt,[t,pt,ie]),ke=a.useMemo(()=>jt==="exact"?t.cogita.library.revision.checkValue:jt,[t,jt]),te=u==="ready"?h[P]??null:null,ut=(te==null?void 0:te.checkType)==="translation-match"&&Re,it=a.useRef(new Map),bt=a.useRef(new Map),ft=a.useRef(new Map),Mt=a.useRef(new Map),na=a.useMemo(()=>te?te.cardType==="vocab"?t.cogita.library.revision.vocabLabel:te.infoType?qe(t,te.infoType):t.cogita.library.revision.infoLabel:"",[t,te]),Ht=a.useMemo(()=>{var U;return ie.id!=="levels"?h.length:((U=We.pool)==null?void 0:U.length)??ie.getFetchLimit(_,Se)},[We,Se,ie,h.length,_]),Dt=ie.getProgressTotal?ie.getProgressTotal(h,We,_,Se):ie.id==="levels"?Math.min(_,Ht):h.length,vt=Dt?Math.min(P+1,Dt):0,wt=Math.max(1,Number(Se.tries??1)),Ut=Se.compare??"anchors",nt=Math.max(0,Math.min(100,Number(Se.minCorrectness??0))),ot=(Se.considerDependencies??"on")==="on",Ft=Math.max(0,Math.min(100,Number(Se.dependencyThreshold??85))),ga=$=>{const U=$.slice();for(let r=U.length-1;r>0;r-=1){const g=Math.floor(Math.random()*(r+1));[U[r],U[g]]=[U[g],U[r]]}return U},ma=$=>Gt($,{treatSimilarCharsAsSame:!0})>=nt,Wa=async()=>{const $=await qt(),U=new Map,r=new Map;$.forEach(j=>{const B=`${j.itemType}:${j.itemId}`,w=Vt(j.itemType,j.itemId,j.checkType,j.direction);U.has(B)||U.set(B,[]),U.get(B).push(j),r.has(w)||r.set(w,[]),r.get(w).push(j)});const g=new Map,N=new Map;return U.forEach((j,B)=>g.set(B,Ot(j).score)),r.forEach((j,B)=>N.set(B,Ot(j).score)),{itemKnowness:g,cardKnowness:N}},pa=async $=>{const U=We,r=$.concat(U.active??[]).concat(U.pool??[]).filter((D,ee,ce)=>ce.findIndex(be=>me(be)===me(D))===ee);if(!ot){tt(new Set(r.map(me)));return}const{itemKnowness:g,cardKnowness:N}=await Wa(),j=D=>{if(D.cardType!=="info"||D.infoType!=="citation"||D.checkType!=="quote-fragment")return!0;const ee=Rt(D.direction);if(!(ee!=null&&ee.fragmentId))return!0;const ce=D.description??"";if(!ce.trim())return!0;const ve=sa(ce).nodes[ee.fragmentId];if(!ve||!ve.leftId&&!ve.rightId)return!0;const Ae=[ve.leftId,ve.rightId].filter(Ge=>!!Ge);if(Ae.length===0)return!0;const Ee=Ae.map(Ge=>{const gt=Vt("info",D.cardId,"quote-fragment",Ge);return N.get(gt)??0});return Ee.reduce((Ge,gt)=>Ge+gt,0)/Ee.length>=Ft},B=(x==null?void 0:x.collectionId)??null,w=B?rt.filter(D=>mt(D.childItemType)==="collection"&&D.childItemId===B&&!mt(D.childCheckType)&&!mt(D.childDirection)):[],z=B&&r.length>0?r.reduce((D,ee)=>D+(N.get(me(ee))??0),0)/r.length:0,M=new Set;for(const D of r){if(D.cardType!=="info"){M.add(me(D));continue}if(!j(D))continue;const ee=rt.filter(ve=>fn(ve,D)).concat(w);if(ee.length===0){M.add(me(D));continue}let ce=0;for(const ve of ee)if(mt(ve.parentItemType)==="collection")ce+=ve.parentItemId===B?z:0;else if(mt(ve.parentCheckType)||mt(ve.parentDirection)){const Ae=mt(ve.parentCheckType),Ee=mt(ve.parentDirection),_e=Vt(ve.parentItemType,ve.parentItemId,Ae,Ee);ce+=N.get(_e)??0}else{const Ae=`${ve.parentItemType}:${ve.parentItemId}`;ce+=g.get(Ae)??0}ce/ee.length>=Ft&&M.add(me(D))}tt(M)},Ha=$=>{for(let U=$;U<h.length;U+=1){const r=h[U];if(r&&(!ot||r.cardType!=="info"||xt.has(me(r))))return U}return-1},ia=$=>!ot||$.cardType!=="info"||xt.has(me($)),Ya=$=>{if(ie.id!=="temporal"&&ie.id!=="levels")return null;const U=We,r=(U.active??[]).concat(U.pool??[]),g=new Set;for(const N of r){const j=me(N);if(!(g.has(j)||$.has(j))&&(g.add(j),ia(N)))return N}return null},Et=a.useMemo(()=>{if(ie.id!=="levels")return null;const $=We,U=$.pool??[],r=$.active??[],g=$.levelMap??{},N=Math.max(1,Number(Se.levels??1)),j=Array.from({length:N},()=>0),B=new Set(r.map(D=>me(D)));U.forEach(D=>{const ee=Math.min(N,Math.max(1,g[me(D)]??1));j[ee-1]+=1});const w=U.length||1,z=j.map(D=>D/w*100),M=te?g[me(te)]??1:null;return{counts:j,percentages:z,currentLevel:M,levelsCount:N,activeCount:r.length,poolCount:U.length,activeSet:B}},[We,Se,ie,te]),ra=a.useMemo(()=>{if(ie.id!=="temporal")return null;const $=We,U=$.pool??[],r=$.active??[],g=$.knownessMap??{},N=new Set($.unknownSet??[]);let j=0;U.forEach(z=>{(g[me(z)]??0)>1&&(j+=1)});const B=N.size,w=r.map(z=>({id:me(z),value:N.has(me(z))?0:Math.max(0,Math.min(1,g[me(z)]??0))}));return{knownCount:j,unknownCount:B,dots:w}},[We,ie]),Kt=a.useMemo(()=>{if(!ot)return 0;const $=We;return h.concat($.active??[]).concat($.pool??[]).filter((r,g,N)=>N.findIndex(j=>me(j)===me(r))===g).filter(r=>r.cardType==="info"&&!xt.has(me(r))).length},[ot,We,h,xt]);a.useEffect(()=>{if(!ot||H!=="ready")return;const $=We,r=h.concat($.active??[]).concat($.pool??[]).filter((j,B,w)=>w.findIndex(z=>me(z)===me(j))===B).filter(j=>j.cardType!=="info"||xt.has(me(j))).length,g=Pe.current;if(Pe.current=r,g===null||r<=g)return;const N=r-g;Ie(`New card available (+${N})`),se.current&&window.clearTimeout(se.current),se.current=window.setTimeout(()=>Ie(null),2200)},[ot,H,We,h,xt]),a.useEffect(()=>()=>{se.current&&window.clearTimeout(se.current)},[]);const kt=($,U)=>{const r=ie.applyOutcome({queue:h,meta:We},te,_,Se,{correct:$,correctness:U,createdUtc:new Date().toISOString()});he(r.queue),Ct(r.meta);const g=r.queue[P+1];g&&Pt(g,P+1)};a.useEffect(()=>{if(!c){k("error");return}k("loading"),Yn({shareId:c,key:ht}).then($=>{o($),q($.collectionName),b($.libraryName),k("ready")}).catch(()=>{k("error")})},[c,ht]),a.useEffect(()=>{c&&Qn({shareId:c,key:ht,type:"language"}).then($=>y($)).catch(()=>y([]))},[c,ht]),a.useEffect(()=>{!c||u!=="ready"||Gn({shareId:c,key:ht}).then($=>Lt($.items??[])).catch(()=>Lt([]))},[c,ht,u]),a.useEffect(()=>{if(!c||u!=="ready")return;let $=!0;return(async()=>{E("loading"),L({current:0,total:ie.id==="levels"?0:ie.getFetchLimit(_,Se)});try{const r=[];let g=null,N=null;do{const ee=await Jn({shareId:c,key:ht,limit:300,cursor:g});if(r.push(...ee.items),(ie.id==="levels"||ie.id==="temporal")&&ee.total&&(N=ee.total),L(ce=>({current:r.length,total:ce.total||ee.total||ie.getFetchLimit(_,Se)})),g=ee.nextCursor??null,N!==null&&r.length>=N||ie.id!=="levels"&&ie.id!=="temporal"&&r.length>=ie.getFetchLimit(_,Se))break}while(g);if(!$)return;const j=hs(r);let B;if(ie.id==="levels"){const ee=Math.max(1,Number(Se.levels??1));B={},j.forEach(ce=>{const be=me(ce);B[be]=Math.max(1,Math.min(ee,1))})}let w=null,z=null,M=null;if(ie.id==="temporal"){const ee=await qt(),ce=new Set(j.map(Ae=>me(Ae))),be=ee.reduce((Ae,Ee)=>{const _e=Vt(Ee.itemType,Ee.itemId,Ee.checkType,Ee.direction);return ce.has(_e)&&(Ae[_e]||(Ae[_e]=[]),Ae[_e].push(Ee)),Ae},{});w={},z=new Set,M={};const ve=Date.now();j.forEach(Ae=>{const Ee=me(Ae),_e=be[Ee]??[];if(_e.length===0){w[Ee]=0,z.add(Ee),M[Ee]=[];return}const Ge=ws(_e);M[Ee]=Ge;const gt=Oa(Ge,ve);w[Ee]=gt.knowness})}const D=ie.id==="levels"?ks(j,_,Se,B):ie.id==="temporal"?js(j,_,Se,w??{},z??new Set,M??{}):ie.prepare(j,_,Se);he(D.queue),Ct(D.meta),re(0),E("ready"),L(ee=>({current:Math.min(ee.current,ee.total),total:ee.total}))}catch{$&&E("error")}})(),()=>{$=!1}},[c,ht,_,ie,Se,u]),a.useEffect(()=>{pa(h)},[h,rt,ot,Ft,x==null?void 0:x.collectionId]),a.useEffect(()=>{if(!te||!ot){At(!1);return}if(te.cardType!=="info"||xt.has(me(te))){At(!1);return}const $=Ha(P+1);if($>=0){At(!1),re($);return}if(ie.id==="temporal"||ie.id==="levels"){const U=h.slice(0,P+1),r=h.slice(P+1).filter(ia),g=U.concat(r),N=new Set(g.map(me)),j=Ya(N);if(j){const w=me(j);N.has(w)||(g.push(j),N.add(w),Ct(z=>{const M=z,D=new Set(M.queued??[]);return D.add(w),{...M,queued:D}}))}const B=g.findIndex((w,z)=>z!==P&&ia(w));if(B>=0){he(g),re(B),At(!1);return}}At(!0)},[te,xt,ot,P,h,We,ie.id]),a.useEffect(()=>{if(de(""),pe(null),le(null),Oe(0),je([]),Ne({}),Me({}),Ke(null),De(null),Je(null),T(!1),Ue(!1),Z(null),we(null),He({}),!te){xe(null),O(null);return}te.cardType==="info"&&te.infoType==="computed"&&xe(t.cogita.library.revision.loadingComputed);let $=!0;return Pt(te,P).then(U=>{!$||!U||(xe(U.prompt),O(U.expectedAnswer),je(U.computedExpected),Ne(U.computedAnswers),Ke(U.answerTemplate),De(U.outputVariables),Je(U.variableValues))}),()=>{$=!1}},[te,c,t]),a.useEffect(()=>{if(!te||te.cardType!=="info"||te.infoType!=="citation"){dt.current=null,It.current=new Set,Q(null);return}const $=te.description??"",U=(te.label??"").trim(),r=U.replace(/\s+/g," ").trim(),g=$.replace(/\s+/g," ").trim(),N=r&&r!==g?U:t.cogita.library.infoTypes.citation;if(!$){Q(null),O(null);return}const j=sa($);dt.current=j,xe(N);let B=!0;return qt().then(w=>{if(!B)return;const z=new Map;w.forEach(be=>{if(be.itemType!=="info"||be.checkType!=="quote-fragment"||!be.direction)return;const ve=Rt(be.direction);if(!ve)return;const Ae=`${be.itemId}:${ve.fragmentId}`;z.has(Ae)||z.set(Ae,[]),z.get(Ae).push(be)});const M={},D=new Set;z.forEach((be,ve)=>{const[Ae,Ee]=ve.split(":",2);if(Ae!==te.cardId)return;const _e=Ot(be).score;M[Ee]=_e,_e>=Ft&&D.add(Ee)}),It.current=D,lt.current=M;const ee=Rt(te.direction);if(ee!=null&&ee.fragmentId&&j.nodes[ee.fragmentId]){Zt(j,ee.fragmentId,N);return}const ce=ua(j,D,M,Ft,ot,te.direction);Zt(j,(ce==null?void 0:ce.id)??null,N)}).catch(()=>{It.current=new Set,lt.current={};const w=Rt(te.direction);if(w!=null&&w.fragmentId&&j.nodes[w.fragmentId]){Zt(j,w.fragmentId,N);return}const z=ua(j,It.current,{},Ft,ot,te.direction);Zt(j,(z==null?void 0:z.id)??null,N)}),()=>{B=!1}},[te,t,ot,Ft]),a.useEffect(()=>{if(!te||te.cardType!=="vocab"||te.checkType!=="translation-match"){we(null),He({});return}const r=(We.pool??We.active??h).filter(w=>w.cardType==="vocab"&&w.checkType==="translation-match").filter((w,z,M)=>M.findIndex(D=>D.cardId===w.cardId)===z);r.some(w=>w.cardId===te.cardId)||r.unshift(te);const N=ga(r).slice(0,6).map(w=>{const z=w.label.split("↔").map(ee=>ee.trim()).filter(Boolean);if(z.length<2)return null;const M=`${w.cardId}:L`,D=`${w.cardId}:R`;return{cardId:w.cardId,leftId:M,rightId:D,leftLabel:z[0],rightLabel:z[1]}}).filter(Boolean),j=N.map(w=>w.leftId),B=ga(N.map(w=>w.rightId));we({pairs:N,leftOrder:j,rightOrder:B,selection:{},activeLeft:null,activeRight:null,locked:{}})},[te,h,We]),a.useEffect(()=>()=>{Xe.current&&window.clearTimeout(Xe.current),X.current&&window.clearTimeout(X.current)},[]);const oa=a.useRef(null);a.useEffect(()=>{if(!te)return;const $=me(te),U=typeof document<"u"?document.activeElement:null;if(oa.current===$&&U&&(U.tagName==="INPUT"||U.tagName==="TEXTAREA"))return;let r=0;const g=()=>{if(te){if(te.cardType==="info"&&te.infoType==="computed"){if(K.length>0){const j=Ba(Be,K,$e),B=j?ct.current[j]:null;if(B&&(B.focus(),document.activeElement===B)){oa.current=$;return}}if(Ye.current&&(Ye.current.focus(),document.activeElement===Ye.current)){oa.current=$;return}}else if(te.cardType==="vocab"&&Ye.current&&(Ye.current.focus(),document.activeElement===Ye.current)){oa.current=$;return}r<6&&(r+=1,window.setTimeout(g,40))}},N=window.setTimeout(g,40);return()=>window.clearTimeout(N)},[te,K,Be,$e]),a.useEffect(()=>{if(!yt)return;const $=U=>{U.key==="Enter"&&(U.preventDefault(),la())};return window.addEventListener("keydown",$),()=>window.removeEventListener("keydown",$)},[yt]);const Nt=$=>{ne($),G(Ot($))};a.useEffect(()=>{if(!te){G(null),ne([]);return}const $=te.cardType==="info"?"info":"connection";if(te.cardType==="info"&&te.infoType==="citation"){qt().then(U=>{const r=U.filter(g=>g.itemType==="info"&&g.itemId===te.cardId&&g.checkType==="quote-fragment"&&za(g.direction,te.direction));Nt(r)}).catch(()=>{G(null),ne([])});return}Ka($,te.cardId,te.checkType,te.direction).then(U=>Nt(U)).catch(()=>{G(null),ne([])})},[te]);const Jt=($,U,r,g)=>{if($==="info"&&r==="quote-fragment"){qt().then(N=>{const j=N.filter(B=>B.itemType==="info"&&B.itemId===U&&B.checkType==="quote-fragment"&&za(B.direction,g));Nt(j)}).catch(()=>{G(null),ne([])});return}Ka($,U,r,g).then(N=>Nt(N)).catch(()=>{G(null),ne([])})},Xt=($,U,r)=>{var B;const g=((B=r.pairs.find(w=>w.leftId===$))==null?void 0:B.rightId)??null;if(!g)return r;const N=g===U;He(w=>({...w,[$]:N?"correct":"incorrect"})),Xe.current&&window.clearTimeout(Xe.current),X.current&&window.clearTimeout(X.current),oe.current+=1;const j={kind:N?"correct":"incorrect",tick:oe.current};if(Ve(null),Xe.current=window.setTimeout(()=>Ve(j),0),X.current=window.setTimeout(()=>Ve(null),420),N){const w={...r.locked,[$]:!0};return Object.keys(w).length>=r.pairs.length?(pe("correct"),Ue(!0)):pe("correct"),{...r,selection:{...r.selection,[$]:U},activeLeft:null,activeRight:null,locked:w}}return pe("incorrect"),{...r,activeLeft:null,activeRight:null}},ka=$=>{we(U=>!U||U.locked[$]?U:U.activeRight?Xt($,U.activeRight,U):{...U,activeLeft:U.activeLeft===$?null:$})},Na=$=>{we(U=>U&&(U.activeLeft?Xt(U.activeLeft,$,U):{...U,activeRight:U.activeRight===$?null:$}))},la=()=>{var $;if(te&&te.cardType==="info"&&te.infoType==="citation"&&dt.current&&ye&&!(($=Rt(te.direction))!=null&&$.fragmentId)){const U=ua(dt.current,It.current,lt.current,Ft,ot,te.direction,ye.fragmentId);if(U){pe(null),de(""),T(!1),Me({}),Ue(!1),le(null),Oe(0),Zt(dt.current,U.id,ye.title);return}}pe(null),de(""),T(!1),Me({}),Ue(!1),le(null),Oe(0),re(U=>Math.min(U+1,h.length))},zt=$=>{if(!te)return;const U=$.expected??null,r=$.answer??"";let g=U??"",N=r;if(!U&&$.expectedMap&&$.answerMap){const ee=Object.keys($.expectedMap).sort((ce,be)=>ce.localeCompare(be));g=ee.map(ce=>{var be;return((be=$.expectedMap)==null?void 0:be[ce])??""}).join("|"),N=ee.map(ce=>{var be;return((be=$.answerMap)==null?void 0:be[ce])??""}).join("|")}const j=g?ha(g,N,Ut):new Uint8Array,B={revisionType:ie.id,evalType:$.evalType,direction:$.direction,prompt:S??"",expected:U,answer:r,expectedAnswers:$.expectedMap??null,answers:$.answerMap??null,correct:$.correct,maskBase64:j.length?Yt(j):null,checkMode:jt,compareMode:Ut,minCorrectness:nt},w=new TextEncoder().encode(JSON.stringify(B)),z=te.cardType==="info"?"info":"connection",M=$.overrideCheckType??te.checkType??null,D=$.overrideDirection??te.direction??null;Fa({itemType:z,itemId:te.cardId,checkType:M,direction:D,revisionType:ie.id,evalType:$.evalType,correct:$.correct,maskBase64:j.length?Yt(j):null,payloadBase64:Yt(w)}).then(()=>{Jt(z,te.cardId,M,D),pa(h)}).catch(()=>{})},ca=($,U)=>{const r=it.current.get(U);if(r)return Promise.resolve(r);const g=bt.current.get(U);if(g)return g;const N=Xn({shareCode:c,infoId:$,key:ht}).then(j=>{var ee,ce;const B=j.payload,w=((ee=B.definition)==null?void 0:ee.graph)??null,z="",M=((ce=B.definition)==null?void 0:ce.answerTemplate)??"",D=un(w,z,M);if(D){const ve={sample:hn(D),answerTemplate:M||null};return it.current.set(U,ve),ve}return Ms({shareId:c,infoId:$,key:ht}).then(be=>{const ve={sample:be,answerTemplate:null};return it.current.set(U,ve),ve})}).catch(()=>Ms({shareId:c,infoId:$,key:ht}).then(j=>{const B={sample:j,answerTemplate:null};return it.current.set(U,B),B}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{bt.current.delete(U)});return bt.current.set(U,N),N},Pt=($,U)=>{var w;const r=`${me($)}:${U}`,g=ft.current.get(r);if(g)return Promise.resolve(g);const N=Mt.current.get(r);if(N)return N;const j=z=>(ft.current.set(r,z),z);let B;if($.cardType==="vocab"){if($.checkType==="translation-match")return B=Promise.resolve(j({prompt:$.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),B;const z=$.label.split("↔").map(M=>M.trim()).filter(Boolean);if(z.length>=2){const D=($.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",ee=D?z[0]:z[1],ce=D?z[1]:z[0];B=Promise.resolve(j({prompt:ee,expectedAnswer:ce,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else B=Promise.resolve(j({prompt:$.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if($.cardType==="info"&&$.infoType==="word"){const z=(w=$.description)!=null&&w.startsWith("Language: ")?$.description.replace("Language: ",""):null;B=Promise.resolve(j({prompt:$.label,expectedAnswer:z,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else $.cardType==="info"&&$.infoType==="computed"?B=ca($.cardId,r).then(z=>{var be,ve;if(!z.sample)return j({prompt:$.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const M=z.sample,D=M.expectedAnswers?Object.entries(M.expectedAnswers).map(([Ae,Ee])=>({key:Ae,expected:Ee})):[],ee=D.reduce((Ae,Ee)=>(Ae[Ee.key]="",Ae),{}),ce=M.expectedAnswerIsSentence&&((be=M.expectedAnswer)==null?void 0:be.trim())||null;return j({prompt:M.prompt,expectedAnswer:D.length>0?ce:((ve=M.expectedAnswer)==null?void 0:ve.trim())||null,computedExpected:D,computedAnswers:ee,answerTemplate:z.answerTemplate,outputVariables:M.outputVariables??null,variableValues:M.variableValues??null})}).catch(()=>j({prompt:$.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Mt.current.delete(r)}):B=Promise.resolve(j({prompt:$.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return Mt.current.set(r,B),B},Zt=($,U,r)=>{const g=Object.keys($.nodes).length,N=It.current.size;if(!U){Q({title:r,before:$.text,after:"",fragmentId:null,total:g,completed:N}),O(null),Ue(!0);return}const j=$.nodes[U];if(!j)return;const B=ys($.text,j);Q({title:r,before:B.before,after:B.after,fragmentId:j.id,total:g,completed:N}),O(B.fragment),Ue(!1)},fa=()=>{const $=dt.current;$&&Q(U=>U&&{...U,total:Object.keys($.nodes).length,completed:It.current.size})},Bt=()=>{const $=h[P+1];$&&Pt($,P+1)},Sa=()=>{if(Bt(),te&&te.cardType==="vocab"&&te.checkType==="translation-match"&&Re){if(Re.pairs.length===0){pe("incorrect"),Ue(!0);return}const j=Re.pairs.reduce((ce,be)=>(ce[be.rightId]=be.rightLabel,ce),{});let B=0;const w={};Re.pairs.forEach(ce=>{const ve=Re.selection[ce.leftId]===ce.rightId;w[ce.leftId]=ve?"correct":"incorrect",ve&&(B+=1)});const z=Re.pairs.length||1,M=B/z,D=B===Re.pairs.length;He(ce=>({...ce,...w})),D?(pe("correct"),Ue(!0),Oe(0)):(pe("incorrect"),Ue(!1),Oe(ce=>{const be=ce+1;return be>=wt&&(T(!0),Ue(!0),we(ve=>{if(!ve)return ve;const Ae=ve.pairs.reduce((Ee,_e)=>(Ee[_e.leftId]=_e.rightId,Ee),{});return{...ve,selection:Ae}})),be})),kt(D,M);const ee="connection";Promise.all(Re.pairs.map(ce=>{const be=Re.selection[ce.leftId]??null,ve=be?j[be]:"",Ae={left:ce.leftLabel,expected:ce.rightLabel,answer:ve,checkType:"translation-match"},Ee=new TextEncoder().encode(JSON.stringify(Ae));return Fa({itemType:ee,itemId:ce.cardId,checkType:"translation-match",direction:null,revisionType:ie.id,evalType:"translation-match",correct:be===ce.rightId,maskBase64:null,payloadBase64:Yt(Ee)})})).then(()=>{Jt(ee,te.cardId,te.checkType,te.direction),pa(h)}).catch(()=>{});return}if(K.length>0){const j=K.reduce((w,z)=>{const M=Te[z.key]??"";return w[z.key]=St(M)===St(z.expected)?"correct":"incorrect",w},{});K.every(({key:w,expected:z})=>{const M=Te[w]??"";return jt==="exact"&&St(M)===St(z)})?(pe("correct"),Me(j),Ue(!0),Oe(0),kt(!0,1),zt({correct:!0,direction:S?`${S} -> computed`:"computed",expectedMap:K.reduce((w,z)=>(w[z.key]=z.expected,w),{}),answerMap:Te,evalType:"computed"})):(pe("incorrect"),Me(j),Ue(!1),Oe(w=>{const z=w+1;return z>=wt&&ea&&(T(!0),Ue(!0)),z}),kt(!1,0),window.setTimeout(()=>{var z;const w=Ba(Be,K,$e);w&&ct.current[w]&&((z=ct.current[w])==null||z.focus())},40),zt({correct:!1,direction:S?`${S} -> computed`:"computed",expectedMap:K.reduce((w,z)=>(w[z.key]=z.expected,w),{}),answerMap:Te,evalType:"computed"}));return}if(te&&te.cardType==="info"&&te.infoType==="citation"&&(ye!=null&&ye.fragmentId)){if(!v)return;const j=Rt(te.direction),B=(j==null?void 0:j.fragmentId)??ye.fragmentId,w=Ea(v,ue,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),z=w.mask,M=w.isCorrect,D=w.percent;M?(lt.current[ye.fragmentId]=Math.max(lt.current[ye.fragmentId]??0,D),(lt.current[ye.fragmentId]??0)>=Ft&&It.current.add(ye.fragmentId),fa(),pe("correct"),Me({}),Ue(!0),le(z),Oe(0),D<100&&wt<=1&&T(!0),kt(!0,D/100),zt({correct:!0,direction:`quote:${ye.fragmentId}`,expected:v,answer:ue,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:B})):(pe("incorrect"),Me({}),Ue(!1),le(z),Oe(ee=>{const ce=ee+1;return ce>=wt&&ea&&(T(!0),Ue(!0)),ce}),kt(!1,D/100),window.setTimeout(()=>{var ee;return(ee=Ye.current)==null?void 0:ee.focus()},40),zt({correct:!1,direction:`quote:${ye.fragmentId}`,expected:v,answer:ue,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:B}));return}if(!v)return;const $=ha(v,ue,Ut),U=jt==="exact"&&St(ue)===St(v),r=ma($),g=U||r,N=Gt($);g?(pe("correct"),Me({}),Ue(!0),le($),Oe(0),N<100&&wt<=1&&T(!0),kt(!0,N/100),zt({correct:!0,direction:S?`${S} -> ${v}`:null,expected:v,answer:ue,evalType:"text"})):(pe("incorrect"),Me({}),Ue(!1),le($),Oe(j=>{const B=j+1;return B>=wt&&ea&&(T(!0),Ue(!0)),B}),kt(!1,N/100),window.setTimeout(()=>{var j;return(j=Ye.current)==null?void 0:j.focus()},40),zt({correct:!1,direction:S?`${S} -> ${v}`:null,expected:v,answer:ue,evalType:"text"}))},da=$=>{if(Bt(),!v)return;const U=ha(v,$,Ut),r=St($)===St(v),g=ma(U),N=r||g,j=Gt(U);N?(pe("correct"),Me({}),Ue(!0),le(U),Oe(0),j<100&&wt<=1&&T(!0),kt(!0,j/100),zt({correct:!0,direction:"word->language",expected:v,answer:$,evalType:"language-select"})):(pe("incorrect"),Me({}),Ue(!1),le(U),Oe(B=>{const w=B+1;return w>=wt&&ea&&(T(!0),Ue(!0)),w}),kt(!1,j/100),zt({correct:!1,direction:"word->language",expected:v,answer:$,evalType:"language-select"}))},Ta=$=>{var r;if($.key!=="Enter")return;if($.preventDefault(),$.stopPropagation(),yt){la();return}const U=K.find(g=>!(Te[g.key]??"").trim());if(U){(r=ct.current[U.key])==null||r.focus();return}Sa()},Qa=()=>{Bt(),pe("correct"),Ue(!0),Oe(0),kt(!0,1),v&&zt({correct:!0,direction:"manual",expected:v,answer:ue,evalType:"manual"})},Ga=()=>{if(kt(!1,0),te&&te.cardType==="info"&&te.infoType==="citation"){pe(null),de(""),T(!1),Me({}),Ue(!1),le(null),Oe(0),re($=>Math.min($+1,h.length));return}la()};a.useEffect(()=>{Bt()},[P,h]);const Ja=t.cogita.library.revision.revealModeAfterIncorrect,ea=K.length>0||!!v;return e.jsxs(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:l,onLogout:p,secureMode:m,onNavigate:f,language:R,onLanguageChange:I,children:[(u==="loading"||H==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:u==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${J.total?Math.min(100,Math.max(0,J.current/J.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:J.total?`${Math.min(J.current,J.total)} / ${J.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:Y}),e.jsx("p",{className:"cogita-library-subtitle",children:V}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",d).replace("{check}",ke)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:C?`${C.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Et?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Et.currentLevel??"-"," / ",Et.levelsCount]}):null,C?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(C.correct)).replace("{total}",String(C.total))}),C.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(C.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(gn,{outcomes:ae})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[Ce?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:Ce})}):null,e.jsx(xs,{feedbackToken:Le?`${Le.kind}-${Le.tick}`:ut?"idle":ze??"idle",children:u!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:u==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):te?e.jsx(e.Fragment,{children:at?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(vs,{copy:t,currentCard:te,currentTypeLabel:na,prompt:S,languages:F,answer:ue,onAnswerChange:$=>de(U=>Da(U,$,A)),computedExpected:K,computedAnswers:Te,onComputedAnswerChange:($,U)=>Ne(r=>({...r,[$]:Da(r[$]??"",U,A)})),answerTemplate:Be,outputVariables:$e,variableValues:et,computedFieldFeedback:Fe,feedback:ze,canAdvance:yt,quoteContext:ye,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Sa,onSkip:Ga,onLanguageSelect:da,onMarkReviewed:Qa,onAdvance:la,showCorrectAnswer:fe,setShowCorrectAnswer:T,onRevealCorrect:()=>Ue(!0),answerMask:ge,expectedAnswer:v,hasExpectedAnswer:ea,handleComputedKeyDown:Ta,answerInputRef:Ye,computedInputRefs:ct,scriptMode:A,setScriptMode:Z,matchPairs:Re==null?void 0:Re.pairs,matchLeftOrder:Re==null?void 0:Re.leftOrder,matchRightOrder:Re==null?void 0:Re.rightOrder,matchSelection:Re==null?void 0:Re.selection,matchActiveLeft:Re==null?void 0:Re.activeLeft,matchActiveRight:Re==null?void 0:Re.activeRight,matchFeedback:Ze,onMatchLeftSelect:ka,onMatchRightSelect:Na})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Dt?`${vt} / ${Dt}`:t.cogita.library.revision.progressUnlimited}),u==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),u==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),u==="ready"&&H==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),u==="ready"&&H==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),u==="ready"&&H==="ready"&&h.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Ja}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",wt]})]})]}),Et?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Et.activeCount," / ",Et.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Et.counts.map(($,U)=>{const r=U+1,g=Et.currentLevel===r,N=Et.percentages[U]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":g,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:r}),e.jsx("strong",{children:$})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,N))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[N.toFixed(1),"%"]})]},`level-${r}`)})})]}):null,ra?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:ra.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:ra.dots.map($=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-$.value))}, ${Math.round(200*$.value)}, 80, 0.9)`}},$.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:ra.knownCount})]})]}):null,ot?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Kt})]})}):null]})]})]})})})]})]})}const dr=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:nr},Symbol.toStringTag,{value:"Module"}));export{lr as C,cr as a,dr as b};
