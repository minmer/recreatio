import{r as a,j as e,u as Os,a as Va,b as qs,c as Us,d as Ws,R as gs,B as ms,C as ps}from"./vendor-CL5v9b84.js";import{L as Hs,A as Qs,g as Ys,a as xn,b as ja,c as Gs,s as Ns,d as fs,e as vn,f as Ss,h as Gt,i as wn,j as Js,k as Xs,l as Zs,m as bs,n as en,o as jn,u as kn,p as Nn,q as Sn,r as Tn,t as Cn,v as Mn,w as tn,x as an,y as In,z as Ln,B as $n,C as Oa,D as Ra,E as Rn,F as En,G as sn,H as An,I as Pn,J as Fn,K as Ts,M as Yt,N as Kn,O as zn,P as Bn,Q as Dn,R as _n,S as Vn,T as On,U as qn,V as Un,W as Wn,X as Hn,Y as Qn,Z as Yn,_ as Gn,$ as Jn,a0 as Xn,a1 as Cs}from"./recreatio-core-r39TKt4X.js";import"./vendor-cogita-ui-mbCyoqV0.js";const wa={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},xa={moveMs:900,pauseMs:220,errorMs:900},Zn=(t=11)=>{let s=t;const n=()=>(s=(s*1664525+1013904223)%4294967296,s/4294967296),{width:i,height:o,paddingX:g,paddingY:f,levels:y}=wa,E=(o-f*2)/(y.length-1),N=[],l=[],b=[];y.forEach((k,m)=>{const de=o-f-m*E,P=i-g*2,p=[];for(let W=0;W<k;W+=1){const L=g+(W+1)*P/(k+1),G=(n()-.5)*18,I=Math.max(g,Math.min(i-g,L+G)),$=m===0?3:m<2?2.1:1.4,ne=m===0?"root":`l${m}-${W}`;p.push({id:ne,x:m===0?i/2:I,y:de,r:$,level:m,role:m===0?"root":void 0})}b.push(p),N.push(...p)});const c=b[b.length-1];if(c!=null&&c.length){const k=c[Math.floor(c.length/2)];k.role="goal",k.r=2}for(let k=1;k<b.length;k+=1){const m=b[k-1];b[k].forEach(P=>{const p=[...m].sort((I,$)=>Math.abs(I.x-P.x)-Math.abs($.x-P.x)),W=p[0],L=p[1]&&n()<.45?p[1]:null;(L?[W,L]:[W]).forEach(I=>{l.push({from:I.id,to:P.id,key:`${I.id}-${P.id}`})}),n()<.2&&p[2]&&l.push({from:p[2].id,to:P.id,key:`${p[2].id}-${P.id}`})})}const u=new Map;l.forEach(k=>{const m=u.get(k.to)??[];m.push(k.from),u.set(k.to,m)});const S=new Map,ae=new Map,Y=new Map;l.forEach(k=>{const m=S.get(k.from)??[];m.push(k.key),S.set(k.from,m);const de=ae.get(k.from)??[];de.push(k.to),ae.set(k.from,de);const P=Y.get(k.from)??[];P.push(k.to),Y.set(k.from,P);const p=Y.get(k.to)??[];p.push(k.from),Y.set(k.to,p)});const U=new Map;return N.forEach(k=>{U.set(k.id,k)}),{nodes:N,links:l,parentsById:u,linksByFrom:S,childrenByFrom:ae,neighborsById:Y,nodesById:U}};function ei({slides:t,activeIndex:s,introOpen:n,prefersReducedMotion:i,onNext:o,onPrev:g,onSelect:f,onExit:y,onOpen:E,onRegister:N}){const l=s===t.length-1,b=n&&s===0?"entry":"docked",c=t[t.length-1],[u,S]=a.useState(!1),ae=a.useMemo(()=>Array.from({length:20},(A,J)=>({src:`/cogita/logo/Cogita${String(J).padStart(2,"0")}.png`,kind:J<=11?"bubble":J<=17?"text":"recreatio"})),[]),Y=n&&s===0;a.useEffect(()=>{if(!n){S(!1);return}s>0&&!u&&S(!0)},[s,n,u]);const U=a.useRef(0),k=a.useRef(null),m=a.useMemo(()=>{const A={x:40,y:160},J={x:260,y:48},Ce=6,R=J.x-A.x,_=A.y-J.y,Q=R/Ce,se=[.3,.45,.6,.65,1.4,2.2],Z=se.reduce((Ke,Me)=>Ke+Me,0),Pe=se.map(Ke=>_*Ke/Z),Fe=[A];let Oe=A.x,Ee=A.y;for(let Ke=1;Ke<=Ce;Ke+=1){const Me=(Math.random()-.5)*14,lt=(Math.random()-.5)*28;Oe=Math.max(A.x+Ke*14,Math.min(J.x-(Ce-Ke)*14,Oe+Q+Me));const We=Pe[Ke-1]??Pe[Pe.length-1];Ee=Ee-We+lt;const Xe=Math.max(J.y,Math.min(A.y-4,Ee));Fe.push({x:Math.round(Oe),y:Math.round(Xe)})}return Fe[Fe.length-1]=J,Fe},[]),de=a.useMemo(()=>{const _=(Z,Pe,Fe)=>Math.min(Fe,Math.max(Pe,Z)),Q=m.map(Z=>{const Pe=10+Math.random()*36;return{x:_(Z.x,40,260),y:_(Z.y-Pe,40,140)}}),se=m.map((Z,Pe)=>{var Ee;const Fe=12+Math.random()*40,Oe=((Ee=Q[Pe])==null?void 0:Ee.y)??Z.y;return{x:_(Z.x,40,260),y:_(Math.max(Oe+10,Z.y+Fe),60,170)}});return{upper:Q,lower:se}},[m]),P=a.useMemo(()=>{var J;const A=((J=m[4])==null?void 0:J.x)??260;return Math.max(0,Math.min(240,A-40))},[m]),p=a.useMemo(()=>{var Pe,Fe;const A=(Oe,Ee,Ke)=>Math.min(Ke,Math.max(Ee,Oe)),J=(Oe,Ee,Ke)=>m.map((Me,lt)=>{var Ct,ut;const We=((Ct=de.upper[lt])==null?void 0:Ct.y)??Me.y,Xe=((ut=de.lower[lt])==null?void 0:ut.y)??Me.y,dt=(Math.random()-.5)*70,bt=Me.y+Oe+dt,He=A(Me.y+Ee,We+6,Xe-6),Qe=A(Me.y+Ke,We+6,Xe-6);return{x:Me.x,y:A(bt,Math.min(He,Qe),Math.max(He,Qe))}}),Ce=-14+Math.random()*28,R=14+Math.random()*28,_=J(Ce,-80,12),Q=J(R,-12,80);for(let Oe=4;Oe<m.length;Oe+=1){const Ee=m[Oe],Ke=((Pe=de.upper[Oe])==null?void 0:Pe.y)??Ee.y,Me=((Fe=de.lower[Oe])==null?void 0:Fe.y)??Ee.y;_[Oe]={x:Ee.x,y:A(Ee.y-12,Ke+6,Me-6)},Q[Oe]={x:Ee.x,y:A(Ee.y+12,Ke+6,Me-6)}}const se=de.upper.length?de.upper[de.upper.length-1].y:40,Z=de.lower.length?de.lower[de.lower.length-1].y:170;return _[_.length-1]={x:m[m.length-1].x,y:A(m[m.length-1].y-14,se,Z)},Q[Q.length-1]={x:m[m.length-1].x,y:A(m[m.length-1].y+12,se,Z)},{higher:_,lower:Q}},[m,de]),W=1e4,L=a.useMemo(()=>{let A=17;const J=()=>(A=(A*1664525+1013904223)%4294967296,A/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((R,_)=>{const Q=(J()-.5)*240,se=(J()-.5)*180,Z=(J()-.5)*24;return{id:`card-${_+1}`,throw:{x:`${Q.toFixed(0)}px`,y:`${se.toFixed(0)}px`,rot:`${Z.toFixed(1)}deg`},grid:{x:`${R.x}px`,y:`${R.y}px`},delay:`${_*.12}s`}})},[]),G=a.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[I,$]=a.useState([]),ne=a.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),oe=a.useMemo(()=>{const J=[],R=(Q,se)=>Q+Math.random()*(se-Q);for(let Q=0;Q<6;Q+=1){let se=!1;for(let Z=0;Z<80;Z+=1){const Pe=R(14,86),Fe=R(10,34);if(J.every(Ee=>{const Ke=Ee.x-Pe,Me=Ee.y-Fe;return Math.hypot(Ke,Me)>=12})){J.push({x:Pe,y:Fe}),se=!0;break}}se||J.push({x:R(16,84),y:R(12,32)})}return J.map((Q,se)=>({id:`p${se+1}`,x:`${Q.x.toFixed(1)}%`,y:`${Q.y.toFixed(1)}%`,xNum:Q.x,yNum:Q.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[ce,_e]=a.useState(0),[me,T]=a.useState(0),[be,x]=a.useState([]),V=1e4,fe=a.useMemo(()=>{if(oe.length<2)return[];const A=se=>{let Z=se+1831565813;return Z=Math.imul(Z^Z>>>15,Z|1),Z^=Z+Math.imul(Z^Z>>>7,Z|61),((Z^Z>>>14)>>>0)/4294967296},J=(se,Z)=>Math.floor(A(se)*Z),Ce=new Set,R=[],_=Math.min(3,oe.length);let Q=0;for(;R.length<_&&Q<30;){Q+=1;const se=J(ce*13+Q*5,oe.length),Z=J(ce*29+Q*7,oe.length);if(se===Z)continue;const Pe=se<Z?`${se}-${Z}`:`${Z}-${se}`;Ce.has(Pe)||(Ce.add(Pe),R.push({id:`link-${Pe}`,from:oe[se],to:oe[Z],delay:`${(Q*.35).toFixed(2)}s`}))}return R},[ce,oe]);a.useEffect(()=>{if(!n||s!==2)return;const A=()=>{const Ce=L.map(R=>R.id);for(let R=Ce.length-1;R>0;R-=1){const _=Math.floor(Math.random()*(R+1));[Ce[R],Ce[_]]=[Ce[_],Ce[R]]}return Ce.slice(0,4)};$(A());const J=window.setInterval(()=>{$(A())},W);return()=>window.clearInterval(J)},[s,n,L,W]),a.useEffect(()=>{if(!n||s!==3)return;const A=()=>{T(Math.floor(Math.random()*ne.length)),x(oe.map(()=>Math.random()<.6?"good":"bad")),_e(Ce=>Ce+1)};A();const J=window.setInterval(A,V);return()=>window.clearInterval(J)},[s,n,ne.length,oe,V]);const H=a.useMemo(()=>Zn(11),[]),[F,je]=a.useState(new Set(["root"])),[Te,Ne]=a.useState(new Set),[ze,Ie]=a.useState(new Set),[Ve,De]=a.useState({fromId:"root",toId:"root",key:0}),Le=a.useRef(F),Ue=a.useRef("root"),et=a.useRef(0),Je=a.useRef(null),ye=a.useRef(null),ge=a.useRef([]);a.useEffect(()=>{Le.current=F},[F]);const ie=a.useMemo(()=>{const A=new Set;return F.forEach(J=>{const Ce=H.linksByFrom.get(J);Ce&&Ce.forEach(R=>A.add(R))}),A},[F,H]),ke=H.nodesById.get(Ve.toId)??H.nodesById.get("root"),le=ke?`${ke.x/wa.width*100}%`:"50%",xe=ke?`${ke.y/wa.height*100}%`:"90%";a.useEffect(()=>{if(!n||s!==1||i)return;(()=>{je(new Set(["root"])),Ne(new Set),Ie(new Set),De({fromId:"root",toId:"root",key:0}),ye.current=null,et.current=0,Ue.current="root",ge.current=[]})();const J=()=>{const R=Ue.current,_=Le.current,se=(H.childrenByFrom.get(R)??[]).filter(Me=>!_.has(Me));if(se.length)return se[Math.floor(Math.random()*se.length)];if(_.size>=H.nodes.length){const Me=H.neighborsById.get(R)??[];return Me.length?Me[Math.floor(Math.random()*Me.length)]:null}const Z=Me=>(H.childrenByFrom.get(Me)??[]).some(We=>!_.has(We)),Pe=[R],Fe=new Set([R]),Oe=new Map;let Ee=null;for(;Pe.length;){const Me=Pe.shift();if(!Me)break;if(Me!==R&&Z(Me)){Ee=Me;break}(H.neighborsById.get(Me)??[]).forEach(We=>{Fe.has(We)||(Fe.add(We),Oe.set(We,Me),Pe.push(We))})}if(!Ee)return null;let Ke=Ee;for(;Oe.get(Ke)&&Oe.get(Ke)!==R;)Ke=Oe.get(Ke)??Ke;return Ke},Ce=(R,_)=>{if(R===_){const Q=J();Q&&Ce(R,Q);return}et.current+=1,De({fromId:R,toId:_,key:et.current}),Ue.current=_,Je.current=window.setTimeout(()=>{const Q=H.parentsById.get(_)??[],se=Le.current,Z=Q.filter(Ee=>!se.has(Ee));if(!Z.length){const Ee=new Set(se);Ee.add(_),je(Ee),Je.current=window.setTimeout(()=>{for(;ge.current.length;){const Me=ge.current[ge.current.length-1];if(!Ee.has(Me)){if(Me!==_){Ce(_,Me);return}break}ge.current.pop()}const Ke=J();Ke&&Ce(_,Ke)},xa.pauseMs);return}const Pe=new Set([_,...Z]),Fe=new Set(Z.map(Ee=>`${Ee}-${_}`));Ne(Pe),Ie(Fe),ge.current.includes(_)||ge.current.push(_);const Oe=Z[Math.floor(Math.random()*Z.length)];ye.current={fromId:_,toId:Oe},Je.current=window.setTimeout(()=>{Ne(new Set),Ie(new Set);const Ee=ye.current;Ee&&Ce(Ee.fromId,Ee.toId)},xa.errorMs)},xa.moveMs)};return Je.current=window.setTimeout(()=>{const R=J();R&&Ce(Ue.current,R)},xa.pauseMs),()=>{Je.current&&window.clearTimeout(Je.current)}},[s,n,H,i]);const Be=A=>{if(!n)return;const J=Date.now();J-U.current<520||Math.abs(A.deltaY)<10||(U.current=J,A.deltaY>0?o():g(),A.preventDefault())},Re=A=>{if(!n)return;const J=A.touches[0];J&&(k.current={x:J.clientX,y:J.clientY})},we=A=>{if(!n)return;const J=k.current;if(k.current=null,!J)return;const Ce=A.changedTouches[0];if(!Ce)return;const R=Ce.clientX-J.x,_=Ce.clientY-J.y;Math.abs(_)<40||Math.abs(_)<Math.abs(R)||(_<0?o():g())};return e.jsxs("div",{className:`cogita-intro ${n?"is-open":"is-closed"} ${i?"is-reduced":""} ${l?"is-final":""}`,"data-slide":s+1,onWheel:Be,onTouchStart:Re,onTouchEnd:we,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":b,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${Y&&!u?"is-entry":""}`,children:ae.map((A,J)=>e.jsx("img",{src:A.src,alt:"",className:`cogita-logo-layer ${J===0?"is-base":""} ${A.kind==="text"?"is-text":A.kind==="recreatio"?"is-recreatio":""} ${A.kind==="bubble"?"is-bubble":""}`},A.src))})}),n&&t.map((A,J)=>{const Ce=J===s;return e.jsxs("section",{className:`cogita-intro-slide slide-${J+1} ${Ce?"is-active":""}`,"aria-hidden":!Ce,children:[e.jsxs("div",{className:"cogita-intro-text",children:[A.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:A.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:A.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:A.title}),A.body&&e.jsx("p",{children:A.body.split(`
`).map((R,_)=>e.jsxs("span",{children:[R,_===0&&e.jsx("br",{})]},String(_)))})]}),A.micro&&e.jsx("p",{className:"cogita-intro-micro",children:A.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:l?N:o,children:A.cta}),l&&A.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>f(0),children:A.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[J===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${wa.width} ${wa.height}`,preserveAspectRatio:"none",children:[H.links.map(R=>{const _=H.nodesById.get(R.from),Q=H.nodesById.get(R.to);if(!_||!Q)return null;const se=ie.has(R.key),Z=ze.has(R.key);return e.jsx("line",{className:`map-link ${se?"is-active":""} ${Z?"is-error":""}`,x1:_.x,y1:_.y,x2:Q.x,y2:Q.y},R.key)}),H.nodes.map(R=>{const _=F.has(R.id),Q=Te.has(R.id);return e.jsx("circle",{className:`map-node ${R.role?`is-${R.role}`:""} ${_?"is-active":""} ${Q?"is-error":""}`,cx:R.x,cy:R.y,r:R.r},R.id)})]}),ke&&e.jsx("span",{className:"map-explorer-dot",style:{left:le,top:xe,"--move":`${xa.moveMs}ms`}})]}),J===2&&e.jsx("div",{className:"cogita-index-cards",children:L.map(R=>{const _=I.indexOf(R.id),Q=_>=0?G[_]:null,se=(Q==null?void 0:Q.x)??"140px",Z=(Q==null?void 0:Q.y)??"140px",Pe=_>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":R.throw.x,"--throw-y":R.throw.y,"--throw-rot":R.throw.rot,"--grid-x":R.grid.x,"--grid-y":R.grid.y,"--stack-x":se,"--stack-y":Z,"--stack-opacity":Pe,"--delay":R.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},R.id)})}),J===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[ne.map((R,_)=>e.jsxs("div",{className:`round-card ${_===me?"is-active":""}`,style:{"--card-x":R.x,"--card-y":R.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},R.id)),ne[me]&&e.jsx("span",{className:"round-ring",style:{"--card-x":ne[me].x,"--card-y":`calc(${ne[me].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:oe.map(R=>e.jsx("span",{className:"player-dot",style:{left:R.x,top:R.y,"--jitter-x":R.jitterX,"--jitter-y":R.jitterY,"--breath-delay":R.delay}},R.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:fe.map(R=>e.jsx("line",{className:"round-link",x1:R.from.xNum,y1:R.from.yNum,x2:R.to.xNum,y2:R.to.yNum,style:{"--delay":R.delay}},R.id))}),e.jsx("div",{className:"round-flows",children:oe.map((R,_)=>{const Q=be[_]??"good",se=ne[me];if(!se)return null;const Z=`calc(${se.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":R.x,"--from-y":R.y,"--to-x":se.x,"--to-y":Z,"--delay":`${_*.12}s`}}),e.jsx("span",{className:`return-dot is-${Q}`,style:{"--from-x":se.x,"--from-y":Z,"--to-x":R.x,"--to-y":R.y,"--delay":`${_*.12}s`}}),e.jsx("span",{className:`result-pop is-${Q}`,style:{"--at-x":R.x,"--at-y":R.y,"--delay":`${_*.12}s`}})]},`${R.id}-${ce}`)})})]},`round-${ce}`),J===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${m[0].x} ${m[0].y} L${m[1].x} ${m[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${m[1].x} ${m[1].y} L${m[2].x} ${m[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${m[2].x} ${m[2].y} L${m[3].x} ${m[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${m[3].x} ${m[3].y} L${m[4].x} ${m[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${m[4].x} ${m[4].y} L${m[5].x} ${m[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${m[5].x} ${m[5].y} L${m[6].x} ${m[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${P};${P};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${de.upper.map((R,_)=>`${_===0?"M":"L"}${R.x} ${R.y}`).join(" ")} ${de.lower.slice().reverse().map(R=>`L${R.x} ${R.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${de.upper.map((R,_)=>`${_===0?"M":"L"}${R.x} ${R.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${de.lower.map((R,_)=>`${_===0?"M":"L"}${R.x} ${R.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[p.higher.slice(0,6).map((R,_)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${_+1}`,d:`M${R.x} ${R.y} L${p.higher[_+1].x} ${p.higher[_+1].y}`,pathLength:"100"},`peer-1-${_}`)),p.lower.slice(0,6).map((R,_)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${_+1}`,d:`M${R.x} ${R.y} L${p.lower[_+1].x} ${p.lower[_+1].y}`,pathLength:"100"},`peer-2-${_}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${m[0].x/300*100}%`,"--p0y":`${m[0].y/200*100}%`,"--p1x":`${m[1].x/300*100}%`,"--p1y":`${m[1].y/200*100}%`,"--p2x":`${m[2].x/300*100}%`,"--p2y":`${m[2].y/200*100}%`,"--p3x":`${m[3].x/300*100}%`,"--p3y":`${m[3].y/200*100}%`,"--p4x":`${m[4].x/300*100}%`,"--p4y":`${m[4].y/200*100}%`,"--p5x":`${m[5].x/300*100}%`,"--p5y":`${m[5].y/200*100}%`,"--p6x":`${m[6].x/300*100}%`,"--p6y":`${m[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${p.higher[0].x/300*100}%`,"--q0y":`${p.higher[0].y/200*100}%`,"--q1x":`${p.higher[1].x/300*100}%`,"--q1y":`${p.higher[1].y/200*100}%`,"--q2x":`${p.higher[2].x/300*100}%`,"--q2y":`${p.higher[2].y/200*100}%`,"--q3x":`${p.higher[3].x/300*100}%`,"--q3y":`${p.higher[3].y/200*100}%`,"--q4x":`${p.higher[4].x/300*100}%`,"--q4y":`${p.higher[4].y/200*100}%`,"--q5x":`${p.higher[5].x/300*100}%`,"--q5y":`${p.higher[5].y/200*100}%`,"--q6x":`${p.higher[6].x/300*100}%`,"--q6y":`${p.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${p.lower[0].x/300*100}%`,"--q0y":`${p.lower[0].y/200*100}%`,"--q1x":`${p.lower[1].x/300*100}%`,"--q1y":`${p.lower[1].y/200*100}%`,"--q2x":`${p.lower[2].x/300*100}%`,"--q2y":`${p.lower[2].y/200*100}%`,"--q3x":`${p.lower[3].x/300*100}%`,"--q3y":`${p.lower[3].y/200*100}%`,"--q4x":`${p.lower[4].x/300*100}%`,"--q4y":`${p.lower[4].y/200*100}%`,"--q5x":`${p.lower[5].x/300*100}%`,"--q5y":`${p.lower[5].y/200*100}%`,"--q6x":`${p.lower[6].x/300*100}%`,"--q6y":`${p.lower[6].y/200*100}%`}})]})})}),J===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),J===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},A.id)}),!n&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:c.title}),c.body&&e.jsx("p",{children:c.body}),c.micro&&e.jsx("p",{className:"cogita-intro-micro",children:c.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:N,children:c.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:E,children:"Otwórz pokaz"})]})]})})]}),n&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((A,J)=>e.jsx("button",{type:"button",className:`dot ${s===J?"active":""}`,"aria-label":A.title,onClick:()=>f(J)},A.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:y,children:"Pomiń"})]})]})}const ti=6,ai=4;function si({copy:t,onAuthAction:s,authLabel:n,showProfileMenu:i,onProfileNavigate:o,onToggleSecureMode:g,onLogout:f,secureMode:y,onNavigate:E,language:N,onLanguageChange:l}){const b=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}E("home")},c=a.useRef(null),u=a.useRef([]),S=a.useMemo(()=>{let x=Date.now()%2147483647;const V=()=>(x=x*48271%2147483647,x/2147483647);return Array.from({length:ti},(fe,H)=>{const F=6+V()*8,je=7+V()*10,Te=6+V()*9,Ne=-V()*F,ze=-V()*je,Ie=-V()*Te,Ve=.18+V()*.28,De=12+V()*18,Le=4+V()*8,Ue=(V()-.5)*3.2,et=(V()-.5)*3.8,Je=V()>.5?"alternate":"alternate-reverse",ye=V()>.5?"alternate":"alternate-reverse",ge=V()>.5?"alternate":"alternate-reverse",ie=.18+V()*.42,ke=30+V()*60,le=-45-V()*38,xe=188+V()*32,Be=.1+V()*.2;return{id:`wave-${H+1}`,style:{"--wave-sway-duration":`${F}s`,"--wave-scale-duration":`${je}s`,"--wave-drift-duration":`${Te}s`,"--wave-sway-delay":`${Ne}s`,"--wave-scale-delay":`${ze}s`,"--wave-drift-delay":`${Ie}s`,"--wave-sway-dir":Je,"--wave-scale-dir":ye,"--wave-drift-dir":ge,"--wave-scale":`${Ve}`,"--wave-shift":`${De}%`,"--wave-xshift":`${Le}%`,"--wave-x0":`${Ue}%`,"--wave-y0":`${et}%`,"--wave-opacity":`${ie}`,"--wave-blur":`${ke}px`,"--wave-bottom":`${le}%`,"--wave-hue":`${xe}`,"--wave-glow":`${Be}`}}})},[]),ae=a.useMemo(()=>{let x=Date.now()*3%2147483647;const V=()=>(x=x*48271%2147483647,x/2147483647);return Array.from({length:ai},(fe,H)=>{const F=180+V()*220,je=220+V()*280,Te=-V()*F,Ne=-V()*je,ze=.12+V()*.22,Ie=3+V()*7,Ve=1+V()*3,De=(V()-.5)*2.8,Le=(V()-.5)*2.2;return{id:`mesh-${H+1}`,seed:1e3+H*991+Math.floor(V()*999),style:{"--mesh-sway-duration":`${F}s`,"--mesh-drift-duration":`${je}s`,"--mesh-sway-delay":`${Te}s`,"--mesh-drift-delay":`${Ne}s`,"--mesh-scale":`${ze}`,"--mesh-shift":`${Ie}%`,"--mesh-xshift":`${Ve}%`,"--mesh-x0":`${Le}%`,"--mesh-y0":`${De}%`}}})},[]),Y=a.useMemo(()=>{const x=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],V=t.cogita.introSlides,fe=new Map(V.map(H=>[H.id,H]));return x.map(H=>{var je;const F=fe.get(H.id);return{...H,...F,title:(F==null?void 0:F.title)??"Cogita",cta:(F==null?void 0:F.cta)??((je=t.cogita.introSlides[0])==null?void 0:je.cta)??t.cogita.loginCta,secondary:F==null?void 0:F.secondary}})},[t.cogita.introSlides]),[U,k]=a.useState(0),[m,de]=a.useState(!0),[P,p]=a.useState(!1),W=Y.length-1,L=a.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),G=a.useCallback(()=>{L(),s()},[L,s]),I=a.useCallback(()=>{de(!0),k(0)},[]),$=a.useCallback(()=>{de(!1),k(W)},[W]),ne=a.useCallback(x=>{k(Math.max(0,Math.min(W,x)))},[W]),oe=a.useCallback(()=>{U>=W?G():ne(U+1)},[U,ne,G,W]),ce=a.useCallback(()=>{ne(U-1)},[U,ne]);a.useEffect(()=>{var fe;const x=(fe=window.matchMedia)==null?void 0:fe.call(window,"(prefers-reduced-motion: reduce)");if(!x)return;const V=()=>p(x.matches);return V(),x.addEventListener?(x.addEventListener("change",V),()=>x.removeEventListener("change",V)):(x.addListener(V),()=>x.removeListener(V))},[]),a.useEffect(()=>{if(!m)return;const x=V=>{const fe=V.target;if(!fe)return;const H=fe.tagName;if(!(fe.isContentEditable||H==="INPUT"||H==="TEXTAREA"||H==="SELECT"||H==="BUTTON"||H==="A"||fe.closest('button, a, [role="button"], [role="link"]'))){if(V.key==="Escape"){$();return}if(V.key==="ArrowLeft"||V.key==="ArrowUp"){ce();return}(V.key==="ArrowRight"||V.key==="ArrowDown"||V.code==="Space"||V.key===" ")&&(V.preventDefault(),oe())}};return window.addEventListener("keydown",x),()=>window.removeEventListener("keydown",x)},[$,oe,ce,m]),a.useEffect(()=>{m&&U===W&&L()},[U,m,W,L]),a.useEffect(()=>{const x=c.current;if(!x)return;const V=u.current.filter(le=>!!le);if(!V.length)return;const fe=1,H=.6,F=.6,je=Math.max(1,Math.min(fe,window.devicePixelRatio||1));let Te=0,Ne=0,ze=H,Ie=0,Ve=0;const De=le=>{let xe=le%2147483647;return xe<=0&&(xe+=2147483646),(Be,Re)=>{xe=xe*48271%2147483647;const we=xe/2147483647;return Be+we*(Re-Be)}},Le={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},Ue=le=>{const xe=Math.sin(le*12.9898)*43758.5453;return xe-Math.floor(xe)},et=le=>{const xe=Ue(le+.1)||1e-4,Be=Ue(le+.7)||1e-4;return Math.sqrt(-2*Math.log(xe))*Math.cos(2*Math.PI*Be)},Je=(le,xe)=>{const Be=Math.floor(le),Re=Be+1,we=le-Be,A=we*we*(3-2*we),J=Ue(Be*12.9898+xe*78.233),Ce=Ue(Re*12.9898+xe*78.233);return J+(Ce-J)*A},ye=le=>{const xe=De(le),Be=Math.min(4,Math.max(4,Math.floor(Te/1200*Le.filamentCount)));return Array.from({length:Be},(Re,we)=>{const A=Math.max(-1,Math.min(1,et(le+we*.37))),J=Math.min(1,Math.max(0,Ue(le+we*1.31))),Ce=Math.min(Le.depthLayers-1,Math.floor(J*Le.depthLayers));return{seed:xe(0,Math.PI*2)+le*.01,offset:A,freqA:Le.freq1*(.75+xe(0,.5)),freqB:Le.freq2*(.75+xe(0,.5)),ampA:Le.amp1*(.6+xe(0,.7)),ampB:Le.amp2*(.6+xe(0,.7)),width:2+we%5*.32,depth:J,layer:Ce}})},ge=(le,xe,Be)=>{const Re=Math.max(30,Math.floor(Te*Ne/14e4));le.save(),le.globalAlpha=.6;for(let we=0;we<Re;we+=1){const A=Ue(we*9.1+Te*.11)*xe+Be,J=Ue(we*3.7+Ne*.23)*Ne,Ce=1.2+Ue(we*5.9)*2.4,R=le.createRadialGradient(A,J,0,A,J,Ce*2);R.addColorStop(0,"rgba(10, 30, 60, 0.45)"),R.addColorStop(1,"rgba(10, 30, 60, 0)"),le.fillStyle=R,le.beginPath(),le.arc(A,J,Ce*2,0,Math.PI*2),le.fill()}le.restore()},ie=(le,xe)=>{le.clearRect(0,0,Te,Ne);const Be=Ne*Le.waveCenter,Re=Le.waveBandPx,we=Le.segments,A=Le.colors.filaments,J=Ie||Te,Ce=0;ge(le,J,Ce),le.strokeStyle=A,le.lineCap="round",le.lineJoin="round";for(let R=0;R<xe.length;R+=1){const _=xe[R],Q=_.offset*Re*(.85+Ue(_.seed)*.4),se=1-Math.min(1,Math.abs(Q)/Re),Z=Math.exp(-Math.pow(Q/Le.crestThickness,2)),Pe=_.layer===0?1.1:_.layer===1?.85:.6,Fe=.35+(1-_.depth)*.65,Oe=se*Fe*Pe*(.34+Z*.45);le.globalAlpha=Oe,le.lineWidth=_.width*(1+(1-_.depth)*.8);const Ee=[];for(let Me=0;Me<=we;Me+=1){const lt=Me/we*J+Ce,We=(Je(lt*.012,_.seed)-.5)*Le.xJitter,Xe=lt+We,dt=(Je(Xe*_.freqA,_.seed)-.5)*Le.jitterA,bt=(Je(Xe*_.freqB,_.seed*1.7)-.5)*Le.jitterB,He=Be+Math.sin(Xe*_.freqA+_.seed)*_.ampA+Math.sin(Xe*_.freqB+_.seed*1.3)*_.ampB+Q+dt+bt;Ee.push({x:Xe,y:He})}le.beginPath(),le.moveTo(Ee[0].x,Ee[0].y);for(let Me=1;Me<Ee.length-1;Me+=1){const lt=(Ee[Me].x+Ee[Me+1].x)/2,We=(Ee[Me].y+Ee[Me+1].y)/2;le.quadraticCurveTo(Ee[Me].x,Ee[Me].y,lt,We)}const Ke=Ee[Ee.length-1];le.quadraticCurveTo(Ke.x,Ke.y,Ke.x,Ke.y),le.stroke()}le.save(),le.globalCompositeOperation="lighter",le.strokeStyle=Le.colors.glow,le.lineCap="round",le.lineJoin="round";for(let R=0;R<xe.length;R+=1){const _=xe[R];if(Math.abs(_.offset)*Re>Le.crestThickness)continue;const Q=Le.glowAlpha*(.7+(1-_.depth)*.6);le.globalAlpha=Q,le.lineWidth=1.6+(1-_.depth)*1.2;const se=[];for(let Pe=0;Pe<=we;Pe+=1){const Fe=Pe/we*J+Ce,Oe=Math.sin(Fe*.02+_.seed)*3,Ee=Be+Math.sin(Fe*_.freqA+_.seed)*_.ampA+Math.sin(Fe*_.freqB+_.seed*1.3)*_.ampB+_.offset*Re*.35+Oe;se.push({x:Fe,y:Ee})}le.beginPath(),le.moveTo(se[0].x,se[0].y);for(let Pe=1;Pe<se.length-1;Pe+=1){const Fe=(se[Pe].x+se[Pe+1].x)/2,Oe=(se[Pe].y+se[Pe+1].y)/2;le.quadraticCurveTo(se[Pe].x,se[Pe].y,Fe,Oe)}const Z=se[se.length-1];le.quadraticCurveTo(Z.x,Z.y,Z.x,Z.y),le.stroke()}le.restore()},ke=()=>{Te=Math.floor(x.clientWidth),Ne=Math.floor(x.clientHeight),Ie=Math.floor(Te*1.8),Ve=Ne,ze=Te<820?F:H,V.forEach(le=>{const xe=le.getContext("2d");if(!xe)return;le.width=Math.floor(Ie*je*ze),le.height=Math.floor(Ve*je*ze),le.style.width=`${Ie}px`,le.style.height=`${Ve}px`,le.style.left=`${-(Ie-Te)/2}px`,xe.setTransform(je*ze,0,0,je*ze,0,0);const Be=Number(le.dataset.seed||1),Re=ye(Be);ie(xe,Re)})};return ke(),window.addEventListener("resize",ke,{passive:!0}),()=>window.removeEventListener("resize",ke)},[ae]);const _e=Y[Math.min(U,Y.length-1)],me=m?_e:Y[Y.length-1],T=(me==null?void 0:me.theme)??Y[0].theme,be={"--cogita-bg0":T.bg0,"--cogita-bg1":T.bg1,"--cogita-bg2":T.bg2,"--cogita-bloom":T.bloom,"--cogita-sat":T.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:b,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Hs,{value:N,onChange:l}),e.jsx(Qs,{copy:t,label:n,isAuthenticated:i,secureMode:y,onLogin:s,onProfileNavigate:o,onToggleSecureMode:g,onLogout:f,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:c,className:"cogita-section cogita-home",style:be,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[ae.map((x,V)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:x.style,"data-seed":x.seed,ref:fe=>{u.current[V]=fe}},x.id)),S.map(x=>e.jsx("div",{className:"cogita-home-wave",style:x.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},x.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(ei,{slides:Y,activeIndex:U,introOpen:m,prefersReducedMotion:P,onNext:oe,onPrev:ce,onSelect:ne,onExit:$,onOpen:I,onRegister:G})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const cr=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:si},Symbol.toStringTag,{value:"Module"})),nn=a.createContext(!1);function Tt({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,headerExtra:l,children:b}){if(a.useContext(nn))return e.jsx(e.Fragment,{children:b});const u=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}y("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:u,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Hs,{value:E,onChange:N}),e.jsxs("div",{className:"cogita-header-right",children:[l,e.jsx(Qs,{copy:t,label:s,isAuthenticated:n,secureMode:f,onLogin:()=>y("home"),onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:b}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function Wt(t){const[s,n]=a.useState("Cogita library"),[i,o]=a.useState(null);return a.useEffect(()=>{let g=!1;return Ys().then(f=>{if(g)return;const y=f.find(E=>E.libraryId===t);y&&n(y.name)}).catch(()=>{g||n("Cogita library")}),()=>{g=!0}},[t]),a.useEffect(()=>{let g=!1;return xn(t).then(f=>{g||o(f)}).catch(()=>{g||o(null)}),()=>{g=!0}},[t]),{libraryName:s,stats:i}}function Ms({slices:t}){const s=t.reduce((i,o)=>i+Math.max(0,o.value),0),n=a.useMemo(()=>{if(s<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let i=0;return`conic-gradient(${t.map(g=>{const y=Math.max(0,g.value)/s*360,E=i,N=i+y;return i=N,`${g.color} ${E}deg ${N}deg`}).join(",")})`},[t,s]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:n}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(i=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:i.color}}),e.jsx("strong",{children:i.value}),e.jsx("small",{children:i.label})]},i.label))})]})}function ni({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,libraryId:l}){const{libraryName:b,stats:c}=Wt(l),[u,S]=a.useState("infos"),[ae,Y]=a.useState(0),[U,k]=a.useState(0),[m,de]=a.useState(0),P=(c==null?void 0:c.totalInfos)??0,p=(c==null?void 0:c.totalCollections)??0,W=0,L=0,G=0,I=Math.max(0,P-G-U),$=Math.max(0,P-U-m);a.useEffect(()=>{let oe=!1;return(async()=>{try{const _e=await ja({libraryId:l,limit:200}),me=await Promise.all(_e.items.map(T=>Gs({libraryId:l,collectionId:T.collectionId}).catch(()=>[])));if(oe)return;Y(me.reduce((T,be)=>T+be.length,0))}catch{oe||Y(0)}})(),()=>{oe=!0}},[l]),a.useEffect(()=>{let oe=!1;return(async()=>{try{const[_e,me,T]=await Promise.all([Ns({libraryId:l,type:"computed",limit:1}).catch(()=>({total:0})),Ns({libraryId:l,type:"source",limit:1}).catch(()=>({total:0})),fs({libraryId:l}).catch(()=>({items:[]}))]);if(oe)return;k((_e.total??0)+(me.total??0));const be=new Set(T.items.filter(x=>x.childItemType.toLowerCase()==="info").map(x=>x.childItemId).filter(Boolean));de(be.size)}catch{oe||(k(0),de(0))}})(),()=>{oe=!0}},[l]);const ne=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:P},{key:"collections",label:t.cogita.library.overview.stats.collections,value:p},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:ae},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:W},{key:"texts",label:t.cogita.library.overview.stats.texts,value:L}];return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:b})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:ne.map(oe=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${u===oe.key?"active":""}`,onClick:()=>S(oe.key),children:[e.jsx("span",{children:oe.label}),e.jsx("strong",{children:oe.value})]},oe.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),u==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(Ms,{slices:[{label:t.cogita.library.overview.known,value:G,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:I,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:U,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(Ms,{slices:[{label:t.cogita.library.overview.availableChecks,value:m,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:$,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const Ge=(t,s)=>{const n=t.cogita.library.infoTypes,i=t.cogita.library.connectionTypes,o=t.cogita.library.groupTypes;return{any:n.any,vocab:n.vocab,book:o.book,citation:o.citation,language:n.language,word:n.word,sentence:n.sentence,topic:n.topic,collection:n.collection,person:n.person,institution:n.institution,collective:n.collective,orcid:n.orcid,address:n.address,email:n.email,phone:n.phone,media:n.media,work:n.work,geo:n.geo,music_piece:n.musicPiece,music_fragment:n.musicFragment,source:n.source,computed:n.computed,"word-language":i.wordLanguage,"quote-language":i.quoteLanguage,"language-sentence":i.languageSentence,translation:i.translation,"word-topic":i.wordTopic,reference:i.reference,"source-resource":i.sourceResource,"work-contributor":i.workContributor,"work-medium":i.workMedium,"orcid-link":i.orcidLink}[s]??String(s)},ii=t=>[{value:"any",label:Ge(t,"any")},{value:"language",label:Ge(t,"language")},{value:"word",label:Ge(t,"word")},{value:"sentence",label:Ge(t,"sentence")},{value:"topic",label:Ge(t,"topic")},{value:"collection",label:Ge(t,"collection")},{value:"person",label:Ge(t,"person")},{value:"institution",label:Ge(t,"institution")},{value:"collective",label:Ge(t,"collective")},{value:"orcid",label:Ge(t,"orcid")},{value:"address",label:Ge(t,"address")},{value:"email",label:Ge(t,"email")},{value:"phone",label:Ge(t,"phone")},{value:"media",label:Ge(t,"media")},{value:"work",label:Ge(t,"work")},{value:"geo",label:Ge(t,"geo")},{value:"music_piece",label:Ge(t,"music_piece")},{value:"music_fragment",label:Ge(t,"music_fragment")},{value:"source",label:Ge(t,"source")},{value:"citation",label:Ge(t,"citation")},{value:"computed",label:Ge(t,"computed")},{value:"vocab",label:Ge(t,"vocab")},{value:"book",label:Ge(t,"book")},{value:"word-language",label:Ge(t,"word-language")},{value:"quote-language",label:Ge(t,"quote-language")},{value:"language-sentence",label:Ge(t,"language-sentence")},{value:"translation",label:Ge(t,"translation")},{value:"word-topic",label:Ge(t,"word-topic")},{value:"reference",label:Ge(t,"reference")},{value:"source-resource",label:Ge(t,"source-resource")},{value:"work-contributor",label:Ge(t,"work-contributor")},{value:"work-medium",label:Ge(t,"work-medium")},{value:"orcid-link",label:Ge(t,"orcid-link")}],ri=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Za={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},oi={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code","notes"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","notes","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Za]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","notes","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Za]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name","notes"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name","notes"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid","notes"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country","notes"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address","notes"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number","notes"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind","notes"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId","notes"]},filterFields:[Za,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city","notes"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer","notes"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text","notes"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator","notes"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text","notes"],connections:[{relationType:"quote-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"quote",kind:"text",path:"text",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition","notes"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},Is={infoType:"default",entityKind:"single",structure:{payloadFields:["label","notes"]},filterFields:[]};function ci(t){return t?oi[t]??Is:Is}function li(t,s){return t.optionsSource==="languages"?s.languages.map(n=>({value:n.infoId,label:n.label})):t.optionsSource==="sourceKinds"?ri:[]}const es=60,di=500;function rn(t){return`cogita.info-selection:${t}`}function Ls(t){if(typeof window>"u")return{};const s=window.localStorage.getItem(rn(t));if(!s)return{};try{const n=JSON.parse(s);return!n||typeof n!="object"?{}:n}catch{return{}}}function ui({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,libraryId:l,mode:b}){var wt;const c=Os(),u=Va(),S=t.cogita.library.list,[ae,Y]=a.useState("any"),[U,k]=a.useState(""),[m,de]=a.useState("relevance"),[P,p]=a.useState("details"),[W,L]=a.useState(!1),[G,I]=a.useState("idle"),[$,ne]=a.useState([]),[oe,ce]=a.useState(es),[_e,me]=a.useState(null),[T,be]=a.useState(()=>Ls(l)),[x,V]=a.useState({}),[fe,H]=a.useState([]),[F,je]=a.useState(null),[Te,Ne]=a.useState(null),[ze,Ie]=a.useState(null),[Ve,De]=a.useState("idle"),[Le,Ue]=a.useState([]),[et,Je]=a.useState(""),[ye,ge]=a.useState(null),[ie,ke]=a.useState("idle"),[le,xe]=a.useState(null),[Be,Re]=a.useState(null),[we,A]=a.useState("idle"),J=a.useMemo(()=>ii(t),[t]),Ce=a.useMemo(()=>[{value:"relevance",label:S.sortRelevance},{value:"label_asc",label:S.sortLabelAsc},{value:"label_desc",label:S.sortLabelDesc},{value:"type_asc",label:S.sortTypeAsc},{value:"type_desc",label:S.sortTypeDesc}],[S.sortLabelAsc,S.sortLabelDesc,S.sortRelevance,S.sortTypeAsc,S.sortTypeDesc]);a.useEffect(()=>{be(Ls(l)),V({}),L(!1)},[l]),a.useEffect(()=>{fs({libraryId:l}).then(D=>Ie(D)).catch(()=>Ie({items:[]}))},[l]),a.useEffect(()=>{vn({libraryId:l}).then(D=>Ue(D)).catch(()=>Ue([]))},[l]),a.useEffect(()=>{Ss({libraryId:l,type:"language",filters:{sourceKind:"info"},limit:200}).then(D=>{const te=D.map(Se=>({infoId:Se.infoId??"",infoType:Se.entityType,label:Se.title})).filter(Se=>Se.infoId.length>0);H(te)}).catch(()=>H([]))},[l]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(rn(l),JSON.stringify(T))},[l,T]);const R=a.useMemo(()=>ci(ae==="any"?null:ae),[ae]),_=a.useMemo(()=>new URLSearchParams(u.search),[u.search]),Q=a.useMemo(()=>u.pathname.split("/").filter(Boolean),[u.pathname]),se=Q.findIndex(D=>D==="infos"),Z=se>=0&&(Q[se+1]??"").trim()||null,Pe=se>=0?(Q[se+2]??"").trim()==="checkcards"?"cards":"overview":"",Fe=Z??((_.get("infoId")??"").trim()||null),Oe=Z?Pe:(_.get("infoView")??"overview").trim(),Ee=Oe==="overview"&&!!Fe,Ke=a.useMemo(()=>({language:S.typeFilterLanguage,languageA:S.typeFilterLanguageA,languageB:S.typeFilterLanguageB,originalLanguage:S.typeFilterOriginalLanguage,doi:S.typeFilterDoi,sourceKind:S.typeFilterSourceKind,locator:S.typeFilterLocator,quote:S.typeFilterQuote}),[S.typeFilterDoi,S.typeFilterLanguage,S.typeFilterLanguageA,S.typeFilterLanguageB,S.typeFilterLocator,S.typeFilterOriginalLanguage,S.typeFilterQuote,S.typeFilterSourceKind]),Me=a.useMemo(()=>R.filterFields.map(D=>({...D,label:D.labelKey?Ke[D.labelKey]:D.label??D.key,options:li(D,{languages:fe})})),[Ke,fe,R.filterFields]),lt=a.useMemo(()=>Me.some(D=>(x[D.key]??"").trim().length>0),[Me,x]);a.useEffect(()=>{V({})},[ae]),a.useEffect(()=>{const D={sourceKind:"info"};if(lt)for(const Se of Me){const d=(x[Se.key]??"").trim();d&&(D[Se.path??Se.key]=d)}I("loading");const te=window.setTimeout(()=>{Ss({libraryId:l,type:ae==="any"?void 0:ae,query:U.trim()||void 0,filters:D,limit:di}).then(Se=>{const d=Se.map(ve=>({infoId:ve.infoId??"",infoType:ve.entityType,label:ve.title})).filter(ve=>ve.infoId.length>0);ne(d),I("ready")}).catch(()=>{ne([]),I("ready")})},240);return()=>window.clearTimeout(te)},[lt,l,U,ae,Me,x]),a.useEffect(()=>{if(!Fe||Oe!=="overview"){je(null),Ne(null),De("idle");return}let D=!1;return De("loading"),Promise.all([Gt({libraryId:l,infoId:Fe}),wn({libraryId:l,itemType:"info",itemId:Fe}).catch(()=>null)]).then(([te,Se])=>{D||(je(te),Ne(Se),De("ready"))}).catch(()=>{D||(je(null),Ne(null),De("error"))}),()=>{D=!0}},[l,Fe,Oe]),a.useEffect(()=>{if(!Fe||Oe!=="overview"){xe(null),Re(null),A("idle");return}let D=!1;return A("loading"),Promise.all([Js({libraryId:l,infoId:Fe}),Xs({libraryId:l,infoId:Fe})]).then(([te,Se])=>{D||(xe(te),Re(Se),A("ready"))}).catch(()=>{D||(xe(null),Re(null),A("error"))}),()=>{D=!0}},[l,Fe,Oe]);const We=a.useMemo(()=>F?Le.filter(D=>D.sourceInfoTypes.some(te=>te.toLowerCase()===F.infoType.toLowerCase())):[],[Le,F]);a.useEffect(()=>{if(!F){Je("");return}Je(D=>{var te;return D&&We.some(Se=>Se.approachKey===D)?D:((te=We[0])==null?void 0:te.approachKey)??""})},[We,F]),a.useEffect(()=>{if(!F||!et){ge(null),ke("idle");return}let D=!1;return ke("loading"),Zs({libraryId:l,infoId:F.infoId,approachKey:et}).then(te=>{D||(ge(te),ke("ready"))}).catch(()=>{D||(ge(null),ke("error"))}),()=>{D=!0}},[l,et,F]);const Xe=a.useMemo(()=>{const D=$.slice(),te=Se=>Ge(t,Se);return m==="relevance"?D:m==="label_asc"?D.sort((Se,d)=>Se.label.localeCompare(d.label)):m==="label_desc"?D.sort((Se,d)=>d.label.localeCompare(Se.label)):m==="type_asc"?D.sort((Se,d)=>Se.infoType===d.infoType?Se.label.localeCompare(d.label):te(Se.infoType).localeCompare(te(d.infoType))):D.sort((Se,d)=>Se.infoType===d.infoType?Se.label.localeCompare(d.label):te(d.infoType).localeCompare(te(Se.infoType)))},[t,$,m]),dt=a.useMemo(()=>Xe.slice(0,oe),[Xe,oe]),bt=dt.length<Xe.length,He=a.useMemo(()=>new Set(Object.keys(T)),[T]),Qe=a.useMemo(()=>Object.values(T),[T]),Ct=a.useMemo(()=>{const D=new Map;for(const te of Qe)D.set(te.infoType,(D.get(te.infoType)??0)+1);return Array.from(D.entries()).sort((te,Se)=>Se[1]-te[1]||te[0].localeCompare(Se[0]))},[Qe]),ut=a.useMemo(()=>{if(!Fe||!ze)return 0;const D=new Set;for(const te of ze.items)te.childItemType!=="info"||te.childItemId!==Fe||D.add([te.parentItemType,te.parentItemId,te.parentCheckType??"",te.parentDirection??""].join("|"));return D.size},[ze,Fe]);a.useEffect(()=>{ce(es);const D=new Set($.map(te=>te.infoId));me(te=>te&&D.has(te)?te:null)},[$]);const Lt=D=>{be(te=>({...te,[D.infoId]:{infoId:D.infoId,infoType:D.infoType,label:D.label}}))},ct=D=>{be(te=>{if(!te[D])return te;const Se={...te};return delete Se[D],Se})},nt=(D,te)=>{if(te){Lt(D);return}ct(D.infoId)},$t=D=>{c(`/cogita/library/${l}/infos/${encodeURIComponent(D)}`,{replace:!0})},yt=()=>{c(`/cogita/library/${l}/list`,{replace:!0})},tt=()=>{Fe&&c(`/cogita/library/${l}/edit/${encodeURIComponent(Fe)}`,{replace:!0})},at=Qe.length===1?((wt=Qe[0])==null?void 0:wt.infoId)??null:null,Et=S.selectionCount.replace("{count}",String(Qe.length)),Rt=b==="collection"?"grid":b==="detail"?"wide":P,Ze=mi(E),gt=Te?Math.max(0,Math.min(100,Math.round((Te.score??0)*100))):0,pt=Te?pi(Te,Ze):Ze.noKnownnessData;return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":Rt,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[Ee?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:Ze.kicker}),e.jsx("h2",{className:"cogita-card-title",children:F?hi(F.payload,F.infoType,F.infoId):Ze.loading}),F?e.jsxs("p",{className:"cogita-card-subtitle",children:[Ge(t,F.infoType)," · ",F.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:yt,children:Ze.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:tt,disabled:!Fe||Ve!=="ready",children:S.editInfo})]})]}),Ve==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:Ze.loading})}):Ve==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:Ze.loadError})}):F?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Ze.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[gt,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${gt}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:pt})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Ze.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(Te==null?void 0:Te.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:Ze.correct.replace("{correct}",String((Te==null?void 0:Te.correctReviews)??0)).replace("{total}",String((Te==null?void 0:Te.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:Te!=null&&Te.lastReviewedUtc?`${Ze.lastReview}: ${gi(Te.lastReviewedUtc,E)}`:Ze.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:Ze.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:ut}),e.jsx("p",{className:"cogita-library-hint",children:Ze.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Ze.checkcards}),we==="loading"?e.jsx("p",{className:"cogita-library-hint",children:Ze.loadingCheckcards}):we==="error"?e.jsx("p",{className:"cogita-library-hint",children:Ze.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:Ze.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(le==null?void 0:le.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:Ze.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(Be==null?void 0:Be.items.length)??0})]})]})]}),We.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:Ze.approach}),e.jsx("select",{value:et,onChange:D=>Je(D.target.value),"aria-label":Ze.approach,children:We.map(D=>e.jsx("option",{value:D.approachKey,children:D.label},D.approachKey))})]}),ie==="loading"?e.jsx("p",{className:"cogita-library-hint",children:Ze.loadingApproach}):ie==="error"?e.jsx("p",{className:"cogita-library-hint",children:Ze.loadApproachError}):ye?e.jsx(Ea,{value:ye.projection,emptyLabel:Ze.empty}):e.jsx("p",{className:"cogita-library-hint",children:Ze.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Ze.payload}),e.jsx(Ea,{value:F.payload,emptyLabel:Ze.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:Ze.links}),e.jsx(fi,{links:F.links,emptyLabel:Ze.noLinks})]})]})]}):null]})}):null,Ee?null:e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":S.typeLabel,value:ae,onChange:D=>Y(D.target.value),children:J.map(D=>e.jsx("option",{value:D.value,children:D.label},D.value))}),e.jsx("input",{type:"text",value:U,onChange:D=>k(D.target.value),placeholder:S.searchPlaceholder}),e.jsx("select",{"aria-label":S.sortLabel,value:m,onChange:D=>de(D.target.value),children:Ce.map(D=>e.jsx("option",{value:D.value,children:D.label},D.value))}),e.jsxs("select",{"aria-label":S.viewLabel,value:P,onChange:D=>p(D.target.value),children:[e.jsx("option",{value:"details",children:S.viewDetails}),e.jsx("option",{value:"wide",children:S.viewWide}),e.jsx("option",{value:"grid",children:S.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:S.cardCount.replace("{shown}",String(dt.length)).replace("{total}",String(Xe.length))}),e.jsx("span",{children:G==="loading"?S.loading:S.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>L(D=>!D),children:W?S.hideFilters:S.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:S.filtersOptionalHint})]}),W&&Me.length>0?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsx("div",{className:"cogita-filter-grid",children:Me.map(D=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:D.label}),D.kind==="select"?e.jsxs("select",{value:x[D.key]??"",onChange:te=>V(Se=>({...Se,[D.key]:te.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(D.options??[]).map(te=>e.jsx("option",{value:te.value,children:te.label},`${D.key}:${te.value}`))]}):e.jsx("input",{type:"text",value:x[D.key]??"",onChange:te=>V(Se=>({...Se,[D.key]:te.target.value}))})]},`type-filter:${D.key}`))})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:Et}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{be(D=>{const te={...D};for(const Se of dt)te[Se.infoId]={infoId:Se.infoId,infoType:Se.infoType,label:Se.label};return te})},disabled:dt.length===0,children:S.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>be({}),disabled:Qe.length===0,children:S.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>at&&$t(at),disabled:!at,title:at?void 0:S.openSelectedDisabled,children:S.openSelected})]})]}),Qe.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:S.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:S.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:Ct.map(([D,te])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:Ge(t,D)}),e.jsx("span",{className:"cogita-tag-count",children:te})]},`stack:type:${D}`))})]}):null,Rt==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":S.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:S.detailColumnName}),e.jsx("span",{children:S.detailColumnType}),e.jsx("span",{children:S.detailColumnId}),e.jsx("span",{})]}),dt.length?dt.map(D=>{const te=Ge(t,D.infoType),Se=He.has(D.infoId),d=_e===D.infoId;return e.jsxs("div",{className:`cogita-details-row ${d||Se?"active":""}`,role:"row",onClick:()=>me(D.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:Se,onChange:ve=>nt(D,ve.target.checked),onClick:ve=>ve.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:D.label,children:D.label}),e.jsx("span",{title:te,children:te}),e.jsx("span",{title:D.infoId,children:D.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:ve=>{ve.stopPropagation(),$t(D.infoId)},"aria-label":S.editInfo,children:">"})]},D.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:S.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${Rt}`,"data-view":Rt,children:dt.length?dt.map(D=>{const te=Ge(t,D.infoType),Se=He.has(D.infoId),d=_e===D.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":d||Se,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:Se,onChange:ve=>nt(D,ve.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>me(D.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:te}),e.jsx("h3",{className:"cogita-card-title",children:D.label}),e.jsx("p",{className:"cogita-card-subtitle",children:D.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>$t(D.infoId),children:S.editInfo})]})},D.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:S.noMatch})})}),bt?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>ce(D=>D+es),children:S.loadMore})}):null]})]})})})})}function hi(t,s,n){if(t&&typeof t=="object"&&!Array.isArray(t)){const i=t,o=["title","name","label","value","text","quote","term"];for(const g of o){const f=i[g];if(typeof f=="string"&&f.trim())return f.trim()}}return`${s} · ${n}`}function gi(t,s){try{const n=s==="pl"?"pl-PL":s==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(n,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function mi(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function pi(t,s){return t.totalReviews<=0?s.noKnownnessData:t.totalReviews<3||t.score<.35?s.developmentStart:t.totalReviews<8||t.score<.65?s.developmentGrowing:t.score<.85?s.developmentStable:s.developmentStrong}function fi({links:t,emptyLabel:s}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:s}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([n,i])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:n}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(i)?i.length?e.jsx("div",{className:"cogita-selection-overview",children:i.map(o=>e.jsx("span",{className:"cogita-tag-chip",children:o},`${n}:${o}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):i?e.jsx("span",{className:"cogita-tag-chip",children:i}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},n))})}function Ea({value:t,emptyLabel:s}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:s});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((n,i)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:i+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(Ea,{value:n,emptyLabel:s})})]},i))});if(typeof t=="object"){const n=Object.entries(t);return n.length===0?e.jsx("p",{className:"cogita-library-hint",children:s}):e.jsx("div",{className:"cogita-info-tree",children:n.map(([i,o])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:i}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(Ea,{value:o,emptyLabel:s})})]},i))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const sa=5,$s=50,Rs=2,Es=[];function na({libraryId:t,infoType:s,label:n,placeholder:i,value:o,onChange:g,values:f,onChangeMultiple:y,helperText:E,searchFailedText:N,createFailedText:l,createLabel:b,savingLabel:c,loadMoreLabel:u,inputRef:S,autoAdvance:ae,onCommit:Y,multiple:U}){const k=U?f??Es:Es,[m,de]=a.useState(U?"":(o==null?void 0:o.label)??""),[P,p]=a.useState([]),[W,L]=a.useState(sa),[G,I]=a.useState(-1),[$,ne]=a.useState(!1),[oe,ce]=a.useState(!1),[_e,me]=a.useState(null),T=a.useRef(0),be=a.useRef(new Map),x=a.useMemo(()=>U?m.trim().length>0:m.trim().length>0&&!o,[m,o,U]);a.useEffect(()=>{U||de((o==null?void 0:o.label)??"")},[o,U]),a.useEffect(()=>{const H=m.trim();if(!H||H.length<Rs){p([]),ne(!1),L(sa),I(-1),ce(!1),me(null);return}const F=H.toLowerCase(),je=`${t}:${s}:${F}`,Te=be.current.get(je);if(Te){if(U&&k.length>0){const ze=new Set(k.map(Ie=>Ie.id));p(Te.filter(Ie=>!ze.has(Ie.id)))}else p(Te);L(sa),I(-1),ne(Te.length>0),ce(!1),me(null);return}const Ne=window.setTimeout(async()=>{const ze=Date.now();T.current=ze,ce(!0),me(null);try{const Ie=await bs({libraryId:t,type:s,query:H,limit:$s});if(T.current!==ze)return;const Ve=Ie.slice(0,$s).map(De=>({id:De.infoId,label:De.label,infoType:De.infoType}));if(be.current.set(je,Ve),U&&k.length>0){const De=new Set(k.map(Le=>Le.id));p(Ve.filter(Le=>!De.has(Le.id)))}else p(Ve);L(sa),I(-1),ne(!0)}catch{if(T.current!==ze)return;me(N??"Search failed.")}finally{T.current===ze&&ce(!1)}},250);return()=>window.clearTimeout(Ne)},[t,s,m,k]);const V=H=>{if(U){const F=k.some(je=>je.id===H.id)?k:[...k,H];y==null||y(F),de(""),ne(!1),I(-1);return}g==null||g(H),de(H.label),ne(!1),I(-1),ae&&(Y==null||Y())},fe=async()=>{const H=m.trim();if(H){ce(!0),me(null);try{const F=await en({libraryId:t,infoType:s,payload:{label:H}}),je={id:F.infoId,label:H,infoType:F.infoType};if(H.length>=Rs){const Te=`${t}:${s}:${H.toLowerCase()}`,Ne=be.current.get(Te)??[];be.current.set(Te,[je,...Ne])}if(U){y==null||y([...k,je]),de(""),ne(!1),I(-1);return}g==null||g(je),ne(!1),I(-1),ae&&(Y==null||Y())}catch{me(l??"Create failed.")}finally{ce(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:n}),e.jsx("input",{value:m,placeholder:i,onChange:H=>{de(H.target.value),!U&&o&&(g==null||g(null))},onKeyDown:H=>{if(H.key==="ArrowDown"){if(H.preventDefault(),!P.length)return;ne(!0),I(F=>{const je=Math.min(P.length,W)-1,Te=F<0?0:Math.min(F+1,je);return Te===je&&P.length>W?(L(Ne=>Math.min(Ne+sa,P.length)),Math.min(F+1,Math.min(P.length,W+sa)-1)):Te});return}if(H.key==="ArrowUp"){if(H.preventDefault(),!P.length)return;ne(!0),I(F=>F<=0?0:F-1);return}if(H.key==="Enter"){if(H.preventDefault(),G>=0&&P[G]){V(P[G]);return}if(x){fe();return}}},onFocus:()=>{P.length>0&&ne(!0)},autoComplete:"off",ref:S})]}),U&&k.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:k.map(H=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>y==null?void 0:y(k.filter(F=>F.id!==H.id)),children:[H.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},H.id))}),E&&e.jsx("p",{className:"cogita-help",children:E}),_e&&e.jsx("p",{className:"cogita-error",children:_e}),$&&P.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[P.slice(0,W).map((H,F)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":F===G,onClick:()=>V(H),children:[e.jsx("strong",{children:H.label}),e.jsx("span",{children:H.infoType})]},H.id)),W<P.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>L(H=>Math.min(H+sa,P.length)),children:u??"Load more"})]}),x&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:fe,disabled:oe,children:oe?c??"Saving...":b??`Create new ${s}`})]})}function bi(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function As(t,s){if(!t||typeof t!="object")return s;const n=t,i=[n.label,n.name,n.title,n.text,n.orcid,n.email,n.number];for(const o of i)if(typeof o=="string"&&o.trim())return o.trim();return s}function yi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,libraryId:l,editInfoId:b}){const{libraryName:c}=Wt(l),u=!!b,[S,ae]=a.useState([]),[Y,U]=a.useState("word"),[k,m]=a.useState({}),[de,P]=a.useState({}),[p,W]=a.useState({}),[L,G]=a.useState({}),[I,$]=a.useState(null),[ne,oe]=a.useState("idle"),ce=a.useMemo(()=>S.find(x=>x.infoType===Y),[Y,S]),_e=a.useMemo(()=>S.map(x=>({value:x.infoType,label:Ge(t,x.infoType)})),[t,S]);a.useEffect(()=>{let x=!1;return jn({libraryId:l}).then(V=>{var fe;if(!x&&(ae(V),!u)){const H=(fe=V[0])==null?void 0:fe.infoType;H&&U(H)}}).catch(()=>{x||ae([])}),()=>{x=!0}},[u,l]),a.useEffect(()=>{if(!ce)return;const x={},V={},fe={},H={};for(const F of ce.payloadFields)x[F.key]="";for(const F of ce.linkFields)F.multiple?fe[F.key]=[]:V[F.key]=null,F.targetTypes.length>0&&(H[F.key]=F.targetTypes[0]);m(x),P(V),W(fe),G(H)},[ce==null?void 0:ce.infoType]),a.useEffect(()=>{if(!u||!b||S.length===0)return;let x=!1;return oe("loading"),$(null),(async()=>{const fe=await Gt({libraryId:l,infoId:b});if(x)return;const H=fe.infoType;U(H);const F=S.find(Le=>Le.infoType===H);if(!F){oe("idle");return}const je=fe.payload??{},Te={};for(const Le of F.payloadFields)Te[Le.key]=bi(je[Le.key]);m(Te);const Ne=fe.links??{}??{},ze={},Ie={},Ve={},De=[];for(const Le of F.linkFields){Le.targetTypes.length>0&&(Ve[Le.key]=Le.targetTypes[0]);const Ue=Ne[Le.key];if(Le.multiple){const et=Array.isArray(Ue)?Ue.filter(Je=>typeof Je=="string"):[];Ie[Le.key]=[];for(const Je of et)De.push(Gt({libraryId:l,infoId:Je}).then(ye=>{if(x)return;const ge={id:Je,infoType:ye.infoType,label:As(ye.payload,Je)};Ie[Le.key]=[...Ie[Le.key],ge]}).catch(()=>{}))}else{const et=typeof Ue=="string"?Ue:null;ze[Le.key]=null,et&&De.push(Gt({libraryId:l,infoId:et}).then(Je=>{x||(ze[Le.key]={id:et,infoType:Je.infoType,label:As(Je.payload,et)})}).catch(()=>{}))}}await Promise.all(De),!x&&(P(ze),W(Ie),G(Le=>({...Le,...Ve})),oe("idle"))})().catch(()=>{x||($("Failed to load info details."),oe("idle"))}),()=>{x=!0}},[b,u,l,S]);const me=async()=>{var H;if(!ce)return;const x={};for(const F of ce.payloadFields){const je=(k[F.key]??"").trim();if(!je){if(F.required){$(`Field '${F.label}' is required.`);return}continue}if(F.inputType==="json")try{x[F.key]=JSON.parse(je)}catch{$(`Field '${F.label}' must be valid JSON.`);return}else x[F.key]=je}const V={};for(const F of ce.linkFields)if(F.multiple){const je=(p[F.key]??[]).map(Te=>Te.id);if(F.required&&je.length===0){$(`Link '${F.label}' is required.`);return}je.length>0&&(V[F.key]=je)}else{const je=((H=de[F.key])==null?void 0:H.id)??null;if(F.required&&!je){$(`Link '${F.label}' is required.`);return}je&&(V[F.key]=je)}const fe=Object.keys(V).length>0;oe("saving"),$(null);try{if(u&&b)await kn({libraryId:l,infoId:b,payload:x,links:fe?V:void 0}),$("Info updated.");else{await en({libraryId:l,infoType:Y,payload:x,links:fe?V:void 0}),$("Info saved.");const F={};for(const Ne of ce.payloadFields)F[Ne.key]="";m(F);const je={},Te={};for(const Ne of ce.linkFields)Ne.multiple?Te[Ne.key]=[]:je[Ne.key]=null;P(Ne=>({...Ne,...je})),W(Ne=>({...Ne,...Te}))}}catch{$("Failed to save info.")}finally{oe("idle")}},T=x=>{const V=k[x.key]??"",fe=x.inputType==="textarea"||x.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:x.label}),fe?e.jsx("textarea",{rows:x.inputType==="json"?8:4,value:V,onChange:H=>m(F=>({...F,[x.key]:H.target.value})),placeholder:x.key}):e.jsx("input",{type:"text",value:V,onChange:H=>m(F=>({...F,[x.key]:H.target.value})),placeholder:x.key})]},`payload:${x.key}`)},be=x=>{const V=L[x.key]??x.targetTypes[0];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:x.label}),x.targetTypes.length>1?e.jsx("select",{value:V,onChange:fe=>G(H=>({...H,[x.key]:fe.target.value})),children:x.targetTypes.map(fe=>e.jsx("option",{value:fe,children:Ge(t,fe)},`${x.key}:${fe}`))}):null,x.multiple?e.jsx(na,{libraryId:l,infoType:V,label:x.label,placeholder:x.key,multiple:!0,values:p[x.key]??[],onChangeMultiple:fe=>W(H=>({...H,[x.key]:fe})),searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(na,{libraryId:l,infoType:V,label:x.label,placeholder:x.key,value:de[x.key]??null,onChange:fe=>P(H=>({...H,[x.key]:fe})),searchFailedText:"Search failed",createFailedText:"Create failed"})]},`link:${x.key}`)};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:u?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${l}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[u?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:Y,onChange:x=>U(x.target.value),children:_e.map(x=>e.jsx("option",{value:x.value,children:x.label},x.value))})]}),ne==="loading"?e.jsx("p",{children:"Loading..."}):null,ce?e.jsxs("div",{className:"cogita-form-grid",children:[ce.payloadFields.map(T),ce.linkFields.map(be)]}):e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:me,disabled:ne==="saving"||!ce,children:ne==="saving"?"Saving...":u?"Update info":"Create info"})}),I?e.jsx("p",{className:"cogita-library-subtitle",children:I}):null]})})})]})})}const Ps=t=>/\s/.test(t),Aa=t=>/[\p{L}\p{N}]/u.test(t),Fs=(t,s)=>{const n=s>0?t[s-1]:"",i=s<t.length?t[s]:"";if(!n||!i)return 0;const o=Ps(n),g=Ps(i);if(o||g)return 3;const f=Aa(n),y=Aa(i);return f!==y?2:!f&&!y?1:0},ts=(t,s,n,i,o)=>{const g=Math.max(i-s,n-i);for(let f=0;f<=g;f+=1){const y=i-f;if(y>=s&&y<=n&&Fs(t,y)>=o)return y;const E=i+f;if(E>=s&&E<=n&&Fs(t,E)>=o)return E}return null},as=(t,s)=>{const n=s>0?t[s-1]:"",i=s<t.length?t[s]:"";return!n||!i?!0:Aa(n)!==Aa(i)},xi=(t,s,n,i)=>{const o=n-s,g=s+i,f=n-i;if(o<=i*2||f<=g)return null;const y=Math.floor((s+n)/2),E=ts(t,g,f,y,3);if(E!==null&&as(t,E))return E;const N=ts(t,g,f,y,2);if(N!==null&&as(t,N))return N;const l=ts(t,g,f,y,1);return l!==null&&as(t,l)?l:null},ia=(t,s)=>{const n=Math.max(1,7),i=Math.max(n,13),o={},g=(E,N,l,b,c)=>{const u=String(b),S={id:u,start:E,end:N,text:t.slice(E,N),depth:l,index:b,parentId:c};if(o[u]=S,N-E>i){let Y=xi(t,E,N,n);if(Y!==null&&Y>E&&Y<N){const U=g(E,Y,l+1,b*2+1,u),k=g(Y,N,l+1,b*2+2,u);S.leftId=U.id,S.rightId=k.id}}return S},f=g(0,t.length,0,0),y=Object.values(o).sort((E,N)=>N.depth-E.depth||E.start-N.start).map(E=>E.id);return{text:t,rootId:f.id,nodes:o,order:y}},ma=(t,s,n,i,o,g,f)=>{const y=g==="reverse"?t.order.slice().sort((E,N)=>t.nodes[N].start-t.nodes[E].start||t.nodes[N].depth-t.nodes[E].depth):t.order;for(const E of y){if(f&&E===f||s.has(E))continue;const N=t.nodes[E];if(N){if(o&&(N.leftId||N.rightId)){const l=N.leftId?n[N.leftId]??0:i,b=N.rightId?n[N.rightId]??0:i;if((l+b)/2<i)continue}return N}}return null},ys=(t,s)=>({before:t.slice(0,s.start),fragment:t.slice(s.start,s.end),after:t.slice(s.end)});function vi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,libraryId:l}){const b=`/#/cogita/library/${l}`,[c,u,S]=qs([]),[ae,Y,U]=Us([]),[k,m]=a.useState(null),[de,P]=a.useState(null),[p,W]=a.useState(null),[L,G]=a.useState(null),I=a.useMemo(()=>c.find(T=>T.id===k)??null,[c,k]);a.useEffect(()=>{let T=!0;return Nn({libraryId:l}).then(be=>{if(!T)return;const x=be.nodes.map(V=>{var fe,H,F;return{id:V.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:V.payload&&typeof V.payload=="object"&&"label"in V.payload?String(V.payload.label):"Item",nodeType:V.nodeType,itemType:((fe=V.payload)==null?void 0:fe.itemType)??"info",itemId:((H=V.payload)==null?void 0:H.itemId)??null,infoType:((F=V.payload)==null?void 0:F.infoType)??null}}});u(x),Y(be.edges.map(V=>({id:V.edgeId,source:V.fromNodeId,target:V.toNodeId})))}).catch(()=>{T&&(u([]),Y([]))}),()=>{T=!1}},[l]),a.useEffect(()=>{Sn({libraryId:l}).then(P).catch(()=>P(null))},[l,c,ae]);const $=a.useCallback(T=>{Y(be=>Ws(T,be))},[]),ne=()=>{const T=crypto.randomUUID();u(be=>[...be,{id:T,type:"default",position:{x:140+be.length*40,y:120+be.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},oe=()=>{const T=crypto.randomUUID();u(be=>[...be,{id:T,type:"default",position:{x:180+be.length*40,y:160+be.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},ce=async()=>{W(null);try{const T=c.map(x=>({nodeId:x.id,nodeType:x.data.nodeType,payload:{itemType:x.data.itemType,itemId:x.data.itemId??null,label:x.data.label,infoType:x.data.infoType??null}})),be=ae.map(x=>({edgeId:x.id,fromNodeId:x.source,toNodeId:x.target}));await Tn({libraryId:l,nodes:T,edges:be}),W(t.cogita.library.graph.saveSuccess)}catch{W(t.cogita.library.graph.saveFail)}},_e=T=>{I&&u(be=>be.map(x=>x.id===I.id?{...x,data:{...x.data,itemId:(T==null?void 0:T.infoId)??null,itemType:"collection",infoType:"collection",label:(T==null?void 0:T.label)??t.cogita.library.infoTypes.collection}}:x))},me=T=>{I&&u(be=>be.map(x=>x.id===I.id?{...x,data:{...x.data,itemId:(T==null?void 0:T.infoId)??null,itemType:"info",infoType:(T==null?void 0:T.infoType)??null,label:(T==null?void 0:T.label)??t.cogita.library.infoTypes.any}}:x))};return a.useEffect(()=>{if(!I||I.data.nodeType!=="info"||I.data.infoType!=="citation"||!I.data.itemId){G(null);return}let T=!0;return Gt({libraryId:l,infoId:I.data.itemId}).then(be=>{if(!T)return;const x=be.payload,V=(x==null?void 0:x.text)??"";if(!V){G(null);return}const fe=ia(V),H=Object.values(fe.nodes).sort((F,je)=>F.depth-je.depth||F.start-je.start).map(F=>({id:F.id,text:F.text,depth:F.depth}));G({title:(x==null?void 0:x.title)??I.data.label,fragments:H})}).catch(()=>G(null)),()=>{T=!1}},[l,I]),e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:b,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:ce,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ne,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:oe,children:t.cogita.library.actions.addInfo}),de?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(de.totalCollections))})}):null,p?e.jsx("p",{className:"cogita-help",children:p}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(gs,{nodes:c,edges:ae,onNodesChange:S,onEdgesChange:U,onConnect:$,onNodeClick:(T,be)=>m(be.id),fitView:!0,children:[e.jsx(ms,{gap:18,size:1}),e.jsx(ps,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),I?e.jsxs("div",{className:"cogita-graph-inspector",children:[I.data.nodeType==="collection"?e.jsx(na,{libraryId:l,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:I.data.itemId?{id:I.data.itemId,label:I.data.label,infoType:"collection"}:null,onChange:_e,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(na,{libraryId:l,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:I.data.itemId?{id:I.data.itemId,label:I.data.label,infoType:I.data.infoType??void 0}:null,onChange:me,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),L?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:L.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:L.fragments.map(T=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:T.id}),e.jsx("span",{children:T.text})]},T.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function xs({copy:t,currentCard:s,currentTypeLabel:n,prompt:i,languages:o,answer:g,onAnswerChange:f,computedExpected:y,computedAnswers:E,onComputedAnswerChange:N,answerTemplate:l,outputVariables:b,variableValues:c,computedFieldFeedback:u,feedback:S,canAdvance:ae,quoteContext:Y,quotePlaceholder:U,onCheckAnswer:k,onSkip:m,onLanguageSelect:de,onMarkReviewed:P,onAdvance:p,showCorrectAnswer:W,setShowCorrectAnswer:L,onRevealCorrect:G,answerMask:I,expectedAnswer:$,hasExpectedAnswer:ne,handleComputedKeyDown:oe,answerInputRef:ce,computedInputRefs:_e,scriptMode:me,setScriptMode:T,matchPairs:be,matchLeftOrder:x,matchRightOrder:V,matchSelection:fe,matchActiveLeft:H,matchActiveRight:F,matchFeedback:je,onMatchLeftSelect:Te,onMatchRightSelect:Ne,disableCheckAnswer:ze=!1,hideSkipAction:Ie=!1}){const Ve=a.useMemo(()=>{var _;const ie=!l&&y.length===2?`The {${y[0].key}} is of type {${y[1].key}}`:null,ke=l??ie;if(!ke)return null;const le=new Map(y.map(Q=>[Q.key,Q.expected])),xe=new Set,Be=[],Re=/\{([^}]+)\}/g;let we=0,A,J=null;for(;(A=Re.exec(ke))!==null;){const Q=ke.slice(we,A.index);Q&&Be.push({type:"text",value:Q});const se=((_=A[1])==null?void 0:_.trim())??"",Z=se&&le.has(se)?se:se&&b&&b[se]?b[se]:null;se&&xe.add(se),Z&&xe.add(Z),Z&&le.has(Z)?(Be.push({type:"input",value:Z}),J||(J=Z)):se&&c&&c[se]!==void 0?Be.push({type:"text",value:c[se]}):Be.push({type:"text",value:A[0]}),we=A.index+A[0].length}const Ce=ke.slice(we);return Ce&&Be.push({type:"text",value:Ce}),y.filter(Q=>!xe.has(Q.key)).length>0?null:{parts:Be,expectedByKey:le,firstInputKey:J}},[l,y,b,c]),De=()=>{if(!Ve)return null;const{parts:ie,expectedByKey:ke,firstInputKey:le}=Ve;return e.jsx("div",{className:"cogita-revision-inline-answer",children:ie.map((xe,Be)=>{var Re,we;return xe.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:xe.value},`text-${Be}`):e.jsx("input",{ref:A=>{_e.current[xe.value]=A},autoFocus:xe.value===le,value:E[xe.value]??"",onChange:A=>N(xe.value,A.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":u[xe.value]??(S==="correct"?"correct":S==="incorrect"?"incorrect":void 0),onKeyDown:A=>Je(A)||oe(A),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((Re=E[xe.value])==null?void 0:Re.length)??0,((we=ke.get(xe.value))==null?void 0:we.length)??6)}ch`}},`input-${xe.value}-${Be}`)})})},Le=a.useMemo(()=>{const ie=new Map;return(be??[]).forEach(ke=>ie.set(ke.leftId,ke)),ie},[be]),Ue=a.useMemo(()=>{const ie=new Map;return(be??[]).forEach(ke=>ie.set(ke.rightId,ke)),ie},[be]);a.useEffect(()=>{var Be;if(s.cardType!=="info"||s.infoType!=="computed"||y.length===0)return;const ie=typeof document<"u"?document.activeElement:null;if(ie&&(ie.tagName==="INPUT"||ie.tagName==="TEXTAREA"))return;const ke=(Ve==null?void 0:Ve.firstInputKey)??((Be=y[0])==null?void 0:Be.key);if(!ke)return;const le=_e.current[ke];if(!le)return;const xe=requestAnimationFrame(()=>{le.focus()});return()=>cancelAnimationFrame(xe)},[s,y,Ve]);const et=(()=>{const ie=[$??"",...y.map(xe=>xe.expected??"")].join(""),ke=[g,...Object.values(E)].join(""),le=`${ie}${ke}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(le)})(),Je=ie=>ie.ctrlKey&&(ie.key==="^"||ie.key==="6")?(ie.preventDefault(),T(ke=>ke==="super"?null:"super"),!0):ie.ctrlKey&&(ie.key==="_"||ie.key==="-")?(ie.preventDefault(),T(ke=>ke==="sub"?null:"sub"),!0):!1,ye=()=>{if(!$||!I)return $??"";const ie=$.split(""),ke=Array.from(I),le=ke.length>0?ke.reduce((xe,Be)=>xe+Be,0)/ke.length:127;return ie.map((xe,Be)=>{const Re=ke[Be]??le,we=Math.max(0,Math.min(255,Math.round(Re)));let A=255,J=0;return we<=127?J=Math.round(we/127*255):(J=255,A=Math.round(255*(1-(we-127)/128))),e.jsx("span",{style:{color:`rgb(${A}, ${J}, 0)`},children:xe},`mask-${Be}`)})},ge=s.cardType==="info"&&s.infoType==="citation"?(Y==null?void 0:Y.title)||s.label:s.description;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[n?e.jsx("span",{children:n}):null,e.jsx("strong",{children:ge})]}),s.cardType==="vocab"&&s.checkType==="translation-match"&&be?e.jsxs("div",{className:"cogita-revision-body",children:[i?e.jsx("h2",{children:i}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(x??[]).map(ie=>{const ke=Le.get(ie);if(!ke)return null;const le=(fe==null?void 0:fe[ie])??null,xe=(je==null?void 0:je[ie])??null,Be=H===ie;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":Be,"data-state":xe??void 0,"data-locked":le?"true":void 0,onClick:()=>Te==null?void 0:Te(ie),children:[e.jsx("span",{children:ke.leftLabel}),le&&W?e.jsx("em",{children:"✓"}):null]},ie)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(V??[]).map(ie=>{const ke=Ue.get(ie);if(!ke)return null;const le=Object.values(fe??{}).includes(ie),xe=F===ie;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":le||xe,"data-locked":le?"true":void 0,onClick:()=>Ne==null?void 0:Ne(ie),children:e.jsx("span",{children:ke.rightLabel})},ie)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:k,disabled:s.checkType==="translation-match"||ze,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:m,children:t.cogita.library.revision.skip})]})]}):s.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ce,value:g,onChange:ie=>f(ie.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":S==="correct"?"correct":S==="incorrect"?"incorrect":void 0,onKeyDown:ie=>{if(ie.key==="Enter")if(ie.preventDefault(),ie.stopPropagation(),ae)p();else{if(ze)return;k()}}})]}),et?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":me==="super",onClick:()=>T(ie=>ie==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":me==="sub",onClick:()=>T(ie=>ie==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:k,disabled:ze,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:m,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[s.label?e.jsx("p",{className:"cogita-revision-hint",children:s.label}):null,l?null:e.jsx(Cn,{value:i??"",mode:"auto"}),y.length>0?(()=>{const ie=De();return ie?e.jsx("div",{className:"cogita-inline-answer-wrap",children:ie}):e.jsx("div",{className:"cogita-form-grid",children:y.map((ke,le)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:ke.key}),e.jsx("textarea",{ref:xe=>{_e.current[ke.key]=xe},autoFocus:le===0,value:E[ke.key]??"",onChange:xe=>N(ke.key,xe.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":u[ke.key]??(S==="correct"?"correct":S==="incorrect"?"incorrect":void 0),onKeyDown:xe=>Je(xe)||oe(xe)})]},ke.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:ce,value:g,onChange:ie=>f(ie.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":S==="correct"?"correct":S==="incorrect"?"incorrect":void 0,onKeyDown:ie=>{if(!Je(ie)&&ie.key==="Enter")if(ie.preventDefault(),ie.stopPropagation(),ae)p();else{if(ze)return;k()}}})]})}),et?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":me==="super",onClick:()=>T(ie=>ie==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":me==="sub",onClick:()=>T(ie=>ie==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:k,disabled:ze,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:m,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="citation"&&Y?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(Y.completed)).replace("{total}",String(Y.total))}),e.jsx("p",{className:"cogita-quote-text",children:Y.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ce,value:g,onChange:ie=>f(ie.target.value),placeholder:U??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":S==="correct"?"correct":S==="incorrect"?"incorrect":void 0,onKeyDown:ie=>{if(ie.key==="Enter")if(ie.preventDefault(),ie.stopPropagation(),ae)p();else{if(ze)return;k()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:Y.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:k,disabled:ze,children:t.cogita.library.revision.checkAnswer}),Ie?null:e.jsx("button",{type:"button",className:"ghost",onClick:m,children:t.cogita.library.revision.skip})]})]}):s.cardType==="info"&&s.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:o.length?o.map(ie=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>de(ie.label),children:ie.label},ie.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:m,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:i}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:P,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:m,children:t.cogita.library.revision.skip})]})]}),S&&e.jsx("div",{className:"cogita-revision-feedback","data-state":S,children:S==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),S==="incorrect"&&ne?e.jsxs("div",{className:"cogita-revision-reveal",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>L(ie=>{const ke=!ie;return ke&&G(),ke}),children:t.cogita.library.revision.showAnswer}),W?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),y.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[y.map(ie=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:ie.key}),e.jsx("span",{children:ie.expected})]},ie.key)),$?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:$})]}):null]}):e.jsx("p",{children:I?ye():$})]}):null]}):null,ae?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:p,children:t.cogita.library.revision.nextQuestion})}):null]})}function Ut(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function Ks(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function zs(t){const s=t.checkType??"info";return t.direction?`${s} / ${t.direction}`:s}function Bs(t){return t.trim().replace(/\s+/g," ").toLocaleLowerCase()}function wi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,libraryId:l,infoId:b,selectedReviewerRoleId:c}){const[u,S]=a.useState(b),[ae,Y]=a.useState([]),[U,k]=a.useState([]),[m,de]=a.useState("loading"),[P,p]=a.useState(null),[W,L]=a.useState(null),[G,I]=a.useState(null),[$,ne]=a.useState(null),[oe,ce]=a.useState(""),[_e,me]=a.useState(null),[T,be]=a.useState(1),[x,V]=a.useState(null),[fe,H]=a.useState(!1),[F,je]=a.useState({}),[Te,Ne]=a.useState({}),[ze]=a.useState({}),[Ie,Ve]=a.useState(null),De=a.useRef(null),Le=a.useRef({});a.useEffect(()=>{let Re=!1;return de("loading"),Promise.all([Gt({libraryId:l,infoId:b}).catch(()=>null),Js({libraryId:l,infoId:b}),Xs({libraryId:l,infoId:b})]).then(([we,A,J])=>{if(Re)return;const Ce=(we==null?void 0:we.payload)??{},R=typeof Ce.title=="string"&&Ce.title||typeof Ce.label=="string"&&Ce.label||typeof Ce.name=="string"&&Ce.name||b;S(R),L(Ce),I((we==null?void 0:we.infoType)??null),Y(A.items),k(J.items),de("ready")}).catch(()=>{Re||(L(null),I(null),Y([]),k([]),de("error"))}),()=>{Re=!0}},[l,b]),a.useEffect(()=>{if(G!=="translation"){ne(null);return}Zs({libraryId:l,infoId:b,approachKey:"vocab-card"}).then(Re=>ne(Re.projection??null)).catch(()=>ne(null))},[G,b,l]);const Ue=a.useMemo(()=>{var _;const Re=new Map(ae.map(Q=>[Ut(Q),Q])),we=new Map,A=new Map;for(const Q of ae)we.set(Ut(Q),0),A.set(Ut(Q),[]);for(const Q of U){const se=Ks({parentItemId:Q.parentItemId,parentCheckType:Q.parentCheckType,parentDirection:Q.parentDirection}),Z=[Q.childItemId,Q.childCheckType??"",Q.childDirection??""].join("|");!Re.has(se)||!Re.has(Z)||((_=A.get(se))==null||_.push(Z),we.set(Z,(we.get(Z)??0)+1))}const J=Array.from(we.entries()).filter(([,Q])=>Q===0).map(([Q])=>Q),Ce=new Map;for(const Q of J)Ce.set(Q,0);for(;J.length;){const Q=J.shift(),se=Ce.get(Q)??0;for(const Z of A.get(Q)??[]){const Pe=Math.max(Ce.get(Z)??0,se+1);Ce.set(Z,Pe),we.set(Z,(we.get(Z)??1)-1),(we.get(Z)??0)<=0&&J.push(Z)}}const R=new Map;for(const Q of ae){const se=Ut(Q),Z=Ce.get(se)??0,Pe=R.get(Z)??[];Pe.push(se),R.set(Z,Pe)}return ae.map(Q=>{const se=Ut(Q),Z=Ce.get(se)??0,Pe=R.get(Z)??[se],Fe=Math.max(0,Pe.indexOf(se));return{id:se,position:{x:40+Fe*290+(Z%2?18:0),y:30+Z*120},draggable:!1,selectable:!0,data:{label:Q.label,subtitle:zs(Q),checkType:Q.checkType??"info",direction:Q.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[ae,U]),et=a.useMemo(()=>new Map(ae.map(Re=>[Ut(Re),Re])),[ae]),Je=a.useMemo(()=>{const Re=[];for(const we of U){const A=Ks({parentItemId:we.parentItemId,parentCheckType:we.parentCheckType,parentDirection:we.parentDirection}),J=[we.childItemId,we.childCheckType??"",we.childDirection??""].join("|");!et.has(A)||!et.has(J)||Re.push({id:`${A}->${J}`,source:A,target:J,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return Re},[et,U]),ye=a.useMemo(()=>P?et.get(P)??null:null,[et,P]);a.useEffect(()=>{ce(""),V(null),H(!1),me(null),Ne({})},[P]);const ge=a.useMemo(()=>{var Ce,R;if(!ye)return null;const Re=G??ye.infoType??null,we=ye.checkType??"info",A=ye.direction??null,J=W??{};if(ye.cardType==="vocab"&&$&&Array.isArray($.words)){const _=$.words,Q=((Ce=_[0])==null?void 0:Ce.label)??"?",se=((R=_[1])==null?void 0:R.label)??"?";return A==="a-to-b"?{kind:"vocab",prompt:String(Q),expected:String(se)}:A==="b-to-a"?{kind:"vocab",prompt:String(se),expected:String(Q)}:{kind:"generic",prompt:`${Q} ↔ ${se}`,expected:`${Q} ↔ ${se}`}}if(Re==="citation"&&we==="quote-fragment"&&A&&typeof J.text=="string"){const _=A,Q=ia(J.text),se=Q.nodes[_];if(se){const Z=ys(J.text,se);return{kind:"citation-fragment",expected:se.text,quoteContext:{title:u,before:Z.before,after:Z.after,total:Object.keys(Q.nodes).length,completed:0},quotePlaceholder:se.text.length>0?".".repeat(Math.max(4,Math.min(18,se.text.length))):"..."}}}return{kind:"generic",prompt:ye.description||ye.label,expected:ye.label}},[G,W,ye,u,$]),ie=async Re=>{if(ye&&c)try{await Mn({libraryId:l,outcome:{itemType:"info",itemId:ye.cardId,checkType:ye.checkType??"info",direction:ye.direction??null,revisionType:"direct",evalType:"direct-check",correct:Re,clientId:"cogita-info-checkcards",clientSequence:T,personRoleId:c}}),be(we=>we+1),me(Re?"Saved as correct.":"Saved as incorrect.")}catch{me("Failed to save answer.")}},ke=ye?Ut(ye):null,le=ke?!!F[ke]:!1,xe=async()=>{if(!ye||!ge)return;const Re=Ut(ye);if(F[Re]){me("This card was already checked.");return}const we=ge.expected,A=Bs(oe)===Bs(we);V(A?"correct":"incorrect"),me(c?null:"Answer checked locally (not saved: no person selected)."),je(J=>({...J,[Re]:!0})),c&&await ie(A)},Be=a.useMemo(()=>ye?ye.infoType==="citation"?{...ye,description:u}:{...ye,description:ye.label}:null,[ye,u]);return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.infoTypes.citation}),e.jsx("h2",{className:"cogita-card-title",children:u}),e.jsx("p",{className:"cogita-card-subtitle",children:b})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${ae.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${U.length}`})]})]}),m==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):m==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(gs,{nodes:Ue,edges:Je,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:(Re,we)=>p(we.id),panOnDrag:!0,children:[e.jsx(ms,{}),e.jsx(ps,{showInteractive:!1})]})}),ye?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[ge&&Be?e.jsx(xs,{copy:t,currentCard:Be,currentTypeLabel:"",prompt:ge.kind==="citation-fragment"?null:ge.prompt,languages:[],answer:oe,onAnswerChange:ce,computedExpected:[],computedAnswers:Te,onComputedAnswerChange:(Re,we)=>Ne(A=>({...A,[Re]:we})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:ze,feedback:x,canAdvance:!1,quoteContext:ge.kind==="citation-fragment"?ge.quoteContext:null,quotePlaceholder:ge.kind==="citation-fragment"?ge.quotePlaceholder:null,onCheckAnswer:()=>void xe(),onSkip:()=>p(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:fe,setShowCorrectAnswer:H,onRevealCorrect:()=>{},answerMask:null,expectedAnswer:ge.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:De,computedInputRefs:Le,scriptMode:Ie,setScriptMode:Ve,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:le,hideSkipAction:!0}):null,c?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),_e?e.jsx("p",{className:"cogita-library-hint",children:_e}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:ae.map(Re=>{const we=Ut(Re),A=P===we;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${A?"active":""}`,onClick:()=>p(we),children:[e.jsx("span",{children:Re.label}),e.jsx("small",{children:zs(Re)})]},we)})})]})]})]})})})})})}function ji({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,libraryId:l,collectionId:b}){const{libraryName:c}=Wt(l),[u,S]=a.useState([]),[ae,Y]=a.useState("loading"),[U,k]=a.useState("idle"),m=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),de=`/#/cogita/library/${l}`,P=()=>{Y("loading"),tn({libraryId:l}).then(L=>{S(L),Y("idle")}).catch(()=>{S([]),Y("error")})};a.useEffect(()=>{P()},[l]);const p=async L=>{try{await an({libraryId:l,shareId:L}),P()}catch{P()}},W=async L=>{const G=`${m}/${L}`;try{await navigator.clipboard.writeText(G),k("copied")}catch{k("failed")}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:de,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${de}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[ae==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):ae==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):u.filter(L=>!b||L.collectionId===b).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:u.filter(L=>!b||L.collectionId===b).map(L=>e.jsxs("div",{className:"cogita-share-row","data-state":L.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:L.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(L.createdUtc).toLocaleString(),L.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),L.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${m}/${L.shareCode}`}):null]}),L.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[L.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>W(L.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>p(L.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},L.shareId))}),U==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):U==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function ki({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,libraryId:l}){const{libraryName:b}=Wt(l),[c,u]=a.useState(null),[S,ae]=a.useState(null),[Y,U]=a.useState(null),[k,m]=a.useState(null),[de,P]=a.useState(null),[p,W]=a.useState(null),L=a.useRef(null),G=ne=>{if(!Number.isFinite(ne))return"0 B";if(ne<1024)return`${ne} B`;const oe=ne/1024;if(oe<1024)return`${oe.toFixed(1)} KB`;const ce=oe/1024;return ce<1024?`${ce.toFixed(1)} MB`:`${(ce/1024).toFixed(1)} GB`},I=async()=>{u(null),P({loadedBytes:0,totalBytes:null,percent:null});try{u(t.cogita.library.overview.exporting);const ne=await In(l,P),oe=URL.createObjectURL(ne),ce=document.createElement("a");ce.href=oe,ce.download=`cogita-library-${b||l}.json`,ce.click(),URL.revokeObjectURL(oe),u(t.cogita.library.overview.exportReady)}catch{u(t.cogita.library.overview.exportFail)}finally{P(ne=>ne??{loadedBytes:0,totalBytes:null,percent:null})}},$=async ne=>{var ce;ae(null),U(null),m(null);const oe=(ce=ne.target.files)==null?void 0:ce[0];if(oe)try{ae(t.cogita.library.overview.importing),W({loadedBytes:0,totalBytes:oe.size,percent:0});const _e=await Ln(l,oe,W,me=>{const T=me.stage==="infos"?t.cogita.library.overview.importStageInfos:me.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;m(t.cogita.library.overview.importLiveProgress.replace("{stage}",T).replace("{done}",String(me.processed)).replace("{total}",String(me.total)).replace("{infos}",String(me.infos)).replace("{connections}",String(me.connections)).replace("{collections}",String(me.collections)))});U({infos:_e.infosImported,connections:_e.connectionsImported,collections:_e.collectionsImported}),ae(t.cogita.library.overview.importDone)}catch(_e){const me=_e instanceof $n&&_e.message?` ${_e.message}`:"";ae(`${t.cogita.library.overview.importFail}${me}`)}finally{L.current&&(L.current.value="")}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:b}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:I,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:L,type:"file",accept:"application/json",onChange:$})]})]}),de?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:de.percent??void 0,max:de.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",G(de.loadedBytes)).replace("{total}",de.totalBytes?G(de.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,p?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:p.percent??void 0,max:p.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",G(p.loadedBytes)).replace("{total}",p.totalBytes?G(p.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,c?e.jsx("p",{className:"cogita-help",children:c}):null,S?e.jsx("p",{className:"cogita-help",children:S}):null,k?e.jsx("p",{className:"cogita-help",children:k}):null,Y?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(Y.infos)).replace("{connections}",String(Y.connections)).replace("{collections}",String(Y.collections))}):null]})]})})})]})})}function Ni({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,libraryId:l}){const{libraryName:b}=Wt(l),[c,u]=a.useState(""),[S,ae]=a.useState([]),Y=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:b}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:c,onChange:U=>u(U.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const U=c.trim();U&&(ae(k=>[{id:Y(),name:U},...k]),u(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[S.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,S.map(U=>e.jsx("button",{type:"button",className:"ghost",children:U.name},U.id))]})]})]})})})]})})}function Si({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,libraryId:l}){const{libraryName:b}=Wt(l),[c,u]=a.useState(""),[S,ae]=a.useState([]),Y=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:b}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:c,onChange:U=>u(U.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const U=c.trim();U&&(ae(k=>[{id:Y(),name:U},...k]),u(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[S.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,S.map(U=>e.jsx("button",{type:"button",className:"ghost",children:U.name},U.id))]})]})]})})})]})})}function Ds({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,libraryId:l}){const{libraryName:b}=Wt(l),c=`/#/cogita/library/${l}`,[u,S]=a.useState(""),[ae,Y]=a.useState([]),[U,k]=a.useState("idle"),[m,de]=a.useState(0),[P,p]=a.useState(null);a.useEffect(()=>{k("loading");const L=window.setTimeout(()=>{ja({libraryId:l,query:u.trim()||void 0,limit:30}).then(G=>{Y(G.items),de(G.total),p(G.nextCursor??null),k("ready")}).catch(()=>{Y([]),de(0),p(null),k("ready")})},240);return()=>window.clearTimeout(L)},[l,u]);const W=async()=>{if(P){k("loading");try{const L=await ja({libraryId:l,query:u.trim()||void 0,limit:30,cursor:P});Y(G=>[...G,...L.items]),p(L.nextCursor??null),de(L.total),k("ready")}catch{k("ready")}}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:b}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:c,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${c}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:u,onChange:L=>S(L.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(ae.length)).replace("{total}",String(m||ae.length))}),e.jsx("span",{children:U==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:ae.length?ae.map(L=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${c}/collections/${L.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:L.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(L.itemCount))," ·"," ",L.notes||t.cogita.library.collections.noNotes]})]})},L.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${c}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),P?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:W,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const he=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,Vt=(t,s,n,i)=>`${t}:${s}:${n??""}:${i??""}`;function Ti({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,libraryId:l,collectionId:b}){Wt(l);const c=`/#/cogita/library/${l}`,[u,S]=a.useState(t.cogita.library.collections.defaultName),[ae,Y]=a.useState(null),[U,k]=a.useState(0),[m,de]=a.useState([]),[P,p]=a.useState("idle"),[W,L]=a.useState(null),G=a.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(m.length)).replace("{total}",String(U||m.length)),[t,m.length,U]);a.useEffect(()=>{Oa(l,b).then($=>{S($.name),Y($.notes??null),k($.itemCount)}).catch(()=>{S(t.cogita.library.collections.defaultName),Y(null)})},[l,b]),a.useEffect(()=>{p("loading"),Ra({libraryId:l,collectionId:b,limit:40}).then($=>{de($.items),L($.nextCursor??null),k($.total),p("ready")}).catch(()=>{de([]),L(null),p("ready")})},[l,b]);const I=async()=>{if(W){p("loading");try{const $=await Ra({libraryId:l,collectionId:b,limit:40,cursor:W});de(ne=>[...ne,...$.items]),L($.nextCursor??null),k($.total),p("ready")}catch{p("ready")}}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:u}),e.jsx("p",{className:"cogita-library-subtitle",children:ae||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:c,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${c}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${c}/collections/${b}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${c}/collections/${b}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:G}),e.jsx("span",{children:P==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:m.length?m.map($=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:$.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:$.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:$.label}),e.jsx("p",{className:"cogita-card-subtitle",children:$.description})]})},he($))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),W?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:I,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${c}/collections/${b}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const Ot=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const s=t.length,n=t.filter(g=>g.correct).length,i=qa(vs(t));return{score:Math.round(Math.max(0,Math.min(100,i.knowness*100))*100)/100,total:s,correct:n,lastReviewedUtc:i.lastReviewedUtc??null}},Ci=t=>{if(t.maskBase64)try{const s=Rn(t.maskBase64);if(!s.length)return t.correct?1:0;const n=s.reduce((i,o)=>i+o,0);return Math.max(0,Math.min(1,n/s.length/255))}catch{return t.correct?1:0}return t.correct?1:0},vs=t=>t.map(s=>({correctness:Ci(s),createdUtc:s.createdUtc})),qa=(t,s=Date.now())=>{var U;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const i=t.slice().sort((k,m)=>k.createdUtc.localeCompare(m.createdUtc)).slice(-5),o=i.reduce((k,m)=>k+m.correctness,0)/i.length,g=5,f=2,y=.15;let E=0,N=0;for(let k=0;k<i.length;k+=1){const m=new Date(i[k].createdUtc).getTime(),de=k===i.length-1?s:new Date(i[k+1].createdUtc).getTime(),P=Math.max(0,(de-m)/(1e3*60)),p=1-Math.exp(-P/g);E+=p,i[k].correctness>.5&&(N+=y)}let l=o*E*f+N;const b=((U=i[i.length-1])==null?void 0:U.createdUtc)??null,c=b?Math.max(0,(s-new Date(b).getTime())/(1e3*60)):0,S=1/(1+Math.log1p(c/60));return l*=S,i.length===1&&i[0].correctness>.5&&(l+=5.44*Math.exp(-c/2)),{knowness:l,avgCorrectness:o,lastReviewedUtc:b}},ka=t=>{const s=t.slice();for(let n=s.length-1;n>0;n-=1){const i=Math.floor(Math.random()*(n+1));[s[n],s[i]]=[s[i],s[n]]}return s},$a=t=>t[Math.floor(Math.random()*t.length)],Mi=(t,s)=>{const n=new Map;return t.forEach(i=>n.set(i,Math.random())),t.sort((i,o)=>{const g=s(i)-s(o);return g!==0?g:(n.get(i)??0)-(n.get(o)??0)})},Ua=(t,s,n,i,o)=>{if(!t.length)return null;const g=t.filter(y=>!(o!=null&&o.has(he(y))));if(g.length===0)return null;const f=g.filter(y=>he(y)!==n);return $a(f.length?f:g)},Ii=(t,s,n,i,o)=>{if(!t.length)return null;let g=Number.POSITIVE_INFINITY;for(const N of t){const l=he(N);if(n.has(l))continue;const b=s[l]??1;b<g&&(g=b)}if(!Number.isFinite(g))return null;const f=t.filter(N=>{const l=he(N);return!n.has(l)&&(s[l]??1)===g}),y=f.filter(N=>!o||he(N)!==o),E=i?y.filter(N=>!i.has(he(N))):y;return E.length>0?$a(E):y.length>0?$a(y):o&&f.some(N=>he(N)===o)?f.find(N=>he(N)===o)??null:f.length?$a(f):null},on=(t,s,n,i,o)=>{const g=[],f=t.filter(E=>!o.has(he(E))&&!n.has(he(E))&&(s[he(E)]??0)<1),y=Mi(f,E=>s[he(E)]??0);for(const E of y){if(g.length>=i)break;g.push(E),o.add(he(E))}if(g.length<i){const E=ka(t.filter(N=>!o.has(he(N))&&n.has(he(N))));for(const N of E){if(g.length>=i)break;g.push(N),o.add(he(N))}}return g},Li=(t,s,n,i)=>on(t,s,n,i,new Set),ws=(t,s,n,i,o,g)=>{const f=Math.max(1,n.stackSize??s),E=ka(t).filter((S,ae,Y)=>Y.findIndex(U=>he(U)===he(S))===ae),N=Li(E,i,o,f),l=new Set,b=new Set,c=Ua(N,{},null,l,b),u=c?[c]:[];return c&&b.add(he(c)),{queue:u,meta:{pool:E,active:N,knownessMap:i,unknownSet:o,outcomesById:g,asked:l,queued:b}}},us={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,s)=>{const i=ka(t).filter((o,g,f)=>f.findIndex(y=>he(y)===he(o))===g);return{queue:i.slice(0,Math.min(s,i.length)),meta:{}}},applyOutcome:t=>t},js=(t,s,n,i)=>{const o=Math.max(1,n.stackSize??s),f=ka(t).filter((ae,Y,U)=>U.findIndex(k=>he(k)===he(ae))===Y),y={},E=new Set,N=new Set,l=new Set,b=Math.max(1,n.levels??1);f.forEach(ae=>{const Y=he(ae),U=i==null?void 0:i[Y],k=typeof U=="number"&&Number.isFinite(U)?U:1;y[Y]=Math.min(b,Math.max(1,Math.round(k)))});const c=[];if(f.length>0){const ae=new Map;f.forEach(U=>{var m;const k=y[he(U)]??1;ae.has(k)||ae.set(k,[]),(m=ae.get(k))==null||m.push(U)});const Y=Array.from(ae.keys()).sort((U,k)=>U-k);for(const U of Y){if(c.length>=o)break;const k=ka(ae.get(U)??[]);for(const m of k){if(c.length>=o)break;c.push(m)}}}const u=Ua(c,y,null,E,N),S=u?[u]:[];return u&&N.add(he(u)),{queue:S,meta:{pool:f,active:c,levelMap:y,asked:E,queued:N,wrongSinceCorrect:l}}},$i={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,s)=>Math.max(1,s.stackSize??t),getProgressTotal:()=>null,prepare:(t,s,n)=>js(t,s,n),applyOutcome:(t,s,n,i,o)=>{if(!s)return t;const g=Math.max(1,i.levels??1),f=t.meta.pool??[],y=t.meta.active??[],E={...t.meta.levelMap??{}},N=new Set(t.meta.asked??[]),l=new Set(t.meta.queued??[]),b=new Set(t.meta.wrongSinceCorrect??[]),c=he(s);l.delete(c),N.add(c);const u=E[c]??1;o.correct?(E[c]=b.has(c)?1:Math.min(u+1,g),b.delete(c)):(E[c]=1,b.add(c));const S=o.correct?y.filter(U=>he(U)!==c):y.slice();if(o.correct&&S.length<Math.max(1,i.stackSize??1)){const U=new Set(S.map(m=>he(m))),k=Ii(f,E,U,N,c);k&&S.push(k)}const ae=t.queue.slice(),Y=Ua(S,E,c,N,l);return Y&&(ae.push(Y),l.add(he(Y))),{queue:ae,meta:{pool:f,active:S,levelMap:E,asked:N,queued:l,wrongSinceCorrect:b}}}},Ri={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,s)=>Math.max(1,s.stackSize??t),getProgressTotal:()=>null,prepare:(t,s,n)=>ws(t,s,n,{},new Set,{}),applyOutcome:(t,s,n,i,o)=>{if(!s)return t;const g=t.meta.pool??[],f=t.meta.active??[],y={...t.meta.knownessMap??{}},E=new Set(t.meta.unknownSet??[]),N={...t.meta.outcomesById??{}},l=new Set(t.meta.asked??[]),b=new Set(t.meta.queued??[]),c=he(s);b.delete(c),l.add(c);const u={correctness:Math.max(0,Math.min(1,o.correctness??(o.correct?1:0))),createdUtc:o.createdUtc??new Date().toISOString()},ae=(N[c]??[]).concat(u).sort((P,p)=>P.createdUtc.localeCompare(p.createdUtc)).slice(-5);N[c]=ae,E.delete(c);const Y=Date.now();g.forEach(P=>{const p=he(P),W=N[p]??[];if(W.length===0){y[p]=0,E.add(p);return}const L=qa(W,Y);y[p]=L.knowness});const U=f.slice();if((y[c]??0)>=1){const P=U.filter(p=>he(p)!==c);U.length=0,U.push(...P)}const m=Math.max(1,i.stackSize??n);if(U.length<m){const P=new Set(U.map(W=>he(W))),p=on(g,y,E,m-U.length,P);U.push(...p)}const de=t.queue.slice();if(de.length===0||he(de[de.length-1])===c){const P=Ua(U,{},c,l,b);P&&(de.push(P),b.add(he(P)))}return{queue:de,meta:{pool:g,active:U,knownessMap:y,unknownSet:E,outcomesById:N,asked:l,queued:b}}}},cn={random:us,levels:$i,temporal:Ri},Ei=Object.values(cn),ks=t=>{if(!t)return us;const s=t.trim().toLowerCase();return s==="random"||s==="levels"||s==="temporal"?cn[s]:us},Wa=(t,s)=>{const n={...t.defaultSettings};return s&&Object.entries(s).forEach(([i,o])=>{typeof o=="number"&&Number.isFinite(o)&&(n[i]=o),typeof o=="string"&&(n[i]=o)}),t.settingsFields.forEach(i=>{var g;const o=n[i.key];if(i.type==="number"){if(typeof o!="number"||Number.isNaN(o)){n[i.key]=t.defaultSettings[i.key]??0;return}i.min!==void 0&&(n[i.key]=Math.max(i.min,n[i.key])),i.max!==void 0&&(n[i.key]=Math.min(i.max,n[i.key]));return}if(i.type==="select"){const f=((g=i.options)==null?void 0:g.map(y=>y.value))??[];(typeof o!="string"||f.length>0&&!f.includes(o))&&(n[i.key]=t.defaultSettings[i.key]??f[0]??"")}}),n},ln=(t,s)=>{const n={};return t.settingsFields.forEach(i=>{const o=s.get(i.key);if(o){if(i.type==="number"){const g=Number(o);Number.isNaN(g)||(n[i.key]=g);return}n[i.key]=o}}),Wa(t,n)},Ai=(t,s)=>{const n=new URLSearchParams;return t.settingsFields.forEach(i=>{const o=s[i.key];(typeof o=="number"||typeof o=="string")&&n.set(i.key,String(o))}),n};function Pi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,libraryId:l,collectionId:b,revisionId:c}){const{libraryName:u}=Wt(l),S=`/#/cogita/library/${l}`,[ae,Y]=a.useState(t.cogita.library.collections.defaultName),[U,k]=a.useState(""),[m,de]=a.useState(20),[P,p]=a.useState("random"),[W,L]=a.useState({}),[G,I]=a.useState("exact"),[$,ne]=a.useState([]),[oe,ce]=a.useState(null),[_e,me]=a.useState([]),[T,be]=a.useState("idle"),[x,V]=a.useState(null),[fe,H]=a.useState("idle"),[F,je]=a.useState("idle"),[Te,Ne]=a.useState("idle"),ze=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),Ie=a.useMemo(()=>ks(P),[P]),Ve=a.useMemo(()=>Wa(Ie,W),[Ie,W]),De=a.useMemo(()=>Ai(Ie,Ve).toString(),[Ie,Ve]);a.useEffect(()=>{Oa(l,b).then(ge=>Y(ge.name)).catch(()=>Y(t.cogita.library.collections.defaultName))},[l,b]),a.useEffect(()=>{c&&En({libraryId:l,collectionId:b,revisionId:c}).then(ge=>{k(ge.name),p(ge.mode||"random"),I(ge.check||"exact"),de(ge.limit||20),L(ge.revisionSettings??{})}).catch(()=>{k("")})},[b,l,c]),a.useEffect(()=>{sn({libraryId:l}).then(ge=>{ne(ge),!oe&&ge.length>0&&ce(ge[0].roleId)}).catch(()=>{ne([])})},[l]);const Le=()=>{je("loading"),tn({libraryId:l}).then(ge=>{me(ge),je("idle")}).catch(()=>{me([]),je("error")})};a.useEffect(()=>{Le()},[l]);const Ue=async()=>{be("working"),H("idle");try{const ge=await Pn({libraryId:l,collectionId:b,revisionType:Ie.id,revisionSettings:Ve,mode:P,check:G,limit:m});V(`${ze}/${ge.shareCode}${De?`?${De}`:""}`),be("ready"),Le()}catch{be("error")}},et=async()=>{if(c){Ne("saving");try{await An({libraryId:l,collectionId:b,revisionId:c,name:U||ae,revisionType:Ie.id,revisionSettings:Ve,mode:P,check:G,limit:m}),Ne("saved")}catch{Ne("error")}}},Je=async()=>{if(x)try{await navigator.clipboard.writeText(x),H("copied")}catch{H("failed")}},ye=async ge=>{try{await an({libraryId:l,shareId:ge}),Le()}catch{Le()}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:ae}),e.jsx("p",{className:"cogita-library-subtitle",children:u})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:S,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${S}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${S}/collections/${b}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${S}/collections/${b}/revision/run?mode=${encodeURIComponent(P)}&check=${encodeURIComponent(G)}&limit=${m}${De?`&${De}`:""}${oe?`&reviewer=${encodeURIComponent(oe)}`:""}${c?`&revisionId=${encodeURIComponent(c)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:U,onChange:ge=>k(ge.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:P,onChange:ge=>p(ge.target.value),children:Ei.map(ge=>e.jsx("option",{value:ge.id,children:t.cogita.library.revision[ge.labelKey]},ge.id))})]}),Ie.settingsFields.map(ge=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[ge.labelKey]}),ge.type==="select"?e.jsx("select",{value:String(Ve[ge.key]??""),onChange:ie=>L(ke=>({...ke,[ge.key]:ie.target.value})),children:(ge.options??[]).map(ie=>e.jsx("option",{value:ie.value,children:t.cogita.library.revision[ie.labelKey]},ie.value))}):e.jsx("input",{type:"number",min:ge.min,max:ge.max,step:ge.step,value:Ve[ge.key]??0,onChange:ie=>L(ke=>({...ke,[ge.key]:Number(ie.target.value||0)}))})]},ge.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),Ie.id!=="levels"&&Ie.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:m,onChange:ge=>de(Number(ge.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:oe??"",onChange:ge=>ce(ge.target.value||null),children:$.map(ge=>e.jsx("option",{value:ge.roleId,children:ge.label},ge.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[c?e.jsx("button",{type:"button",className:"cta ghost",onClick:et,disabled:Te==="saving",children:Te==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${S}/collections/${b}/revision/run?mode=${encodeURIComponent(P)}&check=${encodeURIComponent(G)}&limit=${m}${De?`&${De}`:""}${oe?`&reviewer=${encodeURIComponent(oe)}`:""}${c?`&revisionId=${encodeURIComponent(c)}`:""}`,children:t.cogita.library.actions.startRevision})]}),Te==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),x?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:x,readOnly:!0})]}):null,T==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,fe==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):fe==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:Ue,disabled:T==="working",children:T==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),x?e.jsx("button",{type:"button",className:"cta ghost",onClick:Je,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),F==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):_e.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:_e.map(ge=>e.jsxs("div",{className:"cogita-share-row","data-state":ge.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:ge.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(ge.createdUtc).toLocaleString(),ge.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),ge.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>ye(ge.shareId),children:t.cogita.library.revision.shareRevokeAction})]},ge.shareId))})]})]})]})]})})})]})})}const ss=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function dn(t,s,n){if(!t)return null;const i=new Map(t.nodes.map(P=>[P.id,P])),o=new Map,g=new Set,f=P=>{if(typeof P=="number")return P;if(typeof P=="string"){const p=Number(P);return Number.isFinite(p)?p:0}return 0},y=P=>{if(o.has(P))return o.get(P);if(g.has(P))return 0;const p=i.get(P);if(!p)return 0;g.add(P);const W=G=>{var $,ne;return(G?(($=p.inputsByHandle)==null?void 0:$[G])??[]:p.inputs??((ne=p.inputsByHandle)==null?void 0:ne.in)??[]).map(oe=>y(oe))};let L=0;switch(p.type){case"input.random":{const G=p.min??0,I=p.max??G+10,$=Math.min(G,I),ne=Math.max(G,I);L=Math.floor(Math.random()*(ne-$+1))+$;break}case"input.const":{L=p.value??0;break}case"input.list":{const G=(p.list??[]).filter(Boolean),I=Math.round(f(W("index")[0]));L=G.length?G[Math.max(0,Math.min(G.length-1,I))]:String(I);break}case"compute.add":{L=W("in").map(I=>f(I)).reduce((I,$)=>I+$,0);break}case"compute.sub":{const G=W("add").map($=>f($)),I=W("sub").map($=>f($));L=G.reduce(($,ne)=>$+ne,0)-I.reduce(($,ne)=>$+ne,0);break}case"compute.mul":{const G=W("in").map(I=>f(I));L=G.length?G.reduce((I,$)=>I*$,1):0;break}case"compute.div":{const G=f(W("num")[0]),I=W("den").map($=>f($)).reduce(($,ne)=>$+ne,0);L=Math.abs(I)<Number.EPSILON?0:G/I;break}case"compute.pow":{const G=f(W("base")[0]),I=f(W("exp")[0]);L=Math.pow(G,I);break}case"compute.exp":{const G=f(W("base")[0]),I=f(W("exp")[0]);L=Math.pow(G,I);break}case"compute.log":{const G=f(W("value")[0]),I=f(W("base")[0]),$=Math.max(G,Number.EPSILON);L=Math.abs(I)<Number.EPSILON?Math.log($):Math.log($)/Math.log(I);break}case"compute.abs":{L=Math.abs(f(W("in")[0]));break}case"compute.min":{const G=W("in").map(I=>f(I));L=G.length?Math.min(...G):0;break}case"compute.max":{const G=W("in").map(I=>f(I));L=G.length?Math.max(...G):0;break}case"compute.floor":{L=Math.floor(f(W("in")[0]));break}case"compute.ceil":{L=Math.ceil(f(W("in")[0]));break}case"compute.round":{L=Math.round(f(W("in")[0]));break}case"compute.mod":{const G=f(W("a")[0]),I=f(W("b")[0]);L=Math.abs(I)<Number.EPSILON?0:G%I;break}case"compute.concat":{const I=["in1","in2","in3","in4","in5","in6"].flatMap(ce=>W(ce)),$=I.length?I:W("in");L=($.length?$:W()).map(ce=>ce==null?"":String(ce)).join("");break}case"compute.trim":{const G=W("text")[0]??W("in")[0]??"",I=G==null?"":String(G),$=Math.max(0,Math.round(f(W("start")[0]))),ne=Math.max(0,Math.round(f(W("end")[0])));$+ne>=I.length?L="":L=I.substring($,I.length-ne);break}case"output":{L=W("in")[0]??0;break}default:L=0}return g.delete(P),o.set(P,L),L},E=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(P=>P.type==="output").map(P=>P.id);t.nodes.forEach(P=>y(P.id)),E.forEach(P=>y(P));const N=P=>Math.abs(P%1)<1e-5?String(Math.round(P)):P.toFixed(3).replace(/\.?0+$/,""),l=P=>typeof P=="number"?N(P):P??"",b=new Map;E.forEach(P=>{var I,$,ne,oe;const p=i.get(P);if(!p)return;const W=($=(I=p.inputsByHandle)==null?void 0:I.name)==null?void 0:$[0],L=W?l(o.get(W)):"",G=(L==null?void 0:L.toString().trim())||((ne=p.outputLabel)==null?void 0:ne.trim())||((oe=p.name)==null?void 0:oe.trim())||P;b.set(P,G)});const c={},u={},S={};E.forEach(P=>{var L,G;const p=i.get(P);if(!p)return;const W=b.get(P)??(((L=p.outputLabel)==null?void 0:L.trim())||((G=p.name)==null?void 0:G.trim())||P);c[W]=l(o.get(P)),p.name&&(u[p.name.trim()]=W),u[P]=W});const ae=(P,p)=>{let W=P;return t.nodes.forEach(L=>{var oe,ce;const G=l(o.get(L.id)),I=E.includes(L.id),$=I?b.get(L.id)??((oe=L.outputLabel)==null?void 0:oe.trim())??((ce=L.name)==null?void 0:ce.trim())??L.id:"",ne=I&&p?$:G;W=W.replace(new RegExp(`\\{\\s*${ss(L.id)}\\s*\\}`,"gi"),ne),L.name&&(W=W.replace(new RegExp(`\\{\\s*${ss(L.name)}\\s*\\}`,"gi"),ne)),I&&L.outputLabel&&(W=W.replace(new RegExp(`\\{\\s*${ss(L.outputLabel)}\\s*\\}`,"gi"),$))}),W},Y=s;let U=Y.trim().length>0?Y:"";U||(U=E.length?`Compute ${E.join(", ")}`:"Compute"),U=ae(U,!0);const k=(n==null?void 0:n.trim())??"",m=k?ae(k,!1):"",de={};return o.forEach((P,p)=>{de[p]=P,S[p]=l(P);const W=i.get(p);W!=null&&W.name&&(S[W.name.trim()]=l(P))}),{prompt:U,answers:c,values:de,answerText:m,outputVariables:u,variableValues:S}}function un(t){var n;const s=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((n=s[0])==null?void 0:n[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const ns=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function hn({outcomes:t}){const[s,n]=a.useState("day"),i=a.useMemo(()=>{const o=ns.find(y=>y.id===s)??ns[1],g=Date.now()-o.ms,f=t.filter(y=>new Date(y.createdUtc).getTime()>=g);return Ot(f)},[t,s]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:ns.map(o=>e.jsx("button",{type:"button",className:"ghost","data-active":s===o.id,onClick:()=>n(o.id),children:o.label},o.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[i.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[i.correct," / ",i.total]})]})}const Fi="cogita-revision",Ki=1,Pa="outcomes",zi=()=>new Promise((t,s)=>{const n=indexedDB.open(Fi,Ki);n.onupgradeneeded=()=>{const i=n.result;if(!i.objectStoreNames.contains(Pa)){const o=i.createObjectStore(Pa,{keyPath:"id"});o.createIndex("byItem","itemKey",{unique:!1}),o.createIndex("byPending","pending",{unique:!1})}},n.onerror=()=>s(n.error),n.onsuccess=()=>t(n.result)}),Sa=async(t,s)=>{const n=await zi();return new Promise((i,o)=>{const g=n.transaction(Pa,t),f=g.objectStore(Pa);s(f).then(i).catch(o),g.onerror=()=>o(g.error)})},gn=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const s=Array.from(t).map(n=>n.toString(16).padStart(2,"0"));return`${s.slice(0,4).join("")}-${s.slice(4,6).join("")}-${s.slice(6,8).join("")}-${s.slice(8,10).join("")}-${s.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},Bi=()=>{const t="cogita_revision_client_id",s=localStorage.getItem(t);if(s)return s;const n=gn();return localStorage.setItem(t,n),n},Di=()=>{const t="cogita_revision_client_seq",s=Number(localStorage.getItem(t)??"0"),n=Number.isFinite(s)?s+1:1;return localStorage.setItem(t,String(n)),n},mn=(t,s,n,i)=>Vt(t,s,n,i),Fa=async t=>{const s=Bi(),n=Di(),i=new Date().toISOString(),o={...t,clientId:s,clientSequence:n,createdUtc:i,id:gn(),pending:!0};return await Sa("readwrite",g=>new Promise((f,y)=>{const E={...o,itemKey:mn(o.itemType,o.itemId,o.checkType,o.direction)},N=g.add(E);N.onsuccess=()=>f(),N.onerror=()=>y(N.error)})),o},Ka=async(t,s,n,i)=>{if(!s)return[];try{const o=mn(t,s,n,i);return await Sa("readonly",g=>new Promise((f,y)=>{const N=g.index("byItem").getAll(o);N.onsuccess=()=>{const b=(N.result??[]).map(c=>({itemType:c.itemType,itemId:c.itemId,checkType:c.checkType??null,direction:c.direction??null,revisionType:c.revisionType,evalType:c.evalType,correct:c.correct,createdUtc:c.createdUtc,maskBase64:c.maskBase64,payloadBase64:c.payloadBase64,payloadHashBase64:c.payloadHashBase64,clientId:c.clientId,clientSequence:c.clientSequence,personRoleId:c.personRoleId??null})).sort((c,u)=>c.createdUtc.localeCompare(u.createdUtc));f(b)},N.onerror=()=>y(N.error)}))}catch{return[]}},qt=async()=>{try{return await Sa("readonly",t=>new Promise((s,n)=>{const i=t.getAll();i.onsuccess=()=>{const g=(i.result??[]).map(f=>({itemType:f.itemType,itemId:f.itemId,checkType:f.checkType??null,direction:f.direction??null,revisionType:f.revisionType,evalType:f.evalType,correct:f.correct,createdUtc:f.createdUtc,maskBase64:f.maskBase64,payloadBase64:f.payloadBase64,payloadHashBase64:f.payloadHashBase64,clientId:f.clientId,clientSequence:f.clientSequence,personRoleId:f.personRoleId??null}));s(g)},i.onerror=()=>n(i.error)}))}catch{return[]}},_i=async(t=100)=>{try{return await Sa("readonly",s=>new Promise((n,i)=>{const g=s.index("byPending").getAll(!0);g.onsuccess=()=>{const f=g.result??[];n(f.slice(0,t))},g.onerror=()=>i(g.error)}))}catch{return[]}},Vi=async t=>{if(t.length!==0)try{await Sa("readwrite",s=>new Promise((n,i)=>{let o=t.length;t.forEach(g=>{const f=s.get(g);f.onsuccess=()=>{const y=f.result;if(y){y.pending=!1;const E=s.put(y);E.onsuccess=()=>{o-=1,o===0&&n()},E.onerror=()=>i(E.error)}else o-=1,o===0&&n()},f.onerror=()=>i(f.error)})}))}catch{}},is=async(t,s)=>{const n=await _i(200);if(n.length===0)return;const i=new Map;n.forEach(o=>{var f;const g=o.personRoleId??s??"";i.has(g)||i.set(g,[]),(f=i.get(g))==null||f.push(o)});for(const[o,g]of i.entries()){const f=g.map(y=>({itemType:y.itemType,itemId:y.itemId,checkType:y.checkType??null,direction:y.direction??null,revisionType:y.revisionType,evalType:y.evalType,correct:y.correct,clientId:y.clientId,clientSequence:y.clientSequence,maskBase64:y.maskBase64??null,payloadHashBase64:y.payloadHashBase64??null,payloadBase64:y.payloadBase64??null,personRoleId:o||null}));try{await Fn({libraryId:t,outcomes:f}),await Vi(g.map(y=>y.id))}catch{}}},_s={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},Oi=(t,s)=>{const n=Math.max(t.length,s.length,1),i=Math.abs(t.length-s.length);return Math.max(0,1-i/n)},qi=(t,s)=>{const n=new Uint8Array(t.length),i=Oi(t,s);for(let o=0;o<t.length;o+=1){const g=t[o]===(s[o]??"")?128:0,f=t.length-1-o,y=s.length-1-o,E=t[f]===(s[y]??"")?127:0,N=Math.round((g+E)*i);n[o]=Math.max(0,Math.min(255,N))}return n},La=(t,s)=>t===s||(_s[t]??[]).includes(s)?!0:(_s[s]??[]).includes(t),za=(t,s)=>{const n=new Uint8Array(t.length);if(!t.length)return n;const i=[];for(let g=0;g<=t.length-3;g+=1)i.push({index:g,text:t.slice(g,g+3)});let o=!1;return i.forEach(g=>{for(let f=0;f<=s.length-3;f+=1){const y=s.slice(f,f+3);let E=0;for(let u=0;u<3;u+=1)La(g.text[u],y[u])&&(E+=1);if(E<2)continue;let N=g.index-1,l=f-1;for(;N>=0&&l>=0;){const u=t[N],S=s[l];if(u===S){n[N]=Math.max(n[N],255),N-=1,l-=1,o=!0;continue}if(La(u,S)){n[N]=Math.max(n[N],127),N-=1,l-=1,o=!0;continue}if(N>0&&t[N-1]===S){n[N]=Math.max(n[N],0),N-=1,o=!0;continue}if(l>0&&t[N]===s[l-1]){l-=1,o=!0;continue}break}for(let u=0;u<3;u+=1){const S=g.index+u,ae=g.text[u],Y=y[u],U=ae===Y?255:La(ae,Y)?127:0;n[S]=Math.max(n[S],U),o=!0}let b=g.index+3,c=f+3;for(;b<t.length&&c<s.length;){const u=t[b],S=s[c];if(u===S){n[b]=Math.max(n[b],255),b+=1,c+=1,o=!0;continue}if(La(u,S)){n[b]=Math.max(n[b],127),b+=1,c+=1,o=!0;continue}if(b+1<t.length&&t[b+1]===S){n[b]=Math.max(n[b],0),b+=1,o=!0;continue}if(c+1<s.length&&t[b]===s[c+1]){c+=1,o=!0;continue}break}}}),o?n:qi(t,s)},pa=(t,s,n)=>{const i=t.trim().toLowerCase(),o=s.trim().toLowerCase();return za(i,o)},fa=t=>t.trim().toLowerCase().replace(/[^\p{L}\p{N}]+/gu,""),pn=(t,s,n)=>{const i=fa(t),o=fa(s);return za(i,o)},St=t=>t.trim().toLowerCase(),Ui=t=>t==="reverse"?"reverse":"forward",Na=(t,s)=>`${t}|${s}`,It=t=>{if(!t)return null;const[s,n]=t.split("|",2);return(s==="forward"||s==="reverse")&&n?{mode:s,fragmentId:n}:{mode:"forward",fragmentId:t}},Ba=(t,s)=>{var i;const n=It(s);return n?n.fragmentId&&s?(t??null)===s:(((i=It(t))==null?void 0:i.mode)??"forward")===n.mode:!0},mt=t=>{const s=t==null?void 0:t.trim().toLowerCase();return s||null},fn=(t,s)=>{if((mt(t.childItemType)??"info")!==(s.cardType??"").toLowerCase()||t.childItemId!==s.cardId)return!1;const i=mt(t.childCheckType),o=mt(t.childDirection),g=mt(s.checkType),f=mt(s.direction);return!(i&&i!==g||o&&o!==f)},Wi={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},Hi={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},Da=(t,s,n)=>{if(!n||!s.startsWith(t))return s;const i=s.slice(t.length);if(!i)return s;const o=n==="super"?Wi:Hi,g=i.split("").map(f=>o[f]??f).join("");return t+g},_a=(t,s,n)=>{var f,y,E;if(!t)return((f=s[0])==null?void 0:f.key)??null;const i=new Set(s.map(N=>N.key)),o=/\{([^}]+)\}/g;let g;for(;(g=o.exec(t))!==null;){const N=((y=g[1])==null?void 0:y.trim())??"";if(!N)continue;if(i.has(N))return N;const l=n==null?void 0:n[N];if(l&&i.has(l))return l}return((E=s[0])==null?void 0:E.key)??null},hs=t=>t.flatMap(s=>{if(s.cardType!=="info"||s.infoType!=="citation")return[s];const n=s.description??"";if(!n.trim())return[s];const i=It(s.direction),o=(i==null?void 0:i.mode)??Ui(s.direction),g=ia(n),f=Object.keys(g.nodes);return f.length===0?[s]:f.map(y=>({...s,checkType:"quote-fragment",direction:Na(o,y)}))});function Qi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,libraryId:l,collectionId:b,revisionId:c}){const u=Va(),S=`/#/cogita/library/${l}`,ae=a.useMemo(()=>new URLSearchParams(u.search),[u.search]),Y=Math.max(1,Number(ae.get("limit")??20)),U=ae.get("mode")??"random",k=a.useMemo(()=>ks(U),[U]),m=a.useMemo(()=>Wa(k,ln(k,ae)),[k,ae]),de=ae.get("check")??"exact",P=ae.get("reviewer"),p=a.useMemo(()=>t.cogita.library.revision[k.labelKey]??U,[t,U,k]),W=a.useMemo(()=>de==="exact"?t.cogita.library.revision.checkValue:de,[t,de]),[L,G]=a.useState(t.cogita.library.collections.defaultName),[I,$]=a.useState([]),[ne,oe]=a.useState([]),[ce,_e]=a.useState("idle"),[me,T]=a.useState({current:0,total:0}),[be,x]=a.useState(0),[V,fe]=a.useState(""),[H,F]=a.useState(null),[je,Te]=a.useState(null),[Ne,ze]=a.useState(null),[Ie,Ve]=a.useState(null),[De,Le]=a.useState([]),[Ue,et]=a.useState({}),[Je,ye]=a.useState({}),[ge,ie]=a.useState(null),[ke,le]=a.useState(null),[xe,Be]=a.useState(null),[Re,we]=a.useState(null),[A,J]=a.useState(null),[Ce,R]=a.useState({}),_=a.useRef(0),[Q,se]=a.useState(null),Z=a.useRef(null),Pe=a.useRef(null),[Fe,Oe]=a.useState(null),[Ee,Ke]=a.useState(!1),[Me,lt]=a.useState(null),[We,Xe]=a.useState([]),[dt,bt]=a.useState(null),He=a.useRef(null),Qe=a.useRef(null),[Ct,ut]=a.useState(null),[Lt,ct]=a.useState(0),nt=a.useRef(null),$t=a.useRef({}),[yt,tt]=a.useState(!1),[at,Et]=a.useState({}),[Rt,Ze]=a.useState([]),gt=a.useRef(new Map),[pt,wt]=a.useState(new Set),[D,te]=a.useState(!1),Se=a.useRef(null),d=a.useRef(new Set),ve=a.useRef({}),O=I[be]??null,X=(O==null?void 0:O.checkType)==="translation-match"&&A,ot=a.useRef(new Map),rt=a.useRef(new Map),ft=a.useRef(new Map),xt=a.useRef(new Map),Mt=a.useMemo(()=>O?O.cardType==="vocab"?t.cogita.library.revision.vocabLabel:O.infoType?Ge(t,O.infoType):t.cogita.library.revision.infoLabel:"",[t,O]),ra=a.useMemo(()=>{var h;return k.id!=="levels"?I.length:((h=at.pool)==null?void 0:h.length)??k.getFetchLimit(Y,m)},[at,m,k,I.length,Y]),Ht=k.getProgressTotal?k.getProgressTotal(I,at,Y,m):k.id==="levels"?Math.min(Y,ra):I.length,Bt=Ht?Math.min(be+1,Ht):0,jt=Math.max(1,Number(m.tries??1)),vt=m.compare??"anchors",Dt=Math.max(0,Math.min(100,Number(m.minCorrectness??0))),st=(m.considerDependencies??"on")==="on",it=Math.max(0,Math.min(100,Number(m.dependencyThreshold??85))),Ft=r=>{const h=r.slice();for(let j=h.length-1;j>0;j-=1){const v=Math.floor(Math.random()*(j+1));[h[j],h[v]]=[h[v],h[j]]}return h},Jt=r=>r.length?r.reduce((j,v)=>j+v,0)/r.length/255*100:0,Qt=r=>Jt(r)>=Dt,oa=async()=>{const r=await qt(),h=new Map,j=new Map,v=new Map;r.forEach(M=>{const z=`${M.itemType}:${M.itemId}`,ee=Vt(M.itemType,M.itemId,M.checkType,M.direction);if(h.has(z)||h.set(z,[]),h.get(z).push(M),j.has(ee)||j.set(ee,[]),j.get(ee).push(M),M.itemType==="info"&&M.checkType==="quote-fragment"&&M.direction){const re=`${M.itemId}:${M.direction}`;v.has(re)||v.set(re,[]),v.get(re).push(M)}});const B=new Map,w=new Map,K=new Map;return h.forEach((M,z)=>B.set(z,Ot(M).score)),j.forEach((M,z)=>w.set(z,Ot(M).score)),v.forEach((M,z)=>K.set(z,Ot(M).score)),{itemKnowness:B,cardKnowness:w,fragmentKnowness:K}},Ha=async r=>{const h=[];let j=null;for(;;){const v=await Ra({libraryId:l,collectionId:r,limit:200,cursor:j});if(h.push(...v.items),!v.nextCursor)break;j=v.nextCursor}return hs(h)},ba=async(r,h)=>{if(gt.current.has(r))return gt.current.get(r)??0;const j=await Ha(r);if(j.length===0)return gt.current.set(r,0),0;const B=j.reduce((w,K)=>{const M=he(K);return w+(h.get(M)??0)},0)/j.length;return gt.current.set(r,B),B},Qa=(r,h)=>{if(!st||r.cardType!=="info"||r.infoType!=="citation"||r.checkType!=="quote-fragment")return!0;const j=It(r.direction);if(!(j!=null&&j.fragmentId))return!0;const v=r.description??"";if(!v.trim())return!0;const w=ia(v).nodes[j.fragmentId];if(!w||!w.leftId&&!w.rightId)return!0;const K=[w.leftId,w.rightId].filter(ee=>!!ee);if(K.length===0)return!0;const M=K.map(ee=>{const re=Vt("info",r.cardId,"quote-fragment",Na(j.mode,ee));return h.get(re)??0});return M.reduce((ee,re)=>ee+re,0)/M.length>=it},ca=async r=>{const h=at,j=r.concat(h.active??[]).concat(h.pool??[]).filter((M,z,ee)=>ee.findIndex(re=>he(re)===he(M))===z);if(!st){wt(new Set(j.map(he)));return}const{itemKnowness:v,cardKnowness:B}=await oa(),w=Rt.filter(M=>mt(M.childItemType)==="collection"&&M.childItemId===b&&!mt(M.childCheckType)&&!mt(M.childDirection)),K=new Set;for(const M of j){if(M.cardType!=="info"){K.add(he(M));continue}if(!Qa(M,B))continue;const z=Rt.filter(pe=>fn(pe,M)).concat(w);if(z.length===0){K.add(he(M));continue}let ee=0;for(const pe of z)if(mt(pe.parentItemType)==="collection")ee+=await ba(pe.parentItemId,B);else if(mt(pe.parentCheckType)||mt(pe.parentDirection)){const ue=mt(pe.parentCheckType),$e=mt(pe.parentDirection),Ae=Vt(pe.parentItemType,pe.parentItemId,ue,$e);ee+=B.get(Ae)??0}else{const ue=`${pe.parentItemType}:${pe.parentItemId}`;ee+=v.get(ue)??0}ee/z.length>=it&&K.add(he(M))}wt(K)},Ya=r=>{for(let h=r;h<I.length;h+=1){const j=I[h];if(j&&(!st||j.cardType!=="info"||pt.has(he(j))))return h}return-1},At=r=>!st||r.cardType!=="info"||pt.has(he(r)),la=r=>{if(k.id!=="temporal"&&k.id!=="levels")return null;const h=at,j=(h.active??[]).concat(h.pool??[]),v=new Set;for(const B of j){const w=he(B);if(!(v.has(w)||r.has(w))&&(v.add(w),At(B)))return B}return null},Kt=a.useMemo(()=>{if(k.id!=="levels")return null;const r=at,h=r.pool??[],j=r.active??[],v=r.levelMap??{},B=Math.max(1,Number(m.levels??1)),w=Array.from({length:B},()=>0),K=new Set(j.map(re=>he(re)));h.forEach(re=>{const pe=Math.min(B,Math.max(1,v[he(re)]??1));w[pe-1]+=1});const M=h.length||1,z=w.map(re=>re/M*100),ee=O?v[he(O)]??1:null;return{counts:w,percentages:z,currentLevel:ee,levelsCount:B,activeCount:j.length,poolCount:h.length,activeSet:K}},[at,m,k,O]),kt=a.useMemo(()=>{if(k.id!=="temporal")return null;const r=at,h=r.pool??[],j=r.active??[],v=r.knownessMap??{},B=new Set(r.unknownSet??[]);let w=0;h.forEach(z=>{(v[he(z)]??0)>1&&(w+=1)});const K=B.size,M=j.map(z=>({id:he(z),value:B.has(he(z))?0:Math.max(0,Math.min(1,v[he(z)]??0))}));return{knownCount:w,unknownCount:K,dots:M}},[at,k]),da=a.useMemo(()=>{if(!st)return 0;const r=at;return I.concat(r.active??[]).concat(r.pool??[]).filter((j,v,B)=>B.findIndex(w=>he(w)===he(j))===v).filter(j=>j.cardType==="info"&&!pt.has(he(j))).length},[st,at,I,pt]);a.useEffect(()=>{if(!st||ce!=="ready")return;const r=at,j=I.concat(r.active??[]).concat(r.pool??[]).filter((w,K,M)=>M.findIndex(z=>he(z)===he(w))===K).filter(w=>w.cardType!=="info"||pt.has(he(w))).length,v=He.current;if(He.current=j,v===null||j<=v)return;const B=j-v;bt(`New card available (+${B})`),Qe.current&&window.clearTimeout(Qe.current),Qe.current=window.setTimeout(()=>bt(null),2200)},[st,ce,at,I,pt]),a.useEffect(()=>()=>{Qe.current&&window.clearTimeout(Qe.current)},[]);const Nt=(r,h)=>{const j=k.applyOutcome({queue:I,meta:at},O,Y,m,{correct:r,correctness:h,createdUtc:new Date().toISOString()});$(j.queue),Et(j.meta);const v=j.queue[be+1];v&&ya(v,be+1)};a.useEffect(()=>{Oa(l,b).then(r=>G(r.name)).catch(()=>G(t.cogita.library.collections.defaultName))},[l,b]),a.useEffect(()=>{bs({libraryId:l,type:"language"}).then(r=>oe(r)).catch(()=>oe([]))},[l]),a.useEffect(()=>{fs({libraryId:l}).then(r=>Ze(r.items??[])).catch(()=>Ze([]))},[l]),a.useEffect(()=>{is(l,P)},[l,P]),a.useEffect(()=>{ca(I)},[I,Rt,st,it,b]),a.useEffect(()=>{if(!O||!st){te(!1);return}if(O.cardType!=="info"||pt.has(he(O))){te(!1);return}const r=Ya(be+1);if(r>=0){te(!1),x(r);return}if(k.id==="temporal"||k.id==="levels"){const h=I.slice(0,be+1),j=I.slice(be+1).filter(At),v=h.concat(j),B=new Set(v.map(he)),w=la(B);if(w){const M=he(w);B.has(M)||(v.push(w),B.add(M),Et(z=>{const ee=z,re=new Set(ee.queued??[]);return re.add(M),{...ee,queued:re}}))}const K=v.findIndex((M,z)=>z!==be&&At(M));if(K>=0){$(v),x(K),te(!1);return}}te(!0)},[O,pt,st,be,I,at,k.id]),a.useEffect(()=>{let r=!0;return(async()=>{_e("loading"),T({current:0,total:k.id==="levels"?0:k.getFetchLimit(Y,m)});try{const j=[];let v=null,B=null;do{const pe=await Ra({libraryId:l,collectionId:b,limit:300,cursor:v});if(j.push(...pe.items),(k.id==="levels"||k.id==="temporal")&&pe.total&&(B=pe.total),T(ue=>({current:j.length,total:ue.total||pe.total||k.getFetchLimit(Y,m)})),v=pe.nextCursor??null,B!==null&&j.length>=B||k.id!=="levels"&&k.id!=="temporal"&&j.length>=k.getFetchLimit(Y,m))break}while(v);if(!r)return;const w=hs(j);let K;if(k.id==="levels"){const pe=Math.max(1,Number(m.levels??1)),$e=(await qt()).reduce((Ae,qe)=>{const Ye=Vt(qe.itemType,qe.itemId,qe.checkType,qe.direction);return Ae[Ye]||(Ae[Ye]=[]),Ae[Ye].push(qe),Ae},{});K={},w.forEach(Ae=>{const qe=he(Ae),Ye=$e[qe]??[],ht=Ye.length>0?Ot(Ye).score:0,aa=Math.max(1,Math.min(pe,Math.ceil(ht/100*pe)));K[qe]=aa})}let M=null,z=null,ee=null;if(k.id==="temporal"){const pe=await qt(),ue=new Set(w.map(qe=>he(qe))),$e=pe.reduce((qe,Ye)=>{const ht=Vt(Ye.itemType,Ye.itemId,Ye.checkType,Ye.direction);return ue.has(ht)&&(qe[ht]||(qe[ht]=[]),qe[ht].push(Ye)),qe},{});M={},z=new Set,ee={};const Ae=Date.now();w.forEach(qe=>{const Ye=he(qe),ht=$e[Ye]??[];if(ht.length===0){M[Ye]=0,z.add(Ye),ee[Ye]=[];return}const aa=vs(ht);ee[Ye]=aa;const yn=qa(aa,Ae);M[Ye]=yn.knowness})}const re=k.id==="levels"?js(w,Y,m,K):k.id==="temporal"?ws(w,Y,m,M??{},z??new Set,ee??{}):k.prepare(w,Y,m);$(re.queue),Et(re.meta),x(0),_e("ready"),T(pe=>({current:Math.min(pe.current,pe.total),total:pe.total}))}catch{r&&_e("error")}})(),()=>{r=!1}},[l,b,Y,m,k,P]),a.useEffect(()=>{if(fe(""),F(null),ut(null),ct(0),Le([]),et({}),ye({}),le(null),Be(null),we(null),Ke(!1),tt(!1),Oe(null),J(null),R({}),!O){Te(null),ze(null),ie(null),lt(null);return}O.cardType==="info"&&O.infoType==="computed"&&Te(t.cogita.library.revision.loadingComputed);let r=!0;return ya(O,be).then(h=>{!r||!h||(Te(h.prompt),ze(h.expectedAnswer),Le(h.computedExpected),et(h.computedAnswers),ie(h.computedValues),le(h.answerTemplate),Be(h.outputVariables),we(h.variableValues))}),()=>{r=!1}},[O,t]),a.useEffect(()=>{if(!O||O.cardType!=="info"||O.infoType!=="citation"){Se.current=null,d.current=new Set,Ve(null);return}const r=O.description??"",h=(O.label??"").trim(),j=h.replace(/\s+/g," ").trim(),v=r.replace(/\s+/g," ").trim(),B=j&&j!==v?h:t.cogita.library.infoTypes.citation;if(!r){Ve(null),ze(null);return}const w=ia(r);Se.current=w,Te(B);let K=!0;return oa().then(({fragmentKnowness:M})=>{if(!K)return;const z=getQuoteMode(O.direction),ee=new Set,re={};M.forEach(($e,Ae)=>{const[qe,Ye]=Ae.split(":",2);if(qe!==O.cardId)return;const ht=It(Ye);if(!ht||ht.mode!==z)return;const aa=ht.fragmentId;re[aa]=$e,$e>=it&&ee.add(aa)}),d.current=ee,ve.current=re;const pe=It(O.direction);if(pe!=null&&pe.fragmentId&&w.nodes[pe.fragmentId]){_t(w,pe.fragmentId,B);return}const ue=ma(w,ee,re,it,st,O.direction);_t(w,(ue==null?void 0:ue.id)??null,B)}).catch(()=>{d.current=new Set,ve.current={};const M=It(O.direction);if(M!=null&&M.fragmentId&&w.nodes[M.fragmentId]){_t(w,M.fragmentId,B);return}const z=ma(w,d.current,{},it,st,O.direction);_t(w,(z==null?void 0:z.id)??null,B)}),()=>{K=!1}},[O,t,st,it]),a.useEffect(()=>{if(!O||O.cardType!=="vocab"||O.checkType!=="translation-match"){J(null),R({});return}const j=(at.pool??at.active??I).filter(M=>M.cardType==="vocab"&&M.checkType==="translation-match").filter((M,z,ee)=>ee.findIndex(re=>re.cardId===M.cardId)===z);j.some(M=>M.cardId===O.cardId)||j.unshift(O);const B=Ft(j).slice(0,6).map(M=>{const z=M.label.split("↔").map(pe=>pe.trim()).filter(Boolean);if(z.length<2)return null;const ee=`${M.cardId}:L`,re=`${M.cardId}:R`;return{cardId:M.cardId,leftId:ee,rightId:re,leftLabel:z[0],rightLabel:z[1]}}).filter(Boolean),w=B.map(M=>M.leftId),K=Ft(B.map(M=>M.rightId));J({pairs:B,leftOrder:w,rightOrder:K,selection:{},activeLeft:null,activeRight:null,locked:{}})},[O,I,at]),a.useEffect(()=>()=>{Z.current&&window.clearTimeout(Z.current),Pe.current&&window.clearTimeout(Pe.current)},[]);const Xt=a.useRef(null);a.useEffect(()=>{if(!O)return;const r=he(O),h=typeof document<"u"?document.activeElement:null;if(Xt.current===r&&h&&(h.tagName==="INPUT"||h.tagName==="TEXTAREA"))return;let j=0;const v=()=>{if(O){if(O.cardType==="info"&&O.infoType==="computed"){if(De.length>0){const w=_a(ke,De,xe),K=w?$t.current[w]:null;if(K&&(K.focus(),document.activeElement===K)){Xt.current=r;return}}if(nt.current&&(nt.current.focus(),document.activeElement===nt.current)){Xt.current=r;return}}else if(O.cardType==="vocab"&&nt.current&&(nt.current.focus(),document.activeElement===nt.current)){Xt.current=r;return}j<6&&(j+=1,window.setTimeout(v,40))}},B=window.setTimeout(v,40);return()=>window.clearTimeout(B)},[O,De,ke,xe]),a.useEffect(()=>{if(!yt)return;const r=h=>{h.key==="Enter"&&(h.preventDefault(),ha())};return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)},[yt]);const Zt=r=>{Xe(r),lt(Ot(r))};a.useEffect(()=>{if(!O){lt(null),Xe([]);return}const r=O.cardType==="info"?"info":"connection";if(O.cardType==="info"&&O.infoType==="citation"){qt().then(h=>{const j=h.filter(v=>v.itemType==="info"&&v.itemId===O.cardId&&v.checkType==="quote-fragment"&&Ba(v.direction,O.direction));Zt(j)}).catch(()=>{lt(null),Xe([])});return}Ka(r,O.cardId,O.checkType,O.direction).then(h=>Zt(h)).catch(()=>{lt(null),Xe([])})},[l,O,P]);const Ta=(r,h,j,v)=>{if(r==="info"&&j==="quote-fragment"){qt().then(B=>{const w=B.filter(K=>K.itemType==="info"&&K.itemId===h&&K.checkType==="quote-fragment"&&Ba(K.direction,v));Zt(w)}).catch(()=>{lt(null),Xe([])});return}Ka(r,h,j,v).then(B=>Zt(B)).catch(()=>{lt(null),Xe([])})},Ca=(r,h,j)=>{var K;const v=((K=j.pairs.find(M=>M.leftId===r))==null?void 0:K.rightId)??null;if(!v)return j;const B=v===h;R(M=>({...M,[r]:B?"correct":"incorrect"})),Z.current&&window.clearTimeout(Z.current),Pe.current&&window.clearTimeout(Pe.current),_.current+=1;const w={kind:B?"correct":"incorrect",tick:_.current};if(se(null),Z.current=window.setTimeout(()=>se(w),0),Pe.current=window.setTimeout(()=>se(null),420),B){const M={...j.locked,[r]:!0};return Object.keys(M).length>=j.pairs.length?(F("correct"),tt(!0)):F("correct"),{...j,selection:{...j.selection,[r]:h},activeLeft:null,activeRight:null,locked:M}}return F("incorrect"),{...j,activeLeft:null,activeRight:null}},ua=r=>{J(h=>!h||h.locked[r]?h:h.activeRight?Ca(r,h.activeRight,h):{...h,activeLeft:h.activeLeft===r?null:r})},zt=r=>{J(h=>h&&(h.activeLeft?Ca(h.activeLeft,r,h):{...h,activeRight:h.activeRight===r?null:r}))},ha=()=>{var r;if(O&&O.cardType==="info"&&O.infoType==="citation"&&Se.current&&Ie&&!((r=It(O.direction))!=null&&r.fragmentId)){const h=ma(Se.current,d.current,ve.current,it,st,O.direction,Ie.fragmentId);if(h){F(null),fe(""),Ke(!1),ye({}),tt(!1),ut(null),ct(0),_t(Se.current,h.id,Ie.title);return}}F(null),fe(""),Ke(!1),ye({}),tt(!1),ut(null),ct(0),x(h=>Math.min(h+1,I.length))},Pt=r=>{if(!O)return;const h=r.expected??null,j=r.answer??"";let v=h??"",B=j;if(!h&&r.expectedMap&&r.answerMap){const pe=Object.keys(r.expectedMap).sort((ue,$e)=>ue.localeCompare($e));v=pe.map(ue=>{var $e;return(($e=r.expectedMap)==null?void 0:$e[ue])??""}).join("|"),B=pe.map(ue=>{var $e;return(($e=r.answerMap)==null?void 0:$e[ue])??""}).join("|")}const w=v?pa(v,B,vt):new Uint8Array,K={revisionType:k.id,evalType:r.evalType,direction:r.direction,prompt:je??"",expected:h,answer:j,expectedAnswers:r.expectedMap??null,answers:r.answerMap??null,correct:r.correct,maskBase64:w.length?Yt(w):null,values:ge??null,checkMode:de,compareMode:vt,minCorrectness:Dt},M=new TextEncoder().encode(JSON.stringify(K)),z=O.cardType==="info"?"info":"connection",ee=r.overrideCheckType??O.checkType??null,re=r.overrideDirection??O.direction??null;Fa({itemType:z,itemId:O.cardId,checkType:ee,direction:re,revisionType:k.id,evalType:r.evalType,correct:r.correct,maskBase64:w.length?Yt(w):null,payloadBase64:Yt(M),personRoleId:P??null}).then(()=>{Ta(z,O.cardId,ee,re),ca(I),is(l,P)}).catch(()=>{})},ea=(r,h)=>{const j=ot.current.get(h);if(j)return Promise.resolve(j);const v=rt.current.get(h);if(v)return v;const B=Gt({libraryId:l,infoId:r}).then(w=>{var pe,ue;const K=w.payload,M=((pe=K.definition)==null?void 0:pe.graph)??null,z="",ee=((ue=K.definition)==null?void 0:ue.answerTemplate)??"",re=dn(M,z,ee);if(re){const Ae={sample:un(re),answerTemplate:ee||null};return ot.current.set(h,Ae),Ae}return Ts({libraryId:l,infoId:r}).then($e=>{const Ae={sample:$e,answerTemplate:null};return ot.current.set(h,Ae),Ae})}).catch(()=>Ts({libraryId:l,infoId:r}).then(w=>{const K={sample:w,answerTemplate:null};return ot.current.set(h,K),K}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{rt.current.delete(h)});return rt.current.set(h,B),B},ya=(r,h)=>{var M;const j=`${he(r)}:${h}`,v=ft.current.get(j);if(v)return Promise.resolve(v);const B=xt.current.get(j);if(B)return B;const w=z=>(ft.current.set(j,z),z);let K;if(r.cardType==="vocab"){if(r.checkType==="translation-match")return K=Promise.resolve(w({prompt:r.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),K;const z=r.label.split("↔").map(ee=>ee.trim()).filter(Boolean);if(z.length>=2){const re=(r.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",pe=re?z[0]:z[1],ue=re?z[1]:z[0];K=Promise.resolve(w({prompt:pe,expectedAnswer:ue,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else K=Promise.resolve(w({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(r.cardType==="info"&&r.infoType==="word"){const z=(M=r.description)!=null&&M.startsWith("Language: ")?r.description.replace("Language: ",""):null;K=Promise.resolve(w({prompt:r.label,expectedAnswer:z,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else r.cardType==="info"&&r.infoType==="computed"?K=ea(r.cardId,j).then(z=>{var $e,Ae;if(!z.sample)return w({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const ee=z.sample,re=ee.expectedAnswers?Object.entries(ee.expectedAnswers).map(([qe,Ye])=>({key:qe,expected:Ye})):[],pe=re.reduce((qe,Ye)=>(qe[Ye.key]="",qe),{}),ue=ee.expectedAnswerIsSentence&&(($e=ee.expectedAnswer)==null?void 0:$e.trim())||null;return w({prompt:ee.prompt,expectedAnswer:re.length>0?ue:((Ae=ee.expectedAnswer)==null?void 0:Ae.trim())||null,computedExpected:re,computedAnswers:pe,computedValues:ee.values??null,answerTemplate:z.answerTemplate,outputVariables:ee.outputVariables??null,variableValues:ee.variableValues??null})}).catch(()=>w({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{xt.current.delete(j)}):K=Promise.resolve(w({prompt:r.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return xt.current.set(j,K),K},_t=(r,h,j)=>{const v=Object.keys(r.nodes).length,B=d.current.size;if(!h){Ve({title:j,before:r.text,after:"",fragmentId:null,total:v,completed:B}),ze(null),tt(!0);return}const w=r.nodes[h];if(!w)return;const K=ys(r.text,w);Ve({title:j,before:K.before,after:K.after,fragmentId:w.id,total:v,completed:B}),ze(K.fragment),tt(!1)},Ma=()=>{const r=Se.current;r&&Ve(h=>h&&{...h,total:Object.keys(r.nodes).length,completed:d.current.size})},ga=()=>{const r=I[be+1];r&&ya(r,be+1)},Ia=()=>{if(ga(),O&&O.cardType==="vocab"&&O.checkType==="translation-match"&&A){if(A.pairs.length===0){F("incorrect"),tt(!0);return}const w=A.pairs.reduce((ue,$e)=>(ue[$e.rightId]=$e.rightLabel,ue),{});let K=0;const M={};A.pairs.forEach(ue=>{const Ae=A.selection[ue.leftId]===ue.rightId;M[ue.leftId]=Ae?"correct":"incorrect",Ae&&(K+=1)});const z=A.pairs.length||1,ee=K/z,re=K===A.pairs.length;R(ue=>({...ue,...M})),re?(F("correct"),tt(!0),ct(0)):(F("incorrect"),tt(!1),ct(ue=>{const $e=ue+1;return $e>=jt&&(Ke(!0),tt(!0),J(Ae=>{if(!Ae)return Ae;const qe=Ae.pairs.reduce((Ye,ht)=>(Ye[ht.leftId]=ht.rightId,Ye),{});return{...Ae,selection:qe}})),$e})),Nt(re,ee);const pe="connection";Promise.all(A.pairs.map(ue=>{const $e=A.selection[ue.leftId]??null,Ae=$e?w[$e]:"",qe={left:ue.leftLabel,expected:ue.rightLabel,answer:Ae,checkType:"translation-match"},Ye=new TextEncoder().encode(JSON.stringify(qe));return Fa({itemType:pe,itemId:ue.cardId,checkType:"translation-match",direction:null,revisionType:k.id,evalType:"translation-match",correct:$e===ue.rightId,maskBase64:null,payloadBase64:Yt(Ye),personRoleId:P??null})})).then(()=>{Ta(pe,O.cardId,O.checkType,O.direction),is(l,P)}).catch(()=>{});return}if(De.length>0){const w=De.reduce((M,z)=>{const ee=Ue[z.key]??"";return M[z.key]=St(ee)===St(z.expected)?"correct":"incorrect",M},{});De.every(({key:M,expected:z})=>{const ee=Ue[M]??"";return de==="exact"&&St(ee)===St(z)})?(F("correct"),ye(w),tt(!0),ct(0),Nt(!0,1),Pt({correct:!0,direction:je?`${je} -> computed`:"computed",expectedMap:De.reduce((M,z)=>(M[z.key]=z.expected,M),{}),answerMap:Ue,evalType:"computed"})):(F("incorrect"),ye(w),tt(!1),ct(M=>{const z=M+1;return z>=jt&&q&&(Ke(!0),tt(!0)),z}),Nt(!1,0),window.setTimeout(()=>{var z;const M=_a(ke,De,xe);M&&$t.current[M]&&((z=$t.current[M])==null||z.focus())},40),Pt({correct:!1,direction:je?`${je} -> computed`:"computed",expectedMap:De.reduce((M,z)=>(M[z.key]=z.expected,M),{}),answerMap:Ue,evalType:"computed"}));return}if(O&&O.cardType==="info"&&O.infoType==="citation"&&(Ie!=null&&Ie.fragmentId)){if(!Ne)return;const w=It(O.direction),K=(w==null?void 0:w.mode)??getQuoteMode(O.direction),M=w!=null&&w.fragmentId&&O.direction?O.direction:Na(K,Ie.fragmentId),z=pn(Ne,V,vt),ee=de==="exact"&&fa(V)===fa(Ne),re=Qt(z),pe=ee||re,ue=Jt(z);pe?(ve.current[Ie.fragmentId]=Math.max(ve.current[Ie.fragmentId]??0,ue),(ve.current[Ie.fragmentId]??0)>=it&&d.current.add(Ie.fragmentId),Ma(),F("correct"),ye({}),tt(!0),ut(z),ct(0),ue<100&&jt<=1&&Ke(!0),Nt(!0,ue/100),Pt({correct:!0,direction:`quote:${Ie.fragmentId}`,expected:Ne,answer:V,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:M})):(F("incorrect"),ye({}),tt(!1),ut(z),ct($e=>{const Ae=$e+1;return Ae>=jt&&q&&(Ke(!0),tt(!0)),Ae}),Nt(!1,ue/100),window.setTimeout(()=>{var $e;return($e=nt.current)==null?void 0:$e.focus()},40),Pt({correct:!1,direction:`quote:${Ie.fragmentId}`,expected:Ne,answer:V,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:M}));return}if(!Ne)return;const r=pa(Ne,V,vt),h=de==="exact"&&St(V)===St(Ne),j=Qt(r),v=h||j,B=Jt(r);v?(F("correct"),ye({}),tt(!0),ut(r),ct(0),B<100&&jt<=1&&Ke(!0),Nt(!0,B/100),Pt({correct:!0,direction:je?`${je} -> ${Ne}`:null,expected:Ne,answer:V,evalType:"text"})):(F("incorrect"),ye({}),tt(!1),ut(r),ct(w=>{const K=w+1;return K>=jt&&q&&(Ke(!0),tt(!0)),K}),Nt(!1,B/100),window.setTimeout(()=>{var w;return(w=nt.current)==null?void 0:w.focus()},40),Pt({correct:!1,direction:je?`${je} -> ${Ne}`:null,expected:Ne,answer:V,evalType:"text"}))},Ga=r=>{if(ga(),!Ne)return;const h=pa(Ne,r,vt),j=St(r)===St(Ne),v=Qt(h),B=j||v,w=Jt(h);B?(F("correct"),ye({}),tt(!0),ut(h),ct(0),w<100&&jt<=1&&Ke(!0),Nt(!0,w/100),Pt({correct:!0,direction:"word->language",expected:Ne,answer:r,evalType:"language-select"})):(F("incorrect"),ye({}),tt(!1),ut(h),ct(K=>{const M=K+1;return M>=jt&&q&&(Ke(!0),tt(!0)),M}),Nt(!1,w/100),Pt({correct:!1,direction:"word->language",expected:Ne,answer:r,evalType:"language-select"}))},Ja=()=>{ga(),F("correct"),tt(!0),ct(0),Nt(!0,1),Ne&&Pt({correct:!0,direction:"manual",expected:Ne,answer:V,evalType:"manual"})},Xa=()=>{if(Nt(!1,0),O&&O.cardType==="info"&&O.infoType==="citation"){F(null),fe(""),Ke(!1),ye({}),tt(!1),ut(null),ct(0),x(r=>Math.min(r+1,I.length));return}ha()};a.useEffect(()=>{ga()},[be,I]);const ta=r=>{var j;if(r.key!=="Enter")return;if(r.preventDefault(),r.stopPropagation(),yt){ha();return}const h=De.find(v=>!(Ue[v.key]??"").trim());if(h){(j=$t.current[h.key])==null||j.focus();return}Ia()},C=t.cogita.library.revision.revealModeAfterIncorrect,q=De.length>0||!!Ne;return e.jsxs(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,children:[ce==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${me.total?Math.min(100,Math.max(0,me.current/me.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:me.total?`${Math.min(me.current,me.total)} / ${me.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:L}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",p).replace("{check}",W)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:S,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${S}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${S}/collections/${b}`,children:t.cogita.library.actions.collectionDetail})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Me?`${Me.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Kt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Kt.currentLevel??"-"," / ",Kt.levelsCount]}):null,Me?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(Me.correct)).replace("{total}",String(Me.total))}),Me.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(Me.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(hn,{outcomes:We})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[dt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:dt})}):null,e.jsx("section",{className:"cogita-revision-card","data-feedback":Q?`${Q.kind}-${Q.tick}`:X?"idle":H??"idle",children:O?e.jsx(e.Fragment,{children:D?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(xs,{copy:t,currentCard:O,currentTypeLabel:Mt,prompt:je,languages:ne,answer:V,onAnswerChange:r=>fe(h=>Da(h,r,Fe)),computedExpected:De,computedAnswers:Ue,onComputedAnswerChange:(r,h)=>et(j=>({...j,[r]:Da(j[r]??"",h,Fe)})),answerTemplate:ke,outputVariables:xe,variableValues:Re,computedFieldFeedback:Je,feedback:H,canAdvance:yt,quoteContext:Ie,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Ia,onSkip:Xa,onLanguageSelect:Ga,onMarkReviewed:Ja,onAdvance:ha,showCorrectAnswer:Ee,setShowCorrectAnswer:Ke,onRevealCorrect:()=>tt(!0),answerMask:Ct,expectedAnswer:Ne,hasExpectedAnswer:q,handleComputedKeyDown:ta,answerInputRef:nt,computedInputRefs:$t,scriptMode:Fe,setScriptMode:Oe,matchPairs:A==null?void 0:A.pairs,matchLeftOrder:A==null?void 0:A.leftOrder,matchRightOrder:A==null?void 0:A.rightOrder,matchSelection:A==null?void 0:A.selection,matchActiveLeft:A==null?void 0:A.activeLeft,matchActiveRight:A==null?void 0:A.activeRight,matchFeedback:Ce,onMatchLeftSelect:ua,onMatchRightSelect:zt})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${S}/collections/${b}`,children:t.cogita.library.actions.collectionDetail})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Ht?`${Bt} / ${Ht}`:t.cogita.library.revision.progressUnlimited}),ce==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),ce==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),ce==="ready"&&I.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:C}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",jt]})]})]}),Kt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Kt.activeCount," / ",Kt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Kt.counts.map((r,h)=>{const j=h+1,v=Kt.currentLevel===j,B=Kt.percentages[h]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":v,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:j}),e.jsx("strong",{children:r})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,B))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[B.toFixed(1),"%"]})]},`level-${j}`)})})]}):null,kt?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:kt.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:kt.dots.map(r=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,r.value*100))}%`,background:`rgba(${Math.round(255*(1-r.value))}, ${Math.round(200*r.value)}, 80, 0.9)`}},r.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:kt.knownCount})]})]}):null,st?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:da})]})}):null]})]})]})})})]})]})}const rs=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],Yi={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},Gi=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Ji=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function Xi({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,libraryId:l,collectionId:b}){const[c,u]=a.useState(""),[S,ae,Y]=qs([]),[U,k,m]=Us([]),[de,P]=a.useState(null),[p,W]=a.useState(null),[L,G]=a.useState(null),I=`/#/cogita/library/${l}`;a.useEffect(()=>{Oa(l,b).then(T=>u(T.name)).catch(()=>u(t.cogita.library.collections.defaultName))},[l,b,t]),a.useEffect(()=>{Kn({libraryId:l,collectionId:b}).then(T=>{if(!T.graphId||T.graphId==="00000000-0000-0000-0000-000000000000"){ae([]),k([]);return}const be=T.nodes.map(V=>{var je;const fe=V.payload??{},H=fe.position??{x:120,y:120},F=fe.params??{};return{id:V.nodeId,type:"default",position:H,data:{nodeType:V.nodeType,label:((je=rs.find(Te=>Te.type===V.nodeType))==null?void 0:je.label)??V.nodeType,params:F}}}),x=T.edges.map(V=>({id:V.edgeId,source:V.fromNodeId,target:V.toNodeId,sourceHandle:V.fromPort??void 0,targetHandle:V.toPort??void 0}));ae(be),k(x)}).catch(()=>{ae([]),k([])})},[l,b,k,ae]);const $=a.useMemo(()=>S.find(T=>T.id===de)??null,[S,de]),ne=T=>{var fe;const be=crypto.randomUUID(),x=((fe=rs.find(H=>H.type===T))==null?void 0:fe.label)??T,V={...Yi[T]};ae(H=>[...H,{id:be,type:"default",position:{x:120+H.length*40,y:120+H.length*40},data:{nodeType:T,label:x,params:V}}]),P(be)},oe=a.useCallback(T=>{k(be=>Ws({...T,id:crypto.randomUUID()},be))},[k]),ce=async()=>{W(null);try{await Bn({libraryId:l,collectionId:b,nodes:S.map(T=>({nodeId:T.id,nodeType:T.data.nodeType,payload:{position:T.position,params:T.data.params}})),edges:U.map(T=>({edgeId:T.id,fromNodeId:T.source,fromPort:T.sourceHandle??null,toNodeId:T.target,toPort:T.targetHandle??null}))}),W(t.cogita.library.graph.saveSuccess)}catch{W(t.cogita.library.graph.saveFail)}},_e=async()=>{try{const T=await zn({libraryId:l,collectionId:b});G(T)}catch{G(null)}},me=T=>{$&&ae(be=>be.map(x=>x.id===$.id?{...x,data:{...x.data,params:T}}:x))};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${I}/collections/${b}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:_e,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:ce,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:rs.map(T=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>ne(T.type),children:T.label},T.type))}),p?e.jsx("p",{className:"cogita-help",children:p}):null,L&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(L.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(L.connections)).replace("{infos}",String(L.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(gs,{nodes:S,edges:U,onNodesChange:Y,onEdgesChange:m,onConnect:oe,onNodeClick:(T,be)=>P(be.id),fitView:!0,children:[e.jsx(ms,{color:"rgba(120,160,200,0.2)"}),e.jsx(ps,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),$?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:$.data.label}),$.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(na,{libraryId:l,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:$.data.params.tagId?{id:$.data.params.tagId,label:$.data.params.tagLabel??"",infoType:"topic"}:null,onChange:T=>me({...$.data.params,tagId:(T==null?void 0:T.id)??null,tagLabel:(T==null?void 0:T.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:$.data.params.scope??"any",onChange:T=>me({...$.data.params,scope:T.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),$.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(na,{libraryId:l,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:$.data.params.languageId?{id:$.data.params.languageId,label:$.data.params.languageLabel??"",infoType:"language"}:null,onChange:T=>me({...$.data.params,languageId:(T==null?void 0:T.id)??null,languageLabel:(T==null?void 0:T.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:$.data.params.scope??"any",onChange:T=>me({...$.data.params,scope:T.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),$.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:$.data.params.infoType??"word",onChange:T=>me({...$.data.params,infoType:T.target.value}),children:Ji.map(T=>e.jsx("option",{value:T.value,children:T.label},T.value))})]}),e.jsx(na,{libraryId:l,infoType:$.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:$.data.params.infoId?{id:$.data.params.infoId,label:$.data.params.infoLabel??"",infoType:$.data.params.infoType??"word"}:null,onChange:T=>me({...$.data.params,infoId:(T==null?void 0:T.id)??null,infoLabel:(T==null?void 0:T.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),$.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:$.data.params.connectionType??"translation",onChange:T=>me({...$.data.params,connectionType:T.target.value}),children:Gi.map(T=>e.jsx("option",{value:T.value,children:T.label},T.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:$.data.params.connectionId??"",onChange:T=>me({...$.data.params,connectionId:T.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes($.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const os="cogita.preferences",cs="cogita.reviewer.preferences",bn=["library_overview","all_cards","all_collections","storyboards","texts","dependencies","transfer"],ls={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},ds=["settings","run","shared"];function Zi(t,s=""){const n=t.split("/").filter(Boolean);if(n[0]!=="cogita"||n[1]!=="library")return{};const i=n[2];if(!i)return{};if(!n[3])return{libraryId:i,target:"library_overview"};const o=new URLSearchParams(s),g=o.get("revisionId")??void 0,f=o.get("infoId")??void 0,y=o.get("infoView")==="cards"?"cards":"overview",E=o.get("collectionAction"),N=o.get("libraryAction");if(n[3]==="list")return{libraryId:i,target:N==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:g,infoId:f,infoView:y,libraryAction:N==="new-info"?"new-info":void 0};if(n[3]==="detail"||n[3]==="collection")return{libraryId:i,target:"all_cards",cardMode:n[3],revisionId:g,infoId:f,infoView:y};if(n[3]==="new"||n[3]==="add")return{libraryId:i,target:"new_card",revisionId:g,libraryAction:"new-info"};if(n[3]==="edit")return{libraryId:i,target:"new_card",revisionId:g,infoId:n[4]};if(n[3]==="infos"){const b=n[4];return b?n[5]==="checkcards"?{libraryId:i,target:"all_cards",cardMode:"list",revisionId:g,infoId:b,infoView:"cards"}:{libraryId:i,target:"all_cards",cardMode:"list",revisionId:g,infoId:b,infoView:"overview"}:{libraryId:i,target:"all_cards",cardMode:"list",revisionId:g}}if(n[3]==="shared-revisions")return{libraryId:i,target:"all_collections",revisionId:g};if(n[3]==="dependencies")return{libraryId:i,target:"dependencies"};if(n[3]==="transfer")return{libraryId:i,target:"transfer"};if(n[3]==="storyboards")return n[4]==="new"?{libraryId:i,target:"new_storyboard"}:{libraryId:i,target:"storyboards"};if(n[3]==="texts")return n[4]==="new"?{libraryId:i,target:"new_text"}:{libraryId:i,target:"texts"};if(n[3]!=="collections")return{libraryId:i,target:"library_overview"};if(n[4]==="new")return{libraryId:i,target:"new_collection",revisionId:g};const l=n[4];return l?n[5]==="graph"?{libraryId:i,target:"all_collections",collectionId:l,revisionId:g,revisionView:"graph"}:n[5]==="shared-revisions"?{libraryId:i,target:"all_collections",collectionId:l,revisionId:g,revisionView:"shared"}:n[5]==="revision"?{libraryId:i,target:"all_collections",collectionId:l,revisionId:g,revisionView:n[6]==="run"?"run":"settings"}:E==="new-revision"?{libraryId:i,target:"all_collections",collectionId:l,revisionId:g,revisionView:"new"}:{libraryId:i,target:"all_collections",collectionId:l,revisionId:g,revisionView:"detail"}:E==="new-collection"?{libraryId:i,target:"new_collection",collectionAction:"new-collection"}:{libraryId:i,target:"all_collections"}}function Vs(t,s="library_overview",n,i,o,g,f="overview"){const y=(E,N)=>{const l=new URLSearchParams;N!=null&&N.revisionId&&l.set("revisionId",N.revisionId),N!=null&&N.collectionAction&&l.set("collectionAction",N.collectionAction),N!=null&&N.libraryAction&&l.set("libraryAction",N.libraryAction),N!=null&&N.infoId&&l.set("infoId",N.infoId),N!=null&&N.infoView&&(N!=null&&N.infoId)&&l.set("infoView",N.infoView);const b=l.toString();return b?`${E}?${b}`:E};return t?s==="library_overview"?y(`/cogita/library/${t}`,{revisionId:o}):s==="all_cards"?g?f==="cards"?y(`/cogita/library/${t}/infos/${g}/checkcards`,{revisionId:o}):y(`/cogita/library/${t}/infos/${g}`,{revisionId:o}):y(`/cogita/library/${t}/list`,{revisionId:o,infoId:g,infoView:f}):s==="new_card"?g?y(`/cogita/library/${t}/edit/${g}`,{revisionId:o}):y(`/cogita/library/${t}/list`,{revisionId:o,libraryAction:"new-info"}):s==="all_collections"?n?i==="graph"?y(`/cogita/library/${t}/collections/${n}/graph`,{revisionId:o}):i==="settings"?y(`/cogita/library/${t}/collections/${n}/revision`,{revisionId:o}):i==="run"?y(`/cogita/library/${t}/collections/${n}/revision/run`,{revisionId:o}):i==="shared"?y(`/cogita/library/${t}/collections/${n}/shared-revisions`,{revisionId:o}):i==="new"?y(`/cogita/library/${t}/collections/${n}`,{revisionId:o,collectionAction:"new-revision"}):y(`/cogita/library/${t}/collections/${n}`,{revisionId:o}):y(`/cogita/library/${t}/collections`,{revisionId:o}):s==="new_collection"?y(`/cogita/library/${t}/collections`,{revisionId:o,collectionAction:"new-collection"}):s==="transfer"?y(`/cogita/library/${t}/transfer`,{revisionId:o}):s==="storyboards"?y(`/cogita/library/${t}/storyboards`,{revisionId:o}):s==="new_storyboard"?y(`/cogita/library/${t}/storyboards/new`,{revisionId:o}):s==="texts"?y(`/cogita/library/${t}/texts`,{revisionId:o}):s==="new_text"?y(`/cogita/library/${t}/texts/new`,{revisionId:o}):s==="dependencies"?y(`/cogita/library/${t}/dependencies`,{revisionId:o}):y(`/cogita/library/${t}`,{revisionId:o}):"/cogita"}function va(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function er(t){return typeof t=="string"&&bn.includes(t)}function tr(t,s){var y;if(!t.length)return null;const n=t.filter(E=>s.has(E.roleId)),i=n.length>0?n:t,o=i.map(E=>{var l,b;const N=((b=(l=E.fields.find(c=>c.fieldType==="role_kind"))==null?void 0:l.plainValue)==null?void 0:b.toLowerCase())??"";return{roleId:E.roleId,roleKind:N}}),g=o.find(E=>E.roleKind.includes("master"));if(g)return g.roleId;const f=o.find(E=>E.roleKind.includes("account")||E.roleKind.includes("user"));return f?f.roleId:((y=i[0])==null?void 0:y.roleId)??null}function ar(t){if(!t)return{version:1,byLibrary:{}};try{const s=JSON.parse(t);return!s||typeof s!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:s.lastLibraryId,byLibrary:s.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function sr({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N}){const l=Os(),b=Va(),c=a.useMemo(()=>Zi(b.pathname,b.search),[b.pathname,b.search]),u=t.cogita.workspace,[S,ae]=a.useState([]),[Y,U]=a.useState([]),[k,m]=a.useState([]),[de,P]=a.useState([]),[p,W]=a.useState(void 0),[L,G]=a.useState("library_overview"),[I,$]=a.useState(void 0),[ne,oe]=a.useState(void 0),[ce,_e]=a.useState("detail"),[me,T]=a.useState(void 0),[be,x]=a.useState(!1),[V,fe]=a.useState(!0),[H,F]=a.useState(!1),[je,Te]=a.useState(!1),[Ne,ze]=a.useState(null),[Ie,Ve]=a.useState(0),[De,Le]=a.useState(""),[Ue,et]=a.useState(""),[Je,ye]=a.useState(""),[ge,ie]=a.useState([]),[ke,le]=a.useState(""),[xe,Be]=a.useState(null),[Re,we]=a.useState(null),A=a.useRef({version:1,byLibrary:{}}),J=a.useRef(!1),Ce=a.useRef(!1),R=a.useRef(null),_=a.useMemo(()=>S.find(d=>d.libraryId===p)??null,[S,p]),Q=a.useMemo(()=>Y.find(d=>d.collectionId===I)??null,[Y,I]);a.useEffect(()=>{if(!p){ie([]),le("");return}let d=!1;return sn({libraryId:p}).then(ve=>{if(!d){ie(ve);try{const O=window.localStorage.getItem(cs),ot=(O?JSON.parse(O):{})[p]??"",rt=ot&&ve.some(ft=>ft.roleId===ot)?ot:"";le(rt)}catch{le("")}}}).catch(()=>{d||(ie([]),le(""))}),()=>{d=!0}},[p]),a.useEffect(()=>{if(p)try{const d=window.localStorage.getItem(cs),ve=d?JSON.parse(d):{};ke?ve[p]=ke:delete ve[p],window.localStorage.setItem(cs,JSON.stringify(ve))}catch{}},[p,ke]);const se=a.useMemo(()=>de.find(d=>d.revisionId===ne)??null,[de,ne]),Z=a.useMemo(()=>({detail:u.revisions.detail,graph:u.revisions.graph,settings:u.revisions.settings,run:u.revisions.run,shared:u.targets.sharedRevisions,new:u.revisionForm.createAction}),[u.revisions.detail,u.revisions.graph,u.revisions.run,u.revisions.settings,u.targets.sharedRevisions,u.revisionForm.createAction]),Pe=a.useMemo(()=>[{value:"detail",label:Z.detail},{value:"graph",label:Z.graph},{value:"settings",label:u.targets.allRevisions},{value:"run",label:Z.run},{value:"shared",label:Z.shared}],[Z.detail,Z.graph,Z.run,Z.shared,u.targets.allRevisions]),Fe=a.useMemo(()=>L==="new_card"?"all_cards":L==="new_collection"?"all_collections":L==="new_storyboard"?"storyboards":L==="new_text"?"texts":L,[L]),Oe=a.useMemo(()=>ce==="new"?"settings":ce,[ce]),Ee=a.useMemo(()=>c.infoId?"selected":L==="new_card"?"create":"search",[c.infoId,L]),Ke=a.useMemo(()=>k.find(d=>d.infoId===c.infoId)??null,[k,c.infoId]),Me=a.useMemo(()=>({library_overview:u.targets.libraryOverview,all_cards:u.targets.allCards,new_card:u.targets.newCard,all_collections:u.targets.allCollections,new_collection:u.targets.newCollection,transfer:u.targets.transfer,storyboards:u.targets.storyboards,new_storyboard:u.targets.newStoryboard,texts:u.targets.texts,new_text:u.targets.newText,dependencies:u.targets.dependencies}),[u.targets]),lt=a.useMemo(()=>Me[Fe]??Fe,[Fe,Me]),We=Z[Oe],Xe=!!p,dt=a.useMemo(()=>{const d=E==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":E==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return E==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:d},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:d},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:d},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:d},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:d},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:d},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:d},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:d},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:d},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:d},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:d},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:d},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:d},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:E==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:d},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:d},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:d},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:d},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:d},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:d},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:d},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:d},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:d},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:d},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:d},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:d},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:d},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:d},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:d},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:d},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:d},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:d},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:d},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:d},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:d},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:d},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:d},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:d},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:d},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:d},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[E]),bt=dt.length,He=Math.max(0,Math.min(Ie,bt-1)),Qe=dt[He],Ct=!!I,ut=Xe&&L==="all_collections",Lt=Ct&&L==="all_collections",ct=Ct&&L==="all_collections"&&ds.includes(ce),nt=a.useCallback(d=>{const ve=!!d.libraryId;let O=d.target,X=d.collectionId,ot=d.revisionId,rt=d.revisionView,ft=d.infoId,xt=d.infoView??c.infoView??"overview";ve?ls[O].requiresCollection&&!X?(O="all_collections",ot=void 0,rt="detail"):O!=="all_collections"?(X=void 0,ot=void 0,O!=="new_card"&&O!=="all_cards"&&(ft=void 0,xt="overview")):ls[O].allowsRevision?ds.includes(rt)||(ot=void 0):rt="detail":(O="library_overview",X=void 0,ot=void 0,rt="detail",ft=void 0,xt="overview"),W(d.libraryId),G(O),$(X),oe(ot),_e(rt),x(!1);const Mt=va(Vs(d.libraryId,O,X,rt,ot,ft,xt));va(`${b.pathname}${b.search}`)!==Mt&&(R.current=Mt,l(Mt))},[b.pathname,b.search,l,c.infoView]),$t=d=>{nt({libraryId:p,target:"all_collections",collectionId:I,revisionId:ds.includes(d)?ne:void 0,revisionView:d})},yt=a.useMemo(()=>[{key:"library",label:u.layers.library,visible:!0,value:p??"",selectedLabel:(_==null?void 0:_.name)??u.path.noLibrarySelected,disabled:V||S.length===0,options:S.map(d=>({value:d.libraryId,label:d.name})),emptyOption:u.noLibraryOption,onSelect:d=>{const ve=d||void 0;nt({libraryId:ve,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:u.layers.target,visible:Xe,value:Fe,selectedLabel:lt,disabled:!Xe,options:bn.map(d=>({value:d,label:Me[d]})),onSelect:d=>{const ve=d;nt({libraryId:p,target:ve,collectionId:I,revisionId:ne,revisionView:ce,infoId:ve==="new_card"?c.infoId:void 0})}},{key:"info_mode",label:u.layers.target,visible:Fe==="all_cards",value:Ee,selectedLabel:Ee==="create"?u.infoMode.create:Ee==="selected"?(Ke==null?void 0:Ke.label)??me??t.cogita.library.list.selectedEmpty:u.infoMode.search,disabled:!Xe,options:[{value:"search",label:u.infoMode.search},{value:"create",label:u.infoMode.create},...c.infoId?[{value:"selected",label:(Ke==null?void 0:Ke.label)??me??t.cogita.library.list.selectedEmpty}]:[]],onSelect:d=>{if(d==="selected"){if(!c.infoId)return;nt({libraryId:p,target:"all_cards",collectionId:I,revisionId:ne,revisionView:ce,infoId:c.infoId,infoView:"overview"});return}if(d==="create"){nt({libraryId:p,target:"new_card",collectionId:I,revisionId:ne,revisionView:ce,infoId:void 0});return}nt({libraryId:p,target:"all_cards",collectionId:I,revisionId:ne,revisionView:ce,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:u.layers.target,visible:Fe==="all_cards"&&!!c.infoId,value:L==="new_card"&&c.infoId?"edit":c.infoView==="cards"?"cards":"overview",selectedLabel:L==="new_card"&&c.infoId?u.infoActions.edit:c.infoView==="cards"?u.infoActions.seeCards:u.infoActions.overview,disabled:!Xe||!c.infoId,options:[{value:"overview",label:u.infoActions.overview},{value:"edit",label:u.infoActions.edit},{value:"cards",label:u.infoActions.seeCards}],onSelect:d=>{if(c.infoId){if(d==="edit"){nt({libraryId:p,target:"new_card",collectionId:I,revisionId:ne,revisionView:ce,infoId:c.infoId});return}if(d==="cards"){nt({libraryId:p,target:"all_cards",collectionId:I,revisionId:ne,revisionView:ce,infoId:c.infoId,infoView:"cards"});return}nt({libraryId:p,target:"all_cards",collectionId:I,revisionId:ne,revisionView:ce,infoId:c.infoId,infoView:"overview"})}}},{key:"collection",label:u.layers.collection,visible:ut,value:I??"",selectedLabel:(Q==null?void 0:Q.name)??u.path.noCollectionSelected,disabled:!Xe||H||Y.length===0,options:Y.map(d=>({value:d.collectionId,label:d.name})),emptyOption:u.selectCollectionOption,onSelect:d=>{nt({libraryId:p,target:"all_collections",collectionId:d||void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection_action",label:u.layers.revision,visible:Lt,value:Oe,selectedLabel:We,disabled:!I,options:Pe.map(d=>({value:d.value,label:d.label})),onSelect:d=>{$t(d)}},{key:"revision_entry",label:u.layers.revision,visible:ct,value:ne??"",selectedLabel:(se==null?void 0:se.name)??u.status.noRevisions,disabled:!Ct||je||de.length===0,options:de.map(d=>({value:d.revisionId,label:d.name})),emptyOption:u.status.noRevisions,onSelect:d=>{nt({libraryId:p,target:"all_collections",collectionId:I,revisionId:d||void 0,revisionView:ce})}}],[Pe,Y,H,Ee,k,S,V,nt,de,je,Q,I,Ke,se,ne,me,Ct,Xe,_,p,We,ce,L,Oe,Fe,lt,ut,Lt,ct,Me,t.cogita.library.list.selectedEmpty,c.infoId,c.infoView,u.infoActions.edit,u.infoActions.overview,u.infoActions.seeCards,u.layers.collection,u.layers.library,u.layers.revision,u.layers.target,u.noLibraryOption,u.path.noCollectionSelected,u.path.noLibrarySelected,u.selectCollectionOption]),tt=a.useMemo(()=>yt.filter(d=>d.visible),[yt]),at=a.useMemo(()=>tt.filter(d=>d.key!=="library"&&d.key!=="collection"&&d.key!=="revision_entry"),[tt]),Et=a.useMemo(()=>at.find(d=>d.key==="target")??null,[at]),Rt=a.useMemo(()=>at.find(d=>d.key==="info_mode")??null,[at]),Ze=a.useMemo(()=>at.find(d=>d.key==="info_selected_action")??null,[at]),gt=a.useMemo(()=>at.find(d=>d.key==="collection_action")??null,[at]),pt=a.useCallback((d,ve)=>d?e.jsx("div",{className:"cogita-sidebar-actions",children:d.options.map(O=>e.jsx("button",{type:"button",className:`ghost ${String(d.value)===O.value?"active":""}`,onClick:()=>d.onSelect(O.value),disabled:d.disabled,children:O.label},`${ve}:${d.key}:${O.value}`))}):null,[]),wt=a.useMemo(()=>{const d=c.libraryId;if(!d||!b.pathname.startsWith("/cogita/library/"))return null;const ve={copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,libraryId:d};if(c.target==="library_overview")return e.jsx(ni,{...ve});if(c.target==="all_cards")return c.infoId&&c.infoView==="cards"?e.jsx(wi,{...ve,infoId:c.infoId,selectedReviewerRoleId:ke||null}):e.jsx(ui,{...ve,mode:c.cardMode??"list"});if(c.target==="new_card")return e.jsx(yi,{...ve,editInfoId:c.infoId});if(c.target==="dependencies")return e.jsx(vi,{...ve});if(c.target==="transfer")return e.jsx(ki,{...ve});if(c.target==="storyboards"||c.target==="new_storyboard")return e.jsx(Ni,{...ve});if(c.target==="texts"||c.target==="new_text")return e.jsx(Si,{...ve});if(c.target==="all_collections"){if(c.collectionId){const O={...ve,collectionId:c.collectionId};return c.revisionView==="graph"?e.jsx(Xi,{...O}):c.revisionView==="shared"?e.jsx(ji,{...ve,collectionId:c.collectionId}):c.revisionView==="settings"?e.jsx(Pi,{...O,revisionId:c.revisionId}):c.revisionView==="run"?e.jsx(Qi,{...O,revisionId:c.revisionId}):e.jsx(Ti,{...O})}return e.jsx(Ds,{...ve})}return c.target==="new_collection"?e.jsx(Ds,{...ve}):null},[s,t,E,b.pathname,l,N,g,y,i,o,c.cardMode,c.collectionId,c.infoId,c.libraryId,c.revisionId,c.revisionView,c.target,f,n,ke]);a.useEffect(()=>{let d=!1;return(async()=>{var O,X,ot,rt,ft;fe(!0);try{await Dn();const[xt,Mt,ra]=await Promise.all([Ys(),_n(),Vn()]);if(d)return;ae(xt);const Ht=new Set(ra.nodes.filter(st=>st.nodeType==="role"&&st.canLink).map(st=>st.roleId??"")),Bt=tr(Mt,Ht);if(Be(Bt),Bt){const st=ra.nodes.find(it=>it.nodeType==="data"&&it.roleId===Bt&&(it.fieldType===os||it.label===os));we((st==null?void 0:st.dataKeyId)??null),A.current=ar(st==null?void 0:st.value)}const jt=(O=xt.find(st=>st.libraryId===c.libraryId))==null?void 0:O.libraryId,vt=jt?(ot=(X=A.current.byLibrary)==null?void 0:X[jt])==null?void 0:ot.lastTarget:void 0,Dt=er(vt)?vt:"library_overview";W(jt),G(c.target??Dt),oe(c.revisionId??(jt?(ft=(rt=A.current.byLibrary)==null?void 0:rt[jt])==null?void 0:ft.lastRevisionId:void 0)),_e(c.revisionView??"detail"),J.current=!0}catch{d||ze(u.status.loadFailed)}finally{d||fe(!1)}})(),()=>{d=!0}},[u.status.loadFailed]),a.useLayoutEffect(()=>{if(J.current){if(!c.libraryId){W(void 0),G(c.target??"library_overview"),$(void 0),oe(void 0),_e("detail");return}c.libraryId&&S.some(d=>d.libraryId===c.libraryId)&&W(c.libraryId),c.target&&G(c.target),$(c.collectionId),oe(c.revisionId),c.revisionView&&_e(c.revisionView)}},[S,c.collectionId,c.libraryId,c.revisionId,c.revisionView,c.target]),a.useEffect(()=>{if(!p){U([]),$(void 0),m([]),P([]),oe(void 0);return}let d=!1;return F(!0),ja({libraryId:p,limit:200}).then(ve=>{var ot;if(d)return;const O=ve.items;U(O);const X=(ot=O.find(rt=>rt.collectionId===c.collectionId))==null?void 0:ot.collectionId;$(X)}).catch(()=>{d||(U([]),$(void 0))}).finally(()=>{d||F(!1)}),()=>{d=!0}},[c.collectionId,p]),a.useEffect(()=>{if(!p||Fe!=="all_cards"&&L!=="new_card"){m([]);return}let d=!1;return bs({libraryId:p,limit:200}).then(ve=>{d||m(ve)}).catch(()=>{d||m([])}),()=>{d=!0}},[Fe,p,L]),a.useEffect(()=>{if(!p||!I){P([]),oe(void 0);return}let d=!1;return Te(!0),Gs({libraryId:p,collectionId:I}).then(ve=>{var ot,rt,ft,xt;if(d)return;P(ve);const O=(rt=(ot=A.current.byLibrary)==null?void 0:ot[p])==null?void 0:rt.lastRevisionId,X=((ft=ve.find(Mt=>Mt.revisionId===c.revisionId))==null?void 0:ft.revisionId)??((xt=ve.find(Mt=>Mt.revisionId===O))==null?void 0:xt.revisionId);oe(X)}).catch(()=>{d||(P([]),oe(void 0))}).finally(()=>{d||Te(!1)}),()=>{d=!0}},[c.revisionId,I,p]),a.useEffect(()=>{const d=c.infoId;if(!p||!d){T(void 0);return}let ve=!1;return Gt({libraryId:p,infoId:d}).then(O=>{if(ve)return;const X=O.payload;T((X==null?void 0:X.label)??(X==null?void 0:X.name)??(X==null?void 0:X.title)??O.infoId)}).catch(()=>{ve||T(d)}),()=>{ve=!0}},[c.infoId,p]),a.useEffect(()=>{if(!J.current||c.libraryId&&S.some(X=>X.libraryId===c.libraryId)&&c.libraryId!==p||c.target&&c.target!==L||c.revisionView&&c.revisionView!==ce||c.revisionId&&c.revisionId!==ne||ls[L].requiresCollection&&!I&&c.target==="all_collections"&&c.collectionId)return;const d=va(`${b.pathname}${b.search}`);if(va(b.pathname)==="/cogita"&&!c.libraryId&&!p){R.current=null;return}const O=va(Vs(p,L,I,ce,ne,c.infoId,c.infoView??"overview"));if(d===O){R.current=null;return}R.current!==O&&(R.current=O,l(O,{replace:!0}))},[S,b.pathname,b.search,l,c.collectionId,c.infoId,c.infoView,c.libraryId,c.revisionId,c.revisionView,c.target,I,p,ne,ce,L]),a.useEffect(()=>{if(typeof window>"u")return;const d=()=>{window.innerWidth>920&&x(!1)};return window.addEventListener("resize",d),()=>window.removeEventListener("resize",d)},[]),a.useEffect(()=>{if(!J.current||!xe||!p||Ce.current)return;const d=A.current,ve={...d.byLibrary??{}},O={...ve[p]??{},lastCollectionId:I,lastRevisionId:ne,lastRevisionView:ce,lastTarget:L},X={version:1,lastLibraryId:p,byLibrary:{...ve,[p]:O}},ot=JSON.stringify(d),rt=JSON.stringify(X);if(ot===rt)return;A.current=X,Ce.current=!0,(async()=>{try{if(Re)await On(Re,{plainValue:rt});else{const xt=await qn(xe,{itemName:os,itemType:"data",plainValue:rt});we(xt.dataItemId)}}catch{ze(u.status.savePrefsFailed)}finally{Ce.current=!1}})()},[Re,xe,I,p,ne,ce,L,u.status.savePrefsFailed]);const D=async()=>{const d=De.trim();if(!d){ze(t.cogita.user.libraryNameRequired);return}ze(null);try{const ve=await Hn({name:d});ae(O=>[ve,...O]),W(ve.libraryId),G("library_overview"),$(void 0),Le("")}catch{ze(t.cogita.user.libraryCreateFailed)}},te=async()=>{if(!p){ze(u.status.selectLibraryFirst);return}const d=Ue.trim();if(!d){ze(t.cogita.library.collections.saveRequiredName);return}ze(null);try{const ve=await Un({libraryId:p,name:d,items:[]}),O=await ja({libraryId:p,limit:200});U(O.items),$(ve.collectionId),oe(void 0),G("all_collections"),_e("detail"),et("")}catch{ze(t.cogita.library.collections.saveFail)}},Se=async()=>{if(!p||!I){ze(u.status.selectLibraryFirst);return}const d=Je.trim();if(!d){ze(u.revisionForm.nameLabel);return}ze(null);try{const ve=await Wn({libraryId:p,collectionId:I,name:d,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});P(O=>[ve,...O]),oe(ve.revisionId),G("all_collections"),_e("settings"),ye("")}catch{ze(u.status.loadFailed)}};return e.jsx(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,headerExtra:p?e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:ke,onChange:d=>le(d.target.value),children:[e.jsx("option",{value:"",children:"No person"}),ge.map(d=>e.jsx("option",{value:d.roleId,children:d.label},d.roleId))]})]}):null,children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${be?"open":""}`,"aria-label":u.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{children:(_==null?void 0:_.name)??u.path.noLibrarySelected}),e.jsx("p",{className:"cogita-sidebar-note",children:_?u.sidebar.libraryActionsHint:u.status.selectLibraryFirst}),pt(Et,"sidebar")]}),Rt?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:u.sidebar.infoActionsHint}),pt(Rt,"sidebar"),Ze?e.jsxs("div",{className:"cogita-sidebar-actions-nested",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(Ke==null?void 0:Ke.label)??me??t.cogita.library.list.selectedEmpty}),e.jsx("p",{className:"cogita-sidebar-note",children:u.sidebar.selectedInfoActionsHint}),pt(Ze,"sidebar")]}):null]}):null,Q?e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:Q.name}),e.jsx("p",{className:"cogita-sidebar-note",children:u.sidebar.collectionActionsHint}),pt(gt,"sidebar")]}):null,e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:u.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:i,children:u.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{y("cogita"),x(!1)},children:u.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:o,children:f?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),be?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":u.sidebar.closeMenu,onClick:()=>x(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":u.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>x(d=>!d),"aria-label":be?u.sidebar.closeMenu:u.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),tt.map((d,ve)=>e.jsxs("div",{className:"cogita-browser-segment",children:[ve>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,d.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":d.label,children:d.selectedLabel}):e.jsxs("select",{"aria-label":d.label,value:d.value,onChange:O=>d.onSelect(O.target.value),disabled:d.disabled,children:[d.emptyOption?e.jsx("option",{value:"",children:d.emptyOption}):null,d.options.map(O=>e.jsx("option",{value:O.value,children:O.label},`${d.key}:${O.value}`))]})]},`menu:${d.key}`))]}),wt?e.jsxs(e.Fragment,{children:[L==="new_collection"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.library.actions.createCollection}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{type:"text",value:Ue,onChange:d=>et(d.target.value),placeholder:t.cogita.library.collections.namePlaceholder,disabled:!p})]}),e.jsx("button",{type:"button",className:"cta",onClick:te,disabled:!p,children:t.cogita.library.actions.createCollection}),Ne?e.jsx("p",{className:"cogita-form-error",children:Ne}):null]}):null,L==="all_collections"&&I&&ce==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:u.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:u.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Je,onChange:d=>ye(d.target.value),placeholder:u.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Se,children:u.revisionForm.createAction}),Ne?e.jsx("p",{className:"cogita-form-error",children:Ne}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(nn.Provider,{value:!0,children:wt})})]}):null,wt?null:e.jsx(e.Fragment,{children:p?null:e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:Qe.step}),e.jsx("h2",{children:Qe.title})]}),e.jsxs("p",{children:[He+1," / ",bt]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:Qe.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:Qe.passages.map(d=>e.jsx("p",{children:d},d))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:Qe.focus.map(d=>e.jsx("span",{children:d},d))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:Qe.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:dt.map((d,ve)=>e.jsx("button",{type:"button",className:`ghost ${ve===He?"active":""}`,onClick:()=>Ve(ve),"aria-label":`${ve+1}`,children:ve+1},`tutorial:${d.title}:${ve}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:He===0,onClick:()=>Ve(d=>Math.max(0,d-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:He===bt-1,onClick:()=>Ve(d=>Math.min(bt-1,d+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:De,onChange:d=>Le(d.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:D,children:t.cogita.user.createLibraryAction}),Ne?e.jsx("p",{className:"cogita-form-error",children:Ne}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),S.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,S.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:S.map(d=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{nt({libraryId:d.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:d.name})]},d.libraryId))}):null]})]})]})})]})]})})}const lr=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:sr},Symbol.toStringTag,{value:"Module"}));function nr({copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,shareId:l}){const[b,c]=a.useState(null),[u,S]=a.useState("loading"),[ae,Y]=a.useState(t.cogita.library.collections.defaultName),[U,k]=a.useState("Cogita Library"),[m,de]=a.useState([]),[P,p]=a.useState([]),[W,L]=a.useState("idle"),[G,I]=a.useState({current:0,total:0}),[$,ne]=a.useState(0),[oe,ce]=a.useState(""),[_e,me]=a.useState(null),[T,be]=a.useState(null),[x,V]=a.useState(null),[fe,H]=a.useState(null),[F,je]=a.useState([]),[Te,Ne]=a.useState({}),[ze,Ie]=a.useState({}),[Ve,De]=a.useState(null),[Le,Ue]=a.useState(null),[et,Je]=a.useState(null),[ye,ge]=a.useState(null),[ie,ke]=a.useState({}),le=a.useRef(0),[xe,Be]=a.useState(null),Re=a.useRef(null),we=a.useRef(null),[A,J]=a.useState(null),[Ce,R]=a.useState(!1),[_,Q]=a.useState(null),[se,Z]=a.useState([]),[Pe,Fe]=a.useState(null),Oe=a.useRef(null),Ee=a.useRef(null),[Ke,Me]=a.useState(null),[lt,We]=a.useState(0),Xe=a.useRef(null),dt=a.useRef({}),[bt,He]=a.useState(!1),[Qe,Ct]=a.useState({}),ut=a.useRef(null),Lt=a.useRef(new Set),ct=a.useRef({}),[nt,$t]=a.useState([]),[yt,tt]=a.useState(new Set),[at,Et]=a.useState(!1),Rt=Va(),Ze=a.useMemo(()=>new URLSearchParams(Rt.search),[Rt.search]),gt=a.useMemo(()=>Ze.get("key")??"",[Ze]),pt=(b==null?void 0:b.mode)??"random",wt=(b==null?void 0:b.check)??"exact",D=(b==null?void 0:b.limit)??20,te=a.useMemo(()=>ks((b==null?void 0:b.revisionType)??pt),[b,pt]),Se=a.useMemo(()=>{const C=b==null?void 0:b.revisionSettings,q=ln(te,Ze);return Wa(te,C??q)},[b,Ze,te]),d=a.useMemo(()=>t.cogita.library.revision[te.labelKey]??pt,[t,pt,te]),ve=a.useMemo(()=>wt==="exact"?t.cogita.library.revision.checkValue:wt,[t,wt]),X=u==="ready"?m[$]??null:null,ot=(X==null?void 0:X.checkType)==="translation-match"&&ye,rt=a.useRef(new Map),ft=a.useRef(new Map),xt=a.useRef(new Map),Mt=a.useRef(new Map),ra=a.useMemo(()=>X?X.cardType==="vocab"?t.cogita.library.revision.vocabLabel:X.infoType?Ge(t,X.infoType):t.cogita.library.revision.infoLabel:"",[t,X]),Ht=a.useMemo(()=>{var q;return te.id!=="levels"?m.length:((q=Qe.pool)==null?void 0:q.length)??te.getFetchLimit(D,Se)},[Qe,Se,te,m.length,D]),Bt=te.getProgressTotal?te.getProgressTotal(m,Qe,D,Se):te.id==="levels"?Math.min(D,Ht):m.length,jt=Bt?Math.min($+1,Bt):0,vt=Math.max(1,Number(Se.tries??1)),Dt=Se.compare??"anchors",st=Math.max(0,Math.min(100,Number(Se.minCorrectness??0))),it=(Se.considerDependencies??"on")==="on",Ft=Math.max(0,Math.min(100,Number(Se.dependencyThreshold??85))),Jt=C=>{const q=C.slice();for(let r=q.length-1;r>0;r-=1){const h=Math.floor(Math.random()*(r+1));[q[r],q[h]]=[q[h],q[r]]}return q},Qt=C=>C.length?C.reduce((r,h)=>r+h,0)/C.length/255*100:0,oa=C=>Qt(C)>=st,Ha=async()=>{const C=await qt(),q=new Map,r=new Map;C.forEach(v=>{const B=`${v.itemType}:${v.itemId}`,w=Vt(v.itemType,v.itemId,v.checkType,v.direction);q.has(B)||q.set(B,[]),q.get(B).push(v),r.has(w)||r.set(w,[]),r.get(w).push(v)});const h=new Map,j=new Map;return q.forEach((v,B)=>h.set(B,Ot(v).score)),r.forEach((v,B)=>j.set(B,Ot(v).score)),{itemKnowness:h,cardKnowness:j}},ba=async C=>{const q=Qe,r=C.concat(q.active??[]).concat(q.pool??[]).filter((z,ee,re)=>re.findIndex(pe=>he(pe)===he(z))===ee);if(!it){tt(new Set(r.map(he)));return}const{itemKnowness:h,cardKnowness:j}=await Ha(),v=z=>{if(z.cardType!=="info"||z.infoType!=="citation"||z.checkType!=="quote-fragment")return!0;const ee=It(z.direction);if(!(ee!=null&&ee.fragmentId))return!0;const re=z.description??"";if(!re.trim())return!0;const ue=ia(re).nodes[ee.fragmentId];if(!ue||!ue.leftId&&!ue.rightId)return!0;const $e=[ue.leftId,ue.rightId].filter(Ye=>!!Ye);if($e.length===0)return!0;const Ae=$e.map(Ye=>{const ht=Vt("info",z.cardId,"quote-fragment",Na(ee.mode,Ye));return j.get(ht)??0});return Ae.reduce((Ye,ht)=>Ye+ht,0)/Ae.length>=Ft},B=(b==null?void 0:b.collectionId)??null,w=B?nt.filter(z=>mt(z.childItemType)==="collection"&&z.childItemId===B&&!mt(z.childCheckType)&&!mt(z.childDirection)):[],K=B&&r.length>0?r.reduce((z,ee)=>z+(j.get(he(ee))??0),0)/r.length:0,M=new Set;for(const z of r){if(z.cardType!=="info"){M.add(he(z));continue}if(!v(z))continue;const ee=nt.filter(ue=>fn(ue,z)).concat(w);if(ee.length===0){M.add(he(z));continue}let re=0;for(const ue of ee)if(mt(ue.parentItemType)==="collection")re+=ue.parentItemId===B?K:0;else if(mt(ue.parentCheckType)||mt(ue.parentDirection)){const $e=mt(ue.parentCheckType),Ae=mt(ue.parentDirection),qe=Vt(ue.parentItemType,ue.parentItemId,$e,Ae);re+=j.get(qe)??0}else{const $e=`${ue.parentItemType}:${ue.parentItemId}`;re+=h.get($e)??0}re/ee.length>=Ft&&M.add(he(z))}tt(M)},Qa=C=>{for(let q=C;q<m.length;q+=1){const r=m[q];if(r&&(!it||r.cardType!=="info"||yt.has(he(r))))return q}return-1},ca=C=>!it||C.cardType!=="info"||yt.has(he(C)),Ya=C=>{if(te.id!=="temporal"&&te.id!=="levels")return null;const q=Qe,r=(q.active??[]).concat(q.pool??[]),h=new Set;for(const j of r){const v=he(j);if(!(h.has(v)||C.has(v))&&(h.add(v),ca(j)))return j}return null},At=a.useMemo(()=>{if(te.id!=="levels")return null;const C=Qe,q=C.pool??[],r=C.active??[],h=C.levelMap??{},j=Math.max(1,Number(Se.levels??1)),v=Array.from({length:j},()=>0),B=new Set(r.map(z=>he(z)));q.forEach(z=>{const ee=Math.min(j,Math.max(1,h[he(z)]??1));v[ee-1]+=1});const w=q.length||1,K=v.map(z=>z/w*100),M=X?h[he(X)]??1:null;return{counts:v,percentages:K,currentLevel:M,levelsCount:j,activeCount:r.length,poolCount:q.length,activeSet:B}},[Qe,Se,te,X]),la=a.useMemo(()=>{if(te.id!=="temporal")return null;const C=Qe,q=C.pool??[],r=C.active??[],h=C.knownessMap??{},j=new Set(C.unknownSet??[]);let v=0;q.forEach(K=>{(h[he(K)]??0)>1&&(v+=1)});const B=j.size,w=r.map(K=>({id:he(K),value:j.has(he(K))?0:Math.max(0,Math.min(1,h[he(K)]??0))}));return{knownCount:v,unknownCount:B,dots:w}},[Qe,te]),Kt=a.useMemo(()=>{if(!it)return 0;const C=Qe;return m.concat(C.active??[]).concat(C.pool??[]).filter((r,h,j)=>j.findIndex(v=>he(v)===he(r))===h).filter(r=>r.cardType==="info"&&!yt.has(he(r))).length},[it,Qe,m,yt]);a.useEffect(()=>{if(!it||W!=="ready")return;const C=Qe,r=m.concat(C.active??[]).concat(C.pool??[]).filter((v,B,w)=>w.findIndex(K=>he(K)===he(v))===B).filter(v=>v.cardType!=="info"||yt.has(he(v))).length,h=Oe.current;if(Oe.current=r,h===null||r<=h)return;const j=r-h;Fe(`New card available (+${j})`),Ee.current&&window.clearTimeout(Ee.current),Ee.current=window.setTimeout(()=>Fe(null),2200)},[it,W,Qe,m,yt]),a.useEffect(()=>()=>{Ee.current&&window.clearTimeout(Ee.current)},[]);const kt=(C,q)=>{const r=te.applyOutcome({queue:m,meta:Qe},X,D,Se,{correct:C,correctness:q,createdUtc:new Date().toISOString()});de(r.queue),Ct(r.meta);const h=r.queue[$+1];h&&Pt(h,$+1)};a.useEffect(()=>{if(!l){S("error");return}S("loading"),Qn({shareId:l,key:gt}).then(C=>{c(C),Y(C.collectionName),k(C.libraryName),S("ready")}).catch(()=>{S("error")})},[l,gt]),a.useEffect(()=>{l&&Yn({shareId:l,key:gt,type:"language"}).then(C=>p(C)).catch(()=>p([]))},[l,gt]),a.useEffect(()=>{!l||u!=="ready"||Gn({shareId:l,key:gt}).then(C=>$t(C.items??[])).catch(()=>$t([]))},[l,gt,u]),a.useEffect(()=>{if(!l||u!=="ready")return;let C=!0;return(async()=>{L("loading"),I({current:0,total:te.id==="levels"?0:te.getFetchLimit(D,Se)});try{const r=[];let h=null,j=null;do{const ee=await Jn({shareId:l,key:gt,limit:300,cursor:h});if(r.push(...ee.items),(te.id==="levels"||te.id==="temporal")&&ee.total&&(j=ee.total),I(re=>({current:r.length,total:re.total||ee.total||te.getFetchLimit(D,Se)})),h=ee.nextCursor??null,j!==null&&r.length>=j||te.id!=="levels"&&te.id!=="temporal"&&r.length>=te.getFetchLimit(D,Se))break}while(h);if(!C)return;const v=hs(r);let B;if(te.id==="levels"){const ee=Math.max(1,Number(Se.levels??1));B={},v.forEach(re=>{const pe=he(re);B[pe]=Math.max(1,Math.min(ee,1))})}let w=null,K=null,M=null;if(te.id==="temporal"){const ee=await qt(),re=new Set(v.map($e=>he($e))),pe=ee.reduce(($e,Ae)=>{const qe=Vt(Ae.itemType,Ae.itemId,Ae.checkType,Ae.direction);return re.has(qe)&&($e[qe]||($e[qe]=[]),$e[qe].push(Ae)),$e},{});w={},K=new Set,M={};const ue=Date.now();v.forEach($e=>{const Ae=he($e),qe=pe[Ae]??[];if(qe.length===0){w[Ae]=0,K.add(Ae),M[Ae]=[];return}const Ye=vs(qe);M[Ae]=Ye;const ht=qa(Ye,ue);w[Ae]=ht.knowness})}const z=te.id==="levels"?js(v,D,Se,B):te.id==="temporal"?ws(v,D,Se,w??{},K??new Set,M??{}):te.prepare(v,D,Se);de(z.queue),Ct(z.meta),ne(0),L("ready"),I(ee=>({current:Math.min(ee.current,ee.total),total:ee.total}))}catch{C&&L("error")}})(),()=>{C=!1}},[l,gt,D,te,Se,u]),a.useEffect(()=>{ba(m)},[m,nt,it,Ft,b==null?void 0:b.collectionId]),a.useEffect(()=>{if(!X||!it){Et(!1);return}if(X.cardType!=="info"||yt.has(he(X))){Et(!1);return}const C=Qa($+1);if(C>=0){Et(!1),ne(C);return}if(te.id==="temporal"||te.id==="levels"){const q=m.slice(0,$+1),r=m.slice($+1).filter(ca),h=q.concat(r),j=new Set(h.map(he)),v=Ya(j);if(v){const w=he(v);j.has(w)||(h.push(v),j.add(w),Ct(K=>{const M=K,z=new Set(M.queued??[]);return z.add(w),{...M,queued:z}}))}const B=h.findIndex((w,K)=>K!==$&&ca(w));if(B>=0){de(h),ne(B),Et(!1);return}}Et(!0)},[X,yt,it,$,m,Qe,te.id]),a.useEffect(()=>{if(ce(""),me(null),Me(null),We(0),je([]),Ne({}),Ie({}),De(null),Ue(null),Je(null),R(!1),He(!1),J(null),ge(null),ke({}),!X){be(null),V(null);return}X.cardType==="info"&&X.infoType==="computed"&&be(t.cogita.library.revision.loadingComputed);let C=!0;return Pt(X,$).then(q=>{!C||!q||(be(q.prompt),V(q.expectedAnswer),je(q.computedExpected),Ne(q.computedAnswers),De(q.answerTemplate),Ue(q.outputVariables),Je(q.variableValues))}),()=>{C=!1}},[X,l,t]),a.useEffect(()=>{if(!X||X.cardType!=="info"||X.infoType!=="citation"){ut.current=null,Lt.current=new Set,H(null);return}const C=X.description??"",q=(X.label??"").trim(),r=q.replace(/\s+/g," ").trim(),h=C.replace(/\s+/g," ").trim(),j=r&&r!==h?q:t.cogita.library.infoTypes.citation;if(!C){H(null),V(null);return}const v=ia(C);ut.current=v,be(j);let B=!0;return qt().then(w=>{if(!B)return;const K=getQuoteMode(X.direction),M=new Map;w.forEach(ue=>{if(ue.itemType!=="info"||ue.checkType!=="quote-fragment"||!ue.direction)return;const $e=It(ue.direction);if(!$e||$e.mode!==K)return;const Ae=`${ue.itemId}:${$e.fragmentId}`;M.has(Ae)||M.set(Ae,[]),M.get(Ae).push(ue)});const z={},ee=new Set;M.forEach((ue,$e)=>{const[Ae,qe]=$e.split(":",2);if(Ae!==X.cardId)return;const Ye=Ot(ue).score;z[qe]=Ye,Ye>=Ft&&ee.add(qe)}),Lt.current=ee,ct.current=z;const re=It(X.direction);if(re!=null&&re.fragmentId&&v.nodes[re.fragmentId]){ea(v,re.fragmentId,j);return}const pe=ma(v,ee,z,Ft,it,X.direction);ea(v,(pe==null?void 0:pe.id)??null,j)}).catch(()=>{Lt.current=new Set,ct.current={};const w=It(X.direction);if(w!=null&&w.fragmentId&&v.nodes[w.fragmentId]){ea(v,w.fragmentId,j);return}const K=ma(v,Lt.current,{},Ft,it,X.direction);ea(v,(K==null?void 0:K.id)??null,j)}),()=>{B=!1}},[X,t,it,Ft]),a.useEffect(()=>{if(!X||X.cardType!=="vocab"||X.checkType!=="translation-match"){ge(null),ke({});return}const r=(Qe.pool??Qe.active??m).filter(w=>w.cardType==="vocab"&&w.checkType==="translation-match").filter((w,K,M)=>M.findIndex(z=>z.cardId===w.cardId)===K);r.some(w=>w.cardId===X.cardId)||r.unshift(X);const j=Jt(r).slice(0,6).map(w=>{const K=w.label.split("↔").map(ee=>ee.trim()).filter(Boolean);if(K.length<2)return null;const M=`${w.cardId}:L`,z=`${w.cardId}:R`;return{cardId:w.cardId,leftId:M,rightId:z,leftLabel:K[0],rightLabel:K[1]}}).filter(Boolean),v=j.map(w=>w.leftId),B=Jt(j.map(w=>w.rightId));ge({pairs:j,leftOrder:v,rightOrder:B,selection:{},activeLeft:null,activeRight:null,locked:{}})},[X,m,Qe]),a.useEffect(()=>()=>{Re.current&&window.clearTimeout(Re.current),we.current&&window.clearTimeout(we.current)},[]);const da=a.useRef(null);a.useEffect(()=>{if(!X)return;const C=he(X),q=typeof document<"u"?document.activeElement:null;if(da.current===C&&q&&(q.tagName==="INPUT"||q.tagName==="TEXTAREA"))return;let r=0;const h=()=>{if(X){if(X.cardType==="info"&&X.infoType==="computed"){if(F.length>0){const v=_a(Ve,F,Le),B=v?dt.current[v]:null;if(B&&(B.focus(),document.activeElement===B)){da.current=C;return}}if(Xe.current&&(Xe.current.focus(),document.activeElement===Xe.current)){da.current=C;return}}else if(X.cardType==="vocab"&&Xe.current&&(Xe.current.focus(),document.activeElement===Xe.current)){da.current=C;return}r<6&&(r+=1,window.setTimeout(h,40))}},j=window.setTimeout(h,40);return()=>window.clearTimeout(j)},[X,F,Ve,Le]),a.useEffect(()=>{if(!bt)return;const C=q=>{q.key==="Enter"&&(q.preventDefault(),ua())};return window.addEventListener("keydown",C),()=>window.removeEventListener("keydown",C)},[bt]);const Nt=C=>{Z(C),Q(Ot(C))};a.useEffect(()=>{if(!X){Q(null),Z([]);return}const C=X.cardType==="info"?"info":"connection";if(X.cardType==="info"&&X.infoType==="citation"){qt().then(q=>{const r=q.filter(h=>h.itemType==="info"&&h.itemId===X.cardId&&h.checkType==="quote-fragment"&&Ba(h.direction,X.direction));Nt(r)}).catch(()=>{Q(null),Z([])});return}Ka(C,X.cardId,X.checkType,X.direction).then(q=>Nt(q)).catch(()=>{Q(null),Z([])})},[X]);const Xt=(C,q,r,h)=>{if(C==="info"&&r==="quote-fragment"){qt().then(j=>{const v=j.filter(B=>B.itemType==="info"&&B.itemId===q&&B.checkType==="quote-fragment"&&Ba(B.direction,h));Nt(v)}).catch(()=>{Q(null),Z([])});return}Ka(C,q,r,h).then(j=>Nt(j)).catch(()=>{Q(null),Z([])})},Zt=(C,q,r)=>{var B;const h=((B=r.pairs.find(w=>w.leftId===C))==null?void 0:B.rightId)??null;if(!h)return r;const j=h===q;ke(w=>({...w,[C]:j?"correct":"incorrect"})),Re.current&&window.clearTimeout(Re.current),we.current&&window.clearTimeout(we.current),le.current+=1;const v={kind:j?"correct":"incorrect",tick:le.current};if(Be(null),Re.current=window.setTimeout(()=>Be(v),0),we.current=window.setTimeout(()=>Be(null),420),j){const w={...r.locked,[C]:!0};return Object.keys(w).length>=r.pairs.length?(me("correct"),He(!0)):me("correct"),{...r,selection:{...r.selection,[C]:q},activeLeft:null,activeRight:null,locked:w}}return me("incorrect"),{...r,activeLeft:null,activeRight:null}},Ta=C=>{ge(q=>!q||q.locked[C]?q:q.activeRight?Zt(C,q.activeRight,q):{...q,activeLeft:q.activeLeft===C?null:C})},Ca=C=>{ge(q=>q&&(q.activeLeft?Zt(q.activeLeft,C,q):{...q,activeRight:q.activeRight===C?null:C}))},ua=()=>{var C;if(X&&X.cardType==="info"&&X.infoType==="citation"&&ut.current&&fe&&!((C=It(X.direction))!=null&&C.fragmentId)){const q=ma(ut.current,Lt.current,ct.current,Ft,it,X.direction,fe.fragmentId);if(q){me(null),ce(""),R(!1),Ie({}),He(!1),Me(null),We(0),ea(ut.current,q.id,fe.title);return}}me(null),ce(""),R(!1),Ie({}),He(!1),Me(null),We(0),ne(q=>Math.min(q+1,m.length))},zt=C=>{if(!X)return;const q=C.expected??null,r=C.answer??"";let h=q??"",j=r;if(!q&&C.expectedMap&&C.answerMap){const ee=Object.keys(C.expectedMap).sort((re,pe)=>re.localeCompare(pe));h=ee.map(re=>{var pe;return((pe=C.expectedMap)==null?void 0:pe[re])??""}).join("|"),j=ee.map(re=>{var pe;return((pe=C.answerMap)==null?void 0:pe[re])??""}).join("|")}const v=h?pa(h,j,Dt):new Uint8Array,B={revisionType:te.id,evalType:C.evalType,direction:C.direction,prompt:T??"",expected:q,answer:r,expectedAnswers:C.expectedMap??null,answers:C.answerMap??null,correct:C.correct,maskBase64:v.length?Yt(v):null,checkMode:wt,compareMode:Dt,minCorrectness:st},w=new TextEncoder().encode(JSON.stringify(B)),K=X.cardType==="info"?"info":"connection",M=C.overrideCheckType??X.checkType??null,z=C.overrideDirection??X.direction??null;Fa({itemType:K,itemId:X.cardId,checkType:M,direction:z,revisionType:te.id,evalType:C.evalType,correct:C.correct,maskBase64:v.length?Yt(v):null,payloadBase64:Yt(w)}).then(()=>{Xt(K,X.cardId,M,z),ba(m)}).catch(()=>{})},ha=(C,q)=>{const r=rt.current.get(q);if(r)return Promise.resolve(r);const h=ft.current.get(q);if(h)return h;const j=Xn({shareCode:l,infoId:C,key:gt}).then(v=>{var ee,re;const B=v.payload,w=((ee=B.definition)==null?void 0:ee.graph)??null,K="",M=((re=B.definition)==null?void 0:re.answerTemplate)??"",z=dn(w,K,M);if(z){const ue={sample:un(z),answerTemplate:M||null};return rt.current.set(q,ue),ue}return Cs({shareId:l,infoId:C,key:gt}).then(pe=>{const ue={sample:pe,answerTemplate:null};return rt.current.set(q,ue),ue})}).catch(()=>Cs({shareId:l,infoId:C,key:gt}).then(v=>{const B={sample:v,answerTemplate:null};return rt.current.set(q,B),B}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{ft.current.delete(q)});return ft.current.set(q,j),j},Pt=(C,q)=>{var w;const r=`${he(C)}:${q}`,h=xt.current.get(r);if(h)return Promise.resolve(h);const j=Mt.current.get(r);if(j)return j;const v=K=>(xt.current.set(r,K),K);let B;if(C.cardType==="vocab"){if(C.checkType==="translation-match")return B=Promise.resolve(v({prompt:C.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),B;const K=C.label.split("↔").map(M=>M.trim()).filter(Boolean);if(K.length>=2){const z=(C.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",ee=z?K[0]:K[1],re=z?K[1]:K[0];B=Promise.resolve(v({prompt:ee,expectedAnswer:re,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else B=Promise.resolve(v({prompt:C.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(C.cardType==="info"&&C.infoType==="word"){const K=(w=C.description)!=null&&w.startsWith("Language: ")?C.description.replace("Language: ",""):null;B=Promise.resolve(v({prompt:C.label,expectedAnswer:K,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else C.cardType==="info"&&C.infoType==="computed"?B=ha(C.cardId,r).then(K=>{var pe,ue;if(!K.sample)return v({prompt:C.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const M=K.sample,z=M.expectedAnswers?Object.entries(M.expectedAnswers).map(([$e,Ae])=>({key:$e,expected:Ae})):[],ee=z.reduce(($e,Ae)=>($e[Ae.key]="",$e),{}),re=M.expectedAnswerIsSentence&&((pe=M.expectedAnswer)==null?void 0:pe.trim())||null;return v({prompt:M.prompt,expectedAnswer:z.length>0?re:((ue=M.expectedAnswer)==null?void 0:ue.trim())||null,computedExpected:z,computedAnswers:ee,answerTemplate:K.answerTemplate,outputVariables:M.outputVariables??null,variableValues:M.variableValues??null})}).catch(()=>v({prompt:C.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Mt.current.delete(r)}):B=Promise.resolve(v({prompt:C.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return Mt.current.set(r,B),B},ea=(C,q,r)=>{const h=Object.keys(C.nodes).length,j=Lt.current.size;if(!q){H({title:r,before:C.text,after:"",fragmentId:null,total:h,completed:j}),V(null),He(!0);return}const v=C.nodes[q];if(!v)return;const B=ys(C.text,v);H({title:r,before:B.before,after:B.after,fragmentId:v.id,total:h,completed:j}),V(B.fragment),He(!1)},ya=()=>{const C=ut.current;C&&H(q=>q&&{...q,total:Object.keys(C.nodes).length,completed:Lt.current.size})},_t=()=>{const C=m[$+1];C&&Pt(C,$+1)},Ma=()=>{if(_t(),X&&X.cardType==="vocab"&&X.checkType==="translation-match"&&ye){if(ye.pairs.length===0){me("incorrect"),He(!0);return}const v=ye.pairs.reduce((re,pe)=>(re[pe.rightId]=pe.rightLabel,re),{});let B=0;const w={};ye.pairs.forEach(re=>{const ue=ye.selection[re.leftId]===re.rightId;w[re.leftId]=ue?"correct":"incorrect",ue&&(B+=1)});const K=ye.pairs.length||1,M=B/K,z=B===ye.pairs.length;ke(re=>({...re,...w})),z?(me("correct"),He(!0),We(0)):(me("incorrect"),He(!1),We(re=>{const pe=re+1;return pe>=vt&&(R(!0),He(!0),ge(ue=>{if(!ue)return ue;const $e=ue.pairs.reduce((Ae,qe)=>(Ae[qe.leftId]=qe.rightId,Ae),{});return{...ue,selection:$e}})),pe})),kt(z,M);const ee="connection";Promise.all(ye.pairs.map(re=>{const pe=ye.selection[re.leftId]??null,ue=pe?v[pe]:"",$e={left:re.leftLabel,expected:re.rightLabel,answer:ue,checkType:"translation-match"},Ae=new TextEncoder().encode(JSON.stringify($e));return Fa({itemType:ee,itemId:re.cardId,checkType:"translation-match",direction:null,revisionType:te.id,evalType:"translation-match",correct:pe===re.rightId,maskBase64:null,payloadBase64:Yt(Ae)})})).then(()=>{Xt(ee,X.cardId,X.checkType,X.direction),ba(m)}).catch(()=>{});return}if(F.length>0){const v=F.reduce((w,K)=>{const M=Te[K.key]??"";return w[K.key]=St(M)===St(K.expected)?"correct":"incorrect",w},{});F.every(({key:w,expected:K})=>{const M=Te[w]??"";return wt==="exact"&&St(M)===St(K)})?(me("correct"),Ie(v),He(!0),We(0),kt(!0,1),zt({correct:!0,direction:T?`${T} -> computed`:"computed",expectedMap:F.reduce((w,K)=>(w[K.key]=K.expected,w),{}),answerMap:Te,evalType:"computed"})):(me("incorrect"),Ie(v),He(!1),We(w=>{const K=w+1;return K>=vt&&ta&&(R(!0),He(!0)),K}),kt(!1,0),window.setTimeout(()=>{var K;const w=_a(Ve,F,Le);w&&dt.current[w]&&((K=dt.current[w])==null||K.focus())},40),zt({correct:!1,direction:T?`${T} -> computed`:"computed",expectedMap:F.reduce((w,K)=>(w[K.key]=K.expected,w),{}),answerMap:Te,evalType:"computed"}));return}if(X&&X.cardType==="info"&&X.infoType==="citation"&&(fe!=null&&fe.fragmentId)){if(!x)return;const v=It(X.direction),B=(v==null?void 0:v.mode)??getQuoteMode(X.direction),w=v!=null&&v.fragmentId&&X.direction?X.direction:Na(B,fe.fragmentId),K=pn(x,oe,Dt),M=wt==="exact"&&fa(oe)===fa(x),z=oa(K),ee=M||z,re=Qt(K);ee?(ct.current[fe.fragmentId]=Math.max(ct.current[fe.fragmentId]??0,re),(ct.current[fe.fragmentId]??0)>=Ft&&Lt.current.add(fe.fragmentId),ya(),me("correct"),Ie({}),He(!0),Me(K),We(0),re<100&&vt<=1&&R(!0),kt(!0,re/100),zt({correct:!0,direction:`quote:${fe.fragmentId}`,expected:x,answer:oe,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:w})):(me("incorrect"),Ie({}),He(!1),Me(K),We(pe=>{const ue=pe+1;return ue>=vt&&ta&&(R(!0),He(!0)),ue}),kt(!1,re/100),window.setTimeout(()=>{var pe;return(pe=Xe.current)==null?void 0:pe.focus()},40),zt({correct:!1,direction:`quote:${fe.fragmentId}`,expected:x,answer:oe,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:w}));return}if(!x)return;const C=pa(x,oe,Dt),q=wt==="exact"&&St(oe)===St(x),r=oa(C),h=q||r,j=Qt(C);h?(me("correct"),Ie({}),He(!0),Me(C),We(0),j<100&&vt<=1&&R(!0),kt(!0,j/100),zt({correct:!0,direction:T?`${T} -> ${x}`:null,expected:x,answer:oe,evalType:"text"})):(me("incorrect"),Ie({}),He(!1),Me(C),We(v=>{const B=v+1;return B>=vt&&ta&&(R(!0),He(!0)),B}),kt(!1,j/100),window.setTimeout(()=>{var v;return(v=Xe.current)==null?void 0:v.focus()},40),zt({correct:!1,direction:T?`${T} -> ${x}`:null,expected:x,answer:oe,evalType:"text"}))},ga=C=>{if(_t(),!x)return;const q=pa(x,C,Dt),r=St(C)===St(x),h=oa(q),j=r||h,v=Qt(q);j?(me("correct"),Ie({}),He(!0),Me(q),We(0),v<100&&vt<=1&&R(!0),kt(!0,v/100),zt({correct:!0,direction:"word->language",expected:x,answer:C,evalType:"language-select"})):(me("incorrect"),Ie({}),He(!1),Me(q),We(B=>{const w=B+1;return w>=vt&&ta&&(R(!0),He(!0)),w}),kt(!1,v/100),zt({correct:!1,direction:"word->language",expected:x,answer:C,evalType:"language-select"}))},Ia=C=>{var r;if(C.key!=="Enter")return;if(C.preventDefault(),C.stopPropagation(),bt){ua();return}const q=F.find(h=>!(Te[h.key]??"").trim());if(q){(r=dt.current[q.key])==null||r.focus();return}Ma()},Ga=()=>{_t(),me("correct"),He(!0),We(0),kt(!0,1),x&&zt({correct:!0,direction:"manual",expected:x,answer:oe,evalType:"manual"})},Ja=()=>{if(kt(!1,0),X&&X.cardType==="info"&&X.infoType==="citation"){me(null),ce(""),R(!1),Ie({}),He(!1),Me(null),We(0),ne(C=>Math.min(C+1,m.length));return}ua()};a.useEffect(()=>{_t()},[$,m]);const Xa=t.cogita.library.revision.revealModeAfterIncorrect,ta=F.length>0||!!x;return e.jsxs(Tt,{copy:t,authLabel:s,showProfileMenu:n,onProfileNavigate:i,onToggleSecureMode:o,onLogout:g,secureMode:f,onNavigate:y,language:E,onLanguageChange:N,children:[(u==="loading"||W==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:u==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${G.total?Math.min(100,Math.max(0,G.current/G.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:G.total?`${Math.min(G.current,G.total)} / ${G.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:ae}),e.jsx("p",{className:"cogita-library-subtitle",children:U}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",d).replace("{check}",ve)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:_?`${_.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[At?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",At.currentLevel??"-"," / ",At.levelsCount]}):null,_?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(_.correct)).replace("{total}",String(_.total))}),_.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(_.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(hn,{outcomes:se})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[Pe?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:Pe})}):null,e.jsx("section",{className:"cogita-revision-card","data-feedback":xe?`${xe.kind}-${xe.tick}`:ot?"idle":_e??"idle",children:u!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:u==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):X?e.jsx(e.Fragment,{children:at?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(xs,{copy:t,currentCard:X,currentTypeLabel:ra,prompt:T,languages:P,answer:oe,onAnswerChange:C=>ce(q=>Da(q,C,A)),computedExpected:F,computedAnswers:Te,onComputedAnswerChange:(C,q)=>Ne(r=>({...r,[C]:Da(r[C]??"",q,A)})),answerTemplate:Ve,outputVariables:Le,variableValues:et,computedFieldFeedback:ze,feedback:_e,canAdvance:bt,quoteContext:fe,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Ma,onSkip:Ja,onLanguageSelect:ga,onMarkReviewed:Ga,onAdvance:ua,showCorrectAnswer:Ce,setShowCorrectAnswer:R,onRevealCorrect:()=>He(!0),answerMask:Ke,expectedAnswer:x,hasExpectedAnswer:ta,handleComputedKeyDown:Ia,answerInputRef:Xe,computedInputRefs:dt,scriptMode:A,setScriptMode:J,matchPairs:ye==null?void 0:ye.pairs,matchLeftOrder:ye==null?void 0:ye.leftOrder,matchRightOrder:ye==null?void 0:ye.rightOrder,matchSelection:ye==null?void 0:ye.selection,matchActiveLeft:ye==null?void 0:ye.activeLeft,matchActiveRight:ye==null?void 0:ye.activeRight,matchFeedback:ie,onMatchLeftSelect:Ta,onMatchRightSelect:Ca})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Bt?`${jt} / ${Bt}`:t.cogita.library.revision.progressUnlimited}),u==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),u==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),u==="ready"&&W==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),u==="ready"&&W==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),u==="ready"&&W==="ready"&&m.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Xa}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",vt]})]})]}),At?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",At.activeCount," / ",At.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:At.counts.map((C,q)=>{const r=q+1,h=At.currentLevel===r,j=At.percentages[q]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":h,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:r}),e.jsx("strong",{children:C})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,j))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[j.toFixed(1),"%"]})]},`level-${r}`)})})]}):null,la?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:la.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:la.dots.map(C=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-C.value))}, ${Math.round(200*C.value)}, 80, 0.9)`}},C.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:la.knownCount})]})]}):null,it?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Kt})]})}):null]})]})]})})})]})]})}const dr=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:nr},Symbol.toStringTag,{value:"Module"}));export{cr as C,lr as a,dr as b};
