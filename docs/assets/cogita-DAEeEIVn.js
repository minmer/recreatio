import{r as n,j as e,u as Wa,a as Pa,b as Gn,c as Yn,d as Xn,R as fn,B as bn,C as yn,Q as Gs}from"./vendor-CAC2WLor.js";import{L as Ys,A as Xs,g as Zs,a as wr,b as Oa,c as Zn,s as gs,d as es,e as kr,f as Mn,h as na,i as Nr,j as Sr,k as sn,l as rn,m as er,n as ts,o as Jn,p as Tr,u as ms,q as as,r as Cr,t as Ir,v as Mr,w as Lr,x as Ar,y as tr,z as Rr,B as ar,C as nr,D as $r,E as Pr,F as xn,G as Ua,H as Er,I as sr,J as Fr,K as ns,M as rr,N as Kr,O as _r,P as Dr,Q as zr,R as Hn,S as ya,T as Br,U as Vr,V as qr,W as Or,X as Ur,Y as Jr,Z as Hr,_ as Wr,$ as Qr,a0 as Gr,a1 as Yr,a2 as ps,a3 as Xr,a4 as fs,a5 as bs,a6 as Zr,a7 as ys,a8 as ei,a9 as ir,aa as ti,ab as ai,ac as ni,ad as Wn,ae as si,af as ri,ag as ii,ah as oi,ai as li}from"./recreatio-core-BQsNPQ_b.js";import"./vendor-cogita-ui-DTaQ_FiW.js";const Ba={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},Da={moveMs:900,pauseMs:220,errorMs:900},ci=(t=11)=>{let a=t;const s=()=>(a=(a*1664525+1013904223)%4294967296,a/4294967296),{width:r,height:i,paddingX:u,paddingY:o,levels:j}=Ba,h=(i-o*2)/(j.length-1),b=[],c=[],p=[];j.forEach((v,f)=>{const J=i-o-f*h,L=r-u*2,w=[];for(let K=0;K<v;K+=1){const S=u+(K+1)*L/(v+1),G=(s()-.5)*18,_=Math.max(u,Math.min(r-u,S+G)),A=f===0?3:f<2?2.1:1.4,O=f===0?"root":`l${f}-${K}`;w.push({id:O,x:f===0?r/2:_,y:J,r:A,level:f,role:f===0?"root":void 0})}p.push(w),b.push(...w)});const l=p[p.length-1];if(l!=null&&l.length){const v=l[Math.floor(l.length/2)];v.role="goal",v.r=2}for(let v=1;v<p.length;v+=1){const f=p[v-1];p[v].forEach(L=>{const w=[...f].sort((_,A)=>Math.abs(_.x-L.x)-Math.abs(A.x-L.x)),K=w[0],S=w[1]&&s()<.45?w[1]:null;(S?[K,S]:[K]).forEach(_=>{c.push({from:_.id,to:L.id,key:`${_.id}-${L.id}`})}),s()<.2&&w[2]&&c.push({from:w[2].id,to:L.id,key:`${w[2].id}-${L.id}`})})}const d=new Map;c.forEach(v=>{const f=d.get(v.to)??[];f.push(v.from),d.set(v.to,f)});const k=new Map,m=new Map,N=new Map;c.forEach(v=>{const f=k.get(v.from)??[];f.push(v.key),k.set(v.from,f);const J=m.get(v.from)??[];J.push(v.to),m.set(v.from,J);const L=N.get(v.from)??[];L.push(v.to),N.set(v.from,L);const w=N.get(v.to)??[];w.push(v.from),N.set(v.to,w)});const C=new Map;return b.forEach(v=>{C.set(v.id,v)}),{nodes:b,links:c,parentsById:d,linksByFrom:k,childrenByFrom:m,neighborsById:N,nodesById:C}};function di({slides:t,activeIndex:a,introOpen:s,prefersReducedMotion:r,onNext:i,onPrev:u,onSelect:o,onExit:j,onOpen:h,onRegister:b}){const c=a===t.length-1,p=s&&a===0?"entry":"docked",l=t[t.length-1],[d,k]=n.useState(!1),m=n.useMemo(()=>Array.from({length:20},(Y,pe)=>({src:`/cogita/logo/Cogita${String(pe).padStart(2,"0")}.png`,kind:pe<=11?"bubble":pe<=17?"text":"recreatio"})),[]),N=s&&a===0;n.useEffect(()=>{if(!s){k(!1);return}a>0&&!d&&k(!0)},[a,s,d]);const C=n.useRef(0),v=n.useRef(null),f=n.useMemo(()=>{const Y={x:40,y:160},pe={x:260,y:48},T=6,I=pe.x-Y.x,x=Y.y-pe.y,F=I/T,H=[.3,.45,.6,.65,1.4,2.2],fe=H.reduce((re,W)=>re+W,0),q=H.map(re=>x*re/fe),R=[Y];let Se=Y.x,Z=Y.y;for(let re=1;re<=T;re+=1){const W=(Math.random()-.5)*14,je=(Math.random()-.5)*28;Se=Math.max(Y.x+re*14,Math.min(pe.x-(T-re)*14,Se+F+W));const he=q[re-1]??q[q.length-1];Z=Z-he+je;const ge=Math.max(pe.y,Math.min(Y.y-4,Z));R.push({x:Math.round(Se),y:Math.round(ge)})}return R[R.length-1]=pe,R},[]),J=n.useMemo(()=>{const x=(fe,q,R)=>Math.min(R,Math.max(q,fe)),F=f.map(fe=>{const q=10+Math.random()*36;return{x:x(fe.x,40,260),y:x(fe.y-q,40,140)}}),H=f.map((fe,q)=>{var Z;const R=12+Math.random()*40,Se=((Z=F[q])==null?void 0:Z.y)??fe.y;return{x:x(fe.x,40,260),y:x(Math.max(Se+10,fe.y+R),60,170)}});return{upper:F,lower:H}},[f]),L=n.useMemo(()=>{var pe;const Y=((pe=f[4])==null?void 0:pe.x)??260;return Math.max(0,Math.min(240,Y-40))},[f]),w=n.useMemo(()=>{var q,R;const Y=(Se,Z,re)=>Math.min(re,Math.max(Z,Se)),pe=(Se,Z,re)=>f.map((W,je)=>{var bt,ut;const he=((bt=J.upper[je])==null?void 0:bt.y)??W.y,ge=((ut=J.lower[je])==null?void 0:ut.y)??W.y,$e=(Math.random()-.5)*70,Ge=W.y+Se+$e,Ve=Y(W.y+Z,he+6,ge-6),Ke=Y(W.y+re,he+6,ge-6);return{x:W.x,y:Y(Ge,Math.min(Ve,Ke),Math.max(Ve,Ke))}}),T=-14+Math.random()*28,I=14+Math.random()*28,x=pe(T,-80,12),F=pe(I,-12,80);for(let Se=4;Se<f.length;Se+=1){const Z=f[Se],re=((q=J.upper[Se])==null?void 0:q.y)??Z.y,W=((R=J.lower[Se])==null?void 0:R.y)??Z.y;x[Se]={x:Z.x,y:Y(Z.y-12,re+6,W-6)},F[Se]={x:Z.x,y:Y(Z.y+12,re+6,W-6)}}const H=J.upper.length?J.upper[J.upper.length-1].y:40,fe=J.lower.length?J.lower[J.lower.length-1].y:170;return x[x.length-1]={x:f[f.length-1].x,y:Y(f[f.length-1].y-14,H,fe)},F[F.length-1]={x:f[f.length-1].x,y:Y(f[f.length-1].y+12,H,fe)},{higher:x,lower:F}},[f,J]),K=1e4,S=n.useMemo(()=>{let Y=17;const pe=()=>(Y=(Y*1664525+1013904223)%4294967296,Y/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((I,x)=>{const F=(pe()-.5)*240,H=(pe()-.5)*180,fe=(pe()-.5)*24;return{id:`card-${x+1}`,throw:{x:`${F.toFixed(0)}px`,y:`${H.toFixed(0)}px`,rot:`${fe.toFixed(1)}deg`},grid:{x:`${I.x}px`,y:`${I.y}px`},delay:`${x*.12}s`}})},[]),G=n.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[_,A]=n.useState([]),O=n.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),de=n.useMemo(()=>{const pe=[],I=(F,H)=>F+Math.random()*(H-F);for(let F=0;F<6;F+=1){let H=!1;for(let fe=0;fe<80;fe+=1){const q=I(14,86),R=I(10,34);if(pe.every(Z=>{const re=Z.x-q,W=Z.y-R;return Math.hypot(re,W)>=12})){pe.push({x:q,y:R}),H=!0;break}}H||pe.push({x:I(16,84),y:I(12,32)})}return pe.map((F,H)=>({id:`p${H+1}`,x:`${F.x.toFixed(1)}%`,y:`${F.y.toFixed(1)}%`,xNum:F.x,yNum:F.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[Ce,Je]=n.useState(0),[ie,$]=n.useState(0),[be,U]=n.useState([]),ce=1e4,Q=n.useMemo(()=>{if(de.length<2)return[];const Y=H=>{let fe=H+1831565813;return fe=Math.imul(fe^fe>>>15,fe|1),fe^=fe+Math.imul(fe^fe>>>7,fe|61),((fe^fe>>>14)>>>0)/4294967296},pe=(H,fe)=>Math.floor(Y(H)*fe),T=new Set,I=[],x=Math.min(3,de.length);let F=0;for(;I.length<x&&F<30;){F+=1;const H=pe(Ce*13+F*5,de.length),fe=pe(Ce*29+F*7,de.length);if(H===fe)continue;const q=H<fe?`${H}-${fe}`:`${fe}-${H}`;T.has(q)||(T.add(q),I.push({id:`link-${q}`,from:de[H],to:de[fe],delay:`${(F*.35).toFixed(2)}s`}))}return I},[Ce,de]);n.useEffect(()=>{if(!s||a!==2)return;const Y=()=>{const T=S.map(I=>I.id);for(let I=T.length-1;I>0;I-=1){const x=Math.floor(Math.random()*(I+1));[T[I],T[x]]=[T[x],T[I]]}return T.slice(0,4)};A(Y());const pe=window.setInterval(()=>{A(Y())},K);return()=>window.clearInterval(pe)},[a,s,S,K]),n.useEffect(()=>{if(!s||a!==3)return;const Y=()=>{$(Math.floor(Math.random()*O.length)),U(de.map(()=>Math.random()<.6?"good":"bad")),Je(T=>T+1)};Y();const pe=window.setInterval(Y,ce);return()=>window.clearInterval(pe)},[a,s,O.length,de,ce]);const xe=n.useMemo(()=>ci(11),[]),[oe,ae]=n.useState(new Set(["root"])),[Me,se]=n.useState(new Set),[Re,Le]=n.useState(new Set),[He,st]=n.useState({fromId:"root",toId:"root",key:0}),V=n.useRef(oe),ye=n.useRef("root"),Qe=n.useRef(0),Ee=n.useRef(null),Ne=n.useRef(null),tt=n.useRef([]);n.useEffect(()=>{V.current=oe},[oe]);const vt=n.useMemo(()=>{const Y=new Set;return oe.forEach(pe=>{const T=xe.linksByFrom.get(pe);T&&T.forEach(I=>Y.add(I))}),Y},[oe,xe]),rt=xe.nodesById.get(He.toId)??xe.nodesById.get("root"),Ae=rt?`${rt.x/Ba.width*100}%`:"50%",ze=rt?`${rt.y/Ba.height*100}%`:"90%";n.useEffect(()=>{if(!s||a!==1||r)return;(()=>{ae(new Set(["root"])),se(new Set),Le(new Set),st({fromId:"root",toId:"root",key:0}),Ne.current=null,Qe.current=0,ye.current="root",tt.current=[]})();const pe=()=>{const I=ye.current,x=V.current,H=(xe.childrenByFrom.get(I)??[]).filter(W=>!x.has(W));if(H.length)return H[Math.floor(Math.random()*H.length)];if(x.size>=xe.nodes.length){const W=xe.neighborsById.get(I)??[];return W.length?W[Math.floor(Math.random()*W.length)]:null}const fe=W=>(xe.childrenByFrom.get(W)??[]).some(he=>!x.has(he)),q=[I],R=new Set([I]),Se=new Map;let Z=null;for(;q.length;){const W=q.shift();if(!W)break;if(W!==I&&fe(W)){Z=W;break}(xe.neighborsById.get(W)??[]).forEach(he=>{R.has(he)||(R.add(he),Se.set(he,W),q.push(he))})}if(!Z)return null;let re=Z;for(;Se.get(re)&&Se.get(re)!==I;)re=Se.get(re)??re;return re},T=(I,x)=>{if(I===x){const F=pe();F&&T(I,F);return}Qe.current+=1,st({fromId:I,toId:x,key:Qe.current}),ye.current=x,Ee.current=window.setTimeout(()=>{const F=xe.parentsById.get(x)??[],H=V.current,fe=F.filter(Z=>!H.has(Z));if(!fe.length){const Z=new Set(H);Z.add(x),ae(Z),Ee.current=window.setTimeout(()=>{for(;tt.current.length;){const W=tt.current[tt.current.length-1];if(!Z.has(W)){if(W!==x){T(x,W);return}break}tt.current.pop()}const re=pe();re&&T(x,re)},Da.pauseMs);return}const q=new Set([x,...fe]),R=new Set(fe.map(Z=>`${Z}-${x}`));se(q),Le(R),tt.current.includes(x)||tt.current.push(x);const Se=fe[Math.floor(Math.random()*fe.length)];Ne.current={fromId:x,toId:Se},Ee.current=window.setTimeout(()=>{se(new Set),Le(new Set);const Z=Ne.current;Z&&T(Z.fromId,Z.toId)},Da.errorMs)},Da.moveMs)};return Ee.current=window.setTimeout(()=>{const I=pe();I&&T(ye.current,I)},Da.pauseMs),()=>{Ee.current&&window.clearTimeout(Ee.current)}},[a,s,xe,r]);const at=Y=>{if(!s)return;const pe=Date.now();pe-C.current<520||Math.abs(Y.deltaY)<10||(C.current=pe,Y.deltaY>0?i():u(),Y.preventDefault())},Ue=Y=>{if(!s)return;const pe=Y.touches[0];pe&&(v.current={x:pe.clientX,y:pe.clientY})},E=Y=>{if(!s)return;const pe=v.current;if(v.current=null,!pe)return;const T=Y.changedTouches[0];if(!T)return;const I=T.clientX-pe.x,x=T.clientY-pe.y;Math.abs(x)<40||Math.abs(x)<Math.abs(I)||(x<0?i():u())};return e.jsxs("div",{className:`cogita-intro ${s?"is-open":"is-closed"} ${r?"is-reduced":""} ${c?"is-final":""}`,"data-slide":a+1,onWheel:at,onTouchStart:Ue,onTouchEnd:E,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":p,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${N&&!d?"is-entry":""}`,children:m.map((Y,pe)=>e.jsx("img",{src:Y.src,alt:"",className:`cogita-logo-layer ${pe===0?"is-base":""} ${Y.kind==="text"?"is-text":Y.kind==="recreatio"?"is-recreatio":""} ${Y.kind==="bubble"?"is-bubble":""}`},Y.src))})}),s&&t.map((Y,pe)=>{const T=pe===a;return e.jsxs("section",{className:`cogita-intro-slide slide-${pe+1} ${T?"is-active":""}`,"aria-hidden":!T,children:[e.jsxs("div",{className:"cogita-intro-text",children:[Y.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:Y.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:Y.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:Y.title}),Y.body&&e.jsx("p",{children:Y.body.split(`
`).map((I,x)=>e.jsxs("span",{children:[I,x===0&&e.jsx("br",{})]},String(x)))})]}),Y.micro&&e.jsx("p",{className:"cogita-intro-micro",children:Y.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:c?b:i,children:Y.cta}),c&&Y.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>o(0),children:Y.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[pe===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${Ba.width} ${Ba.height}`,preserveAspectRatio:"none",children:[xe.links.map(I=>{const x=xe.nodesById.get(I.from),F=xe.nodesById.get(I.to);if(!x||!F)return null;const H=vt.has(I.key),fe=Re.has(I.key);return e.jsx("line",{className:`map-link ${H?"is-active":""} ${fe?"is-error":""}`,x1:x.x,y1:x.y,x2:F.x,y2:F.y},I.key)}),xe.nodes.map(I=>{const x=oe.has(I.id),F=Me.has(I.id);return e.jsx("circle",{className:`map-node ${I.role?`is-${I.role}`:""} ${x?"is-active":""} ${F?"is-error":""}`,cx:I.x,cy:I.y,r:I.r},I.id)})]}),rt&&e.jsx("span",{className:"map-explorer-dot",style:{left:Ae,top:ze,"--move":`${Da.moveMs}ms`}})]}),pe===2&&e.jsx("div",{className:"cogita-index-cards",children:S.map(I=>{const x=_.indexOf(I.id),F=x>=0?G[x]:null,H=(F==null?void 0:F.x)??"140px",fe=(F==null?void 0:F.y)??"140px",q=x>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":I.throw.x,"--throw-y":I.throw.y,"--throw-rot":I.throw.rot,"--grid-x":I.grid.x,"--grid-y":I.grid.y,"--stack-x":H,"--stack-y":fe,"--stack-opacity":q,"--delay":I.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},I.id)})}),pe===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[O.map((I,x)=>e.jsxs("div",{className:`round-card ${x===ie?"is-active":""}`,style:{"--card-x":I.x,"--card-y":I.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},I.id)),O[ie]&&e.jsx("span",{className:"round-ring",style:{"--card-x":O[ie].x,"--card-y":`calc(${O[ie].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:de.map(I=>e.jsx("span",{className:"player-dot",style:{left:I.x,top:I.y,"--jitter-x":I.jitterX,"--jitter-y":I.jitterY,"--breath-delay":I.delay}},I.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:Q.map(I=>e.jsx("line",{className:"round-link",x1:I.from.xNum,y1:I.from.yNum,x2:I.to.xNum,y2:I.to.yNum,style:{"--delay":I.delay}},I.id))}),e.jsx("div",{className:"round-flows",children:de.map((I,x)=>{const F=be[x]??"good",H=O[ie];if(!H)return null;const fe=`calc(${H.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":I.x,"--from-y":I.y,"--to-x":H.x,"--to-y":fe,"--delay":`${x*.12}s`}}),e.jsx("span",{className:`return-dot is-${F}`,style:{"--from-x":H.x,"--from-y":fe,"--to-x":I.x,"--to-y":I.y,"--delay":`${x*.12}s`}}),e.jsx("span",{className:`result-pop is-${F}`,style:{"--at-x":I.x,"--at-y":I.y,"--delay":`${x*.12}s`}})]},`${I.id}-${Ce}`)})})]},`round-${Ce}`),pe===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${f[0].x} ${f[0].y} L${f[1].x} ${f[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${f[1].x} ${f[1].y} L${f[2].x} ${f[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${f[2].x} ${f[2].y} L${f[3].x} ${f[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${f[3].x} ${f[3].y} L${f[4].x} ${f[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${f[4].x} ${f[4].y} L${f[5].x} ${f[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${f[5].x} ${f[5].y} L${f[6].x} ${f[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${L};${L};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${J.upper.map((I,x)=>`${x===0?"M":"L"}${I.x} ${I.y}`).join(" ")} ${J.lower.slice().reverse().map(I=>`L${I.x} ${I.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${J.upper.map((I,x)=>`${x===0?"M":"L"}${I.x} ${I.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${J.lower.map((I,x)=>`${x===0?"M":"L"}${I.x} ${I.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[w.higher.slice(0,6).map((I,x)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${x+1}`,d:`M${I.x} ${I.y} L${w.higher[x+1].x} ${w.higher[x+1].y}`,pathLength:"100"},`peer-1-${x}`)),w.lower.slice(0,6).map((I,x)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${x+1}`,d:`M${I.x} ${I.y} L${w.lower[x+1].x} ${w.lower[x+1].y}`,pathLength:"100"},`peer-2-${x}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${f[0].x/300*100}%`,"--p0y":`${f[0].y/200*100}%`,"--p1x":`${f[1].x/300*100}%`,"--p1y":`${f[1].y/200*100}%`,"--p2x":`${f[2].x/300*100}%`,"--p2y":`${f[2].y/200*100}%`,"--p3x":`${f[3].x/300*100}%`,"--p3y":`${f[3].y/200*100}%`,"--p4x":`${f[4].x/300*100}%`,"--p4y":`${f[4].y/200*100}%`,"--p5x":`${f[5].x/300*100}%`,"--p5y":`${f[5].y/200*100}%`,"--p6x":`${f[6].x/300*100}%`,"--p6y":`${f[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${w.higher[0].x/300*100}%`,"--q0y":`${w.higher[0].y/200*100}%`,"--q1x":`${w.higher[1].x/300*100}%`,"--q1y":`${w.higher[1].y/200*100}%`,"--q2x":`${w.higher[2].x/300*100}%`,"--q2y":`${w.higher[2].y/200*100}%`,"--q3x":`${w.higher[3].x/300*100}%`,"--q3y":`${w.higher[3].y/200*100}%`,"--q4x":`${w.higher[4].x/300*100}%`,"--q4y":`${w.higher[4].y/200*100}%`,"--q5x":`${w.higher[5].x/300*100}%`,"--q5y":`${w.higher[5].y/200*100}%`,"--q6x":`${w.higher[6].x/300*100}%`,"--q6y":`${w.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${w.lower[0].x/300*100}%`,"--q0y":`${w.lower[0].y/200*100}%`,"--q1x":`${w.lower[1].x/300*100}%`,"--q1y":`${w.lower[1].y/200*100}%`,"--q2x":`${w.lower[2].x/300*100}%`,"--q2y":`${w.lower[2].y/200*100}%`,"--q3x":`${w.lower[3].x/300*100}%`,"--q3y":`${w.lower[3].y/200*100}%`,"--q4x":`${w.lower[4].x/300*100}%`,"--q4y":`${w.lower[4].y/200*100}%`,"--q5x":`${w.lower[5].x/300*100}%`,"--q5y":`${w.lower[5].y/200*100}%`,"--q6x":`${w.lower[6].x/300*100}%`,"--q6y":`${w.lower[6].y/200*100}%`}})]})})}),pe===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),pe===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},Y.id)}),!s&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:l.title}),l.body&&e.jsx("p",{children:l.body}),l.micro&&e.jsx("p",{className:"cogita-intro-micro",children:l.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:b,children:l.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:h,children:"Otwórz pokaz"})]})]})})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((Y,pe)=>e.jsx("button",{type:"button",className:`dot ${a===pe?"active":""}`,"aria-label":Y.title,onClick:()=>o(pe)},Y.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:j,children:"Pomiń"})]})]})}const ui=6,hi=4;function gi({copy:t,onAuthAction:a,authLabel:s,showProfileMenu:r,onProfileNavigate:i,onToggleSecureMode:u,onLogout:o,secureMode:j,onNavigate:h,language:b,onLanguageChange:c}){const p=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}h("home")},l=n.useRef(null),d=n.useRef([]),k=n.useMemo(()=>{let U=Date.now()%2147483647;const ce=()=>(U=U*48271%2147483647,U/2147483647);return Array.from({length:ui},(Q,xe)=>{const oe=6+ce()*8,ae=7+ce()*10,Me=6+ce()*9,se=-ce()*oe,Re=-ce()*ae,Le=-ce()*Me,He=.18+ce()*.28,st=12+ce()*18,V=4+ce()*8,ye=(ce()-.5)*3.2,Qe=(ce()-.5)*3.8,Ee=ce()>.5?"alternate":"alternate-reverse",Ne=ce()>.5?"alternate":"alternate-reverse",tt=ce()>.5?"alternate":"alternate-reverse",vt=.18+ce()*.42,rt=30+ce()*60,Ae=-45-ce()*38,ze=188+ce()*32,at=.1+ce()*.2;return{id:`wave-${xe+1}`,style:{"--wave-sway-duration":`${oe}s`,"--wave-scale-duration":`${ae}s`,"--wave-drift-duration":`${Me}s`,"--wave-sway-delay":`${se}s`,"--wave-scale-delay":`${Re}s`,"--wave-drift-delay":`${Le}s`,"--wave-sway-dir":Ee,"--wave-scale-dir":Ne,"--wave-drift-dir":tt,"--wave-scale":`${He}`,"--wave-shift":`${st}%`,"--wave-xshift":`${V}%`,"--wave-x0":`${ye}%`,"--wave-y0":`${Qe}%`,"--wave-opacity":`${vt}`,"--wave-blur":`${rt}px`,"--wave-bottom":`${Ae}%`,"--wave-hue":`${ze}`,"--wave-glow":`${at}`}}})},[]),m=n.useMemo(()=>{let U=Date.now()*3%2147483647;const ce=()=>(U=U*48271%2147483647,U/2147483647);return Array.from({length:hi},(Q,xe)=>{const oe=180+ce()*220,ae=220+ce()*280,Me=-ce()*oe,se=-ce()*ae,Re=.12+ce()*.22,Le=3+ce()*7,He=1+ce()*3,st=(ce()-.5)*2.8,V=(ce()-.5)*2.2;return{id:`mesh-${xe+1}`,seed:1e3+xe*991+Math.floor(ce()*999),style:{"--mesh-sway-duration":`${oe}s`,"--mesh-drift-duration":`${ae}s`,"--mesh-sway-delay":`${Me}s`,"--mesh-drift-delay":`${se}s`,"--mesh-scale":`${Re}`,"--mesh-shift":`${Le}%`,"--mesh-xshift":`${He}%`,"--mesh-x0":`${V}%`,"--mesh-y0":`${st}%`}}})},[]),N=n.useMemo(()=>{const U=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],ce=t.cogita.introSlides,Q=new Map(ce.map(xe=>[xe.id,xe]));return U.map(xe=>{var ae;const oe=Q.get(xe.id);return{...xe,...oe,title:(oe==null?void 0:oe.title)??"Cogita",cta:(oe==null?void 0:oe.cta)??((ae=t.cogita.introSlides[0])==null?void 0:ae.cta)??t.cogita.loginCta,secondary:oe==null?void 0:oe.secondary}})},[t.cogita.introSlides]),[C,v]=n.useState(0),[f,J]=n.useState(!0),[L,w]=n.useState(!1),K=N.length-1,S=n.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),G=n.useCallback(()=>{S(),a()},[S,a]),_=n.useCallback(()=>{J(!0),v(0)},[]),A=n.useCallback(()=>{J(!1),v(K)},[K]),O=n.useCallback(U=>{v(Math.max(0,Math.min(K,U)))},[K]),de=n.useCallback(()=>{C>=K?G():O(C+1)},[C,O,G,K]),Ce=n.useCallback(()=>{O(C-1)},[C,O]);n.useEffect(()=>{var Q;const U=(Q=window.matchMedia)==null?void 0:Q.call(window,"(prefers-reduced-motion: reduce)");if(!U)return;const ce=()=>w(U.matches);return ce(),U.addEventListener?(U.addEventListener("change",ce),()=>U.removeEventListener("change",ce)):(U.addListener(ce),()=>U.removeListener(ce))},[]),n.useEffect(()=>{if(!f)return;const U=ce=>{const Q=ce.target;if(!Q)return;const xe=Q.tagName;if(!(Q.isContentEditable||xe==="INPUT"||xe==="TEXTAREA"||xe==="SELECT"||xe==="BUTTON"||xe==="A"||Q.closest('button, a, [role="button"], [role="link"]'))){if(ce.key==="Escape"){A();return}if(ce.key==="ArrowLeft"||ce.key==="ArrowUp"){Ce();return}(ce.key==="ArrowRight"||ce.key==="ArrowDown"||ce.code==="Space"||ce.key===" ")&&(ce.preventDefault(),de())}};return window.addEventListener("keydown",U),()=>window.removeEventListener("keydown",U)},[A,de,Ce,f]),n.useEffect(()=>{f&&C===K&&S()},[C,f,K,S]),n.useEffect(()=>{const U=l.current;if(!U)return;const ce=d.current.filter(Ae=>!!Ae);if(!ce.length)return;const Q=1,xe=.6,oe=.6,ae=Math.max(1,Math.min(Q,window.devicePixelRatio||1));let Me=0,se=0,Re=xe,Le=0,He=0;const st=Ae=>{let ze=Ae%2147483647;return ze<=0&&(ze+=2147483646),(at,Ue)=>{ze=ze*48271%2147483647;const E=ze/2147483647;return at+E*(Ue-at)}},V={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},ye=Ae=>{const ze=Math.sin(Ae*12.9898)*43758.5453;return ze-Math.floor(ze)},Qe=Ae=>{const ze=ye(Ae+.1)||1e-4,at=ye(Ae+.7)||1e-4;return Math.sqrt(-2*Math.log(ze))*Math.cos(2*Math.PI*at)},Ee=(Ae,ze)=>{const at=Math.floor(Ae),Ue=at+1,E=Ae-at,Y=E*E*(3-2*E),pe=ye(at*12.9898+ze*78.233),T=ye(Ue*12.9898+ze*78.233);return pe+(T-pe)*Y},Ne=Ae=>{const ze=st(Ae),at=Math.min(4,Math.max(4,Math.floor(Me/1200*V.filamentCount)));return Array.from({length:at},(Ue,E)=>{const Y=Math.max(-1,Math.min(1,Qe(Ae+E*.37))),pe=Math.min(1,Math.max(0,ye(Ae+E*1.31))),T=Math.min(V.depthLayers-1,Math.floor(pe*V.depthLayers));return{seed:ze(0,Math.PI*2)+Ae*.01,offset:Y,freqA:V.freq1*(.75+ze(0,.5)),freqB:V.freq2*(.75+ze(0,.5)),ampA:V.amp1*(.6+ze(0,.7)),ampB:V.amp2*(.6+ze(0,.7)),width:2+E%5*.32,depth:pe,layer:T}})},tt=(Ae,ze,at)=>{const Ue=Math.max(30,Math.floor(Me*se/14e4));Ae.save(),Ae.globalAlpha=.6;for(let E=0;E<Ue;E+=1){const Y=ye(E*9.1+Me*.11)*ze+at,pe=ye(E*3.7+se*.23)*se,T=1.2+ye(E*5.9)*2.4,I=Ae.createRadialGradient(Y,pe,0,Y,pe,T*2);I.addColorStop(0,"rgba(10, 30, 60, 0.45)"),I.addColorStop(1,"rgba(10, 30, 60, 0)"),Ae.fillStyle=I,Ae.beginPath(),Ae.arc(Y,pe,T*2,0,Math.PI*2),Ae.fill()}Ae.restore()},vt=(Ae,ze)=>{Ae.clearRect(0,0,Me,se);const at=se*V.waveCenter,Ue=V.waveBandPx,E=V.segments,Y=V.colors.filaments,pe=Le||Me,T=0;tt(Ae,pe,T),Ae.strokeStyle=Y,Ae.lineCap="round",Ae.lineJoin="round";for(let I=0;I<ze.length;I+=1){const x=ze[I],F=x.offset*Ue*(.85+ye(x.seed)*.4),H=1-Math.min(1,Math.abs(F)/Ue),fe=Math.exp(-Math.pow(F/V.crestThickness,2)),q=x.layer===0?1.1:x.layer===1?.85:.6,R=.35+(1-x.depth)*.65,Se=H*R*q*(.34+fe*.45);Ae.globalAlpha=Se,Ae.lineWidth=x.width*(1+(1-x.depth)*.8);const Z=[];for(let W=0;W<=E;W+=1){const je=W/E*pe+T,he=(Ee(je*.012,x.seed)-.5)*V.xJitter,ge=je+he,$e=(Ee(ge*x.freqA,x.seed)-.5)*V.jitterA,Ge=(Ee(ge*x.freqB,x.seed*1.7)-.5)*V.jitterB,Ve=at+Math.sin(ge*x.freqA+x.seed)*x.ampA+Math.sin(ge*x.freqB+x.seed*1.3)*x.ampB+F+$e+Ge;Z.push({x:ge,y:Ve})}Ae.beginPath(),Ae.moveTo(Z[0].x,Z[0].y);for(let W=1;W<Z.length-1;W+=1){const je=(Z[W].x+Z[W+1].x)/2,he=(Z[W].y+Z[W+1].y)/2;Ae.quadraticCurveTo(Z[W].x,Z[W].y,je,he)}const re=Z[Z.length-1];Ae.quadraticCurveTo(re.x,re.y,re.x,re.y),Ae.stroke()}Ae.save(),Ae.globalCompositeOperation="lighter",Ae.strokeStyle=V.colors.glow,Ae.lineCap="round",Ae.lineJoin="round";for(let I=0;I<ze.length;I+=1){const x=ze[I];if(Math.abs(x.offset)*Ue>V.crestThickness)continue;const F=V.glowAlpha*(.7+(1-x.depth)*.6);Ae.globalAlpha=F,Ae.lineWidth=1.6+(1-x.depth)*1.2;const H=[];for(let q=0;q<=E;q+=1){const R=q/E*pe+T,Se=Math.sin(R*.02+x.seed)*3,Z=at+Math.sin(R*x.freqA+x.seed)*x.ampA+Math.sin(R*x.freqB+x.seed*1.3)*x.ampB+x.offset*Ue*.35+Se;H.push({x:R,y:Z})}Ae.beginPath(),Ae.moveTo(H[0].x,H[0].y);for(let q=1;q<H.length-1;q+=1){const R=(H[q].x+H[q+1].x)/2,Se=(H[q].y+H[q+1].y)/2;Ae.quadraticCurveTo(H[q].x,H[q].y,R,Se)}const fe=H[H.length-1];Ae.quadraticCurveTo(fe.x,fe.y,fe.x,fe.y),Ae.stroke()}Ae.restore()},rt=()=>{Me=Math.floor(U.clientWidth),se=Math.floor(U.clientHeight),Le=Math.floor(Me*1.8),He=se,Re=Me<820?oe:xe,ce.forEach(Ae=>{const ze=Ae.getContext("2d");if(!ze)return;Ae.width=Math.floor(Le*ae*Re),Ae.height=Math.floor(He*ae*Re),Ae.style.width=`${Le}px`,Ae.style.height=`${He}px`,Ae.style.left=`${-(Le-Me)/2}px`,ze.setTransform(ae*Re,0,0,ae*Re,0,0);const at=Number(Ae.dataset.seed||1),Ue=Ne(at);vt(ze,Ue)})};return rt(),window.addEventListener("resize",rt,{passive:!0}),()=>window.removeEventListener("resize",rt)},[m]);const Je=N[Math.min(C,N.length-1)],ie=f?Je:N[N.length-1],$=(ie==null?void 0:ie.theme)??N[0].theme,be={"--cogita-bg0":$.bg0,"--cogita-bg1":$.bg1,"--cogita-bg2":$.bg2,"--cogita-bloom":$.bloom,"--cogita-sat":$.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:p,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Ys,{value:b,onChange:c}),e.jsx(Xs,{copy:t,label:s,isAuthenticated:r,secureMode:j,onLogin:a,onProfileNavigate:i,onToggleSecureMode:u,onLogout:o,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:l,className:"cogita-section cogita-home",style:be,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[m.map((U,ce)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:U.style,"data-seed":U.seed,ref:Q=>{d.current[ce]=Q}},U.id)),k.map(U=>e.jsx("div",{className:"cogita-home-wave",style:U.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},U.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(di,{slides:N,activeIndex:C,introOpen:f,prefersReducedMotion:L,onNext:de,onPrev:Ce,onSelect:O,onExit:A,onOpen:_,onRegister:G})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const Jo=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:gi},Symbol.toStringTag,{value:"Module"})),or=n.createContext(!1);function $t({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,headerExtra:c,children:p}){if(n.useContext(or))return e.jsx(e.Fragment,{children:p});const d=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}j("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:d,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Ys,{value:h,onChange:b}),e.jsxs("div",{className:"cogita-header-right",children:[c,e.jsx(Xs,{copy:t,label:a,isAuthenticated:s,secureMode:o,onLogin:()=>j("home"),onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:p}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function ua(t){const[a,s]=n.useState("Cogita library"),[r,i]=n.useState(null);return n.useEffect(()=>{let u=!1;return Zs().then(o=>{if(u)return;const j=o.find(h=>h.libraryId===t);j&&s(j.name)}).catch(()=>{u||s("Cogita library")}),()=>{u=!0}},[t]),n.useEffect(()=>{let u=!1;return wr(t).then(o=>{u||i(o)}).catch(()=>{u||i(null)}),()=>{u=!0}},[t]),{libraryName:a,stats:r}}function xs({slices:t}){const a=t.reduce((r,i)=>r+Math.max(0,i.value),0),s=n.useMemo(()=>{if(a<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let r=0;return`conic-gradient(${t.map(u=>{const j=Math.max(0,u.value)/a*360,h=r,b=r+j;return r=b,`${u.color} ${h}deg ${b}deg`}).join(",")})`},[t,a]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:s}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(r=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:r.color}}),e.jsx("strong",{children:r.value}),e.jsx("small",{children:r.label})]},r.label))})]})}function mi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,libraryId:c}){const{libraryName:p,stats:l}=ua(c),[d,k]=n.useState("infos"),[m,N]=n.useState(0),[C,v]=n.useState(0),[f,J]=n.useState(0),L=(l==null?void 0:l.totalInfos)??0,w=(l==null?void 0:l.totalCollections)??0,K=0,S=0,G=0,_=Math.max(0,L-G-C),A=Math.max(0,L-C-f);n.useEffect(()=>{let de=!1;return(async()=>{try{const Je=await Oa({libraryId:c,limit:200}),ie=await Promise.all(Je.items.map($=>Zn({libraryId:c,collectionId:$.collectionId}).catch(()=>[])));if(de)return;N(ie.reduce(($,be)=>$+be.length,0))}catch{de||N(0)}})(),()=>{de=!0}},[c]),n.useEffect(()=>{let de=!1;return(async()=>{try{const[Je,ie,$]=await Promise.all([gs({libraryId:c,type:"computed",limit:1}).catch(()=>({total:0})),gs({libraryId:c,type:"source",limit:1}).catch(()=>({total:0})),es({libraryId:c}).catch(()=>({items:[]}))]);if(de)return;v((Je.total??0)+(ie.total??0));const be=new Set($.items.filter(U=>U.childItemType.toLowerCase()==="info").map(U=>U.childItemId).filter(Boolean));J(be.size)}catch{de||(v(0),J(0))}})(),()=>{de=!0}},[c]);const O=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:L},{key:"collections",label:t.cogita.library.overview.stats.collections,value:w},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:m},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:K},{key:"texts",label:t.cogita.library.overview.stats.texts,value:S}];return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:p})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:O.map(de=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${d===de.key?"active":""}`,onClick:()=>k(de.key),children:[e.jsx("span",{children:de.label}),e.jsx("strong",{children:de.value})]},de.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),d==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(xs,{slices:[{label:t.cogita.library.overview.known,value:G,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:_,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:C,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(xs,{slices:[{label:t.cogita.library.overview.availableChecks,value:f,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:A,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const lt=(t,a)=>{const s=t.cogita.library.infoTypes,r=t.cogita.library.connectionTypes,i=t.cogita.library.groupTypes;return{any:s.any,vocab:s.vocab,book:i.book,citation:i.citation,language:s.language,word:s.word,sentence:s.sentence,topic:s.topic,collection:s.collection,person:s.person,institution:s.institution,collective:s.collective,orcid:s.orcid,address:s.address,email:s.email,phone:s.phone,media:s.media,work:s.work,geo:s.geo,music_piece:s.musicPiece,music_fragment:s.musicFragment,source:s.source,question:s.question,computed:s.computed,"word-language":r.wordLanguage,"citation-language":r.citationLanguage,"language-sentence":r.languageSentence,translation:r.translation,"word-topic":r.wordTopic,reference:r.reference,"source-resource":r.sourceResource,"work-contributor":r.workContributor,"work-medium":r.workMedium,"orcid-link":r.orcidLink}[a]??String(a)},pi=t=>[{value:"any",label:lt(t,"any")},{value:"language",label:lt(t,"language")},{value:"word",label:lt(t,"word")},{value:"sentence",label:lt(t,"sentence")},{value:"topic",label:lt(t,"topic")},{value:"collection",label:lt(t,"collection")},{value:"person",label:lt(t,"person")},{value:"institution",label:lt(t,"institution")},{value:"collective",label:lt(t,"collective")},{value:"orcid",label:lt(t,"orcid")},{value:"address",label:lt(t,"address")},{value:"email",label:lt(t,"email")},{value:"phone",label:lt(t,"phone")},{value:"media",label:lt(t,"media")},{value:"work",label:lt(t,"work")},{value:"geo",label:lt(t,"geo")},{value:"music_piece",label:lt(t,"music_piece")},{value:"music_fragment",label:lt(t,"music_fragment")},{value:"source",label:lt(t,"source")},{value:"question",label:lt(t,"question")},{value:"citation",label:lt(t,"citation")},{value:"computed",label:lt(t,"computed")},{value:"vocab",label:lt(t,"vocab")},{value:"book",label:lt(t,"book")},{value:"word-language",label:lt(t,"word-language")},{value:"citation-language",label:lt(t,"citation-language")},{value:"language-sentence",label:lt(t,"language-sentence")},{value:"translation",label:lt(t,"translation")},{value:"word-topic",label:lt(t,"word-topic")},{value:"reference",label:lt(t,"reference")},{value:"source-resource",label:lt(t,"source-resource")},{value:"work-contributor",label:lt(t,"work-contributor")},{value:"work-medium",label:lt(t,"work-medium")},{value:"orcid-link",label:lt(t,"orcid-link")}],fi=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Ln={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},bi={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Ln]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Ln]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId"]},filterFields:[Ln,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text"],connections:[{relationType:"citation-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"citationText",kind:"text",path:"text",matcher:"contains"}]},question:{infoType:"question",entityKind:"single",structure:{payloadFields:["definition"]},filterFields:[{key:"questionType",labelKey:"type",kind:"text",path:"definition.type",matcher:"contains"},{key:"questionText",labelKey:"text",kind:"text",path:"definition.question",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},vs={infoType:"default",entityKind:"single",structure:{payloadFields:["label"]},filterFields:[]};function yi(t){return t?bi[t]??vs:vs}function xi(t,a){return t.optionsSource==="languages"?a.languages.map(s=>({value:s.infoId,label:s.label})):t.optionsSource==="sourceKinds"?fi:[]}const vi="cogita.revision.seed:";function lr(t){return`${vi}${t}`}function ji(t,a){if(typeof window>"u")return null;const s=Array.from(new Set(a.map(u=>u.trim()).filter(Boolean)));if(!s.length)return null;const r=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,i={kind:"info-selection",libraryId:t,infoIds:s,createdAt:new Date().toISOString()};return window.localStorage.setItem(lr(r),JSON.stringify(i)),r}function js(t,a){if(typeof window>"u")return null;const s=window.localStorage.getItem(lr(a));if(!s)return null;try{const r=JSON.parse(s);if(r.kind!=="info-selection"||r.libraryId!==t||!Array.isArray(r.infoIds))return null;const i=r.infoIds.map(u=>String(u??"").trim()).filter(Boolean);return i.length?{infoIds:i}:null}catch{return null}}const wi="cogita.collection-draft:";function cr(t){return`${wi}${t}`}function ki(t,a){if(typeof window>"u")return null;const s=Array.from(new Set(a.map(u=>u.trim()).filter(Boolean)));if(!s.length)return null;const r=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,i={kind:"info-selection",libraryId:t,infoIds:s,createdAt:new Date().toISOString()};return window.localStorage.setItem(cr(r),JSON.stringify(i)),r}function Ni(t,a){if(typeof window>"u")return null;const s=window.localStorage.getItem(cr(a));if(!s)return null;try{const r=JSON.parse(s);if(r.kind!=="info-selection"||r.libraryId!==t||!Array.isArray(r.infoIds))return null;const i=r.infoIds.map(u=>String(u??"").trim()).filter(Boolean);return i.length?{infoIds:i}:null}catch{return null}}const An=60,Si=500;function dr(t){return`cogita.info-selection:${t}`}function ws(t){if(typeof window>"u")return{};const a=window.localStorage.getItem(dr(t));if(!a)return{};try{const s=JSON.parse(a);return!s||typeof s!="object"?{}:s}catch{return{}}}function Ti({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,libraryId:c,mode:p}){var Ut;const l=Wa(),d=Pa(),k=t.cogita.library.list,[m,N]=n.useState("any"),[C,v]=n.useState(""),[f,J]=n.useState("relevance"),[L,w]=n.useState("details"),[K,S]=n.useState(!1),[G,_]=n.useState("idle"),[A,O]=n.useState([]),[de,Ce]=n.useState(An),[Je,ie]=n.useState(null),[$,be]=n.useState(()=>ws(c)),[U,ce]=n.useState({}),[Q,xe]=n.useState([]),[oe,ae]=n.useState([]),[Me,se]=n.useState(null),[Re,Le]=n.useState(null),[He,st]=n.useState(null),[V,ye]=n.useState("idle"),[Qe,Ee]=n.useState([]),[Ne,tt]=n.useState(""),[vt,rt]=n.useState(null),[Ae,ze]=n.useState("idle"),[at,Ue]=n.useState(null),[E,Y]=n.useState(null),[pe,T]=n.useState("idle"),[I,x]=n.useState([]),[F,H]=n.useState("idle"),fe=n.useMemo(()=>pi(t),[t]),q=n.useMemo(()=>[{value:"relevance",label:k.sortRelevance},{value:"label_asc",label:k.sortLabelAsc},{value:"label_desc",label:k.sortLabelDesc},{value:"type_asc",label:k.sortTypeAsc},{value:"type_desc",label:k.sortTypeDesc}],[k.sortLabelAsc,k.sortLabelDesc,k.sortRelevance,k.sortTypeAsc,k.sortTypeDesc]);n.useEffect(()=>{be(ws(c)),ce({}),S(!1)},[c]),n.useEffect(()=>{es({libraryId:c}).then(D=>st(D)).catch(()=>st({items:[]}))},[c]),n.useEffect(()=>{kr({libraryId:c}).then(D=>Ee(D)).catch(()=>Ee([]))},[c]),n.useEffect(()=>{Mn({libraryId:c,type:"language",filters:{sourceKind:"info"},limit:200}).then(D=>{const g=D.map(ee=>({infoId:ee.infoId??"",infoType:ee.entityType,label:ee.title})).filter(ee=>ee.infoId.length>0);xe(g)}).catch(()=>xe([]))},[c]),n.useEffect(()=>{Mn({libraryId:c,type:"source",filters:{sourceKind:"info"},limit:200}).then(D=>{const g=D.map(ee=>({infoId:ee.infoId??"",infoType:ee.entityType,label:ee.title})).filter(ee=>ee.infoId.length>0);ae(g)}).catch(()=>ae([]))},[c]),n.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(dr(c),JSON.stringify($))},[c,$]);const R=n.useMemo(()=>yi(m==="any"?null:m),[m]),Se=n.useMemo(()=>new URLSearchParams(d.search),[d.search]),Z=n.useMemo(()=>d.pathname.split("/").filter(Boolean),[d.pathname]),re=Z.findIndex(D=>D==="infos"),W=re>=0&&(Z[re+1]??"").trim()||null,je=re>=0?(Z[re+2]??"").trim():"",he=re>=0?je==="checkcards"?"cards":je==="collections"?"collections":"overview":"",ge=W??((Se.get("infoId")??"").trim()||null),$e=W?he:(Se.get("infoView")??"overview").trim(),Ge=$e==="overview"&&!!ge,Ve=$e==="collections"&&!!ge,Ke=n.useMemo(()=>({language:k.typeFilterLanguage,languageA:k.typeFilterLanguageA,languageB:k.typeFilterLanguageB,originalLanguage:k.typeFilterOriginalLanguage,doi:k.typeFilterDoi,sourceKind:k.typeFilterSourceKind,locator:k.typeFilterLocator,citationText:k.typeFilterCitationText}),[k.typeFilterDoi,k.typeFilterLanguage,k.typeFilterLanguageA,k.typeFilterLanguageB,k.typeFilterLocator,k.typeFilterOriginalLanguage,k.typeFilterCitationText,k.typeFilterSourceKind]),bt=n.useMemo(()=>R.filterFields.map(D=>({...D,label:D.labelKey?Ke[D.labelKey]:D.label??D.key,options:xi(D,{languages:Q})})),[Ke,Q,R.filterFields]),ut=n.useMemo(()=>bt.some(D=>(U[D.key]??"").trim().length>0),[bt,U]);n.useEffect(()=>{ce({})},[m]),n.useEffect(()=>{const D={sourceKind:"info"};if(ut)for(const B of bt){const nt=(U[B.key]??"").trim();nt&&(D[B.path??B.key]=nt)}const g=(U.__referenceId??"").trim();g&&(D["link.references"]=g),_("loading");const ee=window.setTimeout(()=>{Mn({libraryId:c,type:m==="any"?void 0:m,query:C.trim()||void 0,filters:D,limit:Si}).then(B=>{const nt=B.map(gt=>({infoId:gt.infoId??"",infoType:gt.entityType,label:gt.title})).filter(gt=>gt.infoId.length>0);O(nt),_("ready")}).catch(()=>{O([]),_("ready")})},240);return()=>window.clearTimeout(ee)},[ut,c,C,m,bt,U]),n.useEffect(()=>{if(!ge||$e!=="overview"&&$e!=="collections"){se(null),Le(null),ye("idle");return}let D=!1;return ye("loading"),Promise.all([na({libraryId:c,infoId:ge}),Nr({libraryId:c,itemType:"info",itemId:ge}).catch(()=>null)]).then(([g,ee])=>{D||(se(g),Le(ee),ye("ready"))}).catch(()=>{D||(se(null),Le(null),ye("error"))}),()=>{D=!0}},[c,ge,$e]),n.useEffect(()=>{if(!ge||$e!=="collections"){x([]),H("idle");return}let D=!1;return H("loading"),Sr({libraryId:c,infoId:ge}).then(g=>{D||(x(g),H("ready"))}).catch(()=>{D||(x([]),H("error"))}),()=>{D=!0}},[c,ge,$e]),n.useEffect(()=>{if(!ge||$e!=="overview"){Ue(null),Y(null),T("idle");return}let D=!1;return T("loading"),Promise.all([sn({libraryId:c,infoId:ge}),rn({libraryId:c,infoId:ge})]).then(([g,ee])=>{D||(Ue(g),Y(ee),T("ready"))}).catch(()=>{D||(Ue(null),Y(null),T("error"))}),()=>{D=!0}},[c,ge,$e]);const yt=n.useMemo(()=>Me?Qe.filter(D=>D.sourceInfoTypes.some(g=>g.toLowerCase()===Me.infoType.toLowerCase())):[],[Qe,Me]);n.useEffect(()=>{if(!Me){tt("");return}tt(D=>{var g;return D&&yt.some(ee=>ee.approachKey===D)?D:((g=yt[0])==null?void 0:g.approachKey)??""})},[yt,Me]),n.useEffect(()=>{if(!Me||!Ne){rt(null),ze("idle");return}let D=!1;return ze("loading"),er({libraryId:c,infoId:Me.infoId,approachKey:Ne}).then(g=>{D||(rt(g),ze("ready"))}).catch(()=>{D||(rt(null),ze("error"))}),()=>{D=!0}},[c,Ne,Me]);const We=n.useMemo(()=>{const D=A.slice(),g=ee=>lt(t,ee);return f==="relevance"?D:f==="label_asc"?D.sort((ee,B)=>ee.label.localeCompare(B.label)):f==="label_desc"?D.sort((ee,B)=>B.label.localeCompare(ee.label)):f==="type_asc"?D.sort((ee,B)=>ee.infoType===B.infoType?ee.label.localeCompare(B.label):g(ee.infoType).localeCompare(g(B.infoType))):D.sort((ee,B)=>ee.infoType===B.infoType?ee.label.localeCompare(B.label):g(B.infoType).localeCompare(g(ee.infoType)))},[t,A,f]),De=n.useMemo(()=>We.slice(0,de),[We,de]),mt=De.length<We.length,it=n.useMemo(()=>new Set(Object.keys($)),[$]),pt=n.useMemo(()=>Object.values($),[$]),Bt=n.useMemo(()=>{const D=new Map;for(const g of pt)D.set(g.infoType,(D.get(g.infoType)??0)+1);return Array.from(D.entries()).sort((g,ee)=>ee[1]-g[1]||g[0].localeCompare(ee[0]))},[pt]),It=n.useMemo(()=>{if(!ge||!He)return 0;const D=new Set;for(const g of He.items)g.childItemType!=="info"||g.childItemId!==ge||D.add([g.parentItemType,g.parentItemId,g.parentCheckType??"",g.parentDirection??""].join("|"));return D.size},[He,ge]);n.useEffect(()=>{Ce(An);const D=new Set(A.map(g=>g.infoId));ie(g=>g&&D.has(g)?g:null)},[A]);const Nt=D=>{be(g=>({...g,[D.infoId]:{infoId:D.infoId,infoType:D.infoType,label:D.label}}))},Mt=D=>{be(g=>{if(!g[D])return g;const ee={...g};return delete ee[D],ee})},St=(D,g)=>{if(g){Nt(D);return}Mt(D.infoId)},ht=D=>{l(`/cogita/library/${c}/infos/${encodeURIComponent(D)}`,{replace:!0})},Kt=()=>{l(`/cogita/library/${c}/list`,{replace:!0})},ct=()=>{ge&&l(`/cogita/library/${c}/edit/${encodeURIComponent(ge)}`,{replace:!0})},Ze=()=>{const D=ji(c,pt.map(g=>g.infoId));D&&l(`/cogita/library/${c}/revision/run?libraryTarget=revisions&scope=info-selection&seed=${encodeURIComponent(D)}`)},Tt=()=>{const D=ki(c,pt.map(g=>g.infoId));D&&l(`/cogita/library/${c}/collections/new?draft=${encodeURIComponent(D)}&draftType=info-selection`)},Gt=pt.length===1?((Ut=pt[0])==null?void 0:Ut.infoId)??null:null,Ot=k.selectionCount.replace("{count}",String(pt.length)),Vt=p==="collection"?"grid":p==="detail"?"wide":L,ue=Ii(h),Et=Re?Math.max(0,Math.min(100,Math.round((Re.score??0)*100))):0,Zt=Re?Mi(Re,ue):ue.noKnownnessData;return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":Vt,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[Ge?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:ue.kicker}),e.jsx("h2",{className:"cogita-card-title",children:Me?ks(Me.payload,Me.infoType,Me.infoId):ue.loading}),Me?e.jsxs("p",{className:"cogita-card-subtitle",children:[lt(t,Me.infoType)," · ",Me.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:Kt,children:ue.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:ct,disabled:!ge||V!=="ready",children:k.editInfo})]})]}),V==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:ue.loading})}):V==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:ue.loadError})}):Me?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:ue.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[Et,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${Et}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:Zt})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:ue.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(Re==null?void 0:Re.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:ue.correct.replace("{correct}",String((Re==null?void 0:Re.correctReviews)??0)).replace("{total}",String((Re==null?void 0:Re.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:Re!=null&&Re.lastReviewedUtc?`${ue.lastReview}: ${Ci(Re.lastReviewedUtc,h)}`:ue.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:ue.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:It}),e.jsx("p",{className:"cogita-library-hint",children:ue.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:ue.checkcards}),pe==="loading"?e.jsx("p",{className:"cogita-library-hint",children:ue.loadingCheckcards}):pe==="error"?e.jsx("p",{className:"cogita-library-hint",children:ue.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:ue.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(at==null?void 0:at.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:ue.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(E==null?void 0:E.items.length)??0})]})]})]}),yt.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:ue.approach}),e.jsx("select",{value:Ne,onChange:D=>tt(D.target.value),"aria-label":ue.approach,children:yt.map(D=>e.jsx("option",{value:D.approachKey,children:D.label},D.approachKey))})]}),Ae==="loading"?e.jsx("p",{className:"cogita-library-hint",children:ue.loadingApproach}):Ae==="error"?e.jsx("p",{className:"cogita-library-hint",children:ue.loadApproachError}):vt?e.jsx(on,{value:vt.projection,emptyLabel:ue.empty}):e.jsx("p",{className:"cogita-library-hint",children:ue.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:ue.payload}),e.jsx(on,{value:Me.payload,emptyLabel:ue.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:ue.links}),e.jsx(Li,{links:Me.links,emptyLabel:ue.noLinks})]})]})]}):null]})}):null,Ve?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Informacja"}),e.jsx("h2",{className:"cogita-card-title",children:Me?ks(Me.payload,Me.infoType,Me.infoId):ge??""}),e.jsx("p",{className:"cogita-card-subtitle",children:"Collections using this info"})]}),e.jsx("div",{className:"cogita-info-overview-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:Kt,children:"Back to search"})})]}),F==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading collections..."})}):null,F==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load collections."})}):null,F==="ready"&&I.length===0?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"This info is not used in any collection yet."})}):null,F==="ready"&&I.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:I.map(D=>e.jsx("article",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`/#/cogita/library/${c}/collections/${D.collectionId}?libraryTarget=collections`,children:[e.jsx("div",{className:"cogita-card-type",children:"Collection"}),e.jsx("h3",{className:"cogita-card-title",children:D.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[D.itemCount," items"]})]})},D.collectionId))}):null]})}):null,!Ge&&!Ve?e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":k.typeLabel,value:m,onChange:D=>N(D.target.value),children:fe.map(D=>e.jsx("option",{value:D.value,children:D.label},D.value))}),e.jsx("input",{type:"text",value:C,onChange:D=>v(D.target.value),placeholder:k.searchPlaceholder}),e.jsx("select",{"aria-label":k.sortLabel,value:f,onChange:D=>J(D.target.value),children:q.map(D=>e.jsx("option",{value:D.value,children:D.label},D.value))}),e.jsxs("select",{"aria-label":k.viewLabel,value:L,onChange:D=>w(D.target.value),children:[e.jsx("option",{value:"details",children:k.viewDetails}),e.jsx("option",{value:"wide",children:k.viewWide}),e.jsx("option",{value:"grid",children:k.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:k.cardCount.replace("{shown}",String(De.length)).replace("{total}",String(We.length))}),e.jsx("span",{children:G==="loading"?k.loading:k.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>S(D=>!D),children:K?k.hideFilters:k.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:k.filtersOptionalHint})]}),K?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsxs("div",{className:"cogita-filter-grid",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:k.typeLabel}),e.jsx("select",{value:m,onChange:D=>N(D.target.value),children:fe.map(D=>e.jsx("option",{value:D.value,children:D.label},`advanced-type:${D.value}`))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Reference"}),e.jsxs("select",{value:U.__referenceId??"",onChange:D=>ce(g=>({...g,__referenceId:D.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),oe.map(D=>e.jsx("option",{value:D.infoId,children:D.label},`reference:${D.infoId}`))]})]}),bt.map(D=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:D.label}),D.kind==="select"?e.jsxs("select",{value:U[D.key]??"",onChange:g=>ce(ee=>({...ee,[D.key]:g.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(D.options??[]).map(g=>e.jsx("option",{value:g.value,children:g.label},`${D.key}:${g.value}`))]}):e.jsx("input",{type:"text",value:U[D.key]??"",onChange:g=>ce(ee=>({...ee,[D.key]:g.target.value}))})]},`type-filter:${D.key}`))]})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:Ot}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{be(D=>{const g={...D};for(const ee of De)g[ee.infoId]={infoId:ee.infoId,infoType:ee.infoType,label:ee.label};return g})},disabled:De.length===0,children:k.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>be({}),disabled:pt.length===0,children:k.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Gt&&ht(Gt),disabled:!Gt,title:Gt?void 0:k.openSelectedDisabled,children:k.openSelected})]})]}),Vt==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":k.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:k.detailColumnName}),e.jsx("span",{children:k.detailColumnType}),e.jsx("span",{children:k.detailColumnId}),e.jsx("span",{})]}),De.length?De.map(D=>{const g=lt(t,D.infoType),ee=it.has(D.infoId),B=Je===D.infoId;return e.jsxs("div",{className:`cogita-details-row ${B||ee?"active":""}`,role:"row",onClick:()=>ie(D.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:ee,onChange:nt=>St(D,nt.target.checked),onClick:nt=>nt.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:D.label,children:D.label}),e.jsx("span",{title:g,children:g}),e.jsx("span",{title:D.infoId,children:D.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:nt=>{nt.stopPropagation(),ht(D.infoId)},"aria-label":k.editInfo,children:">"})]},D.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:k.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${Vt}`,"data-view":Vt,children:De.length?De.map(D=>{const g=lt(t,D.infoType),ee=it.has(D.infoId),B=Je===D.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":B||ee,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:ee,onChange:nt=>St(D,nt.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>ie(D.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:g}),e.jsx("h3",{className:"cogita-card-title",children:D.label}),e.jsx("p",{className:"cogita-card-subtitle",children:D.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>ht(D.infoId),children:k.editInfo})]})},D.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:k.noMatch})})}),mt?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>Ce(D=>D+An),children:k.loadMore})}):null,pt.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:k.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:k.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:Bt.map(([D,g])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:lt(t,D)}),e.jsx("span",{className:"cogita-tag-count",children:g})]},`stack:type:${D}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:Ze,disabled:pt.length===0,children:"Start revision"}),e.jsx("button",{type:"button",className:"ghost",onClick:Tt,disabled:pt.length===0,children:"Create collection from selection"})]})]}):null]}):null]})})})})}function ks(t,a,s){if(t&&typeof t=="object"&&!Array.isArray(t)){const r=t,i=["title","name","label","value","text","quote","term"];for(const u of i){const o=r[u];if(typeof o=="string"&&o.trim())return o.trim()}}return`${a} · ${s}`}function Ci(t,a){try{const s=a==="pl"?"pl-PL":a==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(s,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function Ii(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function Mi(t,a){return t.totalReviews<=0?a.noKnownnessData:t.totalReviews<3||t.score<.35?a.developmentStart:t.totalReviews<8||t.score<.65?a.developmentGrowing:t.score<.85?a.developmentStable:a.developmentStrong}function Li({links:t,emptyLabel:a}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:a}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([s,r])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(r)?r.length?e.jsx("div",{className:"cogita-selection-overview",children:r.map(i=>e.jsx("span",{className:"cogita-tag-chip",children:i},`${s}:${i}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):r?e.jsx("span",{className:"cogita-tag-chip",children:r}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},s))})}function on({value:t,emptyLabel:a}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:a});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((s,r)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(on,{value:s,emptyLabel:a})})]},r))});if(typeof t=="object"){const s=Object.entries(t);return s.length===0?e.jsx("p",{className:"cogita-library-hint",children:a}):e.jsx("div",{className:"cogita-info-tree",children:s.map(([r,i])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(on,{value:i,emptyLabel:a})})]},r))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const Na=5,Ns=50,Ss=2,Ts=[];function Xt({libraryId:t,infoType:a,label:s,placeholder:r,value:i,onChange:u,values:o,onChangeMultiple:j,helperText:h,searchFailedText:b,createFailedText:c,createLabel:p,savingLabel:l,loadMoreLabel:d,allowCreate:k=!0,inputRef:m,autoAdvance:N,onCommit:C,multiple:v}){const f=v?o??Ts:Ts,[J,L]=n.useState(v?"":(i==null?void 0:i.label)??""),[w,K]=n.useState([]),[S,G]=n.useState(Na),[_,A]=n.useState(-1),[O,de]=n.useState(!1),[Ce,Je]=n.useState(!1),[ie,$]=n.useState(null),be=n.useRef(0),U=n.useRef(new Map),ce=n.useMemo(()=>k?v?J.trim().length>0:J.trim().length>0&&!i:!1,[k,J,i,v]);n.useEffect(()=>{v||L((i==null?void 0:i.label)??"")},[i,v]),n.useEffect(()=>{const oe=J.trim();if(!oe||oe.length<Ss){K([]),de(!1),G(Na),A(-1),Je(!1),$(null);return}const ae=oe.toLowerCase(),Me=`${t}:${a}:${ae}`,se=U.current.get(Me);if(se){if(v&&f.length>0){const Le=new Set(f.map(He=>He.id));K(se.filter(He=>!Le.has(He.id)))}else K(se);G(Na),A(-1),de(se.length>0),Je(!1),$(null);return}const Re=window.setTimeout(async()=>{const Le=Date.now();be.current=Le,Je(!0),$(null);try{const He=await ts({libraryId:t,type:a,query:oe,limit:Ns});if(be.current!==Le)return;const st=He.slice(0,Ns).map(V=>({id:V.infoId,label:V.label,infoType:V.infoType}));if(U.current.set(Me,st),v&&f.length>0){const V=new Set(f.map(ye=>ye.id));K(st.filter(ye=>!V.has(ye.id)))}else K(st);G(Na),A(-1),de(!0)}catch{if(be.current!==Le)return;$(b??"Search failed.")}finally{be.current===Le&&Je(!1)}},250);return()=>window.clearTimeout(Re)},[t,a,J,f]);const Q=oe=>{if(v){const ae=f.some(Me=>Me.id===oe.id)?f:[...f,oe];j==null||j(ae),L(""),de(!1),A(-1);return}u==null||u(oe),L(oe.label),de(!1),A(-1),N&&(C==null||C())},xe=async()=>{const oe=J.trim();if(oe){Je(!0),$(null);try{const ae=await Jn({libraryId:t,infoType:a,payload:{label:oe}}),Me={id:ae.infoId,label:oe,infoType:ae.infoType};if(oe.length>=Ss){const se=`${t}:${a}:${oe.toLowerCase()}`,Re=U.current.get(se)??[];U.current.set(se,[Me,...Re])}if(v){j==null||j([...f,Me]),L(""),de(!1),A(-1);return}u==null||u(Me),de(!1),A(-1),N&&(C==null||C())}catch{$(c??"Create failed.")}finally{Je(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:s}),e.jsx("input",{value:J,placeholder:r,onChange:oe=>{L(oe.target.value),!v&&i&&(u==null||u(null))},onKeyDown:oe=>{if(oe.key==="ArrowDown"){if(oe.preventDefault(),!w.length)return;de(!0),A(ae=>{const Me=Math.min(w.length,S)-1,se=ae<0?0:Math.min(ae+1,Me);return se===Me&&w.length>S?(G(Re=>Math.min(Re+Na,w.length)),Math.min(ae+1,Math.min(w.length,S+Na)-1)):se});return}if(oe.key==="ArrowUp"){if(oe.preventDefault(),!w.length)return;de(!0),A(ae=>ae<=0?0:ae-1);return}if(oe.key==="Enter"){if(oe.preventDefault(),_>=0&&w[_]){Q(w[_]);return}if(ce){xe();return}}},onFocus:()=>{w.length>0&&de(!0)},autoComplete:"off",ref:m})]}),v&&f.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:f.map(oe=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>j==null?void 0:j(f.filter(ae=>ae.id!==oe.id)),children:[oe.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},oe.id))}),h&&e.jsx("p",{className:"cogita-help",children:h}),ie&&e.jsx("p",{className:"cogita-error",children:ie}),O&&w.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[w.slice(0,S).map((oe,ae)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":ae===_,onClick:()=>Q(oe),children:[e.jsx("strong",{children:oe.label}),e.jsx("span",{children:oe.infoType})]},oe.id)),S<w.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>G(oe=>Math.min(oe+Na,w.length)),children:d??"Load more"})]}),ce&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:xe,disabled:Ce,children:Ce?l??"Saving...":p??`Create new ${a}`})]})}const Cs=[{id:"gen",la:{abbr:"Gen",name:"Genesis"},en:{abbr:"Gen",name:"Genesis"},de:{abbr:"Gen",name:"Genesis"},pl:{abbr:"Rdz",name:"Księga Rodzaju"}},{id:"ex",la:{abbr:"Ex",name:"Exodus"},en:{abbr:"Ex",name:"Exodus"},de:{abbr:"Ex",name:"Exodus"},pl:{abbr:"Wj",name:"Księga Wyjścia"}},{id:"lev",la:{abbr:"Lev",name:"Leviticus"},en:{abbr:"Lev",name:"Leviticus"},de:{abbr:"Lev",name:"Levitikus"},pl:{abbr:"Kpł",name:"Księga Kapłańska"}},{id:"num",la:{abbr:"Num",name:"Numeri"},en:{abbr:"Num",name:"Numbers"},de:{abbr:"Num",name:"Numeri"},pl:{abbr:"Lb",name:"Księga Liczb"}},{id:"deut",la:{abbr:"Deut",name:"Deuteronomium"},en:{abbr:"Deut",name:"Deuteronomy"},de:{abbr:"Dtn",name:"Deuteronomium"},pl:{abbr:"Pwt",name:"Księga Powtórzonego Prawa"}},{id:"ios",la:{abbr:"Ios",name:"Iosue"},en:{abbr:"Josh",name:"Joshua"},de:{abbr:"Jos",name:"Josua"},pl:{abbr:"Joz",name:"Księga Jozuego"}},{id:"iudg",la:{abbr:"Iudg",name:"Iudicum"},en:{abbr:"Judg",name:"Judges"},de:{abbr:"Ri",name:"Richter"},pl:{abbr:"Sdz",name:"Księga Sędziów"}},{id:"ruth",la:{abbr:"Ruth",name:"Ruth"},en:{abbr:"Ruth",name:"Ruth"},de:{abbr:"Rut",name:"Rut"},pl:{abbr:"Rt",name:"Księga Rut"}},{id:"1sam",la:{abbr:"1 Sam",name:"I Samuelis"},en:{abbr:"1 Sam",name:"1 Samuel"},de:{abbr:"1 Sam",name:"1 Samuel"},pl:{abbr:"1 Sm",name:"1 Księga Samuela"}},{id:"2sam",la:{abbr:"2 Sam",name:"II Samuelis"},en:{abbr:"2 Sam",name:"2 Samuel"},de:{abbr:"2 Sam",name:"2 Samuel"},pl:{abbr:"2 Sm",name:"2 Księga Samuela"}},{id:"1reg",la:{abbr:"1 Reg",name:"I Regum"},en:{abbr:"1 Kgs",name:"1 Kings"},de:{abbr:"1 Kön",name:"1 Könige"},pl:{abbr:"1 Krl",name:"1 Księga Królewska"}},{id:"2reg",la:{abbr:"2 Reg",name:"II Regum"},en:{abbr:"2 Kgs",name:"2 Kings"},de:{abbr:"2 Kön",name:"2 Könige"},pl:{abbr:"2 Krl",name:"2 Księga Królewska"}},{id:"1par",la:{abbr:"1 Par",name:"I Paralipomenon"},en:{abbr:"1 Chr",name:"1 Chronicles"},de:{abbr:"1 Chr",name:"1 Chronik"},pl:{abbr:"1 Krn",name:"1 Księga Kronik"}},{id:"2par",la:{abbr:"2 Par",name:"II Paralipomenon"},en:{abbr:"2 Chr",name:"2 Chronicles"},de:{abbr:"2 Chr",name:"2 Chronik"},pl:{abbr:"2 Krn",name:"2 Księga Kronik"}},{id:"esd",la:{abbr:"Esd",name:"Esdrae"},en:{abbr:"Ezra",name:"Ezra"},de:{abbr:"Esra",name:"Esra"},pl:{abbr:"Ezd",name:"Księga Ezdrasza"}},{id:"neh",la:{abbr:"Neh",name:"Nehemiae"},en:{abbr:"Neh",name:"Nehemiah"},de:{abbr:"Neh",name:"Nehemia"},pl:{abbr:"Ne",name:"Księga Nehemiasza"}},{id:"tob",la:{abbr:"Tob",name:"Tobiae"},en:{abbr:"Tob",name:"Tobit"},de:{abbr:"Tob",name:"Tobit"},pl:{abbr:"Tb",name:"Księga Tobiasza"}},{id:"iudt",la:{abbr:"Iudt",name:"Iudith"},en:{abbr:"Jdt",name:"Judith"},de:{abbr:"Jdt",name:"Judit"},pl:{abbr:"Jdt",name:"Księga Judyty"}},{id:"est",la:{abbr:"Est",name:"Esther"},en:{abbr:"Est",name:"Esther"},de:{abbr:"Est",name:"Ester"},pl:{abbr:"Est",name:"Księga Estery"}},{id:"1macc",la:{abbr:"1 Macc",name:"I Maccabaeorum"},en:{abbr:"1 Mc",name:"1 Maccabees"},de:{abbr:"1 Makk",name:"1 Makkabäer"},pl:{abbr:"1 Mch",name:"1 Księga Machabejska"}},{id:"2macc",la:{abbr:"2 Macc",name:"II Maccabaeorum"},en:{abbr:"2 Mc",name:"2 Maccabees"},de:{abbr:"2 Makk",name:"2 Makkabäer"},pl:{abbr:"2 Mch",name:"2 Księga Machabejska"}},{id:"iob",la:{abbr:"Iob",name:"Iob"},en:{abbr:"Job",name:"Job"},de:{abbr:"Ijob",name:"Ijob"},pl:{abbr:"Hi",name:"Księga Hioba"}},{id:"ps",la:{abbr:"Ps",name:"Psalmi"},en:{abbr:"Ps",name:"Psalms"},de:{abbr:"Ps",name:"Psalmen"},pl:{abbr:"Ps",name:"Księga Psalmów"}},{id:"prov",la:{abbr:"Prov",name:"Proverbia"},en:{abbr:"Prov",name:"Proverbs"},de:{abbr:"Spr",name:"Sprichwörter"},pl:{abbr:"Prz",name:"Księga Przysłów"}},{id:"ecc",la:{abbr:"Ecc",name:"Ecclesiastes"},en:{abbr:"Eccl",name:"Ecclesiastes"},de:{abbr:"Koh",name:"Kohelet"},pl:{abbr:"Koh",name:"Księga Koheleta"}},{id:"cant",la:{abbr:"Cant",name:"Canticum Canticorum"},en:{abbr:"Song",name:"Song of Songs"},de:{abbr:"Hld",name:"Hoheslied"},pl:{abbr:"Pnp",name:"Pieśń nad Pieśniami"}},{id:"sap",la:{abbr:"Sap",name:"Sapientia"},en:{abbr:"Wis",name:"Wisdom"},de:{abbr:"Weish",name:"Weisheit"},pl:{abbr:"Mdr",name:"Księga Mądrości"}},{id:"sir",la:{abbr:"Sir",name:"Ecclesiasticus (Sirach)"},en:{abbr:"Sir",name:"Sirach"},de:{abbr:"Sir",name:"Jesus Sirach"},pl:{abbr:"Syr",name:"Mądrość Syracha"}},{id:"isa",la:{abbr:"Isa",name:"Isaias"},en:{abbr:"Isa",name:"Isaiah"},de:{abbr:"Jes",name:"Jesaja"},pl:{abbr:"Iz",name:"Księga Izajasza"}},{id:"ier",la:{abbr:"Ier",name:"Ieremias"},en:{abbr:"Jer",name:"Jeremiah"},de:{abbr:"Jer",name:"Jeremia"},pl:{abbr:"Jr",name:"Księga Jeremiasza"}},{id:"lam",la:{abbr:"Lam",name:"Lamentationes"},en:{abbr:"Lam",name:"Lamentations"},de:{abbr:"Klgl",name:"Klagelieder"},pl:{abbr:"Lm",name:"Lamentacje"}},{id:"bar",la:{abbr:"Bar",name:"Baruch"},en:{abbr:"Bar",name:"Baruch"},de:{abbr:"Bar",name:"Baruch"},pl:{abbr:"Ba",name:"Księga Barucha"}},{id:"ez",la:{abbr:"Ez",name:"Ezechiel"},en:{abbr:"Ezek",name:"Ezekiel"},de:{abbr:"Ez",name:"Ezechiel"},pl:{abbr:"Ez",name:"Księga Ezechiela"}},{id:"dan",la:{abbr:"Dan",name:"Daniel"},en:{abbr:"Dan",name:"Daniel"},de:{abbr:"Dan",name:"Daniel"},pl:{abbr:"Dn",name:"Księga Daniela"}},{id:"hos",la:{abbr:"Hos",name:"Osee"},en:{abbr:"Hos",name:"Hosea"},de:{abbr:"Hos",name:"Hosea"},pl:{abbr:"Oz",name:"Księga Ozeasza"}},{id:"ioel",la:{abbr:"Ioel",name:"Ioel"},en:{abbr:"Joel",name:"Joel"},de:{abbr:"Joel",name:"Joel"},pl:{abbr:"Jl",name:"Księga Joela"}},{id:"amos",la:{abbr:"Amos",name:"Amos"},en:{abbr:"Am",name:"Amos"},de:{abbr:"Am",name:"Amos"},pl:{abbr:"Am",name:"Księga Amosa"}},{id:"abd",la:{abbr:"Abd",name:"Abdias"},en:{abbr:"Obad",name:"Obadiah"},de:{abbr:"Obd",name:"Obadja"},pl:{abbr:"Abd",name:"Księga Abdiasza"}},{id:"ion",la:{abbr:"Ion",name:"Ionas"},en:{abbr:"Jon",name:"Jonah"},de:{abbr:"Jona",name:"Jona"},pl:{abbr:"Jon",name:"Księga Jonasza"}},{id:"mich",la:{abbr:"Mich",name:"Michaeas"},en:{abbr:"Mic",name:"Micah"},de:{abbr:"Mi",name:"Micha"},pl:{abbr:"Mi",name:"Księga Micheasza"}},{id:"nah",la:{abbr:"Nah",name:"Nahum"},en:{abbr:"Nah",name:"Nahum"},de:{abbr:"Nah",name:"Nahum"},pl:{abbr:"Na",name:"Księga Nahuma"}},{id:"hab",la:{abbr:"Hab",name:"Habacuc"},en:{abbr:"Hab",name:"Habakkuk"},de:{abbr:"Hab",name:"Habakuk"},pl:{abbr:"Ha",name:"Księga Habakuka"}},{id:"soph",la:{abbr:"Soph",name:"Sophonias"},en:{abbr:"Zeph",name:"Zephaniah"},de:{abbr:"Zef",name:"Zefanja"},pl:{abbr:"So",name:"Księga Sofoniasza"}},{id:"agg",la:{abbr:"Agg",name:"Aggaeus"},en:{abbr:"Hag",name:"Haggai"},de:{abbr:"Hag",name:"Haggai"},pl:{abbr:"Ag",name:"Księga Aggeusza"}},{id:"zach",la:{abbr:"Zach",name:"Zacharias"},en:{abbr:"Zech",name:"Zechariah"},de:{abbr:"Sach",name:"Sacharja"},pl:{abbr:"Za",name:"Księga Zachariasza"}},{id:"mal",la:{abbr:"Mal",name:"Malachias"},en:{abbr:"Mal",name:"Malachi"},de:{abbr:"Mal",name:"Maleachi"},pl:{abbr:"Ml",name:"Księga Malachiasza"}},{id:"mt",la:{abbr:"Mt",name:"Matthaeus"},en:{abbr:"Matt",name:"Matthew"},de:{abbr:"Mt",name:"Matthäus"},pl:{abbr:"Mt",name:"Ewangelia wg św. Mateusza"}},{id:"mc",la:{abbr:"Mc",name:"Marcus"},en:{abbr:"Mark",name:"Mark"},de:{abbr:"Mk",name:"Markus"},pl:{abbr:"Mk",name:"Ewangelia wg św. Marka"}},{id:"lc",la:{abbr:"Lc",name:"Lucas"},en:{abbr:"Luke",name:"Luke"},de:{abbr:"Lk",name:"Lukas"},pl:{abbr:"Łk",name:"Ewangelia wg św. Łukasza"}},{id:"io",la:{abbr:"Io",name:"Ioannes"},en:{abbr:"John",name:"John"},de:{abbr:"Joh",name:"Johannes"},pl:{abbr:"J",name:"Ewangelia wg św. Jana"}},{id:"act",la:{abbr:"Act",name:"Actus Apostolorum"},en:{abbr:"Acts",name:"Acts"},de:{abbr:"Apg",name:"Apostelgeschichte"},pl:{abbr:"Dz",name:"Dzieje Apostolskie"}},{id:"rom",la:{abbr:"Rom",name:"ad Romanos"},en:{abbr:"Rom",name:"Romans"},de:{abbr:"Röm",name:"Römer"},pl:{abbr:"Rz",name:"List do Rzymian"}},{id:"1cor",la:{abbr:"1 Cor",name:"I ad Corinthios"},en:{abbr:"1 Cor",name:"1 Corinthians"},de:{abbr:"1 Kor",name:"1 Korinther"},pl:{abbr:"1 Kor",name:"1 List do Koryntian"}},{id:"2cor",la:{abbr:"2 Cor",name:"II ad Corinthios"},en:{abbr:"2 Cor",name:"2 Corinthians"},de:{abbr:"2 Kor",name:"2 Korinther"},pl:{abbr:"2 Kor",name:"2 List do Koryntian"}},{id:"gal",la:{abbr:"Gal",name:"ad Galatas"},en:{abbr:"Gal",name:"Galatians"},de:{abbr:"Gal",name:"Galater"},pl:{abbr:"Ga",name:"List do Galatów"}},{id:"eph",la:{abbr:"Eph",name:"ad Ephesios"},en:{abbr:"Eph",name:"Ephesians"},de:{abbr:"Eph",name:"Epheser"},pl:{abbr:"Ef",name:"List do Efezjan"}},{id:"phil",la:{abbr:"Phil",name:"ad Philippenses"},en:{abbr:"Phil",name:"Philippians"},de:{abbr:"Phil",name:"Philipper"},pl:{abbr:"Flp",name:"List do Filipian"}},{id:"col",la:{abbr:"Col",name:"ad Colossenses"},en:{abbr:"Col",name:"Colossians"},de:{abbr:"Kol",name:"Kolosser"},pl:{abbr:"Kol",name:"List do Kolosan"}},{id:"1thess",la:{abbr:"1 Thess",name:"I ad Thessalonicenses"},en:{abbr:"1 Thess",name:"1 Thessalonians"},de:{abbr:"1 Thess",name:"1 Thessalonicher"},pl:{abbr:"1 Tes",name:"1 List do Tesaloniczan"}},{id:"2thess",la:{abbr:"2 Thess",name:"II ad Thessalonicenses"},en:{abbr:"2 Thess",name:"2 Thessalonians"},de:{abbr:"2 Thess",name:"2 Thessalonicher"},pl:{abbr:"2 Tes",name:"2 List do Tesaloniczan"}},{id:"1tim",la:{abbr:"1 Tim",name:"I ad Timotheum"},en:{abbr:"1 Tim",name:"1 Timothy"},de:{abbr:"1 Tim",name:"1 Timotheus"},pl:{abbr:"1 Tm",name:"1 List do Tymoteusza"}},{id:"2tim",la:{abbr:"2 Tim",name:"II ad Timotheum"},en:{abbr:"2 Tim",name:"2 Timothy"},de:{abbr:"2 Tim",name:"2 Timotheus"},pl:{abbr:"2 Tm",name:"2 List do Tymoteusza"}},{id:"tit",la:{abbr:"Tit",name:"ad Titum"},en:{abbr:"Titus",name:"Titus"},de:{abbr:"Tit",name:"Titus"},pl:{abbr:"Tt",name:"List do Tytusa"}},{id:"phlm",la:{abbr:"Phlm",name:"ad Philemonem"},en:{abbr:"Phlm",name:"Philemon"},de:{abbr:"Phlm",name:"Philemon"},pl:{abbr:"Flm",name:"List do Filemona"}},{id:"heb",la:{abbr:"Heb",name:"ad Hebraeos"},en:{abbr:"Heb",name:"Hebrews"},de:{abbr:"Hebr",name:"Hebräer"},pl:{abbr:"Hbr",name:"List do Hebrajczyków"}},{id:"iac",la:{abbr:"Iac",name:"Iacobi"},en:{abbr:"Jas",name:"James"},de:{abbr:"Jak",name:"Jakobus"},pl:{abbr:"Jk",name:"List św. Jakuba"}},{id:"1pet",la:{abbr:"1 Pet",name:"I Petri"},en:{abbr:"1 Pet",name:"1 Peter"},de:{abbr:"1 Petr",name:"1 Petrus"},pl:{abbr:"1 P",name:"1 List św. Piotra"}},{id:"2pet",la:{abbr:"2 Pet",name:"II Petri"},en:{abbr:"2 Pet",name:"2 Peter"},de:{abbr:"2 Petr",name:"2 Petrus"},pl:{abbr:"2 P",name:"2 List św. Piotra"}},{id:"1io",la:{abbr:"1 Io",name:"I Ioannis"},en:{abbr:"1 John",name:"1 John"},de:{abbr:"1 Joh",name:"1 Johannes"},pl:{abbr:"1 J",name:"1 List św. Jana"}},{id:"2io",la:{abbr:"2 Io",name:"II Ioannis"},en:{abbr:"2 John",name:"2 John"},de:{abbr:"2 Joh",name:"2 Johannes"},pl:{abbr:"2 J",name:"2 List św. Jana"}},{id:"3io",la:{abbr:"3 Io",name:"III Ioannis"},en:{abbr:"3 John",name:"3 John"},de:{abbr:"3 Joh",name:"3 Johannes"},pl:{abbr:"3 J",name:"3 List św. Jana"}},{id:"iud",la:{abbr:"Iud",name:"Iudae"},en:{abbr:"Jude",name:"Jude"},de:{abbr:"Jud",name:"Judas"},pl:{abbr:"Jud",name:"List św. Judy"}},{id:"apoc",la:{abbr:"Apoc",name:"Apocalypsis Ioannis"},en:{abbr:"Rev",name:"Revelation"},de:{abbr:"Offb",name:"Offenbarung"},pl:{abbr:"Ap",name:"Apokalipsa św. Jana"}}],Is=8;function Ms({libraryId:t,copy:a,language:s,sourceKindOptions:r,value:i,onChange:u,labels:o}){const[j,h]=n.useState(!1),[b,c]=n.useState(-1),p=n.useMemo(()=>{const m=s;return Cs.map(N=>{var f;const C=(N==null?void 0:N[m])??(N==null?void 0:N.en)??(N==null?void 0:N.la);return{label:`${C.abbr} — ${C.name}`,latin:((f=N==null?void 0:N.la)==null?void 0:f.abbr)??C.abbr}})},[s]),l=(m,N=!1)=>{const C=m.trim().toLowerCase();return C?p.filter(v=>v.label.toLowerCase().includes(C)).slice(0,Is):N?p.slice(0,Is):[]},d=(m,N)=>{const C=m.trim().toLowerCase();if(!C)return null;const v=Cs;for(const f of v){const J=f==null?void 0:f.la,L=(f==null?void 0:f[N])??(f==null?void 0:f.en)??J,w=(L==null?void 0:L.abbr)??"",K=(L==null?void 0:L.name)??"";if(w.toLowerCase()===C||K.toLowerCase()===C||`${w} — ${K}`.toLowerCase()===C)return{book:f,entry:L,la:J}}return null};n.useEffect(()=>{if(i.sourceKind==="bible"&&i.locatorValue&&!j){const m=d(i.locatorValue,s);if(m){const N=`${m.entry.abbr} — ${m.entry.name}`;N!==i.bibleBookDisplay&&u({...i,bibleBookDisplay:N})}}},[s,i,j,u]);const k=m=>u({...i,...m});return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.sourceKindLabel}),e.jsx("select",{value:i.sourceKind,onChange:m=>k({sourceKind:m.target.value,churchDocument:null,bookMedia:null,work:null,locatorValue:"",locatorAux:"",bibleBookDisplay:""}),children:r.map(m=>e.jsx("option",{value:m.value,children:m.label},m.value))})]}),i.sourceKind==="bible"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-lookup full",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.bibleBookLabel}),e.jsx("input",{type:"text",value:i.bibleBookDisplay,onChange:m=>{const N=m.target.value;k({bibleBookDisplay:N,locatorValue:""}),h(!0),c(-1)},onKeyDown:m=>{var C;const N=l(i.bibleBookDisplay);if(N.length){if(m.key==="ArrowDown")m.preventDefault(),c(v=>Math.min(v+1,N.length-1));else if(m.key==="ArrowUp")m.preventDefault(),c(v=>Math.max(v-1,0));else if((m.key==="Enter"||m.key==="Tab")&&b>=0&&N[b]){const v=N[b],f=d(v.label,s);if(!f)return;k({bibleBookDisplay:v.label,locatorValue:((C=f.la)==null?void 0:C.abbr)??i.locatorValue}),h(!1)}}},onFocus:()=>h(!0),onBlur:()=>window.setTimeout(()=>h(!1),100),placeholder:o.bibleBookPlaceholder})]}),j&&l(i.bibleBookDisplay,!0).length>0&&e.jsx("div",{className:"cogita-lookup-results",children:l(i.bibleBookDisplay,!0).map((m,N)=>e.jsx("button",{type:"button",className:"cogita-lookup-option","data-active":N===b,tabIndex:-1,onMouseDown:()=>{var v;const C=d(m.label,s);C&&k({bibleBookDisplay:m.label,locatorValue:((v=C.la)==null?void 0:v.abbr)??i.locatorValue})},children:e.jsx("strong",{children:m.label})},m.latin))})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.bibleRestLabel}),e.jsx("input",{type:"text",value:i.locatorAux,onChange:m=>k({locatorAux:m.target.value}),placeholder:o.bibleRestPlaceholder})]})]}),i.sourceKind==="website"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:a.cogita.library.add.info.sourceUrlLabel}),e.jsx("input",{type:"text",value:i.sourceUrl,onChange:m=>k({sourceUrl:m.target.value}),placeholder:a.cogita.library.add.info.sourceUrlPlaceholder})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:a.cogita.library.add.info.sourceAccessedDateLabel}),e.jsx("input",{type:"text",value:i.sourceAccessedDate,onChange:m=>k({sourceAccessedDate:m.target.value}),placeholder:a.cogita.library.add.info.sourceAccessedDatePlaceholder})]})]}),i.sourceKind==="number_document"&&e.jsxs(e.Fragment,{children:[e.jsx(Xt,{libraryId:t,infoType:"work",label:o.churchDocumentLabel,placeholder:o.churchDocumentPlaceholder,value:i.churchDocument,onChange:m=>k({churchDocument:m}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.work),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:m=>k({locatorValue:m.target.value}),placeholder:o.locatorPlaceholder})]})]}),i.sourceKind==="work"&&e.jsx(Xt,{libraryId:t,infoType:"work",label:o.workLabel,placeholder:o.workPlaceholder,value:i.work,onChange:m=>k({work:m}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.work),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),i.sourceKind==="book"&&e.jsxs(e.Fragment,{children:[e.jsx(Xt,{libraryId:t,infoType:"media",label:o.bookLabel,placeholder:o.bookPlaceholder,value:i.bookMedia,onChange:m=>k({bookMedia:m}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.media),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:m=>k({locatorValue:m.target.value}),placeholder:o.locatorPlaceholder})]})]}),i.sourceKind!=="website"&&i.sourceKind!=="bible"&&i.sourceKind!=="book"&&i.sourceKind!=="number_document"&&e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:m=>k({locatorValue:m.target.value}),placeholder:o.locatorPlaceholder})]})]})}const za=JSON.stringify({type:"selection",title:"Question title",question:"Question text",options:["Option A","Option B","Option C"],answer:[0]},null,2);function Za(t="selection"){return t==="matching"?{type:t,title:"",question:"",columns:[[""],[""]],answer:{paths:[]},matchingPaths:[["",""]]}:t==="ordering"?{type:t,title:"",question:"",options:[""]}:t==="truefalse"?{type:t,title:"",question:"",answer:!0}:t==="text"||t==="date"?{type:t,title:"",question:"",answer:""}:t==="number"?{type:t,title:"",question:"",answer:""}:{type:t,title:"",question:"",options:[""],answer:[]}}function Ai(t){return["selection","truefalse","text","number","date","matching","ordering"].includes(t)}function La(t){if(!t||typeof t!="object")return null;const a=t,s=typeof a.type=="string"?a.type:typeof a.kind=="string"?a.kind:"selection",r=s==="multi_select"||s==="single_select"?"selection":s==="boolean"?"truefalse":s==="order"?"ordering":s==="short"||s==="open"||s==="short_text"?"text":s,i=Ai(r)?r:"selection",u=typeof a.title=="string"?a.title:"",o=typeof a.question=="string"?a.question:"";if(i==="matching"){let b=[];Array.isArray(a.columns)?b=a.columns.map(m=>Array.isArray(m)?m.map(N=>typeof N=="string"?N:""):[""]):Array.isArray(a.left)&&Array.isArray(a.right)&&(b=[a.left.map(m=>typeof m=="string"?m:""),a.right.map(m=>typeof m=="string"?m:"")]),b.length<2&&(b=[[""],[""]]);const c=a.answer&&typeof a.answer=="object"?a.answer:null,l=(Array.isArray(c==null?void 0:c.paths)?c==null?void 0:c.paths:Array.isArray(a.correctPairs)?a.correctPairs:[]).map(m=>Array.isArray(m)?m.map(N=>Number(N)).filter(N=>Number.isInteger(N)&&N>=0):[]).filter(m=>m.length>0),d=Array.isArray(a.matchingPaths)?a.matchingPaths.map(m=>Array.isArray(m)?Array.from({length:b.length},(N,C)=>String(m[C]??"")):new Array(b.length).fill("")):null,k=d&&d.length>0?d:[...l.map(m=>m.map(String)),new Array(b.length).fill("")];return{type:i,title:u,question:o,columns:b,answer:{paths:l},matchingPaths:k}}if(i==="ordering"){const b=Array.isArray(a.options)?a.options.map(c=>typeof c=="string"?c:""):Array.isArray(a.items)?a.items.map(c=>typeof c=="string"?c:""):[""];return{type:i,title:u,question:o,options:b.length?b:[""]}}if(i==="truefalse"){const b=typeof a.answer=="boolean"?a.answer:typeof a.expected=="boolean"?a.expected:!0;return{type:i,title:u,question:o,answer:b}}if(i==="number")return typeof a.answer=="number"?{type:i,title:u,question:o,answer:a.answer}:typeof a.answer=="string"?{type:i,title:u,question:o,answer:a.answer}:typeof a.expected=="number"?{type:i,title:u,question:o,answer:a.expected}:{type:i,title:u,question:o,answer:""};if(i==="text"||i==="date"){const b=typeof a.answer=="string"?a.answer:typeof a.expected=="string"?a.expected:"";return{type:i,title:u,question:o,answer:b}}const j=Array.isArray(a.options)?a.options.map(b=>typeof b=="string"?b:""):[""],h=Array.isArray(a.answer)?a.answer.map(b=>Number(b)).filter(b=>Number.isInteger(b)&&b>=0):Array.isArray(a.correct)?a.correct.map(b=>Number(b)).filter(b=>Number.isInteger(b)&&b>=0):[];return{type:i,title:u,question:o,options:j.length?j:[""],answer:h}}function Rn(t){const a=(t.title??"").trim(),s=(t.question??"").trim();switch(t.type){case"matching":{const r=(t.columns??[[""],[""]]).map(p=>p.map(l=>l.trim()).filter(Boolean)).filter(p=>p.length>0),i=r.length>=2?r:[[""],[""]],u=t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[],o=(t.matchingPaths??[]).map(p=>p.map(l=>String(l??""))),j=i.length,h=o.map(p=>p.slice(0,j).map(l=>l.trim())).filter(p=>p.some(Boolean)).map(p=>p.map(l=>Number(l))).filter(p=>p.length===j&&p.every(l=>Number.isInteger(l)&&l>=0)),b=(Array.isArray(u)?u:[]).map(p=>Array.isArray(p)?p.map(l=>Number(l)).filter(l=>Number.isInteger(l)&&l>=0):[]).filter(p=>p.length===j),c=Array.from(new Set([...b,...h].map(p=>JSON.stringify(p)))).map(p=>JSON.parse(p));return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,columns:i,answer:{paths:c}},null,2)}case"ordering":{const r=(t.options??[]).map(i=>i.trim()).filter(Boolean);return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,options:r},null,2)}case"truefalse":return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,answer:!!t.answer},null,2);case"number":return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,answer:typeof t.answer=="number"||typeof t.answer=="string"?t.answer:""},null,2);case"date":case"text":return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,answer:String(t.answer??"")},null,2);case"selection":default:{const r=(t.options??[]).map(o=>o.trim()).filter(Boolean),i=Array.isArray(t.answer)?t.answer:[],u=Array.from(new Set(i.filter(o=>Number.isInteger(o)&&o>=0&&o<r.length))).sort((o,j)=>o-j);return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,options:r,answer:u},null,2)}}}const Ls=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}];function Va(){return{sourceKind:"string",locatorValue:"",locatorAux:"",bibleBookDisplay:"",sourceUrl:"",sourceAccessedDate:"",churchDocument:null,bookMedia:null,work:null}}function As(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function Rs(t,a){if(!t||typeof t!="object")return a;const s=t,r=s.definition&&typeof s.definition=="object"?s.definition:null,i=[s.label,s.name,s.title,s.text,s.orcid,s.email,s.number];r&&i.unshift(r.title,r.question);for(const u of i)if(typeof u=="string"&&u.trim())return u.trim();return a}function $s(t,a){var r;if(!(t instanceof as))return a;const s=(r=t.message)==null?void 0:r.trim();if(!s)return a;try{const i=JSON.parse(s);if(typeof i.error=="string"&&i.error.trim())return i.error.trim()}catch{}return s}function Ri(t){const a=t.trim();if(!a)return null;try{const s=JSON.parse(a);return s&&typeof s=="object"&&!Array.isArray(s)?s:null}catch{return null}}function oa(t,a){const s=t==null?void 0:t[a];return typeof s=="string"?s:""}function $i(t,a){return a?t==="book"&&a.infoType==="media"?{bookMedia:a}:t==="work"&&a.infoType==="work"?{work:a}:t==="number_document"&&a.infoType==="work"?{churchDocument:a}:{}:{}}function Pi(t,a){const s=Va(),r=(t.sourceKind??"").trim()||s.sourceKind,i=t.locator??"",u=Ri(i);let o="",j="",h="",b="",c="";return r==="website"?(b=oa(u,"url"),c=oa(u,"accessedDate"),o=oa(u,"value")):r==="bible"?(o=oa(u,"book")||i.trim(),j=oa(u,"passage")||oa(u,"rest"),h=oa(u,"bookDisplay")):u?(o=oa(u,"value")||oa(u,"locator"),j=oa(u,"aux")):o=i,{...s,sourceKind:r,locatorValue:o,locatorAux:j,bibleBookDisplay:h,sourceUrl:b,sourceAccessedDate:c,...$i(r,a)}}function $n(t){return t.sourceKind==="book"?t.bookMedia:t.sourceKind==="work"?t.work:t.sourceKind==="number_document"?t.churchDocument:null}function Pn(t){const a=t.locatorValue.trim(),s=t.locatorAux.trim(),r=t.sourceUrl.trim(),i=t.sourceAccessedDate.trim();switch(t.sourceKind){case"website":return{url:r,accessedDate:i};case"bible":return{book:a,bookDisplay:t.bibleBookDisplay.trim(),passage:s};case"book":case"work":case"number_document":return s?{value:a,aux:s}:a;default:return s?{value:a,aux:s}:a}}function Ps(t){var i,u,o;const a=t.locatorValue.trim(),s=t.locatorAux.trim(),r=[a,s].filter(Boolean).join(" ");switch(t.sourceKind){case"website":return t.sourceUrl.trim()||"website";case"bible":return r||"bible";case"book":return[(i=t.bookMedia)==null?void 0:i.label,r].filter(Boolean).join(" · ")||"book";case"work":return[(u=t.work)==null?void 0:u.label,r].filter(Boolean).join(" · ")||"work";case"number_document":return[(o=t.churchDocument)==null?void 0:o.label,r].filter(Boolean).join(" · ")||"number_document";default:return r||t.sourceKind||"source"}}function Es(t){return t.sourceKind.trim()?t.sourceKind==="website"?!!t.sourceUrl.trim():t.sourceKind==="bible"?!!(t.locatorValue.trim()&&t.locatorAux.trim()):t.sourceKind==="book"?!!t.bookMedia:t.sourceKind==="work"?!!t.work:t.sourceKind==="number_document"?!!(t.churchDocument&&t.locatorValue.trim()):!!t.locatorValue.trim():!1}function Ei({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,libraryId:c,editInfoId:p}){var E,Y,pe;const{libraryName:l}=ua(c),d=!!p,[k,m]=n.useState([]),[N,C]=n.useState("word"),[v,f]=n.useState({}),[J,L]=n.useState({}),[w,K]=n.useState({}),[S,G]=n.useState({}),[_,A]=n.useState(null),[O,de]=n.useState("idle"),[Ce,Je]=n.useState(Va),[ie,$]=n.useState({}),[be,U]=n.useState({}),[ce,Q]=n.useState({}),[xe,oe]=n.useState(null),[ae,Me]=n.useState(()=>La(JSON.parse(za))??Za()),[se,Re]=n.useState(za),[Le,He]=n.useState([]),[st,V]=n.useState(0),ye=n.useMemo(()=>k.find(T=>T.infoType===N),[N,k]),Qe=n.useMemo(()=>k.find(T=>T.infoType==="source"),[k]),Ee=n.useMemo(()=>k.map(T=>({value:T.infoType,label:lt(t,T.infoType)})),[t,k]),Ne=T=>{const I=La(T)??Za(),x=Rn(I);Me(I),f(F=>({...F,definition:x}))};n.useEffect(()=>{let T=!1;return Tr({libraryId:c}).then(I=>{var x;if(!T&&(m(I),!d)){const F=(x=I[0])==null?void 0:x.infoType;F&&C(F)}}).catch(()=>{T||m([])}),()=>{T=!0}},[d,c]),n.useEffect(()=>{if(d||!ye)return;const T={},I={},x={},F={};for(const H of ye.payloadFields)ye.infoType==="question"&&H.key==="definition"&&H.inputType==="json"?T[H.key]=za:T[H.key]="";for(const H of ye.linkFields)H.multiple?x[H.key]=[]:I[H.key]=null,H.targetTypes.length>0&&(F[H.key]=H.targetTypes[0]);f(T),L(I),K(x),G(F)},[ye==null?void 0:ye.infoType,d]),n.useEffect(()=>{if(N!=="question")return;const T=v.definition??"";if(!T.trim()){const I=La(JSON.parse(za))??Za();Me(I),Re(za);return}try{const I=JSON.parse(T),x=La(I);if(!x)return;Me(x),Le.length===0&&Re(JSON.stringify(I,null,2))}catch{}},[v.definition,Le.length,N]),n.useEffect(()=>{if(!d||!p||k.length===0)return;let T=!1;return de("loading"),A(null),(async()=>{const x=await na({libraryId:c,infoId:p});if(T)return;const F=x.infoType;C(F);const H=k.find(je=>je.infoType===F);if(!H){de("idle");return}const fe=x.payload??{},q={};for(const je of H.payloadFields)q[je.key]=As(fe[je.key]);f(q);const R=x.links??{}??{},Se={},Z={},re={},W=[];for(const je of H.linkFields){je.targetTypes.length>0&&(re[je.key]=je.targetTypes[0]);const he=R[je.key];if(je.multiple){const ge=Array.isArray(he)?he.filter($e=>typeof $e=="string"):[];Z[je.key]=[];for(const $e of ge)W.push(na({libraryId:c,infoId:$e}).then(Ge=>{if(T)return;const Ve={id:$e,infoType:Ge.infoType,label:Rs(Ge.payload,$e)};re[je.key]=Ve.infoType,Z[je.key]=[...Z[je.key],Ve]}).catch(()=>{}))}else{const ge=typeof he=="string"?he:null;Se[je.key]=null,ge&&W.push(na({libraryId:c,infoId:ge}).then($e=>{if(T)return;const Ge={id:ge,infoType:$e.infoType,label:Rs($e.payload,ge)};re[je.key]=Ge.infoType,Se[je.key]=Ge}).catch(()=>{}))}}await Promise.all(W),!T&&(L(Se),K(Z),G(re),de("idle"))})().catch(()=>{T||(A("Failed to load info details."),de("idle"))}),()=>{T=!0}},[p,d,c,k]),n.useEffect(()=>{N==="source"&&Je(Pi(v,J.resource??null))},[N,v.sourceKind,v.locator,(E=J.resource)==null?void 0:E.id,(Y=J.resource)==null?void 0:Y.infoType,(pe=J.resource)==null?void 0:pe.label]);const tt=T=>{var H,fe;const I=((H=Qe==null?void 0:Qe.payloadFields.find(q=>q.key==="sourceKind"))==null?void 0:H.keepOnCreate)??!1,x=((fe=Qe==null?void 0:Qe.linkFields.find(q=>q.key==="resource"))==null?void 0:fe.keepOnCreate)??!1,F=Va();return F.sourceKind=I?T.sourceKind:F.sourceKind,x&&(F.work=T.work,F.bookMedia=T.bookMedia,F.churchDocument=T.churchDocument),I&&T.sourceKind==="bible"&&(F.locatorValue=T.locatorValue,F.bibleBookDisplay=T.bibleBookDisplay),I&&T.sourceKind==="website"&&(F.sourceUrl=T.sourceUrl,F.sourceAccessedDate=T.sourceAccessedDate),F},vt=n.useMemo(()=>({sourceKindLabel:t.cogita.library.add.info.sourceKindLabel,bibleBookLabel:t.cogita.library.add.info.sourceBibleBookLabel,bibleBookPlaceholder:t.cogita.library.add.info.sourceBibleBookPlaceholder,bibleRestLabel:t.cogita.library.add.info.sourceBibleRestLabel,bibleRestPlaceholder:t.cogita.library.add.info.sourceBibleRestPlaceholder,churchDocumentLabel:t.cogita.library.add.info.sourceResourceLabel,churchDocumentPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,workLabel:t.cogita.library.add.info.sourceResourceLabel,workPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,bookLabel:t.cogita.library.add.info.sourceResourceLabel,bookPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,locatorLabel:t.cogita.library.list.typeFilterLocator,locatorPlaceholder:t.cogita.library.list.typeFilterLocator}),[t]),rt=async T=>{const I=be[T]??Va();if(!Es(I)){Q(x=>({...x,[T]:t.cogita.library.add.info.referenceMissingSource}));return}oe(T),Q(x=>({...x,[T]:null}));try{const x=$n(I),F=x?{resource:x.id}:{},H={label:Ps(I),sourceKind:I.sourceKind.trim(),locator:Pn(I)},q={id:(await Jn({libraryId:c,infoType:"source",payload:H,links:F})).infoId,infoType:"source",label:H.label};if(K(R=>{const Se=R[T]??[];return Se.some(Z=>Z.id===q.id)?R:{...R,[T]:[...Se,q]}}),d&&p){const R=await na({libraryId:c,infoId:p}),Se=R.links&&typeof R.links=="object"?{...R.links}:{},Z=Se[T],re=Array.isArray(Z)?Z.filter(W=>typeof W=="string"):typeof Z=="string"?[Z]:[];re.includes(q.id)||(Se[T]=[...re,q.id],await ms({libraryId:c,infoId:p,payload:R.payload,links:Se}))}U(R=>({...R,[T]:tt(I)})),Q(R=>({...R,[T]:null}))}catch(x){Q(F=>({...F,[T]:$s(x,t.cogita.library.lookup.createFailed)}))}finally{oe(x=>x===T?null:x)}},Ae=async()=>{var x;if(!ye)return;const T={};for(const F of ye.payloadFields){if(N==="source"&&(F.key==="sourceKind"||F.key==="locator"))continue;const H=(v[F.key]??"").trim();if(!H){if(F.required){A(`Field '${F.label}' is required.`);return}continue}if(F.inputType==="json")try{T[F.key]=JSON.parse(H)}catch{A(`Field '${F.label}' must be valid JSON.`);return}else T[F.key]=H}const I={};for(const F of ye.linkFields)if(!(N==="source"&&F.key==="resource"))if(F.multiple){const H=(w[F.key]??[]).map(fe=>fe.id);if(F.required&&H.length===0){A(`Link '${F.label}' is required.`);return}H.length>0&&(I[F.key]=H)}else{const H=((x=J[F.key])==null?void 0:x.id)??null;if(F.required&&!H){A(`Link '${F.label}' is required.`);return}H&&(I[F.key]=H)}if(N==="source"){if(!Es(Ce)){A(t.cogita.library.add.info.referenceMissingSource);return}const F=Ce.sourceKind.trim();T.sourceKind=F,T.locator=Pn(Ce),(typeof T.label!="string"||!T.label.trim())&&(T.label=Ps(Ce));const H=$n(Ce);H&&(I.resource=H.id)}de("saving"),A(null);try{if(d&&p)await ms({libraryId:c,infoId:p,payload:T,links:I}),A("Info updated.");else{await Jn({libraryId:c,infoType:N,payload:T,links:I});const F=N==="question"&&Le.length>0&&st<Le.length-1;if(F){const R=st+1,Se=Le[R]??null;if(Se){const Z=Rn(Se);V(R),Me(Se),f(re=>({...re,definition:Z})),A(`Info saved. Loaded next question (${R+1}/${Le.length}).`)}else A("Info saved.")}else N==="question"&&Le.length>0&&(He([]),V(0)),A("Info saved.");const H={};for(const R of ye.payloadFields)H[R.key]=R.keepOnCreate?v[R.key]??"":"";if(F){const R=Le[Math.min(st+1,Le.length-1)];R&&(H.definition=Rn(R))}f(H);const fe={},q={};for(const R of ye.linkFields)R.multiple?q[R.key]=R.keepOnCreate?w[R.key]??[]:[]:fe[R.key]=R.keepOnCreate?J[R.key]??null:null;L(R=>({...R,...fe})),K(R=>({...R,...q})),N==="source"&&Je(R=>{const Se=tt(R),Z=$n(Se);return f(re=>({...re,sourceKind:Se.sourceKind,locator:As(Pn(Se))})),L(re=>({...re,resource:Z})),Z&&G(re=>({...re,resource:Z.infoType})),Se})}}catch(F){A($s(F,"Failed to save info."))}finally{de("idle")}},ze=T=>{const I=v[T.key]??"";if(N==="question"&&T.key==="definition"&&T.inputType==="json"){const F=ae.type,H=W=>{const je=ae.title??"",he=ae.question??"";Ne({...Za(W),title:je,question:he})},fe=W=>W.length===0?[""]:W[W.length-1].trim()?[...W,""]:W,q=W=>{const je=(W.length?W:[[""],[""]]).map(he=>fe(he));return je.length>=2?je:[...je,[""]]},R=(W,je)=>{const he=W.map($e=>Array.from({length:je},(Ge,Ve)=>$e[Ve]??"")).filter($e=>$e.some(Ge=>Ge.trim())||$e===W[W.length-1]);return he.length===0?[new Array(je).fill("")]:he[he.length-1].some($e=>$e.trim())?[...he,new Array(je).fill("")]:he},Se=Array.isArray(ae.answer)?ae.answer:[],Z=q(ae.columns??[[""],[""]]),re=R(ae.matchingPaths??[[]],Z.length);return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:T.label}),e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.8rem"},children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question type"}),e.jsxs("select",{value:F,onChange:W=>H(W.target.value),children:[e.jsx("option",{value:"selection",children:"Selection"}),e.jsx("option",{value:"truefalse",children:"True / false"}),e.jsx("option",{value:"text",children:"Text answer"}),e.jsx("option",{value:"number",children:"Number answer"}),e.jsx("option",{value:"date",children:"Date answer"}),e.jsx("option",{value:"matching",children:"Matching"}),e.jsx("option",{value:"ordering",children:"Right order"})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Title"}),e.jsx("input",{type:"text",value:ae.title??"",onChange:W=>Ne({...ae,title:W.target.value}),placeholder:"Optional title"})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question"}),e.jsx("textarea",{rows:3,value:ae.question??"",onChange:W=>Ne({...ae,question:W.target.value}),placeholder:"Question text"})]}),F==="selection"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Options / correct indices"}),fe(ae.options??[""]).map((W,je,he)=>{const ge=new Set(Se.filter(Ge=>Number.isInteger(Ge))),$e=je===he.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:ge.has(je),disabled:!W.trim(),onChange:Ge=>{const Ve=Ge.target.checked?[...ge,je]:[...ge].filter(Ke=>Ke!==je);Ne({...ae,answer:Ve})}}),e.jsx("input",{type:"text",value:W,placeholder:`Answer ${je+1}`,onChange:Ge=>{const Ve=[...ae.options??[""]];Ve[je]=Ge.target.value;const Ke=fe(Ve),bt=Ke.length-1,ut=Se.filter(yt=>yt>=0&&yt<bt);Ne({...ae,options:Ke,answer:ut})}}),$e?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const Ve=(ae.options??[""]).filter((bt,ut)=>ut!==je),Ke=Se.filter(bt=>bt!==je).map(bt=>bt>je?bt-1:bt);Ne({...ae,options:fe(Ve),answer:Ke})},children:"Remove"})]},`question-option:${je}`)})]}):null,F==="text"||F==="date"||F==="number"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsx("input",{type:F==="date"?"date":"text",value:typeof ae.answer=="string"||typeof ae.answer=="number"?String(ae.answer):"",onChange:W=>Ne({...ae,answer:W.target.value})})]}):null,F==="truefalse"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsxs("select",{value:String(!!ae.answer),onChange:W=>Ne({...ae,answer:W.target.value==="true"}),children:[e.jsx("option",{value:"true",children:"True"}),e.jsx("option",{value:"false",children:"False"})]})]}):null,F==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Columns"}),Z.map((W,je)=>e.jsxs("div",{style:{display:"grid",gap:"0.35rem",border:"1px solid rgba(120,170,220,0.22)",borderRadius:"0.6rem",padding:"0.55rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"0.5rem"},children:[e.jsxs("span",{style:{fontSize:"0.8rem",color:"rgba(184,209,234,0.85)"},children:["Column ",je+1]}),Z.length>2?e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const he=Z.filter(($e,Ge)=>Ge!==je),ge=re.map($e=>$e.filter((Ge,Ve)=>Ve!==je));Ne({...ae,columns:q(he),matchingPaths:R(ge,Math.max(2,he.length))})},children:"Remove column"}):null]}),W.map((he,ge)=>{const $e=ge===W.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",gap:"0.4rem",alignItems:"center"},children:[e.jsx("input",{type:"text",value:he,placeholder:`Option ${ge+1}`,onChange:Ge=>{const Ve=Z.map(Ke=>[...Ke]);Ve[je][ge]=Ge.target.value,Ne({...ae,columns:q(Ve),matchingPaths:R(re,Z.length)})}}),$e?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const Ge=Z.map(Ve=>[...Ve]);Ge[je]=Ge[je].filter((Ve,Ke)=>Ke!==ge),Ne({...ae,columns:q(Ge),matchingPaths:R(re,Z.length)})},children:"Remove"})]},`question-column:${je}:row:${ge}`)})]},`question-column:${je}`)),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{const W=[...Z.map(he=>[...he]),[""]],je=re.map(he=>[...he,""]);Ne({...ae,columns:q(W),matchingPaths:R(je,W.length)})},children:"Add column"})}),e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Correct paths (0-based indices)"}),re.map((W,je)=>{const he=je===re.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:`repeat(${Z.length}, minmax(0,1fr)) auto`,gap:"0.35rem",alignItems:"center"},children:[W.map((ge,$e)=>e.jsx("input",{type:"number",min:0,step:1,value:ge,placeholder:`${$e}`,onChange:Ge=>{const Ve=re.map(ut=>[...ut]);Ve[je][$e]=Ge.target.value;const Ke=R(Ve,Z.length),bt=Ke.map(ut=>ut.map(yt=>yt.trim())).filter(ut=>ut.every(yt=>yt!=="")).map(ut=>ut.map(yt=>Number(yt))).filter(ut=>ut.every(yt=>Number.isInteger(yt)&&yt>=0));Ne({...ae,matchingPaths:Ke,answer:{paths:bt}})}},`question-path:${je}:${$e}`)),he?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const ge=re.filter((Ve,Ke)=>Ke!==je),$e=R(ge,Z.length),Ge=$e.map(Ve=>Ve.map(Ke=>Ke.trim())).filter(Ve=>Ve.every(Ke=>Ke!=="")).map(Ve=>Ve.map(Ke=>Number(Ke))).filter(Ve=>Ve.every(Ke=>Number.isInteger(Ke)&&Ke>=0));Ne({...ae,matchingPaths:$e,answer:{paths:Ge}})},children:"Remove"})]},`question-path:${je}`)})]}):null,F==="ordering"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Ordered options (correct order = listed order)"}),fe(ae.options??[""]).map((W,je,he)=>{const ge=je===he.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)",minWidth:"1.5rem"},children:[je+1,"."]}),e.jsx("input",{type:"text",value:W,placeholder:`Step ${je+1}`,onChange:$e=>{const Ge=[...ae.options??[""]];Ge[je]=$e.target.value,Ne({...ae,options:fe(Ge)})}}),ge?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ne({...ae,options:fe((ae.options??[]).filter(($e,Ge)=>Ge!==je))}),children:"Remove"})]},`question-order:${je}`)})]}):null,e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"JSON import"}),e.jsx("textarea",{rows:8,value:se,onChange:W=>Re(W.target.value),placeholder:"Paste question JSON"}),e.jsxs("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:[e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{try{const W=JSON.parse(se);if(Array.isArray(W)){const he=W.map($e=>La($e)).filter($e=>!!$e);if(he.length===0){A("Question JSON array must contain at least one valid question object.");return}const ge=he[0];He(he),V(0),Ne(ge),A(`Loaded question array (${he.length} items).`);return}const je=La(W);if(!je){A("Question JSON must be an object or an array of question objects.");return}He([]),V(0),Ne(je),A(null)}catch{A("Question JSON is invalid.")}},children:"Interpret JSON"}),Le.length>0?e.jsxs("span",{className:"cogita-library-hint",children:["Queue: ",Math.min(st+1,Le.length)," / ",Le.length]}):null]})]})]})]},`payload:${T.key}`)}const x=T.inputType==="textarea"||T.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:T.label}),x?e.jsx("textarea",{rows:T.inputType==="json"?8:4,value:I,onChange:F=>f(H=>({...H,[T.key]:F.target.value})),placeholder:T.key}):e.jsx("input",{type:"text",value:I,onChange:F=>f(H=>({...H,[T.key]:F.target.value})),placeholder:T.key})]},`payload:${T.key}`)},at=T=>{const I=S[T.key]??T.targetTypes[0],x=T.key==="references"&&T.multiple&&T.targetTypes.includes("source"),F=be[T.key]??Va(),H=ie[T.key]??!1,fe=ce[T.key];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:T.label}),T.targetTypes.length>1?e.jsx("select",{value:I,onChange:q=>G(R=>({...R,[T.key]:q.target.value})),children:T.targetTypes.map(q=>e.jsx("option",{value:q,children:lt(t,q)},`${T.key}:${q}`))}):null,T.multiple?e.jsx(Xt,{libraryId:c,infoType:I,label:T.label,placeholder:T.key,multiple:!0,values:w[T.key]??[],onChangeMultiple:q=>K(R=>({...R,[T.key]:q})),allowCreate:!x,searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(Xt,{libraryId:c,infoType:I,label:T.label,placeholder:T.key,value:J[T.key]??null,onChange:q=>L(R=>({...R,[T.key]:q})),searchFailedText:"Search failed",createFailedText:"Create failed"}),x?e.jsxs("div",{children:[e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:H,onChange:q=>$(R=>({...R,[T.key]:q.target.checked}))}),e.jsx("span",{children:t.cogita.library.add.info.referenceToggle})]}),H?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(Ms,{libraryId:c,copy:t,language:h,sourceKindOptions:[...Ls],value:F,onChange:q=>U(R=>({...R,[T.key]:q})),labels:vt}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>rt(T.key),disabled:xe===T.key,children:xe===T.key?t.cogita.library.lookup.saving:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.source)})}),fe?e.jsx("p",{className:"cogita-library-subtitle",children:fe}):null]}):null]}):null]},`link:${T.key}`)},Ue=()=>e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(Ms,{libraryId:c,copy:t,language:h,sourceKindOptions:[...Ls],value:Ce,onChange:Je,labels:vt})]});return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:d?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${c}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[d?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:N,onChange:T=>C(T.target.value),children:Ee.map(T=>e.jsx("option",{value:T.value,children:T.label},T.value))})]}),O==="loading"&&d?e.jsx("p",{children:"Loading..."}):null,ye&&!(O==="loading"&&d)?e.jsxs("div",{className:"cogita-form-grid",children:[ye.payloadFields.filter(T=>!(N==="source"&&(T.key==="sourceKind"||T.key==="locator"))).map(ze),N==="source"?Ue():null,ye.linkFields.filter(T=>!(N==="source"&&T.key==="resource")).map(at)]}):O==="loading"&&d?null:e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:Ae,disabled:O==="saving"||!ye,children:O==="saving"?"Saving...":d?"Update info":"Create info"})}),_?e.jsx("p",{className:"cogita-library-subtitle",children:_}):null]})})})]})})}const Fs=t=>/\s/.test(t),ln=t=>/[\p{L}\p{N}]/u.test(t),Ks=(t,a)=>{const s=a>0?t[a-1]:"",r=a<t.length?t[a]:"";if(!s||!r)return 0;const i=Fs(s),u=Fs(r);if(i||u)return 3;const o=ln(s),j=ln(r);return o!==j?2:!o&&!j?1:0},En=(t,a,s,r,i)=>{const u=Math.max(r-a,s-r);for(let o=0;o<=u;o+=1){const j=r-o;if(j>=a&&j<=s&&Ks(t,j)>=i)return j;const h=r+o;if(h>=a&&h<=s&&Ks(t,h)>=i)return h}return null},Fn=(t,a)=>{const s=a>0?t[a-1]:"",r=a<t.length?t[a]:"";return!s||!r?!0:ln(s)!==ln(r)},Fi=(t,a,s,r)=>{const i=s-a,u=a+r,o=s-r;if(i<=r*2||o<=u)return null;const j=Math.floor((a+s)/2),h=En(t,u,o,j,3);if(h!==null&&Fn(t,h))return h;const b=En(t,u,o,j,2);if(b!==null&&Fn(t,b))return b;const c=En(t,u,o,j,1);return c!==null&&Fn(t,c)?c:null},va=(t,a)=>{const s=Math.max(1,(a==null?void 0:a.minLen)??7),r=Math.max(s,(a==null?void 0:a.maxLen)??13),i={},u=(h,b,c,p,l)=>{const d=String(p),k={id:d,start:h,end:b,text:t.slice(h,b),depth:c,index:p,parentId:l};if(i[d]=k,b-h>r){let N=Fi(t,h,b,s);if(N!==null&&N>h&&N<b){const C=u(h,N,c+1,p*2+1,d),v=u(N,b,c+1,p*2+2,d);k.leftId=C.id,k.rightId=v.id}}return k},o=u(0,t.length,0,0),j=Object.values(i).sort((h,b)=>b.depth-h.depth||h.start-b.start).map(h=>h.id);return{text:t,rootId:o.id,nodes:i,order:j}},Ra=(t,a,s,r,i,u,o)=>{const j=u==="reverse"?t.order.slice().sort((h,b)=>t.nodes[b].start-t.nodes[h].start||t.nodes[b].depth-t.nodes[h].depth):t.order;for(const h of j){if(o&&h===o||a.has(h))continue;const b=t.nodes[h];if(b){if(i&&(b.leftId||b.rightId)){const c=b.leftId?s[b.leftId]??0:r,p=b.rightId?s[b.rightId]??0:r;if((c+p)/2<r)continue}return b}}return null},vn=(t,a)=>({before:t.slice(0,a.start),fragment:t.slice(a.start,a.end),after:t.slice(a.end)});function Ki({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,libraryId:c}){const p=`/#/cogita/library/${c}`,[l,d,k]=Gn([]),[m,N,C]=Yn([]),[v,f]=n.useState(null),[J,L]=n.useState(null),[w,K]=n.useState(null),[S,G]=n.useState(null),_=n.useMemo(()=>l.find($=>$.id===v)??null,[l,v]);n.useEffect(()=>{let $=!0;return Cr({libraryId:c}).then(be=>{if(!$)return;const U=be.nodes.map(ce=>{var Q,xe,oe;return{id:ce.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:ce.payload&&typeof ce.payload=="object"&&"label"in ce.payload?String(ce.payload.label):"Item",nodeType:ce.nodeType,itemType:((Q=ce.payload)==null?void 0:Q.itemType)??"info",itemId:((xe=ce.payload)==null?void 0:xe.itemId)??null,infoType:((oe=ce.payload)==null?void 0:oe.infoType)??null}}});d(U),N(be.edges.map(ce=>({id:ce.edgeId,source:ce.fromNodeId,target:ce.toNodeId})))}).catch(()=>{$&&(d([]),N([]))}),()=>{$=!1}},[c]),n.useEffect(()=>{Ir({libraryId:c}).then(L).catch(()=>L(null))},[c,l,m]);const A=n.useCallback($=>{N(be=>Xn($,be))},[]),O=()=>{const $=crypto.randomUUID();d(be=>[...be,{id:$,type:"default",position:{x:140+be.length*40,y:120+be.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},de=()=>{const $=crypto.randomUUID();d(be=>[...be,{id:$,type:"default",position:{x:180+be.length*40,y:160+be.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},Ce=async()=>{K(null);try{const $=l.map(U=>({nodeId:U.id,nodeType:U.data.nodeType,payload:{itemType:U.data.itemType,itemId:U.data.itemId??null,label:U.data.label,infoType:U.data.infoType??null}})),be=m.map(U=>({edgeId:U.id,fromNodeId:U.source,toNodeId:U.target}));await Mr({libraryId:c,nodes:$,edges:be}),K(t.cogita.library.graph.saveSuccess)}catch{K(t.cogita.library.graph.saveFail)}},Je=$=>{_&&d(be=>be.map(U=>U.id===_.id?{...U,data:{...U.data,itemId:($==null?void 0:$.infoId)??null,itemType:"collection",infoType:"collection",label:($==null?void 0:$.label)??t.cogita.library.infoTypes.collection}}:U))},ie=$=>{_&&d(be=>be.map(U=>U.id===_.id?{...U,data:{...U.data,itemId:($==null?void 0:$.infoId)??null,itemType:"info",infoType:($==null?void 0:$.infoType)??null,label:($==null?void 0:$.label)??t.cogita.library.infoTypes.any}}:U))};return n.useEffect(()=>{if(!_||_.data.nodeType!=="info"||_.data.infoType!=="citation"||!_.data.itemId){G(null);return}let $=!0;return na({libraryId:c,infoId:_.data.itemId}).then(be=>{if(!$)return;const U=be.payload,ce=(U==null?void 0:U.text)??"";if(!ce){G(null);return}const Q=va(ce),xe=Object.values(Q.nodes).sort((oe,ae)=>oe.depth-ae.depth||oe.start-ae.start).map(oe=>({id:oe.id,text:oe.text,depth:oe.depth}));G({title:(U==null?void 0:U.title)??_.data.label,fragments:xe})}).catch(()=>G(null)),()=>{$=!1}},[c,_]),e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:p,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:Ce,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:O,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:de,children:t.cogita.library.actions.addInfo}),J?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(J.totalCollections))})}):null,w?e.jsx("p",{className:"cogita-help",children:w}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(fn,{nodes:l,edges:m,onNodesChange:k,onEdgesChange:C,onConnect:A,onNodeClick:($,be)=>f(be.id),fitView:!0,children:[e.jsx(bn,{gap:18,size:1}),e.jsx(yn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),_?e.jsxs("div",{className:"cogita-graph-inspector",children:[_.data.nodeType==="collection"?e.jsx(Xt,{libraryId:c,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:_.data.itemId?{id:_.data.itemId,label:_.data.label,infoType:"collection"}:null,onChange:Je,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(Xt,{libraryId:c,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:_.data.itemId?{id:_.data.itemId,label:_.data.label,infoType:_.data.infoType??void 0}:null,onChange:ie,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),S?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:S.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:S.fragments.map($=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:$.id}),e.jsx("span",{children:$.text})]},$.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function Ea({children:t,flashState:a,flashTick:s=0,feedbackToken:r,className:i}){const u=r??(a?`${a}-${s}`:"idle"),[o,j]=n.useState("a"),h=n.useRef(u);return n.useEffect(()=>{h.current!==u&&(h.current=u,j(b=>b==="a"?"b":"a"))},[u]),e.jsx("section",{className:i?`cogita-revision-card ${i}`:"cogita-revision-card","data-feedback":u,"data-feedback-variant":o,children:t})}function ss({copy:t,currentCard:a,currentTypeLabel:s,prompt:r,languages:i,answer:u,onAnswerChange:o,computedExpected:j,computedAnswers:h,onComputedAnswerChange:b,answerTemplate:c,outputVariables:p,variableValues:l,computedFieldFeedback:d,feedback:k,canAdvance:m,quoteContext:N,quotePlaceholder:C,onCheckAnswer:v,onSkip:f,onLanguageSelect:J,onMarkReviewed:L,onAdvance:w,showCorrectAnswer:K,setShowCorrectAnswer:S,onRevealCorrect:G,answerMask:_,expectedAnswer:A,hasExpectedAnswer:O,handleComputedKeyDown:de,answerInputRef:Ce,computedInputRefs:Je,scriptMode:ie,setScriptMode:$,matchPairs:be,matchLeftOrder:U,matchRightOrder:ce,matchSelection:Q,matchActiveLeft:xe,matchActiveRight:oe,matchFeedback:ae,onMatchLeftSelect:Me,onMatchRightSelect:se,disableCheckAnswer:Re=!1,hideSkipAction:Le=!1,allowRevealBeforeCheck:He=!1,autoRevealAfterAnswer:st=!1,disableCheckAfterAnswer:V=!1}){const ye=n.useMemo(()=>{var Se;const E=!c&&j.length===2?`The {${j[0].key}} is of type {${j[1].key}}`:null,Y=c??E;if(!Y)return null;const pe=new Map(j.map(Z=>[Z.key,Z.expected])),T=new Set,I=[],x=/\{([^}]+)\}/g;let F=0,H,fe=null;for(;(H=x.exec(Y))!==null;){const Z=Y.slice(F,H.index);Z&&I.push({type:"text",value:Z});const re=((Se=H[1])==null?void 0:Se.trim())??"",W=re&&pe.has(re)?re:re&&p&&p[re]?p[re]:null;re&&T.add(re),W&&T.add(W),W&&pe.has(W)?(I.push({type:"input",value:W}),fe||(fe=W)):re&&l&&l[re]!==void 0?I.push({type:"text",value:l[re]}):I.push({type:"text",value:H[0]}),F=H.index+H[0].length}const q=Y.slice(F);return q&&I.push({type:"text",value:q}),j.filter(Z=>!T.has(Z.key)).length>0?null:{parts:I,expectedByKey:pe,firstInputKey:fe}},[c,j,p,l]),Qe=()=>{if(!ye)return null;const{parts:E,expectedByKey:Y,firstInputKey:pe}=ye;return e.jsx("div",{className:"cogita-revision-inline-answer",children:E.map((T,I)=>{var x,F;return T.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:T.value},`text-${I}`):e.jsx("input",{ref:H=>{Je.current[T.value]=H},autoFocus:T.value===pe,value:h[T.value]??"",onChange:H=>b(T.value,H.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":d[T.value]??(k==="correct"?"correct":k==="incorrect"?"incorrect":void 0),onKeyDown:H=>vt(H)||de(H),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((x=h[T.value])==null?void 0:x.length)??0,((F=Y.get(T.value))==null?void 0:F.length)??6)}ch`}},`input-${T.value}-${I}`)})})},Ee=n.useMemo(()=>{const E=new Map;return(be??[]).forEach(Y=>E.set(Y.leftId,Y)),E},[be]),Ne=n.useMemo(()=>{const E=new Map;return(be??[]).forEach(Y=>E.set(Y.rightId,Y)),E},[be]);n.useEffect(()=>{var I;if(a.cardType!=="info"||a.infoType!=="computed"||j.length===0)return;const E=typeof document<"u"?document.activeElement:null;if(E&&(E.tagName==="INPUT"||E.tagName==="TEXTAREA"))return;const Y=(ye==null?void 0:ye.firstInputKey)??((I=j[0])==null?void 0:I.key);if(!Y)return;const pe=Je.current[Y];if(!pe)return;const T=requestAnimationFrame(()=>{pe.focus()});return()=>cancelAnimationFrame(T)},[a,j,ye]);const tt=(()=>{const E=[A??"",...j.map(T=>T.expected??"")].join(""),Y=[u,...Object.values(h)].join(""),pe=`${E}${Y}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(pe)})(),vt=E=>E.ctrlKey&&(E.key==="^"||E.key==="6")?(E.preventDefault(),$(Y=>Y==="super"?null:"super"),!0):E.ctrlKey&&(E.key==="_"||E.key==="-")?(E.preventDefault(),$(Y=>Y==="sub"?null:"sub"),!0):!1,rt=()=>{if(!A||!_)return A??"";const E=A.split(""),Y=Array.from(_),pe=Y.length>0?Y.reduce((T,I)=>T+I,0)/Y.length:127;return E.map((T,I)=>{const x=Y[I]??pe,F=Math.max(0,Math.min(255,Math.round(x)));let H=255,fe=0;return F<=127?fe=Math.round(F/127*255):(fe=255,H=Math.round(255*(1-(F-127)/128))),e.jsx("span",{style:{color:`rgb(${H}, ${fe}, 0)`},children:T},`mask-${I}`)})},Ae=a.cardType==="info"&&a.infoType==="citation"?(N==null?void 0:N.title)||a.label:a.description,ze=K||st&&k!==null,at=Re||V&&(k!==null||ze),Ue=O&&(He||k==="incorrect"||ze);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[s?e.jsx("span",{children:s}):null,e.jsx("strong",{children:Ae})]}),a.cardType==="vocab"&&a.checkType==="translation-match"&&be?e.jsxs("div",{className:"cogita-revision-body",children:[r?e.jsx("h2",{children:r}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(U??[]).map(E=>{const Y=Ee.get(E);if(!Y)return null;const pe=(Q==null?void 0:Q[E])??null,T=(ae==null?void 0:ae[E])??null,I=xe===E;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":I,"data-state":T??void 0,"data-locked":pe?"true":void 0,onClick:()=>Me==null?void 0:Me(E),children:[e.jsx("span",{children:Y.leftLabel}),pe&&K?e.jsx("em",{children:"✓"}):null]},E)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(ce??[]).map(E=>{const Y=Ne.get(E);if(!Y)return null;const pe=Object.values(Q??{}).includes(E),T=oe===E;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":pe||T,"data-locked":pe?"true":void 0,onClick:()=>se==null?void 0:se(E),children:e.jsx("span",{children:Y.rightLabel})},E)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:a.checkType==="translation-match"||at,children:t.cogita.library.revision.checkAnswer}),Le?null:e.jsx("button",{type:"button",className:"ghost",onClick:f,children:t.cogita.library.revision.skip})]})]}):a.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:Ce,value:u,onChange:E=>o(E.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":k==="correct"?"correct":k==="incorrect"?"incorrect":void 0,onKeyDown:E=>{if(E.key==="Enter")if(E.preventDefault(),E.stopPropagation(),m)w();else{if(at)return;v()}}})]}),tt?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":ie==="super",onClick:()=>$(E=>E==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":ie==="sub",onClick:()=>$(E=>E==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:at,children:t.cogita.library.revision.checkAnswer}),Le?null:e.jsx("button",{type:"button",className:"ghost",onClick:f,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="question"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:Ce,value:u,onChange:E=>o(E.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":k==="correct"?"correct":k==="incorrect"?"incorrect":void 0,onKeyDown:E=>{if(E.key==="Enter")if(E.preventDefault(),E.stopPropagation(),m)w();else{if(at)return;v()}}})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:at,children:t.cogita.library.revision.checkAnswer}),Le?null:e.jsx("button",{type:"button",className:"ghost",onClick:f,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[a.label?e.jsx("p",{className:"cogita-revision-hint",children:a.label}):null,c?null:e.jsx(Lr,{value:r??"",mode:"auto"}),j.length>0?(()=>{const E=Qe();return E?e.jsx("div",{className:"cogita-inline-answer-wrap",children:E}):e.jsx("div",{className:"cogita-form-grid",children:j.map((Y,pe)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:Y.key}),e.jsx("textarea",{ref:T=>{Je.current[Y.key]=T},autoFocus:pe===0,value:h[Y.key]??"",onChange:T=>b(Y.key,T.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":d[Y.key]??(k==="correct"?"correct":k==="incorrect"?"incorrect":void 0),onKeyDown:T=>vt(T)||de(T)})]},Y.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:Ce,value:u,onChange:E=>o(E.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":k==="correct"?"correct":k==="incorrect"?"incorrect":void 0,onKeyDown:E=>{if(!vt(E)&&E.key==="Enter")if(E.preventDefault(),E.stopPropagation(),m)w();else{if(at)return;v()}}})]})}),tt?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":ie==="super",onClick:()=>$(E=>E==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":ie==="sub",onClick:()=>$(E=>E==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:at,children:t.cogita.library.revision.checkAnswer}),Le?null:e.jsx("button",{type:"button",className:"ghost",onClick:f,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="citation"&&N?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(N.completed)).replace("{total}",String(N.total))}),e.jsx("p",{className:"cogita-quote-text",children:N.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:Ce,value:u,onChange:E=>o(E.target.value),placeholder:C??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":k==="correct"?"correct":k==="incorrect"?"incorrect":void 0,onKeyDown:E=>{if(E.key==="Enter")if(E.preventDefault(),E.stopPropagation(),m)w();else{if(at)return;v()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:N.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:at,children:t.cogita.library.revision.checkAnswer}),Le?null:e.jsx("button",{type:"button",className:"ghost",onClick:f,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:i.length?i.map(E=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>J(E.label),children:E.label},E.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:f,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:L,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:f,children:t.cogita.library.revision.skip})]})]}),k&&e.jsx("div",{className:"cogita-revision-feedback","data-state":k,children:k==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),Ue?e.jsxs("div",{className:"cogita-revision-reveal",children:[ze?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>S(E=>{const Y=!E;return Y&&G(),Y}),children:t.cogita.library.revision.showAnswer}),ze?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),j.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[j.map(E=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:E.key}),e.jsx("span",{children:E.expected})]},E.key)),A?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:A})]}):null]}):e.jsx("p",{children:_?rt():A})]}):null]}):null,m?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:w,children:t.cogita.library.revision.nextQuestion})}):null]})}const _s={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},_i=(t,a)=>{const s=Math.max(t.length,a.length,1),r=Math.abs(t.length-a.length);return Math.max(0,1-r/s)},Di=(t,a)=>{const s=new Uint8Array(t.length),r=_i(t,a);for(let i=0;i<t.length;i+=1){const u=t[i]===(a[i]??"")?128:0,o=t.length-1-i,j=a.length-1-i,h=t[o]===(a[j]??"")?127:0,b=Math.round((u+h)*r);s[i]=Math.max(0,Math.min(255,b))}return s},zi=(t,a)=>t===a||(_s[t]??[]).includes(a)?!0:(_s[a]??[]).includes(t),en=(t,a,s)=>s?zi(t,a):t===a,cn=(t,a,s)=>{const r=new Uint8Array(t.length);if(!t.length)return r;const i=(s==null?void 0:s.allowSimilarChars)??!0,u=[];for(let j=0;j<=t.length-3;j+=1)u.push({index:j,text:t.slice(j,j+3)});let o=!1;return u.forEach(j=>{for(let h=0;h<=a.length-3;h+=1){const b=a.slice(h,h+3);let c=0;for(let m=0;m<3;m+=1)en(j.text[m],b[m],i)&&(c+=1);if(c<2)continue;let p=j.index-1,l=h-1;for(;p>=0&&l>=0;){const m=t[p],N=a[l];if(m===N){r[p]=Math.max(r[p],255),p-=1,l-=1,o=!0;continue}if(en(m,N,i)&&m!==N){r[p]=Math.max(r[p],127),p-=1,l-=1,o=!0;continue}if(p>0&&t[p-1]===N){r[p]=Math.max(r[p],0),p-=1,o=!0;continue}if(l>0&&t[p]===a[l-1]){l-=1,o=!0;continue}break}for(let m=0;m<3;m+=1){const N=j.index+m,C=j.text[m],v=b[m],f=C===v?255:en(C,v,i)?127:0;r[N]=Math.max(r[N],f),o=!0}let d=j.index+3,k=h+3;for(;d<t.length&&k<a.length;){const m=t[d],N=a[k];if(m===N){r[d]=Math.max(r[d],255),d+=1,k+=1,o=!0;continue}if(en(m,N,i)&&m!==N){r[d]=Math.max(r[d],127),d+=1,k+=1,o=!0;continue}if(d+1<t.length&&t[d+1]===N){r[d]=Math.max(r[d],0),d+=1,o=!0;continue}if(k+1<a.length&&t[d]===a[k+1]){k+=1,o=!0;continue}break}}}),o?r:Di(t,a)},Kn=t=>/[\p{L}\p{N}]/u.test(t),Ds=t=>t.trim().toLowerCase(),xa=(t,a)=>{if(t.length===0)return 100;const s=(a==null?void 0:a.treatSimilarCharsAsSame)??!1,r=Array.from(t).reduce((i,u)=>s&&u===127?i+255:i+u,0);return Math.round(r/(t.length*255)*100)},Ja=(t,a,s)=>{const r=Math.max(0,Math.min(100,(s==null?void 0:s.thresholdPercent)??100)),i=(s==null?void 0:s.treatSimilarCharsAsSame)??!0,u=(s==null?void 0:s.ignorePunctuationAndSpacing)??!1,o=Ds(t),j=Ds(a);if(!u){const v=cn(o,j,{allowSimilarChars:i}),f=xa(v,{treatSimilarCharsAsSame:i});return{mask:v,percent:f,isCorrect:f>=r,normalizedExpected:o,normalizedAnswer:j}}const h=Array.from(o),b=Array.from(j),c=[],p=[],l=[];h.forEach((v,f)=>{Kn(v)&&(c.push(v),p.push(f))}),b.forEach(v=>{Kn(v)&&l.push(v)});const d=c.join(""),k=l.join(""),m=cn(d,k,{allowSimilarChars:i}),N=new Uint8Array(h.length);for(let v=0;v<N.length;v+=1)N[v]=Kn(h[v]??"")?0:255;for(let v=0;v<m.length;v+=1){const f=p[v];f!==void 0&&(N[f]=m[v])}const C=xa(m,{treatSimilarCharsAsSame:i});return{mask:N,percent:C,isCorrect:C>=r,normalizedExpected:d,normalizedAnswer:k}},$a=(t,a,s)=>{const r=t.trim().toLowerCase(),i=a.trim().toLowerCase();return s==="prefix"||s==="bidirectional"?cn(r,i,{allowSimilarChars:!0}):cn(r,i,{allowSimilarChars:!0})},rs=t=>{if(typeof t!="string")return"";const a=t.trim().toLowerCase();return a==="single_select"||a==="multi_select"?"selection":a==="boolean"||a==="true_false"?"truefalse":a==="order"?"ordering":a==="short"||a==="open"||a==="short_text"?"text":a==="selection"||a==="truefalse"||a==="text"||a==="number"||a==="date"||a==="ordering"||a==="matching"?a:""};function ur(t){if(!t||typeof t!="object")return null;const a=t,s=a.definition&&typeof a.definition=="object"?a.definition:a,r=rs(s.type??s.kind);if(!r)return null;const i=typeof s.title=="string"?s.title:void 0,u=typeof s.question=="string"?s.question:"",o=Array.isArray(s.options)?s.options.map(b=>typeof b=="string"?b:"").filter(Boolean):void 0,j=Array.isArray(s.columns)?s.columns.map(b=>Array.isArray(b)?b.map(c=>typeof c=="string"?c:"").filter(Boolean):[]).filter(b=>b.length>0):void 0,h=(()=>{if(r==="selection")return(Array.isArray(s.answer)?s.answer:Array.isArray(s.correct)?s.correct:[]).map(c=>Number(c)).filter(c=>Number.isInteger(c)&&c>=0).sort((c,p)=>c-p);if(r==="truefalse")return typeof s.answer=="boolean"?s.answer:typeof s.expected=="boolean"?s.expected:!1;if(r==="matching"){const b=s.answer&&typeof s.answer=="object"?s.answer:null;return{paths:(Array.isArray(b==null?void 0:b.paths)?b.paths:Array.isArray(s.correctPairs)?s.correctPairs:[]).map(l=>Array.isArray(l)?l.map(d=>Number(d)).filter(d=>Number.isInteger(d)&&d>=0):[]).filter(l=>l.length>0)}}if(typeof s.answer=="string"||typeof s.answer=="number")return s.answer;if(typeof s.expected=="string"||typeof s.expected=="number")return s.expected})();return{type:r,title:i,question:u,options:o,answer:h,columns:j}}function zs(t){const a=t.map((i,u)=>({value:i,oldIndex:u}));for(let i=a.length-1;i>0;i-=1){const u=Math.floor(Math.random()*(i+1));[a[i],a[u]]=[a[u],a[i]]}const s=a.map(i=>i.value),r=new Map;return a.forEach((i,u)=>r.set(i.oldIndex,u)),{values:s,oldToNew:r}}function Bi(t){if(t.type==="selection"){const a=t.options??[],s=zs(a),r=Array.isArray(t.answer)?t.answer:[];return{...t,options:s.values,answer:r.map(i=>s.oldToNew.get(i)).filter(i=>Number.isInteger(i)).sort((i,u)=>i-u)}}if(t.type==="matching"){const s=(t.columns??[]).map(u=>zs(u)),i=(t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[]).map(u=>u.map((o,j)=>{var h;return((h=s[j])==null?void 0:h.oldToNew.get(o))??o}));return{...t,columns:s.map(u=>u.values),answer:{paths:i}}}return t}function tn(t){return t.map(a=>Number(a)).filter(a=>Number.isInteger(a)&&a>=0).sort((a,s)=>a-s)}function Bs(t){return t.join("|")}function aa(t){const{prompt:a,expected:s,answer:r}=t;if(a.kind==="selection"){const h=Array.isArray(s)?tn(s):[],b=tn(r.selection??[]);return{correct:h.length===b.length&&h.every((p,l)=>p===b[l]),mask:null}}if(a.kind==="boolean")return{correct:typeof s=="boolean"&&r.booleanAnswer!=null&&s===r.booleanAnswer,mask:null};if(a.kind==="ordering"){const h=Array.isArray(s)?s.map(String).join(`
`):Array.isArray(a.options)?a.options.map(String).join(`
`):"",b=Array.isArray(r.ordering)?r.ordering.map(String).join(`
`):"",c=Ja(h,b,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});return{correct:c.isCorrect,mask:c.mask}}if(a.kind==="matching"){const h=s&&typeof s=="object"&&"paths"in s&&Array.isArray(s.paths)?s.paths.map(d=>Array.isArray(d)?tn(d):[]).filter(d=>d.length>0).map(Bs):[],b=(r.matchingPaths??[]).map(d=>Array.isArray(d)?tn(d):[]).filter(d=>d.length>0).map(Bs),c=Array.from(new Set(h)).sort(),p=Array.from(new Set(b)).sort();return{correct:c.length===p.length&&c.every((d,k)=>d===p[k]),mask:null}}if(a.kind==="text"&&a.inputType==="number"){const h=Number(s),b=Number(r.text??"");return{correct:Number.isFinite(h)&&Number.isFinite(b)&&Math.abs(h-b)<1e-9,mask:null}}const i=typeof s=="string"||typeof s=="number"?String(s):"",u=String(r.text??""),o=a.kind==="citation-fragment",j=Ja(i,u,{thresholdPercent:o?90:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:o});return{correct:j.isCorrect,mask:j.mask}}function Vi(t){const a=[...t];for(let s=a.length-1;s>0;s-=1){const r=Math.floor(Math.random()*(s+1));[a[s],a[r]]=[a[r],a[s]]}return a}function la(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function Vs(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function qs(t){const a=t.checkType??"info",s=a.startsWith("question-")?`question / ${a.slice(9)}`:a;return t.direction?`${s} / ${t.direction}`:s}function qi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,libraryId:c,infoId:p,selectedReviewerRoleId:l}){const[d,k]=n.useState(p),[m,N]=n.useState([]),[C,v]=n.useState([]),[f,J]=n.useState("loading"),[L,w]=n.useState(null),[K,S]=n.useState(null),[G,_]=n.useState(null),[A,O]=n.useState(null),[de,Ce]=n.useState(""),[Je,ie]=n.useState(null),[$,be]=n.useState(1),[U,ce]=n.useState(null),[Q,xe]=n.useState(0),[oe,ae]=n.useState(!1),[Me,se]=n.useState(null),[Re,Le]=n.useState({}),[He,st]=n.useState({}),[V]=n.useState({}),[ye,Qe]=n.useState(null),[Ee,Ne]=n.useState({selection:[],booleanAnswer:null,ordering:[],matchingRows:[],matchingSelection:[]}),tt=n.useRef(null),vt=n.useRef({}),rt=Wa();n.useEffect(()=>{let q=!1;return J("loading"),Promise.all([na({libraryId:c,infoId:p}).catch(()=>null),sn({libraryId:c,infoId:p}),rn({libraryId:c,infoId:p})]).then(([R,Se,Z])=>{if(q)return;const re=(R==null?void 0:R.payload)??{},W=typeof re.title=="string"&&re.title||typeof re.label=="string"&&re.label||typeof re.name=="string"&&re.name||p;k(W),S(re),_((R==null?void 0:R.infoType)??null),N(Se.items),v(Z.items),J("ready")}).catch(()=>{q||(S(null),_(null),N([]),v([]),J("error"))}),()=>{q=!0}},[c,p]),n.useEffect(()=>{if(G!=="translation"){O(null);return}er({libraryId:c,infoId:p,approachKey:"vocab-card"}).then(q=>O(q.projection??null)).catch(()=>O(null))},[G,p,c]);const Ae=n.useMemo(()=>{var je;const q=new Map(m.map(he=>[la(he),he])),R=new Map,Se=new Map;for(const he of m)R.set(la(he),0),Se.set(la(he),[]);for(const he of C){const ge=Vs({parentItemId:he.parentItemId,parentCheckType:he.parentCheckType,parentDirection:he.parentDirection}),$e=[he.childItemId,he.childCheckType??"",he.childDirection??""].join("|");!q.has(ge)||!q.has($e)||((je=Se.get(ge))==null||je.push($e),R.set($e,(R.get($e)??0)+1))}const Z=Array.from(R.entries()).filter(([,he])=>he===0).map(([he])=>he),re=new Map;for(const he of Z)re.set(he,0);for(;Z.length;){const he=Z.shift(),ge=re.get(he)??0;for(const $e of Se.get(he)??[]){const Ge=Math.max(re.get($e)??0,ge+1);re.set($e,Ge),R.set($e,(R.get($e)??1)-1),(R.get($e)??0)<=0&&Z.push($e)}}const W=new Map;for(const he of m){const ge=la(he),$e=re.get(ge)??0,Ge=W.get($e)??[];Ge.push(ge),W.set($e,Ge)}return m.map(he=>{const ge=la(he),$e=re.get(ge)??0,Ge=W.get($e)??[ge],Ve=Math.max(0,Ge.indexOf(ge));return{id:ge,position:{x:40+Ve*290+($e%2?18:0),y:30+$e*120},draggable:!1,selectable:!0,data:{label:he.label,subtitle:qs(he),checkType:he.checkType??"info",direction:he.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[m,C]),ze=n.useMemo(()=>new Map(m.map(q=>[la(q),q])),[m]),at=n.useMemo(()=>{const q=[];for(const R of C){const Se=Vs({parentItemId:R.parentItemId,parentCheckType:R.parentCheckType,parentDirection:R.parentDirection}),Z=[R.childItemId,R.childCheckType??"",R.childDirection??""].join("|");!ze.has(Se)||!ze.has(Z)||q.push({id:`${Se}->${Z}`,source:Se,target:Z,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return q},[ze,C]),Ue=n.useMemo(()=>L?ze.get(L)??null:null,[ze,L]);n.useEffect(()=>{Ce(""),ce(null),xe(0),ae(!1),se(null),ie(null),st({}),Ne({selection:[],booleanAnswer:null,ordering:[],matchingRows:[],matchingSelection:[]})},[L]);const E=n.useMemo(()=>{var re,W;if(!Ue)return null;const q=G??Ue.infoType??null,R=Ue.checkType??"info",Se=Ue.direction??null,Z=K??{};if(Ue.cardType==="vocab"&&A&&Array.isArray(A.words)){const je=A.words,he=((re=je[0])==null?void 0:re.label)??"?",ge=((W=je[1])==null?void 0:W.label)??"?";return Se==="a-to-b"?{kind:"vocab",prompt:String(he),expected:String(ge)}:Se==="b-to-a"?{kind:"vocab",prompt:String(ge),expected:String(he)}:{kind:"generic",prompt:`${he} ↔ ${ge}`,expected:`${he} ↔ ${ge}`}}if(q==="citation"&&R==="quote-fragment"&&Se&&typeof Z.text=="string"){const je=Se,he=va(Z.text),ge=he.nodes[je];if(ge){const $e=vn(Z.text,ge);return{kind:"citation-fragment",expected:ge.text,quoteContext:{title:d,before:$e.before,after:$e.after,total:Object.keys(he.nodes).length,completed:0},quotePlaceholder:ge.text.length>0?".".repeat(Math.max(4,Math.min(18,ge.text.length))):"..."}}}if(q==="question"){const je=ur(Z);if(je)return{kind:"question",definition:Bi(je)}}return{kind:"generic",prompt:Ue.description||Ue.label,expected:Ue.label}},[G,K,Ue,d,A]);n.useEffect(()=>{var R;if(!E||E.kind!=="question")return;const q=E.definition;Ne({selection:[],booleanAnswer:null,ordering:q.type==="ordering"?Vi(q.options??[]):[],matchingRows:[],matchingSelection:q.type==="matching"?new Array(Math.max(2,((R=q.columns)==null?void 0:R.length)??2)).fill(null):[]})},[E,L]);const Y=async q=>{if(Ue&&l)try{await Ar({libraryId:c,outcome:{itemType:"info",itemId:Ue.cardId,checkType:Ue.checkType??"info",direction:Ue.direction??null,revisionType:"direct",evalType:"direct-check",correct:q,clientId:"cogita-info-checkcards",clientSequence:$,personRoleId:l}}),be(R=>R+1),ie(q?"Saved as correct.":"Saved as incorrect.")}catch{ie("Failed to save answer.")}},pe=Ue?la(Ue):null,T=pe?!!Re[pe]:!1,I=async()=>{if(!Ue||!E)return;const q=la(Ue);if(Re[q]){ie("This card was already checked.");return}const R=E.kind==="question"?E.definition.type==="selection"?{kind:"selection",options:E.definition.options??[]}:E.definition.type==="truefalse"?{kind:"boolean"}:E.definition.type==="ordering"?{kind:"ordering",options:E.definition.options??[]}:E.definition.type==="matching"?{kind:"matching",columns:E.definition.columns??[]}:{kind:"text",inputType:E.definition.type==="number"?"number":E.definition.type==="date"?"date":"text"}:{kind:E.kind==="citation-fragment"?"citation-fragment":"text",inputType:"text"},Se=E.kind==="question"?E.definition.answer:E.expected,Z=aa({prompt:R,expected:Se,answer:{text:de,selection:Ee.selection,booleanAnswer:Ee.booleanAnswer,ordering:Ee.ordering,matchingPaths:Ee.matchingRows}}),re=Z.correct;se(Z.mask),ae(!0),ce(re?"correct":"incorrect"),xe(W=>W+1),ie(l?null:"Answer checked locally (not saved: no person selected)."),Le(W=>({...W,[q]:!0})),l&&await Y(re)},x=()=>{if(!Ue||!E)return;const q=la(Ue);if(Re[q]||(Le(Se=>({...Se,[q]:!0})),ie("Answer revealed (not saved).")),E.kind==="question"){se(null);return}const R=Ja(E.expected,E.expected,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:E.kind==="citation-fragment"});se(R.mask)},F=n.useMemo(()=>Ue?Ue.infoType==="question"?{...Ue,description:Ue.label}:Ue.infoType==="citation"?{...Ue,description:d}:{...Ue,description:Ue.label}:null,[Ue,d]),H=q=>{var ut,yt;const R=q.definition,Se=T||oe,Z=Array.isArray(R.answer)?R.answer:[],re=R.answer&&typeof R.answer=="object"&&"paths"in R.answer?R.answer.paths:[],W=Math.max(2,((ut=R.columns)==null?void 0:ut.length)??2),je=R.type==="matching"?Ee.matchingRows.filter(We=>We.length===W&&We.every(De=>Number.isInteger(De)&&De>=0)):[],he=Array.from({length:W},(We,De)=>Ee.matchingSelection[De]??null),ge=We=>We.join("|"),$e=new Map;for(const We of re){const De=ge(We);$e.set(De,($e.get(De)??0)+1)}const Ge=new Map;for(const We of je){const De=ge(We);Ge.set(De,(Ge.get(De)??0)+1)}const Ve=re.filter(We=>{const De=ge(We),mt=Ge.get(De)??0;return mt>0?(Ge.set(De,mt-1),!1):!0}),Ke=new Map;for(const We of Ve)We.forEach((De,mt)=>{const it=Ke.get(mt)??new Map;it.set(De,(it.get(De)??0)+1),Ke.set(mt,it)});const bt=(We,De)=>{Se||Ne(mt=>{var St;const it=Math.max(2,((St=R.columns)==null?void 0:St.length)??2),pt=Array.from({length:it},(ht,Kt)=>mt.matchingSelection[Kt]??null);if(pt[We]=pt[We]===De?null:De,pt.some(ht=>ht==null))return{...mt,matchingSelection:pt};const Bt=pt.map(ht=>Number(ht)),It=ge(Bt),Nt=mt.matchingRows.filter(ht=>ge(ht)===It).length;return($e.get(It)??0)>Nt?(ce("correct"),xe(ht=>ht+1),ie(null),{...mt,matchingRows:[...mt.matchingRows,Bt],matchingSelection:new Array(it).fill(null)}):(ce("incorrect"),xe(ht=>ht+1),ie("This path is not valid or has already been used."),{...mt,matchingSelection:new Array(it).fill(null)})})};return e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:R.question||(Ue==null?void 0:Ue.label)}),R.title?e.jsx("p",{className:"cogita-revision-hint",children:R.title}):null,R.type==="selection"?e.jsx("div",{className:"cogita-choice-grid",style:{gridTemplateColumns:"1fr"},children:(R.options??[]).map((We,De)=>e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.6rem"},children:[e.jsx("input",{type:"checkbox",checked:Ee.selection.includes(De),disabled:Se,onChange:mt=>Ne(it=>({...it,selection:mt.target.checked?Array.from(new Set([...it.selection,De])):it.selection.filter(pt=>pt!==De)}))}),e.jsx("span",{children:We})]},`q-opt:${De}`))}):null,R.type==="truefalse"?e.jsxs("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:[e.jsx("button",{type:"button",className:"ghost","data-active":Ee.booleanAnswer===!0,disabled:Se,onClick:()=>Ne(We=>({...We,booleanAnswer:!0})),children:"True"}),e.jsx("button",{type:"button",className:"ghost","data-active":Ee.booleanAnswer===!1,disabled:Se,onClick:()=>Ne(We=>({...We,booleanAnswer:!1})),children:"False"})]}):null,R.type==="text"||R.type==="number"||R.type==="date"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:tt,type:R.type==="date"?"date":"text",value:de,onChange:We=>Ce(We.target.value),disabled:Se,"data-state":U==="correct"?"correct":U==="incorrect"?"incorrect":void 0})]}):null,R.type==="ordering"?e.jsx("div",{style:{display:"grid",gap:"0.45rem"},children:Ee.ordering.map((We,De)=>e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)"},children:[De+1,"."]}),e.jsx("span",{children:We}),e.jsx("button",{type:"button",className:"ghost",disabled:Se||De===0,onClick:()=>Ne(mt=>{const it=[...mt.ordering];return[it[De-1],it[De]]=[it[De],it[De-1]],{...mt,ordering:it}}),children:"Up"}),e.jsx("button",{type:"button",className:"ghost",disabled:Se||De>=Ee.ordering.length-1,onClick:()=>Ne(mt=>{const it=[...mt.ordering];return[it[De+1],it[De]]=[it[De],it[De+1]],{...mt,ordering:it}}),children:"Down"})]},`q-order:${De}:${We}`))}):null,R.type==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.65rem"},children:[e.jsx("div",{style:{display:"grid",gap:"0.65rem",gridTemplateColumns:`repeat(${Math.max(2,((yt=R.columns)==null?void 0:yt.length)??2)}, minmax(0, 1fr))`,alignItems:"start"},children:(R.columns??[]).map((We,De)=>e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.35rem",padding:"0.6rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:`Column ${De+1}`}),We.map((mt,it)=>{var pt;return e.jsxs("button",{type:"button",className:"ghost cogita-checkcard-row",style:{textAlign:"left"},disabled:Se||he[De]!==it&&(((pt=Ke.get(De))==null?void 0:pt.get(it))??0)<=0,"data-active":he[De]===it?"true":void 0,onClick:()=>bt(De,it),children:[e.jsx("span",{children:mt}),e.jsx("small",{children:it})]},`q-col:${De}:${it}`)})]},`q-col:${De}`))}),e.jsxs("div",{style:{display:"grid",gap:"0.4rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:"Selected paths"}),je.length?je.map((We,De)=>e.jsxs("div",{className:"cogita-share-row",style:{alignItems:"center"},children:[e.jsx("span",{children:We.map((mt,it)=>{var Bt,It;const pt=String(((It=(Bt=R.columns)==null?void 0:Bt[it])==null?void 0:It[mt])??mt);return`${it>0?" -> ":""}${pt}`})}),Se?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ne(mt=>({...mt,matchingRows:mt.matchingRows.filter((it,pt)=>pt!==De)})),children:"Remove"})]},`q-path:${De}`)):e.jsx("p",{className:"cogita-library-hint",children:"Choose one option in each column. After the last column is selected, the path is checked automatically."})]})]}):null,e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>void I(),disabled:Se,children:t.cogita.library.revision.checkAnswer})}),oe?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),R.type==="selection"?e.jsx("p",{children:Z.length?Z.map(We=>{var De;return`${We}${(De=R.options)!=null&&De[We]?`: ${R.options[We]}`:""}`}).join(", "):"-"}):R.type==="truefalse"?e.jsx("p",{children:String(!!R.answer)}):R.type==="ordering"?e.jsx("ol",{children:(R.options??[]).map((We,De)=>e.jsx("li",{children:We},`ans-order:${De}`))}):R.type==="matching"?e.jsx("div",{style:{display:"grid",gap:"0.35rem"},children:re.length?re.map((We,De)=>e.jsx("p",{children:We.join(" → ")},`ans-path:${De}`)):e.jsx("p",{children:"-"})}):e.jsx("p",{children:String(R.answer??"")})]}):e.jsx("div",{className:"cogita-revision-reveal",children:e.jsx("button",{type:"button",className:"ghost",onClick:()=>{ae(!0),x()},children:t.cogita.library.revision.showAnswer})})]})},fe=n.useMemo(()=>G?lt(t,G):t.cogita.library.infoTypes.any,[t,G]);return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:fe}),e.jsx("h2",{className:"cogita-card-title",children:d}),e.jsx("p",{className:"cogita-card-subtitle",children:p})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${m.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${C.length}`}),e.jsx("button",{type:"button",className:"cta",disabled:m.length===0,onClick:()=>rt(`/cogita/library/${c}/revision/run?libraryTarget=revisions&scope=info&infoId=${encodeURIComponent(p)}`),children:"Start revision"})]})]}),f==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):f==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(fn,{nodes:Ae,edges:at,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:(q,R)=>w(R.id),panOnDrag:!0,children:[e.jsx(bn,{}),e.jsx(yn,{showInteractive:!1})]})}),Ue?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[E&&F?e.jsx(Ea,{flashState:U,flashTick:Q,children:E.kind==="question"?H(E):e.jsx(ss,{copy:t,currentCard:F,currentTypeLabel:"",prompt:E.kind==="citation-fragment"?null:E.prompt,languages:[],answer:de,onAnswerChange:Ce,computedExpected:[],computedAnswers:He,onComputedAnswerChange:(q,R)=>st(Se=>({...Se,[q]:R})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:V,feedback:U,canAdvance:!1,quoteContext:E.kind==="citation-fragment"?E.quoteContext:null,quotePlaceholder:E.kind==="citation-fragment"?E.quotePlaceholder:null,onCheckAnswer:()=>void I(),onSkip:()=>w(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:oe,setShowCorrectAnswer:ae,onRevealCorrect:x,answerMask:Me,expectedAnswer:E.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:tt,computedInputRefs:vt,scriptMode:ye,setScriptMode:Qe,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:T||oe,hideSkipAction:!0,allowRevealBeforeCheck:!0,autoRevealAfterAnswer:!0,disableCheckAfterAnswer:!0})}):null,l?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),Je?e.jsx("p",{className:"cogita-library-hint",children:Je}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:m.map(q=>{const R=la(q),Se=L===R;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${Se?"active":""}`,onClick:()=>w(R),children:[e.jsx("span",{children:q.label}),e.jsx("small",{children:qs(q)})]},R)})})]})]})]})})})})})}function an(t,a){var s,r;return((r=(s=t.fields.find(i=>i.fieldType===a))==null?void 0:s.plainValue)==null?void 0:r.trim())??""}function Oi(t){return an(t,"role_kind").toLowerCase()==="person"}function Ui(t){return an(t,"label")||an(t,"display_name")||an(t,"name")||t.roleId}function Ji({copy:t,onPersonCreated:a}){const[s,r]=n.useState([]),[i,u]=n.useState("loading"),[o,j]=n.useState(null),[h,b]=n.useState(!1),[c,p]=n.useState(""),l=async()=>{u("loading");try{const m=await tr();r(m),u("ready")}catch{r([]),u("error")}};n.useEffect(()=>{l()},[]);const d=n.useMemo(()=>s.filter(Oi).map(m=>({roleId:m.roleId,label:Ui(m)})).sort((m,N)=>m.label.localeCompare(N.label)),[s]),k=async()=>{const m=c.trim();if(!m){j("Name is required.");return}b(!0),j(null);try{const N=await Rr({fields:[{fieldType:"nick",plainValue:m},{fieldType:"role_kind",plainValue:"person"},{fieldType:"label",plainValue:m},{fieldType:"display_name",plainValue:m}]});p(""),j("Person role created."),a==null||a(N.roleId),await l()}catch{j("Failed to create person role.")}finally{b(!1)}};return e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-browser-panel",children:[e.jsx("div",{className:"cogita-info-overview-head",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Cogita"}),e.jsx("h2",{className:"cogita-card-title",children:"Persons"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Select reviewer persons in the header and create new person roles here."})]})}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Create"}),e.jsx("h3",{className:"cogita-detail-title",children:"New person role"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{type:"text",value:c,onChange:m=>p(m.target.value),placeholder:"e.g. Anna Kowalska",disabled:h})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:k,disabled:h,children:h?"Creating...":"Create person"})}),o?e.jsx("p",{className:"cogita-library-hint",children:o}):null]})]}),e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Overview"}),e.jsx("h3",{className:"cogita-detail-title",children:"All person roles"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[i==="loading"?e.jsx("p",{children:"Loading persons..."}):null,i==="error"?e.jsx("p",{children:"Failed to load persons."}):null,i==="ready"&&d.length===0?e.jsx("p",{children:"No person roles found."}):null,i==="ready"&&d.length>0?e.jsxs("div",{className:"cogita-details-grid",children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:"Name"}),e.jsx("span",{children:"Type"}),e.jsx("span",{children:"Role ID"}),e.jsx("span",{})]}),d.map(m=>e.jsxs("div",{className:"cogita-details-row",role:"row",children:[e.jsx("span",{}),e.jsx("span",{title:m.label,children:m.label}),e.jsx("span",{children:"person"}),e.jsx("span",{title:m.roleId,children:m.roleId}),e.jsx("span",{})]},m.roleId))]}):null]})]})]})]})})})})}function Hi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,libraryId:c,collectionId:p}){const{libraryName:l}=ua(c),[d,k]=n.useState([]),[m,N]=n.useState("loading"),[C,v]=n.useState("idle"),f=n.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),J=`/#/cogita/library/${c}`,L=()=>{N("loading"),ar({libraryId:c}).then(S=>{k(S),N("idle")}).catch(()=>{k([]),N("error")})};n.useEffect(()=>{L()},[c]);const w=async S=>{try{await nr({libraryId:c,shareId:S}),L()}catch{L()}},K=async S=>{const G=`${f}/${S}`;try{await navigator.clipboard.writeText(G),v("copied")}catch{v("failed")}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:J,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${J}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[m==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):m==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):d.filter(S=>!p||S.collectionId===p).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:d.filter(S=>!p||S.collectionId===p).map(S=>e.jsxs("div",{className:"cogita-share-row","data-state":S.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:S.revisionName}),e.jsx("div",{className:"cogita-share-meta",children:S.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(S.createdUtc).toLocaleString(),S.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),S.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${f}/${S.shareCode}`}):null]}),S.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[S.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>K(S.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>w(S.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},S.shareId))}),C==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):C==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function Wi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,libraryId:c}){const{libraryName:p}=ua(c),[l,d]=n.useState(null),[k,m]=n.useState(null),[N,C]=n.useState(null),[v,f]=n.useState(null),[J,L]=n.useState(null),[w,K]=n.useState(null),S=n.useRef(null),G=O=>{if(!Number.isFinite(O))return"0 B";if(O<1024)return`${O} B`;const de=O/1024;if(de<1024)return`${de.toFixed(1)} KB`;const Ce=de/1024;return Ce<1024?`${Ce.toFixed(1)} MB`:`${(Ce/1024).toFixed(1)} GB`},_=async()=>{d(null),L({loadedBytes:0,totalBytes:null,percent:null});try{d(t.cogita.library.overview.exporting);const O=await $r(c,L),de=URL.createObjectURL(O),Ce=document.createElement("a");Ce.href=de,Ce.download=`cogita-library-${p||c}.json`,Ce.click(),URL.revokeObjectURL(de),d(t.cogita.library.overview.exportReady)}catch{d(t.cogita.library.overview.exportFail)}finally{L(O=>O??{loadedBytes:0,totalBytes:null,percent:null})}},A=async O=>{var Ce;m(null),C(null),f(null);const de=(Ce=O.target.files)==null?void 0:Ce[0];if(de)try{m(t.cogita.library.overview.importing),K({loadedBytes:0,totalBytes:de.size,percent:0});const Je=await Pr(c,de,K,ie=>{const $=ie.stage==="infos"?t.cogita.library.overview.importStageInfos:ie.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;f(t.cogita.library.overview.importLiveProgress.replace("{stage}",$).replace("{done}",String(ie.processed)).replace("{total}",String(ie.total)).replace("{infos}",String(ie.infos)).replace("{connections}",String(ie.connections)).replace("{collections}",String(ie.collections)))});C({infos:Je.infosImported,connections:Je.connectionsImported,collections:Je.collectionsImported}),m(t.cogita.library.overview.importDone)}catch(Je){const ie=Je instanceof as&&Je.message?` ${Je.message}`:"";m(`${t.cogita.library.overview.importFail}${ie}`)}finally{S.current&&(S.current.value="")}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:_,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:S,type:"file",accept:"application/json",onChange:A})]})]}),J?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:J.percent??void 0,max:J.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",G(J.loadedBytes)).replace("{total}",J.totalBytes?G(J.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,w?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:w.percent??void 0,max:w.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",G(w.loadedBytes)).replace("{total}",w.totalBytes?G(w.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,l?e.jsx("p",{className:"cogita-help",children:l}):null,k?e.jsx("p",{className:"cogita-help",children:k}):null,v?e.jsx("p",{className:"cogita-help",children:v}):null,N?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(N.infos)).replace("{connections}",String(N.connections)).replace("{collections}",String(N.collections))}):null]})]})})})]})})}function Qi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,libraryId:c}){const{libraryName:p}=ua(c),[l,d]=n.useState(""),[k,m]=n.useState([]),N=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:C=>d(C.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const C=l.trim();C&&(m(v=>[{id:N(),name:C},...v]),d(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[k.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,k.map(C=>e.jsx("button",{type:"button",className:"ghost",children:C.name},C.id))]})]})]})})})]})})}function Gi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,libraryId:c}){const{libraryName:p}=ua(c),[l,d]=n.useState(""),[k,m]=n.useState([]),N=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:C=>d(C.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const C=l.trim();C&&(m(v=>[{id:N(),name:C},...v]),d(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[k.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,k.map(C=>e.jsx("button",{type:"button",className:"ghost",children:C.name},C.id))]})]})]})})})]})})}function Yi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,libraryId:c}){const{libraryName:p}=ua(c),l=`/#/cogita/library/${c}`,[d,k]=n.useState(""),[m,N]=n.useState([]),[C,v]=n.useState("idle"),[f,J]=n.useState(0),[L,w]=n.useState(null);n.useEffect(()=>{v("loading");const S=window.setTimeout(()=>{Oa({libraryId:c,query:d.trim()||void 0,limit:30}).then(G=>{N(G.items),J(G.total),w(G.nextCursor??null),v("ready")}).catch(()=>{N([]),J(0),w(null),v("ready")})},240);return()=>window.clearTimeout(S)},[c,d]);const K=async()=>{if(L){v("loading");try{const S=await Oa({libraryId:c,query:d.trim()||void 0,limit:30,cursor:L});N(G=>[...G,...S.items]),w(S.nextCursor??null),J(S.total),v("ready")}catch{v("ready")}}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:p}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${l}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:d,onChange:S=>k(S.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(m.length)).replace("{total}",String(f||m.length))}),e.jsx("span",{children:C==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:m.length?m.map(S=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${l}/collections/${S.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:S.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(S.itemCount))," ·"," ",S.notes||t.cogita.library.collections.noNotes]})]})},S.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${l}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),L?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:K,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const Ie=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,ta=(t,a,s,r)=>`${t}:${a}:${s??""}:${r??""}`;function Xi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,libraryId:c,collectionId:p}){ua(c);const l=`/#/cogita/library/${c}`,[d,k]=n.useState(t.cogita.library.collections.defaultName),[m,N]=n.useState(null),[C,v]=n.useState(0),[f,J]=n.useState([]),[L,w]=n.useState("idle"),[K,S]=n.useState(null),G=n.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(f.length)).replace("{total}",String(C||f.length)),[t,f.length,C]);n.useEffect(()=>{xn(c,p).then(A=>{k(A.name),N(A.notes??null),v(A.itemCount)}).catch(()=>{k(t.cogita.library.collections.defaultName),N(null)})},[c,p]),n.useEffect(()=>{w("loading"),Ua({libraryId:c,collectionId:p,limit:40}).then(A=>{J(A.items),S(A.nextCursor??null),v(A.total),w("ready")}).catch(()=>{J([]),S(null),w("ready")})},[c,p]);const _=async()=>{if(K){w("loading");try{const A=await Ua({libraryId:c,collectionId:p,limit:40,cursor:K});J(O=>[...O,...A.items]),S(A.nextCursor??null),v(A.total),w("ready")}catch{w("ready")}}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:d}),e.jsx("p",{className:"cogita-library-subtitle",children:m||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${l}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${l}/collections/${p}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${l}/collections/${p}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:G}),e.jsx("span",{children:L==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:f.length?f.map(A=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:A.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:A.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:A.label}),e.jsx("p",{className:"cogita-card-subtitle",children:A.description})]})},Ie(A))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),K?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:_,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${l}/collections/${p}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const Os=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],Zi={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},eo=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],to=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function ao({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,libraryId:c,onCreated:p}){const l=Pa(),{libraryName:d}=ua(c),k=`/#/cogita/library/${c}`,[m,N]=n.useState(null),[C,v]=n.useState(""),[f,J]=n.useState(""),[L,w,K]=Gn([]),[S,G,_]=Yn([]),[A,O]=n.useState(null),[de,Ce]=n.useState(null),Je=n.useRef(null),ie=n.useMemo(()=>L.find(Q=>Q.id===A)??null,[L,A]);n.useEffect(()=>{const Q=new URLSearchParams(l.search),xe=(Q.get("draft")??"").trim(),oe=(Q.get("draftType")??"").trim();if(!xe||oe!=="info-selection"||Je.current===xe)return;const ae=Ni(c,xe);if(!ae||ae.infoIds.length===0)return;const Me=crypto.randomUUID(),se=ae.infoIds.length>1?crypto.randomUUID():null,Re=ae.infoIds.map((V,ye)=>({id:crypto.randomUUID(),type:"default",position:{x:80,y:80+ye*100},data:{nodeType:"source.info",label:"Selected info",params:{infoId:V,infoType:"any"}}})),Le=se?[{id:se,type:"default",position:{x:360,y:120+Math.max(0,(ae.infoIds.length-1)*50)},data:{nodeType:"logic.or",label:"Selected infos",params:{}}}]:[],He={id:Me,type:"default",position:{x:660,y:140+Math.max(0,(ae.infoIds.length-1)*35)},data:{nodeType:"output.collection",label:"Collection output",params:{}}},st=Re.map(V=>({id:crypto.randomUUID(),source:V.id,target:se??Me}));se&&st.push({id:crypto.randomUUID(),source:se,target:Me}),w([...Re,...Le,He]),G(st),O(Me),Ce(`Draft loaded from ${ae.infoIds.length} selected infos. Set name and save to create collection.`),Je.current=xe},[c,l.search,G,w]);const $=Q=>{var Me;const xe=crypto.randomUUID(),oe=((Me=Os.find(se=>se.type===Q))==null?void 0:Me.label)??Q,ae={...Zi[Q]};w(se=>[...se,{id:xe,type:"default",position:{x:120+se.length*40,y:120+se.length*40},data:{nodeType:Q,label:oe,params:ae}}]),O(xe)},be=n.useCallback(Q=>{G(xe=>Xn({...Q,id:crypto.randomUUID()},xe))},[G]),U=Q=>{ie&&w(xe=>xe.map(oe=>oe.id===ie.id?{...oe,data:{...oe.data,params:Q}}:oe))},ce=async()=>{if(Ce(null),!C.trim()){Ce(t.cogita.library.collections.saveRequiredName);return}try{const Q={nodes:L.map(ae=>({nodeId:ae.id,nodeType:ae.data.nodeType,payload:{position:ae.position,params:ae.data.params}})),edges:S.map(ae=>({edgeId:ae.id,fromNodeId:ae.source,fromPort:ae.sourceHandle??null,toNodeId:ae.target,toPort:ae.targetHandle??null}))};let xe=m,oe=!1;if(xe)await sr({libraryId:c,collectionId:xe,nodes:Q.nodes,edges:Q.edges});else{const ae=await Er({libraryId:c,name:C.trim(),notes:f.trim()||void 0,items:[],graph:Q});xe=ae.collectionId,oe=!0,N(ae.collectionId)}Ce(oe?t.cogita.library.collections.saveSuccess:t.cogita.library.graph.saveSuccess),p(xe)}catch{Ce(m?t.cogita.library.graph.saveFail:t.cogita.library.collections.saveFail)}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.createKicker}),e.jsx("h1",{className:"cogita-library-title",children:d}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.createSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:k,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${k}/collections`,children:t.cogita.library.actions.collections}),e.jsx("button",{type:"button",className:"cta",onClick:ce,children:t.cogita.library.actions.saveCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.collectionInfoTitle}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{value:C,onChange:Q=>v(Q.target.value),placeholder:t.cogita.library.collections.namePlaceholder})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.notesLabel}),e.jsx("textarea",{value:f,onChange:Q=>J(Q.target.value),placeholder:t.cogita.library.collections.notesPlaceholder})]}),de?e.jsx("p",{className:"cogita-help",children:de}):null,e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Os.map(Q=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>$(Q.type),children:Q.label},Q.type))})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(fn,{nodes:L,edges:S,onNodesChange:K,onEdgesChange:_,onConnect:be,onNodeClick:(Q,xe)=>O(xe.id),fitView:!0,children:[e.jsx(bn,{color:"rgba(120,160,200,0.2)"}),e.jsx(yn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),ie?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:ie.data.label}),ie.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Xt,{libraryId:c,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:ie.data.params.tagId?{id:ie.data.params.tagId,label:ie.data.params.tagLabel??"",infoType:"topic"}:null,onChange:Q=>U({...ie.data.params,tagId:(Q==null?void 0:Q.id)??null,tagLabel:(Q==null?void 0:Q.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:ie.data.params.scope??"any",onChange:Q=>U({...ie.data.params,scope:Q.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),ie.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Xt,{libraryId:c,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:ie.data.params.languageId?{id:ie.data.params.languageId,label:ie.data.params.languageLabel??"",infoType:"language"}:null,onChange:Q=>U({...ie.data.params,languageId:(Q==null?void 0:Q.id)??null,languageLabel:(Q==null?void 0:Q.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:ie.data.params.scope??"any",onChange:Q=>U({...ie.data.params,scope:Q.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),ie.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:ie.data.params.infoType??"word",onChange:Q=>U({...ie.data.params,infoType:Q.target.value}),children:to.map(Q=>e.jsx("option",{value:Q.value,children:Q.label},Q.value))})]}),e.jsx(Xt,{libraryId:c,infoType:ie.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:ie.data.params.infoId?{id:ie.data.params.infoId,label:ie.data.params.infoLabel??"",infoType:ie.data.params.infoType??"word"}:null,onChange:Q=>U({...ie.data.params,infoId:(Q==null?void 0:Q.id)??null,infoLabel:(Q==null?void 0:Q.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),ie.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:ie.data.params.connectionType??"translation",onChange:Q=>U({...ie.data.params,connectionType:Q.target.value}),children:eo.map(Q=>e.jsx("option",{value:Q.value,children:Q.label},Q.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:ie.data.params.connectionId??"",onChange:Q=>U({...ie.data.params,connectionId:Q.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(ie.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const ca=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const a=t.length,s=t.filter(u=>u.correct).length,r=jn(is(t));return{score:Math.round(Math.max(0,Math.min(100,r.knowness*100))*100)/100,total:a,correct:s,lastReviewedUtc:r.lastReviewedUtc??null}},no=t=>{if(t.maskBase64)try{const a=Fr(t.maskBase64);if(!a.length)return t.correct?1:0;const s=a.reduce((r,i)=>r+i,0);return Math.max(0,Math.min(1,s/a.length/255))}catch{return t.correct?1:0}return t.correct?1:0},is=t=>t.map(a=>({correctness:no(a),createdUtc:a.createdUtc})),jn=(t,a=Date.now())=>{var C;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const r=t.slice().sort((v,f)=>v.createdUtc.localeCompare(f.createdUtc)).slice(-5),i=r.reduce((v,f)=>v+f.correctness,0)/r.length,u=5,o=2,j=.15;let h=0,b=0;for(let v=0;v<r.length;v+=1){const f=new Date(r[v].createdUtc).getTime(),J=v===r.length-1?a:new Date(r[v+1].createdUtc).getTime(),L=Math.max(0,(J-f)/(1e3*60)),w=1-Math.exp(-L/u);h+=w,r[v].correctness>.5&&(b+=j)}let c=i*h*o+b;const p=((C=r[r.length-1])==null?void 0:C.createdUtc)??null,l=p?Math.max(0,(a-new Date(p).getTime())/(1e3*60)):0,k=1/(1+Math.log1p(l/60));return c*=k,r.length===1&&r[0].correctness>.5&&(c+=5.44*Math.exp(-l/2)),{knowness:c,avgCorrectness:i,lastReviewedUtc:p}},Ha=t=>{const a=t.slice();for(let s=a.length-1;s>0;s-=1){const r=Math.floor(Math.random()*(s+1));[a[s],a[r]]=[a[r],a[s]]}return a},nn=t=>t[Math.floor(Math.random()*t.length)],so=(t,a)=>{const s=new Map;return t.forEach(r=>s.set(r,Math.random())),t.sort((r,i)=>{const u=a(r)-a(i);return u!==0?u:(s.get(r)??0)-(s.get(i)??0)})},wn=(t,a,s,r,i)=>{if(!t.length)return null;const u=t.filter(j=>!(i!=null&&i.has(Ie(j))));if(u.length===0)return null;const o=u.filter(j=>Ie(j)!==s);return nn(o.length?o:u)},ro=(t,a,s,r,i)=>{if(!t.length)return null;let u=Number.POSITIVE_INFINITY;for(const b of t){const c=Ie(b);if(s.has(c))continue;const p=a[c]??1;p<u&&(u=p)}if(!Number.isFinite(u))return null;const o=t.filter(b=>{const c=Ie(b);return!s.has(c)&&(a[c]??1)===u}),j=o.filter(b=>!i||Ie(b)!==i),h=r?j.filter(b=>!r.has(Ie(b))):j;return h.length>0?nn(h):j.length>0?nn(j):i&&o.some(b=>Ie(b)===i)?o.find(b=>Ie(b)===i)??null:o.length?nn(o):null},hr=(t,a,s,r,i)=>{const u=[],o=t.filter(h=>!i.has(Ie(h))&&!s.has(Ie(h))&&(a[Ie(h)]??0)<1),j=so(o,h=>a[Ie(h)]??0);for(const h of j){if(u.length>=r)break;u.push(h),i.add(Ie(h))}if(u.length<r){const h=Ha(t.filter(b=>!i.has(Ie(b))&&s.has(Ie(b))));for(const b of h){if(u.length>=r)break;u.push(b),i.add(Ie(b))}}return u},io=(t,a,s,r)=>hr(t,a,s,r,new Set),os=(t,a,s,r,i,u)=>{const o=Math.max(1,s.stackSize??a),h=Ha(t).filter((k,m,N)=>N.findIndex(C=>Ie(C)===Ie(k))===m),b=io(h,r,i,o),c=new Set,p=new Set,l=wn(b,{},null,c,p),d=l?[l]:[];return l&&p.add(Ie(l)),{queue:d,meta:{pool:h,active:b,knownessMap:r,unknownSet:i,outcomesById:u,asked:c,queued:p}}},Qn={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,a)=>{const r=Ha(t).filter((i,u,o)=>o.findIndex(j=>Ie(j)===Ie(i))===u);return{queue:r.slice(0,Math.min(a,r.length)),meta:{}}},applyOutcome:t=>t},ls=(t,a,s,r)=>{const i=Math.max(1,s.stackSize??a),o=Ha(t).filter((m,N,C)=>C.findIndex(v=>Ie(v)===Ie(m))===N),j={},h=new Set,b=new Set,c=new Set,p=Math.max(1,s.levels??1);o.forEach(m=>{const N=Ie(m),C=r==null?void 0:r[N],v=typeof C=="number"&&Number.isFinite(C)?C:1;j[N]=Math.min(p,Math.max(1,Math.round(v)))});const l=[];if(o.length>0){const m=new Map;o.forEach(C=>{var f;const v=j[Ie(C)]??1;m.has(v)||m.set(v,[]),(f=m.get(v))==null||f.push(C)});const N=Array.from(m.keys()).sort((C,v)=>C-v);for(const C of N){if(l.length>=i)break;const v=Ha(m.get(C)??[]);for(const f of v){if(l.length>=i)break;l.push(f)}}}const d=wn(l,j,null,h,b),k=d?[d]:[];return d&&b.add(Ie(d)),{queue:k,meta:{pool:o,active:l,levelMap:j,asked:h,queued:b,wrongSinceCorrect:c}}},oo={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,a)=>Math.max(1,a.stackSize??t),getProgressTotal:()=>null,prepare:(t,a,s)=>ls(t,a,s),applyOutcome:(t,a,s,r,i)=>{if(!a)return t;const u=Math.max(1,r.levels??1),o=t.meta.pool??[],j=t.meta.active??[],h={...t.meta.levelMap??{}},b=new Set(t.meta.asked??[]),c=new Set(t.meta.queued??[]),p=new Set(t.meta.wrongSinceCorrect??[]),l=Ie(a);c.delete(l),b.add(l);const d=h[l]??1;i.correct?(h[l]=p.has(l)?1:Math.min(d+1,u),p.delete(l)):(h[l]=1,p.add(l));const k=i.correct?j.filter(C=>Ie(C)!==l):j.slice();if(i.correct&&k.length<Math.max(1,r.stackSize??1)){const C=new Set(k.map(f=>Ie(f))),v=ro(o,h,C,b,l);v&&k.push(v)}const m=t.queue.slice(),N=wn(k,h,l,b,c);return N&&(m.push(N),c.add(Ie(N))),{queue:m,meta:{pool:o,active:k,levelMap:h,asked:b,queued:c,wrongSinceCorrect:p}}}},lo={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,a)=>Math.max(1,a.stackSize??t),getProgressTotal:()=>null,prepare:(t,a,s)=>os(t,a,s,{},new Set,{}),applyOutcome:(t,a,s,r,i)=>{if(!a)return t;const u=t.meta.pool??[],o=t.meta.active??[],j={...t.meta.knownessMap??{}},h=new Set(t.meta.unknownSet??[]),b={...t.meta.outcomesById??{}},c=new Set(t.meta.asked??[]),p=new Set(t.meta.queued??[]),l=Ie(a);p.delete(l),c.add(l);const d={correctness:Math.max(0,Math.min(1,i.correctness??(i.correct?1:0))),createdUtc:i.createdUtc??new Date().toISOString()},m=(b[l]??[]).concat(d).sort((L,w)=>L.createdUtc.localeCompare(w.createdUtc)).slice(-5);b[l]=m,h.delete(l);const N=Date.now();u.forEach(L=>{const w=Ie(L),K=b[w]??[];if(K.length===0){j[w]=0,h.add(w);return}const S=jn(K,N);j[w]=S.knowness});const C=o.slice();if((j[l]??0)>=1){const L=C.filter(w=>Ie(w)!==l);C.length=0,C.push(...L)}const f=Math.max(1,r.stackSize??s);if(C.length<f){const L=new Set(C.map(K=>Ie(K))),w=hr(u,j,h,f-C.length,L);C.push(...w)}const J=t.queue.slice();if(J.length===0||Ie(J[J.length-1])===l){const L=wn(C,{},l,c,p);L&&(J.push(L),p.add(Ie(L)))}return{queue:J,meta:{pool:u,active:C,knownessMap:j,unknownSet:h,outcomesById:b,asked:c,queued:p}}}},gr={random:Qn,levels:oo,temporal:lo},co=Object.values(gr),cs=t=>{if(!t)return Qn;const a=t.trim().toLowerCase();return a==="random"||a==="levels"||a==="temporal"?gr[a]:Qn},kn=(t,a)=>{const s={...t.defaultSettings};return a&&Object.entries(a).forEach(([r,i])=>{typeof i=="number"&&Number.isFinite(i)&&(s[r]=i),typeof i=="string"&&(s[r]=i)}),t.settingsFields.forEach(r=>{var u;const i=s[r.key];if(r.type==="number"){if(typeof i!="number"||Number.isNaN(i)){s[r.key]=t.defaultSettings[r.key]??0;return}r.min!==void 0&&(s[r.key]=Math.max(r.min,s[r.key])),r.max!==void 0&&(s[r.key]=Math.min(r.max,s[r.key]));return}if(r.type==="select"){const o=((u=r.options)==null?void 0:u.map(j=>j.value))??[];(typeof i!="string"||o.length>0&&!o.includes(i))&&(s[r.key]=t.defaultSettings[r.key]??o[0]??"")}}),s},mr=(t,a)=>{const s={};return t.settingsFields.forEach(r=>{const i=a.get(r.key);if(i){if(r.type==="number"){const u=Number(i);Number.isNaN(u)||(s[r.key]=u);return}s[r.key]=i}}),kn(t,s)},uo=(t,a)=>{const s=new URLSearchParams;return t.settingsFields.forEach(r=>{const i=a[r.key];(typeof i=="number"||typeof i=="string")&&s.set(r.key,String(i))}),s};function Us({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,libraryId:c,collectionId:p,revisionId:l}){const d=Wa(),{libraryName:k}=ua(c),m=`/#/cogita/library/${c}`,[N,C]=n.useState(t.cogita.library.collections.defaultName),[v,f]=n.useState([]),[J,L]=n.useState(p??""),[w,K]=n.useState(""),[S,G]=n.useState(20),[_,A]=n.useState("random"),[O,de]=n.useState({}),[Ce,Je]=n.useState("exact"),[ie,$]=n.useState([]),[be,U]=n.useState(null),[ce,Q]=n.useState([]),[xe,oe]=n.useState([]),[ae,Me]=n.useState(""),[se,Re]=n.useState("idle"),[Le,He]=n.useState(null),[st,V]=n.useState("idle"),[ye,Qe]=n.useState("idle"),[Ee,Ne]=n.useState("idle"),[tt,vt]=n.useState([]),rt=n.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),Ae=n.useMemo(()=>cs(_),[_]),ze=n.useMemo(()=>kn(Ae,O),[Ae,O]),at=n.useMemo(()=>uo(Ae,ze).toString(),[Ae,ze]),Ue=n.useMemo(()=>{const x=ae.trim().toLocaleLowerCase();return x?xe.filter(F=>F.name.toLocaleLowerCase().includes(x)):xe},[ae,xe]);n.useEffect(()=>{L(p??"")},[p]),n.useEffect(()=>{if(!J){C(t.cogita.library.collections.defaultName);return}xn(c,J).then(x=>C(x.name)).catch(()=>C(t.cogita.library.collections.defaultName))},[t.cogita.library.collections.defaultName,c,J]),n.useEffect(()=>{Oa({libraryId:c,limit:200}).then(x=>f(x.items.map(F=>({collectionId:F.collectionId,name:F.name})))).catch(()=>f([]))},[c]),n.useEffect(()=>{Zn({libraryId:c}).then(x=>oe(x)).catch(()=>oe([]))},[c]),n.useEffect(()=>{l&&ns({libraryId:c,revisionId:l}).then(x=>{L(x.collectionId),K(x.name),A(x.mode||"random"),Je(x.check||"exact"),G(x.limit||20),de(x.revisionSettings??{})}).catch(()=>{K("")})},[c,l]),n.useEffect(()=>{rr({libraryId:c}).then(x=>{$(x),!be&&x.length>0&&U(x[0].roleId)}).catch(()=>{$([])})},[c]);const E=()=>{Qe("loading"),ar({libraryId:c}).then(x=>{Q(x),Qe("idle")}).catch(()=>{Q([]),Qe("error")})};n.useEffect(()=>{E()},[c]),n.useEffect(()=>{if(!l){vt([]);return}Kr({libraryId:c,revisionId:l}).then(x=>vt(x)).catch(()=>vt([]))},[c,l]);const Y=async()=>{Re("working"),V("idle");try{if(!l){Re("error");return}const x=await Dr({libraryId:c,revisionId:l});He(`${rt}/${x.shareCode}${at?`?${at}`:""}`),Re("ready"),E()}catch{Re("error")}},pe=async()=>{if(l){Ne("saving");try{await _r({libraryId:c,collectionId:p??J,revisionId:l,targetCollectionId:J,name:w||N,revisionType:Ae.id,revisionSettings:ze,mode:_,check:Ce,limit:S}),Ne("saved"),J&&d(`/cogita/library/${c}/revisions/${encodeURIComponent(l)}`,{replace:!0})}catch{Ne("error")}}},T=async()=>{if(Le)try{await navigator.clipboard.writeText(Le),V("copied")}catch{V("failed")}},I=async x=>{try{await nr({libraryId:c,shareId:x}),E()}catch{E()}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:N}),e.jsx("p",{className:"cogita-library-subtitle",children:k})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:m,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${m}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:J?`${m}/collections/${J}`:`${m}/collections`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${m}${l?`/revisions/${encodeURIComponent(l)}/run`:J?`/collections/${J}/revision/run`:"/revision/run"}?mode=${encodeURIComponent(_)}&check=${encodeURIComponent(Ce)}&limit=${S}${at?`&${at}`:""}${be?`&reviewer=${encodeURIComponent(be)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:ae,onChange:x=>Me(x.target.value),placeholder:t.cogita.workspace.revisionForm.namePlaceholder})}),e.jsxs("div",{className:"cogita-card-list","data-view":"list",children:[e.jsxs("a",{className:"cogita-card-select",href:`${m}/revisions/new`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:t.cogita.workspace.revisionForm.createAction})]}),Ue.map(x=>e.jsxs("a",{className:"cogita-card-select",href:`${m}/revisions/${encodeURIComponent(x.revisionId)}`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:x.name})]},x.revisionId))]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsx("select",{value:J,onChange:x=>L(x.target.value),children:v.map(x=>e.jsx("option",{value:x.collectionId,children:x.name},x.collectionId))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:w,onChange:x=>K(x.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:_,onChange:x=>A(x.target.value),children:co.map(x=>e.jsx("option",{value:x.id,children:t.cogita.library.revision[x.labelKey]},x.id))})]}),Ae.settingsFields.map(x=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[x.labelKey]}),x.type==="select"?e.jsx("select",{value:String(ze[x.key]??""),onChange:F=>de(H=>({...H,[x.key]:F.target.value})),children:(x.options??[]).map(F=>e.jsx("option",{value:F.value,children:t.cogita.library.revision[F.labelKey]},F.value))}):e.jsx("input",{type:"number",min:x.min,max:x.max,step:x.step,value:ze[x.key]??0,onChange:F=>de(H=>({...H,[x.key]:Number(F.target.value||0)}))})]},x.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),Ae.id!=="levels"&&Ae.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:S,onChange:x=>G(Number(x.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:be??"",onChange:x=>U(x.target.value||null),children:ie.map(x=>e.jsx("option",{value:x.roleId,children:x.label},x.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[l?e.jsx("button",{type:"button",className:"cta ghost",onClick:pe,disabled:Ee==="saving",children:Ee==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${m}${l?`/revisions/${encodeURIComponent(l)}/run`:J?`/collections/${J}/revision/run`:"/revision/run"}?mode=${encodeURIComponent(_)}&check=${encodeURIComponent(Ce)}&limit=${S}${at?`&${at}`:""}${be?`&reviewer=${encodeURIComponent(be)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision}),l?e.jsx("a",{className:"cta ghost",href:`/#/cogita/live-revision-host/${encodeURIComponent(c)}/${encodeURIComponent(l)}`,children:"Live session"}):null,e.jsx("a",{className:"cta ghost",href:`/#/cogita/live-sessions/${encodeURIComponent(c)}`,children:"Active live sessions"})]}),Ee==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),Le?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:Le,readOnly:!0})]}):null,se==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,st==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):st==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:Y,disabled:se==="working",children:se==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),Le?e.jsx("button",{type:"button",className:"cta ghost",onClick:T,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),ye==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):ce.filter(x=>!l||x.revisionId===l).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:ce.filter(x=>!l||x.revisionId===l).map(x=>e.jsxs("div",{className:"cogita-share-row","data-state":x.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:x.revisionName}),e.jsx("div",{className:"cogita-share-meta",children:x.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(x.createdUtc).toLocaleString(),x.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),x.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>I(x.shareId),children:t.cogita.library.revision.shareRevokeAction})]},x.shareId))})]})]}),l?e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Live sessions"}),e.jsx("h3",{className:"cogita-detail-title",children:"Active sessions for this revision"})]})}),e.jsx("div",{className:"cogita-detail-body",children:tt.length===0?e.jsx("p",{className:"cogita-help",children:"No active sessions."}):e.jsx("div",{className:"cogita-share-list",children:tt.map(x=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsxs("div",{children:[e.jsx("strong",{children:x.title||x.sessionId}),e.jsxs("div",{className:"cogita-share-meta",children:[x.status," · participants: ",x.participantCount]})]}),e.jsx("a",{className:"ghost",href:`/#/cogita/live-sessions/${encodeURIComponent(c)}`,children:"Open sessions"})]},`revision-live:${x.sessionId}`))})})]}):null]})]})})})]})})}const _n=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function pr(t,a,s){if(!t)return null;const r=new Map(t.nodes.map(L=>[L.id,L])),i=new Map,u=new Set,o=L=>{if(typeof L=="number")return L;if(typeof L=="string"){const w=Number(L);return Number.isFinite(w)?w:0}return 0},j=L=>{if(i.has(L))return i.get(L);if(u.has(L))return 0;const w=r.get(L);if(!w)return 0;u.add(L);const K=G=>{var A,O;return(G?((A=w.inputsByHandle)==null?void 0:A[G])??[]:w.inputs??((O=w.inputsByHandle)==null?void 0:O.in)??[]).map(de=>j(de))};let S=0;switch(w.type){case"input.random":{const G=w.min??0,_=w.max??G+10,A=Math.min(G,_),O=Math.max(G,_);S=Math.floor(Math.random()*(O-A+1))+A;break}case"input.const":{S=w.value??0;break}case"input.list":{const G=(w.list??[]).filter(Boolean),_=Math.round(o(K("index")[0]));S=G.length?G[Math.max(0,Math.min(G.length-1,_))]:String(_);break}case"compute.add":{S=K("in").map(_=>o(_)).reduce((_,A)=>_+A,0);break}case"compute.sub":{const G=K("add").map(A=>o(A)),_=K("sub").map(A=>o(A));S=G.reduce((A,O)=>A+O,0)-_.reduce((A,O)=>A+O,0);break}case"compute.mul":{const G=K("in").map(_=>o(_));S=G.length?G.reduce((_,A)=>_*A,1):0;break}case"compute.div":{const G=o(K("num")[0]),_=K("den").map(A=>o(A)).reduce((A,O)=>A+O,0);S=Math.abs(_)<Number.EPSILON?0:G/_;break}case"compute.pow":{const G=o(K("base")[0]),_=o(K("exp")[0]);S=Math.pow(G,_);break}case"compute.exp":{const G=o(K("base")[0]),_=o(K("exp")[0]);S=Math.pow(G,_);break}case"compute.log":{const G=o(K("value")[0]),_=o(K("base")[0]),A=Math.max(G,Number.EPSILON);S=Math.abs(_)<Number.EPSILON?Math.log(A):Math.log(A)/Math.log(_);break}case"compute.abs":{S=Math.abs(o(K("in")[0]));break}case"compute.min":{const G=K("in").map(_=>o(_));S=G.length?Math.min(...G):0;break}case"compute.max":{const G=K("in").map(_=>o(_));S=G.length?Math.max(...G):0;break}case"compute.floor":{S=Math.floor(o(K("in")[0]));break}case"compute.ceil":{S=Math.ceil(o(K("in")[0]));break}case"compute.round":{S=Math.round(o(K("in")[0]));break}case"compute.mod":{const G=o(K("a")[0]),_=o(K("b")[0]);S=Math.abs(_)<Number.EPSILON?0:G%_;break}case"compute.concat":{const _=["in1","in2","in3","in4","in5","in6"].flatMap(Ce=>K(Ce)),A=_.length?_:K("in");S=(A.length?A:K()).map(Ce=>Ce==null?"":String(Ce)).join("");break}case"compute.trim":{const G=K("text")[0]??K("in")[0]??"",_=G==null?"":String(G),A=Math.max(0,Math.round(o(K("start")[0]))),O=Math.max(0,Math.round(o(K("end")[0])));A+O>=_.length?S="":S=_.substring(A,_.length-O);break}case"output":{S=K("in")[0]??0;break}default:S=0}return u.delete(L),i.set(L,S),S},h=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(L=>L.type==="output").map(L=>L.id);t.nodes.forEach(L=>j(L.id)),h.forEach(L=>j(L));const b=L=>Math.abs(L%1)<1e-5?String(Math.round(L)):L.toFixed(3).replace(/\.?0+$/,""),c=L=>typeof L=="number"?b(L):L??"",p=new Map;h.forEach(L=>{var _,A,O,de;const w=r.get(L);if(!w)return;const K=(A=(_=w.inputsByHandle)==null?void 0:_.name)==null?void 0:A[0],S=K?c(i.get(K)):"",G=(S==null?void 0:S.toString().trim())||((O=w.outputLabel)==null?void 0:O.trim())||((de=w.name)==null?void 0:de.trim())||L;p.set(L,G)});const l={},d={},k={};h.forEach(L=>{var S,G;const w=r.get(L);if(!w)return;const K=p.get(L)??(((S=w.outputLabel)==null?void 0:S.trim())||((G=w.name)==null?void 0:G.trim())||L);l[K]=c(i.get(L)),w.name&&(d[w.name.trim()]=K),d[L]=K});const m=(L,w)=>{let K=L;return t.nodes.forEach(S=>{var de,Ce;const G=c(i.get(S.id)),_=h.includes(S.id),A=_?p.get(S.id)??((de=S.outputLabel)==null?void 0:de.trim())??((Ce=S.name)==null?void 0:Ce.trim())??S.id:"",O=_&&w?A:G;K=K.replace(new RegExp(`\\{\\s*${_n(S.id)}\\s*\\}`,"gi"),O),S.name&&(K=K.replace(new RegExp(`\\{\\s*${_n(S.name)}\\s*\\}`,"gi"),O)),_&&S.outputLabel&&(K=K.replace(new RegExp(`\\{\\s*${_n(S.outputLabel)}\\s*\\}`,"gi"),A))}),K},N=a;let C=N.trim().length>0?N:"";C||(C=h.length?`Compute ${h.join(", ")}`:"Compute"),C=m(C,!0);const v=(s==null?void 0:s.trim())??"",f=v?m(v,!1):"",J={};return i.forEach((L,w)=>{J[w]=L,k[w]=c(L);const K=r.get(w);K!=null&&K.name&&(k[K.name.trim()]=c(L))}),{prompt:C,answers:l,values:J,answerText:f,outputVariables:d,variableValues:k}}function fr(t){var s;const a=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((s=a[0])==null?void 0:s[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const Dn=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function br({outcomes:t}){const[a,s]=n.useState("day"),r=n.useMemo(()=>{const i=Dn.find(j=>j.id===a)??Dn[1],u=Date.now()-i.ms,o=t.filter(j=>new Date(j.createdUtc).getTime()>=u);return ca(o)},[t,a]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:Dn.map(i=>e.jsx("button",{type:"button",className:"ghost","data-active":a===i.id,onClick:()=>s(i.id),children:i.label},i.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[r.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[r.correct," / ",r.total]})]})}const ho="cogita-revision",go=1,dn="outcomes",mo=()=>new Promise((t,a)=>{const s=indexedDB.open(ho,go);s.onupgradeneeded=()=>{const r=s.result;if(!r.objectStoreNames.contains(dn)){const i=r.createObjectStore(dn,{keyPath:"id"});i.createIndex("byItem","itemKey",{unique:!1}),i.createIndex("byPending","pending",{unique:!1})}},s.onerror=()=>a(s.error),s.onsuccess=()=>t(s.result)}),Qa=async(t,a)=>{const s=await mo();return new Promise((r,i)=>{const u=s.transaction(dn,t),o=u.objectStore(dn);a(o).then(r).catch(i),u.onerror=()=>i(u.error)})},yr=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const a=Array.from(t).map(s=>s.toString(16).padStart(2,"0"));return`${a.slice(0,4).join("")}-${a.slice(4,6).join("")}-${a.slice(6,8).join("")}-${a.slice(8,10).join("")}-${a.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},po=()=>{const t="cogita_revision_client_id",a=localStorage.getItem(t);if(a)return a;const s=yr();return localStorage.setItem(t,s),s},fo=()=>{const t="cogita_revision_client_seq",a=Number(localStorage.getItem(t)??"0"),s=Number.isFinite(a)?a+1:1;return localStorage.setItem(t,String(s)),s},xr=(t,a,s,r)=>ta(t,a,s,r),un=async t=>{const a=po(),s=fo(),r=new Date().toISOString(),i={...t,clientId:a,clientSequence:s,createdUtc:r,id:yr(),pending:!0};return await Qa("readwrite",u=>new Promise((o,j)=>{const h={...i,itemKey:xr(i.itemType,i.itemId,i.checkType,i.direction)},b=u.add(h);b.onsuccess=()=>o(),b.onerror=()=>j(b.error)})),i},hn=async(t,a,s,r)=>{if(!a)return[];try{const i=xr(t,a,s,r);return await Qa("readonly",u=>new Promise((o,j)=>{const b=u.index("byItem").getAll(i);b.onsuccess=()=>{const p=(b.result??[]).map(l=>({itemType:l.itemType,itemId:l.itemId,checkType:l.checkType??null,direction:l.direction??null,revisionType:l.revisionType,evalType:l.evalType,correct:l.correct,createdUtc:l.createdUtc,maskBase64:l.maskBase64,payloadBase64:l.payloadBase64,payloadHashBase64:l.payloadHashBase64,clientId:l.clientId,clientSequence:l.clientSequence,personRoleId:l.personRoleId??null})).sort((l,d)=>l.createdUtc.localeCompare(d.createdUtc));o(p)},b.onerror=()=>j(b.error)}))}catch{return[]}},da=async()=>{try{return await Qa("readonly",t=>new Promise((a,s)=>{const r=t.getAll();r.onsuccess=()=>{const u=(r.result??[]).map(o=>({itemType:o.itemType,itemId:o.itemId,checkType:o.checkType??null,direction:o.direction??null,revisionType:o.revisionType,evalType:o.evalType,correct:o.correct,createdUtc:o.createdUtc,maskBase64:o.maskBase64,payloadBase64:o.payloadBase64,payloadHashBase64:o.payloadHashBase64,clientId:o.clientId,clientSequence:o.clientSequence,personRoleId:o.personRoleId??null}));a(u)},r.onerror=()=>s(r.error)}))}catch{return[]}},bo=async(t=100)=>{try{return await Qa("readonly",a=>new Promise((s,r)=>{const u=a.index("byPending").getAll(!0);u.onsuccess=()=>{const o=u.result??[];s(o.slice(0,t))},u.onerror=()=>r(u.error)}))}catch{return[]}},yo=async t=>{if(t.length!==0)try{await Qa("readwrite",a=>new Promise((s,r)=>{let i=t.length;t.forEach(u=>{const o=a.get(u);o.onsuccess=()=>{const j=o.result;if(j){j.pending=!1;const h=a.put(j);h.onsuccess=()=>{i-=1,i===0&&s()},h.onerror=()=>r(h.error)}else i-=1,i===0&&s()},o.onerror=()=>r(o.error)})}))}catch{}},zn=async(t,a)=>{const s=await bo(200);if(s.length===0)return;const r=new Map;s.forEach(i=>{var o;const u=i.personRoleId??a??"";r.has(u)||r.set(u,[]),(o=r.get(u))==null||o.push(i)});for(const[i,u]of r.entries()){const o=u.map(j=>({itemType:j.itemType,itemId:j.itemId,checkType:j.checkType??null,direction:j.direction??null,revisionType:j.revisionType,evalType:j.evalType,correct:j.correct,clientId:j.clientId,clientSequence:j.clientSequence,maskBase64:j.maskBase64??null,payloadHashBase64:j.payloadHashBase64??null,payloadBase64:j.payloadBase64??null,personRoleId:i||null}));try{await zr({libraryId:t,outcomes:o}),await yo(u.map(j=>j.id))}catch{}}},zt=t=>t.trim().toLowerCase(),Qt=t=>{const a=t==null?void 0:t.trim();return a?{fragmentId:a}:null},gn=(t,a)=>{const s=Qt(a);if(!s)return!0;const r=Qt(t);return(r==null?void 0:r.fragmentId)===s.fragmentId},Lt=t=>{const a=t==null?void 0:t.trim().toLowerCase();return a||null},vr=(t,a)=>{if((Lt(t.childItemType)??"info")!==(a.cardType??"").toLowerCase()||t.childItemId!==a.cardId)return!1;const r=Lt(t.childCheckType),i=Lt(t.childDirection),u=Lt(a.checkType),o=Lt(a.direction);return!(r&&r!==u||i&&i!==o)},xo={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},vo={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},mn=(t,a,s)=>{if(!s||!a.startsWith(t))return a;const r=a.slice(t.length);if(!r)return a;const i=s==="super"?xo:vo,u=r.split("").map(o=>i[o]??o).join("");return t+u},pn=(t,a,s)=>{var o,j,h;if(!t)return((o=a[0])==null?void 0:o.key)??null;const r=new Set(a.map(b=>b.key)),i=/\{([^}]+)\}/g;let u;for(;(u=i.exec(t))!==null;){const b=((j=u[1])==null?void 0:j.trim())??"";if(!b)continue;if(r.has(b))return b;const c=s==null?void 0:s[b];if(c&&r.has(c))return c}return((h=a[0])==null?void 0:h.key)??null},qa=t=>(()=>{const a=new Set;return t.flatMap(s=>{if(s.cardType!=="info"||s.infoType!=="citation")return[s];const r=s.description??"";if(!r.trim())return[s];const i=va(r),u=Object.keys(i.nodes);return u.length===0?[s]:u.map(o=>({...s,checkType:"quote-fragment",direction:o})).filter(o=>{const j=[o.cardId,o.checkType??"",o.direction??""].join("|");return a.has(j)?!1:(a.add(j),!0)})})})();function Bn({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,libraryId:c,collectionId:p,revisionId:l}){const d=Pa(),k=`/#/cogita/library/${c}`,m=n.useMemo(()=>new URLSearchParams(d.search),[d.search]),N=Math.max(1,Number(m.get("limit")??20)),C=m.get("mode")??"random",v=n.useMemo(()=>cs(C),[C]),f=n.useMemo(()=>kn(v,mr(v,m)),[v,m]),J=m.get("check")??"exact",L=m.get("reviewer"),w=(m.get("scope")??"").trim(),K=w==="info"||w==="info-selection"?w:"collection",S=K==="info"?(m.get("infoId")??"").trim():"",G=K==="info-selection"?(m.get("seed")??"").trim():"",[_,A]=n.useState(null),O=p??_??void 0,de=K==="collection"&&!!O,Ce=n.useMemo(()=>t.cogita.library.revision[v.labelKey]??C,[t,C,v]),Je=n.useMemo(()=>J==="exact"?t.cogita.library.revision.checkValue:J,[t,J]),[ie,$]=n.useState(t.cogita.library.collections.defaultName),[be,U]=n.useState([]),[ce,Q]=n.useState([]),[xe,oe]=n.useState("idle"),[ae,Me]=n.useState({current:0,total:0}),[se,Re]=n.useState(0),[Le,He]=n.useState(""),[st,V]=n.useState(null),[ye,Qe]=n.useState(null),[Ee,Ne]=n.useState(null),[tt,vt]=n.useState(null),[rt,Ae]=n.useState([]),[ze,at]=n.useState({}),[Ue,E]=n.useState({}),[Y,pe]=n.useState(null),[T,I]=n.useState(null),[x,F]=n.useState(null),[H,fe]=n.useState(null),[q,R]=n.useState(null),[Se,Z]=n.useState({}),re=n.useRef(0),[W,je]=n.useState(null),he=n.useRef(null),ge=n.useRef(null),[$e,Ge]=n.useState(null),[Ve,Ke]=n.useState(!1),[bt,ut]=n.useState(null),[yt,We]=n.useState([]),[De,mt]=n.useState(null),it=n.useRef(null),pt=n.useRef(null),[Bt,It]=n.useState(null),[Nt,Mt]=n.useState(0),St=n.useRef(null),ht=n.useRef({}),[Kt,ct]=n.useState(!1),[Ze,Tt]=n.useState({}),[Gt,Ot]=n.useState([]),Vt=n.useRef(new Map),[ue,Et]=n.useState(new Set),[Zt,Ut]=n.useState(!1),D=n.useRef(null),g=n.useRef(new Set),ee=n.useRef({});n.useEffect(()=>{if(!l||p){A(null);return}ns({libraryId:c,revisionId:l}).then(y=>A(y.collectionId)).catch(()=>A(null))},[p,c,l]);const B=be[se]??null,nt=(B==null?void 0:B.checkType)==="translation-match"&&q,gt=n.useRef(new Map),ft=n.useRef(new Map),Rt=n.useRef(new Map),At=n.useRef(new Map),Ct=n.useMemo(()=>B?B.cardType==="vocab"?t.cogita.library.revision.vocabLabel:B.infoType?lt(t,B.infoType):t.cogita.library.revision.infoLabel:"",[t,B]),Pt=n.useMemo(()=>{var M;return v.id!=="levels"?be.length:((M=Ze.pool)==null?void 0:M.length)??v.getFetchLimit(N,f)},[Ze,f,v,be.length,N]),ha=v.getProgressTotal?v.getProgressTotal(be,Ze,N,f):v.id==="levels"?Math.min(N,Pt):be.length,ma=ha?Math.min(se+1,ha):0,_t=Math.max(1,Number(f.tries??1)),sa=f.compare??"anchors",Sa=Math.max(0,Math.min(100,Number(f.minCorrectness??0))),jt=(f.considerDependencies??"on")==="on",Dt=Math.max(0,Math.min(100,Number(f.dependencyThreshold??85))),ea=y=>{const M=y.slice();for(let z=M.length-1;z>0;z-=1){const le=Math.floor(Math.random()*(z+1));[M[z],M[le]]=[M[le],M[z]]}return M},ja=y=>xa(y,{treatSimilarCharsAsSame:!0})>=Sa,Ga=async()=>{const y=await da(),M=new Map,z=new Map,le=new Map;y.forEach(X=>{const Te=`${X.itemType}:${X.itemId}`,Oe=ta(X.itemType,X.itemId,X.checkType,X.direction);if(M.has(Te)||M.set(Te,[]),M.get(Te).push(X),z.has(Oe)||z.set(Oe,[]),z.get(Oe).push(X),X.itemType==="info"&&X.checkType==="quote-fragment"&&X.direction){const Ye=`${X.itemId}:${X.direction}`;le.has(Ye)||le.set(Ye,[]),le.get(Ye).push(X)}});const me=new Map,te=new Map,ve=new Map;return M.forEach((X,Te)=>me.set(Te,ca(X).score)),z.forEach((X,Te)=>te.set(Te,ca(X).score)),le.forEach((X,Te)=>ve.set(Te,ca(X).score)),{itemKnowness:me,cardKnowness:te,fragmentKnowness:ve}},Yt=async y=>{const M=[];let z=null;for(;;){const le=await Ua({libraryId:c,collectionId:y,limit:200,cursor:z});if(M.push(...le.items),!le.nextCursor)break;z=le.nextCursor}return qa(M)},Ta=async(y,M)=>{if(Vt.current.has(y))return Vt.current.get(y)??0;const z=await Yt(y);if(z.length===0)return Vt.current.set(y,0),0;const me=z.reduce((te,ve)=>{const X=Ie(ve);return te+(M.get(X)??0)},0)/z.length;return Vt.current.set(y,me),me},Ca=(y,M)=>{if(!jt||y.cardType!=="info"||y.infoType!=="citation"||y.checkType!=="quote-fragment")return!0;const z=Qt(y.direction);if(!(z!=null&&z.fragmentId))return!0;const le=y.description??"";if(!le.trim())return!0;const te=va(le).nodes[z.fragmentId];if(!te||!te.leftId&&!te.rightId)return!0;const ve=[te.leftId,te.rightId].filter(Oe=>!!Oe);if(ve.length===0)return!0;const X=ve.map(Oe=>{const Ye=ta("info",y.cardId,"quote-fragment",Oe);return M.get(Ye)??0});return X.reduce((Oe,Ye)=>Oe+Ye,0)/X.length>=Dt},Fa=async y=>{const M=Ze,z=y.concat(M.active??[]).concat(M.pool??[]).filter((X,Te,Oe)=>Oe.findIndex(Ye=>Ie(Ye)===Ie(X))===Te);if(!jt){Et(new Set(z.map(Ie)));return}const{itemKnowness:le,cardKnowness:me}=await Ga(),te=Gt.filter(X=>Lt(X.childItemType)==="collection"&&X.childItemId===p&&!Lt(X.childCheckType)&&!Lt(X.childDirection)),ve=new Set;for(const X of z){if(X.cardType!=="info"){ve.add(Ie(X));continue}if(!Ca(X,me))continue;const Te=Gt.filter(Xe=>vr(Xe,X)).concat(te);if(Te.length===0){ve.add(Ie(X));continue}let Oe=0;for(const Xe of Te)if(Lt(Xe.parentItemType)==="collection")Oe+=await Ta(Xe.parentItemId,me);else if(Lt(Xe.parentCheckType)||Lt(Xe.parentDirection)){const ot=Lt(Xe.parentCheckType),dt=Lt(Xe.parentDirection),xt=ta(Xe.parentItemType,Xe.parentItemId,ot,dt);Oe+=me.get(xt)??0}else{const ot=`${Xe.parentItemType}:${Xe.parentItemId}`;Oe+=le.get(ot)??0}Oe/Te.length>=Dt&&ve.add(Ie(X))}Et(ve)},Ya=y=>{for(let M=y;M<be.length;M+=1){const z=be[M];if(z&&(!jt||z.cardType!=="info"||ue.has(Ie(z))))return M}return-1},Ka=y=>!jt||y.cardType!=="info"||ue.has(Ie(y)),Nn=y=>{if(v.id!=="temporal"&&v.id!=="levels")return null;const M=Ze,z=(M.active??[]).concat(M.pool??[]),le=new Set;for(const me of z){const te=Ie(me);if(!(le.has(te)||y.has(te))&&(le.add(te),Ka(me)))return me}return null},Jt=n.useMemo(()=>{if(v.id!=="levels")return null;const y=Ze,M=y.pool??[],z=y.active??[],le=y.levelMap??{},me=Math.max(1,Number(f.levels??1)),te=Array.from({length:me},()=>0),ve=new Set(z.map(Ye=>Ie(Ye)));M.forEach(Ye=>{const Xe=Math.min(me,Math.max(1,le[Ie(Ye)]??1));te[Xe-1]+=1});const X=M.length||1,Te=te.map(Ye=>Ye/X*100),Oe=B?le[Ie(B)]??1:null;return{counts:te,percentages:Te,currentLevel:Oe,levelsCount:me,activeCount:z.length,poolCount:M.length,activeSet:ve}},[Ze,f,v,B]),Ht=n.useMemo(()=>{if(v.id!=="temporal")return null;const y=Ze,M=y.pool??[],z=y.active??[],le=y.knownessMap??{},me=new Set(y.unknownSet??[]);let te=0;M.forEach(Te=>{(le[Ie(Te)]??0)>1&&(te+=1)});const ve=me.size,X=z.map(Te=>({id:Ie(Te),value:me.has(Ie(Te))?0:Math.max(0,Math.min(1,le[Ie(Te)]??0))}));return{knownCount:te,unknownCount:ve,dots:X}},[Ze,v]),Sn=n.useMemo(()=>{if(!jt)return 0;const y=Ze;return be.concat(y.active??[]).concat(y.pool??[]).filter((z,le,me)=>me.findIndex(te=>Ie(te)===Ie(z))===le).filter(z=>z.cardType==="info"&&!ue.has(Ie(z))).length},[jt,Ze,be,ue]);n.useEffect(()=>{if(!jt||xe!=="ready")return;const y=Ze,z=be.concat(y.active??[]).concat(y.pool??[]).filter((te,ve,X)=>X.findIndex(Te=>Ie(Te)===Ie(te))===ve).filter(te=>te.cardType!=="info"||ue.has(Ie(te))).length,le=it.current;if(it.current=z,le===null||z<=le)return;const me=z-le;mt(`New card available (+${me})`),pt.current&&window.clearTimeout(pt.current),pt.current=window.setTimeout(()=>mt(null),2200)},[jt,xe,Ze,be,ue]),n.useEffect(()=>()=>{pt.current&&window.clearTimeout(pt.current)},[]);const qt=(y,M)=>{const z=v.applyOutcome({queue:be,meta:Ze},B,N,f,{correct:y,correctness:M,createdUtc:new Date().toISOString()});U(z.queue),Tt(z.meta);const le=z.queue[se+1];le&&ga(le,se+1)};n.useEffect(()=>{if(de&&O){xn(c,O).then(y=>$(y.name)).catch(()=>$(t.cogita.library.collections.defaultName));return}if(K==="info"&&S){na({libraryId:c,infoId:S}).then(y=>{const M=y.payload??{};$(M.title||M.label||M.name||S)}).catch(()=>$(S||t.cogita.library.revision.runKicker));return}if(K==="info-selection"){const y=G?js(c,G):null,M=(y==null?void 0:y.infoIds.length)??0;$(M>0?`Selected infos (${M})`:"Selected infos");return}$(t.cogita.library.collections.defaultName)},[t,O,de,c,K,S,G]),n.useEffect(()=>{ts({libraryId:c,type:"language"}).then(y=>Q(y)).catch(()=>Q([]))},[c]),n.useEffect(()=>{de&&es({libraryId:c}).then(y=>Ot(y.items??[])).catch(()=>Ot([]))},[de,c]),n.useEffect(()=>{zn(c,L)},[c,L]),n.useEffect(()=>{Fa(be)},[be,Gt,jt,Dt,O]),n.useEffect(()=>{if(!B||!jt){Ut(!1);return}if(B.cardType!=="info"||ue.has(Ie(B))){Ut(!1);return}const y=Ya(se+1);if(y>=0){Ut(!1),Re(y);return}if(v.id==="temporal"||v.id==="levels"){const M=be.slice(0,se+1),z=be.slice(se+1).filter(Ka),le=M.concat(z),me=new Set(le.map(Ie)),te=Nn(me);if(te){const X=Ie(te);me.has(X)||(le.push(te),me.add(X),Tt(Te=>{const Oe=Te,Ye=new Set(Oe.queued??[]);return Ye.add(X),{...Oe,queued:Ye}}))}const ve=le.findIndex((X,Te)=>Te!==se&&Ka(X));if(ve>=0){U(le),Re(ve),Ut(!1);return}}Ut(!0)},[B,ue,jt,se,be,Ze,v.id]),n.useEffect(()=>{let y=!0;return(async()=>{oe("loading"),Me({current:0,total:v.id==="levels"?0:v.getFetchLimit(N,f)});try{if(!de){if(Ot([]),K==="info"){if(!S){y&&(U([]),Ot([]),Tt({}),Re(0),oe("ready"));return}const[Xe,ot]=await Promise.all([sn({libraryId:c,infoId:S}),rn({libraryId:c,infoId:S})]);if(!y)return;const dt=qa(Xe.items??[]);Ot(ot.items??[]);const xt=v.prepare(dt,N,f);U(xt.queue),Tt(xt.meta),Re(0),oe("ready"),Me({current:dt.length,total:dt.length});return}if(K==="info-selection"){const Xe=G?js(c,G):null,ot=(Xe==null?void 0:Xe.infoIds)??[];if(!ot.length){y&&(U([]),Ot([]),Tt({}),Re(0),oe("ready"));return}const dt=await Promise.all(ot.map(async pa=>{const[Wt,Xa]=await Promise.all([sn({libraryId:c,infoId:pa}),rn({libraryId:c,infoId:pa})]);return{cards:Wt.items??[],deps:Xa.items??[]}}));if(!y)return;const xt=new Map;dt.forEach(pa=>{qa(pa.cards).forEach(Wt=>{xt.set(Ie(Wt),Wt)})});const wt=Array.from(xt.values()),kt=new Set(wt.map(Ie)),Ft=new Map;dt.forEach(pa=>{(pa.deps??[]).forEach(Wt=>{const Xa=ta(Wt.parentItemType,Wt.parentItemId,Lt(Wt.parentCheckType),Lt(Wt.parentDirection)),us=ta(Wt.childItemType,Wt.childItemId,Lt(Wt.childCheckType),Lt(Wt.childDirection));if(!kt.has(Xa)||!kt.has(us))return;const hs=`${Xa}->${us}`;Ft.has(hs)||Ft.set(hs,Wt)})}),Ot(Array.from(Ft.values()));const ka=v.prepare(wt,N,f);U(ka.queue),Tt(ka.meta),Re(0),oe("ready"),Me({current:wt.length,total:wt.length});return}}const z=[];let le=null,me=null;do{const Xe=await Ua({libraryId:c,collectionId:O,limit:300,cursor:le});if(z.push(...Xe.items),(v.id==="levels"||v.id==="temporal")&&Xe.total&&(me=Xe.total),Me(ot=>({current:z.length,total:ot.total||Xe.total||v.getFetchLimit(N,f)})),le=Xe.nextCursor??null,me!==null&&z.length>=me||v.id!=="levels"&&v.id!=="temporal"&&z.length>=v.getFetchLimit(N,f))break}while(le);if(!y)return;const te=qa(z);let ve;if(v.id==="levels"){const Xe=Math.max(1,Number(f.levels??1)),dt=(await da()).reduce((xt,wt)=>{const kt=ta(wt.itemType,wt.itemId,wt.checkType,wt.direction);return xt[kt]||(xt[kt]=[]),xt[kt].push(wt),xt},{});ve={},te.forEach(xt=>{const wt=Ie(xt),kt=dt[wt]??[],Ft=kt.length>0?ca(kt).score:0,ka=Math.max(1,Math.min(Xe,Math.ceil(Ft/100*Xe)));ve[wt]=ka})}let X=null,Te=null,Oe=null;if(v.id==="temporal"){const Xe=await da(),ot=new Set(te.map(wt=>Ie(wt))),dt=Xe.reduce((wt,kt)=>{const Ft=ta(kt.itemType,kt.itemId,kt.checkType,kt.direction);return ot.has(Ft)&&(wt[Ft]||(wt[Ft]=[]),wt[Ft].push(kt)),wt},{});X={},Te=new Set,Oe={};const xt=Date.now();te.forEach(wt=>{const kt=Ie(wt),Ft=dt[kt]??[];if(Ft.length===0){X[kt]=0,Te.add(kt),Oe[kt]=[];return}const ka=is(Ft);Oe[kt]=ka;const pa=jn(ka,xt);X[kt]=pa.knowness})}const Ye=v.id==="levels"?ls(te,N,f,ve):v.id==="temporal"?os(te,N,f,X??{},Te??new Set,Oe??{}):v.prepare(te,N,f);U(Ye.queue),Tt(Ye.meta),Re(0),oe("ready"),Me(Xe=>({current:Math.min(Xe.current,Xe.total),total:Xe.total}))}catch{y&&oe("error")}})(),()=>{y=!1}},[O,de,c,N,K,f,v,L,S,G]),n.useEffect(()=>{if(He(""),V(null),It(null),Mt(0),Ae([]),at({}),E({}),I(null),F(null),fe(null),Ke(!1),ct(!1),Ge(null),R(null),Z({}),!B){Qe(null),Ne(null),pe(null),ut(null);return}B.cardType==="info"&&B.infoType==="computed"&&Qe(t.cogita.library.revision.loadingComputed);let y=!0;return ga(B,se).then(M=>{!y||!M||(Qe(M.prompt),Ne(M.expectedAnswer),Ae(M.computedExpected),at(M.computedAnswers),pe(M.computedValues),I(M.answerTemplate),F(M.outputVariables),fe(M.variableValues))}),()=>{y=!1}},[B,t]),n.useEffect(()=>{if(!B||B.cardType!=="info"||B.infoType!=="citation"){D.current=null,g.current=new Set,vt(null);return}const y=B.description??"",M=(B.label??"").trim(),z=M.replace(/\s+/g," ").trim(),le=y.replace(/\s+/g," ").trim(),me=z&&z!==le?M:t.cogita.library.infoTypes.citation;if(!y){vt(null),Ne(null);return}const te=va(y);D.current=te,Qe(me);let ve=!0;return Ga().then(({fragmentKnowness:X})=>{if(!ve)return;const Te=new Set,Oe={};X.forEach((ot,dt)=>{const[xt,wt]=dt.split(":",2);if(xt!==B.cardId)return;const kt=Qt(wt);if(!kt)return;const{fragmentId:Ft}=kt;Oe[Ft]=ot,ot>=Dt&&Te.add(Ft)}),g.current=Te,ee.current=Oe;const Ye=Qt(B.direction);if(Ye!=null&&Ye.fragmentId&&te.nodes[Ye.fragmentId]){P(te,Ye.fragmentId,me);return}const Xe=Ra(te,Te,Oe,Dt,jt,B.direction);P(te,(Xe==null?void 0:Xe.id)??null,me)}).catch(()=>{g.current=new Set,ee.current={};const X=Qt(B.direction);if(X!=null&&X.fragmentId&&te.nodes[X.fragmentId]){P(te,X.fragmentId,me);return}const Te=Ra(te,g.current,{},Dt,jt,B.direction);P(te,(Te==null?void 0:Te.id)??null,me)}),()=>{ve=!1}},[B,t,jt,Dt]),n.useEffect(()=>{if(!B||B.cardType!=="vocab"||B.checkType!=="translation-match"){R(null),Z({});return}const z=(Ze.pool??Ze.active??be).filter(X=>X.cardType==="vocab"&&X.checkType==="translation-match").filter((X,Te,Oe)=>Oe.findIndex(Ye=>Ye.cardId===X.cardId)===Te);z.some(X=>X.cardId===B.cardId)||z.unshift(B);const me=ea(z).slice(0,6).map(X=>{const Te=X.label.split("↔").map(Xe=>Xe.trim()).filter(Boolean);if(Te.length<2)return null;const Oe=`${X.cardId}:L`,Ye=`${X.cardId}:R`;return{cardId:X.cardId,leftId:Oe,rightId:Ye,leftLabel:Te[0],rightLabel:Te[1]}}).filter(Boolean),te=me.map(X=>X.leftId),ve=ea(me.map(X=>X.rightId));R({pairs:me,leftOrder:te,rightOrder:ve,selection:{},activeLeft:null,activeRight:null,locked:{}})},[B,be,Ze]),n.useEffect(()=>()=>{he.current&&window.clearTimeout(he.current),ge.current&&window.clearTimeout(ge.current)},[]);const ia=n.useRef(null);n.useEffect(()=>{if(!B)return;const y=Ie(B),M=typeof document<"u"?document.activeElement:null;if(ia.current===y&&M&&(M.tagName==="INPUT"||M.tagName==="TEXTAREA"))return;let z=0;const le=()=>{if(B){if(B.cardType==="info"&&B.infoType==="computed"){if(rt.length>0){const te=pn(T,rt,x),ve=te?ht.current[te]:null;if(ve&&(ve.focus(),document.activeElement===ve)){ia.current=y;return}}if(St.current&&(St.current.focus(),document.activeElement===St.current)){ia.current=y;return}}else if(B.cardType==="vocab"&&St.current&&(St.current.focus(),document.activeElement===St.current)){ia.current=y;return}z<6&&(z+=1,window.setTimeout(le,40))}},me=window.setTimeout(le,40);return()=>window.clearTimeout(me)},[B,rt,T,x]),n.useEffect(()=>{if(!Kt)return;const y=M=>{M.key==="Enter"&&(M.preventDefault(),Ma())};return window.addEventListener("keydown",y),()=>window.removeEventListener("keydown",y)},[Kt]);const Ia=y=>{We(y),ut(ca(y))};n.useEffect(()=>{if(!B){ut(null),We([]);return}const y=B.cardType==="info"?"info":"connection";if(B.cardType==="info"&&B.infoType==="citation"){da().then(M=>{const z=M.filter(le=>le.itemType==="info"&&le.itemId===B.cardId&&le.checkType==="quote-fragment"&&gn(le.direction,B.direction));Ia(z)}).catch(()=>{ut(null),We([])});return}hn(y,B.cardId,B.checkType,B.direction).then(M=>Ia(M)).catch(()=>{ut(null),We([])})},[c,B,L]);const wa=(y,M,z,le)=>{if(y==="info"&&z==="quote-fragment"){da().then(me=>{const te=me.filter(ve=>ve.itemType==="info"&&ve.itemId===M&&ve.checkType==="quote-fragment"&&gn(ve.direction,le));Ia(te)}).catch(()=>{ut(null),We([])});return}hn(y,M,z,le).then(me=>Ia(me)).catch(()=>{ut(null),We([])})},_a=(y,M,z)=>{var ve;const le=((ve=z.pairs.find(X=>X.leftId===y))==null?void 0:ve.rightId)??null;if(!le)return z;const me=le===M;Z(X=>({...X,[y]:me?"correct":"incorrect"})),he.current&&window.clearTimeout(he.current),ge.current&&window.clearTimeout(ge.current),re.current+=1;const te={kind:me?"correct":"incorrect",tick:re.current};if(je(null),he.current=window.setTimeout(()=>je(te),0),ge.current=window.setTimeout(()=>je(null),420),me){const X={...z.locked,[y]:!0};return Object.keys(X).length>=z.pairs.length?(V("correct"),ct(!0)):V("correct"),{...z,selection:{...z.selection,[y]:M},activeLeft:null,activeRight:null,locked:X}}return V("incorrect"),{...z,activeLeft:null,activeRight:null}},Tn=y=>{R(M=>!M||M.locked[y]?M:M.activeRight?_a(y,M.activeRight,M):{...M,activeLeft:M.activeLeft===y?null:y})},Cn=y=>{R(M=>M&&(M.activeLeft?_a(M.activeLeft,y,M):{...M,activeRight:M.activeRight===y?null:y}))},Ma=()=>{var y;if(B&&B.cardType==="info"&&B.infoType==="citation"&&D.current&&tt&&!((y=Qt(B.direction))!=null&&y.fragmentId)){const M=Ra(D.current,g.current,ee.current,Dt,jt,B.direction,tt.fragmentId);if(M){V(null),He(""),Ke(!1),E({}),ct(!1),It(null),Mt(0),P(D.current,M.id,tt.title);return}}V(null),He(""),Ke(!1),E({}),ct(!1),It(null),Mt(0),Re(M=>Math.min(M+1,be.length))},ra=y=>{if(!B)return;const M=y.expected??null,z=y.answer??"";let le=M??"",me=z;if(!M&&y.expectedMap&&y.answerMap){const Xe=Object.keys(y.expectedMap).sort((ot,dt)=>ot.localeCompare(dt));le=Xe.map(ot=>{var dt;return((dt=y.expectedMap)==null?void 0:dt[ot])??""}).join("|"),me=Xe.map(ot=>{var dt;return((dt=y.answerMap)==null?void 0:dt[ot])??""}).join("|")}const te=le?$a(le,me,sa):new Uint8Array,ve={revisionType:v.id,evalType:y.evalType,direction:y.direction,prompt:ye??"",expected:M,answer:z,expectedAnswers:y.expectedMap??null,answers:y.answerMap??null,correct:y.correct,maskBase64:te.length?ya(te):null,values:Y??null,checkMode:J,compareMode:sa,minCorrectness:Sa},X=new TextEncoder().encode(JSON.stringify(ve)),Te=B.cardType==="info"?"info":"connection",Oe=y.overrideCheckType??B.checkType??null,Ye=y.overrideDirection??B.direction??null;un({itemType:Te,itemId:B.cardId,checkType:Oe,direction:Ye,revisionType:v.id,evalType:y.evalType,correct:y.correct,maskBase64:te.length?ya(te):null,payloadBase64:ya(X),personRoleId:L??null}).then(()=>{wa(Te,B.cardId,Oe,Ye),Fa(be),zn(c,L)}).catch(()=>{})},In=(y,M)=>{const z=gt.current.get(M);if(z)return Promise.resolve(z);const le=ft.current.get(M);if(le)return le;const me=na({libraryId:c,infoId:y}).then(te=>{var Xe,ot;const ve=te.payload,X=((Xe=ve.definition)==null?void 0:Xe.graph)??null,Te="",Oe=((ot=ve.definition)==null?void 0:ot.answerTemplate)??"",Ye=pr(X,Te,Oe);if(Ye){const xt={sample:fr(Ye),answerTemplate:Oe||null};return gt.current.set(M,xt),xt}return Hn({libraryId:c,infoId:y}).then(dt=>{const xt={sample:dt,answerTemplate:null};return gt.current.set(M,xt),xt})}).catch(()=>Hn({libraryId:c,infoId:y}).then(te=>{const ve={sample:te,answerTemplate:null};return gt.current.set(M,ve),ve}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{ft.current.delete(M)});return ft.current.set(M,me),me},ga=(y,M)=>{var X;const z=`${Ie(y)}:${M}`,le=Rt.current.get(z);if(le)return Promise.resolve(le);const me=At.current.get(z);if(me)return me;const te=Te=>(Rt.current.set(z,Te),Te);let ve;if(y.cardType==="vocab"){if(y.checkType==="translation-match")return ve=Promise.resolve(te({prompt:y.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),ve;const Te=y.label.split("↔").map(Oe=>Oe.trim()).filter(Boolean);if(Te.length>=2){const Ye=(y.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",Xe=Ye?Te[0]:Te[1],ot=Ye?Te[1]:Te[0];ve=Promise.resolve(te({prompt:Xe,expectedAnswer:ot,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else ve=Promise.resolve(te({prompt:y.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(y.cardType==="info"&&y.infoType==="word"){const Te=(X=y.description)!=null&&X.startsWith("Language: ")?y.description.replace("Language: ",""):null;ve=Promise.resolve(te({prompt:y.label,expectedAnswer:Te,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else y.cardType==="info"&&y.infoType==="question"?ve=na({libraryId:c,infoId:y.cardId}).then(Te=>{const Oe=Te.payload??{},Ye=Oe.definition??Oe??{},Xe=rs(Ye.type??Ye.kind),ot=(typeof Ye.question=="string"&&Ye.question.trim()?Ye.question.trim():null)??(typeof Ye.title=="string"&&Ye.title.trim()?Ye.title.trim():null)??y.label,dt=Ye.answer;return te(Xe==="text"||Xe==="number"||Xe==="date"?{prompt:ot,expectedAnswer:typeof dt=="string"||typeof dt=="number"?String(dt):null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}:{prompt:ot,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})}).catch(()=>te({prompt:y.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{At.current.delete(z)}):y.cardType==="info"&&y.infoType==="computed"?ve=In(y.cardId,z).then(Te=>{var dt,xt;if(!Te.sample)return te({prompt:y.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const Oe=Te.sample,Ye=Oe.expectedAnswers?Object.entries(Oe.expectedAnswers).map(([wt,kt])=>({key:wt,expected:kt})):[],Xe=Ye.reduce((wt,kt)=>(wt[kt.key]="",wt),{}),ot=Oe.expectedAnswerIsSentence&&((dt=Oe.expectedAnswer)==null?void 0:dt.trim())||null;return te({prompt:Oe.prompt,expectedAnswer:Ye.length>0?ot:((xt=Oe.expectedAnswer)==null?void 0:xt.trim())||null,computedExpected:Ye,computedAnswers:Xe,computedValues:Oe.values??null,answerTemplate:Te.answerTemplate,outputVariables:Oe.outputVariables??null,variableValues:Oe.variableValues??null})}).catch(()=>te({prompt:y.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{At.current.delete(z)}):ve=Promise.resolve(te({prompt:y.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return At.current.set(z,ve),ve},P=(y,M,z)=>{const le=Object.keys(y.nodes).length,me=g.current.size;if(!M){vt({title:z,before:y.text,after:"",fragmentId:null,total:le,completed:me}),Ne(null),ct(!0);return}const te=y.nodes[M];if(!te)return;const ve=vn(y.text,te);vt({title:z,before:ve.before,after:ve.after,fragmentId:te.id,total:le,completed:me}),Ne(ve.fragment),ct(!1)},ne=()=>{const y=D.current;y&&vt(M=>M&&{...M,total:Object.keys(y.nodes).length,completed:g.current.size})},we=()=>{const y=be[se+1];y&&ga(y,se+1)},Be=()=>{if(we(),B&&B.cardType==="vocab"&&B.checkType==="translation-match"&&q){if(q.pairs.length===0){V("incorrect"),ct(!0);return}const te=q.pairs.reduce((ot,dt)=>(ot[dt.rightId]=dt.rightLabel,ot),{});let ve=0;const X={};q.pairs.forEach(ot=>{const xt=q.selection[ot.leftId]===ot.rightId;X[ot.leftId]=xt?"correct":"incorrect",xt&&(ve+=1)});const Te=q.pairs.length||1,Oe=ve/Te,Ye=ve===q.pairs.length;Z(ot=>({...ot,...X})),Ye?(V("correct"),ct(!0),Mt(0)):(V("incorrect"),ct(!1),Mt(ot=>{const dt=ot+1;return dt>=_t&&(Ke(!0),ct(!0),R(xt=>{if(!xt)return xt;const wt=xt.pairs.reduce((kt,Ft)=>(kt[Ft.leftId]=Ft.rightId,kt),{});return{...xt,selection:wt}})),dt})),qt(Ye,Oe);const Xe="connection";Promise.all(q.pairs.map(ot=>{const dt=q.selection[ot.leftId]??null,xt=dt?te[dt]:"",wt={left:ot.leftLabel,expected:ot.rightLabel,answer:xt,checkType:"translation-match"},kt=new TextEncoder().encode(JSON.stringify(wt));return un({itemType:Xe,itemId:ot.cardId,checkType:"translation-match",direction:null,revisionType:v.id,evalType:"translation-match",correct:dt===ot.rightId,maskBase64:null,payloadBase64:ya(kt),personRoleId:L??null})})).then(()=>{wa(Xe,B.cardId,B.checkType,B.direction),zn(c,L)}).catch(()=>{});return}if(rt.length>0){const te=rt.reduce((X,Te)=>{const Oe=ze[Te.key]??"";return X[Te.key]=zt(Oe)===zt(Te.expected)?"correct":"incorrect",X},{});rt.every(({key:X,expected:Te})=>{const Oe=ze[X]??"";return J==="exact"&&zt(Oe)===zt(Te)})?(V("correct"),E(te),ct(!0),Mt(0),qt(!0,1),ra({correct:!0,direction:ye?`${ye} -> computed`:"computed",expectedMap:rt.reduce((X,Te)=>(X[Te.key]=Te.expected,X),{}),answerMap:ze,evalType:"computed"})):(V("incorrect"),E(te),ct(!1),Mt(X=>{const Te=X+1;return Te>=_t&&et&&(Ke(!0),ct(!0)),Te}),qt(!1,0),window.setTimeout(()=>{var Te;const X=pn(T,rt,x);X&&ht.current[X]&&((Te=ht.current[X])==null||Te.focus())},40),ra({correct:!1,direction:ye?`${ye} -> computed`:"computed",expectedMap:rt.reduce((X,Te)=>(X[Te.key]=Te.expected,X),{}),answerMap:ze,evalType:"computed"}));return}if(B&&B.cardType==="info"&&B.infoType==="citation"&&(tt!=null&&tt.fragmentId)){if(!Ee)return;const te=Qt(B.direction),ve=(te==null?void 0:te.fragmentId)??tt.fragmentId,X=Ja(Ee,Le,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Te=X.mask,Oe=X.isCorrect,Ye=X.percent;Oe?(ee.current[tt.fragmentId]=Math.max(ee.current[tt.fragmentId]??0,Ye),(ee.current[tt.fragmentId]??0)>=Dt&&g.current.add(tt.fragmentId),ne(),V("correct"),E({}),ct(!0),It(Te),Mt(0),Ye<100&&_t<=1&&Ke(!0),qt(!0,Ye/100),ra({correct:!0,direction:`quote:${tt.fragmentId}`,expected:Ee,answer:Le,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:ve})):(V("incorrect"),E({}),ct(!1),It(Te),Mt(Xe=>{const ot=Xe+1;return ot>=_t&&et&&(Ke(!0),ct(!0)),ot}),qt(!1,Ye/100),window.setTimeout(()=>{var Xe;return(Xe=St.current)==null?void 0:Xe.focus()},40),ra({correct:!1,direction:`quote:${tt.fragmentId}`,expected:Ee,answer:Le,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:ve}));return}if(!Ee)return;const y=$a(Ee,Le,sa),M=J==="exact"&&zt(Le)===zt(Ee),z=ja(y),le=M||z,me=xa(y);le?(V("correct"),E({}),ct(!0),It(y),Mt(0),me<100&&_t<=1&&Ke(!0),qt(!0,me/100),ra({correct:!0,direction:ye?`${ye} -> ${Ee}`:null,expected:Ee,answer:Le,evalType:"text"})):(V("incorrect"),E({}),ct(!1),It(y),Mt(te=>{const ve=te+1;return ve>=_t&&et&&(Ke(!0),ct(!0)),ve}),qt(!1,me/100),window.setTimeout(()=>{var te;return(te=St.current)==null?void 0:te.focus()},40),ra({correct:!1,direction:ye?`${ye} -> ${Ee}`:null,expected:Ee,answer:Le,evalType:"text"}))},qe=y=>{if(we(),!Ee)return;const M=$a(Ee,y,sa),z=zt(y)===zt(Ee),le=ja(M),me=z||le,te=xa(M);me?(V("correct"),E({}),ct(!0),It(M),Mt(0),te<100&&_t<=1&&Ke(!0),qt(!0,te/100),ra({correct:!0,direction:"word->language",expected:Ee,answer:y,evalType:"language-select"})):(V("incorrect"),E({}),ct(!1),It(M),Mt(ve=>{const X=ve+1;return X>=_t&&et&&(Ke(!0),ct(!0)),X}),qt(!1,te/100),ra({correct:!1,direction:"word->language",expected:Ee,answer:y,evalType:"language-select"}))},ke=()=>{we(),V("correct"),ct(!0),Mt(0),qt(!0,1),Ee&&ra({correct:!0,direction:"manual",expected:Ee,answer:Le,evalType:"manual"})},_e=()=>{if(qt(!1,0),B&&B.cardType==="info"&&B.infoType==="citation"){V(null),He(""),Ke(!1),E({}),ct(!1),It(null),Mt(0),Re(y=>Math.min(y+1,be.length));return}Ma()};n.useEffect(()=>{we()},[se,be]);const Pe=y=>{var z;if(y.key!=="Enter")return;if(y.preventDefault(),y.stopPropagation(),Kt){Ma();return}const M=rt.find(le=>!(ze[le.key]??"").trim());if(M){(z=ht.current[M.key])==null||z.focus();return}Be()},Fe=t.cogita.library.revision.revealModeAfterIncorrect,et=rt.length>0||!!Ee;return e.jsxs($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,children:[xe==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${ae.total?Math.min(100,Math.max(0,ae.current/ae.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:ae.total?`${Math.min(ae.current,ae.total)} / ${ae.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:ie}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",Ce).replace("{check}",Je)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:k,children:t.cogita.library.actions.libraryOverview}),de?e.jsxs(e.Fragment,{children:[e.jsx("a",{className:"cta ghost",href:`${k}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${k}/collections/${O}`,children:t.cogita.library.actions.collectionDetail})]}):e.jsx("a",{className:"cta ghost",href:`${k}/list`,children:t.cogita.library.actions.allCards})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:bt?`${bt.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Jt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Jt.currentLevel??"-"," / ",Jt.levelsCount]}):null,bt?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(bt.correct)).replace("{total}",String(bt.total))}),bt.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(bt.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(br,{outcomes:yt})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[De?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:De})}):null,e.jsx(Ea,{feedbackToken:W?`${W.kind}-${W.tick}`:nt?"idle":st?`${st}-${se}-${Nt}`:"idle",children:B?e.jsx(e.Fragment,{children:Zt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(ss,{copy:t,currentCard:B,currentTypeLabel:Ct,prompt:ye,languages:ce,answer:Le,onAnswerChange:y=>He(M=>mn(M,y,$e)),computedExpected:rt,computedAnswers:ze,onComputedAnswerChange:(y,M)=>at(z=>({...z,[y]:mn(z[y]??"",M,$e)})),answerTemplate:T,outputVariables:x,variableValues:H,computedFieldFeedback:Ue,feedback:st,canAdvance:Kt,quoteContext:tt,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Be,onSkip:_e,onLanguageSelect:qe,onMarkReviewed:ke,onAdvance:Ma,showCorrectAnswer:Ve,setShowCorrectAnswer:Ke,onRevealCorrect:()=>ct(!0),answerMask:Bt,expectedAnswer:Ee,hasExpectedAnswer:et,handleComputedKeyDown:Pe,answerInputRef:St,computedInputRefs:ht,scriptMode:$e,setScriptMode:Ge,matchPairs:q==null?void 0:q.pairs,matchLeftOrder:q==null?void 0:q.leftOrder,matchRightOrder:q==null?void 0:q.rightOrder,matchSelection:q==null?void 0:q.selection,matchActiveLeft:q==null?void 0:q.activeLeft,matchActiveRight:q==null?void 0:q.activeRight,matchFeedback:Se,onMatchLeftSelect:Tn,onMatchRightSelect:Cn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:de?`${k}/collections/${O}`:`${k}/list`,children:de?t.cogita.library.actions.collectionDetail:t.cogita.library.actions.allCards})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:ha?`${ma} / ${ha}`:t.cogita.library.revision.progressUnlimited}),xe==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),xe==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),xe==="ready"&&be.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Fe}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",_t]})]})]}),Jt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Jt.activeCount," / ",Jt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Jt.counts.map((y,M)=>{const z=M+1,le=Jt.currentLevel===z,me=Jt.percentages[M]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":le,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:z}),e.jsx("strong",{children:y})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,me))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[me.toFixed(1),"%"]})]},`level-${z}`)})})]}):null,Ht?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:Ht.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:Ht.dots.map(y=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,y.value*100))}%`,background:`rgba(${Math.round(255*(1-y.value))}, ${Math.round(200*y.value)}, 80, 0.9)`}},y.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:Ht.knownCount})]})]}):null,jt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Sn})]})}):null]})]})]})})})]})]})}const Vn=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],jo={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},wo=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],ko=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function No({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,libraryId:c,collectionId:p}){const[l,d]=n.useState(""),[k,m,N]=Gn([]),[C,v,f]=Yn([]),[J,L]=n.useState(null),[w,K]=n.useState(null),[S,G]=n.useState(null),_=`/#/cogita/library/${c}`;n.useEffect(()=>{xn(c,p).then($=>d($.name)).catch(()=>d(t.cogita.library.collections.defaultName))},[c,p,t]),n.useEffect(()=>{Br({libraryId:c,collectionId:p}).then($=>{if(!$.graphId||$.graphId==="00000000-0000-0000-0000-000000000000"){m([]),v([]);return}const be=$.nodes.map(ce=>{var ae;const Q=ce.payload??{},xe=Q.position??{x:120,y:120},oe=Q.params??{};return{id:ce.nodeId,type:"default",position:xe,data:{nodeType:ce.nodeType,label:((ae=Vn.find(Me=>Me.type===ce.nodeType))==null?void 0:ae.label)??ce.nodeType,params:oe}}}),U=$.edges.map(ce=>({id:ce.edgeId,source:ce.fromNodeId,target:ce.toNodeId,sourceHandle:ce.fromPort??void 0,targetHandle:ce.toPort??void 0}));m(be),v(U)}).catch(()=>{m([]),v([])})},[c,p,v,m]);const A=n.useMemo(()=>k.find($=>$.id===J)??null,[k,J]),O=$=>{var Q;const be=crypto.randomUUID(),U=((Q=Vn.find(xe=>xe.type===$))==null?void 0:Q.label)??$,ce={...jo[$]};m(xe=>[...xe,{id:be,type:"default",position:{x:120+xe.length*40,y:120+xe.length*40},data:{nodeType:$,label:U,params:ce}}]),L(be)},de=n.useCallback($=>{v(be=>Xn({...$,id:crypto.randomUUID()},be))},[v]),Ce=async()=>{K(null);try{await sr({libraryId:c,collectionId:p,nodes:k.map($=>({nodeId:$.id,nodeType:$.data.nodeType,payload:{position:$.position,params:$.data.params}})),edges:C.map($=>({edgeId:$.id,fromNodeId:$.source,fromPort:$.sourceHandle??null,toNodeId:$.target,toPort:$.targetHandle??null}))}),K(t.cogita.library.graph.saveSuccess)}catch{K(t.cogita.library.graph.saveFail)}},Je=async()=>{try{const $=await Vr({libraryId:c,collectionId:p});G($)}catch{G(null)}},ie=$=>{A&&m(be=>be.map(U=>U.id===A.id?{...U,data:{...U.data,params:$}}:U))};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${_}/collections/${p}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Je,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:Ce,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Vn.map($=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>O($.type),children:$.label},$.type))}),w?e.jsx("p",{className:"cogita-help",children:w}):null,S&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(S.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(S.connections)).replace("{infos}",String(S.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(fn,{nodes:k,edges:C,onNodesChange:N,onEdgesChange:f,onConnect:de,onNodeClick:($,be)=>L(be.id),fitView:!0,children:[e.jsx(bn,{color:"rgba(120,160,200,0.2)"}),e.jsx(yn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),A?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:A.data.label}),A.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Xt,{libraryId:c,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:A.data.params.tagId?{id:A.data.params.tagId,label:A.data.params.tagLabel??"",infoType:"topic"}:null,onChange:$=>ie({...A.data.params,tagId:($==null?void 0:$.id)??null,tagLabel:($==null?void 0:$.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:A.data.params.scope??"any",onChange:$=>ie({...A.data.params,scope:$.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),A.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Xt,{libraryId:c,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:A.data.params.languageId?{id:A.data.params.languageId,label:A.data.params.languageLabel??"",infoType:"language"}:null,onChange:$=>ie({...A.data.params,languageId:($==null?void 0:$.id)??null,languageLabel:($==null?void 0:$.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:A.data.params.scope??"any",onChange:$=>ie({...A.data.params,scope:$.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),A.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:A.data.params.infoType??"word",onChange:$=>ie({...A.data.params,infoType:$.target.value}),children:ko.map($=>e.jsx("option",{value:$.value,children:$.label},$.value))})]}),e.jsx(Xt,{libraryId:c,infoType:A.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:A.data.params.infoId?{id:A.data.params.infoId,label:A.data.params.infoLabel??"",infoType:A.data.params.infoType??"word"}:null,onChange:$=>ie({...A.data.params,infoId:($==null?void 0:$.id)??null,infoLabel:($==null?void 0:$.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),A.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:A.data.params.connectionType??"translation",onChange:$=>ie({...A.data.params,connectionType:$.target.value}),children:wo.map($=>e.jsx("option",{value:$.value,children:$.label},$.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:A.data.params.connectionId??"",onChange:$=>ie({...A.data.params,connectionId:$.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(A.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const qn="cogita.preferences",On="cogita.reviewer.preferences",jr=["library_overview","all_cards","all_collections","all_revisions","storyboards","texts","dependencies","transfer"],Un={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},all_revisions:{requiresCollection:!1,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},So=["settings","run","shared"],Aa=30,Js=42;function fa(t,a){const s=(t??"").trim();return s.length<=a?s:a<=1?s.slice(0,a):`${s.slice(0,Math.max(1,a-1)).trimEnd()}…`}function To(t,a=""){const s=t.split("/").filter(Boolean);if(s[0]!=="cogita"||s[1]!=="library")return{};const r=s[2];if(!r)return{};if(!s[3])return{libraryId:r,target:"library_overview"};const i=new URLSearchParams(a),u=i.get("revisionId")??void 0,o=i.get("infoId")??void 0,j=i.get("infoView"),h=j==="cards"?"cards":j==="collections"?"collections":"overview",b=i.get("collectionView")==="overview"?"overview":"infos",c=i.get("collectionAction"),p=i.get("libraryAction"),d=i.get("libraryTarget")==="revisions"?"all_revisions":"all_collections";if(s[3]==="list")return{libraryId:r,target:p==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:u,infoId:o,infoView:h,libraryAction:p==="new-info"?"new-info":void 0};if(s[3]==="detail"||s[3]==="collection")return{libraryId:r,target:"all_cards",cardMode:s[3],revisionId:u,infoId:o,infoView:h};if(s[3]==="new"||s[3]==="add")return{libraryId:r,target:"new_card",revisionId:u,libraryAction:"new-info"};if(s[3]==="edit")return{libraryId:r,target:"new_card",revisionId:u,infoId:s[4]};if(s[3]==="infos"){const m=s[4];return m?s[5]==="checkcards"?{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u,infoId:m,infoView:"cards"}:s[5]==="collections"?{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u,infoId:m,infoView:"collections"}:{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u,infoId:m,infoView:"overview"}:{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u}}if(s[3]==="shared-revisions")return{libraryId:r,target:d,revisionId:u};if(s[3]==="revisions"){const m=s[4];return m?m==="shared-links"?{libraryId:r,target:"all_revisions",revisionView:"shared"}:m==="new"?{libraryId:r,target:"all_revisions",revisionView:"new"}:s[5]==="run"?{libraryId:r,target:"all_revisions",revisionId:m,revisionView:"run"}:s[5]==="shared"?{libraryId:r,target:"all_revisions",revisionId:m,revisionView:"shared"}:{libraryId:r,target:"all_revisions",revisionId:m,revisionView:"settings"}:{libraryId:r,target:"all_revisions"}}if(s[3]==="revision"&&s[4]==="run")return{libraryId:r,target:d,revisionView:"run",revisionId:u,infoId:o,infoView:h};if(s[3]==="dependencies")return{libraryId:r,target:"dependencies"};if(s[3]==="transfer")return{libraryId:r,target:"transfer"};if(s[3]==="storyboards")return s[4]==="new"?{libraryId:r,target:"new_storyboard"}:{libraryId:r,target:"storyboards"};if(s[3]==="texts")return s[4]==="new"?{libraryId:r,target:"new_text"}:{libraryId:r,target:"texts"};if(s[3]!=="collections")return{libraryId:r,target:"library_overview"};if(s[4]==="new")return{libraryId:r,target:"new_collection",revisionId:u};const k=s[4];return k?s[5]==="graph"?{libraryId:r,target:d,collectionId:k,revisionId:u,revisionView:"graph"}:s[5]==="shared-revisions"?{libraryId:r,target:d,collectionId:k,revisionId:u,revisionView:"shared"}:s[5]==="revision"?{libraryId:r,target:d,collectionId:k,revisionId:u,revisionView:s[6]==="run"?"run":"settings",collectionView:b}:c==="new-revision"?{libraryId:r,target:d,collectionId:k,revisionId:u,revisionView:"new"}:{libraryId:r,target:d,collectionId:k,revisionId:u,revisionView:"detail",collectionView:b}:c==="new-collection"?{libraryId:r,target:"new_collection",collectionAction:"new-collection"}:{libraryId:r,target:d}}function Hs(t,a="library_overview",s,r,i,u,o="overview",j="infos"){const h=(b,c)=>{const p=new URLSearchParams;c!=null&&c.revisionId&&p.set("revisionId",c.revisionId),c!=null&&c.collectionAction&&p.set("collectionAction",c.collectionAction),c!=null&&c.libraryAction&&p.set("libraryAction",c.libraryAction),c!=null&&c.libraryTarget&&p.set("libraryTarget",c.libraryTarget),c!=null&&c.infoId&&p.set("infoId",c.infoId),c!=null&&c.infoView&&(c!=null&&c.infoId)&&p.set("infoView",c.infoView),c!=null&&c.collectionView&&c.collectionView!=="infos"&&p.set("collectionView",c.collectionView);const l=p.toString();return l?`${b}?${l}`:b};if(!t)return"/cogita";if(a==="library_overview")return h(`/cogita/library/${t}`,{revisionId:i});if(a==="all_cards")return u?o==="cards"?h(`/cogita/library/${t}/infos/${u}/checkcards`,{revisionId:i}):o==="collections"?h(`/cogita/library/${t}/infos/${u}/collections`,{revisionId:i}):h(`/cogita/library/${t}/infos/${u}`,{revisionId:i}):h(`/cogita/library/${t}/list`,{revisionId:i,infoId:u,infoView:o});if(a==="new_card")return u?h(`/cogita/library/${t}/edit/${u}`,{revisionId:i}):h(`/cogita/library/${t}/list`,{revisionId:i,libraryAction:"new-info"});if(a==="all_collections"||a==="all_revisions"){const b=a==="all_revisions"?"revisions":void 0;return a==="all_revisions"&&i?r==="run"?h(`/cogita/library/${t}/revisions/${i}/run`,{revisionId:i}):r==="shared"?h(`/cogita/library/${t}/revisions/${i}/shared`,{revisionId:i}):h(`/cogita/library/${t}/revisions/${i}`,{revisionId:i}):a==="all_revisions"&&r==="new"?h(`/cogita/library/${t}/revisions/new`,{revisionId:i}):a==="all_revisions"?r==="shared"?h(`/cogita/library/${t}/revisions/shared-links`,{revisionId:i}):r==="run"?h(`/cogita/library/${t}/revision/run`,{revisionId:i,libraryTarget:b}):h(`/cogita/library/${t}/revisions`,{revisionId:i}):!s&&r==="run"?h(`/cogita/library/${t}/revision/run`,{revisionId:i,libraryTarget:b}):s?r==="graph"?h(`/cogita/library/${t}/collections/${s}/graph`,{revisionId:i,libraryTarget:b}):r==="settings"?h(`/cogita/library/${t}/collections/${s}/revision`,{revisionId:i,libraryTarget:b}):r==="run"?h(`/cogita/library/${t}/collections/${s}/revision/run`,{revisionId:i,libraryTarget:b}):r==="shared"?h(`/cogita/library/${t}/collections/${s}/shared-revisions`,{revisionId:i,libraryTarget:b}):r==="new"?h(`/cogita/library/${t}/collections/${s}`,{revisionId:i,libraryTarget:b,collectionAction:"new-revision"}):h(`/cogita/library/${t}/collections/${s}`,{revisionId:i,libraryTarget:b,collectionView:j}):h(`/cogita/library/${t}/collections`,{revisionId:i,libraryTarget:b})}return a==="new_collection"?h(`/cogita/library/${t}/collections`,{revisionId:i,collectionAction:"new-collection"}):a==="transfer"?h(`/cogita/library/${t}/transfer`,{revisionId:i}):a==="storyboards"?h(`/cogita/library/${t}/storyboards`,{revisionId:i}):a==="new_storyboard"?h(`/cogita/library/${t}/storyboards/new`,{revisionId:i}):a==="texts"?h(`/cogita/library/${t}/texts`,{revisionId:i}):a==="new_text"?h(`/cogita/library/${t}/texts/new`,{revisionId:i}):a==="dependencies"?h(`/cogita/library/${t}/dependencies`,{revisionId:i}):h(`/cogita/library/${t}`,{revisionId:i})}function ba(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function Co(t){return typeof t=="string"&&jr.includes(t)}function Io(t,a){var j;if(!t.length)return null;const s=t.filter(h=>a.has(h.roleId)),r=s.length>0?s:t,i=r.map(h=>{var c,p;const b=((p=(c=h.fields.find(l=>l.fieldType==="role_kind"))==null?void 0:c.plainValue)==null?void 0:p.toLowerCase())??"";return{roleId:h.roleId,roleKind:b}}),u=i.find(h=>h.roleKind.includes("master"));if(u)return u.roleId;const o=i.find(h=>h.roleKind.includes("account")||h.roleKind.includes("user"));return o?o.roleId:((j=r[0])==null?void 0:j.roleId)??null}function Mo(t){if(!t)return{version:1,byLibrary:{}};try{const a=JSON.parse(t);return!a||typeof a!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:a.lastLibraryId,byLibrary:a.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function Lo({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b}){const c=Wa(),p=Pa(),l=n.useMemo(()=>To(p.pathname,p.search),[p.pathname,p.search]),d=t.cogita.workspace,[k,m]=n.useState([]),[N,C]=n.useState([]),[v,f]=n.useState([]),[J,L]=n.useState([]),[w,K]=n.useState(void 0),[S,G]=n.useState("library_overview"),[_,A]=n.useState(void 0),[O,de]=n.useState(void 0),[Ce,Je]=n.useState("detail"),[ie,$]=n.useState(void 0),[be,U]=n.useState(!1),[ce,Q]=n.useState(!0),[xe,oe]=n.useState(!1),[ae,Me]=n.useState(!1),[se,Re]=n.useState(null),[Le,He]=n.useState(0),[st,V]=n.useState(""),[ye,Qe]=n.useState(""),[Ee,Ne]=n.useState(""),[tt,vt]=n.useState([]),[rt,Ae]=n.useState(""),[ze,at]=n.useState(0),[Ue,E]=n.useState(null),[Y,pe]=n.useState(null),T=n.useRef({version:1,byLibrary:{}}),I=n.useRef(!1),x=n.useRef(!1),F=n.useRef(null),H=n.useMemo(()=>k.find(g=>g.libraryId===w)??null,[k,w]),fe=n.useMemo(()=>N.find(g=>g.collectionId===_)??null,[N,_]),q=ba(p.pathname)==="/cogita/persons";n.useEffect(()=>{if(!w){vt([]),Ae("");return}let g=!1;return rr({libraryId:w}).then(ee=>{if(g)return;const B=ee.filter(nt=>(nt.roleKind??"").trim().toLowerCase()==="person");vt(B);try{const nt=window.localStorage.getItem(On),ft=(nt?JSON.parse(nt):{})[w]??"",Rt=ft&&B.some(At=>At.roleId===ft)?ft:"";Ae(Rt)}catch{Ae("")}}).catch(()=>{g||(vt([]),Ae(""))}),()=>{g=!0}},[w,ze]),n.useEffect(()=>{if(w)try{const g=window.localStorage.getItem(On),ee=g?JSON.parse(g):{};rt?ee[w]=rt:delete ee[w],window.localStorage.setItem(On,JSON.stringify(ee))}catch{}},[w,rt]);const R=n.useMemo(()=>J.find(g=>g.revisionId===O)??null,[J,O]),Se=n.useMemo(()=>({detail:d.revisions.detail,graph:d.revisions.graph,settings:d.revisions.settings,run:d.revisions.run,shared:d.targets.sharedRevisions,new:d.revisionForm.createAction}),[d.revisions.detail,d.revisions.graph,d.revisions.run,d.revisions.settings,d.targets.sharedRevisions,d.revisionForm.createAction]),Z=n.useMemo(()=>S==="new_card"?"all_cards":S==="new_collection"?"all_collections":S==="new_storyboard"?"storyboards":S==="new_text"?"texts":S,[S]),re=n.useMemo(()=>Ce==="new"?"settings":Ce,[Ce]),W=S==="all_collections"||S==="all_revisions",je=n.useMemo(()=>S==="new_collection"?"create":S==="all_collections"&&_?"selected":"search",[_,S]),he=n.useMemo(()=>l.infoId?"selected":S==="new_card"?"create":"search",[l.infoId,S]),ge=n.useMemo(()=>v.find(g=>g.infoId===l.infoId)??null,[v,l.infoId]),$e=n.useMemo(()=>({library_overview:d.targets.libraryOverview,all_cards:d.targets.allCards,new_card:d.targets.newCard,all_collections:d.targets.allCollections,all_revisions:d.targets.allRevisions,new_collection:d.targets.newCollection,transfer:d.targets.transfer,storyboards:d.targets.storyboards,new_storyboard:d.targets.newStoryboard,texts:d.targets.texts,new_text:d.targets.newText,dependencies:d.targets.dependencies}),[d.targets]),Ge=n.useMemo(()=>$e[Z]??Z,[Z,$e]),Ve=Se[re],Ke=!!w,bt=n.useMemo(()=>{const g=h==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":h==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return h==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:g},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:g},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:g},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:g},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:g},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:g},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:g},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:g},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:g},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:g},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:g},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:g},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:g},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:h==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:g},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:g},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:g},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:g},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:g},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:g},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:g},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:g},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:g},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:g},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:g},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:g},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:g},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:g},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:g},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:g},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:g},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:g},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:g},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:g},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:g},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:g},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:g},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:g},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:g},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:g},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[h]),ut=bt.length,yt=Math.max(0,Math.min(Le,ut-1)),We=bt[yt],De=!!_,mt=Ke&&S==="all_collections",it=De&&S==="all_collections",pt=Ke&&(S==="all_revisions"||De&&S==="all_collections")&&(re==="settings"||re==="run"||re==="shared"||S==="all_revisions"),Bt=pt,It=pt&&!!O,Nt=n.useCallback(g=>{const ee=!!g.libraryId;let B=g.target,nt=g.collectionId,gt=g.revisionId,ft=g.revisionView,Rt=g.infoId,At=g.infoView??l.infoView??"overview",Ct=g.collectionView??l.collectionView??"infos";ee?Un[B].requiresCollection&&!nt?(B=B==="all_revisions"?"all_revisions":"all_collections",gt=void 0,ft="detail"):B!=="all_collections"&&B!=="all_revisions"?(nt=void 0,gt=void 0,B!=="new_card"&&B!=="all_cards"&&(Rt=void 0,At="overview"),B!=="new_collection"&&(Ct="infos")):Un[B].allowsRevision?So.includes(ft)||(gt=void 0):ft="detail":(B="library_overview",nt=void 0,gt=void 0,ft="detail",Rt=void 0,At="overview",Ct="infos"),K(g.libraryId),G(B),A(nt),de(gt),Je(ft),U(!1);const Pt=ba(Hs(g.libraryId,B,nt,ft,gt,Rt,At,Ct));ba(`${p.pathname}${p.search}`)!==Pt&&(F.current=Pt,c(Pt))},[p.pathname,p.search,c,l.collectionView,l.infoView]),Mt=n.useMemo(()=>[{key:"library",label:d.layers.library,visible:!0,value:w??"",selectedLabel:(H==null?void 0:H.name)??d.path.noLibrarySelected,disabled:ce||k.length===0,options:k.map(g=>({value:g.libraryId,label:g.name})),emptyOption:d.noLibraryOption,onSelect:g=>{const ee=g||void 0;Nt({libraryId:ee,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:d.layers.target,visible:Ke,value:Z,selectedLabel:Ge,disabled:!Ke,options:jr.map(g=>({value:g,label:$e[g]})),onSelect:g=>{const ee=g;Nt({libraryId:w,target:ee,collectionId:_,revisionId:O,revisionView:Ce,infoId:ee==="new_card"?l.infoId:void 0})}},{key:"info_mode",label:d.layers.target,visible:Z==="all_cards",value:he,selectedLabel:he==="create"?d.infoMode.create:he==="selected"?(ge==null?void 0:ge.label)??ie??t.cogita.library.list.selectedEmpty:d.infoMode.search,disabled:!Ke,options:[{value:"search",label:d.infoMode.search},{value:"create",label:d.infoMode.create},...l.infoId?[{value:"selected",label:(ge==null?void 0:ge.label)??ie??t.cogita.library.list.selectedEmpty}]:[]],onSelect:g=>{if(g==="selected"){if(!l.infoId)return;Nt({libraryId:w,target:"all_cards",collectionId:_,revisionId:O,revisionView:Ce,infoId:l.infoId,infoView:"overview"});return}if(g==="create"){Nt({libraryId:w,target:"new_card",collectionId:_,revisionId:O,revisionView:Ce,infoId:void 0});return}Nt({libraryId:w,target:"all_cards",collectionId:_,revisionId:O,revisionView:Ce,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:d.layers.target,visible:Z==="all_cards"&&!!l.infoId,value:S==="new_card"&&l.infoId?"edit":l.infoView==="cards"?"cards":l.infoView==="collections"?"collections":"overview",selectedLabel:S==="new_card"&&l.infoId?d.infoActions.edit:l.infoView==="cards"?d.infoActions.seeCards:l.infoView==="collections"?"Kolekcje":d.infoActions.overview,disabled:!Ke||!l.infoId,options:[{value:"overview",label:d.infoActions.overview},{value:"edit",label:d.infoActions.edit},{value:"cards",label:d.infoActions.seeCards},{value:"collections",label:"Kolekcje"}],onSelect:g=>{if(l.infoId){if(g==="edit"){Nt({libraryId:w,target:"new_card",collectionId:_,revisionId:O,revisionView:Ce,infoId:l.infoId});return}if(g==="cards"){Nt({libraryId:w,target:"all_cards",collectionId:_,revisionId:O,revisionView:Ce,infoId:l.infoId,infoView:"cards"});return}Nt({libraryId:w,target:"all_cards",collectionId:_,revisionId:O,revisionView:Ce,infoId:l.infoId,infoView:"overview"})}}},{key:"collection_mode",label:d.layers.collection,visible:Ke&&(S==="all_collections"||S==="new_collection"),value:je,selectedLabel:je==="create"?t.cogita.library.actions.createCollection:je==="selected"?(fe==null?void 0:fe.name)??d.path.noCollectionSelected:t.cogita.library.actions.collections,disabled:!Ke,options:[{value:"search",label:t.cogita.library.actions.collections},{value:"create",label:t.cogita.library.actions.createCollection},..._&&fe?[{value:"selected",label:fe.name}]:[]],onSelect:g=>{if(g==="create"){Nt({libraryId:w,target:"new_collection",collectionId:void 0,revisionId:void 0,revisionView:"detail"});return}if(g==="selected"&&_){const ee=W?S:"all_collections";Nt({libraryId:w,target:ee,collectionId:_,revisionId:O,revisionView:ee==="all_revisions"?"settings":"detail"});return}if(g==="collections"){Nt({libraryId:w,target:"all_cards",collectionId:_,revisionId:O,revisionView:Ce,infoId:l.infoId,infoView:"collections"});return}Nt({libraryId:w,target:W?S:"all_collections",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection",label:d.layers.collection,visible:mt&&je!=="create",value:_??"",selectedLabel:(fe==null?void 0:fe.name)??d.path.noCollectionSelected,disabled:!Ke||xe||N.length===0,options:N.map(g=>({value:g.collectionId,label:g.name})),emptyOption:d.selectCollectionOption,onSelect:g=>{const ee=g||void 0,B=W?S:"all_collections";Nt({libraryId:w,target:B,collectionId:ee,revisionId:void 0,revisionView:B==="all_revisions"?"settings":"detail"})}},{key:"collection_selected_action",label:d.layers.revision,visible:it,value:S==="all_revisions"?"revisions":re==="graph"?"edit":re==="settings"||re==="run"||re==="shared"?"revisions":(l.collectionView??"infos")==="overview"?"overview":"infos",selectedLabel:S==="all_revisions"?d.targets.allRevisions:re==="graph"?"Edytuj":re==="settings"||re==="run"||re==="shared"?d.targets.allRevisions:(l.collectionView??"infos")==="overview"?"Przegląd":"Informacje",disabled:!_,options:[{value:"overview",label:"Przegląd"},{value:"edit",label:"Edytuj"},{value:"infos",label:"Informacje"},{value:"revisions",label:d.targets.allRevisions}],onSelect:g=>{if(_){if(g==="edit"){Nt({libraryId:w,target:W?S:"all_collections",collectionId:_,revisionId:void 0,revisionView:"graph"});return}if(g==="revisions"){Nt({libraryId:w,target:W?S:"all_collections",collectionId:_,revisionId:O,revisionView:"settings"});return}Nt({libraryId:w,target:W?S:"all_collections",collectionId:_,revisionId:void 0,revisionView:"detail",infoId:l.infoId,infoView:l.infoView,collectionView:g==="overview"?"overview":"infos"})}}},{key:"revision_mode",label:d.layers.revision,visible:Bt,value:Ce==="new"?"create":!O&&re==="shared"?"shared":"search",selectedLabel:Ce==="new"?d.revisionForm.createAction:!O&&re==="shared"?d.targets.sharedRevisions:d.infoActions.search,disabled:S==="all_revisions"?!Ke:!De,options:[{value:"search",label:d.infoActions.search},{value:"create",label:d.revisionForm.createAction},{value:"shared",label:d.targets.sharedRevisions}],onSelect:g=>{Nt({libraryId:w,target:W?S:"all_revisions",collectionId:S==="all_revisions"?void 0:_,revisionId:void 0,revisionView:g==="create"?"new":g==="shared"?"shared":"settings"})}},{key:"revision_entry",label:d.layers.revision,visible:Bt,value:O??"",selectedLabel:(R==null?void 0:R.name)??d.status.noRevisions,disabled:(S==="all_revisions"?!Ke:!De)||ae||J.length===0,options:J.map(g=>({value:g.revisionId,label:g.name})),emptyOption:d.status.noRevisions,onSelect:g=>{Nt({libraryId:w,target:W?S:"all_collections",collectionId:_,revisionId:g||void 0,revisionView:re==="settings"||re==="run"||re==="shared"?re:"settings"})}},{key:"revision_selected_action",label:d.layers.revision,visible:It,value:re==="run"?"run":re==="shared"?"shared":"settings",selectedLabel:re==="run"?d.revisions.run:re==="shared"?d.targets.sharedRevisions:d.infoActions.edit,disabled:!O,options:[{value:"settings",label:d.infoActions.edit},{value:"run",label:d.revisions.run},{value:"shared",label:d.targets.sharedRevisions}],onSelect:g=>{O&&Nt({libraryId:w,target:W?S:"all_collections",collectionId:_,revisionId:O,revisionView:g==="run"?"run":g==="shared"?"shared":"settings"})}}],[N,xe,he,v,k,ce,Nt,J,ae,fe,_,ge,R,O,ie,De,Ke,H,W,w,Ve,Ce,S,re,Z,Ge,mt,it,Bt,It,$e,t.cogita.library.list.selectedEmpty,l.infoId,l.infoView,l.collectionView,d.infoActions.edit,d.infoActions.overview,d.infoActions.seeCards,d.layers.collection,d.layers.library,d.layers.revision,d.layers.target,d.noLibraryOption,d.path.noCollectionSelected,d.path.noLibrarySelected,d.selectCollectionOption,d.targets.allRevisions,d.infoActions.search,d.revisionForm.createAction,d.revisions.run,d.targets.sharedRevisions,je]),St=n.useMemo(()=>Mt.filter(g=>g.visible),[Mt]),ht=n.useMemo(()=>St.filter(g=>g.key!=="library"&&g.key!=="collection"),[St]),Kt=n.useMemo(()=>ht.find(g=>g.key==="target")??null,[ht]),ct=n.useMemo(()=>ht.find(g=>g.key==="info_mode")??null,[ht]),Ze=n.useMemo(()=>ht.find(g=>g.key==="info_selected_action")??null,[ht]),Tt=n.useMemo(()=>ht.find(g=>g.key==="collection_mode")??null,[ht]),Gt=n.useMemo(()=>ht.find(g=>g.key==="revision_mode")??null,[ht]),Ot=n.useMemo(()=>ht.find(g=>g.key==="collection_selected_action")??null,[ht]),Vt=n.useMemo(()=>ht.find(g=>g.key==="revision_entry")??null,[ht]),ue=n.useMemo(()=>ht.find(g=>g.key==="revision_selected_action")??null,[ht]),Et=n.useCallback((g,ee)=>g?e.jsx("div",{className:"cogita-sidebar-actions",children:g.options.map(B=>e.jsx("button",{type:"button",className:`ghost ${String(g.value)===B.value?"active":""}`,onClick:()=>g.onSelect(B.value),disabled:g.disabled,title:B.label,children:fa(B.label,Aa)},`${ee}:${g.key}:${B.value}`))}):null,[]),Zt=n.useMemo(()=>{const g=l.libraryId;if(!g||!p.pathname.startsWith("/cogita/library/"))return null;const ee={copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,libraryId:g};if(l.target==="library_overview")return e.jsx(mi,{...ee});if(l.target==="all_cards")return l.infoId&&l.infoView==="cards"?e.jsx(qi,{...ee,infoId:l.infoId,selectedReviewerRoleId:rt||null}):e.jsx(Ti,{...ee,mode:l.cardMode??"list"});if(l.target==="new_card")return e.jsx(Ei,{...ee,editInfoId:l.infoId});if(l.target==="dependencies")return e.jsx(Ki,{...ee});if(l.target==="transfer")return e.jsx(Wi,{...ee});if(l.target==="storyboards"||l.target==="new_storyboard")return e.jsx(Qi,{...ee});if(l.target==="texts"||l.target==="new_text")return e.jsx(Gi,{...ee});if(l.target==="all_collections"||l.target==="all_revisions"){if(l.target==="all_revisions"&&!l.collectionId)return l.revisionView==="run"?e.jsx(Bn,{...ee,revisionId:l.revisionId}):e.jsx(Us,{...ee,revisionId:l.revisionId});if(!l.collectionId&&l.revisionView==="run")return e.jsx(Bn,{...ee,revisionId:l.revisionId});if(l.collectionId){const B={...ee,collectionId:l.collectionId};return l.revisionView==="graph"?e.jsx(No,{...B}):l.revisionView==="shared"?e.jsx(Hi,{...ee,collectionId:l.collectionId}):l.revisionView==="settings"?e.jsx(Us,{...B,revisionId:l.revisionId}):l.revisionView==="run"?e.jsx(Bn,{...B,revisionId:l.revisionId}):e.jsx(Xi,{...B})}return e.jsx(Yi,{...ee})}return l.target==="new_collection"?e.jsx(ao,{...ee,onCreated:B=>{Nt({libraryId:g,target:S==="all_revisions"?"all_revisions":"all_collections",collectionId:B,revisionId:void 0,revisionView:"graph"})}}):null},[a,Nt,t,h,p.pathname,c,b,u,j,r,i,l.cardMode,l.collectionId,l.infoId,l.libraryId,l.revisionId,l.revisionView,l.target,o,s,S,rt]);n.useEffect(()=>{let g=!1;return(async()=>{var B,nt,gt,ft,Rt;Q(!0);try{await qr();const[At,Ct,Pt]=await Promise.all([Zs(),tr(),Or()]);if(g)return;m(At);const ha=new Set(Pt.nodes.filter(jt=>jt.nodeType==="role"&&jt.canLink).map(jt=>jt.roleId??"")),ma=Io(Ct,ha);if(E(ma),ma){const jt=Pt.nodes.find(Dt=>Dt.nodeType==="data"&&Dt.roleId===ma&&(Dt.fieldType===qn||Dt.label===qn));pe((jt==null?void 0:jt.dataKeyId)??null),T.current=Mo(jt==null?void 0:jt.value)}const _t=(B=At.find(jt=>jt.libraryId===l.libraryId))==null?void 0:B.libraryId,sa=_t?(gt=(nt=T.current.byLibrary)==null?void 0:nt[_t])==null?void 0:gt.lastTarget:void 0,Sa=Co(sa)?sa:"library_overview";K(_t),G(l.target??Sa),de(l.revisionId??(_t?(Rt=(ft=T.current.byLibrary)==null?void 0:ft[_t])==null?void 0:Rt.lastRevisionId:void 0)),Je(l.revisionView??"detail"),I.current=!0}catch{g||Re(d.status.loadFailed)}finally{g||Q(!1)}})(),()=>{g=!0}},[d.status.loadFailed]),n.useLayoutEffect(()=>{if(I.current){if(!l.libraryId){K(void 0),G(l.target??"library_overview"),A(void 0),de(void 0),Je("detail");return}l.libraryId&&k.some(g=>g.libraryId===l.libraryId)&&K(l.libraryId),l.target&&G(l.target),A(l.collectionId),de(l.revisionId),l.revisionView&&Je(l.revisionView)}},[k,l.collectionId,l.libraryId,l.revisionId,l.revisionView,l.target]),n.useEffect(()=>{if(!w){C([]),A(void 0),f([]),L([]),de(void 0);return}let g=!1;return oe(!0),Oa({libraryId:w,limit:200}).then(ee=>{var gt;if(g)return;const B=ee.items;C(B);const nt=(gt=B.find(ft=>ft.collectionId===l.collectionId))==null?void 0:gt.collectionId;A(nt)}).catch(()=>{g||(C([]),A(void 0))}).finally(()=>{g||oe(!1)}),()=>{g=!0}},[l.collectionId,w]),n.useEffect(()=>{if(!w||Z!=="all_cards"&&S!=="new_card"){f([]);return}let g=!1;return ts({libraryId:w,limit:200}).then(ee=>{g||f(ee)}).catch(()=>{g||f([])}),()=>{g=!0}},[Z,w,S]),n.useEffect(()=>{if(!w||S!=="all_revisions"&&!_){L([]),S!=="all_revisions"&&de(void 0);return}let g=!1;return Me(!0),Zn({libraryId:w,collectionId:S==="all_revisions"?void 0:_}).then(ee=>{var gt,ft,Rt,At;if(g)return;L(ee);const B=(ft=(gt=T.current.byLibrary)==null?void 0:gt[w])==null?void 0:ft.lastRevisionId,nt=((Rt=ee.find(Ct=>Ct.revisionId===l.revisionId))==null?void 0:Rt.revisionId)??((At=ee.find(Ct=>Ct.revisionId===B))==null?void 0:At.revisionId);de(nt)}).catch(()=>{g||(L([]),de(void 0))}).finally(()=>{g||Me(!1)}),()=>{g=!0}},[l.revisionId,_,w,S]),n.useEffect(()=>{const g=l.infoId;if(!w||!g){$(void 0);return}let ee=!1;return na({libraryId:w,infoId:g}).then(B=>{if(ee)return;const nt=B.payload??{},gt=nt.definition&&typeof nt.definition=="object"?nt.definition:null,ft=typeof(gt==null?void 0:gt.title)=="string"?gt.title:void 0,Rt=typeof(gt==null?void 0:gt.question)=="string"?gt.question:void 0,At=typeof nt.label=="string"?nt.label:void 0,Ct=typeof nt.name=="string"?nt.name:void 0,Pt=typeof nt.title=="string"?nt.title:void 0;$(ft??Rt??At??Ct??Pt??B.infoId)}).catch(()=>{ee||$(g)}),()=>{ee=!0}},[l.infoId,w]),n.useEffect(()=>{if(!I.current||l.libraryId&&k.some(gt=>gt.libraryId===l.libraryId)&&l.libraryId!==w||l.target&&l.target!==S||l.revisionView&&l.revisionView!==Ce||l.revisionId&&l.revisionId!==O||Un[S].requiresCollection&&!_&&(l.target==="all_collections"||l.target==="all_revisions")&&l.collectionId)return;const g=ba(`${p.pathname}${p.search}`);if(ba(p.pathname)==="/cogita"&&!l.libraryId&&!w){F.current=null;return}if(ba(p.pathname)==="/cogita/persons"){F.current=null;return}if(ba(p.pathname)===`/cogita/library/${w}/revision/run`&&l.revisionView==="run"&&!l.collectionId&&(S==="all_collections"||S==="all_revisions")&&Ce==="run"&&!_){F.current=null;return}const nt=ba(Hs(w,S,_,Ce,O,l.infoId,l.infoView??"overview",l.collectionView??"infos"));if(g===nt){F.current=null;return}F.current!==nt&&(F.current=nt,c(nt,{replace:!0}))},[k,p.pathname,p.search,c,l.collectionId,l.infoId,l.infoView,l.collectionView,l.libraryId,l.revisionId,l.revisionView,l.target,_,w,O,Ce,S]),n.useEffect(()=>{if(typeof window>"u")return;const g=()=>{window.innerWidth>920&&U(!1)};return window.addEventListener("resize",g),()=>window.removeEventListener("resize",g)},[]),n.useEffect(()=>{if(!I.current||!Ue||!w||x.current)return;const g=T.current,ee={...g.byLibrary??{}},B={...ee[w]??{},lastCollectionId:_,lastRevisionId:O,lastRevisionView:Ce,lastTarget:S},nt={version:1,lastLibraryId:w,byLibrary:{...ee,[w]:B}},gt=JSON.stringify(g),ft=JSON.stringify(nt);if(gt===ft)return;T.current=nt,x.current=!0,(async()=>{try{if(Y)await Ur(Y,{plainValue:ft});else{const At=await Jr(Ue,{itemName:qn,itemType:"data",plainValue:ft});pe(At.dataItemId)}}catch{Re(d.status.savePrefsFailed)}finally{x.current=!1}})()},[Y,Ue,_,w,O,Ce,S,d.status.savePrefsFailed]);const Ut=async()=>{const g=st.trim();if(!g){Re(t.cogita.user.libraryNameRequired);return}Re(null);try{const ee=await Wr({name:g});m(B=>[ee,...B]),K(ee.libraryId),G("library_overview"),A(void 0),V("")}catch{Re(t.cogita.user.libraryCreateFailed)}},D=async()=>{if(!w||!_){Re(d.status.selectLibraryFirst);return}const g=Ee.trim();if(!g){Re(d.revisionForm.nameLabel);return}Re(null);try{const ee=await Hr({libraryId:w,collectionId:_,name:g,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});L(B=>[ee,...B]),de(ee.revisionId),G(S==="all_revisions"?"all_revisions":"all_collections"),Je("settings"),Ne("")}catch{Re(d.status.loadFailed)}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,headerExtra:e.jsxs("div",{className:"cogita-header-reviewer-actions",children:[e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:rt,disabled:!w,onChange:g=>{const ee=g.target.value;if(ee==="__new_person__"){c("/cogita/persons");return}Ae(ee)},children:[e.jsx("option",{value:"",children:w?"No person":"Select library first"}),tt.map(g=>e.jsx("option",{value:g.roleId,children:g.label},g.roleId)),e.jsx("option",{value:"__new_person__",children:"+ Create new person"})]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>c("/cogita/persons"),children:"Persons"})]}),children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${be?"open":""}`,"aria-label":d.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{title:(H==null?void 0:H.name)??d.path.noLibrarySelected,children:fa((H==null?void 0:H.name)??d.path.noLibrarySelected,Aa)}),e.jsx("p",{className:"cogita-sidebar-note",children:H?d.sidebar.libraryActionsHint:d.status.selectLibraryFirst}),Et(Kt,"sidebar"),S==="all_revisions"&&Vt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.targets.allRevisions}),Et(Gt,"sidebar"),Et(Vt,"sidebar"),ue?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(R==null?void 0:R.name)??d.status.noRevisions,children:fa((R==null?void 0:R.name)??d.status.noRevisions,Aa)}),Et(ue,"sidebar")]}):null]}):null,ct?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.infoActionsHint}),Et(ct,"sidebar"),Ze?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(ge==null?void 0:ge.label)??ie??t.cogita.library.list.selectedEmpty,children:fa((ge==null?void 0:ge.label)??ie??t.cogita.library.list.selectedEmpty,Aa)}),e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.selectedInfoActionsHint}),Et(Ze,"sidebar")]}):null]}):null,Tt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.collectionActionsHint}),Et(Tt,"sidebar"),fe&&Ot?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:fe.name,children:fa(fe.name,Aa)}),Et(Ot,"sidebar"),S!=="all_revisions"&&Vt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.targets.allRevisions}),Et(Gt,"sidebar"),Et(Vt,"sidebar"),ue?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(R==null?void 0:R.name)??d.status.noRevisions,children:fa((R==null?void 0:R.name)??d.status.noRevisions,Aa)}),Et(ue,"sidebar")]}):null]}):null]}):null]}):null]}),e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:d.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:r,children:d.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{j("cogita"),U(!1)},children:d.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:i,children:o?t.account.secureModeDisable:t.account.secureModeEnable}),e.jsx("button",{type:"button",className:"ghost",disabled:!w,onClick:()=>{w&&(c(`/cogita/live-sessions/${encodeURIComponent(w)}`),U(!1))},children:t.cogita.library.revision.live.hostTitle})]})]})]}),be?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":d.sidebar.closeMenu,onClick:()=>U(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":d.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>U(g=>!g),"aria-label":be?d.sidebar.closeMenu:d.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),St.map((g,ee)=>e.jsxs("div",{className:"cogita-browser-segment",children:[ee>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,g.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":g.label,title:g.selectedLabel,children:fa(g.selectedLabel,Js)}):e.jsxs("select",{"aria-label":g.label,value:g.value,onChange:B=>g.onSelect(B.target.value),disabled:g.disabled,children:[g.emptyOption?e.jsx("option",{value:"",children:g.emptyOption}):null,g.options.map(B=>e.jsx("option",{value:B.value,title:B.label,children:fa(B.label,Js)},`${g.key}:${B.value}`))]})]},`menu:${g.key}`))]}),Zt?e.jsxs(e.Fragment,{children:[(S==="all_collections"||S==="all_revisions")&&Ce==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:d.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsxs("select",{value:_??"",onChange:g=>A(g.target.value||void 0),children:[e.jsx("option",{value:"",children:d.selectCollectionOption}),N.map(g=>e.jsx("option",{value:g.collectionId,children:g.name},g.collectionId))]})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:d.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Ee,onChange:g=>Ne(g.target.value),placeholder:d.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:D,children:d.revisionForm.createAction}),se?e.jsx("p",{className:"cogita-form-error",children:se}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(or.Provider,{value:!0,children:Zt})})]}):null,Zt?null:e.jsxs(e.Fragment,{children:[q?e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Ji,{copy:t,onPersonCreated:g=>{at(ee=>ee+1)}})}):null,!w&&!q?e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:We.step}),e.jsx("h2",{children:We.title})]}),e.jsxs("p",{children:[yt+1," / ",ut]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:We.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:We.passages.map(g=>e.jsx("p",{children:g},g))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:We.focus.map(g=>e.jsx("span",{children:g},g))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:We.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:bt.map((g,ee)=>e.jsx("button",{type:"button",className:`ghost ${ee===yt?"active":""}`,onClick:()=>He(ee),"aria-label":`${ee+1}`,children:ee+1},`tutorial:${g.title}:${ee}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:yt===0,onClick:()=>He(g=>Math.max(0,g-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:yt===ut-1,onClick:()=>He(g=>Math.min(ut-1,g+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:st,onChange:g=>V(g.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Ut,children:t.cogita.user.createLibraryAction}),se?e.jsx("p",{className:"cogita-form-error",children:se}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),k.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,k.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:k.map(g=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{Nt({libraryId:g.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:g.name})]},g.libraryId))}):null]})]})]}):null]})]})]})})}const Ho=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:Lo},Symbol.toStringTag,{value:"Module"}));function Ao({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,shareId:c}){const[p,l]=n.useState(null),[d,k]=n.useState("loading"),[m,N]=n.useState(t.cogita.library.collections.defaultName),[C,v]=n.useState("Cogita Library"),[f,J]=n.useState([]),[L,w]=n.useState([]),[K,S]=n.useState("idle"),[G,_]=n.useState({current:0,total:0}),[A,O]=n.useState(0),[de,Ce]=n.useState(""),[Je,ie]=n.useState(null),[$,be]=n.useState(null),[U,ce]=n.useState(null),[Q,xe]=n.useState(null),[oe,ae]=n.useState([]),[Me,se]=n.useState({}),[Re,Le]=n.useState({}),[He,st]=n.useState(null),[V,ye]=n.useState(null),[Qe,Ee]=n.useState(null),[Ne,tt]=n.useState(null),[vt,rt]=n.useState({}),Ae=n.useRef(0),[ze,at]=n.useState(null),Ue=n.useRef(null),E=n.useRef(null),[Y,pe]=n.useState(null),[T,I]=n.useState(!1),[x,F]=n.useState(null),[H,fe]=n.useState([]),[q,R]=n.useState(null),Se=n.useRef(null),Z=n.useRef(null),[re,W]=n.useState(null),[je,he]=n.useState(0),ge=n.useRef(null),$e=n.useRef({}),[Ge,Ve]=n.useState(!1),[Ke,bt]=n.useState({}),ut=n.useRef(null),yt=n.useRef(new Set),We=n.useRef({}),[De,mt]=n.useState([]),[it,pt]=n.useState(new Set),[Bt,It]=n.useState(!1),Nt=Pa(),Mt=n.useMemo(()=>new URLSearchParams(Nt.search),[Nt.search]),St=n.useMemo(()=>Mt.get("key")??"",[Mt]),ht=(p==null?void 0:p.mode)??"random",Kt=(p==null?void 0:p.check)??"exact",ct=(p==null?void 0:p.limit)??20,Ze=n.useMemo(()=>cs((p==null?void 0:p.revisionType)??ht),[p,ht]),Tt=n.useMemo(()=>{const P=p==null?void 0:p.revisionSettings,ne=mr(Ze,Mt);return kn(Ze,P??ne)},[p,Mt,Ze]),Gt=n.useMemo(()=>t.cogita.library.revision[Ze.labelKey]??ht,[t,ht,Ze]),Ot=n.useMemo(()=>Kt==="exact"?t.cogita.library.revision.checkValue:Kt,[t,Kt]),ue=d==="ready"?f[A]??null:null,Et=(ue==null?void 0:ue.checkType)==="translation-match"&&Ne,Zt=n.useRef(new Map),Ut=n.useRef(new Map),D=n.useRef(new Map),g=n.useRef(new Map),ee=n.useMemo(()=>ue?ue.cardType==="vocab"?t.cogita.library.revision.vocabLabel:ue.infoType?lt(t,ue.infoType):t.cogita.library.revision.infoLabel:"",[t,ue]),B=n.useMemo(()=>{var ne;return Ze.id!=="levels"?f.length:((ne=Ke.pool)==null?void 0:ne.length)??Ze.getFetchLimit(ct,Tt)},[Ke,Tt,Ze,f.length,ct]),nt=Ze.getProgressTotal?Ze.getProgressTotal(f,Ke,ct,Tt):Ze.id==="levels"?Math.min(ct,B):f.length,gt=nt?Math.min(A+1,nt):0,ft=Math.max(1,Number(Tt.tries??1)),Rt=Tt.compare??"anchors",At=Math.max(0,Math.min(100,Number(Tt.minCorrectness??0))),Ct=(Tt.considerDependencies??"on")==="on",Pt=Math.max(0,Math.min(100,Number(Tt.dependencyThreshold??85))),ha=P=>{const ne=P.slice();for(let we=ne.length-1;we>0;we-=1){const Be=Math.floor(Math.random()*(we+1));[ne[we],ne[Be]]=[ne[Be],ne[we]]}return ne},ma=P=>xa(P,{treatSimilarCharsAsSame:!0})>=At,_t=async()=>{const P=await da(),ne=new Map,we=new Map;P.forEach(ke=>{const _e=`${ke.itemType}:${ke.itemId}`,Pe=ta(ke.itemType,ke.itemId,ke.checkType,ke.direction);ne.has(_e)||ne.set(_e,[]),ne.get(_e).push(ke),we.has(Pe)||we.set(Pe,[]),we.get(Pe).push(ke)});const Be=new Map,qe=new Map;return ne.forEach((ke,_e)=>Be.set(_e,ca(ke).score)),we.forEach((ke,_e)=>qe.set(_e,ca(ke).score)),{itemKnowness:Be,cardKnowness:qe}},sa=async P=>{const ne=Ke,we=P.concat(ne.active??[]).concat(ne.pool??[]).filter((y,M,z)=>z.findIndex(le=>Ie(le)===Ie(y))===M);if(!Ct){pt(new Set(we.map(Ie)));return}const{itemKnowness:Be,cardKnowness:qe}=await _t(),ke=y=>{if(y.cardType!=="info"||y.infoType!=="citation"||y.checkType!=="quote-fragment")return!0;const M=Qt(y.direction);if(!(M!=null&&M.fragmentId))return!0;const z=y.description??"";if(!z.trim())return!0;const me=va(z).nodes[M.fragmentId];if(!me||!me.leftId&&!me.rightId)return!0;const te=[me.leftId,me.rightId].filter(Te=>!!Te);if(te.length===0)return!0;const ve=te.map(Te=>{const Oe=ta("info",y.cardId,"quote-fragment",Te);return qe.get(Oe)??0});return ve.reduce((Te,Oe)=>Te+Oe,0)/ve.length>=Pt},_e=(p==null?void 0:p.collectionId)??null,Pe=_e?De.filter(y=>Lt(y.childItemType)==="collection"&&y.childItemId===_e&&!Lt(y.childCheckType)&&!Lt(y.childDirection)):[],Fe=_e&&we.length>0?we.reduce((y,M)=>y+(qe.get(Ie(M))??0),0)/we.length:0,et=new Set;for(const y of we){if(y.cardType!=="info"){et.add(Ie(y));continue}if(!ke(y))continue;const M=De.filter(me=>vr(me,y)).concat(Pe);if(M.length===0){et.add(Ie(y));continue}let z=0;for(const me of M)if(Lt(me.parentItemType)==="collection")z+=me.parentItemId===_e?Fe:0;else if(Lt(me.parentCheckType)||Lt(me.parentDirection)){const te=Lt(me.parentCheckType),ve=Lt(me.parentDirection),X=ta(me.parentItemType,me.parentItemId,te,ve);z+=qe.get(X)??0}else{const te=`${me.parentItemType}:${me.parentItemId}`;z+=Be.get(te)??0}z/M.length>=Pt&&et.add(Ie(y))}pt(et)},Sa=P=>{for(let ne=P;ne<f.length;ne+=1){const we=f[ne];if(we&&(!Ct||we.cardType!=="info"||it.has(Ie(we))))return ne}return-1},jt=P=>!Ct||P.cardType!=="info"||it.has(Ie(P)),Dt=P=>{if(Ze.id!=="temporal"&&Ze.id!=="levels")return null;const ne=Ke,we=(ne.active??[]).concat(ne.pool??[]),Be=new Set;for(const qe of we){const ke=Ie(qe);if(!(Be.has(ke)||P.has(ke))&&(Be.add(ke),jt(qe)))return qe}return null},ea=n.useMemo(()=>{if(Ze.id!=="levels")return null;const P=Ke,ne=P.pool??[],we=P.active??[],Be=P.levelMap??{},qe=Math.max(1,Number(Tt.levels??1)),ke=Array.from({length:qe},()=>0),_e=new Set(we.map(y=>Ie(y)));ne.forEach(y=>{const M=Math.min(qe,Math.max(1,Be[Ie(y)]??1));ke[M-1]+=1});const Pe=ne.length||1,Fe=ke.map(y=>y/Pe*100),et=ue?Be[Ie(ue)]??1:null;return{counts:ke,percentages:Fe,currentLevel:et,levelsCount:qe,activeCount:we.length,poolCount:ne.length,activeSet:_e}},[Ke,Tt,Ze,ue]),ja=n.useMemo(()=>{if(Ze.id!=="temporal")return null;const P=Ke,ne=P.pool??[],we=P.active??[],Be=P.knownessMap??{},qe=new Set(P.unknownSet??[]);let ke=0;ne.forEach(Fe=>{(Be[Ie(Fe)]??0)>1&&(ke+=1)});const _e=qe.size,Pe=we.map(Fe=>({id:Ie(Fe),value:qe.has(Ie(Fe))?0:Math.max(0,Math.min(1,Be[Ie(Fe)]??0))}));return{knownCount:ke,unknownCount:_e,dots:Pe}},[Ke,Ze]),Ga=n.useMemo(()=>{if(!Ct)return 0;const P=Ke;return f.concat(P.active??[]).concat(P.pool??[]).filter((we,Be,qe)=>qe.findIndex(ke=>Ie(ke)===Ie(we))===Be).filter(we=>we.cardType==="info"&&!it.has(Ie(we))).length},[Ct,Ke,f,it]);n.useEffect(()=>{if(!Ct||K!=="ready")return;const P=Ke,we=f.concat(P.active??[]).concat(P.pool??[]).filter((ke,_e,Pe)=>Pe.findIndex(Fe=>Ie(Fe)===Ie(ke))===_e).filter(ke=>ke.cardType!=="info"||it.has(Ie(ke))).length,Be=Se.current;if(Se.current=we,Be===null||we<=Be)return;const qe=we-Be;R(`New card available (+${qe})`),Z.current&&window.clearTimeout(Z.current),Z.current=window.setTimeout(()=>R(null),2200)},[Ct,K,Ke,f,it]),n.useEffect(()=>()=>{Z.current&&window.clearTimeout(Z.current)},[]);const Yt=(P,ne)=>{const we=Ze.applyOutcome({queue:f,meta:Ke},ue,ct,Tt,{correct:P,correctness:ne,createdUtc:new Date().toISOString()});J(we.queue),bt(we.meta);const Be=we.queue[A+1];Be&&qt(Be,A+1)};n.useEffect(()=>{if(!c){k("error");return}k("loading"),Qr({shareId:c,key:St}).then(P=>{l(P),N(P.collectionName),v(P.libraryName),k("ready")}).catch(()=>{k("error")})},[c,St]),n.useEffect(()=>{c&&Gr({shareId:c,key:St,type:"language"}).then(P=>w(P)).catch(()=>w([]))},[c,St]),n.useEffect(()=>{!c||d!=="ready"||Yr({shareId:c,key:St}).then(P=>mt(P.items??[])).catch(()=>mt([]))},[c,St,d]),n.useEffect(()=>{if(!c||d!=="ready")return;let P=!0;return(async()=>{S("loading"),_({current:0,total:Ze.id==="levels"?0:Ze.getFetchLimit(ct,Tt)});try{const we=[];let Be=null,qe=null;do{const M=await Xr({shareId:c,key:St,limit:300,cursor:Be});if(we.push(...M.items),(Ze.id==="levels"||Ze.id==="temporal")&&M.total&&(qe=M.total),_(z=>({current:we.length,total:z.total||M.total||Ze.getFetchLimit(ct,Tt)})),Be=M.nextCursor??null,qe!==null&&we.length>=qe||Ze.id!=="levels"&&Ze.id!=="temporal"&&we.length>=Ze.getFetchLimit(ct,Tt))break}while(Be);if(!P)return;const ke=qa(we);let _e;if(Ze.id==="levels"){const M=Math.max(1,Number(Tt.levels??1));_e={},ke.forEach(z=>{const le=Ie(z);_e[le]=Math.max(1,Math.min(M,1))})}let Pe=null,Fe=null,et=null;if(Ze.id==="temporal"){const M=await da(),z=new Set(ke.map(te=>Ie(te))),le=M.reduce((te,ve)=>{const X=ta(ve.itemType,ve.itemId,ve.checkType,ve.direction);return z.has(X)&&(te[X]||(te[X]=[]),te[X].push(ve)),te},{});Pe={},Fe=new Set,et={};const me=Date.now();ke.forEach(te=>{const ve=Ie(te),X=le[ve]??[];if(X.length===0){Pe[ve]=0,Fe.add(ve),et[ve]=[];return}const Te=is(X);et[ve]=Te;const Oe=jn(Te,me);Pe[ve]=Oe.knowness})}const y=Ze.id==="levels"?ls(ke,ct,Tt,_e):Ze.id==="temporal"?os(ke,ct,Tt,Pe??{},Fe??new Set,et??{}):Ze.prepare(ke,ct,Tt);J(y.queue),bt(y.meta),O(0),S("ready"),_(M=>({current:Math.min(M.current,M.total),total:M.total}))}catch{P&&S("error")}})(),()=>{P=!1}},[c,St,ct,Ze,Tt,d]),n.useEffect(()=>{sa(f)},[f,De,Ct,Pt,p==null?void 0:p.collectionId]),n.useEffect(()=>{if(!ue||!Ct){It(!1);return}if(ue.cardType!=="info"||it.has(Ie(ue))){It(!1);return}const P=Sa(A+1);if(P>=0){It(!1),O(P);return}if(Ze.id==="temporal"||Ze.id==="levels"){const ne=f.slice(0,A+1),we=f.slice(A+1).filter(jt),Be=ne.concat(we),qe=new Set(Be.map(Ie)),ke=Dt(qe);if(ke){const Pe=Ie(ke);qe.has(Pe)||(Be.push(ke),qe.add(Pe),bt(Fe=>{const et=Fe,y=new Set(et.queued??[]);return y.add(Pe),{...et,queued:y}}))}const _e=Be.findIndex((Pe,Fe)=>Fe!==A&&jt(Pe));if(_e>=0){J(Be),O(_e),It(!1);return}}It(!0)},[ue,it,Ct,A,f,Ke,Ze.id]),n.useEffect(()=>{if(Ce(""),ie(null),W(null),he(0),ae([]),se({}),Le({}),st(null),ye(null),Ee(null),I(!1),Ve(!1),pe(null),tt(null),rt({}),!ue){be(null),ce(null);return}ue.cardType==="info"&&ue.infoType==="computed"&&be(t.cogita.library.revision.loadingComputed);let P=!0;return qt(ue,A).then(ne=>{!P||!ne||(be(ne.prompt),ce(ne.expectedAnswer),ae(ne.computedExpected),se(ne.computedAnswers),st(ne.answerTemplate),ye(ne.outputVariables),Ee(ne.variableValues))}),()=>{P=!1}},[ue,c,t]),n.useEffect(()=>{if(!ue||ue.cardType!=="info"||ue.infoType!=="citation"){ut.current=null,yt.current=new Set,xe(null);return}const P=ue.description??"",ne=(ue.label??"").trim(),we=ne.replace(/\s+/g," ").trim(),Be=P.replace(/\s+/g," ").trim(),qe=we&&we!==Be?ne:t.cogita.library.infoTypes.citation;if(!P){xe(null),ce(null);return}const ke=va(P);ut.current=ke,be(qe);let _e=!0;return da().then(Pe=>{if(!_e)return;const Fe=new Map;Pe.forEach(le=>{if(le.itemType!=="info"||le.checkType!=="quote-fragment"||!le.direction)return;const me=Qt(le.direction);if(!me)return;const te=`${le.itemId}:${me.fragmentId}`;Fe.has(te)||Fe.set(te,[]),Fe.get(te).push(le)});const et={},y=new Set;Fe.forEach((le,me)=>{const[te,ve]=me.split(":",2);if(te!==ue.cardId)return;const X=ca(le).score;et[ve]=X,X>=Pt&&y.add(ve)}),yt.current=y,We.current=et;const M=Qt(ue.direction);if(M!=null&&M.fragmentId&&ke.nodes[M.fragmentId]){ia(ke,M.fragmentId,qe);return}const z=Ra(ke,y,et,Pt,Ct,ue.direction);ia(ke,(z==null?void 0:z.id)??null,qe)}).catch(()=>{yt.current=new Set,We.current={};const Pe=Qt(ue.direction);if(Pe!=null&&Pe.fragmentId&&ke.nodes[Pe.fragmentId]){ia(ke,Pe.fragmentId,qe);return}const Fe=Ra(ke,yt.current,{},Pt,Ct,ue.direction);ia(ke,(Fe==null?void 0:Fe.id)??null,qe)}),()=>{_e=!1}},[ue,t,Ct,Pt]),n.useEffect(()=>{if(!ue||ue.cardType!=="vocab"||ue.checkType!=="translation-match"){tt(null),rt({});return}const we=(Ke.pool??Ke.active??f).filter(Pe=>Pe.cardType==="vocab"&&Pe.checkType==="translation-match").filter((Pe,Fe,et)=>et.findIndex(y=>y.cardId===Pe.cardId)===Fe);we.some(Pe=>Pe.cardId===ue.cardId)||we.unshift(ue);const qe=ha(we).slice(0,6).map(Pe=>{const Fe=Pe.label.split("↔").map(M=>M.trim()).filter(Boolean);if(Fe.length<2)return null;const et=`${Pe.cardId}:L`,y=`${Pe.cardId}:R`;return{cardId:Pe.cardId,leftId:et,rightId:y,leftLabel:Fe[0],rightLabel:Fe[1]}}).filter(Boolean),ke=qe.map(Pe=>Pe.leftId),_e=ha(qe.map(Pe=>Pe.rightId));tt({pairs:qe,leftOrder:ke,rightOrder:_e,selection:{},activeLeft:null,activeRight:null,locked:{}})},[ue,f,Ke]),n.useEffect(()=>()=>{Ue.current&&window.clearTimeout(Ue.current),E.current&&window.clearTimeout(E.current)},[]);const Ta=n.useRef(null);n.useEffect(()=>{if(!ue)return;const P=Ie(ue),ne=typeof document<"u"?document.activeElement:null;if(Ta.current===P&&ne&&(ne.tagName==="INPUT"||ne.tagName==="TEXTAREA"))return;let we=0;const Be=()=>{if(ue){if(ue.cardType==="info"&&ue.infoType==="computed"){if(oe.length>0){const ke=pn(He,oe,V),_e=ke?$e.current[ke]:null;if(_e&&(_e.focus(),document.activeElement===_e)){Ta.current=P;return}}if(ge.current&&(ge.current.focus(),document.activeElement===ge.current)){Ta.current=P;return}}else if(ue.cardType==="vocab"&&ge.current&&(ge.current.focus(),document.activeElement===ge.current)){Ta.current=P;return}we<6&&(we+=1,window.setTimeout(Be,40))}},qe=window.setTimeout(Be,40);return()=>window.clearTimeout(qe)},[ue,oe,He,V]),n.useEffect(()=>{if(!Ge)return;const P=ne=>{ne.key==="Enter"&&(ne.preventDefault(),Jt())};return window.addEventListener("keydown",P),()=>window.removeEventListener("keydown",P)},[Ge]);const Ca=P=>{fe(P),F(ca(P))};n.useEffect(()=>{if(!ue){F(null),fe([]);return}const P=ue.cardType==="info"?"info":"connection";if(ue.cardType==="info"&&ue.infoType==="citation"){da().then(ne=>{const we=ne.filter(Be=>Be.itemType==="info"&&Be.itemId===ue.cardId&&Be.checkType==="quote-fragment"&&gn(Be.direction,ue.direction));Ca(we)}).catch(()=>{F(null),fe([])});return}hn(P,ue.cardId,ue.checkType,ue.direction).then(ne=>Ca(ne)).catch(()=>{F(null),fe([])})},[ue]);const Fa=(P,ne,we,Be)=>{if(P==="info"&&we==="quote-fragment"){da().then(qe=>{const ke=qe.filter(_e=>_e.itemType==="info"&&_e.itemId===ne&&_e.checkType==="quote-fragment"&&gn(_e.direction,Be));Ca(ke)}).catch(()=>{F(null),fe([])});return}hn(P,ne,we,Be).then(qe=>Ca(qe)).catch(()=>{F(null),fe([])})},Ya=(P,ne,we)=>{var _e;const Be=((_e=we.pairs.find(Pe=>Pe.leftId===P))==null?void 0:_e.rightId)??null;if(!Be)return we;const qe=Be===ne;rt(Pe=>({...Pe,[P]:qe?"correct":"incorrect"})),Ue.current&&window.clearTimeout(Ue.current),E.current&&window.clearTimeout(E.current),Ae.current+=1;const ke={kind:qe?"correct":"incorrect",tick:Ae.current};if(at(null),Ue.current=window.setTimeout(()=>at(ke),0),E.current=window.setTimeout(()=>at(null),420),qe){const Pe={...we.locked,[P]:!0};return Object.keys(Pe).length>=we.pairs.length?(ie("correct"),Ve(!0)):ie("correct"),{...we,selection:{...we.selection,[P]:ne},activeLeft:null,activeRight:null,locked:Pe}}return ie("incorrect"),{...we,activeLeft:null,activeRight:null}},Ka=P=>{tt(ne=>!ne||ne.locked[P]?ne:ne.activeRight?Ya(P,ne.activeRight,ne):{...ne,activeLeft:ne.activeLeft===P?null:P})},Nn=P=>{tt(ne=>ne&&(ne.activeLeft?Ya(ne.activeLeft,P,ne):{...ne,activeRight:ne.activeRight===P?null:P}))},Jt=()=>{var P;if(ue&&ue.cardType==="info"&&ue.infoType==="citation"&&ut.current&&Q&&!((P=Qt(ue.direction))!=null&&P.fragmentId)){const ne=Ra(ut.current,yt.current,We.current,Pt,Ct,ue.direction,Q.fragmentId);if(ne){ie(null),Ce(""),I(!1),Le({}),Ve(!1),W(null),he(0),ia(ut.current,ne.id,Q.title);return}}ie(null),Ce(""),I(!1),Le({}),Ve(!1),W(null),he(0),O(ne=>Math.min(ne+1,f.length))},Ht=P=>{if(!ue)return;const ne=P.expected??null,we=P.answer??"";let Be=ne??"",qe=we;if(!ne&&P.expectedMap&&P.answerMap){const M=Object.keys(P.expectedMap).sort((z,le)=>z.localeCompare(le));Be=M.map(z=>{var le;return((le=P.expectedMap)==null?void 0:le[z])??""}).join("|"),qe=M.map(z=>{var le;return((le=P.answerMap)==null?void 0:le[z])??""}).join("|")}const ke=Be?$a(Be,qe,Rt):new Uint8Array,_e={revisionType:Ze.id,evalType:P.evalType,direction:P.direction,prompt:$??"",expected:ne,answer:we,expectedAnswers:P.expectedMap??null,answers:P.answerMap??null,correct:P.correct,maskBase64:ke.length?ya(ke):null,checkMode:Kt,compareMode:Rt,minCorrectness:At},Pe=new TextEncoder().encode(JSON.stringify(_e)),Fe=ue.cardType==="info"?"info":"connection",et=P.overrideCheckType??ue.checkType??null,y=P.overrideDirection??ue.direction??null;un({itemType:Fe,itemId:ue.cardId,checkType:et,direction:y,revisionType:Ze.id,evalType:P.evalType,correct:P.correct,maskBase64:ke.length?ya(ke):null,payloadBase64:ya(Pe)}).then(()=>{Fa(Fe,ue.cardId,et,y),sa(f)}).catch(()=>{})},Sn=(P,ne)=>{const we=Zt.current.get(ne);if(we)return Promise.resolve(we);const Be=Ut.current.get(ne);if(Be)return Be;const qe=ps({shareCode:c,infoId:P,key:St}).then(ke=>{var M,z;const _e=ke.payload,Pe=((M=_e.definition)==null?void 0:M.graph)??null,Fe="",et=((z=_e.definition)==null?void 0:z.answerTemplate)??"",y=pr(Pe,Fe,et);if(y){const me={sample:fr(y),answerTemplate:et||null};return Zt.current.set(ne,me),me}return fs({shareId:c,infoId:P,key:St}).then(le=>{const me={sample:le,answerTemplate:null};return Zt.current.set(ne,me),me})}).catch(()=>fs({shareId:c,infoId:P,key:St}).then(ke=>{const _e={sample:ke,answerTemplate:null};return Zt.current.set(ne,_e),_e}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{Ut.current.delete(ne)});return Ut.current.set(ne,qe),qe},qt=(P,ne)=>{var Pe;const we=`${Ie(P)}:${ne}`,Be=D.current.get(we);if(Be)return Promise.resolve(Be);const qe=g.current.get(we);if(qe)return qe;const ke=Fe=>(D.current.set(we,Fe),Fe);let _e;if(P.cardType==="vocab"){if(P.checkType==="translation-match")return _e=Promise.resolve(ke({prompt:P.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),_e;const Fe=P.label.split("↔").map(et=>et.trim()).filter(Boolean);if(Fe.length>=2){const y=(P.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",M=y?Fe[0]:Fe[1],z=y?Fe[1]:Fe[0];_e=Promise.resolve(ke({prompt:M,expectedAnswer:z,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else _e=Promise.resolve(ke({prompt:P.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(P.cardType==="info"&&P.infoType==="word"){const Fe=(Pe=P.description)!=null&&Pe.startsWith("Language: ")?P.description.replace("Language: ",""):null;_e=Promise.resolve(ke({prompt:P.label,expectedAnswer:Fe,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else P.cardType==="info"&&P.infoType==="question"?_e=ps({shareCode:c,infoId:P.cardId,key:St}).then(Fe=>{const et=Fe.payload??{},y=et.definition??et??{},M=rs(y.type??y.kind),z=(typeof y.question=="string"&&y.question.trim()?y.question.trim():null)??(typeof y.title=="string"&&y.title.trim()?y.title.trim():null)??P.label,le=y.answer;return ke(M==="text"||M==="number"||M==="date"?{prompt:z,expectedAnswer:typeof le=="string"||typeof le=="number"?String(le):null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}:{prompt:z,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})}).catch(()=>ke({prompt:P.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{g.current.delete(we)}):P.cardType==="info"&&P.infoType==="computed"?_e=Sn(P.cardId,we).then(Fe=>{var le,me;if(!Fe.sample)return ke({prompt:P.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const et=Fe.sample,y=et.expectedAnswers?Object.entries(et.expectedAnswers).map(([te,ve])=>({key:te,expected:ve})):[],M=y.reduce((te,ve)=>(te[ve.key]="",te),{}),z=et.expectedAnswerIsSentence&&((le=et.expectedAnswer)==null?void 0:le.trim())||null;return ke({prompt:et.prompt,expectedAnswer:y.length>0?z:((me=et.expectedAnswer)==null?void 0:me.trim())||null,computedExpected:y,computedAnswers:M,answerTemplate:Fe.answerTemplate,outputVariables:et.outputVariables??null,variableValues:et.variableValues??null})}).catch(()=>ke({prompt:P.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{g.current.delete(we)}):_e=Promise.resolve(ke({prompt:P.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return g.current.set(we,_e),_e},ia=(P,ne,we)=>{const Be=Object.keys(P.nodes).length,qe=yt.current.size;if(!ne){xe({title:we,before:P.text,after:"",fragmentId:null,total:Be,completed:qe}),ce(null),Ve(!0);return}const ke=P.nodes[ne];if(!ke)return;const _e=vn(P.text,ke);xe({title:we,before:_e.before,after:_e.after,fragmentId:ke.id,total:Be,completed:qe}),ce(_e.fragment),Ve(!1)},Ia=()=>{const P=ut.current;P&&xe(ne=>ne&&{...ne,total:Object.keys(P.nodes).length,completed:yt.current.size})},wa=()=>{const P=f[A+1];P&&qt(P,A+1)},_a=()=>{if(wa(),ue&&ue.cardType==="vocab"&&ue.checkType==="translation-match"&&Ne){if(Ne.pairs.length===0){ie("incorrect"),Ve(!0);return}const ke=Ne.pairs.reduce((z,le)=>(z[le.rightId]=le.rightLabel,z),{});let _e=0;const Pe={};Ne.pairs.forEach(z=>{const me=Ne.selection[z.leftId]===z.rightId;Pe[z.leftId]=me?"correct":"incorrect",me&&(_e+=1)});const Fe=Ne.pairs.length||1,et=_e/Fe,y=_e===Ne.pairs.length;rt(z=>({...z,...Pe})),y?(ie("correct"),Ve(!0),he(0)):(ie("incorrect"),Ve(!1),he(z=>{const le=z+1;return le>=ft&&(I(!0),Ve(!0),tt(me=>{if(!me)return me;const te=me.pairs.reduce((ve,X)=>(ve[X.leftId]=X.rightId,ve),{});return{...me,selection:te}})),le})),Yt(y,et);const M="connection";Promise.all(Ne.pairs.map(z=>{const le=Ne.selection[z.leftId]??null,me=le?ke[le]:"",te={left:z.leftLabel,expected:z.rightLabel,answer:me,checkType:"translation-match"},ve=new TextEncoder().encode(JSON.stringify(te));return un({itemType:M,itemId:z.cardId,checkType:"translation-match",direction:null,revisionType:Ze.id,evalType:"translation-match",correct:le===z.rightId,maskBase64:null,payloadBase64:ya(ve)})})).then(()=>{Fa(M,ue.cardId,ue.checkType,ue.direction),sa(f)}).catch(()=>{});return}if(oe.length>0){const ke=oe.reduce((Pe,Fe)=>{const et=Me[Fe.key]??"";return Pe[Fe.key]=zt(et)===zt(Fe.expected)?"correct":"incorrect",Pe},{});oe.every(({key:Pe,expected:Fe})=>{const et=Me[Pe]??"";return Kt==="exact"&&zt(et)===zt(Fe)})?(ie("correct"),Le(ke),Ve(!0),he(0),Yt(!0,1),Ht({correct:!0,direction:$?`${$} -> computed`:"computed",expectedMap:oe.reduce((Pe,Fe)=>(Pe[Fe.key]=Fe.expected,Pe),{}),answerMap:Me,evalType:"computed"})):(ie("incorrect"),Le(ke),Ve(!1),he(Pe=>{const Fe=Pe+1;return Fe>=ft&&ga&&(I(!0),Ve(!0)),Fe}),Yt(!1,0),window.setTimeout(()=>{var Fe;const Pe=pn(He,oe,V);Pe&&$e.current[Pe]&&((Fe=$e.current[Pe])==null||Fe.focus())},40),Ht({correct:!1,direction:$?`${$} -> computed`:"computed",expectedMap:oe.reduce((Pe,Fe)=>(Pe[Fe.key]=Fe.expected,Pe),{}),answerMap:Me,evalType:"computed"}));return}if(ue&&ue.cardType==="info"&&ue.infoType==="citation"&&(Q!=null&&Q.fragmentId)){if(!U)return;const ke=Qt(ue.direction),_e=(ke==null?void 0:ke.fragmentId)??Q.fragmentId,Pe=Ja(U,de,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Fe=Pe.mask,et=Pe.isCorrect,y=Pe.percent;et?(We.current[Q.fragmentId]=Math.max(We.current[Q.fragmentId]??0,y),(We.current[Q.fragmentId]??0)>=Pt&&yt.current.add(Q.fragmentId),Ia(),ie("correct"),Le({}),Ve(!0),W(Fe),he(0),y<100&&ft<=1&&I(!0),Yt(!0,y/100),Ht({correct:!0,direction:`quote:${Q.fragmentId}`,expected:U,answer:de,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:_e})):(ie("incorrect"),Le({}),Ve(!1),W(Fe),he(M=>{const z=M+1;return z>=ft&&ga&&(I(!0),Ve(!0)),z}),Yt(!1,y/100),window.setTimeout(()=>{var M;return(M=ge.current)==null?void 0:M.focus()},40),Ht({correct:!1,direction:`quote:${Q.fragmentId}`,expected:U,answer:de,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:_e}));return}if(!U)return;const P=$a(U,de,Rt),ne=Kt==="exact"&&zt(de)===zt(U),we=ma(P),Be=ne||we,qe=xa(P);Be?(ie("correct"),Le({}),Ve(!0),W(P),he(0),qe<100&&ft<=1&&I(!0),Yt(!0,qe/100),Ht({correct:!0,direction:$?`${$} -> ${U}`:null,expected:U,answer:de,evalType:"text"})):(ie("incorrect"),Le({}),Ve(!1),W(P),he(ke=>{const _e=ke+1;return _e>=ft&&ga&&(I(!0),Ve(!0)),_e}),Yt(!1,qe/100),window.setTimeout(()=>{var ke;return(ke=ge.current)==null?void 0:ke.focus()},40),Ht({correct:!1,direction:$?`${$} -> ${U}`:null,expected:U,answer:de,evalType:"text"}))},Tn=P=>{if(wa(),!U)return;const ne=$a(U,P,Rt),we=zt(P)===zt(U),Be=ma(ne),qe=we||Be,ke=xa(ne);qe?(ie("correct"),Le({}),Ve(!0),W(ne),he(0),ke<100&&ft<=1&&I(!0),Yt(!0,ke/100),Ht({correct:!0,direction:"word->language",expected:U,answer:P,evalType:"language-select"})):(ie("incorrect"),Le({}),Ve(!1),W(ne),he(_e=>{const Pe=_e+1;return Pe>=ft&&ga&&(I(!0),Ve(!0)),Pe}),Yt(!1,ke/100),Ht({correct:!1,direction:"word->language",expected:U,answer:P,evalType:"language-select"}))},Cn=P=>{var we;if(P.key!=="Enter")return;if(P.preventDefault(),P.stopPropagation(),Ge){Jt();return}const ne=oe.find(Be=>!(Me[Be.key]??"").trim());if(ne){(we=$e.current[ne.key])==null||we.focus();return}_a()},Ma=()=>{wa(),ie("correct"),Ve(!0),he(0),Yt(!0,1),U&&Ht({correct:!0,direction:"manual",expected:U,answer:de,evalType:"manual"})},ra=()=>{if(Yt(!1,0),ue&&ue.cardType==="info"&&ue.infoType==="citation"){ie(null),Ce(""),I(!1),Le({}),Ve(!1),W(null),he(0),O(P=>Math.min(P+1,f.length));return}Jt()};n.useEffect(()=>{wa()},[A,f]);const In=t.cogita.library.revision.revealModeAfterIncorrect,ga=oe.length>0||!!U;return e.jsxs($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:h,onLanguageChange:b,children:[(d==="loading"||K==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:d==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${G.total?Math.min(100,Math.max(0,G.current/G.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:G.total?`${Math.min(G.current,G.total)} / ${G.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:m}),e.jsx("p",{className:"cogita-library-subtitle",children:C}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",Gt).replace("{check}",Ot)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:x?`${x.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[ea?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",ea.currentLevel??"-"," / ",ea.levelsCount]}):null,x?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(x.correct)).replace("{total}",String(x.total))}),x.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(x.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(br,{outcomes:H})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[q?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:q})}):null,e.jsx(Ea,{feedbackToken:ze?`${ze.kind}-${ze.tick}`:Et?"idle":Je?`${Je}-${A}-${je}`:"idle",children:d!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:d==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):ue?e.jsx(e.Fragment,{children:Bt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(ss,{copy:t,currentCard:ue,currentTypeLabel:ee,prompt:$,languages:L,answer:de,onAnswerChange:P=>Ce(ne=>mn(ne,P,Y)),computedExpected:oe,computedAnswers:Me,onComputedAnswerChange:(P,ne)=>se(we=>({...we,[P]:mn(we[P]??"",ne,Y)})),answerTemplate:He,outputVariables:V,variableValues:Qe,computedFieldFeedback:Re,feedback:Je,canAdvance:Ge,quoteContext:Q,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:_a,onSkip:ra,onLanguageSelect:Tn,onMarkReviewed:Ma,onAdvance:Jt,showCorrectAnswer:T,setShowCorrectAnswer:I,onRevealCorrect:()=>Ve(!0),answerMask:re,expectedAnswer:U,hasExpectedAnswer:ga,handleComputedKeyDown:Cn,answerInputRef:ge,computedInputRefs:$e,scriptMode:Y,setScriptMode:pe,matchPairs:Ne==null?void 0:Ne.pairs,matchLeftOrder:Ne==null?void 0:Ne.leftOrder,matchRightOrder:Ne==null?void 0:Ne.rightOrder,matchSelection:Ne==null?void 0:Ne.selection,matchActiveLeft:Ne==null?void 0:Ne.activeLeft,matchActiveRight:Ne==null?void 0:Ne.activeRight,matchFeedback:vt,onMatchLeftSelect:Ka,onMatchRightSelect:Nn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:nt?`${gt} / ${nt}`:t.cogita.library.revision.progressUnlimited}),d==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),d==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),d==="ready"&&K==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),d==="ready"&&K==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),d==="ready"&&K==="ready"&&f.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:In}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",ft]})]})]}),ea?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",ea.activeCount," / ",ea.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:ea.counts.map((P,ne)=>{const we=ne+1,Be=ea.currentLevel===we,qe=ea.percentages[ne]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":Be,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:we}),e.jsx("strong",{children:P})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,qe))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[qe.toFixed(1),"%"]})]},`level-${we}`)})})]}):null,ja?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:ja.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:ja.dots.map(P=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-P.value))}, ${Math.round(200*P.value)}, 80, 0.9)`}},P.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:ja.knownCount})]})]}):null,Ct?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Ga})]})}):null]})]})]})})})]})]})}const Wo=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:Ao},Symbol.toStringTag,{value:"Module"})),Ro={answerLabel:"Answer",correctAnswerLabel:"Correct answer",trueLabel:"True",falseLabel:"False",fragmentLabel:"Fragment",correctFragmentLabel:"Correct fragment",participantAnswerPlaceholder:"",unsupportedPromptType:"Unsupported prompt type",waitingForReveal:"Waiting for reveal.",selectedPaths:"Selected paths",removePath:"Remove",columnPrefix:"Column"};function ds({prompt:t,revealExpected:a,mode:s,labels:r,answers:i,onTextChange:u,onSelectionToggle:o,onBooleanChange:j,onOrderingMove:h,onMatchingPick:b,onMatchingRemovePath:c}){var v;if(!t)return null;const p={...Ro,...r??{}},l=typeof a<"u",d=String(t.kind??""),k=Array.isArray(a)?a.map(f=>Number(f)).filter(Number.isFinite):[],m=(f,J,L)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:l?p.correctAnswerLabel:p.answerLabel}),e.jsx("input",{type:f==="number"?"number":f==="date"?"date":"text",value:J??"",onChange:w=>L==null?void 0:L(w.target.value),readOnly:s==="readonly"||l,placeholder:p.participantAnswerPlaceholder})]}),N=(f,J)=>J.map((L,w)=>{const K=Array.isArray(f[w])?f[w]:[];return`${w>0?" -> ":""}${String(K[L]??L)}`}).join(""),C=f=>e.jsx("div",{className:"cogita-live-card-surface","data-state":l?"correct":"idle",children:f});if(d==="citation-fragment")return C(e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("span",{style:{opacity:.7},children:String(t.before??"")}),e.jsx("strong",{children:" [ ... ] "}),e.jsx("span",{style:{opacity:.7},children:String(t.after??"")})]}),m("text",l?String(a??""):(i==null?void 0:i.text)??"",u)]}));if(d==="text")return C(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),m(String(t.inputType??"text"),l?String(a??""):(i==null?void 0:i.text)??"",u)]}));if(d==="boolean"){const f=!!a,J=i==null?void 0:i.booleanAnswer;return C(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:`cta ghost ${l&&f?"live-correct-answer":""}`,"data-active":!l&&J===!0?"true":void 0,onClick:()=>j==null?void 0:j(!0),disabled:s==="readonly"||l,children:p.trueLabel}),e.jsx("button",{type:"button",className:`cta ghost ${l&&!f?"live-correct-answer":""}`,"data-active":!l&&J===!1?"true":void 0,onClick:()=>j==null?void 0:j(!1),disabled:s==="readonly"||l,children:p.falseLabel})]})]}))}if(d==="selection"){const f=Array.isArray(t.options)?t.options:[],J=!!t.multiple,L=(i==null?void 0:i.selection)??[];return C(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:f.map((w,K)=>e.jsxs("label",{className:"cogita-share-row","data-state":l&&k.includes(K)?"correct":void 0,children:[e.jsx("span",{children:w}),e.jsx("input",{type:J?"checkbox":"radio",name:"live-selection",checked:l?k.includes(K):L.includes(K),onChange:()=>o==null?void 0:o(K),disabled:s==="readonly"||l})]},`${K}-${w}`))})]}))}if(d==="ordering"){const f=Array.isArray(l?a:i==null?void 0:i.ordering)?(l?a:(i==null?void 0:i.ordering)??[]).map(String):[];return C(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:f.map((J,L)=>e.jsxs("div",{className:"cogita-share-row","data-state":l?"correct":void 0,children:[e.jsx("span",{children:J}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>h==null?void 0:h(L,-1),disabled:s==="readonly"||l,children:"↑"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>h==null?void 0:h(L,1),disabled:s==="readonly"||l,children:"↓"})]})]},`${L}-${J}`))})]}))}if(d==="matching"){const f=Array.isArray(t.columns)?t.columns:[],J=(a==null?void 0:a.paths)??[],L=Math.max(2,f.length),w=Array.from({length:L},(K,S)=>(i==null?void 0:i.matchingSelection[S])??null);return C(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),e.jsx("div",{style:{display:"grid",gap:"0.65rem",gridTemplateColumns:`repeat(${L}, minmax(0, 1fr))`,alignItems:"start"},children:f.map((K,S)=>e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.35rem",padding:"0.6rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:`${p.columnPrefix} ${S+1}`}),K.map((G,_)=>e.jsxs("button",{type:"button",className:"ghost cogita-checkcard-row",style:{textAlign:"left"},"data-active":!l&&w[S]===_?"true":void 0,onClick:()=>b==null?void 0:b(S,_),disabled:s==="readonly"||l,children:[e.jsx("span",{children:G}),e.jsx("small",{children:_})]},`live-col:${S}:${_}`))]},`live-col:${S}`))}),e.jsxs("div",{style:{display:"grid",gap:"0.4rem",marginTop:"0.65rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:p.selectedPaths}),l?e.jsx("div",{className:"cogita-share-list",children:J.map((K,S)=>e.jsx("div",{className:"cogita-share-row","data-state":"correct",children:e.jsx("span",{children:N(f,K)})},`path-${S}`))}):(((v=i==null?void 0:i.matchingRows)==null?void 0:v.length)??0)>0?e.jsx("div",{className:"cogita-share-list",children:((i==null?void 0:i.matchingRows)??[]).map((K,S)=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("span",{children:N(f,K)}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>c==null?void 0:c(S),disabled:s==="readonly",children:p.removePath})]},`path-${S}`))}):e.jsx("p",{className:"cogita-library-hint",children:p.waitingForReveal})]})]}))}return e.jsx("p",{className:"cogita-help",children:p.unsupportedPromptType})}const $o=t=>Array.from(new Set(t.map(a=>Number(a)).filter(Number.isFinite))).sort((a,s)=>a-s);function Po(t){const a=[...t];for(let s=a.length-1;s>0;s-=1){const r=Math.floor(Math.random()*(s+1));[a[s],a[r]]=[a[r],a[s]]}return a}function Ws(t){const a=t.map((i,u)=>({value:i,oldIndex:u}));for(let i=a.length-1;i>0;i-=1){const u=Math.floor(Math.random()*(i+1));[a[i],a[u]]=[a[u],a[i]]}const s=a.map(i=>i.value),r=new Map;return a.forEach((i,u)=>r.set(i.oldIndex,u)),{values:s,oldToNew:r}}function Eo(t){const a=t.split("↔").map(s=>s.trim()).filter(Boolean);return a.length>=2?[a[0],a[1]]:null}function Fo(t){if(!t)return null;const a=t.indexOf(":");return a>=0?t.slice(a+1).trim():t.trim()}function Ko(t,a,s,r){const i=typeof s.title=="string"&&s.title.trim()?s.title.trim():a,u=typeof s.question=="string"?s.question:a,o=s.type;if(!u)return null;if(o==="selection"){const j=Array.isArray(s.options)?s.options.filter(l=>typeof l=="string"):[],h=Array.isArray(s.answer)?$o(s.answer):[],b=h.length!==1,c=Ws(j),p=h.map(l=>c.oldToNew.get(l)).filter(l=>Number.isInteger(l)).sort((l,d)=>l-d);return{roundIndex:r,cardKey:`info:${t}:question-selection`,publicPrompt:{kind:"selection",title:i,prompt:u,options:c.values,multiple:b,cardLabel:"question"},reveal:{kind:"selection",expected:p,title:i},grade:l=>aa({prompt:{kind:"selection",options:c.values},expected:p,answer:{selection:Array.isArray(l)?l:[]}}).correct}}if(o==="truefalse"){const j=!!s.answer;return{roundIndex:r,cardKey:`info:${t}:question-truefalse`,publicPrompt:{kind:"boolean",title:i,prompt:u,cardLabel:"question"},reveal:{kind:"boolean",expected:j,title:i},grade:h=>aa({prompt:{kind:"boolean"},expected:j,answer:{booleanAnswer:h==null?null:!!h}}).correct}}if(o==="text"||o==="number"||o==="date"){const j=String(s.answer??"");return{roundIndex:r,cardKey:`info:${t}:question-${o}`,publicPrompt:{kind:"text",title:i,prompt:u,inputType:o==="number"?"number":o==="date"?"date":"text",cardLabel:"question"},reveal:{kind:"text",expected:j,title:i},grade:h=>aa({prompt:{kind:"text",inputType:o==="number"?"number":o==="date"?"date":"text"},expected:j,answer:{text:String(h??"")}}).correct}}if(o==="ordering"){const j=Array.isArray(s.options)?s.options.filter(b=>typeof b=="string"):[],h=Po(j);return{roundIndex:r,cardKey:`info:${t}:question-ordering`,publicPrompt:{kind:"ordering",title:i,prompt:u,options:h,cardLabel:"question"},reveal:{kind:"ordering",expected:j,title:i},grade:b=>aa({prompt:{kind:"ordering",options:j},expected:j,answer:{ordering:Array.isArray(b)?b.map(String):[]}}).correct}}if(o==="matching"){const h=(Array.isArray(s.columns)?s.columns.map(l=>Array.isArray(l)?l.filter(d=>typeof d=="string"):[]):[]).map(l=>Ws(l)),b=s.answer??{},p=(Array.isArray(b.paths)?b.paths.map(l=>Array.isArray(l)?l.map(d=>Number(d)).filter(Number.isFinite):null).filter(l=>Array.isArray(l)):[]).map(l=>l.map((d,k)=>{var m;return((m=h[k])==null?void 0:m.oldToNew.get(d))??d}));return{roundIndex:r,cardKey:`info:${t}:question-matching`,publicPrompt:{kind:"matching",title:i,prompt:u,columns:h.map(l=>l.values),cardLabel:"question"},reveal:{kind:"matching",expected:{paths:p},title:i},grade:l=>{const d=l??{},k=Array.isArray(d.paths)?d.paths.map(m=>Array.isArray(m)?m.map(N=>Number(N)).filter(Number.isFinite):null).filter(m=>Array.isArray(m)):[];return aa({prompt:{kind:"matching",columns:h.map(m=>m.values)},expected:{paths:p},answer:{matchingPaths:k}}).correct}}}return null}async function _o(t){var p,l;const a=await ns({libraryId:t.libraryId,revisionId:t.revisionId}),r=(await Ua({libraryId:t.libraryId,collectionId:a.collectionId,limit:1e3})).items,i=Array.from(new Set(r.filter(d=>d.cardType==="info").map(d=>d.cardId))),u=new Map;await Promise.all(i.map(async d=>{try{const k=await na({libraryId:t.libraryId,infoId:d});u.set(d,{infoType:k.infoType,payload:k.payload})}catch{}}));const o=new Map;await Promise.all(Array.from(u.entries()).filter(([,d])=>d.infoType==="computed").map(async([d])=>{try{const k=await Hn({libraryId:t.libraryId,infoId:d});o.set(d,k)}catch{}}));const j=Array.from(new Set(r.filter(d=>d.cardType==="vocab").map(d=>d.label))).filter(Boolean),h={selectMatchingPairPrompt:((p=t.labels)==null?void 0:p.selectMatchingPairPrompt)??"Select the matching pair",wordLanguagePromptPrefix:((l=t.labels)==null?void 0:l.wordLanguagePromptPrefix)??"Language of"},b=[],c=new Set;for(const d of r){if(d.cardType==="vocab"){const m=Eo(d.label);if(!m)continue;if(d.checkType==="translation"&&d.direction==="a-to-b"){const[N,C]=m;b.push({roundIndex:b.length,cardKey:`connection:${d.cardId}:translation:a-to-b`,publicPrompt:{kind:"text",title:d.label,prompt:N,cardLabel:d.description??void 0},reveal:{kind:"text",expected:C,title:d.label},grade:v=>aa({prompt:{kind:"text",inputType:"text"},expected:C,answer:{text:String(v??"")}}).correct})}else if(d.checkType==="translation"&&d.direction==="b-to-a"){const[N,C]=m;b.push({roundIndex:b.length,cardKey:`connection:${d.cardId}:translation:b-to-a`,publicPrompt:{kind:"text",title:d.label,prompt:C,cardLabel:d.description??void 0},reveal:{kind:"text",expected:N,title:d.label},grade:v=>aa({prompt:{kind:"text",inputType:"text"},expected:N,answer:{text:String(v??"")}}).correct})}else if(d.checkType==="translation-match"){const N=Array.from(new Set([d.label,...j.filter(v=>v!==d.label).slice(0,3)])),C=N.findIndex(v=>v===d.label);b.push({roundIndex:b.length,cardKey:`connection:${d.cardId}:translation-match`,publicPrompt:{kind:"selection",title:d.label,prompt:h.selectMatchingPairPrompt,options:N,multiple:!1,cardLabel:d.description??void 0},reveal:{kind:"selection",expected:[C],title:d.label},grade:v=>aa({prompt:{kind:"selection",options:N},expected:[C],answer:{selection:Array.isArray(v)?v.map(f=>Number(f)).filter(Number.isFinite):[Number(v)].filter(Number.isFinite)}}).correct})}continue}if(d.cardType!=="info")continue;const k=u.get(d.cardId);if(k){if(k.infoType==="word"&&d.checkType==="word-language"){const m=Fo(d.description);if(!m)continue;b.push({roundIndex:b.length,cardKey:`info:${d.cardId}:word-language:${d.direction??""}`,publicPrompt:{kind:"text",title:d.label,prompt:`${h.wordLanguagePromptPrefix}: ${d.label}`,cardLabel:"word-language"},reveal:{kind:"text",expected:m,title:d.label},grade:N=>aa({prompt:{kind:"text",inputType:"text"},expected:m,answer:{text:String(N??"")}}).correct});continue}if(k.infoType==="computed"&&d.checkType==="computed"){const m=o.get(d.cardId);if(!m)continue;b.push({roundIndex:b.length,cardKey:`info:${d.cardId}:computed`,publicPrompt:{kind:"text",title:d.label,prompt:m.prompt,multiLine:!1,cardLabel:"computed"},reveal:{kind:"text",expected:m.expectedAnswer,title:d.label},grade:N=>aa({prompt:{kind:"text",inputType:"text"},expected:m.expectedAnswer,answer:{text:String(N??"")}}).correct});continue}if(k.infoType==="question"){const m=ur(k.payload),N=m?Ko(d.cardId,d.label,m,b.length):null;N&&(N.roundIndex=b.length,b.push(N));continue}if(k.infoType==="citation"&&!c.has(d.cardId)){c.add(d.cardId);const m=k.payload,N=typeof m.text=="string"?m.text:"",C=typeof m.title=="string"&&m.title.trim()?m.title.trim():d.label;if(!N.trim())continue;const v=va(N,{minLen:7,maxLen:13});for(const f of v.order){const J=v.nodes[f];if(!J)continue;const L=vn(N,J);b.push({roundIndex:b.length,cardKey:`info:${d.cardId}:quote-fragment:${f}`,publicPrompt:{kind:"citation-fragment",title:C,before:L.before,after:L.after,fragmentId:f,cardLabel:"quote-fragment"},reveal:{kind:"citation-fragment",expected:L.fragment,title:C},grade:w=>aa({prompt:{kind:"citation-fragment"},expected:L.fragment,answer:{text:String(w??"")}}).correct})}continue}}}return b.map((d,k)=>({...d,roundIndex:k}))}function Do(t){var st;const{libraryId:a,revisionId:s}=t,r=Pa(),i=t.copy.cogita.library.revision,u=i.live,[o,j]=n.useState(null),[h,b]=n.useState([]),[c,p]=n.useState("loading"),[l,d]=n.useState(null),[k,m]=n.useState("simultaneous"),[N,C]=n.useState("panel"),[v,f]=n.useState("question"),J=`cogita.live.host.${a}.${s}`,L=o?h[o.currentRoundIndex]??null:null,w=o!=null&&o.status&&o.status!=="lobby"?o.currentPrompt??null:null,K=(o==null?void 0:o.currentReveal)??null,S=n.useMemo(()=>o!=null&&o.code&&typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision/${encodeURIComponent(o.code)}`:"",[o==null?void 0:o.code]),G=n.useMemo(()=>o!=null&&o.code&&typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision-screen/${encodeURIComponent(o.code)}`:"",[o==null?void 0:o.code]),_=n.useMemo(()=>{if(!(o!=null&&o.sessionId)||!(o!=null&&o.hostSecret)||typeof window>"u")return"";const V=`${window.location.origin}/#/cogita/live-revision-host/${encodeURIComponent(a)}/${encodeURIComponent(s)}`,ye=new URLSearchParams({sessionId:o.sessionId,hostSecret:o.hostSecret,code:o.code});return`${V}?${ye.toString()}`},[a,s,o==null?void 0:o.code,o==null?void 0:o.hostSecret,o==null?void 0:o.sessionId]),A=(o==null?void 0:o.status)==="finished"||(o==null?void 0:o.status)==="closed"?"finished":o!=null&&o.status&&o.status!=="lobby"?"active":"lobby",O=N==="panel",de=N==="panel"||N==="question",Ce=N==="panel"||N==="score",Je=(V,ye)=>V.replace(/\{(\w+)\}/g,(Qe,Ee)=>String(ye[Ee]??"")),ie={lobby:u.statusLobby,running:u.statusRunning,revealed:u.statusRevealed,finished:u.statusFinished,closed:"Closed"},$=(V,ye,Qe)=>({...V,hostSecret:V.hostSecret||(ye==null?void 0:ye.hostSecret)||(Qe==null?void 0:Qe.hostSecret)||"",code:V.code||(ye==null?void 0:ye.code)||(Qe==null?void 0:Qe.code)||""}),be=n.useRef(null),U=async()=>{const V=await ys({libraryId:a,revisionId:s,title:u.hostKicker,sessionMode:k,hostViewMode:N,participantViewMode:v,sessionSettings:{mode:k,hostViewMode:N,participantViewMode:v}});j(V),typeof localStorage<"u"&&localStorage.setItem(J,JSON.stringify({sessionId:V.sessionId,hostSecret:V.hostSecret,code:V.code}))};n.useEffect(()=>{o!=null&&o.sessionId&&(m(o.sessionMode==="asynchronous"?"asynchronous":"simultaneous"),C(o.hostViewMode==="question"||o.hostViewMode==="score"?o.hostViewMode:"panel"),f(o.participantViewMode==="score"||o.participantViewMode==="fullscreen"?o.participantViewMode:"question"))},[o==null?void 0:o.sessionId]),n.useEffect(()=>{let V=!1;return _o({libraryId:a,revisionId:s,labels:{selectMatchingPairPrompt:u.selectMatchingPairPrompt,wordLanguagePromptPrefix:u.wordLanguagePromptPrefix}}).then(ye=>{V||b(ye)}).catch(()=>{V||(d(u.loadRoundsError),p("error"))}),()=>{V=!0}},[a,u.selectMatchingPairPrompt,u.wordLanguagePromptPrefix,s]),n.useEffect(()=>{let V=!1;async function ye(){try{const Qe=new URLSearchParams(r.search),Ee=Qe.get("sessionId"),Ne=Qe.get("hostSecret"),tt=Qe.get("code");if(!!(Ee&&Ne)&&Ee&&Ne){const Ae=await bs({libraryId:a,sessionId:Ee,hostSecret:Ne});if(V)return;const ze=$(Ae,null,{hostSecret:Ne,code:tt??void 0});j(ze),typeof localStorage<"u"&&localStorage.setItem(J,JSON.stringify({sessionId:ze.sessionId,hostSecret:ze.hostSecret,code:ze.code})),p("ready");return}const rt=await ys({libraryId:a,revisionId:s,title:u.hostKicker,sessionMode:k,hostViewMode:N,participantViewMode:v,sessionSettings:{mode:k,hostViewMode:N,participantViewMode:v}});if(V)return;j(rt),localStorage.setItem(J,JSON.stringify({sessionId:rt.sessionId,hostSecret:rt.hostSecret,code:rt.code})),p("ready")}catch{if(V)return;d(u.createSessionError),p("error")}}return ye(),()=>{V=!0}},[a,u.hostKicker,r.search,s,J]),n.useEffect(()=>{if(!o)return;const V=window.setInterval(async()=>{try{const ye=await bs({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret});j(Qe=>$(ye,Qe))}catch{}},1200);return()=>window.clearInterval(V)},[a,o]),n.useEffect(()=>{if(!o||!L||o.status!=="running"||o.sessionMode!=="simultaneous")return;const V=o.participants.filter(Ne=>Ne.isConnected);if(V.length===0)return;const ye=new Set(o.currentRoundAnswers.filter(Ne=>Ne.roundIndex===o.currentRoundIndex&&(Ne.cardKey??"")===L.cardKey).map(Ne=>Ne.participantId));if(!V.every(Ne=>ye.has(Ne.participantId)))return;const Ee=`${o.sessionId}:${o.currentRoundIndex}:${L.cardKey}:running`;be.current!==Ee&&(be.current=Ee,oe().catch(()=>{be.current=null}))},[L,o]);const ce=async V=>{if(!o)return;const ye=Object.prototype.hasOwnProperty.call(V,"currentPrompt"),Qe=Object.prototype.hasOwnProperty.call(V,"currentReveal"),Ee=await ei({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret,status:V.status??o.status,currentRoundIndex:V.currentRoundIndex??o.currentRoundIndex,revealVersion:V.revealVersion??o.revealVersion,currentPrompt:ye?V.currentPrompt??null:o.currentPrompt??null,currentReveal:Qe?V.currentReveal??null:o.currentReveal??null});j(Ne=>$(Ee,Ne))},Q=async V=>{const ye=h[V];!ye||!o||await ce({status:"running",currentRoundIndex:V,revealVersion:o.revealVersion+1,currentReveal:null,currentPrompt:{...ye.publicPrompt,roundIndex:V,cardKey:ye.cardKey}})},xe=async()=>{h.length&&await Q((o==null?void 0:o.currentRoundIndex)??0)},oe=async()=>{if(!o||!L)return;const V=new Map(o.currentRoundAnswers.filter(Ee=>Ee.roundIndex===o.currentRoundIndex&&(Ee.cardKey??"")===L.cardKey).map(Ee=>[Ee.participantId,Ee.answer])),ye=o.participants.map(Ee=>{const Ne=V.get(Ee.participantId),tt=L.grade(Ne);return{participantId:Ee.participantId,isCorrect:tt,pointsAwarded:tt?1:0}}),Qe=await Zr({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret,scores:ye});j(Ee=>$(Qe,Ee)),await ce({status:"revealed",revealVersion:Qe.revealVersion+1,currentReveal:L.reveal})},ae=async()=>{if(!o)return;const V=o.currentRoundIndex+1;if(V>=h.length){await ce({status:"finished",currentReveal:null});return}await Q(V)},Me=async()=>{if(o){if(o.status==="running"){await oe();return}if(o.status==="revealed"){await ae();return}o.status==="lobby"&&await xe()}},se=async V=>{if(o!=null&&o.hostSecret)try{const ye=await ai({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret,requestId:V});j(Qe=>$(ye,Qe))}catch{}},Re=async()=>{if(o)try{const V=await ir({libraryId:a,sessionId:o.sessionId});j(V),typeof localStorage<"u"&&localStorage.setItem(J,JSON.stringify({sessionId:V.sessionId,hostSecret:V.hostSecret,code:V.code}))}catch{}},Le=async()=>{try{p("loading"),await U(),p("ready")}catch{d(u.createSessionError),p("error")}},He=async()=>{if(o)try{const V=await ti({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret});j(ye=>$(V,ye))}catch{}};return e.jsx($t,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":A,children:[O?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:u.hostKicker}),e.jsx("h2",{className:"cogita-detail-title",children:u.hostTitle}),c==="loading"?e.jsx("p",{children:u.loading}):null,l?e.jsx("p",{className:"cogita-help",children:l}):null,o?e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Session mode"}),e.jsxs("select",{value:k,onChange:V=>m(V.target.value),children:[e.jsx("option",{value:"simultaneous",children:"Simultaneous"}),e.jsx("option",{value:"asynchronous",children:"Asynchronous"})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Host view"}),e.jsxs("select",{value:N,onChange:V=>C(V.target.value),children:[e.jsx("option",{value:"panel",children:"Panel"}),e.jsx("option",{value:"question",children:"Question"}),e.jsx("option",{value:"score",children:"Score"})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Participant view"}),e.jsxs("select",{value:v,onChange:V=>f(V.target.value),children:[e.jsx("option",{value:"question",children:"Question"}),e.jsx("option",{value:"score",children:"Score"}),e.jsx("option",{value:"fullscreen",children:"Fullscreen"})]})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:u.joinCodeLabel}),e.jsx("input",{readOnly:!0,value:o.code})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:u.joinUrlLabel}),e.jsx("input",{readOnly:!0,value:S})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Host URL"}),e.jsx("input",{readOnly:!0,value:_})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Presenter URL"}),e.jsx("input",{readOnly:!0,value:G})]}),S?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:u.qrLabel}),e.jsx("div",{style:{display:"inline-flex",padding:"0.75rem",borderRadius:"12px",background:"#fff"},children:e.jsx(Gs,{value:S,size:176,marginSize:2})})]}):null,e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:u.statusLabel}),e.jsx("input",{readOnly:!0,value:ie[o.status]??o.status})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:xe,disabled:!h.length,children:u.publishCurrentRound}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Le,children:"New session"}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Re,children:"Refresh links"}),e.jsx("button",{type:"button",className:"cta ghost",onClick:He,disabled:o.status==="closed",children:"Close session"})]}),e.jsx("p",{className:"cogita-help",children:Je(u.roundsLabel,{count:h.length})})]}):null]}):null,de?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:u.currentRoundTitle}),e.jsx("h3",{className:"cogita-detail-title",children:w&&typeof w.title=="string"?w.title:(o==null?void 0:o.status)==="lobby"?u.sessionNotStarted:u.waitingForPublishedRound}),(o==null?void 0:o.status)==="lobby"?e.jsx("p",{className:"cogita-help",children:u.hiddenBeforeStart}):e.jsx(Ea,{className:"cogita-live-card-container",feedbackToken:K?`correct-${(o==null?void 0:o.revealVersion)??0}`:"idle",children:e.jsx(ds,{prompt:w,revealExpected:K==null?void 0:K.expected,mode:"readonly",labels:{answerLabel:i.answerLabel,correctAnswerLabel:i.correctAnswerLabel,trueLabel:u.trueLabel,falseLabel:u.falseLabel,fragmentLabel:u.fragmentLabel,correctFragmentLabel:u.correctFragmentLabel,participantAnswerPlaceholder:u.participantAnswerPlaceholder,unsupportedPromptType:u.unsupportedPromptType,waitingForReveal:"Waiting for reveal.",selectedPaths:"Selected paths",removePath:"Remove",columnPrefix:"Column"}})}),A!=="lobby"?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:Me,disabled:!h.length||!L||o.status==="finished"||o.status==="closed",children:o.status==="revealed"?i.nextQuestion:i.checkAnswer})}):null,A!=="finished"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:u.participantsTitle}),e.jsxs("div",{className:"cogita-share-list",children:[o==null?void 0:o.participants.map(V=>{const ye=o.currentRoundAnswers.find(Qe=>Qe.participantId===V.participantId);return e.jsx("div",{className:"cogita-share-row",children:e.jsxs("div",{children:[e.jsx("strong",{children:V.displayName}),e.jsxs("div",{className:"cogita-share-meta",children:[ye?u.answerStatusAnswered:u.answerStatusWaiting,(ye==null?void 0:ye.isCorrect)===!0?` · ${u.answerStatusCorrect}`:"",(ye==null?void 0:ye.isCorrect)===!1?` · ${u.answerStatusIncorrect}`:""]})]})},V.participantId)}),o&&o.participants.length===0?e.jsx("p",{className:"cogita-help",children:u.noParticipants}):null]}),o&&(((st=o.pendingReloginRequests)==null?void 0:st.length)??0)>0?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Relogin requests"}),e.jsx("div",{className:"cogita-share-list",children:(o.pendingReloginRequests??[]).map(V=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsxs("div",{children:[e.jsx("strong",{children:V.displayName}),e.jsx("div",{className:"cogita-share-meta",children:new Date(V.requestedUtc).toLocaleTimeString()})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>se(V.requestId),children:"Allow relogin"})]},V.requestId))})]}):null]}):null]}):null,A!=="lobby"&&Ce?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:A==="finished"?u.finalScoreTitle:u.pointsTitle}),e.jsx("div",{className:"cogita-share-list",children:((o==null?void 0:o.scoreboard)??[]).map(V=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:V.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[V.score," ",u.scoreUnit]})]},`score:${V.participantId}`))})]}):null]})})})})})}const Qo=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionHostPage:Do},Symbol.toStringTag,{value:"Module"}));function Qs(t){return`cogita.live.join.${t}`}function zo(t){const{code:a}=t,s=t.copy.cogita.library.revision,r=s.live,[i,u]=n.useState(""),[o,j]=n.useState(()=>typeof localStorage>"u"?null:localStorage.getItem(Qs(a))),[h,b]=n.useState(null),[c,p]=n.useState("idle"),[l,d]=n.useState(""),[k,m]=n.useState([]),[N,C]=n.useState(null),[v,f]=n.useState([]),[J,L]=n.useState([]),[w,K]=n.useState([]),[S,G]=n.useState(null),[_,A]=n.useState(!1),O=(h==null?void 0:h.currentPrompt)??null,de=(h==null?void 0:h.currentReveal)??null,Ce=de==null?void 0:de.expected,Je=(h==null?void 0:h.status)==="finished"||(h==null?void 0:h.status)==="closed"?"finished":h!=null&&h.status&&h.status!=="lobby"?"active":"lobby",ie=(h==null?void 0:h.participantViewMode)??"question",$=ie!=="fullscreen"||Je==="lobby"||!o,be=ie!=="score",U=ie!=="question"||Je==="finished",ce=n.useMemo(()=>`${(h==null?void 0:h.currentRoundIndex)??0}:${(h==null?void 0:h.revealVersion)??0}:${String((O==null?void 0:O.cardKey)??"")}`,[O==null?void 0:O.cardKey,h==null?void 0:h.currentRoundIndex,h==null?void 0:h.revealVersion]);n.useEffect(()=>{d(""),m([]),C(null),f(Array.isArray(O==null?void 0:O.options)?[...O.options??[]]:[]);const se=Array.isArray(O==null?void 0:O.columns)?Math.max(2,O.columns.length):0;L([]),K(se>0?new Array(se).fill(null):[])},[ce]),n.useEffect(()=>{let se=!0;const Re=async()=>{try{const He=await Wn({code:a,participantToken:o});if(!se)return;b(He),o&&p("ready")}catch{se&&c!=="joining"&&p("error")}};Re();const Le=window.setInterval(Re,1200);return()=>{se=!1,window.clearInterval(Le)}},[a,o,c]),n.useEffect(()=>{if(!S||!_||o)return;let se=!1;const Re=window.setInterval(async()=>{try{const Le=await ni({code:a,requestId:S});if(se)return;Le.status==="approved"&&(A(!1),p("idle"))}catch{}},1200);return()=>{se=!0,window.clearInterval(Re)}},[a,o,_,S]);const Q=async()=>{p("joining");try{const se=await si({code:a,name:i});j(se.participantToken),localStorage.setItem(Qs(a),se.participantToken),A(!1),G(null),p("ready")}catch(se){if(se instanceof as&&se.status===409)try{const Re=await ri({code:a,name:i});G(Re.requestId),A(!0),p("ready");return}catch{p("error");return}p("error")}},xe=se=>{if(!!(O!=null&&O.multiple)){m(Le=>Le.includes(se)?Le.filter(He=>He!==se):[...Le,se].sort((He,st)=>He-st));return}m([se])},oe=(se,Re)=>{f(Le=>{const He=[...Le],st=se+Re;return st<0||st>=He.length?Le:([He[se],He[st]]=[He[st],He[se]],He)})},ae=(se,Re)=>{const Le=Array.isArray(O==null?void 0:O.columns)?O.columns:[],He=Math.max(2,Le.length);K(st=>{const V=Array.from({length:He},(Qe,Ee)=>st[Ee]??null);if(V[se]=V[se]===Re?null:Re,V.some(Qe=>Qe==null))return V;const ye=V.map(Qe=>Number(Qe));return L(Qe=>[...Qe,ye]),new Array(He).fill(null)})},Me=async()=>{if(!o||!O||typeof O.cardKey!="string")return;let se=null;switch(O.kind){case"selection":se=k;break;case"boolean":se=N;break;case"ordering":se=v;break;case"matching":se={paths:J};break;case"citation-fragment":case"text":default:se=l;break}try{await ii({code:a,participantToken:o,roundIndex:Number(O.roundIndex??(h==null?void 0:h.currentRoundIndex)??0),cardKey:O.cardKey,answer:se});const Re=await Wn({code:a,participantToken:o});b(Re),p("ready")}catch{p("error")}};return e.jsx($t,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":Je,"data-participant-view":ie,children:[$?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:r.joinKicker}),e.jsx("h2",{className:"cogita-detail-title",children:r.joinTitle}),o?e.jsx("p",{className:"cogita-help",children:r.joinedWaiting}):e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:r.participantNameLabel}),e.jsx("input",{value:i,onChange:se=>u(se.target.value)})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:Q,disabled:!i.trim()||c==="joining",children:c==="joining"?r.joiningAction:r.joinAction})})]}),_?e.jsx("p",{className:"cogita-help",children:"Relogin request sent. Wait for host approval and join again."}):null,c==="error"?e.jsx("p",{className:"cogita-help",children:r.connectionError}):null,Je==="lobby"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:r.scoreboardTitle}),e.jsxs("div",{className:"cogita-share-list",children:[h==null?void 0:h.scoreboard.map(se=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:se.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[se.score," ",r.scoreUnit]})]},se.participantId)),h&&h.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:r.noParticipants}):null]})]}):null]}):null,be?e.jsxs("div",{className:`cogita-library-panel ${ie==="fullscreen"?"cogita-live-fullscreen-panel":""}`,children:[e.jsx("p",{className:"cogita-user-kicker",children:r.questionTitle}),e.jsx("h3",{className:"cogita-detail-title",children:typeof(O==null?void 0:O.title)=="string"?O.title:r.waitingForPublishedRound}),O?e.jsxs(e.Fragment,{children:[e.jsx(Ea,{className:"cogita-live-card-container",feedbackToken:de?`correct-${(h==null?void 0:h.revealVersion)??0}`:"idle",children:e.jsx(ds,{prompt:O,revealExpected:Ce,mode:"interactive",labels:{answerLabel:s.answerLabel,correctAnswerLabel:s.correctAnswerLabel,trueLabel:r.trueLabel,falseLabel:r.falseLabel,fragmentLabel:r.fragmentLabel,correctFragmentLabel:r.correctFragmentLabel,participantAnswerPlaceholder:r.participantAnswerPlaceholder,unsupportedPromptType:r.unsupportedPromptType,waitingForReveal:"Waiting for reveal.",selectedPaths:"Selected paths",removePath:"Remove",columnPrefix:"Column"},answers:{text:l,selection:k,booleanAnswer:N,ordering:v,matchingRows:J,matchingSelection:w},onTextChange:d,onSelectionToggle:xe,onBooleanChange:C,onOrderingMove:oe,onMatchingPick:ae,onMatchingRemovePath:se=>L(Re=>Re.filter((Le,He)=>He!==se))})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:Me,disabled:!o||!O.cardKey||(h==null?void 0:h.answerSubmitted),children:h!=null&&h.answerSubmitted?r.submitted:r.submitAnswer})})]}):e.jsx("p",{className:"cogita-help",children:r.waitingForHostQuestion})]}):null,Je!=="lobby"&&U?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:Je==="finished"?r.finalScoreTitle:r.pointsTitle}),e.jsxs("div",{className:"cogita-share-list",children:[h==null?void 0:h.scoreboard.map(se=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:se.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[se.score," ",r.scoreUnit]})]},`score:${se.participantId}`)),h&&h.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:r.noParticipants}):null]})]}):null]})})})})})}const Go=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionJoinPage:zo},Symbol.toStringTag,{value:"Module"}));function Bo(t){const{code:a}=t,s=t.copy.cogita.library.revision.live,[r,i]=n.useState(null),[u,o]=n.useState("loading"),j=(r==null?void 0:r.currentPrompt)??null,h=(r==null?void 0:r.currentReveal)??null,b=h==null?void 0:h.expected,c=(r==null?void 0:r.participantViewMode)??"question",p=(r==null?void 0:r.status)==="finished"||(r==null?void 0:r.status)==="closed"?"finished":r!=null&&r.status&&r.status!=="lobby"?"active":"lobby",l=c!=="score",d=c!=="question"||p==="finished",k=n.useMemo(()=>typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision/${encodeURIComponent(a)}`:"",[a]);return n.useEffect(()=>{let m=!0;const N=async()=>{try{const v=await Wn({code:a});if(!m)return;i(v),o("ready")}catch{if(!m)return;o("error")}};N();const C=window.setInterval(N,1200);return()=>{m=!1,window.clearInterval(C)}},[a]),e.jsx($t,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":p,"data-participant-view":c,children:[l?e.jsxs("div",{className:`cogita-library-panel ${c==="fullscreen"?"cogita-live-fullscreen-panel":""}`,children:[e.jsx("p",{className:"cogita-user-kicker",children:s.hostKicker}),e.jsx("h2",{className:"cogita-detail-title",children:u==="error"?s.connectionError:s.statusLobby}),(r==null?void 0:r.status)==="lobby"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:s.joinCodeLabel}),e.jsx("input",{readOnly:!0,value:a})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:s.joinUrlLabel}),e.jsx("input",{readOnly:!0,value:k})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:s.qrLabel}),e.jsx("div",{style:{display:"inline-flex",padding:"0.75rem",borderRadius:"12px",background:"#fff"},children:e.jsx(Gs,{value:k,size:176,marginSize:2})})]})]}):e.jsx(Ea,{className:"cogita-live-card-container",feedbackToken:h?`correct-${(r==null?void 0:r.revealVersion)??0}`:"idle",children:e.jsx(ds,{prompt:j,revealExpected:b,mode:"readonly",labels:{answerLabel:t.copy.cogita.library.revision.answerLabel,correctAnswerLabel:t.copy.cogita.library.revision.correctAnswerLabel,trueLabel:s.trueLabel,falseLabel:s.falseLabel,fragmentLabel:s.fragmentLabel,correctFragmentLabel:s.correctFragmentLabel,participantAnswerPlaceholder:s.participantAnswerPlaceholder,unsupportedPromptType:s.unsupportedPromptType,waitingForReveal:"Waiting for reveal.",selectedPaths:"Selected paths",removePath:"Remove",columnPrefix:"Column"}})})]}):null,d?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:(r==null?void 0:r.status)==="finished"?s.finalScoreTitle:s.pointsTitle}),e.jsxs("div",{className:"cogita-share-list",children:[((r==null?void 0:r.scoreboard)??[]).map(m=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:m.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[m.score," ",s.scoreUnit]})]},`presenter-score:${m.participantId}`)),r&&r.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:s.noParticipants}):null]})]}):null]})})})})})}const Yo=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionPresenterPage:Bo},Symbol.toStringTag,{value:"Module"}));function Vo(t){const a=Wa(),s=t.copy.cogita.library.revision.live,{libraryId:r}=t,[i,u]=n.useState([]),[o,j]=n.useState([]),[h,b]=n.useState("loading"),[c,p]=n.useState(null),[l,d]=n.useState({}),k=n.useMemo(()=>({lobby:s.statusLobby,running:s.statusRunning,revealed:s.statusRevealed,finished:s.statusFinished,closed:"Closed"}),[s.statusFinished,s.statusLobby,s.statusRevealed,s.statusRunning]),m=async()=>{b("loading");try{const[C,v]=await Promise.all([oi({libraryId:r}),li({libraryId:r})]);u(C),j(v),b("ready")}catch{u([]),j([]),b("error")}};n.useEffect(()=>{m()},[r]);const N=async(C,v)=>{p(C.sessionId);try{const f=l[C.sessionId]??await ir({libraryId:r,sessionId:C.sessionId});l[C.sessionId]||d(w=>({...w,[C.sessionId]:{sessionId:f.sessionId,code:f.code,hostSecret:f.hostSecret}}));const J=encodeURIComponent(f.code);if(v==="host"){a(`/cogita/live-revision-host/${encodeURIComponent(r)}/${encodeURIComponent(C.revisionId)}?sessionId=${encodeURIComponent(f.sessionId)}&hostSecret=${encodeURIComponent(f.hostSecret)}&code=${J}`);return}const L=v==="presenter"?`${window.location.origin}/#/cogita/public/live-revision-screen/${J}`:`${window.location.origin}/#/cogita/public/live-revision/${J}`;window.open(L,"_blank","noopener")}finally{p(null)}};return e.jsx($t,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("div",{className:"cogita-detail-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:s.hostKicker}),e.jsx("h2",{className:"cogita-detail-title",children:"Active live sessions"})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:m,children:"Refresh"})})]}),h==="loading"?e.jsx("p",{children:s.loading}):null,h==="error"?e.jsx("p",{className:"cogita-help",children:s.connectionError}):null,h==="ready"&&i.length===0?e.jsx("p",{className:"cogita-help",children:"No active sessions."}):null,e.jsx("div",{className:"cogita-share-list",children:i.map(C=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsxs("div",{children:[e.jsx("strong",{children:C.title||C.sessionId}),e.jsxs("div",{className:"cogita-share-meta",children:[k[C.status]??C.status," · ",s.participantsTitle,": ",C.participantCount]})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>N(C,"host"),disabled:c===C.sessionId,children:"Host"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>N(C,"presenter"),disabled:c===C.sessionId,children:"Screen"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>N(C,"login"),disabled:c===C.sessionId,children:"Login panel"})]})]},C.sessionId))}),e.jsx("div",{className:"cogita-detail-header",style:{marginTop:"1rem"},children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Participant sessions"}),e.jsx("h3",{className:"cogita-detail-title",children:"Sessions where you participate"})]})}),h==="ready"&&o.length===0?e.jsx("p",{className:"cogita-help",children:"No participant sessions."}):null,e.jsx("div",{className:"cogita-share-list",children:o.map(C=>e.jsx("div",{className:"cogita-share-row",children:e.jsxs("div",{children:[e.jsx("strong",{children:C.title||C.sessionId}),e.jsxs("div",{className:"cogita-share-meta",children:[k[C.status]??C.status," · ",s.participantsTitle,": ",C.participantCount]}),e.jsxs("div",{className:"cogita-share-meta",children:["Score: ",C.participantScore," · ",C.isConnected?"Connected":"Disconnected"]})]})},`participating:${C.sessionId}`))})]})})})})})}const Xo=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveSessionsPage:Vo},Symbol.toStringTag,{value:"Module"}));export{Jo as C,Ho as a,Wo as b,Qo as c,Go as d,Yo as e,Xo as f};
