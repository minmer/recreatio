import{j as t,H as be,P as pe,n as ea,b as ta,c as aa,r as d,R as sa,o as na,B as ra,C as la}from"./vendor-CL5v9b84.js";import{B as oa,Q as X,S as ca,am as ia,T as da,an as ua,ao as dt,ap as ut,aq as ha,ar as ga,as as pa,at as ht,au as ma,av as gt,aw as pt,U as xa,ax as fa,ay as ya,az as ja,ag as mt,L as Na,A as wa,aA as va,aB as ka,aC as Sa}from"./recreatio-core-C0WUwo_7.js";import"./vendor-cogita-ui-mbCyoqV0.js";const Ne=["Owner","Write","Read"],je={Owner:"#1d4ed8",Write:"#dc2626",Read:"#0284c7",link:"#374151"},ye="#374151",ba=["Owner","Write","Read"],ft="aux-in",yt="aux-out",Ra=e=>{const h={...je};return e.forEach(g=>{h[g.type]||(h[g.type]=ye)}),h},Ia=e=>Ne.includes(e),Pe=e=>Ia(e)?{sourceHandle:`out-${e}`,targetHandle:`in-${e}`}:{sourceHandle:yt,targetHandle:ft};function Ta({copy:e,search:h,onSearchChange:g,showReachable:x,onToggleReachable:m,isFullscreen:u,onToggleFullscreen:I,filters:L,onToggleFilter:b}){return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"role-controls",children:[t.jsx("input",{type:"search",placeholder:e.account.roles.searchPlaceholder,value:h,onChange:y=>g(y.target.value)}),t.jsxs("label",{className:"role-toggle",children:[t.jsx("input",{type:"checkbox",checked:x,onChange:y=>m(y.target.checked)}),e.account.roles.reachableToggle]}),t.jsx("button",{type:"button",className:"chip",onClick:I,children:u?e.account.roles.fullscreenExit:e.account.roles.fullscreenEnter})]}),t.jsxs("div",{className:"role-filters",children:[Object.keys(L).length===0&&t.jsx("span",{className:"hint",children:e.account.roles.noFilters}),Object.entries(L).map(([y,F])=>t.jsx("button",{type:"button",className:`chip ${F?"active":""}`,onClick:()=>b(y,!F),children:y},y))]}),t.jsxs("div",{className:"role-legend",children:[t.jsx("span",{className:"hint",children:e.account.roles.legendTitle}),t.jsx("div",{className:"role-legend-items",children:ba.map(y=>t.jsxs("div",{className:"role-legend-item",children:[t.jsx("span",{className:"role-legend-dot",style:{background:je[y],borderColor:je[y]}}),t.jsx("span",{children:y})]},y))})]}),t.jsxs("div",{className:"role-legend-notes",children:[t.jsx("span",{className:"hint",children:e.account.roles.relationNotesTitle}),t.jsxs("div",{className:"role-legend-items",children:[t.jsxs("div",{className:"role-legend-item",children:[t.jsx("span",{children:"Owner"}),t.jsx("span",{className:"hint",children:e.account.roles.relationOwner})]}),t.jsxs("div",{className:"role-legend-item",children:[t.jsx("span",{children:"Write"}),t.jsx("span",{className:"hint",children:e.account.roles.relationWrite})]}),t.jsxs("div",{className:"role-legend-item",children:[t.jsx("span",{children:"Read"}),t.jsx("span",{className:"hint",children:e.account.roles.relationRead})]})]})]})]})}function Ca({copy:e,state:h,form:g,setForm:x,handlers:m}){var ce;const{selectedNode:u,selectedEdge:I,selectedEdgeCanDelete:L,pendingLink:b,actionStatus:y,selectedRoleId:F,selectedRoleCanWrite:M,selectedRoleCanLink:R,selectedRecoveryPlanId:U,selectedRecoveryCanLink:q,selectedRecoveryHasShares:A,selectedRecoveryNeedsShares:Z,selectedDataOwner:l,createOwnerId:f,pendingShares:T,pendingState:w,pendingDataShares:E,pendingDataState:Q,parents:_,parentsState:z,verification:he,verificationState:oe,edges:ge}=h;return t.jsxs("aside",{className:"role-panel",children:[t.jsx("h4",{children:e.account.roles.panelTitle}),u&&t.jsxs("div",{className:"role-panel-block",children:[t.jsx("strong",{children:u.data.label}),u.data.kind&&u.data.nodeType!=="data"&&u.data.nodeType!=="external"&&t.jsx("span",{className:"hint",children:u.data.kind}),u.data.nodeType==="data"&&u.data.value&&t.jsx("span",{className:"hint",children:u.data.value}),u.data.nodeType==="data"&&u.data.roleId&&t.jsxs("span",{className:"hint",children:[e.account.roles.dataOwnerLabel,":"," ",l?`${l.data.label} (${u.data.roleId})`:u.data.roleId]}),t.jsx("span",{className:"hint",children:u.id})]}),I&&t.jsxs("div",{className:"role-panel-block",children:[t.jsx("strong",{children:e.account.roles.edgeTitle}),t.jsx("span",{className:"hint",children:(ce=I.data)==null?void 0:ce.relationType}),t.jsxs("span",{className:"hint",children:[I.source," ","->"," ",I.target]}),L&&t.jsx("button",{type:"button",className:"ghost",onClick:m.onDeleteEdge,children:e.account.roles.edgeDeleteAction})]}),b&&t.jsxs("div",{className:"role-panel-block",children:[t.jsx("strong",{children:e.account.roles.linkDraftTitle}),t.jsx("span",{className:"hint",children:e.account.roles.linkDraftHint}),t.jsxs("span",{className:"hint",children:[b.sourceId," ","->"," ",b.targetId]}),t.jsx("span",{className:"hint",children:b.relationType})]}),y.type!=="idle"&&t.jsxs("div",{className:`status ${y.type==="working"?"":y.type}`,children:[t.jsx("strong",{children:e.access.statusTitle}),t.jsx("span",{children:y.message??e.access.statusReady})]}),!u&&!I&&t.jsx("p",{className:"hint",children:e.account.roles.panelEmpty}),u&&u.data.nodeType==="role"&&t.jsxs(t.Fragment,{children:[R&&M&&t.jsxs(t.Fragment,{children:[t.jsx("button",{type:"button",className:"chip",onClick:()=>m.onStartCreateRole(u.id),children:e.account.roles.createOwnedRole}),f&&t.jsxs("form",{className:"role-panel-form",onSubmit:m.onCreateRole,children:[t.jsx("strong",{children:e.account.roles.createRoleTitle}),t.jsx("span",{className:"hint",children:e.account.roles.createOwnedRoleHint}),t.jsxs("label",{children:[e.account.roles.createRoleNickLabel,t.jsx("input",{type:"text",value:g.newRoleNick,onChange:o=>x.setNewRoleNick(o.target.value)})]}),t.jsxs("label",{children:[e.account.roles.createRoleKindLabel,t.jsx("input",{type:"text",value:g.newRoleKind,onChange:o=>x.setNewRoleKind(o.target.value)})]}),t.jsxs("div",{className:"role-panel-actions",children:[t.jsx("button",{type:"submit",className:"chip",children:e.account.roles.createRoleAction}),t.jsx("button",{type:"button",className:"ghost",onClick:m.onCancelCreateRole,children:e.account.roles.cancelAction})]})]})]}),R&&t.jsxs("form",{className:"role-panel-form",onSubmit:m.onAddField,children:[t.jsx("strong",{children:e.account.roles.dataAddTitle}),t.jsxs("label",{children:[e.account.roles.dataKindLabel,t.jsxs("select",{value:g.newDataKind,onChange:o=>{const W=o.target.value;x.setNewDataKind(W),W==="key"&&x.setNewFieldValue("")},children:[t.jsx("option",{value:"data",children:e.account.roles.dataKindData}),t.jsx("option",{value:"key",children:e.account.roles.dataKindKey})]})]}),t.jsxs("label",{children:[e.account.roles.dataFieldLabel,t.jsx("input",{type:"text",value:g.newFieldType,onChange:o=>x.setNewFieldType(o.target.value)})]}),t.jsxs("label",{children:[e.account.roles.dataValueLabel,t.jsx("input",{type:"text",value:g.newFieldValue,onChange:o=>x.setNewFieldValue(o.target.value),disabled:g.newDataKind==="key"})]}),t.jsx("button",{type:"submit",className:"chip",children:e.account.roles.dataAddAction})]}),M&&R&&t.jsxs("form",{className:"role-panel-form",onSubmit:m.onShareRole,children:[t.jsx("strong",{children:e.account.roles.shareRoleTitle}),t.jsx("span",{className:"hint",children:e.account.roles.shareRoleHint}),t.jsxs("label",{children:[e.account.roles.shareRoleTargetLabel,t.jsx("input",{type:"text",value:g.shareTargetRoleId,onChange:o=>x.setShareTargetRoleId(o.target.value)})]}),t.jsxs("label",{children:[e.account.roles.shareRoleRelationLabel,t.jsx("select",{value:g.shareRelationType,onChange:o=>x.setShareRelationType(o.target.value),children:Ne.map(o=>t.jsx("option",{value:o,children:o},o))})]}),t.jsx("button",{type:"submit",className:"chip",children:e.account.roles.shareRoleAction})]}),F&&R&&t.jsx("button",{type:"button",className:"chip",onClick:()=>m.onPrepareRecovery(F),children:e.account.roles.recoveryPrepareAction})]}),U&&q&&t.jsxs("div",{className:"role-panel-block",children:[t.jsx("strong",{children:e.account.roles.recoveryPlanTitle}),t.jsx("span",{className:"hint",children:e.account.roles.recoveryPlanHint}),Z&&t.jsx("span",{className:"hint",children:e.account.roles.recoveryPlanNeedsShares}),!Z&&t.jsx("button",{type:"button",className:"chip",onClick:()=>m.onActivateRecovery(U),children:e.account.roles.recoveryActivateAction})]}),F&&t.jsxs("div",{className:"role-panel-block",children:[t.jsx("strong",{children:e.account.roles.pendingTitle}),t.jsx("button",{type:"button",className:"chip",onClick:m.onLoadPendingShares,children:e.account.roles.pendingAction}),w==="working"&&t.jsx("span",{className:"hint",children:e.account.roles.pendingWorking}),w==="error"&&t.jsx("div",{className:"status error",children:e.account.roles.pendingError}),w==="idle"&&T.length===0&&t.jsx("span",{className:"hint",children:e.account.roles.pendingEmpty}),T.length>0&&t.jsx("div",{className:"role-panel-list",children:T.map(o=>t.jsxs("div",{className:"role-ledger-row",children:[t.jsx("span",{className:"note",children:o.sourceRoleId}),t.jsx("span",{className:"hint",children:o.relationshipType}),M&&t.jsx("button",{type:"button",className:"chip",onClick:()=>m.onAcceptShare(o.shareId),children:e.account.roles.pendingAccept})]},o.shareId))})]}),u&&(u.data.nodeType==="data"||u.data.nodeType==="key")&&R&&t.jsxs("form",{className:"role-panel-form",onSubmit:m.onShareData,children:[t.jsx("strong",{children:e.account.roles.dataShareTitle}),t.jsxs("label",{children:[e.account.roles.dataShareTargetLabel,t.jsx("input",{type:"text",value:g.shareDataTargetRoleId,onChange:o=>x.setShareDataTargetRoleId(o.target.value)})]}),t.jsxs("label",{children:[e.account.roles.dataSharePermissionLabel,t.jsx("select",{value:g.shareDataPermission,onChange:o=>x.setShareDataPermission(o.target.value),children:Ne.map(o=>t.jsx("option",{value:o,children:o},o))})]}),t.jsx("button",{type:"submit",className:"chip",children:e.account.roles.dataShareAction})]}),t.jsxs("div",{className:"role-panel-block",children:[t.jsx("strong",{children:e.account.roles.pendingDataTitle}),t.jsx("button",{type:"button",className:"chip",onClick:m.onLoadPendingDataShares,children:e.account.roles.pendingDataAction}),Q==="working"&&t.jsx("span",{className:"hint",children:e.account.roles.pendingDataWorking}),Q==="error"&&t.jsx("div",{className:"status error",children:e.account.roles.pendingDataError}),Q==="idle"&&E.length===0&&t.jsx("span",{className:"hint",children:e.account.roles.pendingDataEmpty}),E.length>0&&t.jsx("div",{className:"role-panel-list",children:E.map(o=>t.jsxs("div",{className:"role-ledger-row",children:[t.jsx("span",{className:"note",children:o.dataItemId}),t.jsx("span",{className:"hint",children:o.permissionType}),t.jsx("button",{type:"button",className:"chip",onClick:()=>m.onAcceptDataShare(o.shareId),children:e.account.roles.pendingAccept})]},o.shareId))})]}),F&&t.jsxs("div",{className:"role-panel-block",children:[t.jsx("strong",{children:e.account.roles.parentsTitle}),t.jsx("button",{type:"button",className:"chip",onClick:m.onLoadParents,children:e.account.roles.parentsAction}),z==="working"&&t.jsx("span",{className:"hint",children:e.account.roles.parentsWorking}),z==="error"&&t.jsx("div",{className:"status error",children:e.account.roles.parentsError}),_&&_.parents.length===0&&t.jsx("span",{className:"hint",children:e.account.roles.none}),_&&_.parents.length>0&&t.jsx("div",{className:"role-panel-list",children:_.parents.map(o=>{var j;const W=o.parentRoleId,ne=F?`role:${F.replace(/-/g,"")}`:"",i=`role:${W.replace(/-/g,"")}`,te=ge.find(O=>O.source===i&&O.target===ne);return t.jsxs("div",{className:"role-ledger-row",children:[t.jsx("span",{className:"note",children:W}),t.jsx("span",{className:"hint",children:((j=te==null?void 0:te.data)==null?void 0:j.relationType)??o.relationshipType}),R&&t.jsx("button",{type:"button",className:"ghost",onClick:()=>m.onDeleteParent(W),children:e.account.roles.parentsRemoveAction})]},W)})})]}),F&&t.jsxs("div",{className:"role-panel-block",children:[t.jsx("strong",{children:e.account.roles.verifyTitle}),t.jsx("button",{type:"button",className:"chip",onClick:m.onVerifyRole,children:e.account.roles.verifyAction}),oe==="working"&&t.jsx("span",{className:"hint",children:e.account.roles.verifyWorking}),oe==="error"&&t.jsx("div",{className:"status error",children:e.account.roles.verifyError}),he&&t.jsx("div",{className:"role-panel-list",children:he.ledgers.map(o=>{const W=o.hashMismatches===0&&o.previousHashMismatches===0,ne=o.signaturesInvalid===0&&o.signaturesMissing===0;return t.jsxs("div",{className:"role-ledger-row",children:[t.jsx("span",{className:"note",children:o.ledger}),t.jsx("span",{className:`role-ledger-flag ${W?"ok":"error"}`,children:W?e.account.roles.verifyHashOk:e.account.roles.verifyHashIssue}),t.jsx("span",{className:`role-ledger-flag ${ne?"ok":"error"}`,children:ne?e.account.roles.verifySigOk:e.account.roles.verifySigIssue}),t.jsx("span",{className:"hint",children:e.account.roles.verifyRoleSigned.replace("{count}",String(o.roleSignedEntries))})]},o.ledger)})})]}),u&&u.data.nodeType==="data"&&M&&t.jsxs("form",{className:"role-panel-form",onSubmit:m.onUpdateField,children:[t.jsx("strong",{children:e.account.roles.dataEditTitle}),t.jsxs("label",{children:[e.account.roles.dataValueLabel,t.jsx("input",{type:"text",value:g.dataValue,onChange:o=>x.setDataValue(o.target.value)})]}),t.jsxs("div",{className:"role-panel-actions",children:[t.jsx("button",{type:"submit",className:"chip",children:e.account.roles.dataEditAction}),t.jsx("button",{type:"button",className:"ghost",onClick:m.onDeleteField,children:e.account.roles.dataDeleteAction})]})]}),u&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"role-panel-block",children:[t.jsx("strong",{children:e.account.roles.incomingTitle}),u.data.incomingTypes.length===0&&t.jsx("span",{className:"hint",children:e.account.roles.none}),u.data.incomingTypes.map(o=>t.jsx("div",{children:t.jsx("span",{className:"note",children:o})},o))]}),t.jsxs("div",{className:"role-panel-block",children:[t.jsx("strong",{children:e.account.roles.outgoingTitle}),u.data.outgoingTypes.length===0&&t.jsx("span",{className:"hint",children:e.account.roles.none}),u.data.outgoingTypes.map(o=>t.jsx("div",{children:t.jsx("span",{className:"note",children:o})},o))]})]})]})}const Le=({data:e})=>{const g=e.nodeType==="external",x=e.nodeType==="role"||e.nodeType==="data"||e.nodeType==="key"||g,m=e.nodeType==="data"||e.nodeType==="key",u=!!e.canLink,I=x?[...Ne]:[],L=x?I.length:1,b=x?Math.max(72,(L-1)*16+48):56,y=e.nodeType==="data"?e.value:g?null:e.kind,F="",M=!u&&!g?"role-handle--disabled":"";return t.jsxs("div",{className:`role-flow-node role-flow-node--${e.nodeType}`,style:{minHeight:b},children:[t.jsx(be,{id:ft,type:"target",position:pe.Left,isConnectableStart:!1,isConnectableEnd:!1,className:"role-handle role-handle-aux",style:{"--edge-color":"transparent"}}),t.jsx(be,{id:yt,type:"source",position:pe.Right,isConnectableStart:!1,isConnectableEnd:!1,className:"role-handle role-handle-aux",style:{"--edge-color":"transparent"}}),!g&&I.map((R,U)=>{const q=(U-(I.length-1)/2)*16,A=e.typeColors[R]??"var(--ink)";return t.jsx(be,{id:`in-${R}`,type:"target",position:pe.Left,isConnectableStart:!0,isConnectableEnd:!0,className:`role-handle role-handle-in ${F} ${M}`,style:{"--edge-color":A,"--port-offset":`${q}px`}},`in-${R}`)}),!m&&I.map((R,U)=>{const q=(U-(I.length-1)/2)*16,A=e.typeColors[R]??"var(--ink)";return t.jsx(be,{id:`out-${R}`,type:"source",position:pe.Right,isConnectableStart:!0,isConnectableEnd:!0,className:`role-handle role-handle-out ${F} ${M}`,style:{"--edge-color":A,"--port-offset":`${q}px`}},`out-${R}`)}),t.jsx("span",{children:e.label}),y&&t.jsx("small",{className:e.nodeType==="data"?"role-node-value":"role-node-kind",children:y})]})},xt=({data:e})=>{const h=!!e.canLink,g=e.nodeType==="recovery_plan"?"Draft":e.kind,x=e.typeColors.Owner??"var(--ink)",m=h?"":"role-handle--hidden";return t.jsxs("div",{className:`role-flow-node role-flow-node--${e.nodeType}`,children:[t.jsx(be,{id:"in-Owner",type:"target",position:pe.Left,isConnectableStart:!1,isConnectableEnd:h,className:`role-handle role-handle-in ${m}`,style:{"--edge-color":x}}),t.jsx(be,{id:"out-Owner",type:"source",position:pe.Right,isConnectableStart:h,isConnectableEnd:!1,className:`role-handle role-handle-out ${m}`,style:{"--edge-color":x}}),t.jsx("span",{children:e.label}),g&&t.jsx("small",{className:"role-node-kind",children:g})]})},Ea=({id:e,sourceX:h,sourceY:g,targetX:x,targetY:m,sourcePosition:u,targetPosition:I,data:L,markerEnd:b})=>{const[y]=ea({sourceX:h,sourceY:g,targetX:x,targetY:m,sourcePosition:u??pe.Right,targetPosition:I??pe.Left});return t.jsx("g",{className:"react-flow__edge",children:t.jsx("path",{id:e,className:"react-flow__edge-path role-edge-path",d:y,markerEnd:b,style:{stroke:L==null?void 0:L.color},children:t.jsx("title",{children:L==null?void 0:L.relationType})})})},Da=(e,h)=>{const g=e.filter(l=>l.nodeType==="role"),x=new Set(g.map(l=>l.id)),m=new Map,u=new Map;g.forEach(l=>{m.set(l.id,[]),u.set(l.id,0)}),h.forEach(l=>{var f;!x.has(l.sourceRoleId)||!x.has(l.targetRoleId)||((f=m.get(l.sourceRoleId))==null||f.push(l.targetRoleId),u.set(l.targetRoleId,(u.get(l.targetRoleId)??0)+1))});const I=[];u.forEach((l,f)=>{l===0&&I.push(f)});const L=new Map;for(I.forEach(l=>L.set(l,0));I.length>0;){const l=I.shift();if(!l)continue;const f=L.get(l)??0;(m.get(l)??[]).forEach(w=>{const E=f+1,Q=L.get(w);(Q===void 0||E>Q)&&L.set(w,E);const _=(u.get(w)??0)-1;u.set(w,_),_===0&&I.push(w)})}const b={},y=new Map;g.forEach(l=>{var T;const f=L.get(l.id)??0;y.has(f)||y.set(f,[]),(T=y.get(f))==null||T.push(l.id)});const F=140,M=424,R=140,U=200;Array.from(y.keys()).sort((l,f)=>l-f).forEach(l=>{(y.get(l)??[]).forEach((T,w)=>{b[T]={x:F+l*M,y:R+w*U}})});const A=new Map,Z=new Map;return e.forEach(l=>{if(l.nodeType==="data"&&l.roleId&&b[`role:${l.roleId.replace(/-/g,"")}`]){const f=`role:${l.roleId.replace(/-/g,"")}`,T=b[f],w=A.get(f)??0;A.set(f,w+1),b[l.id]={x:T.x+272,y:T.y+w*90}}}),e.forEach(l=>{if(l.nodeType==="recovery"&&l.roleId){const f=`role:${l.roleId.replace(/-/g,"")}`,T=b[f];if(T){const w=Z.get(f)??0;Z.set(f,w+1),b[l.id]={x:T.x+252,y:T.y-120-w*80}}}}),e.forEach(l=>{if(l.nodeType!=="recovery_shared")return;const f=h.find(w=>w.targetRoleId===l.id);if(!f)return;const T=b[f.sourceRoleId];T&&(b[l.id]={x:T.x+252,y:T.y})}),e.forEach(l=>{b[l.id]||(b[l.id]={x:140,y:140})}),b},G=e=>e.startsWith("role:")?e.slice(5):e,ae=(e,h)=>{var g;if(e instanceof oa){const x=(g=e.message)==null?void 0:g.trim();if(!x)return h;if(x.startsWith("{"))try{const m=JSON.parse(x);if(m.error)return m.error}catch{return x}return x}return h},Pa=()=>typeof crypto<"u"&&"randomUUID"in crypto?`recovery-plan:draft-${crypto.randomUUID()}`:`recovery-plan:draft-${Date.now().toString(36)}${Math.random().toString(36).slice(2,8)}`,Ae=e=>{var h;return!!((h=e==null?void 0:e.data.nodeType)!=null&&h.startsWith("recovery"))},He=e=>(e==null?void 0:e.data.nodeType)==="external";function La(e){var ot;const[h,g,x]=ta([]),[m,u,I]=aa([]),[L,b]=d.useState(!1),[y,F]=d.useState(""),[M,R]=d.useState(null),[U,q]=d.useState(null),[A,Z]=d.useState(!1),[l,f]=d.useState({}),[T,w]=d.useState([]),[E,Q]=d.useState(null),[_,z]=d.useState(null),[he,oe]=d.useState(!1),[ge,ce]=d.useState(!1),[o,W]=d.useState("graph"),[ne,i]=d.useState({type:"idle"}),[te,j]=d.useState(""),[O,ie]=d.useState(""),[B,se]=d.useState("data"),[Re,qe]=d.useState(""),[$e,Xe]=d.useState(""),[We,Oe]=d.useState(""),[Ve,Ye]=d.useState(""),[Ze,jt]=d.useState("Read"),[Fe,Je]=d.useState(""),[Qe,Nt]=d.useState("Read"),[Ie,Me]=d.useState(null),[et,_e]=d.useState(""),[wt,Ke]=d.useState(null),[vt,Ce]=d.useState("idle"),[kt,tt]=d.useState(null),[St,Ee]=d.useState("idle"),[bt,at]=d.useState([]),[Rt,we]=d.useState("idle"),[It,st]=d.useState([]),[Tt,ve]=d.useState("idle"),[Ct,Be]=d.useState({}),Et=d.useMemo(()=>({role:Le,data:Le,key:Le,external:Le,recovery:xt,recovery_plan:xt}),[]),Dt=d.useMemo(()=>({role:Ea}),[]),Pt=d.useCallback(()=>Pa(),[]),me=d.useCallback(async()=>{b(!0);try{await X();const a=await ca(),n=Da(a.nodes,a.edges),s=Ra(a.edges),p=a.nodes.reduce((c,$)=>(c[$.id]={incoming:[],outgoing:[]},c),{});a.edges.forEach(c=>{var $,C;($=p[c.targetRoleId])==null||$.incoming.push(c.type),(C=p[c.sourceRoleId])==null||C.outgoing.push(c.type)});const N=a.nodes.map(c=>{var C,H;const $=c.nodeType??"role";return{id:c.id,type:$,position:n[c.id],data:{label:c.label,kind:c.kind,nodeType:$,value:c.value,roleId:c.roleId,fieldType:c.fieldType,dataKeyId:c.dataKeyId,canLink:c.canLink??!1,canWrite:c.canWrite??!1,incomingTypes:((C=p[c.id])==null?void 0:C.incoming)??[],outgoingTypes:((H=p[c.id])==null?void 0:H.outgoing)??[],typeColors:s}}}),D=a.edges.map(c=>{const $=Pe(c.type);return{id:c.id,source:c.sourceRoleId,target:c.targetRoleId,sourceHandle:$.sourceHandle,targetHandle:$.targetHandle,type:"role",data:{relationType:c.type,color:s[c.type]??ye}}}),k=a.edges.reduce((c,$)=>(c[$.type]=c[$.type]??!0,c),{});f(k),g(N),u(D),w(a.nodes.map(c=>({id:c.id,label:c.label,value:c.value??c.kind})))}finally{b(!1)}},[u,g]);d.useEffect(()=>{me()},[me]);const Te=d.useMemo(()=>m.filter(a=>{var n;return l[((n=a.data)==null?void 0:n.relationType)??""]!==!1}),[m,l]),Ue=d.useMemo(()=>{if(!A||!M)return null;const a=new Set([M]),n=[M];for(;n.length>0;){const s=n.shift();s&&Te.forEach(p=>{p.source===s&&!a.has(p.target)&&(a.add(p.target),n.push(p.target))})}return a},[Te,M,A]),xe=d.useMemo(()=>Ue?new Set(Ue):null,[Ue]),Lt=d.useMemo(()=>xe?h.filter(a=>xe.has(a.id)):h,[h,xe]),At=d.useMemo(()=>xe?Te.filter(a=>xe.has(a.source)&&xe.has(a.target)):Te,[Te,xe]);d.useEffect(()=>{const a=()=>{ce(window.innerWidth<960)};return a(),window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},[]);const Ht=a=>{if(!a.source||!a.target||a.source===a.target||!a.sourceHandle||!a.targetHandle)return!1;const n=h.find(v=>v.id===a.source),s=h.find(v=>v.id===a.target);if(!n||!s)return!1;const p=Ae(n),N=Ae(s),D=He(n),k=He(s);if(p||N)return p&&N||p?!1:a.sourceHandle==="out-Owner"&&a.targetHandle==="in-Owner";const c=a.source.startsWith("role:"),$=a.target.startsWith("role:"),C=a.source.startsWith("data:")||a.source.startsWith("key:"),H=a.target.startsWith("data:")||a.target.startsWith("key:");if(C||H){if(!c&&!$||C&&H)return!1;const v=c?a.sourceHandle:a.targetHandle,K=C?a.sourceHandle:a.targetHandle;if(!(v!=null&&v.startsWith("out-"))||!(K!=null&&K.startsWith("in-")))return!1;const re=v.replace(/^(in|out)-/,"");return!!Ne.includes(re)}if(!c||!$||D&&k)return!1;const S=a.sourceHandle.replace(/^(in|out)-/,"")||a.targetHandle.replace(/^(in|out)-/,"");if(S&&!Ne.includes(S))return!1;const Y=a.sourceHandle.startsWith("in-"),P=a.targetHandle.startsWith("in-");return Y!==P},$t=async a=>{if(!a.source||!a.target||!a.sourceHandle||!a.targetHandle)return;const n=h.find(P=>P.id===a.source),s=h.find(P=>P.id===a.target);if(!n||!s)return;const p=Ae(n),N=Ae(s),D=He(n),k=He(s);if(p||N){const P=p?n:s,v=p?s:n,K=p?a.sourceHandle:a.targetHandle,re=p?a.targetHandle:a.sourceHandle;if(K!=="in-Owner"&&K!=="out-Owner"||re!=="in-Owner"&&re!=="out-Owner"||P.data.nodeType!=="recovery_plan"||K!=="in-Owner")return;if(P.data.recoveryDraft){const ee=`${G(v.id)}:${G(P.id)}:Owner`;u(J=>{var ue,le;return J.some(De=>De.id===ee)?J:J.concat({id:ee,source:v.id,target:P.id,sourceHandle:"out-Owner",targetHandle:"in-Owner",type:"role",data:{relationType:"Owner",color:((le=(ue=h[0])==null?void 0:ue.data.typeColors)==null?void 0:le.Owner)??ye}})}),Be(J=>{const ue=J[P.id]??{targetRoleId:P.data.roleId??G(v.id),sharedRoleIds:[]},le=G(v.id);return ue.sharedRoleIds.includes(le)?J:{...J,[P.id]:{...ue,sharedRoleIds:ue.sharedRoleIds.concat(le)}}}),f(J=>({...J,Owner:J.Owner??!0})),i({type:"success",message:e.account.roles.recoveryShareSuccess})}else i({type:"error",message:e.account.roles.recoveryPlanError});return}const c=n.data.nodeType==="data"||n.data.nodeType==="key",$=s.data.nodeType==="data"||s.data.nodeType==="key";if(c||$){const P=c?n:s,v=c?s:n,K=c?a.targetHandle:a.sourceHandle,re=c?a.sourceHandle:a.targetHandle;if(!K||!re||!K.startsWith("out-")||!re.startsWith("in-"))return;if(!P.data.canLink){i({type:"error",message:e.account.roles.linkPermissionNeeded});return}const ee=K.replace(/^(in|out)-/,"");if(!Ne.includes(ee))return;const J=P.id.replace(/^data:|^key:/,""),ue=G(v.id);i({type:"working",message:e.account.roles.dataShareWorking});try{await X(),await gt(J,{targetRoleId:ue,permissionType:ee});const le=`${ue}:${J}:${ee}`,De=Pe(ee);u(Se=>{var ct,it;return Se.some(Qt=>Qt.id===le)?Se:Se.concat({id:le,source:v.id,target:P.id,sourceHandle:De.sourceHandle,targetHandle:De.targetHandle,type:"role",data:{relationType:ee,color:((it=(ct=h[0])==null?void 0:ct.data.typeColors)==null?void 0:it[ee])??ye}})}),f(Se=>({...Se,[ee]:Se[ee]??!0})),i({type:"success",message:e.account.roles.dataShareSuccess})}catch(le){i({type:"error",message:ae(le,e.account.roles.dataShareError)})}return}const C=a.sourceHandle.startsWith("out-"),H=(C?a.sourceHandle:a.targetHandle).replace(/^(in|out)-/,""),S=C?a.source:a.target,Y=C?a.target:a.source;if(H){if(D||k){const P=D?n:s,v=D?s:n;if(!v.data.canLink){i({type:"error",message:e.account.roles.linkPermissionNeeded});return}i({type:"working",message:e.account.roles.shareRoleWorking});try{await X(),await pt(G(v.id),{targetRoleId:G(P.id),relationshipType:H}),i({type:"success",message:e.account.roles.shareRoleSuccess})}catch(K){i({type:"error",message:ae(K,e.account.roles.shareRoleError)})}return}if(!n.data.canLink||!s.data.canLink){i({type:"error",message:e.account.roles.linkPermissionNeeded});return}Q({sourceId:S,targetId:Y,relationType:H}),i({type:"working",message:e.account.roles.linkWorking});try{await X(),await ya(G(S),{childRoleId:G(Y),relationshipType:H});const P=`${G(S)}:${G(Y)}:${H}`,v=Pe(H);u(K=>{var re,ee;return K.some(J=>J.id===P)?K:K.concat({id:P,source:S,target:Y,sourceHandle:v.sourceHandle,targetHandle:v.targetHandle,type:"role",data:{relationType:H,color:((ee=(re=h[0])==null?void 0:re.data.typeColors)==null?void 0:ee[H])??ye}})}),f(K=>({...K,[H]:K[H]??!0})),i({type:"success",message:e.account.roles.linkSuccess})}catch(P){i({type:"error",message:ae(P,e.account.roles.linkError)})}}},r=h.find(a=>a.id===M)??null,de=m.find(a=>a.id===U)??null,V=(r==null?void 0:r.data.roleId)??(r!=null&&r.id&&r.id.startsWith("role:")?G(r.id):null),ke=V?h.find(a=>a.id===`role:${V.replace(/-/g,"")}`)??null:null,ze=de?h.find(a=>a.id===de.target)??null:null,Ge=de?h.find(a=>a.id===de.source)??null:null,Wt=!!(ze!=null&&ze.data.canLink||Ge!=null&&Ge.data.canLink),Ot=(r==null?void 0:r.data.nodeType)==="data"||(r==null?void 0:r.data.nodeType)==="key"?!!r.data.canWrite:(ke==null?void 0:ke.data.canWrite)??!1,nt=(r==null?void 0:r.data.nodeType)==="data"||(r==null?void 0:r.data.nodeType)==="key"?!!r.data.canLink:(ke==null?void 0:ke.data.canLink)??!1,Vt=(r==null?void 0:r.data.nodeType)==="recovery_plan"?r.id.replace("recovery-plan:",""):null,Ft=(ot=r==null?void 0:r.data.nodeType)!=null&&ot.startsWith("recovery")?!!r.data.canLink:!1,rt=(r==null?void 0:r.data.nodeType)==="recovery_plan"?m.some(a=>{var n;return a.target===r.id&&((n=a.data)==null?void 0:n.relationType)==="Owner"}):!1,Mt=(r==null?void 0:r.data.nodeType)==="recovery_plan"&&!rt;r!=null&&r.data.recoveryDraft;const _t=(r==null?void 0:r.data.nodeType)==="data"&&r.data.roleId?h.find(a=>a.id===`role:${r.data.roleId.replace(/-/g,"")}`)??null:null,fe=Ie!=null&&Ie.nodeId?h.find(a=>a.id===Ie.nodeId)??null:null,Kt=(fe==null?void 0:fe.data.canWrite)??!1,Bt=(fe==null?void 0:fe.data.canLink)??!1;d.useEffect(()=>{(r==null?void 0:r.data.nodeType)==="data"?Oe(r.data.value??""):Oe(""),(!r||r.id!==_)&&z(null),Ke(null),Ce("idle"),tt(null),Ee("idle")},[_,r]),d.useEffect(()=>{if(y.trim()==="")return;const a=y.trim().toLowerCase(),n=T.filter(p=>p.label.toLowerCase().includes(a)||p.id.toLowerCase().includes(a));if(n.length===0)return;const s=n[0];R(s.id),q(null)},[y,T]);const Ut=async a=>{var p;if(a.preventDefault(),!_||!te.trim()||!O.trim()){i({type:"error",message:e.account.roles.createRoleError});return}i({type:"working",message:e.account.roles.createRoleWorking});const n=_,s="Owner";try{await X();const N=await fa({parentRoleId:G(n),relationshipType:s,fields:[{fieldType:"nick",plainValue:te.trim()},{fieldType:"role_kind",plainValue:O.trim()}]}),D=((p=h[0])==null?void 0:p.data.typeColors)??{...je},k=`role:${N.roleId.replace(/-/g,"")}`,c=h.find(S=>S.id===n),$=m.filter(S=>S.source===n),C=c?{x:c.position.x+300,y:c.position.y+$.length*110}:{x:300,y:200},H=s!=="Read";g(S=>S.map(Y=>{if(Y.id!==n)return Y;const P=[...new Set([...Y.data.outgoingTypes,s])];return{...Y,data:{...Y.data,outgoingTypes:P}}}).concat({id:k,type:"role",position:C,data:{label:te.trim(),kind:O.trim(),nodeType:"role",value:null,roleId:N.roleId,fieldType:null,dataKeyId:null,canLink:!0,canWrite:H,incomingTypes:[s],outgoingTypes:[],typeColors:D}})),u(S=>S.concat({id:`${G(n)}:${N.roleId.replace(/-/g,"")}:${s}`,source:n,target:k,sourceHandle:`out-${s}`,targetHandle:`in-${s}`,type:"role",data:{relationType:s,color:D[s]??ye}})),f(S=>({...S,[s]:S[s]??!0})),w(S=>S.concat({id:k,label:te.trim(),value:O.trim()})),R(k),j(""),ie(""),z(null),i({type:"success",message:e.account.roles.createRoleSuccess})}catch(N){i({type:"error",message:ae(N,e.account.roles.createRoleError)})}},zt=async a=>{var n;if(a.preventDefault(),!(!V||!nt)){if(!Re.trim()){i({type:"error",message:e.account.roles.dataAddError});return}if(B==="data"&&!$e.trim()){i({type:"error",message:e.account.roles.dataAddError});return}i({type:"working",message:e.account.roles.dataAddWorking});try{await X();const s=await xa(V,{itemName:Re.trim(),itemType:B,plainValue:$e.trim()||null}),p=`role:${V.replace(/-/g,"")}`,N=s.itemType==="key"?"key":"data",D=`${N}:${s.dataItemId.replace(/-/g,"")}`,k="Owner",c=`${V.replace(/-/g,"")}:${s.dataItemId.replace(/-/g,"")}:${k}`,$=((n=h[0])==null?void 0:n.data.typeColors)??{...je};g(C=>{const H=C.find(v=>v.id===p),S=C.filter(v=>v.data.nodeType===N&&v.data.roleId===V).length,Y=H?{x:H.position.x+240,y:H.position.y+S*90}:{x:320,y:220};return C.some(v=>v.id===D)?C.map(v=>v.id===D?{...v,data:{...v.data,label:s.itemName,kind:s.itemType,value:s.plainValue??null,fieldType:s.itemName,dataKeyId:s.dataItemId}}:v):C.concat({id:D,type:N,position:Y,data:{label:s.itemName,kind:s.itemType,nodeType:N,value:s.plainValue??null,roleId:V,fieldType:s.itemName,dataKeyId:s.dataItemId,canLink:!0,canWrite:!0,incomingTypes:[k],outgoingTypes:[],typeColors:$}})}),u(C=>{if(C.some(Y=>Y.id===c))return C;const S=Pe(k);return C.concat({id:c,source:p,target:D,sourceHandle:S.sourceHandle,targetHandle:S.targetHandle,type:"role",data:{relationType:k,color:$[k]??ye}})}),w(C=>C.some(S=>S.id===D)?C.map(S=>S.id===D?{...S,label:s.itemName,value:s.plainValue??null}:S):C.concat({id:D,label:s.itemName,value:s.plainValue??null})),R(D),qe(""),Xe(""),se("data"),i({type:"success",message:e.account.roles.dataAddSuccess})}catch(s){i({type:"error",message:ae(s,e.account.roles.dataAddError)})}}},Gt=async a=>{if(a.preventDefault(),!r||r.data.nodeType!=="data")return;if(!We.trim()){i({type:"error",message:e.account.roles.dataEditError});return}const n=r.id.replace(/^data:/,"");i({type:"working",message:e.account.roles.dataEditWorking});try{await X();const s=await da(n,{plainValue:We.trim()}),N=`${r.data.nodeType==="key"?"key":"data"}:${s.dataItemId.replace(/-/g,"")}`;g(D=>D.map(k=>k.id===N?{...k,data:{...k.data,label:s.itemName,kind:s.itemType,value:s.plainValue??null,fieldType:s.itemName,dataKeyId:s.dataItemId}}:k)),w(D=>D.map(k=>k.id===N?{...k,label:s.itemName,value:s.plainValue??null}:k)),i({type:"success",message:e.account.roles.dataEditSuccess})}catch(s){i({type:"error",message:ae(s,e.account.roles.dataEditError)})}},qt=async()=>{if(!r||r.data.nodeType!=="data"&&r.data.nodeType!=="key")return;const a=r.id.replace(/^data:|^key:/,"");if(a){i({type:"working",message:e.account.roles.dataDeleteWorking});try{await X(),await ia(a);const n=r.id;g(s=>s.filter(p=>p.id!==n)),u(s=>s.filter(p=>p.source!==n&&p.target!==n)),w(s=>s.filter(p=>p.id!==n)),R(null),i({type:"success",message:e.account.roles.dataDeleteSuccess})}catch(n){i({type:"error",message:ae(n,e.account.roles.dataDeleteError)})}}},Xt=async a=>{if(a.preventDefault(),!V||!Ve.trim()){i({type:"error",message:e.account.roles.shareRoleError});return}const n=G(Ve.trim());i({type:"working",message:e.account.roles.shareRoleWorking});try{await X(),await pt(V,{targetRoleId:n,relationshipType:Ze}),Ye(""),i({type:"success",message:e.account.roles.shareRoleSuccess})}catch(s){i({type:"error",message:ae(s,e.account.roles.shareRoleError)})}},Yt=async a=>{if(a.preventDefault(),!r||r.data.nodeType!=="data"&&r.data.nodeType!=="key")return;if(!Fe.trim()){i({type:"error",message:e.account.roles.dataShareError});return}const n=r.id.replace(/^data:|^key:/,"");i({type:"working",message:e.account.roles.dataShareWorking});try{await X(),await gt(n,{targetRoleId:G(Fe.trim()),permissionType:Qe}),await me(),Je(""),i({type:"success",message:e.account.roles.dataShareSuccess})}catch(s){i({type:"error",message:ae(s,e.account.roles.dataShareError)})}},Zt=async()=>{ve("working");try{const a=await ga();st(a),ve("idle")}catch{ve("error")}},Jt=async a=>{ve("working");try{await X(),await ha(a,{}),await me(),st(n=>n.filter(s=>s.shareId!==a)),ve("idle")}catch{ve("error")}},lt=async a=>{var k;i({type:"working",message:e.account.roles.recoveryPrepareWorking});const n=`role:${a.replace(/-/g,"")}`,s=Pt(),p=((k=h[0])==null?void 0:k.data.typeColors)??{...je},N=h.find(c=>c.id===n),D=N?{x:N.position.x+260,y:N.position.y-120}:{x:320,y:200};g(c=>c.concat({id:s,type:"recovery_plan",position:D,data:{label:e.account.roles.recoveryPlanLabel,kind:"RecoveryKey",nodeType:"recovery_plan",value:null,roleId:a,fieldType:null,dataKeyId:null,canLink:!0,canWrite:!1,incomingTypes:[],outgoingTypes:[],typeColors:p,recoveryDraft:!0}})),Be(c=>({...c,[s]:{targetRoleId:a,sharedRoleIds:[]}})),R(s),i({type:"success",message:e.account.roles.recoveryPrepareSuccess})};return{nodes:Lt,edges:At,nodeTypes:Et,edgeTypes:Dt,onNodesChange:x,onEdgesChange:I,loading:L,search:y,setSearch:F,showReachable:A,setShowReachable:Z,isFullscreen:he,setIsFullscreen:oe,isCompact:ge,compactView:o,setCompactView:W,filters:l,setFilters:f,contextMenu:Ie,setContextMenu:Me,contextRoleId:et,setContextRoleId:_e,contextNode:fe,contextNodeCanWrite:Kt,contextNodeCanLink:Bt,handleContextAddRole:()=>{const a=et.trim();if(!a)return;const n=a.replace(/^role:/i,"").trim(),s=`role:${n.replace(/-/g,"")}`;if(h.find(N=>N.id===s)){R(s),q(null),Me(null),_e("");return}i({type:"working",message:e.account.roles.contextAddRoleWorking}),ja(n).then(N=>{var k;const D=((k=h[0])==null?void 0:k.data.typeColors)??{...je};g(c=>c.concat({id:N.id,type:N.nodeType,position:{x:140,y:140},data:{label:N.label,kind:N.kind,nodeType:N.nodeType,value:null,roleId:N.roleId,fieldType:null,dataKeyId:null,canLink:N.canLink,canWrite:N.canWrite,incomingTypes:[],outgoingTypes:[],typeColors:D}})),R(N.id),q(null),Me(null),_e(""),i({type:"success",message:e.account.roles.contextAddRoleSuccess})}).catch(()=>{i({type:"error",message:e.account.roles.contextAddRoleError})})},handlePrepareRecovery:lt,handleConnect:$t,isValidConnection:Ht,panelState:{selectedNode:r,selectedEdge:de,selectedEdgeCanDelete:Wt,pendingLink:E,actionStatus:ne,selectedRoleId:V,selectedRoleCanWrite:Ot,selectedRoleCanLink:nt,selectedRecoveryPlanId:Vt,selectedRecoveryCanLink:Ft,selectedRecoveryHasShares:rt,selectedRecoveryNeedsShares:Mt,selectedDataOwner:_t,createOwnerId:_,pendingShares:bt,pendingState:Rt,pendingDataShares:It,pendingDataState:Tt,parents:wt,parentsState:vt,verification:kt,verificationState:St,edges:m},panelForm:{newRoleNick:te,newRoleKind:O,newDataKind:B,newFieldType:Re,newFieldValue:$e,shareTargetRoleId:Ve,shareRelationType:Ze,shareDataTargetRoleId:Fe,shareDataPermission:Qe,dataValue:We},panelSetters:{setNewRoleNick:j,setNewRoleKind:ie,setNewDataKind:se,setNewFieldType:qe,setNewFieldValue:Xe,setShareTargetRoleId:Ye,setShareRelationType:jt,setShareDataTargetRoleId:Je,setShareDataPermission:Nt,setDataValue:Oe},panelHandlers:{onStartCreateRole:a=>{z(a),Q(null)},onCancelCreateRole:()=>z(null),onCreateRole:Ut,onAddField:zt,onShareRole:Xt,onShareData:Yt,onPrepareRecovery:lt,onActivateRecovery:async a=>{const n=Ct[a];if(!n){i({type:"error",message:e.account.roles.recoveryPlanError});return}if(!n.sharedRoleIds.length){i({type:"error",message:e.account.roles.recoveryPlanNeedsShares});return}i({type:"working",message:e.account.roles.recoveryActivateWorking});try{await X(),await ma(n.targetRoleId,{sharedRoleIds:n.sharedRoleIds}),g(s=>s.filter(p=>p.id!==a)),u(s=>s.filter(p=>p.target!==a&&p.source!==a)),Be(s=>{const p={...s};return delete p[a],p}),await me(),i({type:"success",message:e.account.roles.recoveryActivateSuccess})}catch(s){i({type:"error",message:ae(s,e.account.roles.recoveryActivateError)})}},onLoadPendingShares:async()=>{if(V){we("working");try{const a=await ht();at(a.filter(n=>n.targetRoleId===V)),we("idle")}catch{we("error")}}},onAcceptShare:async a=>{we("working");try{if(await X(),await pa(a,{}),await me(),V){const n=await ht();at(n.filter(s=>s.targetRoleId===V))}we("idle")}catch{we("error")}},onLoadPendingDataShares:Zt,onAcceptDataShare:Jt,onLoadParents:async()=>{if(V){Ce("working");try{const a=await ut(V);Ke(a),Ce("idle")}catch{Ce("error")}}},onDeleteParent:async a=>{if(V){i({type:"working",message:e.account.roles.parentsWorking});try{await X(),await dt(V,a),await me();const n=await ut(V);Ke(n),i({type:"success",message:e.account.roles.parentsRemoved})}catch(n){i({type:"error",message:ae(n,e.account.roles.parentsError)})}}},onDeleteEdge:async()=>{if(!de)return;const a=G(de.source),n=G(de.target);i({type:"working",message:e.account.roles.edgeDeleteWorking});try{await X(),await dt(n,a),u(s=>s.filter(p=>p.id!==de.id)),i({type:"success",message:e.account.roles.edgeDeleteSuccess})}catch(s){i({type:"error",message:ae(s,e.account.roles.edgeDeleteError)})}},onVerifyRole:async()=>{if(V){Ee("working");try{const a=await ua(V);tt(a),Ee("idle")}catch{Ee("error")}}},onUpdateField:Gt,onDeleteField:qt},selectedNodeId:M,selectedEdgeId:U,setSelectedNodeId:R,setSelectedEdgeId:q}}function Aa({copy:e}){const h=La(e),{nodes:g,edges:x,nodeTypes:m,edgeTypes:u,onNodesChange:I,onEdgesChange:L,loading:b,search:y,setSearch:F,showReachable:M,setShowReachable:R,isFullscreen:U,setIsFullscreen:q,isCompact:A,compactView:Z,setCompactView:l,filters:f,setFilters:T,contextMenu:w,setContextMenu:E,contextRoleId:Q,setContextRoleId:_,contextNode:z,contextNodeCanWrite:he,contextNodeCanLink:oe,handleContextAddRole:ge,handlePrepareRecovery:ce,handleConnect:o,isValidConnection:W,panelState:ne,panelForm:i,panelSetters:te,panelHandlers:j,setSelectedNodeId:O,setSelectedEdgeId:ie}=h;return t.jsxs("section",{className:"account-card",id:"roles",children:[t.jsx("h3",{children:e.account.sections.roles}),t.jsx("p",{className:"note",children:e.account.roles.lead}),t.jsx(Ta,{copy:e,search:y,onSearchChange:F,showReachable:M,onToggleReachable:R,isFullscreen:U,onToggleFullscreen:()=>q(B=>!B),filters:f,onToggleFilter:(B,se)=>T(Re=>({...Re,[B]:se}))}),t.jsxs("div",{className:`role-graph ${U?"is-fullscreen":""} ${A?"is-compact":""} ${A?`view-${Z}`:""}`,children:[A&&t.jsxs("div",{className:"role-view-toggle",children:[t.jsx("button",{type:"button",className:`chip ${Z==="graph"?"active":""}`,onClick:()=>l("graph"),children:e.account.roles.viewGraph}),t.jsx("button",{type:"button",className:`chip ${Z==="panel"?"active":""}`,onClick:()=>l("panel"),children:e.account.roles.viewDetails})]}),t.jsxs("div",{className:"role-flow",children:[t.jsxs(sa,{nodes:g,edges:x,nodeTypes:m,edgeTypes:u,onNodesChange:I,onEdgesChange:L,onNodeClick:(B,se)=>{E(null),O(se.id),ie(null),A&&l("panel")},onEdgeClick:(B,se)=>{E(null),ie(se.id),O(null),A&&l("panel")},onPaneClick:()=>E(null),onPaneContextMenu:B=>{B.preventDefault(),E({x:B.clientX,y:B.clientY,type:"canvas"}),_("")},onNodeContextMenu:(B,se)=>{B.preventDefault(),E({x:B.clientX,y:B.clientY,type:"node",nodeId:se.id}),O(se.id),ie(null),A&&l("panel")},onConnect:o,isValidConnection:W,fitView:!0,minZoom:.4,maxZoom:1.8,onlyRenderVisibleElements:!0,zoomOnScroll:!0,panOnScroll:!1,preventScrolling:!0,connectionLineType:na.Bezier,children:[t.jsx(ra,{gap:24,size:1,color:"rgba(40, 48, 56, 0.08)"}),t.jsx(la,{showInteractive:!1})]}),w&&t.jsxs("div",{className:"role-context-menu",style:{left:w.x,top:w.y},children:[w.type==="canvas"&&t.jsxs("div",{className:"role-context-block",children:[t.jsx("strong",{children:e.account.roles.contextAddRoleTitle}),t.jsx("input",{type:"text",placeholder:e.account.roles.contextAddRolePlaceholder,value:Q,onChange:B=>_(B.target.value)}),t.jsx("button",{type:"button",className:"chip",onClick:ge,children:e.account.roles.contextAddRoleAction}),t.jsx("button",{type:"button",className:"ghost",onClick:()=>E(null),children:e.account.roles.contextClose})]}),w.type==="node"&&z&&t.jsxs("div",{className:"role-context-block",children:[t.jsx("strong",{children:z.data.label}),z.data.nodeType==="role"&&he&&t.jsx("button",{type:"button",className:"chip",onClick:()=>{E(null),O(z.id),A&&l("panel")},children:e.account.roles.contextAddData}),z.data.nodeType==="role"&&oe&&z.data.roleId&&t.jsx("button",{type:"button",className:"chip",onClick:()=>{E(null),ce(z.data.roleId)},children:e.account.roles.contextPrepareRecovery}),t.jsx("button",{type:"button",className:"ghost",onClick:()=>E(null),children:e.account.roles.contextClose})]})]}),b&&t.jsx("div",{className:"role-loading",children:e.account.roles.loading}),!b&&g.length===0&&t.jsx("div",{className:"role-loading",children:e.account.roles.noNodes})]}),t.jsx(Ca,{copy:e,state:ne,form:i,setForm:te,handlers:j})]})]})}function Ya({copy:e,loginId:h,onLoginIdChange:g,secureMode:x,onToggleSecureMode:m,onLogout:u,onNavigate:I,language:L,onLanguageChange:b}){const y=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}I("home")},F=d.useMemo(()=>[{id:"overview",label:e.account.sections.overview},{id:"profile",label:e.account.sections.profile},{id:"roles",label:e.account.sections.roles},{id:"security",label:e.account.sections.security}],[e.account.sections]),[M,R]=d.useState(!1),[U,q]=d.useState(""),[A,Z]=d.useState({type:"idle"}),[l,f]=d.useState(!1),[T,w]=d.useState(""),[E,Q]=d.useState(""),[_,z]=d.useState(""),[he,oe]=d.useState(!1),[ge,ce]=d.useState(null),[o,W]=d.useState({type:"idle"});d.useEffect(()=>{if(!E){ce(null);return}const j=mt(E,{tooShort:e.access.passwordTooShort,common:e.access.passwordCommon,weak:e.access.passwordWeak,strong:e.access.passwordStrong});ce(j.message)},[e.access.passwordCommon,e.access.passwordStrong,e.access.passwordTooShort,e.access.passwordWeak,E]),d.useEffect(()=>{let j=!0;return(async()=>{try{await X();const ie=await va();if(!j)return;g(ie.loginId),q(ie.displayName??"")}catch{if(!j)return}})(),()=>{j=!1}},[g]);const ne=j=>{const O=document.getElementById(j);O&&O.scrollIntoView({behavior:"smooth",block:"start"}),R(!1)},i=async j=>{if(j.preventDefault(),W({type:"idle"}),!h||!T||!E){W({type:"error",message:e.access.loginRequired});return}if(E!==_){W({type:"error",message:e.access.passwordMismatch});return}const O=mt(E,{tooShort:e.access.passwordTooShort,common:e.access.passwordCommon,weak:e.access.passwordWeak,strong:e.access.passwordStrong});if(!O.ok){W({type:"error",message:O.message});return}W({type:"working",message:e.account.passwordWorking});try{await X(),await Sa({loginId:h,currentPassword:T,newPassword:E}),W({type:"success",message:e.account.passwordSuccess}),w(""),Q(""),z(""),oe(!1)}catch{W({type:"error",message:e.account.passwordError})}},te=async j=>{j.preventDefault(),Z({type:"working",message:e.account.nicknameWorking});try{const O=await ka({displayName:U||null});q(O.displayName??""),Z({type:"success",message:e.account.nicknameSuccess}),f(!1)}catch{Z({type:"error",message:e.account.nicknameError})}};return t.jsxs("div",{className:"portal-page account-page",children:[t.jsxs("header",{className:"portal-header",children:[t.jsxs("div",{className:"portal-header-left",children:[t.jsx("button",{type:"button",className:"ghost portal-back",onClick:y,children:"Back"}),t.jsx("button",{type:"button",className:"portal-brand",onClick:()=>I("home"),children:t.jsx("img",{src:"/logo_new.svg",alt:e.loginCard.title})})]}),t.jsx(Na,{value:L,onChange:b}),t.jsx(wa,{copy:e,label:e.nav.account,isAuthenticated:!0,secureMode:x,onLogin:()=>I("home"),onProfileNavigate:()=>{},onToggleSecureMode:m,onLogout:u,variant:"ghost"})]}),t.jsx("main",{className:"account-main",children:t.jsxs("div",{className:"account-shell",children:[t.jsxs("aside",{className:`account-nav ${M?"open":""}`,children:[t.jsx("button",{type:"button",className:"account-menu-toggle",onClick:()=>R(j=>!j),children:e.account.menuLabel}),t.jsx("nav",{children:F.map(j=>t.jsx("button",{type:"button",onClick:()=>ne(j.id),children:j.label},j.id))})]}),t.jsxs("div",{className:"account-content",children:[t.jsxs("section",{className:"account-intro",id:"overview",children:[t.jsx("p",{className:"tag",children:e.nav.account}),t.jsx("h2",{children:e.account.title}),t.jsx("p",{className:"lead",children:e.account.subtitle}),t.jsx("p",{className:"note",children:e.account.overviewLead})]}),t.jsxs("section",{className:"account-card",id:"profile",children:[t.jsx("h3",{children:e.account.sections.profile}),t.jsxs("div",{className:"account-row",children:[t.jsxs("div",{children:[t.jsx("strong",{children:e.account.nicknameLabel}),t.jsx("p",{className:"note",children:U||e.account.nicknamePlaceholder})]}),t.jsx("button",{type:"button",className:"ghost",onClick:()=>f(j=>!j),children:e.account.nicknameToggle})]}),l&&t.jsxs("form",{className:"account-form",onSubmit:te,children:[t.jsxs("label",{children:[e.account.nicknameLabel,t.jsx("input",{type:"text",value:U,onChange:j=>q(j.target.value),placeholder:e.account.nicknamePlaceholder})]}),t.jsx("p",{className:"hint",children:e.account.nicknameHint}),t.jsx("button",{type:"submit",className:"ghost",children:e.account.nicknameAction})]}),A.type!=="idle"&&t.jsxs("div",{className:`status ${A.type==="working"?"":A.type}`,children:[t.jsx("strong",{children:e.access.statusTitle}),t.jsx("span",{children:A.message??e.access.statusReady})]})]}),t.jsx(Aa,{copy:e}),t.jsxs("section",{className:"account-card",id:"security",children:[t.jsx("h3",{children:e.account.sections.security}),t.jsxs("div",{className:"account-readonly",children:[t.jsx("strong",{children:e.account.loginIdLabel}),t.jsx("span",{children:h})]}),t.jsx("p",{className:"hint",children:e.account.loginIdHint}),t.jsx("button",{type:"button",className:"ghost",onClick:()=>oe(j=>!j),children:e.account.passwordToggle}),he&&t.jsxs("form",{className:"account-form",onSubmit:i,children:[t.jsxs("label",{children:[e.account.currentPassword,t.jsx("input",{type:"password",value:T,onChange:j=>w(j.target.value)})]}),t.jsxs("label",{children:[e.account.newPassword,t.jsx("input",{type:"password",value:E,onChange:j=>Q(j.target.value)})]}),ge&&t.jsx("span",{className:"hint",children:ge}),t.jsxs("label",{children:[e.account.confirmPassword,t.jsx("input",{type:"password",value:_,onChange:j=>z(j.target.value)})]}),t.jsx("button",{type:"submit",className:"cta",children:e.account.passwordAction})]}),o.type!=="idle"&&t.jsxs("div",{className:`status ${o.type}`,children:[t.jsx("strong",{children:e.access.statusTitle}),t.jsx("span",{children:o.message??e.access.statusReady})]}),t.jsxs("div",{className:"account-security",children:[t.jsxs("div",{children:[t.jsx("strong",{children:e.account.secureModeTitle}),t.jsx("p",{className:"note",children:e.account.secureModeNote})]}),t.jsx("button",{type:"button",className:"ghost",onClick:m,children:x?e.account.secureModeDisable:e.account.secureModeEnable})]}),t.jsxs("div",{className:"account-security",children:[t.jsx("div",{children:t.jsx("strong",{children:e.account.logoutAction})}),t.jsx("button",{type:"button",className:"ghost",onClick:u,children:e.account.logoutAction})]})]})]})]})})]})}export{Ya as AccountPage};
