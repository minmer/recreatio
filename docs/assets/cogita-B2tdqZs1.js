import{r as a,j as e,u as dn,a as Oa,b as Bn,c as On,d as Vn,R as un,B as hn,C as gn}from"./vendor-CL5v9b84.js";import{L as $s,A as Rs,g as Es,a as nr,b as za,c as qn,s as as,d as Un,e as sr,f as kn,h as ua,i as rr,j as ir,k as Ya,l as Xa,m as Ps,n as Jn,o as _n,p as or,u as ns,q as Fs,r as lr,t as cr,v as dr,w as ur,x as hr,y as Ks,z as gr,B as Ds,C as _s,D as mr,E as pr,F as mn,G as Za,H as fr,I as zs,J as br,K as Bs,M as Os,N as yr,O as xr,P as vr,Q as ss,R as ba,S as wr,T as jr,U as kr,V as Nr,W as Sr,X as Tr,Y as Cr,Z as Ir,_ as Mr,$ as Lr,a0 as Ar,a1 as $r,a2 as Rr,a3 as rs}from"./recreatio-core-Ydb8QFim.js";import"./vendor-cogita-ui-mbCyoqV0.js";const Ka={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},Ea={moveMs:900,pauseMs:220,errorMs:900},Er=(t=11)=>{let n=t;const s=()=>(n=(n*1664525+1013904223)%4294967296,n/4294967296),{width:r,height:o,paddingX:u,paddingY:h,levels:w}=Ka,v=(o-h*2)/(w.length-1),S=[],c=[],f=[];w.forEach((b,p)=>{const oe=o-h-p*v,B=r-u*2,y=[];for(let q=0;q<b;q+=1){const k=u+(q+1)*B/(b+1),Z=(s()-.5)*18,_=Math.max(u,Math.min(r-u,k+Z)),$=p===0?3:p<2?2.1:1.4,de=p===0?"root":`l${p}-${q}`;y.push({id:de,x:p===0?r/2:_,y:oe,r:$,level:p,role:p===0?"root":void 0})}f.push(y),S.push(...y)});const l=f[f.length-1];if(l!=null&&l.length){const b=l[Math.floor(l.length/2)];b.role="goal",b.r=2}for(let b=1;b<f.length;b+=1){const p=f[b-1];f[b].forEach(B=>{const y=[...p].sort((_,$)=>Math.abs(_.x-B.x)-Math.abs($.x-B.x)),q=y[0],k=y[1]&&s()<.45?y[1]:null;(k?[q,k]:[q]).forEach(_=>{c.push({from:_.id,to:B.id,key:`${_.id}-${B.id}`})}),s()<.2&&y[2]&&c.push({from:y[2].id,to:B.id,key:`${y[2].id}-${B.id}`})})}const d=new Map;c.forEach(b=>{const p=d.get(b.to)??[];p.push(b.from),d.set(b.to,p)});const j=new Map,m=new Map,C=new Map;c.forEach(b=>{const p=j.get(b.from)??[];p.push(b.key),j.set(b.from,p);const oe=m.get(b.from)??[];oe.push(b.to),m.set(b.from,oe);const B=C.get(b.from)??[];B.push(b.to),C.set(b.from,B);const y=C.get(b.to)??[];y.push(b.from),C.set(b.to,y)});const O=new Map;return S.forEach(b=>{O.set(b.id,b)}),{nodes:S,links:c,parentsById:d,linksByFrom:j,childrenByFrom:m,neighborsById:C,nodesById:O}};function Pr({slides:t,activeIndex:n,introOpen:s,prefersReducedMotion:r,onNext:o,onPrev:u,onSelect:h,onExit:w,onOpen:v,onRegister:S}){const c=n===t.length-1,f=s&&n===0?"entry":"docked",l=t[t.length-1],[d,j]=a.useState(!1),m=a.useMemo(()=>Array.from({length:20},(P,L)=>({src:`/cogita/logo/Cogita${String(L).padStart(2,"0")}.png`,kind:L<=11?"bubble":L<=17?"text":"recreatio"})),[]),C=s&&n===0;a.useEffect(()=>{if(!s){j(!1);return}n>0&&!d&&j(!0)},[n,s,d]);const O=a.useRef(0),b=a.useRef(null),p=a.useMemo(()=>{const P={x:40,y:160},L={x:260,y:48},x=6,N=L.x-P.x,I=P.y-L.y,ne=N/x,fe=[.3,.45,.6,.65,1.4,2.2],ie=fe.reduce((U,Q)=>U+Q,0),W=fe.map(U=>I*U/ie),E=[P];let J=P.x,X=P.y;for(let U=1;U<=x;U+=1){const Q=(Math.random()-.5)*14,be=(Math.random()-.5)*28;J=Math.max(P.x+U*14,Math.min(L.x-(x-U)*14,J+ne+Q));const K=W[U-1]??W[W.length-1];X=X-K+be;const ee=Math.max(L.y,Math.min(P.y-4,X));E.push({x:Math.round(J),y:Math.round(ee)})}return E[E.length-1]=L,E},[]),oe=a.useMemo(()=>{const I=(ie,W,E)=>Math.min(E,Math.max(W,ie)),ne=p.map(ie=>{const W=10+Math.random()*36;return{x:I(ie.x,40,260),y:I(ie.y-W,40,140)}}),fe=p.map((ie,W)=>{var X;const E=12+Math.random()*40,J=((X=ne[W])==null?void 0:X.y)??ie.y;return{x:I(ie.x,40,260),y:I(Math.max(J+10,ie.y+E),60,170)}});return{upper:ne,lower:fe}},[p]),B=a.useMemo(()=>{var L;const P=((L=p[4])==null?void 0:L.x)??260;return Math.max(0,Math.min(240,P-40))},[p]),y=a.useMemo(()=>{var W,E;const P=(J,X,U)=>Math.min(U,Math.max(X,J)),L=(J,X,U)=>p.map((Q,be)=>{var pt,ht;const K=((pt=oe.upper[be])==null?void 0:pt.y)??Q.y,ee=((ht=oe.lower[be])==null?void 0:ht.y)??Q.y,Le=(Math.random()-.5)*70,Ve=Q.y+J+Le,Ke=P(Q.y+X,K+6,ee-6),Ue=P(Q.y+U,K+6,ee-6);return{x:Q.x,y:P(Ve,Math.min(Ke,Ue),Math.max(Ke,Ue))}}),x=-14+Math.random()*28,N=14+Math.random()*28,I=L(x,-80,12),ne=L(N,-12,80);for(let J=4;J<p.length;J+=1){const X=p[J],U=((W=oe.upper[J])==null?void 0:W.y)??X.y,Q=((E=oe.lower[J])==null?void 0:E.y)??X.y;I[J]={x:X.x,y:P(X.y-12,U+6,Q-6)},ne[J]={x:X.x,y:P(X.y+12,U+6,Q-6)}}const fe=oe.upper.length?oe.upper[oe.upper.length-1].y:40,ie=oe.lower.length?oe.lower[oe.lower.length-1].y:170;return I[I.length-1]={x:p[p.length-1].x,y:P(p[p.length-1].y-14,fe,ie)},ne[ne.length-1]={x:p[p.length-1].x,y:P(p[p.length-1].y+12,fe,ie)},{higher:I,lower:ne}},[p,oe]),q=1e4,k=a.useMemo(()=>{let P=17;const L=()=>(P=(P*1664525+1013904223)%4294967296,P/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((N,I)=>{const ne=(L()-.5)*240,fe=(L()-.5)*180,ie=(L()-.5)*24;return{id:`card-${I+1}`,throw:{x:`${ne.toFixed(0)}px`,y:`${fe.toFixed(0)}px`,rot:`${ie.toFixed(1)}deg`},grid:{x:`${N.x}px`,y:`${N.y}px`},delay:`${I*.12}s`}})},[]),Z=a.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[_,$]=a.useState([]),de=a.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),ue=a.useMemo(()=>{const L=[],N=(ne,fe)=>ne+Math.random()*(fe-ne);for(let ne=0;ne<6;ne+=1){let fe=!1;for(let ie=0;ie<80;ie+=1){const W=N(14,86),E=N(10,34);if(L.every(X=>{const U=X.x-W,Q=X.y-E;return Math.hypot(U,Q)>=12})){L.push({x:W,y:E}),fe=!0;break}}fe||L.push({x:N(16,84),y:N(12,32)})}return L.map((ne,fe)=>({id:`p${fe+1}`,x:`${ne.x.toFixed(1)}%`,y:`${ne.y.toFixed(1)}%`,xNum:ne.x,yNum:ne.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[Se,He]=a.useState(0),[me,R]=a.useState(0),[ye,V]=a.useState([]),he=1e4,Y=a.useMemo(()=>{if(ue.length<2)return[];const P=fe=>{let ie=fe+1831565813;return ie=Math.imul(ie^ie>>>15,ie|1),ie^=ie+Math.imul(ie^ie>>>7,ie|61),((ie^ie>>>14)>>>0)/4294967296},L=(fe,ie)=>Math.floor(P(fe)*ie),x=new Set,N=[],I=Math.min(3,ue.length);let ne=0;for(;N.length<I&&ne<30;){ne+=1;const fe=L(Se*13+ne*5,ue.length),ie=L(Se*29+ne*7,ue.length);if(fe===ie)continue;const W=fe<ie?`${fe}-${ie}`:`${ie}-${fe}`;x.has(W)||(x.add(W),N.push({id:`link-${W}`,from:ue[fe],to:ue[ie],delay:`${(ne*.35).toFixed(2)}s`}))}return N},[Se,ue]);a.useEffect(()=>{if(!s||n!==2)return;const P=()=>{const x=k.map(N=>N.id);for(let N=x.length-1;N>0;N-=1){const I=Math.floor(Math.random()*(N+1));[x[N],x[I]]=[x[I],x[N]]}return x.slice(0,4)};$(P());const L=window.setInterval(()=>{$(P())},q);return()=>window.clearInterval(L)},[n,s,k,q]),a.useEffect(()=>{if(!s||n!==3)return;const P=()=>{R(Math.floor(Math.random()*de.length)),V(ue.map(()=>Math.random()<.6?"good":"bad")),He(x=>x+1)};P();const L=window.setInterval(P,he);return()=>window.clearInterval(L)},[n,s,de.length,ue,he]);const je=a.useMemo(()=>Er(11),[]),[le,se]=a.useState(new Set(["root"])),[Ie,Ae]=a.useState(new Set),[Pe,$e]=a.useState(new Set),[Ze,ot]=a.useState({fromId:"root",toId:"root",key:0}),Te=a.useRef(le),We=a.useRef("root"),ft=a.useRef(0),Oe=a.useRef(null),_e=a.useRef(null),et=a.useRef([]);a.useEffect(()=>{Te.current=le},[le]);const it=a.useMemo(()=>{const P=new Set;return le.forEach(L=>{const x=je.linksByFrom.get(L);x&&x.forEach(N=>P.add(N))}),P},[le,je]),Ge=je.nodesById.get(Ze.toId)??je.nodesById.get("root"),Ce=Ge?`${Ge.x/Ka.width*100}%`:"50%",ze=Ge?`${Ge.y/Ka.height*100}%`:"90%";a.useEffect(()=>{if(!s||n!==1||r)return;(()=>{se(new Set(["root"])),Ae(new Set),$e(new Set),ot({fromId:"root",toId:"root",key:0}),_e.current=null,ft.current=0,We.current="root",et.current=[]})();const L=()=>{const N=We.current,I=Te.current,fe=(je.childrenByFrom.get(N)??[]).filter(Q=>!I.has(Q));if(fe.length)return fe[Math.floor(Math.random()*fe.length)];if(I.size>=je.nodes.length){const Q=je.neighborsById.get(N)??[];return Q.length?Q[Math.floor(Math.random()*Q.length)]:null}const ie=Q=>(je.childrenByFrom.get(Q)??[]).some(K=>!I.has(K)),W=[N],E=new Set([N]),J=new Map;let X=null;for(;W.length;){const Q=W.shift();if(!Q)break;if(Q!==N&&ie(Q)){X=Q;break}(je.neighborsById.get(Q)??[]).forEach(K=>{E.has(K)||(E.add(K),J.set(K,Q),W.push(K))})}if(!X)return null;let U=X;for(;J.get(U)&&J.get(U)!==N;)U=J.get(U)??U;return U},x=(N,I)=>{if(N===I){const ne=L();ne&&x(N,ne);return}ft.current+=1,ot({fromId:N,toId:I,key:ft.current}),We.current=I,Oe.current=window.setTimeout(()=>{const ne=je.parentsById.get(I)??[],fe=Te.current,ie=ne.filter(X=>!fe.has(X));if(!ie.length){const X=new Set(fe);X.add(I),se(X),Oe.current=window.setTimeout(()=>{for(;et.current.length;){const Q=et.current[et.current.length-1];if(!X.has(Q)){if(Q!==I){x(I,Q);return}break}et.current.pop()}const U=L();U&&x(I,U)},Ea.pauseMs);return}const W=new Set([I,...ie]),E=new Set(ie.map(X=>`${X}-${I}`));Ae(W),$e(E),et.current.includes(I)||et.current.push(I);const J=ie[Math.floor(Math.random()*ie.length)];_e.current={fromId:I,toId:J},Oe.current=window.setTimeout(()=>{Ae(new Set),$e(new Set);const X=_e.current;X&&x(X.fromId,X.toId)},Ea.errorMs)},Ea.moveMs)};return Oe.current=window.setTimeout(()=>{const N=L();N&&x(We.current,N)},Ea.pauseMs),()=>{Oe.current&&window.clearTimeout(Oe.current)}},[n,s,je,r]);const Ye=P=>{if(!s)return;const L=Date.now();L-O.current<520||Math.abs(P.deltaY)<10||(O.current=L,P.deltaY>0?o():u(),P.preventDefault())},A=P=>{if(!s)return;const L=P.touches[0];L&&(b.current={x:L.clientX,y:L.clientY})},M=P=>{if(!s)return;const L=b.current;if(b.current=null,!L)return;const x=P.changedTouches[0];if(!x)return;const N=x.clientX-L.x,I=x.clientY-L.y;Math.abs(I)<40||Math.abs(I)<Math.abs(N)||(I<0?o():u())};return e.jsxs("div",{className:`cogita-intro ${s?"is-open":"is-closed"} ${r?"is-reduced":""} ${c?"is-final":""}`,"data-slide":n+1,onWheel:Ye,onTouchStart:A,onTouchEnd:M,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":f,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${C&&!d?"is-entry":""}`,children:m.map((P,L)=>e.jsx("img",{src:P.src,alt:"",className:`cogita-logo-layer ${L===0?"is-base":""} ${P.kind==="text"?"is-text":P.kind==="recreatio"?"is-recreatio":""} ${P.kind==="bubble"?"is-bubble":""}`},P.src))})}),s&&t.map((P,L)=>{const x=L===n;return e.jsxs("section",{className:`cogita-intro-slide slide-${L+1} ${x?"is-active":""}`,"aria-hidden":!x,children:[e.jsxs("div",{className:"cogita-intro-text",children:[P.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:P.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:P.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:P.title}),P.body&&e.jsx("p",{children:P.body.split(`
`).map((N,I)=>e.jsxs("span",{children:[N,I===0&&e.jsx("br",{})]},String(I)))})]}),P.micro&&e.jsx("p",{className:"cogita-intro-micro",children:P.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:c?S:o,children:P.cta}),c&&P.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>h(0),children:P.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[L===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${Ka.width} ${Ka.height}`,preserveAspectRatio:"none",children:[je.links.map(N=>{const I=je.nodesById.get(N.from),ne=je.nodesById.get(N.to);if(!I||!ne)return null;const fe=it.has(N.key),ie=Pe.has(N.key);return e.jsx("line",{className:`map-link ${fe?"is-active":""} ${ie?"is-error":""}`,x1:I.x,y1:I.y,x2:ne.x,y2:ne.y},N.key)}),je.nodes.map(N=>{const I=le.has(N.id),ne=Ie.has(N.id);return e.jsx("circle",{className:`map-node ${N.role?`is-${N.role}`:""} ${I?"is-active":""} ${ne?"is-error":""}`,cx:N.x,cy:N.y,r:N.r},N.id)})]}),Ge&&e.jsx("span",{className:"map-explorer-dot",style:{left:Ce,top:ze,"--move":`${Ea.moveMs}ms`}})]}),L===2&&e.jsx("div",{className:"cogita-index-cards",children:k.map(N=>{const I=_.indexOf(N.id),ne=I>=0?Z[I]:null,fe=(ne==null?void 0:ne.x)??"140px",ie=(ne==null?void 0:ne.y)??"140px",W=I>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":N.throw.x,"--throw-y":N.throw.y,"--throw-rot":N.throw.rot,"--grid-x":N.grid.x,"--grid-y":N.grid.y,"--stack-x":fe,"--stack-y":ie,"--stack-opacity":W,"--delay":N.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},N.id)})}),L===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[de.map((N,I)=>e.jsxs("div",{className:`round-card ${I===me?"is-active":""}`,style:{"--card-x":N.x,"--card-y":N.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},N.id)),de[me]&&e.jsx("span",{className:"round-ring",style:{"--card-x":de[me].x,"--card-y":`calc(${de[me].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:ue.map(N=>e.jsx("span",{className:"player-dot",style:{left:N.x,top:N.y,"--jitter-x":N.jitterX,"--jitter-y":N.jitterY,"--breath-delay":N.delay}},N.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:Y.map(N=>e.jsx("line",{className:"round-link",x1:N.from.xNum,y1:N.from.yNum,x2:N.to.xNum,y2:N.to.yNum,style:{"--delay":N.delay}},N.id))}),e.jsx("div",{className:"round-flows",children:ue.map((N,I)=>{const ne=ye[I]??"good",fe=de[me];if(!fe)return null;const ie=`calc(${fe.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":N.x,"--from-y":N.y,"--to-x":fe.x,"--to-y":ie,"--delay":`${I*.12}s`}}),e.jsx("span",{className:`return-dot is-${ne}`,style:{"--from-x":fe.x,"--from-y":ie,"--to-x":N.x,"--to-y":N.y,"--delay":`${I*.12}s`}}),e.jsx("span",{className:`result-pop is-${ne}`,style:{"--at-x":N.x,"--at-y":N.y,"--delay":`${I*.12}s`}})]},`${N.id}-${Se}`)})})]},`round-${Se}`),L===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${p[0].x} ${p[0].y} L${p[1].x} ${p[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${p[1].x} ${p[1].y} L${p[2].x} ${p[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${p[2].x} ${p[2].y} L${p[3].x} ${p[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${p[3].x} ${p[3].y} L${p[4].x} ${p[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${p[4].x} ${p[4].y} L${p[5].x} ${p[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${p[5].x} ${p[5].y} L${p[6].x} ${p[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${B};${B};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${oe.upper.map((N,I)=>`${I===0?"M":"L"}${N.x} ${N.y}`).join(" ")} ${oe.lower.slice().reverse().map(N=>`L${N.x} ${N.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${oe.upper.map((N,I)=>`${I===0?"M":"L"}${N.x} ${N.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${oe.lower.map((N,I)=>`${I===0?"M":"L"}${N.x} ${N.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[y.higher.slice(0,6).map((N,I)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${I+1}`,d:`M${N.x} ${N.y} L${y.higher[I+1].x} ${y.higher[I+1].y}`,pathLength:"100"},`peer-1-${I}`)),y.lower.slice(0,6).map((N,I)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${I+1}`,d:`M${N.x} ${N.y} L${y.lower[I+1].x} ${y.lower[I+1].y}`,pathLength:"100"},`peer-2-${I}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${p[0].x/300*100}%`,"--p0y":`${p[0].y/200*100}%`,"--p1x":`${p[1].x/300*100}%`,"--p1y":`${p[1].y/200*100}%`,"--p2x":`${p[2].x/300*100}%`,"--p2y":`${p[2].y/200*100}%`,"--p3x":`${p[3].x/300*100}%`,"--p3y":`${p[3].y/200*100}%`,"--p4x":`${p[4].x/300*100}%`,"--p4y":`${p[4].y/200*100}%`,"--p5x":`${p[5].x/300*100}%`,"--p5y":`${p[5].y/200*100}%`,"--p6x":`${p[6].x/300*100}%`,"--p6y":`${p[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${y.higher[0].x/300*100}%`,"--q0y":`${y.higher[0].y/200*100}%`,"--q1x":`${y.higher[1].x/300*100}%`,"--q1y":`${y.higher[1].y/200*100}%`,"--q2x":`${y.higher[2].x/300*100}%`,"--q2y":`${y.higher[2].y/200*100}%`,"--q3x":`${y.higher[3].x/300*100}%`,"--q3y":`${y.higher[3].y/200*100}%`,"--q4x":`${y.higher[4].x/300*100}%`,"--q4y":`${y.higher[4].y/200*100}%`,"--q5x":`${y.higher[5].x/300*100}%`,"--q5y":`${y.higher[5].y/200*100}%`,"--q6x":`${y.higher[6].x/300*100}%`,"--q6y":`${y.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${y.lower[0].x/300*100}%`,"--q0y":`${y.lower[0].y/200*100}%`,"--q1x":`${y.lower[1].x/300*100}%`,"--q1y":`${y.lower[1].y/200*100}%`,"--q2x":`${y.lower[2].x/300*100}%`,"--q2y":`${y.lower[2].y/200*100}%`,"--q3x":`${y.lower[3].x/300*100}%`,"--q3y":`${y.lower[3].y/200*100}%`,"--q4x":`${y.lower[4].x/300*100}%`,"--q4y":`${y.lower[4].y/200*100}%`,"--q5x":`${y.lower[5].x/300*100}%`,"--q5y":`${y.lower[5].y/200*100}%`,"--q6x":`${y.lower[6].x/300*100}%`,"--q6y":`${y.lower[6].y/200*100}%`}})]})})}),L===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),L===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},P.id)}),!s&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:l.title}),l.body&&e.jsx("p",{children:l.body}),l.micro&&e.jsx("p",{className:"cogita-intro-micro",children:l.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:S,children:l.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:v,children:"Otwórz pokaz"})]})]})})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((P,L)=>e.jsx("button",{type:"button",className:`dot ${n===L?"active":""}`,"aria-label":P.title,onClick:()=>h(L)},P.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:w,children:"Pomiń"})]})]})}const Fr=6,Kr=4;function Dr({copy:t,onAuthAction:n,authLabel:s,showProfileMenu:r,onProfileNavigate:o,onToggleSecureMode:u,onLogout:h,secureMode:w,onNavigate:v,language:S,onLanguageChange:c}){const f=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}v("home")},l=a.useRef(null),d=a.useRef([]),j=a.useMemo(()=>{let V=Date.now()%2147483647;const he=()=>(V=V*48271%2147483647,V/2147483647);return Array.from({length:Fr},(Y,je)=>{const le=6+he()*8,se=7+he()*10,Ie=6+he()*9,Ae=-he()*le,Pe=-he()*se,$e=-he()*Ie,Ze=.18+he()*.28,ot=12+he()*18,Te=4+he()*8,We=(he()-.5)*3.2,ft=(he()-.5)*3.8,Oe=he()>.5?"alternate":"alternate-reverse",_e=he()>.5?"alternate":"alternate-reverse",et=he()>.5?"alternate":"alternate-reverse",it=.18+he()*.42,Ge=30+he()*60,Ce=-45-he()*38,ze=188+he()*32,Ye=.1+he()*.2;return{id:`wave-${je+1}`,style:{"--wave-sway-duration":`${le}s`,"--wave-scale-duration":`${se}s`,"--wave-drift-duration":`${Ie}s`,"--wave-sway-delay":`${Ae}s`,"--wave-scale-delay":`${Pe}s`,"--wave-drift-delay":`${$e}s`,"--wave-sway-dir":Oe,"--wave-scale-dir":_e,"--wave-drift-dir":et,"--wave-scale":`${Ze}`,"--wave-shift":`${ot}%`,"--wave-xshift":`${Te}%`,"--wave-x0":`${We}%`,"--wave-y0":`${ft}%`,"--wave-opacity":`${it}`,"--wave-blur":`${Ge}px`,"--wave-bottom":`${Ce}%`,"--wave-hue":`${ze}`,"--wave-glow":`${Ye}`}}})},[]),m=a.useMemo(()=>{let V=Date.now()*3%2147483647;const he=()=>(V=V*48271%2147483647,V/2147483647);return Array.from({length:Kr},(Y,je)=>{const le=180+he()*220,se=220+he()*280,Ie=-he()*le,Ae=-he()*se,Pe=.12+he()*.22,$e=3+he()*7,Ze=1+he()*3,ot=(he()-.5)*2.8,Te=(he()-.5)*2.2;return{id:`mesh-${je+1}`,seed:1e3+je*991+Math.floor(he()*999),style:{"--mesh-sway-duration":`${le}s`,"--mesh-drift-duration":`${se}s`,"--mesh-sway-delay":`${Ie}s`,"--mesh-drift-delay":`${Ae}s`,"--mesh-scale":`${Pe}`,"--mesh-shift":`${$e}%`,"--mesh-xshift":`${Ze}%`,"--mesh-x0":`${Te}%`,"--mesh-y0":`${ot}%`}}})},[]),C=a.useMemo(()=>{const V=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],he=t.cogita.introSlides,Y=new Map(he.map(je=>[je.id,je]));return V.map(je=>{var se;const le=Y.get(je.id);return{...je,...le,title:(le==null?void 0:le.title)??"Cogita",cta:(le==null?void 0:le.cta)??((se=t.cogita.introSlides[0])==null?void 0:se.cta)??t.cogita.loginCta,secondary:le==null?void 0:le.secondary}})},[t.cogita.introSlides]),[O,b]=a.useState(0),[p,oe]=a.useState(!0),[B,y]=a.useState(!1),q=C.length-1,k=a.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),Z=a.useCallback(()=>{k(),n()},[k,n]),_=a.useCallback(()=>{oe(!0),b(0)},[]),$=a.useCallback(()=>{oe(!1),b(q)},[q]),de=a.useCallback(V=>{b(Math.max(0,Math.min(q,V)))},[q]),ue=a.useCallback(()=>{O>=q?Z():de(O+1)},[O,de,Z,q]),Se=a.useCallback(()=>{de(O-1)},[O,de]);a.useEffect(()=>{var Y;const V=(Y=window.matchMedia)==null?void 0:Y.call(window,"(prefers-reduced-motion: reduce)");if(!V)return;const he=()=>y(V.matches);return he(),V.addEventListener?(V.addEventListener("change",he),()=>V.removeEventListener("change",he)):(V.addListener(he),()=>V.removeListener(he))},[]),a.useEffect(()=>{if(!p)return;const V=he=>{const Y=he.target;if(!Y)return;const je=Y.tagName;if(!(Y.isContentEditable||je==="INPUT"||je==="TEXTAREA"||je==="SELECT"||je==="BUTTON"||je==="A"||Y.closest('button, a, [role="button"], [role="link"]'))){if(he.key==="Escape"){$();return}if(he.key==="ArrowLeft"||he.key==="ArrowUp"){Se();return}(he.key==="ArrowRight"||he.key==="ArrowDown"||he.code==="Space"||he.key===" ")&&(he.preventDefault(),ue())}};return window.addEventListener("keydown",V),()=>window.removeEventListener("keydown",V)},[$,ue,Se,p]),a.useEffect(()=>{p&&O===q&&k()},[O,p,q,k]),a.useEffect(()=>{const V=l.current;if(!V)return;const he=d.current.filter(Ce=>!!Ce);if(!he.length)return;const Y=1,je=.6,le=.6,se=Math.max(1,Math.min(Y,window.devicePixelRatio||1));let Ie=0,Ae=0,Pe=je,$e=0,Ze=0;const ot=Ce=>{let ze=Ce%2147483647;return ze<=0&&(ze+=2147483646),(Ye,A)=>{ze=ze*48271%2147483647;const M=ze/2147483647;return Ye+M*(A-Ye)}},Te={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},We=Ce=>{const ze=Math.sin(Ce*12.9898)*43758.5453;return ze-Math.floor(ze)},ft=Ce=>{const ze=We(Ce+.1)||1e-4,Ye=We(Ce+.7)||1e-4;return Math.sqrt(-2*Math.log(ze))*Math.cos(2*Math.PI*Ye)},Oe=(Ce,ze)=>{const Ye=Math.floor(Ce),A=Ye+1,M=Ce-Ye,P=M*M*(3-2*M),L=We(Ye*12.9898+ze*78.233),x=We(A*12.9898+ze*78.233);return L+(x-L)*P},_e=Ce=>{const ze=ot(Ce),Ye=Math.min(4,Math.max(4,Math.floor(Ie/1200*Te.filamentCount)));return Array.from({length:Ye},(A,M)=>{const P=Math.max(-1,Math.min(1,ft(Ce+M*.37))),L=Math.min(1,Math.max(0,We(Ce+M*1.31))),x=Math.min(Te.depthLayers-1,Math.floor(L*Te.depthLayers));return{seed:ze(0,Math.PI*2)+Ce*.01,offset:P,freqA:Te.freq1*(.75+ze(0,.5)),freqB:Te.freq2*(.75+ze(0,.5)),ampA:Te.amp1*(.6+ze(0,.7)),ampB:Te.amp2*(.6+ze(0,.7)),width:2+M%5*.32,depth:L,layer:x}})},et=(Ce,ze,Ye)=>{const A=Math.max(30,Math.floor(Ie*Ae/14e4));Ce.save(),Ce.globalAlpha=.6;for(let M=0;M<A;M+=1){const P=We(M*9.1+Ie*.11)*ze+Ye,L=We(M*3.7+Ae*.23)*Ae,x=1.2+We(M*5.9)*2.4,N=Ce.createRadialGradient(P,L,0,P,L,x*2);N.addColorStop(0,"rgba(10, 30, 60, 0.45)"),N.addColorStop(1,"rgba(10, 30, 60, 0)"),Ce.fillStyle=N,Ce.beginPath(),Ce.arc(P,L,x*2,0,Math.PI*2),Ce.fill()}Ce.restore()},it=(Ce,ze)=>{Ce.clearRect(0,0,Ie,Ae);const Ye=Ae*Te.waveCenter,A=Te.waveBandPx,M=Te.segments,P=Te.colors.filaments,L=$e||Ie,x=0;et(Ce,L,x),Ce.strokeStyle=P,Ce.lineCap="round",Ce.lineJoin="round";for(let N=0;N<ze.length;N+=1){const I=ze[N],ne=I.offset*A*(.85+We(I.seed)*.4),fe=1-Math.min(1,Math.abs(ne)/A),ie=Math.exp(-Math.pow(ne/Te.crestThickness,2)),W=I.layer===0?1.1:I.layer===1?.85:.6,E=.35+(1-I.depth)*.65,J=fe*E*W*(.34+ie*.45);Ce.globalAlpha=J,Ce.lineWidth=I.width*(1+(1-I.depth)*.8);const X=[];for(let Q=0;Q<=M;Q+=1){const be=Q/M*L+x,K=(Oe(be*.012,I.seed)-.5)*Te.xJitter,ee=be+K,Le=(Oe(ee*I.freqA,I.seed)-.5)*Te.jitterA,Ve=(Oe(ee*I.freqB,I.seed*1.7)-.5)*Te.jitterB,Ke=Ye+Math.sin(ee*I.freqA+I.seed)*I.ampA+Math.sin(ee*I.freqB+I.seed*1.3)*I.ampB+ne+Le+Ve;X.push({x:ee,y:Ke})}Ce.beginPath(),Ce.moveTo(X[0].x,X[0].y);for(let Q=1;Q<X.length-1;Q+=1){const be=(X[Q].x+X[Q+1].x)/2,K=(X[Q].y+X[Q+1].y)/2;Ce.quadraticCurveTo(X[Q].x,X[Q].y,be,K)}const U=X[X.length-1];Ce.quadraticCurveTo(U.x,U.y,U.x,U.y),Ce.stroke()}Ce.save(),Ce.globalCompositeOperation="lighter",Ce.strokeStyle=Te.colors.glow,Ce.lineCap="round",Ce.lineJoin="round";for(let N=0;N<ze.length;N+=1){const I=ze[N];if(Math.abs(I.offset)*A>Te.crestThickness)continue;const ne=Te.glowAlpha*(.7+(1-I.depth)*.6);Ce.globalAlpha=ne,Ce.lineWidth=1.6+(1-I.depth)*1.2;const fe=[];for(let W=0;W<=M;W+=1){const E=W/M*L+x,J=Math.sin(E*.02+I.seed)*3,X=Ye+Math.sin(E*I.freqA+I.seed)*I.ampA+Math.sin(E*I.freqB+I.seed*1.3)*I.ampB+I.offset*A*.35+J;fe.push({x:E,y:X})}Ce.beginPath(),Ce.moveTo(fe[0].x,fe[0].y);for(let W=1;W<fe.length-1;W+=1){const E=(fe[W].x+fe[W+1].x)/2,J=(fe[W].y+fe[W+1].y)/2;Ce.quadraticCurveTo(fe[W].x,fe[W].y,E,J)}const ie=fe[fe.length-1];Ce.quadraticCurveTo(ie.x,ie.y,ie.x,ie.y),Ce.stroke()}Ce.restore()},Ge=()=>{Ie=Math.floor(V.clientWidth),Ae=Math.floor(V.clientHeight),$e=Math.floor(Ie*1.8),Ze=Ae,Pe=Ie<820?le:je,he.forEach(Ce=>{const ze=Ce.getContext("2d");if(!ze)return;Ce.width=Math.floor($e*se*Pe),Ce.height=Math.floor(Ze*se*Pe),Ce.style.width=`${$e}px`,Ce.style.height=`${Ze}px`,Ce.style.left=`${-($e-Ie)/2}px`,ze.setTransform(se*Pe,0,0,se*Pe,0,0);const Ye=Number(Ce.dataset.seed||1),A=_e(Ye);it(ze,A)})};return Ge(),window.addEventListener("resize",Ge,{passive:!0}),()=>window.removeEventListener("resize",Ge)},[m]);const He=C[Math.min(O,C.length-1)],me=p?He:C[C.length-1],R=(me==null?void 0:me.theme)??C[0].theme,ye={"--cogita-bg0":R.bg0,"--cogita-bg1":R.bg1,"--cogita-bg2":R.bg2,"--cogita-bloom":R.bloom,"--cogita-sat":R.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:f,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx($s,{value:S,onChange:c}),e.jsx(Rs,{copy:t,label:s,isAuthenticated:r,secureMode:w,onLogin:n,onProfileNavigate:o,onToggleSecureMode:u,onLogout:h,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:l,className:"cogita-section cogita-home",style:ye,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[m.map((V,he)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:V.style,"data-seed":V.seed,ref:Y=>{d.current[he]=Y}},V.id)),j.map(V=>e.jsx("div",{className:"cogita-home-wave",style:V.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},V.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(Pr,{slides:C,activeIndex:O,introOpen:p,prefersReducedMotion:B,onNext:ue,onPrev:Se,onSelect:de,onExit:$,onOpen:_,onRegister:Z})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const oo=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:Dr},Symbol.toStringTag,{value:"Module"})),Vs=a.createContext(!1);function Et({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,headerExtra:c,children:f}){if(a.useContext(Vs))return e.jsx(e.Fragment,{children:f});const d=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}w("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:d,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx($s,{value:v,onChange:S}),e.jsxs("div",{className:"cogita-header-right",children:[c,e.jsx(Rs,{copy:t,label:n,isAuthenticated:s,secureMode:h,onLogin:()=>w("home"),onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:f}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function ha(t){const[n,s]=a.useState("Cogita library"),[r,o]=a.useState(null);return a.useEffect(()=>{let u=!1;return Es().then(h=>{if(u)return;const w=h.find(v=>v.libraryId===t);w&&s(w.name)}).catch(()=>{u||s("Cogita library")}),()=>{u=!0}},[t]),a.useEffect(()=>{let u=!1;return nr(t).then(h=>{u||o(h)}).catch(()=>{u||o(null)}),()=>{u=!0}},[t]),{libraryName:n,stats:r}}function is({slices:t}){const n=t.reduce((r,o)=>r+Math.max(0,o.value),0),s=a.useMemo(()=>{if(n<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let r=0;return`conic-gradient(${t.map(u=>{const w=Math.max(0,u.value)/n*360,v=r,S=r+w;return r=S,`${u.color} ${v}deg ${S}deg`}).join(",")})`},[t,n]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:s}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(r=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:r.color}}),e.jsx("strong",{children:r.value}),e.jsx("small",{children:r.label})]},r.label))})]})}function _r({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,libraryId:c}){const{libraryName:f,stats:l}=ha(c),[d,j]=a.useState("infos"),[m,C]=a.useState(0),[O,b]=a.useState(0),[p,oe]=a.useState(0),B=(l==null?void 0:l.totalInfos)??0,y=(l==null?void 0:l.totalCollections)??0,q=0,k=0,Z=0,_=Math.max(0,B-Z-O),$=Math.max(0,B-O-p);a.useEffect(()=>{let ue=!1;return(async()=>{try{const He=await za({libraryId:c,limit:200}),me=await Promise.all(He.items.map(R=>qn({libraryId:c,collectionId:R.collectionId}).catch(()=>[])));if(ue)return;C(me.reduce((R,ye)=>R+ye.length,0))}catch{ue||C(0)}})(),()=>{ue=!0}},[c]),a.useEffect(()=>{let ue=!1;return(async()=>{try{const[He,me,R]=await Promise.all([as({libraryId:c,type:"computed",limit:1}).catch(()=>({total:0})),as({libraryId:c,type:"source",limit:1}).catch(()=>({total:0})),Un({libraryId:c}).catch(()=>({items:[]}))]);if(ue)return;b((He.total??0)+(me.total??0));const ye=new Set(R.items.filter(V=>V.childItemType.toLowerCase()==="info").map(V=>V.childItemId).filter(Boolean));oe(ye.size)}catch{ue||(b(0),oe(0))}})(),()=>{ue=!0}},[c]);const de=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:B},{key:"collections",label:t.cogita.library.overview.stats.collections,value:y},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:m},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:q},{key:"texts",label:t.cogita.library.overview.stats.texts,value:k}];return e.jsx(Et,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:f})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:de.map(ue=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${d===ue.key?"active":""}`,onClick:()=>j(ue.key),children:[e.jsx("span",{children:ue.label}),e.jsx("strong",{children:ue.value})]},ue.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),d==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(is,{slices:[{label:t.cogita.library.overview.known,value:Z,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:_,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:O,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(is,{slices:[{label:t.cogita.library.overview.availableChecks,value:p,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:$,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const nt=(t,n)=>{const s=t.cogita.library.infoTypes,r=t.cogita.library.connectionTypes,o=t.cogita.library.groupTypes;return{any:s.any,vocab:s.vocab,book:o.book,citation:o.citation,language:s.language,word:s.word,sentence:s.sentence,topic:s.topic,collection:s.collection,person:s.person,institution:s.institution,collective:s.collective,orcid:s.orcid,address:s.address,email:s.email,phone:s.phone,media:s.media,work:s.work,geo:s.geo,music_piece:s.musicPiece,music_fragment:s.musicFragment,source:s.source,question:s.question,computed:s.computed,"word-language":r.wordLanguage,"citation-language":r.citationLanguage,"language-sentence":r.languageSentence,translation:r.translation,"word-topic":r.wordTopic,reference:r.reference,"source-resource":r.sourceResource,"work-contributor":r.workContributor,"work-medium":r.workMedium,"orcid-link":r.orcidLink}[n]??String(n)},zr=t=>[{value:"any",label:nt(t,"any")},{value:"language",label:nt(t,"language")},{value:"word",label:nt(t,"word")},{value:"sentence",label:nt(t,"sentence")},{value:"topic",label:nt(t,"topic")},{value:"collection",label:nt(t,"collection")},{value:"person",label:nt(t,"person")},{value:"institution",label:nt(t,"institution")},{value:"collective",label:nt(t,"collective")},{value:"orcid",label:nt(t,"orcid")},{value:"address",label:nt(t,"address")},{value:"email",label:nt(t,"email")},{value:"phone",label:nt(t,"phone")},{value:"media",label:nt(t,"media")},{value:"work",label:nt(t,"work")},{value:"geo",label:nt(t,"geo")},{value:"music_piece",label:nt(t,"music_piece")},{value:"music_fragment",label:nt(t,"music_fragment")},{value:"source",label:nt(t,"source")},{value:"question",label:nt(t,"question")},{value:"citation",label:nt(t,"citation")},{value:"computed",label:nt(t,"computed")},{value:"vocab",label:nt(t,"vocab")},{value:"book",label:nt(t,"book")},{value:"word-language",label:nt(t,"word-language")},{value:"citation-language",label:nt(t,"citation-language")},{value:"language-sentence",label:nt(t,"language-sentence")},{value:"translation",label:nt(t,"translation")},{value:"word-topic",label:nt(t,"word-topic")},{value:"reference",label:nt(t,"reference")},{value:"source-resource",label:nt(t,"source-resource")},{value:"work-contributor",label:nt(t,"work-contributor")},{value:"work-medium",label:nt(t,"work-medium")},{value:"orcid-link",label:nt(t,"orcid-link")}],Br=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Nn={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},Or={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Nn]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Nn]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId"]},filterFields:[Nn,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text"],connections:[{relationType:"citation-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"citationText",kind:"text",path:"text",matcher:"contains"}]},question:{infoType:"question",entityKind:"single",structure:{payloadFields:["definition"]},filterFields:[{key:"questionType",labelKey:"type",kind:"text",path:"definition.type",matcher:"contains"},{key:"questionText",labelKey:"text",kind:"text",path:"definition.question",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},os={infoType:"default",entityKind:"single",structure:{payloadFields:["label"]},filterFields:[]};function Vr(t){return t?Or[t]??os:os}function qr(t,n){return t.optionsSource==="languages"?n.languages.map(s=>({value:s.infoId,label:s.label})):t.optionsSource==="sourceKinds"?Br:[]}const Ur="cogita.revision.seed:";function qs(t){return`${Ur}${t}`}function Jr(t,n){if(typeof window>"u")return null;const s=Array.from(new Set(n.map(u=>u.trim()).filter(Boolean)));if(!s.length)return null;const r=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,o={kind:"info-selection",libraryId:t,infoIds:s,createdAt:new Date().toISOString()};return window.localStorage.setItem(qs(r),JSON.stringify(o)),r}function ls(t,n){if(typeof window>"u")return null;const s=window.localStorage.getItem(qs(n));if(!s)return null;try{const r=JSON.parse(s);if(r.kind!=="info-selection"||r.libraryId!==t||!Array.isArray(r.infoIds))return null;const o=r.infoIds.map(u=>String(u??"").trim()).filter(Boolean);return o.length?{infoIds:o}:null}catch{return null}}const Hr="cogita.collection-draft:";function Us(t){return`${Hr}${t}`}function Wr(t,n){if(typeof window>"u")return null;const s=Array.from(new Set(n.map(u=>u.trim()).filter(Boolean)));if(!s.length)return null;const r=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,o={kind:"info-selection",libraryId:t,infoIds:s,createdAt:new Date().toISOString()};return window.localStorage.setItem(Us(r),JSON.stringify(o)),r}function Qr(t,n){if(typeof window>"u")return null;const s=window.localStorage.getItem(Us(n));if(!s)return null;try{const r=JSON.parse(s);if(r.kind!=="info-selection"||r.libraryId!==t||!Array.isArray(r.infoIds))return null;const o=r.infoIds.map(u=>String(u??"").trim()).filter(Boolean);return o.length?{infoIds:o}:null}catch{return null}}const Sn=60,Gr=500;function Js(t){return`cogita.info-selection:${t}`}function cs(t){if(typeof window>"u")return{};const n=window.localStorage.getItem(Js(t));if(!n)return{};try{const s=JSON.parse(n);return!s||typeof s!="object"?{}:s}catch{return{}}}function Yr({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,libraryId:c,mode:f}){var Bt;const l=dn(),d=Oa(),j=t.cogita.library.list,[m,C]=a.useState("any"),[O,b]=a.useState(""),[p,oe]=a.useState("relevance"),[B,y]=a.useState("details"),[q,k]=a.useState(!1),[Z,_]=a.useState("idle"),[$,de]=a.useState([]),[ue,Se]=a.useState(Sn),[He,me]=a.useState(null),[R,ye]=a.useState(()=>cs(c)),[V,he]=a.useState({}),[Y,je]=a.useState([]),[le,se]=a.useState([]),[Ie,Ae]=a.useState(null),[Pe,$e]=a.useState(null),[Ze,ot]=a.useState(null),[Te,We]=a.useState("idle"),[ft,Oe]=a.useState([]),[_e,et]=a.useState(""),[it,Ge]=a.useState(null),[Ce,ze]=a.useState("idle"),[Ye,A]=a.useState(null),[M,P]=a.useState(null),[L,x]=a.useState("idle"),[N,I]=a.useState([]),[ne,fe]=a.useState("idle"),ie=a.useMemo(()=>zr(t),[t]),W=a.useMemo(()=>[{value:"relevance",label:j.sortRelevance},{value:"label_asc",label:j.sortLabelAsc},{value:"label_desc",label:j.sortLabelDesc},{value:"type_asc",label:j.sortTypeAsc},{value:"type_desc",label:j.sortTypeDesc}],[j.sortLabelAsc,j.sortLabelDesc,j.sortRelevance,j.sortTypeAsc,j.sortTypeDesc]);a.useEffect(()=>{ye(cs(c)),he({}),k(!1)},[c]),a.useEffect(()=>{Un({libraryId:c}).then(i=>ot(i)).catch(()=>ot({items:[]}))},[c]),a.useEffect(()=>{sr({libraryId:c}).then(i=>Oe(i)).catch(()=>Oe([]))},[c]),a.useEffect(()=>{kn({libraryId:c,type:"language",filters:{sourceKind:"info"},limit:200}).then(i=>{const z=i.map(pe=>({infoId:pe.infoId??"",infoType:pe.entityType,label:pe.title})).filter(pe=>pe.infoId.length>0);je(z)}).catch(()=>je([]))},[c]),a.useEffect(()=>{kn({libraryId:c,type:"source",filters:{sourceKind:"info"},limit:200}).then(i=>{const z=i.map(pe=>({infoId:pe.infoId??"",infoType:pe.entityType,label:pe.title})).filter(pe=>pe.infoId.length>0);se(z)}).catch(()=>se([]))},[c]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(Js(c),JSON.stringify(R))},[c,R]);const E=a.useMemo(()=>Vr(m==="any"?null:m),[m]),J=a.useMemo(()=>new URLSearchParams(d.search),[d.search]),X=a.useMemo(()=>d.pathname.split("/").filter(Boolean),[d.pathname]),U=X.findIndex(i=>i==="infos"),Q=U>=0&&(X[U+1]??"").trim()||null,be=U>=0?(X[U+2]??"").trim():"",K=U>=0?be==="checkcards"?"cards":be==="collections"?"collections":"overview":"",ee=Q??((J.get("infoId")??"").trim()||null),Le=Q?K:(J.get("infoView")??"overview").trim(),Ve=Le==="overview"&&!!ee,Ke=Le==="collections"&&!!ee,Ue=a.useMemo(()=>({language:j.typeFilterLanguage,languageA:j.typeFilterLanguageA,languageB:j.typeFilterLanguageB,originalLanguage:j.typeFilterOriginalLanguage,doi:j.typeFilterDoi,sourceKind:j.typeFilterSourceKind,locator:j.typeFilterLocator,citationText:j.typeFilterCitationText}),[j.typeFilterDoi,j.typeFilterLanguage,j.typeFilterLanguageA,j.typeFilterLanguageB,j.typeFilterLocator,j.typeFilterOriginalLanguage,j.typeFilterCitationText,j.typeFilterSourceKind]),pt=a.useMemo(()=>E.filterFields.map(i=>({...i,label:i.labelKey?Ue[i.labelKey]:i.label??i.key,options:qr(i,{languages:Y})})),[Ue,Y,E.filterFields]),ht=a.useMemo(()=>pt.some(i=>(V[i.key]??"").trim().length>0),[pt,V]);a.useEffect(()=>{he({})},[m]),a.useEffect(()=>{const i={sourceKind:"info"};if(ht)for(const H of pt){const tt=(V[H.key]??"").trim();tt&&(i[H.path??H.key]=tt)}const z=(V.__referenceId??"").trim();z&&(i["link.references"]=z),_("loading");const pe=window.setTimeout(()=>{kn({libraryId:c,type:m==="any"?void 0:m,query:O.trim()||void 0,filters:i,limit:Gr}).then(H=>{const tt=H.map(lt=>({infoId:lt.infoId??"",infoType:lt.entityType,label:lt.title})).filter(lt=>lt.infoId.length>0);de(tt),_("ready")}).catch(()=>{de([]),_("ready")})},240);return()=>window.clearTimeout(pe)},[ht,c,O,m,pt,V]),a.useEffect(()=>{if(!ee||Le!=="overview"&&Le!=="collections"){Ae(null),$e(null),We("idle");return}let i=!1;return We("loading"),Promise.all([ua({libraryId:c,infoId:ee}),rr({libraryId:c,itemType:"info",itemId:ee}).catch(()=>null)]).then(([z,pe])=>{i||(Ae(z),$e(pe),We("ready"))}).catch(()=>{i||(Ae(null),$e(null),We("error"))}),()=>{i=!0}},[c,ee,Le]),a.useEffect(()=>{if(!ee||Le!=="collections"){I([]),fe("idle");return}let i=!1;return fe("loading"),ir({libraryId:c,infoId:ee}).then(z=>{i||(I(z),fe("ready"))}).catch(()=>{i||(I([]),fe("error"))}),()=>{i=!0}},[c,ee,Le]),a.useEffect(()=>{if(!ee||Le!=="overview"){A(null),P(null),x("idle");return}let i=!1;return x("loading"),Promise.all([Ya({libraryId:c,infoId:ee}),Xa({libraryId:c,infoId:ee})]).then(([z,pe])=>{i||(A(z),P(pe),x("ready"))}).catch(()=>{i||(A(null),P(null),x("error"))}),()=>{i=!0}},[c,ee,Le]);const gt=a.useMemo(()=>Ie?ft.filter(i=>i.sourceInfoTypes.some(z=>z.toLowerCase()===Ie.infoType.toLowerCase())):[],[ft,Ie]);a.useEffect(()=>{if(!Ie){et("");return}et(i=>{var z;return i&&gt.some(pe=>pe.approachKey===i)?i:((z=gt[0])==null?void 0:z.approachKey)??""})},[gt,Ie]),a.useEffect(()=>{if(!Ie||!_e){Ge(null),ze("idle");return}let i=!1;return ze("loading"),Ps({libraryId:c,infoId:Ie.infoId,approachKey:_e}).then(z=>{i||(Ge(z),ze("ready"))}).catch(()=>{i||(Ge(null),ze("error"))}),()=>{i=!0}},[c,_e,Ie]);const yt=a.useMemo(()=>{const i=$.slice(),z=pe=>nt(t,pe);return p==="relevance"?i:p==="label_asc"?i.sort((pe,H)=>pe.label.localeCompare(H.label)):p==="label_desc"?i.sort((pe,H)=>H.label.localeCompare(pe.label)):p==="type_asc"?i.sort((pe,H)=>pe.infoType===H.infoType?pe.label.localeCompare(H.label):z(pe.infoType).localeCompare(z(H.infoType))):i.sort((pe,H)=>pe.infoType===H.infoType?pe.label.localeCompare(H.label):z(H.infoType).localeCompare(z(pe.infoType)))},[t,$,p]),Ct=a.useMemo(()=>yt.slice(0,ue),[yt,ue]),zt=Ct.length<yt.length,At=a.useMemo(()=>new Set(Object.keys(R)),[R]),kt=a.useMemo(()=>Object.values(R),[R]),ma=a.useMemo(()=>{const i=new Map;for(const z of kt)i.set(z.infoType,(i.get(z.infoType)??0)+1);return Array.from(i.entries()).sort((z,pe)=>pe[1]-z[1]||z[0].localeCompare(pe[0]))},[kt]),Mt=a.useMemo(()=>{if(!ee||!Ze)return 0;const i=new Set;for(const z of Ze.items)z.childItemType!=="info"||z.childItemId!==ee||i.add([z.parentItemType,z.parentItemId,z.parentCheckType??"",z.parentDirection??""].join("|"));return i.size},[Ze,ee]);a.useEffect(()=>{Se(Sn);const i=new Set($.map(z=>z.infoId));me(z=>z&&i.has(z)?z:null)},[$]);const xt=i=>{ye(z=>({...z,[i.infoId]:{infoId:i.infoId,infoType:i.infoType,label:i.label}}))},Nt=i=>{ye(z=>{if(!z[i])return z;const pe={...z};return delete pe[i],pe})},vt=(i,z)=>{if(z){xt(i);return}Nt(i.infoId)},bt=i=>{l(`/cogita/library/${c}/infos/${encodeURIComponent(i)}`,{replace:!0})},Pt=()=>{l(`/cogita/library/${c}/list`,{replace:!0})},st=()=>{ee&&l(`/cogita/library/${c}/edit/${encodeURIComponent(ee)}`,{replace:!0})},qe=()=>{const i=Jr(c,kt.map(z=>z.infoId));i&&l(`/cogita/library/${c}/revision/run?libraryTarget=revisions&scope=info-selection&seed=${encodeURIComponent(i)}`)},mt=()=>{const i=Wr(c,kt.map(z=>z.infoId));i&&l(`/cogita/library/${c}/collections/new?draft=${encodeURIComponent(i)}&draftType=info-selection`)},Ht=kt.length===1?((Bt=kt[0])==null?void 0:Bt.infoId)??null:null,Ft=j.selectionCount.replace("{count}",String(kt.length)),Dt=f==="collection"?"grid":f==="detail"?"wide":B,re=Zr(v),Zt=Pe?Math.max(0,Math.min(100,Math.round((Pe.score??0)*100))):0,na=Pe?ei(Pe,re):re.noKnownnessData;return e.jsx(Et,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":Dt,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[Ve?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:re.kicker}),e.jsx("h2",{className:"cogita-card-title",children:Ie?ds(Ie.payload,Ie.infoType,Ie.infoId):re.loading}),Ie?e.jsxs("p",{className:"cogita-card-subtitle",children:[nt(t,Ie.infoType)," · ",Ie.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:Pt,children:re.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:st,disabled:!ee||Te!=="ready",children:j.editInfo})]})]}),Te==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:re.loading})}):Te==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:re.loadError})}):Ie?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:re.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[Zt,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${Zt}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:na})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:re.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(Pe==null?void 0:Pe.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:re.correct.replace("{correct}",String((Pe==null?void 0:Pe.correctReviews)??0)).replace("{total}",String((Pe==null?void 0:Pe.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:Pe!=null&&Pe.lastReviewedUtc?`${re.lastReview}: ${Xr(Pe.lastReviewedUtc,v)}`:re.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:re.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:Mt}),e.jsx("p",{className:"cogita-library-hint",children:re.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:re.checkcards}),L==="loading"?e.jsx("p",{className:"cogita-library-hint",children:re.loadingCheckcards}):L==="error"?e.jsx("p",{className:"cogita-library-hint",children:re.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:re.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(Ye==null?void 0:Ye.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:re.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(M==null?void 0:M.items.length)??0})]})]})]}),gt.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:re.approach}),e.jsx("select",{value:_e,onChange:i=>et(i.target.value),"aria-label":re.approach,children:gt.map(i=>e.jsx("option",{value:i.approachKey,children:i.label},i.approachKey))})]}),Ce==="loading"?e.jsx("p",{className:"cogita-library-hint",children:re.loadingApproach}):Ce==="error"?e.jsx("p",{className:"cogita-library-hint",children:re.loadApproachError}):it?e.jsx(en,{value:it.projection,emptyLabel:re.empty}):e.jsx("p",{className:"cogita-library-hint",children:re.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:re.payload}),e.jsx(en,{value:Ie.payload,emptyLabel:re.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:re.links}),e.jsx(ti,{links:Ie.links,emptyLabel:re.noLinks})]})]})]}):null]})}):null,Ke?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Informacja"}),e.jsx("h2",{className:"cogita-card-title",children:Ie?ds(Ie.payload,Ie.infoType,Ie.infoId):ee??""}),e.jsx("p",{className:"cogita-card-subtitle",children:"Collections using this info"})]}),e.jsx("div",{className:"cogita-info-overview-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:Pt,children:"Back to search"})})]}),ne==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading collections..."})}):null,ne==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load collections."})}):null,ne==="ready"&&N.length===0?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"This info is not used in any collection yet."})}):null,ne==="ready"&&N.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:N.map(i=>e.jsx("article",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`/#/cogita/library/${c}/collections/${i.collectionId}?libraryTarget=collections`,children:[e.jsx("div",{className:"cogita-card-type",children:"Collection"}),e.jsx("h3",{className:"cogita-card-title",children:i.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[i.itemCount," items"]})]})},i.collectionId))}):null]})}):null,!Ve&&!Ke?e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":j.typeLabel,value:m,onChange:i=>C(i.target.value),children:ie.map(i=>e.jsx("option",{value:i.value,children:i.label},i.value))}),e.jsx("input",{type:"text",value:O,onChange:i=>b(i.target.value),placeholder:j.searchPlaceholder}),e.jsx("select",{"aria-label":j.sortLabel,value:p,onChange:i=>oe(i.target.value),children:W.map(i=>e.jsx("option",{value:i.value,children:i.label},i.value))}),e.jsxs("select",{"aria-label":j.viewLabel,value:B,onChange:i=>y(i.target.value),children:[e.jsx("option",{value:"details",children:j.viewDetails}),e.jsx("option",{value:"wide",children:j.viewWide}),e.jsx("option",{value:"grid",children:j.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:j.cardCount.replace("{shown}",String(Ct.length)).replace("{total}",String(yt.length))}),e.jsx("span",{children:Z==="loading"?j.loading:j.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>k(i=>!i),children:q?j.hideFilters:j.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:j.filtersOptionalHint})]}),q?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsxs("div",{className:"cogita-filter-grid",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:j.typeLabel}),e.jsx("select",{value:m,onChange:i=>C(i.target.value),children:ie.map(i=>e.jsx("option",{value:i.value,children:i.label},`advanced-type:${i.value}`))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Reference"}),e.jsxs("select",{value:V.__referenceId??"",onChange:i=>he(z=>({...z,__referenceId:i.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),le.map(i=>e.jsx("option",{value:i.infoId,children:i.label},`reference:${i.infoId}`))]})]}),pt.map(i=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:i.label}),i.kind==="select"?e.jsxs("select",{value:V[i.key]??"",onChange:z=>he(pe=>({...pe,[i.key]:z.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(i.options??[]).map(z=>e.jsx("option",{value:z.value,children:z.label},`${i.key}:${z.value}`))]}):e.jsx("input",{type:"text",value:V[i.key]??"",onChange:z=>he(pe=>({...pe,[i.key]:z.target.value}))})]},`type-filter:${i.key}`))]})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:Ft}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{ye(i=>{const z={...i};for(const pe of Ct)z[pe.infoId]={infoId:pe.infoId,infoType:pe.infoType,label:pe.label};return z})},disabled:Ct.length===0,children:j.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>ye({}),disabled:kt.length===0,children:j.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ht&&bt(Ht),disabled:!Ht,title:Ht?void 0:j.openSelectedDisabled,children:j.openSelected})]})]}),Dt==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":j.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:j.detailColumnName}),e.jsx("span",{children:j.detailColumnType}),e.jsx("span",{children:j.detailColumnId}),e.jsx("span",{})]}),Ct.length?Ct.map(i=>{const z=nt(t,i.infoType),pe=At.has(i.infoId),H=He===i.infoId;return e.jsxs("div",{className:`cogita-details-row ${H||pe?"active":""}`,role:"row",onClick:()=>me(i.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:pe,onChange:tt=>vt(i,tt.target.checked),onClick:tt=>tt.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:i.label,children:i.label}),e.jsx("span",{title:z,children:z}),e.jsx("span",{title:i.infoId,children:i.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:tt=>{tt.stopPropagation(),bt(i.infoId)},"aria-label":j.editInfo,children:">"})]},i.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:j.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${Dt}`,"data-view":Dt,children:Ct.length?Ct.map(i=>{const z=nt(t,i.infoType),pe=At.has(i.infoId),H=He===i.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":H||pe,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:pe,onChange:tt=>vt(i,tt.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>me(i.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:z}),e.jsx("h3",{className:"cogita-card-title",children:i.label}),e.jsx("p",{className:"cogita-card-subtitle",children:i.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>bt(i.infoId),children:j.editInfo})]})},i.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:j.noMatch})})}),zt?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>Se(i=>i+Sn),children:j.loadMore})}):null,kt.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:j.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:j.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:ma.map(([i,z])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:nt(t,i)}),e.jsx("span",{className:"cogita-tag-count",children:z})]},`stack:type:${i}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:qe,disabled:kt.length===0,children:"Start revision"}),e.jsx("button",{type:"button",className:"ghost",onClick:mt,disabled:kt.length===0,children:"Create collection from selection"})]})]}):null]}):null]})})})})}function ds(t,n,s){if(t&&typeof t=="object"&&!Array.isArray(t)){const r=t,o=["title","name","label","value","text","quote","term"];for(const u of o){const h=r[u];if(typeof h=="string"&&h.trim())return h.trim()}}return`${n} · ${s}`}function Xr(t,n){try{const s=n==="pl"?"pl-PL":n==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(s,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function Zr(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function ei(t,n){return t.totalReviews<=0?n.noKnownnessData:t.totalReviews<3||t.score<.35?n.developmentStart:t.totalReviews<8||t.score<.65?n.developmentGrowing:t.score<.85?n.developmentStable:n.developmentStrong}function ti({links:t,emptyLabel:n}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([s,r])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(r)?r.length?e.jsx("div",{className:"cogita-selection-overview",children:r.map(o=>e.jsx("span",{className:"cogita-tag-chip",children:o},`${s}:${o}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):r?e.jsx("span",{className:"cogita-tag-chip",children:r}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},s))})}function en({value:t,emptyLabel:n}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:n});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((s,r)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(en,{value:s,emptyLabel:n})})]},r))});if(typeof t=="object"){const s=Object.entries(t);return s.length===0?e.jsx("p",{className:"cogita-library-hint",children:n}):e.jsx("div",{className:"cogita-info-tree",children:s.map(([r,o])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(en,{value:o,emptyLabel:n})})]},r))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const ja=5,us=50,hs=2,gs=[];function Gt({libraryId:t,infoType:n,label:s,placeholder:r,value:o,onChange:u,values:h,onChangeMultiple:w,helperText:v,searchFailedText:S,createFailedText:c,createLabel:f,savingLabel:l,loadMoreLabel:d,allowCreate:j=!0,inputRef:m,autoAdvance:C,onCommit:O,multiple:b}){const p=b?h??gs:gs,[oe,B]=a.useState(b?"":(o==null?void 0:o.label)??""),[y,q]=a.useState([]),[k,Z]=a.useState(ja),[_,$]=a.useState(-1),[de,ue]=a.useState(!1),[Se,He]=a.useState(!1),[me,R]=a.useState(null),ye=a.useRef(0),V=a.useRef(new Map),he=a.useMemo(()=>j?b?oe.trim().length>0:oe.trim().length>0&&!o:!1,[j,oe,o,b]);a.useEffect(()=>{b||B((o==null?void 0:o.label)??"")},[o,b]),a.useEffect(()=>{const le=oe.trim();if(!le||le.length<hs){q([]),ue(!1),Z(ja),$(-1),He(!1),R(null);return}const se=le.toLowerCase(),Ie=`${t}:${n}:${se}`,Ae=V.current.get(Ie);if(Ae){if(b&&p.length>0){const $e=new Set(p.map(Ze=>Ze.id));q(Ae.filter(Ze=>!$e.has(Ze.id)))}else q(Ae);Z(ja),$(-1),ue(Ae.length>0),He(!1),R(null);return}const Pe=window.setTimeout(async()=>{const $e=Date.now();ye.current=$e,He(!0),R(null);try{const Ze=await Jn({libraryId:t,type:n,query:le,limit:us});if(ye.current!==$e)return;const ot=Ze.slice(0,us).map(Te=>({id:Te.infoId,label:Te.label,infoType:Te.infoType}));if(V.current.set(Ie,ot),b&&p.length>0){const Te=new Set(p.map(We=>We.id));q(ot.filter(We=>!Te.has(We.id)))}else q(ot);Z(ja),$(-1),ue(!0)}catch{if(ye.current!==$e)return;R(S??"Search failed.")}finally{ye.current===$e&&He(!1)}},250);return()=>window.clearTimeout(Pe)},[t,n,oe,p]);const Y=le=>{if(b){const se=p.some(Ie=>Ie.id===le.id)?p:[...p,le];w==null||w(se),B(""),ue(!1),$(-1);return}u==null||u(le),B(le.label),ue(!1),$(-1),C&&(O==null||O())},je=async()=>{const le=oe.trim();if(le){He(!0),R(null);try{const se=await _n({libraryId:t,infoType:n,payload:{label:le}}),Ie={id:se.infoId,label:le,infoType:se.infoType};if(le.length>=hs){const Ae=`${t}:${n}:${le.toLowerCase()}`,Pe=V.current.get(Ae)??[];V.current.set(Ae,[Ie,...Pe])}if(b){w==null||w([...p,Ie]),B(""),ue(!1),$(-1);return}u==null||u(Ie),ue(!1),$(-1),C&&(O==null||O())}catch{R(c??"Create failed.")}finally{He(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:s}),e.jsx("input",{value:oe,placeholder:r,onChange:le=>{B(le.target.value),!b&&o&&(u==null||u(null))},onKeyDown:le=>{if(le.key==="ArrowDown"){if(le.preventDefault(),!y.length)return;ue(!0),$(se=>{const Ie=Math.min(y.length,k)-1,Ae=se<0?0:Math.min(se+1,Ie);return Ae===Ie&&y.length>k?(Z(Pe=>Math.min(Pe+ja,y.length)),Math.min(se+1,Math.min(y.length,k+ja)-1)):Ae});return}if(le.key==="ArrowUp"){if(le.preventDefault(),!y.length)return;ue(!0),$(se=>se<=0?0:se-1);return}if(le.key==="Enter"){if(le.preventDefault(),_>=0&&y[_]){Y(y[_]);return}if(he){je();return}}},onFocus:()=>{y.length>0&&ue(!0)},autoComplete:"off",ref:m})]}),b&&p.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:p.map(le=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>w==null?void 0:w(p.filter(se=>se.id!==le.id)),children:[le.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},le.id))}),v&&e.jsx("p",{className:"cogita-help",children:v}),me&&e.jsx("p",{className:"cogita-error",children:me}),de&&y.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[y.slice(0,k).map((le,se)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":se===_,onClick:()=>Y(le),children:[e.jsx("strong",{children:le.label}),e.jsx("span",{children:le.infoType})]},le.id)),k<y.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>Z(le=>Math.min(le+ja,y.length)),children:d??"Load more"})]}),he&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:je,disabled:Se,children:Se?l??"Saving...":f??`Create new ${n}`})]})}const ms=[{id:"gen",la:{abbr:"Gen",name:"Genesis"},en:{abbr:"Gen",name:"Genesis"},de:{abbr:"Gen",name:"Genesis"},pl:{abbr:"Rdz",name:"Księga Rodzaju"}},{id:"ex",la:{abbr:"Ex",name:"Exodus"},en:{abbr:"Ex",name:"Exodus"},de:{abbr:"Ex",name:"Exodus"},pl:{abbr:"Wj",name:"Księga Wyjścia"}},{id:"lev",la:{abbr:"Lev",name:"Leviticus"},en:{abbr:"Lev",name:"Leviticus"},de:{abbr:"Lev",name:"Levitikus"},pl:{abbr:"Kpł",name:"Księga Kapłańska"}},{id:"num",la:{abbr:"Num",name:"Numeri"},en:{abbr:"Num",name:"Numbers"},de:{abbr:"Num",name:"Numeri"},pl:{abbr:"Lb",name:"Księga Liczb"}},{id:"deut",la:{abbr:"Deut",name:"Deuteronomium"},en:{abbr:"Deut",name:"Deuteronomy"},de:{abbr:"Dtn",name:"Deuteronomium"},pl:{abbr:"Pwt",name:"Księga Powtórzonego Prawa"}},{id:"ios",la:{abbr:"Ios",name:"Iosue"},en:{abbr:"Josh",name:"Joshua"},de:{abbr:"Jos",name:"Josua"},pl:{abbr:"Joz",name:"Księga Jozuego"}},{id:"iudg",la:{abbr:"Iudg",name:"Iudicum"},en:{abbr:"Judg",name:"Judges"},de:{abbr:"Ri",name:"Richter"},pl:{abbr:"Sdz",name:"Księga Sędziów"}},{id:"ruth",la:{abbr:"Ruth",name:"Ruth"},en:{abbr:"Ruth",name:"Ruth"},de:{abbr:"Rut",name:"Rut"},pl:{abbr:"Rt",name:"Księga Rut"}},{id:"1sam",la:{abbr:"1 Sam",name:"I Samuelis"},en:{abbr:"1 Sam",name:"1 Samuel"},de:{abbr:"1 Sam",name:"1 Samuel"},pl:{abbr:"1 Sm",name:"1 Księga Samuela"}},{id:"2sam",la:{abbr:"2 Sam",name:"II Samuelis"},en:{abbr:"2 Sam",name:"2 Samuel"},de:{abbr:"2 Sam",name:"2 Samuel"},pl:{abbr:"2 Sm",name:"2 Księga Samuela"}},{id:"1reg",la:{abbr:"1 Reg",name:"I Regum"},en:{abbr:"1 Kgs",name:"1 Kings"},de:{abbr:"1 Kön",name:"1 Könige"},pl:{abbr:"1 Krl",name:"1 Księga Królewska"}},{id:"2reg",la:{abbr:"2 Reg",name:"II Regum"},en:{abbr:"2 Kgs",name:"2 Kings"},de:{abbr:"2 Kön",name:"2 Könige"},pl:{abbr:"2 Krl",name:"2 Księga Królewska"}},{id:"1par",la:{abbr:"1 Par",name:"I Paralipomenon"},en:{abbr:"1 Chr",name:"1 Chronicles"},de:{abbr:"1 Chr",name:"1 Chronik"},pl:{abbr:"1 Krn",name:"1 Księga Kronik"}},{id:"2par",la:{abbr:"2 Par",name:"II Paralipomenon"},en:{abbr:"2 Chr",name:"2 Chronicles"},de:{abbr:"2 Chr",name:"2 Chronik"},pl:{abbr:"2 Krn",name:"2 Księga Kronik"}},{id:"esd",la:{abbr:"Esd",name:"Esdrae"},en:{abbr:"Ezra",name:"Ezra"},de:{abbr:"Esra",name:"Esra"},pl:{abbr:"Ezd",name:"Księga Ezdrasza"}},{id:"neh",la:{abbr:"Neh",name:"Nehemiae"},en:{abbr:"Neh",name:"Nehemiah"},de:{abbr:"Neh",name:"Nehemia"},pl:{abbr:"Ne",name:"Księga Nehemiasza"}},{id:"tob",la:{abbr:"Tob",name:"Tobiae"},en:{abbr:"Tob",name:"Tobit"},de:{abbr:"Tob",name:"Tobit"},pl:{abbr:"Tb",name:"Księga Tobiasza"}},{id:"iudt",la:{abbr:"Iudt",name:"Iudith"},en:{abbr:"Jdt",name:"Judith"},de:{abbr:"Jdt",name:"Judit"},pl:{abbr:"Jdt",name:"Księga Judyty"}},{id:"est",la:{abbr:"Est",name:"Esther"},en:{abbr:"Est",name:"Esther"},de:{abbr:"Est",name:"Ester"},pl:{abbr:"Est",name:"Księga Estery"}},{id:"1macc",la:{abbr:"1 Macc",name:"I Maccabaeorum"},en:{abbr:"1 Mc",name:"1 Maccabees"},de:{abbr:"1 Makk",name:"1 Makkabäer"},pl:{abbr:"1 Mch",name:"1 Księga Machabejska"}},{id:"2macc",la:{abbr:"2 Macc",name:"II Maccabaeorum"},en:{abbr:"2 Mc",name:"2 Maccabees"},de:{abbr:"2 Makk",name:"2 Makkabäer"},pl:{abbr:"2 Mch",name:"2 Księga Machabejska"}},{id:"iob",la:{abbr:"Iob",name:"Iob"},en:{abbr:"Job",name:"Job"},de:{abbr:"Ijob",name:"Ijob"},pl:{abbr:"Hi",name:"Księga Hioba"}},{id:"ps",la:{abbr:"Ps",name:"Psalmi"},en:{abbr:"Ps",name:"Psalms"},de:{abbr:"Ps",name:"Psalmen"},pl:{abbr:"Ps",name:"Księga Psalmów"}},{id:"prov",la:{abbr:"Prov",name:"Proverbia"},en:{abbr:"Prov",name:"Proverbs"},de:{abbr:"Spr",name:"Sprichwörter"},pl:{abbr:"Prz",name:"Księga Przysłów"}},{id:"ecc",la:{abbr:"Ecc",name:"Ecclesiastes"},en:{abbr:"Eccl",name:"Ecclesiastes"},de:{abbr:"Koh",name:"Kohelet"},pl:{abbr:"Koh",name:"Księga Koheleta"}},{id:"cant",la:{abbr:"Cant",name:"Canticum Canticorum"},en:{abbr:"Song",name:"Song of Songs"},de:{abbr:"Hld",name:"Hoheslied"},pl:{abbr:"Pnp",name:"Pieśń nad Pieśniami"}},{id:"sap",la:{abbr:"Sap",name:"Sapientia"},en:{abbr:"Wis",name:"Wisdom"},de:{abbr:"Weish",name:"Weisheit"},pl:{abbr:"Mdr",name:"Księga Mądrości"}},{id:"sir",la:{abbr:"Sir",name:"Ecclesiasticus (Sirach)"},en:{abbr:"Sir",name:"Sirach"},de:{abbr:"Sir",name:"Jesus Sirach"},pl:{abbr:"Syr",name:"Mądrość Syracha"}},{id:"isa",la:{abbr:"Isa",name:"Isaias"},en:{abbr:"Isa",name:"Isaiah"},de:{abbr:"Jes",name:"Jesaja"},pl:{abbr:"Iz",name:"Księga Izajasza"}},{id:"ier",la:{abbr:"Ier",name:"Ieremias"},en:{abbr:"Jer",name:"Jeremiah"},de:{abbr:"Jer",name:"Jeremia"},pl:{abbr:"Jr",name:"Księga Jeremiasza"}},{id:"lam",la:{abbr:"Lam",name:"Lamentationes"},en:{abbr:"Lam",name:"Lamentations"},de:{abbr:"Klgl",name:"Klagelieder"},pl:{abbr:"Lm",name:"Lamentacje"}},{id:"bar",la:{abbr:"Bar",name:"Baruch"},en:{abbr:"Bar",name:"Baruch"},de:{abbr:"Bar",name:"Baruch"},pl:{abbr:"Ba",name:"Księga Barucha"}},{id:"ez",la:{abbr:"Ez",name:"Ezechiel"},en:{abbr:"Ezek",name:"Ezekiel"},de:{abbr:"Ez",name:"Ezechiel"},pl:{abbr:"Ez",name:"Księga Ezechiela"}},{id:"dan",la:{abbr:"Dan",name:"Daniel"},en:{abbr:"Dan",name:"Daniel"},de:{abbr:"Dan",name:"Daniel"},pl:{abbr:"Dn",name:"Księga Daniela"}},{id:"hos",la:{abbr:"Hos",name:"Osee"},en:{abbr:"Hos",name:"Hosea"},de:{abbr:"Hos",name:"Hosea"},pl:{abbr:"Oz",name:"Księga Ozeasza"}},{id:"ioel",la:{abbr:"Ioel",name:"Ioel"},en:{abbr:"Joel",name:"Joel"},de:{abbr:"Joel",name:"Joel"},pl:{abbr:"Jl",name:"Księga Joela"}},{id:"amos",la:{abbr:"Amos",name:"Amos"},en:{abbr:"Am",name:"Amos"},de:{abbr:"Am",name:"Amos"},pl:{abbr:"Am",name:"Księga Amosa"}},{id:"abd",la:{abbr:"Abd",name:"Abdias"},en:{abbr:"Obad",name:"Obadiah"},de:{abbr:"Obd",name:"Obadja"},pl:{abbr:"Abd",name:"Księga Abdiasza"}},{id:"ion",la:{abbr:"Ion",name:"Ionas"},en:{abbr:"Jon",name:"Jonah"},de:{abbr:"Jona",name:"Jona"},pl:{abbr:"Jon",name:"Księga Jonasza"}},{id:"mich",la:{abbr:"Mich",name:"Michaeas"},en:{abbr:"Mic",name:"Micah"},de:{abbr:"Mi",name:"Micha"},pl:{abbr:"Mi",name:"Księga Micheasza"}},{id:"nah",la:{abbr:"Nah",name:"Nahum"},en:{abbr:"Nah",name:"Nahum"},de:{abbr:"Nah",name:"Nahum"},pl:{abbr:"Na",name:"Księga Nahuma"}},{id:"hab",la:{abbr:"Hab",name:"Habacuc"},en:{abbr:"Hab",name:"Habakkuk"},de:{abbr:"Hab",name:"Habakuk"},pl:{abbr:"Ha",name:"Księga Habakuka"}},{id:"soph",la:{abbr:"Soph",name:"Sophonias"},en:{abbr:"Zeph",name:"Zephaniah"},de:{abbr:"Zef",name:"Zefanja"},pl:{abbr:"So",name:"Księga Sofoniasza"}},{id:"agg",la:{abbr:"Agg",name:"Aggaeus"},en:{abbr:"Hag",name:"Haggai"},de:{abbr:"Hag",name:"Haggai"},pl:{abbr:"Ag",name:"Księga Aggeusza"}},{id:"zach",la:{abbr:"Zach",name:"Zacharias"},en:{abbr:"Zech",name:"Zechariah"},de:{abbr:"Sach",name:"Sacharja"},pl:{abbr:"Za",name:"Księga Zachariasza"}},{id:"mal",la:{abbr:"Mal",name:"Malachias"},en:{abbr:"Mal",name:"Malachi"},de:{abbr:"Mal",name:"Maleachi"},pl:{abbr:"Ml",name:"Księga Malachiasza"}},{id:"mt",la:{abbr:"Mt",name:"Matthaeus"},en:{abbr:"Matt",name:"Matthew"},de:{abbr:"Mt",name:"Matthäus"},pl:{abbr:"Mt",name:"Ewangelia wg św. Mateusza"}},{id:"mc",la:{abbr:"Mc",name:"Marcus"},en:{abbr:"Mark",name:"Mark"},de:{abbr:"Mk",name:"Markus"},pl:{abbr:"Mk",name:"Ewangelia wg św. Marka"}},{id:"lc",la:{abbr:"Lc",name:"Lucas"},en:{abbr:"Luke",name:"Luke"},de:{abbr:"Lk",name:"Lukas"},pl:{abbr:"Łk",name:"Ewangelia wg św. Łukasza"}},{id:"io",la:{abbr:"Io",name:"Ioannes"},en:{abbr:"John",name:"John"},de:{abbr:"Joh",name:"Johannes"},pl:{abbr:"J",name:"Ewangelia wg św. Jana"}},{id:"act",la:{abbr:"Act",name:"Actus Apostolorum"},en:{abbr:"Acts",name:"Acts"},de:{abbr:"Apg",name:"Apostelgeschichte"},pl:{abbr:"Dz",name:"Dzieje Apostolskie"}},{id:"rom",la:{abbr:"Rom",name:"ad Romanos"},en:{abbr:"Rom",name:"Romans"},de:{abbr:"Röm",name:"Römer"},pl:{abbr:"Rz",name:"List do Rzymian"}},{id:"1cor",la:{abbr:"1 Cor",name:"I ad Corinthios"},en:{abbr:"1 Cor",name:"1 Corinthians"},de:{abbr:"1 Kor",name:"1 Korinther"},pl:{abbr:"1 Kor",name:"1 List do Koryntian"}},{id:"2cor",la:{abbr:"2 Cor",name:"II ad Corinthios"},en:{abbr:"2 Cor",name:"2 Corinthians"},de:{abbr:"2 Kor",name:"2 Korinther"},pl:{abbr:"2 Kor",name:"2 List do Koryntian"}},{id:"gal",la:{abbr:"Gal",name:"ad Galatas"},en:{abbr:"Gal",name:"Galatians"},de:{abbr:"Gal",name:"Galater"},pl:{abbr:"Ga",name:"List do Galatów"}},{id:"eph",la:{abbr:"Eph",name:"ad Ephesios"},en:{abbr:"Eph",name:"Ephesians"},de:{abbr:"Eph",name:"Epheser"},pl:{abbr:"Ef",name:"List do Efezjan"}},{id:"phil",la:{abbr:"Phil",name:"ad Philippenses"},en:{abbr:"Phil",name:"Philippians"},de:{abbr:"Phil",name:"Philipper"},pl:{abbr:"Flp",name:"List do Filipian"}},{id:"col",la:{abbr:"Col",name:"ad Colossenses"},en:{abbr:"Col",name:"Colossians"},de:{abbr:"Kol",name:"Kolosser"},pl:{abbr:"Kol",name:"List do Kolosan"}},{id:"1thess",la:{abbr:"1 Thess",name:"I ad Thessalonicenses"},en:{abbr:"1 Thess",name:"1 Thessalonians"},de:{abbr:"1 Thess",name:"1 Thessalonicher"},pl:{abbr:"1 Tes",name:"1 List do Tesaloniczan"}},{id:"2thess",la:{abbr:"2 Thess",name:"II ad Thessalonicenses"},en:{abbr:"2 Thess",name:"2 Thessalonians"},de:{abbr:"2 Thess",name:"2 Thessalonicher"},pl:{abbr:"2 Tes",name:"2 List do Tesaloniczan"}},{id:"1tim",la:{abbr:"1 Tim",name:"I ad Timotheum"},en:{abbr:"1 Tim",name:"1 Timothy"},de:{abbr:"1 Tim",name:"1 Timotheus"},pl:{abbr:"1 Tm",name:"1 List do Tymoteusza"}},{id:"2tim",la:{abbr:"2 Tim",name:"II ad Timotheum"},en:{abbr:"2 Tim",name:"2 Timothy"},de:{abbr:"2 Tim",name:"2 Timotheus"},pl:{abbr:"2 Tm",name:"2 List do Tymoteusza"}},{id:"tit",la:{abbr:"Tit",name:"ad Titum"},en:{abbr:"Titus",name:"Titus"},de:{abbr:"Tit",name:"Titus"},pl:{abbr:"Tt",name:"List do Tytusa"}},{id:"phlm",la:{abbr:"Phlm",name:"ad Philemonem"},en:{abbr:"Phlm",name:"Philemon"},de:{abbr:"Phlm",name:"Philemon"},pl:{abbr:"Flm",name:"List do Filemona"}},{id:"heb",la:{abbr:"Heb",name:"ad Hebraeos"},en:{abbr:"Heb",name:"Hebrews"},de:{abbr:"Hebr",name:"Hebräer"},pl:{abbr:"Hbr",name:"List do Hebrajczyków"}},{id:"iac",la:{abbr:"Iac",name:"Iacobi"},en:{abbr:"Jas",name:"James"},de:{abbr:"Jak",name:"Jakobus"},pl:{abbr:"Jk",name:"List św. Jakuba"}},{id:"1pet",la:{abbr:"1 Pet",name:"I Petri"},en:{abbr:"1 Pet",name:"1 Peter"},de:{abbr:"1 Petr",name:"1 Petrus"},pl:{abbr:"1 P",name:"1 List św. Piotra"}},{id:"2pet",la:{abbr:"2 Pet",name:"II Petri"},en:{abbr:"2 Pet",name:"2 Peter"},de:{abbr:"2 Petr",name:"2 Petrus"},pl:{abbr:"2 P",name:"2 List św. Piotra"}},{id:"1io",la:{abbr:"1 Io",name:"I Ioannis"},en:{abbr:"1 John",name:"1 John"},de:{abbr:"1 Joh",name:"1 Johannes"},pl:{abbr:"1 J",name:"1 List św. Jana"}},{id:"2io",la:{abbr:"2 Io",name:"II Ioannis"},en:{abbr:"2 John",name:"2 John"},de:{abbr:"2 Joh",name:"2 Johannes"},pl:{abbr:"2 J",name:"2 List św. Jana"}},{id:"3io",la:{abbr:"3 Io",name:"III Ioannis"},en:{abbr:"3 John",name:"3 John"},de:{abbr:"3 Joh",name:"3 Johannes"},pl:{abbr:"3 J",name:"3 List św. Jana"}},{id:"iud",la:{abbr:"Iud",name:"Iudae"},en:{abbr:"Jude",name:"Jude"},de:{abbr:"Jud",name:"Judas"},pl:{abbr:"Jud",name:"List św. Judy"}},{id:"apoc",la:{abbr:"Apoc",name:"Apocalypsis Ioannis"},en:{abbr:"Rev",name:"Revelation"},de:{abbr:"Offb",name:"Offenbarung"},pl:{abbr:"Ap",name:"Apokalipsa św. Jana"}}],ps=8;function fs({libraryId:t,copy:n,language:s,sourceKindOptions:r,value:o,onChange:u,labels:h}){const[w,v]=a.useState(!1),[S,c]=a.useState(-1),f=a.useMemo(()=>{const m=s;return ms.map(C=>{var p;const O=(C==null?void 0:C[m])??(C==null?void 0:C.en)??(C==null?void 0:C.la);return{label:`${O.abbr} — ${O.name}`,latin:((p=C==null?void 0:C.la)==null?void 0:p.abbr)??O.abbr}})},[s]),l=(m,C=!1)=>{const O=m.trim().toLowerCase();return O?f.filter(b=>b.label.toLowerCase().includes(O)).slice(0,ps):C?f.slice(0,ps):[]},d=(m,C)=>{const O=m.trim().toLowerCase();if(!O)return null;const b=ms;for(const p of b){const oe=p==null?void 0:p.la,B=(p==null?void 0:p[C])??(p==null?void 0:p.en)??oe,y=(B==null?void 0:B.abbr)??"",q=(B==null?void 0:B.name)??"";if(y.toLowerCase()===O||q.toLowerCase()===O||`${y} — ${q}`.toLowerCase()===O)return{book:p,entry:B,la:oe}}return null};a.useEffect(()=>{if(o.sourceKind==="bible"&&o.locatorValue&&!w){const m=d(o.locatorValue,s);if(m){const C=`${m.entry.abbr} — ${m.entry.name}`;C!==o.bibleBookDisplay&&u({...o,bibleBookDisplay:C})}}},[s,o,w,u]);const j=m=>u({...o,...m});return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.sourceKindLabel}),e.jsx("select",{value:o.sourceKind,onChange:m=>j({sourceKind:m.target.value,churchDocument:null,bookMedia:null,work:null,locatorValue:"",locatorAux:"",bibleBookDisplay:""}),children:r.map(m=>e.jsx("option",{value:m.value,children:m.label},m.value))})]}),o.sourceKind==="bible"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-lookup full",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.bibleBookLabel}),e.jsx("input",{type:"text",value:o.bibleBookDisplay,onChange:m=>{const C=m.target.value;j({bibleBookDisplay:C,locatorValue:""}),v(!0),c(-1)},onKeyDown:m=>{var O;const C=l(o.bibleBookDisplay);if(C.length){if(m.key==="ArrowDown")m.preventDefault(),c(b=>Math.min(b+1,C.length-1));else if(m.key==="ArrowUp")m.preventDefault(),c(b=>Math.max(b-1,0));else if((m.key==="Enter"||m.key==="Tab")&&S>=0&&C[S]){const b=C[S],p=d(b.label,s);if(!p)return;j({bibleBookDisplay:b.label,locatorValue:((O=p.la)==null?void 0:O.abbr)??o.locatorValue}),v(!1)}}},onFocus:()=>v(!0),onBlur:()=>window.setTimeout(()=>v(!1),100),placeholder:h.bibleBookPlaceholder})]}),w&&l(o.bibleBookDisplay,!0).length>0&&e.jsx("div",{className:"cogita-lookup-results",children:l(o.bibleBookDisplay,!0).map((m,C)=>e.jsx("button",{type:"button",className:"cogita-lookup-option","data-active":C===S,tabIndex:-1,onMouseDown:()=>{var b;const O=d(m.label,s);O&&j({bibleBookDisplay:m.label,locatorValue:((b=O.la)==null?void 0:b.abbr)??o.locatorValue})},children:e.jsx("strong",{children:m.label})},m.latin))})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.bibleRestLabel}),e.jsx("input",{type:"text",value:o.locatorAux,onChange:m=>j({locatorAux:m.target.value}),placeholder:h.bibleRestPlaceholder})]})]}),o.sourceKind==="website"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceUrlLabel}),e.jsx("input",{type:"text",value:o.sourceUrl,onChange:m=>j({sourceUrl:m.target.value}),placeholder:n.cogita.library.add.info.sourceUrlPlaceholder})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:n.cogita.library.add.info.sourceAccessedDateLabel}),e.jsx("input",{type:"text",value:o.sourceAccessedDate,onChange:m=>j({sourceAccessedDate:m.target.value}),placeholder:n.cogita.library.add.info.sourceAccessedDatePlaceholder})]})]}),o.sourceKind==="number_document"&&e.jsxs(e.Fragment,{children:[e.jsx(Gt,{libraryId:t,infoType:"work",label:h.churchDocumentLabel,placeholder:h.churchDocumentPlaceholder,value:o.churchDocument,onChange:m=>j({churchDocument:m}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.locatorLabel}),e.jsx("input",{type:"text",value:o.locatorValue,onChange:m=>j({locatorValue:m.target.value}),placeholder:h.locatorPlaceholder})]})]}),o.sourceKind==="work"&&e.jsx(Gt,{libraryId:t,infoType:"work",label:h.workLabel,placeholder:h.workPlaceholder,value:o.work,onChange:m=>j({work:m}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.work),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),o.sourceKind==="book"&&e.jsxs(e.Fragment,{children:[e.jsx(Gt,{libraryId:t,infoType:"media",label:h.bookLabel,placeholder:h.bookPlaceholder,value:o.bookMedia,onChange:m=>j({bookMedia:m}),searchFailedText:n.cogita.library.lookup.searchFailed,createFailedText:n.cogita.library.lookup.createFailed,createLabel:n.cogita.library.lookup.createNew.replace("{type}",n.cogita.library.infoTypes.media),savingLabel:n.cogita.library.lookup.saving,loadMoreLabel:n.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.locatorLabel}),e.jsx("input",{type:"text",value:o.locatorValue,onChange:m=>j({locatorValue:m.target.value}),placeholder:h.locatorPlaceholder})]})]}),o.sourceKind!=="website"&&o.sourceKind!=="bible"&&o.sourceKind!=="book"&&o.sourceKind!=="number_document"&&e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.locatorLabel}),e.jsx("input",{type:"text",value:o.locatorValue,onChange:m=>j({locatorValue:m.target.value}),placeholder:h.locatorPlaceholder})]})]})}const Pa=JSON.stringify({type:"selection",title:"Question title",question:"Question text",options:["Option A","Option B","Option C"],answer:[0]},null,2);function Ha(t="selection"){return t==="matching"?{type:t,title:"",question:"",columns:[[""],[""]],answer:{paths:[]},matchingPaths:[["",""]]}:t==="ordering"?{type:t,title:"",question:"",options:[""]}:t==="truefalse"?{type:t,title:"",question:"",answer:!0}:t==="text"||t==="date"?{type:t,title:"",question:"",answer:""}:t==="number"?{type:t,title:"",question:"",answer:""}:{type:t,title:"",question:"",options:[""],answer:[]}}function ai(t){return["selection","truefalse","text","number","date","matching","ordering"].includes(t)}function Fa(t){if(!t||typeof t!="object")return null;const n=t,s=typeof n.type=="string"?n.type:typeof n.kind=="string"?n.kind:"selection",r=s==="multi_select"||s==="single_select"?"selection":s==="boolean"?"truefalse":s==="order"?"ordering":s,o=ai(r)?r:"selection",u=typeof n.title=="string"?n.title:"",h=typeof n.question=="string"?n.question:"";if(o==="matching"){let S=[];Array.isArray(n.columns)?S=n.columns.map(m=>Array.isArray(m)?m.map(C=>typeof C=="string"?C:""):[""]):Array.isArray(n.left)&&Array.isArray(n.right)&&(S=[n.left.map(m=>typeof m=="string"?m:""),n.right.map(m=>typeof m=="string"?m:"")]),S.length<2&&(S=[[""],[""]]);const c=n.answer&&typeof n.answer=="object"?n.answer:null,l=(Array.isArray(c==null?void 0:c.paths)?c==null?void 0:c.paths:Array.isArray(n.correctPairs)?n.correctPairs:[]).map(m=>Array.isArray(m)?m.map(C=>Number(C)).filter(C=>Number.isInteger(C)&&C>=0):[]).filter(m=>m.length>0),d=Array.isArray(n.matchingPaths)?n.matchingPaths.map(m=>Array.isArray(m)?Array.from({length:S.length},(C,O)=>String(m[O]??"")):new Array(S.length).fill("")):null,j=d&&d.length>0?d:[...l.map(m=>m.map(String)),new Array(S.length).fill("")];return{type:o,title:u,question:h,columns:S,answer:{paths:l},matchingPaths:j}}if(o==="ordering"){const S=Array.isArray(n.options)?n.options.map(c=>typeof c=="string"?c:""):Array.isArray(n.items)?n.items.map(c=>typeof c=="string"?c:""):[""];return{type:o,title:u,question:h,options:S.length?S:[""]}}if(o==="truefalse"){const S=typeof n.answer=="boolean"?n.answer:typeof n.expected=="boolean"?n.expected:!0;return{type:o,title:u,question:h,answer:S}}if(o==="number")return typeof n.answer=="number"?{type:o,title:u,question:h,answer:n.answer}:typeof n.answer=="string"?{type:o,title:u,question:h,answer:n.answer}:typeof n.expected=="number"?{type:o,title:u,question:h,answer:n.expected}:{type:o,title:u,question:h,answer:""};if(o==="text"||o==="date"){const S=typeof n.answer=="string"?n.answer:typeof n.expected=="string"?n.expected:"";return{type:o,title:u,question:h,answer:S}}const w=Array.isArray(n.options)?n.options.map(S=>typeof S=="string"?S:""):[""],v=Array.isArray(n.answer)?n.answer.map(S=>Number(S)).filter(S=>Number.isInteger(S)&&S>=0):Array.isArray(n.correct)?n.correct.map(S=>Number(S)).filter(S=>Number.isInteger(S)&&S>=0):[];return{type:o,title:u,question:h,options:w.length?w:[""],answer:v}}function ni(t){const n=(t.title??"").trim(),s=(t.question??"").trim();switch(t.type){case"matching":{const r=(t.columns??[[""],[""]]).map(f=>f.map(l=>l.trim()).filter(Boolean)).filter(f=>f.length>0),o=r.length>=2?r:[[""],[""]],u=t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[],h=(t.matchingPaths??[]).map(f=>f.map(l=>String(l??""))),w=o.length,v=h.map(f=>f.slice(0,w).map(l=>l.trim())).filter(f=>f.some(Boolean)).map(f=>f.map(l=>Number(l))).filter(f=>f.length===w&&f.every(l=>Number.isInteger(l)&&l>=0)),S=(Array.isArray(u)?u:[]).map(f=>Array.isArray(f)?f.map(l=>Number(l)).filter(l=>Number.isInteger(l)&&l>=0):[]).filter(f=>f.length===w),c=Array.from(new Set([...S,...v].map(f=>JSON.stringify(f)))).map(f=>JSON.parse(f));return JSON.stringify({type:t.type,...n?{title:n}:{},question:s,columns:o,answer:{paths:c}},null,2)}case"ordering":{const r=(t.options??[]).map(o=>o.trim()).filter(Boolean);return JSON.stringify({type:t.type,...n?{title:n}:{},question:s,options:r},null,2)}case"truefalse":return JSON.stringify({type:t.type,...n?{title:n}:{},question:s,answer:!!t.answer},null,2);case"number":return JSON.stringify({type:t.type,...n?{title:n}:{},question:s,answer:typeof t.answer=="number"||typeof t.answer=="string"?t.answer:""},null,2);case"date":case"text":return JSON.stringify({type:t.type,...n?{title:n}:{},question:s,answer:String(t.answer??"")},null,2);case"selection":default:{const r=(t.options??[]).map(h=>h.trim()).filter(Boolean),o=Array.isArray(t.answer)?t.answer:[],u=Array.from(new Set(o.filter(h=>Number.isInteger(h)&&h>=0&&h<r.length))).sort((h,w)=>h-w);return JSON.stringify({type:t.type,...n?{title:n}:{},question:s,options:r,answer:u},null,2)}}}const bs=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}];function Da(){return{sourceKind:"string",locatorValue:"",locatorAux:"",bibleBookDisplay:"",sourceUrl:"",sourceAccessedDate:"",churchDocument:null,bookMedia:null,work:null}}function ys(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function xs(t,n){if(!t||typeof t!="object")return n;const s=t,r=s.definition&&typeof s.definition=="object"?s.definition:null,o=[s.label,s.name,s.title,s.text,s.orcid,s.email,s.number];r&&o.unshift(r.title,r.question);for(const u of o)if(typeof u=="string"&&u.trim())return u.trim();return n}function vs(t,n){var r;if(!(t instanceof Fs))return n;const s=(r=t.message)==null?void 0:r.trim();if(!s)return n;try{const o=JSON.parse(s);if(typeof o.error=="string"&&o.error.trim())return o.error.trim()}catch{}return s}function si(t){const n=t.trim();if(!n)return null;try{const s=JSON.parse(n);return s&&typeof s=="object"&&!Array.isArray(s)?s:null}catch{return null}}function oa(t,n){const s=t==null?void 0:t[n];return typeof s=="string"?s:""}function ri(t,n){return n?t==="book"&&n.infoType==="media"?{bookMedia:n}:t==="work"&&n.infoType==="work"?{work:n}:t==="number_document"&&n.infoType==="work"?{churchDocument:n}:{}:{}}function ii(t,n){const s=Da(),r=(t.sourceKind??"").trim()||s.sourceKind,o=t.locator??"",u=si(o);let h="",w="",v="",S="",c="";return r==="website"?(S=oa(u,"url"),c=oa(u,"accessedDate"),h=oa(u,"value")):r==="bible"?(h=oa(u,"book")||o.trim(),w=oa(u,"passage")||oa(u,"rest"),v=oa(u,"bookDisplay")):u?(h=oa(u,"value")||oa(u,"locator"),w=oa(u,"aux")):h=o,{...s,sourceKind:r,locatorValue:h,locatorAux:w,bibleBookDisplay:v,sourceUrl:S,sourceAccessedDate:c,...ri(r,n)}}function Tn(t){return t.sourceKind==="book"?t.bookMedia:t.sourceKind==="work"?t.work:t.sourceKind==="number_document"?t.churchDocument:null}function Cn(t){const n=t.locatorValue.trim(),s=t.locatorAux.trim(),r=t.sourceUrl.trim(),o=t.sourceAccessedDate.trim();switch(t.sourceKind){case"website":return{url:r,accessedDate:o};case"bible":return{book:n,bookDisplay:t.bibleBookDisplay.trim(),passage:s};case"book":case"work":case"number_document":return s?{value:n,aux:s}:n;default:return s?{value:n,aux:s}:n}}function ws(t){var o,u,h;const n=t.locatorValue.trim(),s=t.locatorAux.trim(),r=[n,s].filter(Boolean).join(" ");switch(t.sourceKind){case"website":return t.sourceUrl.trim()||"website";case"bible":return r||"bible";case"book":return[(o=t.bookMedia)==null?void 0:o.label,r].filter(Boolean).join(" · ")||"book";case"work":return[(u=t.work)==null?void 0:u.label,r].filter(Boolean).join(" · ")||"work";case"number_document":return[(h=t.churchDocument)==null?void 0:h.label,r].filter(Boolean).join(" · ")||"number_document";default:return r||t.sourceKind||"source"}}function js(t){return t.sourceKind.trim()?t.sourceKind==="website"?!!t.sourceUrl.trim():t.sourceKind==="bible"?!!(t.locatorValue.trim()&&t.locatorAux.trim()):t.sourceKind==="book"?!!t.bookMedia:t.sourceKind==="work"?!!t.work:t.sourceKind==="number_document"?!!(t.churchDocument&&t.locatorValue.trim()):!!t.locatorValue.trim():!1}function oi({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,libraryId:c,editInfoId:f}){var Ce,ze,Ye;const{libraryName:l}=ha(c),d=!!f,[j,m]=a.useState([]),[C,O]=a.useState("word"),[b,p]=a.useState({}),[oe,B]=a.useState({}),[y,q]=a.useState({}),[k,Z]=a.useState({}),[_,$]=a.useState(null),[de,ue]=a.useState("idle"),[Se,He]=a.useState(Da),[me,R]=a.useState({}),[ye,V]=a.useState({}),[he,Y]=a.useState({}),[je,le]=a.useState(null),[se,Ie]=a.useState(()=>Fa(JSON.parse(Pa))??Ha()),[Ae,Pe]=a.useState(Pa),$e=a.useMemo(()=>j.find(A=>A.infoType===C),[C,j]),Ze=a.useMemo(()=>j.find(A=>A.infoType==="source"),[j]),ot=a.useMemo(()=>j.map(A=>({value:A.infoType,label:nt(t,A.infoType)})),[t,j]),Te=A=>{const M=Fa(A)??Ha(),P=ni(M);Ie(M),p(L=>({...L,definition:P}))};a.useEffect(()=>{let A=!1;return or({libraryId:c}).then(M=>{var P;if(!A&&(m(M),!d)){const L=(P=M[0])==null?void 0:P.infoType;L&&O(L)}}).catch(()=>{A||m([])}),()=>{A=!0}},[d,c]),a.useEffect(()=>{if(d||!$e)return;const A={},M={},P={},L={};for(const x of $e.payloadFields)$e.infoType==="question"&&x.key==="definition"&&x.inputType==="json"?A[x.key]=Pa:A[x.key]="";for(const x of $e.linkFields)x.multiple?P[x.key]=[]:M[x.key]=null,x.targetTypes.length>0&&(L[x.key]=x.targetTypes[0]);p(A),B(M),q(P),Z(L)},[$e==null?void 0:$e.infoType,d]),a.useEffect(()=>{if(C!=="question")return;const A=b.definition??"";if(!A.trim()){const M=Fa(JSON.parse(Pa))??Ha();Ie(M),Pe(Pa);return}try{const M=JSON.parse(A),P=Fa(M);if(!P)return;Ie(P),Pe(JSON.stringify(M,null,2))}catch{}},[b.definition,C]),a.useEffect(()=>{if(!d||!f||j.length===0)return;let A=!1;return ue("loading"),$(null),(async()=>{const P=await ua({libraryId:c,infoId:f});if(A)return;const L=P.infoType;O(L);const x=j.find(J=>J.infoType===L);if(!x){ue("idle");return}const N=P.payload??{},I={};for(const J of x.payloadFields)I[J.key]=ys(N[J.key]);p(I);const ne=P.links??{}??{},fe={},ie={},W={},E=[];for(const J of x.linkFields){J.targetTypes.length>0&&(W[J.key]=J.targetTypes[0]);const X=ne[J.key];if(J.multiple){const U=Array.isArray(X)?X.filter(Q=>typeof Q=="string"):[];ie[J.key]=[];for(const Q of U)E.push(ua({libraryId:c,infoId:Q}).then(be=>{if(A)return;const K={id:Q,infoType:be.infoType,label:xs(be.payload,Q)};W[J.key]=K.infoType,ie[J.key]=[...ie[J.key],K]}).catch(()=>{}))}else{const U=typeof X=="string"?X:null;fe[J.key]=null,U&&E.push(ua({libraryId:c,infoId:U}).then(Q=>{if(A)return;const be={id:U,infoType:Q.infoType,label:xs(Q.payload,U)};W[J.key]=be.infoType,fe[J.key]=be}).catch(()=>{}))}}await Promise.all(E),!A&&(B(fe),q(ie),Z(W),ue("idle"))})().catch(()=>{A||($("Failed to load info details."),ue("idle"))}),()=>{A=!0}},[f,d,c,j]),a.useEffect(()=>{C==="source"&&He(ii(b,oe.resource??null))},[C,b.sourceKind,b.locator,(Ce=oe.resource)==null?void 0:Ce.id,(ze=oe.resource)==null?void 0:ze.infoType,(Ye=oe.resource)==null?void 0:Ye.label]);const We=A=>{var x,N;const M=((x=Ze==null?void 0:Ze.payloadFields.find(I=>I.key==="sourceKind"))==null?void 0:x.keepOnCreate)??!1,P=((N=Ze==null?void 0:Ze.linkFields.find(I=>I.key==="resource"))==null?void 0:N.keepOnCreate)??!1,L=Da();return L.sourceKind=M?A.sourceKind:L.sourceKind,P&&(L.work=A.work,L.bookMedia=A.bookMedia,L.churchDocument=A.churchDocument),M&&A.sourceKind==="bible"&&(L.locatorValue=A.locatorValue,L.bibleBookDisplay=A.bibleBookDisplay),M&&A.sourceKind==="website"&&(L.sourceUrl=A.sourceUrl,L.sourceAccessedDate=A.sourceAccessedDate),L},ft=a.useMemo(()=>({sourceKindLabel:t.cogita.library.add.info.sourceKindLabel,bibleBookLabel:t.cogita.library.add.info.sourceBibleBookLabel,bibleBookPlaceholder:t.cogita.library.add.info.sourceBibleBookPlaceholder,bibleRestLabel:t.cogita.library.add.info.sourceBibleRestLabel,bibleRestPlaceholder:t.cogita.library.add.info.sourceBibleRestPlaceholder,churchDocumentLabel:t.cogita.library.add.info.sourceResourceLabel,churchDocumentPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,workLabel:t.cogita.library.add.info.sourceResourceLabel,workPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,bookLabel:t.cogita.library.add.info.sourceResourceLabel,bookPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,locatorLabel:t.cogita.library.list.typeFilterLocator,locatorPlaceholder:t.cogita.library.list.typeFilterLocator}),[t]),Oe=async A=>{const M=ye[A]??Da();if(!js(M)){Y(P=>({...P,[A]:t.cogita.library.add.info.referenceMissingSource}));return}le(A),Y(P=>({...P,[A]:null}));try{const P=Tn(M),L=P?{resource:P.id}:{},x={label:ws(M),sourceKind:M.sourceKind.trim(),locator:Cn(M)},I={id:(await _n({libraryId:c,infoType:"source",payload:x,links:L})).infoId,infoType:"source",label:x.label};if(q(ne=>{const fe=ne[A]??[];return fe.some(ie=>ie.id===I.id)?ne:{...ne,[A]:[...fe,I]}}),d&&f){const ne=await ua({libraryId:c,infoId:f}),fe=ne.links&&typeof ne.links=="object"?{...ne.links}:{},ie=fe[A],W=Array.isArray(ie)?ie.filter(E=>typeof E=="string"):typeof ie=="string"?[ie]:[];W.includes(I.id)||(fe[A]=[...W,I.id],await ns({libraryId:c,infoId:f,payload:ne.payload,links:fe}))}V(ne=>({...ne,[A]:We(M)})),Y(ne=>({...ne,[A]:null}))}catch(P){Y(L=>({...L,[A]:vs(P,t.cogita.library.lookup.createFailed)}))}finally{le(P=>P===A?null:P)}},_e=async()=>{var P;if(!$e)return;const A={};for(const L of $e.payloadFields){if(C==="source"&&(L.key==="sourceKind"||L.key==="locator"))continue;const x=(b[L.key]??"").trim();if(!x){if(L.required){$(`Field '${L.label}' is required.`);return}continue}if(L.inputType==="json")try{A[L.key]=JSON.parse(x)}catch{$(`Field '${L.label}' must be valid JSON.`);return}else A[L.key]=x}const M={};for(const L of $e.linkFields)if(!(C==="source"&&L.key==="resource"))if(L.multiple){const x=(y[L.key]??[]).map(N=>N.id);if(L.required&&x.length===0){$(`Link '${L.label}' is required.`);return}x.length>0&&(M[L.key]=x)}else{const x=((P=oe[L.key])==null?void 0:P.id)??null;if(L.required&&!x){$(`Link '${L.label}' is required.`);return}x&&(M[L.key]=x)}if(C==="source"){if(!js(Se)){$(t.cogita.library.add.info.referenceMissingSource);return}const L=Se.sourceKind.trim();A.sourceKind=L,A.locator=Cn(Se),(typeof A.label!="string"||!A.label.trim())&&(A.label=ws(Se));const x=Tn(Se);x&&(M.resource=x.id)}ue("saving"),$(null);try{if(d&&f)await ns({libraryId:c,infoId:f,payload:A,links:M}),$("Info updated.");else{await _n({libraryId:c,infoType:C,payload:A,links:M}),$("Info saved.");const L={};for(const I of $e.payloadFields)L[I.key]=I.keepOnCreate?b[I.key]??"":"";p(L);const x={},N={};for(const I of $e.linkFields)I.multiple?N[I.key]=I.keepOnCreate?y[I.key]??[]:[]:x[I.key]=I.keepOnCreate?oe[I.key]??null:null;B(I=>({...I,...x})),q(I=>({...I,...N})),C==="source"&&He(I=>{const ne=We(I),fe=Tn(ne);return p(ie=>({...ie,sourceKind:ne.sourceKind,locator:ys(Cn(ne))})),B(ie=>({...ie,resource:fe})),fe&&Z(ie=>({...ie,resource:fe.infoType})),ne})}}catch(L){$(vs(L,"Failed to save info."))}finally{ue("idle")}},et=A=>{const M=b[A.key]??"";if(C==="question"&&A.key==="definition"&&A.inputType==="json"){const L=se.type,x=E=>{const J=se.title??"",X=se.question??"";Te({...Ha(E),title:J,question:X})},N=E=>E.length===0?[""]:E[E.length-1].trim()?[...E,""]:E,I=E=>{const J=(E.length?E:[[""],[""]]).map(X=>N(X));return J.length>=2?J:[...J,[""]]},ne=(E,J)=>{const X=E.map(Q=>Array.from({length:J},(be,K)=>Q[K]??"")).filter(Q=>Q.some(be=>be.trim())||Q===E[E.length-1]);return X.length===0?[new Array(J).fill("")]:X[X.length-1].some(Q=>Q.trim())?[...X,new Array(J).fill("")]:X},fe=Array.isArray(se.answer)?se.answer:[],ie=I(se.columns??[[""],[""]]),W=ne(se.matchingPaths??[[]],ie.length);return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:A.label}),e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.8rem"},children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question type"}),e.jsxs("select",{value:L,onChange:E=>x(E.target.value),children:[e.jsx("option",{value:"selection",children:"Selection"}),e.jsx("option",{value:"truefalse",children:"True / false"}),e.jsx("option",{value:"text",children:"Text answer"}),e.jsx("option",{value:"number",children:"Number answer"}),e.jsx("option",{value:"date",children:"Date answer"}),e.jsx("option",{value:"matching",children:"Matching"}),e.jsx("option",{value:"ordering",children:"Right order"})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Title"}),e.jsx("input",{type:"text",value:se.title??"",onChange:E=>Te({...se,title:E.target.value}),placeholder:"Optional title"})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question"}),e.jsx("textarea",{rows:3,value:se.question??"",onChange:E=>Te({...se,question:E.target.value}),placeholder:"Question text"})]}),L==="selection"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Options / correct indices"}),N(se.options??[""]).map((E,J,X)=>{const U=new Set(fe.filter(be=>Number.isInteger(be))),Q=J===X.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:U.has(J),disabled:!E.trim(),onChange:be=>{const K=be.target.checked?[...U,J]:[...U].filter(ee=>ee!==J);Te({...se,answer:K})}}),e.jsx("input",{type:"text",value:E,placeholder:`Answer ${J+1}`,onChange:be=>{const K=[...se.options??[""]];K[J]=be.target.value;const ee=N(K),Le=ee.length-1,Ve=fe.filter(Ke=>Ke>=0&&Ke<Le);Te({...se,options:ee,answer:Ve})}}),Q?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const K=(se.options??[""]).filter((Le,Ve)=>Ve!==J),ee=fe.filter(Le=>Le!==J).map(Le=>Le>J?Le-1:Le);Te({...se,options:N(K),answer:ee})},children:"Remove"})]},`question-option:${J}`)})]}):null,L==="text"||L==="date"||L==="number"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsx("input",{type:L==="date"?"date":"text",value:typeof se.answer=="string"||typeof se.answer=="number"?String(se.answer):"",onChange:E=>Te({...se,answer:E.target.value})})]}):null,L==="truefalse"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsxs("select",{value:String(!!se.answer),onChange:E=>Te({...se,answer:E.target.value==="true"}),children:[e.jsx("option",{value:"true",children:"True"}),e.jsx("option",{value:"false",children:"False"})]})]}):null,L==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Columns"}),ie.map((E,J)=>e.jsxs("div",{style:{display:"grid",gap:"0.35rem",border:"1px solid rgba(120,170,220,0.22)",borderRadius:"0.6rem",padding:"0.55rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"0.5rem"},children:[e.jsxs("span",{style:{fontSize:"0.8rem",color:"rgba(184,209,234,0.85)"},children:["Column ",J+1]}),ie.length>2?e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const X=ie.filter((Q,be)=>be!==J),U=W.map(Q=>Q.filter((be,K)=>K!==J));Te({...se,columns:I(X),matchingPaths:ne(U,Math.max(2,X.length))})},children:"Remove column"}):null]}),E.map((X,U)=>{const Q=U===E.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",gap:"0.4rem",alignItems:"center"},children:[e.jsx("input",{type:"text",value:X,placeholder:`Option ${U+1}`,onChange:be=>{const K=ie.map(ee=>[...ee]);K[J][U]=be.target.value,Te({...se,columns:I(K),matchingPaths:ne(W,ie.length)})}}),Q?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const be=ie.map(K=>[...K]);be[J]=be[J].filter((K,ee)=>ee!==U),Te({...se,columns:I(be),matchingPaths:ne(W,ie.length)})},children:"Remove"})]},`question-column:${J}:row:${U}`)})]},`question-column:${J}`)),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{const E=[...ie.map(X=>[...X]),[""]],J=W.map(X=>[...X,""]);Te({...se,columns:I(E),matchingPaths:ne(J,E.length)})},children:"Add column"})}),e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Correct paths (0-based indices)"}),W.map((E,J)=>{const X=J===W.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:`repeat(${ie.length}, minmax(0,1fr)) auto`,gap:"0.35rem",alignItems:"center"},children:[E.map((U,Q)=>e.jsx("input",{type:"number",min:0,step:1,value:U,placeholder:`${Q}`,onChange:be=>{const K=W.map(Ve=>[...Ve]);K[J][Q]=be.target.value;const ee=ne(K,ie.length),Le=ee.map(Ve=>Ve.map(Ke=>Ke.trim())).filter(Ve=>Ve.every(Ke=>Ke!=="")).map(Ve=>Ve.map(Ke=>Number(Ke))).filter(Ve=>Ve.every(Ke=>Number.isInteger(Ke)&&Ke>=0));Te({...se,matchingPaths:ee,answer:{paths:Le}})}},`question-path:${J}:${Q}`)),X?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const U=W.filter((K,ee)=>ee!==J),Q=ne(U,ie.length),be=Q.map(K=>K.map(ee=>ee.trim())).filter(K=>K.every(ee=>ee!=="")).map(K=>K.map(ee=>Number(ee))).filter(K=>K.every(ee=>Number.isInteger(ee)&&ee>=0));Te({...se,matchingPaths:Q,answer:{paths:be}})},children:"Remove"})]},`question-path:${J}`)})]}):null,L==="ordering"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Ordered options (correct order = listed order)"}),N(se.options??[""]).map((E,J,X)=>{const U=J===X.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)",minWidth:"1.5rem"},children:[J+1,"."]}),e.jsx("input",{type:"text",value:E,placeholder:`Step ${J+1}`,onChange:Q=>{const be=[...se.options??[""]];be[J]=Q.target.value,Te({...se,options:N(be)})}}),U?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>Te({...se,options:N((se.options??[]).filter((Q,be)=>be!==J))}),children:"Remove"})]},`question-order:${J}`)})]}):null,e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"JSON import"}),e.jsx("textarea",{rows:8,value:Ae,onChange:E=>Pe(E.target.value),placeholder:"Paste question JSON"}),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{try{const E=JSON.parse(Ae),J=Fa(E);if(!J){$("Question JSON must be an object.");return}Te(J),$(null)}catch{$("Question JSON is invalid.")}},children:"Interpret JSON"})})]})]})]},`payload:${A.key}`)}const P=A.inputType==="textarea"||A.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:A.label}),P?e.jsx("textarea",{rows:A.inputType==="json"?8:4,value:M,onChange:L=>p(x=>({...x,[A.key]:L.target.value})),placeholder:A.key}):e.jsx("input",{type:"text",value:M,onChange:L=>p(x=>({...x,[A.key]:L.target.value})),placeholder:A.key})]},`payload:${A.key}`)},it=A=>{const M=k[A.key]??A.targetTypes[0],P=A.key==="references"&&A.multiple&&A.targetTypes.includes("source"),L=ye[A.key]??Da(),x=me[A.key]??!1,N=he[A.key];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:A.label}),A.targetTypes.length>1?e.jsx("select",{value:M,onChange:I=>Z(ne=>({...ne,[A.key]:I.target.value})),children:A.targetTypes.map(I=>e.jsx("option",{value:I,children:nt(t,I)},`${A.key}:${I}`))}):null,A.multiple?e.jsx(Gt,{libraryId:c,infoType:M,label:A.label,placeholder:A.key,multiple:!0,values:y[A.key]??[],onChangeMultiple:I=>q(ne=>({...ne,[A.key]:I})),allowCreate:!P,searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(Gt,{libraryId:c,infoType:M,label:A.label,placeholder:A.key,value:oe[A.key]??null,onChange:I=>B(ne=>({...ne,[A.key]:I})),searchFailedText:"Search failed",createFailedText:"Create failed"}),P?e.jsxs("div",{children:[e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:x,onChange:I=>R(ne=>({...ne,[A.key]:I.target.checked}))}),e.jsx("span",{children:t.cogita.library.add.info.referenceToggle})]}),x?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(fs,{libraryId:c,copy:t,language:v,sourceKindOptions:[...bs],value:L,onChange:I=>V(ne=>({...ne,[A.key]:I})),labels:ft}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>Oe(A.key),disabled:je===A.key,children:je===A.key?t.cogita.library.lookup.saving:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.source)})}),N?e.jsx("p",{className:"cogita-library-subtitle",children:N}):null]}):null]}):null]},`link:${A.key}`)},Ge=()=>e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(fs,{libraryId:c,copy:t,language:v,sourceKindOptions:[...bs],value:Se,onChange:He,labels:ft})]});return e.jsx(Et,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:d?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${c}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[d?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:C,onChange:A=>O(A.target.value),children:ot.map(A=>e.jsx("option",{value:A.value,children:A.label},A.value))})]}),de==="loading"&&d?e.jsx("p",{children:"Loading..."}):null,$e&&!(de==="loading"&&d)?e.jsxs("div",{className:"cogita-form-grid",children:[$e.payloadFields.filter(A=>!(C==="source"&&(A.key==="sourceKind"||A.key==="locator"))).map(et),C==="source"?Ge():null,$e.linkFields.filter(A=>!(C==="source"&&A.key==="resource")).map(it)]}):de==="loading"&&d?null:e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:_e,disabled:de==="saving"||!$e,children:de==="saving"?"Saving...":d?"Update info":"Create info"})}),_?e.jsx("p",{className:"cogita-library-subtitle",children:_}):null]})})})]})})}const ks=t=>/\s/.test(t),tn=t=>/[\p{L}\p{N}]/u.test(t),Ns=(t,n)=>{const s=n>0?t[n-1]:"",r=n<t.length?t[n]:"";if(!s||!r)return 0;const o=ks(s),u=ks(r);if(o||u)return 3;const h=tn(s),w=tn(r);return h!==w?2:!h&&!w?1:0},In=(t,n,s,r,o)=>{const u=Math.max(r-n,s-r);for(let h=0;h<=u;h+=1){const w=r-h;if(w>=n&&w<=s&&Ns(t,w)>=o)return w;const v=r+h;if(v>=n&&v<=s&&Ns(t,v)>=o)return v}return null},Mn=(t,n)=>{const s=n>0?t[n-1]:"",r=n<t.length?t[n]:"";return!s||!r?!0:tn(s)!==tn(r)},li=(t,n,s,r)=>{const o=s-n,u=n+r,h=s-r;if(o<=r*2||h<=u)return null;const w=Math.floor((n+s)/2),v=In(t,u,h,w,3);if(v!==null&&Mn(t,v))return v;const S=In(t,u,h,w,2);if(S!==null&&Mn(t,S))return S;const c=In(t,u,h,w,1);return c!==null&&Mn(t,c)?c:null},ka=(t,n)=>{const s=Math.max(1,7),r=Math.max(s,13),o={},u=(v,S,c,f,l)=>{const d=String(f),j={id:d,start:v,end:S,text:t.slice(v,S),depth:c,index:f,parentId:l};if(o[d]=j,S-v>r){let C=li(t,v,S,s);if(C!==null&&C>v&&C<S){const O=u(v,C,c+1,f*2+1,d),b=u(C,S,c+1,f*2+2,d);j.leftId=O.id,j.rightId=b.id}}return j},h=u(0,t.length,0,0),w=Object.values(o).sort((v,S)=>S.depth-v.depth||v.start-S.start).map(v=>v.id);return{text:t,rootId:h.id,nodes:o,order:w}},Ma=(t,n,s,r,o,u,h)=>{const w=u==="reverse"?t.order.slice().sort((v,S)=>t.nodes[S].start-t.nodes[v].start||t.nodes[S].depth-t.nodes[v].depth):t.order;for(const v of w){if(h&&v===h||n.has(v))continue;const S=t.nodes[v];if(S){if(o&&(S.leftId||S.rightId)){const c=S.leftId?s[S.leftId]??0:r,f=S.rightId?s[S.rightId]??0:r;if((c+f)/2<r)continue}return S}}return null},Hn=(t,n)=>({before:t.slice(0,n.start),fragment:t.slice(n.start,n.end),after:t.slice(n.end)});function ci({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,libraryId:c}){const f=`/#/cogita/library/${c}`,[l,d,j]=Bn([]),[m,C,O]=On([]),[b,p]=a.useState(null),[oe,B]=a.useState(null),[y,q]=a.useState(null),[k,Z]=a.useState(null),_=a.useMemo(()=>l.find(R=>R.id===b)??null,[l,b]);a.useEffect(()=>{let R=!0;return lr({libraryId:c}).then(ye=>{if(!R)return;const V=ye.nodes.map(he=>{var Y,je,le;return{id:he.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:he.payload&&typeof he.payload=="object"&&"label"in he.payload?String(he.payload.label):"Item",nodeType:he.nodeType,itemType:((Y=he.payload)==null?void 0:Y.itemType)??"info",itemId:((je=he.payload)==null?void 0:je.itemId)??null,infoType:((le=he.payload)==null?void 0:le.infoType)??null}}});d(V),C(ye.edges.map(he=>({id:he.edgeId,source:he.fromNodeId,target:he.toNodeId})))}).catch(()=>{R&&(d([]),C([]))}),()=>{R=!1}},[c]),a.useEffect(()=>{cr({libraryId:c}).then(B).catch(()=>B(null))},[c,l,m]);const $=a.useCallback(R=>{C(ye=>Vn(R,ye))},[]),de=()=>{const R=crypto.randomUUID();d(ye=>[...ye,{id:R,type:"default",position:{x:140+ye.length*40,y:120+ye.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},ue=()=>{const R=crypto.randomUUID();d(ye=>[...ye,{id:R,type:"default",position:{x:180+ye.length*40,y:160+ye.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},Se=async()=>{q(null);try{const R=l.map(V=>({nodeId:V.id,nodeType:V.data.nodeType,payload:{itemType:V.data.itemType,itemId:V.data.itemId??null,label:V.data.label,infoType:V.data.infoType??null}})),ye=m.map(V=>({edgeId:V.id,fromNodeId:V.source,toNodeId:V.target}));await dr({libraryId:c,nodes:R,edges:ye}),q(t.cogita.library.graph.saveSuccess)}catch{q(t.cogita.library.graph.saveFail)}},He=R=>{_&&d(ye=>ye.map(V=>V.id===_.id?{...V,data:{...V.data,itemId:(R==null?void 0:R.infoId)??null,itemType:"collection",infoType:"collection",label:(R==null?void 0:R.label)??t.cogita.library.infoTypes.collection}}:V))},me=R=>{_&&d(ye=>ye.map(V=>V.id===_.id?{...V,data:{...V.data,itemId:(R==null?void 0:R.infoId)??null,itemType:"info",infoType:(R==null?void 0:R.infoType)??null,label:(R==null?void 0:R.label)??t.cogita.library.infoTypes.any}}:V))};return a.useEffect(()=>{if(!_||_.data.nodeType!=="info"||_.data.infoType!=="citation"||!_.data.itemId){Z(null);return}let R=!0;return ua({libraryId:c,infoId:_.data.itemId}).then(ye=>{if(!R)return;const V=ye.payload,he=(V==null?void 0:V.text)??"";if(!he){Z(null);return}const Y=ka(he),je=Object.values(Y.nodes).sort((le,se)=>le.depth-se.depth||le.start-se.start).map(le=>({id:le.id,text:le.text,depth:le.depth}));Z({title:(V==null?void 0:V.title)??_.data.label,fragments:je})}).catch(()=>Z(null)),()=>{R=!1}},[c,_]),e.jsx(Et,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:f,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:Se,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:de,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:ue,children:t.cogita.library.actions.addInfo}),oe?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(oe.totalCollections))})}):null,y?e.jsx("p",{className:"cogita-help",children:y}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(un,{nodes:l,edges:m,onNodesChange:j,onEdgesChange:O,onConnect:$,onNodeClick:(R,ye)=>p(ye.id),fitView:!0,children:[e.jsx(hn,{gap:18,size:1}),e.jsx(gn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),_?e.jsxs("div",{className:"cogita-graph-inspector",children:[_.data.nodeType==="collection"?e.jsx(Gt,{libraryId:c,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:_.data.itemId?{id:_.data.itemId,label:_.data.label,infoType:"collection"}:null,onChange:He,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(Gt,{libraryId:c,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:_.data.itemId?{id:_.data.itemId,label:_.data.label,infoType:_.data.infoType??void 0}:null,onChange:me,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),k?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:k.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:k.fragments.map(R=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:R.id}),e.jsx("span",{children:R.text})]},R.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function Wn({children:t,flashState:n,flashTick:s=0,feedbackToken:r,className:o}){const u=r??(n?`${n}-${s}`:"idle");return e.jsx("section",{className:o?`cogita-revision-card ${o}`:"cogita-revision-card","data-feedback":u,children:t})}function Qn({copy:t,currentCard:n,currentTypeLabel:s,prompt:r,languages:o,answer:u,onAnswerChange:h,computedExpected:w,computedAnswers:v,onComputedAnswerChange:S,answerTemplate:c,outputVariables:f,variableValues:l,computedFieldFeedback:d,feedback:j,canAdvance:m,quoteContext:C,quotePlaceholder:O,onCheckAnswer:b,onSkip:p,onLanguageSelect:oe,onMarkReviewed:B,onAdvance:y,showCorrectAnswer:q,setShowCorrectAnswer:k,onRevealCorrect:Z,answerMask:_,expectedAnswer:$,hasExpectedAnswer:de,handleComputedKeyDown:ue,answerInputRef:Se,computedInputRefs:He,scriptMode:me,setScriptMode:R,matchPairs:ye,matchLeftOrder:V,matchRightOrder:he,matchSelection:Y,matchActiveLeft:je,matchActiveRight:le,matchFeedback:se,onMatchLeftSelect:Ie,onMatchRightSelect:Ae,disableCheckAnswer:Pe=!1,hideSkipAction:$e=!1,allowRevealBeforeCheck:Ze=!1,autoRevealAfterAnswer:ot=!1,disableCheckAfterAnswer:Te=!1}){const We=a.useMemo(()=>{var J;const M=!c&&w.length===2?`The {${w[0].key}} is of type {${w[1].key}}`:null,P=c??M;if(!P)return null;const L=new Map(w.map(X=>[X.key,X.expected])),x=new Set,N=[],I=/\{([^}]+)\}/g;let ne=0,fe,ie=null;for(;(fe=I.exec(P))!==null;){const X=P.slice(ne,fe.index);X&&N.push({type:"text",value:X});const U=((J=fe[1])==null?void 0:J.trim())??"",Q=U&&L.has(U)?U:U&&f&&f[U]?f[U]:null;U&&x.add(U),Q&&x.add(Q),Q&&L.has(Q)?(N.push({type:"input",value:Q}),ie||(ie=Q)):U&&l&&l[U]!==void 0?N.push({type:"text",value:l[U]}):N.push({type:"text",value:fe[0]}),ne=fe.index+fe[0].length}const W=P.slice(ne);return W&&N.push({type:"text",value:W}),w.filter(X=>!x.has(X.key)).length>0?null:{parts:N,expectedByKey:L,firstInputKey:ie}},[c,w,f,l]),ft=()=>{if(!We)return null;const{parts:M,expectedByKey:P,firstInputKey:L}=We;return e.jsx("div",{className:"cogita-revision-inline-answer",children:M.map((x,N)=>{var I,ne;return x.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:x.value},`text-${N}`):e.jsx("input",{ref:fe=>{He.current[x.value]=fe},autoFocus:x.value===L,value:v[x.value]??"",onChange:fe=>S(x.value,fe.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":d[x.value]??(j==="correct"?"correct":j==="incorrect"?"incorrect":void 0),onKeyDown:fe=>it(fe)||ue(fe),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((I=v[x.value])==null?void 0:I.length)??0,((ne=P.get(x.value))==null?void 0:ne.length)??6)}ch`}},`input-${x.value}-${N}`)})})},Oe=a.useMemo(()=>{const M=new Map;return(ye??[]).forEach(P=>M.set(P.leftId,P)),M},[ye]),_e=a.useMemo(()=>{const M=new Map;return(ye??[]).forEach(P=>M.set(P.rightId,P)),M},[ye]);a.useEffect(()=>{var N;if(n.cardType!=="info"||n.infoType!=="computed"||w.length===0)return;const M=typeof document<"u"?document.activeElement:null;if(M&&(M.tagName==="INPUT"||M.tagName==="TEXTAREA"))return;const P=(We==null?void 0:We.firstInputKey)??((N=w[0])==null?void 0:N.key);if(!P)return;const L=He.current[P];if(!L)return;const x=requestAnimationFrame(()=>{L.focus()});return()=>cancelAnimationFrame(x)},[n,w,We]);const et=(()=>{const M=[$??"",...w.map(x=>x.expected??"")].join(""),P=[u,...Object.values(v)].join(""),L=`${M}${P}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(L)})(),it=M=>M.ctrlKey&&(M.key==="^"||M.key==="6")?(M.preventDefault(),R(P=>P==="super"?null:"super"),!0):M.ctrlKey&&(M.key==="_"||M.key==="-")?(M.preventDefault(),R(P=>P==="sub"?null:"sub"),!0):!1,Ge=()=>{if(!$||!_)return $??"";const M=$.split(""),P=Array.from(_),L=P.length>0?P.reduce((x,N)=>x+N,0)/P.length:127;return M.map((x,N)=>{const I=P[N]??L,ne=Math.max(0,Math.min(255,Math.round(I)));let fe=255,ie=0;return ne<=127?ie=Math.round(ne/127*255):(ie=255,fe=Math.round(255*(1-(ne-127)/128))),e.jsx("span",{style:{color:`rgb(${fe}, ${ie}, 0)`},children:x},`mask-${N}`)})},Ce=n.cardType==="info"&&n.infoType==="citation"?(C==null?void 0:C.title)||n.label:n.description,ze=q||ot&&j!==null,Ye=Pe||Te&&(j!==null||ze),A=de&&(Ze||j==="incorrect"||ze);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[s?e.jsx("span",{children:s}):null,e.jsx("strong",{children:Ce})]}),n.cardType==="vocab"&&n.checkType==="translation-match"&&ye?e.jsxs("div",{className:"cogita-revision-body",children:[r?e.jsx("h2",{children:r}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(V??[]).map(M=>{const P=Oe.get(M);if(!P)return null;const L=(Y==null?void 0:Y[M])??null,x=(se==null?void 0:se[M])??null,N=je===M;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":N,"data-state":x??void 0,"data-locked":L?"true":void 0,onClick:()=>Ie==null?void 0:Ie(M),children:[e.jsx("span",{children:P.leftLabel}),L&&q?e.jsx("em",{children:"✓"}):null]},M)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(he??[]).map(M=>{const P=_e.get(M);if(!P)return null;const L=Object.values(Y??{}).includes(M),x=le===M;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":L||x,"data-locked":L?"true":void 0,onClick:()=>Ae==null?void 0:Ae(M),children:e.jsx("span",{children:P.rightLabel})},M)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:b,disabled:n.checkType==="translation-match"||Ye,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:p,children:t.cogita.library.revision.skip})]})]}):n.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:Se,value:u,onChange:M=>h(M.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":j==="correct"?"correct":j==="incorrect"?"incorrect":void 0,onKeyDown:M=>{if(M.key==="Enter")if(M.preventDefault(),M.stopPropagation(),m)y();else{if(Ye)return;b()}}})]}),et?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":me==="super",onClick:()=>R(M=>M==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":me==="sub",onClick:()=>R(M=>M==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:b,disabled:Ye,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:p,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[n.label?e.jsx("p",{className:"cogita-revision-hint",children:n.label}):null,c?null:e.jsx(ur,{value:r??"",mode:"auto"}),w.length>0?(()=>{const M=ft();return M?e.jsx("div",{className:"cogita-inline-answer-wrap",children:M}):e.jsx("div",{className:"cogita-form-grid",children:w.map((P,L)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:P.key}),e.jsx("textarea",{ref:x=>{He.current[P.key]=x},autoFocus:L===0,value:v[P.key]??"",onChange:x=>S(P.key,x.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":d[P.key]??(j==="correct"?"correct":j==="incorrect"?"incorrect":void 0),onKeyDown:x=>it(x)||ue(x)})]},P.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:Se,value:u,onChange:M=>h(M.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":j==="correct"?"correct":j==="incorrect"?"incorrect":void 0,onKeyDown:M=>{if(!it(M)&&M.key==="Enter")if(M.preventDefault(),M.stopPropagation(),m)y();else{if(Ye)return;b()}}})]})}),et?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":me==="super",onClick:()=>R(M=>M==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":me==="sub",onClick:()=>R(M=>M==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:b,disabled:Ye,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:p,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="citation"&&C?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(C.completed)).replace("{total}",String(C.total))}),e.jsx("p",{className:"cogita-quote-text",children:C.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:Se,value:u,onChange:M=>h(M.target.value),placeholder:O??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":j==="correct"?"correct":j==="incorrect"?"incorrect":void 0,onKeyDown:M=>{if(M.key==="Enter")if(M.preventDefault(),M.stopPropagation(),m)y();else{if(Ye)return;b()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:C.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:b,disabled:Ye,children:t.cogita.library.revision.checkAnswer}),$e?null:e.jsx("button",{type:"button",className:"ghost",onClick:p,children:t.cogita.library.revision.skip})]})]}):n.cardType==="info"&&n.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:o.length?o.map(M=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>oe(M.label),children:M.label},M.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:p,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:B,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:p,children:t.cogita.library.revision.skip})]})]}),j&&e.jsx("div",{className:"cogita-revision-feedback","data-state":j,children:j==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),A?e.jsxs("div",{className:"cogita-revision-reveal",children:[ze?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>k(M=>{const P=!M;return P&&Z(),P}),children:t.cogita.library.revision.showAnswer}),ze?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),w.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[w.map(M=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:M.key}),e.jsx("span",{children:M.expected})]},M.key)),$?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:$})]}):null]}):e.jsx("p",{children:_?Ge():$})]}):null]}):null,m?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:y,children:t.cogita.library.revision.nextQuestion})}):null]})}const Ss={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},di=(t,n)=>{const s=Math.max(t.length,n.length,1),r=Math.abs(t.length-n.length);return Math.max(0,1-r/s)},ui=(t,n)=>{const s=new Uint8Array(t.length),r=di(t,n);for(let o=0;o<t.length;o+=1){const u=t[o]===(n[o]??"")?128:0,h=t.length-1-o,w=n.length-1-o,v=t[h]===(n[w]??"")?127:0,S=Math.round((u+v)*r);s[o]=Math.max(0,Math.min(255,S))}return s},hi=(t,n)=>t===n||(Ss[t]??[]).includes(n)?!0:(Ss[n]??[]).includes(t),Wa=(t,n,s)=>s?hi(t,n):t===n,an=(t,n,s)=>{const r=new Uint8Array(t.length);if(!t.length)return r;const o=(s==null?void 0:s.allowSimilarChars)??!0,u=[];for(let w=0;w<=t.length-3;w+=1)u.push({index:w,text:t.slice(w,w+3)});let h=!1;return u.forEach(w=>{for(let v=0;v<=n.length-3;v+=1){const S=n.slice(v,v+3);let c=0;for(let m=0;m<3;m+=1)Wa(w.text[m],S[m],o)&&(c+=1);if(c<2)continue;let f=w.index-1,l=v-1;for(;f>=0&&l>=0;){const m=t[f],C=n[l];if(m===C){r[f]=Math.max(r[f],255),f-=1,l-=1,h=!0;continue}if(Wa(m,C,o)&&m!==C){r[f]=Math.max(r[f],127),f-=1,l-=1,h=!0;continue}if(f>0&&t[f-1]===C){r[f]=Math.max(r[f],0),f-=1,h=!0;continue}if(l>0&&t[f]===n[l-1]){l-=1,h=!0;continue}break}for(let m=0;m<3;m+=1){const C=w.index+m,O=w.text[m],b=S[m],p=O===b?255:Wa(O,b,o)?127:0;r[C]=Math.max(r[C],p),h=!0}let d=w.index+3,j=v+3;for(;d<t.length&&j<n.length;){const m=t[d],C=n[j];if(m===C){r[d]=Math.max(r[d],255),d+=1,j+=1,h=!0;continue}if(Wa(m,C,o)&&m!==C){r[d]=Math.max(r[d],127),d+=1,j+=1,h=!0;continue}if(d+1<t.length&&t[d+1]===C){r[d]=Math.max(r[d],0),d+=1,h=!0;continue}if(j+1<n.length&&t[d]===n[j+1]){j+=1,h=!0;continue}break}}}),h?r:ui(t,n)},Ln=t=>/[\p{L}\p{N}]/u.test(t),Ts=t=>t.trim().toLowerCase(),ya=(t,n)=>{if(t.length===0)return 100;const s=(n==null?void 0:n.treatSimilarCharsAsSame)??!1,r=Array.from(t).reduce((o,u)=>s&&u===127?o+255:o+u,0);return Math.round(r/(t.length*255)*100)},Ia=(t,n,s)=>{const r=Math.max(0,Math.min(100,(s==null?void 0:s.thresholdPercent)??100)),o=(s==null?void 0:s.treatSimilarCharsAsSame)??!0,u=(s==null?void 0:s.ignorePunctuationAndSpacing)??!1,h=Ts(t),w=Ts(n);if(!u){const b=an(h,w,{allowSimilarChars:o}),p=ya(b,{treatSimilarCharsAsSame:o});return{mask:b,percent:p,isCorrect:p>=r,normalizedExpected:h,normalizedAnswer:w}}const v=Array.from(h),S=Array.from(w),c=[],f=[],l=[];v.forEach((b,p)=>{Ln(b)&&(c.push(b),f.push(p))}),S.forEach(b=>{Ln(b)&&l.push(b)});const d=c.join(""),j=l.join(""),m=an(d,j,{allowSimilarChars:o}),C=new Uint8Array(v.length);for(let b=0;b<C.length;b+=1)C[b]=Ln(v[b]??"")?0:255;for(let b=0;b<m.length;b+=1){const p=f[b];p!==void 0&&(C[p]=m[b])}const O=ya(m,{treatSimilarCharsAsSame:o});return{mask:C,percent:O,isCorrect:O>=r,normalizedExpected:d,normalizedAnswer:j}},La=(t,n,s)=>{const r=t.trim().toLowerCase(),o=n.trim().toLowerCase();return s==="prefix"||s==="bidirectional"?an(r,o,{allowSimilarChars:!0}):an(r,o,{allowSimilarChars:!0})};function gi(t){if(!t||typeof t!="object")return null;const s=t.definition;if(!s||typeof s!="object")return null;const r=s,o=typeof r.type=="string"?r.type:typeof r.kind=="string"?r.kind:"selection",u=o==="multi_select"||o==="single_select"?"selection":o==="boolean"?"truefalse":o==="order"?"ordering":o;if(!["selection","truefalse","text","number","date","ordering","matching"].includes(u))return null;const h=u,w=typeof r.title=="string"?r.title:void 0,v=typeof r.question=="string"?r.question:"",S=Array.isArray(r.options)?r.options.map(l=>typeof l=="string"?l:"").filter(Boolean):void 0,c=Array.isArray(r.columns)?r.columns.map(l=>Array.isArray(l)?l.map(d=>typeof d=="string"?d:"").filter(Boolean):[]).filter(l=>l.length>0):void 0,f=(()=>{if(u==="selection")return(Array.isArray(r.answer)?r.answer:Array.isArray(r.correct)?r.correct:[]).map(d=>Number(d)).filter(d=>Number.isInteger(d)&&d>=0);if(u==="truefalse")return typeof r.answer=="boolean"?r.answer:typeof r.expected=="boolean"?r.expected:!1;if(u==="matching"){const l=r.answer&&typeof r.answer=="object"?r.answer:null;return{paths:(Array.isArray(l==null?void 0:l.paths)?l==null?void 0:l.paths:Array.isArray(r.correctPairs)?r.correctPairs:[]).map(m=>Array.isArray(m)?m.map(C=>Number(C)).filter(C=>Number.isInteger(C)&&C>=0):[]).filter(m=>m.length>0)}}if(typeof r.answer=="string"||typeof r.answer=="number")return r.answer;if(typeof r.expected=="string"||typeof r.expected=="number")return r.expected})();return{type:h,title:w,question:v,options:S,columns:c,answer:f}}function mi(t){var o;if(t.type!=="matching")return[[]];const n=Math.max(2,((o=t.columns)==null?void 0:o.length)??2);return[...((t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[])??[]).map(u=>Array.from({length:n},(h,w)=>String(u[w]??""))),new Array(n).fill("")]}function pi(t){const n=[...t];for(let s=n.length-1;s>0;s-=1){const r=Math.floor(Math.random()*(s+1));[n[s],n[r]]=[n[r],n[s]]}return n}function la(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function Cs(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function Is(t){const n=t.checkType??"info",s=n.startsWith("question-")?`question / ${n.slice(9)}`:n;return t.direction?`${s} / ${t.direction}`:s}function fi({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,libraryId:c,infoId:f,selectedReviewerRoleId:l}){const[d,j]=a.useState(f),[m,C]=a.useState([]),[O,b]=a.useState([]),[p,oe]=a.useState("loading"),[B,y]=a.useState(null),[q,k]=a.useState(null),[Z,_]=a.useState(null),[$,de]=a.useState(null),[ue,Se]=a.useState(""),[He,me]=a.useState(null),[R,ye]=a.useState(1),[V,he]=a.useState(null),[Y,je]=a.useState(0),[le,se]=a.useState(!1),[Ie,Ae]=a.useState(null),[Pe,$e]=a.useState({}),[Ze,ot]=a.useState({}),[Te]=a.useState({}),[We,ft]=a.useState(null),[Oe,_e]=a.useState({selection:[],booleanAnswer:null,ordering:[],matchingRows:[[]]}),et=a.useRef(null),it=a.useRef({}),Ge=dn();a.useEffect(()=>{let W=!1;return oe("loading"),Promise.all([ua({libraryId:c,infoId:f}).catch(()=>null),Ya({libraryId:c,infoId:f}),Xa({libraryId:c,infoId:f})]).then(([E,J,X])=>{if(W)return;const U=(E==null?void 0:E.payload)??{},Q=typeof U.title=="string"&&U.title||typeof U.label=="string"&&U.label||typeof U.name=="string"&&U.name||f;j(Q),k(U),_((E==null?void 0:E.infoType)??null),C(J.items),b(X.items),oe("ready")}).catch(()=>{W||(k(null),_(null),C([]),b([]),oe("error"))}),()=>{W=!0}},[c,f]),a.useEffect(()=>{if(Z!=="translation"){de(null);return}Ps({libraryId:c,infoId:f,approachKey:"vocab-card"}).then(W=>de(W.projection??null)).catch(()=>de(null))},[Z,f,c]);const Ce=a.useMemo(()=>{var be;const W=new Map(m.map(K=>[la(K),K])),E=new Map,J=new Map;for(const K of m)E.set(la(K),0),J.set(la(K),[]);for(const K of O){const ee=Cs({parentItemId:K.parentItemId,parentCheckType:K.parentCheckType,parentDirection:K.parentDirection}),Le=[K.childItemId,K.childCheckType??"",K.childDirection??""].join("|");!W.has(ee)||!W.has(Le)||((be=J.get(ee))==null||be.push(Le),E.set(Le,(E.get(Le)??0)+1))}const X=Array.from(E.entries()).filter(([,K])=>K===0).map(([K])=>K),U=new Map;for(const K of X)U.set(K,0);for(;X.length;){const K=X.shift(),ee=U.get(K)??0;for(const Le of J.get(K)??[]){const Ve=Math.max(U.get(Le)??0,ee+1);U.set(Le,Ve),E.set(Le,(E.get(Le)??1)-1),(E.get(Le)??0)<=0&&X.push(Le)}}const Q=new Map;for(const K of m){const ee=la(K),Le=U.get(ee)??0,Ve=Q.get(Le)??[];Ve.push(ee),Q.set(Le,Ve)}return m.map(K=>{const ee=la(K),Le=U.get(ee)??0,Ve=Q.get(Le)??[ee],Ke=Math.max(0,Ve.indexOf(ee));return{id:ee,position:{x:40+Ke*290+(Le%2?18:0),y:30+Le*120},draggable:!1,selectable:!0,data:{label:K.label,subtitle:Is(K),checkType:K.checkType??"info",direction:K.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[m,O]),ze=a.useMemo(()=>new Map(m.map(W=>[la(W),W])),[m]),Ye=a.useMemo(()=>{const W=[];for(const E of O){const J=Cs({parentItemId:E.parentItemId,parentCheckType:E.parentCheckType,parentDirection:E.parentDirection}),X=[E.childItemId,E.childCheckType??"",E.childDirection??""].join("|");!ze.has(J)||!ze.has(X)||W.push({id:`${J}->${X}`,source:J,target:X,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return W},[ze,O]),A=a.useMemo(()=>B?ze.get(B)??null:null,[ze,B]);a.useEffect(()=>{Se(""),he(null),je(0),se(!1),Ae(null),me(null),ot({}),_e({selection:[],booleanAnswer:null,ordering:[],matchingRows:[[]]})},[B]);const M=a.useMemo(()=>{var U,Q;if(!A)return null;const W=Z??A.infoType??null,E=A.checkType??"info",J=A.direction??null,X=q??{};if(A.cardType==="vocab"&&$&&Array.isArray($.words)){const be=$.words,K=((U=be[0])==null?void 0:U.label)??"?",ee=((Q=be[1])==null?void 0:Q.label)??"?";return J==="a-to-b"?{kind:"vocab",prompt:String(K),expected:String(ee)}:J==="b-to-a"?{kind:"vocab",prompt:String(ee),expected:String(K)}:{kind:"generic",prompt:`${K} ↔ ${ee}`,expected:`${K} ↔ ${ee}`}}if(W==="citation"&&E==="quote-fragment"&&J&&typeof X.text=="string"){const be=J,K=ka(X.text),ee=K.nodes[be];if(ee){const Le=Hn(X.text,ee);return{kind:"citation-fragment",expected:ee.text,quoteContext:{title:d,before:Le.before,after:Le.after,total:Object.keys(K.nodes).length,completed:0},quotePlaceholder:ee.text.length>0?".".repeat(Math.max(4,Math.min(18,ee.text.length))):"..."}}}if(W==="question"){const be=gi(X);if(be)return{kind:"question",definition:be}}return{kind:"generic",prompt:A.description||A.label,expected:A.label}},[Z,q,A,d,$]);a.useEffect(()=>{if(!M||M.kind!=="question")return;const W=M.definition;_e({selection:[],booleanAnswer:null,ordering:W.type==="ordering"?pi(W.options??[]):[],matchingRows:W.type==="matching"?mi(W):[[]]})},[M,B]);const P=async W=>{if(A&&l)try{await hr({libraryId:c,outcome:{itemType:"info",itemId:A.cardId,checkType:A.checkType??"info",direction:A.direction??null,revisionType:"direct",evalType:"direct-check",correct:W,clientId:"cogita-info-checkcards",clientSequence:R,personRoleId:l}}),ye(E=>E+1),me(W?"Saved as correct.":"Saved as incorrect.")}catch{me("Failed to save answer.")}},L=A?la(A):null,x=L?!!Pe[L]:!1,N=async()=>{var X;if(!A||!M)return;const W=la(A);if(Pe[W]){me("This card was already checked.");return}let E=!1,J=null;if(M.kind==="question"){const U=M.definition;if(U.type==="selection"){const Q=Array.isArray(U.answer)?[...U.answer].sort((K,ee)=>K-ee):[],be=[...Oe.selection].sort((K,ee)=>K-ee);E=Q.length===be.length&&Q.every((K,ee)=>K===be[ee])}else if(U.type==="truefalse")E=typeof U.answer=="boolean"&&Oe.booleanAnswer!==null&&U.answer===Oe.booleanAnswer;else if(U.type==="ordering"){const Q=(U.options??[]).join(`
`),be=Oe.ordering.join(`
`),K=Ia(Q,be,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});E=K.isCorrect,J=K.mask}else if(U.type==="matching"){const Q=Math.max(2,((X=U.columns)==null?void 0:X.length)??2),be=Oe.matchingRows.map(Ve=>Ve.slice(0,Q).map(Ke=>Ke.trim())).filter(Ve=>Ve.every(Ke=>Ke!=="")).map(Ve=>Ve.map(Ke=>Number(Ke))).filter(Ve=>Ve.every(Ke=>Number.isInteger(Ke)&&Ke>=0)).map(Ve=>JSON.stringify(Ve)),K=(U.answer&&typeof U.answer=="object"&&"paths"in U.answer?U.answer.paths:[]).map(Ve=>JSON.stringify(Ve)),ee=Array.from(new Set(be)).sort(),Le=Array.from(new Set(K)).sort();E=ee.length===Le.length&&ee.every((Ve,Ke)=>Ve===Le[Ke])}else{const Q=String(U.answer??""),be=Ia(Q,ue,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});E=be.isCorrect,J=be.mask}Ae(J),se(!0)}else{const U=M.expected,Q=M.kind==="citation-fragment",be=Ia(U,ue,{thresholdPercent:Q?90:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:Q});E=be.isCorrect,Ae(be.mask),se(!0)}he(E?"correct":"incorrect"),je(U=>U+1),me(l?null:"Answer checked locally (not saved: no person selected)."),$e(U=>({...U,[W]:!0})),l&&await P(E)},I=()=>{if(!A||!M)return;const W=la(A);if(Pe[W]||($e(J=>({...J,[W]:!0})),me("Answer revealed (not saved).")),M.kind==="question"){Ae(null);return}const E=Ia(M.expected,M.expected,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:M.kind==="citation-fragment"});Ae(E.mask)},ne=a.useMemo(()=>A?A.infoType==="question"?{...A,description:A.label}:A.infoType==="citation"?{...A,description:d}:{...A,description:A.label}:null,[A,d]),fe=W=>{const E=W.definition,J=x||le,X=E.type==="matching"?(()=>{var Ve;const be=Math.max(2,((Ve=E.columns)==null?void 0:Ve.length)??2),ee=(Oe.matchingRows.length?Oe.matchingRows:[new Array(be).fill("")]).map(Ke=>Array.from({length:be},(Ue,pt)=>Ke[pt]??""));return ee[ee.length-1].some(Ke=>Ke.trim())?[...ee,new Array(be).fill("")]:ee})():[],U=Array.isArray(E.answer)?E.answer:[],Q=E.answer&&typeof E.answer=="object"&&"paths"in E.answer?E.answer.paths:[];return e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:E.question||(A==null?void 0:A.label)}),E.title?e.jsx("p",{className:"cogita-revision-hint",children:E.title}):null,E.type==="selection"?e.jsx("div",{className:"cogita-choice-grid",style:{gridTemplateColumns:"1fr"},children:(E.options??[]).map((be,K)=>e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.6rem"},children:[e.jsx("input",{type:"checkbox",checked:Oe.selection.includes(K),disabled:J,onChange:ee=>_e(Le=>({...Le,selection:ee.target.checked?Array.from(new Set([...Le.selection,K])):Le.selection.filter(Ve=>Ve!==K)}))}),e.jsx("span",{children:be})]},`q-opt:${K}`))}):null,E.type==="truefalse"?e.jsxs("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:[e.jsx("button",{type:"button",className:"ghost","data-active":Oe.booleanAnswer===!0,disabled:J,onClick:()=>_e(be=>({...be,booleanAnswer:!0})),children:"True"}),e.jsx("button",{type:"button",className:"ghost","data-active":Oe.booleanAnswer===!1,disabled:J,onClick:()=>_e(be=>({...be,booleanAnswer:!1})),children:"False"})]}):null,E.type==="text"||E.type==="number"||E.type==="date"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:et,type:E.type==="date"?"date":"text",value:ue,onChange:be=>Se(be.target.value),disabled:J,"data-state":V==="correct"?"correct":V==="incorrect"?"incorrect":void 0})]}):null,E.type==="ordering"?e.jsx("div",{style:{display:"grid",gap:"0.45rem"},children:Oe.ordering.map((be,K)=>e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)"},children:[K+1,"."]}),e.jsx("span",{children:be}),e.jsx("button",{type:"button",className:"ghost",disabled:J||K===0,onClick:()=>_e(ee=>{const Le=[...ee.ordering];return[Le[K-1],Le[K]]=[Le[K],Le[K-1]],{...ee,ordering:Le}}),children:"Up"}),e.jsx("button",{type:"button",className:"ghost",disabled:J||K>=Oe.ordering.length-1,onClick:()=>_e(ee=>{const Le=[...ee.ordering];return[Le[K+1],Le[K]]=[Le[K],Le[K+1]],{...ee,ordering:Le}}),children:"Down"})]},`q-order:${K}:${be}`))}):null,E.type==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.65rem"},children:[(E.columns??[]).map((be,K)=>e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.35rem",padding:"0.6rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:`Column ${K+1}`}),be.map((ee,Le)=>e.jsx("div",{className:"cogita-library-hint",children:`${Le}: ${ee}`},`q-col:${K}:${Le}`))]},`q-col:${K}`)),e.jsxs("div",{style:{display:"grid",gap:"0.4rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:"Paths (0-based indices)"}),X.map((be,K)=>{var Le;const ee=K===X.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:`repeat(${Math.max(2,((Le=E.columns)==null?void 0:Le.length)??2)}, minmax(0, 1fr)) auto`,gap:"0.35rem",alignItems:"center"},children:[be.map((Ve,Ke)=>e.jsx("input",{type:"number",min:0,step:1,value:Ve,disabled:J,onChange:Ue=>_e(pt=>{var Ct;const ht=Math.max(2,((Ct=E.columns)==null?void 0:Ct.length)??2),gt=(pt.matchingRows.length?pt.matchingRows:[new Array(ht).fill("")]).map(zt=>Array.from({length:ht},(At,kt)=>zt[kt]??""));return gt[K]=gt[K]??new Array(ht).fill(""),gt[K][Ke]=Ue.target.value,gt[gt.length-1].some(zt=>zt.trim())&&gt.push(new Array(ht).fill("")),{...pt,matchingRows:gt}})},`q-path:${K}:${Ke}`)),ee?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",disabled:J,onClick:()=>_e(Ve=>{var ht;const Ke=Math.max(2,((ht=E.columns)==null?void 0:ht.length)??2),Ue=Ve.matchingRows.filter((gt,yt)=>yt!==K);return Ue.length===0&&Ue.push(new Array(Ke).fill("")),Ue[Ue.length-1].some(gt=>gt.trim())&&Ue.push(new Array(Ke).fill("")),{...Ve,matchingRows:Ue}}),children:"Remove"})]},`q-path:${K}`)})]})]}):null,e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>void N(),disabled:J,children:t.cogita.library.revision.checkAnswer})}),le?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),E.type==="selection"?e.jsx("p",{children:U.length?U.map(be=>{var K;return`${be}${(K=E.options)!=null&&K[be]?`: ${E.options[be]}`:""}`}).join(", "):"-"}):E.type==="truefalse"?e.jsx("p",{children:String(!!E.answer)}):E.type==="ordering"?e.jsx("ol",{children:(E.options??[]).map((be,K)=>e.jsx("li",{children:be},`ans-order:${K}`))}):E.type==="matching"?e.jsx("div",{style:{display:"grid",gap:"0.35rem"},children:Q.length?Q.map((be,K)=>e.jsx("p",{children:be.join(" → ")},`ans-path:${K}`)):e.jsx("p",{children:"-"})}):e.jsx("p",{children:String(E.answer??"")})]}):e.jsx("div",{className:"cogita-revision-reveal",children:e.jsx("button",{type:"button",className:"ghost",onClick:()=>{se(!0),I()},children:t.cogita.library.revision.showAnswer})})]})},ie=a.useMemo(()=>Z?nt(t,Z):t.cogita.library.infoTypes.any,[t,Z]);return e.jsx(Et,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:ie}),e.jsx("h2",{className:"cogita-card-title",children:d}),e.jsx("p",{className:"cogita-card-subtitle",children:f})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${m.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${O.length}`}),e.jsx("button",{type:"button",className:"cta",disabled:m.length===0,onClick:()=>Ge(`/cogita/library/${c}/revision/run?libraryTarget=revisions&scope=info&infoId=${encodeURIComponent(f)}`),children:"Start revision"})]})]}),p==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):p==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(un,{nodes:Ce,edges:Ye,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:(W,E)=>y(E.id),panOnDrag:!0,children:[e.jsx(hn,{}),e.jsx(gn,{showInteractive:!1})]})}),A?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[M&&ne?e.jsx(Wn,{flashState:V,flashTick:Y,children:M.kind==="question"?fe(M):e.jsx(Qn,{copy:t,currentCard:ne,currentTypeLabel:"",prompt:M.kind==="citation-fragment"?null:M.prompt,languages:[],answer:ue,onAnswerChange:Se,computedExpected:[],computedAnswers:Ze,onComputedAnswerChange:(W,E)=>ot(J=>({...J,[W]:E})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:Te,feedback:V,canAdvance:!1,quoteContext:M.kind==="citation-fragment"?M.quoteContext:null,quotePlaceholder:M.kind==="citation-fragment"?M.quotePlaceholder:null,onCheckAnswer:()=>void N(),onSkip:()=>y(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:le,setShowCorrectAnswer:se,onRevealCorrect:I,answerMask:Ie,expectedAnswer:M.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:et,computedInputRefs:it,scriptMode:We,setScriptMode:ft,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:x||le,hideSkipAction:!0,allowRevealBeforeCheck:!0,autoRevealAfterAnswer:!0,disableCheckAfterAnswer:!0})}):null,l?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),He?e.jsx("p",{className:"cogita-library-hint",children:He}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:m.map(W=>{const E=la(W),J=B===E;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${J?"active":""}`,onClick:()=>y(E),children:[e.jsx("span",{children:W.label}),e.jsx("small",{children:Is(W)})]},E)})})]})]})]})})})})})}function Qa(t,n){var s,r;return((r=(s=t.fields.find(o=>o.fieldType===n))==null?void 0:s.plainValue)==null?void 0:r.trim())??""}function bi(t){return Qa(t,"role_kind").toLowerCase()==="person"}function yi(t){return Qa(t,"label")||Qa(t,"display_name")||Qa(t,"name")||t.roleId}function xi({copy:t,onPersonCreated:n}){const[s,r]=a.useState([]),[o,u]=a.useState("loading"),[h,w]=a.useState(null),[v,S]=a.useState(!1),[c,f]=a.useState(""),l=async()=>{u("loading");try{const m=await Ks();r(m),u("ready")}catch{r([]),u("error")}};a.useEffect(()=>{l()},[]);const d=a.useMemo(()=>s.filter(bi).map(m=>({roleId:m.roleId,label:yi(m)})).sort((m,C)=>m.label.localeCompare(C.label)),[s]),j=async()=>{const m=c.trim();if(!m){w("Name is required.");return}S(!0),w(null);try{const C=await gr({fields:[{fieldType:"role_kind",plainValue:"person"},{fieldType:"label",plainValue:m},{fieldType:"display_name",plainValue:m}]});f(""),w("Person role created."),n==null||n(C.roleId),await l()}catch{w("Failed to create person role.")}finally{S(!1)}};return e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-browser-panel",children:[e.jsx("div",{className:"cogita-info-overview-head",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Cogita"}),e.jsx("h2",{className:"cogita-card-title",children:"Persons"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Select reviewer persons in the header and create new person roles here."})]})}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Create"}),e.jsx("h3",{className:"cogita-detail-title",children:"New person role"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{type:"text",value:c,onChange:m=>f(m.target.value),placeholder:"e.g. Anna Kowalska",disabled:v})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:j,disabled:v,children:v?"Creating...":"Create person"})}),h?e.jsx("p",{className:"cogita-library-hint",children:h}):null]})]}),e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Overview"}),e.jsx("h3",{className:"cogita-detail-title",children:"All person roles"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[o==="loading"?e.jsx("p",{children:"Loading persons..."}):null,o==="error"?e.jsx("p",{children:"Failed to load persons."}):null,o==="ready"&&d.length===0?e.jsx("p",{children:"No person roles found."}):null,o==="ready"&&d.length>0?e.jsxs("div",{className:"cogita-details-grid",children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:"Name"}),e.jsx("span",{children:"Type"}),e.jsx("span",{children:"Role ID"}),e.jsx("span",{})]}),d.map(m=>e.jsxs("div",{className:"cogita-details-row",role:"row",children:[e.jsx("span",{}),e.jsx("span",{title:m.label,children:m.label}),e.jsx("span",{children:"person"}),e.jsx("span",{title:m.roleId,children:m.roleId}),e.jsx("span",{})]},m.roleId))]}):null]})]})]})]})})})})}function vi({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,libraryId:c,collectionId:f}){const{libraryName:l}=ha(c),[d,j]=a.useState([]),[m,C]=a.useState("loading"),[O,b]=a.useState("idle"),p=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),oe=`/#/cogita/library/${c}`,B=()=>{C("loading"),Ds({libraryId:c}).then(k=>{j(k),C("idle")}).catch(()=>{j([]),C("error")})};a.useEffect(()=>{B()},[c]);const y=async k=>{try{await _s({libraryId:c,shareId:k}),B()}catch{B()}},q=async k=>{const Z=`${p}/${k}`;try{await navigator.clipboard.writeText(Z),b("copied")}catch{b("failed")}};return e.jsx(Et,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:oe,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${oe}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[m==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):m==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):d.filter(k=>!f||k.collectionId===f).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:d.filter(k=>!f||k.collectionId===f).map(k=>e.jsxs("div",{className:"cogita-share-row","data-state":k.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:k.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(k.createdUtc).toLocaleString(),k.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),k.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${p}/${k.shareCode}`}):null]}),k.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[k.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>q(k.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>y(k.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},k.shareId))}),O==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):O==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function wi({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,libraryId:c}){const{libraryName:f}=ha(c),[l,d]=a.useState(null),[j,m]=a.useState(null),[C,O]=a.useState(null),[b,p]=a.useState(null),[oe,B]=a.useState(null),[y,q]=a.useState(null),k=a.useRef(null),Z=de=>{if(!Number.isFinite(de))return"0 B";if(de<1024)return`${de} B`;const ue=de/1024;if(ue<1024)return`${ue.toFixed(1)} KB`;const Se=ue/1024;return Se<1024?`${Se.toFixed(1)} MB`:`${(Se/1024).toFixed(1)} GB`},_=async()=>{d(null),B({loadedBytes:0,totalBytes:null,percent:null});try{d(t.cogita.library.overview.exporting);const de=await mr(c,B),ue=URL.createObjectURL(de),Se=document.createElement("a");Se.href=ue,Se.download=`cogita-library-${f||c}.json`,Se.click(),URL.revokeObjectURL(ue),d(t.cogita.library.overview.exportReady)}catch{d(t.cogita.library.overview.exportFail)}finally{B(de=>de??{loadedBytes:0,totalBytes:null,percent:null})}},$=async de=>{var Se;m(null),O(null),p(null);const ue=(Se=de.target.files)==null?void 0:Se[0];if(ue)try{m(t.cogita.library.overview.importing),q({loadedBytes:0,totalBytes:ue.size,percent:0});const He=await pr(c,ue,q,me=>{const R=me.stage==="infos"?t.cogita.library.overview.importStageInfos:me.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;p(t.cogita.library.overview.importLiveProgress.replace("{stage}",R).replace("{done}",String(me.processed)).replace("{total}",String(me.total)).replace("{infos}",String(me.infos)).replace("{connections}",String(me.connections)).replace("{collections}",String(me.collections)))});O({infos:He.infosImported,connections:He.connectionsImported,collections:He.collectionsImported}),m(t.cogita.library.overview.importDone)}catch(He){const me=He instanceof Fs&&He.message?` ${He.message}`:"";m(`${t.cogita.library.overview.importFail}${me}`)}finally{k.current&&(k.current.value="")}};return e.jsx(Et,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:f}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:_,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:k,type:"file",accept:"application/json",onChange:$})]})]}),oe?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:oe.percent??void 0,max:oe.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",Z(oe.loadedBytes)).replace("{total}",oe.totalBytes?Z(oe.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,y?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:y.percent??void 0,max:y.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",Z(y.loadedBytes)).replace("{total}",y.totalBytes?Z(y.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,l?e.jsx("p",{className:"cogita-help",children:l}):null,j?e.jsx("p",{className:"cogita-help",children:j}):null,b?e.jsx("p",{className:"cogita-help",children:b}):null,C?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(C.infos)).replace("{connections}",String(C.connections)).replace("{collections}",String(C.collections))}):null]})]})})})]})})}function ji({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,libraryId:c}){const{libraryName:f}=ha(c),[l,d]=a.useState(""),[j,m]=a.useState([]),C=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Et,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:f}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:O=>d(O.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const O=l.trim();O&&(m(b=>[{id:C(),name:O},...b]),d(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[j.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,j.map(O=>e.jsx("button",{type:"button",className:"ghost",children:O.name},O.id))]})]})]})})})]})})}function ki({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,libraryId:c}){const{libraryName:f}=ha(c),[l,d]=a.useState(""),[j,m]=a.useState([]),C=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Et,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:f}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:O=>d(O.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const O=l.trim();O&&(m(b=>[{id:C(),name:O},...b]),d(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[j.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,j.map(O=>e.jsx("button",{type:"button",className:"ghost",children:O.name},O.id))]})]})]})})})]})})}function Ni({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,libraryId:c}){const{libraryName:f}=ha(c),l=`/#/cogita/library/${c}`,[d,j]=a.useState(""),[m,C]=a.useState([]),[O,b]=a.useState("idle"),[p,oe]=a.useState(0),[B,y]=a.useState(null);a.useEffect(()=>{b("loading");const k=window.setTimeout(()=>{za({libraryId:c,query:d.trim()||void 0,limit:30}).then(Z=>{C(Z.items),oe(Z.total),y(Z.nextCursor??null),b("ready")}).catch(()=>{C([]),oe(0),y(null),b("ready")})},240);return()=>window.clearTimeout(k)},[c,d]);const q=async()=>{if(B){b("loading");try{const k=await za({libraryId:c,query:d.trim()||void 0,limit:30,cursor:B});C(Z=>[...Z,...k.items]),y(k.nextCursor??null),oe(k.total),b("ready")}catch{b("ready")}}};return e.jsx(Et,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:f}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${l}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:d,onChange:k=>j(k.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(m.length)).replace("{total}",String(p||m.length))}),e.jsx("span",{children:O==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:m.length?m.map(k=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${l}/collections/${k.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:k.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(k.itemCount))," ·"," ",k.notes||t.cogita.library.collections.noNotes]})]})},k.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${l}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),B?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:q,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const ke=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,Xt=(t,n,s,r)=>`${t}:${n}:${s??""}:${r??""}`;function Si({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,libraryId:c,collectionId:f}){ha(c);const l=`/#/cogita/library/${c}`,[d,j]=a.useState(t.cogita.library.collections.defaultName),[m,C]=a.useState(null),[O,b]=a.useState(0),[p,oe]=a.useState([]),[B,y]=a.useState("idle"),[q,k]=a.useState(null),Z=a.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(p.length)).replace("{total}",String(O||p.length)),[t,p.length,O]);a.useEffect(()=>{mn(c,f).then($=>{j($.name),C($.notes??null),b($.itemCount)}).catch(()=>{j(t.cogita.library.collections.defaultName),C(null)})},[c,f]),a.useEffect(()=>{y("loading"),Za({libraryId:c,collectionId:f,limit:40}).then($=>{oe($.items),k($.nextCursor??null),b($.total),y("ready")}).catch(()=>{oe([]),k(null),y("ready")})},[c,f]);const _=async()=>{if(q){y("loading");try{const $=await Za({libraryId:c,collectionId:f,limit:40,cursor:q});oe(de=>[...de,...$.items]),k($.nextCursor??null),b($.total),y("ready")}catch{y("ready")}}};return e.jsx(Et,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:d}),e.jsx("p",{className:"cogita-library-subtitle",children:m||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${l}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${l}/collections/${f}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${l}/collections/${f}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:Z}),e.jsx("span",{children:B==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:p.length?p.map($=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:$.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:$.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:$.label}),e.jsx("p",{className:"cogita-card-subtitle",children:$.description})]})},ke($))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),q?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:_,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${l}/collections/${f}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const Ms=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],Ti={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},Ci=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Ii=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function Mi({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,libraryId:c,onCreated:f}){const l=Oa(),{libraryName:d}=ha(c),j=`/#/cogita/library/${c}`,[m,C]=a.useState(null),[O,b]=a.useState(""),[p,oe]=a.useState(""),[B,y,q]=Bn([]),[k,Z,_]=On([]),[$,de]=a.useState(null),[ue,Se]=a.useState(null),He=a.useRef(null),me=a.useMemo(()=>B.find(Y=>Y.id===$)??null,[B,$]);a.useEffect(()=>{const Y=new URLSearchParams(l.search),je=(Y.get("draft")??"").trim(),le=(Y.get("draftType")??"").trim();if(!je||le!=="info-selection"||He.current===je)return;const se=Qr(c,je);if(!se||se.infoIds.length===0)return;const Ie=crypto.randomUUID(),Ae=se.infoIds.length>1?crypto.randomUUID():null,Pe=se.infoIds.map((Te,We)=>({id:crypto.randomUUID(),type:"default",position:{x:80,y:80+We*100},data:{nodeType:"source.info",label:"Selected info",params:{infoId:Te,infoType:"any"}}})),$e=Ae?[{id:Ae,type:"default",position:{x:360,y:120+Math.max(0,(se.infoIds.length-1)*50)},data:{nodeType:"logic.or",label:"Selected infos",params:{}}}]:[],Ze={id:Ie,type:"default",position:{x:660,y:140+Math.max(0,(se.infoIds.length-1)*35)},data:{nodeType:"output.collection",label:"Collection output",params:{}}},ot=Pe.map(Te=>({id:crypto.randomUUID(),source:Te.id,target:Ae??Ie}));Ae&&ot.push({id:crypto.randomUUID(),source:Ae,target:Ie}),y([...Pe,...$e,Ze]),Z(ot),de(Ie),Se(`Draft loaded from ${se.infoIds.length} selected infos. Set name and save to create collection.`),He.current=je},[c,l.search,Z,y]);const R=Y=>{var Ie;const je=crypto.randomUUID(),le=((Ie=Ms.find(Ae=>Ae.type===Y))==null?void 0:Ie.label)??Y,se={...Ti[Y]};y(Ae=>[...Ae,{id:je,type:"default",position:{x:120+Ae.length*40,y:120+Ae.length*40},data:{nodeType:Y,label:le,params:se}}]),de(je)},ye=a.useCallback(Y=>{Z(je=>Vn({...Y,id:crypto.randomUUID()},je))},[Z]),V=Y=>{me&&y(je=>je.map(le=>le.id===me.id?{...le,data:{...le.data,params:Y}}:le))},he=async()=>{if(Se(null),!O.trim()){Se(t.cogita.library.collections.saveRequiredName);return}try{const Y={nodes:B.map(se=>({nodeId:se.id,nodeType:se.data.nodeType,payload:{position:se.position,params:se.data.params}})),edges:k.map(se=>({edgeId:se.id,fromNodeId:se.source,fromPort:se.sourceHandle??null,toNodeId:se.target,toPort:se.targetHandle??null}))};let je=m,le=!1;if(je)await zs({libraryId:c,collectionId:je,nodes:Y.nodes,edges:Y.edges});else{const se=await fr({libraryId:c,name:O.trim(),notes:p.trim()||void 0,items:[],graph:Y});je=se.collectionId,le=!0,C(se.collectionId)}Se(le?t.cogita.library.collections.saveSuccess:t.cogita.library.graph.saveSuccess),f(je)}catch{Se(m?t.cogita.library.graph.saveFail:t.cogita.library.collections.saveFail)}};return e.jsx(Et,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.createKicker}),e.jsx("h1",{className:"cogita-library-title",children:d}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.createSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:j,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${j}/collections`,children:t.cogita.library.actions.collections}),e.jsx("button",{type:"button",className:"cta",onClick:he,children:t.cogita.library.actions.saveCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.collectionInfoTitle}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{value:O,onChange:Y=>b(Y.target.value),placeholder:t.cogita.library.collections.namePlaceholder})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.notesLabel}),e.jsx("textarea",{value:p,onChange:Y=>oe(Y.target.value),placeholder:t.cogita.library.collections.notesPlaceholder})]}),ue?e.jsx("p",{className:"cogita-help",children:ue}):null,e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Ms.map(Y=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>R(Y.type),children:Y.label},Y.type))})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(un,{nodes:B,edges:k,onNodesChange:q,onEdgesChange:_,onConnect:ye,onNodeClick:(Y,je)=>de(je.id),fitView:!0,children:[e.jsx(hn,{color:"rgba(120,160,200,0.2)"}),e.jsx(gn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),me?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:me.data.label}),me.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Gt,{libraryId:c,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:me.data.params.tagId?{id:me.data.params.tagId,label:me.data.params.tagLabel??"",infoType:"topic"}:null,onChange:Y=>V({...me.data.params,tagId:(Y==null?void 0:Y.id)??null,tagLabel:(Y==null?void 0:Y.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:me.data.params.scope??"any",onChange:Y=>V({...me.data.params,scope:Y.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),me.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Gt,{libraryId:c,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:me.data.params.languageId?{id:me.data.params.languageId,label:me.data.params.languageLabel??"",infoType:"language"}:null,onChange:Y=>V({...me.data.params,languageId:(Y==null?void 0:Y.id)??null,languageLabel:(Y==null?void 0:Y.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:me.data.params.scope??"any",onChange:Y=>V({...me.data.params,scope:Y.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),me.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:me.data.params.infoType??"word",onChange:Y=>V({...me.data.params,infoType:Y.target.value}),children:Ii.map(Y=>e.jsx("option",{value:Y.value,children:Y.label},Y.value))})]}),e.jsx(Gt,{libraryId:c,infoType:me.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:me.data.params.infoId?{id:me.data.params.infoId,label:me.data.params.infoLabel??"",infoType:me.data.params.infoType??"word"}:null,onChange:Y=>V({...me.data.params,infoId:(Y==null?void 0:Y.id)??null,infoLabel:(Y==null?void 0:Y.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),me.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:me.data.params.connectionType??"translation",onChange:Y=>V({...me.data.params,connectionType:Y.target.value}),children:Ci.map(Y=>e.jsx("option",{value:Y.value,children:Y.label},Y.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:me.data.params.connectionId??"",onChange:Y=>V({...me.data.params,connectionId:Y.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(me.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const ca=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const n=t.length,s=t.filter(u=>u.correct).length,r=pn(Gn(t));return{score:Math.round(Math.max(0,Math.min(100,r.knowness*100))*100)/100,total:n,correct:s,lastReviewedUtc:r.lastReviewedUtc??null}},Li=t=>{if(t.maskBase64)try{const n=br(t.maskBase64);if(!n.length)return t.correct?1:0;const s=n.reduce((r,o)=>r+o,0);return Math.max(0,Math.min(1,s/n.length/255))}catch{return t.correct?1:0}return t.correct?1:0},Gn=t=>t.map(n=>({correctness:Li(n),createdUtc:n.createdUtc})),pn=(t,n=Date.now())=>{var O;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const r=t.slice().sort((b,p)=>b.createdUtc.localeCompare(p.createdUtc)).slice(-5),o=r.reduce((b,p)=>b+p.correctness,0)/r.length,u=5,h=2,w=.15;let v=0,S=0;for(let b=0;b<r.length;b+=1){const p=new Date(r[b].createdUtc).getTime(),oe=b===r.length-1?n:new Date(r[b+1].createdUtc).getTime(),B=Math.max(0,(oe-p)/(1e3*60)),y=1-Math.exp(-B/u);v+=y,r[b].correctness>.5&&(S+=w)}let c=o*v*h+S;const f=((O=r[r.length-1])==null?void 0:O.createdUtc)??null,l=f?Math.max(0,(n-new Date(f).getTime())/(1e3*60)):0,j=1/(1+Math.log1p(l/60));return c*=j,r.length===1&&r[0].correctness>.5&&(c+=5.44*Math.exp(-l/2)),{knowness:c,avgCorrectness:o,lastReviewedUtc:f}},Ba=t=>{const n=t.slice();for(let s=n.length-1;s>0;s-=1){const r=Math.floor(Math.random()*(s+1));[n[s],n[r]]=[n[r],n[s]]}return n},Ga=t=>t[Math.floor(Math.random()*t.length)],Ai=(t,n)=>{const s=new Map;return t.forEach(r=>s.set(r,Math.random())),t.sort((r,o)=>{const u=n(r)-n(o);return u!==0?u:(s.get(r)??0)-(s.get(o)??0)})},fn=(t,n,s,r,o)=>{if(!t.length)return null;const u=t.filter(w=>!(o!=null&&o.has(ke(w))));if(u.length===0)return null;const h=u.filter(w=>ke(w)!==s);return Ga(h.length?h:u)},$i=(t,n,s,r,o)=>{if(!t.length)return null;let u=Number.POSITIVE_INFINITY;for(const S of t){const c=ke(S);if(s.has(c))continue;const f=n[c]??1;f<u&&(u=f)}if(!Number.isFinite(u))return null;const h=t.filter(S=>{const c=ke(S);return!s.has(c)&&(n[c]??1)===u}),w=h.filter(S=>!o||ke(S)!==o),v=r?w.filter(S=>!r.has(ke(S))):w;return v.length>0?Ga(v):w.length>0?Ga(w):o&&h.some(S=>ke(S)===o)?h.find(S=>ke(S)===o)??null:h.length?Ga(h):null},Hs=(t,n,s,r,o)=>{const u=[],h=t.filter(v=>!o.has(ke(v))&&!s.has(ke(v))&&(n[ke(v)]??0)<1),w=Ai(h,v=>n[ke(v)]??0);for(const v of w){if(u.length>=r)break;u.push(v),o.add(ke(v))}if(u.length<r){const v=Ba(t.filter(S=>!o.has(ke(S))&&s.has(ke(S))));for(const S of v){if(u.length>=r)break;u.push(S),o.add(ke(S))}}return u},Ri=(t,n,s,r)=>Hs(t,n,s,r,new Set),Yn=(t,n,s,r,o,u)=>{const h=Math.max(1,s.stackSize??n),v=Ba(t).filter((j,m,C)=>C.findIndex(O=>ke(O)===ke(j))===m),S=Ri(v,r,o,h),c=new Set,f=new Set,l=fn(S,{},null,c,f),d=l?[l]:[];return l&&f.add(ke(l)),{queue:d,meta:{pool:v,active:S,knownessMap:r,unknownSet:o,outcomesById:u,asked:c,queued:f}}},zn={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,n)=>{const r=Ba(t).filter((o,u,h)=>h.findIndex(w=>ke(w)===ke(o))===u);return{queue:r.slice(0,Math.min(n,r.length)),meta:{}}},applyOutcome:t=>t},Xn=(t,n,s,r)=>{const o=Math.max(1,s.stackSize??n),h=Ba(t).filter((m,C,O)=>O.findIndex(b=>ke(b)===ke(m))===C),w={},v=new Set,S=new Set,c=new Set,f=Math.max(1,s.levels??1);h.forEach(m=>{const C=ke(m),O=r==null?void 0:r[C],b=typeof O=="number"&&Number.isFinite(O)?O:1;w[C]=Math.min(f,Math.max(1,Math.round(b)))});const l=[];if(h.length>0){const m=new Map;h.forEach(O=>{var p;const b=w[ke(O)]??1;m.has(b)||m.set(b,[]),(p=m.get(b))==null||p.push(O)});const C=Array.from(m.keys()).sort((O,b)=>O-b);for(const O of C){if(l.length>=o)break;const b=Ba(m.get(O)??[]);for(const p of b){if(l.length>=o)break;l.push(p)}}}const d=fn(l,w,null,v,S),j=d?[d]:[];return d&&S.add(ke(d)),{queue:j,meta:{pool:h,active:l,levelMap:w,asked:v,queued:S,wrongSinceCorrect:c}}},Ei={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,s)=>Xn(t,n,s),applyOutcome:(t,n,s,r,o)=>{if(!n)return t;const u=Math.max(1,r.levels??1),h=t.meta.pool??[],w=t.meta.active??[],v={...t.meta.levelMap??{}},S=new Set(t.meta.asked??[]),c=new Set(t.meta.queued??[]),f=new Set(t.meta.wrongSinceCorrect??[]),l=ke(n);c.delete(l),S.add(l);const d=v[l]??1;o.correct?(v[l]=f.has(l)?1:Math.min(d+1,u),f.delete(l)):(v[l]=1,f.add(l));const j=o.correct?w.filter(O=>ke(O)!==l):w.slice();if(o.correct&&j.length<Math.max(1,r.stackSize??1)){const O=new Set(j.map(p=>ke(p))),b=$i(h,v,O,S,l);b&&j.push(b)}const m=t.queue.slice(),C=fn(j,v,l,S,c);return C&&(m.push(C),c.add(ke(C))),{queue:m,meta:{pool:h,active:j,levelMap:v,asked:S,queued:c,wrongSinceCorrect:f}}}},Pi={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,n)=>Math.max(1,n.stackSize??t),getProgressTotal:()=>null,prepare:(t,n,s)=>Yn(t,n,s,{},new Set,{}),applyOutcome:(t,n,s,r,o)=>{if(!n)return t;const u=t.meta.pool??[],h=t.meta.active??[],w={...t.meta.knownessMap??{}},v=new Set(t.meta.unknownSet??[]),S={...t.meta.outcomesById??{}},c=new Set(t.meta.asked??[]),f=new Set(t.meta.queued??[]),l=ke(n);f.delete(l),c.add(l);const d={correctness:Math.max(0,Math.min(1,o.correctness??(o.correct?1:0))),createdUtc:o.createdUtc??new Date().toISOString()},m=(S[l]??[]).concat(d).sort((B,y)=>B.createdUtc.localeCompare(y.createdUtc)).slice(-5);S[l]=m,v.delete(l);const C=Date.now();u.forEach(B=>{const y=ke(B),q=S[y]??[];if(q.length===0){w[y]=0,v.add(y);return}const k=pn(q,C);w[y]=k.knowness});const O=h.slice();if((w[l]??0)>=1){const B=O.filter(y=>ke(y)!==l);O.length=0,O.push(...B)}const p=Math.max(1,r.stackSize??s);if(O.length<p){const B=new Set(O.map(q=>ke(q))),y=Hs(u,w,v,p-O.length,B);O.push(...y)}const oe=t.queue.slice();if(oe.length===0||ke(oe[oe.length-1])===l){const B=fn(O,{},l,c,f);B&&(oe.push(B),f.add(ke(B)))}return{queue:oe,meta:{pool:u,active:O,knownessMap:w,unknownSet:v,outcomesById:S,asked:c,queued:f}}}},Ws={random:zn,levels:Ei,temporal:Pi},Fi=Object.values(Ws),Zn=t=>{if(!t)return zn;const n=t.trim().toLowerCase();return n==="random"||n==="levels"||n==="temporal"?Ws[n]:zn},bn=(t,n)=>{const s={...t.defaultSettings};return n&&Object.entries(n).forEach(([r,o])=>{typeof o=="number"&&Number.isFinite(o)&&(s[r]=o),typeof o=="string"&&(s[r]=o)}),t.settingsFields.forEach(r=>{var u;const o=s[r.key];if(r.type==="number"){if(typeof o!="number"||Number.isNaN(o)){s[r.key]=t.defaultSettings[r.key]??0;return}r.min!==void 0&&(s[r.key]=Math.max(r.min,s[r.key])),r.max!==void 0&&(s[r.key]=Math.min(r.max,s[r.key]));return}if(r.type==="select"){const h=((u=r.options)==null?void 0:u.map(w=>w.value))??[];(typeof o!="string"||h.length>0&&!h.includes(o))&&(s[r.key]=t.defaultSettings[r.key]??h[0]??"")}}),s},Qs=(t,n)=>{const s={};return t.settingsFields.forEach(r=>{const o=n.get(r.key);if(o){if(r.type==="number"){const u=Number(o);Number.isNaN(u)||(s[r.key]=u);return}s[r.key]=o}}),bn(t,s)},Ki=(t,n)=>{const s=new URLSearchParams;return t.settingsFields.forEach(r=>{const o=n[r.key];(typeof o=="number"||typeof o=="string")&&s.set(r.key,String(o))}),s};function Ls({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,libraryId:c,collectionId:f,revisionId:l}){const d=dn(),{libraryName:j}=ha(c),m=`/#/cogita/library/${c}`,[C,O]=a.useState(t.cogita.library.collections.defaultName),[b,p]=a.useState([]),[oe,B]=a.useState(f??""),[y,q]=a.useState(""),[k,Z]=a.useState(20),[_,$]=a.useState("random"),[de,ue]=a.useState({}),[Se,He]=a.useState("exact"),[me,R]=a.useState([]),[ye,V]=a.useState(null),[he,Y]=a.useState([]),[je,le]=a.useState([]),[se,Ie]=a.useState(""),[Ae,Pe]=a.useState("idle"),[$e,Ze]=a.useState(null),[ot,Te]=a.useState("idle"),[We,ft]=a.useState("idle"),[Oe,_e]=a.useState("idle"),et=a.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),it=a.useMemo(()=>Zn(_),[_]),Ge=a.useMemo(()=>bn(it,de),[it,de]),Ce=a.useMemo(()=>Ki(it,Ge).toString(),[it,Ge]),ze=a.useMemo(()=>{const x=se.trim().toLocaleLowerCase();return x?je.filter(N=>N.name.toLocaleLowerCase().includes(x)):je},[se,je]);a.useEffect(()=>{B(f??"")},[f]),a.useEffect(()=>{if(!oe){O(t.cogita.library.collections.defaultName);return}mn(c,oe).then(x=>O(x.name)).catch(()=>O(t.cogita.library.collections.defaultName))},[t.cogita.library.collections.defaultName,c,oe]),a.useEffect(()=>{za({libraryId:c,limit:200}).then(x=>p(x.items.map(N=>({collectionId:N.collectionId,name:N.name})))).catch(()=>p([]))},[c]),a.useEffect(()=>{qn({libraryId:c}).then(x=>le(x)).catch(()=>le([]))},[c]),a.useEffect(()=>{l&&Bs({libraryId:c,revisionId:l}).then(x=>{B(x.collectionId),q(x.name),$(x.mode||"random"),He(x.check||"exact"),Z(x.limit||20),ue(x.revisionSettings??{})}).catch(()=>{q("")})},[c,l]),a.useEffect(()=>{Os({libraryId:c}).then(x=>{R(x),!ye&&x.length>0&&V(x[0].roleId)}).catch(()=>{R([])})},[c]);const Ye=()=>{ft("loading"),Ds({libraryId:c}).then(x=>{Y(x),ft("idle")}).catch(()=>{Y([]),ft("error")})};a.useEffect(()=>{Ye()},[c]);const A=async()=>{Pe("working"),Te("idle");try{if(!oe){Pe("error");return}const x=await xr({libraryId:c,collectionId:oe,revisionType:it.id,revisionSettings:Ge,mode:_,check:Se,limit:k});Ze(`${et}/${x.shareCode}${Ce?`?${Ce}`:""}`),Pe("ready"),Ye()}catch{Pe("error")}},M=async()=>{if(l){_e("saving");try{await yr({libraryId:c,collectionId:f??oe,revisionId:l,targetCollectionId:oe,name:y||C,revisionType:it.id,revisionSettings:Ge,mode:_,check:Se,limit:k}),_e("saved"),oe&&d(`/cogita/library/${c}/revisions/${encodeURIComponent(l)}`,{replace:!0})}catch{_e("error")}}},P=async()=>{if($e)try{await navigator.clipboard.writeText($e),Te("copied")}catch{Te("failed")}},L=async x=>{try{await _s({libraryId:c,shareId:x}),Ye()}catch{Ye()}};return e.jsx(Et,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:C}),e.jsx("p",{className:"cogita-library-subtitle",children:j})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:m,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${m}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:oe?`${m}/collections/${oe}`:`${m}/collections`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${m}${l?`/revisions/${encodeURIComponent(l)}/run`:oe?`/collections/${oe}/revision/run`:"/revision/run"}?mode=${encodeURIComponent(_)}&check=${encodeURIComponent(Se)}&limit=${k}${Ce?`&${Ce}`:""}${ye?`&reviewer=${encodeURIComponent(ye)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:se,onChange:x=>Ie(x.target.value),placeholder:t.cogita.workspace.revisionForm.namePlaceholder})}),e.jsxs("div",{className:"cogita-card-list","data-view":"list",children:[e.jsxs("a",{className:"cogita-card-select",href:`${m}/revisions/new`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:t.cogita.workspace.revisionForm.createAction})]}),ze.map(x=>e.jsxs("a",{className:"cogita-card-select",href:`${m}/revisions/${encodeURIComponent(x.revisionId)}`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:x.name})]},x.revisionId))]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsx("select",{value:oe,onChange:x=>B(x.target.value),children:b.map(x=>e.jsx("option",{value:x.collectionId,children:x.name},x.collectionId))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:y,onChange:x=>q(x.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:_,onChange:x=>$(x.target.value),children:Fi.map(x=>e.jsx("option",{value:x.id,children:t.cogita.library.revision[x.labelKey]},x.id))})]}),it.settingsFields.map(x=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[x.labelKey]}),x.type==="select"?e.jsx("select",{value:String(Ge[x.key]??""),onChange:N=>ue(I=>({...I,[x.key]:N.target.value})),children:(x.options??[]).map(N=>e.jsx("option",{value:N.value,children:t.cogita.library.revision[N.labelKey]},N.value))}):e.jsx("input",{type:"number",min:x.min,max:x.max,step:x.step,value:Ge[x.key]??0,onChange:N=>ue(I=>({...I,[x.key]:Number(N.target.value||0)}))})]},x.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),it.id!=="levels"&&it.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:k,onChange:x=>Z(Number(x.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:ye??"",onChange:x=>V(x.target.value||null),children:me.map(x=>e.jsx("option",{value:x.roleId,children:x.label},x.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[l?e.jsx("button",{type:"button",className:"cta ghost",onClick:M,disabled:Oe==="saving",children:Oe==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${m}${l?`/revisions/${encodeURIComponent(l)}/run`:oe?`/collections/${oe}/revision/run`:"/revision/run"}?mode=${encodeURIComponent(_)}&check=${encodeURIComponent(Se)}&limit=${k}${Ce?`&${Ce}`:""}${ye?`&reviewer=${encodeURIComponent(ye)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]}),Oe==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),$e?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:$e,readOnly:!0})]}):null,Ae==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,ot==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):ot==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:A,disabled:Ae==="working",children:Ae==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),$e?e.jsx("button",{type:"button",className:"cta ghost",onClick:P,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),We==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):he.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:he.map(x=>e.jsxs("div",{className:"cogita-share-row","data-state":x.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:x.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(x.createdUtc).toLocaleString(),x.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),x.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>L(x.shareId),children:t.cogita.library.revision.shareRevokeAction})]},x.shareId))})]})]})]})]})})})]})})}const An=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function Gs(t,n,s){if(!t)return null;const r=new Map(t.nodes.map(B=>[B.id,B])),o=new Map,u=new Set,h=B=>{if(typeof B=="number")return B;if(typeof B=="string"){const y=Number(B);return Number.isFinite(y)?y:0}return 0},w=B=>{if(o.has(B))return o.get(B);if(u.has(B))return 0;const y=r.get(B);if(!y)return 0;u.add(B);const q=Z=>{var $,de;return(Z?(($=y.inputsByHandle)==null?void 0:$[Z])??[]:y.inputs??((de=y.inputsByHandle)==null?void 0:de.in)??[]).map(ue=>w(ue))};let k=0;switch(y.type){case"input.random":{const Z=y.min??0,_=y.max??Z+10,$=Math.min(Z,_),de=Math.max(Z,_);k=Math.floor(Math.random()*(de-$+1))+$;break}case"input.const":{k=y.value??0;break}case"input.list":{const Z=(y.list??[]).filter(Boolean),_=Math.round(h(q("index")[0]));k=Z.length?Z[Math.max(0,Math.min(Z.length-1,_))]:String(_);break}case"compute.add":{k=q("in").map(_=>h(_)).reduce((_,$)=>_+$,0);break}case"compute.sub":{const Z=q("add").map($=>h($)),_=q("sub").map($=>h($));k=Z.reduce(($,de)=>$+de,0)-_.reduce(($,de)=>$+de,0);break}case"compute.mul":{const Z=q("in").map(_=>h(_));k=Z.length?Z.reduce((_,$)=>_*$,1):0;break}case"compute.div":{const Z=h(q("num")[0]),_=q("den").map($=>h($)).reduce(($,de)=>$+de,0);k=Math.abs(_)<Number.EPSILON?0:Z/_;break}case"compute.pow":{const Z=h(q("base")[0]),_=h(q("exp")[0]);k=Math.pow(Z,_);break}case"compute.exp":{const Z=h(q("base")[0]),_=h(q("exp")[0]);k=Math.pow(Z,_);break}case"compute.log":{const Z=h(q("value")[0]),_=h(q("base")[0]),$=Math.max(Z,Number.EPSILON);k=Math.abs(_)<Number.EPSILON?Math.log($):Math.log($)/Math.log(_);break}case"compute.abs":{k=Math.abs(h(q("in")[0]));break}case"compute.min":{const Z=q("in").map(_=>h(_));k=Z.length?Math.min(...Z):0;break}case"compute.max":{const Z=q("in").map(_=>h(_));k=Z.length?Math.max(...Z):0;break}case"compute.floor":{k=Math.floor(h(q("in")[0]));break}case"compute.ceil":{k=Math.ceil(h(q("in")[0]));break}case"compute.round":{k=Math.round(h(q("in")[0]));break}case"compute.mod":{const Z=h(q("a")[0]),_=h(q("b")[0]);k=Math.abs(_)<Number.EPSILON?0:Z%_;break}case"compute.concat":{const _=["in1","in2","in3","in4","in5","in6"].flatMap(Se=>q(Se)),$=_.length?_:q("in");k=($.length?$:q()).map(Se=>Se==null?"":String(Se)).join("");break}case"compute.trim":{const Z=q("text")[0]??q("in")[0]??"",_=Z==null?"":String(Z),$=Math.max(0,Math.round(h(q("start")[0]))),de=Math.max(0,Math.round(h(q("end")[0])));$+de>=_.length?k="":k=_.substring($,_.length-de);break}case"output":{k=q("in")[0]??0;break}default:k=0}return u.delete(B),o.set(B,k),k},v=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(B=>B.type==="output").map(B=>B.id);t.nodes.forEach(B=>w(B.id)),v.forEach(B=>w(B));const S=B=>Math.abs(B%1)<1e-5?String(Math.round(B)):B.toFixed(3).replace(/\.?0+$/,""),c=B=>typeof B=="number"?S(B):B??"",f=new Map;v.forEach(B=>{var _,$,de,ue;const y=r.get(B);if(!y)return;const q=($=(_=y.inputsByHandle)==null?void 0:_.name)==null?void 0:$[0],k=q?c(o.get(q)):"",Z=(k==null?void 0:k.toString().trim())||((de=y.outputLabel)==null?void 0:de.trim())||((ue=y.name)==null?void 0:ue.trim())||B;f.set(B,Z)});const l={},d={},j={};v.forEach(B=>{var k,Z;const y=r.get(B);if(!y)return;const q=f.get(B)??(((k=y.outputLabel)==null?void 0:k.trim())||((Z=y.name)==null?void 0:Z.trim())||B);l[q]=c(o.get(B)),y.name&&(d[y.name.trim()]=q),d[B]=q});const m=(B,y)=>{let q=B;return t.nodes.forEach(k=>{var ue,Se;const Z=c(o.get(k.id)),_=v.includes(k.id),$=_?f.get(k.id)??((ue=k.outputLabel)==null?void 0:ue.trim())??((Se=k.name)==null?void 0:Se.trim())??k.id:"",de=_&&y?$:Z;q=q.replace(new RegExp(`\\{\\s*${An(k.id)}\\s*\\}`,"gi"),de),k.name&&(q=q.replace(new RegExp(`\\{\\s*${An(k.name)}\\s*\\}`,"gi"),de)),_&&k.outputLabel&&(q=q.replace(new RegExp(`\\{\\s*${An(k.outputLabel)}\\s*\\}`,"gi"),$))}),q},C=n;let O=C.trim().length>0?C:"";O||(O=v.length?`Compute ${v.join(", ")}`:"Compute"),O=m(O,!0);const b=(s==null?void 0:s.trim())??"",p=b?m(b,!1):"",oe={};return o.forEach((B,y)=>{oe[y]=B,j[y]=c(B);const q=r.get(y);q!=null&&q.name&&(j[q.name.trim()]=c(B))}),{prompt:O,answers:l,values:oe,answerText:p,outputVariables:d,variableValues:j}}function Ys(t){var s;const n=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((s=n[0])==null?void 0:s[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const $n=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function Xs({outcomes:t}){const[n,s]=a.useState("day"),r=a.useMemo(()=>{const o=$n.find(w=>w.id===n)??$n[1],u=Date.now()-o.ms,h=t.filter(w=>new Date(w.createdUtc).getTime()>=u);return ca(h)},[t,n]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:$n.map(o=>e.jsx("button",{type:"button",className:"ghost","data-active":n===o.id,onClick:()=>s(o.id),children:o.label},o.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[r.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[r.correct," / ",r.total]})]})}const Di="cogita-revision",_i=1,nn="outcomes",zi=()=>new Promise((t,n)=>{const s=indexedDB.open(Di,_i);s.onupgradeneeded=()=>{const r=s.result;if(!r.objectStoreNames.contains(nn)){const o=r.createObjectStore(nn,{keyPath:"id"});o.createIndex("byItem","itemKey",{unique:!1}),o.createIndex("byPending","pending",{unique:!1})}},s.onerror=()=>n(s.error),s.onsuccess=()=>t(s.result)}),Va=async(t,n)=>{const s=await zi();return new Promise((r,o)=>{const u=s.transaction(nn,t),h=u.objectStore(nn);n(h).then(r).catch(o),u.onerror=()=>o(u.error)})},Zs=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const n=Array.from(t).map(s=>s.toString(16).padStart(2,"0"));return`${n.slice(0,4).join("")}-${n.slice(4,6).join("")}-${n.slice(6,8).join("")}-${n.slice(8,10).join("")}-${n.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},Bi=()=>{const t="cogita_revision_client_id",n=localStorage.getItem(t);if(n)return n;const s=Zs();return localStorage.setItem(t,s),s},Oi=()=>{const t="cogita_revision_client_seq",n=Number(localStorage.getItem(t)??"0"),s=Number.isFinite(n)?n+1:1;return localStorage.setItem(t,String(s)),s},er=(t,n,s,r)=>Xt(t,n,s,r),sn=async t=>{const n=Bi(),s=Oi(),r=new Date().toISOString(),o={...t,clientId:n,clientSequence:s,createdUtc:r,id:Zs(),pending:!0};return await Va("readwrite",u=>new Promise((h,w)=>{const v={...o,itemKey:er(o.itemType,o.itemId,o.checkType,o.direction)},S=u.add(v);S.onsuccess=()=>h(),S.onerror=()=>w(S.error)})),o},rn=async(t,n,s,r)=>{if(!n)return[];try{const o=er(t,n,s,r);return await Va("readonly",u=>new Promise((h,w)=>{const S=u.index("byItem").getAll(o);S.onsuccess=()=>{const f=(S.result??[]).map(l=>({itemType:l.itemType,itemId:l.itemId,checkType:l.checkType??null,direction:l.direction??null,revisionType:l.revisionType,evalType:l.evalType,correct:l.correct,createdUtc:l.createdUtc,maskBase64:l.maskBase64,payloadBase64:l.payloadBase64,payloadHashBase64:l.payloadHashBase64,clientId:l.clientId,clientSequence:l.clientSequence,personRoleId:l.personRoleId??null})).sort((l,d)=>l.createdUtc.localeCompare(d.createdUtc));h(f)},S.onerror=()=>w(S.error)}))}catch{return[]}},da=async()=>{try{return await Va("readonly",t=>new Promise((n,s)=>{const r=t.getAll();r.onsuccess=()=>{const u=(r.result??[]).map(h=>({itemType:h.itemType,itemId:h.itemId,checkType:h.checkType??null,direction:h.direction??null,revisionType:h.revisionType,evalType:h.evalType,correct:h.correct,createdUtc:h.createdUtc,maskBase64:h.maskBase64,payloadBase64:h.payloadBase64,payloadHashBase64:h.payloadHashBase64,clientId:h.clientId,clientSequence:h.clientSequence,personRoleId:h.personRoleId??null}));n(u)},r.onerror=()=>s(r.error)}))}catch{return[]}},Vi=async(t=100)=>{try{return await Va("readonly",n=>new Promise((s,r)=>{const u=n.index("byPending").getAll(!0);u.onsuccess=()=>{const h=u.result??[];s(h.slice(0,t))},u.onerror=()=>r(u.error)}))}catch{return[]}},qi=async t=>{if(t.length!==0)try{await Va("readwrite",n=>new Promise((s,r)=>{let o=t.length;t.forEach(u=>{const h=n.get(u);h.onsuccess=()=>{const w=h.result;if(w){w.pending=!1;const v=n.put(w);v.onsuccess=()=>{o-=1,o===0&&s()},v.onerror=()=>r(v.error)}else o-=1,o===0&&s()},h.onerror=()=>r(h.error)})}))}catch{}},Rn=async(t,n)=>{const s=await Vi(200);if(s.length===0)return;const r=new Map;s.forEach(o=>{var h;const u=o.personRoleId??n??"";r.has(u)||r.set(u,[]),(h=r.get(u))==null||h.push(o)});for(const[o,u]of r.entries()){const h=u.map(w=>({itemType:w.itemType,itemId:w.itemId,checkType:w.checkType??null,direction:w.direction??null,revisionType:w.revisionType,evalType:w.evalType,correct:w.correct,clientId:w.clientId,clientSequence:w.clientSequence,maskBase64:w.maskBase64??null,payloadHashBase64:w.payloadHashBase64??null,payloadBase64:w.payloadBase64??null,personRoleId:o||null}));try{await vr({libraryId:t,outcomes:h}),await qi(u.map(w=>w.id))}catch{}}},Kt=t=>t.trim().toLowerCase(),Jt=t=>{const n=t==null?void 0:t.trim();return n?{fragmentId:n}:null},on=(t,n)=>{const s=Jt(n);if(!s)return!0;const r=Jt(t);return(r==null?void 0:r.fragmentId)===s.fragmentId},Tt=t=>{const n=t==null?void 0:t.trim().toLowerCase();return n||null},tr=(t,n)=>{if((Tt(t.childItemType)??"info")!==(n.cardType??"").toLowerCase()||t.childItemId!==n.cardId)return!1;const r=Tt(t.childCheckType),o=Tt(t.childDirection),u=Tt(n.checkType),h=Tt(n.direction);return!(r&&r!==u||o&&o!==h)},Ui={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},Ji={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},ln=(t,n,s)=>{if(!s||!n.startsWith(t))return n;const r=n.slice(t.length);if(!r)return n;const o=s==="super"?Ui:Ji,u=r.split("").map(h=>o[h]??h).join("");return t+u},cn=(t,n,s)=>{var h,w,v;if(!t)return((h=n[0])==null?void 0:h.key)??null;const r=new Set(n.map(S=>S.key)),o=/\{([^}]+)\}/g;let u;for(;(u=o.exec(t))!==null;){const S=((w=u[1])==null?void 0:w.trim())??"";if(!S)continue;if(r.has(S))return S;const c=s==null?void 0:s[S];if(c&&r.has(c))return c}return((v=n[0])==null?void 0:v.key)??null},_a=t=>(()=>{const n=new Set;return t.flatMap(s=>{if(s.cardType!=="info"||s.infoType!=="citation")return[s];const r=s.description??"";if(!r.trim())return[s];const o=ka(r),u=Object.keys(o.nodes);return u.length===0?[s]:u.map(h=>({...s,checkType:"quote-fragment",direction:h})).filter(h=>{const w=[h.cardId,h.checkType??"",h.direction??""].join("|");return n.has(w)?!1:(n.add(w),!0)})})})();function En({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,libraryId:c,collectionId:f,revisionId:l}){const d=Oa(),j=`/#/cogita/library/${c}`,m=a.useMemo(()=>new URLSearchParams(d.search),[d.search]),C=Math.max(1,Number(m.get("limit")??20)),O=m.get("mode")??"random",b=a.useMemo(()=>Zn(O),[O]),p=a.useMemo(()=>bn(b,Qs(b,m)),[b,m]),oe=m.get("check")??"exact",B=m.get("reviewer"),y=(m.get("scope")??"").trim(),q=y==="info"||y==="info-selection"?y:"collection",k=q==="info"?(m.get("infoId")??"").trim():"",Z=q==="info-selection"?(m.get("seed")??"").trim():"",[_,$]=a.useState(null),de=f??_??void 0,ue=q==="collection"&&!!de,Se=a.useMemo(()=>t.cogita.library.revision[b.labelKey]??O,[t,O,b]),He=a.useMemo(()=>oe==="exact"?t.cogita.library.revision.checkValue:oe,[t,oe]),[me,R]=a.useState(t.cogita.library.collections.defaultName),[ye,V]=a.useState([]),[he,Y]=a.useState([]),[je,le]=a.useState("idle"),[se,Ie]=a.useState({current:0,total:0}),[Ae,Pe]=a.useState(0),[$e,Ze]=a.useState(""),[ot,Te]=a.useState(null),[We,ft]=a.useState(null),[Oe,_e]=a.useState(null),[et,it]=a.useState(null),[Ge,Ce]=a.useState([]),[ze,Ye]=a.useState({}),[A,M]=a.useState({}),[P,L]=a.useState(null),[x,N]=a.useState(null),[I,ne]=a.useState(null),[fe,ie]=a.useState(null),[W,E]=a.useState(null),[J,X]=a.useState({}),U=a.useRef(0),[Q,be]=a.useState(null),K=a.useRef(null),ee=a.useRef(null),[Le,Ve]=a.useState(null),[Ke,Ue]=a.useState(!1),[pt,ht]=a.useState(null),[gt,yt]=a.useState([]),[Ct,zt]=a.useState(null),At=a.useRef(null),kt=a.useRef(null),[ma,Mt]=a.useState(null),[xt,Nt]=a.useState(0),vt=a.useRef(null),bt=a.useRef({}),[Pt,st]=a.useState(!1),[qe,mt]=a.useState({}),[Ht,Ft]=a.useState([]),Dt=a.useRef(new Map),[re,Zt]=a.useState(new Set),[na,Bt]=a.useState(!1),i=a.useRef(null),z=a.useRef(new Set),pe=a.useRef({});a.useEffect(()=>{if(!l||f){$(null);return}Bs({libraryId:c,revisionId:l}).then(g=>$(g.collectionId)).catch(()=>$(null))},[f,c,l]);const H=ye[Ae]??null,tt=(H==null?void 0:H.checkType)==="translation-match"&&W,lt=a.useRef(new Map),wt=a.useRef(new Map),It=a.useRef(new Map),$t=a.useRef(new Map),jt=a.useMemo(()=>H?H.cardType==="vocab"?t.cogita.library.revision.vocabLabel:H.infoType?nt(t,H.infoType):t.cogita.library.revision.infoLabel:"",[t,H]),Wt=a.useMemo(()=>{var T;return b.id!=="levels"?ye.length:((T=qe.pool)==null?void 0:T.length)??b.getFetchLimit(C,p)},[qe,p,b,ye.length,C]),ea=b.getProgressTotal?b.getProgressTotal(ye,qe,C,p):b.id==="levels"?Math.min(C,Wt):ye.length,sa=ea?Math.min(Ae+1,ea):0,Ot=Math.max(1,Number(p.tries??1)),ra=p.compare??"anchors",Rt=Math.max(0,Math.min(100,Number(p.minCorrectness??0))),St=(p.considerDependencies??"on")==="on",ta=Math.max(0,Math.min(100,Number(p.dependencyThreshold??85))),Yt=g=>{const T=g.slice();for(let D=T.length-1;D>0;D-=1){const ce=Math.floor(Math.random()*(D+1));[T[D],T[ce]]=[T[ce],T[D]]}return T},xa=g=>ya(g,{treatSimilarCharsAsSame:!0})>=Rt,qa=async()=>{const g=await da(),T=new Map,D=new Map,ce=new Map;g.forEach(G=>{const Ne=`${G.itemType}:${G.itemId}`,Be=Xt(G.itemType,G.itemId,G.checkType,G.direction);if(T.has(Ne)||T.set(Ne,[]),T.get(Ne).push(G),D.has(Be)||D.set(Be,[]),D.get(Be).push(G),G.itemType==="info"&&G.checkType==="quote-fragment"&&G.direction){const Xe=`${G.itemId}:${G.direction}`;ce.has(Xe)||ce.set(Xe,[]),ce.get(Xe).push(G)}});const ge=new Map,ae=new Map,xe=new Map;return T.forEach((G,Ne)=>ge.set(Ne,ca(G).score)),D.forEach((G,Ne)=>ae.set(Ne,ca(G).score)),ce.forEach((G,Ne)=>xe.set(Ne,ca(G).score)),{itemKnowness:ge,cardKnowness:ae,fragmentKnowness:xe}},Qt=async g=>{const T=[];let D=null;for(;;){const ce=await Za({libraryId:c,collectionId:g,limit:200,cursor:D});if(T.push(...ce.items),!ce.nextCursor)break;D=ce.nextCursor}return _a(T)},Na=async(g,T)=>{if(Dt.current.has(g))return Dt.current.get(g)??0;const D=await Qt(g);if(D.length===0)return Dt.current.set(g,0),0;const ge=D.reduce((ae,xe)=>{const G=ke(xe);return ae+(T.get(G)??0)},0)/D.length;return Dt.current.set(g,ge),ge},Sa=(g,T)=>{if(!St||g.cardType!=="info"||g.infoType!=="citation"||g.checkType!=="quote-fragment")return!0;const D=Jt(g.direction);if(!(D!=null&&D.fragmentId))return!0;const ce=g.description??"";if(!ce.trim())return!0;const ae=ka(ce).nodes[D.fragmentId];if(!ae||!ae.leftId&&!ae.rightId)return!0;const xe=[ae.leftId,ae.rightId].filter(Be=>!!Be);if(xe.length===0)return!0;const G=xe.map(Be=>{const Xe=Xt("info",g.cardId,"quote-fragment",Be);return T.get(Xe)??0});return G.reduce((Be,Xe)=>Be+Xe,0)/G.length>=ta},Aa=async g=>{const T=qe,D=g.concat(T.active??[]).concat(T.pool??[]).filter((G,Ne,Be)=>Be.findIndex(Xe=>ke(Xe)===ke(G))===Ne);if(!St){Zt(new Set(D.map(ke)));return}const{itemKnowness:ce,cardKnowness:ge}=await qa(),ae=Ht.filter(G=>Tt(G.childItemType)==="collection"&&G.childItemId===f&&!Tt(G.childCheckType)&&!Tt(G.childDirection)),xe=new Set;for(const G of D){if(G.cardType!=="info"){xe.add(ke(G));continue}if(!Sa(G,ge))continue;const Ne=Ht.filter(Je=>tr(Je,G)).concat(ae);if(Ne.length===0){xe.add(ke(G));continue}let Be=0;for(const Je of Ne)if(Tt(Je.parentItemType)==="collection")Be+=await Na(Je.parentItemId,ge);else if(Tt(Je.parentCheckType)||Tt(Je.parentDirection)){const at=Tt(Je.parentCheckType),rt=Tt(Je.parentDirection),ct=Xt(Je.parentItemType,Je.parentItemId,at,rt);Be+=ge.get(ct)??0}else{const at=`${Je.parentItemType}:${Je.parentItemId}`;Be+=ce.get(at)??0}Be/Ne.length>=ta&&xe.add(ke(G))}Zt(xe)},Ua=g=>{for(let T=g;T<ye.length;T+=1){const D=ye[T];if(D&&(!St||D.cardType!=="info"||re.has(ke(D))))return T}return-1},$a=g=>!St||g.cardType!=="info"||re.has(ke(g)),yn=g=>{if(b.id!=="temporal"&&b.id!=="levels")return null;const T=qe,D=(T.active??[]).concat(T.pool??[]),ce=new Set;for(const ge of D){const ae=ke(ge);if(!(ce.has(ae)||g.has(ae))&&(ce.add(ae),$a(ge)))return ge}return null},Vt=a.useMemo(()=>{if(b.id!=="levels")return null;const g=qe,T=g.pool??[],D=g.active??[],ce=g.levelMap??{},ge=Math.max(1,Number(p.levels??1)),ae=Array.from({length:ge},()=>0),xe=new Set(D.map(Xe=>ke(Xe)));T.forEach(Xe=>{const Je=Math.min(ge,Math.max(1,ce[ke(Xe)]??1));ae[Je-1]+=1});const G=T.length||1,Ne=ae.map(Xe=>Xe/G*100),Be=H?ce[ke(H)]??1:null;return{counts:ae,percentages:Ne,currentLevel:Be,levelsCount:ge,activeCount:D.length,poolCount:T.length,activeSet:xe}},[qe,p,b,H]),qt=a.useMemo(()=>{if(b.id!=="temporal")return null;const g=qe,T=g.pool??[],D=g.active??[],ce=g.knownessMap??{},ge=new Set(g.unknownSet??[]);let ae=0;T.forEach(Ne=>{(ce[ke(Ne)]??0)>1&&(ae+=1)});const xe=ge.size,G=D.map(Ne=>({id:ke(Ne),value:ge.has(ke(Ne))?0:Math.max(0,Math.min(1,ce[ke(Ne)]??0))}));return{knownCount:ae,unknownCount:xe,dots:G}},[qe,b]),xn=a.useMemo(()=>{if(!St)return 0;const g=qe;return ye.concat(g.active??[]).concat(g.pool??[]).filter((D,ce,ge)=>ge.findIndex(ae=>ke(ae)===ke(D))===ce).filter(D=>D.cardType==="info"&&!re.has(ke(D))).length},[St,qe,ye,re]);a.useEffect(()=>{if(!St||je!=="ready")return;const g=qe,D=ye.concat(g.active??[]).concat(g.pool??[]).filter((ae,xe,G)=>G.findIndex(Ne=>ke(Ne)===ke(ae))===xe).filter(ae=>ae.cardType!=="info"||re.has(ke(ae))).length,ce=At.current;if(At.current=D,ce===null||D<=ce)return;const ge=D-ce;zt(`New card available (+${ge})`),kt.current&&window.clearTimeout(kt.current),kt.current=window.setTimeout(()=>zt(null),2200)},[St,je,qe,ye,re]),a.useEffect(()=>()=>{kt.current&&window.clearTimeout(kt.current)},[]);const _t=(g,T)=>{const D=b.applyOutcome({queue:ye,meta:qe},H,C,p,{correct:g,correctness:T,createdUtc:new Date().toISOString()});V(D.queue),mt(D.meta);const ce=D.queue[Ae+1];ce&&ga(ce,Ae+1)};a.useEffect(()=>{if(ue&&de){mn(c,de).then(g=>R(g.name)).catch(()=>R(t.cogita.library.collections.defaultName));return}if(q==="info"&&k){ua({libraryId:c,infoId:k}).then(g=>{const T=g.payload??{};R(T.title||T.label||T.name||k)}).catch(()=>R(k||t.cogita.library.revision.runKicker));return}if(q==="info-selection"){const g=Z?ls(c,Z):null,T=(g==null?void 0:g.infoIds.length)??0;R(T>0?`Selected infos (${T})`:"Selected infos");return}R(t.cogita.library.collections.defaultName)},[t,de,ue,c,q,k,Z]),a.useEffect(()=>{Jn({libraryId:c,type:"language"}).then(g=>Y(g)).catch(()=>Y([]))},[c]),a.useEffect(()=>{ue&&Un({libraryId:c}).then(g=>Ft(g.items??[])).catch(()=>Ft([]))},[ue,c]),a.useEffect(()=>{Rn(c,B)},[c,B]),a.useEffect(()=>{Aa(ye)},[ye,Ht,St,ta,de]),a.useEffect(()=>{if(!H||!St){Bt(!1);return}if(H.cardType!=="info"||re.has(ke(H))){Bt(!1);return}const g=Ua(Ae+1);if(g>=0){Bt(!1),Pe(g);return}if(b.id==="temporal"||b.id==="levels"){const T=ye.slice(0,Ae+1),D=ye.slice(Ae+1).filter($a),ce=T.concat(D),ge=new Set(ce.map(ke)),ae=yn(ge);if(ae){const G=ke(ae);ge.has(G)||(ce.push(ae),ge.add(G),mt(Ne=>{const Be=Ne,Xe=new Set(Be.queued??[]);return Xe.add(G),{...Be,queued:Xe}}))}const xe=ce.findIndex((G,Ne)=>Ne!==Ae&&$a(G));if(xe>=0){V(ce),Pe(xe),Bt(!1);return}}Bt(!0)},[H,re,St,Ae,ye,qe,b.id]),a.useEffect(()=>{let g=!0;return(async()=>{le("loading"),Ie({current:0,total:b.id==="levels"?0:b.getFetchLimit(C,p)});try{if(!ue){if(Ft([]),q==="info"){if(!k){g&&(V([]),Ft([]),mt({}),Pe(0),le("ready"));return}const[Je,at]=await Promise.all([Ya({libraryId:c,infoId:k}),Xa({libraryId:c,infoId:k})]);if(!g)return;const rt=_a(Je.items??[]);Ft(at.items??[]);const ct=b.prepare(rt,C,p);V(ct.queue),mt(ct.meta),Pe(0),le("ready"),Ie({current:rt.length,total:rt.length});return}if(q==="info-selection"){const Je=Z?ls(c,Z):null,at=(Je==null?void 0:Je.infoIds)??[];if(!at.length){g&&(V([]),Ft([]),mt({}),Pe(0),le("ready"));return}const rt=await Promise.all(at.map(async pa=>{const[Ut,Ja]=await Promise.all([Ya({libraryId:c,infoId:pa}),Xa({libraryId:c,infoId:pa})]);return{cards:Ut.items??[],deps:Ja.items??[]}}));if(!g)return;const ct=new Map;rt.forEach(pa=>{_a(pa.cards).forEach(Ut=>{ct.set(ke(Ut),Ut)})});const dt=Array.from(ct.values()),ut=new Set(dt.map(ke)),Lt=new Map;rt.forEach(pa=>{(pa.deps??[]).forEach(Ut=>{const Ja=Xt(Ut.parentItemType,Ut.parentItemId,Tt(Ut.parentCheckType),Tt(Ut.parentDirection)),es=Xt(Ut.childItemType,Ut.childItemId,Tt(Ut.childCheckType),Tt(Ut.childDirection));if(!ut.has(Ja)||!ut.has(es))return;const ts=`${Ja}->${es}`;Lt.has(ts)||Lt.set(ts,Ut)})}),Ft(Array.from(Lt.values()));const wa=b.prepare(dt,C,p);V(wa.queue),mt(wa.meta),Pe(0),le("ready"),Ie({current:dt.length,total:dt.length});return}}const D=[];let ce=null,ge=null;do{const Je=await Za({libraryId:c,collectionId:de,limit:300,cursor:ce});if(D.push(...Je.items),(b.id==="levels"||b.id==="temporal")&&Je.total&&(ge=Je.total),Ie(at=>({current:D.length,total:at.total||Je.total||b.getFetchLimit(C,p)})),ce=Je.nextCursor??null,ge!==null&&D.length>=ge||b.id!=="levels"&&b.id!=="temporal"&&D.length>=b.getFetchLimit(C,p))break}while(ce);if(!g)return;const ae=_a(D);let xe;if(b.id==="levels"){const Je=Math.max(1,Number(p.levels??1)),rt=(await da()).reduce((ct,dt)=>{const ut=Xt(dt.itemType,dt.itemId,dt.checkType,dt.direction);return ct[ut]||(ct[ut]=[]),ct[ut].push(dt),ct},{});xe={},ae.forEach(ct=>{const dt=ke(ct),ut=rt[dt]??[],Lt=ut.length>0?ca(ut).score:0,wa=Math.max(1,Math.min(Je,Math.ceil(Lt/100*Je)));xe[dt]=wa})}let G=null,Ne=null,Be=null;if(b.id==="temporal"){const Je=await da(),at=new Set(ae.map(dt=>ke(dt))),rt=Je.reduce((dt,ut)=>{const Lt=Xt(ut.itemType,ut.itemId,ut.checkType,ut.direction);return at.has(Lt)&&(dt[Lt]||(dt[Lt]=[]),dt[Lt].push(ut)),dt},{});G={},Ne=new Set,Be={};const ct=Date.now();ae.forEach(dt=>{const ut=ke(dt),Lt=rt[ut]??[];if(Lt.length===0){G[ut]=0,Ne.add(ut),Be[ut]=[];return}const wa=Gn(Lt);Be[ut]=wa;const pa=pn(wa,ct);G[ut]=pa.knowness})}const Xe=b.id==="levels"?Xn(ae,C,p,xe):b.id==="temporal"?Yn(ae,C,p,G??{},Ne??new Set,Be??{}):b.prepare(ae,C,p);V(Xe.queue),mt(Xe.meta),Pe(0),le("ready"),Ie(Je=>({current:Math.min(Je.current,Je.total),total:Je.total}))}catch{g&&le("error")}})(),()=>{g=!1}},[de,ue,c,C,q,p,b,B,k,Z]),a.useEffect(()=>{if(Ze(""),Te(null),Mt(null),Nt(0),Ce([]),Ye({}),M({}),N(null),ne(null),ie(null),Ue(!1),st(!1),Ve(null),E(null),X({}),!H){ft(null),_e(null),L(null),ht(null);return}H.cardType==="info"&&H.infoType==="computed"&&ft(t.cogita.library.revision.loadingComputed);let g=!0;return ga(H,Ae).then(T=>{!g||!T||(ft(T.prompt),_e(T.expectedAnswer),Ce(T.computedExpected),Ye(T.computedAnswers),L(T.computedValues),N(T.answerTemplate),ne(T.outputVariables),ie(T.variableValues))}),()=>{g=!1}},[H,t]),a.useEffect(()=>{if(!H||H.cardType!=="info"||H.infoType!=="citation"){i.current=null,z.current=new Set,it(null);return}const g=H.description??"",T=(H.label??"").trim(),D=T.replace(/\s+/g," ").trim(),ce=g.replace(/\s+/g," ").trim(),ge=D&&D!==ce?T:t.cogita.library.infoTypes.citation;if(!g){it(null),_e(null);return}const ae=ka(g);i.current=ae,ft(ge);let xe=!0;return qa().then(({fragmentKnowness:G})=>{if(!xe)return;const Ne=new Set,Be={};G.forEach((at,rt)=>{const[ct,dt]=rt.split(":",2);if(ct!==H.cardId)return;const ut=Jt(dt);if(!ut)return;const{fragmentId:Lt}=ut;Be[Lt]=at,at>=ta&&Ne.add(Lt)}),z.current=Ne,pe.current=Be;const Xe=Jt(H.direction);if(Xe!=null&&Xe.fragmentId&&ae.nodes[Xe.fragmentId]){F(ae,Xe.fragmentId,ge);return}const Je=Ma(ae,Ne,Be,ta,St,H.direction);F(ae,(Je==null?void 0:Je.id)??null,ge)}).catch(()=>{z.current=new Set,pe.current={};const G=Jt(H.direction);if(G!=null&&G.fragmentId&&ae.nodes[G.fragmentId]){F(ae,G.fragmentId,ge);return}const Ne=Ma(ae,z.current,{},ta,St,H.direction);F(ae,(Ne==null?void 0:Ne.id)??null,ge)}),()=>{xe=!1}},[H,t,St,ta]),a.useEffect(()=>{if(!H||H.cardType!=="vocab"||H.checkType!=="translation-match"){E(null),X({});return}const D=(qe.pool??qe.active??ye).filter(G=>G.cardType==="vocab"&&G.checkType==="translation-match").filter((G,Ne,Be)=>Be.findIndex(Xe=>Xe.cardId===G.cardId)===Ne);D.some(G=>G.cardId===H.cardId)||D.unshift(H);const ge=Yt(D).slice(0,6).map(G=>{const Ne=G.label.split("↔").map(Je=>Je.trim()).filter(Boolean);if(Ne.length<2)return null;const Be=`${G.cardId}:L`,Xe=`${G.cardId}:R`;return{cardId:G.cardId,leftId:Be,rightId:Xe,leftLabel:Ne[0],rightLabel:Ne[1]}}).filter(Boolean),ae=ge.map(G=>G.leftId),xe=Yt(ge.map(G=>G.rightId));E({pairs:ge,leftOrder:ae,rightOrder:xe,selection:{},activeLeft:null,activeRight:null,locked:{}})},[H,ye,qe]),a.useEffect(()=>()=>{K.current&&window.clearTimeout(K.current),ee.current&&window.clearTimeout(ee.current)},[]);const ia=a.useRef(null);a.useEffect(()=>{if(!H)return;const g=ke(H),T=typeof document<"u"?document.activeElement:null;if(ia.current===g&&T&&(T.tagName==="INPUT"||T.tagName==="TEXTAREA"))return;let D=0;const ce=()=>{if(H){if(H.cardType==="info"&&H.infoType==="computed"){if(Ge.length>0){const ae=cn(x,Ge,I),xe=ae?bt.current[ae]:null;if(xe&&(xe.focus(),document.activeElement===xe)){ia.current=g;return}}if(vt.current&&(vt.current.focus(),document.activeElement===vt.current)){ia.current=g;return}}else if(H.cardType==="vocab"&&vt.current&&(vt.current.focus(),document.activeElement===vt.current)){ia.current=g;return}D<6&&(D+=1,window.setTimeout(ce,40))}},ge=window.setTimeout(ce,40);return()=>window.clearTimeout(ge)},[H,Ge,x,I]),a.useEffect(()=>{if(!Pt)return;const g=T=>{T.key==="Enter"&&(T.preventDefault(),Ca())};return window.addEventListener("keydown",g),()=>window.removeEventListener("keydown",g)},[Pt]);const Ta=g=>{yt(g),ht(ca(g))};a.useEffect(()=>{if(!H){ht(null),yt([]);return}const g=H.cardType==="info"?"info":"connection";if(H.cardType==="info"&&H.infoType==="citation"){da().then(T=>{const D=T.filter(ce=>ce.itemType==="info"&&ce.itemId===H.cardId&&ce.checkType==="quote-fragment"&&on(ce.direction,H.direction));Ta(D)}).catch(()=>{ht(null),yt([])});return}rn(g,H.cardId,H.checkType,H.direction).then(T=>Ta(T)).catch(()=>{ht(null),yt([])})},[c,H,B]);const va=(g,T,D,ce)=>{if(g==="info"&&D==="quote-fragment"){da().then(ge=>{const ae=ge.filter(xe=>xe.itemType==="info"&&xe.itemId===T&&xe.checkType==="quote-fragment"&&on(xe.direction,ce));Ta(ae)}).catch(()=>{ht(null),yt([])});return}rn(g,T,D,ce).then(ge=>Ta(ge)).catch(()=>{ht(null),yt([])})},Ra=(g,T,D)=>{var xe;const ce=((xe=D.pairs.find(G=>G.leftId===g))==null?void 0:xe.rightId)??null;if(!ce)return D;const ge=ce===T;X(G=>({...G,[g]:ge?"correct":"incorrect"})),K.current&&window.clearTimeout(K.current),ee.current&&window.clearTimeout(ee.current),U.current+=1;const ae={kind:ge?"correct":"incorrect",tick:U.current};if(be(null),K.current=window.setTimeout(()=>be(ae),0),ee.current=window.setTimeout(()=>be(null),420),ge){const G={...D.locked,[g]:!0};return Object.keys(G).length>=D.pairs.length?(Te("correct"),st(!0)):Te("correct"),{...D,selection:{...D.selection,[g]:T},activeLeft:null,activeRight:null,locked:G}}return Te("incorrect"),{...D,activeLeft:null,activeRight:null}},vn=g=>{E(T=>!T||T.locked[g]?T:T.activeRight?Ra(g,T.activeRight,T):{...T,activeLeft:T.activeLeft===g?null:g})},wn=g=>{E(T=>T&&(T.activeLeft?Ra(T.activeLeft,g,T):{...T,activeRight:T.activeRight===g?null:g}))},Ca=()=>{var g;if(H&&H.cardType==="info"&&H.infoType==="citation"&&i.current&&et&&!((g=Jt(H.direction))!=null&&g.fragmentId)){const T=Ma(i.current,z.current,pe.current,ta,St,H.direction,et.fragmentId);if(T){Te(null),Ze(""),Ue(!1),M({}),st(!1),Mt(null),Nt(0),F(i.current,T.id,et.title);return}}Te(null),Ze(""),Ue(!1),M({}),st(!1),Mt(null),Nt(0),Pe(T=>Math.min(T+1,ye.length))},aa=g=>{if(!H)return;const T=g.expected??null,D=g.answer??"";let ce=T??"",ge=D;if(!T&&g.expectedMap&&g.answerMap){const Je=Object.keys(g.expectedMap).sort((at,rt)=>at.localeCompare(rt));ce=Je.map(at=>{var rt;return((rt=g.expectedMap)==null?void 0:rt[at])??""}).join("|"),ge=Je.map(at=>{var rt;return((rt=g.answerMap)==null?void 0:rt[at])??""}).join("|")}const ae=ce?La(ce,ge,ra):new Uint8Array,xe={revisionType:b.id,evalType:g.evalType,direction:g.direction,prompt:We??"",expected:T,answer:D,expectedAnswers:g.expectedMap??null,answers:g.answerMap??null,correct:g.correct,maskBase64:ae.length?ba(ae):null,values:P??null,checkMode:oe,compareMode:ra,minCorrectness:Rt},G=new TextEncoder().encode(JSON.stringify(xe)),Ne=H.cardType==="info"?"info":"connection",Be=g.overrideCheckType??H.checkType??null,Xe=g.overrideDirection??H.direction??null;sn({itemType:Ne,itemId:H.cardId,checkType:Be,direction:Xe,revisionType:b.id,evalType:g.evalType,correct:g.correct,maskBase64:ae.length?ba(ae):null,payloadBase64:ba(G),personRoleId:B??null}).then(()=>{va(Ne,H.cardId,Be,Xe),Aa(ye),Rn(c,B)}).catch(()=>{})},jn=(g,T)=>{const D=lt.current.get(T);if(D)return Promise.resolve(D);const ce=wt.current.get(T);if(ce)return ce;const ge=ua({libraryId:c,infoId:g}).then(ae=>{var Je,at;const xe=ae.payload,G=((Je=xe.definition)==null?void 0:Je.graph)??null,Ne="",Be=((at=xe.definition)==null?void 0:at.answerTemplate)??"",Xe=Gs(G,Ne,Be);if(Xe){const ct={sample:Ys(Xe),answerTemplate:Be||null};return lt.current.set(T,ct),ct}return ss({libraryId:c,infoId:g}).then(rt=>{const ct={sample:rt,answerTemplate:null};return lt.current.set(T,ct),ct})}).catch(()=>ss({libraryId:c,infoId:g}).then(ae=>{const xe={sample:ae,answerTemplate:null};return lt.current.set(T,xe),xe}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{wt.current.delete(T)});return wt.current.set(T,ge),ge},ga=(g,T)=>{var G;const D=`${ke(g)}:${T}`,ce=It.current.get(D);if(ce)return Promise.resolve(ce);const ge=$t.current.get(D);if(ge)return ge;const ae=Ne=>(It.current.set(D,Ne),Ne);let xe;if(g.cardType==="vocab"){if(g.checkType==="translation-match")return xe=Promise.resolve(ae({prompt:g.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),xe;const Ne=g.label.split("↔").map(Be=>Be.trim()).filter(Boolean);if(Ne.length>=2){const Xe=(g.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",Je=Xe?Ne[0]:Ne[1],at=Xe?Ne[1]:Ne[0];xe=Promise.resolve(ae({prompt:Je,expectedAnswer:at,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else xe=Promise.resolve(ae({prompt:g.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(g.cardType==="info"&&g.infoType==="word"){const Ne=(G=g.description)!=null&&G.startsWith("Language: ")?g.description.replace("Language: ",""):null;xe=Promise.resolve(ae({prompt:g.label,expectedAnswer:Ne,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else g.cardType==="info"&&g.infoType==="computed"?xe=jn(g.cardId,D).then(Ne=>{var rt,ct;if(!Ne.sample)return ae({prompt:g.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const Be=Ne.sample,Xe=Be.expectedAnswers?Object.entries(Be.expectedAnswers).map(([dt,ut])=>({key:dt,expected:ut})):[],Je=Xe.reduce((dt,ut)=>(dt[ut.key]="",dt),{}),at=Be.expectedAnswerIsSentence&&((rt=Be.expectedAnswer)==null?void 0:rt.trim())||null;return ae({prompt:Be.prompt,expectedAnswer:Xe.length>0?at:((ct=Be.expectedAnswer)==null?void 0:ct.trim())||null,computedExpected:Xe,computedAnswers:Je,computedValues:Be.values??null,answerTemplate:Ne.answerTemplate,outputVariables:Be.outputVariables??null,variableValues:Be.variableValues??null})}).catch(()=>ae({prompt:g.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{$t.current.delete(D)}):xe=Promise.resolve(ae({prompt:g.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return $t.current.set(D,xe),xe},F=(g,T,D)=>{const ce=Object.keys(g.nodes).length,ge=z.current.size;if(!T){it({title:D,before:g.text,after:"",fragmentId:null,total:ce,completed:ge}),_e(null),st(!0);return}const ae=g.nodes[T];if(!ae)return;const xe=Hn(g.text,ae);it({title:D,before:xe.before,after:xe.after,fragmentId:ae.id,total:ce,completed:ge}),_e(xe.fragment),st(!1)},te=()=>{const g=i.current;g&&it(T=>T&&{...T,total:Object.keys(g.nodes).length,completed:z.current.size})},ve=()=>{const g=ye[Ae+1];g&&ga(g,Ae+1)},Fe=()=>{if(ve(),H&&H.cardType==="vocab"&&H.checkType==="translation-match"&&W){if(W.pairs.length===0){Te("incorrect"),st(!0);return}const ae=W.pairs.reduce((at,rt)=>(at[rt.rightId]=rt.rightLabel,at),{});let xe=0;const G={};W.pairs.forEach(at=>{const ct=W.selection[at.leftId]===at.rightId;G[at.leftId]=ct?"correct":"incorrect",ct&&(xe+=1)});const Ne=W.pairs.length||1,Be=xe/Ne,Xe=xe===W.pairs.length;X(at=>({...at,...G})),Xe?(Te("correct"),st(!0),Nt(0)):(Te("incorrect"),st(!1),Nt(at=>{const rt=at+1;return rt>=Ot&&(Ue(!0),st(!0),E(ct=>{if(!ct)return ct;const dt=ct.pairs.reduce((ut,Lt)=>(ut[Lt.leftId]=Lt.rightId,ut),{});return{...ct,selection:dt}})),rt})),_t(Xe,Be);const Je="connection";Promise.all(W.pairs.map(at=>{const rt=W.selection[at.leftId]??null,ct=rt?ae[rt]:"",dt={left:at.leftLabel,expected:at.rightLabel,answer:ct,checkType:"translation-match"},ut=new TextEncoder().encode(JSON.stringify(dt));return sn({itemType:Je,itemId:at.cardId,checkType:"translation-match",direction:null,revisionType:b.id,evalType:"translation-match",correct:rt===at.rightId,maskBase64:null,payloadBase64:ba(ut),personRoleId:B??null})})).then(()=>{va(Je,H.cardId,H.checkType,H.direction),Rn(c,B)}).catch(()=>{});return}if(Ge.length>0){const ae=Ge.reduce((G,Ne)=>{const Be=ze[Ne.key]??"";return G[Ne.key]=Kt(Be)===Kt(Ne.expected)?"correct":"incorrect",G},{});Ge.every(({key:G,expected:Ne})=>{const Be=ze[G]??"";return oe==="exact"&&Kt(Be)===Kt(Ne)})?(Te("correct"),M(ae),st(!0),Nt(0),_t(!0,1),aa({correct:!0,direction:We?`${We} -> computed`:"computed",expectedMap:Ge.reduce((G,Ne)=>(G[Ne.key]=Ne.expected,G),{}),answerMap:ze,evalType:"computed"})):(Te("incorrect"),M(ae),st(!1),Nt(G=>{const Ne=G+1;return Ne>=Ot&&Qe&&(Ue(!0),st(!0)),Ne}),_t(!1,0),window.setTimeout(()=>{var Ne;const G=cn(x,Ge,I);G&&bt.current[G]&&((Ne=bt.current[G])==null||Ne.focus())},40),aa({correct:!1,direction:We?`${We} -> computed`:"computed",expectedMap:Ge.reduce((G,Ne)=>(G[Ne.key]=Ne.expected,G),{}),answerMap:ze,evalType:"computed"}));return}if(H&&H.cardType==="info"&&H.infoType==="citation"&&(et!=null&&et.fragmentId)){if(!Oe)return;const ae=Jt(H.direction),xe=(ae==null?void 0:ae.fragmentId)??et.fragmentId,G=Ia(Oe,$e,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Ne=G.mask,Be=G.isCorrect,Xe=G.percent;Be?(pe.current[et.fragmentId]=Math.max(pe.current[et.fragmentId]??0,Xe),(pe.current[et.fragmentId]??0)>=ta&&z.current.add(et.fragmentId),te(),Te("correct"),M({}),st(!0),Mt(Ne),Nt(0),Xe<100&&Ot<=1&&Ue(!0),_t(!0,Xe/100),aa({correct:!0,direction:`quote:${et.fragmentId}`,expected:Oe,answer:$e,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:xe})):(Te("incorrect"),M({}),st(!1),Mt(Ne),Nt(Je=>{const at=Je+1;return at>=Ot&&Qe&&(Ue(!0),st(!0)),at}),_t(!1,Xe/100),window.setTimeout(()=>{var Je;return(Je=vt.current)==null?void 0:Je.focus()},40),aa({correct:!1,direction:`quote:${et.fragmentId}`,expected:Oe,answer:$e,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:xe}));return}if(!Oe)return;const g=La(Oe,$e,ra),T=oe==="exact"&&Kt($e)===Kt(Oe),D=xa(g),ce=T||D,ge=ya(g);ce?(Te("correct"),M({}),st(!0),Mt(g),Nt(0),ge<100&&Ot<=1&&Ue(!0),_t(!0,ge/100),aa({correct:!0,direction:We?`${We} -> ${Oe}`:null,expected:Oe,answer:$e,evalType:"text"})):(Te("incorrect"),M({}),st(!1),Mt(g),Nt(ae=>{const xe=ae+1;return xe>=Ot&&Qe&&(Ue(!0),st(!0)),xe}),_t(!1,ge/100),window.setTimeout(()=>{var ae;return(ae=vt.current)==null?void 0:ae.focus()},40),aa({correct:!1,direction:We?`${We} -> ${Oe}`:null,expected:Oe,answer:$e,evalType:"text"}))},De=g=>{if(ve(),!Oe)return;const T=La(Oe,g,ra),D=Kt(g)===Kt(Oe),ce=xa(T),ge=D||ce,ae=ya(T);ge?(Te("correct"),M({}),st(!0),Mt(T),Nt(0),ae<100&&Ot<=1&&Ue(!0),_t(!0,ae/100),aa({correct:!0,direction:"word->language",expected:Oe,answer:g,evalType:"language-select"})):(Te("incorrect"),M({}),st(!1),Mt(T),Nt(xe=>{const G=xe+1;return G>=Ot&&Qe&&(Ue(!0),st(!0)),G}),_t(!1,ae/100),aa({correct:!1,direction:"word->language",expected:Oe,answer:g,evalType:"language-select"}))},we=()=>{ve(),Te("correct"),st(!0),Nt(0),_t(!0,1),Oe&&aa({correct:!0,direction:"manual",expected:Oe,answer:$e,evalType:"manual"})},Re=()=>{if(_t(!1,0),H&&H.cardType==="info"&&H.infoType==="citation"){Te(null),Ze(""),Ue(!1),M({}),st(!1),Mt(null),Nt(0),Pe(g=>Math.min(g+1,ye.length));return}Ca()};a.useEffect(()=>{ve()},[Ae,ye]);const Me=g=>{var D;if(g.key!=="Enter")return;if(g.preventDefault(),g.stopPropagation(),Pt){Ca();return}const T=Ge.find(ce=>!(ze[ce.key]??"").trim());if(T){(D=bt.current[T.key])==null||D.focus();return}Fe()},Ee=t.cogita.library.revision.revealModeAfterIncorrect,Qe=Ge.length>0||!!Oe;return e.jsxs(Et,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,children:[je==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${se.total?Math.min(100,Math.max(0,se.current/se.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:se.total?`${Math.min(se.current,se.total)} / ${se.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:me}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",Se).replace("{check}",He)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:j,children:t.cogita.library.actions.libraryOverview}),ue?e.jsxs(e.Fragment,{children:[e.jsx("a",{className:"cta ghost",href:`${j}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${j}/collections/${de}`,children:t.cogita.library.actions.collectionDetail})]}):e.jsx("a",{className:"cta ghost",href:`${j}/list`,children:t.cogita.library.actions.allCards})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:pt?`${pt.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Vt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Vt.currentLevel??"-"," / ",Vt.levelsCount]}):null,pt?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(pt.correct)).replace("{total}",String(pt.total))}),pt.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(pt.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(Xs,{outcomes:gt})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[Ct?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:Ct})}):null,e.jsx(Wn,{feedbackToken:Q?`${Q.kind}-${Q.tick}`:tt?"idle":ot??"idle",children:H?e.jsx(e.Fragment,{children:na?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(Qn,{copy:t,currentCard:H,currentTypeLabel:jt,prompt:We,languages:he,answer:$e,onAnswerChange:g=>Ze(T=>ln(T,g,Le)),computedExpected:Ge,computedAnswers:ze,onComputedAnswerChange:(g,T)=>Ye(D=>({...D,[g]:ln(D[g]??"",T,Le)})),answerTemplate:x,outputVariables:I,variableValues:fe,computedFieldFeedback:A,feedback:ot,canAdvance:Pt,quoteContext:et,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Fe,onSkip:Re,onLanguageSelect:De,onMarkReviewed:we,onAdvance:Ca,showCorrectAnswer:Ke,setShowCorrectAnswer:Ue,onRevealCorrect:()=>st(!0),answerMask:ma,expectedAnswer:Oe,hasExpectedAnswer:Qe,handleComputedKeyDown:Me,answerInputRef:vt,computedInputRefs:bt,scriptMode:Le,setScriptMode:Ve,matchPairs:W==null?void 0:W.pairs,matchLeftOrder:W==null?void 0:W.leftOrder,matchRightOrder:W==null?void 0:W.rightOrder,matchSelection:W==null?void 0:W.selection,matchActiveLeft:W==null?void 0:W.activeLeft,matchActiveRight:W==null?void 0:W.activeRight,matchFeedback:J,onMatchLeftSelect:vn,onMatchRightSelect:wn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:ue?`${j}/collections/${de}`:`${j}/list`,children:ue?t.cogita.library.actions.collectionDetail:t.cogita.library.actions.allCards})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:ea?`${sa} / ${ea}`:t.cogita.library.revision.progressUnlimited}),je==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),je==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),je==="ready"&&ye.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Ee}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",Ot]})]})]}),Vt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Vt.activeCount," / ",Vt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Vt.counts.map((g,T)=>{const D=T+1,ce=Vt.currentLevel===D,ge=Vt.percentages[T]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":ce,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:D}),e.jsx("strong",{children:g})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,ge))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[ge.toFixed(1),"%"]})]},`level-${D}`)})})]}):null,qt?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:qt.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:qt.dots.map(g=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,g.value*100))}%`,background:`rgba(${Math.round(255*(1-g.value))}, ${Math.round(200*g.value)}, 80, 0.9)`}},g.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:qt.knownCount})]})]}):null,St?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:xn})]})}):null]})]})]})})})]})]})}const Pn=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],Hi={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},Wi=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Qi=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function Gi({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,libraryId:c,collectionId:f}){const[l,d]=a.useState(""),[j,m,C]=Bn([]),[O,b,p]=On([]),[oe,B]=a.useState(null),[y,q]=a.useState(null),[k,Z]=a.useState(null),_=`/#/cogita/library/${c}`;a.useEffect(()=>{mn(c,f).then(R=>d(R.name)).catch(()=>d(t.cogita.library.collections.defaultName))},[c,f,t]),a.useEffect(()=>{wr({libraryId:c,collectionId:f}).then(R=>{if(!R.graphId||R.graphId==="00000000-0000-0000-0000-000000000000"){m([]),b([]);return}const ye=R.nodes.map(he=>{var se;const Y=he.payload??{},je=Y.position??{x:120,y:120},le=Y.params??{};return{id:he.nodeId,type:"default",position:je,data:{nodeType:he.nodeType,label:((se=Pn.find(Ie=>Ie.type===he.nodeType))==null?void 0:se.label)??he.nodeType,params:le}}}),V=R.edges.map(he=>({id:he.edgeId,source:he.fromNodeId,target:he.toNodeId,sourceHandle:he.fromPort??void 0,targetHandle:he.toPort??void 0}));m(ye),b(V)}).catch(()=>{m([]),b([])})},[c,f,b,m]);const $=a.useMemo(()=>j.find(R=>R.id===oe)??null,[j,oe]),de=R=>{var Y;const ye=crypto.randomUUID(),V=((Y=Pn.find(je=>je.type===R))==null?void 0:Y.label)??R,he={...Hi[R]};m(je=>[...je,{id:ye,type:"default",position:{x:120+je.length*40,y:120+je.length*40},data:{nodeType:R,label:V,params:he}}]),B(ye)},ue=a.useCallback(R=>{b(ye=>Vn({...R,id:crypto.randomUUID()},ye))},[b]),Se=async()=>{q(null);try{await zs({libraryId:c,collectionId:f,nodes:j.map(R=>({nodeId:R.id,nodeType:R.data.nodeType,payload:{position:R.position,params:R.data.params}})),edges:O.map(R=>({edgeId:R.id,fromNodeId:R.source,fromPort:R.sourceHandle??null,toNodeId:R.target,toPort:R.targetHandle??null}))}),q(t.cogita.library.graph.saveSuccess)}catch{q(t.cogita.library.graph.saveFail)}},He=async()=>{try{const R=await jr({libraryId:c,collectionId:f});Z(R)}catch{Z(null)}},me=R=>{$&&m(ye=>ye.map(V=>V.id===$.id?{...V,data:{...V.data,params:R}}:V))};return e.jsx(Et,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${_}/collections/${f}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:He,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:Se,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Pn.map(R=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>de(R.type),children:R.label},R.type))}),y?e.jsx("p",{className:"cogita-help",children:y}):null,k&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(k.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(k.connections)).replace("{infos}",String(k.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(un,{nodes:j,edges:O,onNodesChange:C,onEdgesChange:p,onConnect:ue,onNodeClick:(R,ye)=>B(ye.id),fitView:!0,children:[e.jsx(hn,{color:"rgba(120,160,200,0.2)"}),e.jsx(gn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),$?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:$.data.label}),$.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Gt,{libraryId:c,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:$.data.params.tagId?{id:$.data.params.tagId,label:$.data.params.tagLabel??"",infoType:"topic"}:null,onChange:R=>me({...$.data.params,tagId:(R==null?void 0:R.id)??null,tagLabel:(R==null?void 0:R.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:$.data.params.scope??"any",onChange:R=>me({...$.data.params,scope:R.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),$.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Gt,{libraryId:c,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:$.data.params.languageId?{id:$.data.params.languageId,label:$.data.params.languageLabel??"",infoType:"language"}:null,onChange:R=>me({...$.data.params,languageId:(R==null?void 0:R.id)??null,languageLabel:(R==null?void 0:R.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:$.data.params.scope??"any",onChange:R=>me({...$.data.params,scope:R.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),$.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:$.data.params.infoType??"word",onChange:R=>me({...$.data.params,infoType:R.target.value}),children:Qi.map(R=>e.jsx("option",{value:R.value,children:R.label},R.value))})]}),e.jsx(Gt,{libraryId:c,infoType:$.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:$.data.params.infoId?{id:$.data.params.infoId,label:$.data.params.infoLabel??"",infoType:$.data.params.infoType??"word"}:null,onChange:R=>me({...$.data.params,infoId:(R==null?void 0:R.id)??null,infoLabel:(R==null?void 0:R.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),$.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:$.data.params.connectionType??"translation",onChange:R=>me({...$.data.params,connectionType:R.target.value}),children:Wi.map(R=>e.jsx("option",{value:R.value,children:R.label},R.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:$.data.params.connectionId??"",onChange:R=>me({...$.data.params,connectionId:R.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes($.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const Fn="cogita.preferences",Kn="cogita.reviewer.preferences",ar=["library_overview","all_cards","all_collections","all_revisions","storyboards","texts","dependencies","transfer"],Dn={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},all_revisions:{requiresCollection:!1,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},Yi=["settings","run","shared"];function Xi(t,n=""){const s=t.split("/").filter(Boolean);if(s[0]!=="cogita"||s[1]!=="library")return{};const r=s[2];if(!r)return{};if(!s[3])return{libraryId:r,target:"library_overview"};const o=new URLSearchParams(n),u=o.get("revisionId")??void 0,h=o.get("infoId")??void 0,w=o.get("infoView"),v=w==="cards"?"cards":w==="collections"?"collections":"overview",S=o.get("collectionView")==="overview"?"overview":"infos",c=o.get("collectionAction"),f=o.get("libraryAction"),d=o.get("libraryTarget")==="revisions"?"all_revisions":"all_collections";if(s[3]==="list")return{libraryId:r,target:f==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:u,infoId:h,infoView:v,libraryAction:f==="new-info"?"new-info":void 0};if(s[3]==="detail"||s[3]==="collection")return{libraryId:r,target:"all_cards",cardMode:s[3],revisionId:u,infoId:h,infoView:v};if(s[3]==="new"||s[3]==="add")return{libraryId:r,target:"new_card",revisionId:u,libraryAction:"new-info"};if(s[3]==="edit")return{libraryId:r,target:"new_card",revisionId:u,infoId:s[4]};if(s[3]==="infos"){const m=s[4];return m?s[5]==="checkcards"?{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u,infoId:m,infoView:"cards"}:s[5]==="collections"?{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u,infoId:m,infoView:"collections"}:{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u,infoId:m,infoView:"overview"}:{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u}}if(s[3]==="shared-revisions")return{libraryId:r,target:d,revisionId:u};if(s[3]==="revisions"){const m=s[4];return m?m==="new"?{libraryId:r,target:"all_revisions",revisionView:"new"}:s[5]==="run"?{libraryId:r,target:"all_revisions",revisionId:m,revisionView:"run"}:s[5]==="shared"?{libraryId:r,target:"all_revisions",revisionId:m,revisionView:"shared"}:{libraryId:r,target:"all_revisions",revisionId:m,revisionView:"settings"}:{libraryId:r,target:"all_revisions"}}if(s[3]==="revision"&&s[4]==="run")return{libraryId:r,target:d,revisionView:"run",revisionId:u,infoId:h,infoView:v};if(s[3]==="dependencies")return{libraryId:r,target:"dependencies"};if(s[3]==="transfer")return{libraryId:r,target:"transfer"};if(s[3]==="storyboards")return s[4]==="new"?{libraryId:r,target:"new_storyboard"}:{libraryId:r,target:"storyboards"};if(s[3]==="texts")return s[4]==="new"?{libraryId:r,target:"new_text"}:{libraryId:r,target:"texts"};if(s[3]!=="collections")return{libraryId:r,target:"library_overview"};if(s[4]==="new")return{libraryId:r,target:"new_collection",revisionId:u};const j=s[4];return j?s[5]==="graph"?{libraryId:r,target:d,collectionId:j,revisionId:u,revisionView:"graph"}:s[5]==="shared-revisions"?{libraryId:r,target:d,collectionId:j,revisionId:u,revisionView:"shared"}:s[5]==="revision"?{libraryId:r,target:d,collectionId:j,revisionId:u,revisionView:s[6]==="run"?"run":"settings",collectionView:S}:c==="new-revision"?{libraryId:r,target:d,collectionId:j,revisionId:u,revisionView:"new"}:{libraryId:r,target:d,collectionId:j,revisionId:u,revisionView:"detail",collectionView:S}:c==="new-collection"?{libraryId:r,target:"new_collection",collectionAction:"new-collection"}:{libraryId:r,target:d}}function As(t,n="library_overview",s,r,o,u,h="overview",w="infos"){const v=(S,c)=>{const f=new URLSearchParams;c!=null&&c.revisionId&&f.set("revisionId",c.revisionId),c!=null&&c.collectionAction&&f.set("collectionAction",c.collectionAction),c!=null&&c.libraryAction&&f.set("libraryAction",c.libraryAction),c!=null&&c.libraryTarget&&f.set("libraryTarget",c.libraryTarget),c!=null&&c.infoId&&f.set("infoId",c.infoId),c!=null&&c.infoView&&(c!=null&&c.infoId)&&f.set("infoView",c.infoView),c!=null&&c.collectionView&&c.collectionView!=="infos"&&f.set("collectionView",c.collectionView);const l=f.toString();return l?`${S}?${l}`:S};if(!t)return"/cogita";if(n==="library_overview")return v(`/cogita/library/${t}`,{revisionId:o});if(n==="all_cards")return u?h==="cards"?v(`/cogita/library/${t}/infos/${u}/checkcards`,{revisionId:o}):h==="collections"?v(`/cogita/library/${t}/infos/${u}/collections`,{revisionId:o}):v(`/cogita/library/${t}/infos/${u}`,{revisionId:o}):v(`/cogita/library/${t}/list`,{revisionId:o,infoId:u,infoView:h});if(n==="new_card")return u?v(`/cogita/library/${t}/edit/${u}`,{revisionId:o}):v(`/cogita/library/${t}/list`,{revisionId:o,libraryAction:"new-info"});if(n==="all_collections"||n==="all_revisions"){const S=n==="all_revisions"?"revisions":void 0;return n==="all_revisions"&&o?r==="run"?v(`/cogita/library/${t}/revisions/${o}/run`,{revisionId:o}):r==="shared"?v(`/cogita/library/${t}/revisions/${o}/shared`,{revisionId:o}):v(`/cogita/library/${t}/revisions/${o}`,{revisionId:o}):n==="all_revisions"&&r==="new"?v(`/cogita/library/${t}/revisions/new`,{revisionId:o}):n==="all_revisions"?r==="run"?v(`/cogita/library/${t}/revision/run`,{revisionId:o,libraryTarget:S}):v(`/cogita/library/${t}/revisions`,{revisionId:o}):!s&&r==="run"?v(`/cogita/library/${t}/revision/run`,{revisionId:o,libraryTarget:S}):s?r==="graph"?v(`/cogita/library/${t}/collections/${s}/graph`,{revisionId:o,libraryTarget:S}):r==="settings"?v(`/cogita/library/${t}/collections/${s}/revision`,{revisionId:o,libraryTarget:S}):r==="run"?v(`/cogita/library/${t}/collections/${s}/revision/run`,{revisionId:o,libraryTarget:S}):r==="shared"?v(`/cogita/library/${t}/collections/${s}/shared-revisions`,{revisionId:o,libraryTarget:S}):r==="new"?v(`/cogita/library/${t}/collections/${s}`,{revisionId:o,libraryTarget:S,collectionAction:"new-revision"}):v(`/cogita/library/${t}/collections/${s}`,{revisionId:o,libraryTarget:S,collectionView:w}):v(`/cogita/library/${t}/collections`,{revisionId:o,libraryTarget:S})}return n==="new_collection"?v(`/cogita/library/${t}/collections`,{revisionId:o,collectionAction:"new-collection"}):n==="transfer"?v(`/cogita/library/${t}/transfer`,{revisionId:o}):n==="storyboards"?v(`/cogita/library/${t}/storyboards`,{revisionId:o}):n==="new_storyboard"?v(`/cogita/library/${t}/storyboards/new`,{revisionId:o}):n==="texts"?v(`/cogita/library/${t}/texts`,{revisionId:o}):n==="new_text"?v(`/cogita/library/${t}/texts/new`,{revisionId:o}):n==="dependencies"?v(`/cogita/library/${t}/dependencies`,{revisionId:o}):v(`/cogita/library/${t}`,{revisionId:o})}function fa(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function Zi(t){return typeof t=="string"&&ar.includes(t)}function eo(t,n){var w;if(!t.length)return null;const s=t.filter(v=>n.has(v.roleId)),r=s.length>0?s:t,o=r.map(v=>{var c,f;const S=((f=(c=v.fields.find(l=>l.fieldType==="role_kind"))==null?void 0:c.plainValue)==null?void 0:f.toLowerCase())??"";return{roleId:v.roleId,roleKind:S}}),u=o.find(v=>v.roleKind.includes("master"));if(u)return u.roleId;const h=o.find(v=>v.roleKind.includes("account")||v.roleKind.includes("user"));return h?h.roleId:((w=r[0])==null?void 0:w.roleId)??null}function to(t){if(!t)return{version:1,byLibrary:{}};try{const n=JSON.parse(t);return!n||typeof n!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:n.lastLibraryId,byLibrary:n.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function ao({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S}){const c=dn(),f=Oa(),l=a.useMemo(()=>Xi(f.pathname,f.search),[f.pathname,f.search]),d=t.cogita.workspace,[j,m]=a.useState([]),[C,O]=a.useState([]),[b,p]=a.useState([]),[oe,B]=a.useState([]),[y,q]=a.useState(void 0),[k,Z]=a.useState("library_overview"),[_,$]=a.useState(void 0),[de,ue]=a.useState(void 0),[Se,He]=a.useState("detail"),[me,R]=a.useState(void 0),[ye,V]=a.useState(!1),[he,Y]=a.useState(!0),[je,le]=a.useState(!1),[se,Ie]=a.useState(!1),[Ae,Pe]=a.useState(null),[$e,Ze]=a.useState(0),[ot,Te]=a.useState(""),[We,ft]=a.useState(""),[Oe,_e]=a.useState(""),[et,it]=a.useState([]),[Ge,Ce]=a.useState(""),[ze,Ye]=a.useState(0),[A,M]=a.useState(null),[P,L]=a.useState(null),x=a.useRef({version:1,byLibrary:{}}),N=a.useRef(!1),I=a.useRef(!1),ne=a.useRef(null),fe=a.useMemo(()=>j.find(i=>i.libraryId===y)??null,[j,y]),ie=a.useMemo(()=>C.find(i=>i.collectionId===_)??null,[C,_]),W=fa(f.pathname)==="/cogita/persons";a.useEffect(()=>{if(!y){it([]),Ce("");return}let i=!1;return Os({libraryId:y}).then(z=>{if(i)return;const pe=z.filter(H=>(H.roleKind??"").trim().toLowerCase()==="person");it(pe);try{const H=window.localStorage.getItem(Kn),lt=(H?JSON.parse(H):{})[y]??"",wt=lt&&pe.some(It=>It.roleId===lt)?lt:"";Ce(wt)}catch{Ce("")}}).catch(()=>{i||(it([]),Ce(""))}),()=>{i=!0}},[y,ze]),a.useEffect(()=>{if(y)try{const i=window.localStorage.getItem(Kn),z=i?JSON.parse(i):{};Ge?z[y]=Ge:delete z[y],window.localStorage.setItem(Kn,JSON.stringify(z))}catch{}},[y,Ge]);const E=a.useMemo(()=>oe.find(i=>i.revisionId===de)??null,[oe,de]),J=a.useMemo(()=>({detail:d.revisions.detail,graph:d.revisions.graph,settings:d.revisions.settings,run:d.revisions.run,shared:d.targets.sharedRevisions,new:d.revisionForm.createAction}),[d.revisions.detail,d.revisions.graph,d.revisions.run,d.revisions.settings,d.targets.sharedRevisions,d.revisionForm.createAction]),X=a.useMemo(()=>k==="new_card"?"all_cards":k==="new_collection"?"all_collections":k==="new_storyboard"?"storyboards":k==="new_text"?"texts":k,[k]),U=a.useMemo(()=>Se==="new"?"settings":Se,[Se]),Q=k==="all_collections"||k==="all_revisions",be=a.useMemo(()=>k==="new_collection"?"create":k==="all_collections"&&_?"selected":"search",[_,k]),K=a.useMemo(()=>l.infoId?"selected":k==="new_card"?"create":"search",[l.infoId,k]),ee=a.useMemo(()=>b.find(i=>i.infoId===l.infoId)??null,[b,l.infoId]),Le=a.useMemo(()=>({library_overview:d.targets.libraryOverview,all_cards:d.targets.allCards,new_card:d.targets.newCard,all_collections:d.targets.allCollections,all_revisions:d.targets.allRevisions,new_collection:d.targets.newCollection,transfer:d.targets.transfer,storyboards:d.targets.storyboards,new_storyboard:d.targets.newStoryboard,texts:d.targets.texts,new_text:d.targets.newText,dependencies:d.targets.dependencies}),[d.targets]),Ve=a.useMemo(()=>Le[X]??X,[X,Le]),Ke=J[U],Ue=!!y,pt=a.useMemo(()=>{const i=v==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":v==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return v==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:i},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:i},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:i},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:i},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:i},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:i},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:i},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:i},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:i},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:i},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:i},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:i},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:i},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:v==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:i},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:i},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:i},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:i},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:i},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:i},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:i},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:i},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:i},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:i},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:i},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:i},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:i},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:i},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:i},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:i},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:i},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:i},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:i},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:i},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:i},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:i},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:i},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:i},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:i},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:i},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[v]),ht=pt.length,gt=Math.max(0,Math.min($e,ht-1)),yt=pt[gt],Ct=!!_,zt=Ue&&k==="all_collections",At=Ct&&k==="all_collections",kt=Ue&&(k==="all_revisions"||Ct&&k==="all_collections")&&(U==="settings"||U==="run"||U==="shared"||k==="all_revisions"),ma=kt,Mt=kt&&!!de,xt=a.useCallback(i=>{const z=!!i.libraryId;let pe=i.target,H=i.collectionId,tt=i.revisionId,lt=i.revisionView,wt=i.infoId,It=i.infoView??l.infoView??"overview",$t=i.collectionView??l.collectionView??"infos";z?Dn[pe].requiresCollection&&!H?(pe=pe==="all_revisions"?"all_revisions":"all_collections",tt=void 0,lt="detail"):pe!=="all_collections"&&pe!=="all_revisions"?(H=void 0,tt=void 0,pe!=="new_card"&&pe!=="all_cards"&&(wt=void 0,It="overview"),pe!=="new_collection"&&($t="infos")):Dn[pe].allowsRevision?Yi.includes(lt)||(tt=void 0):lt="detail":(pe="library_overview",H=void 0,tt=void 0,lt="detail",wt=void 0,It="overview",$t="infos"),q(i.libraryId),Z(pe),$(H),ue(tt),He(lt),V(!1);const jt=fa(As(i.libraryId,pe,H,lt,tt,wt,It,$t));fa(`${f.pathname}${f.search}`)!==jt&&(ne.current=jt,c(jt))},[f.pathname,f.search,c,l.collectionView,l.infoView]),Nt=a.useMemo(()=>[{key:"library",label:d.layers.library,visible:!0,value:y??"",selectedLabel:(fe==null?void 0:fe.name)??d.path.noLibrarySelected,disabled:he||j.length===0,options:j.map(i=>({value:i.libraryId,label:i.name})),emptyOption:d.noLibraryOption,onSelect:i=>{const z=i||void 0;xt({libraryId:z,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:d.layers.target,visible:Ue,value:X,selectedLabel:Ve,disabled:!Ue,options:ar.map(i=>({value:i,label:Le[i]})),onSelect:i=>{const z=i;xt({libraryId:y,target:z,collectionId:_,revisionId:de,revisionView:Se,infoId:z==="new_card"?l.infoId:void 0})}},{key:"info_mode",label:d.layers.target,visible:X==="all_cards",value:K,selectedLabel:K==="create"?d.infoMode.create:K==="selected"?(ee==null?void 0:ee.label)??me??t.cogita.library.list.selectedEmpty:d.infoMode.search,disabled:!Ue,options:[{value:"search",label:d.infoMode.search},{value:"create",label:d.infoMode.create},...l.infoId?[{value:"selected",label:(ee==null?void 0:ee.label)??me??t.cogita.library.list.selectedEmpty}]:[]],onSelect:i=>{if(i==="selected"){if(!l.infoId)return;xt({libraryId:y,target:"all_cards",collectionId:_,revisionId:de,revisionView:Se,infoId:l.infoId,infoView:"overview"});return}if(i==="create"){xt({libraryId:y,target:"new_card",collectionId:_,revisionId:de,revisionView:Se,infoId:void 0});return}xt({libraryId:y,target:"all_cards",collectionId:_,revisionId:de,revisionView:Se,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:d.layers.target,visible:X==="all_cards"&&!!l.infoId,value:k==="new_card"&&l.infoId?"edit":l.infoView==="cards"?"cards":l.infoView==="collections"?"collections":"overview",selectedLabel:k==="new_card"&&l.infoId?d.infoActions.edit:l.infoView==="cards"?d.infoActions.seeCards:l.infoView==="collections"?"Kolekcje":d.infoActions.overview,disabled:!Ue||!l.infoId,options:[{value:"overview",label:d.infoActions.overview},{value:"edit",label:d.infoActions.edit},{value:"cards",label:d.infoActions.seeCards},{value:"collections",label:"Kolekcje"}],onSelect:i=>{if(l.infoId){if(i==="edit"){xt({libraryId:y,target:"new_card",collectionId:_,revisionId:de,revisionView:Se,infoId:l.infoId});return}if(i==="cards"){xt({libraryId:y,target:"all_cards",collectionId:_,revisionId:de,revisionView:Se,infoId:l.infoId,infoView:"cards"});return}xt({libraryId:y,target:"all_cards",collectionId:_,revisionId:de,revisionView:Se,infoId:l.infoId,infoView:"overview"})}}},{key:"collection_mode",label:d.layers.collection,visible:Ue&&(k==="all_collections"||k==="new_collection"),value:be,selectedLabel:be==="create"?t.cogita.library.actions.createCollection:be==="selected"?(ie==null?void 0:ie.name)??d.path.noCollectionSelected:t.cogita.library.actions.collections,disabled:!Ue,options:[{value:"search",label:t.cogita.library.actions.collections},{value:"create",label:t.cogita.library.actions.createCollection},..._&&ie?[{value:"selected",label:ie.name}]:[]],onSelect:i=>{if(i==="create"){xt({libraryId:y,target:"new_collection",collectionId:void 0,revisionId:void 0,revisionView:"detail"});return}if(i==="selected"&&_){const z=Q?k:"all_collections";xt({libraryId:y,target:z,collectionId:_,revisionId:de,revisionView:z==="all_revisions"?"settings":"detail"});return}if(i==="collections"){xt({libraryId:y,target:"all_cards",collectionId:_,revisionId:de,revisionView:Se,infoId:l.infoId,infoView:"collections"});return}xt({libraryId:y,target:Q?k:"all_collections",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection",label:d.layers.collection,visible:zt&&be!=="create",value:_??"",selectedLabel:(ie==null?void 0:ie.name)??d.path.noCollectionSelected,disabled:!Ue||je||C.length===0,options:C.map(i=>({value:i.collectionId,label:i.name})),emptyOption:d.selectCollectionOption,onSelect:i=>{const z=i||void 0,pe=Q?k:"all_collections";xt({libraryId:y,target:pe,collectionId:z,revisionId:void 0,revisionView:pe==="all_revisions"?"settings":"detail"})}},{key:"collection_selected_action",label:d.layers.revision,visible:At,value:k==="all_revisions"?"revisions":U==="graph"?"edit":U==="settings"||U==="run"||U==="shared"?"revisions":(l.collectionView??"infos")==="overview"?"overview":"infos",selectedLabel:k==="all_revisions"?d.targets.allRevisions:U==="graph"?"Edytuj":U==="settings"||U==="run"||U==="shared"?d.targets.allRevisions:(l.collectionView??"infos")==="overview"?"Przegląd":"Informacje",disabled:!_,options:[{value:"overview",label:"Przegląd"},{value:"edit",label:"Edytuj"},{value:"infos",label:"Informacje"},{value:"revisions",label:d.targets.allRevisions}],onSelect:i=>{if(_){if(i==="edit"){xt({libraryId:y,target:Q?k:"all_collections",collectionId:_,revisionId:void 0,revisionView:"graph"});return}if(i==="revisions"){xt({libraryId:y,target:Q?k:"all_collections",collectionId:_,revisionId:de,revisionView:"settings"});return}xt({libraryId:y,target:Q?k:"all_collections",collectionId:_,revisionId:void 0,revisionView:"detail",infoId:l.infoId,infoView:l.infoView,collectionView:i==="overview"?"overview":"infos"})}}},{key:"revision_entry",label:d.layers.revision,visible:ma,value:de??"",selectedLabel:(E==null?void 0:E.name)??d.status.noRevisions,disabled:(k==="all_revisions"?!Ue:!Ct)||se||oe.length===0,options:oe.map(i=>({value:i.revisionId,label:i.name})),emptyOption:d.status.noRevisions,onSelect:i=>{xt({libraryId:y,target:Q?k:"all_collections",collectionId:_,revisionId:i||void 0,revisionView:U==="settings"||U==="run"||U==="shared"?U:"settings"})}},{key:"revision_selected_action",label:d.layers.revision,visible:Mt,value:U==="run"?"run":U==="shared"?"shared":"settings",selectedLabel:U==="run"?d.revisions.run:U==="shared"?d.targets.sharedRevisions:d.revisions.settings,disabled:!_||!de,options:[{value:"settings",label:d.revisions.settings},{value:"run",label:d.revisions.run},{value:"shared",label:d.targets.sharedRevisions}],onSelect:i=>{!_||!de||xt({libraryId:y,target:Q?k:"all_collections",collectionId:_,revisionId:de,revisionView:i==="run"?"run":i==="shared"?"shared":"settings"})}}],[C,je,K,b,j,he,xt,oe,se,ie,_,ee,E,de,me,Ct,Ue,fe,Q,y,Ke,Se,k,U,X,Ve,zt,At,ma,Mt,Le,t.cogita.library.list.selectedEmpty,l.infoId,l.infoView,l.collectionView,d.infoActions.edit,d.infoActions.overview,d.infoActions.seeCards,d.layers.collection,d.layers.library,d.layers.revision,d.layers.target,d.noLibraryOption,d.path.noCollectionSelected,d.path.noLibrarySelected,d.selectCollectionOption,d.targets.allRevisions,d.revisions.run,d.revisions.settings,d.targets.sharedRevisions,be]),vt=a.useMemo(()=>Nt.filter(i=>i.visible),[Nt]),bt=a.useMemo(()=>vt.filter(i=>i.key!=="library"&&i.key!=="collection"),[vt]),Pt=a.useMemo(()=>bt.find(i=>i.key==="target")??null,[bt]),st=a.useMemo(()=>bt.find(i=>i.key==="info_mode")??null,[bt]),qe=a.useMemo(()=>bt.find(i=>i.key==="info_selected_action")??null,[bt]),mt=a.useMemo(()=>bt.find(i=>i.key==="collection_mode")??null,[bt]),Ht=a.useMemo(()=>bt.find(i=>i.key==="collection_selected_action")??null,[bt]),Ft=a.useMemo(()=>bt.find(i=>i.key==="revision_entry")??null,[bt]),Dt=a.useMemo(()=>bt.find(i=>i.key==="revision_selected_action")??null,[bt]),re=a.useCallback((i,z)=>i?e.jsx("div",{className:"cogita-sidebar-actions",children:i.options.map(pe=>e.jsx("button",{type:"button",className:`ghost ${String(i.value)===pe.value?"active":""}`,onClick:()=>i.onSelect(pe.value),disabled:i.disabled,children:pe.label},`${z}:${i.key}:${pe.value}`))}):null,[]),Zt=a.useMemo(()=>{const i=l.libraryId;if(!i||!f.pathname.startsWith("/cogita/library/"))return null;const z={copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,libraryId:i};if(l.target==="library_overview")return e.jsx(_r,{...z});if(l.target==="all_cards")return l.infoId&&l.infoView==="cards"?e.jsx(fi,{...z,infoId:l.infoId,selectedReviewerRoleId:Ge||null}):e.jsx(Yr,{...z,mode:l.cardMode??"list"});if(l.target==="new_card")return e.jsx(oi,{...z,editInfoId:l.infoId});if(l.target==="dependencies")return e.jsx(ci,{...z});if(l.target==="transfer")return e.jsx(wi,{...z});if(l.target==="storyboards"||l.target==="new_storyboard")return e.jsx(ji,{...z});if(l.target==="texts"||l.target==="new_text")return e.jsx(ki,{...z});if(l.target==="all_collections"||l.target==="all_revisions"){if(l.target==="all_revisions"&&!l.collectionId)return l.revisionView==="run"?e.jsx(En,{...z,revisionId:l.revisionId}):e.jsx(Ls,{...z,revisionId:l.revisionId});if(!l.collectionId&&l.revisionView==="run")return e.jsx(En,{...z,revisionId:l.revisionId});if(l.collectionId){const pe={...z,collectionId:l.collectionId};return l.revisionView==="graph"?e.jsx(Gi,{...pe}):l.revisionView==="shared"?e.jsx(vi,{...z,collectionId:l.collectionId}):l.revisionView==="settings"?e.jsx(Ls,{...pe,revisionId:l.revisionId}):l.revisionView==="run"?e.jsx(En,{...pe,revisionId:l.revisionId}):e.jsx(Si,{...pe})}return e.jsx(Ni,{...z})}return l.target==="new_collection"?e.jsx(Mi,{...z,onCreated:pe=>{xt({libraryId:i,target:k==="all_revisions"?"all_revisions":"all_collections",collectionId:pe,revisionId:void 0,revisionView:"graph"})}}):null},[n,xt,t,v,f.pathname,c,S,u,w,r,o,l.cardMode,l.collectionId,l.infoId,l.libraryId,l.revisionId,l.revisionView,l.target,h,s,k,Ge]);a.useEffect(()=>{let i=!1;return(async()=>{var pe,H,tt,lt,wt;Y(!0);try{await kr();const[It,$t,jt]=await Promise.all([Es(),Ks(),Nr()]);if(i)return;m(It);const Wt=new Set(jt.nodes.filter(Rt=>Rt.nodeType==="role"&&Rt.canLink).map(Rt=>Rt.roleId??"")),ea=eo($t,Wt);if(M(ea),ea){const Rt=jt.nodes.find(St=>St.nodeType==="data"&&St.roleId===ea&&(St.fieldType===Fn||St.label===Fn));L((Rt==null?void 0:Rt.dataKeyId)??null),x.current=to(Rt==null?void 0:Rt.value)}const sa=(pe=It.find(Rt=>Rt.libraryId===l.libraryId))==null?void 0:pe.libraryId,Ot=sa?(tt=(H=x.current.byLibrary)==null?void 0:H[sa])==null?void 0:tt.lastTarget:void 0,ra=Zi(Ot)?Ot:"library_overview";q(sa),Z(l.target??ra),ue(l.revisionId??(sa?(wt=(lt=x.current.byLibrary)==null?void 0:lt[sa])==null?void 0:wt.lastRevisionId:void 0)),He(l.revisionView??"detail"),N.current=!0}catch{i||Pe(d.status.loadFailed)}finally{i||Y(!1)}})(),()=>{i=!0}},[d.status.loadFailed]),a.useLayoutEffect(()=>{if(N.current){if(!l.libraryId){q(void 0),Z(l.target??"library_overview"),$(void 0),ue(void 0),He("detail");return}l.libraryId&&j.some(i=>i.libraryId===l.libraryId)&&q(l.libraryId),l.target&&Z(l.target),$(l.collectionId),ue(l.revisionId),l.revisionView&&He(l.revisionView)}},[j,l.collectionId,l.libraryId,l.revisionId,l.revisionView,l.target]),a.useEffect(()=>{if(!y){O([]),$(void 0),p([]),B([]),ue(void 0);return}let i=!1;return le(!0),za({libraryId:y,limit:200}).then(z=>{var tt;if(i)return;const pe=z.items;O(pe);const H=(tt=pe.find(lt=>lt.collectionId===l.collectionId))==null?void 0:tt.collectionId;$(H)}).catch(()=>{i||(O([]),$(void 0))}).finally(()=>{i||le(!1)}),()=>{i=!0}},[l.collectionId,y]),a.useEffect(()=>{if(!y||X!=="all_cards"&&k!=="new_card"){p([]);return}let i=!1;return Jn({libraryId:y,limit:200}).then(z=>{i||p(z)}).catch(()=>{i||p([])}),()=>{i=!0}},[X,y,k]),a.useEffect(()=>{if(!y||k!=="all_revisions"&&!_){B([]),k!=="all_revisions"&&ue(void 0);return}let i=!1;return Ie(!0),qn({libraryId:y,collectionId:k==="all_revisions"?void 0:_}).then(z=>{var tt,lt,wt,It;if(i)return;B(z);const pe=(lt=(tt=x.current.byLibrary)==null?void 0:tt[y])==null?void 0:lt.lastRevisionId,H=((wt=z.find($t=>$t.revisionId===l.revisionId))==null?void 0:wt.revisionId)??((It=z.find($t=>$t.revisionId===pe))==null?void 0:It.revisionId);ue(H)}).catch(()=>{i||(B([]),ue(void 0))}).finally(()=>{i||Ie(!1)}),()=>{i=!0}},[l.revisionId,_,y,k]),a.useEffect(()=>{const i=l.infoId;if(!y||!i){R(void 0);return}let z=!1;return ua({libraryId:y,infoId:i}).then(pe=>{if(z)return;const H=pe.payload??{},tt=H.definition&&typeof H.definition=="object"?H.definition:null,lt=typeof(tt==null?void 0:tt.title)=="string"?tt.title:void 0,wt=typeof(tt==null?void 0:tt.question)=="string"?tt.question:void 0,It=typeof H.label=="string"?H.label:void 0,$t=typeof H.name=="string"?H.name:void 0,jt=typeof H.title=="string"?H.title:void 0;R(lt??wt??It??$t??jt??pe.infoId)}).catch(()=>{z||R(i)}),()=>{z=!0}},[l.infoId,y]),a.useEffect(()=>{if(!N.current||l.libraryId&&j.some(tt=>tt.libraryId===l.libraryId)&&l.libraryId!==y||l.target&&l.target!==k||l.revisionView&&l.revisionView!==Se||l.revisionId&&l.revisionId!==de||Dn[k].requiresCollection&&!_&&(l.target==="all_collections"||l.target==="all_revisions")&&l.collectionId)return;const i=fa(`${f.pathname}${f.search}`);if(fa(f.pathname)==="/cogita"&&!l.libraryId&&!y){ne.current=null;return}if(fa(f.pathname)==="/cogita/persons"){ne.current=null;return}if(fa(f.pathname)===`/cogita/library/${y}/revision/run`&&l.revisionView==="run"&&!l.collectionId&&(k==="all_collections"||k==="all_revisions")&&Se==="run"&&!_){ne.current=null;return}const H=fa(As(y,k,_,Se,de,l.infoId,l.infoView??"overview",l.collectionView??"infos"));if(i===H){ne.current=null;return}ne.current!==H&&(ne.current=H,c(H,{replace:!0}))},[j,f.pathname,f.search,c,l.collectionId,l.infoId,l.infoView,l.collectionView,l.libraryId,l.revisionId,l.revisionView,l.target,_,y,de,Se,k]),a.useEffect(()=>{if(typeof window>"u")return;const i=()=>{window.innerWidth>920&&V(!1)};return window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[]),a.useEffect(()=>{if(!N.current||!A||!y||I.current)return;const i=x.current,z={...i.byLibrary??{}},pe={...z[y]??{},lastCollectionId:_,lastRevisionId:de,lastRevisionView:Se,lastTarget:k},H={version:1,lastLibraryId:y,byLibrary:{...z,[y]:pe}},tt=JSON.stringify(i),lt=JSON.stringify(H);if(tt===lt)return;x.current=H,I.current=!0,(async()=>{try{if(P)await Sr(P,{plainValue:lt});else{const It=await Tr(A,{itemName:Fn,itemType:"data",plainValue:lt});L(It.dataItemId)}}catch{Pe(d.status.savePrefsFailed)}finally{I.current=!1}})()},[P,A,_,y,de,Se,k,d.status.savePrefsFailed]);const na=async()=>{const i=ot.trim();if(!i){Pe(t.cogita.user.libraryNameRequired);return}Pe(null);try{const z=await Ir({name:i});m(pe=>[z,...pe]),q(z.libraryId),Z("library_overview"),$(void 0),Te("")}catch{Pe(t.cogita.user.libraryCreateFailed)}},Bt=async()=>{if(!y||!_){Pe(d.status.selectLibraryFirst);return}const i=Oe.trim();if(!i){Pe(d.revisionForm.nameLabel);return}Pe(null);try{const z=await Cr({libraryId:y,collectionId:_,name:i,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});B(pe=>[z,...pe]),ue(z.revisionId),Z(k==="all_revisions"?"all_revisions":"all_collections"),He("settings"),_e("")}catch{Pe(d.status.loadFailed)}};return e.jsx(Et,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,headerExtra:e.jsxs("div",{className:"cogita-header-reviewer-actions",children:[e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:Ge,disabled:!y,onChange:i=>{const z=i.target.value;if(z==="__new_person__"){c("/cogita/persons");return}Ce(z)},children:[e.jsx("option",{value:"",children:y?"No person":"Select library first"}),et.map(i=>e.jsx("option",{value:i.roleId,children:i.label},i.roleId)),e.jsx("option",{value:"__new_person__",children:"+ Create new person"})]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>c("/cogita/persons"),children:"Persons"})]}),children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${ye?"open":""}`,"aria-label":d.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{children:(fe==null?void 0:fe.name)??d.path.noLibrarySelected}),e.jsx("p",{className:"cogita-sidebar-note",children:fe?d.sidebar.libraryActionsHint:d.status.selectLibraryFirst}),re(Pt,"sidebar"),k==="all_revisions"&&Ft?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.targets.allRevisions}),re(Ft,"sidebar"),Dt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(E==null?void 0:E.name)??d.status.noRevisions}),re(Dt,"sidebar")]}):null]}):null,st?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.infoActionsHint}),re(st,"sidebar"),qe?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(ee==null?void 0:ee.label)??me??t.cogita.library.list.selectedEmpty}),e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.selectedInfoActionsHint}),re(qe,"sidebar")]}):null]}):null,mt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.collectionActionsHint}),re(mt,"sidebar"),ie&&Ht?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:ie.name}),re(Ht,"sidebar"),k!=="all_revisions"&&Ft?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:(E==null?void 0:E.name)??d.status.noRevisions}),re(Ft,"sidebar"),Dt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.layers.revision}),re(Dt,"sidebar")]}):null]}):null]}):null]}):null]}),e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:d.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:r,children:d.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{w("cogita"),V(!1)},children:d.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:o,children:h?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),ye?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":d.sidebar.closeMenu,onClick:()=>V(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":d.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>V(i=>!i),"aria-label":ye?d.sidebar.closeMenu:d.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),vt.map((i,z)=>e.jsxs("div",{className:"cogita-browser-segment",children:[z>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,i.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":i.label,children:i.selectedLabel}):e.jsxs("select",{"aria-label":i.label,value:i.value,onChange:pe=>i.onSelect(pe.target.value),disabled:i.disabled,children:[i.emptyOption?e.jsx("option",{value:"",children:i.emptyOption}):null,i.options.map(pe=>e.jsx("option",{value:pe.value,children:pe.label},`${i.key}:${pe.value}`))]})]},`menu:${i.key}`))]}),Zt?e.jsxs(e.Fragment,{children:[(k==="all_collections"||k==="all_revisions")&&Se==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:d.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsxs("select",{value:_??"",onChange:i=>$(i.target.value||void 0),children:[e.jsx("option",{value:"",children:d.selectCollectionOption}),C.map(i=>e.jsx("option",{value:i.collectionId,children:i.name},i.collectionId))]})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:d.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Oe,onChange:i=>_e(i.target.value),placeholder:d.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Bt,children:d.revisionForm.createAction}),Ae?e.jsx("p",{className:"cogita-form-error",children:Ae}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Vs.Provider,{value:!0,children:Zt})})]}):null,Zt?null:e.jsxs(e.Fragment,{children:[W?e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(xi,{copy:t,onPersonCreated:i=>{Ye(z=>z+1)}})}):null,!y&&!W?e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:yt.step}),e.jsx("h2",{children:yt.title})]}),e.jsxs("p",{children:[gt+1," / ",ht]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:yt.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:yt.passages.map(i=>e.jsx("p",{children:i},i))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:yt.focus.map(i=>e.jsx("span",{children:i},i))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:yt.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:pt.map((i,z)=>e.jsx("button",{type:"button",className:`ghost ${z===gt?"active":""}`,onClick:()=>Ze(z),"aria-label":`${z+1}`,children:z+1},`tutorial:${i.title}:${z}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:gt===0,onClick:()=>Ze(i=>Math.max(0,i-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:gt===ht-1,onClick:()=>Ze(i=>Math.min(ht-1,i+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:ot,onChange:i=>Te(i.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:na,children:t.cogita.user.createLibraryAction}),Ae?e.jsx("p",{className:"cogita-form-error",children:Ae}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),j.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,j.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:j.map(i=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{xt({libraryId:i.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:i.name})]},i.libraryId))}):null]})]})]}):null]})]})]})})}const lo=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:ao},Symbol.toStringTag,{value:"Module"}));function no({copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,shareId:c}){const[f,l]=a.useState(null),[d,j]=a.useState("loading"),[m,C]=a.useState(t.cogita.library.collections.defaultName),[O,b]=a.useState("Cogita Library"),[p,oe]=a.useState([]),[B,y]=a.useState([]),[q,k]=a.useState("idle"),[Z,_]=a.useState({current:0,total:0}),[$,de]=a.useState(0),[ue,Se]=a.useState(""),[He,me]=a.useState(null),[R,ye]=a.useState(null),[V,he]=a.useState(null),[Y,je]=a.useState(null),[le,se]=a.useState([]),[Ie,Ae]=a.useState({}),[Pe,$e]=a.useState({}),[Ze,ot]=a.useState(null),[Te,We]=a.useState(null),[ft,Oe]=a.useState(null),[_e,et]=a.useState(null),[it,Ge]=a.useState({}),Ce=a.useRef(0),[ze,Ye]=a.useState(null),A=a.useRef(null),M=a.useRef(null),[P,L]=a.useState(null),[x,N]=a.useState(!1),[I,ne]=a.useState(null),[fe,ie]=a.useState([]),[W,E]=a.useState(null),J=a.useRef(null),X=a.useRef(null),[U,Q]=a.useState(null),[be,K]=a.useState(0),ee=a.useRef(null),Le=a.useRef({}),[Ve,Ke]=a.useState(!1),[Ue,pt]=a.useState({}),ht=a.useRef(null),gt=a.useRef(new Set),yt=a.useRef({}),[Ct,zt]=a.useState([]),[At,kt]=a.useState(new Set),[ma,Mt]=a.useState(!1),xt=Oa(),Nt=a.useMemo(()=>new URLSearchParams(xt.search),[xt.search]),vt=a.useMemo(()=>Nt.get("key")??"",[Nt]),bt=(f==null?void 0:f.mode)??"random",Pt=(f==null?void 0:f.check)??"exact",st=(f==null?void 0:f.limit)??20,qe=a.useMemo(()=>Zn((f==null?void 0:f.revisionType)??bt),[f,bt]),mt=a.useMemo(()=>{const F=f==null?void 0:f.revisionSettings,te=Qs(qe,Nt);return bn(qe,F??te)},[f,Nt,qe]),Ht=a.useMemo(()=>t.cogita.library.revision[qe.labelKey]??bt,[t,bt,qe]),Ft=a.useMemo(()=>Pt==="exact"?t.cogita.library.revision.checkValue:Pt,[t,Pt]),re=d==="ready"?p[$]??null:null,Zt=(re==null?void 0:re.checkType)==="translation-match"&&_e,na=a.useRef(new Map),Bt=a.useRef(new Map),i=a.useRef(new Map),z=a.useRef(new Map),pe=a.useMemo(()=>re?re.cardType==="vocab"?t.cogita.library.revision.vocabLabel:re.infoType?nt(t,re.infoType):t.cogita.library.revision.infoLabel:"",[t,re]),H=a.useMemo(()=>{var te;return qe.id!=="levels"?p.length:((te=Ue.pool)==null?void 0:te.length)??qe.getFetchLimit(st,mt)},[Ue,mt,qe,p.length,st]),tt=qe.getProgressTotal?qe.getProgressTotal(p,Ue,st,mt):qe.id==="levels"?Math.min(st,H):p.length,lt=tt?Math.min($+1,tt):0,wt=Math.max(1,Number(mt.tries??1)),It=mt.compare??"anchors",$t=Math.max(0,Math.min(100,Number(mt.minCorrectness??0))),jt=(mt.considerDependencies??"on")==="on",Wt=Math.max(0,Math.min(100,Number(mt.dependencyThreshold??85))),ea=F=>{const te=F.slice();for(let ve=te.length-1;ve>0;ve-=1){const Fe=Math.floor(Math.random()*(ve+1));[te[ve],te[Fe]]=[te[Fe],te[ve]]}return te},sa=F=>ya(F,{treatSimilarCharsAsSame:!0})>=$t,Ot=async()=>{const F=await da(),te=new Map,ve=new Map;F.forEach(we=>{const Re=`${we.itemType}:${we.itemId}`,Me=Xt(we.itemType,we.itemId,we.checkType,we.direction);te.has(Re)||te.set(Re,[]),te.get(Re).push(we),ve.has(Me)||ve.set(Me,[]),ve.get(Me).push(we)});const Fe=new Map,De=new Map;return te.forEach((we,Re)=>Fe.set(Re,ca(we).score)),ve.forEach((we,Re)=>De.set(Re,ca(we).score)),{itemKnowness:Fe,cardKnowness:De}},ra=async F=>{const te=Ue,ve=F.concat(te.active??[]).concat(te.pool??[]).filter((g,T,D)=>D.findIndex(ce=>ke(ce)===ke(g))===T);if(!jt){kt(new Set(ve.map(ke)));return}const{itemKnowness:Fe,cardKnowness:De}=await Ot(),we=g=>{if(g.cardType!=="info"||g.infoType!=="citation"||g.checkType!=="quote-fragment")return!0;const T=Jt(g.direction);if(!(T!=null&&T.fragmentId))return!0;const D=g.description??"";if(!D.trim())return!0;const ge=ka(D).nodes[T.fragmentId];if(!ge||!ge.leftId&&!ge.rightId)return!0;const ae=[ge.leftId,ge.rightId].filter(Ne=>!!Ne);if(ae.length===0)return!0;const xe=ae.map(Ne=>{const Be=Xt("info",g.cardId,"quote-fragment",Ne);return De.get(Be)??0});return xe.reduce((Ne,Be)=>Ne+Be,0)/xe.length>=Wt},Re=(f==null?void 0:f.collectionId)??null,Me=Re?Ct.filter(g=>Tt(g.childItemType)==="collection"&&g.childItemId===Re&&!Tt(g.childCheckType)&&!Tt(g.childDirection)):[],Ee=Re&&ve.length>0?ve.reduce((g,T)=>g+(De.get(ke(T))??0),0)/ve.length:0,Qe=new Set;for(const g of ve){if(g.cardType!=="info"){Qe.add(ke(g));continue}if(!we(g))continue;const T=Ct.filter(ge=>tr(ge,g)).concat(Me);if(T.length===0){Qe.add(ke(g));continue}let D=0;for(const ge of T)if(Tt(ge.parentItemType)==="collection")D+=ge.parentItemId===Re?Ee:0;else if(Tt(ge.parentCheckType)||Tt(ge.parentDirection)){const ae=Tt(ge.parentCheckType),xe=Tt(ge.parentDirection),G=Xt(ge.parentItemType,ge.parentItemId,ae,xe);D+=De.get(G)??0}else{const ae=`${ge.parentItemType}:${ge.parentItemId}`;D+=Fe.get(ae)??0}D/T.length>=Wt&&Qe.add(ke(g))}kt(Qe)},Rt=F=>{for(let te=F;te<p.length;te+=1){const ve=p[te];if(ve&&(!jt||ve.cardType!=="info"||At.has(ke(ve))))return te}return-1},St=F=>!jt||F.cardType!=="info"||At.has(ke(F)),ta=F=>{if(qe.id!=="temporal"&&qe.id!=="levels")return null;const te=Ue,ve=(te.active??[]).concat(te.pool??[]),Fe=new Set;for(const De of ve){const we=ke(De);if(!(Fe.has(we)||F.has(we))&&(Fe.add(we),St(De)))return De}return null},Yt=a.useMemo(()=>{if(qe.id!=="levels")return null;const F=Ue,te=F.pool??[],ve=F.active??[],Fe=F.levelMap??{},De=Math.max(1,Number(mt.levels??1)),we=Array.from({length:De},()=>0),Re=new Set(ve.map(g=>ke(g)));te.forEach(g=>{const T=Math.min(De,Math.max(1,Fe[ke(g)]??1));we[T-1]+=1});const Me=te.length||1,Ee=we.map(g=>g/Me*100),Qe=re?Fe[ke(re)]??1:null;return{counts:we,percentages:Ee,currentLevel:Qe,levelsCount:De,activeCount:ve.length,poolCount:te.length,activeSet:Re}},[Ue,mt,qe,re]),xa=a.useMemo(()=>{if(qe.id!=="temporal")return null;const F=Ue,te=F.pool??[],ve=F.active??[],Fe=F.knownessMap??{},De=new Set(F.unknownSet??[]);let we=0;te.forEach(Ee=>{(Fe[ke(Ee)]??0)>1&&(we+=1)});const Re=De.size,Me=ve.map(Ee=>({id:ke(Ee),value:De.has(ke(Ee))?0:Math.max(0,Math.min(1,Fe[ke(Ee)]??0))}));return{knownCount:we,unknownCount:Re,dots:Me}},[Ue,qe]),qa=a.useMemo(()=>{if(!jt)return 0;const F=Ue;return p.concat(F.active??[]).concat(F.pool??[]).filter((ve,Fe,De)=>De.findIndex(we=>ke(we)===ke(ve))===Fe).filter(ve=>ve.cardType==="info"&&!At.has(ke(ve))).length},[jt,Ue,p,At]);a.useEffect(()=>{if(!jt||q!=="ready")return;const F=Ue,ve=p.concat(F.active??[]).concat(F.pool??[]).filter((we,Re,Me)=>Me.findIndex(Ee=>ke(Ee)===ke(we))===Re).filter(we=>we.cardType!=="info"||At.has(ke(we))).length,Fe=J.current;if(J.current=ve,Fe===null||ve<=Fe)return;const De=ve-Fe;E(`New card available (+${De})`),X.current&&window.clearTimeout(X.current),X.current=window.setTimeout(()=>E(null),2200)},[jt,q,Ue,p,At]),a.useEffect(()=>()=>{X.current&&window.clearTimeout(X.current)},[]);const Qt=(F,te)=>{const ve=qe.applyOutcome({queue:p,meta:Ue},re,st,mt,{correct:F,correctness:te,createdUtc:new Date().toISOString()});oe(ve.queue),pt(ve.meta);const Fe=ve.queue[$+1];Fe&&_t(Fe,$+1)};a.useEffect(()=>{if(!c){j("error");return}j("loading"),Mr({shareId:c,key:vt}).then(F=>{l(F),C(F.collectionName),b(F.libraryName),j("ready")}).catch(()=>{j("error")})},[c,vt]),a.useEffect(()=>{c&&Lr({shareId:c,key:vt,type:"language"}).then(F=>y(F)).catch(()=>y([]))},[c,vt]),a.useEffect(()=>{!c||d!=="ready"||Ar({shareId:c,key:vt}).then(F=>zt(F.items??[])).catch(()=>zt([]))},[c,vt,d]),a.useEffect(()=>{if(!c||d!=="ready")return;let F=!0;return(async()=>{k("loading"),_({current:0,total:qe.id==="levels"?0:qe.getFetchLimit(st,mt)});try{const ve=[];let Fe=null,De=null;do{const T=await $r({shareId:c,key:vt,limit:300,cursor:Fe});if(ve.push(...T.items),(qe.id==="levels"||qe.id==="temporal")&&T.total&&(De=T.total),_(D=>({current:ve.length,total:D.total||T.total||qe.getFetchLimit(st,mt)})),Fe=T.nextCursor??null,De!==null&&ve.length>=De||qe.id!=="levels"&&qe.id!=="temporal"&&ve.length>=qe.getFetchLimit(st,mt))break}while(Fe);if(!F)return;const we=_a(ve);let Re;if(qe.id==="levels"){const T=Math.max(1,Number(mt.levels??1));Re={},we.forEach(D=>{const ce=ke(D);Re[ce]=Math.max(1,Math.min(T,1))})}let Me=null,Ee=null,Qe=null;if(qe.id==="temporal"){const T=await da(),D=new Set(we.map(ae=>ke(ae))),ce=T.reduce((ae,xe)=>{const G=Xt(xe.itemType,xe.itemId,xe.checkType,xe.direction);return D.has(G)&&(ae[G]||(ae[G]=[]),ae[G].push(xe)),ae},{});Me={},Ee=new Set,Qe={};const ge=Date.now();we.forEach(ae=>{const xe=ke(ae),G=ce[xe]??[];if(G.length===0){Me[xe]=0,Ee.add(xe),Qe[xe]=[];return}const Ne=Gn(G);Qe[xe]=Ne;const Be=pn(Ne,ge);Me[xe]=Be.knowness})}const g=qe.id==="levels"?Xn(we,st,mt,Re):qe.id==="temporal"?Yn(we,st,mt,Me??{},Ee??new Set,Qe??{}):qe.prepare(we,st,mt);oe(g.queue),pt(g.meta),de(0),k("ready"),_(T=>({current:Math.min(T.current,T.total),total:T.total}))}catch{F&&k("error")}})(),()=>{F=!1}},[c,vt,st,qe,mt,d]),a.useEffect(()=>{ra(p)},[p,Ct,jt,Wt,f==null?void 0:f.collectionId]),a.useEffect(()=>{if(!re||!jt){Mt(!1);return}if(re.cardType!=="info"||At.has(ke(re))){Mt(!1);return}const F=Rt($+1);if(F>=0){Mt(!1),de(F);return}if(qe.id==="temporal"||qe.id==="levels"){const te=p.slice(0,$+1),ve=p.slice($+1).filter(St),Fe=te.concat(ve),De=new Set(Fe.map(ke)),we=ta(De);if(we){const Me=ke(we);De.has(Me)||(Fe.push(we),De.add(Me),pt(Ee=>{const Qe=Ee,g=new Set(Qe.queued??[]);return g.add(Me),{...Qe,queued:g}}))}const Re=Fe.findIndex((Me,Ee)=>Ee!==$&&St(Me));if(Re>=0){oe(Fe),de(Re),Mt(!1);return}}Mt(!0)},[re,At,jt,$,p,Ue,qe.id]),a.useEffect(()=>{if(Se(""),me(null),Q(null),K(0),se([]),Ae({}),$e({}),ot(null),We(null),Oe(null),N(!1),Ke(!1),L(null),et(null),Ge({}),!re){ye(null),he(null);return}re.cardType==="info"&&re.infoType==="computed"&&ye(t.cogita.library.revision.loadingComputed);let F=!0;return _t(re,$).then(te=>{!F||!te||(ye(te.prompt),he(te.expectedAnswer),se(te.computedExpected),Ae(te.computedAnswers),ot(te.answerTemplate),We(te.outputVariables),Oe(te.variableValues))}),()=>{F=!1}},[re,c,t]),a.useEffect(()=>{if(!re||re.cardType!=="info"||re.infoType!=="citation"){ht.current=null,gt.current=new Set,je(null);return}const F=re.description??"",te=(re.label??"").trim(),ve=te.replace(/\s+/g," ").trim(),Fe=F.replace(/\s+/g," ").trim(),De=ve&&ve!==Fe?te:t.cogita.library.infoTypes.citation;if(!F){je(null),he(null);return}const we=ka(F);ht.current=we,ye(De);let Re=!0;return da().then(Me=>{if(!Re)return;const Ee=new Map;Me.forEach(ce=>{if(ce.itemType!=="info"||ce.checkType!=="quote-fragment"||!ce.direction)return;const ge=Jt(ce.direction);if(!ge)return;const ae=`${ce.itemId}:${ge.fragmentId}`;Ee.has(ae)||Ee.set(ae,[]),Ee.get(ae).push(ce)});const Qe={},g=new Set;Ee.forEach((ce,ge)=>{const[ae,xe]=ge.split(":",2);if(ae!==re.cardId)return;const G=ca(ce).score;Qe[xe]=G,G>=Wt&&g.add(xe)}),gt.current=g,yt.current=Qe;const T=Jt(re.direction);if(T!=null&&T.fragmentId&&we.nodes[T.fragmentId]){ia(we,T.fragmentId,De);return}const D=Ma(we,g,Qe,Wt,jt,re.direction);ia(we,(D==null?void 0:D.id)??null,De)}).catch(()=>{gt.current=new Set,yt.current={};const Me=Jt(re.direction);if(Me!=null&&Me.fragmentId&&we.nodes[Me.fragmentId]){ia(we,Me.fragmentId,De);return}const Ee=Ma(we,gt.current,{},Wt,jt,re.direction);ia(we,(Ee==null?void 0:Ee.id)??null,De)}),()=>{Re=!1}},[re,t,jt,Wt]),a.useEffect(()=>{if(!re||re.cardType!=="vocab"||re.checkType!=="translation-match"){et(null),Ge({});return}const ve=(Ue.pool??Ue.active??p).filter(Me=>Me.cardType==="vocab"&&Me.checkType==="translation-match").filter((Me,Ee,Qe)=>Qe.findIndex(g=>g.cardId===Me.cardId)===Ee);ve.some(Me=>Me.cardId===re.cardId)||ve.unshift(re);const De=ea(ve).slice(0,6).map(Me=>{const Ee=Me.label.split("↔").map(T=>T.trim()).filter(Boolean);if(Ee.length<2)return null;const Qe=`${Me.cardId}:L`,g=`${Me.cardId}:R`;return{cardId:Me.cardId,leftId:Qe,rightId:g,leftLabel:Ee[0],rightLabel:Ee[1]}}).filter(Boolean),we=De.map(Me=>Me.leftId),Re=ea(De.map(Me=>Me.rightId));et({pairs:De,leftOrder:we,rightOrder:Re,selection:{},activeLeft:null,activeRight:null,locked:{}})},[re,p,Ue]),a.useEffect(()=>()=>{A.current&&window.clearTimeout(A.current),M.current&&window.clearTimeout(M.current)},[]);const Na=a.useRef(null);a.useEffect(()=>{if(!re)return;const F=ke(re),te=typeof document<"u"?document.activeElement:null;if(Na.current===F&&te&&(te.tagName==="INPUT"||te.tagName==="TEXTAREA"))return;let ve=0;const Fe=()=>{if(re){if(re.cardType==="info"&&re.infoType==="computed"){if(le.length>0){const we=cn(Ze,le,Te),Re=we?Le.current[we]:null;if(Re&&(Re.focus(),document.activeElement===Re)){Na.current=F;return}}if(ee.current&&(ee.current.focus(),document.activeElement===ee.current)){Na.current=F;return}}else if(re.cardType==="vocab"&&ee.current&&(ee.current.focus(),document.activeElement===ee.current)){Na.current=F;return}ve<6&&(ve+=1,window.setTimeout(Fe,40))}},De=window.setTimeout(Fe,40);return()=>window.clearTimeout(De)},[re,le,Ze,Te]),a.useEffect(()=>{if(!Ve)return;const F=te=>{te.key==="Enter"&&(te.preventDefault(),Vt())};return window.addEventListener("keydown",F),()=>window.removeEventListener("keydown",F)},[Ve]);const Sa=F=>{ie(F),ne(ca(F))};a.useEffect(()=>{if(!re){ne(null),ie([]);return}const F=re.cardType==="info"?"info":"connection";if(re.cardType==="info"&&re.infoType==="citation"){da().then(te=>{const ve=te.filter(Fe=>Fe.itemType==="info"&&Fe.itemId===re.cardId&&Fe.checkType==="quote-fragment"&&on(Fe.direction,re.direction));Sa(ve)}).catch(()=>{ne(null),ie([])});return}rn(F,re.cardId,re.checkType,re.direction).then(te=>Sa(te)).catch(()=>{ne(null),ie([])})},[re]);const Aa=(F,te,ve,Fe)=>{if(F==="info"&&ve==="quote-fragment"){da().then(De=>{const we=De.filter(Re=>Re.itemType==="info"&&Re.itemId===te&&Re.checkType==="quote-fragment"&&on(Re.direction,Fe));Sa(we)}).catch(()=>{ne(null),ie([])});return}rn(F,te,ve,Fe).then(De=>Sa(De)).catch(()=>{ne(null),ie([])})},Ua=(F,te,ve)=>{var Re;const Fe=((Re=ve.pairs.find(Me=>Me.leftId===F))==null?void 0:Re.rightId)??null;if(!Fe)return ve;const De=Fe===te;Ge(Me=>({...Me,[F]:De?"correct":"incorrect"})),A.current&&window.clearTimeout(A.current),M.current&&window.clearTimeout(M.current),Ce.current+=1;const we={kind:De?"correct":"incorrect",tick:Ce.current};if(Ye(null),A.current=window.setTimeout(()=>Ye(we),0),M.current=window.setTimeout(()=>Ye(null),420),De){const Me={...ve.locked,[F]:!0};return Object.keys(Me).length>=ve.pairs.length?(me("correct"),Ke(!0)):me("correct"),{...ve,selection:{...ve.selection,[F]:te},activeLeft:null,activeRight:null,locked:Me}}return me("incorrect"),{...ve,activeLeft:null,activeRight:null}},$a=F=>{et(te=>!te||te.locked[F]?te:te.activeRight?Ua(F,te.activeRight,te):{...te,activeLeft:te.activeLeft===F?null:F})},yn=F=>{et(te=>te&&(te.activeLeft?Ua(te.activeLeft,F,te):{...te,activeRight:te.activeRight===F?null:F}))},Vt=()=>{var F;if(re&&re.cardType==="info"&&re.infoType==="citation"&&ht.current&&Y&&!((F=Jt(re.direction))!=null&&F.fragmentId)){const te=Ma(ht.current,gt.current,yt.current,Wt,jt,re.direction,Y.fragmentId);if(te){me(null),Se(""),N(!1),$e({}),Ke(!1),Q(null),K(0),ia(ht.current,te.id,Y.title);return}}me(null),Se(""),N(!1),$e({}),Ke(!1),Q(null),K(0),de(te=>Math.min(te+1,p.length))},qt=F=>{if(!re)return;const te=F.expected??null,ve=F.answer??"";let Fe=te??"",De=ve;if(!te&&F.expectedMap&&F.answerMap){const T=Object.keys(F.expectedMap).sort((D,ce)=>D.localeCompare(ce));Fe=T.map(D=>{var ce;return((ce=F.expectedMap)==null?void 0:ce[D])??""}).join("|"),De=T.map(D=>{var ce;return((ce=F.answerMap)==null?void 0:ce[D])??""}).join("|")}const we=Fe?La(Fe,De,It):new Uint8Array,Re={revisionType:qe.id,evalType:F.evalType,direction:F.direction,prompt:R??"",expected:te,answer:ve,expectedAnswers:F.expectedMap??null,answers:F.answerMap??null,correct:F.correct,maskBase64:we.length?ba(we):null,checkMode:Pt,compareMode:It,minCorrectness:$t},Me=new TextEncoder().encode(JSON.stringify(Re)),Ee=re.cardType==="info"?"info":"connection",Qe=F.overrideCheckType??re.checkType??null,g=F.overrideDirection??re.direction??null;sn({itemType:Ee,itemId:re.cardId,checkType:Qe,direction:g,revisionType:qe.id,evalType:F.evalType,correct:F.correct,maskBase64:we.length?ba(we):null,payloadBase64:ba(Me)}).then(()=>{Aa(Ee,re.cardId,Qe,g),ra(p)}).catch(()=>{})},xn=(F,te)=>{const ve=na.current.get(te);if(ve)return Promise.resolve(ve);const Fe=Bt.current.get(te);if(Fe)return Fe;const De=Rr({shareCode:c,infoId:F,key:vt}).then(we=>{var T,D;const Re=we.payload,Me=((T=Re.definition)==null?void 0:T.graph)??null,Ee="",Qe=((D=Re.definition)==null?void 0:D.answerTemplate)??"",g=Gs(Me,Ee,Qe);if(g){const ge={sample:Ys(g),answerTemplate:Qe||null};return na.current.set(te,ge),ge}return rs({shareId:c,infoId:F,key:vt}).then(ce=>{const ge={sample:ce,answerTemplate:null};return na.current.set(te,ge),ge})}).catch(()=>rs({shareId:c,infoId:F,key:vt}).then(we=>{const Re={sample:we,answerTemplate:null};return na.current.set(te,Re),Re}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{Bt.current.delete(te)});return Bt.current.set(te,De),De},_t=(F,te)=>{var Me;const ve=`${ke(F)}:${te}`,Fe=i.current.get(ve);if(Fe)return Promise.resolve(Fe);const De=z.current.get(ve);if(De)return De;const we=Ee=>(i.current.set(ve,Ee),Ee);let Re;if(F.cardType==="vocab"){if(F.checkType==="translation-match")return Re=Promise.resolve(we({prompt:F.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),Re;const Ee=F.label.split("↔").map(Qe=>Qe.trim()).filter(Boolean);if(Ee.length>=2){const g=(F.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",T=g?Ee[0]:Ee[1],D=g?Ee[1]:Ee[0];Re=Promise.resolve(we({prompt:T,expectedAnswer:D,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else Re=Promise.resolve(we({prompt:F.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(F.cardType==="info"&&F.infoType==="word"){const Ee=(Me=F.description)!=null&&Me.startsWith("Language: ")?F.description.replace("Language: ",""):null;Re=Promise.resolve(we({prompt:F.label,expectedAnswer:Ee,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else F.cardType==="info"&&F.infoType==="computed"?Re=xn(F.cardId,ve).then(Ee=>{var ce,ge;if(!Ee.sample)return we({prompt:F.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const Qe=Ee.sample,g=Qe.expectedAnswers?Object.entries(Qe.expectedAnswers).map(([ae,xe])=>({key:ae,expected:xe})):[],T=g.reduce((ae,xe)=>(ae[xe.key]="",ae),{}),D=Qe.expectedAnswerIsSentence&&((ce=Qe.expectedAnswer)==null?void 0:ce.trim())||null;return we({prompt:Qe.prompt,expectedAnswer:g.length>0?D:((ge=Qe.expectedAnswer)==null?void 0:ge.trim())||null,computedExpected:g,computedAnswers:T,answerTemplate:Ee.answerTemplate,outputVariables:Qe.outputVariables??null,variableValues:Qe.variableValues??null})}).catch(()=>we({prompt:F.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{z.current.delete(ve)}):Re=Promise.resolve(we({prompt:F.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return z.current.set(ve,Re),Re},ia=(F,te,ve)=>{const Fe=Object.keys(F.nodes).length,De=gt.current.size;if(!te){je({title:ve,before:F.text,after:"",fragmentId:null,total:Fe,completed:De}),he(null),Ke(!0);return}const we=F.nodes[te];if(!we)return;const Re=Hn(F.text,we);je({title:ve,before:Re.before,after:Re.after,fragmentId:we.id,total:Fe,completed:De}),he(Re.fragment),Ke(!1)},Ta=()=>{const F=ht.current;F&&je(te=>te&&{...te,total:Object.keys(F.nodes).length,completed:gt.current.size})},va=()=>{const F=p[$+1];F&&_t(F,$+1)},Ra=()=>{if(va(),re&&re.cardType==="vocab"&&re.checkType==="translation-match"&&_e){if(_e.pairs.length===0){me("incorrect"),Ke(!0);return}const we=_e.pairs.reduce((D,ce)=>(D[ce.rightId]=ce.rightLabel,D),{});let Re=0;const Me={};_e.pairs.forEach(D=>{const ge=_e.selection[D.leftId]===D.rightId;Me[D.leftId]=ge?"correct":"incorrect",ge&&(Re+=1)});const Ee=_e.pairs.length||1,Qe=Re/Ee,g=Re===_e.pairs.length;Ge(D=>({...D,...Me})),g?(me("correct"),Ke(!0),K(0)):(me("incorrect"),Ke(!1),K(D=>{const ce=D+1;return ce>=wt&&(N(!0),Ke(!0),et(ge=>{if(!ge)return ge;const ae=ge.pairs.reduce((xe,G)=>(xe[G.leftId]=G.rightId,xe),{});return{...ge,selection:ae}})),ce})),Qt(g,Qe);const T="connection";Promise.all(_e.pairs.map(D=>{const ce=_e.selection[D.leftId]??null,ge=ce?we[ce]:"",ae={left:D.leftLabel,expected:D.rightLabel,answer:ge,checkType:"translation-match"},xe=new TextEncoder().encode(JSON.stringify(ae));return sn({itemType:T,itemId:D.cardId,checkType:"translation-match",direction:null,revisionType:qe.id,evalType:"translation-match",correct:ce===D.rightId,maskBase64:null,payloadBase64:ba(xe)})})).then(()=>{Aa(T,re.cardId,re.checkType,re.direction),ra(p)}).catch(()=>{});return}if(le.length>0){const we=le.reduce((Me,Ee)=>{const Qe=Ie[Ee.key]??"";return Me[Ee.key]=Kt(Qe)===Kt(Ee.expected)?"correct":"incorrect",Me},{});le.every(({key:Me,expected:Ee})=>{const Qe=Ie[Me]??"";return Pt==="exact"&&Kt(Qe)===Kt(Ee)})?(me("correct"),$e(we),Ke(!0),K(0),Qt(!0,1),qt({correct:!0,direction:R?`${R} -> computed`:"computed",expectedMap:le.reduce((Me,Ee)=>(Me[Ee.key]=Ee.expected,Me),{}),answerMap:Ie,evalType:"computed"})):(me("incorrect"),$e(we),Ke(!1),K(Me=>{const Ee=Me+1;return Ee>=wt&&ga&&(N(!0),Ke(!0)),Ee}),Qt(!1,0),window.setTimeout(()=>{var Ee;const Me=cn(Ze,le,Te);Me&&Le.current[Me]&&((Ee=Le.current[Me])==null||Ee.focus())},40),qt({correct:!1,direction:R?`${R} -> computed`:"computed",expectedMap:le.reduce((Me,Ee)=>(Me[Ee.key]=Ee.expected,Me),{}),answerMap:Ie,evalType:"computed"}));return}if(re&&re.cardType==="info"&&re.infoType==="citation"&&(Y!=null&&Y.fragmentId)){if(!V)return;const we=Jt(re.direction),Re=(we==null?void 0:we.fragmentId)??Y.fragmentId,Me=Ia(V,ue,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Ee=Me.mask,Qe=Me.isCorrect,g=Me.percent;Qe?(yt.current[Y.fragmentId]=Math.max(yt.current[Y.fragmentId]??0,g),(yt.current[Y.fragmentId]??0)>=Wt&&gt.current.add(Y.fragmentId),Ta(),me("correct"),$e({}),Ke(!0),Q(Ee),K(0),g<100&&wt<=1&&N(!0),Qt(!0,g/100),qt({correct:!0,direction:`quote:${Y.fragmentId}`,expected:V,answer:ue,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Re})):(me("incorrect"),$e({}),Ke(!1),Q(Ee),K(T=>{const D=T+1;return D>=wt&&ga&&(N(!0),Ke(!0)),D}),Qt(!1,g/100),window.setTimeout(()=>{var T;return(T=ee.current)==null?void 0:T.focus()},40),qt({correct:!1,direction:`quote:${Y.fragmentId}`,expected:V,answer:ue,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Re}));return}if(!V)return;const F=La(V,ue,It),te=Pt==="exact"&&Kt(ue)===Kt(V),ve=sa(F),Fe=te||ve,De=ya(F);Fe?(me("correct"),$e({}),Ke(!0),Q(F),K(0),De<100&&wt<=1&&N(!0),Qt(!0,De/100),qt({correct:!0,direction:R?`${R} -> ${V}`:null,expected:V,answer:ue,evalType:"text"})):(me("incorrect"),$e({}),Ke(!1),Q(F),K(we=>{const Re=we+1;return Re>=wt&&ga&&(N(!0),Ke(!0)),Re}),Qt(!1,De/100),window.setTimeout(()=>{var we;return(we=ee.current)==null?void 0:we.focus()},40),qt({correct:!1,direction:R?`${R} -> ${V}`:null,expected:V,answer:ue,evalType:"text"}))},vn=F=>{if(va(),!V)return;const te=La(V,F,It),ve=Kt(F)===Kt(V),Fe=sa(te),De=ve||Fe,we=ya(te);De?(me("correct"),$e({}),Ke(!0),Q(te),K(0),we<100&&wt<=1&&N(!0),Qt(!0,we/100),qt({correct:!0,direction:"word->language",expected:V,answer:F,evalType:"language-select"})):(me("incorrect"),$e({}),Ke(!1),Q(te),K(Re=>{const Me=Re+1;return Me>=wt&&ga&&(N(!0),Ke(!0)),Me}),Qt(!1,we/100),qt({correct:!1,direction:"word->language",expected:V,answer:F,evalType:"language-select"}))},wn=F=>{var ve;if(F.key!=="Enter")return;if(F.preventDefault(),F.stopPropagation(),Ve){Vt();return}const te=le.find(Fe=>!(Ie[Fe.key]??"").trim());if(te){(ve=Le.current[te.key])==null||ve.focus();return}Ra()},Ca=()=>{va(),me("correct"),Ke(!0),K(0),Qt(!0,1),V&&qt({correct:!0,direction:"manual",expected:V,answer:ue,evalType:"manual"})},aa=()=>{if(Qt(!1,0),re&&re.cardType==="info"&&re.infoType==="citation"){me(null),Se(""),N(!1),$e({}),Ke(!1),Q(null),K(0),de(F=>Math.min(F+1,p.length));return}Vt()};a.useEffect(()=>{va()},[$,p]);const jn=t.cogita.library.revision.revealModeAfterIncorrect,ga=le.length>0||!!V;return e.jsxs(Et,{copy:t,authLabel:n,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:o,onLogout:u,secureMode:h,onNavigate:w,language:v,onLanguageChange:S,children:[(d==="loading"||q==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:d==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${Z.total?Math.min(100,Math.max(0,Z.current/Z.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:Z.total?`${Math.min(Z.current,Z.total)} / ${Z.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:m}),e.jsx("p",{className:"cogita-library-subtitle",children:O}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",Ht).replace("{check}",Ft)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:I?`${I.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Yt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Yt.currentLevel??"-"," / ",Yt.levelsCount]}):null,I?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(I.correct)).replace("{total}",String(I.total))}),I.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(I.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(Xs,{outcomes:fe})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[W?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:W})}):null,e.jsx(Wn,{feedbackToken:ze?`${ze.kind}-${ze.tick}`:Zt?"idle":He??"idle",children:d!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:d==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):re?e.jsx(e.Fragment,{children:ma?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(Qn,{copy:t,currentCard:re,currentTypeLabel:pe,prompt:R,languages:B,answer:ue,onAnswerChange:F=>Se(te=>ln(te,F,P)),computedExpected:le,computedAnswers:Ie,onComputedAnswerChange:(F,te)=>Ae(ve=>({...ve,[F]:ln(ve[F]??"",te,P)})),answerTemplate:Ze,outputVariables:Te,variableValues:ft,computedFieldFeedback:Pe,feedback:He,canAdvance:Ve,quoteContext:Y,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Ra,onSkip:aa,onLanguageSelect:vn,onMarkReviewed:Ca,onAdvance:Vt,showCorrectAnswer:x,setShowCorrectAnswer:N,onRevealCorrect:()=>Ke(!0),answerMask:U,expectedAnswer:V,hasExpectedAnswer:ga,handleComputedKeyDown:wn,answerInputRef:ee,computedInputRefs:Le,scriptMode:P,setScriptMode:L,matchPairs:_e==null?void 0:_e.pairs,matchLeftOrder:_e==null?void 0:_e.leftOrder,matchRightOrder:_e==null?void 0:_e.rightOrder,matchSelection:_e==null?void 0:_e.selection,matchActiveLeft:_e==null?void 0:_e.activeLeft,matchActiveRight:_e==null?void 0:_e.activeRight,matchFeedback:it,onMatchLeftSelect:$a,onMatchRightSelect:yn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:tt?`${lt} / ${tt}`:t.cogita.library.revision.progressUnlimited}),d==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),d==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),d==="ready"&&q==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),d==="ready"&&q==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),d==="ready"&&q==="ready"&&p.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:jn}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",wt]})]})]}),Yt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Yt.activeCount," / ",Yt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Yt.counts.map((F,te)=>{const ve=te+1,Fe=Yt.currentLevel===ve,De=Yt.percentages[te]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":Fe,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:ve}),e.jsx("strong",{children:F})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,De))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[De.toFixed(1),"%"]})]},`level-${ve}`)})})]}):null,xa?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:xa.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:xa.dots.map(F=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-F.value))}, ${Math.round(200*F.value)}, 80, 0.9)`}},F.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:xa.knownCount})]})]}):null,jt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:qa})]})}):null]})]})]})})})]})]})}const co=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:no},Symbol.toStringTag,{value:"Module"}));export{oo as C,lo as a,co as b};
