import{r as n,j as e,u as mn,a as Ja,b as Hn,c as Wn,d as Qn,R as pn,B as fn,C as bn,Q as gr}from"./vendor-CAC2WLor.js";import{L as Vs,A as qs,g as Us,a as mr,b as Va,c as Gn,s as ls,d as Yn,e as pr,f as In,h as na,i as fr,j as br,k as tn,l as an,m as Js,n as Xn,o as qn,p as yr,u as cs,q as Hs,r as xr,t as vr,v as wr,w as jr,x as kr,y as Ws,z as Nr,B as Qs,C as Gs,D as Sr,E as Tr,F as yn,G as qa,H as Cr,I as Ys,J as Ir,K as Zn,M as Xs,N as Mr,O as Lr,P as Ar,Q as Un,R as ya,S as $r,T as Rr,U as Pr,V as Er,W as Fr,X as Kr,Y as _r,Z as Dr,_ as Br,$ as zr,a0 as Or,a1 as Vr,a2 as qr,a3 as ds,a4 as Ur,a5 as Jr,a6 as Hr,a7 as Wr,a8 as us,a9 as Qr,aa as Gr}from"./recreatio-core-B12ledQl.js";import"./vendor-cogita-ui-DTaQ_FiW.js";const Ba={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},Ka={moveMs:900,pauseMs:220,errorMs:900},Yr=(t=11)=>{let a=t;const r=()=>(a=(a*1664525+1013904223)%4294967296,a/4294967296),{width:s,height:i,paddingX:o,paddingY:h,levels:v}=Ba,m=(i-h*2)/(v.length-1),w=[],d=[],f=[];v.forEach((x,y)=>{const de=i-h-y*m,B=s-o*2,p=[];for(let Q=0;Q<x;Q+=1){const N=o+(Q+1)*B/(x+1),ee=(r()-.5)*18,q=Math.max(o,Math.min(s-o,N+ee)),R=y===0?3:y<2?2.1:1.4,me=y===0?"root":`l${y}-${Q}`;p.push({id:me,x:y===0?s/2:q,y:de,r:R,level:y,role:y===0?"root":void 0})}f.push(p),w.push(...p)});const l=f[f.length-1];if(l!=null&&l.length){const x=l[Math.floor(l.length/2)];x.role="goal",x.r=2}for(let x=1;x<f.length;x+=1){const y=f[x-1];f[x].forEach(B=>{const p=[...y].sort((q,R)=>Math.abs(q.x-B.x)-Math.abs(R.x-B.x)),Q=p[0],N=p[1]&&r()<.45?p[1]:null;(N?[Q,N]:[Q]).forEach(q=>{d.push({from:q.id,to:B.id,key:`${q.id}-${B.id}`})}),r()<.2&&p[2]&&d.push({from:p[2].id,to:B.id,key:`${p[2].id}-${B.id}`})})}const c=new Map;d.forEach(x=>{const y=c.get(x.to)??[];y.push(x.from),c.set(x.to,y)});const j=new Map,g=new Map,S=new Map;d.forEach(x=>{const y=j.get(x.from)??[];y.push(x.key),j.set(x.from,y);const de=g.get(x.from)??[];de.push(x.to),g.set(x.from,de);const B=S.get(x.from)??[];B.push(x.to),S.set(x.from,B);const p=S.get(x.to)??[];p.push(x.from),S.set(x.to,p)});const F=new Map;return w.forEach(x=>{F.set(x.id,x)}),{nodes:w,links:d,parentsById:c,linksByFrom:j,childrenByFrom:g,neighborsById:S,nodesById:F}};function Xr({slides:t,activeIndex:a,introOpen:r,prefersReducedMotion:s,onNext:i,onPrev:o,onSelect:h,onExit:v,onOpen:m,onRegister:w}){const d=a===t.length-1,f=r&&a===0?"entry":"docked",l=t[t.length-1],[c,j]=n.useState(!1),g=n.useMemo(()=>Array.from({length:20},(_,P)=>({src:`/cogita/logo/Cogita${String(P).padStart(2,"0")}.png`,kind:P<=11?"bubble":P<=17?"text":"recreatio"})),[]),S=r&&a===0;n.useEffect(()=>{if(!r){j(!1);return}a>0&&!c&&j(!0)},[a,r,c]);const F=n.useRef(0),x=n.useRef(null),y=n.useMemo(()=>{const _={x:40,y:160},P={x:260,y:48},k=6,T=P.x-_.x,I=_.y-P.y,he=T/k,xe=[.3,.45,.6,.65,1.4,2.2],ge=xe.reduce((Y,ae)=>Y+ae,0),te=xe.map(Y=>I*Y/ge),$=[_];let X=_.x,ie=_.y;for(let Y=1;Y<=k;Y+=1){const ae=(Math.random()-.5)*14,ve=(Math.random()-.5)*28;X=Math.max(_.x+Y*14,Math.min(P.x-(k-Y)*14,X+he+ae));const U=te[Y-1]??te[te.length-1];ie=ie-U+ve;const oe=Math.max(P.y,Math.min(_.y-4,ie));$.push({x:Math.round(X),y:Math.round(oe)})}return $[$.length-1]=P,$},[]),de=n.useMemo(()=>{const I=(ge,te,$)=>Math.min($,Math.max(te,ge)),he=y.map(ge=>{const te=10+Math.random()*36;return{x:I(ge.x,40,260),y:I(ge.y-te,40,140)}}),xe=y.map((ge,te)=>{var ie;const $=12+Math.random()*40,X=((ie=he[te])==null?void 0:ie.y)??ge.y;return{x:I(ge.x,40,260),y:I(Math.max(X+10,ge.y+$),60,170)}});return{upper:he,lower:xe}},[y]),B=n.useMemo(()=>{var P;const _=((P=y[4])==null?void 0:P.x)??260;return Math.max(0,Math.min(240,_-40))},[y]),p=n.useMemo(()=>{var te,$;const _=(X,ie,Y)=>Math.min(Y,Math.max(ie,X)),P=(X,ie,Y)=>y.map((ae,ve)=>{var bt,mt;const U=((bt=de.upper[ve])==null?void 0:bt.y)??ae.y,oe=((mt=de.lower[ve])==null?void 0:mt.y)??ae.y,$e=(Math.random()-.5)*70,qe=ae.y+X+$e,_e=_(ae.y+ie,U+6,oe-6),Je=_(ae.y+Y,U+6,oe-6);return{x:ae.x,y:_(qe,Math.min(_e,Je),Math.max(_e,Je))}}),k=-14+Math.random()*28,T=14+Math.random()*28,I=P(k,-80,12),he=P(T,-12,80);for(let X=4;X<y.length;X+=1){const ie=y[X],Y=((te=de.upper[X])==null?void 0:te.y)??ie.y,ae=(($=de.lower[X])==null?void 0:$.y)??ie.y;I[X]={x:ie.x,y:_(ie.y-12,Y+6,ae-6)},he[X]={x:ie.x,y:_(ie.y+12,Y+6,ae-6)}}const xe=de.upper.length?de.upper[de.upper.length-1].y:40,ge=de.lower.length?de.lower[de.lower.length-1].y:170;return I[I.length-1]={x:y[y.length-1].x,y:_(y[y.length-1].y-14,xe,ge)},he[he.length-1]={x:y[y.length-1].x,y:_(y[y.length-1].y+12,xe,ge)},{higher:I,lower:he}},[y,de]),Q=1e4,N=n.useMemo(()=>{let _=17;const P=()=>(_=(_*1664525+1013904223)%4294967296,_/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((T,I)=>{const he=(P()-.5)*240,xe=(P()-.5)*180,ge=(P()-.5)*24;return{id:`card-${I+1}`,throw:{x:`${he.toFixed(0)}px`,y:`${xe.toFixed(0)}px`,rot:`${ge.toFixed(1)}deg`},grid:{x:`${T.x}px`,y:`${T.y}px`},delay:`${I*.12}s`}})},[]),ee=n.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[q,R]=n.useState([]),me=n.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),K=n.useMemo(()=>{const P=[],T=(he,xe)=>he+Math.random()*(xe-he);for(let he=0;he<6;he+=1){let xe=!1;for(let ge=0;ge<80;ge+=1){const te=T(14,86),$=T(10,34);if(P.every(ie=>{const Y=ie.x-te,ae=ie.y-$;return Math.hypot(Y,ae)>=12})){P.push({x:te,y:$}),xe=!0;break}}xe||P.push({x:T(16,84),y:T(12,32)})}return P.map((he,xe)=>({id:`p${xe+1}`,x:`${he.x.toFixed(1)}%`,y:`${he.y.toFixed(1)}%`,xNum:he.x,yNum:he.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[Z,Le]=n.useState(0),[G,L]=n.useState(0),[A,z]=n.useState([]),W=1e4,O=n.useMemo(()=>{if(K.length<2)return[];const _=xe=>{let ge=xe+1831565813;return ge=Math.imul(ge^ge>>>15,ge|1),ge^=ge+Math.imul(ge^ge>>>7,ge|61),((ge^ge>>>14)>>>0)/4294967296},P=(xe,ge)=>Math.floor(_(xe)*ge),k=new Set,T=[],I=Math.min(3,K.length);let he=0;for(;T.length<I&&he<30;){he+=1;const xe=P(Z*13+he*5,K.length),ge=P(Z*29+he*7,K.length);if(xe===ge)continue;const te=xe<ge?`${xe}-${ge}`:`${ge}-${xe}`;k.has(te)||(k.add(te),T.push({id:`link-${te}`,from:K[xe],to:K[ge],delay:`${(he*.35).toFixed(2)}s`}))}return T},[Z,K]);n.useEffect(()=>{if(!r||a!==2)return;const _=()=>{const k=N.map(T=>T.id);for(let T=k.length-1;T>0;T-=1){const I=Math.floor(Math.random()*(T+1));[k[T],k[I]]=[k[I],k[T]]}return k.slice(0,4)};R(_());const P=window.setInterval(()=>{R(_())},Q);return()=>window.clearInterval(P)},[a,r,N,Q]),n.useEffect(()=>{if(!r||a!==3)return;const _=()=>{L(Math.floor(Math.random()*me.length)),z(K.map(()=>Math.random()<.6?"good":"bad")),Le(k=>k+1)};_();const P=window.setInterval(_,W);return()=>window.clearInterval(P)},[a,r,me.length,K,W]);const fe=n.useMemo(()=>Yr(11),[]),[se,ne]=n.useState(new Set(["root"])),[Ne,Ae]=n.useState(new Set),[Pe,Re]=n.useState(new Set),[et,ct]=n.useState({fromId:"root",toId:"root",key:0}),Ce=n.useRef(se),We=n.useRef("root"),xt=n.useRef(0),Ve=n.useRef(null),Be=n.useRef(null),tt=n.useRef([]);n.useEffect(()=>{Ce.current=se},[se]);const ot=n.useMemo(()=>{const _=new Set;return se.forEach(P=>{const k=fe.linksByFrom.get(P);k&&k.forEach(T=>_.add(T))}),_},[se,fe]),Ye=fe.nodesById.get(et.toId)??fe.nodesById.get("root"),Ie=Ye?`${Ye.x/Ba.width*100}%`:"50%",ze=Ye?`${Ye.y/Ba.height*100}%`:"90%";n.useEffect(()=>{if(!r||a!==1||s)return;(()=>{ne(new Set(["root"])),Ae(new Set),Re(new Set),ct({fromId:"root",toId:"root",key:0}),Be.current=null,xt.current=0,We.current="root",tt.current=[]})();const P=()=>{const T=We.current,I=Ce.current,xe=(fe.childrenByFrom.get(T)??[]).filter(ae=>!I.has(ae));if(xe.length)return xe[Math.floor(Math.random()*xe.length)];if(I.size>=fe.nodes.length){const ae=fe.neighborsById.get(T)??[];return ae.length?ae[Math.floor(Math.random()*ae.length)]:null}const ge=ae=>(fe.childrenByFrom.get(ae)??[]).some(U=>!I.has(U)),te=[T],$=new Set([T]),X=new Map;let ie=null;for(;te.length;){const ae=te.shift();if(!ae)break;if(ae!==T&&ge(ae)){ie=ae;break}(fe.neighborsById.get(ae)??[]).forEach(U=>{$.has(U)||($.add(U),X.set(U,ae),te.push(U))})}if(!ie)return null;let Y=ie;for(;X.get(Y)&&X.get(Y)!==T;)Y=X.get(Y)??Y;return Y},k=(T,I)=>{if(T===I){const he=P();he&&k(T,he);return}xt.current+=1,ct({fromId:T,toId:I,key:xt.current}),We.current=I,Ve.current=window.setTimeout(()=>{const he=fe.parentsById.get(I)??[],xe=Ce.current,ge=he.filter(ie=>!xe.has(ie));if(!ge.length){const ie=new Set(xe);ie.add(I),ne(ie),Ve.current=window.setTimeout(()=>{for(;tt.current.length;){const ae=tt.current[tt.current.length-1];if(!ie.has(ae)){if(ae!==I){k(I,ae);return}break}tt.current.pop()}const Y=P();Y&&k(I,Y)},Ka.pauseMs);return}const te=new Set([I,...ge]),$=new Set(ge.map(ie=>`${ie}-${I}`));Ae(te),Re($),tt.current.includes(I)||tt.current.push(I);const X=ge[Math.floor(Math.random()*ge.length)];Be.current={fromId:I,toId:X},Ve.current=window.setTimeout(()=>{Ae(new Set),Re(new Set);const ie=Be.current;ie&&k(ie.fromId,ie.toId)},Ka.errorMs)},Ka.moveMs)};return Ve.current=window.setTimeout(()=>{const T=P();T&&k(We.current,T)},Ka.pauseMs),()=>{Ve.current&&window.clearTimeout(Ve.current)}},[a,r,fe,s]);const Xe=_=>{if(!r)return;const P=Date.now();P-F.current<520||Math.abs(_.deltaY)<10||(F.current=P,_.deltaY>0?i():o(),_.preventDefault())},E=_=>{if(!r)return;const P=_.touches[0];P&&(x.current={x:P.clientX,y:P.clientY})},M=_=>{if(!r)return;const P=x.current;if(x.current=null,!P)return;const k=_.changedTouches[0];if(!k)return;const T=k.clientX-P.x,I=k.clientY-P.y;Math.abs(I)<40||Math.abs(I)<Math.abs(T)||(I<0?i():o())};return e.jsxs("div",{className:`cogita-intro ${r?"is-open":"is-closed"} ${s?"is-reduced":""} ${d?"is-final":""}`,"data-slide":a+1,onWheel:Xe,onTouchStart:E,onTouchEnd:M,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":f,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${S&&!c?"is-entry":""}`,children:g.map((_,P)=>e.jsx("img",{src:_.src,alt:"",className:`cogita-logo-layer ${P===0?"is-base":""} ${_.kind==="text"?"is-text":_.kind==="recreatio"?"is-recreatio":""} ${_.kind==="bubble"?"is-bubble":""}`},_.src))})}),r&&t.map((_,P)=>{const k=P===a;return e.jsxs("section",{className:`cogita-intro-slide slide-${P+1} ${k?"is-active":""}`,"aria-hidden":!k,children:[e.jsxs("div",{className:"cogita-intro-text",children:[_.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:_.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:_.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:_.title}),_.body&&e.jsx("p",{children:_.body.split(`
`).map((T,I)=>e.jsxs("span",{children:[T,I===0&&e.jsx("br",{})]},String(I)))})]}),_.micro&&e.jsx("p",{className:"cogita-intro-micro",children:_.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:d?w:i,children:_.cta}),d&&_.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>h(0),children:_.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[P===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${Ba.width} ${Ba.height}`,preserveAspectRatio:"none",children:[fe.links.map(T=>{const I=fe.nodesById.get(T.from),he=fe.nodesById.get(T.to);if(!I||!he)return null;const xe=ot.has(T.key),ge=Pe.has(T.key);return e.jsx("line",{className:`map-link ${xe?"is-active":""} ${ge?"is-error":""}`,x1:I.x,y1:I.y,x2:he.x,y2:he.y},T.key)}),fe.nodes.map(T=>{const I=se.has(T.id),he=Ne.has(T.id);return e.jsx("circle",{className:`map-node ${T.role?`is-${T.role}`:""} ${I?"is-active":""} ${he?"is-error":""}`,cx:T.x,cy:T.y,r:T.r},T.id)})]}),Ye&&e.jsx("span",{className:"map-explorer-dot",style:{left:Ie,top:ze,"--move":`${Ka.moveMs}ms`}})]}),P===2&&e.jsx("div",{className:"cogita-index-cards",children:N.map(T=>{const I=q.indexOf(T.id),he=I>=0?ee[I]:null,xe=(he==null?void 0:he.x)??"140px",ge=(he==null?void 0:he.y)??"140px",te=I>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":T.throw.x,"--throw-y":T.throw.y,"--throw-rot":T.throw.rot,"--grid-x":T.grid.x,"--grid-y":T.grid.y,"--stack-x":xe,"--stack-y":ge,"--stack-opacity":te,"--delay":T.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},T.id)})}),P===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[me.map((T,I)=>e.jsxs("div",{className:`round-card ${I===G?"is-active":""}`,style:{"--card-x":T.x,"--card-y":T.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},T.id)),me[G]&&e.jsx("span",{className:"round-ring",style:{"--card-x":me[G].x,"--card-y":`calc(${me[G].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:K.map(T=>e.jsx("span",{className:"player-dot",style:{left:T.x,top:T.y,"--jitter-x":T.jitterX,"--jitter-y":T.jitterY,"--breath-delay":T.delay}},T.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:O.map(T=>e.jsx("line",{className:"round-link",x1:T.from.xNum,y1:T.from.yNum,x2:T.to.xNum,y2:T.to.yNum,style:{"--delay":T.delay}},T.id))}),e.jsx("div",{className:"round-flows",children:K.map((T,I)=>{const he=A[I]??"good",xe=me[G];if(!xe)return null;const ge=`calc(${xe.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":T.x,"--from-y":T.y,"--to-x":xe.x,"--to-y":ge,"--delay":`${I*.12}s`}}),e.jsx("span",{className:`return-dot is-${he}`,style:{"--from-x":xe.x,"--from-y":ge,"--to-x":T.x,"--to-y":T.y,"--delay":`${I*.12}s`}}),e.jsx("span",{className:`result-pop is-${he}`,style:{"--at-x":T.x,"--at-y":T.y,"--delay":`${I*.12}s`}})]},`${T.id}-${Z}`)})})]},`round-${Z}`),P===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${y[0].x} ${y[0].y} L${y[1].x} ${y[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${y[1].x} ${y[1].y} L${y[2].x} ${y[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${y[2].x} ${y[2].y} L${y[3].x} ${y[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${y[3].x} ${y[3].y} L${y[4].x} ${y[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${y[4].x} ${y[4].y} L${y[5].x} ${y[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${y[5].x} ${y[5].y} L${y[6].x} ${y[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${B};${B};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${de.upper.map((T,I)=>`${I===0?"M":"L"}${T.x} ${T.y}`).join(" ")} ${de.lower.slice().reverse().map(T=>`L${T.x} ${T.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${de.upper.map((T,I)=>`${I===0?"M":"L"}${T.x} ${T.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${de.lower.map((T,I)=>`${I===0?"M":"L"}${T.x} ${T.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[p.higher.slice(0,6).map((T,I)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${I+1}`,d:`M${T.x} ${T.y} L${p.higher[I+1].x} ${p.higher[I+1].y}`,pathLength:"100"},`peer-1-${I}`)),p.lower.slice(0,6).map((T,I)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${I+1}`,d:`M${T.x} ${T.y} L${p.lower[I+1].x} ${p.lower[I+1].y}`,pathLength:"100"},`peer-2-${I}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${y[0].x/300*100}%`,"--p0y":`${y[0].y/200*100}%`,"--p1x":`${y[1].x/300*100}%`,"--p1y":`${y[1].y/200*100}%`,"--p2x":`${y[2].x/300*100}%`,"--p2y":`${y[2].y/200*100}%`,"--p3x":`${y[3].x/300*100}%`,"--p3y":`${y[3].y/200*100}%`,"--p4x":`${y[4].x/300*100}%`,"--p4y":`${y[4].y/200*100}%`,"--p5x":`${y[5].x/300*100}%`,"--p5y":`${y[5].y/200*100}%`,"--p6x":`${y[6].x/300*100}%`,"--p6y":`${y[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${p.higher[0].x/300*100}%`,"--q0y":`${p.higher[0].y/200*100}%`,"--q1x":`${p.higher[1].x/300*100}%`,"--q1y":`${p.higher[1].y/200*100}%`,"--q2x":`${p.higher[2].x/300*100}%`,"--q2y":`${p.higher[2].y/200*100}%`,"--q3x":`${p.higher[3].x/300*100}%`,"--q3y":`${p.higher[3].y/200*100}%`,"--q4x":`${p.higher[4].x/300*100}%`,"--q4y":`${p.higher[4].y/200*100}%`,"--q5x":`${p.higher[5].x/300*100}%`,"--q5y":`${p.higher[5].y/200*100}%`,"--q6x":`${p.higher[6].x/300*100}%`,"--q6y":`${p.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${p.lower[0].x/300*100}%`,"--q0y":`${p.lower[0].y/200*100}%`,"--q1x":`${p.lower[1].x/300*100}%`,"--q1y":`${p.lower[1].y/200*100}%`,"--q2x":`${p.lower[2].x/300*100}%`,"--q2y":`${p.lower[2].y/200*100}%`,"--q3x":`${p.lower[3].x/300*100}%`,"--q3y":`${p.lower[3].y/200*100}%`,"--q4x":`${p.lower[4].x/300*100}%`,"--q4y":`${p.lower[4].y/200*100}%`,"--q5x":`${p.lower[5].x/300*100}%`,"--q5y":`${p.lower[5].y/200*100}%`,"--q6x":`${p.lower[6].x/300*100}%`,"--q6y":`${p.lower[6].y/200*100}%`}})]})})}),P===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),P===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},_.id)}),!r&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:l.title}),l.body&&e.jsx("p",{children:l.body}),l.micro&&e.jsx("p",{className:"cogita-intro-micro",children:l.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:w,children:l.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:m,children:"Otwórz pokaz"})]})]})})]}),r&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((_,P)=>e.jsx("button",{type:"button",className:`dot ${a===P?"active":""}`,"aria-label":_.title,onClick:()=>h(P)},_.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:v,children:"Pomiń"})]})]})}const Zr=6,ei=4;function ti({copy:t,onAuthAction:a,authLabel:r,showProfileMenu:s,onProfileNavigate:i,onToggleSecureMode:o,onLogout:h,secureMode:v,onNavigate:m,language:w,onLanguageChange:d}){const f=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}m("home")},l=n.useRef(null),c=n.useRef([]),j=n.useMemo(()=>{let z=Date.now()%2147483647;const W=()=>(z=z*48271%2147483647,z/2147483647);return Array.from({length:Zr},(O,fe)=>{const se=6+W()*8,ne=7+W()*10,Ne=6+W()*9,Ae=-W()*se,Pe=-W()*ne,Re=-W()*Ne,et=.18+W()*.28,ct=12+W()*18,Ce=4+W()*8,We=(W()-.5)*3.2,xt=(W()-.5)*3.8,Ve=W()>.5?"alternate":"alternate-reverse",Be=W()>.5?"alternate":"alternate-reverse",tt=W()>.5?"alternate":"alternate-reverse",ot=.18+W()*.42,Ye=30+W()*60,Ie=-45-W()*38,ze=188+W()*32,Xe=.1+W()*.2;return{id:`wave-${fe+1}`,style:{"--wave-sway-duration":`${se}s`,"--wave-scale-duration":`${ne}s`,"--wave-drift-duration":`${Ne}s`,"--wave-sway-delay":`${Ae}s`,"--wave-scale-delay":`${Pe}s`,"--wave-drift-delay":`${Re}s`,"--wave-sway-dir":Ve,"--wave-scale-dir":Be,"--wave-drift-dir":tt,"--wave-scale":`${et}`,"--wave-shift":`${ct}%`,"--wave-xshift":`${Ce}%`,"--wave-x0":`${We}%`,"--wave-y0":`${xt}%`,"--wave-opacity":`${ot}`,"--wave-blur":`${Ye}px`,"--wave-bottom":`${Ie}%`,"--wave-hue":`${ze}`,"--wave-glow":`${Xe}`}}})},[]),g=n.useMemo(()=>{let z=Date.now()*3%2147483647;const W=()=>(z=z*48271%2147483647,z/2147483647);return Array.from({length:ei},(O,fe)=>{const se=180+W()*220,ne=220+W()*280,Ne=-W()*se,Ae=-W()*ne,Pe=.12+W()*.22,Re=3+W()*7,et=1+W()*3,ct=(W()-.5)*2.8,Ce=(W()-.5)*2.2;return{id:`mesh-${fe+1}`,seed:1e3+fe*991+Math.floor(W()*999),style:{"--mesh-sway-duration":`${se}s`,"--mesh-drift-duration":`${ne}s`,"--mesh-sway-delay":`${Ne}s`,"--mesh-drift-delay":`${Ae}s`,"--mesh-scale":`${Pe}`,"--mesh-shift":`${Re}%`,"--mesh-xshift":`${et}%`,"--mesh-x0":`${Ce}%`,"--mesh-y0":`${ct}%`}}})},[]),S=n.useMemo(()=>{const z=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],W=t.cogita.introSlides,O=new Map(W.map(fe=>[fe.id,fe]));return z.map(fe=>{var ne;const se=O.get(fe.id);return{...fe,...se,title:(se==null?void 0:se.title)??"Cogita",cta:(se==null?void 0:se.cta)??((ne=t.cogita.introSlides[0])==null?void 0:ne.cta)??t.cogita.loginCta,secondary:se==null?void 0:se.secondary}})},[t.cogita.introSlides]),[F,x]=n.useState(0),[y,de]=n.useState(!0),[B,p]=n.useState(!1),Q=S.length-1,N=n.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),ee=n.useCallback(()=>{N(),a()},[N,a]),q=n.useCallback(()=>{de(!0),x(0)},[]),R=n.useCallback(()=>{de(!1),x(Q)},[Q]),me=n.useCallback(z=>{x(Math.max(0,Math.min(Q,z)))},[Q]),K=n.useCallback(()=>{F>=Q?ee():me(F+1)},[F,me,ee,Q]),Z=n.useCallback(()=>{me(F-1)},[F,me]);n.useEffect(()=>{var O;const z=(O=window.matchMedia)==null?void 0:O.call(window,"(prefers-reduced-motion: reduce)");if(!z)return;const W=()=>p(z.matches);return W(),z.addEventListener?(z.addEventListener("change",W),()=>z.removeEventListener("change",W)):(z.addListener(W),()=>z.removeListener(W))},[]),n.useEffect(()=>{if(!y)return;const z=W=>{const O=W.target;if(!O)return;const fe=O.tagName;if(!(O.isContentEditable||fe==="INPUT"||fe==="TEXTAREA"||fe==="SELECT"||fe==="BUTTON"||fe==="A"||O.closest('button, a, [role="button"], [role="link"]'))){if(W.key==="Escape"){R();return}if(W.key==="ArrowLeft"||W.key==="ArrowUp"){Z();return}(W.key==="ArrowRight"||W.key==="ArrowDown"||W.code==="Space"||W.key===" ")&&(W.preventDefault(),K())}};return window.addEventListener("keydown",z),()=>window.removeEventListener("keydown",z)},[R,K,Z,y]),n.useEffect(()=>{y&&F===Q&&N()},[F,y,Q,N]),n.useEffect(()=>{const z=l.current;if(!z)return;const W=c.current.filter(Ie=>!!Ie);if(!W.length)return;const O=1,fe=.6,se=.6,ne=Math.max(1,Math.min(O,window.devicePixelRatio||1));let Ne=0,Ae=0,Pe=fe,Re=0,et=0;const ct=Ie=>{let ze=Ie%2147483647;return ze<=0&&(ze+=2147483646),(Xe,E)=>{ze=ze*48271%2147483647;const M=ze/2147483647;return Xe+M*(E-Xe)}},Ce={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},We=Ie=>{const ze=Math.sin(Ie*12.9898)*43758.5453;return ze-Math.floor(ze)},xt=Ie=>{const ze=We(Ie+.1)||1e-4,Xe=We(Ie+.7)||1e-4;return Math.sqrt(-2*Math.log(ze))*Math.cos(2*Math.PI*Xe)},Ve=(Ie,ze)=>{const Xe=Math.floor(Ie),E=Xe+1,M=Ie-Xe,_=M*M*(3-2*M),P=We(Xe*12.9898+ze*78.233),k=We(E*12.9898+ze*78.233);return P+(k-P)*_},Be=Ie=>{const ze=ct(Ie),Xe=Math.min(4,Math.max(4,Math.floor(Ne/1200*Ce.filamentCount)));return Array.from({length:Xe},(E,M)=>{const _=Math.max(-1,Math.min(1,xt(Ie+M*.37))),P=Math.min(1,Math.max(0,We(Ie+M*1.31))),k=Math.min(Ce.depthLayers-1,Math.floor(P*Ce.depthLayers));return{seed:ze(0,Math.PI*2)+Ie*.01,offset:_,freqA:Ce.freq1*(.75+ze(0,.5)),freqB:Ce.freq2*(.75+ze(0,.5)),ampA:Ce.amp1*(.6+ze(0,.7)),ampB:Ce.amp2*(.6+ze(0,.7)),width:2+M%5*.32,depth:P,layer:k}})},tt=(Ie,ze,Xe)=>{const E=Math.max(30,Math.floor(Ne*Ae/14e4));Ie.save(),Ie.globalAlpha=.6;for(let M=0;M<E;M+=1){const _=We(M*9.1+Ne*.11)*ze+Xe,P=We(M*3.7+Ae*.23)*Ae,k=1.2+We(M*5.9)*2.4,T=Ie.createRadialGradient(_,P,0,_,P,k*2);T.addColorStop(0,"rgba(10, 30, 60, 0.45)"),T.addColorStop(1,"rgba(10, 30, 60, 0)"),Ie.fillStyle=T,Ie.beginPath(),Ie.arc(_,P,k*2,0,Math.PI*2),Ie.fill()}Ie.restore()},ot=(Ie,ze)=>{Ie.clearRect(0,0,Ne,Ae);const Xe=Ae*Ce.waveCenter,E=Ce.waveBandPx,M=Ce.segments,_=Ce.colors.filaments,P=Re||Ne,k=0;tt(Ie,P,k),Ie.strokeStyle=_,Ie.lineCap="round",Ie.lineJoin="round";for(let T=0;T<ze.length;T+=1){const I=ze[T],he=I.offset*E*(.85+We(I.seed)*.4),xe=1-Math.min(1,Math.abs(he)/E),ge=Math.exp(-Math.pow(he/Ce.crestThickness,2)),te=I.layer===0?1.1:I.layer===1?.85:.6,$=.35+(1-I.depth)*.65,X=xe*$*te*(.34+ge*.45);Ie.globalAlpha=X,Ie.lineWidth=I.width*(1+(1-I.depth)*.8);const ie=[];for(let ae=0;ae<=M;ae+=1){const ve=ae/M*P+k,U=(Ve(ve*.012,I.seed)-.5)*Ce.xJitter,oe=ve+U,$e=(Ve(oe*I.freqA,I.seed)-.5)*Ce.jitterA,qe=(Ve(oe*I.freqB,I.seed*1.7)-.5)*Ce.jitterB,_e=Xe+Math.sin(oe*I.freqA+I.seed)*I.ampA+Math.sin(oe*I.freqB+I.seed*1.3)*I.ampB+he+$e+qe;ie.push({x:oe,y:_e})}Ie.beginPath(),Ie.moveTo(ie[0].x,ie[0].y);for(let ae=1;ae<ie.length-1;ae+=1){const ve=(ie[ae].x+ie[ae+1].x)/2,U=(ie[ae].y+ie[ae+1].y)/2;Ie.quadraticCurveTo(ie[ae].x,ie[ae].y,ve,U)}const Y=ie[ie.length-1];Ie.quadraticCurveTo(Y.x,Y.y,Y.x,Y.y),Ie.stroke()}Ie.save(),Ie.globalCompositeOperation="lighter",Ie.strokeStyle=Ce.colors.glow,Ie.lineCap="round",Ie.lineJoin="round";for(let T=0;T<ze.length;T+=1){const I=ze[T];if(Math.abs(I.offset)*E>Ce.crestThickness)continue;const he=Ce.glowAlpha*(.7+(1-I.depth)*.6);Ie.globalAlpha=he,Ie.lineWidth=1.6+(1-I.depth)*1.2;const xe=[];for(let te=0;te<=M;te+=1){const $=te/M*P+k,X=Math.sin($*.02+I.seed)*3,ie=Xe+Math.sin($*I.freqA+I.seed)*I.ampA+Math.sin($*I.freqB+I.seed*1.3)*I.ampB+I.offset*E*.35+X;xe.push({x:$,y:ie})}Ie.beginPath(),Ie.moveTo(xe[0].x,xe[0].y);for(let te=1;te<xe.length-1;te+=1){const $=(xe[te].x+xe[te+1].x)/2,X=(xe[te].y+xe[te+1].y)/2;Ie.quadraticCurveTo(xe[te].x,xe[te].y,$,X)}const ge=xe[xe.length-1];Ie.quadraticCurveTo(ge.x,ge.y,ge.x,ge.y),Ie.stroke()}Ie.restore()},Ye=()=>{Ne=Math.floor(z.clientWidth),Ae=Math.floor(z.clientHeight),Re=Math.floor(Ne*1.8),et=Ae,Pe=Ne<820?se:fe,W.forEach(Ie=>{const ze=Ie.getContext("2d");if(!ze)return;Ie.width=Math.floor(Re*ne*Pe),Ie.height=Math.floor(et*ne*Pe),Ie.style.width=`${Re}px`,Ie.style.height=`${et}px`,Ie.style.left=`${-(Re-Ne)/2}px`,ze.setTransform(ne*Pe,0,0,ne*Pe,0,0);const Xe=Number(Ie.dataset.seed||1),E=Be(Xe);ot(ze,E)})};return Ye(),window.addEventListener("resize",Ye,{passive:!0}),()=>window.removeEventListener("resize",Ye)},[g]);const Le=S[Math.min(F,S.length-1)],G=y?Le:S[S.length-1],L=(G==null?void 0:G.theme)??S[0].theme,A={"--cogita-bg0":L.bg0,"--cogita-bg1":L.bg1,"--cogita-bg2":L.bg2,"--cogita-bloom":L.bloom,"--cogita-sat":L.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:f,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Vs,{value:w,onChange:d}),e.jsx(qs,{copy:t,label:r,isAuthenticated:s,secureMode:v,onLogin:a,onProfileNavigate:i,onToggleSecureMode:o,onLogout:h,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:l,className:"cogita-section cogita-home",style:A,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[g.map((z,W)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:z.style,"data-seed":z.seed,ref:O=>{c.current[W]=O}},z.id)),j.map(z=>e.jsx("div",{className:"cogita-home-wave",style:z.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},z.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(Xr,{slides:S,activeIndex:F,introOpen:y,prefersReducedMotion:B,onNext:K,onPrev:Z,onSelect:me,onExit:R,onOpen:q,onRegister:ee})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const Ro=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:ti},Symbol.toStringTag,{value:"Module"})),Zs=n.createContext(!1);function Pt({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,headerExtra:d,children:f}){if(n.useContext(Zs))return e.jsx(e.Fragment,{children:f});const c=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}v("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:c,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Vs,{value:m,onChange:w}),e.jsxs("div",{className:"cogita-header-right",children:[d,e.jsx(qs,{copy:t,label:a,isAuthenticated:r,secureMode:h,onLogin:()=>v("home"),onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:f}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function da(t){const[a,r]=n.useState("Cogita library"),[s,i]=n.useState(null);return n.useEffect(()=>{let o=!1;return Us().then(h=>{if(o)return;const v=h.find(m=>m.libraryId===t);v&&r(v.name)}).catch(()=>{o||r("Cogita library")}),()=>{o=!0}},[t]),n.useEffect(()=>{let o=!1;return mr(t).then(h=>{o||i(h)}).catch(()=>{o||i(null)}),()=>{o=!0}},[t]),{libraryName:a,stats:s}}function hs({slices:t}){const a=t.reduce((s,i)=>s+Math.max(0,i.value),0),r=n.useMemo(()=>{if(a<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let s=0;return`conic-gradient(${t.map(o=>{const v=Math.max(0,o.value)/a*360,m=s,w=s+v;return s=w,`${o.color} ${m}deg ${w}deg`}).join(",")})`},[t,a]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:r}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(s=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:s.color}}),e.jsx("strong",{children:s.value}),e.jsx("small",{children:s.label})]},s.label))})]})}function ai({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,libraryId:d}){const{libraryName:f,stats:l}=da(d),[c,j]=n.useState("infos"),[g,S]=n.useState(0),[F,x]=n.useState(0),[y,de]=n.useState(0),B=(l==null?void 0:l.totalInfos)??0,p=(l==null?void 0:l.totalCollections)??0,Q=0,N=0,ee=0,q=Math.max(0,B-ee-F),R=Math.max(0,B-F-y);n.useEffect(()=>{let K=!1;return(async()=>{try{const Le=await Va({libraryId:d,limit:200}),G=await Promise.all(Le.items.map(L=>Gn({libraryId:d,collectionId:L.collectionId}).catch(()=>[])));if(K)return;S(G.reduce((L,A)=>L+A.length,0))}catch{K||S(0)}})(),()=>{K=!0}},[d]),n.useEffect(()=>{let K=!1;return(async()=>{try{const[Le,G,L]=await Promise.all([ls({libraryId:d,type:"computed",limit:1}).catch(()=>({total:0})),ls({libraryId:d,type:"source",limit:1}).catch(()=>({total:0})),Yn({libraryId:d}).catch(()=>({items:[]}))]);if(K)return;x((Le.total??0)+(G.total??0));const A=new Set(L.items.filter(z=>z.childItemType.toLowerCase()==="info").map(z=>z.childItemId).filter(Boolean));de(A.size)}catch{K||(x(0),de(0))}})(),()=>{K=!0}},[d]);const me=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:B},{key:"collections",label:t.cogita.library.overview.stats.collections,value:p},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:g},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:Q},{key:"texts",label:t.cogita.library.overview.stats.texts,value:N}];return e.jsx(Pt,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:f})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:me.map(K=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${c===K.key?"active":""}`,onClick:()=>j(K.key),children:[e.jsx("span",{children:K.label}),e.jsx("strong",{children:K.value})]},K.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),c==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(hs,{slices:[{label:t.cogita.library.overview.known,value:ee,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:q,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:F,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(hs,{slices:[{label:t.cogita.library.overview.availableChecks,value:y,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:R,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const nt=(t,a)=>{const r=t.cogita.library.infoTypes,s=t.cogita.library.connectionTypes,i=t.cogita.library.groupTypes;return{any:r.any,vocab:r.vocab,book:i.book,citation:i.citation,language:r.language,word:r.word,sentence:r.sentence,topic:r.topic,collection:r.collection,person:r.person,institution:r.institution,collective:r.collective,orcid:r.orcid,address:r.address,email:r.email,phone:r.phone,media:r.media,work:r.work,geo:r.geo,music_piece:r.musicPiece,music_fragment:r.musicFragment,source:r.source,question:r.question,computed:r.computed,"word-language":s.wordLanguage,"citation-language":s.citationLanguage,"language-sentence":s.languageSentence,translation:s.translation,"word-topic":s.wordTopic,reference:s.reference,"source-resource":s.sourceResource,"work-contributor":s.workContributor,"work-medium":s.workMedium,"orcid-link":s.orcidLink}[a]??String(a)},ni=t=>[{value:"any",label:nt(t,"any")},{value:"language",label:nt(t,"language")},{value:"word",label:nt(t,"word")},{value:"sentence",label:nt(t,"sentence")},{value:"topic",label:nt(t,"topic")},{value:"collection",label:nt(t,"collection")},{value:"person",label:nt(t,"person")},{value:"institution",label:nt(t,"institution")},{value:"collective",label:nt(t,"collective")},{value:"orcid",label:nt(t,"orcid")},{value:"address",label:nt(t,"address")},{value:"email",label:nt(t,"email")},{value:"phone",label:nt(t,"phone")},{value:"media",label:nt(t,"media")},{value:"work",label:nt(t,"work")},{value:"geo",label:nt(t,"geo")},{value:"music_piece",label:nt(t,"music_piece")},{value:"music_fragment",label:nt(t,"music_fragment")},{value:"source",label:nt(t,"source")},{value:"question",label:nt(t,"question")},{value:"citation",label:nt(t,"citation")},{value:"computed",label:nt(t,"computed")},{value:"vocab",label:nt(t,"vocab")},{value:"book",label:nt(t,"book")},{value:"word-language",label:nt(t,"word-language")},{value:"citation-language",label:nt(t,"citation-language")},{value:"language-sentence",label:nt(t,"language-sentence")},{value:"translation",label:nt(t,"translation")},{value:"word-topic",label:nt(t,"word-topic")},{value:"reference",label:nt(t,"reference")},{value:"source-resource",label:nt(t,"source-resource")},{value:"work-contributor",label:nt(t,"work-contributor")},{value:"work-medium",label:nt(t,"work-medium")},{value:"orcid-link",label:nt(t,"orcid-link")}],si=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Mn={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},ri={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Mn]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Mn]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId"]},filterFields:[Mn,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text"],connections:[{relationType:"citation-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"citationText",kind:"text",path:"text",matcher:"contains"}]},question:{infoType:"question",entityKind:"single",structure:{payloadFields:["definition"]},filterFields:[{key:"questionType",labelKey:"type",kind:"text",path:"definition.type",matcher:"contains"},{key:"questionText",labelKey:"text",kind:"text",path:"definition.question",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},gs={infoType:"default",entityKind:"single",structure:{payloadFields:["label"]},filterFields:[]};function ii(t){return t?ri[t]??gs:gs}function oi(t,a){return t.optionsSource==="languages"?a.languages.map(r=>({value:r.infoId,label:r.label})):t.optionsSource==="sourceKinds"?si:[]}const li="cogita.revision.seed:";function er(t){return`${li}${t}`}function ci(t,a){if(typeof window>"u")return null;const r=Array.from(new Set(a.map(o=>o.trim()).filter(Boolean)));if(!r.length)return null;const s=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,i={kind:"info-selection",libraryId:t,infoIds:r,createdAt:new Date().toISOString()};return window.localStorage.setItem(er(s),JSON.stringify(i)),s}function ms(t,a){if(typeof window>"u")return null;const r=window.localStorage.getItem(er(a));if(!r)return null;try{const s=JSON.parse(r);if(s.kind!=="info-selection"||s.libraryId!==t||!Array.isArray(s.infoIds))return null;const i=s.infoIds.map(o=>String(o??"").trim()).filter(Boolean);return i.length?{infoIds:i}:null}catch{return null}}const di="cogita.collection-draft:";function tr(t){return`${di}${t}`}function ui(t,a){if(typeof window>"u")return null;const r=Array.from(new Set(a.map(o=>o.trim()).filter(Boolean)));if(!r.length)return null;const s=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,i={kind:"info-selection",libraryId:t,infoIds:r,createdAt:new Date().toISOString()};return window.localStorage.setItem(tr(s),JSON.stringify(i)),s}function hi(t,a){if(typeof window>"u")return null;const r=window.localStorage.getItem(tr(a));if(!r)return null;try{const s=JSON.parse(r);if(s.kind!=="info-selection"||s.libraryId!==t||!Array.isArray(s.infoIds))return null;const i=s.infoIds.map(o=>String(o??"").trim()).filter(Boolean);return i.length?{infoIds:i}:null}catch{return null}}const Ln=60,gi=500;function ar(t){return`cogita.info-selection:${t}`}function ps(t){if(typeof window>"u")return{};const a=window.localStorage.getItem(ar(t));if(!a)return{};try{const r=JSON.parse(a);return!r||typeof r!="object"?{}:r}catch{return{}}}function mi({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,libraryId:d,mode:f}){var qt;const l=mn(),c=Ja(),j=t.cogita.library.list,[g,S]=n.useState("any"),[F,x]=n.useState(""),[y,de]=n.useState("relevance"),[B,p]=n.useState("details"),[Q,N]=n.useState(!1),[ee,q]=n.useState("idle"),[R,me]=n.useState([]),[K,Z]=n.useState(Ln),[Le,G]=n.useState(null),[L,A]=n.useState(()=>ps(d)),[z,W]=n.useState({}),[O,fe]=n.useState([]),[se,ne]=n.useState([]),[Ne,Ae]=n.useState(null),[Pe,Re]=n.useState(null),[et,ct]=n.useState(null),[Ce,We]=n.useState("idle"),[xt,Ve]=n.useState([]),[Be,tt]=n.useState(""),[ot,Ye]=n.useState(null),[Ie,ze]=n.useState("idle"),[Xe,E]=n.useState(null),[M,_]=n.useState(null),[P,k]=n.useState("idle"),[T,I]=n.useState([]),[he,xe]=n.useState("idle"),ge=n.useMemo(()=>ni(t),[t]),te=n.useMemo(()=>[{value:"relevance",label:j.sortRelevance},{value:"label_asc",label:j.sortLabelAsc},{value:"label_desc",label:j.sortLabelDesc},{value:"type_asc",label:j.sortTypeAsc},{value:"type_desc",label:j.sortTypeDesc}],[j.sortLabelAsc,j.sortLabelDesc,j.sortRelevance,j.sortTypeAsc,j.sortTypeDesc]);n.useEffect(()=>{A(ps(d)),W({}),N(!1)},[d]),n.useEffect(()=>{Yn({libraryId:d}).then(V=>ct(V)).catch(()=>ct({items:[]}))},[d]),n.useEffect(()=>{pr({libraryId:d}).then(V=>Ve(V)).catch(()=>Ve([]))},[d]),n.useEffect(()=>{In({libraryId:d,type:"language",filters:{sourceKind:"info"},limit:200}).then(V=>{const u=V.map(le=>({infoId:le.infoId??"",infoType:le.entityType,label:le.title})).filter(le=>le.infoId.length>0);fe(u)}).catch(()=>fe([]))},[d]),n.useEffect(()=>{In({libraryId:d,type:"source",filters:{sourceKind:"info"},limit:200}).then(V=>{const u=V.map(le=>({infoId:le.infoId??"",infoType:le.entityType,label:le.title})).filter(le=>le.infoId.length>0);ne(u)}).catch(()=>ne([]))},[d]),n.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(ar(d),JSON.stringify(L))},[d,L]);const $=n.useMemo(()=>ii(g==="any"?null:g),[g]),X=n.useMemo(()=>new URLSearchParams(c.search),[c.search]),ie=n.useMemo(()=>c.pathname.split("/").filter(Boolean),[c.pathname]),Y=ie.findIndex(V=>V==="infos"),ae=Y>=0&&(ie[Y+1]??"").trim()||null,ve=Y>=0?(ie[Y+2]??"").trim():"",U=Y>=0?ve==="checkcards"?"cards":ve==="collections"?"collections":"overview":"",oe=ae??((X.get("infoId")??"").trim()||null),$e=ae?U:(X.get("infoView")??"overview").trim(),qe=$e==="overview"&&!!oe,_e=$e==="collections"&&!!oe,Je=n.useMemo(()=>({language:j.typeFilterLanguage,languageA:j.typeFilterLanguageA,languageB:j.typeFilterLanguageB,originalLanguage:j.typeFilterOriginalLanguage,doi:j.typeFilterDoi,sourceKind:j.typeFilterSourceKind,locator:j.typeFilterLocator,citationText:j.typeFilterCitationText}),[j.typeFilterDoi,j.typeFilterLanguage,j.typeFilterLanguageA,j.typeFilterLanguageB,j.typeFilterLocator,j.typeFilterOriginalLanguage,j.typeFilterCitationText,j.typeFilterSourceKind]),bt=n.useMemo(()=>$.filterFields.map(V=>({...V,label:V.labelKey?Je[V.labelKey]:V.label??V.key,options:oi(V,{languages:O})})),[Je,O,$.filterFields]),mt=n.useMemo(()=>bt.some(V=>(z[V.key]??"").trim().length>0),[bt,z]);n.useEffect(()=>{W({})},[g]),n.useEffect(()=>{const V={sourceKind:"info"};if(mt)for(const H of bt){const Qe=(z[H.key]??"").trim();Qe&&(V[H.path??H.key]=Qe)}const u=(z.__referenceId??"").trim();u&&(V["link.references"]=u),q("loading");const le=window.setTimeout(()=>{In({libraryId:d,type:g==="any"?void 0:g,query:F.trim()||void 0,filters:V,limit:gi}).then(H=>{const Qe=H.map(rt=>({infoId:rt.infoId??"",infoType:rt.entityType,label:rt.title})).filter(rt=>rt.infoId.length>0);me(Qe),q("ready")}).catch(()=>{me([]),q("ready")})},240);return()=>window.clearTimeout(le)},[mt,d,F,g,bt,z]),n.useEffect(()=>{if(!oe||$e!=="overview"&&$e!=="collections"){Ae(null),Re(null),We("idle");return}let V=!1;return We("loading"),Promise.all([na({libraryId:d,infoId:oe}),fr({libraryId:d,itemType:"info",itemId:oe}).catch(()=>null)]).then(([u,le])=>{V||(Ae(u),Re(le),We("ready"))}).catch(()=>{V||(Ae(null),Re(null),We("error"))}),()=>{V=!0}},[d,oe,$e]),n.useEffect(()=>{if(!oe||$e!=="collections"){I([]),xe("idle");return}let V=!1;return xe("loading"),br({libraryId:d,infoId:oe}).then(u=>{V||(I(u),xe("ready"))}).catch(()=>{V||(I([]),xe("error"))}),()=>{V=!0}},[d,oe,$e]),n.useEffect(()=>{if(!oe||$e!=="overview"){E(null),_(null),k("idle");return}let V=!1;return k("loading"),Promise.all([tn({libraryId:d,infoId:oe}),an({libraryId:d,infoId:oe})]).then(([u,le])=>{V||(E(u),_(le),k("ready"))}).catch(()=>{V||(E(null),_(null),k("error"))}),()=>{V=!0}},[d,oe,$e]);const pt=n.useMemo(()=>Ne?xt.filter(V=>V.sourceInfoTypes.some(u=>u.toLowerCase()===Ne.infoType.toLowerCase())):[],[xt,Ne]);n.useEffect(()=>{if(!Ne){tt("");return}tt(V=>{var u;return V&&pt.some(le=>le.approachKey===V)?V:((u=pt[0])==null?void 0:u.approachKey)??""})},[pt,Ne]),n.useEffect(()=>{if(!Ne||!Be){Ye(null),ze("idle");return}let V=!1;return ze("loading"),Js({libraryId:d,infoId:Ne.infoId,approachKey:Be}).then(u=>{V||(Ye(u),ze("ready"))}).catch(()=>{V||(Ye(null),ze("error"))}),()=>{V=!0}},[d,Be,Ne]);const jt=n.useMemo(()=>{const V=R.slice(),u=le=>nt(t,le);return y==="relevance"?V:y==="label_asc"?V.sort((le,H)=>le.label.localeCompare(H.label)):y==="label_desc"?V.sort((le,H)=>H.label.localeCompare(le.label)):y==="type_asc"?V.sort((le,H)=>le.infoType===H.infoType?le.label.localeCompare(H.label):u(le.infoType).localeCompare(u(H.infoType))):V.sort((le,H)=>le.infoType===H.infoType?le.label.localeCompare(H.label):u(H.infoType).localeCompare(u(le.infoType)))},[t,R,y]),Ct=n.useMemo(()=>jt.slice(0,K),[jt,K]),Ot=Ct.length<jt.length,Et=n.useMemo(()=>new Set(Object.keys(L)),[L]),Nt=n.useMemo(()=>Object.values(L),[L]),ua=n.useMemo(()=>{const V=new Map;for(const u of Nt)V.set(u.infoType,(V.get(u.infoType)??0)+1);return Array.from(V.entries()).sort((u,le)=>le[1]-u[1]||u[0].localeCompare(le[0]))},[Nt]),Lt=n.useMemo(()=>{if(!oe||!et)return 0;const V=new Set;for(const u of et.items)u.childItemType!=="info"||u.childItemId!==oe||V.add([u.parentItemType,u.parentItemId,u.parentCheckType??"",u.parentDirection??""].join("|"));return V.size},[et,oe]);n.useEffect(()=>{Z(Ln);const V=new Set(R.map(u=>u.infoId));G(u=>u&&V.has(u)?u:null)},[R]);const vt=V=>{A(u=>({...u,[V.infoId]:{infoId:V.infoId,infoType:V.infoType,label:V.label}}))},St=V=>{A(u=>{if(!u[V])return u;const le={...u};return delete le[V],le})},kt=(V,u)=>{if(u){vt(V);return}St(V.infoId)},yt=V=>{l(`/cogita/library/${d}/infos/${encodeURIComponent(V)}`,{replace:!0})},Kt=()=>{l(`/cogita/library/${d}/list`,{replace:!0})},st=()=>{oe&&l(`/cogita/library/${d}/edit/${encodeURIComponent(oe)}`,{replace:!0})},Ue=()=>{const V=ci(d,Nt.map(u=>u.infoId));V&&l(`/cogita/library/${d}/revision/run?libraryTarget=revisions&scope=info-selection&seed=${encodeURIComponent(V)}`)},ft=()=>{const V=ui(d,Nt.map(u=>u.infoId));V&&l(`/cogita/library/${d}/collections/new?draft=${encodeURIComponent(V)}&draftType=info-selection`)},Qt=Nt.length===1?((qt=Nt[0])==null?void 0:qt.infoId)??null:null,Vt=j.selectionCount.replace("{count}",String(Nt.length)),Bt=f==="collection"?"grid":f==="detail"?"wide":B,pe=fi(m),$t=Pe?Math.max(0,Math.min(100,Math.round((Pe.score??0)*100))):0,Xt=Pe?bi(Pe,pe):pe.noKnownnessData;return e.jsx(Pt,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":Bt,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[qe?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:pe.kicker}),e.jsx("h2",{className:"cogita-card-title",children:Ne?fs(Ne.payload,Ne.infoType,Ne.infoId):pe.loading}),Ne?e.jsxs("p",{className:"cogita-card-subtitle",children:[nt(t,Ne.infoType)," · ",Ne.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:Kt,children:pe.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:st,disabled:!oe||Ce!=="ready",children:j.editInfo})]})]}),Ce==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:pe.loading})}):Ce==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:pe.loadError})}):Ne?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:pe.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[$t,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${$t}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:Xt})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:pe.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(Pe==null?void 0:Pe.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:pe.correct.replace("{correct}",String((Pe==null?void 0:Pe.correctReviews)??0)).replace("{total}",String((Pe==null?void 0:Pe.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:Pe!=null&&Pe.lastReviewedUtc?`${pe.lastReview}: ${pi(Pe.lastReviewedUtc,m)}`:pe.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:pe.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:Lt}),e.jsx("p",{className:"cogita-library-hint",children:pe.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:pe.checkcards}),P==="loading"?e.jsx("p",{className:"cogita-library-hint",children:pe.loadingCheckcards}):P==="error"?e.jsx("p",{className:"cogita-library-hint",children:pe.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:pe.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(Xe==null?void 0:Xe.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:pe.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(M==null?void 0:M.items.length)??0})]})]})]}),pt.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:pe.approach}),e.jsx("select",{value:Be,onChange:V=>tt(V.target.value),"aria-label":pe.approach,children:pt.map(V=>e.jsx("option",{value:V.approachKey,children:V.label},V.approachKey))})]}),Ie==="loading"?e.jsx("p",{className:"cogita-library-hint",children:pe.loadingApproach}):Ie==="error"?e.jsx("p",{className:"cogita-library-hint",children:pe.loadApproachError}):ot?e.jsx(nn,{value:ot.projection,emptyLabel:pe.empty}):e.jsx("p",{className:"cogita-library-hint",children:pe.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:pe.payload}),e.jsx(nn,{value:Ne.payload,emptyLabel:pe.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:pe.links}),e.jsx(yi,{links:Ne.links,emptyLabel:pe.noLinks})]})]})]}):null]})}):null,_e?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Informacja"}),e.jsx("h2",{className:"cogita-card-title",children:Ne?fs(Ne.payload,Ne.infoType,Ne.infoId):oe??""}),e.jsx("p",{className:"cogita-card-subtitle",children:"Collections using this info"})]}),e.jsx("div",{className:"cogita-info-overview-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:Kt,children:"Back to search"})})]}),he==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading collections..."})}):null,he==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load collections."})}):null,he==="ready"&&T.length===0?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"This info is not used in any collection yet."})}):null,he==="ready"&&T.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:T.map(V=>e.jsx("article",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`/#/cogita/library/${d}/collections/${V.collectionId}?libraryTarget=collections`,children:[e.jsx("div",{className:"cogita-card-type",children:"Collection"}),e.jsx("h3",{className:"cogita-card-title",children:V.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[V.itemCount," items"]})]})},V.collectionId))}):null]})}):null,!qe&&!_e?e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":j.typeLabel,value:g,onChange:V=>S(V.target.value),children:ge.map(V=>e.jsx("option",{value:V.value,children:V.label},V.value))}),e.jsx("input",{type:"text",value:F,onChange:V=>x(V.target.value),placeholder:j.searchPlaceholder}),e.jsx("select",{"aria-label":j.sortLabel,value:y,onChange:V=>de(V.target.value),children:te.map(V=>e.jsx("option",{value:V.value,children:V.label},V.value))}),e.jsxs("select",{"aria-label":j.viewLabel,value:B,onChange:V=>p(V.target.value),children:[e.jsx("option",{value:"details",children:j.viewDetails}),e.jsx("option",{value:"wide",children:j.viewWide}),e.jsx("option",{value:"grid",children:j.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:j.cardCount.replace("{shown}",String(Ct.length)).replace("{total}",String(jt.length))}),e.jsx("span",{children:ee==="loading"?j.loading:j.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>N(V=>!V),children:Q?j.hideFilters:j.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:j.filtersOptionalHint})]}),Q?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsxs("div",{className:"cogita-filter-grid",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:j.typeLabel}),e.jsx("select",{value:g,onChange:V=>S(V.target.value),children:ge.map(V=>e.jsx("option",{value:V.value,children:V.label},`advanced-type:${V.value}`))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Reference"}),e.jsxs("select",{value:z.__referenceId??"",onChange:V=>W(u=>({...u,__referenceId:V.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),se.map(V=>e.jsx("option",{value:V.infoId,children:V.label},`reference:${V.infoId}`))]})]}),bt.map(V=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:V.label}),V.kind==="select"?e.jsxs("select",{value:z[V.key]??"",onChange:u=>W(le=>({...le,[V.key]:u.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(V.options??[]).map(u=>e.jsx("option",{value:u.value,children:u.label},`${V.key}:${u.value}`))]}):e.jsx("input",{type:"text",value:z[V.key]??"",onChange:u=>W(le=>({...le,[V.key]:u.target.value}))})]},`type-filter:${V.key}`))]})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:Vt}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{A(V=>{const u={...V};for(const le of Ct)u[le.infoId]={infoId:le.infoId,infoType:le.infoType,label:le.label};return u})},disabled:Ct.length===0,children:j.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>A({}),disabled:Nt.length===0,children:j.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Qt&&yt(Qt),disabled:!Qt,title:Qt?void 0:j.openSelectedDisabled,children:j.openSelected})]})]}),Bt==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":j.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:j.detailColumnName}),e.jsx("span",{children:j.detailColumnType}),e.jsx("span",{children:j.detailColumnId}),e.jsx("span",{})]}),Ct.length?Ct.map(V=>{const u=nt(t,V.infoType),le=Et.has(V.infoId),H=Le===V.infoId;return e.jsxs("div",{className:`cogita-details-row ${H||le?"active":""}`,role:"row",onClick:()=>G(V.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:le,onChange:Qe=>kt(V,Qe.target.checked),onClick:Qe=>Qe.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:V.label,children:V.label}),e.jsx("span",{title:u,children:u}),e.jsx("span",{title:V.infoId,children:V.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:Qe=>{Qe.stopPropagation(),yt(V.infoId)},"aria-label":j.editInfo,children:">"})]},V.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:j.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${Bt}`,"data-view":Bt,children:Ct.length?Ct.map(V=>{const u=nt(t,V.infoType),le=Et.has(V.infoId),H=Le===V.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":H||le,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:le,onChange:Qe=>kt(V,Qe.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>G(V.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:u}),e.jsx("h3",{className:"cogita-card-title",children:V.label}),e.jsx("p",{className:"cogita-card-subtitle",children:V.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>yt(V.infoId),children:j.editInfo})]})},V.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:j.noMatch})})}),Ot?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>Z(V=>V+Ln),children:j.loadMore})}):null,Nt.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:j.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:j.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:ua.map(([V,u])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:nt(t,V)}),e.jsx("span",{className:"cogita-tag-count",children:u})]},`stack:type:${V}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:Ue,disabled:Nt.length===0,children:"Start revision"}),e.jsx("button",{type:"button",className:"ghost",onClick:ft,disabled:Nt.length===0,children:"Create collection from selection"})]})]}):null]}):null]})})})})}function fs(t,a,r){if(t&&typeof t=="object"&&!Array.isArray(t)){const s=t,i=["title","name","label","value","text","quote","term"];for(const o of i){const h=s[o];if(typeof h=="string"&&h.trim())return h.trim()}}return`${a} · ${r}`}function pi(t,a){try{const r=a==="pl"?"pl-PL":a==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(r,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function fi(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function bi(t,a){return t.totalReviews<=0?a.noKnownnessData:t.totalReviews<3||t.score<.35?a.developmentStart:t.totalReviews<8||t.score<.65?a.developmentGrowing:t.score<.85?a.developmentStable:a.developmentStrong}function yi({links:t,emptyLabel:a}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:a}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([r,s])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(s)?s.length?e.jsx("div",{className:"cogita-selection-overview",children:s.map(i=>e.jsx("span",{className:"cogita-tag-chip",children:i},`${r}:${i}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):s?e.jsx("span",{className:"cogita-tag-chip",children:s}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},r))})}function nn({value:t,emptyLabel:a}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:a});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((r,s)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(nn,{value:r,emptyLabel:a})})]},s))});if(typeof t=="object"){const r=Object.entries(t);return r.length===0?e.jsx("p",{className:"cogita-library-hint",children:a}):e.jsx("div",{className:"cogita-info-tree",children:r.map(([s,i])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(nn,{value:i,emptyLabel:a})})]},s))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const Na=5,bs=50,ys=2,xs=[];function Yt({libraryId:t,infoType:a,label:r,placeholder:s,value:i,onChange:o,values:h,onChangeMultiple:v,helperText:m,searchFailedText:w,createFailedText:d,createLabel:f,savingLabel:l,loadMoreLabel:c,allowCreate:j=!0,inputRef:g,autoAdvance:S,onCommit:F,multiple:x}){const y=x?h??xs:xs,[de,B]=n.useState(x?"":(i==null?void 0:i.label)??""),[p,Q]=n.useState([]),[N,ee]=n.useState(Na),[q,R]=n.useState(-1),[me,K]=n.useState(!1),[Z,Le]=n.useState(!1),[G,L]=n.useState(null),A=n.useRef(0),z=n.useRef(new Map),W=n.useMemo(()=>j?x?de.trim().length>0:de.trim().length>0&&!i:!1,[j,de,i,x]);n.useEffect(()=>{x||B((i==null?void 0:i.label)??"")},[i,x]),n.useEffect(()=>{const se=de.trim();if(!se||se.length<ys){Q([]),K(!1),ee(Na),R(-1),Le(!1),L(null);return}const ne=se.toLowerCase(),Ne=`${t}:${a}:${ne}`,Ae=z.current.get(Ne);if(Ae){if(x&&y.length>0){const Re=new Set(y.map(et=>et.id));Q(Ae.filter(et=>!Re.has(et.id)))}else Q(Ae);ee(Na),R(-1),K(Ae.length>0),Le(!1),L(null);return}const Pe=window.setTimeout(async()=>{const Re=Date.now();A.current=Re,Le(!0),L(null);try{const et=await Xn({libraryId:t,type:a,query:se,limit:bs});if(A.current!==Re)return;const ct=et.slice(0,bs).map(Ce=>({id:Ce.infoId,label:Ce.label,infoType:Ce.infoType}));if(z.current.set(Ne,ct),x&&y.length>0){const Ce=new Set(y.map(We=>We.id));Q(ct.filter(We=>!Ce.has(We.id)))}else Q(ct);ee(Na),R(-1),K(!0)}catch{if(A.current!==Re)return;L(w??"Search failed.")}finally{A.current===Re&&Le(!1)}},250);return()=>window.clearTimeout(Pe)},[t,a,de,y]);const O=se=>{if(x){const ne=y.some(Ne=>Ne.id===se.id)?y:[...y,se];v==null||v(ne),B(""),K(!1),R(-1);return}o==null||o(se),B(se.label),K(!1),R(-1),S&&(F==null||F())},fe=async()=>{const se=de.trim();if(se){Le(!0),L(null);try{const ne=await qn({libraryId:t,infoType:a,payload:{label:se}}),Ne={id:ne.infoId,label:se,infoType:ne.infoType};if(se.length>=ys){const Ae=`${t}:${a}:${se.toLowerCase()}`,Pe=z.current.get(Ae)??[];z.current.set(Ae,[Ne,...Pe])}if(x){v==null||v([...y,Ne]),B(""),K(!1),R(-1);return}o==null||o(Ne),K(!1),R(-1),S&&(F==null||F())}catch{L(d??"Create failed.")}finally{Le(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:r}),e.jsx("input",{value:de,placeholder:s,onChange:se=>{B(se.target.value),!x&&i&&(o==null||o(null))},onKeyDown:se=>{if(se.key==="ArrowDown"){if(se.preventDefault(),!p.length)return;K(!0),R(ne=>{const Ne=Math.min(p.length,N)-1,Ae=ne<0?0:Math.min(ne+1,Ne);return Ae===Ne&&p.length>N?(ee(Pe=>Math.min(Pe+Na,p.length)),Math.min(ne+1,Math.min(p.length,N+Na)-1)):Ae});return}if(se.key==="ArrowUp"){if(se.preventDefault(),!p.length)return;K(!0),R(ne=>ne<=0?0:ne-1);return}if(se.key==="Enter"){if(se.preventDefault(),q>=0&&p[q]){O(p[q]);return}if(W){fe();return}}},onFocus:()=>{p.length>0&&K(!0)},autoComplete:"off",ref:g})]}),x&&y.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:y.map(se=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>v==null?void 0:v(y.filter(ne=>ne.id!==se.id)),children:[se.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},se.id))}),m&&e.jsx("p",{className:"cogita-help",children:m}),G&&e.jsx("p",{className:"cogita-error",children:G}),me&&p.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[p.slice(0,N).map((se,ne)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":ne===q,onClick:()=>O(se),children:[e.jsx("strong",{children:se.label}),e.jsx("span",{children:se.infoType})]},se.id)),N<p.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>ee(se=>Math.min(se+Na,p.length)),children:c??"Load more"})]}),W&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:fe,disabled:Z,children:Z?l??"Saving...":f??`Create new ${a}`})]})}const vs=[{id:"gen",la:{abbr:"Gen",name:"Genesis"},en:{abbr:"Gen",name:"Genesis"},de:{abbr:"Gen",name:"Genesis"},pl:{abbr:"Rdz",name:"Księga Rodzaju"}},{id:"ex",la:{abbr:"Ex",name:"Exodus"},en:{abbr:"Ex",name:"Exodus"},de:{abbr:"Ex",name:"Exodus"},pl:{abbr:"Wj",name:"Księga Wyjścia"}},{id:"lev",la:{abbr:"Lev",name:"Leviticus"},en:{abbr:"Lev",name:"Leviticus"},de:{abbr:"Lev",name:"Levitikus"},pl:{abbr:"Kpł",name:"Księga Kapłańska"}},{id:"num",la:{abbr:"Num",name:"Numeri"},en:{abbr:"Num",name:"Numbers"},de:{abbr:"Num",name:"Numeri"},pl:{abbr:"Lb",name:"Księga Liczb"}},{id:"deut",la:{abbr:"Deut",name:"Deuteronomium"},en:{abbr:"Deut",name:"Deuteronomy"},de:{abbr:"Dtn",name:"Deuteronomium"},pl:{abbr:"Pwt",name:"Księga Powtórzonego Prawa"}},{id:"ios",la:{abbr:"Ios",name:"Iosue"},en:{abbr:"Josh",name:"Joshua"},de:{abbr:"Jos",name:"Josua"},pl:{abbr:"Joz",name:"Księga Jozuego"}},{id:"iudg",la:{abbr:"Iudg",name:"Iudicum"},en:{abbr:"Judg",name:"Judges"},de:{abbr:"Ri",name:"Richter"},pl:{abbr:"Sdz",name:"Księga Sędziów"}},{id:"ruth",la:{abbr:"Ruth",name:"Ruth"},en:{abbr:"Ruth",name:"Ruth"},de:{abbr:"Rut",name:"Rut"},pl:{abbr:"Rt",name:"Księga Rut"}},{id:"1sam",la:{abbr:"1 Sam",name:"I Samuelis"},en:{abbr:"1 Sam",name:"1 Samuel"},de:{abbr:"1 Sam",name:"1 Samuel"},pl:{abbr:"1 Sm",name:"1 Księga Samuela"}},{id:"2sam",la:{abbr:"2 Sam",name:"II Samuelis"},en:{abbr:"2 Sam",name:"2 Samuel"},de:{abbr:"2 Sam",name:"2 Samuel"},pl:{abbr:"2 Sm",name:"2 Księga Samuela"}},{id:"1reg",la:{abbr:"1 Reg",name:"I Regum"},en:{abbr:"1 Kgs",name:"1 Kings"},de:{abbr:"1 Kön",name:"1 Könige"},pl:{abbr:"1 Krl",name:"1 Księga Królewska"}},{id:"2reg",la:{abbr:"2 Reg",name:"II Regum"},en:{abbr:"2 Kgs",name:"2 Kings"},de:{abbr:"2 Kön",name:"2 Könige"},pl:{abbr:"2 Krl",name:"2 Księga Królewska"}},{id:"1par",la:{abbr:"1 Par",name:"I Paralipomenon"},en:{abbr:"1 Chr",name:"1 Chronicles"},de:{abbr:"1 Chr",name:"1 Chronik"},pl:{abbr:"1 Krn",name:"1 Księga Kronik"}},{id:"2par",la:{abbr:"2 Par",name:"II Paralipomenon"},en:{abbr:"2 Chr",name:"2 Chronicles"},de:{abbr:"2 Chr",name:"2 Chronik"},pl:{abbr:"2 Krn",name:"2 Księga Kronik"}},{id:"esd",la:{abbr:"Esd",name:"Esdrae"},en:{abbr:"Ezra",name:"Ezra"},de:{abbr:"Esra",name:"Esra"},pl:{abbr:"Ezd",name:"Księga Ezdrasza"}},{id:"neh",la:{abbr:"Neh",name:"Nehemiae"},en:{abbr:"Neh",name:"Nehemiah"},de:{abbr:"Neh",name:"Nehemia"},pl:{abbr:"Ne",name:"Księga Nehemiasza"}},{id:"tob",la:{abbr:"Tob",name:"Tobiae"},en:{abbr:"Tob",name:"Tobit"},de:{abbr:"Tob",name:"Tobit"},pl:{abbr:"Tb",name:"Księga Tobiasza"}},{id:"iudt",la:{abbr:"Iudt",name:"Iudith"},en:{abbr:"Jdt",name:"Judith"},de:{abbr:"Jdt",name:"Judit"},pl:{abbr:"Jdt",name:"Księga Judyty"}},{id:"est",la:{abbr:"Est",name:"Esther"},en:{abbr:"Est",name:"Esther"},de:{abbr:"Est",name:"Ester"},pl:{abbr:"Est",name:"Księga Estery"}},{id:"1macc",la:{abbr:"1 Macc",name:"I Maccabaeorum"},en:{abbr:"1 Mc",name:"1 Maccabees"},de:{abbr:"1 Makk",name:"1 Makkabäer"},pl:{abbr:"1 Mch",name:"1 Księga Machabejska"}},{id:"2macc",la:{abbr:"2 Macc",name:"II Maccabaeorum"},en:{abbr:"2 Mc",name:"2 Maccabees"},de:{abbr:"2 Makk",name:"2 Makkabäer"},pl:{abbr:"2 Mch",name:"2 Księga Machabejska"}},{id:"iob",la:{abbr:"Iob",name:"Iob"},en:{abbr:"Job",name:"Job"},de:{abbr:"Ijob",name:"Ijob"},pl:{abbr:"Hi",name:"Księga Hioba"}},{id:"ps",la:{abbr:"Ps",name:"Psalmi"},en:{abbr:"Ps",name:"Psalms"},de:{abbr:"Ps",name:"Psalmen"},pl:{abbr:"Ps",name:"Księga Psalmów"}},{id:"prov",la:{abbr:"Prov",name:"Proverbia"},en:{abbr:"Prov",name:"Proverbs"},de:{abbr:"Spr",name:"Sprichwörter"},pl:{abbr:"Prz",name:"Księga Przysłów"}},{id:"ecc",la:{abbr:"Ecc",name:"Ecclesiastes"},en:{abbr:"Eccl",name:"Ecclesiastes"},de:{abbr:"Koh",name:"Kohelet"},pl:{abbr:"Koh",name:"Księga Koheleta"}},{id:"cant",la:{abbr:"Cant",name:"Canticum Canticorum"},en:{abbr:"Song",name:"Song of Songs"},de:{abbr:"Hld",name:"Hoheslied"},pl:{abbr:"Pnp",name:"Pieśń nad Pieśniami"}},{id:"sap",la:{abbr:"Sap",name:"Sapientia"},en:{abbr:"Wis",name:"Wisdom"},de:{abbr:"Weish",name:"Weisheit"},pl:{abbr:"Mdr",name:"Księga Mądrości"}},{id:"sir",la:{abbr:"Sir",name:"Ecclesiasticus (Sirach)"},en:{abbr:"Sir",name:"Sirach"},de:{abbr:"Sir",name:"Jesus Sirach"},pl:{abbr:"Syr",name:"Mądrość Syracha"}},{id:"isa",la:{abbr:"Isa",name:"Isaias"},en:{abbr:"Isa",name:"Isaiah"},de:{abbr:"Jes",name:"Jesaja"},pl:{abbr:"Iz",name:"Księga Izajasza"}},{id:"ier",la:{abbr:"Ier",name:"Ieremias"},en:{abbr:"Jer",name:"Jeremiah"},de:{abbr:"Jer",name:"Jeremia"},pl:{abbr:"Jr",name:"Księga Jeremiasza"}},{id:"lam",la:{abbr:"Lam",name:"Lamentationes"},en:{abbr:"Lam",name:"Lamentations"},de:{abbr:"Klgl",name:"Klagelieder"},pl:{abbr:"Lm",name:"Lamentacje"}},{id:"bar",la:{abbr:"Bar",name:"Baruch"},en:{abbr:"Bar",name:"Baruch"},de:{abbr:"Bar",name:"Baruch"},pl:{abbr:"Ba",name:"Księga Barucha"}},{id:"ez",la:{abbr:"Ez",name:"Ezechiel"},en:{abbr:"Ezek",name:"Ezekiel"},de:{abbr:"Ez",name:"Ezechiel"},pl:{abbr:"Ez",name:"Księga Ezechiela"}},{id:"dan",la:{abbr:"Dan",name:"Daniel"},en:{abbr:"Dan",name:"Daniel"},de:{abbr:"Dan",name:"Daniel"},pl:{abbr:"Dn",name:"Księga Daniela"}},{id:"hos",la:{abbr:"Hos",name:"Osee"},en:{abbr:"Hos",name:"Hosea"},de:{abbr:"Hos",name:"Hosea"},pl:{abbr:"Oz",name:"Księga Ozeasza"}},{id:"ioel",la:{abbr:"Ioel",name:"Ioel"},en:{abbr:"Joel",name:"Joel"},de:{abbr:"Joel",name:"Joel"},pl:{abbr:"Jl",name:"Księga Joela"}},{id:"amos",la:{abbr:"Amos",name:"Amos"},en:{abbr:"Am",name:"Amos"},de:{abbr:"Am",name:"Amos"},pl:{abbr:"Am",name:"Księga Amosa"}},{id:"abd",la:{abbr:"Abd",name:"Abdias"},en:{abbr:"Obad",name:"Obadiah"},de:{abbr:"Obd",name:"Obadja"},pl:{abbr:"Abd",name:"Księga Abdiasza"}},{id:"ion",la:{abbr:"Ion",name:"Ionas"},en:{abbr:"Jon",name:"Jonah"},de:{abbr:"Jona",name:"Jona"},pl:{abbr:"Jon",name:"Księga Jonasza"}},{id:"mich",la:{abbr:"Mich",name:"Michaeas"},en:{abbr:"Mic",name:"Micah"},de:{abbr:"Mi",name:"Micha"},pl:{abbr:"Mi",name:"Księga Micheasza"}},{id:"nah",la:{abbr:"Nah",name:"Nahum"},en:{abbr:"Nah",name:"Nahum"},de:{abbr:"Nah",name:"Nahum"},pl:{abbr:"Na",name:"Księga Nahuma"}},{id:"hab",la:{abbr:"Hab",name:"Habacuc"},en:{abbr:"Hab",name:"Habakkuk"},de:{abbr:"Hab",name:"Habakuk"},pl:{abbr:"Ha",name:"Księga Habakuka"}},{id:"soph",la:{abbr:"Soph",name:"Sophonias"},en:{abbr:"Zeph",name:"Zephaniah"},de:{abbr:"Zef",name:"Zefanja"},pl:{abbr:"So",name:"Księga Sofoniasza"}},{id:"agg",la:{abbr:"Agg",name:"Aggaeus"},en:{abbr:"Hag",name:"Haggai"},de:{abbr:"Hag",name:"Haggai"},pl:{abbr:"Ag",name:"Księga Aggeusza"}},{id:"zach",la:{abbr:"Zach",name:"Zacharias"},en:{abbr:"Zech",name:"Zechariah"},de:{abbr:"Sach",name:"Sacharja"},pl:{abbr:"Za",name:"Księga Zachariasza"}},{id:"mal",la:{abbr:"Mal",name:"Malachias"},en:{abbr:"Mal",name:"Malachi"},de:{abbr:"Mal",name:"Maleachi"},pl:{abbr:"Ml",name:"Księga Malachiasza"}},{id:"mt",la:{abbr:"Mt",name:"Matthaeus"},en:{abbr:"Matt",name:"Matthew"},de:{abbr:"Mt",name:"Matthäus"},pl:{abbr:"Mt",name:"Ewangelia wg św. Mateusza"}},{id:"mc",la:{abbr:"Mc",name:"Marcus"},en:{abbr:"Mark",name:"Mark"},de:{abbr:"Mk",name:"Markus"},pl:{abbr:"Mk",name:"Ewangelia wg św. Marka"}},{id:"lc",la:{abbr:"Lc",name:"Lucas"},en:{abbr:"Luke",name:"Luke"},de:{abbr:"Lk",name:"Lukas"},pl:{abbr:"Łk",name:"Ewangelia wg św. Łukasza"}},{id:"io",la:{abbr:"Io",name:"Ioannes"},en:{abbr:"John",name:"John"},de:{abbr:"Joh",name:"Johannes"},pl:{abbr:"J",name:"Ewangelia wg św. Jana"}},{id:"act",la:{abbr:"Act",name:"Actus Apostolorum"},en:{abbr:"Acts",name:"Acts"},de:{abbr:"Apg",name:"Apostelgeschichte"},pl:{abbr:"Dz",name:"Dzieje Apostolskie"}},{id:"rom",la:{abbr:"Rom",name:"ad Romanos"},en:{abbr:"Rom",name:"Romans"},de:{abbr:"Röm",name:"Römer"},pl:{abbr:"Rz",name:"List do Rzymian"}},{id:"1cor",la:{abbr:"1 Cor",name:"I ad Corinthios"},en:{abbr:"1 Cor",name:"1 Corinthians"},de:{abbr:"1 Kor",name:"1 Korinther"},pl:{abbr:"1 Kor",name:"1 List do Koryntian"}},{id:"2cor",la:{abbr:"2 Cor",name:"II ad Corinthios"},en:{abbr:"2 Cor",name:"2 Corinthians"},de:{abbr:"2 Kor",name:"2 Korinther"},pl:{abbr:"2 Kor",name:"2 List do Koryntian"}},{id:"gal",la:{abbr:"Gal",name:"ad Galatas"},en:{abbr:"Gal",name:"Galatians"},de:{abbr:"Gal",name:"Galater"},pl:{abbr:"Ga",name:"List do Galatów"}},{id:"eph",la:{abbr:"Eph",name:"ad Ephesios"},en:{abbr:"Eph",name:"Ephesians"},de:{abbr:"Eph",name:"Epheser"},pl:{abbr:"Ef",name:"List do Efezjan"}},{id:"phil",la:{abbr:"Phil",name:"ad Philippenses"},en:{abbr:"Phil",name:"Philippians"},de:{abbr:"Phil",name:"Philipper"},pl:{abbr:"Flp",name:"List do Filipian"}},{id:"col",la:{abbr:"Col",name:"ad Colossenses"},en:{abbr:"Col",name:"Colossians"},de:{abbr:"Kol",name:"Kolosser"},pl:{abbr:"Kol",name:"List do Kolosan"}},{id:"1thess",la:{abbr:"1 Thess",name:"I ad Thessalonicenses"},en:{abbr:"1 Thess",name:"1 Thessalonians"},de:{abbr:"1 Thess",name:"1 Thessalonicher"},pl:{abbr:"1 Tes",name:"1 List do Tesaloniczan"}},{id:"2thess",la:{abbr:"2 Thess",name:"II ad Thessalonicenses"},en:{abbr:"2 Thess",name:"2 Thessalonians"},de:{abbr:"2 Thess",name:"2 Thessalonicher"},pl:{abbr:"2 Tes",name:"2 List do Tesaloniczan"}},{id:"1tim",la:{abbr:"1 Tim",name:"I ad Timotheum"},en:{abbr:"1 Tim",name:"1 Timothy"},de:{abbr:"1 Tim",name:"1 Timotheus"},pl:{abbr:"1 Tm",name:"1 List do Tymoteusza"}},{id:"2tim",la:{abbr:"2 Tim",name:"II ad Timotheum"},en:{abbr:"2 Tim",name:"2 Timothy"},de:{abbr:"2 Tim",name:"2 Timotheus"},pl:{abbr:"2 Tm",name:"2 List do Tymoteusza"}},{id:"tit",la:{abbr:"Tit",name:"ad Titum"},en:{abbr:"Titus",name:"Titus"},de:{abbr:"Tit",name:"Titus"},pl:{abbr:"Tt",name:"List do Tytusa"}},{id:"phlm",la:{abbr:"Phlm",name:"ad Philemonem"},en:{abbr:"Phlm",name:"Philemon"},de:{abbr:"Phlm",name:"Philemon"},pl:{abbr:"Flm",name:"List do Filemona"}},{id:"heb",la:{abbr:"Heb",name:"ad Hebraeos"},en:{abbr:"Heb",name:"Hebrews"},de:{abbr:"Hebr",name:"Hebräer"},pl:{abbr:"Hbr",name:"List do Hebrajczyków"}},{id:"iac",la:{abbr:"Iac",name:"Iacobi"},en:{abbr:"Jas",name:"James"},de:{abbr:"Jak",name:"Jakobus"},pl:{abbr:"Jk",name:"List św. Jakuba"}},{id:"1pet",la:{abbr:"1 Pet",name:"I Petri"},en:{abbr:"1 Pet",name:"1 Peter"},de:{abbr:"1 Petr",name:"1 Petrus"},pl:{abbr:"1 P",name:"1 List św. Piotra"}},{id:"2pet",la:{abbr:"2 Pet",name:"II Petri"},en:{abbr:"2 Pet",name:"2 Peter"},de:{abbr:"2 Petr",name:"2 Petrus"},pl:{abbr:"2 P",name:"2 List św. Piotra"}},{id:"1io",la:{abbr:"1 Io",name:"I Ioannis"},en:{abbr:"1 John",name:"1 John"},de:{abbr:"1 Joh",name:"1 Johannes"},pl:{abbr:"1 J",name:"1 List św. Jana"}},{id:"2io",la:{abbr:"2 Io",name:"II Ioannis"},en:{abbr:"2 John",name:"2 John"},de:{abbr:"2 Joh",name:"2 Johannes"},pl:{abbr:"2 J",name:"2 List św. Jana"}},{id:"3io",la:{abbr:"3 Io",name:"III Ioannis"},en:{abbr:"3 John",name:"3 John"},de:{abbr:"3 Joh",name:"3 Johannes"},pl:{abbr:"3 J",name:"3 List św. Jana"}},{id:"iud",la:{abbr:"Iud",name:"Iudae"},en:{abbr:"Jude",name:"Jude"},de:{abbr:"Jud",name:"Judas"},pl:{abbr:"Jud",name:"List św. Judy"}},{id:"apoc",la:{abbr:"Apoc",name:"Apocalypsis Ioannis"},en:{abbr:"Rev",name:"Revelation"},de:{abbr:"Offb",name:"Offenbarung"},pl:{abbr:"Ap",name:"Apokalipsa św. Jana"}}],ws=8;function js({libraryId:t,copy:a,language:r,sourceKindOptions:s,value:i,onChange:o,labels:h}){const[v,m]=n.useState(!1),[w,d]=n.useState(-1),f=n.useMemo(()=>{const g=r;return vs.map(S=>{var y;const F=(S==null?void 0:S[g])??(S==null?void 0:S.en)??(S==null?void 0:S.la);return{label:`${F.abbr} — ${F.name}`,latin:((y=S==null?void 0:S.la)==null?void 0:y.abbr)??F.abbr}})},[r]),l=(g,S=!1)=>{const F=g.trim().toLowerCase();return F?f.filter(x=>x.label.toLowerCase().includes(F)).slice(0,ws):S?f.slice(0,ws):[]},c=(g,S)=>{const F=g.trim().toLowerCase();if(!F)return null;const x=vs;for(const y of x){const de=y==null?void 0:y.la,B=(y==null?void 0:y[S])??(y==null?void 0:y.en)??de,p=(B==null?void 0:B.abbr)??"",Q=(B==null?void 0:B.name)??"";if(p.toLowerCase()===F||Q.toLowerCase()===F||`${p} — ${Q}`.toLowerCase()===F)return{book:y,entry:B,la:de}}return null};n.useEffect(()=>{if(i.sourceKind==="bible"&&i.locatorValue&&!v){const g=c(i.locatorValue,r);if(g){const S=`${g.entry.abbr} — ${g.entry.name}`;S!==i.bibleBookDisplay&&o({...i,bibleBookDisplay:S})}}},[r,i,v,o]);const j=g=>o({...i,...g});return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.sourceKindLabel}),e.jsx("select",{value:i.sourceKind,onChange:g=>j({sourceKind:g.target.value,churchDocument:null,bookMedia:null,work:null,locatorValue:"",locatorAux:"",bibleBookDisplay:""}),children:s.map(g=>e.jsx("option",{value:g.value,children:g.label},g.value))})]}),i.sourceKind==="bible"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-lookup full",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.bibleBookLabel}),e.jsx("input",{type:"text",value:i.bibleBookDisplay,onChange:g=>{const S=g.target.value;j({bibleBookDisplay:S,locatorValue:""}),m(!0),d(-1)},onKeyDown:g=>{var F;const S=l(i.bibleBookDisplay);if(S.length){if(g.key==="ArrowDown")g.preventDefault(),d(x=>Math.min(x+1,S.length-1));else if(g.key==="ArrowUp")g.preventDefault(),d(x=>Math.max(x-1,0));else if((g.key==="Enter"||g.key==="Tab")&&w>=0&&S[w]){const x=S[w],y=c(x.label,r);if(!y)return;j({bibleBookDisplay:x.label,locatorValue:((F=y.la)==null?void 0:F.abbr)??i.locatorValue}),m(!1)}}},onFocus:()=>m(!0),onBlur:()=>window.setTimeout(()=>m(!1),100),placeholder:h.bibleBookPlaceholder})]}),v&&l(i.bibleBookDisplay,!0).length>0&&e.jsx("div",{className:"cogita-lookup-results",children:l(i.bibleBookDisplay,!0).map((g,S)=>e.jsx("button",{type:"button",className:"cogita-lookup-option","data-active":S===w,tabIndex:-1,onMouseDown:()=>{var x;const F=c(g.label,r);F&&j({bibleBookDisplay:g.label,locatorValue:((x=F.la)==null?void 0:x.abbr)??i.locatorValue})},children:e.jsx("strong",{children:g.label})},g.latin))})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.bibleRestLabel}),e.jsx("input",{type:"text",value:i.locatorAux,onChange:g=>j({locatorAux:g.target.value}),placeholder:h.bibleRestPlaceholder})]})]}),i.sourceKind==="website"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:a.cogita.library.add.info.sourceUrlLabel}),e.jsx("input",{type:"text",value:i.sourceUrl,onChange:g=>j({sourceUrl:g.target.value}),placeholder:a.cogita.library.add.info.sourceUrlPlaceholder})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:a.cogita.library.add.info.sourceAccessedDateLabel}),e.jsx("input",{type:"text",value:i.sourceAccessedDate,onChange:g=>j({sourceAccessedDate:g.target.value}),placeholder:a.cogita.library.add.info.sourceAccessedDatePlaceholder})]})]}),i.sourceKind==="number_document"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:t,infoType:"work",label:h.churchDocumentLabel,placeholder:h.churchDocumentPlaceholder,value:i.churchDocument,onChange:g=>j({churchDocument:g}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.work),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:g=>j({locatorValue:g.target.value}),placeholder:h.locatorPlaceholder})]})]}),i.sourceKind==="work"&&e.jsx(Yt,{libraryId:t,infoType:"work",label:h.workLabel,placeholder:h.workPlaceholder,value:i.work,onChange:g=>j({work:g}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.work),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),i.sourceKind==="book"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:t,infoType:"media",label:h.bookLabel,placeholder:h.bookPlaceholder,value:i.bookMedia,onChange:g=>j({bookMedia:g}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.media),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:g=>j({locatorValue:g.target.value}),placeholder:h.locatorPlaceholder})]})]}),i.sourceKind!=="website"&&i.sourceKind!=="bible"&&i.sourceKind!=="book"&&i.sourceKind!=="number_document"&&e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:h.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:g=>j({locatorValue:g.target.value}),placeholder:h.locatorPlaceholder})]})]})}const _a=JSON.stringify({type:"selection",title:"Question title",question:"Question text",options:["Option A","Option B","Option C"],answer:[0]},null,2);function Ya(t="selection"){return t==="matching"?{type:t,title:"",question:"",columns:[[""],[""]],answer:{paths:[]},matchingPaths:[["",""]]}:t==="ordering"?{type:t,title:"",question:"",options:[""]}:t==="truefalse"?{type:t,title:"",question:"",answer:!0}:t==="text"||t==="date"?{type:t,title:"",question:"",answer:""}:t==="number"?{type:t,title:"",question:"",answer:""}:{type:t,title:"",question:"",options:[""],answer:[]}}function xi(t){return["selection","truefalse","text","number","date","matching","ordering"].includes(t)}function Da(t){if(!t||typeof t!="object")return null;const a=t,r=typeof a.type=="string"?a.type:typeof a.kind=="string"?a.kind:"selection",s=r==="multi_select"||r==="single_select"?"selection":r==="boolean"?"truefalse":r==="order"?"ordering":r,i=xi(s)?s:"selection",o=typeof a.title=="string"?a.title:"",h=typeof a.question=="string"?a.question:"";if(i==="matching"){let w=[];Array.isArray(a.columns)?w=a.columns.map(g=>Array.isArray(g)?g.map(S=>typeof S=="string"?S:""):[""]):Array.isArray(a.left)&&Array.isArray(a.right)&&(w=[a.left.map(g=>typeof g=="string"?g:""),a.right.map(g=>typeof g=="string"?g:"")]),w.length<2&&(w=[[""],[""]]);const d=a.answer&&typeof a.answer=="object"?a.answer:null,l=(Array.isArray(d==null?void 0:d.paths)?d==null?void 0:d.paths:Array.isArray(a.correctPairs)?a.correctPairs:[]).map(g=>Array.isArray(g)?g.map(S=>Number(S)).filter(S=>Number.isInteger(S)&&S>=0):[]).filter(g=>g.length>0),c=Array.isArray(a.matchingPaths)?a.matchingPaths.map(g=>Array.isArray(g)?Array.from({length:w.length},(S,F)=>String(g[F]??"")):new Array(w.length).fill("")):null,j=c&&c.length>0?c:[...l.map(g=>g.map(String)),new Array(w.length).fill("")];return{type:i,title:o,question:h,columns:w,answer:{paths:l},matchingPaths:j}}if(i==="ordering"){const w=Array.isArray(a.options)?a.options.map(d=>typeof d=="string"?d:""):Array.isArray(a.items)?a.items.map(d=>typeof d=="string"?d:""):[""];return{type:i,title:o,question:h,options:w.length?w:[""]}}if(i==="truefalse"){const w=typeof a.answer=="boolean"?a.answer:typeof a.expected=="boolean"?a.expected:!0;return{type:i,title:o,question:h,answer:w}}if(i==="number")return typeof a.answer=="number"?{type:i,title:o,question:h,answer:a.answer}:typeof a.answer=="string"?{type:i,title:o,question:h,answer:a.answer}:typeof a.expected=="number"?{type:i,title:o,question:h,answer:a.expected}:{type:i,title:o,question:h,answer:""};if(i==="text"||i==="date"){const w=typeof a.answer=="string"?a.answer:typeof a.expected=="string"?a.expected:"";return{type:i,title:o,question:h,answer:w}}const v=Array.isArray(a.options)?a.options.map(w=>typeof w=="string"?w:""):[""],m=Array.isArray(a.answer)?a.answer.map(w=>Number(w)).filter(w=>Number.isInteger(w)&&w>=0):Array.isArray(a.correct)?a.correct.map(w=>Number(w)).filter(w=>Number.isInteger(w)&&w>=0):[];return{type:i,title:o,question:h,options:v.length?v:[""],answer:m}}function vi(t){const a=(t.title??"").trim(),r=(t.question??"").trim();switch(t.type){case"matching":{const s=(t.columns??[[""],[""]]).map(f=>f.map(l=>l.trim()).filter(Boolean)).filter(f=>f.length>0),i=s.length>=2?s:[[""],[""]],o=t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[],h=(t.matchingPaths??[]).map(f=>f.map(l=>String(l??""))),v=i.length,m=h.map(f=>f.slice(0,v).map(l=>l.trim())).filter(f=>f.some(Boolean)).map(f=>f.map(l=>Number(l))).filter(f=>f.length===v&&f.every(l=>Number.isInteger(l)&&l>=0)),w=(Array.isArray(o)?o:[]).map(f=>Array.isArray(f)?f.map(l=>Number(l)).filter(l=>Number.isInteger(l)&&l>=0):[]).filter(f=>f.length===v),d=Array.from(new Set([...w,...m].map(f=>JSON.stringify(f)))).map(f=>JSON.parse(f));return JSON.stringify({type:t.type,...a?{title:a}:{},question:r,columns:i,answer:{paths:d}},null,2)}case"ordering":{const s=(t.options??[]).map(i=>i.trim()).filter(Boolean);return JSON.stringify({type:t.type,...a?{title:a}:{},question:r,options:s},null,2)}case"truefalse":return JSON.stringify({type:t.type,...a?{title:a}:{},question:r,answer:!!t.answer},null,2);case"number":return JSON.stringify({type:t.type,...a?{title:a}:{},question:r,answer:typeof t.answer=="number"||typeof t.answer=="string"?t.answer:""},null,2);case"date":case"text":return JSON.stringify({type:t.type,...a?{title:a}:{},question:r,answer:String(t.answer??"")},null,2);case"selection":default:{const s=(t.options??[]).map(h=>h.trim()).filter(Boolean),i=Array.isArray(t.answer)?t.answer:[],o=Array.from(new Set(i.filter(h=>Number.isInteger(h)&&h>=0&&h<s.length))).sort((h,v)=>h-v);return JSON.stringify({type:t.type,...a?{title:a}:{},question:r,options:s,answer:o},null,2)}}}const ks=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}];function za(){return{sourceKind:"string",locatorValue:"",locatorAux:"",bibleBookDisplay:"",sourceUrl:"",sourceAccessedDate:"",churchDocument:null,bookMedia:null,work:null}}function Ns(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function Ss(t,a){if(!t||typeof t!="object")return a;const r=t,s=r.definition&&typeof r.definition=="object"?r.definition:null,i=[r.label,r.name,r.title,r.text,r.orcid,r.email,r.number];s&&i.unshift(s.title,s.question);for(const o of i)if(typeof o=="string"&&o.trim())return o.trim();return a}function Ts(t,a){var s;if(!(t instanceof Hs))return a;const r=(s=t.message)==null?void 0:s.trim();if(!r)return a;try{const i=JSON.parse(r);if(typeof i.error=="string"&&i.error.trim())return i.error.trim()}catch{}return r}function wi(t){const a=t.trim();if(!a)return null;try{const r=JSON.parse(a);return r&&typeof r=="object"&&!Array.isArray(r)?r:null}catch{return null}}function ra(t,a){const r=t==null?void 0:t[a];return typeof r=="string"?r:""}function ji(t,a){return a?t==="book"&&a.infoType==="media"?{bookMedia:a}:t==="work"&&a.infoType==="work"?{work:a}:t==="number_document"&&a.infoType==="work"?{churchDocument:a}:{}:{}}function ki(t,a){const r=za(),s=(t.sourceKind??"").trim()||r.sourceKind,i=t.locator??"",o=wi(i);let h="",v="",m="",w="",d="";return s==="website"?(w=ra(o,"url"),d=ra(o,"accessedDate"),h=ra(o,"value")):s==="bible"?(h=ra(o,"book")||i.trim(),v=ra(o,"passage")||ra(o,"rest"),m=ra(o,"bookDisplay")):o?(h=ra(o,"value")||ra(o,"locator"),v=ra(o,"aux")):h=i,{...r,sourceKind:s,locatorValue:h,locatorAux:v,bibleBookDisplay:m,sourceUrl:w,sourceAccessedDate:d,...ji(s,a)}}function An(t){return t.sourceKind==="book"?t.bookMedia:t.sourceKind==="work"?t.work:t.sourceKind==="number_document"?t.churchDocument:null}function $n(t){const a=t.locatorValue.trim(),r=t.locatorAux.trim(),s=t.sourceUrl.trim(),i=t.sourceAccessedDate.trim();switch(t.sourceKind){case"website":return{url:s,accessedDate:i};case"bible":return{book:a,bookDisplay:t.bibleBookDisplay.trim(),passage:r};case"book":case"work":case"number_document":return r?{value:a,aux:r}:a;default:return r?{value:a,aux:r}:a}}function Cs(t){var i,o,h;const a=t.locatorValue.trim(),r=t.locatorAux.trim(),s=[a,r].filter(Boolean).join(" ");switch(t.sourceKind){case"website":return t.sourceUrl.trim()||"website";case"bible":return s||"bible";case"book":return[(i=t.bookMedia)==null?void 0:i.label,s].filter(Boolean).join(" · ")||"book";case"work":return[(o=t.work)==null?void 0:o.label,s].filter(Boolean).join(" · ")||"work";case"number_document":return[(h=t.churchDocument)==null?void 0:h.label,s].filter(Boolean).join(" · ")||"number_document";default:return s||t.sourceKind||"source"}}function Is(t){return t.sourceKind.trim()?t.sourceKind==="website"?!!t.sourceUrl.trim():t.sourceKind==="bible"?!!(t.locatorValue.trim()&&t.locatorAux.trim()):t.sourceKind==="book"?!!t.bookMedia:t.sourceKind==="work"?!!t.work:t.sourceKind==="number_document"?!!(t.churchDocument&&t.locatorValue.trim()):!!t.locatorValue.trim():!1}function Ni({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,libraryId:d,editInfoId:f}){var Ie,ze,Xe;const{libraryName:l}=da(d),c=!!f,[j,g]=n.useState([]),[S,F]=n.useState("word"),[x,y]=n.useState({}),[de,B]=n.useState({}),[p,Q]=n.useState({}),[N,ee]=n.useState({}),[q,R]=n.useState(null),[me,K]=n.useState("idle"),[Z,Le]=n.useState(za),[G,L]=n.useState({}),[A,z]=n.useState({}),[W,O]=n.useState({}),[fe,se]=n.useState(null),[ne,Ne]=n.useState(()=>Da(JSON.parse(_a))??Ya()),[Ae,Pe]=n.useState(_a),Re=n.useMemo(()=>j.find(E=>E.infoType===S),[S,j]),et=n.useMemo(()=>j.find(E=>E.infoType==="source"),[j]),ct=n.useMemo(()=>j.map(E=>({value:E.infoType,label:nt(t,E.infoType)})),[t,j]),Ce=E=>{const M=Da(E)??Ya(),_=vi(M);Ne(M),y(P=>({...P,definition:_}))};n.useEffect(()=>{let E=!1;return yr({libraryId:d}).then(M=>{var _;if(!E&&(g(M),!c)){const P=(_=M[0])==null?void 0:_.infoType;P&&F(P)}}).catch(()=>{E||g([])}),()=>{E=!0}},[c,d]),n.useEffect(()=>{if(c||!Re)return;const E={},M={},_={},P={};for(const k of Re.payloadFields)Re.infoType==="question"&&k.key==="definition"&&k.inputType==="json"?E[k.key]=_a:E[k.key]="";for(const k of Re.linkFields)k.multiple?_[k.key]=[]:M[k.key]=null,k.targetTypes.length>0&&(P[k.key]=k.targetTypes[0]);y(E),B(M),Q(_),ee(P)},[Re==null?void 0:Re.infoType,c]),n.useEffect(()=>{if(S!=="question")return;const E=x.definition??"";if(!E.trim()){const M=Da(JSON.parse(_a))??Ya();Ne(M),Pe(_a);return}try{const M=JSON.parse(E),_=Da(M);if(!_)return;Ne(_),Pe(JSON.stringify(M,null,2))}catch{}},[x.definition,S]),n.useEffect(()=>{if(!c||!f||j.length===0)return;let E=!1;return K("loading"),R(null),(async()=>{const _=await na({libraryId:d,infoId:f});if(E)return;const P=_.infoType;F(P);const k=j.find(X=>X.infoType===P);if(!k){K("idle");return}const T=_.payload??{},I={};for(const X of k.payloadFields)I[X.key]=Ns(T[X.key]);y(I);const he=_.links??{}??{},xe={},ge={},te={},$=[];for(const X of k.linkFields){X.targetTypes.length>0&&(te[X.key]=X.targetTypes[0]);const ie=he[X.key];if(X.multiple){const Y=Array.isArray(ie)?ie.filter(ae=>typeof ae=="string"):[];ge[X.key]=[];for(const ae of Y)$.push(na({libraryId:d,infoId:ae}).then(ve=>{if(E)return;const U={id:ae,infoType:ve.infoType,label:Ss(ve.payload,ae)};te[X.key]=U.infoType,ge[X.key]=[...ge[X.key],U]}).catch(()=>{}))}else{const Y=typeof ie=="string"?ie:null;xe[X.key]=null,Y&&$.push(na({libraryId:d,infoId:Y}).then(ae=>{if(E)return;const ve={id:Y,infoType:ae.infoType,label:Ss(ae.payload,Y)};te[X.key]=ve.infoType,xe[X.key]=ve}).catch(()=>{}))}}await Promise.all($),!E&&(B(xe),Q(ge),ee(te),K("idle"))})().catch(()=>{E||(R("Failed to load info details."),K("idle"))}),()=>{E=!0}},[f,c,d,j]),n.useEffect(()=>{S==="source"&&Le(ki(x,de.resource??null))},[S,x.sourceKind,x.locator,(Ie=de.resource)==null?void 0:Ie.id,(ze=de.resource)==null?void 0:ze.infoType,(Xe=de.resource)==null?void 0:Xe.label]);const We=E=>{var k,T;const M=((k=et==null?void 0:et.payloadFields.find(I=>I.key==="sourceKind"))==null?void 0:k.keepOnCreate)??!1,_=((T=et==null?void 0:et.linkFields.find(I=>I.key==="resource"))==null?void 0:T.keepOnCreate)??!1,P=za();return P.sourceKind=M?E.sourceKind:P.sourceKind,_&&(P.work=E.work,P.bookMedia=E.bookMedia,P.churchDocument=E.churchDocument),M&&E.sourceKind==="bible"&&(P.locatorValue=E.locatorValue,P.bibleBookDisplay=E.bibleBookDisplay),M&&E.sourceKind==="website"&&(P.sourceUrl=E.sourceUrl,P.sourceAccessedDate=E.sourceAccessedDate),P},xt=n.useMemo(()=>({sourceKindLabel:t.cogita.library.add.info.sourceKindLabel,bibleBookLabel:t.cogita.library.add.info.sourceBibleBookLabel,bibleBookPlaceholder:t.cogita.library.add.info.sourceBibleBookPlaceholder,bibleRestLabel:t.cogita.library.add.info.sourceBibleRestLabel,bibleRestPlaceholder:t.cogita.library.add.info.sourceBibleRestPlaceholder,churchDocumentLabel:t.cogita.library.add.info.sourceResourceLabel,churchDocumentPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,workLabel:t.cogita.library.add.info.sourceResourceLabel,workPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,bookLabel:t.cogita.library.add.info.sourceResourceLabel,bookPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,locatorLabel:t.cogita.library.list.typeFilterLocator,locatorPlaceholder:t.cogita.library.list.typeFilterLocator}),[t]),Ve=async E=>{const M=A[E]??za();if(!Is(M)){O(_=>({..._,[E]:t.cogita.library.add.info.referenceMissingSource}));return}se(E),O(_=>({..._,[E]:null}));try{const _=An(M),P=_?{resource:_.id}:{},k={label:Cs(M),sourceKind:M.sourceKind.trim(),locator:$n(M)},I={id:(await qn({libraryId:d,infoType:"source",payload:k,links:P})).infoId,infoType:"source",label:k.label};if(Q(he=>{const xe=he[E]??[];return xe.some(ge=>ge.id===I.id)?he:{...he,[E]:[...xe,I]}}),c&&f){const he=await na({libraryId:d,infoId:f}),xe=he.links&&typeof he.links=="object"?{...he.links}:{},ge=xe[E],te=Array.isArray(ge)?ge.filter($=>typeof $=="string"):typeof ge=="string"?[ge]:[];te.includes(I.id)||(xe[E]=[...te,I.id],await cs({libraryId:d,infoId:f,payload:he.payload,links:xe}))}z(he=>({...he,[E]:We(M)})),O(he=>({...he,[E]:null}))}catch(_){O(P=>({...P,[E]:Ts(_,t.cogita.library.lookup.createFailed)}))}finally{se(_=>_===E?null:_)}},Be=async()=>{var _;if(!Re)return;const E={};for(const P of Re.payloadFields){if(S==="source"&&(P.key==="sourceKind"||P.key==="locator"))continue;const k=(x[P.key]??"").trim();if(!k){if(P.required){R(`Field '${P.label}' is required.`);return}continue}if(P.inputType==="json")try{E[P.key]=JSON.parse(k)}catch{R(`Field '${P.label}' must be valid JSON.`);return}else E[P.key]=k}const M={};for(const P of Re.linkFields)if(!(S==="source"&&P.key==="resource"))if(P.multiple){const k=(p[P.key]??[]).map(T=>T.id);if(P.required&&k.length===0){R(`Link '${P.label}' is required.`);return}k.length>0&&(M[P.key]=k)}else{const k=((_=de[P.key])==null?void 0:_.id)??null;if(P.required&&!k){R(`Link '${P.label}' is required.`);return}k&&(M[P.key]=k)}if(S==="source"){if(!Is(Z)){R(t.cogita.library.add.info.referenceMissingSource);return}const P=Z.sourceKind.trim();E.sourceKind=P,E.locator=$n(Z),(typeof E.label!="string"||!E.label.trim())&&(E.label=Cs(Z));const k=An(Z);k&&(M.resource=k.id)}K("saving"),R(null);try{if(c&&f)await cs({libraryId:d,infoId:f,payload:E,links:M}),R("Info updated.");else{await qn({libraryId:d,infoType:S,payload:E,links:M}),R("Info saved.");const P={};for(const I of Re.payloadFields)P[I.key]=I.keepOnCreate?x[I.key]??"":"";y(P);const k={},T={};for(const I of Re.linkFields)I.multiple?T[I.key]=I.keepOnCreate?p[I.key]??[]:[]:k[I.key]=I.keepOnCreate?de[I.key]??null:null;B(I=>({...I,...k})),Q(I=>({...I,...T})),S==="source"&&Le(I=>{const he=We(I),xe=An(he);return y(ge=>({...ge,sourceKind:he.sourceKind,locator:Ns($n(he))})),B(ge=>({...ge,resource:xe})),xe&&ee(ge=>({...ge,resource:xe.infoType})),he})}}catch(P){R(Ts(P,"Failed to save info."))}finally{K("idle")}},tt=E=>{const M=x[E.key]??"";if(S==="question"&&E.key==="definition"&&E.inputType==="json"){const P=ne.type,k=$=>{const X=ne.title??"",ie=ne.question??"";Ce({...Ya($),title:X,question:ie})},T=$=>$.length===0?[""]:$[$.length-1].trim()?[...$,""]:$,I=$=>{const X=($.length?$:[[""],[""]]).map(ie=>T(ie));return X.length>=2?X:[...X,[""]]},he=($,X)=>{const ie=$.map(ae=>Array.from({length:X},(ve,U)=>ae[U]??"")).filter(ae=>ae.some(ve=>ve.trim())||ae===$[$.length-1]);return ie.length===0?[new Array(X).fill("")]:ie[ie.length-1].some(ae=>ae.trim())?[...ie,new Array(X).fill("")]:ie},xe=Array.isArray(ne.answer)?ne.answer:[],ge=I(ne.columns??[[""],[""]]),te=he(ne.matchingPaths??[[]],ge.length);return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:E.label}),e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.8rem"},children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question type"}),e.jsxs("select",{value:P,onChange:$=>k($.target.value),children:[e.jsx("option",{value:"selection",children:"Selection"}),e.jsx("option",{value:"truefalse",children:"True / false"}),e.jsx("option",{value:"text",children:"Text answer"}),e.jsx("option",{value:"number",children:"Number answer"}),e.jsx("option",{value:"date",children:"Date answer"}),e.jsx("option",{value:"matching",children:"Matching"}),e.jsx("option",{value:"ordering",children:"Right order"})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Title"}),e.jsx("input",{type:"text",value:ne.title??"",onChange:$=>Ce({...ne,title:$.target.value}),placeholder:"Optional title"})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question"}),e.jsx("textarea",{rows:3,value:ne.question??"",onChange:$=>Ce({...ne,question:$.target.value}),placeholder:"Question text"})]}),P==="selection"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Options / correct indices"}),T(ne.options??[""]).map(($,X,ie)=>{const Y=new Set(xe.filter(ve=>Number.isInteger(ve))),ae=X===ie.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:Y.has(X),disabled:!$.trim(),onChange:ve=>{const U=ve.target.checked?[...Y,X]:[...Y].filter(oe=>oe!==X);Ce({...ne,answer:U})}}),e.jsx("input",{type:"text",value:$,placeholder:`Answer ${X+1}`,onChange:ve=>{const U=[...ne.options??[""]];U[X]=ve.target.value;const oe=T(U),$e=oe.length-1,qe=xe.filter(_e=>_e>=0&&_e<$e);Ce({...ne,options:oe,answer:qe})}}),ae?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const U=(ne.options??[""]).filter(($e,qe)=>qe!==X),oe=xe.filter($e=>$e!==X).map($e=>$e>X?$e-1:$e);Ce({...ne,options:T(U),answer:oe})},children:"Remove"})]},`question-option:${X}`)})]}):null,P==="text"||P==="date"||P==="number"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsx("input",{type:P==="date"?"date":"text",value:typeof ne.answer=="string"||typeof ne.answer=="number"?String(ne.answer):"",onChange:$=>Ce({...ne,answer:$.target.value})})]}):null,P==="truefalse"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsxs("select",{value:String(!!ne.answer),onChange:$=>Ce({...ne,answer:$.target.value==="true"}),children:[e.jsx("option",{value:"true",children:"True"}),e.jsx("option",{value:"false",children:"False"})]})]}):null,P==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Columns"}),ge.map(($,X)=>e.jsxs("div",{style:{display:"grid",gap:"0.35rem",border:"1px solid rgba(120,170,220,0.22)",borderRadius:"0.6rem",padding:"0.55rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"0.5rem"},children:[e.jsxs("span",{style:{fontSize:"0.8rem",color:"rgba(184,209,234,0.85)"},children:["Column ",X+1]}),ge.length>2?e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const ie=ge.filter((ae,ve)=>ve!==X),Y=te.map(ae=>ae.filter((ve,U)=>U!==X));Ce({...ne,columns:I(ie),matchingPaths:he(Y,Math.max(2,ie.length))})},children:"Remove column"}):null]}),$.map((ie,Y)=>{const ae=Y===$.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",gap:"0.4rem",alignItems:"center"},children:[e.jsx("input",{type:"text",value:ie,placeholder:`Option ${Y+1}`,onChange:ve=>{const U=ge.map(oe=>[...oe]);U[X][Y]=ve.target.value,Ce({...ne,columns:I(U),matchingPaths:he(te,ge.length)})}}),ae?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const ve=ge.map(U=>[...U]);ve[X]=ve[X].filter((U,oe)=>oe!==Y),Ce({...ne,columns:I(ve),matchingPaths:he(te,ge.length)})},children:"Remove"})]},`question-column:${X}:row:${Y}`)})]},`question-column:${X}`)),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{const $=[...ge.map(ie=>[...ie]),[""]],X=te.map(ie=>[...ie,""]);Ce({...ne,columns:I($),matchingPaths:he(X,$.length)})},children:"Add column"})}),e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Correct paths (0-based indices)"}),te.map(($,X)=>{const ie=X===te.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:`repeat(${ge.length}, minmax(0,1fr)) auto`,gap:"0.35rem",alignItems:"center"},children:[$.map((Y,ae)=>e.jsx("input",{type:"number",min:0,step:1,value:Y,placeholder:`${ae}`,onChange:ve=>{const U=te.map(qe=>[...qe]);U[X][ae]=ve.target.value;const oe=he(U,ge.length),$e=oe.map(qe=>qe.map(_e=>_e.trim())).filter(qe=>qe.every(_e=>_e!=="")).map(qe=>qe.map(_e=>Number(_e))).filter(qe=>qe.every(_e=>Number.isInteger(_e)&&_e>=0));Ce({...ne,matchingPaths:oe,answer:{paths:$e}})}},`question-path:${X}:${ae}`)),ie?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const Y=te.filter((U,oe)=>oe!==X),ae=he(Y,ge.length),ve=ae.map(U=>U.map(oe=>oe.trim())).filter(U=>U.every(oe=>oe!=="")).map(U=>U.map(oe=>Number(oe))).filter(U=>U.every(oe=>Number.isInteger(oe)&&oe>=0));Ce({...ne,matchingPaths:ae,answer:{paths:ve}})},children:"Remove"})]},`question-path:${X}`)})]}):null,P==="ordering"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Ordered options (correct order = listed order)"}),T(ne.options??[""]).map(($,X,ie)=>{const Y=X===ie.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)",minWidth:"1.5rem"},children:[X+1,"."]}),e.jsx("input",{type:"text",value:$,placeholder:`Step ${X+1}`,onChange:ae=>{const ve=[...ne.options??[""]];ve[X]=ae.target.value,Ce({...ne,options:T(ve)})}}),Y?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ce({...ne,options:T((ne.options??[]).filter((ae,ve)=>ve!==X))}),children:"Remove"})]},`question-order:${X}`)})]}):null,e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"JSON import"}),e.jsx("textarea",{rows:8,value:Ae,onChange:$=>Pe($.target.value),placeholder:"Paste question JSON"}),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{try{const $=JSON.parse(Ae),X=Da($);if(!X){R("Question JSON must be an object.");return}Ce(X),R(null)}catch{R("Question JSON is invalid.")}},children:"Interpret JSON"})})]})]})]},`payload:${E.key}`)}const _=E.inputType==="textarea"||E.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:E.label}),_?e.jsx("textarea",{rows:E.inputType==="json"?8:4,value:M,onChange:P=>y(k=>({...k,[E.key]:P.target.value})),placeholder:E.key}):e.jsx("input",{type:"text",value:M,onChange:P=>y(k=>({...k,[E.key]:P.target.value})),placeholder:E.key})]},`payload:${E.key}`)},ot=E=>{const M=N[E.key]??E.targetTypes[0],_=E.key==="references"&&E.multiple&&E.targetTypes.includes("source"),P=A[E.key]??za(),k=G[E.key]??!1,T=W[E.key];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:E.label}),E.targetTypes.length>1?e.jsx("select",{value:M,onChange:I=>ee(he=>({...he,[E.key]:I.target.value})),children:E.targetTypes.map(I=>e.jsx("option",{value:I,children:nt(t,I)},`${E.key}:${I}`))}):null,E.multiple?e.jsx(Yt,{libraryId:d,infoType:M,label:E.label,placeholder:E.key,multiple:!0,values:p[E.key]??[],onChangeMultiple:I=>Q(he=>({...he,[E.key]:I})),allowCreate:!_,searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(Yt,{libraryId:d,infoType:M,label:E.label,placeholder:E.key,value:de[E.key]??null,onChange:I=>B(he=>({...he,[E.key]:I})),searchFailedText:"Search failed",createFailedText:"Create failed"}),_?e.jsxs("div",{children:[e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:k,onChange:I=>L(he=>({...he,[E.key]:I.target.checked}))}),e.jsx("span",{children:t.cogita.library.add.info.referenceToggle})]}),k?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(js,{libraryId:d,copy:t,language:m,sourceKindOptions:[...ks],value:P,onChange:I=>z(he=>({...he,[E.key]:I})),labels:xt}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>Ve(E.key),disabled:fe===E.key,children:fe===E.key?t.cogita.library.lookup.saving:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.source)})}),T?e.jsx("p",{className:"cogita-library-subtitle",children:T}):null]}):null]}):null]},`link:${E.key}`)},Ye=()=>e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(js,{libraryId:d,copy:t,language:m,sourceKindOptions:[...ks],value:Z,onChange:Le,labels:xt})]});return e.jsx(Pt,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:c?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${d}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[c?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:S,onChange:E=>F(E.target.value),children:ct.map(E=>e.jsx("option",{value:E.value,children:E.label},E.value))})]}),me==="loading"&&c?e.jsx("p",{children:"Loading..."}):null,Re&&!(me==="loading"&&c)?e.jsxs("div",{className:"cogita-form-grid",children:[Re.payloadFields.filter(E=>!(S==="source"&&(E.key==="sourceKind"||E.key==="locator"))).map(tt),S==="source"?Ye():null,Re.linkFields.filter(E=>!(S==="source"&&E.key==="resource")).map(ot)]}):me==="loading"&&c?null:e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:Be,disabled:me==="saving"||!Re,children:me==="saving"?"Saving...":c?"Update info":"Create info"})}),q?e.jsx("p",{className:"cogita-library-subtitle",children:q}):null]})})})]})})}const Ms=t=>/\s/.test(t),sn=t=>/[\p{L}\p{N}]/u.test(t),Ls=(t,a)=>{const r=a>0?t[a-1]:"",s=a<t.length?t[a]:"";if(!r||!s)return 0;const i=Ms(r),o=Ms(s);if(i||o)return 3;const h=sn(r),v=sn(s);return h!==v?2:!h&&!v?1:0},Rn=(t,a,r,s,i)=>{const o=Math.max(s-a,r-s);for(let h=0;h<=o;h+=1){const v=s-h;if(v>=a&&v<=r&&Ls(t,v)>=i)return v;const m=s+h;if(m>=a&&m<=r&&Ls(t,m)>=i)return m}return null},Pn=(t,a)=>{const r=a>0?t[a-1]:"",s=a<t.length?t[a]:"";return!r||!s?!0:sn(r)!==sn(s)},Si=(t,a,r,s)=>{const i=r-a,o=a+s,h=r-s;if(i<=s*2||h<=o)return null;const v=Math.floor((a+r)/2),m=Rn(t,o,h,v,3);if(m!==null&&Pn(t,m))return m;const w=Rn(t,o,h,v,2);if(w!==null&&Pn(t,w))return w;const d=Rn(t,o,h,v,1);return d!==null&&Pn(t,d)?d:null},va=(t,a)=>{const r=Math.max(1,(a==null?void 0:a.minLen)??7),s=Math.max(r,(a==null?void 0:a.maxLen)??13),i={},o=(m,w,d,f,l)=>{const c=String(f),j={id:c,start:m,end:w,text:t.slice(m,w),depth:d,index:f,parentId:l};if(i[c]=j,w-m>s){let S=Si(t,m,w,r);if(S!==null&&S>m&&S<w){const F=o(m,S,d+1,f*2+1,c),x=o(S,w,d+1,f*2+2,c);j.leftId=F.id,j.rightId=x.id}}return j},h=o(0,t.length,0,0),v=Object.values(i).sort((m,w)=>w.depth-m.depth||m.start-w.start).map(m=>m.id);return{text:t,rootId:h.id,nodes:i,order:v}},$a=(t,a,r,s,i,o,h)=>{const v=o==="reverse"?t.order.slice().sort((m,w)=>t.nodes[w].start-t.nodes[m].start||t.nodes[w].depth-t.nodes[m].depth):t.order;for(const m of v){if(h&&m===h||a.has(m))continue;const w=t.nodes[m];if(w){if(i&&(w.leftId||w.rightId)){const d=w.leftId?r[w.leftId]??0:s,f=w.rightId?r[w.rightId]??0:s;if((d+f)/2<s)continue}return w}}return null},xn=(t,a)=>({before:t.slice(0,a.start),fragment:t.slice(a.start,a.end),after:t.slice(a.end)});function Ti({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,libraryId:d}){const f=`/#/cogita/library/${d}`,[l,c,j]=Hn([]),[g,S,F]=Wn([]),[x,y]=n.useState(null),[de,B]=n.useState(null),[p,Q]=n.useState(null),[N,ee]=n.useState(null),q=n.useMemo(()=>l.find(L=>L.id===x)??null,[l,x]);n.useEffect(()=>{let L=!0;return xr({libraryId:d}).then(A=>{if(!L)return;const z=A.nodes.map(W=>{var O,fe,se;return{id:W.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:W.payload&&typeof W.payload=="object"&&"label"in W.payload?String(W.payload.label):"Item",nodeType:W.nodeType,itemType:((O=W.payload)==null?void 0:O.itemType)??"info",itemId:((fe=W.payload)==null?void 0:fe.itemId)??null,infoType:((se=W.payload)==null?void 0:se.infoType)??null}}});c(z),S(A.edges.map(W=>({id:W.edgeId,source:W.fromNodeId,target:W.toNodeId})))}).catch(()=>{L&&(c([]),S([]))}),()=>{L=!1}},[d]),n.useEffect(()=>{vr({libraryId:d}).then(B).catch(()=>B(null))},[d,l,g]);const R=n.useCallback(L=>{S(A=>Qn(L,A))},[]),me=()=>{const L=crypto.randomUUID();c(A=>[...A,{id:L,type:"default",position:{x:140+A.length*40,y:120+A.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},K=()=>{const L=crypto.randomUUID();c(A=>[...A,{id:L,type:"default",position:{x:180+A.length*40,y:160+A.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},Z=async()=>{Q(null);try{const L=l.map(z=>({nodeId:z.id,nodeType:z.data.nodeType,payload:{itemType:z.data.itemType,itemId:z.data.itemId??null,label:z.data.label,infoType:z.data.infoType??null}})),A=g.map(z=>({edgeId:z.id,fromNodeId:z.source,toNodeId:z.target}));await wr({libraryId:d,nodes:L,edges:A}),Q(t.cogita.library.graph.saveSuccess)}catch{Q(t.cogita.library.graph.saveFail)}},Le=L=>{q&&c(A=>A.map(z=>z.id===q.id?{...z,data:{...z.data,itemId:(L==null?void 0:L.infoId)??null,itemType:"collection",infoType:"collection",label:(L==null?void 0:L.label)??t.cogita.library.infoTypes.collection}}:z))},G=L=>{q&&c(A=>A.map(z=>z.id===q.id?{...z,data:{...z.data,itemId:(L==null?void 0:L.infoId)??null,itemType:"info",infoType:(L==null?void 0:L.infoType)??null,label:(L==null?void 0:L.label)??t.cogita.library.infoTypes.any}}:z))};return n.useEffect(()=>{if(!q||q.data.nodeType!=="info"||q.data.infoType!=="citation"||!q.data.itemId){ee(null);return}let L=!0;return na({libraryId:d,infoId:q.data.itemId}).then(A=>{if(!L)return;const z=A.payload,W=(z==null?void 0:z.text)??"";if(!W){ee(null);return}const O=va(W),fe=Object.values(O.nodes).sort((se,ne)=>se.depth-ne.depth||se.start-ne.start).map(se=>({id:se.id,text:se.text,depth:se.depth}));ee({title:(z==null?void 0:z.title)??q.data.label,fragments:fe})}).catch(()=>ee(null)),()=>{L=!1}},[d,q]),e.jsx(Pt,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:f,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:Z,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:me,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:K,children:t.cogita.library.actions.addInfo}),de?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(de.totalCollections))})}):null,p?e.jsx("p",{className:"cogita-help",children:p}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(pn,{nodes:l,edges:g,onNodesChange:j,onEdgesChange:F,onConnect:R,onNodeClick:(L,A)=>y(A.id),fitView:!0,children:[e.jsx(fn,{gap:18,size:1}),e.jsx(bn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),q?e.jsxs("div",{className:"cogita-graph-inspector",children:[q.data.nodeType==="collection"?e.jsx(Yt,{libraryId:d,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:q.data.itemId?{id:q.data.itemId,label:q.data.label,infoType:"collection"}:null,onChange:Le,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(Yt,{libraryId:d,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:q.data.itemId?{id:q.data.itemId,label:q.data.label,infoType:q.data.infoType??void 0}:null,onChange:G,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),N?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:N.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:N.fragments.map(L=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:L.id}),e.jsx("span",{children:L.text})]},L.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function es({children:t,flashState:a,flashTick:r=0,feedbackToken:s,className:i}){const o=s??(a?`${a}-${r}`:"idle");return e.jsx("section",{className:i?`cogita-revision-card ${i}`:"cogita-revision-card","data-feedback":o,children:t})}function ts({copy:t,currentCard:a,currentTypeLabel:r,prompt:s,languages:i,answer:o,onAnswerChange:h,computedExpected:v,computedAnswers:m,onComputedAnswerChange:w,answerTemplate:d,outputVariables:f,variableValues:l,computedFieldFeedback:c,feedback:j,canAdvance:g,quoteContext:S,quotePlaceholder:F,onCheckAnswer:x,onSkip:y,onLanguageSelect:de,onMarkReviewed:B,onAdvance:p,showCorrectAnswer:Q,setShowCorrectAnswer:N,onRevealCorrect:ee,answerMask:q,expectedAnswer:R,hasExpectedAnswer:me,handleComputedKeyDown:K,answerInputRef:Z,computedInputRefs:Le,scriptMode:G,setScriptMode:L,matchPairs:A,matchLeftOrder:z,matchRightOrder:W,matchSelection:O,matchActiveLeft:fe,matchActiveRight:se,matchFeedback:ne,onMatchLeftSelect:Ne,onMatchRightSelect:Ae,disableCheckAnswer:Pe=!1,hideSkipAction:Re=!1,allowRevealBeforeCheck:et=!1,autoRevealAfterAnswer:ct=!1,disableCheckAfterAnswer:Ce=!1}){const We=n.useMemo(()=>{var X;const M=!d&&v.length===2?`The {${v[0].key}} is of type {${v[1].key}}`:null,_=d??M;if(!_)return null;const P=new Map(v.map(ie=>[ie.key,ie.expected])),k=new Set,T=[],I=/\{([^}]+)\}/g;let he=0,xe,ge=null;for(;(xe=I.exec(_))!==null;){const ie=_.slice(he,xe.index);ie&&T.push({type:"text",value:ie});const Y=((X=xe[1])==null?void 0:X.trim())??"",ae=Y&&P.has(Y)?Y:Y&&f&&f[Y]?f[Y]:null;Y&&k.add(Y),ae&&k.add(ae),ae&&P.has(ae)?(T.push({type:"input",value:ae}),ge||(ge=ae)):Y&&l&&l[Y]!==void 0?T.push({type:"text",value:l[Y]}):T.push({type:"text",value:xe[0]}),he=xe.index+xe[0].length}const te=_.slice(he);return te&&T.push({type:"text",value:te}),v.filter(ie=>!k.has(ie.key)).length>0?null:{parts:T,expectedByKey:P,firstInputKey:ge}},[d,v,f,l]),xt=()=>{if(!We)return null;const{parts:M,expectedByKey:_,firstInputKey:P}=We;return e.jsx("div",{className:"cogita-revision-inline-answer",children:M.map((k,T)=>{var I,he;return k.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:k.value},`text-${T}`):e.jsx("input",{ref:xe=>{Le.current[k.value]=xe},autoFocus:k.value===P,value:m[k.value]??"",onChange:xe=>w(k.value,xe.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":c[k.value]??(j==="correct"?"correct":j==="incorrect"?"incorrect":void 0),onKeyDown:xe=>ot(xe)||K(xe),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((I=m[k.value])==null?void 0:I.length)??0,((he=_.get(k.value))==null?void 0:he.length)??6)}ch`}},`input-${k.value}-${T}`)})})},Ve=n.useMemo(()=>{const M=new Map;return(A??[]).forEach(_=>M.set(_.leftId,_)),M},[A]),Be=n.useMemo(()=>{const M=new Map;return(A??[]).forEach(_=>M.set(_.rightId,_)),M},[A]);n.useEffect(()=>{var T;if(a.cardType!=="info"||a.infoType!=="computed"||v.length===0)return;const M=typeof document<"u"?document.activeElement:null;if(M&&(M.tagName==="INPUT"||M.tagName==="TEXTAREA"))return;const _=(We==null?void 0:We.firstInputKey)??((T=v[0])==null?void 0:T.key);if(!_)return;const P=Le.current[_];if(!P)return;const k=requestAnimationFrame(()=>{P.focus()});return()=>cancelAnimationFrame(k)},[a,v,We]);const tt=(()=>{const M=[R??"",...v.map(k=>k.expected??"")].join(""),_=[o,...Object.values(m)].join(""),P=`${M}${_}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(P)})(),ot=M=>M.ctrlKey&&(M.key==="^"||M.key==="6")?(M.preventDefault(),L(_=>_==="super"?null:"super"),!0):M.ctrlKey&&(M.key==="_"||M.key==="-")?(M.preventDefault(),L(_=>_==="sub"?null:"sub"),!0):!1,Ye=()=>{if(!R||!q)return R??"";const M=R.split(""),_=Array.from(q),P=_.length>0?_.reduce((k,T)=>k+T,0)/_.length:127;return M.map((k,T)=>{const I=_[T]??P,he=Math.max(0,Math.min(255,Math.round(I)));let xe=255,ge=0;return he<=127?ge=Math.round(he/127*255):(ge=255,xe=Math.round(255*(1-(he-127)/128))),e.jsx("span",{style:{color:`rgb(${xe}, ${ge}, 0)`},children:k},`mask-${T}`)})},Ie=a.cardType==="info"&&a.infoType==="citation"?(S==null?void 0:S.title)||a.label:a.description,ze=Q||ct&&j!==null,Xe=Pe||Ce&&(j!==null||ze),E=me&&(et||j==="incorrect"||ze);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[r?e.jsx("span",{children:r}):null,e.jsx("strong",{children:Ie})]}),a.cardType==="vocab"&&a.checkType==="translation-match"&&A?e.jsxs("div",{className:"cogita-revision-body",children:[s?e.jsx("h2",{children:s}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(z??[]).map(M=>{const _=Ve.get(M);if(!_)return null;const P=(O==null?void 0:O[M])??null,k=(ne==null?void 0:ne[M])??null,T=fe===M;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":T,"data-state":k??void 0,"data-locked":P?"true":void 0,onClick:()=>Ne==null?void 0:Ne(M),children:[e.jsx("span",{children:_.leftLabel}),P&&Q?e.jsx("em",{children:"✓"}):null]},M)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(W??[]).map(M=>{const _=Be.get(M);if(!_)return null;const P=Object.values(O??{}).includes(M),k=se===M;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":P||k,"data-locked":P?"true":void 0,onClick:()=>Ae==null?void 0:Ae(M),children:e.jsx("span",{children:_.rightLabel})},M)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:a.checkType==="translation-match"||Xe,children:t.cogita.library.revision.checkAnswer}),Re?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):a.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:s}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:Z,value:o,onChange:M=>h(M.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":j==="correct"?"correct":j==="incorrect"?"incorrect":void 0,onKeyDown:M=>{if(M.key==="Enter")if(M.preventDefault(),M.stopPropagation(),g)p();else{if(Xe)return;x()}}})]}),tt?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":G==="super",onClick:()=>L(M=>M==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":G==="sub",onClick:()=>L(M=>M==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:Xe,children:t.cogita.library.revision.checkAnswer}),Re?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[a.label?e.jsx("p",{className:"cogita-revision-hint",children:a.label}):null,d?null:e.jsx(jr,{value:s??"",mode:"auto"}),v.length>0?(()=>{const M=xt();return M?e.jsx("div",{className:"cogita-inline-answer-wrap",children:M}):e.jsx("div",{className:"cogita-form-grid",children:v.map((_,P)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:_.key}),e.jsx("textarea",{ref:k=>{Le.current[_.key]=k},autoFocus:P===0,value:m[_.key]??"",onChange:k=>w(_.key,k.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":c[_.key]??(j==="correct"?"correct":j==="incorrect"?"incorrect":void 0),onKeyDown:k=>ot(k)||K(k)})]},_.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:Z,value:o,onChange:M=>h(M.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":j==="correct"?"correct":j==="incorrect"?"incorrect":void 0,onKeyDown:M=>{if(!ot(M)&&M.key==="Enter")if(M.preventDefault(),M.stopPropagation(),g)p();else{if(Xe)return;x()}}})]})}),tt?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":G==="super",onClick:()=>L(M=>M==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":G==="sub",onClick:()=>L(M=>M==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:Xe,children:t.cogita.library.revision.checkAnswer}),Re?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="citation"&&S?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(S.completed)).replace("{total}",String(S.total))}),e.jsx("p",{className:"cogita-quote-text",children:S.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:Z,value:o,onChange:M=>h(M.target.value),placeholder:F??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":j==="correct"?"correct":j==="incorrect"?"incorrect":void 0,onKeyDown:M=>{if(M.key==="Enter")if(M.preventDefault(),M.stopPropagation(),g)p();else{if(Xe)return;x()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:S.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,disabled:Xe,children:t.cogita.library.revision.checkAnswer}),Re?null:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:s}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:i.length?i.map(M=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>de(M.label),children:M.label},M.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:s}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:B,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:y,children:t.cogita.library.revision.skip})]})]}),j&&e.jsx("div",{className:"cogita-revision-feedback","data-state":j,children:j==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),E?e.jsxs("div",{className:"cogita-revision-reveal",children:[ze?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>N(M=>{const _=!M;return _&&ee(),_}),children:t.cogita.library.revision.showAnswer}),ze?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),v.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[v.map(M=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:M.key}),e.jsx("span",{children:M.expected})]},M.key)),R?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:R})]}):null]}):e.jsx("p",{children:q?Ye():R})]}):null]}):null,g?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:p,children:t.cogita.library.revision.nextQuestion})}):null]})}const As={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},Ci=(t,a)=>{const r=Math.max(t.length,a.length,1),s=Math.abs(t.length-a.length);return Math.max(0,1-s/r)},Ii=(t,a)=>{const r=new Uint8Array(t.length),s=Ci(t,a);for(let i=0;i<t.length;i+=1){const o=t[i]===(a[i]??"")?128:0,h=t.length-1-i,v=a.length-1-i,m=t[h]===(a[v]??"")?127:0,w=Math.round((o+m)*s);r[i]=Math.max(0,Math.min(255,w))}return r},Mi=(t,a)=>t===a||(As[t]??[]).includes(a)?!0:(As[a]??[]).includes(t),Xa=(t,a,r)=>r?Mi(t,a):t===a,rn=(t,a,r)=>{const s=new Uint8Array(t.length);if(!t.length)return s;const i=(r==null?void 0:r.allowSimilarChars)??!0,o=[];for(let v=0;v<=t.length-3;v+=1)o.push({index:v,text:t.slice(v,v+3)});let h=!1;return o.forEach(v=>{for(let m=0;m<=a.length-3;m+=1){const w=a.slice(m,m+3);let d=0;for(let g=0;g<3;g+=1)Xa(v.text[g],w[g],i)&&(d+=1);if(d<2)continue;let f=v.index-1,l=m-1;for(;f>=0&&l>=0;){const g=t[f],S=a[l];if(g===S){s[f]=Math.max(s[f],255),f-=1,l-=1,h=!0;continue}if(Xa(g,S,i)&&g!==S){s[f]=Math.max(s[f],127),f-=1,l-=1,h=!0;continue}if(f>0&&t[f-1]===S){s[f]=Math.max(s[f],0),f-=1,h=!0;continue}if(l>0&&t[f]===a[l-1]){l-=1,h=!0;continue}break}for(let g=0;g<3;g+=1){const S=v.index+g,F=v.text[g],x=w[g],y=F===x?255:Xa(F,x,i)?127:0;s[S]=Math.max(s[S],y),h=!0}let c=v.index+3,j=m+3;for(;c<t.length&&j<a.length;){const g=t[c],S=a[j];if(g===S){s[c]=Math.max(s[c],255),c+=1,j+=1,h=!0;continue}if(Xa(g,S,i)&&g!==S){s[c]=Math.max(s[c],127),c+=1,j+=1,h=!0;continue}if(c+1<t.length&&t[c+1]===S){s[c]=Math.max(s[c],0),c+=1,h=!0;continue}if(j+1<a.length&&t[c]===a[j+1]){j+=1,h=!0;continue}break}}}),h?s:Ii(t,a)},En=t=>/[\p{L}\p{N}]/u.test(t),$s=t=>t.trim().toLowerCase(),xa=(t,a)=>{if(t.length===0)return 100;const r=(a==null?void 0:a.treatSimilarCharsAsSame)??!1,s=Array.from(t).reduce((i,o)=>r&&o===127?i+255:i+o,0);return Math.round(s/(t.length*255)*100)},Sa=(t,a,r)=>{const s=Math.max(0,Math.min(100,(r==null?void 0:r.thresholdPercent)??100)),i=(r==null?void 0:r.treatSimilarCharsAsSame)??!0,o=(r==null?void 0:r.ignorePunctuationAndSpacing)??!1,h=$s(t),v=$s(a);if(!o){const x=rn(h,v,{allowSimilarChars:i}),y=xa(x,{treatSimilarCharsAsSame:i});return{mask:x,percent:y,isCorrect:y>=s,normalizedExpected:h,normalizedAnswer:v}}const m=Array.from(h),w=Array.from(v),d=[],f=[],l=[];m.forEach((x,y)=>{En(x)&&(d.push(x),f.push(y))}),w.forEach(x=>{En(x)&&l.push(x)});const c=d.join(""),j=l.join(""),g=rn(c,j,{allowSimilarChars:i}),S=new Uint8Array(m.length);for(let x=0;x<S.length;x+=1)S[x]=En(m[x]??"")?0:255;for(let x=0;x<g.length;x+=1){const y=f[x];y!==void 0&&(S[y]=g[x])}const F=xa(g,{treatSimilarCharsAsSame:i});return{mask:S,percent:F,isCorrect:F>=s,normalizedExpected:c,normalizedAnswer:j}},Ra=(t,a,r)=>{const s=t.trim().toLowerCase(),i=a.trim().toLowerCase();return r==="prefix"||r==="bidirectional"?rn(s,i,{allowSimilarChars:!0}):rn(s,i,{allowSimilarChars:!0})};function Li(t){if(!t||typeof t!="object")return null;const r=t.definition;if(!r||typeof r!="object")return null;const s=r,i=typeof s.type=="string"?s.type:typeof s.kind=="string"?s.kind:"selection",o=i==="multi_select"||i==="single_select"?"selection":i==="boolean"?"truefalse":i==="order"?"ordering":i;if(!["selection","truefalse","text","number","date","ordering","matching"].includes(o))return null;const h=o,v=typeof s.title=="string"?s.title:void 0,m=typeof s.question=="string"?s.question:"",w=Array.isArray(s.options)?s.options.map(l=>typeof l=="string"?l:"").filter(Boolean):void 0,d=Array.isArray(s.columns)?s.columns.map(l=>Array.isArray(l)?l.map(c=>typeof c=="string"?c:"").filter(Boolean):[]).filter(l=>l.length>0):void 0,f=(()=>{if(o==="selection")return(Array.isArray(s.answer)?s.answer:Array.isArray(s.correct)?s.correct:[]).map(c=>Number(c)).filter(c=>Number.isInteger(c)&&c>=0);if(o==="truefalse")return typeof s.answer=="boolean"?s.answer:typeof s.expected=="boolean"?s.expected:!1;if(o==="matching"){const l=s.answer&&typeof s.answer=="object"?s.answer:null;return{paths:(Array.isArray(l==null?void 0:l.paths)?l==null?void 0:l.paths:Array.isArray(s.correctPairs)?s.correctPairs:[]).map(g=>Array.isArray(g)?g.map(S=>Number(S)).filter(S=>Number.isInteger(S)&&S>=0):[]).filter(g=>g.length>0)}}if(typeof s.answer=="string"||typeof s.answer=="number")return s.answer;if(typeof s.expected=="string"||typeof s.expected=="number")return s.expected})();return{type:h,title:v,question:m,options:w,columns:d,answer:f}}function Ai(t){var i;if(t.type!=="matching")return[[]];const a=Math.max(2,((i=t.columns)==null?void 0:i.length)??2);return[...((t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[])??[]).map(o=>Array.from({length:a},(h,v)=>String(o[v]??""))),new Array(a).fill("")]}function $i(t){const a=[...t];for(let r=a.length-1;r>0;r-=1){const s=Math.floor(Math.random()*(r+1));[a[r],a[s]]=[a[s],a[r]]}return a}function Rs(t){const a=t.map((i,o)=>({value:i,oldIndex:o}));for(let i=a.length-1;i>0;i-=1){const o=Math.floor(Math.random()*(i+1));[a[i],a[o]]=[a[o],a[i]]}const r=a.map(i=>i.value),s=new Map;return a.forEach((i,o)=>s.set(i.oldIndex,o)),{values:r,oldToNew:s}}function Ri(t){if(t.type==="selection"){const a=t.options??[],r=Rs(a),s=Array.isArray(t.answer)?t.answer:[];return{...t,options:r.values,answer:s.map(i=>r.oldToNew.get(i)).filter(i=>Number.isInteger(i)).sort((i,o)=>i-o)}}if(t.type==="matching"){const r=(t.columns??[]).map(o=>Rs(o??[])),i=(t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[]).map(o=>o.map((h,v)=>{var m;return((m=r[v])==null?void 0:m.oldToNew.get(h))??h}));return{...t,columns:r.map(o=>o.values),answer:{paths:i}}}return t}function ia(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function Ps(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function Es(t){const a=t.checkType??"info",r=a.startsWith("question-")?`question / ${a.slice(9)}`:a;return t.direction?`${r} / ${t.direction}`:r}function Pi({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,libraryId:d,infoId:f,selectedReviewerRoleId:l}){const[c,j]=n.useState(f),[g,S]=n.useState([]),[F,x]=n.useState([]),[y,de]=n.useState("loading"),[B,p]=n.useState(null),[Q,N]=n.useState(null),[ee,q]=n.useState(null),[R,me]=n.useState(null),[K,Z]=n.useState(""),[Le,G]=n.useState(null),[L,A]=n.useState(1),[z,W]=n.useState(null),[O,fe]=n.useState(0),[se,ne]=n.useState(!1),[Ne,Ae]=n.useState(null),[Pe,Re]=n.useState({}),[et,ct]=n.useState({}),[Ce]=n.useState({}),[We,xt]=n.useState(null),[Ve,Be]=n.useState({selection:[],booleanAnswer:null,ordering:[],matchingRows:[[]]}),tt=n.useRef(null),ot=n.useRef({}),Ye=mn();n.useEffect(()=>{let te=!1;return de("loading"),Promise.all([na({libraryId:d,infoId:f}).catch(()=>null),tn({libraryId:d,infoId:f}),an({libraryId:d,infoId:f})]).then(([$,X,ie])=>{if(te)return;const Y=($==null?void 0:$.payload)??{},ae=typeof Y.title=="string"&&Y.title||typeof Y.label=="string"&&Y.label||typeof Y.name=="string"&&Y.name||f;j(ae),N(Y),q(($==null?void 0:$.infoType)??null),S(X.items),x(ie.items),de("ready")}).catch(()=>{te||(N(null),q(null),S([]),x([]),de("error"))}),()=>{te=!0}},[d,f]),n.useEffect(()=>{if(ee!=="translation"){me(null);return}Js({libraryId:d,infoId:f,approachKey:"vocab-card"}).then(te=>me(te.projection??null)).catch(()=>me(null))},[ee,f,d]);const Ie=n.useMemo(()=>{var ve;const te=new Map(g.map(U=>[ia(U),U])),$=new Map,X=new Map;for(const U of g)$.set(ia(U),0),X.set(ia(U),[]);for(const U of F){const oe=Ps({parentItemId:U.parentItemId,parentCheckType:U.parentCheckType,parentDirection:U.parentDirection}),$e=[U.childItemId,U.childCheckType??"",U.childDirection??""].join("|");!te.has(oe)||!te.has($e)||((ve=X.get(oe))==null||ve.push($e),$.set($e,($.get($e)??0)+1))}const ie=Array.from($.entries()).filter(([,U])=>U===0).map(([U])=>U),Y=new Map;for(const U of ie)Y.set(U,0);for(;ie.length;){const U=ie.shift(),oe=Y.get(U)??0;for(const $e of X.get(U)??[]){const qe=Math.max(Y.get($e)??0,oe+1);Y.set($e,qe),$.set($e,($.get($e)??1)-1),($.get($e)??0)<=0&&ie.push($e)}}const ae=new Map;for(const U of g){const oe=ia(U),$e=Y.get(oe)??0,qe=ae.get($e)??[];qe.push(oe),ae.set($e,qe)}return g.map(U=>{const oe=ia(U),$e=Y.get(oe)??0,qe=ae.get($e)??[oe],_e=Math.max(0,qe.indexOf(oe));return{id:oe,position:{x:40+_e*290+($e%2?18:0),y:30+$e*120},draggable:!1,selectable:!0,data:{label:U.label,subtitle:Es(U),checkType:U.checkType??"info",direction:U.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[g,F]),ze=n.useMemo(()=>new Map(g.map(te=>[ia(te),te])),[g]),Xe=n.useMemo(()=>{const te=[];for(const $ of F){const X=Ps({parentItemId:$.parentItemId,parentCheckType:$.parentCheckType,parentDirection:$.parentDirection}),ie=[$.childItemId,$.childCheckType??"",$.childDirection??""].join("|");!ze.has(X)||!ze.has(ie)||te.push({id:`${X}->${ie}`,source:X,target:ie,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return te},[ze,F]),E=n.useMemo(()=>B?ze.get(B)??null:null,[ze,B]);n.useEffect(()=>{Z(""),W(null),fe(0),ne(!1),Ae(null),G(null),ct({}),Be({selection:[],booleanAnswer:null,ordering:[],matchingRows:[[]]})},[B]);const M=n.useMemo(()=>{var Y,ae;if(!E)return null;const te=ee??E.infoType??null,$=E.checkType??"info",X=E.direction??null,ie=Q??{};if(E.cardType==="vocab"&&R&&Array.isArray(R.words)){const ve=R.words,U=((Y=ve[0])==null?void 0:Y.label)??"?",oe=((ae=ve[1])==null?void 0:ae.label)??"?";return X==="a-to-b"?{kind:"vocab",prompt:String(U),expected:String(oe)}:X==="b-to-a"?{kind:"vocab",prompt:String(oe),expected:String(U)}:{kind:"generic",prompt:`${U} ↔ ${oe}`,expected:`${U} ↔ ${oe}`}}if(te==="citation"&&$==="quote-fragment"&&X&&typeof ie.text=="string"){const ve=X,U=va(ie.text),oe=U.nodes[ve];if(oe){const $e=xn(ie.text,oe);return{kind:"citation-fragment",expected:oe.text,quoteContext:{title:c,before:$e.before,after:$e.after,total:Object.keys(U.nodes).length,completed:0},quotePlaceholder:oe.text.length>0?".".repeat(Math.max(4,Math.min(18,oe.text.length))):"..."}}}if(te==="question"){const ve=Li(ie);if(ve)return{kind:"question",definition:Ri(ve)}}return{kind:"generic",prompt:E.description||E.label,expected:E.label}},[ee,Q,E,c,R]);n.useEffect(()=>{if(!M||M.kind!=="question")return;const te=M.definition;Be({selection:[],booleanAnswer:null,ordering:te.type==="ordering"?$i(te.options??[]):[],matchingRows:te.type==="matching"?Ai(te):[[]]})},[M,B]);const _=async te=>{if(E&&l)try{await kr({libraryId:d,outcome:{itemType:"info",itemId:E.cardId,checkType:E.checkType??"info",direction:E.direction??null,revisionType:"direct",evalType:"direct-check",correct:te,clientId:"cogita-info-checkcards",clientSequence:L,personRoleId:l}}),A($=>$+1),G(te?"Saved as correct.":"Saved as incorrect.")}catch{G("Failed to save answer.")}},P=E?ia(E):null,k=P?!!Pe[P]:!1,T=async()=>{var ie;if(!E||!M)return;const te=ia(E);if(Pe[te]){G("This card was already checked.");return}let $=!1,X=null;if(M.kind==="question"){const Y=M.definition;if(Y.type==="selection"){const ae=Array.isArray(Y.answer)?[...Y.answer].sort((U,oe)=>U-oe):[],ve=[...Ve.selection].sort((U,oe)=>U-oe);$=ae.length===ve.length&&ae.every((U,oe)=>U===ve[oe])}else if(Y.type==="truefalse")$=typeof Y.answer=="boolean"&&Ve.booleanAnswer!==null&&Y.answer===Ve.booleanAnswer;else if(Y.type==="ordering"){const ae=(Y.options??[]).join(`
`),ve=Ve.ordering.join(`
`),U=Sa(ae,ve,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});$=U.isCorrect,X=U.mask}else if(Y.type==="matching"){const ae=Math.max(2,((ie=Y.columns)==null?void 0:ie.length)??2),ve=Ve.matchingRows.map(qe=>qe.slice(0,ae).map(_e=>_e.trim())).filter(qe=>qe.every(_e=>_e!=="")).map(qe=>qe.map(_e=>Number(_e))).filter(qe=>qe.every(_e=>Number.isInteger(_e)&&_e>=0)).map(qe=>JSON.stringify(qe)),U=(Y.answer&&typeof Y.answer=="object"&&"paths"in Y.answer?Y.answer.paths:[]).map(qe=>JSON.stringify(qe)),oe=Array.from(new Set(ve)).sort(),$e=Array.from(new Set(U)).sort();$=oe.length===$e.length&&oe.every((qe,_e)=>qe===$e[_e])}else{const ae=String(Y.answer??""),ve=Sa(ae,K,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});$=ve.isCorrect,X=ve.mask}Ae(X),ne(!0)}else{const Y=M.expected,ae=M.kind==="citation-fragment",ve=Sa(Y,K,{thresholdPercent:ae?90:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:ae});$=ve.isCorrect,Ae(ve.mask),ne(!0)}W($?"correct":"incorrect"),fe(Y=>Y+1),G(l?null:"Answer checked locally (not saved: no person selected)."),Re(Y=>({...Y,[te]:!0})),l&&await _($)},I=()=>{if(!E||!M)return;const te=ia(E);if(Pe[te]||(Re(X=>({...X,[te]:!0})),G("Answer revealed (not saved).")),M.kind==="question"){Ae(null);return}const $=Sa(M.expected,M.expected,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:M.kind==="citation-fragment"});Ae($.mask)},he=n.useMemo(()=>E?E.infoType==="question"?{...E,description:E.label}:E.infoType==="citation"?{...E,description:c}:{...E,description:E.label}:null,[E,c]),xe=te=>{const $=te.definition,X=k||se,ie=$.type==="matching"?(()=>{var qe;const ve=Math.max(2,((qe=$.columns)==null?void 0:qe.length)??2),oe=(Ve.matchingRows.length?Ve.matchingRows:[new Array(ve).fill("")]).map(_e=>Array.from({length:ve},(Je,bt)=>_e[bt]??""));return oe[oe.length-1].some(_e=>_e.trim())?[...oe,new Array(ve).fill("")]:oe})():[],Y=Array.isArray($.answer)?$.answer:[],ae=$.answer&&typeof $.answer=="object"&&"paths"in $.answer?$.answer.paths:[];return e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:$.question||(E==null?void 0:E.label)}),$.title?e.jsx("p",{className:"cogita-revision-hint",children:$.title}):null,$.type==="selection"?e.jsx("div",{className:"cogita-choice-grid",style:{gridTemplateColumns:"1fr"},children:($.options??[]).map((ve,U)=>e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.6rem"},children:[e.jsx("input",{type:"checkbox",checked:Ve.selection.includes(U),disabled:X,onChange:oe=>Be($e=>({...$e,selection:oe.target.checked?Array.from(new Set([...$e.selection,U])):$e.selection.filter(qe=>qe!==U)}))}),e.jsx("span",{children:ve})]},`q-opt:${U}`))}):null,$.type==="truefalse"?e.jsxs("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:[e.jsx("button",{type:"button",className:"ghost","data-active":Ve.booleanAnswer===!0,disabled:X,onClick:()=>Be(ve=>({...ve,booleanAnswer:!0})),children:"True"}),e.jsx("button",{type:"button",className:"ghost","data-active":Ve.booleanAnswer===!1,disabled:X,onClick:()=>Be(ve=>({...ve,booleanAnswer:!1})),children:"False"})]}):null,$.type==="text"||$.type==="number"||$.type==="date"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:tt,type:$.type==="date"?"date":"text",value:K,onChange:ve=>Z(ve.target.value),disabled:X,"data-state":z==="correct"?"correct":z==="incorrect"?"incorrect":void 0})]}):null,$.type==="ordering"?e.jsx("div",{style:{display:"grid",gap:"0.45rem"},children:Ve.ordering.map((ve,U)=>e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)"},children:[U+1,"."]}),e.jsx("span",{children:ve}),e.jsx("button",{type:"button",className:"ghost",disabled:X||U===0,onClick:()=>Be(oe=>{const $e=[...oe.ordering];return[$e[U-1],$e[U]]=[$e[U],$e[U-1]],{...oe,ordering:$e}}),children:"Up"}),e.jsx("button",{type:"button",className:"ghost",disabled:X||U>=Ve.ordering.length-1,onClick:()=>Be(oe=>{const $e=[...oe.ordering];return[$e[U+1],$e[U]]=[$e[U],$e[U+1]],{...oe,ordering:$e}}),children:"Down"})]},`q-order:${U}:${ve}`))}):null,$.type==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.65rem"},children:[($.columns??[]).map((ve,U)=>e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.35rem",padding:"0.6rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:`Column ${U+1}`}),ve.map((oe,$e)=>e.jsx("div",{className:"cogita-library-hint",children:`${$e}: ${oe}`},`q-col:${U}:${$e}`))]},`q-col:${U}`)),e.jsxs("div",{style:{display:"grid",gap:"0.4rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:"Paths (0-based indices)"}),ie.map((ve,U)=>{var $e;const oe=U===ie.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:`repeat(${Math.max(2,(($e=$.columns)==null?void 0:$e.length)??2)}, minmax(0, 1fr)) auto`,gap:"0.35rem",alignItems:"center"},children:[ve.map((qe,_e)=>e.jsx("input",{type:"number",min:0,step:1,value:qe,disabled:X,onChange:Je=>Be(bt=>{var Ct;const mt=Math.max(2,((Ct=$.columns)==null?void 0:Ct.length)??2),pt=(bt.matchingRows.length?bt.matchingRows:[new Array(mt).fill("")]).map(Ot=>Array.from({length:mt},(Et,Nt)=>Ot[Nt]??""));return pt[U]=pt[U]??new Array(mt).fill(""),pt[U][_e]=Je.target.value,pt[pt.length-1].some(Ot=>Ot.trim())&&pt.push(new Array(mt).fill("")),{...bt,matchingRows:pt}})},`q-path:${U}:${_e}`)),oe?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",disabled:X,onClick:()=>Be(qe=>{var mt;const _e=Math.max(2,((mt=$.columns)==null?void 0:mt.length)??2),Je=qe.matchingRows.filter((pt,jt)=>jt!==U);return Je.length===0&&Je.push(new Array(_e).fill("")),Je[Je.length-1].some(pt=>pt.trim())&&Je.push(new Array(_e).fill("")),{...qe,matchingRows:Je}}),children:"Remove"})]},`q-path:${U}`)})]})]}):null,e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>void T(),disabled:X,children:t.cogita.library.revision.checkAnswer})}),se?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),$.type==="selection"?e.jsx("p",{children:Y.length?Y.map(ve=>{var U;return`${ve}${(U=$.options)!=null&&U[ve]?`: ${$.options[ve]}`:""}`}).join(", "):"-"}):$.type==="truefalse"?e.jsx("p",{children:String(!!$.answer)}):$.type==="ordering"?e.jsx("ol",{children:($.options??[]).map((ve,U)=>e.jsx("li",{children:ve},`ans-order:${U}`))}):$.type==="matching"?e.jsx("div",{style:{display:"grid",gap:"0.35rem"},children:ae.length?ae.map((ve,U)=>e.jsx("p",{children:ve.join(" → ")},`ans-path:${U}`)):e.jsx("p",{children:"-"})}):e.jsx("p",{children:String($.answer??"")})]}):e.jsx("div",{className:"cogita-revision-reveal",children:e.jsx("button",{type:"button",className:"ghost",onClick:()=>{ne(!0),I()},children:t.cogita.library.revision.showAnswer})})]})},ge=n.useMemo(()=>ee?nt(t,ee):t.cogita.library.infoTypes.any,[t,ee]);return e.jsx(Pt,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:ge}),e.jsx("h2",{className:"cogita-card-title",children:c}),e.jsx("p",{className:"cogita-card-subtitle",children:f})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${g.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${F.length}`}),e.jsx("button",{type:"button",className:"cta",disabled:g.length===0,onClick:()=>Ye(`/cogita/library/${d}/revision/run?libraryTarget=revisions&scope=info&infoId=${encodeURIComponent(f)}`),children:"Start revision"})]})]}),y==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):y==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(pn,{nodes:Ie,edges:Xe,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:(te,$)=>p($.id),panOnDrag:!0,children:[e.jsx(fn,{}),e.jsx(bn,{showInteractive:!1})]})}),E?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[M&&he?e.jsx(es,{flashState:z,flashTick:O,children:M.kind==="question"?xe(M):e.jsx(ts,{copy:t,currentCard:he,currentTypeLabel:"",prompt:M.kind==="citation-fragment"?null:M.prompt,languages:[],answer:K,onAnswerChange:Z,computedExpected:[],computedAnswers:et,onComputedAnswerChange:(te,$)=>ct(X=>({...X,[te]:$})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:Ce,feedback:z,canAdvance:!1,quoteContext:M.kind==="citation-fragment"?M.quoteContext:null,quotePlaceholder:M.kind==="citation-fragment"?M.quotePlaceholder:null,onCheckAnswer:()=>void T(),onSkip:()=>p(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:se,setShowCorrectAnswer:ne,onRevealCorrect:I,answerMask:Ne,expectedAnswer:M.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:tt,computedInputRefs:ot,scriptMode:We,setScriptMode:xt,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:k||se,hideSkipAction:!0,allowRevealBeforeCheck:!0,autoRevealAfterAnswer:!0,disableCheckAfterAnswer:!0})}):null,l?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),Le?e.jsx("p",{className:"cogita-library-hint",children:Le}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:g.map(te=>{const $=ia(te),X=B===$;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${X?"active":""}`,onClick:()=>p($),children:[e.jsx("span",{children:te.label}),e.jsx("small",{children:Es(te)})]},$)})})]})]})]})})})})})}function Za(t,a){var r,s;return((s=(r=t.fields.find(i=>i.fieldType===a))==null?void 0:r.plainValue)==null?void 0:s.trim())??""}function Ei(t){return Za(t,"role_kind").toLowerCase()==="person"}function Fi(t){return Za(t,"label")||Za(t,"display_name")||Za(t,"name")||t.roleId}function Ki({copy:t,onPersonCreated:a}){const[r,s]=n.useState([]),[i,o]=n.useState("loading"),[h,v]=n.useState(null),[m,w]=n.useState(!1),[d,f]=n.useState(""),l=async()=>{o("loading");try{const g=await Ws();s(g),o("ready")}catch{s([]),o("error")}};n.useEffect(()=>{l()},[]);const c=n.useMemo(()=>r.filter(Ei).map(g=>({roleId:g.roleId,label:Fi(g)})).sort((g,S)=>g.label.localeCompare(S.label)),[r]),j=async()=>{const g=d.trim();if(!g){v("Name is required.");return}w(!0),v(null);try{const S=await Nr({fields:[{fieldType:"nick",plainValue:g},{fieldType:"role_kind",plainValue:"person"},{fieldType:"label",plainValue:g},{fieldType:"display_name",plainValue:g}]});f(""),v("Person role created."),a==null||a(S.roleId),await l()}catch{v("Failed to create person role.")}finally{w(!1)}};return e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-browser-panel",children:[e.jsx("div",{className:"cogita-info-overview-head",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Cogita"}),e.jsx("h2",{className:"cogita-card-title",children:"Persons"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Select reviewer persons in the header and create new person roles here."})]})}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Create"}),e.jsx("h3",{className:"cogita-detail-title",children:"New person role"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{type:"text",value:d,onChange:g=>f(g.target.value),placeholder:"e.g. Anna Kowalska",disabled:m})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:j,disabled:m,children:m?"Creating...":"Create person"})}),h?e.jsx("p",{className:"cogita-library-hint",children:h}):null]})]}),e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Overview"}),e.jsx("h3",{className:"cogita-detail-title",children:"All person roles"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[i==="loading"?e.jsx("p",{children:"Loading persons..."}):null,i==="error"?e.jsx("p",{children:"Failed to load persons."}):null,i==="ready"&&c.length===0?e.jsx("p",{children:"No person roles found."}):null,i==="ready"&&c.length>0?e.jsxs("div",{className:"cogita-details-grid",children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:"Name"}),e.jsx("span",{children:"Type"}),e.jsx("span",{children:"Role ID"}),e.jsx("span",{})]}),c.map(g=>e.jsxs("div",{className:"cogita-details-row",role:"row",children:[e.jsx("span",{}),e.jsx("span",{title:g.label,children:g.label}),e.jsx("span",{children:"person"}),e.jsx("span",{title:g.roleId,children:g.roleId}),e.jsx("span",{})]},g.roleId))]}):null]})]})]})]})})})})}function _i({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,libraryId:d,collectionId:f}){const{libraryName:l}=da(d),[c,j]=n.useState([]),[g,S]=n.useState("loading"),[F,x]=n.useState("idle"),y=n.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),de=`/#/cogita/library/${d}`,B=()=>{S("loading"),Qs({libraryId:d}).then(N=>{j(N),S("idle")}).catch(()=>{j([]),S("error")})};n.useEffect(()=>{B()},[d]);const p=async N=>{try{await Gs({libraryId:d,shareId:N}),B()}catch{B()}},Q=async N=>{const ee=`${y}/${N}`;try{await navigator.clipboard.writeText(ee),x("copied")}catch{x("failed")}};return e.jsx(Pt,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:de,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${de}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[g==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):g==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):c.filter(N=>!f||N.collectionId===f).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:c.filter(N=>!f||N.collectionId===f).map(N=>e.jsxs("div",{className:"cogita-share-row","data-state":N.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:N.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(N.createdUtc).toLocaleString(),N.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),N.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${y}/${N.shareCode}`}):null]}),N.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[N.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>Q(N.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>p(N.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},N.shareId))}),F==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):F==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function Di({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,libraryId:d}){const{libraryName:f}=da(d),[l,c]=n.useState(null),[j,g]=n.useState(null),[S,F]=n.useState(null),[x,y]=n.useState(null),[de,B]=n.useState(null),[p,Q]=n.useState(null),N=n.useRef(null),ee=me=>{if(!Number.isFinite(me))return"0 B";if(me<1024)return`${me} B`;const K=me/1024;if(K<1024)return`${K.toFixed(1)} KB`;const Z=K/1024;return Z<1024?`${Z.toFixed(1)} MB`:`${(Z/1024).toFixed(1)} GB`},q=async()=>{c(null),B({loadedBytes:0,totalBytes:null,percent:null});try{c(t.cogita.library.overview.exporting);const me=await Sr(d,B),K=URL.createObjectURL(me),Z=document.createElement("a");Z.href=K,Z.download=`cogita-library-${f||d}.json`,Z.click(),URL.revokeObjectURL(K),c(t.cogita.library.overview.exportReady)}catch{c(t.cogita.library.overview.exportFail)}finally{B(me=>me??{loadedBytes:0,totalBytes:null,percent:null})}},R=async me=>{var Z;g(null),F(null),y(null);const K=(Z=me.target.files)==null?void 0:Z[0];if(K)try{g(t.cogita.library.overview.importing),Q({loadedBytes:0,totalBytes:K.size,percent:0});const Le=await Tr(d,K,Q,G=>{const L=G.stage==="infos"?t.cogita.library.overview.importStageInfos:G.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;y(t.cogita.library.overview.importLiveProgress.replace("{stage}",L).replace("{done}",String(G.processed)).replace("{total}",String(G.total)).replace("{infos}",String(G.infos)).replace("{connections}",String(G.connections)).replace("{collections}",String(G.collections)))});F({infos:Le.infosImported,connections:Le.connectionsImported,collections:Le.collectionsImported}),g(t.cogita.library.overview.importDone)}catch(Le){const G=Le instanceof Hs&&Le.message?` ${Le.message}`:"";g(`${t.cogita.library.overview.importFail}${G}`)}finally{N.current&&(N.current.value="")}};return e.jsx(Pt,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:f}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:q,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:N,type:"file",accept:"application/json",onChange:R})]})]}),de?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:de.percent??void 0,max:de.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",ee(de.loadedBytes)).replace("{total}",de.totalBytes?ee(de.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,p?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:p.percent??void 0,max:p.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",ee(p.loadedBytes)).replace("{total}",p.totalBytes?ee(p.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,l?e.jsx("p",{className:"cogita-help",children:l}):null,j?e.jsx("p",{className:"cogita-help",children:j}):null,x?e.jsx("p",{className:"cogita-help",children:x}):null,S?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(S.infos)).replace("{connections}",String(S.connections)).replace("{collections}",String(S.collections))}):null]})]})})})]})})}function Bi({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,libraryId:d}){const{libraryName:f}=da(d),[l,c]=n.useState(""),[j,g]=n.useState([]),S=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Pt,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:f}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:F=>c(F.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const F=l.trim();F&&(g(x=>[{id:S(),name:F},...x]),c(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[j.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,j.map(F=>e.jsx("button",{type:"button",className:"ghost",children:F.name},F.id))]})]})]})})})]})})}function zi({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,libraryId:d}){const{libraryName:f}=da(d),[l,c]=n.useState(""),[j,g]=n.useState([]),S=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx(Pt,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:f}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:F=>c(F.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const F=l.trim();F&&(g(x=>[{id:S(),name:F},...x]),c(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[j.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,j.map(F=>e.jsx("button",{type:"button",className:"ghost",children:F.name},F.id))]})]})]})})})]})})}function Oi({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,libraryId:d}){const{libraryName:f}=da(d),l=`/#/cogita/library/${d}`,[c,j]=n.useState(""),[g,S]=n.useState([]),[F,x]=n.useState("idle"),[y,de]=n.useState(0),[B,p]=n.useState(null);n.useEffect(()=>{x("loading");const N=window.setTimeout(()=>{Va({libraryId:d,query:c.trim()||void 0,limit:30}).then(ee=>{S(ee.items),de(ee.total),p(ee.nextCursor??null),x("ready")}).catch(()=>{S([]),de(0),p(null),x("ready")})},240);return()=>window.clearTimeout(N)},[d,c]);const Q=async()=>{if(B){x("loading");try{const N=await Va({libraryId:d,query:c.trim()||void 0,limit:30,cursor:B});S(ee=>[...ee,...N.items]),p(N.nextCursor??null),de(N.total),x("ready")}catch{x("ready")}}};return e.jsx(Pt,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:f}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${l}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:c,onChange:N=>j(N.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(g.length)).replace("{total}",String(y||g.length))}),e.jsx("span",{children:F==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:g.length?g.map(N=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${l}/collections/${N.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:N.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(N.itemCount))," ·"," ",N.notes||t.cogita.library.collections.noNotes]})]})},N.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${l}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),B?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:Q,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const Se=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,ea=(t,a,r,s)=>`${t}:${a}:${r??""}:${s??""}`;function Vi({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,libraryId:d,collectionId:f}){da(d);const l=`/#/cogita/library/${d}`,[c,j]=n.useState(t.cogita.library.collections.defaultName),[g,S]=n.useState(null),[F,x]=n.useState(0),[y,de]=n.useState([]),[B,p]=n.useState("idle"),[Q,N]=n.useState(null),ee=n.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(y.length)).replace("{total}",String(F||y.length)),[t,y.length,F]);n.useEffect(()=>{yn(d,f).then(R=>{j(R.name),S(R.notes??null),x(R.itemCount)}).catch(()=>{j(t.cogita.library.collections.defaultName),S(null)})},[d,f]),n.useEffect(()=>{p("loading"),qa({libraryId:d,collectionId:f,limit:40}).then(R=>{de(R.items),N(R.nextCursor??null),x(R.total),p("ready")}).catch(()=>{de([]),N(null),p("ready")})},[d,f]);const q=async()=>{if(Q){p("loading");try{const R=await qa({libraryId:d,collectionId:f,limit:40,cursor:Q});de(me=>[...me,...R.items]),N(R.nextCursor??null),x(R.total),p("ready")}catch{p("ready")}}};return e.jsx(Pt,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:g||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${l}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${l}/collections/${f}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${l}/collections/${f}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:ee}),e.jsx("span",{children:B==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:y.length?y.map(R=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:R.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:R.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:R.label}),e.jsx("p",{className:"cogita-card-subtitle",children:R.description})]})},Se(R))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),Q?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:q,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${l}/collections/${f}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const Fs=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],qi={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},Ui=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Ji=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function Hi({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,libraryId:d,onCreated:f}){const l=Ja(),{libraryName:c}=da(d),j=`/#/cogita/library/${d}`,[g,S]=n.useState(null),[F,x]=n.useState(""),[y,de]=n.useState(""),[B,p,Q]=Hn([]),[N,ee,q]=Wn([]),[R,me]=n.useState(null),[K,Z]=n.useState(null),Le=n.useRef(null),G=n.useMemo(()=>B.find(O=>O.id===R)??null,[B,R]);n.useEffect(()=>{const O=new URLSearchParams(l.search),fe=(O.get("draft")??"").trim(),se=(O.get("draftType")??"").trim();if(!fe||se!=="info-selection"||Le.current===fe)return;const ne=hi(d,fe);if(!ne||ne.infoIds.length===0)return;const Ne=crypto.randomUUID(),Ae=ne.infoIds.length>1?crypto.randomUUID():null,Pe=ne.infoIds.map((Ce,We)=>({id:crypto.randomUUID(),type:"default",position:{x:80,y:80+We*100},data:{nodeType:"source.info",label:"Selected info",params:{infoId:Ce,infoType:"any"}}})),Re=Ae?[{id:Ae,type:"default",position:{x:360,y:120+Math.max(0,(ne.infoIds.length-1)*50)},data:{nodeType:"logic.or",label:"Selected infos",params:{}}}]:[],et={id:Ne,type:"default",position:{x:660,y:140+Math.max(0,(ne.infoIds.length-1)*35)},data:{nodeType:"output.collection",label:"Collection output",params:{}}},ct=Pe.map(Ce=>({id:crypto.randomUUID(),source:Ce.id,target:Ae??Ne}));Ae&&ct.push({id:crypto.randomUUID(),source:Ae,target:Ne}),p([...Pe,...Re,et]),ee(ct),me(Ne),Z(`Draft loaded from ${ne.infoIds.length} selected infos. Set name and save to create collection.`),Le.current=fe},[d,l.search,ee,p]);const L=O=>{var Ne;const fe=crypto.randomUUID(),se=((Ne=Fs.find(Ae=>Ae.type===O))==null?void 0:Ne.label)??O,ne={...qi[O]};p(Ae=>[...Ae,{id:fe,type:"default",position:{x:120+Ae.length*40,y:120+Ae.length*40},data:{nodeType:O,label:se,params:ne}}]),me(fe)},A=n.useCallback(O=>{ee(fe=>Qn({...O,id:crypto.randomUUID()},fe))},[ee]),z=O=>{G&&p(fe=>fe.map(se=>se.id===G.id?{...se,data:{...se.data,params:O}}:se))},W=async()=>{if(Z(null),!F.trim()){Z(t.cogita.library.collections.saveRequiredName);return}try{const O={nodes:B.map(ne=>({nodeId:ne.id,nodeType:ne.data.nodeType,payload:{position:ne.position,params:ne.data.params}})),edges:N.map(ne=>({edgeId:ne.id,fromNodeId:ne.source,fromPort:ne.sourceHandle??null,toNodeId:ne.target,toPort:ne.targetHandle??null}))};let fe=g,se=!1;if(fe)await Ys({libraryId:d,collectionId:fe,nodes:O.nodes,edges:O.edges});else{const ne=await Cr({libraryId:d,name:F.trim(),notes:y.trim()||void 0,items:[],graph:O});fe=ne.collectionId,se=!0,S(ne.collectionId)}Z(se?t.cogita.library.collections.saveSuccess:t.cogita.library.graph.saveSuccess),f(fe)}catch{Z(g?t.cogita.library.graph.saveFail:t.cogita.library.collections.saveFail)}};return e.jsx(Pt,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.createKicker}),e.jsx("h1",{className:"cogita-library-title",children:c}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.createSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:j,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${j}/collections`,children:t.cogita.library.actions.collections}),e.jsx("button",{type:"button",className:"cta",onClick:W,children:t.cogita.library.actions.saveCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.collectionInfoTitle}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{value:F,onChange:O=>x(O.target.value),placeholder:t.cogita.library.collections.namePlaceholder})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.notesLabel}),e.jsx("textarea",{value:y,onChange:O=>de(O.target.value),placeholder:t.cogita.library.collections.notesPlaceholder})]}),K?e.jsx("p",{className:"cogita-help",children:K}):null,e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Fs.map(O=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>L(O.type),children:O.label},O.type))})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(pn,{nodes:B,edges:N,onNodesChange:Q,onEdgesChange:q,onConnect:A,onNodeClick:(O,fe)=>me(fe.id),fitView:!0,children:[e.jsx(fn,{color:"rgba(120,160,200,0.2)"}),e.jsx(bn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),G?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:G.data.label}),G.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:d,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:G.data.params.tagId?{id:G.data.params.tagId,label:G.data.params.tagLabel??"",infoType:"topic"}:null,onChange:O=>z({...G.data.params,tagId:(O==null?void 0:O.id)??null,tagLabel:(O==null?void 0:O.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:G.data.params.scope??"any",onChange:O=>z({...G.data.params,scope:O.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),G.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:d,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:G.data.params.languageId?{id:G.data.params.languageId,label:G.data.params.languageLabel??"",infoType:"language"}:null,onChange:O=>z({...G.data.params,languageId:(O==null?void 0:O.id)??null,languageLabel:(O==null?void 0:O.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:G.data.params.scope??"any",onChange:O=>z({...G.data.params,scope:O.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),G.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:G.data.params.infoType??"word",onChange:O=>z({...G.data.params,infoType:O.target.value}),children:Ji.map(O=>e.jsx("option",{value:O.value,children:O.label},O.value))})]}),e.jsx(Yt,{libraryId:d,infoType:G.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:G.data.params.infoId?{id:G.data.params.infoId,label:G.data.params.infoLabel??"",infoType:G.data.params.infoType??"word"}:null,onChange:O=>z({...G.data.params,infoId:(O==null?void 0:O.id)??null,infoLabel:(O==null?void 0:O.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),G.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:G.data.params.connectionType??"translation",onChange:O=>z({...G.data.params,connectionType:O.target.value}),children:Ui.map(O=>e.jsx("option",{value:O.value,children:O.label},O.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:G.data.params.connectionId??"",onChange:O=>z({...G.data.params,connectionId:O.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(G.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const la=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const a=t.length,r=t.filter(o=>o.correct).length,s=vn(as(t));return{score:Math.round(Math.max(0,Math.min(100,s.knowness*100))*100)/100,total:a,correct:r,lastReviewedUtc:s.lastReviewedUtc??null}},Wi=t=>{if(t.maskBase64)try{const a=Ir(t.maskBase64);if(!a.length)return t.correct?1:0;const r=a.reduce((s,i)=>s+i,0);return Math.max(0,Math.min(1,r/a.length/255))}catch{return t.correct?1:0}return t.correct?1:0},as=t=>t.map(a=>({correctness:Wi(a),createdUtc:a.createdUtc})),vn=(t,a=Date.now())=>{var F;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const s=t.slice().sort((x,y)=>x.createdUtc.localeCompare(y.createdUtc)).slice(-5),i=s.reduce((x,y)=>x+y.correctness,0)/s.length,o=5,h=2,v=.15;let m=0,w=0;for(let x=0;x<s.length;x+=1){const y=new Date(s[x].createdUtc).getTime(),de=x===s.length-1?a:new Date(s[x+1].createdUtc).getTime(),B=Math.max(0,(de-y)/(1e3*60)),p=1-Math.exp(-B/o);m+=p,s[x].correctness>.5&&(w+=v)}let d=i*m*h+w;const f=((F=s[s.length-1])==null?void 0:F.createdUtc)??null,l=f?Math.max(0,(a-new Date(f).getTime())/(1e3*60)):0,j=1/(1+Math.log1p(l/60));return d*=j,s.length===1&&s[0].correctness>.5&&(d+=5.44*Math.exp(-l/2)),{knowness:d,avgCorrectness:i,lastReviewedUtc:f}},Ua=t=>{const a=t.slice();for(let r=a.length-1;r>0;r-=1){const s=Math.floor(Math.random()*(r+1));[a[r],a[s]]=[a[s],a[r]]}return a},en=t=>t[Math.floor(Math.random()*t.length)],Qi=(t,a)=>{const r=new Map;return t.forEach(s=>r.set(s,Math.random())),t.sort((s,i)=>{const o=a(s)-a(i);return o!==0?o:(r.get(s)??0)-(r.get(i)??0)})},wn=(t,a,r,s,i)=>{if(!t.length)return null;const o=t.filter(v=>!(i!=null&&i.has(Se(v))));if(o.length===0)return null;const h=o.filter(v=>Se(v)!==r);return en(h.length?h:o)},Gi=(t,a,r,s,i)=>{if(!t.length)return null;let o=Number.POSITIVE_INFINITY;for(const w of t){const d=Se(w);if(r.has(d))continue;const f=a[d]??1;f<o&&(o=f)}if(!Number.isFinite(o))return null;const h=t.filter(w=>{const d=Se(w);return!r.has(d)&&(a[d]??1)===o}),v=h.filter(w=>!i||Se(w)!==i),m=s?v.filter(w=>!s.has(Se(w))):v;return m.length>0?en(m):v.length>0?en(v):i&&h.some(w=>Se(w)===i)?h.find(w=>Se(w)===i)??null:h.length?en(h):null},nr=(t,a,r,s,i)=>{const o=[],h=t.filter(m=>!i.has(Se(m))&&!r.has(Se(m))&&(a[Se(m)]??0)<1),v=Qi(h,m=>a[Se(m)]??0);for(const m of v){if(o.length>=s)break;o.push(m),i.add(Se(m))}if(o.length<s){const m=Ua(t.filter(w=>!i.has(Se(w))&&r.has(Se(w))));for(const w of m){if(o.length>=s)break;o.push(w),i.add(Se(w))}}return o},Yi=(t,a,r,s)=>nr(t,a,r,s,new Set),ns=(t,a,r,s,i,o)=>{const h=Math.max(1,r.stackSize??a),m=Ua(t).filter((j,g,S)=>S.findIndex(F=>Se(F)===Se(j))===g),w=Yi(m,s,i,h),d=new Set,f=new Set,l=wn(w,{},null,d,f),c=l?[l]:[];return l&&f.add(Se(l)),{queue:c,meta:{pool:m,active:w,knownessMap:s,unknownSet:i,outcomesById:o,asked:d,queued:f}}},Jn={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,a)=>{const s=Ua(t).filter((i,o,h)=>h.findIndex(v=>Se(v)===Se(i))===o);return{queue:s.slice(0,Math.min(a,s.length)),meta:{}}},applyOutcome:t=>t},ss=(t,a,r,s)=>{const i=Math.max(1,r.stackSize??a),h=Ua(t).filter((g,S,F)=>F.findIndex(x=>Se(x)===Se(g))===S),v={},m=new Set,w=new Set,d=new Set,f=Math.max(1,r.levels??1);h.forEach(g=>{const S=Se(g),F=s==null?void 0:s[S],x=typeof F=="number"&&Number.isFinite(F)?F:1;v[S]=Math.min(f,Math.max(1,Math.round(x)))});const l=[];if(h.length>0){const g=new Map;h.forEach(F=>{var y;const x=v[Se(F)]??1;g.has(x)||g.set(x,[]),(y=g.get(x))==null||y.push(F)});const S=Array.from(g.keys()).sort((F,x)=>F-x);for(const F of S){if(l.length>=i)break;const x=Ua(g.get(F)??[]);for(const y of x){if(l.length>=i)break;l.push(y)}}}const c=wn(l,v,null,m,w),j=c?[c]:[];return c&&w.add(Se(c)),{queue:j,meta:{pool:h,active:l,levelMap:v,asked:m,queued:w,wrongSinceCorrect:d}}},Xi={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,a)=>Math.max(1,a.stackSize??t),getProgressTotal:()=>null,prepare:(t,a,r)=>ss(t,a,r),applyOutcome:(t,a,r,s,i)=>{if(!a)return t;const o=Math.max(1,s.levels??1),h=t.meta.pool??[],v=t.meta.active??[],m={...t.meta.levelMap??{}},w=new Set(t.meta.asked??[]),d=new Set(t.meta.queued??[]),f=new Set(t.meta.wrongSinceCorrect??[]),l=Se(a);d.delete(l),w.add(l);const c=m[l]??1;i.correct?(m[l]=f.has(l)?1:Math.min(c+1,o),f.delete(l)):(m[l]=1,f.add(l));const j=i.correct?v.filter(F=>Se(F)!==l):v.slice();if(i.correct&&j.length<Math.max(1,s.stackSize??1)){const F=new Set(j.map(y=>Se(y))),x=Gi(h,m,F,w,l);x&&j.push(x)}const g=t.queue.slice(),S=wn(j,m,l,w,d);return S&&(g.push(S),d.add(Se(S))),{queue:g,meta:{pool:h,active:j,levelMap:m,asked:w,queued:d,wrongSinceCorrect:f}}}},Zi={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,a)=>Math.max(1,a.stackSize??t),getProgressTotal:()=>null,prepare:(t,a,r)=>ns(t,a,r,{},new Set,{}),applyOutcome:(t,a,r,s,i)=>{if(!a)return t;const o=t.meta.pool??[],h=t.meta.active??[],v={...t.meta.knownessMap??{}},m=new Set(t.meta.unknownSet??[]),w={...t.meta.outcomesById??{}},d=new Set(t.meta.asked??[]),f=new Set(t.meta.queued??[]),l=Se(a);f.delete(l),d.add(l);const c={correctness:Math.max(0,Math.min(1,i.correctness??(i.correct?1:0))),createdUtc:i.createdUtc??new Date().toISOString()},g=(w[l]??[]).concat(c).sort((B,p)=>B.createdUtc.localeCompare(p.createdUtc)).slice(-5);w[l]=g,m.delete(l);const S=Date.now();o.forEach(B=>{const p=Se(B),Q=w[p]??[];if(Q.length===0){v[p]=0,m.add(p);return}const N=vn(Q,S);v[p]=N.knowness});const F=h.slice();if((v[l]??0)>=1){const B=F.filter(p=>Se(p)!==l);F.length=0,F.push(...B)}const y=Math.max(1,s.stackSize??r);if(F.length<y){const B=new Set(F.map(Q=>Se(Q))),p=nr(o,v,m,y-F.length,B);F.push(...p)}const de=t.queue.slice();if(de.length===0||Se(de[de.length-1])===l){const B=wn(F,{},l,d,f);B&&(de.push(B),f.add(Se(B)))}return{queue:de,meta:{pool:o,active:F,knownessMap:v,unknownSet:m,outcomesById:w,asked:d,queued:f}}}},sr={random:Jn,levels:Xi,temporal:Zi},eo=Object.values(sr),rs=t=>{if(!t)return Jn;const a=t.trim().toLowerCase();return a==="random"||a==="levels"||a==="temporal"?sr[a]:Jn},jn=(t,a)=>{const r={...t.defaultSettings};return a&&Object.entries(a).forEach(([s,i])=>{typeof i=="number"&&Number.isFinite(i)&&(r[s]=i),typeof i=="string"&&(r[s]=i)}),t.settingsFields.forEach(s=>{var o;const i=r[s.key];if(s.type==="number"){if(typeof i!="number"||Number.isNaN(i)){r[s.key]=t.defaultSettings[s.key]??0;return}s.min!==void 0&&(r[s.key]=Math.max(s.min,r[s.key])),s.max!==void 0&&(r[s.key]=Math.min(s.max,r[s.key]));return}if(s.type==="select"){const h=((o=s.options)==null?void 0:o.map(v=>v.value))??[];(typeof i!="string"||h.length>0&&!h.includes(i))&&(r[s.key]=t.defaultSettings[s.key]??h[0]??"")}}),r},rr=(t,a)=>{const r={};return t.settingsFields.forEach(s=>{const i=a.get(s.key);if(i){if(s.type==="number"){const o=Number(i);Number.isNaN(o)||(r[s.key]=o);return}r[s.key]=i}}),jn(t,r)},to=(t,a)=>{const r=new URLSearchParams;return t.settingsFields.forEach(s=>{const i=a[s.key];(typeof i=="number"||typeof i=="string")&&r.set(s.key,String(i))}),r};function Ks({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,libraryId:d,collectionId:f,revisionId:l}){const c=mn(),{libraryName:j}=da(d),g=`/#/cogita/library/${d}`,[S,F]=n.useState(t.cogita.library.collections.defaultName),[x,y]=n.useState([]),[de,B]=n.useState(f??""),[p,Q]=n.useState(""),[N,ee]=n.useState(20),[q,R]=n.useState("random"),[me,K]=n.useState({}),[Z,Le]=n.useState("exact"),[G,L]=n.useState([]),[A,z]=n.useState(null),[W,O]=n.useState([]),[fe,se]=n.useState([]),[ne,Ne]=n.useState(""),[Ae,Pe]=n.useState("idle"),[Re,et]=n.useState(null),[ct,Ce]=n.useState("idle"),[We,xt]=n.useState("idle"),[Ve,Be]=n.useState("idle"),tt=n.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),ot=n.useMemo(()=>rs(q),[q]),Ye=n.useMemo(()=>jn(ot,me),[ot,me]),Ie=n.useMemo(()=>to(ot,Ye).toString(),[ot,Ye]),ze=n.useMemo(()=>{const k=ne.trim().toLocaleLowerCase();return k?fe.filter(T=>T.name.toLocaleLowerCase().includes(k)):fe},[ne,fe]);n.useEffect(()=>{B(f??"")},[f]),n.useEffect(()=>{if(!de){F(t.cogita.library.collections.defaultName);return}yn(d,de).then(k=>F(k.name)).catch(()=>F(t.cogita.library.collections.defaultName))},[t.cogita.library.collections.defaultName,d,de]),n.useEffect(()=>{Va({libraryId:d,limit:200}).then(k=>y(k.items.map(T=>({collectionId:T.collectionId,name:T.name})))).catch(()=>y([]))},[d]),n.useEffect(()=>{Gn({libraryId:d}).then(k=>se(k)).catch(()=>se([]))},[d]),n.useEffect(()=>{l&&Zn({libraryId:d,revisionId:l}).then(k=>{B(k.collectionId),Q(k.name),R(k.mode||"random"),Le(k.check||"exact"),ee(k.limit||20),K(k.revisionSettings??{})}).catch(()=>{Q("")})},[d,l]),n.useEffect(()=>{Xs({libraryId:d}).then(k=>{L(k),!A&&k.length>0&&z(k[0].roleId)}).catch(()=>{L([])})},[d]);const Xe=()=>{xt("loading"),Qs({libraryId:d}).then(k=>{O(k),xt("idle")}).catch(()=>{O([]),xt("error")})};n.useEffect(()=>{Xe()},[d]);const E=async()=>{Pe("working"),Ce("idle");try{if(!de){Pe("error");return}const k=await Lr({libraryId:d,collectionId:de,revisionType:ot.id,revisionSettings:Ye,mode:q,check:Z,limit:N});et(`${tt}/${k.shareCode}${Ie?`?${Ie}`:""}`),Pe("ready"),Xe()}catch{Pe("error")}},M=async()=>{if(l){Be("saving");try{await Mr({libraryId:d,collectionId:f??de,revisionId:l,targetCollectionId:de,name:p||S,revisionType:ot.id,revisionSettings:Ye,mode:q,check:Z,limit:N}),Be("saved"),de&&c(`/cogita/library/${d}/revisions/${encodeURIComponent(l)}`,{replace:!0})}catch{Be("error")}}},_=async()=>{if(Re)try{await navigator.clipboard.writeText(Re),Ce("copied")}catch{Ce("failed")}},P=async k=>{try{await Gs({libraryId:d,shareId:k}),Xe()}catch{Xe()}};return e.jsx(Pt,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:S}),e.jsx("p",{className:"cogita-library-subtitle",children:j})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:g,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${g}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:de?`${g}/collections/${de}`:`${g}/collections`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${g}${l?`/revisions/${encodeURIComponent(l)}/run`:de?`/collections/${de}/revision/run`:"/revision/run"}?mode=${encodeURIComponent(q)}&check=${encodeURIComponent(Z)}&limit=${N}${Ie?`&${Ie}`:""}${A?`&reviewer=${encodeURIComponent(A)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:ne,onChange:k=>Ne(k.target.value),placeholder:t.cogita.workspace.revisionForm.namePlaceholder})}),e.jsxs("div",{className:"cogita-card-list","data-view":"list",children:[e.jsxs("a",{className:"cogita-card-select",href:`${g}/revisions/new`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:t.cogita.workspace.revisionForm.createAction})]}),ze.map(k=>e.jsxs("a",{className:"cogita-card-select",href:`${g}/revisions/${encodeURIComponent(k.revisionId)}`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:k.name})]},k.revisionId))]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsx("select",{value:de,onChange:k=>B(k.target.value),children:x.map(k=>e.jsx("option",{value:k.collectionId,children:k.name},k.collectionId))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:p,onChange:k=>Q(k.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:q,onChange:k=>R(k.target.value),children:eo.map(k=>e.jsx("option",{value:k.id,children:t.cogita.library.revision[k.labelKey]},k.id))})]}),ot.settingsFields.map(k=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[k.labelKey]}),k.type==="select"?e.jsx("select",{value:String(Ye[k.key]??""),onChange:T=>K(I=>({...I,[k.key]:T.target.value})),children:(k.options??[]).map(T=>e.jsx("option",{value:T.value,children:t.cogita.library.revision[T.labelKey]},T.value))}):e.jsx("input",{type:"number",min:k.min,max:k.max,step:k.step,value:Ye[k.key]??0,onChange:T=>K(I=>({...I,[k.key]:Number(T.target.value||0)}))})]},k.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),ot.id!=="levels"&&ot.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:N,onChange:k=>ee(Number(k.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:A??"",onChange:k=>z(k.target.value||null),children:G.map(k=>e.jsx("option",{value:k.roleId,children:k.label},k.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[l?e.jsx("button",{type:"button",className:"cta ghost",onClick:M,disabled:Ve==="saving",children:Ve==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${g}${l?`/revisions/${encodeURIComponent(l)}/run`:de?`/collections/${de}/revision/run`:"/revision/run"}?mode=${encodeURIComponent(q)}&check=${encodeURIComponent(Z)}&limit=${N}${Ie?`&${Ie}`:""}${A?`&reviewer=${encodeURIComponent(A)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision}),l?e.jsx("a",{className:"cta ghost",href:`/#/cogita/live-revision-host/${encodeURIComponent(d)}/${encodeURIComponent(l)}`,children:"Live session"}):null]}),Ve==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),Re?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:Re,readOnly:!0})]}):null,Ae==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,ct==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):ct==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:E,disabled:Ae==="working",children:Ae==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),Re?e.jsx("button",{type:"button",className:"cta ghost",onClick:_,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),We==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):W.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:W.map(k=>e.jsxs("div",{className:"cogita-share-row","data-state":k.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:k.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(k.createdUtc).toLocaleString(),k.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),k.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>P(k.shareId),children:t.cogita.library.revision.shareRevokeAction})]},k.shareId))})]})]})]})]})})})]})})}const Fn=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function ir(t,a,r){if(!t)return null;const s=new Map(t.nodes.map(B=>[B.id,B])),i=new Map,o=new Set,h=B=>{if(typeof B=="number")return B;if(typeof B=="string"){const p=Number(B);return Number.isFinite(p)?p:0}return 0},v=B=>{if(i.has(B))return i.get(B);if(o.has(B))return 0;const p=s.get(B);if(!p)return 0;o.add(B);const Q=ee=>{var R,me;return(ee?((R=p.inputsByHandle)==null?void 0:R[ee])??[]:p.inputs??((me=p.inputsByHandle)==null?void 0:me.in)??[]).map(K=>v(K))};let N=0;switch(p.type){case"input.random":{const ee=p.min??0,q=p.max??ee+10,R=Math.min(ee,q),me=Math.max(ee,q);N=Math.floor(Math.random()*(me-R+1))+R;break}case"input.const":{N=p.value??0;break}case"input.list":{const ee=(p.list??[]).filter(Boolean),q=Math.round(h(Q("index")[0]));N=ee.length?ee[Math.max(0,Math.min(ee.length-1,q))]:String(q);break}case"compute.add":{N=Q("in").map(q=>h(q)).reduce((q,R)=>q+R,0);break}case"compute.sub":{const ee=Q("add").map(R=>h(R)),q=Q("sub").map(R=>h(R));N=ee.reduce((R,me)=>R+me,0)-q.reduce((R,me)=>R+me,0);break}case"compute.mul":{const ee=Q("in").map(q=>h(q));N=ee.length?ee.reduce((q,R)=>q*R,1):0;break}case"compute.div":{const ee=h(Q("num")[0]),q=Q("den").map(R=>h(R)).reduce((R,me)=>R+me,0);N=Math.abs(q)<Number.EPSILON?0:ee/q;break}case"compute.pow":{const ee=h(Q("base")[0]),q=h(Q("exp")[0]);N=Math.pow(ee,q);break}case"compute.exp":{const ee=h(Q("base")[0]),q=h(Q("exp")[0]);N=Math.pow(ee,q);break}case"compute.log":{const ee=h(Q("value")[0]),q=h(Q("base")[0]),R=Math.max(ee,Number.EPSILON);N=Math.abs(q)<Number.EPSILON?Math.log(R):Math.log(R)/Math.log(q);break}case"compute.abs":{N=Math.abs(h(Q("in")[0]));break}case"compute.min":{const ee=Q("in").map(q=>h(q));N=ee.length?Math.min(...ee):0;break}case"compute.max":{const ee=Q("in").map(q=>h(q));N=ee.length?Math.max(...ee):0;break}case"compute.floor":{N=Math.floor(h(Q("in")[0]));break}case"compute.ceil":{N=Math.ceil(h(Q("in")[0]));break}case"compute.round":{N=Math.round(h(Q("in")[0]));break}case"compute.mod":{const ee=h(Q("a")[0]),q=h(Q("b")[0]);N=Math.abs(q)<Number.EPSILON?0:ee%q;break}case"compute.concat":{const q=["in1","in2","in3","in4","in5","in6"].flatMap(Z=>Q(Z)),R=q.length?q:Q("in");N=(R.length?R:Q()).map(Z=>Z==null?"":String(Z)).join("");break}case"compute.trim":{const ee=Q("text")[0]??Q("in")[0]??"",q=ee==null?"":String(ee),R=Math.max(0,Math.round(h(Q("start")[0]))),me=Math.max(0,Math.round(h(Q("end")[0])));R+me>=q.length?N="":N=q.substring(R,q.length-me);break}case"output":{N=Q("in")[0]??0;break}default:N=0}return o.delete(B),i.set(B,N),N},m=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(B=>B.type==="output").map(B=>B.id);t.nodes.forEach(B=>v(B.id)),m.forEach(B=>v(B));const w=B=>Math.abs(B%1)<1e-5?String(Math.round(B)):B.toFixed(3).replace(/\.?0+$/,""),d=B=>typeof B=="number"?w(B):B??"",f=new Map;m.forEach(B=>{var q,R,me,K;const p=s.get(B);if(!p)return;const Q=(R=(q=p.inputsByHandle)==null?void 0:q.name)==null?void 0:R[0],N=Q?d(i.get(Q)):"",ee=(N==null?void 0:N.toString().trim())||((me=p.outputLabel)==null?void 0:me.trim())||((K=p.name)==null?void 0:K.trim())||B;f.set(B,ee)});const l={},c={},j={};m.forEach(B=>{var N,ee;const p=s.get(B);if(!p)return;const Q=f.get(B)??(((N=p.outputLabel)==null?void 0:N.trim())||((ee=p.name)==null?void 0:ee.trim())||B);l[Q]=d(i.get(B)),p.name&&(c[p.name.trim()]=Q),c[B]=Q});const g=(B,p)=>{let Q=B;return t.nodes.forEach(N=>{var K,Z;const ee=d(i.get(N.id)),q=m.includes(N.id),R=q?f.get(N.id)??((K=N.outputLabel)==null?void 0:K.trim())??((Z=N.name)==null?void 0:Z.trim())??N.id:"",me=q&&p?R:ee;Q=Q.replace(new RegExp(`\\{\\s*${Fn(N.id)}\\s*\\}`,"gi"),me),N.name&&(Q=Q.replace(new RegExp(`\\{\\s*${Fn(N.name)}\\s*\\}`,"gi"),me)),q&&N.outputLabel&&(Q=Q.replace(new RegExp(`\\{\\s*${Fn(N.outputLabel)}\\s*\\}`,"gi"),R))}),Q},S=a;let F=S.trim().length>0?S:"";F||(F=m.length?`Compute ${m.join(", ")}`:"Compute"),F=g(F,!0);const x=(r==null?void 0:r.trim())??"",y=x?g(x,!1):"",de={};return i.forEach((B,p)=>{de[p]=B,j[p]=d(B);const Q=s.get(p);Q!=null&&Q.name&&(j[Q.name.trim()]=d(B))}),{prompt:F,answers:l,values:de,answerText:y,outputVariables:c,variableValues:j}}function or(t){var r;const a=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((r=a[0])==null?void 0:r[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const Kn=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function lr({outcomes:t}){const[a,r]=n.useState("day"),s=n.useMemo(()=>{const i=Kn.find(v=>v.id===a)??Kn[1],o=Date.now()-i.ms,h=t.filter(v=>new Date(v.createdUtc).getTime()>=o);return la(h)},[t,a]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:Kn.map(i=>e.jsx("button",{type:"button",className:"ghost","data-active":a===i.id,onClick:()=>r(i.id),children:i.label},i.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[s.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[s.correct," / ",s.total]})]})}const ao="cogita-revision",no=1,on="outcomes",so=()=>new Promise((t,a)=>{const r=indexedDB.open(ao,no);r.onupgradeneeded=()=>{const s=r.result;if(!s.objectStoreNames.contains(on)){const i=s.createObjectStore(on,{keyPath:"id"});i.createIndex("byItem","itemKey",{unique:!1}),i.createIndex("byPending","pending",{unique:!1})}},r.onerror=()=>a(r.error),r.onsuccess=()=>t(r.result)}),Ha=async(t,a)=>{const r=await so();return new Promise((s,i)=>{const o=r.transaction(on,t),h=o.objectStore(on);a(h).then(s).catch(i),o.onerror=()=>i(o.error)})},cr=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const a=Array.from(t).map(r=>r.toString(16).padStart(2,"0"));return`${a.slice(0,4).join("")}-${a.slice(4,6).join("")}-${a.slice(6,8).join("")}-${a.slice(8,10).join("")}-${a.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},ro=()=>{const t="cogita_revision_client_id",a=localStorage.getItem(t);if(a)return a;const r=cr();return localStorage.setItem(t,r),r},io=()=>{const t="cogita_revision_client_seq",a=Number(localStorage.getItem(t)??"0"),r=Number.isFinite(a)?a+1:1;return localStorage.setItem(t,String(r)),r},dr=(t,a,r,s)=>ea(t,a,r,s),ln=async t=>{const a=ro(),r=io(),s=new Date().toISOString(),i={...t,clientId:a,clientSequence:r,createdUtc:s,id:cr(),pending:!0};return await Ha("readwrite",o=>new Promise((h,v)=>{const m={...i,itemKey:dr(i.itemType,i.itemId,i.checkType,i.direction)},w=o.add(m);w.onsuccess=()=>h(),w.onerror=()=>v(w.error)})),i},cn=async(t,a,r,s)=>{if(!a)return[];try{const i=dr(t,a,r,s);return await Ha("readonly",o=>new Promise((h,v)=>{const w=o.index("byItem").getAll(i);w.onsuccess=()=>{const f=(w.result??[]).map(l=>({itemType:l.itemType,itemId:l.itemId,checkType:l.checkType??null,direction:l.direction??null,revisionType:l.revisionType,evalType:l.evalType,correct:l.correct,createdUtc:l.createdUtc,maskBase64:l.maskBase64,payloadBase64:l.payloadBase64,payloadHashBase64:l.payloadHashBase64,clientId:l.clientId,clientSequence:l.clientSequence,personRoleId:l.personRoleId??null})).sort((l,c)=>l.createdUtc.localeCompare(c.createdUtc));h(f)},w.onerror=()=>v(w.error)}))}catch{return[]}},ca=async()=>{try{return await Ha("readonly",t=>new Promise((a,r)=>{const s=t.getAll();s.onsuccess=()=>{const o=(s.result??[]).map(h=>({itemType:h.itemType,itemId:h.itemId,checkType:h.checkType??null,direction:h.direction??null,revisionType:h.revisionType,evalType:h.evalType,correct:h.correct,createdUtc:h.createdUtc,maskBase64:h.maskBase64,payloadBase64:h.payloadBase64,payloadHashBase64:h.payloadHashBase64,clientId:h.clientId,clientSequence:h.clientSequence,personRoleId:h.personRoleId??null}));a(o)},s.onerror=()=>r(s.error)}))}catch{return[]}},oo=async(t=100)=>{try{return await Ha("readonly",a=>new Promise((r,s)=>{const o=a.index("byPending").getAll(!0);o.onsuccess=()=>{const h=o.result??[];r(h.slice(0,t))},o.onerror=()=>s(o.error)}))}catch{return[]}},lo=async t=>{if(t.length!==0)try{await Ha("readwrite",a=>new Promise((r,s)=>{let i=t.length;t.forEach(o=>{const h=a.get(o);h.onsuccess=()=>{const v=h.result;if(v){v.pending=!1;const m=a.put(v);m.onsuccess=()=>{i-=1,i===0&&r()},m.onerror=()=>s(m.error)}else i-=1,i===0&&r()},h.onerror=()=>s(h.error)})}))}catch{}},_n=async(t,a)=>{const r=await oo(200);if(r.length===0)return;const s=new Map;r.forEach(i=>{var h;const o=i.personRoleId??a??"";s.has(o)||s.set(o,[]),(h=s.get(o))==null||h.push(i)});for(const[i,o]of s.entries()){const h=o.map(v=>({itemType:v.itemType,itemId:v.itemId,checkType:v.checkType??null,direction:v.direction??null,revisionType:v.revisionType,evalType:v.evalType,correct:v.correct,clientId:v.clientId,clientSequence:v.clientSequence,maskBase64:v.maskBase64??null,payloadHashBase64:v.payloadHashBase64??null,payloadBase64:v.payloadBase64??null,personRoleId:i||null}));try{await Ar({libraryId:t,outcomes:h}),await lo(o.map(v=>v.id))}catch{}}},Dt=t=>t.trim().toLowerCase(),Wt=t=>{const a=t==null?void 0:t.trim();return a?{fragmentId:a}:null},dn=(t,a)=>{const r=Wt(a);if(!r)return!0;const s=Wt(t);return(s==null?void 0:s.fragmentId)===r.fragmentId},Tt=t=>{const a=t==null?void 0:t.trim().toLowerCase();return a||null},ur=(t,a)=>{if((Tt(t.childItemType)??"info")!==(a.cardType??"").toLowerCase()||t.childItemId!==a.cardId)return!1;const s=Tt(t.childCheckType),i=Tt(t.childDirection),o=Tt(a.checkType),h=Tt(a.direction);return!(s&&s!==o||i&&i!==h)},co={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},uo={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},un=(t,a,r)=>{if(!r||!a.startsWith(t))return a;const s=a.slice(t.length);if(!s)return a;const i=r==="super"?co:uo,o=s.split("").map(h=>i[h]??h).join("");return t+o},hn=(t,a,r)=>{var h,v,m;if(!t)return((h=a[0])==null?void 0:h.key)??null;const s=new Set(a.map(w=>w.key)),i=/\{([^}]+)\}/g;let o;for(;(o=i.exec(t))!==null;){const w=((v=o[1])==null?void 0:v.trim())??"";if(!w)continue;if(s.has(w))return w;const d=r==null?void 0:r[w];if(d&&s.has(d))return d}return((m=a[0])==null?void 0:m.key)??null},Oa=t=>(()=>{const a=new Set;return t.flatMap(r=>{if(r.cardType!=="info"||r.infoType!=="citation")return[r];const s=r.description??"";if(!s.trim())return[r];const i=va(s),o=Object.keys(i.nodes);return o.length===0?[r]:o.map(h=>({...r,checkType:"quote-fragment",direction:h})).filter(h=>{const v=[h.cardId,h.checkType??"",h.direction??""].join("|");return a.has(v)?!1:(a.add(v),!0)})})})();function Dn({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,libraryId:d,collectionId:f,revisionId:l}){const c=Ja(),j=`/#/cogita/library/${d}`,g=n.useMemo(()=>new URLSearchParams(c.search),[c.search]),S=Math.max(1,Number(g.get("limit")??20)),F=g.get("mode")??"random",x=n.useMemo(()=>rs(F),[F]),y=n.useMemo(()=>jn(x,rr(x,g)),[x,g]),de=g.get("check")??"exact",B=g.get("reviewer"),p=(g.get("scope")??"").trim(),Q=p==="info"||p==="info-selection"?p:"collection",N=Q==="info"?(g.get("infoId")??"").trim():"",ee=Q==="info-selection"?(g.get("seed")??"").trim():"",[q,R]=n.useState(null),me=f??q??void 0,K=Q==="collection"&&!!me,Z=n.useMemo(()=>t.cogita.library.revision[x.labelKey]??F,[t,F,x]),Le=n.useMemo(()=>de==="exact"?t.cogita.library.revision.checkValue:de,[t,de]),[G,L]=n.useState(t.cogita.library.collections.defaultName),[A,z]=n.useState([]),[W,O]=n.useState([]),[fe,se]=n.useState("idle"),[ne,Ne]=n.useState({current:0,total:0}),[Ae,Pe]=n.useState(0),[Re,et]=n.useState(""),[ct,Ce]=n.useState(null),[We,xt]=n.useState(null),[Ve,Be]=n.useState(null),[tt,ot]=n.useState(null),[Ye,Ie]=n.useState([]),[ze,Xe]=n.useState({}),[E,M]=n.useState({}),[_,P]=n.useState(null),[k,T]=n.useState(null),[I,he]=n.useState(null),[xe,ge]=n.useState(null),[te,$]=n.useState(null),[X,ie]=n.useState({}),Y=n.useRef(0),[ae,ve]=n.useState(null),U=n.useRef(null),oe=n.useRef(null),[$e,qe]=n.useState(null),[_e,Je]=n.useState(!1),[bt,mt]=n.useState(null),[pt,jt]=n.useState([]),[Ct,Ot]=n.useState(null),Et=n.useRef(null),Nt=n.useRef(null),[ua,Lt]=n.useState(null),[vt,St]=n.useState(0),kt=n.useRef(null),yt=n.useRef({}),[Kt,st]=n.useState(!1),[Ue,ft]=n.useState({}),[Qt,Vt]=n.useState([]),Bt=n.useRef(new Map),[pe,$t]=n.useState(new Set),[Xt,qt]=n.useState(!1),V=n.useRef(null),u=n.useRef(new Set),le=n.useRef({});n.useEffect(()=>{if(!l||f){R(null);return}Zn({libraryId:d,revisionId:l}).then(b=>R(b.collectionId)).catch(()=>R(null))},[f,d,l]);const H=A[Ae]??null,Qe=(H==null?void 0:H.checkType)==="translation-match"&&te,rt=n.useRef(new Map),lt=n.useRef(new Map),It=n.useRef(new Map),Mt=n.useRef(new Map),wt=n.useMemo(()=>H?H.cardType==="vocab"?t.cogita.library.revision.vocabLabel:H.infoType?nt(t,H.infoType):t.cogita.library.revision.infoLabel:"",[t,H]),At=n.useMemo(()=>{var C;return x.id!=="levels"?A.length:((C=Ue.pool)==null?void 0:C.length)??x.getFetchLimit(S,y)},[Ue,y,x,A.length,S]),ha=x.getProgressTotal?x.getProgressTotal(A,Ue,S,y):x.id==="levels"?Math.min(S,At):A.length,ma=ha?Math.min(Ae+1,ha):0,Ft=Math.max(1,Number(y.tries??1)),ta=y.compare??"anchors",Ta=Math.max(0,Math.min(100,Number(y.minCorrectness??0))),ut=(y.considerDependencies??"on")==="on",_t=Math.max(0,Math.min(100,Number(y.dependencyThreshold??85))),Zt=b=>{const C=b.slice();for(let J=C.length-1;J>0;J-=1){const be=Math.floor(Math.random()*(J+1));[C[J],C[be]]=[C[be],C[J]]}return C},wa=b=>xa(b,{treatSimilarCharsAsSame:!0})>=Ta,Wa=async()=>{const b=await ca(),C=new Map,J=new Map,be=new Map;b.forEach(re=>{const Te=`${re.itemType}:${re.itemId}`,Oe=ea(re.itemType,re.itemId,re.checkType,re.direction);if(C.has(Te)||C.set(Te,[]),C.get(Te).push(re),J.has(Oe)||J.set(Oe,[]),J.get(Oe).push(re),re.itemType==="info"&&re.checkType==="quote-fragment"&&re.direction){const Ze=`${re.itemId}:${re.direction}`;be.has(Ze)||be.set(Ze,[]),be.get(Ze).push(re)}});const ye=new Map,ue=new Map,we=new Map;return C.forEach((re,Te)=>ye.set(Te,la(re).score)),J.forEach((re,Te)=>ue.set(Te,la(re).score)),be.forEach((re,Te)=>we.set(Te,la(re).score)),{itemKnowness:ye,cardKnowness:ue,fragmentKnowness:we}},Gt=async b=>{const C=[];let J=null;for(;;){const be=await qa({libraryId:d,collectionId:b,limit:200,cursor:J});if(C.push(...be.items),!be.nextCursor)break;J=be.nextCursor}return Oa(C)},Ca=async(b,C)=>{if(Bt.current.has(b))return Bt.current.get(b)??0;const J=await Gt(b);if(J.length===0)return Bt.current.set(b,0),0;const ye=J.reduce((ue,we)=>{const re=Se(we);return ue+(C.get(re)??0)},0)/J.length;return Bt.current.set(b,ye),ye},Ia=(b,C)=>{if(!ut||b.cardType!=="info"||b.infoType!=="citation"||b.checkType!=="quote-fragment")return!0;const J=Wt(b.direction);if(!(J!=null&&J.fragmentId))return!0;const be=b.description??"";if(!be.trim())return!0;const ue=va(be).nodes[J.fragmentId];if(!ue||!ue.leftId&&!ue.rightId)return!0;const we=[ue.leftId,ue.rightId].filter(Oe=>!!Oe);if(we.length===0)return!0;const re=we.map(Oe=>{const Ze=ea("info",b.cardId,"quote-fragment",Oe);return C.get(Ze)??0});return re.reduce((Oe,Ze)=>Oe+Ze,0)/re.length>=_t},Pa=async b=>{const C=Ue,J=b.concat(C.active??[]).concat(C.pool??[]).filter((re,Te,Oe)=>Oe.findIndex(Ze=>Se(Ze)===Se(re))===Te);if(!ut){$t(new Set(J.map(Se)));return}const{itemKnowness:be,cardKnowness:ye}=await Wa(),ue=Qt.filter(re=>Tt(re.childItemType)==="collection"&&re.childItemId===f&&!Tt(re.childCheckType)&&!Tt(re.childDirection)),we=new Set;for(const re of J){if(re.cardType!=="info"){we.add(Se(re));continue}if(!Ia(re,ye))continue;const Te=Qt.filter(He=>ur(He,re)).concat(ue);if(Te.length===0){we.add(Se(re));continue}let Oe=0;for(const He of Te)if(Tt(He.parentItemType)==="collection")Oe+=await Ca(He.parentItemId,ye);else if(Tt(He.parentCheckType)||Tt(He.parentDirection)){const at=Tt(He.parentCheckType),it=Tt(He.parentDirection),dt=ea(He.parentItemType,He.parentItemId,at,it);Oe+=ye.get(dt)??0}else{const at=`${He.parentItemType}:${He.parentItemId}`;Oe+=be.get(at)??0}Oe/Te.length>=_t&&we.add(Se(re))}$t(we)},Qa=b=>{for(let C=b;C<A.length;C+=1){const J=A[C];if(J&&(!ut||J.cardType!=="info"||pe.has(Se(J))))return C}return-1},Ea=b=>!ut||b.cardType!=="info"||pe.has(Se(b)),kn=b=>{if(x.id!=="temporal"&&x.id!=="levels")return null;const C=Ue,J=(C.active??[]).concat(C.pool??[]),be=new Set;for(const ye of J){const ue=Se(ye);if(!(be.has(ue)||b.has(ue))&&(be.add(ue),Ea(ye)))return ye}return null},Ut=n.useMemo(()=>{if(x.id!=="levels")return null;const b=Ue,C=b.pool??[],J=b.active??[],be=b.levelMap??{},ye=Math.max(1,Number(y.levels??1)),ue=Array.from({length:ye},()=>0),we=new Set(J.map(Ze=>Se(Ze)));C.forEach(Ze=>{const He=Math.min(ye,Math.max(1,be[Se(Ze)]??1));ue[He-1]+=1});const re=C.length||1,Te=ue.map(Ze=>Ze/re*100),Oe=H?be[Se(H)]??1:null;return{counts:ue,percentages:Te,currentLevel:Oe,levelsCount:ye,activeCount:J.length,poolCount:C.length,activeSet:we}},[Ue,y,x,H]),Jt=n.useMemo(()=>{if(x.id!=="temporal")return null;const b=Ue,C=b.pool??[],J=b.active??[],be=b.knownessMap??{},ye=new Set(b.unknownSet??[]);let ue=0;C.forEach(Te=>{(be[Se(Te)]??0)>1&&(ue+=1)});const we=ye.size,re=J.map(Te=>({id:Se(Te),value:ye.has(Se(Te))?0:Math.max(0,Math.min(1,be[Se(Te)]??0))}));return{knownCount:ue,unknownCount:we,dots:re}},[Ue,x]),Nn=n.useMemo(()=>{if(!ut)return 0;const b=Ue;return A.concat(b.active??[]).concat(b.pool??[]).filter((J,be,ye)=>ye.findIndex(ue=>Se(ue)===Se(J))===be).filter(J=>J.cardType==="info"&&!pe.has(Se(J))).length},[ut,Ue,A,pe]);n.useEffect(()=>{if(!ut||fe!=="ready")return;const b=Ue,J=A.concat(b.active??[]).concat(b.pool??[]).filter((ue,we,re)=>re.findIndex(Te=>Se(Te)===Se(ue))===we).filter(ue=>ue.cardType!=="info"||pe.has(Se(ue))).length,be=Et.current;if(Et.current=J,be===null||J<=be)return;const ye=J-be;Ot(`New card available (+${ye})`),Nt.current&&window.clearTimeout(Nt.current),Nt.current=window.setTimeout(()=>Ot(null),2200)},[ut,fe,Ue,A,pe]),n.useEffect(()=>()=>{Nt.current&&window.clearTimeout(Nt.current)},[]);const zt=(b,C)=>{const J=x.applyOutcome({queue:A,meta:Ue},H,S,y,{correct:b,correctness:C,createdUtc:new Date().toISOString()});z(J.queue),ft(J.meta);const be=J.queue[Ae+1];be&&ga(be,Ae+1)};n.useEffect(()=>{if(K&&me){yn(d,me).then(b=>L(b.name)).catch(()=>L(t.cogita.library.collections.defaultName));return}if(Q==="info"&&N){na({libraryId:d,infoId:N}).then(b=>{const C=b.payload??{};L(C.title||C.label||C.name||N)}).catch(()=>L(N||t.cogita.library.revision.runKicker));return}if(Q==="info-selection"){const b=ee?ms(d,ee):null,C=(b==null?void 0:b.infoIds.length)??0;L(C>0?`Selected infos (${C})`:"Selected infos");return}L(t.cogita.library.collections.defaultName)},[t,me,K,d,Q,N,ee]),n.useEffect(()=>{Xn({libraryId:d,type:"language"}).then(b=>O(b)).catch(()=>O([]))},[d]),n.useEffect(()=>{K&&Yn({libraryId:d}).then(b=>Vt(b.items??[])).catch(()=>Vt([]))},[K,d]),n.useEffect(()=>{_n(d,B)},[d,B]),n.useEffect(()=>{Pa(A)},[A,Qt,ut,_t,me]),n.useEffect(()=>{if(!H||!ut){qt(!1);return}if(H.cardType!=="info"||pe.has(Se(H))){qt(!1);return}const b=Qa(Ae+1);if(b>=0){qt(!1),Pe(b);return}if(x.id==="temporal"||x.id==="levels"){const C=A.slice(0,Ae+1),J=A.slice(Ae+1).filter(Ea),be=C.concat(J),ye=new Set(be.map(Se)),ue=kn(ye);if(ue){const re=Se(ue);ye.has(re)||(be.push(ue),ye.add(re),ft(Te=>{const Oe=Te,Ze=new Set(Oe.queued??[]);return Ze.add(re),{...Oe,queued:Ze}}))}const we=be.findIndex((re,Te)=>Te!==Ae&&Ea(re));if(we>=0){z(be),Pe(we),qt(!1);return}}qt(!0)},[H,pe,ut,Ae,A,Ue,x.id]),n.useEffect(()=>{let b=!0;return(async()=>{se("loading"),Ne({current:0,total:x.id==="levels"?0:x.getFetchLimit(S,y)});try{if(!K){if(Vt([]),Q==="info"){if(!N){b&&(z([]),Vt([]),ft({}),Pe(0),se("ready"));return}const[He,at]=await Promise.all([tn({libraryId:d,infoId:N}),an({libraryId:d,infoId:N})]);if(!b)return;const it=Oa(He.items??[]);Vt(at.items??[]);const dt=x.prepare(it,S,y);z(dt.queue),ft(dt.meta),Pe(0),se("ready"),Ne({current:it.length,total:it.length});return}if(Q==="info-selection"){const He=ee?ms(d,ee):null,at=(He==null?void 0:He.infoIds)??[];if(!at.length){b&&(z([]),Vt([]),ft({}),Pe(0),se("ready"));return}const it=await Promise.all(at.map(async pa=>{const[Ht,Ga]=await Promise.all([tn({libraryId:d,infoId:pa}),an({libraryId:d,infoId:pa})]);return{cards:Ht.items??[],deps:Ga.items??[]}}));if(!b)return;const dt=new Map;it.forEach(pa=>{Oa(pa.cards).forEach(Ht=>{dt.set(Se(Ht),Ht)})});const ht=Array.from(dt.values()),gt=new Set(ht.map(Se)),Rt=new Map;it.forEach(pa=>{(pa.deps??[]).forEach(Ht=>{const Ga=ea(Ht.parentItemType,Ht.parentItemId,Tt(Ht.parentCheckType),Tt(Ht.parentDirection)),is=ea(Ht.childItemType,Ht.childItemId,Tt(Ht.childCheckType),Tt(Ht.childDirection));if(!gt.has(Ga)||!gt.has(is))return;const os=`${Ga}->${is}`;Rt.has(os)||Rt.set(os,Ht)})}),Vt(Array.from(Rt.values()));const ka=x.prepare(ht,S,y);z(ka.queue),ft(ka.meta),Pe(0),se("ready"),Ne({current:ht.length,total:ht.length});return}}const J=[];let be=null,ye=null;do{const He=await qa({libraryId:d,collectionId:me,limit:300,cursor:be});if(J.push(...He.items),(x.id==="levels"||x.id==="temporal")&&He.total&&(ye=He.total),Ne(at=>({current:J.length,total:at.total||He.total||x.getFetchLimit(S,y)})),be=He.nextCursor??null,ye!==null&&J.length>=ye||x.id!=="levels"&&x.id!=="temporal"&&J.length>=x.getFetchLimit(S,y))break}while(be);if(!b)return;const ue=Oa(J);let we;if(x.id==="levels"){const He=Math.max(1,Number(y.levels??1)),it=(await ca()).reduce((dt,ht)=>{const gt=ea(ht.itemType,ht.itemId,ht.checkType,ht.direction);return dt[gt]||(dt[gt]=[]),dt[gt].push(ht),dt},{});we={},ue.forEach(dt=>{const ht=Se(dt),gt=it[ht]??[],Rt=gt.length>0?la(gt).score:0,ka=Math.max(1,Math.min(He,Math.ceil(Rt/100*He)));we[ht]=ka})}let re=null,Te=null,Oe=null;if(x.id==="temporal"){const He=await ca(),at=new Set(ue.map(ht=>Se(ht))),it=He.reduce((ht,gt)=>{const Rt=ea(gt.itemType,gt.itemId,gt.checkType,gt.direction);return at.has(Rt)&&(ht[Rt]||(ht[Rt]=[]),ht[Rt].push(gt)),ht},{});re={},Te=new Set,Oe={};const dt=Date.now();ue.forEach(ht=>{const gt=Se(ht),Rt=it[gt]??[];if(Rt.length===0){re[gt]=0,Te.add(gt),Oe[gt]=[];return}const ka=as(Rt);Oe[gt]=ka;const pa=vn(ka,dt);re[gt]=pa.knowness})}const Ze=x.id==="levels"?ss(ue,S,y,we):x.id==="temporal"?ns(ue,S,y,re??{},Te??new Set,Oe??{}):x.prepare(ue,S,y);z(Ze.queue),ft(Ze.meta),Pe(0),se("ready"),Ne(He=>({current:Math.min(He.current,He.total),total:He.total}))}catch{b&&se("error")}})(),()=>{b=!1}},[me,K,d,S,Q,y,x,B,N,ee]),n.useEffect(()=>{if(et(""),Ce(null),Lt(null),St(0),Ie([]),Xe({}),M({}),T(null),he(null),ge(null),Je(!1),st(!1),qe(null),$(null),ie({}),!H){xt(null),Be(null),P(null),mt(null);return}H.cardType==="info"&&H.infoType==="computed"&&xt(t.cogita.library.revision.loadingComputed);let b=!0;return ga(H,Ae).then(C=>{!b||!C||(xt(C.prompt),Be(C.expectedAnswer),Ie(C.computedExpected),Xe(C.computedAnswers),P(C.computedValues),T(C.answerTemplate),he(C.outputVariables),ge(C.variableValues))}),()=>{b=!1}},[H,t]),n.useEffect(()=>{if(!H||H.cardType!=="info"||H.infoType!=="citation"){V.current=null,u.current=new Set,ot(null);return}const b=H.description??"",C=(H.label??"").trim(),J=C.replace(/\s+/g," ").trim(),be=b.replace(/\s+/g," ").trim(),ye=J&&J!==be?C:t.cogita.library.infoTypes.citation;if(!b){ot(null),Be(null);return}const ue=va(b);V.current=ue,xt(ye);let we=!0;return Wa().then(({fragmentKnowness:re})=>{if(!we)return;const Te=new Set,Oe={};re.forEach((at,it)=>{const[dt,ht]=it.split(":",2);if(dt!==H.cardId)return;const gt=Wt(ht);if(!gt)return;const{fragmentId:Rt}=gt;Oe[Rt]=at,at>=_t&&Te.add(Rt)}),u.current=Te,le.current=Oe;const Ze=Wt(H.direction);if(Ze!=null&&Ze.fragmentId&&ue.nodes[Ze.fragmentId]){D(ue,Ze.fragmentId,ye);return}const He=$a(ue,Te,Oe,_t,ut,H.direction);D(ue,(He==null?void 0:He.id)??null,ye)}).catch(()=>{u.current=new Set,le.current={};const re=Wt(H.direction);if(re!=null&&re.fragmentId&&ue.nodes[re.fragmentId]){D(ue,re.fragmentId,ye);return}const Te=$a(ue,u.current,{},_t,ut,H.direction);D(ue,(Te==null?void 0:Te.id)??null,ye)}),()=>{we=!1}},[H,t,ut,_t]),n.useEffect(()=>{if(!H||H.cardType!=="vocab"||H.checkType!=="translation-match"){$(null),ie({});return}const J=(Ue.pool??Ue.active??A).filter(re=>re.cardType==="vocab"&&re.checkType==="translation-match").filter((re,Te,Oe)=>Oe.findIndex(Ze=>Ze.cardId===re.cardId)===Te);J.some(re=>re.cardId===H.cardId)||J.unshift(H);const ye=Zt(J).slice(0,6).map(re=>{const Te=re.label.split("↔").map(He=>He.trim()).filter(Boolean);if(Te.length<2)return null;const Oe=`${re.cardId}:L`,Ze=`${re.cardId}:R`;return{cardId:re.cardId,leftId:Oe,rightId:Ze,leftLabel:Te[0],rightLabel:Te[1]}}).filter(Boolean),ue=ye.map(re=>re.leftId),we=Zt(ye.map(re=>re.rightId));$({pairs:ye,leftOrder:ue,rightOrder:we,selection:{},activeLeft:null,activeRight:null,locked:{}})},[H,A,Ue]),n.useEffect(()=>()=>{U.current&&window.clearTimeout(U.current),oe.current&&window.clearTimeout(oe.current)},[]);const sa=n.useRef(null);n.useEffect(()=>{if(!H)return;const b=Se(H),C=typeof document<"u"?document.activeElement:null;if(sa.current===b&&C&&(C.tagName==="INPUT"||C.tagName==="TEXTAREA"))return;let J=0;const be=()=>{if(H){if(H.cardType==="info"&&H.infoType==="computed"){if(Ye.length>0){const ue=hn(k,Ye,I),we=ue?yt.current[ue]:null;if(we&&(we.focus(),document.activeElement===we)){sa.current=b;return}}if(kt.current&&(kt.current.focus(),document.activeElement===kt.current)){sa.current=b;return}}else if(H.cardType==="vocab"&&kt.current&&(kt.current.focus(),document.activeElement===kt.current)){sa.current=b;return}J<6&&(J+=1,window.setTimeout(be,40))}},ye=window.setTimeout(be,40);return()=>window.clearTimeout(ye)},[H,Ye,k,I]),n.useEffect(()=>{if(!Kt)return;const b=C=>{C.key==="Enter"&&(C.preventDefault(),La())};return window.addEventListener("keydown",b),()=>window.removeEventListener("keydown",b)},[Kt]);const Ma=b=>{jt(b),mt(la(b))};n.useEffect(()=>{if(!H){mt(null),jt([]);return}const b=H.cardType==="info"?"info":"connection";if(H.cardType==="info"&&H.infoType==="citation"){ca().then(C=>{const J=C.filter(be=>be.itemType==="info"&&be.itemId===H.cardId&&be.checkType==="quote-fragment"&&dn(be.direction,H.direction));Ma(J)}).catch(()=>{mt(null),jt([])});return}cn(b,H.cardId,H.checkType,H.direction).then(C=>Ma(C)).catch(()=>{mt(null),jt([])})},[d,H,B]);const ja=(b,C,J,be)=>{if(b==="info"&&J==="quote-fragment"){ca().then(ye=>{const ue=ye.filter(we=>we.itemType==="info"&&we.itemId===C&&we.checkType==="quote-fragment"&&dn(we.direction,be));Ma(ue)}).catch(()=>{mt(null),jt([])});return}cn(b,C,J,be).then(ye=>Ma(ye)).catch(()=>{mt(null),jt([])})},Fa=(b,C,J)=>{var we;const be=((we=J.pairs.find(re=>re.leftId===b))==null?void 0:we.rightId)??null;if(!be)return J;const ye=be===C;ie(re=>({...re,[b]:ye?"correct":"incorrect"})),U.current&&window.clearTimeout(U.current),oe.current&&window.clearTimeout(oe.current),Y.current+=1;const ue={kind:ye?"correct":"incorrect",tick:Y.current};if(ve(null),U.current=window.setTimeout(()=>ve(ue),0),oe.current=window.setTimeout(()=>ve(null),420),ye){const re={...J.locked,[b]:!0};return Object.keys(re).length>=J.pairs.length?(Ce("correct"),st(!0)):Ce("correct"),{...J,selection:{...J.selection,[b]:C},activeLeft:null,activeRight:null,locked:re}}return Ce("incorrect"),{...J,activeLeft:null,activeRight:null}},Sn=b=>{$(C=>!C||C.locked[b]?C:C.activeRight?Fa(b,C.activeRight,C):{...C,activeLeft:C.activeLeft===b?null:b})},Tn=b=>{$(C=>C&&(C.activeLeft?Fa(C.activeLeft,b,C):{...C,activeRight:C.activeRight===b?null:b}))},La=()=>{var b;if(H&&H.cardType==="info"&&H.infoType==="citation"&&V.current&&tt&&!((b=Wt(H.direction))!=null&&b.fragmentId)){const C=$a(V.current,u.current,le.current,_t,ut,H.direction,tt.fragmentId);if(C){Ce(null),et(""),Je(!1),M({}),st(!1),Lt(null),St(0),D(V.current,C.id,tt.title);return}}Ce(null),et(""),Je(!1),M({}),st(!1),Lt(null),St(0),Pe(C=>Math.min(C+1,A.length))},aa=b=>{if(!H)return;const C=b.expected??null,J=b.answer??"";let be=C??"",ye=J;if(!C&&b.expectedMap&&b.answerMap){const He=Object.keys(b.expectedMap).sort((at,it)=>at.localeCompare(it));be=He.map(at=>{var it;return((it=b.expectedMap)==null?void 0:it[at])??""}).join("|"),ye=He.map(at=>{var it;return((it=b.answerMap)==null?void 0:it[at])??""}).join("|")}const ue=be?Ra(be,ye,ta):new Uint8Array,we={revisionType:x.id,evalType:b.evalType,direction:b.direction,prompt:We??"",expected:C,answer:J,expectedAnswers:b.expectedMap??null,answers:b.answerMap??null,correct:b.correct,maskBase64:ue.length?ya(ue):null,values:_??null,checkMode:de,compareMode:ta,minCorrectness:Ta},re=new TextEncoder().encode(JSON.stringify(we)),Te=H.cardType==="info"?"info":"connection",Oe=b.overrideCheckType??H.checkType??null,Ze=b.overrideDirection??H.direction??null;ln({itemType:Te,itemId:H.cardId,checkType:Oe,direction:Ze,revisionType:x.id,evalType:b.evalType,correct:b.correct,maskBase64:ue.length?ya(ue):null,payloadBase64:ya(re),personRoleId:B??null}).then(()=>{ja(Te,H.cardId,Oe,Ze),Pa(A),_n(d,B)}).catch(()=>{})},Cn=(b,C)=>{const J=rt.current.get(C);if(J)return Promise.resolve(J);const be=lt.current.get(C);if(be)return be;const ye=na({libraryId:d,infoId:b}).then(ue=>{var He,at;const we=ue.payload,re=((He=we.definition)==null?void 0:He.graph)??null,Te="",Oe=((at=we.definition)==null?void 0:at.answerTemplate)??"",Ze=ir(re,Te,Oe);if(Ze){const dt={sample:or(Ze),answerTemplate:Oe||null};return rt.current.set(C,dt),dt}return Un({libraryId:d,infoId:b}).then(it=>{const dt={sample:it,answerTemplate:null};return rt.current.set(C,dt),dt})}).catch(()=>Un({libraryId:d,infoId:b}).then(ue=>{const we={sample:ue,answerTemplate:null};return rt.current.set(C,we),we}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{lt.current.delete(C)});return lt.current.set(C,ye),ye},ga=(b,C)=>{var re;const J=`${Se(b)}:${C}`,be=It.current.get(J);if(be)return Promise.resolve(be);const ye=Mt.current.get(J);if(ye)return ye;const ue=Te=>(It.current.set(J,Te),Te);let we;if(b.cardType==="vocab"){if(b.checkType==="translation-match")return we=Promise.resolve(ue({prompt:b.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),we;const Te=b.label.split("↔").map(Oe=>Oe.trim()).filter(Boolean);if(Te.length>=2){const Ze=(b.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",He=Ze?Te[0]:Te[1],at=Ze?Te[1]:Te[0];we=Promise.resolve(ue({prompt:He,expectedAnswer:at,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else we=Promise.resolve(ue({prompt:b.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(b.cardType==="info"&&b.infoType==="word"){const Te=(re=b.description)!=null&&re.startsWith("Language: ")?b.description.replace("Language: ",""):null;we=Promise.resolve(ue({prompt:b.label,expectedAnswer:Te,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else b.cardType==="info"&&b.infoType==="computed"?we=Cn(b.cardId,J).then(Te=>{var it,dt;if(!Te.sample)return ue({prompt:b.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const Oe=Te.sample,Ze=Oe.expectedAnswers?Object.entries(Oe.expectedAnswers).map(([ht,gt])=>({key:ht,expected:gt})):[],He=Ze.reduce((ht,gt)=>(ht[gt.key]="",ht),{}),at=Oe.expectedAnswerIsSentence&&((it=Oe.expectedAnswer)==null?void 0:it.trim())||null;return ue({prompt:Oe.prompt,expectedAnswer:Ze.length>0?at:((dt=Oe.expectedAnswer)==null?void 0:dt.trim())||null,computedExpected:Ze,computedAnswers:He,computedValues:Oe.values??null,answerTemplate:Te.answerTemplate,outputVariables:Oe.outputVariables??null,variableValues:Oe.variableValues??null})}).catch(()=>ue({prompt:b.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{Mt.current.delete(J)}):we=Promise.resolve(ue({prompt:b.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return Mt.current.set(J,we),we},D=(b,C,J)=>{const be=Object.keys(b.nodes).length,ye=u.current.size;if(!C){ot({title:J,before:b.text,after:"",fragmentId:null,total:be,completed:ye}),Be(null),st(!0);return}const ue=b.nodes[C];if(!ue)return;const we=xn(b.text,ue);ot({title:J,before:we.before,after:we.after,fragmentId:ue.id,total:be,completed:ye}),Be(we.fragment),st(!1)},ce=()=>{const b=V.current;b&&ot(C=>C&&{...C,total:Object.keys(b.nodes).length,completed:u.current.size})},je=()=>{const b=A[Ae+1];b&&ga(b,Ae+1)},Ke=()=>{if(je(),H&&H.cardType==="vocab"&&H.checkType==="translation-match"&&te){if(te.pairs.length===0){Ce("incorrect"),st(!0);return}const ue=te.pairs.reduce((at,it)=>(at[it.rightId]=it.rightLabel,at),{});let we=0;const re={};te.pairs.forEach(at=>{const dt=te.selection[at.leftId]===at.rightId;re[at.leftId]=dt?"correct":"incorrect",dt&&(we+=1)});const Te=te.pairs.length||1,Oe=we/Te,Ze=we===te.pairs.length;ie(at=>({...at,...re})),Ze?(Ce("correct"),st(!0),St(0)):(Ce("incorrect"),st(!1),St(at=>{const it=at+1;return it>=Ft&&(Je(!0),st(!0),$(dt=>{if(!dt)return dt;const ht=dt.pairs.reduce((gt,Rt)=>(gt[Rt.leftId]=Rt.rightId,gt),{});return{...dt,selection:ht}})),it})),zt(Ze,Oe);const He="connection";Promise.all(te.pairs.map(at=>{const it=te.selection[at.leftId]??null,dt=it?ue[it]:"",ht={left:at.leftLabel,expected:at.rightLabel,answer:dt,checkType:"translation-match"},gt=new TextEncoder().encode(JSON.stringify(ht));return ln({itemType:He,itemId:at.cardId,checkType:"translation-match",direction:null,revisionType:x.id,evalType:"translation-match",correct:it===at.rightId,maskBase64:null,payloadBase64:ya(gt),personRoleId:B??null})})).then(()=>{ja(He,H.cardId,H.checkType,H.direction),_n(d,B)}).catch(()=>{});return}if(Ye.length>0){const ue=Ye.reduce((re,Te)=>{const Oe=ze[Te.key]??"";return re[Te.key]=Dt(Oe)===Dt(Te.expected)?"correct":"incorrect",re},{});Ye.every(({key:re,expected:Te})=>{const Oe=ze[re]??"";return de==="exact"&&Dt(Oe)===Dt(Te)})?(Ce("correct"),M(ue),st(!0),St(0),zt(!0,1),aa({correct:!0,direction:We?`${We} -> computed`:"computed",expectedMap:Ye.reduce((re,Te)=>(re[Te.key]=Te.expected,re),{}),answerMap:ze,evalType:"computed"})):(Ce("incorrect"),M(ue),st(!1),St(re=>{const Te=re+1;return Te>=Ft&&Ge&&(Je(!0),st(!0)),Te}),zt(!1,0),window.setTimeout(()=>{var Te;const re=hn(k,Ye,I);re&&yt.current[re]&&((Te=yt.current[re])==null||Te.focus())},40),aa({correct:!1,direction:We?`${We} -> computed`:"computed",expectedMap:Ye.reduce((re,Te)=>(re[Te.key]=Te.expected,re),{}),answerMap:ze,evalType:"computed"}));return}if(H&&H.cardType==="info"&&H.infoType==="citation"&&(tt!=null&&tt.fragmentId)){if(!Ve)return;const ue=Wt(H.direction),we=(ue==null?void 0:ue.fragmentId)??tt.fragmentId,re=Sa(Ve,Re,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Te=re.mask,Oe=re.isCorrect,Ze=re.percent;Oe?(le.current[tt.fragmentId]=Math.max(le.current[tt.fragmentId]??0,Ze),(le.current[tt.fragmentId]??0)>=_t&&u.current.add(tt.fragmentId),ce(),Ce("correct"),M({}),st(!0),Lt(Te),St(0),Ze<100&&Ft<=1&&Je(!0),zt(!0,Ze/100),aa({correct:!0,direction:`quote:${tt.fragmentId}`,expected:Ve,answer:Re,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:we})):(Ce("incorrect"),M({}),st(!1),Lt(Te),St(He=>{const at=He+1;return at>=Ft&&Ge&&(Je(!0),st(!0)),at}),zt(!1,Ze/100),window.setTimeout(()=>{var He;return(He=kt.current)==null?void 0:He.focus()},40),aa({correct:!1,direction:`quote:${tt.fragmentId}`,expected:Ve,answer:Re,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:we}));return}if(!Ve)return;const b=Ra(Ve,Re,ta),C=de==="exact"&&Dt(Re)===Dt(Ve),J=wa(b),be=C||J,ye=xa(b);be?(Ce("correct"),M({}),st(!0),Lt(b),St(0),ye<100&&Ft<=1&&Je(!0),zt(!0,ye/100),aa({correct:!0,direction:We?`${We} -> ${Ve}`:null,expected:Ve,answer:Re,evalType:"text"})):(Ce("incorrect"),M({}),st(!1),Lt(b),St(ue=>{const we=ue+1;return we>=Ft&&Ge&&(Je(!0),st(!0)),we}),zt(!1,ye/100),window.setTimeout(()=>{var ue;return(ue=kt.current)==null?void 0:ue.focus()},40),aa({correct:!1,direction:We?`${We} -> ${Ve}`:null,expected:Ve,answer:Re,evalType:"text"}))},De=b=>{if(je(),!Ve)return;const C=Ra(Ve,b,ta),J=Dt(b)===Dt(Ve),be=wa(C),ye=J||be,ue=xa(C);ye?(Ce("correct"),M({}),st(!0),Lt(C),St(0),ue<100&&Ft<=1&&Je(!0),zt(!0,ue/100),aa({correct:!0,direction:"word->language",expected:Ve,answer:b,evalType:"language-select"})):(Ce("incorrect"),M({}),st(!1),Lt(C),St(we=>{const re=we+1;return re>=Ft&&Ge&&(Je(!0),st(!0)),re}),zt(!1,ue/100),aa({correct:!1,direction:"word->language",expected:Ve,answer:b,evalType:"language-select"}))},ke=()=>{je(),Ce("correct"),st(!0),St(0),zt(!0,1),Ve&&aa({correct:!0,direction:"manual",expected:Ve,answer:Re,evalType:"manual"})},Ee=()=>{if(zt(!1,0),H&&H.cardType==="info"&&H.infoType==="citation"){Ce(null),et(""),Je(!1),M({}),st(!1),Lt(null),St(0),Pe(b=>Math.min(b+1,A.length));return}La()};n.useEffect(()=>{je()},[Ae,A]);const Me=b=>{var J;if(b.key!=="Enter")return;if(b.preventDefault(),b.stopPropagation(),Kt){La();return}const C=Ye.find(be=>!(ze[be.key]??"").trim());if(C){(J=yt.current[C.key])==null||J.focus();return}Ke()},Fe=t.cogita.library.revision.revealModeAfterIncorrect,Ge=Ye.length>0||!!Ve;return e.jsxs(Pt,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,children:[fe==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${ne.total?Math.min(100,Math.max(0,ne.current/ne.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:ne.total?`${Math.min(ne.current,ne.total)} / ${ne.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:G}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",Z).replace("{check}",Le)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:j,children:t.cogita.library.actions.libraryOverview}),K?e.jsxs(e.Fragment,{children:[e.jsx("a",{className:"cta ghost",href:`${j}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${j}/collections/${me}`,children:t.cogita.library.actions.collectionDetail})]}):e.jsx("a",{className:"cta ghost",href:`${j}/list`,children:t.cogita.library.actions.allCards})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:bt?`${bt.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Ut?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Ut.currentLevel??"-"," / ",Ut.levelsCount]}):null,bt?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(bt.correct)).replace("{total}",String(bt.total))}),bt.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(bt.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(lr,{outcomes:pt})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[Ct?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:Ct})}):null,e.jsx(es,{feedbackToken:ae?`${ae.kind}-${ae.tick}`:Qe?"idle":ct??"idle",children:H?e.jsx(e.Fragment,{children:Xt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(ts,{copy:t,currentCard:H,currentTypeLabel:wt,prompt:We,languages:W,answer:Re,onAnswerChange:b=>et(C=>un(C,b,$e)),computedExpected:Ye,computedAnswers:ze,onComputedAnswerChange:(b,C)=>Xe(J=>({...J,[b]:un(J[b]??"",C,$e)})),answerTemplate:k,outputVariables:I,variableValues:xe,computedFieldFeedback:E,feedback:ct,canAdvance:Kt,quoteContext:tt,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Ke,onSkip:Ee,onLanguageSelect:De,onMarkReviewed:ke,onAdvance:La,showCorrectAnswer:_e,setShowCorrectAnswer:Je,onRevealCorrect:()=>st(!0),answerMask:ua,expectedAnswer:Ve,hasExpectedAnswer:Ge,handleComputedKeyDown:Me,answerInputRef:kt,computedInputRefs:yt,scriptMode:$e,setScriptMode:qe,matchPairs:te==null?void 0:te.pairs,matchLeftOrder:te==null?void 0:te.leftOrder,matchRightOrder:te==null?void 0:te.rightOrder,matchSelection:te==null?void 0:te.selection,matchActiveLeft:te==null?void 0:te.activeLeft,matchActiveRight:te==null?void 0:te.activeRight,matchFeedback:X,onMatchLeftSelect:Sn,onMatchRightSelect:Tn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:K?`${j}/collections/${me}`:`${j}/list`,children:K?t.cogita.library.actions.collectionDetail:t.cogita.library.actions.allCards})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:ha?`${ma} / ${ha}`:t.cogita.library.revision.progressUnlimited}),fe==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),fe==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),fe==="ready"&&A.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Fe}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",Ft]})]})]}),Ut?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Ut.activeCount," / ",Ut.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Ut.counts.map((b,C)=>{const J=C+1,be=Ut.currentLevel===J,ye=Ut.percentages[C]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":be,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:J}),e.jsx("strong",{children:b})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,ye))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[ye.toFixed(1),"%"]})]},`level-${J}`)})})]}):null,Jt?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:Jt.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:Jt.dots.map(b=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,b.value*100))}%`,background:`rgba(${Math.round(255*(1-b.value))}, ${Math.round(200*b.value)}, 80, 0.9)`}},b.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:Jt.knownCount})]})]}):null,ut?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Nn})]})}):null]})]})]})})})]})]})}const Bn=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],ho={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},go=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],mo=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function po({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,libraryId:d,collectionId:f}){const[l,c]=n.useState(""),[j,g,S]=Hn([]),[F,x,y]=Wn([]),[de,B]=n.useState(null),[p,Q]=n.useState(null),[N,ee]=n.useState(null),q=`/#/cogita/library/${d}`;n.useEffect(()=>{yn(d,f).then(L=>c(L.name)).catch(()=>c(t.cogita.library.collections.defaultName))},[d,f,t]),n.useEffect(()=>{$r({libraryId:d,collectionId:f}).then(L=>{if(!L.graphId||L.graphId==="00000000-0000-0000-0000-000000000000"){g([]),x([]);return}const A=L.nodes.map(W=>{var ne;const O=W.payload??{},fe=O.position??{x:120,y:120},se=O.params??{};return{id:W.nodeId,type:"default",position:fe,data:{nodeType:W.nodeType,label:((ne=Bn.find(Ne=>Ne.type===W.nodeType))==null?void 0:ne.label)??W.nodeType,params:se}}}),z=L.edges.map(W=>({id:W.edgeId,source:W.fromNodeId,target:W.toNodeId,sourceHandle:W.fromPort??void 0,targetHandle:W.toPort??void 0}));g(A),x(z)}).catch(()=>{g([]),x([])})},[d,f,x,g]);const R=n.useMemo(()=>j.find(L=>L.id===de)??null,[j,de]),me=L=>{var O;const A=crypto.randomUUID(),z=((O=Bn.find(fe=>fe.type===L))==null?void 0:O.label)??L,W={...ho[L]};g(fe=>[...fe,{id:A,type:"default",position:{x:120+fe.length*40,y:120+fe.length*40},data:{nodeType:L,label:z,params:W}}]),B(A)},K=n.useCallback(L=>{x(A=>Qn({...L,id:crypto.randomUUID()},A))},[x]),Z=async()=>{Q(null);try{await Ys({libraryId:d,collectionId:f,nodes:j.map(L=>({nodeId:L.id,nodeType:L.data.nodeType,payload:{position:L.position,params:L.data.params}})),edges:F.map(L=>({edgeId:L.id,fromNodeId:L.source,fromPort:L.sourceHandle??null,toNodeId:L.target,toPort:L.targetHandle??null}))}),Q(t.cogita.library.graph.saveSuccess)}catch{Q(t.cogita.library.graph.saveFail)}},Le=async()=>{try{const L=await Rr({libraryId:d,collectionId:f});ee(L)}catch{ee(null)}},G=L=>{R&&g(A=>A.map(z=>z.id===R.id?{...z,data:{...z.data,params:L}}:z))};return e.jsx(Pt,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${q}/collections/${f}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Le,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:Z,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Bn.map(L=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>me(L.type),children:L.label},L.type))}),p?e.jsx("p",{className:"cogita-help",children:p}):null,N&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(N.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(N.connections)).replace("{infos}",String(N.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(pn,{nodes:j,edges:F,onNodesChange:S,onEdgesChange:y,onConnect:K,onNodeClick:(L,A)=>B(A.id),fitView:!0,children:[e.jsx(fn,{color:"rgba(120,160,200,0.2)"}),e.jsx(bn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),R?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:R.data.label}),R.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:d,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:R.data.params.tagId?{id:R.data.params.tagId,label:R.data.params.tagLabel??"",infoType:"topic"}:null,onChange:L=>G({...R.data.params,tagId:(L==null?void 0:L.id)??null,tagLabel:(L==null?void 0:L.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:R.data.params.scope??"any",onChange:L=>G({...R.data.params,scope:L.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),R.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Yt,{libraryId:d,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:R.data.params.languageId?{id:R.data.params.languageId,label:R.data.params.languageLabel??"",infoType:"language"}:null,onChange:L=>G({...R.data.params,languageId:(L==null?void 0:L.id)??null,languageLabel:(L==null?void 0:L.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:R.data.params.scope??"any",onChange:L=>G({...R.data.params,scope:L.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),R.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:R.data.params.infoType??"word",onChange:L=>G({...R.data.params,infoType:L.target.value}),children:mo.map(L=>e.jsx("option",{value:L.value,children:L.label},L.value))})]}),e.jsx(Yt,{libraryId:d,infoType:R.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:R.data.params.infoId?{id:R.data.params.infoId,label:R.data.params.infoLabel??"",infoType:R.data.params.infoType??"word"}:null,onChange:L=>G({...R.data.params,infoId:(L==null?void 0:L.id)??null,infoLabel:(L==null?void 0:L.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),R.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:R.data.params.connectionType??"translation",onChange:L=>G({...R.data.params,connectionType:L.target.value}),children:go.map(L=>e.jsx("option",{value:L.value,children:L.label},L.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:R.data.params.connectionId??"",onChange:L=>G({...R.data.params,connectionId:L.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(R.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const zn="cogita.preferences",On="cogita.reviewer.preferences",hr=["library_overview","all_cards","all_collections","all_revisions","storyboards","texts","dependencies","transfer"],Vn={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},all_revisions:{requiresCollection:!1,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},fo=["settings","run","shared"],Aa=30,_s=42;function fa(t,a){const r=(t??"").trim();return r.length<=a?r:a<=1?r.slice(0,a):`${r.slice(0,Math.max(1,a-1)).trimEnd()}…`}function bo(t,a=""){const r=t.split("/").filter(Boolean);if(r[0]!=="cogita"||r[1]!=="library")return{};const s=r[2];if(!s)return{};if(!r[3])return{libraryId:s,target:"library_overview"};const i=new URLSearchParams(a),o=i.get("revisionId")??void 0,h=i.get("infoId")??void 0,v=i.get("infoView"),m=v==="cards"?"cards":v==="collections"?"collections":"overview",w=i.get("collectionView")==="overview"?"overview":"infos",d=i.get("collectionAction"),f=i.get("libraryAction"),c=i.get("libraryTarget")==="revisions"?"all_revisions":"all_collections";if(r[3]==="list")return{libraryId:s,target:f==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:o,infoId:h,infoView:m,libraryAction:f==="new-info"?"new-info":void 0};if(r[3]==="detail"||r[3]==="collection")return{libraryId:s,target:"all_cards",cardMode:r[3],revisionId:o,infoId:h,infoView:m};if(r[3]==="new"||r[3]==="add")return{libraryId:s,target:"new_card",revisionId:o,libraryAction:"new-info"};if(r[3]==="edit")return{libraryId:s,target:"new_card",revisionId:o,infoId:r[4]};if(r[3]==="infos"){const g=r[4];return g?r[5]==="checkcards"?{libraryId:s,target:"all_cards",cardMode:"list",revisionId:o,infoId:g,infoView:"cards"}:r[5]==="collections"?{libraryId:s,target:"all_cards",cardMode:"list",revisionId:o,infoId:g,infoView:"collections"}:{libraryId:s,target:"all_cards",cardMode:"list",revisionId:o,infoId:g,infoView:"overview"}:{libraryId:s,target:"all_cards",cardMode:"list",revisionId:o}}if(r[3]==="shared-revisions")return{libraryId:s,target:c,revisionId:o};if(r[3]==="revisions"){const g=r[4];return g?g==="shared-links"?{libraryId:s,target:"all_revisions",revisionView:"shared"}:g==="new"?{libraryId:s,target:"all_revisions",revisionView:"new"}:r[5]==="run"?{libraryId:s,target:"all_revisions",revisionId:g,revisionView:"run"}:r[5]==="shared"?{libraryId:s,target:"all_revisions",revisionId:g,revisionView:"shared"}:{libraryId:s,target:"all_revisions",revisionId:g,revisionView:"settings"}:{libraryId:s,target:"all_revisions"}}if(r[3]==="revision"&&r[4]==="run")return{libraryId:s,target:c,revisionView:"run",revisionId:o,infoId:h,infoView:m};if(r[3]==="dependencies")return{libraryId:s,target:"dependencies"};if(r[3]==="transfer")return{libraryId:s,target:"transfer"};if(r[3]==="storyboards")return r[4]==="new"?{libraryId:s,target:"new_storyboard"}:{libraryId:s,target:"storyboards"};if(r[3]==="texts")return r[4]==="new"?{libraryId:s,target:"new_text"}:{libraryId:s,target:"texts"};if(r[3]!=="collections")return{libraryId:s,target:"library_overview"};if(r[4]==="new")return{libraryId:s,target:"new_collection",revisionId:o};const j=r[4];return j?r[5]==="graph"?{libraryId:s,target:c,collectionId:j,revisionId:o,revisionView:"graph"}:r[5]==="shared-revisions"?{libraryId:s,target:c,collectionId:j,revisionId:o,revisionView:"shared"}:r[5]==="revision"?{libraryId:s,target:c,collectionId:j,revisionId:o,revisionView:r[6]==="run"?"run":"settings",collectionView:w}:d==="new-revision"?{libraryId:s,target:c,collectionId:j,revisionId:o,revisionView:"new"}:{libraryId:s,target:c,collectionId:j,revisionId:o,revisionView:"detail",collectionView:w}:d==="new-collection"?{libraryId:s,target:"new_collection",collectionAction:"new-collection"}:{libraryId:s,target:c}}function Ds(t,a="library_overview",r,s,i,o,h="overview",v="infos"){const m=(w,d)=>{const f=new URLSearchParams;d!=null&&d.revisionId&&f.set("revisionId",d.revisionId),d!=null&&d.collectionAction&&f.set("collectionAction",d.collectionAction),d!=null&&d.libraryAction&&f.set("libraryAction",d.libraryAction),d!=null&&d.libraryTarget&&f.set("libraryTarget",d.libraryTarget),d!=null&&d.infoId&&f.set("infoId",d.infoId),d!=null&&d.infoView&&(d!=null&&d.infoId)&&f.set("infoView",d.infoView),d!=null&&d.collectionView&&d.collectionView!=="infos"&&f.set("collectionView",d.collectionView);const l=f.toString();return l?`${w}?${l}`:w};if(!t)return"/cogita";if(a==="library_overview")return m(`/cogita/library/${t}`,{revisionId:i});if(a==="all_cards")return o?h==="cards"?m(`/cogita/library/${t}/infos/${o}/checkcards`,{revisionId:i}):h==="collections"?m(`/cogita/library/${t}/infos/${o}/collections`,{revisionId:i}):m(`/cogita/library/${t}/infos/${o}`,{revisionId:i}):m(`/cogita/library/${t}/list`,{revisionId:i,infoId:o,infoView:h});if(a==="new_card")return o?m(`/cogita/library/${t}/edit/${o}`,{revisionId:i}):m(`/cogita/library/${t}/list`,{revisionId:i,libraryAction:"new-info"});if(a==="all_collections"||a==="all_revisions"){const w=a==="all_revisions"?"revisions":void 0;return a==="all_revisions"&&i?s==="run"?m(`/cogita/library/${t}/revisions/${i}/run`,{revisionId:i}):s==="shared"?m(`/cogita/library/${t}/revisions/${i}/shared`,{revisionId:i}):m(`/cogita/library/${t}/revisions/${i}`,{revisionId:i}):a==="all_revisions"&&s==="new"?m(`/cogita/library/${t}/revisions/new`,{revisionId:i}):a==="all_revisions"?s==="shared"?m(`/cogita/library/${t}/revisions/shared-links`,{revisionId:i}):s==="run"?m(`/cogita/library/${t}/revision/run`,{revisionId:i,libraryTarget:w}):m(`/cogita/library/${t}/revisions`,{revisionId:i}):!r&&s==="run"?m(`/cogita/library/${t}/revision/run`,{revisionId:i,libraryTarget:w}):r?s==="graph"?m(`/cogita/library/${t}/collections/${r}/graph`,{revisionId:i,libraryTarget:w}):s==="settings"?m(`/cogita/library/${t}/collections/${r}/revision`,{revisionId:i,libraryTarget:w}):s==="run"?m(`/cogita/library/${t}/collections/${r}/revision/run`,{revisionId:i,libraryTarget:w}):s==="shared"?m(`/cogita/library/${t}/collections/${r}/shared-revisions`,{revisionId:i,libraryTarget:w}):s==="new"?m(`/cogita/library/${t}/collections/${r}`,{revisionId:i,libraryTarget:w,collectionAction:"new-revision"}):m(`/cogita/library/${t}/collections/${r}`,{revisionId:i,libraryTarget:w,collectionView:v}):m(`/cogita/library/${t}/collections`,{revisionId:i,libraryTarget:w})}return a==="new_collection"?m(`/cogita/library/${t}/collections`,{revisionId:i,collectionAction:"new-collection"}):a==="transfer"?m(`/cogita/library/${t}/transfer`,{revisionId:i}):a==="storyboards"?m(`/cogita/library/${t}/storyboards`,{revisionId:i}):a==="new_storyboard"?m(`/cogita/library/${t}/storyboards/new`,{revisionId:i}):a==="texts"?m(`/cogita/library/${t}/texts`,{revisionId:i}):a==="new_text"?m(`/cogita/library/${t}/texts/new`,{revisionId:i}):a==="dependencies"?m(`/cogita/library/${t}/dependencies`,{revisionId:i}):m(`/cogita/library/${t}`,{revisionId:i})}function ba(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function yo(t){return typeof t=="string"&&hr.includes(t)}function xo(t,a){var v;if(!t.length)return null;const r=t.filter(m=>a.has(m.roleId)),s=r.length>0?r:t,i=s.map(m=>{var d,f;const w=((f=(d=m.fields.find(l=>l.fieldType==="role_kind"))==null?void 0:d.plainValue)==null?void 0:f.toLowerCase())??"";return{roleId:m.roleId,roleKind:w}}),o=i.find(m=>m.roleKind.includes("master"));if(o)return o.roleId;const h=i.find(m=>m.roleKind.includes("account")||m.roleKind.includes("user"));return h?h.roleId:((v=s[0])==null?void 0:v.roleId)??null}function vo(t){if(!t)return{version:1,byLibrary:{}};try{const a=JSON.parse(t);return!a||typeof a!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:a.lastLibraryId,byLibrary:a.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function wo({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w}){const d=mn(),f=Ja(),l=n.useMemo(()=>bo(f.pathname,f.search),[f.pathname,f.search]),c=t.cogita.workspace,[j,g]=n.useState([]),[S,F]=n.useState([]),[x,y]=n.useState([]),[de,B]=n.useState([]),[p,Q]=n.useState(void 0),[N,ee]=n.useState("library_overview"),[q,R]=n.useState(void 0),[me,K]=n.useState(void 0),[Z,Le]=n.useState("detail"),[G,L]=n.useState(void 0),[A,z]=n.useState(!1),[W,O]=n.useState(!0),[fe,se]=n.useState(!1),[ne,Ne]=n.useState(!1),[Ae,Pe]=n.useState(null),[Re,et]=n.useState(0),[ct,Ce]=n.useState(""),[We,xt]=n.useState(""),[Ve,Be]=n.useState(""),[tt,ot]=n.useState([]),[Ye,Ie]=n.useState(""),[ze,Xe]=n.useState(0),[E,M]=n.useState(null),[_,P]=n.useState(null),k=n.useRef({version:1,byLibrary:{}}),T=n.useRef(!1),I=n.useRef(!1),he=n.useRef(null),xe=n.useMemo(()=>j.find(u=>u.libraryId===p)??null,[j,p]),ge=n.useMemo(()=>S.find(u=>u.collectionId===q)??null,[S,q]),te=ba(f.pathname)==="/cogita/persons";n.useEffect(()=>{if(!p){ot([]),Ie("");return}let u=!1;return Xs({libraryId:p}).then(le=>{if(u)return;const H=le.filter(Qe=>(Qe.roleKind??"").trim().toLowerCase()==="person");ot(H);try{const Qe=window.localStorage.getItem(On),lt=(Qe?JSON.parse(Qe):{})[p]??"",It=lt&&H.some(Mt=>Mt.roleId===lt)?lt:"";Ie(It)}catch{Ie("")}}).catch(()=>{u||(ot([]),Ie(""))}),()=>{u=!0}},[p,ze]),n.useEffect(()=>{if(p)try{const u=window.localStorage.getItem(On),le=u?JSON.parse(u):{};Ye?le[p]=Ye:delete le[p],window.localStorage.setItem(On,JSON.stringify(le))}catch{}},[p,Ye]);const $=n.useMemo(()=>de.find(u=>u.revisionId===me)??null,[de,me]),X=n.useMemo(()=>({detail:c.revisions.detail,graph:c.revisions.graph,settings:c.revisions.settings,run:c.revisions.run,shared:c.targets.sharedRevisions,new:c.revisionForm.createAction}),[c.revisions.detail,c.revisions.graph,c.revisions.run,c.revisions.settings,c.targets.sharedRevisions,c.revisionForm.createAction]),ie=n.useMemo(()=>N==="new_card"?"all_cards":N==="new_collection"?"all_collections":N==="new_storyboard"?"storyboards":N==="new_text"?"texts":N,[N]),Y=n.useMemo(()=>Z==="new"?"settings":Z,[Z]),ae=N==="all_collections"||N==="all_revisions",ve=n.useMemo(()=>N==="new_collection"?"create":N==="all_collections"&&q?"selected":"search",[q,N]),U=n.useMemo(()=>l.infoId?"selected":N==="new_card"?"create":"search",[l.infoId,N]),oe=n.useMemo(()=>x.find(u=>u.infoId===l.infoId)??null,[x,l.infoId]),$e=n.useMemo(()=>({library_overview:c.targets.libraryOverview,all_cards:c.targets.allCards,new_card:c.targets.newCard,all_collections:c.targets.allCollections,all_revisions:c.targets.allRevisions,new_collection:c.targets.newCollection,transfer:c.targets.transfer,storyboards:c.targets.storyboards,new_storyboard:c.targets.newStoryboard,texts:c.targets.texts,new_text:c.targets.newText,dependencies:c.targets.dependencies}),[c.targets]),qe=n.useMemo(()=>$e[ie]??ie,[ie,$e]),_e=X[Y],Je=!!p,bt=n.useMemo(()=>{const u=m==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":m==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return m==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:u},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:u},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:u},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:u},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:u},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:u},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:u},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:u},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:u},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:u},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:u},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:u},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:u},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:m==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:u},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:u},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:u},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:u},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:u},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:u},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:u},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:u},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:u},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:u},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:u},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:u},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:u},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:u},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:u},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:u},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:u},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:u},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:u},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:u},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:u},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:u},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:u},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:u},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:u},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:u},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[m]),mt=bt.length,pt=Math.max(0,Math.min(Re,mt-1)),jt=bt[pt],Ct=!!q,Ot=Je&&N==="all_collections",Et=Ct&&N==="all_collections",Nt=Je&&(N==="all_revisions"||Ct&&N==="all_collections")&&(Y==="settings"||Y==="run"||Y==="shared"||N==="all_revisions"),ua=Nt,Lt=Nt&&!!me,vt=n.useCallback(u=>{const le=!!u.libraryId;let H=u.target,Qe=u.collectionId,rt=u.revisionId,lt=u.revisionView,It=u.infoId,Mt=u.infoView??l.infoView??"overview",wt=u.collectionView??l.collectionView??"infos";le?Vn[H].requiresCollection&&!Qe?(H=H==="all_revisions"?"all_revisions":"all_collections",rt=void 0,lt="detail"):H!=="all_collections"&&H!=="all_revisions"?(Qe=void 0,rt=void 0,H!=="new_card"&&H!=="all_cards"&&(It=void 0,Mt="overview"),H!=="new_collection"&&(wt="infos")):Vn[H].allowsRevision?fo.includes(lt)||(rt=void 0):lt="detail":(H="library_overview",Qe=void 0,rt=void 0,lt="detail",It=void 0,Mt="overview",wt="infos"),Q(u.libraryId),ee(H),R(Qe),K(rt),Le(lt),z(!1);const At=ba(Ds(u.libraryId,H,Qe,lt,rt,It,Mt,wt));ba(`${f.pathname}${f.search}`)!==At&&(he.current=At,d(At))},[f.pathname,f.search,d,l.collectionView,l.infoView]),St=n.useMemo(()=>[{key:"library",label:c.layers.library,visible:!0,value:p??"",selectedLabel:(xe==null?void 0:xe.name)??c.path.noLibrarySelected,disabled:W||j.length===0,options:j.map(u=>({value:u.libraryId,label:u.name})),emptyOption:c.noLibraryOption,onSelect:u=>{const le=u||void 0;vt({libraryId:le,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:c.layers.target,visible:Je,value:ie,selectedLabel:qe,disabled:!Je,options:hr.map(u=>({value:u,label:$e[u]})),onSelect:u=>{const le=u;vt({libraryId:p,target:le,collectionId:q,revisionId:me,revisionView:Z,infoId:le==="new_card"?l.infoId:void 0})}},{key:"info_mode",label:c.layers.target,visible:ie==="all_cards",value:U,selectedLabel:U==="create"?c.infoMode.create:U==="selected"?(oe==null?void 0:oe.label)??G??t.cogita.library.list.selectedEmpty:c.infoMode.search,disabled:!Je,options:[{value:"search",label:c.infoMode.search},{value:"create",label:c.infoMode.create},...l.infoId?[{value:"selected",label:(oe==null?void 0:oe.label)??G??t.cogita.library.list.selectedEmpty}]:[]],onSelect:u=>{if(u==="selected"){if(!l.infoId)return;vt({libraryId:p,target:"all_cards",collectionId:q,revisionId:me,revisionView:Z,infoId:l.infoId,infoView:"overview"});return}if(u==="create"){vt({libraryId:p,target:"new_card",collectionId:q,revisionId:me,revisionView:Z,infoId:void 0});return}vt({libraryId:p,target:"all_cards",collectionId:q,revisionId:me,revisionView:Z,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:c.layers.target,visible:ie==="all_cards"&&!!l.infoId,value:N==="new_card"&&l.infoId?"edit":l.infoView==="cards"?"cards":l.infoView==="collections"?"collections":"overview",selectedLabel:N==="new_card"&&l.infoId?c.infoActions.edit:l.infoView==="cards"?c.infoActions.seeCards:l.infoView==="collections"?"Kolekcje":c.infoActions.overview,disabled:!Je||!l.infoId,options:[{value:"overview",label:c.infoActions.overview},{value:"edit",label:c.infoActions.edit},{value:"cards",label:c.infoActions.seeCards},{value:"collections",label:"Kolekcje"}],onSelect:u=>{if(l.infoId){if(u==="edit"){vt({libraryId:p,target:"new_card",collectionId:q,revisionId:me,revisionView:Z,infoId:l.infoId});return}if(u==="cards"){vt({libraryId:p,target:"all_cards",collectionId:q,revisionId:me,revisionView:Z,infoId:l.infoId,infoView:"cards"});return}vt({libraryId:p,target:"all_cards",collectionId:q,revisionId:me,revisionView:Z,infoId:l.infoId,infoView:"overview"})}}},{key:"collection_mode",label:c.layers.collection,visible:Je&&(N==="all_collections"||N==="new_collection"),value:ve,selectedLabel:ve==="create"?t.cogita.library.actions.createCollection:ve==="selected"?(ge==null?void 0:ge.name)??c.path.noCollectionSelected:t.cogita.library.actions.collections,disabled:!Je,options:[{value:"search",label:t.cogita.library.actions.collections},{value:"create",label:t.cogita.library.actions.createCollection},...q&&ge?[{value:"selected",label:ge.name}]:[]],onSelect:u=>{if(u==="create"){vt({libraryId:p,target:"new_collection",collectionId:void 0,revisionId:void 0,revisionView:"detail"});return}if(u==="selected"&&q){const le=ae?N:"all_collections";vt({libraryId:p,target:le,collectionId:q,revisionId:me,revisionView:le==="all_revisions"?"settings":"detail"});return}if(u==="collections"){vt({libraryId:p,target:"all_cards",collectionId:q,revisionId:me,revisionView:Z,infoId:l.infoId,infoView:"collections"});return}vt({libraryId:p,target:ae?N:"all_collections",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection",label:c.layers.collection,visible:Ot&&ve!=="create",value:q??"",selectedLabel:(ge==null?void 0:ge.name)??c.path.noCollectionSelected,disabled:!Je||fe||S.length===0,options:S.map(u=>({value:u.collectionId,label:u.name})),emptyOption:c.selectCollectionOption,onSelect:u=>{const le=u||void 0,H=ae?N:"all_collections";vt({libraryId:p,target:H,collectionId:le,revisionId:void 0,revisionView:H==="all_revisions"?"settings":"detail"})}},{key:"collection_selected_action",label:c.layers.revision,visible:Et,value:N==="all_revisions"?"revisions":Y==="graph"?"edit":Y==="settings"||Y==="run"||Y==="shared"?"revisions":(l.collectionView??"infos")==="overview"?"overview":"infos",selectedLabel:N==="all_revisions"?c.targets.allRevisions:Y==="graph"?"Edytuj":Y==="settings"||Y==="run"||Y==="shared"?c.targets.allRevisions:(l.collectionView??"infos")==="overview"?"Przegląd":"Informacje",disabled:!q,options:[{value:"overview",label:"Przegląd"},{value:"edit",label:"Edytuj"},{value:"infos",label:"Informacje"},{value:"revisions",label:c.targets.allRevisions}],onSelect:u=>{if(q){if(u==="edit"){vt({libraryId:p,target:ae?N:"all_collections",collectionId:q,revisionId:void 0,revisionView:"graph"});return}if(u==="revisions"){vt({libraryId:p,target:ae?N:"all_collections",collectionId:q,revisionId:me,revisionView:"settings"});return}vt({libraryId:p,target:ae?N:"all_collections",collectionId:q,revisionId:void 0,revisionView:"detail",infoId:l.infoId,infoView:l.infoView,collectionView:u==="overview"?"overview":"infos"})}}},{key:"revision_mode",label:c.layers.revision,visible:ua,value:Z==="new"?"create":!me&&Y==="shared"?"shared":"search",selectedLabel:Z==="new"?c.revisionForm.createAction:!me&&Y==="shared"?c.targets.sharedRevisions:c.infoActions.search,disabled:N==="all_revisions"?!Je:!Ct,options:[{value:"search",label:c.infoActions.search},{value:"create",label:c.revisionForm.createAction},{value:"shared",label:c.targets.sharedRevisions}],onSelect:u=>{vt({libraryId:p,target:ae?N:"all_revisions",collectionId:N==="all_revisions"?void 0:q,revisionId:void 0,revisionView:u==="create"?"new":u==="shared"?"shared":"settings"})}},{key:"revision_entry",label:c.layers.revision,visible:ua,value:me??"",selectedLabel:($==null?void 0:$.name)??c.status.noRevisions,disabled:(N==="all_revisions"?!Je:!Ct)||ne||de.length===0,options:de.map(u=>({value:u.revisionId,label:u.name})),emptyOption:c.status.noRevisions,onSelect:u=>{vt({libraryId:p,target:ae?N:"all_collections",collectionId:q,revisionId:u||void 0,revisionView:Y==="settings"||Y==="run"||Y==="shared"?Y:"settings"})}},{key:"revision_selected_action",label:c.layers.revision,visible:Lt,value:Y==="run"?"run":Y==="shared"?"shared":"settings",selectedLabel:Y==="run"?c.revisions.run:Y==="shared"?c.targets.sharedRevisions:c.infoActions.edit,disabled:!me,options:[{value:"settings",label:c.infoActions.edit},{value:"run",label:c.revisions.run},{value:"shared",label:c.targets.sharedRevisions}],onSelect:u=>{me&&vt({libraryId:p,target:ae?N:"all_collections",collectionId:q,revisionId:me,revisionView:u==="run"?"run":u==="shared"?"shared":"settings"})}}],[S,fe,U,x,j,W,vt,de,ne,ge,q,oe,$,me,G,Ct,Je,xe,ae,p,_e,Z,N,Y,ie,qe,Ot,Et,ua,Lt,$e,t.cogita.library.list.selectedEmpty,l.infoId,l.infoView,l.collectionView,c.infoActions.edit,c.infoActions.overview,c.infoActions.seeCards,c.layers.collection,c.layers.library,c.layers.revision,c.layers.target,c.noLibraryOption,c.path.noCollectionSelected,c.path.noLibrarySelected,c.selectCollectionOption,c.targets.allRevisions,c.infoActions.search,c.revisionForm.createAction,c.revisions.run,c.targets.sharedRevisions,ve]),kt=n.useMemo(()=>St.filter(u=>u.visible),[St]),yt=n.useMemo(()=>kt.filter(u=>u.key!=="library"&&u.key!=="collection"),[kt]),Kt=n.useMemo(()=>yt.find(u=>u.key==="target")??null,[yt]),st=n.useMemo(()=>yt.find(u=>u.key==="info_mode")??null,[yt]),Ue=n.useMemo(()=>yt.find(u=>u.key==="info_selected_action")??null,[yt]),ft=n.useMemo(()=>yt.find(u=>u.key==="collection_mode")??null,[yt]),Qt=n.useMemo(()=>yt.find(u=>u.key==="revision_mode")??null,[yt]),Vt=n.useMemo(()=>yt.find(u=>u.key==="collection_selected_action")??null,[yt]),Bt=n.useMemo(()=>yt.find(u=>u.key==="revision_entry")??null,[yt]),pe=n.useMemo(()=>yt.find(u=>u.key==="revision_selected_action")??null,[yt]),$t=n.useCallback((u,le)=>u?e.jsx("div",{className:"cogita-sidebar-actions",children:u.options.map(H=>e.jsx("button",{type:"button",className:`ghost ${String(u.value)===H.value?"active":""}`,onClick:()=>u.onSelect(H.value),disabled:u.disabled,title:H.label,children:fa(H.label,Aa)},`${le}:${u.key}:${H.value}`))}):null,[]),Xt=n.useMemo(()=>{const u=l.libraryId;if(!u||!f.pathname.startsWith("/cogita/library/"))return null;const le={copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,libraryId:u};if(l.target==="library_overview")return e.jsx(ai,{...le});if(l.target==="all_cards")return l.infoId&&l.infoView==="cards"?e.jsx(Pi,{...le,infoId:l.infoId,selectedReviewerRoleId:Ye||null}):e.jsx(mi,{...le,mode:l.cardMode??"list"});if(l.target==="new_card")return e.jsx(Ni,{...le,editInfoId:l.infoId});if(l.target==="dependencies")return e.jsx(Ti,{...le});if(l.target==="transfer")return e.jsx(Di,{...le});if(l.target==="storyboards"||l.target==="new_storyboard")return e.jsx(Bi,{...le});if(l.target==="texts"||l.target==="new_text")return e.jsx(zi,{...le});if(l.target==="all_collections"||l.target==="all_revisions"){if(l.target==="all_revisions"&&!l.collectionId)return l.revisionView==="run"?e.jsx(Dn,{...le,revisionId:l.revisionId}):e.jsx(Ks,{...le,revisionId:l.revisionId});if(!l.collectionId&&l.revisionView==="run")return e.jsx(Dn,{...le,revisionId:l.revisionId});if(l.collectionId){const H={...le,collectionId:l.collectionId};return l.revisionView==="graph"?e.jsx(po,{...H}):l.revisionView==="shared"?e.jsx(_i,{...le,collectionId:l.collectionId}):l.revisionView==="settings"?e.jsx(Ks,{...H,revisionId:l.revisionId}):l.revisionView==="run"?e.jsx(Dn,{...H,revisionId:l.revisionId}):e.jsx(Vi,{...H})}return e.jsx(Oi,{...le})}return l.target==="new_collection"?e.jsx(Hi,{...le,onCreated:H=>{vt({libraryId:u,target:N==="all_revisions"?"all_revisions":"all_collections",collectionId:H,revisionId:void 0,revisionView:"graph"})}}):null},[a,vt,t,m,f.pathname,d,w,o,v,s,i,l.cardMode,l.collectionId,l.infoId,l.libraryId,l.revisionId,l.revisionView,l.target,h,r,N,Ye]);n.useEffect(()=>{let u=!1;return(async()=>{var H,Qe,rt,lt,It;O(!0);try{await Pr();const[Mt,wt,At]=await Promise.all([Us(),Ws(),Er()]);if(u)return;g(Mt);const ha=new Set(At.nodes.filter(ut=>ut.nodeType==="role"&&ut.canLink).map(ut=>ut.roleId??"")),ma=xo(wt,ha);if(M(ma),ma){const ut=At.nodes.find(_t=>_t.nodeType==="data"&&_t.roleId===ma&&(_t.fieldType===zn||_t.label===zn));P((ut==null?void 0:ut.dataKeyId)??null),k.current=vo(ut==null?void 0:ut.value)}const Ft=(H=Mt.find(ut=>ut.libraryId===l.libraryId))==null?void 0:H.libraryId,ta=Ft?(rt=(Qe=k.current.byLibrary)==null?void 0:Qe[Ft])==null?void 0:rt.lastTarget:void 0,Ta=yo(ta)?ta:"library_overview";Q(Ft),ee(l.target??Ta),K(l.revisionId??(Ft?(It=(lt=k.current.byLibrary)==null?void 0:lt[Ft])==null?void 0:It.lastRevisionId:void 0)),Le(l.revisionView??"detail"),T.current=!0}catch{u||Pe(c.status.loadFailed)}finally{u||O(!1)}})(),()=>{u=!0}},[c.status.loadFailed]),n.useLayoutEffect(()=>{if(T.current){if(!l.libraryId){Q(void 0),ee(l.target??"library_overview"),R(void 0),K(void 0),Le("detail");return}l.libraryId&&j.some(u=>u.libraryId===l.libraryId)&&Q(l.libraryId),l.target&&ee(l.target),R(l.collectionId),K(l.revisionId),l.revisionView&&Le(l.revisionView)}},[j,l.collectionId,l.libraryId,l.revisionId,l.revisionView,l.target]),n.useEffect(()=>{if(!p){F([]),R(void 0),y([]),B([]),K(void 0);return}let u=!1;return se(!0),Va({libraryId:p,limit:200}).then(le=>{var rt;if(u)return;const H=le.items;F(H);const Qe=(rt=H.find(lt=>lt.collectionId===l.collectionId))==null?void 0:rt.collectionId;R(Qe)}).catch(()=>{u||(F([]),R(void 0))}).finally(()=>{u||se(!1)}),()=>{u=!0}},[l.collectionId,p]),n.useEffect(()=>{if(!p||ie!=="all_cards"&&N!=="new_card"){y([]);return}let u=!1;return Xn({libraryId:p,limit:200}).then(le=>{u||y(le)}).catch(()=>{u||y([])}),()=>{u=!0}},[ie,p,N]),n.useEffect(()=>{if(!p||N!=="all_revisions"&&!q){B([]),N!=="all_revisions"&&K(void 0);return}let u=!1;return Ne(!0),Gn({libraryId:p,collectionId:N==="all_revisions"?void 0:q}).then(le=>{var rt,lt,It,Mt;if(u)return;B(le);const H=(lt=(rt=k.current.byLibrary)==null?void 0:rt[p])==null?void 0:lt.lastRevisionId,Qe=((It=le.find(wt=>wt.revisionId===l.revisionId))==null?void 0:It.revisionId)??((Mt=le.find(wt=>wt.revisionId===H))==null?void 0:Mt.revisionId);K(Qe)}).catch(()=>{u||(B([]),K(void 0))}).finally(()=>{u||Ne(!1)}),()=>{u=!0}},[l.revisionId,q,p,N]),n.useEffect(()=>{const u=l.infoId;if(!p||!u){L(void 0);return}let le=!1;return na({libraryId:p,infoId:u}).then(H=>{if(le)return;const Qe=H.payload??{},rt=Qe.definition&&typeof Qe.definition=="object"?Qe.definition:null,lt=typeof(rt==null?void 0:rt.title)=="string"?rt.title:void 0,It=typeof(rt==null?void 0:rt.question)=="string"?rt.question:void 0,Mt=typeof Qe.label=="string"?Qe.label:void 0,wt=typeof Qe.name=="string"?Qe.name:void 0,At=typeof Qe.title=="string"?Qe.title:void 0;L(lt??It??Mt??wt??At??H.infoId)}).catch(()=>{le||L(u)}),()=>{le=!0}},[l.infoId,p]),n.useEffect(()=>{if(!T.current||l.libraryId&&j.some(rt=>rt.libraryId===l.libraryId)&&l.libraryId!==p||l.target&&l.target!==N||l.revisionView&&l.revisionView!==Z||l.revisionId&&l.revisionId!==me||Vn[N].requiresCollection&&!q&&(l.target==="all_collections"||l.target==="all_revisions")&&l.collectionId)return;const u=ba(`${f.pathname}${f.search}`);if(ba(f.pathname)==="/cogita"&&!l.libraryId&&!p){he.current=null;return}if(ba(f.pathname)==="/cogita/persons"){he.current=null;return}if(ba(f.pathname)===`/cogita/library/${p}/revision/run`&&l.revisionView==="run"&&!l.collectionId&&(N==="all_collections"||N==="all_revisions")&&Z==="run"&&!q){he.current=null;return}const Qe=ba(Ds(p,N,q,Z,me,l.infoId,l.infoView??"overview",l.collectionView??"infos"));if(u===Qe){he.current=null;return}he.current!==Qe&&(he.current=Qe,d(Qe,{replace:!0}))},[j,f.pathname,f.search,d,l.collectionId,l.infoId,l.infoView,l.collectionView,l.libraryId,l.revisionId,l.revisionView,l.target,q,p,me,Z,N]),n.useEffect(()=>{if(typeof window>"u")return;const u=()=>{window.innerWidth>920&&z(!1)};return window.addEventListener("resize",u),()=>window.removeEventListener("resize",u)},[]),n.useEffect(()=>{if(!T.current||!E||!p||I.current)return;const u=k.current,le={...u.byLibrary??{}},H={...le[p]??{},lastCollectionId:q,lastRevisionId:me,lastRevisionView:Z,lastTarget:N},Qe={version:1,lastLibraryId:p,byLibrary:{...le,[p]:H}},rt=JSON.stringify(u),lt=JSON.stringify(Qe);if(rt===lt)return;k.current=Qe,I.current=!0,(async()=>{try{if(_)await Fr(_,{plainValue:lt});else{const Mt=await Kr(E,{itemName:zn,itemType:"data",plainValue:lt});P(Mt.dataItemId)}}catch{Pe(c.status.savePrefsFailed)}finally{I.current=!1}})()},[_,E,q,p,me,Z,N,c.status.savePrefsFailed]);const qt=async()=>{const u=ct.trim();if(!u){Pe(t.cogita.user.libraryNameRequired);return}Pe(null);try{const le=await Dr({name:u});g(H=>[le,...H]),Q(le.libraryId),ee("library_overview"),R(void 0),Ce("")}catch{Pe(t.cogita.user.libraryCreateFailed)}},V=async()=>{if(!p||!q){Pe(c.status.selectLibraryFirst);return}const u=Ve.trim();if(!u){Pe(c.revisionForm.nameLabel);return}Pe(null);try{const le=await _r({libraryId:p,collectionId:q,name:u,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});B(H=>[le,...H]),K(le.revisionId),ee(N==="all_revisions"?"all_revisions":"all_collections"),Le("settings"),Be("")}catch{Pe(c.status.loadFailed)}};return e.jsx(Pt,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,headerExtra:e.jsxs("div",{className:"cogita-header-reviewer-actions",children:[e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:Ye,disabled:!p,onChange:u=>{const le=u.target.value;if(le==="__new_person__"){d("/cogita/persons");return}Ie(le)},children:[e.jsx("option",{value:"",children:p?"No person":"Select library first"}),tt.map(u=>e.jsx("option",{value:u.roleId,children:u.label},u.roleId)),e.jsx("option",{value:"__new_person__",children:"+ Create new person"})]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>d("/cogita/persons"),children:"Persons"})]}),children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${A?"open":""}`,"aria-label":c.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{title:(xe==null?void 0:xe.name)??c.path.noLibrarySelected,children:fa((xe==null?void 0:xe.name)??c.path.noLibrarySelected,Aa)}),e.jsx("p",{className:"cogita-sidebar-note",children:xe?c.sidebar.libraryActionsHint:c.status.selectLibraryFirst}),$t(Kt,"sidebar"),N==="all_revisions"&&Bt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.targets.allRevisions}),$t(Qt,"sidebar"),$t(Bt,"sidebar"),pe?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:($==null?void 0:$.name)??c.status.noRevisions,children:fa(($==null?void 0:$.name)??c.status.noRevisions,Aa)}),$t(pe,"sidebar")]}):null]}):null,st?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.sidebar.infoActionsHint}),$t(st,"sidebar"),Ue?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(oe==null?void 0:oe.label)??G??t.cogita.library.list.selectedEmpty,children:fa((oe==null?void 0:oe.label)??G??t.cogita.library.list.selectedEmpty,Aa)}),e.jsx("p",{className:"cogita-sidebar-note",children:c.sidebar.selectedInfoActionsHint}),$t(Ue,"sidebar")]}):null]}):null,ft?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.sidebar.collectionActionsHint}),$t(ft,"sidebar"),ge&&Vt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:ge.name,children:fa(ge.name,Aa)}),$t(Vt,"sidebar"),N!=="all_revisions"&&Bt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:c.targets.allRevisions}),$t(Qt,"sidebar"),$t(Bt,"sidebar"),pe?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:($==null?void 0:$.name)??c.status.noRevisions,children:fa(($==null?void 0:$.name)??c.status.noRevisions,Aa)}),$t(pe,"sidebar")]}):null]}):null]}):null]}):null]}),e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:c.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:s,children:c.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{v("cogita"),z(!1)},children:c.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:i,children:h?t.account.secureModeDisable:t.account.secureModeEnable})]})]})]}),A?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":c.sidebar.closeMenu,onClick:()=>z(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":c.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>z(u=>!u),"aria-label":A?c.sidebar.closeMenu:c.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),kt.map((u,le)=>e.jsxs("div",{className:"cogita-browser-segment",children:[le>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,u.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":u.label,title:u.selectedLabel,children:fa(u.selectedLabel,_s)}):e.jsxs("select",{"aria-label":u.label,value:u.value,onChange:H=>u.onSelect(H.target.value),disabled:u.disabled,children:[u.emptyOption?e.jsx("option",{value:"",children:u.emptyOption}):null,u.options.map(H=>e.jsx("option",{value:H.value,title:H.label,children:fa(H.label,_s)},`${u.key}:${H.value}`))]})]},`menu:${u.key}`))]}),Xt?e.jsxs(e.Fragment,{children:[(N==="all_collections"||N==="all_revisions")&&Z==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:c.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsxs("select",{value:q??"",onChange:u=>R(u.target.value||void 0),children:[e.jsx("option",{value:"",children:c.selectCollectionOption}),S.map(u=>e.jsx("option",{value:u.collectionId,children:u.name},u.collectionId))]})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:c.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:Ve,onChange:u=>Be(u.target.value),placeholder:c.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:V,children:c.revisionForm.createAction}),Ae?e.jsx("p",{className:"cogita-form-error",children:Ae}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Zs.Provider,{value:!0,children:Xt})})]}):null,Xt?null:e.jsxs(e.Fragment,{children:[te?e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Ki,{copy:t,onPersonCreated:u=>{Xe(le=>le+1)}})}):null,!p&&!te?e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:jt.step}),e.jsx("h2",{children:jt.title})]}),e.jsxs("p",{children:[pt+1," / ",mt]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:jt.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:jt.passages.map(u=>e.jsx("p",{children:u},u))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:jt.focus.map(u=>e.jsx("span",{children:u},u))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:jt.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:bt.map((u,le)=>e.jsx("button",{type:"button",className:`ghost ${le===pt?"active":""}`,onClick:()=>et(le),"aria-label":`${le+1}`,children:le+1},`tutorial:${u.title}:${le}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:pt===0,onClick:()=>et(u=>Math.max(0,u-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:pt===mt-1,onClick:()=>et(u=>Math.min(mt-1,u+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:ct,onChange:u=>Ce(u.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:qt,children:t.cogita.user.createLibraryAction}),Ae?e.jsx("p",{className:"cogita-form-error",children:Ae}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),j.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,j.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:j.map(u=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{vt({libraryId:u.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:u.name})]},u.libraryId))}):null]})]})]}):null]})]})]})})}const Po=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:wo},Symbol.toStringTag,{value:"Module"}));function jo({copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,shareId:d}){const[f,l]=n.useState(null),[c,j]=n.useState("loading"),[g,S]=n.useState(t.cogita.library.collections.defaultName),[F,x]=n.useState("Cogita Library"),[y,de]=n.useState([]),[B,p]=n.useState([]),[Q,N]=n.useState("idle"),[ee,q]=n.useState({current:0,total:0}),[R,me]=n.useState(0),[K,Z]=n.useState(""),[Le,G]=n.useState(null),[L,A]=n.useState(null),[z,W]=n.useState(null),[O,fe]=n.useState(null),[se,ne]=n.useState([]),[Ne,Ae]=n.useState({}),[Pe,Re]=n.useState({}),[et,ct]=n.useState(null),[Ce,We]=n.useState(null),[xt,Ve]=n.useState(null),[Be,tt]=n.useState(null),[ot,Ye]=n.useState({}),Ie=n.useRef(0),[ze,Xe]=n.useState(null),E=n.useRef(null),M=n.useRef(null),[_,P]=n.useState(null),[k,T]=n.useState(!1),[I,he]=n.useState(null),[xe,ge]=n.useState([]),[te,$]=n.useState(null),X=n.useRef(null),ie=n.useRef(null),[Y,ae]=n.useState(null),[ve,U]=n.useState(0),oe=n.useRef(null),$e=n.useRef({}),[qe,_e]=n.useState(!1),[Je,bt]=n.useState({}),mt=n.useRef(null),pt=n.useRef(new Set),jt=n.useRef({}),[Ct,Ot]=n.useState([]),[Et,Nt]=n.useState(new Set),[ua,Lt]=n.useState(!1),vt=Ja(),St=n.useMemo(()=>new URLSearchParams(vt.search),[vt.search]),kt=n.useMemo(()=>St.get("key")??"",[St]),yt=(f==null?void 0:f.mode)??"random",Kt=(f==null?void 0:f.check)??"exact",st=(f==null?void 0:f.limit)??20,Ue=n.useMemo(()=>rs((f==null?void 0:f.revisionType)??yt),[f,yt]),ft=n.useMemo(()=>{const D=f==null?void 0:f.revisionSettings,ce=rr(Ue,St);return jn(Ue,D??ce)},[f,St,Ue]),Qt=n.useMemo(()=>t.cogita.library.revision[Ue.labelKey]??yt,[t,yt,Ue]),Vt=n.useMemo(()=>Kt==="exact"?t.cogita.library.revision.checkValue:Kt,[t,Kt]),pe=c==="ready"?y[R]??null:null,$t=(pe==null?void 0:pe.checkType)==="translation-match"&&Be,Xt=n.useRef(new Map),qt=n.useRef(new Map),V=n.useRef(new Map),u=n.useRef(new Map),le=n.useMemo(()=>pe?pe.cardType==="vocab"?t.cogita.library.revision.vocabLabel:pe.infoType?nt(t,pe.infoType):t.cogita.library.revision.infoLabel:"",[t,pe]),H=n.useMemo(()=>{var ce;return Ue.id!=="levels"?y.length:((ce=Je.pool)==null?void 0:ce.length)??Ue.getFetchLimit(st,ft)},[Je,ft,Ue,y.length,st]),Qe=Ue.getProgressTotal?Ue.getProgressTotal(y,Je,st,ft):Ue.id==="levels"?Math.min(st,H):y.length,rt=Qe?Math.min(R+1,Qe):0,lt=Math.max(1,Number(ft.tries??1)),It=ft.compare??"anchors",Mt=Math.max(0,Math.min(100,Number(ft.minCorrectness??0))),wt=(ft.considerDependencies??"on")==="on",At=Math.max(0,Math.min(100,Number(ft.dependencyThreshold??85))),ha=D=>{const ce=D.slice();for(let je=ce.length-1;je>0;je-=1){const Ke=Math.floor(Math.random()*(je+1));[ce[je],ce[Ke]]=[ce[Ke],ce[je]]}return ce},ma=D=>xa(D,{treatSimilarCharsAsSame:!0})>=Mt,Ft=async()=>{const D=await ca(),ce=new Map,je=new Map;D.forEach(ke=>{const Ee=`${ke.itemType}:${ke.itemId}`,Me=ea(ke.itemType,ke.itemId,ke.checkType,ke.direction);ce.has(Ee)||ce.set(Ee,[]),ce.get(Ee).push(ke),je.has(Me)||je.set(Me,[]),je.get(Me).push(ke)});const Ke=new Map,De=new Map;return ce.forEach((ke,Ee)=>Ke.set(Ee,la(ke).score)),je.forEach((ke,Ee)=>De.set(Ee,la(ke).score)),{itemKnowness:Ke,cardKnowness:De}},ta=async D=>{const ce=Je,je=D.concat(ce.active??[]).concat(ce.pool??[]).filter((b,C,J)=>J.findIndex(be=>Se(be)===Se(b))===C);if(!wt){Nt(new Set(je.map(Se)));return}const{itemKnowness:Ke,cardKnowness:De}=await Ft(),ke=b=>{if(b.cardType!=="info"||b.infoType!=="citation"||b.checkType!=="quote-fragment")return!0;const C=Wt(b.direction);if(!(C!=null&&C.fragmentId))return!0;const J=b.description??"";if(!J.trim())return!0;const ye=va(J).nodes[C.fragmentId];if(!ye||!ye.leftId&&!ye.rightId)return!0;const ue=[ye.leftId,ye.rightId].filter(Te=>!!Te);if(ue.length===0)return!0;const we=ue.map(Te=>{const Oe=ea("info",b.cardId,"quote-fragment",Te);return De.get(Oe)??0});return we.reduce((Te,Oe)=>Te+Oe,0)/we.length>=At},Ee=(f==null?void 0:f.collectionId)??null,Me=Ee?Ct.filter(b=>Tt(b.childItemType)==="collection"&&b.childItemId===Ee&&!Tt(b.childCheckType)&&!Tt(b.childDirection)):[],Fe=Ee&&je.length>0?je.reduce((b,C)=>b+(De.get(Se(C))??0),0)/je.length:0,Ge=new Set;for(const b of je){if(b.cardType!=="info"){Ge.add(Se(b));continue}if(!ke(b))continue;const C=Ct.filter(ye=>ur(ye,b)).concat(Me);if(C.length===0){Ge.add(Se(b));continue}let J=0;for(const ye of C)if(Tt(ye.parentItemType)==="collection")J+=ye.parentItemId===Ee?Fe:0;else if(Tt(ye.parentCheckType)||Tt(ye.parentDirection)){const ue=Tt(ye.parentCheckType),we=Tt(ye.parentDirection),re=ea(ye.parentItemType,ye.parentItemId,ue,we);J+=De.get(re)??0}else{const ue=`${ye.parentItemType}:${ye.parentItemId}`;J+=Ke.get(ue)??0}J/C.length>=At&&Ge.add(Se(b))}Nt(Ge)},Ta=D=>{for(let ce=D;ce<y.length;ce+=1){const je=y[ce];if(je&&(!wt||je.cardType!=="info"||Et.has(Se(je))))return ce}return-1},ut=D=>!wt||D.cardType!=="info"||Et.has(Se(D)),_t=D=>{if(Ue.id!=="temporal"&&Ue.id!=="levels")return null;const ce=Je,je=(ce.active??[]).concat(ce.pool??[]),Ke=new Set;for(const De of je){const ke=Se(De);if(!(Ke.has(ke)||D.has(ke))&&(Ke.add(ke),ut(De)))return De}return null},Zt=n.useMemo(()=>{if(Ue.id!=="levels")return null;const D=Je,ce=D.pool??[],je=D.active??[],Ke=D.levelMap??{},De=Math.max(1,Number(ft.levels??1)),ke=Array.from({length:De},()=>0),Ee=new Set(je.map(b=>Se(b)));ce.forEach(b=>{const C=Math.min(De,Math.max(1,Ke[Se(b)]??1));ke[C-1]+=1});const Me=ce.length||1,Fe=ke.map(b=>b/Me*100),Ge=pe?Ke[Se(pe)]??1:null;return{counts:ke,percentages:Fe,currentLevel:Ge,levelsCount:De,activeCount:je.length,poolCount:ce.length,activeSet:Ee}},[Je,ft,Ue,pe]),wa=n.useMemo(()=>{if(Ue.id!=="temporal")return null;const D=Je,ce=D.pool??[],je=D.active??[],Ke=D.knownessMap??{},De=new Set(D.unknownSet??[]);let ke=0;ce.forEach(Fe=>{(Ke[Se(Fe)]??0)>1&&(ke+=1)});const Ee=De.size,Me=je.map(Fe=>({id:Se(Fe),value:De.has(Se(Fe))?0:Math.max(0,Math.min(1,Ke[Se(Fe)]??0))}));return{knownCount:ke,unknownCount:Ee,dots:Me}},[Je,Ue]),Wa=n.useMemo(()=>{if(!wt)return 0;const D=Je;return y.concat(D.active??[]).concat(D.pool??[]).filter((je,Ke,De)=>De.findIndex(ke=>Se(ke)===Se(je))===Ke).filter(je=>je.cardType==="info"&&!Et.has(Se(je))).length},[wt,Je,y,Et]);n.useEffect(()=>{if(!wt||Q!=="ready")return;const D=Je,je=y.concat(D.active??[]).concat(D.pool??[]).filter((ke,Ee,Me)=>Me.findIndex(Fe=>Se(Fe)===Se(ke))===Ee).filter(ke=>ke.cardType!=="info"||Et.has(Se(ke))).length,Ke=X.current;if(X.current=je,Ke===null||je<=Ke)return;const De=je-Ke;$(`New card available (+${De})`),ie.current&&window.clearTimeout(ie.current),ie.current=window.setTimeout(()=>$(null),2200)},[wt,Q,Je,y,Et]),n.useEffect(()=>()=>{ie.current&&window.clearTimeout(ie.current)},[]);const Gt=(D,ce)=>{const je=Ue.applyOutcome({queue:y,meta:Je},pe,st,ft,{correct:D,correctness:ce,createdUtc:new Date().toISOString()});de(je.queue),bt(je.meta);const Ke=je.queue[R+1];Ke&&zt(Ke,R+1)};n.useEffect(()=>{if(!d){j("error");return}j("loading"),Br({shareId:d,key:kt}).then(D=>{l(D),S(D.collectionName),x(D.libraryName),j("ready")}).catch(()=>{j("error")})},[d,kt]),n.useEffect(()=>{d&&zr({shareId:d,key:kt,type:"language"}).then(D=>p(D)).catch(()=>p([]))},[d,kt]),n.useEffect(()=>{!d||c!=="ready"||Or({shareId:d,key:kt}).then(D=>Ot(D.items??[])).catch(()=>Ot([]))},[d,kt,c]),n.useEffect(()=>{if(!d||c!=="ready")return;let D=!0;return(async()=>{N("loading"),q({current:0,total:Ue.id==="levels"?0:Ue.getFetchLimit(st,ft)});try{const je=[];let Ke=null,De=null;do{const C=await Vr({shareId:d,key:kt,limit:300,cursor:Ke});if(je.push(...C.items),(Ue.id==="levels"||Ue.id==="temporal")&&C.total&&(De=C.total),q(J=>({current:je.length,total:J.total||C.total||Ue.getFetchLimit(st,ft)})),Ke=C.nextCursor??null,De!==null&&je.length>=De||Ue.id!=="levels"&&Ue.id!=="temporal"&&je.length>=Ue.getFetchLimit(st,ft))break}while(Ke);if(!D)return;const ke=Oa(je);let Ee;if(Ue.id==="levels"){const C=Math.max(1,Number(ft.levels??1));Ee={},ke.forEach(J=>{const be=Se(J);Ee[be]=Math.max(1,Math.min(C,1))})}let Me=null,Fe=null,Ge=null;if(Ue.id==="temporal"){const C=await ca(),J=new Set(ke.map(ue=>Se(ue))),be=C.reduce((ue,we)=>{const re=ea(we.itemType,we.itemId,we.checkType,we.direction);return J.has(re)&&(ue[re]||(ue[re]=[]),ue[re].push(we)),ue},{});Me={},Fe=new Set,Ge={};const ye=Date.now();ke.forEach(ue=>{const we=Se(ue),re=be[we]??[];if(re.length===0){Me[we]=0,Fe.add(we),Ge[we]=[];return}const Te=as(re);Ge[we]=Te;const Oe=vn(Te,ye);Me[we]=Oe.knowness})}const b=Ue.id==="levels"?ss(ke,st,ft,Ee):Ue.id==="temporal"?ns(ke,st,ft,Me??{},Fe??new Set,Ge??{}):Ue.prepare(ke,st,ft);de(b.queue),bt(b.meta),me(0),N("ready"),q(C=>({current:Math.min(C.current,C.total),total:C.total}))}catch{D&&N("error")}})(),()=>{D=!1}},[d,kt,st,Ue,ft,c]),n.useEffect(()=>{ta(y)},[y,Ct,wt,At,f==null?void 0:f.collectionId]),n.useEffect(()=>{if(!pe||!wt){Lt(!1);return}if(pe.cardType!=="info"||Et.has(Se(pe))){Lt(!1);return}const D=Ta(R+1);if(D>=0){Lt(!1),me(D);return}if(Ue.id==="temporal"||Ue.id==="levels"){const ce=y.slice(0,R+1),je=y.slice(R+1).filter(ut),Ke=ce.concat(je),De=new Set(Ke.map(Se)),ke=_t(De);if(ke){const Me=Se(ke);De.has(Me)||(Ke.push(ke),De.add(Me),bt(Fe=>{const Ge=Fe,b=new Set(Ge.queued??[]);return b.add(Me),{...Ge,queued:b}}))}const Ee=Ke.findIndex((Me,Fe)=>Fe!==R&&ut(Me));if(Ee>=0){de(Ke),me(Ee),Lt(!1);return}}Lt(!0)},[pe,Et,wt,R,y,Je,Ue.id]),n.useEffect(()=>{if(Z(""),G(null),ae(null),U(0),ne([]),Ae({}),Re({}),ct(null),We(null),Ve(null),T(!1),_e(!1),P(null),tt(null),Ye({}),!pe){A(null),W(null);return}pe.cardType==="info"&&pe.infoType==="computed"&&A(t.cogita.library.revision.loadingComputed);let D=!0;return zt(pe,R).then(ce=>{!D||!ce||(A(ce.prompt),W(ce.expectedAnswer),ne(ce.computedExpected),Ae(ce.computedAnswers),ct(ce.answerTemplate),We(ce.outputVariables),Ve(ce.variableValues))}),()=>{D=!1}},[pe,d,t]),n.useEffect(()=>{if(!pe||pe.cardType!=="info"||pe.infoType!=="citation"){mt.current=null,pt.current=new Set,fe(null);return}const D=pe.description??"",ce=(pe.label??"").trim(),je=ce.replace(/\s+/g," ").trim(),Ke=D.replace(/\s+/g," ").trim(),De=je&&je!==Ke?ce:t.cogita.library.infoTypes.citation;if(!D){fe(null),W(null);return}const ke=va(D);mt.current=ke,A(De);let Ee=!0;return ca().then(Me=>{if(!Ee)return;const Fe=new Map;Me.forEach(be=>{if(be.itemType!=="info"||be.checkType!=="quote-fragment"||!be.direction)return;const ye=Wt(be.direction);if(!ye)return;const ue=`${be.itemId}:${ye.fragmentId}`;Fe.has(ue)||Fe.set(ue,[]),Fe.get(ue).push(be)});const Ge={},b=new Set;Fe.forEach((be,ye)=>{const[ue,we]=ye.split(":",2);if(ue!==pe.cardId)return;const re=la(be).score;Ge[we]=re,re>=At&&b.add(we)}),pt.current=b,jt.current=Ge;const C=Wt(pe.direction);if(C!=null&&C.fragmentId&&ke.nodes[C.fragmentId]){sa(ke,C.fragmentId,De);return}const J=$a(ke,b,Ge,At,wt,pe.direction);sa(ke,(J==null?void 0:J.id)??null,De)}).catch(()=>{pt.current=new Set,jt.current={};const Me=Wt(pe.direction);if(Me!=null&&Me.fragmentId&&ke.nodes[Me.fragmentId]){sa(ke,Me.fragmentId,De);return}const Fe=$a(ke,pt.current,{},At,wt,pe.direction);sa(ke,(Fe==null?void 0:Fe.id)??null,De)}),()=>{Ee=!1}},[pe,t,wt,At]),n.useEffect(()=>{if(!pe||pe.cardType!=="vocab"||pe.checkType!=="translation-match"){tt(null),Ye({});return}const je=(Je.pool??Je.active??y).filter(Me=>Me.cardType==="vocab"&&Me.checkType==="translation-match").filter((Me,Fe,Ge)=>Ge.findIndex(b=>b.cardId===Me.cardId)===Fe);je.some(Me=>Me.cardId===pe.cardId)||je.unshift(pe);const De=ha(je).slice(0,6).map(Me=>{const Fe=Me.label.split("↔").map(C=>C.trim()).filter(Boolean);if(Fe.length<2)return null;const Ge=`${Me.cardId}:L`,b=`${Me.cardId}:R`;return{cardId:Me.cardId,leftId:Ge,rightId:b,leftLabel:Fe[0],rightLabel:Fe[1]}}).filter(Boolean),ke=De.map(Me=>Me.leftId),Ee=ha(De.map(Me=>Me.rightId));tt({pairs:De,leftOrder:ke,rightOrder:Ee,selection:{},activeLeft:null,activeRight:null,locked:{}})},[pe,y,Je]),n.useEffect(()=>()=>{E.current&&window.clearTimeout(E.current),M.current&&window.clearTimeout(M.current)},[]);const Ca=n.useRef(null);n.useEffect(()=>{if(!pe)return;const D=Se(pe),ce=typeof document<"u"?document.activeElement:null;if(Ca.current===D&&ce&&(ce.tagName==="INPUT"||ce.tagName==="TEXTAREA"))return;let je=0;const Ke=()=>{if(pe){if(pe.cardType==="info"&&pe.infoType==="computed"){if(se.length>0){const ke=hn(et,se,Ce),Ee=ke?$e.current[ke]:null;if(Ee&&(Ee.focus(),document.activeElement===Ee)){Ca.current=D;return}}if(oe.current&&(oe.current.focus(),document.activeElement===oe.current)){Ca.current=D;return}}else if(pe.cardType==="vocab"&&oe.current&&(oe.current.focus(),document.activeElement===oe.current)){Ca.current=D;return}je<6&&(je+=1,window.setTimeout(Ke,40))}},De=window.setTimeout(Ke,40);return()=>window.clearTimeout(De)},[pe,se,et,Ce]),n.useEffect(()=>{if(!qe)return;const D=ce=>{ce.key==="Enter"&&(ce.preventDefault(),Ut())};return window.addEventListener("keydown",D),()=>window.removeEventListener("keydown",D)},[qe]);const Ia=D=>{ge(D),he(la(D))};n.useEffect(()=>{if(!pe){he(null),ge([]);return}const D=pe.cardType==="info"?"info":"connection";if(pe.cardType==="info"&&pe.infoType==="citation"){ca().then(ce=>{const je=ce.filter(Ke=>Ke.itemType==="info"&&Ke.itemId===pe.cardId&&Ke.checkType==="quote-fragment"&&dn(Ke.direction,pe.direction));Ia(je)}).catch(()=>{he(null),ge([])});return}cn(D,pe.cardId,pe.checkType,pe.direction).then(ce=>Ia(ce)).catch(()=>{he(null),ge([])})},[pe]);const Pa=(D,ce,je,Ke)=>{if(D==="info"&&je==="quote-fragment"){ca().then(De=>{const ke=De.filter(Ee=>Ee.itemType==="info"&&Ee.itemId===ce&&Ee.checkType==="quote-fragment"&&dn(Ee.direction,Ke));Ia(ke)}).catch(()=>{he(null),ge([])});return}cn(D,ce,je,Ke).then(De=>Ia(De)).catch(()=>{he(null),ge([])})},Qa=(D,ce,je)=>{var Ee;const Ke=((Ee=je.pairs.find(Me=>Me.leftId===D))==null?void 0:Ee.rightId)??null;if(!Ke)return je;const De=Ke===ce;Ye(Me=>({...Me,[D]:De?"correct":"incorrect"})),E.current&&window.clearTimeout(E.current),M.current&&window.clearTimeout(M.current),Ie.current+=1;const ke={kind:De?"correct":"incorrect",tick:Ie.current};if(Xe(null),E.current=window.setTimeout(()=>Xe(ke),0),M.current=window.setTimeout(()=>Xe(null),420),De){const Me={...je.locked,[D]:!0};return Object.keys(Me).length>=je.pairs.length?(G("correct"),_e(!0)):G("correct"),{...je,selection:{...je.selection,[D]:ce},activeLeft:null,activeRight:null,locked:Me}}return G("incorrect"),{...je,activeLeft:null,activeRight:null}},Ea=D=>{tt(ce=>!ce||ce.locked[D]?ce:ce.activeRight?Qa(D,ce.activeRight,ce):{...ce,activeLeft:ce.activeLeft===D?null:D})},kn=D=>{tt(ce=>ce&&(ce.activeLeft?Qa(ce.activeLeft,D,ce):{...ce,activeRight:ce.activeRight===D?null:D}))},Ut=()=>{var D;if(pe&&pe.cardType==="info"&&pe.infoType==="citation"&&mt.current&&O&&!((D=Wt(pe.direction))!=null&&D.fragmentId)){const ce=$a(mt.current,pt.current,jt.current,At,wt,pe.direction,O.fragmentId);if(ce){G(null),Z(""),T(!1),Re({}),_e(!1),ae(null),U(0),sa(mt.current,ce.id,O.title);return}}G(null),Z(""),T(!1),Re({}),_e(!1),ae(null),U(0),me(ce=>Math.min(ce+1,y.length))},Jt=D=>{if(!pe)return;const ce=D.expected??null,je=D.answer??"";let Ke=ce??"",De=je;if(!ce&&D.expectedMap&&D.answerMap){const C=Object.keys(D.expectedMap).sort((J,be)=>J.localeCompare(be));Ke=C.map(J=>{var be;return((be=D.expectedMap)==null?void 0:be[J])??""}).join("|"),De=C.map(J=>{var be;return((be=D.answerMap)==null?void 0:be[J])??""}).join("|")}const ke=Ke?Ra(Ke,De,It):new Uint8Array,Ee={revisionType:Ue.id,evalType:D.evalType,direction:D.direction,prompt:L??"",expected:ce,answer:je,expectedAnswers:D.expectedMap??null,answers:D.answerMap??null,correct:D.correct,maskBase64:ke.length?ya(ke):null,checkMode:Kt,compareMode:It,minCorrectness:Mt},Me=new TextEncoder().encode(JSON.stringify(Ee)),Fe=pe.cardType==="info"?"info":"connection",Ge=D.overrideCheckType??pe.checkType??null,b=D.overrideDirection??pe.direction??null;ln({itemType:Fe,itemId:pe.cardId,checkType:Ge,direction:b,revisionType:Ue.id,evalType:D.evalType,correct:D.correct,maskBase64:ke.length?ya(ke):null,payloadBase64:ya(Me)}).then(()=>{Pa(Fe,pe.cardId,Ge,b),ta(y)}).catch(()=>{})},Nn=(D,ce)=>{const je=Xt.current.get(ce);if(je)return Promise.resolve(je);const Ke=qt.current.get(ce);if(Ke)return Ke;const De=qr({shareCode:d,infoId:D,key:kt}).then(ke=>{var C,J;const Ee=ke.payload,Me=((C=Ee.definition)==null?void 0:C.graph)??null,Fe="",Ge=((J=Ee.definition)==null?void 0:J.answerTemplate)??"",b=ir(Me,Fe,Ge);if(b){const ye={sample:or(b),answerTemplate:Ge||null};return Xt.current.set(ce,ye),ye}return ds({shareId:d,infoId:D,key:kt}).then(be=>{const ye={sample:be,answerTemplate:null};return Xt.current.set(ce,ye),ye})}).catch(()=>ds({shareId:d,infoId:D,key:kt}).then(ke=>{const Ee={sample:ke,answerTemplate:null};return Xt.current.set(ce,Ee),Ee}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{qt.current.delete(ce)});return qt.current.set(ce,De),De},zt=(D,ce)=>{var Me;const je=`${Se(D)}:${ce}`,Ke=V.current.get(je);if(Ke)return Promise.resolve(Ke);const De=u.current.get(je);if(De)return De;const ke=Fe=>(V.current.set(je,Fe),Fe);let Ee;if(D.cardType==="vocab"){if(D.checkType==="translation-match")return Ee=Promise.resolve(ke({prompt:D.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),Ee;const Fe=D.label.split("↔").map(Ge=>Ge.trim()).filter(Boolean);if(Fe.length>=2){const b=(D.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",C=b?Fe[0]:Fe[1],J=b?Fe[1]:Fe[0];Ee=Promise.resolve(ke({prompt:C,expectedAnswer:J,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else Ee=Promise.resolve(ke({prompt:D.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(D.cardType==="info"&&D.infoType==="word"){const Fe=(Me=D.description)!=null&&Me.startsWith("Language: ")?D.description.replace("Language: ",""):null;Ee=Promise.resolve(ke({prompt:D.label,expectedAnswer:Fe,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else D.cardType==="info"&&D.infoType==="computed"?Ee=Nn(D.cardId,je).then(Fe=>{var be,ye;if(!Fe.sample)return ke({prompt:D.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const Ge=Fe.sample,b=Ge.expectedAnswers?Object.entries(Ge.expectedAnswers).map(([ue,we])=>({key:ue,expected:we})):[],C=b.reduce((ue,we)=>(ue[we.key]="",ue),{}),J=Ge.expectedAnswerIsSentence&&((be=Ge.expectedAnswer)==null?void 0:be.trim())||null;return ke({prompt:Ge.prompt,expectedAnswer:b.length>0?J:((ye=Ge.expectedAnswer)==null?void 0:ye.trim())||null,computedExpected:b,computedAnswers:C,answerTemplate:Fe.answerTemplate,outputVariables:Ge.outputVariables??null,variableValues:Ge.variableValues??null})}).catch(()=>ke({prompt:D.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{u.current.delete(je)}):Ee=Promise.resolve(ke({prompt:D.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return u.current.set(je,Ee),Ee},sa=(D,ce,je)=>{const Ke=Object.keys(D.nodes).length,De=pt.current.size;if(!ce){fe({title:je,before:D.text,after:"",fragmentId:null,total:Ke,completed:De}),W(null),_e(!0);return}const ke=D.nodes[ce];if(!ke)return;const Ee=xn(D.text,ke);fe({title:je,before:Ee.before,after:Ee.after,fragmentId:ke.id,total:Ke,completed:De}),W(Ee.fragment),_e(!1)},Ma=()=>{const D=mt.current;D&&fe(ce=>ce&&{...ce,total:Object.keys(D.nodes).length,completed:pt.current.size})},ja=()=>{const D=y[R+1];D&&zt(D,R+1)},Fa=()=>{if(ja(),pe&&pe.cardType==="vocab"&&pe.checkType==="translation-match"&&Be){if(Be.pairs.length===0){G("incorrect"),_e(!0);return}const ke=Be.pairs.reduce((J,be)=>(J[be.rightId]=be.rightLabel,J),{});let Ee=0;const Me={};Be.pairs.forEach(J=>{const ye=Be.selection[J.leftId]===J.rightId;Me[J.leftId]=ye?"correct":"incorrect",ye&&(Ee+=1)});const Fe=Be.pairs.length||1,Ge=Ee/Fe,b=Ee===Be.pairs.length;Ye(J=>({...J,...Me})),b?(G("correct"),_e(!0),U(0)):(G("incorrect"),_e(!1),U(J=>{const be=J+1;return be>=lt&&(T(!0),_e(!0),tt(ye=>{if(!ye)return ye;const ue=ye.pairs.reduce((we,re)=>(we[re.leftId]=re.rightId,we),{});return{...ye,selection:ue}})),be})),Gt(b,Ge);const C="connection";Promise.all(Be.pairs.map(J=>{const be=Be.selection[J.leftId]??null,ye=be?ke[be]:"",ue={left:J.leftLabel,expected:J.rightLabel,answer:ye,checkType:"translation-match"},we=new TextEncoder().encode(JSON.stringify(ue));return ln({itemType:C,itemId:J.cardId,checkType:"translation-match",direction:null,revisionType:Ue.id,evalType:"translation-match",correct:be===J.rightId,maskBase64:null,payloadBase64:ya(we)})})).then(()=>{Pa(C,pe.cardId,pe.checkType,pe.direction),ta(y)}).catch(()=>{});return}if(se.length>0){const ke=se.reduce((Me,Fe)=>{const Ge=Ne[Fe.key]??"";return Me[Fe.key]=Dt(Ge)===Dt(Fe.expected)?"correct":"incorrect",Me},{});se.every(({key:Me,expected:Fe})=>{const Ge=Ne[Me]??"";return Kt==="exact"&&Dt(Ge)===Dt(Fe)})?(G("correct"),Re(ke),_e(!0),U(0),Gt(!0,1),Jt({correct:!0,direction:L?`${L} -> computed`:"computed",expectedMap:se.reduce((Me,Fe)=>(Me[Fe.key]=Fe.expected,Me),{}),answerMap:Ne,evalType:"computed"})):(G("incorrect"),Re(ke),_e(!1),U(Me=>{const Fe=Me+1;return Fe>=lt&&ga&&(T(!0),_e(!0)),Fe}),Gt(!1,0),window.setTimeout(()=>{var Fe;const Me=hn(et,se,Ce);Me&&$e.current[Me]&&((Fe=$e.current[Me])==null||Fe.focus())},40),Jt({correct:!1,direction:L?`${L} -> computed`:"computed",expectedMap:se.reduce((Me,Fe)=>(Me[Fe.key]=Fe.expected,Me),{}),answerMap:Ne,evalType:"computed"}));return}if(pe&&pe.cardType==="info"&&pe.infoType==="citation"&&(O!=null&&O.fragmentId)){if(!z)return;const ke=Wt(pe.direction),Ee=(ke==null?void 0:ke.fragmentId)??O.fragmentId,Me=Sa(z,K,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Fe=Me.mask,Ge=Me.isCorrect,b=Me.percent;Ge?(jt.current[O.fragmentId]=Math.max(jt.current[O.fragmentId]??0,b),(jt.current[O.fragmentId]??0)>=At&&pt.current.add(O.fragmentId),Ma(),G("correct"),Re({}),_e(!0),ae(Fe),U(0),b<100&&lt<=1&&T(!0),Gt(!0,b/100),Jt({correct:!0,direction:`quote:${O.fragmentId}`,expected:z,answer:K,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Ee})):(G("incorrect"),Re({}),_e(!1),ae(Fe),U(C=>{const J=C+1;return J>=lt&&ga&&(T(!0),_e(!0)),J}),Gt(!1,b/100),window.setTimeout(()=>{var C;return(C=oe.current)==null?void 0:C.focus()},40),Jt({correct:!1,direction:`quote:${O.fragmentId}`,expected:z,answer:K,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Ee}));return}if(!z)return;const D=Ra(z,K,It),ce=Kt==="exact"&&Dt(K)===Dt(z),je=ma(D),Ke=ce||je,De=xa(D);Ke?(G("correct"),Re({}),_e(!0),ae(D),U(0),De<100&&lt<=1&&T(!0),Gt(!0,De/100),Jt({correct:!0,direction:L?`${L} -> ${z}`:null,expected:z,answer:K,evalType:"text"})):(G("incorrect"),Re({}),_e(!1),ae(D),U(ke=>{const Ee=ke+1;return Ee>=lt&&ga&&(T(!0),_e(!0)),Ee}),Gt(!1,De/100),window.setTimeout(()=>{var ke;return(ke=oe.current)==null?void 0:ke.focus()},40),Jt({correct:!1,direction:L?`${L} -> ${z}`:null,expected:z,answer:K,evalType:"text"}))},Sn=D=>{if(ja(),!z)return;const ce=Ra(z,D,It),je=Dt(D)===Dt(z),Ke=ma(ce),De=je||Ke,ke=xa(ce);De?(G("correct"),Re({}),_e(!0),ae(ce),U(0),ke<100&&lt<=1&&T(!0),Gt(!0,ke/100),Jt({correct:!0,direction:"word->language",expected:z,answer:D,evalType:"language-select"})):(G("incorrect"),Re({}),_e(!1),ae(ce),U(Ee=>{const Me=Ee+1;return Me>=lt&&ga&&(T(!0),_e(!0)),Me}),Gt(!1,ke/100),Jt({correct:!1,direction:"word->language",expected:z,answer:D,evalType:"language-select"}))},Tn=D=>{var je;if(D.key!=="Enter")return;if(D.preventDefault(),D.stopPropagation(),qe){Ut();return}const ce=se.find(Ke=>!(Ne[Ke.key]??"").trim());if(ce){(je=$e.current[ce.key])==null||je.focus();return}Fa()},La=()=>{ja(),G("correct"),_e(!0),U(0),Gt(!0,1),z&&Jt({correct:!0,direction:"manual",expected:z,answer:K,evalType:"manual"})},aa=()=>{if(Gt(!1,0),pe&&pe.cardType==="info"&&pe.infoType==="citation"){G(null),Z(""),T(!1),Re({}),_e(!1),ae(null),U(0),me(D=>Math.min(D+1,y.length));return}Ut()};n.useEffect(()=>{ja()},[R,y]);const Cn=t.cogita.library.revision.revealModeAfterIncorrect,ga=se.length>0||!!z;return e.jsxs(Pt,{copy:t,authLabel:a,showProfileMenu:r,onProfileNavigate:s,onToggleSecureMode:i,onLogout:o,secureMode:h,onNavigate:v,language:m,onLanguageChange:w,children:[(c==="loading"||Q==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:c==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${ee.total?Math.min(100,Math.max(0,ee.current/ee.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:ee.total?`${Math.min(ee.current,ee.total)} / ${ee.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:g}),e.jsx("p",{className:"cogita-library-subtitle",children:F}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",Qt).replace("{check}",Vt)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:I?`${I.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Zt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Zt.currentLevel??"-"," / ",Zt.levelsCount]}):null,I?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(I.correct)).replace("{total}",String(I.total))}),I.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(I.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(lr,{outcomes:xe})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[te?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:te})}):null,e.jsx(es,{feedbackToken:ze?`${ze.kind}-${ze.tick}`:$t?"idle":Le??"idle",children:c!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:c==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):pe?e.jsx(e.Fragment,{children:ua?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(ts,{copy:t,currentCard:pe,currentTypeLabel:le,prompt:L,languages:B,answer:K,onAnswerChange:D=>Z(ce=>un(ce,D,_)),computedExpected:se,computedAnswers:Ne,onComputedAnswerChange:(D,ce)=>Ae(je=>({...je,[D]:un(je[D]??"",ce,_)})),answerTemplate:et,outputVariables:Ce,variableValues:xt,computedFieldFeedback:Pe,feedback:Le,canAdvance:qe,quoteContext:O,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Fa,onSkip:aa,onLanguageSelect:Sn,onMarkReviewed:La,onAdvance:Ut,showCorrectAnswer:k,setShowCorrectAnswer:T,onRevealCorrect:()=>_e(!0),answerMask:Y,expectedAnswer:z,hasExpectedAnswer:ga,handleComputedKeyDown:Tn,answerInputRef:oe,computedInputRefs:$e,scriptMode:_,setScriptMode:P,matchPairs:Be==null?void 0:Be.pairs,matchLeftOrder:Be==null?void 0:Be.leftOrder,matchRightOrder:Be==null?void 0:Be.rightOrder,matchSelection:Be==null?void 0:Be.selection,matchActiveLeft:Be==null?void 0:Be.activeLeft,matchActiveRight:Be==null?void 0:Be.activeRight,matchFeedback:ot,onMatchLeftSelect:Ea,onMatchRightSelect:kn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Qe?`${rt} / ${Qe}`:t.cogita.library.revision.progressUnlimited}),c==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),c==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),c==="ready"&&Q==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),c==="ready"&&Q==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),c==="ready"&&Q==="ready"&&y.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Cn}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",lt]})]})]}),Zt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Zt.activeCount," / ",Zt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Zt.counts.map((D,ce)=>{const je=ce+1,Ke=Zt.currentLevel===je,De=Zt.percentages[ce]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":Ke,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:je}),e.jsx("strong",{children:D})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,De))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[De.toFixed(1),"%"]})]},`level-${je}`)})})]}):null,wa?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:wa.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:wa.dots.map(D=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-D.value))}, ${Math.round(200*D.value)}, 80, 0.9)`}},D.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:wa.knownCount})]})]}):null,wt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Wa})]})}):null]})]})]})})})]})]})}const Eo=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:jo},Symbol.toStringTag,{value:"Module"})),oa=t=>String(t??"").trim().toLocaleLowerCase(),gn=t=>Array.from(new Set(t.map(a=>Number(a)).filter(Number.isFinite))).sort((a,r)=>a-r),Bs=t=>t.map(a=>a.join(",")).sort().join("|");function ko(t){const a=[...t];for(let r=a.length-1;r>0;r-=1){const s=Math.floor(Math.random()*(r+1));[a[r],a[s]]=[a[s],a[r]]}return a}function zs(t){const a=t.map((i,o)=>({value:i,oldIndex:o}));for(let i=a.length-1;i>0;i-=1){const o=Math.floor(Math.random()*(i+1));[a[i],a[o]]=[a[o],a[i]]}const r=a.map(i=>i.value),s=new Map;return a.forEach((i,o)=>s.set(i.oldIndex,o)),{values:r,oldToNew:s}}function No(t){const a=t.split("↔").map(r=>r.trim()).filter(Boolean);return a.length>=2?[a[0],a[1]]:null}function So(t){if(!t)return null;const a=t.indexOf(":");return a>=0?t.slice(a+1).trim():t.trim()}function To(t,a,r,s){const i=typeof r.type=="string"?r.type:"",o=typeof r.title=="string"&&r.title.trim()?r.title.trim():a,h=typeof r.question=="string"?r.question:a;if(!i||!h)return null;if(i==="selection"){const v=Array.isArray(r.options)?r.options.filter(f=>typeof f=="string"):[],m=Array.isArray(r.answer)?gn(r.answer):[],w=zs(v),d=m.map(f=>w.oldToNew.get(f)).filter(f=>Number.isInteger(f)).sort((f,l)=>f-l);return{roundIndex:s,cardKey:`info:${t}:question-selection`,publicPrompt:{kind:"selection",title:o,prompt:h,options:w.values,multiple:!0,cardLabel:"question"},reveal:{kind:"selection",expected:d,title:o},grade:f=>{const l=Array.isArray(f)?gn(f):[];return JSON.stringify(l)===JSON.stringify(d)}}}if(i==="truefalse"){const v=!!r.answer;return{roundIndex:s,cardKey:`info:${t}:question-truefalse`,publicPrompt:{kind:"boolean",title:o,prompt:h,cardLabel:"question"},reveal:{kind:"boolean",expected:v,title:o},grade:m=>!!m===v}}if(i==="text"||i==="number"||i==="date"){const v=String(r.answer??"");return{roundIndex:s,cardKey:`info:${t}:question-${i}`,publicPrompt:{kind:"text",title:o,prompt:h,inputType:i==="number"?"number":i==="date"?"date":"text",cardLabel:"question"},reveal:{kind:"text",expected:v,title:o},grade:m=>{if(i==="number"){const w=Number(m),d=Number(v);return Number.isFinite(w)&&Number.isFinite(d)&&Math.abs(w-d)<1e-9}return oa(m)===oa(v)}}}if(i==="ordering"){const v=Array.isArray(r.options)?r.options.filter(w=>typeof w=="string"):[],m=ko(v);return{roundIndex:s,cardKey:`info:${t}:question-ordering`,publicPrompt:{kind:"ordering",title:o,prompt:h,options:m,cardLabel:"question"},reveal:{kind:"ordering",expected:v,title:o},grade:w=>JSON.stringify(Array.isArray(w)?w.map(String):[])===JSON.stringify(v)}}if(i==="matching"){const m=(Array.isArray(r.columns)?r.columns.map(l=>Array.isArray(l)?l.filter(c=>typeof c=="string"):[]):[]).map(l=>zs(l)),w=r.answer??{},f=(Array.isArray(w.paths)?w.paths.map(l=>Array.isArray(l)?l.map(c=>Number(c)).filter(Number.isFinite):null).filter(l=>Array.isArray(l)):[]).map(l=>l.map((c,j)=>{var g;return((g=m[j])==null?void 0:g.oldToNew.get(c))??c}));return{roundIndex:s,cardKey:`info:${t}:question-matching`,publicPrompt:{kind:"matching",title:o,prompt:h,columns:m.map(l=>l.values),cardLabel:"question"},reveal:{kind:"matching",expected:{paths:f},title:o},grade:l=>{const c=l??{},j=Array.isArray(c.paths)?c.paths.map(g=>Array.isArray(g)?g.map(S=>Number(S)).filter(Number.isFinite):null).filter(g=>Array.isArray(g)):[];return Bs(j)===Bs(f)}}}return null}async function Co(t){var f,l;const a=await Zn({libraryId:t.libraryId,revisionId:t.revisionId}),s=(await qa({libraryId:t.libraryId,collectionId:a.collectionId,limit:1e3})).items,i=Array.from(new Set(s.filter(c=>c.cardType==="info").map(c=>c.cardId))),o=new Map;await Promise.all(i.map(async c=>{try{const j=await na({libraryId:t.libraryId,infoId:c});o.set(c,{infoType:j.infoType,payload:j.payload})}catch{}}));const h=new Map;await Promise.all(Array.from(o.entries()).filter(([,c])=>c.infoType==="computed").map(async([c])=>{try{const j=await Un({libraryId:t.libraryId,infoId:c});h.set(c,j)}catch{}}));const v=Array.from(new Set(s.filter(c=>c.cardType==="vocab").map(c=>c.label))).filter(Boolean),m={selectMatchingPairPrompt:((f=t.labels)==null?void 0:f.selectMatchingPairPrompt)??"Select the matching pair",wordLanguagePromptPrefix:((l=t.labels)==null?void 0:l.wordLanguagePromptPrefix)??"Language of"},w=[],d=new Set;for(const c of s){if(c.cardType==="vocab"){const g=No(c.label);if(!g)continue;if(c.checkType==="translation"&&c.direction==="a-to-b"){const[S,F]=g;w.push({roundIndex:w.length,cardKey:`connection:${c.cardId}:translation:a-to-b`,publicPrompt:{kind:"text",title:c.label,prompt:S,cardLabel:c.description??void 0},reveal:{kind:"text",expected:F,title:c.label},grade:x=>oa(x)===oa(F)})}else if(c.checkType==="translation"&&c.direction==="b-to-a"){const[S,F]=g;w.push({roundIndex:w.length,cardKey:`connection:${c.cardId}:translation:b-to-a`,publicPrompt:{kind:"text",title:c.label,prompt:F,cardLabel:c.description??void 0},reveal:{kind:"text",expected:S,title:c.label},grade:x=>oa(x)===oa(S)})}else if(c.checkType==="translation-match"){const S=Array.from(new Set([c.label,...v.filter(x=>x!==c.label).slice(0,3)])),F=S.findIndex(x=>x===c.label);w.push({roundIndex:w.length,cardKey:`connection:${c.cardId}:translation-match`,publicPrompt:{kind:"selection",title:c.label,prompt:m.selectMatchingPairPrompt,options:S,multiple:!1,cardLabel:c.description??void 0},reveal:{kind:"selection",expected:[F],title:c.label},grade:x=>{const y=Array.isArray(x)?gn(x):gn([x]);return y.length===1&&y[0]===F}})}continue}if(c.cardType!=="info")continue;const j=o.get(c.cardId);if(j){if(j.infoType==="word"&&c.checkType==="word-language"){const g=So(c.description);if(!g)continue;w.push({roundIndex:w.length,cardKey:`info:${c.cardId}:word-language:${c.direction??""}`,publicPrompt:{kind:"text",title:c.label,prompt:`${m.wordLanguagePromptPrefix}: ${c.label}`,cardLabel:"word-language"},reveal:{kind:"text",expected:g,title:c.label},grade:S=>oa(S)===oa(g)});continue}if(j.infoType==="computed"&&c.checkType==="computed"){const g=h.get(c.cardId);if(!g)continue;w.push({roundIndex:w.length,cardKey:`info:${c.cardId}:computed`,publicPrompt:{kind:"text",title:c.label,prompt:g.prompt,multiLine:!1,cardLabel:"computed"},reveal:{kind:"text",expected:g.expectedAnswer,title:c.label},grade:S=>oa(S)===oa(g.expectedAnswer)});continue}if(j.infoType==="question"){const g=j.payload,S=g.definition??g,F=To(c.cardId,c.label,S,w.length);F&&(F.roundIndex=w.length,w.push(F));continue}if(j.infoType==="citation"&&!d.has(c.cardId)){d.add(c.cardId);const g=j.payload,S=typeof g.text=="string"?g.text:"",F=typeof g.title=="string"&&g.title.trim()?g.title.trim():c.label;if(!S.trim())continue;const x=va(S,{minLen:7,maxLen:13});for(const y of x.order){const de=x.nodes[y];if(!de)continue;const B=xn(S,de);w.push({roundIndex:w.length,cardKey:`info:${c.cardId}:quote-fragment:${y}`,publicPrompt:{kind:"citation-fragment",title:F,before:B.before,after:B.after,fragmentId:y,cardLabel:"quote-fragment"},reveal:{kind:"citation-fragment",expected:B.fragment,title:F},grade:p=>Sa(B.fragment,String(p??""),{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}).isCorrect})}continue}}}return w.map((c,j)=>({...c,roundIndex:j}))}function Io(t){const{libraryId:a,revisionId:r}=t,s=t.copy.cogita.library.revision,i=s.live,[o,h]=n.useState(null),[v,m]=n.useState([]),[w,d]=n.useState("loading"),[f,l]=n.useState(null),c=`cogita.live.host.${a}.${r}`,j=o?v[o.currentRoundIndex]??null:null,g=o!=null&&o.status&&o.status!=="lobby"?o.currentPrompt??null:null,S=(o==null?void 0:o.currentReveal)??null,F=n.useMemo(()=>o!=null&&o.code&&typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision/${encodeURIComponent(o.code)}`:"",[o==null?void 0:o.code]),x=(o==null?void 0:o.status)==="finished"?"finished":o!=null&&o.status&&o.status!=="lobby"?"active":"lobby",y=(K,Z)=>K.replace(/\{(\w+)\}/g,(Le,G)=>String(Z[G]??"")),de={lobby:i.statusLobby,running:i.statusRunning,revealed:i.statusRevealed,finished:i.statusFinished},B=(K,Z,Le)=>({...K,hostSecret:K.hostSecret||(Z==null?void 0:Z.hostSecret)||(Le==null?void 0:Le.hostSecret)||"",code:K.code||(Z==null?void 0:Z.code)||(Le==null?void 0:Le.code)||""});n.useEffect(()=>{let K=!1;return Co({libraryId:a,revisionId:r,labels:{selectMatchingPairPrompt:i.selectMatchingPairPrompt,wordLanguagePromptPrefix:i.wordLanguagePromptPrefix}}).then(Z=>{K||m(Z)}).catch(()=>{K||(l(i.loadRoundsError),d("error"))}),()=>{K=!0}},[a,i.selectMatchingPairPrompt,i.wordLanguagePromptPrefix,r]),n.useEffect(()=>{let K=!1;async function Z(){try{typeof localStorage<"u"&&localStorage.removeItem(c);const Le=await Jr({libraryId:a,revisionId:r,title:i.hostKicker});if(K)return;h(Le),localStorage.setItem(c,JSON.stringify({sessionId:Le.sessionId,hostSecret:Le.hostSecret,code:Le.code})),d("ready")}catch{if(K)return;l(i.createSessionError),d("error")}}return Z(),()=>{K=!0}},[a,r,c]),n.useEffect(()=>{if(!o)return;const K=window.setInterval(async()=>{try{const Z=await Ur({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret});h(Le=>B(Z,Le))}catch{}},1200);return()=>window.clearInterval(K)},[a,o]);const p=async K=>{if(!o)return;const Z=Object.prototype.hasOwnProperty.call(K,"currentPrompt"),Le=Object.prototype.hasOwnProperty.call(K,"currentReveal"),G=await Wr({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret,status:K.status??o.status,currentRoundIndex:K.currentRoundIndex??o.currentRoundIndex,revealVersion:K.revealVersion??o.revealVersion,currentPrompt:Z?K.currentPrompt??null:o.currentPrompt??null,currentReveal:Le?K.currentReveal??null:o.currentReveal??null});h(L=>B(G,L))},Q=async K=>{const Z=v[K];!Z||!o||await p({status:"running",currentRoundIndex:K,revealVersion:o.revealVersion+1,currentReveal:null,currentPrompt:{...Z.publicPrompt,roundIndex:K,cardKey:Z.cardKey}})},N=async()=>{v.length&&await Q((o==null?void 0:o.currentRoundIndex)??0)},ee=async()=>{if(!o||!j)return;const K=new Map(o.currentRoundAnswers.map(G=>[G.participantId,G.answer])),Z=o.participants.map(G=>{const L=K.get(G.participantId),A=j.grade(L);return{participantId:G.participantId,isCorrect:A,pointsAwarded:A?1:0}}),Le=await Hr({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret,scores:Z});h(G=>B(Le,G)),await p({status:"revealed",revealVersion:Le.revealVersion+1,currentReveal:j.reveal})},q=async()=>{if(!o)return;const K=o.currentRoundIndex+1;if(K>=v.length){await p({status:"finished",currentReveal:null});return}await Q(K)},R=async()=>{if(o){if(o.status==="running"){await ee();return}if(o.status==="revealed"){await q();return}o.status==="lobby"&&await N()}},me=(K,Z)=>{if(!K)return e.jsx("p",{className:"cogita-help",children:i.waitingForHostQuestion});const Le=String(K.kind??""),G=typeof Z<"u",L=Array.isArray(Z)?Z.map(A=>Number(A)).filter(Number.isFinite):[];if(Le==="citation-fragment")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":G?"correct":"idle",children:[e.jsxs("p",{children:[e.jsx("span",{style:{opacity:.7},children:String(K.before??"")}),e.jsx("strong",{children:" [ ... ] "}),e.jsx("span",{style:{opacity:.7},children:String(K.after??"")})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:G?i.correctFragmentLabel:i.fragmentLabel}),e.jsx("input",{readOnly:!0,value:G?String(Z??""):"",placeholder:i.participantAnswerPlaceholder})]})]});if(Le==="text")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":G?"correct":"idle",children:[e.jsx("p",{children:String(K.prompt??"")}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:G?s.correctAnswerLabel:s.answerLabel}),e.jsx("input",{readOnly:!0,value:G?String(Z??""):"",placeholder:i.participantAnswerPlaceholder})]})]});if(Le==="boolean"){const A=!!Z;return e.jsxs("div",{className:"cogita-live-card-surface","data-state":G?"correct":"idle",children:[e.jsx("p",{children:String(K.prompt??"")}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:`cta ghost ${G&&A?"live-correct-answer":""}`,disabled:!0,children:i.trueLabel}),e.jsx("button",{type:"button",className:`cta ghost ${G&&!A?"live-correct-answer":""}`,disabled:!0,children:i.falseLabel})]})]})}if(Le==="selection"){const A=Array.isArray(K.options)?K.options.map(String):[],z=!!K.multiple;return e.jsxs("div",{className:"cogita-live-card-surface","data-state":G?"correct":"idle",children:[e.jsx("p",{children:String(K.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:A.map((W,O)=>e.jsxs("label",{className:"cogita-share-row","data-state":G&&L.includes(O)?"correct":void 0,children:[e.jsx("span",{children:W}),e.jsx("input",{type:z?"checkbox":"radio",disabled:!0,checked:G?L.includes(O):!1,readOnly:!0})]},`${O}-${W}`))})]})}if(Le==="ordering"){const A=Array.isArray(G?Z:K.options)?(G?Z:K.options).map(String):[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":G?"correct":"idle",children:[e.jsx("p",{children:String(K.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:A.map((z,W)=>e.jsxs("div",{className:"cogita-share-row","data-state":G?"correct":void 0,children:[e.jsx("span",{children:z}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:!0,children:"↑"}),e.jsx("button",{type:"button",className:"ghost",disabled:!0,children:"↓"})]})]},`${W}-${z}`))})]})}if(Le==="matching"){const A=Array.isArray(K.columns)?K.columns:[],z=(Z==null?void 0:Z.paths)??[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":G?"correct":"idle",children:[e.jsx("p",{children:String(K.prompt??"")}),G?e.jsx("div",{className:"cogita-share-list",children:z.map((W,O)=>e.jsx("div",{className:"cogita-share-row","data-state":"correct",children:e.jsx("span",{children:W.map((fe,se)=>{const ne=Array.isArray(A[se])?A[se]:[],Ne=String(ne[fe]??fe);return`${se>0?" → ":""}${Ne}`})})},`path-${O}`))}):e.jsx("div",{className:"cogita-form-actions",children:A.map((W,O)=>e.jsx("select",{disabled:!0,children:(Array.isArray(W)?W:[]).map((fe,se)=>e.jsx("option",{children:String(fe)},`${O}-${se}`))},`host-col-${O}`))})]})}return e.jsx("p",{className:"cogita-help",children:i.unsupportedPromptType})};return e.jsx(Pt,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":x,children:[e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:i.hostKicker}),e.jsx("h2",{className:"cogita-detail-title",children:i.hostTitle}),w==="loading"?e.jsx("p",{children:i.loading}):null,f?e.jsx("p",{className:"cogita-help",children:f}):null,o?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:i.joinCodeLabel}),e.jsx("input",{readOnly:!0,value:o.code})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:i.joinUrlLabel}),e.jsx("input",{readOnly:!0,value:F})]}),F?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:i.qrLabel}),e.jsx("div",{style:{display:"inline-flex",padding:"0.75rem",borderRadius:"12px",background:"#fff"},children:e.jsx(gr,{value:F,size:176,marginSize:2})})]}):null,e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:i.statusLabel}),e.jsx("input",{readOnly:!0,value:de[o.status]??o.status})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:N,disabled:!v.length,children:i.publishCurrentRound})}),e.jsx("p",{className:"cogita-help",children:y(i.roundsLabel,{count:v.length})})]}):null]}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:i.currentRoundTitle}),e.jsx("h3",{className:"cogita-detail-title",children:g&&typeof g.title=="string"?g.title:(o==null?void 0:o.status)==="lobby"?i.sessionNotStarted:i.waitingForPublishedRound}),(o==null?void 0:o.status)==="lobby"?e.jsx("p",{className:"cogita-help",children:i.hiddenBeforeStart}):me(g,S==null?void 0:S.expected),x!=="lobby"?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:R,disabled:!v.length||!j||o.status==="finished",children:o.status==="revealed"?s.nextQuestion:s.checkAnswer})}):null,x!=="finished"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:i.participantsTitle}),e.jsxs("div",{className:"cogita-share-list",children:[o==null?void 0:o.participants.map(K=>{const Z=o.currentRoundAnswers.find(Le=>Le.participantId===K.participantId);return e.jsx("div",{className:"cogita-share-row",children:e.jsxs("div",{children:[e.jsx("strong",{children:K.displayName}),e.jsxs("div",{className:"cogita-share-meta",children:[Z?i.answerStatusAnswered:i.answerStatusWaiting,(Z==null?void 0:Z.isCorrect)===!0?` · ${i.answerStatusCorrect}`:"",(Z==null?void 0:Z.isCorrect)===!1?` · ${i.answerStatusIncorrect}`:""]})]})},K.participantId)}),o&&o.participants.length===0?e.jsx("p",{className:"cogita-help",children:i.noParticipants}):null]})]}):null]}),x!=="lobby"?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:x==="finished"?i.finalScoreTitle:i.pointsTitle}),e.jsx("div",{className:"cogita-share-list",children:((o==null?void 0:o.scoreboard)??[]).map(K=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:K.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[K.score," ",i.scoreUnit]})]},`score:${K.participantId}`))})]}):null]})})})})})}const Fo=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionHostPage:Io},Symbol.toStringTag,{value:"Module"}));function Os(t){return`cogita.live.join.${t}`}function Mo(t){const{code:a}=t,r=t.copy.cogita.library.revision,s=r.live,[i,o]=n.useState(""),[h,v]=n.useState(()=>typeof localStorage>"u"?null:localStorage.getItem(Os(a))),[m,w]=n.useState(null),[d,f]=n.useState("idle"),[l,c]=n.useState(""),[j,g]=n.useState([]),[S,F]=n.useState(null),[x,y]=n.useState([]),[de,B]=n.useState([]),p=(m==null?void 0:m.currentPrompt)??null,Q=(m==null?void 0:m.currentReveal)??null,N=Q==null?void 0:Q.expected,ee=(m==null?void 0:m.status)==="finished"?"finished":m!=null&&m.status&&m.status!=="lobby"?"active":"lobby",q=n.useMemo(()=>`${(m==null?void 0:m.currentRoundIndex)??0}:${(m==null?void 0:m.revealVersion)??0}:${String((p==null?void 0:p.cardKey)??"")}`,[p==null?void 0:p.cardKey,m==null?void 0:m.currentRoundIndex,m==null?void 0:m.revealVersion]);n.useEffect(()=>{c(""),g([]),F(null),y(Array.isArray(p==null?void 0:p.options)?[...p.options??[]]:[]),B([])},[q]),n.useEffect(()=>{let A=!0;const z=async()=>{try{const O=await us({code:a,participantToken:h});if(!A)return;w(O),h&&f("ready")}catch{A&&d!=="joining"&&f("error")}};z();const W=window.setInterval(z,1200);return()=>{A=!1,window.clearInterval(W)}},[a,h,d]);const R=async()=>{f("joining");try{const A=await Qr({code:a,name:i});v(A.participantToken),localStorage.setItem(Os(a),A.participantToken),f("ready")}catch{f("error")}},me=A=>{if(!!(p!=null&&p.multiple)){g(W=>W.includes(A)?W.filter(O=>O!==A):[...W,A].sort((O,fe)=>O-fe));return}g([A])},K=(A,z)=>{y(W=>{const O=[...W],fe=A+z;return fe<0||fe>=O.length?W:([O[A],O[fe]]=[O[fe],O[A]],O)})},Z=()=>{const A=Array.isArray(p==null?void 0:p.columns)?p.columns:[];B(z=>[...z,A.map(()=>0)])},Le=(A,z,W)=>{B(O=>O.map((fe,se)=>se!==A?fe:fe.map((ne,Ne)=>Ne===z?W:ne)))},G=async()=>{if(!h||!p||typeof p.cardKey!="string")return;let A=null;switch(p.kind){case"selection":A=j;break;case"boolean":A=S;break;case"ordering":A=x;break;case"matching":A={paths:de};break;case"citation-fragment":case"text":default:A=l;break}try{await Gr({code:a,participantToken:h,roundIndex:Number(p.roundIndex??(m==null?void 0:m.currentRoundIndex)??0),cardKey:p.cardKey,answer:A});const z=await us({code:a,participantToken:h});w(z),f("ready")}catch{f("error")}},L=()=>{if(!p)return e.jsx("p",{className:"cogita-help",children:s.waitingForHostQuestion});const A=!!Q,z=Array.isArray(N)?N.map(W=>Number(W)).filter(Number.isFinite):[];if(p.kind==="citation-fragment")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":A?"correct":"idle",children:[e.jsxs("p",{children:[e.jsx("span",{style:{opacity:.7},children:String(p.before??"")}),e.jsx("strong",{children:" [ ... ] "}),e.jsx("span",{style:{opacity:.7},children:String(p.after??"")})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:A?s.correctFragmentLabel:s.fragmentLabel}),e.jsx("input",{value:A?String(N??""):l,onChange:W=>c(W.target.value),readOnly:A})]})]});if(p.kind==="text")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":A?"correct":"idle",children:[e.jsx("p",{children:String(p.prompt??"")}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:A?r.correctAnswerLabel:r.answerLabel}),e.jsx("input",{type:p.inputType==="number"?"number":p.inputType==="date"?"date":"text",value:A?String(N??""):l,onChange:W=>c(W.target.value),readOnly:A})]})]});if(p.kind==="boolean"){const W=!!N;return e.jsxs("div",{className:"cogita-live-card-surface","data-state":A?"correct":"idle",children:[e.jsx("p",{children:String(p.prompt??"")}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:`cta ghost ${A&&W?"live-correct-answer":""}`,onClick:()=>F(!0),disabled:A,children:s.trueLabel}),e.jsx("button",{type:"button",className:`cta ghost ${A&&!W?"live-correct-answer":""}`,onClick:()=>F(!1),disabled:A,children:s.falseLabel})]})]})}if(p.kind==="selection")return e.jsxs("div",{className:"cogita-live-card-surface","data-state":A?"correct":"idle",children:[e.jsx("p",{children:String(p.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:(Array.isArray(p.options)?p.options:[]).map((W,O)=>e.jsxs("label",{className:"cogita-share-row","data-state":A&&z.includes(O)?"correct":void 0,children:[e.jsx("span",{children:W}),e.jsx("input",{type:p.multiple?"checkbox":"radio",name:"live-selection",checked:A?z.includes(O):j.includes(O),onChange:()=>me(O),disabled:A})]},`${O}-${W}`))})]});if(p.kind==="ordering"){const W=Array.isArray(A?N:x)?(A?N:x).map(String):[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":A?"correct":"idle",children:[e.jsx("p",{children:String(p.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:W.map((O,fe)=>e.jsxs("div",{className:"cogita-share-row","data-state":A?"correct":void 0,children:[e.jsx("span",{children:O}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>K(fe,-1),disabled:A,children:"↑"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>K(fe,1),disabled:A,children:"↓"})]})]},`${fe}-${O}`))})]})}if(p.kind==="matching"){const W=Array.isArray(p.columns)?p.columns:[],O=(N==null?void 0:N.paths)??[];return e.jsxs("div",{className:"cogita-live-card-surface","data-state":A?"correct":"idle",children:[e.jsx("p",{children:String(p.prompt??"")}),A?e.jsx("div",{className:"cogita-share-list",children:O.map((fe,se)=>e.jsx("div",{className:"cogita-share-row","data-state":"correct",children:e.jsx("span",{children:fe.map((ne,Ne)=>{const Ae=Array.isArray(W[Ne])?W[Ne]:[];return`${Ne>0?" → ":""}${String(Ae[ne]??ne)}`})})},`path-${se}`))}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:Z,children:s.addPathAction})}),de.map((fe,se)=>e.jsx("div",{className:"cogita-form-actions",children:W.map((ne,Ne)=>e.jsx("select",{value:fe[Ne]??0,onChange:Ae=>Le(se,Ne,Number(Ae.target.value)),children:ne.map((Ae,Pe)=>e.jsxs("option",{value:Pe,children:[Pe,": ",Ae]},`${Ne}-${Pe}`))},`path-${se}-col-${Ne}`))},`path-${se}`))]})]})}return e.jsx("p",{className:"cogita-help",children:s.unsupportedPromptType})};return e.jsx(Pt,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":ee,children:[e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:s.joinKicker}),e.jsx("h2",{className:"cogita-detail-title",children:s.joinTitle}),h?e.jsx("p",{className:"cogita-help",children:s.joinedWaiting}):e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:s.participantNameLabel}),e.jsx("input",{value:i,onChange:A=>o(A.target.value)})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:R,disabled:!i.trim()||d==="joining",children:d==="joining"?s.joiningAction:s.joinAction})})]}),d==="error"?e.jsx("p",{className:"cogita-help",children:s.connectionError}):null,ee==="lobby"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:s.scoreboardTitle}),e.jsxs("div",{className:"cogita-share-list",children:[m==null?void 0:m.scoreboard.map(A=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:A.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[A.score," ",s.scoreUnit]})]},A.participantId)),m&&m.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:s.noParticipants}):null]})]}):null]}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:s.questionTitle}),e.jsx("h3",{className:"cogita-detail-title",children:typeof(p==null?void 0:p.title)=="string"?p.title:s.waitingForPublishedRound}),p?e.jsxs(e.Fragment,{children:[L(),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:G,disabled:!h||!p.cardKey||(m==null?void 0:m.answerSubmitted),children:m!=null&&m.answerSubmitted?s.submitted:s.submitAnswer})})]}):e.jsx("p",{className:"cogita-help",children:s.waitingForHostQuestion})]}),ee!=="lobby"?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:ee==="finished"?s.finalScoreTitle:s.pointsTitle}),e.jsxs("div",{className:"cogita-share-list",children:[m==null?void 0:m.scoreboard.map(A=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:A.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[A.score," ",s.scoreUnit]})]},`score:${A.participantId}`)),m&&m.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:s.noParticipants}):null]})]}):null]})})})})})}const Ko=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionJoinPage:Mo},Symbol.toStringTag,{value:"Module"}));export{Ro as C,Po as a,Eo as b,Fo as c,Ko as d};
