import{r as n,j as e,u as Wa,a as Ea,b as Gn,c as Yn,d as Xn,R as fn,B as bn,C as yn,Q as Qs}from"./vendor-CAC2WLor.js";import{L as Gs,A as Ys,g as Xs,a as jr,b as Ua,c as Zn,s as gs,d as es,e as wr,f as Ln,h as aa,i as kr,j as Nr,k as nn,l as sn,m as Zs,n as ts,o as Jn,p as Sr,u as ms,q as as,r as Tr,t as Cr,v as Ir,w as Lr,x as Mr,y as er,z as Ar,B as tr,C as ar,D as Rr,E as $r,F as xn,G as Ja,H as Pr,I as nr,J as Er,K as ns,M as sr,N as Fr,O as Kr,P as _r,Q as Hn,R as ya,S as Dr,T as zr,U as Br,V as Vr,W as Or,X as qr,Y as Ur,Z as Jr,_ as Hr,$ as Wr,a0 as Qr,a1 as ps,a2 as Gr,a3 as fs,a4 as bs,a5 as Yr,a6 as Xr,a7 as Zr,a8 as rr,a9 as ei,aa as ti,ab as Wn,ac as ai,ad as ni,ae as si,af as ri}from"./recreatio-core-ACWVnSiy.js";import"./vendor-cogita-ui-DTaQ_FiW.js";const Va={width:420,height:320,paddingX:28,paddingY:18,levels:[1,4,6,6,5,4,4]},za={moveMs:900,pauseMs:220,errorMs:900},ii=(t=11)=>{let a=t;const s=()=>(a=(a*1664525+1013904223)%4294967296,a/4294967296),{width:r,height:i,paddingX:u,paddingY:o,levels:j}=Va,g=(i-o*2)/(j.length-1),x=[],c=[],f=[];j.forEach((v,b)=>{const X=i-o-b*g,R=r-u*2,k=[];for(let D=0;D<v;D+=1){const N=u+(D+1)*R/(v+1),ee=(s()-.5)*18,F=Math.max(u,Math.min(r-u,N+ee)),M=b===0?3:b<2?2.1:1.4,H=b===0?"root":`l${b}-${D}`;k.push({id:H,x:b===0?r/2:F,y:X,r:M,level:b,role:b===0?"root":void 0})}f.push(k),x.push(...k)});const l=f[f.length-1];if(l!=null&&l.length){const v=l[Math.floor(l.length/2)];v.role="goal",v.r=2}for(let v=1;v<f.length;v+=1){const b=f[v-1];f[v].forEach(R=>{const k=[...b].sort((F,M)=>Math.abs(F.x-R.x)-Math.abs(M.x-R.x)),D=k[0],N=k[1]&&s()<.45?k[1]:null;(N?[D,N]:[D]).forEach(F=>{c.push({from:F.id,to:R.id,key:`${F.id}-${R.id}`})}),s()<.2&&k[2]&&c.push({from:k[2].id,to:R.id,key:`${k[2].id}-${R.id}`})})}const d=new Map;c.forEach(v=>{const b=d.get(v.to)??[];b.push(v.from),d.set(v.to,b)});const w=new Map,m=new Map,S=new Map;c.forEach(v=>{const b=w.get(v.from)??[];b.push(v.key),w.set(v.from,b);const X=m.get(v.from)??[];X.push(v.to),m.set(v.from,X);const R=S.get(v.from)??[];R.push(v.to),S.set(v.from,R);const k=S.get(v.to)??[];k.push(v.from),S.set(v.to,k)});const A=new Map;return x.forEach(v=>{A.set(v.id,v)}),{nodes:x,links:c,parentsById:d,linksByFrom:w,childrenByFrom:m,neighborsById:S,nodesById:A}};function oi({slides:t,activeIndex:a,introOpen:s,prefersReducedMotion:r,onNext:i,onPrev:u,onSelect:o,onExit:j,onOpen:g,onRegister:x}){const c=a===t.length-1,f=s&&a===0?"entry":"docked",l=t[t.length-1],[d,w]=n.useState(!1),m=n.useMemo(()=>Array.from({length:20},(te,pe)=>({src:`/cogita/logo/Cogita${String(pe).padStart(2,"0")}.png`,kind:pe<=11?"bubble":pe<=17?"text":"recreatio"})),[]),S=s&&a===0;n.useEffect(()=>{if(!s){w(!1);return}a>0&&!d&&w(!0)},[a,s,d]);const A=n.useRef(0),v=n.useRef(null),b=n.useMemo(()=>{const te={x:40,y:160},pe={x:260,y:48},p=6,T=pe.x-te.x,P=te.y-pe.y,V=T/p,Z=[.3,.45,.6,.65,1.4,2.2],fe=Z.reduce((G,Q)=>G+Q,0),W=Z.map(G=>P*G/fe),L=[te];let we=te.x,ne=te.y;for(let G=1;G<=p;G+=1){const Q=(Math.random()-.5)*14,ge=(Math.random()-.5)*28;we=Math.max(te.x+G*14,Math.min(pe.x-(p-G)*14,we+V+Q));const oe=W[G-1]??W[W.length-1];ne=ne-oe+ge;const le=Math.max(pe.y,Math.min(te.y-4,ne));L.push({x:Math.round(we),y:Math.round(le)})}return L[L.length-1]=pe,L},[]),X=n.useMemo(()=>{const P=(fe,W,L)=>Math.min(L,Math.max(W,fe)),V=b.map(fe=>{const W=10+Math.random()*36;return{x:P(fe.x,40,260),y:P(fe.y-W,40,140)}}),Z=b.map((fe,W)=>{var ne;const L=12+Math.random()*40,we=((ne=V[W])==null?void 0:ne.y)??fe.y;return{x:P(fe.x,40,260),y:P(Math.max(we+10,fe.y+L),60,170)}});return{upper:V,lower:Z}},[b]),R=n.useMemo(()=>{var pe;const te=((pe=b[4])==null?void 0:pe.x)??260;return Math.max(0,Math.min(240,te-40))},[b]),k=n.useMemo(()=>{var W,L;const te=(we,ne,G)=>Math.min(G,Math.max(ne,we)),pe=(we,ne,G)=>b.map((Q,ge)=>{var bt,dt;const oe=((bt=X.upper[ge])==null?void 0:bt.y)??Q.y,le=((dt=X.lower[ge])==null?void 0:dt.y)??Q.y,Ce=(Math.random()-.5)*70,ze=Q.y+we+Ce,Ke=te(Q.y+ne,oe+6,le-6),Ee=te(Q.y+G,oe+6,le-6);return{x:Q.x,y:te(ze,Math.min(Ke,Ee),Math.max(Ke,Ee))}}),p=-14+Math.random()*28,T=14+Math.random()*28,P=pe(p,-80,12),V=pe(T,-12,80);for(let we=4;we<b.length;we+=1){const ne=b[we],G=((W=X.upper[we])==null?void 0:W.y)??ne.y,Q=((L=X.lower[we])==null?void 0:L.y)??ne.y;P[we]={x:ne.x,y:te(ne.y-12,G+6,Q-6)},V[we]={x:ne.x,y:te(ne.y+12,G+6,Q-6)}}const Z=X.upper.length?X.upper[X.upper.length-1].y:40,fe=X.lower.length?X.lower[X.lower.length-1].y:170;return P[P.length-1]={x:b[b.length-1].x,y:te(b[b.length-1].y-14,Z,fe)},V[V.length-1]={x:b[b.length-1].x,y:te(b[b.length-1].y+12,Z,fe)},{higher:P,lower:V}},[b,X]),D=1e4,N=n.useMemo(()=>{let te=17;const pe=()=>(te=(te*1664525+1013904223)%4294967296,te/4294967296);return[{x:-180,y:-70},{x:-60,y:-70},{x:60,y:-70},{x:180,y:-70},{x:-120,y:60},{x:0,y:60},{x:120,y:60}].map((T,P)=>{const V=(pe()-.5)*240,Z=(pe()-.5)*180,fe=(pe()-.5)*24;return{id:`card-${P+1}`,throw:{x:`${V.toFixed(0)}px`,y:`${Z.toFixed(0)}px`,rot:`${fe.toFixed(1)}deg`},grid:{x:`${T.x}px`,y:`${T.y}px`},delay:`${P*.12}s`}})},[]),ee=n.useMemo(()=>[{x:"-80px",y:"-120px"},{x:"-80px",y:"-15px"},{x:"-80px",y:"90px"},{x:"-80px",y:"195px"}],[]),[F,M]=n.useState([]),H=n.useMemo(()=>[{id:"round-1",x:"14%",y:"calc(80% + var(--round-card-drop))"},{id:"round-2",x:"30%",y:"calc(80% + var(--round-card-drop))"},{id:"round-3",x:"46%",y:"calc(80% + var(--round-card-drop))"},{id:"round-4",x:"62%",y:"calc(80% + var(--round-card-drop))"},{id:"round-5",x:"78%",y:"calc(80% + var(--round-card-drop))"}],[]),de=n.useMemo(()=>{const pe=[],T=(V,Z)=>V+Math.random()*(Z-V);for(let V=0;V<6;V+=1){let Z=!1;for(let fe=0;fe<80;fe+=1){const W=T(14,86),L=T(10,34);if(pe.every(ne=>{const G=ne.x-W,Q=ne.y-L;return Math.hypot(G,Q)>=12})){pe.push({x:W,y:L}),Z=!0;break}}Z||pe.push({x:T(16,84),y:T(12,32)})}return pe.map((V,Z)=>({id:`p${Z+1}`,x:`${V.x.toFixed(1)}%`,y:`${V.y.toFixed(1)}%`,xNum:V.x,yNum:V.y,jitterX:`${(Math.random()-.5)*12}px`,jitterY:`${(Math.random()-.5)*10}px`,delay:`${(Math.random()*1.2).toFixed(2)}s`}))},[]),[ke,Je]=n.useState(0),[ue,$]=n.useState(0),[be,C]=n.useState([]),U=1e4,O=n.useMemo(()=>{if(de.length<2)return[];const te=Z=>{let fe=Z+1831565813;return fe=Math.imul(fe^fe>>>15,fe|1),fe^=fe+Math.imul(fe^fe>>>7,fe|61),((fe^fe>>>14)>>>0)/4294967296},pe=(Z,fe)=>Math.floor(te(Z)*fe),p=new Set,T=[],P=Math.min(3,de.length);let V=0;for(;T.length<P&&V<30;){V+=1;const Z=pe(ke*13+V*5,de.length),fe=pe(ke*29+V*7,de.length);if(Z===fe)continue;const W=Z<fe?`${Z}-${fe}`:`${fe}-${Z}`;p.has(W)||(p.add(W),T.push({id:`link-${W}`,from:de[Z],to:de[fe],delay:`${(V*.35).toFixed(2)}s`}))}return T},[ke,de]);n.useEffect(()=>{if(!s||a!==2)return;const te=()=>{const p=N.map(T=>T.id);for(let T=p.length-1;T>0;T-=1){const P=Math.floor(Math.random()*(T+1));[p[T],p[P]]=[p[P],p[T]]}return p.slice(0,4)};M(te());const pe=window.setInterval(()=>{M(te())},D);return()=>window.clearInterval(pe)},[a,s,N,D]),n.useEffect(()=>{if(!s||a!==3)return;const te=()=>{$(Math.floor(Math.random()*H.length)),C(de.map(()=>Math.random()<.6?"good":"bad")),Je(p=>p+1)};te();const pe=window.setInterval(te,U);return()=>window.clearInterval(pe)},[a,s,H.length,de,U]);const K=n.useMemo(()=>ii(11),[]),[J,Y]=n.useState(new Set(["root"])),[ye,Te]=n.useState(new Set),[Re,Me]=n.useState(new Set),[tt,ot]=n.useState({fromId:"root",toId:"root",key:0}),$e=n.useRef(J),Oe=n.useRef("root"),kt=n.useRef(0),We=n.useRef(null),Ae=n.useRef(null),rt=n.useRef([]);n.useEffect(()=>{$e.current=J},[J]);const gt=n.useMemo(()=>{const te=new Set;return J.forEach(pe=>{const p=K.linksByFrom.get(pe);p&&p.forEach(T=>te.add(T))}),te},[J,K]),at=K.nodesById.get(tt.toId)??K.nodesById.get("root"),Ie=at?`${at.x/Va.width*100}%`:"50%",Ue=at?`${at.y/Va.height*100}%`:"90%";n.useEffect(()=>{if(!s||a!==1||r)return;(()=>{Y(new Set(["root"])),Te(new Set),Me(new Set),ot({fromId:"root",toId:"root",key:0}),Ae.current=null,kt.current=0,Oe.current="root",rt.current=[]})();const pe=()=>{const T=Oe.current,P=$e.current,Z=(K.childrenByFrom.get(T)??[]).filter(Q=>!P.has(Q));if(Z.length)return Z[Math.floor(Math.random()*Z.length)];if(P.size>=K.nodes.length){const Q=K.neighborsById.get(T)??[];return Q.length?Q[Math.floor(Math.random()*Q.length)]:null}const fe=Q=>(K.childrenByFrom.get(Q)??[]).some(oe=>!P.has(oe)),W=[T],L=new Set([T]),we=new Map;let ne=null;for(;W.length;){const Q=W.shift();if(!Q)break;if(Q!==T&&fe(Q)){ne=Q;break}(K.neighborsById.get(Q)??[]).forEach(oe=>{L.has(oe)||(L.add(oe),we.set(oe,Q),W.push(oe))})}if(!ne)return null;let G=ne;for(;we.get(G)&&we.get(G)!==T;)G=we.get(G)??G;return G},p=(T,P)=>{if(T===P){const V=pe();V&&p(T,V);return}kt.current+=1,ot({fromId:T,toId:P,key:kt.current}),Oe.current=P,We.current=window.setTimeout(()=>{const V=K.parentsById.get(P)??[],Z=$e.current,fe=V.filter(ne=>!Z.has(ne));if(!fe.length){const ne=new Set(Z);ne.add(P),Y(ne),We.current=window.setTimeout(()=>{for(;rt.current.length;){const Q=rt.current[rt.current.length-1];if(!ne.has(Q)){if(Q!==P){p(P,Q);return}break}rt.current.pop()}const G=pe();G&&p(P,G)},za.pauseMs);return}const W=new Set([P,...fe]),L=new Set(fe.map(ne=>`${ne}-${P}`));Te(W),Me(L),rt.current.includes(P)||rt.current.push(P);const we=fe[Math.floor(Math.random()*fe.length)];Ae.current={fromId:P,toId:we},We.current=window.setTimeout(()=>{Te(new Set),Me(new Set);const ne=Ae.current;ne&&p(ne.fromId,ne.toId)},za.errorMs)},za.moveMs)};return We.current=window.setTimeout(()=>{const T=pe();T&&p(Oe.current,T)},za.pauseMs),()=>{We.current&&window.clearTimeout(We.current)}},[a,s,K,r]);const et=te=>{if(!s)return;const pe=Date.now();pe-A.current<520||Math.abs(te.deltaY)<10||(A.current=pe,te.deltaY>0?i():u(),te.preventDefault())},qe=te=>{if(!s)return;const pe=te.touches[0];pe&&(v.current={x:pe.clientX,y:pe.clientY})},B=te=>{if(!s)return;const pe=v.current;if(v.current=null,!pe)return;const p=te.changedTouches[0];if(!p)return;const T=p.clientX-pe.x,P=p.clientY-pe.y;Math.abs(P)<40||Math.abs(P)<Math.abs(T)||(P<0?i():u())};return e.jsxs("div",{className:`cogita-intro ${s?"is-open":"is-closed"} ${r?"is-reduced":""} ${c?"is-final":""}`,"data-slide":a+1,onWheel:et,onTouchStart:qe,onTouchEnd:B,children:[e.jsxs("div",{className:"cogita-intro-stage",children:[e.jsx("div",{className:"cogita-intro-logo","data-state":f,"aria-hidden":"true",children:e.jsx("div",{className:`cogita-logo-layers ${S&&!d?"is-entry":""}`,children:m.map((te,pe)=>e.jsx("img",{src:te.src,alt:"",className:`cogita-logo-layer ${pe===0?"is-base":""} ${te.kind==="text"?"is-text":te.kind==="recreatio"?"is-recreatio":""} ${te.kind==="bubble"?"is-bubble":""}`},te.src))})}),s&&t.map((te,pe)=>{const p=pe===a;return e.jsxs("section",{className:`cogita-intro-slide slide-${pe+1} ${p?"is-active":""}`,"aria-hidden":!p,children:[e.jsxs("div",{className:"cogita-intro-text",children:[te.subtitle?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h1",{children:te.title}),e.jsx("p",{className:"cogita-intro-subtitle",children:te.subtitle})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:te.title}),te.body&&e.jsx("p",{children:te.body.split(`
`).map((T,P)=>e.jsxs("span",{children:[T,P===0&&e.jsx("br",{})]},String(P)))})]}),te.micro&&e.jsx("p",{className:"cogita-intro-micro",children:te.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:c?x:i,children:te.cta}),c&&te.secondary&&e.jsx("button",{type:"button",className:"ghost",onClick:()=>o(0),children:te.secondary})]})]}),e.jsxs("div",{className:"cogita-intro-visual","aria-hidden":"true",children:[pe===1&&e.jsxs("div",{className:"cogita-learning-map",children:[e.jsxs("svg",{className:"learning-map-svg",viewBox:`0 0 ${Va.width} ${Va.height}`,preserveAspectRatio:"none",children:[K.links.map(T=>{const P=K.nodesById.get(T.from),V=K.nodesById.get(T.to);if(!P||!V)return null;const Z=gt.has(T.key),fe=Re.has(T.key);return e.jsx("line",{className:`map-link ${Z?"is-active":""} ${fe?"is-error":""}`,x1:P.x,y1:P.y,x2:V.x,y2:V.y},T.key)}),K.nodes.map(T=>{const P=J.has(T.id),V=ye.has(T.id);return e.jsx("circle",{className:`map-node ${T.role?`is-${T.role}`:""} ${P?"is-active":""} ${V?"is-error":""}`,cx:T.x,cy:T.y,r:T.r},T.id)})]}),at&&e.jsx("span",{className:"map-explorer-dot",style:{left:Ie,top:Ue,"--move":`${za.moveMs}ms`}})]}),pe===2&&e.jsx("div",{className:"cogita-index-cards",children:N.map(T=>{const P=F.indexOf(T.id),V=P>=0?ee[P]:null,Z=(V==null?void 0:V.x)??"140px",fe=(V==null?void 0:V.y)??"140px",W=P>=0?1:0;return e.jsxs("div",{className:"cogita-index-card",style:{"--throw-x":T.throw.x,"--throw-y":T.throw.y,"--throw-rot":T.throw.rot,"--grid-x":T.grid.x,"--grid-y":T.grid.y,"--stack-x":Z,"--stack-y":fe,"--stack-opacity":W,"--delay":T.delay},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"}),e.jsx("span",{className:"card-quote"}),e.jsx("span",{className:"card-source"}),e.jsxs("span",{className:"card-tags",children:[e.jsx("i",{}),e.jsx("i",{}),e.jsx("i",{})]})]},T.id)})}),pe===3&&e.jsxs("div",{className:"cogita-round-board",children:[e.jsxs("div",{className:"round-cards",children:[H.map((T,P)=>e.jsxs("div",{className:`round-card ${P===ue?"is-active":""}`,style:{"--card-x":T.x,"--card-y":T.y},children:[e.jsx("span",{className:"card-title"}),e.jsx("span",{className:"card-line"}),e.jsx("span",{className:"card-line short"})]},T.id)),H[ue]&&e.jsx("span",{className:"round-ring",style:{"--card-x":H[ue].x,"--card-y":`calc(${H[ue].y} - var(--round-card-lift))`}})]}),e.jsx("div",{className:"round-players",children:de.map(T=>e.jsx("span",{className:"player-dot",style:{left:T.x,top:T.y,"--jitter-x":T.jitterX,"--jitter-y":T.jitterY,"--breath-delay":T.delay}},T.id))}),e.jsx("svg",{className:"round-link-layer",viewBox:"0 0 100 100",preserveAspectRatio:"none","aria-hidden":"true",children:O.map(T=>e.jsx("line",{className:"round-link",x1:T.from.xNum,y1:T.from.yNum,x2:T.to.xNum,y2:T.to.yNum,style:{"--delay":T.delay}},T.id))}),e.jsx("div",{className:"round-flows",children:de.map((T,P)=>{const V=be[P]??"good",Z=H[ue];if(!Z)return null;const fe=`calc(${Z.y} - var(--round-card-lift))`;return e.jsxs("div",{className:"round-flow",children:[e.jsx("span",{className:"flow-dot",style:{"--from-x":T.x,"--from-y":T.y,"--to-x":Z.x,"--to-y":fe,"--delay":`${P*.12}s`}}),e.jsx("span",{className:`return-dot is-${V}`,style:{"--from-x":Z.x,"--from-y":fe,"--to-x":T.x,"--to-y":T.y,"--delay":`${P*.12}s`}}),e.jsx("span",{className:`result-pop is-${V}`,style:{"--at-x":T.x,"--at-y":T.y,"--delay":`${P*.12}s`}})]},`${T.id}-${ke}`)})})]},`round-${ke}`),pe===4&&e.jsx("div",{className:"cogita-progress-story",children:e.jsx("div",{className:"progress-chart progress-chart--steps",children:e.jsxs("div",{className:"progress-chart-content",children:[e.jsxs("svg",{className:"progress-svg",viewBox:"0 0 300 200",preserveAspectRatio:"none",role:"presentation",children:[e.jsxs("g",{className:"chart-grid",children:[e.jsx("line",{x1:"40",y1:"30",x2:"40",y2:"170"}),e.jsx("line",{x1:"75",y1:"30",x2:"75",y2:"170"}),e.jsx("line",{x1:"110",y1:"30",x2:"110",y2:"170"}),e.jsx("line",{x1:"145",y1:"30",x2:"145",y2:"170"}),e.jsx("line",{x1:"180",y1:"30",x2:"180",y2:"170"}),e.jsx("line",{x1:"215",y1:"30",x2:"215",y2:"170"}),e.jsx("line",{x1:"250",y1:"30",x2:"250",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"150",x2:"260",y2:"150"}),e.jsx("line",{x1:"40",y1:"130",x2:"260",y2:"130"}),e.jsx("line",{x1:"40",y1:"110",x2:"260",y2:"110"}),e.jsx("line",{x1:"40",y1:"90",x2:"260",y2:"90"}),e.jsx("line",{x1:"40",y1:"70",x2:"260",y2:"70"}),e.jsx("line",{x1:"40",y1:"50",x2:"260",y2:"50"})]}),e.jsxs("g",{className:"chart-axes",children:[e.jsx("line",{x1:"40",y1:"170",x2:"260",y2:"170"}),e.jsx("line",{x1:"40",y1:"170",x2:"40",y2:"30"})]}),e.jsxs("g",{className:"chart-paths",children:[e.jsx("path",{className:"chart-seg seg-1",d:`M${b[0].x} ${b[0].y} L${b[1].x} ${b[1].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-2",d:`M${b[1].x} ${b[1].y} L${b[2].x} ${b[2].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-3",d:`M${b[2].x} ${b[2].y} L${b[3].x} ${b[3].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-4",d:`M${b[3].x} ${b[3].y} L${b[4].x} ${b[4].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-5",d:`M${b[4].x} ${b[4].y} L${b[5].x} ${b[5].y}`,pathLength:"100"}),e.jsx("path",{className:"chart-seg seg-6",d:`M${b[5].x} ${b[5].y} L${b[6].x} ${b[6].y}`,pathLength:"100"})]}),e.jsx("defs",{children:e.jsx("clipPath",{id:"chart-range-clip",clipPathUnits:"userSpaceOnUse",children:e.jsx("rect",{x:"40",y:"30",width:"0",height:"140",children:e.jsx("animate",{attributeName:"width",dur:"24s",begin:"0s",repeatCount:"indefinite",values:`0;0;${R};${R};240;240`,keyTimes:"0;0.25;0.3125;0.75;0.9167;1",calcMode:"linear"})})})}),e.jsxs("g",{className:"chart-range",clipPath:"url(#chart-range-clip)",children:[e.jsx("animate",{attributeName:"opacity",dur:"24s",begin:"0s",repeatCount:"indefinite",values:"0;0;0.9;0.7;0.7",keyTimes:"0;0.1667;0.2917;0.6;1",calcMode:"linear"}),e.jsx("path",{className:"chart-range-fill",d:`${X.upper.map((T,P)=>`${P===0?"M":"L"}${T.x} ${T.y}`).join(" ")} ${X.lower.slice().reverse().map(T=>`L${T.x} ${T.y}`).join(" ")} Z`}),e.jsx("path",{className:"chart-range-line range-top",d:`${X.upper.map((T,P)=>`${P===0?"M":"L"}${T.x} ${T.y}`).join(" ")}`}),e.jsx("path",{className:"chart-range-line range-bottom",d:`${X.lower.map((T,P)=>`${P===0?"M":"L"}${T.x} ${T.y}`).join(" ")}`})]}),e.jsxs("g",{className:"chart-peers",children:[k.higher.slice(0,6).map((T,P)=>e.jsx("path",{className:`chart-peer-seg peer-1 seg-${P+1}`,d:`M${T.x} ${T.y} L${k.higher[P+1].x} ${k.higher[P+1].y}`,pathLength:"100"},`peer-1-${P}`)),k.lower.slice(0,6).map((T,P)=>e.jsx("path",{className:`chart-peer-seg peer-2 seg-${P+1}`,d:`M${T.x} ${T.y} L${k.lower[P+1].x} ${k.lower[P+1].y}`,pathLength:"100"},`peer-2-${P}`))]})]}),e.jsxs("span",{className:"chart-orbit","aria-hidden":"true",children:[e.jsx("span",{className:"chart-orbit-ring"}),e.jsx("span",{className:"chart-orbit-triangle",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent fast",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})}),e.jsx("span",{className:"chart-orbit-triangle accent slow",children:e.jsx("svg",{viewBox:"0 0 100 100",role:"presentation",children:e.jsx("polygon",{points:"100 50 25 93.3 25 6.7"})})})]}),e.jsx("span",{className:"chart-dot-step",style:{"--p0x":`${b[0].x/300*100}%`,"--p0y":`${b[0].y/200*100}%`,"--p1x":`${b[1].x/300*100}%`,"--p1y":`${b[1].y/200*100}%`,"--p2x":`${b[2].x/300*100}%`,"--p2y":`${b[2].y/200*100}%`,"--p3x":`${b[3].x/300*100}%`,"--p3y":`${b[3].y/200*100}%`,"--p4x":`${b[4].x/300*100}%`,"--p4y":`${b[4].y/200*100}%`,"--p5x":`${b[5].x/300*100}%`,"--p5y":`${b[5].y/200*100}%`,"--p6x":`${b[6].x/300*100}%`,"--p6y":`${b[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-1",style:{"--q0x":`${k.higher[0].x/300*100}%`,"--q0y":`${k.higher[0].y/200*100}%`,"--q1x":`${k.higher[1].x/300*100}%`,"--q1y":`${k.higher[1].y/200*100}%`,"--q2x":`${k.higher[2].x/300*100}%`,"--q2y":`${k.higher[2].y/200*100}%`,"--q3x":`${k.higher[3].x/300*100}%`,"--q3y":`${k.higher[3].y/200*100}%`,"--q4x":`${k.higher[4].x/300*100}%`,"--q4y":`${k.higher[4].y/200*100}%`,"--q5x":`${k.higher[5].x/300*100}%`,"--q5y":`${k.higher[5].y/200*100}%`,"--q6x":`${k.higher[6].x/300*100}%`,"--q6y":`${k.higher[6].y/200*100}%`}}),e.jsx("span",{className:"chart-dot-peer dot-peer-2",style:{"--q0x":`${k.lower[0].x/300*100}%`,"--q0y":`${k.lower[0].y/200*100}%`,"--q1x":`${k.lower[1].x/300*100}%`,"--q1y":`${k.lower[1].y/200*100}%`,"--q2x":`${k.lower[2].x/300*100}%`,"--q2y":`${k.lower[2].y/200*100}%`,"--q3x":`${k.lower[3].x/300*100}%`,"--q3y":`${k.lower[3].y/200*100}%`,"--q4x":`${k.lower[4].x/300*100}%`,"--q4y":`${k.lower[4].y/200*100}%`,"--q5x":`${k.lower[5].x/300*100}%`,"--q5y":`${k.lower[5].y/200*100}%`,"--q6x":`${k.lower[6].x/300*100}%`,"--q6y":`${k.lower[6].y/200*100}%`}})]})})}),pe===5&&e.jsxs("div",{className:"cogita-shield",children:[e.jsxs("svg",{viewBox:"0 0 120 140",role:"presentation",children:[e.jsx("path",{d:"M60 10l42 16v44c0 30-19 54-42 62C37 124 18 100 18 70V26z",fill:"none"}),e.jsx("path",{d:"M44 66l10 12 22-26",fill:"none"})]}),e.jsx("span",{className:"cogita-shield-glow"})]}),pe===6&&e.jsx("div",{className:"cogita-final-glow"})]})]},te.id)}),!s&&e.jsx("section",{className:"cogita-intro-static",children:e.jsxs("div",{className:"cogita-intro-text",children:[e.jsx("p",{className:"cogita-intro-kicker",children:"Cogita"}),e.jsx("h2",{children:l.title}),l.body&&e.jsx("p",{children:l.body}),l.micro&&e.jsx("p",{className:"cogita-intro-micro",children:l.micro}),e.jsxs("div",{className:"cogita-intro-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:x,children:l.cta}),e.jsx("button",{type:"button",className:"ghost",onClick:g,children:"Otwórz pokaz"})]})]})})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cogita-intro-dots","aria-label":"Nawigacja slajdów",children:t.map((te,pe)=>e.jsx("button",{type:"button",className:`dot ${a===pe?"active":""}`,"aria-label":te.title,onClick:()=>o(pe)},te.id))}),e.jsx("button",{type:"button",className:"cogita-intro-skip",onClick:j,children:"Pomiń"})]})]})}const li=6,ci=4;function di({copy:t,onAuthAction:a,authLabel:s,showProfileMenu:r,onProfileNavigate:i,onToggleSecureMode:u,onLogout:o,secureMode:j,onNavigate:g,language:x,onLanguageChange:c}){const f=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}g("home")},l=n.useRef(null),d=n.useRef([]),w=n.useMemo(()=>{let C=Date.now()%2147483647;const U=()=>(C=C*48271%2147483647,C/2147483647);return Array.from({length:li},(O,K)=>{const J=6+U()*8,Y=7+U()*10,ye=6+U()*9,Te=-U()*J,Re=-U()*Y,Me=-U()*ye,tt=.18+U()*.28,ot=12+U()*18,$e=4+U()*8,Oe=(U()-.5)*3.2,kt=(U()-.5)*3.8,We=U()>.5?"alternate":"alternate-reverse",Ae=U()>.5?"alternate":"alternate-reverse",rt=U()>.5?"alternate":"alternate-reverse",gt=.18+U()*.42,at=30+U()*60,Ie=-45-U()*38,Ue=188+U()*32,et=.1+U()*.2;return{id:`wave-${K+1}`,style:{"--wave-sway-duration":`${J}s`,"--wave-scale-duration":`${Y}s`,"--wave-drift-duration":`${ye}s`,"--wave-sway-delay":`${Te}s`,"--wave-scale-delay":`${Re}s`,"--wave-drift-delay":`${Me}s`,"--wave-sway-dir":We,"--wave-scale-dir":Ae,"--wave-drift-dir":rt,"--wave-scale":`${tt}`,"--wave-shift":`${ot}%`,"--wave-xshift":`${$e}%`,"--wave-x0":`${Oe}%`,"--wave-y0":`${kt}%`,"--wave-opacity":`${gt}`,"--wave-blur":`${at}px`,"--wave-bottom":`${Ie}%`,"--wave-hue":`${Ue}`,"--wave-glow":`${et}`}}})},[]),m=n.useMemo(()=>{let C=Date.now()*3%2147483647;const U=()=>(C=C*48271%2147483647,C/2147483647);return Array.from({length:ci},(O,K)=>{const J=180+U()*220,Y=220+U()*280,ye=-U()*J,Te=-U()*Y,Re=.12+U()*.22,Me=3+U()*7,tt=1+U()*3,ot=(U()-.5)*2.8,$e=(U()-.5)*2.2;return{id:`mesh-${K+1}`,seed:1e3+K*991+Math.floor(U()*999),style:{"--mesh-sway-duration":`${J}s`,"--mesh-drift-duration":`${Y}s`,"--mesh-sway-delay":`${ye}s`,"--mesh-drift-delay":`${Te}s`,"--mesh-scale":`${Re}`,"--mesh-shift":`${Me}%`,"--mesh-xshift":`${tt}%`,"--mesh-x0":`${$e}%`,"--mesh-y0":`${ot}%`}}})},[]),S=n.useMemo(()=>{const C=[{id:"entry",panel:{x:"0px",y:"0px",scale:"1"},theme:{bg0:"#06162a",bg1:"#0c2d49",bg2:"#0a1c2f",bloom:"rgba(120, 170, 220, 0.18)",sat:"1"}},{id:"workspace",panel:{x:"-6px",y:"-4px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0b3b56",bg2:"#081f33",bloom:"rgba(129, 190, 235, 0.18)",sat:"1.05"}},{id:"library",panel:{x:"-2px",y:"4px",scale:"1.01"},theme:{bg0:"#071a2f",bg1:"#0c2f4a",bg2:"#081f33",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.96"}},{id:"live",panel:{x:"4px",y:"-2px",scale:"1.02"},theme:{bg0:"#07182d",bg1:"#0c2a4a",bg2:"#081f35",bloom:"rgba(115, 170, 225, 0.15)",sat:"0.98"}},{id:"quiz",panel:{x:"2px",y:"6px",scale:"1.01"},theme:{bg0:"#071526",bg1:"#0d2946",bg2:"#081a30",bloom:"rgba(120, 175, 230, 0.14)",sat:"0.97"}},{id:"protection",panel:{x:"-3px",y:"2px",scale:"1.01"},theme:{bg0:"#071a2a",bg1:"#0a2742",bg2:"#07192d",bloom:"rgba(150, 200, 240, 0.16)",sat:"1"}},{id:"register",panel:{x:"0px",y:"-4px",scale:"1.02"},theme:{bg0:"#081c30",bg1:"#0f3754",bg2:"#0b2239",bloom:"rgba(160, 210, 245, 0.2)",sat:"1.05"}}],U=t.cogita.introSlides,O=new Map(U.map(K=>[K.id,K]));return C.map(K=>{var Y;const J=O.get(K.id);return{...K,...J,title:(J==null?void 0:J.title)??"Cogita",cta:(J==null?void 0:J.cta)??((Y=t.cogita.introSlides[0])==null?void 0:Y.cta)??t.cogita.loginCta,secondary:J==null?void 0:J.secondary}})},[t.cogita.introSlides]),[A,v]=n.useState(0),[b,X]=n.useState(!0),[R,k]=n.useState(!1),D=S.length-1,N=n.useCallback(()=>{try{if(typeof window>"u")return;window.localStorage.setItem("cogitaIntroSeen","true")}catch{}},[]),ee=n.useCallback(()=>{N(),a()},[N,a]),F=n.useCallback(()=>{X(!0),v(0)},[]),M=n.useCallback(()=>{X(!1),v(D)},[D]),H=n.useCallback(C=>{v(Math.max(0,Math.min(D,C)))},[D]),de=n.useCallback(()=>{A>=D?ee():H(A+1)},[A,H,ee,D]),ke=n.useCallback(()=>{H(A-1)},[A,H]);n.useEffect(()=>{var O;const C=(O=window.matchMedia)==null?void 0:O.call(window,"(prefers-reduced-motion: reduce)");if(!C)return;const U=()=>k(C.matches);return U(),C.addEventListener?(C.addEventListener("change",U),()=>C.removeEventListener("change",U)):(C.addListener(U),()=>C.removeListener(U))},[]),n.useEffect(()=>{if(!b)return;const C=U=>{const O=U.target;if(!O)return;const K=O.tagName;if(!(O.isContentEditable||K==="INPUT"||K==="TEXTAREA"||K==="SELECT"||K==="BUTTON"||K==="A"||O.closest('button, a, [role="button"], [role="link"]'))){if(U.key==="Escape"){M();return}if(U.key==="ArrowLeft"||U.key==="ArrowUp"){ke();return}(U.key==="ArrowRight"||U.key==="ArrowDown"||U.code==="Space"||U.key===" ")&&(U.preventDefault(),de())}};return window.addEventListener("keydown",C),()=>window.removeEventListener("keydown",C)},[M,de,ke,b]),n.useEffect(()=>{b&&A===D&&N()},[A,b,D,N]),n.useEffect(()=>{const C=l.current;if(!C)return;const U=d.current.filter(Ie=>!!Ie);if(!U.length)return;const O=1,K=.6,J=.6,Y=Math.max(1,Math.min(O,window.devicePixelRatio||1));let ye=0,Te=0,Re=K,Me=0,tt=0;const ot=Ie=>{let Ue=Ie%2147483647;return Ue<=0&&(Ue+=2147483646),(et,qe)=>{Ue=Ue*48271%2147483647;const B=Ue/2147483647;return et+B*(qe-et)}},$e={colors:{filaments:"rgba(143, 208, 255, 0.25)",glow:"rgba(167, 224, 255, 0.35)"},filamentCount:1,segments:20,waveBandPx:120,crestThickness:40,waveCenter:.82,amp1:48,amp2:22,freq1:.01,freq2:.021,jitterA:12,jitterB:8,xJitter:4,glowAlpha:.25,depthLayers:2},Oe=Ie=>{const Ue=Math.sin(Ie*12.9898)*43758.5453;return Ue-Math.floor(Ue)},kt=Ie=>{const Ue=Oe(Ie+.1)||1e-4,et=Oe(Ie+.7)||1e-4;return Math.sqrt(-2*Math.log(Ue))*Math.cos(2*Math.PI*et)},We=(Ie,Ue)=>{const et=Math.floor(Ie),qe=et+1,B=Ie-et,te=B*B*(3-2*B),pe=Oe(et*12.9898+Ue*78.233),p=Oe(qe*12.9898+Ue*78.233);return pe+(p-pe)*te},Ae=Ie=>{const Ue=ot(Ie),et=Math.min(4,Math.max(4,Math.floor(ye/1200*$e.filamentCount)));return Array.from({length:et},(qe,B)=>{const te=Math.max(-1,Math.min(1,kt(Ie+B*.37))),pe=Math.min(1,Math.max(0,Oe(Ie+B*1.31))),p=Math.min($e.depthLayers-1,Math.floor(pe*$e.depthLayers));return{seed:Ue(0,Math.PI*2)+Ie*.01,offset:te,freqA:$e.freq1*(.75+Ue(0,.5)),freqB:$e.freq2*(.75+Ue(0,.5)),ampA:$e.amp1*(.6+Ue(0,.7)),ampB:$e.amp2*(.6+Ue(0,.7)),width:2+B%5*.32,depth:pe,layer:p}})},rt=(Ie,Ue,et)=>{const qe=Math.max(30,Math.floor(ye*Te/14e4));Ie.save(),Ie.globalAlpha=.6;for(let B=0;B<qe;B+=1){const te=Oe(B*9.1+ye*.11)*Ue+et,pe=Oe(B*3.7+Te*.23)*Te,p=1.2+Oe(B*5.9)*2.4,T=Ie.createRadialGradient(te,pe,0,te,pe,p*2);T.addColorStop(0,"rgba(10, 30, 60, 0.45)"),T.addColorStop(1,"rgba(10, 30, 60, 0)"),Ie.fillStyle=T,Ie.beginPath(),Ie.arc(te,pe,p*2,0,Math.PI*2),Ie.fill()}Ie.restore()},gt=(Ie,Ue)=>{Ie.clearRect(0,0,ye,Te);const et=Te*$e.waveCenter,qe=$e.waveBandPx,B=$e.segments,te=$e.colors.filaments,pe=Me||ye,p=0;rt(Ie,pe,p),Ie.strokeStyle=te,Ie.lineCap="round",Ie.lineJoin="round";for(let T=0;T<Ue.length;T+=1){const P=Ue[T],V=P.offset*qe*(.85+Oe(P.seed)*.4),Z=1-Math.min(1,Math.abs(V)/qe),fe=Math.exp(-Math.pow(V/$e.crestThickness,2)),W=P.layer===0?1.1:P.layer===1?.85:.6,L=.35+(1-P.depth)*.65,we=Z*L*W*(.34+fe*.45);Ie.globalAlpha=we,Ie.lineWidth=P.width*(1+(1-P.depth)*.8);const ne=[];for(let Q=0;Q<=B;Q+=1){const ge=Q/B*pe+p,oe=(We(ge*.012,P.seed)-.5)*$e.xJitter,le=ge+oe,Ce=(We(le*P.freqA,P.seed)-.5)*$e.jitterA,ze=(We(le*P.freqB,P.seed*1.7)-.5)*$e.jitterB,Ke=et+Math.sin(le*P.freqA+P.seed)*P.ampA+Math.sin(le*P.freqB+P.seed*1.3)*P.ampB+V+Ce+ze;ne.push({x:le,y:Ke})}Ie.beginPath(),Ie.moveTo(ne[0].x,ne[0].y);for(let Q=1;Q<ne.length-1;Q+=1){const ge=(ne[Q].x+ne[Q+1].x)/2,oe=(ne[Q].y+ne[Q+1].y)/2;Ie.quadraticCurveTo(ne[Q].x,ne[Q].y,ge,oe)}const G=ne[ne.length-1];Ie.quadraticCurveTo(G.x,G.y,G.x,G.y),Ie.stroke()}Ie.save(),Ie.globalCompositeOperation="lighter",Ie.strokeStyle=$e.colors.glow,Ie.lineCap="round",Ie.lineJoin="round";for(let T=0;T<Ue.length;T+=1){const P=Ue[T];if(Math.abs(P.offset)*qe>$e.crestThickness)continue;const V=$e.glowAlpha*(.7+(1-P.depth)*.6);Ie.globalAlpha=V,Ie.lineWidth=1.6+(1-P.depth)*1.2;const Z=[];for(let W=0;W<=B;W+=1){const L=W/B*pe+p,we=Math.sin(L*.02+P.seed)*3,ne=et+Math.sin(L*P.freqA+P.seed)*P.ampA+Math.sin(L*P.freqB+P.seed*1.3)*P.ampB+P.offset*qe*.35+we;Z.push({x:L,y:ne})}Ie.beginPath(),Ie.moveTo(Z[0].x,Z[0].y);for(let W=1;W<Z.length-1;W+=1){const L=(Z[W].x+Z[W+1].x)/2,we=(Z[W].y+Z[W+1].y)/2;Ie.quadraticCurveTo(Z[W].x,Z[W].y,L,we)}const fe=Z[Z.length-1];Ie.quadraticCurveTo(fe.x,fe.y,fe.x,fe.y),Ie.stroke()}Ie.restore()},at=()=>{ye=Math.floor(C.clientWidth),Te=Math.floor(C.clientHeight),Me=Math.floor(ye*1.8),tt=Te,Re=ye<820?J:K,U.forEach(Ie=>{const Ue=Ie.getContext("2d");if(!Ue)return;Ie.width=Math.floor(Me*Y*Re),Ie.height=Math.floor(tt*Y*Re),Ie.style.width=`${Me}px`,Ie.style.height=`${tt}px`,Ie.style.left=`${-(Me-ye)/2}px`,Ue.setTransform(Y*Re,0,0,Y*Re,0,0);const et=Number(Ie.dataset.seed||1),qe=Ae(et);gt(Ue,qe)})};return at(),window.addEventListener("resize",at,{passive:!0}),()=>window.removeEventListener("resize",at)},[m]);const Je=S[Math.min(A,S.length-1)],ue=b?Je:S[S.length-1],$=(ue==null?void 0:ue.theme)??S[0].theme,be={"--cogita-bg0":$.bg0,"--cogita-bg1":$.bg1,"--cogita-bg2":$.bg2,"--cogita-bloom":$.bloom,"--cogita-sat":$.sat};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:f,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Gs,{value:x,onChange:c}),e.jsx(Ys,{copy:t,label:s,isAuthenticated:r,secureMode:j,onLogin:a,onProfileNavigate:i,onToggleSecureMode:u,onLogout:o,variant:"ghost"})]}),e.jsx("main",{className:"cogita-main",children:e.jsxs("section",{ref:l,className:"cogita-section cogita-home",style:be,children:[e.jsxs("div",{className:"cogita-home-bg","aria-hidden":"true",children:[m.map((C,U)=>e.jsx("canvas",{className:"cogita-home-canvas cogita-home-canvas-layer",style:C.style,"data-seed":C.seed,ref:O=>{d.current[U]=O}},C.id)),w.map(C=>e.jsx("div",{className:"cogita-home-wave",style:C.style,children:e.jsx("div",{className:"cogita-home-wave-sway",children:e.jsx("div",{className:"cogita-home-wave-shape"})})},C.id)),e.jsx("div",{className:"cogita-home-glow"})]}),e.jsx(oi,{slides:S,activeIndex:A,introOpen:b,prefersReducedMotion:R,onNext:de,onPrev:ke,onSelect:H,onExit:M,onOpen:F,onRegister:ee})]})}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}const Vo=Object.freeze(Object.defineProperty({__proto__:null,CogitaPage:di},Symbol.toStringTag,{value:"Module"})),ir=n.createContext(!1);function $t({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,headerExtra:c,children:f}){if(n.useContext(ir))return e.jsx(e.Fragment,{children:f});const d=()=>{if(typeof window<"u"&&window.history.length>1){window.history.back();return}j("home")};return e.jsxs("div",{className:"portal-page cogita",children:[e.jsxs("header",{className:"portal-header cogita-header",children:[e.jsxs("div",{className:"portal-header-left",children:[e.jsx("button",{type:"button",className:"ghost portal-back",onClick:d,children:t.cogita.shell.back}),e.jsx("a",{className:"ghost portal-up",href:"/#/cogita",children:t.cogita.shell.up}),e.jsx("a",{className:"portal-brand",href:"/#/cogita",children:e.jsx("img",{src:"/cogita/logo/Cogita_Plain.svg",alt:"Cogita"})})]}),e.jsx(Gs,{value:g,onChange:x}),e.jsxs("div",{className:"cogita-header-right",children:[c,e.jsx(Ys,{copy:t,label:a,isAuthenticated:s,secureMode:o,onLogin:()=>j("home"),onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,variant:"ghost"})]})]}),e.jsx("main",{className:"cogita-main",children:f}),e.jsxs("footer",{className:"portal-footer cogita-footer",children:[e.jsx("a",{className:"portal-brand portal-footer-brand",href:"/#/",children:e.jsx("img",{src:"/logo_inv.svg",alt:"Recreatio"})}),e.jsx("span",{children:t.footer.headline})]})]})}function ua(t){const[a,s]=n.useState("Cogita library"),[r,i]=n.useState(null);return n.useEffect(()=>{let u=!1;return Xs().then(o=>{if(u)return;const j=o.find(g=>g.libraryId===t);j&&s(j.name)}).catch(()=>{u||s("Cogita library")}),()=>{u=!0}},[t]),n.useEffect(()=>{let u=!1;return jr(t).then(o=>{u||i(o)}).catch(()=>{u||i(null)}),()=>{u=!0}},[t]),{libraryName:a,stats:r}}function ys({slices:t}){const a=t.reduce((r,i)=>r+Math.max(0,i.value),0),s=n.useMemo(()=>{if(a<=0)return"conic-gradient(rgba(120, 160, 200, 0.3) 0deg 360deg)";let r=0;return`conic-gradient(${t.map(u=>{const j=Math.max(0,u.value)/a*360,g=r,x=r+j;return r=x,`${u.color} ${g}deg ${x}deg`}).join(",")})`},[t,a]);return e.jsxs("div",{className:"cogita-overview-pie-wrap",children:[e.jsx("div",{className:"cogita-overview-pie",style:{background:s}}),e.jsx("div",{className:"cogita-overview-legend",children:t.map(r=>e.jsxs("div",{className:"cogita-overview-legend-item",children:[e.jsx("span",{style:{background:r.color}}),e.jsx("strong",{children:r.value}),e.jsx("small",{children:r.label})]},r.label))})]})}function ui({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,libraryId:c}){const{libraryName:f,stats:l}=ua(c),[d,w]=n.useState("infos"),[m,S]=n.useState(0),[A,v]=n.useState(0),[b,X]=n.useState(0),R=(l==null?void 0:l.totalInfos)??0,k=(l==null?void 0:l.totalCollections)??0,D=0,N=0,ee=0,F=Math.max(0,R-ee-A),M=Math.max(0,R-A-b);n.useEffect(()=>{let de=!1;return(async()=>{try{const Je=await Ua({libraryId:c,limit:200}),ue=await Promise.all(Je.items.map($=>Zn({libraryId:c,collectionId:$.collectionId}).catch(()=>[])));if(de)return;S(ue.reduce(($,be)=>$+be.length,0))}catch{de||S(0)}})(),()=>{de=!0}},[c]),n.useEffect(()=>{let de=!1;return(async()=>{try{const[Je,ue,$]=await Promise.all([gs({libraryId:c,type:"computed",limit:1}).catch(()=>({total:0})),gs({libraryId:c,type:"source",limit:1}).catch(()=>({total:0})),es({libraryId:c}).catch(()=>({items:[]}))]);if(de)return;v((Je.total??0)+(ue.total??0));const be=new Set($.items.filter(C=>C.childItemType.toLowerCase()==="info").map(C=>C.childItemId).filter(Boolean));X(be.size)}catch{de||(v(0),X(0))}})(),()=>{de=!0}},[c]);const H=[{key:"infos",label:t.cogita.library.overview.stats.totalInfos,value:R},{key:"collections",label:t.cogita.library.overview.stats.collections,value:k},{key:"revisions",label:t.cogita.library.overview.stats.revisions,value:m},{key:"storyboards",label:t.cogita.library.overview.stats.storyboards,value:D},{key:"texts",label:t.cogita.library.overview.stats.texts,value:N}];return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsx("div",{children:e.jsx("h1",{className:"cogita-library-title",children:f})})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[e.jsx("div",{className:"cogita-overview-counters",children:H.map(de=>e.jsxs("button",{type:"button",className:`cogita-overview-counter ${d===de.key?"active":""}`,onClick:()=>w(de.key),children:[e.jsx("span",{children:de.label}),e.jsx("strong",{children:de.value})]},de.key))}),e.jsxs("section",{className:"cogita-overview-main-card",children:[e.jsx("header",{children:e.jsx("h2",{children:t.cogita.library.overview.statsCardTitle})}),d==="infos"?e.jsxs("div",{className:"cogita-overview-main-grid",children:[e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.knownChartTitle}),e.jsx(ys,{slices:[{label:t.cogita.library.overview.known,value:ee,color:"#75d79a"},{label:t.cogita.library.overview.unknown,value:F,color:"#85b9ff"},{label:t.cogita.library.overview.excluded,value:A,color:"#9ca6bb"}]})]}),e.jsxs("article",{children:[e.jsx("h3",{children:t.cogita.library.overview.checksChartTitle}),e.jsx(ys,{slices:[{label:t.cogita.library.overview.availableChecks,value:b,color:"#75d79a"},{label:t.cogita.library.overview.unavailableChecks,value:M,color:"#7ea4d6"}]})]})]}):e.jsxs("div",{className:"cogita-overview-placeholder",children:[e.jsx("p",{children:t.cogita.library.overview.statsCardHint}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]})]})})]})})}const it=(t,a)=>{const s=t.cogita.library.infoTypes,r=t.cogita.library.connectionTypes,i=t.cogita.library.groupTypes;return{any:s.any,vocab:s.vocab,book:i.book,citation:i.citation,language:s.language,word:s.word,sentence:s.sentence,topic:s.topic,collection:s.collection,person:s.person,institution:s.institution,collective:s.collective,orcid:s.orcid,address:s.address,email:s.email,phone:s.phone,media:s.media,work:s.work,geo:s.geo,music_piece:s.musicPiece,music_fragment:s.musicFragment,source:s.source,question:s.question,computed:s.computed,"word-language":r.wordLanguage,"citation-language":r.citationLanguage,"language-sentence":r.languageSentence,translation:r.translation,"word-topic":r.wordTopic,reference:r.reference,"source-resource":r.sourceResource,"work-contributor":r.workContributor,"work-medium":r.workMedium,"orcid-link":r.orcidLink}[a]??String(a)},hi=t=>[{value:"any",label:it(t,"any")},{value:"language",label:it(t,"language")},{value:"word",label:it(t,"word")},{value:"sentence",label:it(t,"sentence")},{value:"topic",label:it(t,"topic")},{value:"collection",label:it(t,"collection")},{value:"person",label:it(t,"person")},{value:"institution",label:it(t,"institution")},{value:"collective",label:it(t,"collective")},{value:"orcid",label:it(t,"orcid")},{value:"address",label:it(t,"address")},{value:"email",label:it(t,"email")},{value:"phone",label:it(t,"phone")},{value:"media",label:it(t,"media")},{value:"work",label:it(t,"work")},{value:"geo",label:it(t,"geo")},{value:"music_piece",label:it(t,"music_piece")},{value:"music_fragment",label:it(t,"music_fragment")},{value:"source",label:it(t,"source")},{value:"question",label:it(t,"question")},{value:"citation",label:it(t,"citation")},{value:"computed",label:it(t,"computed")},{value:"vocab",label:it(t,"vocab")},{value:"book",label:it(t,"book")},{value:"word-language",label:it(t,"word-language")},{value:"citation-language",label:it(t,"citation-language")},{value:"language-sentence",label:it(t,"language-sentence")},{value:"translation",label:it(t,"translation")},{value:"word-topic",label:it(t,"word-topic")},{value:"reference",label:it(t,"reference")},{value:"source-resource",label:it(t,"source-resource")},{value:"work-contributor",label:it(t,"work-contributor")},{value:"work-medium",label:it(t,"work-medium")},{value:"orcid-link",label:it(t,"orcid-link")}],gi=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}],Mn={key:"languageId",labelKey:"language",kind:"select",path:"languageId",optionsSource:"languages",matcher:"equals"},mi={language:{infoType:"language",entityKind:"single",structure:{payloadFields:["label","name","code"]},filterFields:[]},word:{infoType:"word",entityKind:"single",structure:{payloadFields:["label","lemma","languageId"],connections:[{relationType:"word-language",role:"language",targetType:"language"}]},filterFields:[Mn]},sentence:{infoType:"sentence",entityKind:"single",structure:{payloadFields:["label","text","languageId"],connections:[{relationType:"language-sentence",role:"language",targetType:"language"}]},filterFields:[Mn]},topic:{infoType:"topic",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collection:{infoType:"collection",entityKind:"complex",structure:{payloadFields:["label","name"]},filterFields:[]},person:{infoType:"person",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},institution:{infoType:"institution",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},collective:{infoType:"collective",entityKind:"single",structure:{payloadFields:["label","name"]},filterFields:[]},orcid:{infoType:"orcid",entityKind:"single",structure:{payloadFields:["label","orcid"]},filterFields:[{key:"orcid",label:"ORCID",kind:"text",path:"orcid",matcher:"contains"}]},address:{infoType:"address",entityKind:"single",structure:{payloadFields:["label","street","city","postalCode","country"]},filterFields:[]},email:{infoType:"email",entityKind:"single",structure:{payloadFields:["label","email","address"]},filterFields:[]},phone:{infoType:"phone",entityKind:"single",structure:{payloadFields:["label","phone","number"]},filterFields:[]},media:{infoType:"media",entityKind:"single",structure:{payloadFields:["label","name","url","kind"]},filterFields:[]},work:{infoType:"work",entityKind:"single",structure:{payloadFields:["label","title","subtitle","doi","isbn","issn","languageId","originalLanguageId"]},filterFields:[Mn,{key:"originalLanguageId",labelKey:"originalLanguage",kind:"select",path:"originalLanguageId",optionsSource:"languages",matcher:"equals"},{key:"doi",labelKey:"doi",kind:"text",path:"doi",matcher:"contains"}]},geo:{infoType:"geo",entityKind:"single",structure:{payloadFields:["label","name","country","region","city"]},filterFields:[]},music_piece:{infoType:"music_piece",entityKind:"single",structure:{payloadFields:["label","title","composer"]},filterFields:[]},music_fragment:{infoType:"music_fragment",entityKind:"single",structure:{payloadFields:["label","title","text"]},filterFields:[]},source:{infoType:"source",entityKind:"single",structure:{payloadFields:["label","title","sourceKind","locator"],connections:[{relationType:"source-resource",role:"resource",targetType:"work"}]},filterFields:[{key:"sourceKind",labelKey:"sourceKind",kind:"select",path:"sourceKind",optionsSource:"sourceKinds",matcher:"equals"},{key:"locator",labelKey:"locator",kind:"text",path:"locator",matcher:"locator_contains"}]},citation:{infoType:"citation",entityKind:"single",structure:{payloadFields:["title","text"],connections:[{relationType:"citation-language",role:"language",targetType:"language"},{relationType:"reference",role:"source",targetType:"source"}]},filterFields:[{key:"text",labelKey:"citationText",kind:"text",path:"text",matcher:"contains"}]},question:{infoType:"question",entityKind:"single",structure:{payloadFields:["definition"]},filterFields:[{key:"questionType",labelKey:"type",kind:"text",path:"definition.type",matcher:"contains"},{key:"questionText",labelKey:"text",kind:"text",path:"definition.question",matcher:"contains"}]},computed:{infoType:"computed",entityKind:"complex",structure:{payloadFields:["label","title","definition"]},filterFields:[]},translation:{infoType:"translation",entityKind:"connection",structure:{payloadFields:["note","tagIds"],connections:[{relationType:"translation",role:"wordA",targetType:"word"},{relationType:"translation",role:"wordB",targetType:"word"},{relationType:"word-language",role:"languageA",targetType:"language"},{relationType:"word-language",role:"languageB",targetType:"language"}]},filterFields:[{key:"languageAId",labelKey:"languageA",kind:"select",optionsSource:"languages",matcher:"equals"},{key:"languageBId",labelKey:"languageB",kind:"select",optionsSource:"languages",matcher:"equals"}]}},xs={infoType:"default",entityKind:"single",structure:{payloadFields:["label"]},filterFields:[]};function pi(t){return t?mi[t]??xs:xs}function fi(t,a){return t.optionsSource==="languages"?a.languages.map(s=>({value:s.infoId,label:s.label})):t.optionsSource==="sourceKinds"?gi:[]}const bi="cogita.revision.seed:";function or(t){return`${bi}${t}`}function yi(t,a){if(typeof window>"u")return null;const s=Array.from(new Set(a.map(u=>u.trim()).filter(Boolean)));if(!s.length)return null;const r=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,i={kind:"info-selection",libraryId:t,infoIds:s,createdAt:new Date().toISOString()};return window.localStorage.setItem(or(r),JSON.stringify(i)),r}function vs(t,a){if(typeof window>"u")return null;const s=window.localStorage.getItem(or(a));if(!s)return null;try{const r=JSON.parse(s);if(r.kind!=="info-selection"||r.libraryId!==t||!Array.isArray(r.infoIds))return null;const i=r.infoIds.map(u=>String(u??"").trim()).filter(Boolean);return i.length?{infoIds:i}:null}catch{return null}}const xi="cogita.collection-draft:";function lr(t){return`${xi}${t}`}function vi(t,a){if(typeof window>"u")return null;const s=Array.from(new Set(a.map(u=>u.trim()).filter(Boolean)));if(!s.length)return null;const r=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,i={kind:"info-selection",libraryId:t,infoIds:s,createdAt:new Date().toISOString()};return window.localStorage.setItem(lr(r),JSON.stringify(i)),r}function ji(t,a){if(typeof window>"u")return null;const s=window.localStorage.getItem(lr(a));if(!s)return null;try{const r=JSON.parse(s);if(r.kind!=="info-selection"||r.libraryId!==t||!Array.isArray(r.infoIds))return null;const i=r.infoIds.map(u=>String(u??"").trim()).filter(Boolean);return i.length?{infoIds:i}:null}catch{return null}}const An=60,wi=500;function cr(t){return`cogita.info-selection:${t}`}function js(t){if(typeof window>"u")return{};const a=window.localStorage.getItem(cr(t));if(!a)return{};try{const s=JSON.parse(a);return!s||typeof s!="object"?{}:s}catch{return{}}}function ki({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,libraryId:c,mode:f}){var Ut;const l=Wa(),d=Ea(),w=t.cogita.library.list,[m,S]=n.useState("any"),[A,v]=n.useState(""),[b,X]=n.useState("relevance"),[R,k]=n.useState("details"),[D,N]=n.useState(!1),[ee,F]=n.useState("idle"),[M,H]=n.useState([]),[de,ke]=n.useState(An),[Je,ue]=n.useState(null),[$,be]=n.useState(()=>js(c)),[C,U]=n.useState({}),[O,K]=n.useState([]),[J,Y]=n.useState([]),[ye,Te]=n.useState(null),[Re,Me]=n.useState(null),[tt,ot]=n.useState(null),[$e,Oe]=n.useState("idle"),[kt,We]=n.useState([]),[Ae,rt]=n.useState(""),[gt,at]=n.useState(null),[Ie,Ue]=n.useState("idle"),[et,qe]=n.useState(null),[B,te]=n.useState(null),[pe,p]=n.useState("idle"),[T,P]=n.useState([]),[V,Z]=n.useState("idle"),fe=n.useMemo(()=>hi(t),[t]),W=n.useMemo(()=>[{value:"relevance",label:w.sortRelevance},{value:"label_asc",label:w.sortLabelAsc},{value:"label_desc",label:w.sortLabelDesc},{value:"type_asc",label:w.sortTypeAsc},{value:"type_desc",label:w.sortTypeDesc}],[w.sortLabelAsc,w.sortLabelDesc,w.sortRelevance,w.sortTypeAsc,w.sortTypeDesc]);n.useEffect(()=>{be(js(c)),U({}),N(!1)},[c]),n.useEffect(()=>{es({libraryId:c}).then(_=>ot(_)).catch(()=>ot({items:[]}))},[c]),n.useEffect(()=>{wr({libraryId:c}).then(_=>We(_)).catch(()=>We([]))},[c]),n.useEffect(()=>{Ln({libraryId:c,type:"language",filters:{sourceKind:"info"},limit:200}).then(_=>{const h=_.map(se=>({infoId:se.infoId??"",infoType:se.entityType,label:se.title})).filter(se=>se.infoId.length>0);K(h)}).catch(()=>K([]))},[c]),n.useEffect(()=>{Ln({libraryId:c,type:"source",filters:{sourceKind:"info"},limit:200}).then(_=>{const h=_.map(se=>({infoId:se.infoId??"",infoType:se.entityType,label:se.title})).filter(se=>se.infoId.length>0);Y(h)}).catch(()=>Y([]))},[c]),n.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(cr(c),JSON.stringify($))},[c,$]);const L=n.useMemo(()=>pi(m==="any"?null:m),[m]),we=n.useMemo(()=>new URLSearchParams(d.search),[d.search]),ne=n.useMemo(()=>d.pathname.split("/").filter(Boolean),[d.pathname]),G=ne.findIndex(_=>_==="infos"),Q=G>=0&&(ne[G+1]??"").trim()||null,ge=G>=0?(ne[G+2]??"").trim():"",oe=G>=0?ge==="checkcards"?"cards":ge==="collections"?"collections":"overview":"",le=Q??((we.get("infoId")??"").trim()||null),Ce=Q?oe:(we.get("infoView")??"overview").trim(),ze=Ce==="overview"&&!!le,Ke=Ce==="collections"&&!!le,Ee=n.useMemo(()=>({language:w.typeFilterLanguage,languageA:w.typeFilterLanguageA,languageB:w.typeFilterLanguageB,originalLanguage:w.typeFilterOriginalLanguage,doi:w.typeFilterDoi,sourceKind:w.typeFilterSourceKind,locator:w.typeFilterLocator,citationText:w.typeFilterCitationText}),[w.typeFilterDoi,w.typeFilterLanguage,w.typeFilterLanguageA,w.typeFilterLanguageB,w.typeFilterLocator,w.typeFilterOriginalLanguage,w.typeFilterCitationText,w.typeFilterSourceKind]),bt=n.useMemo(()=>L.filterFields.map(_=>({..._,label:_.labelKey?Ee[_.labelKey]:_.label??_.key,options:fi(_,{languages:O})})),[Ee,O,L.filterFields]),dt=n.useMemo(()=>bt.some(_=>(C[_.key]??"").trim().length>0),[bt,C]);n.useEffect(()=>{U({})},[m]),n.useEffect(()=>{const _={sourceKind:"info"};if(dt)for(const q of bt){const Ze=(C[q.key]??"").trim();Ze&&(_[q.path??q.key]=Ze)}const h=(C.__referenceId??"").trim();h&&(_["link.references"]=h),F("loading");const se=window.setTimeout(()=>{Ln({libraryId:c,type:m==="any"?void 0:m,query:A.trim()||void 0,filters:_,limit:wi}).then(q=>{const Ze=q.map(ht=>({infoId:ht.infoId??"",infoType:ht.entityType,label:ht.title})).filter(ht=>ht.infoId.length>0);H(Ze),F("ready")}).catch(()=>{H([]),F("ready")})},240);return()=>window.clearTimeout(se)},[dt,c,A,m,bt,C]),n.useEffect(()=>{if(!le||Ce!=="overview"&&Ce!=="collections"){Te(null),Me(null),Oe("idle");return}let _=!1;return Oe("loading"),Promise.all([aa({libraryId:c,infoId:le}),kr({libraryId:c,itemType:"info",itemId:le}).catch(()=>null)]).then(([h,se])=>{_||(Te(h),Me(se),Oe("ready"))}).catch(()=>{_||(Te(null),Me(null),Oe("error"))}),()=>{_=!0}},[c,le,Ce]),n.useEffect(()=>{if(!le||Ce!=="collections"){P([]),Z("idle");return}let _=!1;return Z("loading"),Nr({libraryId:c,infoId:le}).then(h=>{_||(P(h),Z("ready"))}).catch(()=>{_||(P([]),Z("error"))}),()=>{_=!0}},[c,le,Ce]),n.useEffect(()=>{if(!le||Ce!=="overview"){qe(null),te(null),p("idle");return}let _=!1;return p("loading"),Promise.all([nn({libraryId:c,infoId:le}),sn({libraryId:c,infoId:le})]).then(([h,se])=>{_||(qe(h),te(se),p("ready"))}).catch(()=>{_||(qe(null),te(null),p("error"))}),()=>{_=!0}},[c,le,Ce]);const yt=n.useMemo(()=>ye?kt.filter(_=>_.sourceInfoTypes.some(h=>h.toLowerCase()===ye.infoType.toLowerCase())):[],[kt,ye]);n.useEffect(()=>{if(!ye){rt("");return}rt(_=>{var h;return _&&yt.some(se=>se.approachKey===_)?_:((h=yt[0])==null?void 0:h.approachKey)??""})},[yt,ye]),n.useEffect(()=>{if(!ye||!Ae){at(null),Ue("idle");return}let _=!1;return Ue("loading"),Zs({libraryId:c,infoId:ye.infoId,approachKey:Ae}).then(h=>{_||(at(h),Ue("ready"))}).catch(()=>{_||(at(null),Ue("error"))}),()=>{_=!0}},[c,Ae,ye]);const He=n.useMemo(()=>{const _=M.slice(),h=se=>it(t,se);return b==="relevance"?_:b==="label_asc"?_.sort((se,q)=>se.label.localeCompare(q.label)):b==="label_desc"?_.sort((se,q)=>q.label.localeCompare(se.label)):b==="type_asc"?_.sort((se,q)=>se.infoType===q.infoType?se.label.localeCompare(q.label):h(se.infoType).localeCompare(h(q.infoType))):_.sort((se,q)=>se.infoType===q.infoType?se.label.localeCompare(q.label):h(q.infoType).localeCompare(h(se.infoType)))},[t,M,b]),_e=n.useMemo(()=>He.slice(0,de),[He,de]),mt=_e.length<He.length,nt=n.useMemo(()=>new Set(Object.keys($)),[$]),pt=n.useMemo(()=>Object.values($),[$]),Bt=n.useMemo(()=>{const _=new Map;for(const h of pt)_.set(h.infoType,(_.get(h.infoType)??0)+1);return Array.from(_.entries()).sort((h,se)=>se[1]-h[1]||h[0].localeCompare(se[0]))},[pt]),It=n.useMemo(()=>{if(!le||!tt)return 0;const _=new Set;for(const h of tt.items)h.childItemType!=="info"||h.childItemId!==le||_.add([h.parentItemType,h.parentItemId,h.parentCheckType??"",h.parentDirection??""].join("|"));return _.size},[tt,le]);n.useEffect(()=>{ke(An);const _=new Set(M.map(h=>h.infoId));ue(h=>h&&_.has(h)?h:null)},[M]);const Nt=_=>{be(h=>({...h,[_.infoId]:{infoId:_.infoId,infoType:_.infoType,label:_.label}}))},Lt=_=>{be(h=>{if(!h[_])return h;const se={...h};return delete se[_],se})},St=(_,h)=>{if(h){Nt(_);return}Lt(_.infoId)},ut=_=>{l(`/cogita/library/${c}/infos/${encodeURIComponent(_)}`,{replace:!0})},Kt=()=>{l(`/cogita/library/${c}/list`,{replace:!0})},lt=()=>{le&&l(`/cogita/library/${c}/edit/${encodeURIComponent(le)}`,{replace:!0})},Ye=()=>{const _=yi(c,pt.map(h=>h.infoId));_&&l(`/cogita/library/${c}/revision/run?libraryTarget=revisions&scope=info-selection&seed=${encodeURIComponent(_)}`)},Tt=()=>{const _=vi(c,pt.map(h=>h.infoId));_&&l(`/cogita/library/${c}/collections/new?draft=${encodeURIComponent(_)}&draftType=info-selection`)},Gt=pt.length===1?((Ut=pt[0])==null?void 0:Ut.infoId)??null:null,qt=w.selectionCount.replace("{count}",String(pt.length)),Vt=f==="collection"?"grid":f==="detail"?"wide":R,he=Si(g),Et=Re?Math.max(0,Math.min(100,Math.round((Re.score??0)*100))):0,Zt=Re?Ti(Re,he):he.noKnownnessData;return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":Vt,children:e.jsx("div",{className:"cogita-library-layout",children:e.jsxs("div",{className:"cogita-library-content",children:[ze?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:he.kicker}),e.jsx("h2",{className:"cogita-card-title",children:ye?ws(ye.payload,ye.infoType,ye.infoId):he.loading}),ye?e.jsxs("p",{className:"cogita-card-subtitle",children:[it(t,ye.infoType)," · ",ye.infoId]}):null]}),e.jsxs("div",{className:"cogita-info-overview-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:Kt,children:he.backToSearch}),e.jsx("button",{type:"button",className:"cta",onClick:lt,disabled:!le||$e!=="ready",children:w.editInfo})]})]}),$e==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:he.loading})}):$e==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:he.loadError})}):ye?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-info-overview-metrics",children:[e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:he.knownness}),e.jsxs("div",{className:"cogita-info-metric-value",children:[Et,"%"]}),e.jsx("div",{className:"cogita-info-progress","aria-hidden":"true",children:e.jsx("span",{style:{width:`${Et}%`}})}),e.jsx("p",{className:"cogita-library-hint",children:Zt})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:he.reviews}),e.jsx("div",{className:"cogita-info-metric-value",children:(Re==null?void 0:Re.totalReviews)??0}),e.jsx("p",{className:"cogita-library-hint",children:he.correct.replace("{correct}",String((Re==null?void 0:Re.correctReviews)??0)).replace("{total}",String((Re==null?void 0:Re.totalReviews)??0))}),e.jsx("p",{className:"cogita-library-hint",children:Re!=null&&Re.lastReviewedUtc?`${he.lastReview}: ${Ni(Re.lastReviewedUtc,g)}`:he.noLastReview})]}),e.jsxs("article",{className:"cogita-info-metric-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:he.linkedCards}),e.jsx("div",{className:"cogita-info-metric-value",children:It}),e.jsx("p",{className:"cogita-library-hint",children:he.linkedCardsHint})]})]}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:he.checkcards}),pe==="loading"?e.jsx("p",{className:"cogita-library-hint",children:he.loadingCheckcards}):pe==="error"?e.jsx("p",{className:"cogita-library-hint",children:he.loadCheckcardsError}):e.jsxs("div",{className:"cogita-info-tree",children:[e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:he.checkcardCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(et==null?void 0:et.items.length)??0})]}),e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:he.dependencyCount}),e.jsx("div",{className:"cogita-info-tree-value",children:(B==null?void 0:B.items.length)??0})]})]})]}),yt.length>0?e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsxs("div",{className:"cogita-info-approach-header",children:[e.jsx("h3",{children:he.approach}),e.jsx("select",{value:Ae,onChange:_=>rt(_.target.value),"aria-label":he.approach,children:yt.map(_=>e.jsx("option",{value:_.approachKey,children:_.label},_.approachKey))})]}),Ie==="loading"?e.jsx("p",{className:"cogita-library-hint",children:he.loadingApproach}):Ie==="error"?e.jsx("p",{className:"cogita-library-hint",children:he.loadApproachError}):gt?e.jsx(rn,{value:gt.projection,emptyLabel:he.empty}):e.jsx("p",{className:"cogita-library-hint",children:he.noApproachData})]}):null,e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:he.payload}),e.jsx(rn,{value:ye.payload,emptyLabel:he.empty})]}),e.jsxs("section",{className:"cogita-info-overview-panel",children:[e.jsx("h3",{children:he.links}),e.jsx(Ci,{links:ye.links,emptyLabel:he.noLinks})]})]})]}):null]})}):null,Ke?e.jsx("section",{className:"cogita-library-search-surface",children:e.jsxs("section",{className:"cogita-info-overview",children:[e.jsxs("div",{className:"cogita-info-overview-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Informacja"}),e.jsx("h2",{className:"cogita-card-title",children:ye?ws(ye.payload,ye.infoType,ye.infoId):le??""}),e.jsx("p",{className:"cogita-card-subtitle",children:"Collections using this info"})]}),e.jsx("div",{className:"cogita-info-overview-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:Kt,children:"Back to search"})})]}),V==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading collections..."})}):null,V==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load collections."})}):null,V==="ready"&&T.length===0?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"This info is not used in any collection yet."})}):null,V==="ready"&&T.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:T.map(_=>e.jsx("article",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`/#/cogita/library/${c}/collections/${_.collectionId}?libraryTarget=collections`,children:[e.jsx("div",{className:"cogita-card-type",children:"Collection"}),e.jsx("h3",{className:"cogita-card-title",children:_.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[_.itemCount," items"]})]})},_.collectionId))}):null]})}):null,!ze&&!Ke?e.jsxs("section",{className:"cogita-library-search-surface",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsx("div",{className:"cogita-library-search",children:e.jsxs("div",{className:"cogita-search-field",children:[e.jsx("select",{"aria-label":w.typeLabel,value:m,onChange:_=>S(_.target.value),children:fe.map(_=>e.jsx("option",{value:_.value,children:_.label},_.value))}),e.jsx("input",{type:"text",value:A,onChange:_=>v(_.target.value),placeholder:w.searchPlaceholder}),e.jsx("select",{"aria-label":w.sortLabel,value:b,onChange:_=>X(_.target.value),children:W.map(_=>e.jsx("option",{value:_.value,children:_.label},_.value))}),e.jsxs("select",{"aria-label":w.viewLabel,value:R,onChange:_=>k(_.target.value),children:[e.jsx("option",{value:"details",children:w.viewDetails}),e.jsx("option",{value:"wide",children:w.viewWide}),e.jsx("option",{value:"grid",children:w.viewGrid})]})]})})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:w.cardCount.replace("{shown}",String(_e.length)).replace("{total}",String(He.length))}),e.jsx("span",{children:ee==="loading"?w.loading:w.ready})]}),e.jsxs("div",{className:"cogita-filters-toggle-row",children:[e.jsx("button",{type:"button",className:"ghost cogita-filters-toggle",onClick:()=>N(_=>!_),children:D?w.hideFilters:w.showFilters}),e.jsx("span",{className:"cogita-sidebar-note",children:w.filtersOptionalHint})]}),D?e.jsx("section",{className:"cogita-library-filters cogita-library-filters--compact",children:e.jsxs("div",{className:"cogita-filter-grid",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:w.typeLabel}),e.jsx("select",{value:m,onChange:_=>S(_.target.value),children:fe.map(_=>e.jsx("option",{value:_.value,children:_.label},`advanced-type:${_.value}`))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Reference"}),e.jsxs("select",{value:C.__referenceId??"",onChange:_=>U(h=>({...h,__referenceId:_.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),J.map(_=>e.jsx("option",{value:_.infoId,children:_.label},`reference:${_.infoId}`))]})]}),bt.map(_=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:_.label}),_.kind==="select"?e.jsxs("select",{value:C[_.key]??"",onChange:h=>U(se=>({...se,[_.key]:h.target.value})),children:[e.jsx("option",{value:"",children:t.cogita.library.filters.clear}),(_.options??[]).map(h=>e.jsx("option",{value:h.value,children:h.label},`${_.key}:${h.value}`))]}):e.jsx("input",{type:"text",value:C[_.key]??"",onChange:h=>U(se=>({...se,[_.key]:h.target.value}))})]},`type-filter:${_.key}`))]})}):null,e.jsxs("div",{className:"cogita-info-selection-bar",children:[e.jsx("span",{children:qt}),e.jsxs("div",{className:"cogita-info-selection-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>{be(_=>{const h={..._};for(const se of _e)h[se.infoId]={infoId:se.infoId,infoType:se.infoType,label:se.label};return h})},disabled:_e.length===0,children:w.selectAllVisible}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>be({}),disabled:pt.length===0,children:w.clearSelection}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>Gt&&ut(Gt),disabled:!Gt,title:Gt?void 0:w.openSelectedDisabled,children:w.openSelected})]})]}),Vt==="details"?e.jsxs("div",{className:"cogita-details-grid",role:"table","aria-label":w.searchTitle,children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:w.detailColumnName}),e.jsx("span",{children:w.detailColumnType}),e.jsx("span",{children:w.detailColumnId}),e.jsx("span",{})]}),_e.length?_e.map(_=>{const h=it(t,_.infoType),se=nt.has(_.infoId),q=Je===_.infoId;return e.jsxs("div",{className:`cogita-details-row ${q||se?"active":""}`,role:"row",onClick:()=>ue(_.infoId),children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:se,onChange:Ze=>St(_,Ze.target.checked),onClick:Ze=>Ze.stopPropagation()}),e.jsx("span",{})]}),e.jsx("span",{title:_.label,children:_.label}),e.jsx("span",{title:h,children:h}),e.jsx("span",{title:_.infoId,children:_.infoId}),e.jsx("button",{type:"button",className:"ghost cogita-details-open",onClick:Ze=>{Ze.stopPropagation(),ut(_.infoId)},"aria-label":w.editInfo,children:">"})]},_.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:w.noMatch})})]}):e.jsx("div",{className:`cogita-card-list cogita-card-list--${Vt}`,"data-view":Vt,children:_e.length?_e.map(_=>{const h=it(t,_.infoType),se=nt.has(_.infoId),q=Je===_.infoId;return e.jsx("article",{className:"cogita-card-item","data-selected":q||se,children:e.jsxs("div",{className:"cogita-info-result-row",children:[e.jsxs("label",{className:"cogita-info-checkbox",children:[e.jsx("input",{type:"checkbox",checked:se,onChange:Ze=>St(_,Ze.target.checked)}),e.jsx("span",{})]}),e.jsxs("button",{type:"button",className:"cogita-info-result-main",onClick:()=>ue(_.infoId),children:[e.jsx("div",{className:"cogita-card-type",children:h}),e.jsx("h3",{className:"cogita-card-title",children:_.label}),e.jsx("p",{className:"cogita-card-subtitle",children:_.infoId})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>ut(_.infoId),children:w.editInfo})]})},_.infoId)}):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:w.noMatch})})}),mt?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>ke(_=>_+An),children:w.loadMore})}):null,pt.length>0?e.jsxs("section",{className:"cogita-selection-stack",children:[e.jsx("p",{className:"cogita-user-kicker",children:w.selectedStackTitle}),e.jsx("p",{className:"cogita-library-hint",children:w.selectedStackHint}),e.jsx("div",{className:"cogita-selection-overview",children:Bt.map(([_,h])=>e.jsxs("span",{className:"cogita-tag-chip",children:[e.jsx("span",{children:it(t,_)}),e.jsx("span",{className:"cogita-tag-count",children:h})]},`stack:type:${_}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:Ye,disabled:pt.length===0,children:"Start revision"}),e.jsx("button",{type:"button",className:"ghost",onClick:Tt,disabled:pt.length===0,children:"Create collection from selection"})]})]}):null]}):null]})})})})}function ws(t,a,s){if(t&&typeof t=="object"&&!Array.isArray(t)){const r=t,i=["title","name","label","value","text","quote","term"];for(const u of i){const o=r[u];if(typeof o=="string"&&o.trim())return o.trim()}}return`${a} · ${s}`}function Ni(t,a){try{const s=a==="pl"?"pl-PL":a==="de"?"de-DE":"en-US";return new Intl.DateTimeFormat(s,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}catch{return t}}function Si(t){return t==="pl"?{kicker:"Informacja",backToSearch:"Wróć do wyszukiwania",loading:"Ładowanie informacji...",loadError:"Nie udało się wczytać informacji.",knownness:"Znajomość",reviews:"Sprawdzenia",correct:"Poprawne: {correct} / {total}",lastReview:"Ostatnie sprawdzenie",noLastReview:"Brak sprawdzeń",linkedCards:"Powiązane karty",linkedCardsHint:"Karty sprawdzające zależne od tej informacji",payload:"Treść informacji",links:"Powiązania",empty:"Brak danych",noLinks:"Brak powiązań",checkcards:"Karty sprawdzające",loadingCheckcards:"Ładowanie kart sprawdzających...",loadCheckcardsError:"Nie udało się wczytać kart sprawdzających.",noCheckcards:"Brak kart sprawdzających.",checkcardCount:"Liczba kart",dependencyCount:"Zależności (efektywne)",approach:"Podejście",loadingApproach:"Ładowanie widoku...",loadApproachError:"Nie udało się wczytać widoku.",noApproachData:"Brak danych widoku.",noKnownnessData:"Brak danych o znajomości",developmentStart:"Początek nauki",developmentGrowing:"Rozwój w toku",developmentStable:"Utrwalona wiedza",developmentStrong:"Bardzo dobra znajomość"}:t==="de"?{kicker:"Information",backToSearch:"Zur Suche",loading:"Information wird geladen...",loadError:"Information konnte nicht geladen werden.",knownness:"Kenntnisstand",reviews:"Abfragen",correct:"Richtig: {correct} / {total}",lastReview:"Letzte Abfrage",noLastReview:"Noch keine Abfragen",linkedCards:"Verknüpfte Karten",linkedCardsHint:"Prüfkarten, die von dieser Information abhängen",payload:"Inhalt",links:"Verknüpfungen",empty:"Keine Daten",noLinks:"Keine Verknüpfungen",checkcards:"Prüfkarten",loadingCheckcards:"Prüfkarten werden geladen...",loadCheckcardsError:"Prüfkarten konnten nicht geladen werden.",noCheckcards:"Keine Prüfkarten.",checkcardCount:"Anzahl Karten",dependencyCount:"Abhängigkeiten (effektiv)",approach:"Ansicht",loadingApproach:"Ansicht wird geladen...",loadApproachError:"Ansicht konnte nicht geladen werden.",noApproachData:"Keine Ansichtsdaten.",noKnownnessData:"Keine Kenntnisdaten",developmentStart:"Lernbeginn",developmentGrowing:"Aufbauphase",developmentStable:"Stabil",developmentStrong:"Sehr sicher"}:{kicker:"Info",backToSearch:"Back to search",loading:"Loading info...",loadError:"Failed to load info.",knownness:"Knownness",reviews:"Reviews",correct:"Correct: {correct} / {total}",lastReview:"Last review",noLastReview:"No reviews yet",linkedCards:"Linked checking cards",linkedCardsHint:"Checking cards depending on this info",payload:"Information",links:"Links",empty:"No data",noLinks:"No links",checkcards:"Checkcards",loadingCheckcards:"Loading checkcards...",loadCheckcardsError:"Failed to load checkcards.",noCheckcards:"No checkcards.",checkcardCount:"Checkcard count",dependencyCount:"Dependencies (effective)",approach:"Approach",loadingApproach:"Loading view...",loadApproachError:"Failed to load view.",noApproachData:"No view data.",noKnownnessData:"No knownness data",developmentStart:"Just started",developmentGrowing:"In progress",developmentStable:"Stable",developmentStrong:"Strong"}}function Ti(t,a){return t.totalReviews<=0?a.noKnownnessData:t.totalReviews<3||t.score<.35?a.developmentStart:t.totalReviews<8||t.score<.65?a.developmentGrowing:t.score<.85?a.developmentStable:a.developmentStrong}function Ci({links:t,emptyLabel:a}){return!t||Object.keys(t).length===0?e.jsx("p",{className:"cogita-library-hint",children:a}):e.jsx("div",{className:"cogita-info-tree",children:Object.entries(t).map(([s,r])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:s}),e.jsx("div",{className:"cogita-info-tree-value",children:Array.isArray(r)?r.length?e.jsx("div",{className:"cogita-selection-overview",children:r.map(i=>e.jsx("span",{className:"cogita-tag-chip",children:i},`${s}:${i}`))}):e.jsx("span",{className:"cogita-library-hint",children:"[]"}):r?e.jsx("span",{className:"cogita-tag-chip",children:r}):e.jsx("span",{className:"cogita-library-hint",children:"null"})})]},s))})}function rn({value:t,emptyLabel:a}){if(t==null)return e.jsx("p",{className:"cogita-library-hint",children:a});if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)});if(Array.isArray(t))return t.length===0?e.jsx("p",{className:"cogita-library-hint",children:"[]"}):e.jsx("div",{className:"cogita-info-tree",children:t.map((s,r)=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r+1}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(rn,{value:s,emptyLabel:a})})]},r))});if(typeof t=="object"){const s=Object.entries(t);return s.length===0?e.jsx("p",{className:"cogita-library-hint",children:a}):e.jsx("div",{className:"cogita-info-tree",children:s.map(([r,i])=>e.jsxs("div",{className:"cogita-info-tree-row",children:[e.jsx("div",{className:"cogita-info-tree-key",children:r}),e.jsx("div",{className:"cogita-info-tree-value",children:e.jsx(rn,{value:i,emptyLabel:a})})]},r))})}return e.jsx("div",{className:"cogita-info-tree-value",children:String(t)})}const Na=5,ks=50,Ns=2,Ss=[];function Xt({libraryId:t,infoType:a,label:s,placeholder:r,value:i,onChange:u,values:o,onChangeMultiple:j,helperText:g,searchFailedText:x,createFailedText:c,createLabel:f,savingLabel:l,loadMoreLabel:d,allowCreate:w=!0,inputRef:m,autoAdvance:S,onCommit:A,multiple:v}){const b=v?o??Ss:Ss,[X,R]=n.useState(v?"":(i==null?void 0:i.label)??""),[k,D]=n.useState([]),[N,ee]=n.useState(Na),[F,M]=n.useState(-1),[H,de]=n.useState(!1),[ke,Je]=n.useState(!1),[ue,$]=n.useState(null),be=n.useRef(0),C=n.useRef(new Map),U=n.useMemo(()=>w?v?X.trim().length>0:X.trim().length>0&&!i:!1,[w,X,i,v]);n.useEffect(()=>{v||R((i==null?void 0:i.label)??"")},[i,v]),n.useEffect(()=>{const J=X.trim();if(!J||J.length<Ns){D([]),de(!1),ee(Na),M(-1),Je(!1),$(null);return}const Y=J.toLowerCase(),ye=`${t}:${a}:${Y}`,Te=C.current.get(ye);if(Te){if(v&&b.length>0){const Me=new Set(b.map(tt=>tt.id));D(Te.filter(tt=>!Me.has(tt.id)))}else D(Te);ee(Na),M(-1),de(Te.length>0),Je(!1),$(null);return}const Re=window.setTimeout(async()=>{const Me=Date.now();be.current=Me,Je(!0),$(null);try{const tt=await ts({libraryId:t,type:a,query:J,limit:ks});if(be.current!==Me)return;const ot=tt.slice(0,ks).map($e=>({id:$e.infoId,label:$e.label,infoType:$e.infoType}));if(C.current.set(ye,ot),v&&b.length>0){const $e=new Set(b.map(Oe=>Oe.id));D(ot.filter(Oe=>!$e.has(Oe.id)))}else D(ot);ee(Na),M(-1),de(!0)}catch{if(be.current!==Me)return;$(x??"Search failed.")}finally{be.current===Me&&Je(!1)}},250);return()=>window.clearTimeout(Re)},[t,a,X,b]);const O=J=>{if(v){const Y=b.some(ye=>ye.id===J.id)?b:[...b,J];j==null||j(Y),R(""),de(!1),M(-1);return}u==null||u(J),R(J.label),de(!1),M(-1),S&&(A==null||A())},K=async()=>{const J=X.trim();if(J){Je(!0),$(null);try{const Y=await Jn({libraryId:t,infoType:a,payload:{label:J}}),ye={id:Y.infoId,label:J,infoType:Y.infoType};if(J.length>=Ns){const Te=`${t}:${a}:${J.toLowerCase()}`,Re=C.current.get(Te)??[];C.current.set(Te,[ye,...Re])}if(v){j==null||j([...b,ye]),R(""),de(!1),M(-1);return}u==null||u(ye),de(!1),M(-1),S&&(A==null||A())}catch{$(c??"Create failed.")}finally{Je(!1)}}};return e.jsxs("div",{className:"cogita-lookup",children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:s}),e.jsx("input",{value:X,placeholder:r,onChange:J=>{R(J.target.value),!v&&i&&(u==null||u(null))},onKeyDown:J=>{if(J.key==="ArrowDown"){if(J.preventDefault(),!k.length)return;de(!0),M(Y=>{const ye=Math.min(k.length,N)-1,Te=Y<0?0:Math.min(Y+1,ye);return Te===ye&&k.length>N?(ee(Re=>Math.min(Re+Na,k.length)),Math.min(Y+1,Math.min(k.length,N+Na)-1)):Te});return}if(J.key==="ArrowUp"){if(J.preventDefault(),!k.length)return;de(!0),M(Y=>Y<=0?0:Y-1);return}if(J.key==="Enter"){if(J.preventDefault(),F>=0&&k[F]){O(k[F]);return}if(U){K();return}}},onFocus:()=>{k.length>0&&de(!0)},autoComplete:"off",ref:m})]}),v&&b.length>0&&e.jsx("div",{className:"cogita-lookup-chips",children:b.map(J=>e.jsxs("button",{type:"button",className:"cogita-lookup-chip",onClick:()=>j==null?void 0:j(b.filter(Y=>Y.id!==J.id)),children:[J.label,e.jsx("span",{"aria-hidden":"true",children:"×"})]},J.id))}),g&&e.jsx("p",{className:"cogita-help",children:g}),ue&&e.jsx("p",{className:"cogita-error",children:ue}),H&&k.length>0&&e.jsxs("div",{className:"cogita-lookup-results",children:[k.slice(0,N).map((J,Y)=>e.jsxs("button",{type:"button",className:"cogita-lookup-option","data-active":Y===F,onClick:()=>O(J),children:[e.jsx("strong",{children:J.label}),e.jsx("span",{children:J.infoType})]},J.id)),N<k.length&&e.jsx("button",{type:"button",className:"cogita-lookup-more",onClick:()=>ee(J=>Math.min(J+Na,k.length)),children:d??"Load more"})]}),U&&e.jsx("button",{type:"button",className:"cogita-lookup-create",onClick:K,disabled:ke,children:ke?l??"Saving...":f??`Create new ${a}`})]})}const Ts=[{id:"gen",la:{abbr:"Gen",name:"Genesis"},en:{abbr:"Gen",name:"Genesis"},de:{abbr:"Gen",name:"Genesis"},pl:{abbr:"Rdz",name:"Księga Rodzaju"}},{id:"ex",la:{abbr:"Ex",name:"Exodus"},en:{abbr:"Ex",name:"Exodus"},de:{abbr:"Ex",name:"Exodus"},pl:{abbr:"Wj",name:"Księga Wyjścia"}},{id:"lev",la:{abbr:"Lev",name:"Leviticus"},en:{abbr:"Lev",name:"Leviticus"},de:{abbr:"Lev",name:"Levitikus"},pl:{abbr:"Kpł",name:"Księga Kapłańska"}},{id:"num",la:{abbr:"Num",name:"Numeri"},en:{abbr:"Num",name:"Numbers"},de:{abbr:"Num",name:"Numeri"},pl:{abbr:"Lb",name:"Księga Liczb"}},{id:"deut",la:{abbr:"Deut",name:"Deuteronomium"},en:{abbr:"Deut",name:"Deuteronomy"},de:{abbr:"Dtn",name:"Deuteronomium"},pl:{abbr:"Pwt",name:"Księga Powtórzonego Prawa"}},{id:"ios",la:{abbr:"Ios",name:"Iosue"},en:{abbr:"Josh",name:"Joshua"},de:{abbr:"Jos",name:"Josua"},pl:{abbr:"Joz",name:"Księga Jozuego"}},{id:"iudg",la:{abbr:"Iudg",name:"Iudicum"},en:{abbr:"Judg",name:"Judges"},de:{abbr:"Ri",name:"Richter"},pl:{abbr:"Sdz",name:"Księga Sędziów"}},{id:"ruth",la:{abbr:"Ruth",name:"Ruth"},en:{abbr:"Ruth",name:"Ruth"},de:{abbr:"Rut",name:"Rut"},pl:{abbr:"Rt",name:"Księga Rut"}},{id:"1sam",la:{abbr:"1 Sam",name:"I Samuelis"},en:{abbr:"1 Sam",name:"1 Samuel"},de:{abbr:"1 Sam",name:"1 Samuel"},pl:{abbr:"1 Sm",name:"1 Księga Samuela"}},{id:"2sam",la:{abbr:"2 Sam",name:"II Samuelis"},en:{abbr:"2 Sam",name:"2 Samuel"},de:{abbr:"2 Sam",name:"2 Samuel"},pl:{abbr:"2 Sm",name:"2 Księga Samuela"}},{id:"1reg",la:{abbr:"1 Reg",name:"I Regum"},en:{abbr:"1 Kgs",name:"1 Kings"},de:{abbr:"1 Kön",name:"1 Könige"},pl:{abbr:"1 Krl",name:"1 Księga Królewska"}},{id:"2reg",la:{abbr:"2 Reg",name:"II Regum"},en:{abbr:"2 Kgs",name:"2 Kings"},de:{abbr:"2 Kön",name:"2 Könige"},pl:{abbr:"2 Krl",name:"2 Księga Królewska"}},{id:"1par",la:{abbr:"1 Par",name:"I Paralipomenon"},en:{abbr:"1 Chr",name:"1 Chronicles"},de:{abbr:"1 Chr",name:"1 Chronik"},pl:{abbr:"1 Krn",name:"1 Księga Kronik"}},{id:"2par",la:{abbr:"2 Par",name:"II Paralipomenon"},en:{abbr:"2 Chr",name:"2 Chronicles"},de:{abbr:"2 Chr",name:"2 Chronik"},pl:{abbr:"2 Krn",name:"2 Księga Kronik"}},{id:"esd",la:{abbr:"Esd",name:"Esdrae"},en:{abbr:"Ezra",name:"Ezra"},de:{abbr:"Esra",name:"Esra"},pl:{abbr:"Ezd",name:"Księga Ezdrasza"}},{id:"neh",la:{abbr:"Neh",name:"Nehemiae"},en:{abbr:"Neh",name:"Nehemiah"},de:{abbr:"Neh",name:"Nehemia"},pl:{abbr:"Ne",name:"Księga Nehemiasza"}},{id:"tob",la:{abbr:"Tob",name:"Tobiae"},en:{abbr:"Tob",name:"Tobit"},de:{abbr:"Tob",name:"Tobit"},pl:{abbr:"Tb",name:"Księga Tobiasza"}},{id:"iudt",la:{abbr:"Iudt",name:"Iudith"},en:{abbr:"Jdt",name:"Judith"},de:{abbr:"Jdt",name:"Judit"},pl:{abbr:"Jdt",name:"Księga Judyty"}},{id:"est",la:{abbr:"Est",name:"Esther"},en:{abbr:"Est",name:"Esther"},de:{abbr:"Est",name:"Ester"},pl:{abbr:"Est",name:"Księga Estery"}},{id:"1macc",la:{abbr:"1 Macc",name:"I Maccabaeorum"},en:{abbr:"1 Mc",name:"1 Maccabees"},de:{abbr:"1 Makk",name:"1 Makkabäer"},pl:{abbr:"1 Mch",name:"1 Księga Machabejska"}},{id:"2macc",la:{abbr:"2 Macc",name:"II Maccabaeorum"},en:{abbr:"2 Mc",name:"2 Maccabees"},de:{abbr:"2 Makk",name:"2 Makkabäer"},pl:{abbr:"2 Mch",name:"2 Księga Machabejska"}},{id:"iob",la:{abbr:"Iob",name:"Iob"},en:{abbr:"Job",name:"Job"},de:{abbr:"Ijob",name:"Ijob"},pl:{abbr:"Hi",name:"Księga Hioba"}},{id:"ps",la:{abbr:"Ps",name:"Psalmi"},en:{abbr:"Ps",name:"Psalms"},de:{abbr:"Ps",name:"Psalmen"},pl:{abbr:"Ps",name:"Księga Psalmów"}},{id:"prov",la:{abbr:"Prov",name:"Proverbia"},en:{abbr:"Prov",name:"Proverbs"},de:{abbr:"Spr",name:"Sprichwörter"},pl:{abbr:"Prz",name:"Księga Przysłów"}},{id:"ecc",la:{abbr:"Ecc",name:"Ecclesiastes"},en:{abbr:"Eccl",name:"Ecclesiastes"},de:{abbr:"Koh",name:"Kohelet"},pl:{abbr:"Koh",name:"Księga Koheleta"}},{id:"cant",la:{abbr:"Cant",name:"Canticum Canticorum"},en:{abbr:"Song",name:"Song of Songs"},de:{abbr:"Hld",name:"Hoheslied"},pl:{abbr:"Pnp",name:"Pieśń nad Pieśniami"}},{id:"sap",la:{abbr:"Sap",name:"Sapientia"},en:{abbr:"Wis",name:"Wisdom"},de:{abbr:"Weish",name:"Weisheit"},pl:{abbr:"Mdr",name:"Księga Mądrości"}},{id:"sir",la:{abbr:"Sir",name:"Ecclesiasticus (Sirach)"},en:{abbr:"Sir",name:"Sirach"},de:{abbr:"Sir",name:"Jesus Sirach"},pl:{abbr:"Syr",name:"Mądrość Syracha"}},{id:"isa",la:{abbr:"Isa",name:"Isaias"},en:{abbr:"Isa",name:"Isaiah"},de:{abbr:"Jes",name:"Jesaja"},pl:{abbr:"Iz",name:"Księga Izajasza"}},{id:"ier",la:{abbr:"Ier",name:"Ieremias"},en:{abbr:"Jer",name:"Jeremiah"},de:{abbr:"Jer",name:"Jeremia"},pl:{abbr:"Jr",name:"Księga Jeremiasza"}},{id:"lam",la:{abbr:"Lam",name:"Lamentationes"},en:{abbr:"Lam",name:"Lamentations"},de:{abbr:"Klgl",name:"Klagelieder"},pl:{abbr:"Lm",name:"Lamentacje"}},{id:"bar",la:{abbr:"Bar",name:"Baruch"},en:{abbr:"Bar",name:"Baruch"},de:{abbr:"Bar",name:"Baruch"},pl:{abbr:"Ba",name:"Księga Barucha"}},{id:"ez",la:{abbr:"Ez",name:"Ezechiel"},en:{abbr:"Ezek",name:"Ezekiel"},de:{abbr:"Ez",name:"Ezechiel"},pl:{abbr:"Ez",name:"Księga Ezechiela"}},{id:"dan",la:{abbr:"Dan",name:"Daniel"},en:{abbr:"Dan",name:"Daniel"},de:{abbr:"Dan",name:"Daniel"},pl:{abbr:"Dn",name:"Księga Daniela"}},{id:"hos",la:{abbr:"Hos",name:"Osee"},en:{abbr:"Hos",name:"Hosea"},de:{abbr:"Hos",name:"Hosea"},pl:{abbr:"Oz",name:"Księga Ozeasza"}},{id:"ioel",la:{abbr:"Ioel",name:"Ioel"},en:{abbr:"Joel",name:"Joel"},de:{abbr:"Joel",name:"Joel"},pl:{abbr:"Jl",name:"Księga Joela"}},{id:"amos",la:{abbr:"Amos",name:"Amos"},en:{abbr:"Am",name:"Amos"},de:{abbr:"Am",name:"Amos"},pl:{abbr:"Am",name:"Księga Amosa"}},{id:"abd",la:{abbr:"Abd",name:"Abdias"},en:{abbr:"Obad",name:"Obadiah"},de:{abbr:"Obd",name:"Obadja"},pl:{abbr:"Abd",name:"Księga Abdiasza"}},{id:"ion",la:{abbr:"Ion",name:"Ionas"},en:{abbr:"Jon",name:"Jonah"},de:{abbr:"Jona",name:"Jona"},pl:{abbr:"Jon",name:"Księga Jonasza"}},{id:"mich",la:{abbr:"Mich",name:"Michaeas"},en:{abbr:"Mic",name:"Micah"},de:{abbr:"Mi",name:"Micha"},pl:{abbr:"Mi",name:"Księga Micheasza"}},{id:"nah",la:{abbr:"Nah",name:"Nahum"},en:{abbr:"Nah",name:"Nahum"},de:{abbr:"Nah",name:"Nahum"},pl:{abbr:"Na",name:"Księga Nahuma"}},{id:"hab",la:{abbr:"Hab",name:"Habacuc"},en:{abbr:"Hab",name:"Habakkuk"},de:{abbr:"Hab",name:"Habakuk"},pl:{abbr:"Ha",name:"Księga Habakuka"}},{id:"soph",la:{abbr:"Soph",name:"Sophonias"},en:{abbr:"Zeph",name:"Zephaniah"},de:{abbr:"Zef",name:"Zefanja"},pl:{abbr:"So",name:"Księga Sofoniasza"}},{id:"agg",la:{abbr:"Agg",name:"Aggaeus"},en:{abbr:"Hag",name:"Haggai"},de:{abbr:"Hag",name:"Haggai"},pl:{abbr:"Ag",name:"Księga Aggeusza"}},{id:"zach",la:{abbr:"Zach",name:"Zacharias"},en:{abbr:"Zech",name:"Zechariah"},de:{abbr:"Sach",name:"Sacharja"},pl:{abbr:"Za",name:"Księga Zachariasza"}},{id:"mal",la:{abbr:"Mal",name:"Malachias"},en:{abbr:"Mal",name:"Malachi"},de:{abbr:"Mal",name:"Maleachi"},pl:{abbr:"Ml",name:"Księga Malachiasza"}},{id:"mt",la:{abbr:"Mt",name:"Matthaeus"},en:{abbr:"Matt",name:"Matthew"},de:{abbr:"Mt",name:"Matthäus"},pl:{abbr:"Mt",name:"Ewangelia wg św. Mateusza"}},{id:"mc",la:{abbr:"Mc",name:"Marcus"},en:{abbr:"Mark",name:"Mark"},de:{abbr:"Mk",name:"Markus"},pl:{abbr:"Mk",name:"Ewangelia wg św. Marka"}},{id:"lc",la:{abbr:"Lc",name:"Lucas"},en:{abbr:"Luke",name:"Luke"},de:{abbr:"Lk",name:"Lukas"},pl:{abbr:"Łk",name:"Ewangelia wg św. Łukasza"}},{id:"io",la:{abbr:"Io",name:"Ioannes"},en:{abbr:"John",name:"John"},de:{abbr:"Joh",name:"Johannes"},pl:{abbr:"J",name:"Ewangelia wg św. Jana"}},{id:"act",la:{abbr:"Act",name:"Actus Apostolorum"},en:{abbr:"Acts",name:"Acts"},de:{abbr:"Apg",name:"Apostelgeschichte"},pl:{abbr:"Dz",name:"Dzieje Apostolskie"}},{id:"rom",la:{abbr:"Rom",name:"ad Romanos"},en:{abbr:"Rom",name:"Romans"},de:{abbr:"Röm",name:"Römer"},pl:{abbr:"Rz",name:"List do Rzymian"}},{id:"1cor",la:{abbr:"1 Cor",name:"I ad Corinthios"},en:{abbr:"1 Cor",name:"1 Corinthians"},de:{abbr:"1 Kor",name:"1 Korinther"},pl:{abbr:"1 Kor",name:"1 List do Koryntian"}},{id:"2cor",la:{abbr:"2 Cor",name:"II ad Corinthios"},en:{abbr:"2 Cor",name:"2 Corinthians"},de:{abbr:"2 Kor",name:"2 Korinther"},pl:{abbr:"2 Kor",name:"2 List do Koryntian"}},{id:"gal",la:{abbr:"Gal",name:"ad Galatas"},en:{abbr:"Gal",name:"Galatians"},de:{abbr:"Gal",name:"Galater"},pl:{abbr:"Ga",name:"List do Galatów"}},{id:"eph",la:{abbr:"Eph",name:"ad Ephesios"},en:{abbr:"Eph",name:"Ephesians"},de:{abbr:"Eph",name:"Epheser"},pl:{abbr:"Ef",name:"List do Efezjan"}},{id:"phil",la:{abbr:"Phil",name:"ad Philippenses"},en:{abbr:"Phil",name:"Philippians"},de:{abbr:"Phil",name:"Philipper"},pl:{abbr:"Flp",name:"List do Filipian"}},{id:"col",la:{abbr:"Col",name:"ad Colossenses"},en:{abbr:"Col",name:"Colossians"},de:{abbr:"Kol",name:"Kolosser"},pl:{abbr:"Kol",name:"List do Kolosan"}},{id:"1thess",la:{abbr:"1 Thess",name:"I ad Thessalonicenses"},en:{abbr:"1 Thess",name:"1 Thessalonians"},de:{abbr:"1 Thess",name:"1 Thessalonicher"},pl:{abbr:"1 Tes",name:"1 List do Tesaloniczan"}},{id:"2thess",la:{abbr:"2 Thess",name:"II ad Thessalonicenses"},en:{abbr:"2 Thess",name:"2 Thessalonians"},de:{abbr:"2 Thess",name:"2 Thessalonicher"},pl:{abbr:"2 Tes",name:"2 List do Tesaloniczan"}},{id:"1tim",la:{abbr:"1 Tim",name:"I ad Timotheum"},en:{abbr:"1 Tim",name:"1 Timothy"},de:{abbr:"1 Tim",name:"1 Timotheus"},pl:{abbr:"1 Tm",name:"1 List do Tymoteusza"}},{id:"2tim",la:{abbr:"2 Tim",name:"II ad Timotheum"},en:{abbr:"2 Tim",name:"2 Timothy"},de:{abbr:"2 Tim",name:"2 Timotheus"},pl:{abbr:"2 Tm",name:"2 List do Tymoteusza"}},{id:"tit",la:{abbr:"Tit",name:"ad Titum"},en:{abbr:"Titus",name:"Titus"},de:{abbr:"Tit",name:"Titus"},pl:{abbr:"Tt",name:"List do Tytusa"}},{id:"phlm",la:{abbr:"Phlm",name:"ad Philemonem"},en:{abbr:"Phlm",name:"Philemon"},de:{abbr:"Phlm",name:"Philemon"},pl:{abbr:"Flm",name:"List do Filemona"}},{id:"heb",la:{abbr:"Heb",name:"ad Hebraeos"},en:{abbr:"Heb",name:"Hebrews"},de:{abbr:"Hebr",name:"Hebräer"},pl:{abbr:"Hbr",name:"List do Hebrajczyków"}},{id:"iac",la:{abbr:"Iac",name:"Iacobi"},en:{abbr:"Jas",name:"James"},de:{abbr:"Jak",name:"Jakobus"},pl:{abbr:"Jk",name:"List św. Jakuba"}},{id:"1pet",la:{abbr:"1 Pet",name:"I Petri"},en:{abbr:"1 Pet",name:"1 Peter"},de:{abbr:"1 Petr",name:"1 Petrus"},pl:{abbr:"1 P",name:"1 List św. Piotra"}},{id:"2pet",la:{abbr:"2 Pet",name:"II Petri"},en:{abbr:"2 Pet",name:"2 Peter"},de:{abbr:"2 Petr",name:"2 Petrus"},pl:{abbr:"2 P",name:"2 List św. Piotra"}},{id:"1io",la:{abbr:"1 Io",name:"I Ioannis"},en:{abbr:"1 John",name:"1 John"},de:{abbr:"1 Joh",name:"1 Johannes"},pl:{abbr:"1 J",name:"1 List św. Jana"}},{id:"2io",la:{abbr:"2 Io",name:"II Ioannis"},en:{abbr:"2 John",name:"2 John"},de:{abbr:"2 Joh",name:"2 Johannes"},pl:{abbr:"2 J",name:"2 List św. Jana"}},{id:"3io",la:{abbr:"3 Io",name:"III Ioannis"},en:{abbr:"3 John",name:"3 John"},de:{abbr:"3 Joh",name:"3 Johannes"},pl:{abbr:"3 J",name:"3 List św. Jana"}},{id:"iud",la:{abbr:"Iud",name:"Iudae"},en:{abbr:"Jude",name:"Jude"},de:{abbr:"Jud",name:"Judas"},pl:{abbr:"Jud",name:"List św. Judy"}},{id:"apoc",la:{abbr:"Apoc",name:"Apocalypsis Ioannis"},en:{abbr:"Rev",name:"Revelation"},de:{abbr:"Offb",name:"Offenbarung"},pl:{abbr:"Ap",name:"Apokalipsa św. Jana"}}],Cs=8;function Is({libraryId:t,copy:a,language:s,sourceKindOptions:r,value:i,onChange:u,labels:o}){const[j,g]=n.useState(!1),[x,c]=n.useState(-1),f=n.useMemo(()=>{const m=s;return Ts.map(S=>{var b;const A=(S==null?void 0:S[m])??(S==null?void 0:S.en)??(S==null?void 0:S.la);return{label:`${A.abbr} — ${A.name}`,latin:((b=S==null?void 0:S.la)==null?void 0:b.abbr)??A.abbr}})},[s]),l=(m,S=!1)=>{const A=m.trim().toLowerCase();return A?f.filter(v=>v.label.toLowerCase().includes(A)).slice(0,Cs):S?f.slice(0,Cs):[]},d=(m,S)=>{const A=m.trim().toLowerCase();if(!A)return null;const v=Ts;for(const b of v){const X=b==null?void 0:b.la,R=(b==null?void 0:b[S])??(b==null?void 0:b.en)??X,k=(R==null?void 0:R.abbr)??"",D=(R==null?void 0:R.name)??"";if(k.toLowerCase()===A||D.toLowerCase()===A||`${k} — ${D}`.toLowerCase()===A)return{book:b,entry:R,la:X}}return null};n.useEffect(()=>{if(i.sourceKind==="bible"&&i.locatorValue&&!j){const m=d(i.locatorValue,s);if(m){const S=`${m.entry.abbr} — ${m.entry.name}`;S!==i.bibleBookDisplay&&u({...i,bibleBookDisplay:S})}}},[s,i,j,u]);const w=m=>u({...i,...m});return e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.sourceKindLabel}),e.jsx("select",{value:i.sourceKind,onChange:m=>w({sourceKind:m.target.value,churchDocument:null,bookMedia:null,work:null,locatorValue:"",locatorAux:"",bibleBookDisplay:""}),children:r.map(m=>e.jsx("option",{value:m.value,children:m.label},m.value))})]}),i.sourceKind==="bible"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-lookup full",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.bibleBookLabel}),e.jsx("input",{type:"text",value:i.bibleBookDisplay,onChange:m=>{const S=m.target.value;w({bibleBookDisplay:S,locatorValue:""}),g(!0),c(-1)},onKeyDown:m=>{var A;const S=l(i.bibleBookDisplay);if(S.length){if(m.key==="ArrowDown")m.preventDefault(),c(v=>Math.min(v+1,S.length-1));else if(m.key==="ArrowUp")m.preventDefault(),c(v=>Math.max(v-1,0));else if((m.key==="Enter"||m.key==="Tab")&&x>=0&&S[x]){const v=S[x],b=d(v.label,s);if(!b)return;w({bibleBookDisplay:v.label,locatorValue:((A=b.la)==null?void 0:A.abbr)??i.locatorValue}),g(!1)}}},onFocus:()=>g(!0),onBlur:()=>window.setTimeout(()=>g(!1),100),placeholder:o.bibleBookPlaceholder})]}),j&&l(i.bibleBookDisplay,!0).length>0&&e.jsx("div",{className:"cogita-lookup-results",children:l(i.bibleBookDisplay,!0).map((m,S)=>e.jsx("button",{type:"button",className:"cogita-lookup-option","data-active":S===x,tabIndex:-1,onMouseDown:()=>{var v;const A=d(m.label,s);A&&w({bibleBookDisplay:m.label,locatorValue:((v=A.la)==null?void 0:v.abbr)??i.locatorValue})},children:e.jsx("strong",{children:m.label})},m.latin))})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.bibleRestLabel}),e.jsx("input",{type:"text",value:i.locatorAux,onChange:m=>w({locatorAux:m.target.value}),placeholder:o.bibleRestPlaceholder})]})]}),i.sourceKind==="website"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:a.cogita.library.add.info.sourceUrlLabel}),e.jsx("input",{type:"text",value:i.sourceUrl,onChange:m=>w({sourceUrl:m.target.value}),placeholder:a.cogita.library.add.info.sourceUrlPlaceholder})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:a.cogita.library.add.info.sourceAccessedDateLabel}),e.jsx("input",{type:"text",value:i.sourceAccessedDate,onChange:m=>w({sourceAccessedDate:m.target.value}),placeholder:a.cogita.library.add.info.sourceAccessedDatePlaceholder})]})]}),i.sourceKind==="number_document"&&e.jsxs(e.Fragment,{children:[e.jsx(Xt,{libraryId:t,infoType:"work",label:o.churchDocumentLabel,placeholder:o.churchDocumentPlaceholder,value:i.churchDocument,onChange:m=>w({churchDocument:m}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.work),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:m=>w({locatorValue:m.target.value}),placeholder:o.locatorPlaceholder})]})]}),i.sourceKind==="work"&&e.jsx(Xt,{libraryId:t,infoType:"work",label:o.workLabel,placeholder:o.workPlaceholder,value:i.work,onChange:m=>w({work:m}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.work),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),i.sourceKind==="book"&&e.jsxs(e.Fragment,{children:[e.jsx(Xt,{libraryId:t,infoType:"media",label:o.bookLabel,placeholder:o.bookPlaceholder,value:i.bookMedia,onChange:m=>w({bookMedia:m}),searchFailedText:a.cogita.library.lookup.searchFailed,createFailedText:a.cogita.library.lookup.createFailed,createLabel:a.cogita.library.lookup.createNew.replace("{type}",a.cogita.library.infoTypes.media),savingLabel:a.cogita.library.lookup.saving,loadMoreLabel:a.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:m=>w({locatorValue:m.target.value}),placeholder:o.locatorPlaceholder})]})]}),i.sourceKind!=="website"&&i.sourceKind!=="bible"&&i.sourceKind!=="book"&&i.sourceKind!=="number_document"&&e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:o.locatorLabel}),e.jsx("input",{type:"text",value:i.locatorValue,onChange:m=>w({locatorValue:m.target.value}),placeholder:o.locatorPlaceholder})]})]})}const Ba=JSON.stringify({type:"selection",title:"Question title",question:"Question text",options:["Option A","Option B","Option C"],answer:[0]},null,2);function Za(t="selection"){return t==="matching"?{type:t,title:"",question:"",columns:[[""],[""]],answer:{paths:[]},matchingPaths:[["",""]]}:t==="ordering"?{type:t,title:"",question:"",options:[""]}:t==="truefalse"?{type:t,title:"",question:"",answer:!0}:t==="text"||t==="date"?{type:t,title:"",question:"",answer:""}:t==="number"?{type:t,title:"",question:"",answer:""}:{type:t,title:"",question:"",options:[""],answer:[]}}function Ii(t){return["selection","truefalse","text","number","date","matching","ordering"].includes(t)}function Aa(t){if(!t||typeof t!="object")return null;const a=t,s=typeof a.type=="string"?a.type:typeof a.kind=="string"?a.kind:"selection",r=s==="multi_select"||s==="single_select"?"selection":s==="boolean"?"truefalse":s==="order"?"ordering":s==="short"||s==="open"||s==="short_text"?"text":s,i=Ii(r)?r:"selection",u=typeof a.title=="string"?a.title:"",o=typeof a.question=="string"?a.question:"";if(i==="matching"){let x=[];Array.isArray(a.columns)?x=a.columns.map(m=>Array.isArray(m)?m.map(S=>typeof S=="string"?S:""):[""]):Array.isArray(a.left)&&Array.isArray(a.right)&&(x=[a.left.map(m=>typeof m=="string"?m:""),a.right.map(m=>typeof m=="string"?m:"")]),x.length<2&&(x=[[""],[""]]);const c=a.answer&&typeof a.answer=="object"?a.answer:null,l=(Array.isArray(c==null?void 0:c.paths)?c==null?void 0:c.paths:Array.isArray(a.correctPairs)?a.correctPairs:[]).map(m=>Array.isArray(m)?m.map(S=>Number(S)).filter(S=>Number.isInteger(S)&&S>=0):[]).filter(m=>m.length>0),d=Array.isArray(a.matchingPaths)?a.matchingPaths.map(m=>Array.isArray(m)?Array.from({length:x.length},(S,A)=>String(m[A]??"")):new Array(x.length).fill("")):null,w=d&&d.length>0?d:[...l.map(m=>m.map(String)),new Array(x.length).fill("")];return{type:i,title:u,question:o,columns:x,answer:{paths:l},matchingPaths:w}}if(i==="ordering"){const x=Array.isArray(a.options)?a.options.map(c=>typeof c=="string"?c:""):Array.isArray(a.items)?a.items.map(c=>typeof c=="string"?c:""):[""];return{type:i,title:u,question:o,options:x.length?x:[""]}}if(i==="truefalse"){const x=typeof a.answer=="boolean"?a.answer:typeof a.expected=="boolean"?a.expected:!0;return{type:i,title:u,question:o,answer:x}}if(i==="number")return typeof a.answer=="number"?{type:i,title:u,question:o,answer:a.answer}:typeof a.answer=="string"?{type:i,title:u,question:o,answer:a.answer}:typeof a.expected=="number"?{type:i,title:u,question:o,answer:a.expected}:{type:i,title:u,question:o,answer:""};if(i==="text"||i==="date"){const x=typeof a.answer=="string"?a.answer:typeof a.expected=="string"?a.expected:"";return{type:i,title:u,question:o,answer:x}}const j=Array.isArray(a.options)?a.options.map(x=>typeof x=="string"?x:""):[""],g=Array.isArray(a.answer)?a.answer.map(x=>Number(x)).filter(x=>Number.isInteger(x)&&x>=0):Array.isArray(a.correct)?a.correct.map(x=>Number(x)).filter(x=>Number.isInteger(x)&&x>=0):[];return{type:i,title:u,question:o,options:j.length?j:[""],answer:g}}function Rn(t){const a=(t.title??"").trim(),s=(t.question??"").trim();switch(t.type){case"matching":{const r=(t.columns??[[""],[""]]).map(f=>f.map(l=>l.trim()).filter(Boolean)).filter(f=>f.length>0),i=r.length>=2?r:[[""],[""]],u=t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[],o=(t.matchingPaths??[]).map(f=>f.map(l=>String(l??""))),j=i.length,g=o.map(f=>f.slice(0,j).map(l=>l.trim())).filter(f=>f.some(Boolean)).map(f=>f.map(l=>Number(l))).filter(f=>f.length===j&&f.every(l=>Number.isInteger(l)&&l>=0)),x=(Array.isArray(u)?u:[]).map(f=>Array.isArray(f)?f.map(l=>Number(l)).filter(l=>Number.isInteger(l)&&l>=0):[]).filter(f=>f.length===j),c=Array.from(new Set([...x,...g].map(f=>JSON.stringify(f)))).map(f=>JSON.parse(f));return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,columns:i,answer:{paths:c}},null,2)}case"ordering":{const r=(t.options??[]).map(i=>i.trim()).filter(Boolean);return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,options:r},null,2)}case"truefalse":return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,answer:!!t.answer},null,2);case"number":return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,answer:typeof t.answer=="number"||typeof t.answer=="string"?t.answer:""},null,2);case"date":case"text":return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,answer:String(t.answer??"")},null,2);case"selection":default:{const r=(t.options??[]).map(o=>o.trim()).filter(Boolean),i=Array.isArray(t.answer)?t.answer:[],u=Array.from(new Set(i.filter(o=>Number.isInteger(o)&&o>=0&&o<r.length))).sort((o,j)=>o-j);return JSON.stringify({type:t.type,...a?{title:a}:{},question:s,options:r,answer:u},null,2)}}}const Ls=[{value:"string",label:"string"},{value:"book",label:"book"},{value:"website",label:"website"},{value:"bible",label:"bible"},{value:"number_document",label:"number_document"},{value:"work",label:"work"},{value:"other",label:"other"}];function Oa(){return{sourceKind:"string",locatorValue:"",locatorAux:"",bibleBookDisplay:"",sourceUrl:"",sourceAccessedDate:"",churchDocument:null,bookMedia:null,work:null}}function Ms(t){return t==null?"":typeof t=="string"?t:JSON.stringify(t)}function As(t,a){if(!t||typeof t!="object")return a;const s=t,r=s.definition&&typeof s.definition=="object"?s.definition:null,i=[s.label,s.name,s.title,s.text,s.orcid,s.email,s.number];r&&i.unshift(r.title,r.question);for(const u of i)if(typeof u=="string"&&u.trim())return u.trim();return a}function Rs(t,a){var r;if(!(t instanceof as))return a;const s=(r=t.message)==null?void 0:r.trim();if(!s)return a;try{const i=JSON.parse(s);if(typeof i.error=="string"&&i.error.trim())return i.error.trim()}catch{}return s}function Li(t){const a=t.trim();if(!a)return null;try{const s=JSON.parse(a);return s&&typeof s=="object"&&!Array.isArray(s)?s:null}catch{return null}}function ia(t,a){const s=t==null?void 0:t[a];return typeof s=="string"?s:""}function Mi(t,a){return a?t==="book"&&a.infoType==="media"?{bookMedia:a}:t==="work"&&a.infoType==="work"?{work:a}:t==="number_document"&&a.infoType==="work"?{churchDocument:a}:{}:{}}function Ai(t,a){const s=Oa(),r=(t.sourceKind??"").trim()||s.sourceKind,i=t.locator??"",u=Li(i);let o="",j="",g="",x="",c="";return r==="website"?(x=ia(u,"url"),c=ia(u,"accessedDate"),o=ia(u,"value")):r==="bible"?(o=ia(u,"book")||i.trim(),j=ia(u,"passage")||ia(u,"rest"),g=ia(u,"bookDisplay")):u?(o=ia(u,"value")||ia(u,"locator"),j=ia(u,"aux")):o=i,{...s,sourceKind:r,locatorValue:o,locatorAux:j,bibleBookDisplay:g,sourceUrl:x,sourceAccessedDate:c,...Mi(r,a)}}function $n(t){return t.sourceKind==="book"?t.bookMedia:t.sourceKind==="work"?t.work:t.sourceKind==="number_document"?t.churchDocument:null}function Pn(t){const a=t.locatorValue.trim(),s=t.locatorAux.trim(),r=t.sourceUrl.trim(),i=t.sourceAccessedDate.trim();switch(t.sourceKind){case"website":return{url:r,accessedDate:i};case"bible":return{book:a,bookDisplay:t.bibleBookDisplay.trim(),passage:s};case"book":case"work":case"number_document":return s?{value:a,aux:s}:a;default:return s?{value:a,aux:s}:a}}function $s(t){var i,u,o;const a=t.locatorValue.trim(),s=t.locatorAux.trim(),r=[a,s].filter(Boolean).join(" ");switch(t.sourceKind){case"website":return t.sourceUrl.trim()||"website";case"bible":return r||"bible";case"book":return[(i=t.bookMedia)==null?void 0:i.label,r].filter(Boolean).join(" · ")||"book";case"work":return[(u=t.work)==null?void 0:u.label,r].filter(Boolean).join(" · ")||"work";case"number_document":return[(o=t.churchDocument)==null?void 0:o.label,r].filter(Boolean).join(" · ")||"number_document";default:return r||t.sourceKind||"source"}}function Ps(t){return t.sourceKind.trim()?t.sourceKind==="website"?!!t.sourceUrl.trim():t.sourceKind==="bible"?!!(t.locatorValue.trim()&&t.locatorAux.trim()):t.sourceKind==="book"?!!t.bookMedia:t.sourceKind==="work"?!!t.work:t.sourceKind==="number_document"?!!(t.churchDocument&&t.locatorValue.trim()):!!t.locatorValue.trim():!1}function Ri({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,libraryId:c,editInfoId:f}){var B,te,pe;const{libraryName:l}=ua(c),d=!!f,[w,m]=n.useState([]),[S,A]=n.useState("word"),[v,b]=n.useState({}),[X,R]=n.useState({}),[k,D]=n.useState({}),[N,ee]=n.useState({}),[F,M]=n.useState(null),[H,de]=n.useState("idle"),[ke,Je]=n.useState(Oa),[ue,$]=n.useState({}),[be,C]=n.useState({}),[U,O]=n.useState({}),[K,J]=n.useState(null),[Y,ye]=n.useState(()=>Aa(JSON.parse(Ba))??Za()),[Te,Re]=n.useState(Ba),[Me,tt]=n.useState([]),[ot,$e]=n.useState(0),Oe=n.useMemo(()=>w.find(p=>p.infoType===S),[S,w]),kt=n.useMemo(()=>w.find(p=>p.infoType==="source"),[w]),We=n.useMemo(()=>w.map(p=>({value:p.infoType,label:it(t,p.infoType)})),[t,w]),Ae=p=>{const T=Aa(p)??Za(),P=Rn(T);ye(T),b(V=>({...V,definition:P}))};n.useEffect(()=>{let p=!1;return Sr({libraryId:c}).then(T=>{var P;if(!p&&(m(T),!d)){const V=(P=T[0])==null?void 0:P.infoType;V&&A(V)}}).catch(()=>{p||m([])}),()=>{p=!0}},[d,c]),n.useEffect(()=>{if(d||!Oe)return;const p={},T={},P={},V={};for(const Z of Oe.payloadFields)Oe.infoType==="question"&&Z.key==="definition"&&Z.inputType==="json"?p[Z.key]=Ba:p[Z.key]="";for(const Z of Oe.linkFields)Z.multiple?P[Z.key]=[]:T[Z.key]=null,Z.targetTypes.length>0&&(V[Z.key]=Z.targetTypes[0]);b(p),R(T),D(P),ee(V)},[Oe==null?void 0:Oe.infoType,d]),n.useEffect(()=>{if(S!=="question")return;const p=v.definition??"";if(!p.trim()){const T=Aa(JSON.parse(Ba))??Za();ye(T),Re(Ba);return}try{const T=JSON.parse(p),P=Aa(T);if(!P)return;ye(P),Me.length===0&&Re(JSON.stringify(T,null,2))}catch{}},[v.definition,Me.length,S]),n.useEffect(()=>{if(!d||!f||w.length===0)return;let p=!1;return de("loading"),M(null),(async()=>{const P=await aa({libraryId:c,infoId:f});if(p)return;const V=P.infoType;A(V);const Z=w.find(ge=>ge.infoType===V);if(!Z){de("idle");return}const fe=P.payload??{},W={};for(const ge of Z.payloadFields)W[ge.key]=Ms(fe[ge.key]);b(W);const L=P.links??{}??{},we={},ne={},G={},Q=[];for(const ge of Z.linkFields){ge.targetTypes.length>0&&(G[ge.key]=ge.targetTypes[0]);const oe=L[ge.key];if(ge.multiple){const le=Array.isArray(oe)?oe.filter(Ce=>typeof Ce=="string"):[];ne[ge.key]=[];for(const Ce of le)Q.push(aa({libraryId:c,infoId:Ce}).then(ze=>{if(p)return;const Ke={id:Ce,infoType:ze.infoType,label:As(ze.payload,Ce)};G[ge.key]=Ke.infoType,ne[ge.key]=[...ne[ge.key],Ke]}).catch(()=>{}))}else{const le=typeof oe=="string"?oe:null;we[ge.key]=null,le&&Q.push(aa({libraryId:c,infoId:le}).then(Ce=>{if(p)return;const ze={id:le,infoType:Ce.infoType,label:As(Ce.payload,le)};G[ge.key]=ze.infoType,we[ge.key]=ze}).catch(()=>{}))}}await Promise.all(Q),!p&&(R(we),D(ne),ee(G),de("idle"))})().catch(()=>{p||(M("Failed to load info details."),de("idle"))}),()=>{p=!0}},[f,d,c,w]),n.useEffect(()=>{S==="source"&&Je(Ai(v,X.resource??null))},[S,v.sourceKind,v.locator,(B=X.resource)==null?void 0:B.id,(te=X.resource)==null?void 0:te.infoType,(pe=X.resource)==null?void 0:pe.label]);const rt=p=>{var Z,fe;const T=((Z=kt==null?void 0:kt.payloadFields.find(W=>W.key==="sourceKind"))==null?void 0:Z.keepOnCreate)??!1,P=((fe=kt==null?void 0:kt.linkFields.find(W=>W.key==="resource"))==null?void 0:fe.keepOnCreate)??!1,V=Oa();return V.sourceKind=T?p.sourceKind:V.sourceKind,P&&(V.work=p.work,V.bookMedia=p.bookMedia,V.churchDocument=p.churchDocument),T&&p.sourceKind==="bible"&&(V.locatorValue=p.locatorValue,V.bibleBookDisplay=p.bibleBookDisplay),T&&p.sourceKind==="website"&&(V.sourceUrl=p.sourceUrl,V.sourceAccessedDate=p.sourceAccessedDate),V},gt=n.useMemo(()=>({sourceKindLabel:t.cogita.library.add.info.sourceKindLabel,bibleBookLabel:t.cogita.library.add.info.sourceBibleBookLabel,bibleBookPlaceholder:t.cogita.library.add.info.sourceBibleBookPlaceholder,bibleRestLabel:t.cogita.library.add.info.sourceBibleRestLabel,bibleRestPlaceholder:t.cogita.library.add.info.sourceBibleRestPlaceholder,churchDocumentLabel:t.cogita.library.add.info.sourceResourceLabel,churchDocumentPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,workLabel:t.cogita.library.add.info.sourceResourceLabel,workPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,bookLabel:t.cogita.library.add.info.sourceResourceLabel,bookPlaceholder:t.cogita.library.add.info.sourceResourcePlaceholder,locatorLabel:t.cogita.library.list.typeFilterLocator,locatorPlaceholder:t.cogita.library.list.typeFilterLocator}),[t]),at=async p=>{const T=be[p]??Oa();if(!Ps(T)){O(P=>({...P,[p]:t.cogita.library.add.info.referenceMissingSource}));return}J(p),O(P=>({...P,[p]:null}));try{const P=$n(T),V=P?{resource:P.id}:{},Z={label:$s(T),sourceKind:T.sourceKind.trim(),locator:Pn(T)},W={id:(await Jn({libraryId:c,infoType:"source",payload:Z,links:V})).infoId,infoType:"source",label:Z.label};if(D(L=>{const we=L[p]??[];return we.some(ne=>ne.id===W.id)?L:{...L,[p]:[...we,W]}}),d&&f){const L=await aa({libraryId:c,infoId:f}),we=L.links&&typeof L.links=="object"?{...L.links}:{},ne=we[p],G=Array.isArray(ne)?ne.filter(Q=>typeof Q=="string"):typeof ne=="string"?[ne]:[];G.includes(W.id)||(we[p]=[...G,W.id],await ms({libraryId:c,infoId:f,payload:L.payload,links:we}))}C(L=>({...L,[p]:rt(T)})),O(L=>({...L,[p]:null}))}catch(P){O(V=>({...V,[p]:Rs(P,t.cogita.library.lookup.createFailed)}))}finally{J(P=>P===p?null:P)}},Ie=async()=>{var P;if(!Oe)return;const p={};for(const V of Oe.payloadFields){if(S==="source"&&(V.key==="sourceKind"||V.key==="locator"))continue;const Z=(v[V.key]??"").trim();if(!Z){if(V.required){M(`Field '${V.label}' is required.`);return}continue}if(V.inputType==="json")try{p[V.key]=JSON.parse(Z)}catch{M(`Field '${V.label}' must be valid JSON.`);return}else p[V.key]=Z}const T={};for(const V of Oe.linkFields)if(!(S==="source"&&V.key==="resource"))if(V.multiple){const Z=(k[V.key]??[]).map(fe=>fe.id);if(V.required&&Z.length===0){M(`Link '${V.label}' is required.`);return}Z.length>0&&(T[V.key]=Z)}else{const Z=((P=X[V.key])==null?void 0:P.id)??null;if(V.required&&!Z){M(`Link '${V.label}' is required.`);return}Z&&(T[V.key]=Z)}if(S==="source"){if(!Ps(ke)){M(t.cogita.library.add.info.referenceMissingSource);return}const V=ke.sourceKind.trim();p.sourceKind=V,p.locator=Pn(ke),(typeof p.label!="string"||!p.label.trim())&&(p.label=$s(ke));const Z=$n(ke);Z&&(T.resource=Z.id)}de("saving"),M(null);try{if(d&&f)await ms({libraryId:c,infoId:f,payload:p,links:T}),M("Info updated.");else{await Jn({libraryId:c,infoType:S,payload:p,links:T});const V=S==="question"&&Me.length>0&&ot<Me.length-1;if(V){const L=ot+1,we=Me[L]??null;if(we){const ne=Rn(we);$e(L),ye(we),b(G=>({...G,definition:ne})),M(`Info saved. Loaded next question (${L+1}/${Me.length}).`)}else M("Info saved.")}else S==="question"&&Me.length>0&&(tt([]),$e(0)),M("Info saved.");const Z={};for(const L of Oe.payloadFields)Z[L.key]=L.keepOnCreate?v[L.key]??"":"";if(V){const L=Me[Math.min(ot+1,Me.length-1)];L&&(Z.definition=Rn(L))}b(Z);const fe={},W={};for(const L of Oe.linkFields)L.multiple?W[L.key]=L.keepOnCreate?k[L.key]??[]:[]:fe[L.key]=L.keepOnCreate?X[L.key]??null:null;R(L=>({...L,...fe})),D(L=>({...L,...W})),S==="source"&&Je(L=>{const we=rt(L),ne=$n(we);return b(G=>({...G,sourceKind:we.sourceKind,locator:Ms(Pn(we))})),R(G=>({...G,resource:ne})),ne&&ee(G=>({...G,resource:ne.infoType})),we})}}catch(V){M(Rs(V,"Failed to save info."))}finally{de("idle")}},Ue=p=>{const T=v[p.key]??"";if(S==="question"&&p.key==="definition"&&p.inputType==="json"){const V=Y.type,Z=Q=>{const ge=Y.title??"",oe=Y.question??"";Ae({...Za(Q),title:ge,question:oe})},fe=Q=>Q.length===0?[""]:Q[Q.length-1].trim()?[...Q,""]:Q,W=Q=>{const ge=(Q.length?Q:[[""],[""]]).map(oe=>fe(oe));return ge.length>=2?ge:[...ge,[""]]},L=(Q,ge)=>{const oe=Q.map(Ce=>Array.from({length:ge},(ze,Ke)=>Ce[Ke]??"")).filter(Ce=>Ce.some(ze=>ze.trim())||Ce===Q[Q.length-1]);return oe.length===0?[new Array(ge).fill("")]:oe[oe.length-1].some(Ce=>Ce.trim())?[...oe,new Array(ge).fill("")]:oe},we=Array.isArray(Y.answer)?Y.answer:[],ne=W(Y.columns??[[""],[""]]),G=L(Y.matchingPaths??[[]],ne.length);return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:p.label}),e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.8rem"},children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question type"}),e.jsxs("select",{value:V,onChange:Q=>Z(Q.target.value),children:[e.jsx("option",{value:"selection",children:"Selection"}),e.jsx("option",{value:"truefalse",children:"True / false"}),e.jsx("option",{value:"text",children:"Text answer"}),e.jsx("option",{value:"number",children:"Number answer"}),e.jsx("option",{value:"date",children:"Date answer"}),e.jsx("option",{value:"matching",children:"Matching"}),e.jsx("option",{value:"ordering",children:"Right order"})]})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Title"}),e.jsx("input",{type:"text",value:Y.title??"",onChange:Q=>Ae({...Y,title:Q.target.value}),placeholder:"Optional title"})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Question"}),e.jsx("textarea",{rows:3,value:Y.question??"",onChange:Q=>Ae({...Y,question:Q.target.value}),placeholder:"Question text"})]}),V==="selection"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Options / correct indices"}),fe(Y.options??[""]).map((Q,ge,oe)=>{const le=new Set(we.filter(ze=>Number.isInteger(ze))),Ce=ge===oe.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:le.has(ge),disabled:!Q.trim(),onChange:ze=>{const Ke=ze.target.checked?[...le,ge]:[...le].filter(Ee=>Ee!==ge);Ae({...Y,answer:Ke})}}),e.jsx("input",{type:"text",value:Q,placeholder:`Answer ${ge+1}`,onChange:ze=>{const Ke=[...Y.options??[""]];Ke[ge]=ze.target.value;const Ee=fe(Ke),bt=Ee.length-1,dt=we.filter(yt=>yt>=0&&yt<bt);Ae({...Y,options:Ee,answer:dt})}}),Ce?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const Ke=(Y.options??[""]).filter((bt,dt)=>dt!==ge),Ee=we.filter(bt=>bt!==ge).map(bt=>bt>ge?bt-1:bt);Ae({...Y,options:fe(Ke),answer:Ee})},children:"Remove"})]},`question-option:${ge}`)})]}):null,V==="text"||V==="date"||V==="number"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsx("input",{type:V==="date"?"date":"text",value:typeof Y.answer=="string"||typeof Y.answer=="number"?String(Y.answer):"",onChange:Q=>Ae({...Y,answer:Q.target.value})})]}):null,V==="truefalse"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:"Answer"}),e.jsxs("select",{value:String(!!Y.answer),onChange:Q=>Ae({...Y,answer:Q.target.value==="true"}),children:[e.jsx("option",{value:"true",children:"True"}),e.jsx("option",{value:"false",children:"False"})]})]}):null,V==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Columns"}),ne.map((Q,ge)=>e.jsxs("div",{style:{display:"grid",gap:"0.35rem",border:"1px solid rgba(120,170,220,0.22)",borderRadius:"0.6rem",padding:"0.55rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"0.5rem"},children:[e.jsxs("span",{style:{fontSize:"0.8rem",color:"rgba(184,209,234,0.85)"},children:["Column ",ge+1]}),ne.length>2?e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const oe=ne.filter((Ce,ze)=>ze!==ge),le=G.map(Ce=>Ce.filter((ze,Ke)=>Ke!==ge));Ae({...Y,columns:W(oe),matchingPaths:L(le,Math.max(2,oe.length))})},children:"Remove column"}):null]}),Q.map((oe,le)=>{const Ce=le===Q.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",gap:"0.4rem",alignItems:"center"},children:[e.jsx("input",{type:"text",value:oe,placeholder:`Option ${le+1}`,onChange:ze=>{const Ke=ne.map(Ee=>[...Ee]);Ke[ge][le]=ze.target.value,Ae({...Y,columns:W(Ke),matchingPaths:L(G,ne.length)})}}),Ce?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const ze=ne.map(Ke=>[...Ke]);ze[ge]=ze[ge].filter((Ke,Ee)=>Ee!==le),Ae({...Y,columns:W(ze),matchingPaths:L(G,ne.length)})},children:"Remove"})]},`question-column:${ge}:row:${le}`)})]},`question-column:${ge}`)),e.jsx("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{const Q=[...ne.map(oe=>[...oe]),[""]],ge=G.map(oe=>[...oe,""]);Ae({...Y,columns:W(Q),matchingPaths:L(ge,Q.length)})},children:"Add column"})}),e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Correct paths (0-based indices)"}),G.map((Q,ge)=>{const oe=ge===G.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:`repeat(${ne.length}, minmax(0,1fr)) auto`,gap:"0.35rem",alignItems:"center"},children:[Q.map((le,Ce)=>e.jsx("input",{type:"number",min:0,step:1,value:le,placeholder:`${Ce}`,onChange:ze=>{const Ke=G.map(dt=>[...dt]);Ke[ge][Ce]=ze.target.value;const Ee=L(Ke,ne.length),bt=Ee.map(dt=>dt.map(yt=>yt.trim())).filter(dt=>dt.every(yt=>yt!=="")).map(dt=>dt.map(yt=>Number(yt))).filter(dt=>dt.every(yt=>Number.isInteger(yt)&&yt>=0));Ae({...Y,matchingPaths:Ee,answer:{paths:bt}})}},`question-path:${ge}:${Ce}`)),oe?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>{const le=G.filter((Ke,Ee)=>Ee!==ge),Ce=L(le,ne.length),ze=Ce.map(Ke=>Ke.map(Ee=>Ee.trim())).filter(Ke=>Ke.every(Ee=>Ee!=="")).map(Ke=>Ke.map(Ee=>Number(Ee))).filter(Ke=>Ke.every(Ee=>Number.isInteger(Ee)&&Ee>=0));Ae({...Y,matchingPaths:Ce,answer:{paths:ze}})},children:"Remove"})]},`question-path:${ge}`)})]}):null,V==="ordering"?e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"Ordered options (correct order = listed order)"}),fe(Y.options??[""]).map((Q,ge,oe)=>{const le=ge===oe.length-1;return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)",minWidth:"1.5rem"},children:[ge+1,"."]}),e.jsx("input",{type:"text",value:Q,placeholder:`Step ${ge+1}`,onChange:Ce=>{const ze=[...Y.options??[""]];ze[ge]=Ce.target.value,Ae({...Y,options:fe(ze)})}}),le?e.jsx("span",{}):e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ae({...Y,options:fe((Y.options??[]).filter((Ce,ze)=>ze!==ge))}),children:"Remove"})]},`question-order:${ge}`)})]}):null,e.jsxs("div",{style:{display:"grid",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.82rem",color:"rgba(184,209,234,0.8)"},children:"JSON import"}),e.jsx("textarea",{rows:8,value:Te,onChange:Q=>Re(Q.target.value),placeholder:"Paste question JSON"}),e.jsxs("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:[e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>{try{const Q=JSON.parse(Te);if(Array.isArray(Q)){const oe=Q.map(Ce=>Aa(Ce)).filter(Ce=>!!Ce);if(oe.length===0){M("Question JSON array must contain at least one valid question object.");return}const le=oe[0];tt(oe),$e(0),Ae(le),M(`Loaded question array (${oe.length} items).`);return}const ge=Aa(Q);if(!ge){M("Question JSON must be an object or an array of question objects.");return}tt([]),$e(0),Ae(ge),M(null)}catch{M("Question JSON is invalid.")}},children:"Interpret JSON"}),Me.length>0?e.jsxs("span",{className:"cogita-library-hint",children:["Queue: ",Math.min(ot+1,Me.length)," / ",Me.length]}):null]})]})]})]},`payload:${p.key}`)}const P=p.inputType==="textarea"||p.inputType==="json";return e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:p.label}),P?e.jsx("textarea",{rows:p.inputType==="json"?8:4,value:T,onChange:V=>b(Z=>({...Z,[p.key]:V.target.value})),placeholder:p.key}):e.jsx("input",{type:"text",value:T,onChange:V=>b(Z=>({...Z,[p.key]:V.target.value})),placeholder:p.key})]},`payload:${p.key}`)},et=p=>{const T=N[p.key]??p.targetTypes[0],P=p.key==="references"&&p.multiple&&p.targetTypes.includes("source"),V=be[p.key]??Oa(),Z=ue[p.key]??!1,fe=U[p.key];return e.jsxs("div",{className:"cogita-field full",children:[e.jsx("span",{children:p.label}),p.targetTypes.length>1?e.jsx("select",{value:T,onChange:W=>ee(L=>({...L,[p.key]:W.target.value})),children:p.targetTypes.map(W=>e.jsx("option",{value:W,children:it(t,W)},`${p.key}:${W}`))}):null,p.multiple?e.jsx(Xt,{libraryId:c,infoType:T,label:p.label,placeholder:p.key,multiple:!0,values:k[p.key]??[],onChangeMultiple:W=>D(L=>({...L,[p.key]:W})),allowCreate:!P,searchFailedText:"Search failed",createFailedText:"Create failed"}):e.jsx(Xt,{libraryId:c,infoType:T,label:p.label,placeholder:p.key,value:X[p.key]??null,onChange:W=>R(L=>({...L,[p.key]:W})),searchFailedText:"Search failed",createFailedText:"Create failed"}),P?e.jsxs("div",{children:[e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:Z,onChange:W=>$(L=>({...L,[p.key]:W.target.checked}))}),e.jsx("span",{children:t.cogita.library.add.info.referenceToggle})]}),Z?e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(Is,{libraryId:c,copy:t,language:g,sourceKindOptions:[...Ls],value:V,onChange:W=>C(L=>({...L,[p.key]:W})),labels:gt}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:()=>at(p.key),disabled:K===p.key,children:K===p.key?t.cogita.library.lookup.saving:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.source)})}),fe?e.jsx("p",{className:"cogita-library-subtitle",children:fe}):null]}):null]}):null]},`link:${p.key}`)},qe=()=>e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.add.info.referenceTitle}),e.jsx(Is,{libraryId:c,copy:t,language:g,sourceKindOptions:[...Ls],value:ke,onChange:Je,labels:gt})]});return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:d?"Edit info":"Create info"}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:"Specification-driven editor"})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:`/#/cogita/library/${c}/list`,children:"Back to list"})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("article",{className:"cogita-library-panel",children:[d?null:e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Info type"}),e.jsx("select",{value:S,onChange:p=>A(p.target.value),children:We.map(p=>e.jsx("option",{value:p.value,children:p.label},p.value))})]}),H==="loading"&&d?e.jsx("p",{children:"Loading..."}):null,Oe&&!(H==="loading"&&d)?e.jsxs("div",{className:"cogita-form-grid",children:[Oe.payloadFields.filter(p=>!(S==="source"&&(p.key==="sourceKind"||p.key==="locator"))).map(Ue),S==="source"?qe():null,Oe.linkFields.filter(p=>!(S==="source"&&p.key==="resource")).map(et)]}):H==="loading"&&d?null:e.jsx("p",{children:"No specification found for this info type."}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:Ie,disabled:H==="saving"||!Oe,children:H==="saving"?"Saving...":d?"Update info":"Create info"})}),F?e.jsx("p",{className:"cogita-library-subtitle",children:F}):null]})})})]})})}const Es=t=>/\s/.test(t),on=t=>/[\p{L}\p{N}]/u.test(t),Fs=(t,a)=>{const s=a>0?t[a-1]:"",r=a<t.length?t[a]:"";if(!s||!r)return 0;const i=Es(s),u=Es(r);if(i||u)return 3;const o=on(s),j=on(r);return o!==j?2:!o&&!j?1:0},En=(t,a,s,r,i)=>{const u=Math.max(r-a,s-r);for(let o=0;o<=u;o+=1){const j=r-o;if(j>=a&&j<=s&&Fs(t,j)>=i)return j;const g=r+o;if(g>=a&&g<=s&&Fs(t,g)>=i)return g}return null},Fn=(t,a)=>{const s=a>0?t[a-1]:"",r=a<t.length?t[a]:"";return!s||!r?!0:on(s)!==on(r)},$i=(t,a,s,r)=>{const i=s-a,u=a+r,o=s-r;if(i<=r*2||o<=u)return null;const j=Math.floor((a+s)/2),g=En(t,u,o,j,3);if(g!==null&&Fn(t,g))return g;const x=En(t,u,o,j,2);if(x!==null&&Fn(t,x))return x;const c=En(t,u,o,j,1);return c!==null&&Fn(t,c)?c:null},va=(t,a)=>{const s=Math.max(1,(a==null?void 0:a.minLen)??7),r=Math.max(s,(a==null?void 0:a.maxLen)??13),i={},u=(g,x,c,f,l)=>{const d=String(f),w={id:d,start:g,end:x,text:t.slice(g,x),depth:c,index:f,parentId:l};if(i[d]=w,x-g>r){let S=$i(t,g,x,s);if(S!==null&&S>g&&S<x){const A=u(g,S,c+1,f*2+1,d),v=u(S,x,c+1,f*2+2,d);w.leftId=A.id,w.rightId=v.id}}return w},o=u(0,t.length,0,0),j=Object.values(i).sort((g,x)=>x.depth-g.depth||g.start-x.start).map(g=>g.id);return{text:t,rootId:o.id,nodes:i,order:j}},$a=(t,a,s,r,i,u,o)=>{const j=u==="reverse"?t.order.slice().sort((g,x)=>t.nodes[x].start-t.nodes[g].start||t.nodes[x].depth-t.nodes[g].depth):t.order;for(const g of j){if(o&&g===o||a.has(g))continue;const x=t.nodes[g];if(x){if(i&&(x.leftId||x.rightId)){const c=x.leftId?s[x.leftId]??0:r,f=x.rightId?s[x.rightId]??0:r;if((c+f)/2<r)continue}return x}}return null},vn=(t,a)=>({before:t.slice(0,a.start),fragment:t.slice(a.start,a.end),after:t.slice(a.end)});function Pi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,libraryId:c}){const f=`/#/cogita/library/${c}`,[l,d,w]=Gn([]),[m,S,A]=Yn([]),[v,b]=n.useState(null),[X,R]=n.useState(null),[k,D]=n.useState(null),[N,ee]=n.useState(null),F=n.useMemo(()=>l.find($=>$.id===v)??null,[l,v]);n.useEffect(()=>{let $=!0;return Tr({libraryId:c}).then(be=>{if(!$)return;const C=be.nodes.map(U=>{var O,K,J;return{id:U.nodeId,type:"default",position:{x:80+Math.random()*300,y:60+Math.random()*260},data:{label:U.payload&&typeof U.payload=="object"&&"label"in U.payload?String(U.payload.label):"Item",nodeType:U.nodeType,itemType:((O=U.payload)==null?void 0:O.itemType)??"info",itemId:((K=U.payload)==null?void 0:K.itemId)??null,infoType:((J=U.payload)==null?void 0:J.infoType)??null}}});d(C),S(be.edges.map(U=>({id:U.edgeId,source:U.fromNodeId,target:U.toNodeId})))}).catch(()=>{$&&(d([]),S([]))}),()=>{$=!1}},[c]),n.useEffect(()=>{Cr({libraryId:c}).then(R).catch(()=>R(null))},[c,l,m]);const M=n.useCallback($=>{S(be=>Xn($,be))},[]),H=()=>{const $=crypto.randomUUID();d(be=>[...be,{id:$,type:"default",position:{x:140+be.length*40,y:120+be.length*30},data:{label:t.cogita.library.infoTypes.collection,nodeType:"collection",itemType:"collection",itemId:null,infoType:"collection"}}])},de=()=>{const $=crypto.randomUUID();d(be=>[...be,{id:$,type:"default",position:{x:180+be.length*40,y:160+be.length*30},data:{label:t.cogita.library.infoTypes.any,nodeType:"info",itemType:"info",itemId:null,infoType:null}}])},ke=async()=>{D(null);try{const $=l.map(C=>({nodeId:C.id,nodeType:C.data.nodeType,payload:{itemType:C.data.itemType,itemId:C.data.itemId??null,label:C.data.label,infoType:C.data.infoType??null}})),be=m.map(C=>({edgeId:C.id,fromNodeId:C.source,toNodeId:C.target}));await Ir({libraryId:c,nodes:$,edges:be}),D(t.cogita.library.graph.saveSuccess)}catch{D(t.cogita.library.graph.saveFail)}},Je=$=>{F&&d(be=>be.map(C=>C.id===F.id?{...C,data:{...C.data,itemId:($==null?void 0:$.infoId)??null,itemType:"collection",infoType:"collection",label:($==null?void 0:$.label)??t.cogita.library.infoTypes.collection}}:C))},ue=$=>{F&&d(be=>be.map(C=>C.id===F.id?{...C,data:{...C.data,itemId:($==null?void 0:$.infoId)??null,itemType:"info",infoType:($==null?void 0:$.infoType)??null,label:($==null?void 0:$.label)??t.cogita.library.infoTypes.any}}:C))};return n.useEffect(()=>{if(!F||F.data.nodeType!=="info"||F.data.infoType!=="citation"||!F.data.itemId){ee(null);return}let $=!0;return aa({libraryId:c,infoId:F.data.itemId}).then(be=>{if(!$)return;const C=be.payload,U=(C==null?void 0:C.text)??"";if(!U){ee(null);return}const O=va(U),K=Object.values(O.nodes).sort((J,Y)=>J.depth-Y.depth||J.start-Y.start).map(J=>({id:J.id,text:J.text,depth:J.depth}));ee({title:(C==null?void 0:C.title)??F.data.label,fragments:K})}).catch(()=>ee(null)),()=>{$=!1}},[c,F]),e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:t.cogita.library.navLabel}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:f,children:t.cogita.library.actions.libraryOverview}),e.jsx("button",{type:"button",className:"cta",onClick:ke,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("button",{type:"button",className:"cta ghost",onClick:H,children:t.cogita.library.collections.create}),e.jsx("button",{type:"button",className:"cta ghost",onClick:de,children:t.cogita.library.actions.addInfo}),X?e.jsx("div",{className:"cogita-graph-summary",children:e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(X.totalCollections))})}):null,k?e.jsx("p",{className:"cogita-help",children:k}):null]}),e.jsx("div",{className:"cogita-collection-graph-canvas",children:e.jsxs(fn,{nodes:l,edges:m,onNodesChange:w,onEdgesChange:A,onConnect:M,onNodeClick:($,be)=>b(be.id),fitView:!0,children:[e.jsx(bn,{gap:18,size:1}),e.jsx(yn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),F?e.jsxs("div",{className:"cogita-graph-inspector",children:[F.data.nodeType==="collection"?e.jsx(Xt,{libraryId:c,infoType:"collection",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:F.data.itemId?{id:F.data.itemId,label:F.data.label,infoType:"collection"}:null,onChange:Je,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.collection),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}):e.jsx(Xt,{libraryId:c,infoType:"any",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:F.data.itemId?{id:F.data.itemId,label:F.data.label,infoType:F.data.infoType??void 0}:null,onChange:ue,searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.any),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),N?e.jsxs("div",{className:"cogita-quote-preview",children:[e.jsx("p",{className:"cogita-user-kicker",children:N.title}),e.jsx("div",{className:"cogita-detail-sample-grid",children:N.fragments.map($=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:$.id}),e.jsx("span",{children:$.text})]},$.id))})]}):null]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}function Fa({children:t,flashState:a,flashTick:s=0,feedbackToken:r,className:i}){const u=r??(a?`${a}-${s}`:"idle"),[o,j]=n.useState("a"),g=n.useRef(u);return n.useEffect(()=>{g.current!==u&&(g.current=u,j(x=>x==="a"?"b":"a"))},[u]),e.jsx("section",{className:i?`cogita-revision-card ${i}`:"cogita-revision-card","data-feedback":u,"data-feedback-variant":o,children:t})}function ss({copy:t,currentCard:a,currentTypeLabel:s,prompt:r,languages:i,answer:u,onAnswerChange:o,computedExpected:j,computedAnswers:g,onComputedAnswerChange:x,answerTemplate:c,outputVariables:f,variableValues:l,computedFieldFeedback:d,feedback:w,canAdvance:m,quoteContext:S,quotePlaceholder:A,onCheckAnswer:v,onSkip:b,onLanguageSelect:X,onMarkReviewed:R,onAdvance:k,showCorrectAnswer:D,setShowCorrectAnswer:N,onRevealCorrect:ee,answerMask:F,expectedAnswer:M,hasExpectedAnswer:H,handleComputedKeyDown:de,answerInputRef:ke,computedInputRefs:Je,scriptMode:ue,setScriptMode:$,matchPairs:be,matchLeftOrder:C,matchRightOrder:U,matchSelection:O,matchActiveLeft:K,matchActiveRight:J,matchFeedback:Y,onMatchLeftSelect:ye,onMatchRightSelect:Te,disableCheckAnswer:Re=!1,hideSkipAction:Me=!1,allowRevealBeforeCheck:tt=!1,autoRevealAfterAnswer:ot=!1,disableCheckAfterAnswer:$e=!1}){const Oe=n.useMemo(()=>{var we;const B=!c&&j.length===2?`The {${j[0].key}} is of type {${j[1].key}}`:null,te=c??B;if(!te)return null;const pe=new Map(j.map(ne=>[ne.key,ne.expected])),p=new Set,T=[],P=/\{([^}]+)\}/g;let V=0,Z,fe=null;for(;(Z=P.exec(te))!==null;){const ne=te.slice(V,Z.index);ne&&T.push({type:"text",value:ne});const G=((we=Z[1])==null?void 0:we.trim())??"",Q=G&&pe.has(G)?G:G&&f&&f[G]?f[G]:null;G&&p.add(G),Q&&p.add(Q),Q&&pe.has(Q)?(T.push({type:"input",value:Q}),fe||(fe=Q)):G&&l&&l[G]!==void 0?T.push({type:"text",value:l[G]}):T.push({type:"text",value:Z[0]}),V=Z.index+Z[0].length}const W=te.slice(V);return W&&T.push({type:"text",value:W}),j.filter(ne=>!p.has(ne.key)).length>0?null:{parts:T,expectedByKey:pe,firstInputKey:fe}},[c,j,f,l]),kt=()=>{if(!Oe)return null;const{parts:B,expectedByKey:te,firstInputKey:pe}=Oe;return e.jsx("div",{className:"cogita-revision-inline-answer",children:B.map((p,T)=>{var P,V;return p.type==="text"?e.jsx("span",{className:"cogita-inline-text",children:p.value},`text-${T}`):e.jsx("input",{ref:Z=>{Je.current[p.value]=Z},autoFocus:p.value===pe,value:g[p.value]??"",onChange:Z=>x(p.value,Z.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":d[p.value]??(w==="correct"?"correct":w==="incorrect"?"incorrect":void 0),onKeyDown:Z=>gt(Z)||de(Z),className:"cogita-inline-input",style:{minWidth:"5rem",width:`${Math.max(6,((P=g[p.value])==null?void 0:P.length)??0,((V=te.get(p.value))==null?void 0:V.length)??6)}ch`}},`input-${p.value}-${T}`)})})},We=n.useMemo(()=>{const B=new Map;return(be??[]).forEach(te=>B.set(te.leftId,te)),B},[be]),Ae=n.useMemo(()=>{const B=new Map;return(be??[]).forEach(te=>B.set(te.rightId,te)),B},[be]);n.useEffect(()=>{var T;if(a.cardType!=="info"||a.infoType!=="computed"||j.length===0)return;const B=typeof document<"u"?document.activeElement:null;if(B&&(B.tagName==="INPUT"||B.tagName==="TEXTAREA"))return;const te=(Oe==null?void 0:Oe.firstInputKey)??((T=j[0])==null?void 0:T.key);if(!te)return;const pe=Je.current[te];if(!pe)return;const p=requestAnimationFrame(()=>{pe.focus()});return()=>cancelAnimationFrame(p)},[a,j,Oe]);const rt=(()=>{const B=[M??"",...j.map(p=>p.expected??"")].join(""),te=[u,...Object.values(g)].join(""),pe=`${B}${te}`;return/[⁰¹²³⁴⁵⁶⁷⁸⁹⁺⁻⁼⁽⁾ⁿⁱ₀₁₂₃₄₅₆₇₈₉₊₋₌₍₎ₐₑₕᵢⱼₖₗₘₙₒₚᵣₛₜᵤᵥₓ]/.test(pe)})(),gt=B=>B.ctrlKey&&(B.key==="^"||B.key==="6")?(B.preventDefault(),$(te=>te==="super"?null:"super"),!0):B.ctrlKey&&(B.key==="_"||B.key==="-")?(B.preventDefault(),$(te=>te==="sub"?null:"sub"),!0):!1,at=()=>{if(!M||!F)return M??"";const B=M.split(""),te=Array.from(F),pe=te.length>0?te.reduce((p,T)=>p+T,0)/te.length:127;return B.map((p,T)=>{const P=te[T]??pe,V=Math.max(0,Math.min(255,Math.round(P)));let Z=255,fe=0;return V<=127?fe=Math.round(V/127*255):(fe=255,Z=Math.round(255*(1-(V-127)/128))),e.jsx("span",{style:{color:`rgb(${Z}, ${fe}, 0)`},children:p},`mask-${T}`)})},Ie=a.cardType==="info"&&a.infoType==="citation"?(S==null?void 0:S.title)||a.label:a.description,Ue=D||ot&&w!==null,et=Re||$e&&(w!==null||Ue),qe=H&&(tt||w==="incorrect"||Ue);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-revision-header",children:[s?e.jsx("span",{children:s}):null,e.jsx("strong",{children:Ie})]}),a.cardType==="vocab"&&a.checkType==="translation-match"&&be?e.jsxs("div",{className:"cogita-revision-body",children:[r?e.jsx("h2",{children:r}):null,e.jsxs("div",{className:"cogita-revision-match",children:[e.jsx("div",{className:"cogita-revision-match-column",children:(C??[]).map(B=>{const te=We.get(B);if(!te)return null;const pe=(O==null?void 0:O[B])??null,p=(Y==null?void 0:Y[B])??null,T=K===B;return e.jsxs("button",{type:"button",className:"cogita-revision-match-item","data-active":T,"data-state":p??void 0,"data-locked":pe?"true":void 0,onClick:()=>ye==null?void 0:ye(B),children:[e.jsx("span",{children:te.leftLabel}),pe&&D?e.jsx("em",{children:"✓"}):null]},B)})}),e.jsx("div",{className:"cogita-revision-match-column",children:(U??[]).map(B=>{const te=Ae.get(B);if(!te)return null;const pe=Object.values(O??{}).includes(B),p=J===B;return e.jsx("button",{type:"button",className:"cogita-revision-match-item","data-active":pe||p,"data-locked":pe?"true":void 0,onClick:()=>Te==null?void 0:Te(B),children:e.jsx("span",{children:te.rightLabel})},B)})})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:a.checkType==="translation-match"||et,children:t.cogita.library.revision.checkAnswer}),Me?null:e.jsx("button",{type:"button",className:"ghost",onClick:b,children:t.cogita.library.revision.skip})]})]}):a.cardType==="vocab"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ke,value:u,onChange:B=>o(B.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":w==="correct"?"correct":w==="incorrect"?"incorrect":void 0,onKeyDown:B=>{if(B.key==="Enter")if(B.preventDefault(),B.stopPropagation(),m)k();else{if(et)return;v()}}})]}),rt?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":ue==="super",onClick:()=>$(B=>B==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":ue==="sub",onClick:()=>$(B=>B==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:et,children:t.cogita.library.revision.checkAnswer}),Me?null:e.jsx("button",{type:"button",className:"ghost",onClick:b,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="question"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ke,value:u,onChange:B=>o(B.target.value),placeholder:t.cogita.library.revision.answerPlaceholder,"data-state":w==="correct"?"correct":w==="incorrect"?"incorrect":void 0,onKeyDown:B=>{if(B.key==="Enter")if(B.preventDefault(),B.stopPropagation(),m)k();else{if(et)return;v()}}})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:et,children:t.cogita.library.revision.checkAnswer}),Me?null:e.jsx("button",{type:"button",className:"ghost",onClick:b,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="computed"?e.jsxs("div",{className:"cogita-revision-body",children:[a.label?e.jsx("p",{className:"cogita-revision-hint",children:a.label}):null,c?null:e.jsx(Lr,{value:r??"",mode:"auto"}),j.length>0?(()=>{const B=kt();return B?e.jsx("div",{className:"cogita-inline-answer-wrap",children:B}):e.jsx("div",{className:"cogita-form-grid",children:j.map((te,pe)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:te.key}),e.jsx("textarea",{ref:p=>{Je.current[te.key]=p},autoFocus:pe===0,value:g[te.key]??"",onChange:p=>x(te.key,p.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":d[te.key]??(w==="correct"?"correct":w==="incorrect"?"incorrect":void 0),onKeyDown:p=>gt(p)||de(p)})]},te.key))})})():e.jsx("div",{className:"cogita-form-grid",children:e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("textarea",{ref:ke,value:u,onChange:B=>o(B.target.value),placeholder:t.cogita.library.revision.answerPlaceholderComputed,"data-state":w==="correct"?"correct":w==="incorrect"?"incorrect":void 0,onKeyDown:B=>{if(!gt(B)&&B.key==="Enter")if(B.preventDefault(),B.stopPropagation(),m)k();else{if(et)return;v()}}})]})}),rt?e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost","data-active":ue==="super",onClick:()=>$(B=>B==="super"?null:"super"),children:"x²"}),e.jsx("button",{type:"button",className:"ghost","data-active":ue==="sub",onClick:()=>$(B=>B==="sub"?null:"sub"),children:"x₂"})]}):null,e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:et,children:t.cogita.library.revision.checkAnswer}),Me?null:e.jsx("button",{type:"button",className:"ghost",onClick:b,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="citation"&&S?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsxs("div",{className:"cogita-quote-block",children:[e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.quoteProgress.replace("{done}",String(S.completed)).replace("{total}",String(S.total))}),e.jsx("p",{className:"cogita-quote-text",children:S.before}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:ke,value:u,onChange:B=>o(B.target.value),placeholder:A??t.cogita.library.revision.quoteMissingPlaceholder,"data-state":w==="correct"?"correct":w==="incorrect"?"incorrect":void 0,onKeyDown:B=>{if(B.key==="Enter")if(B.preventDefault(),B.stopPropagation(),m)k();else{if(et)return;v()}}})]}),e.jsx("p",{className:"cogita-quote-text",children:S.after})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:v,disabled:et,children:t.cogita.library.revision.checkAnswer}),Me?null:e.jsx("button",{type:"button",className:"ghost",onClick:b,children:t.cogita.library.revision.skip})]})]}):a.cardType==="info"&&a.infoType==="word"?e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintSelectLanguage}),e.jsx("div",{className:"cogita-choice-grid",children:i.length?i.map(B=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>X(B.label),children:B.label},B.infoId)):e.jsx("span",{className:"cogita-revision-hint",children:t.cogita.library.revision.noLanguages})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"ghost",onClick:b,children:t.cogita.library.revision.skip})})]}):e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:r}),e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.hintReview}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:R,children:t.cogita.library.revision.markDone}),e.jsx("button",{type:"button",className:"ghost",onClick:b,children:t.cogita.library.revision.skip})]})]}),w&&e.jsx("div",{className:"cogita-revision-feedback","data-state":w,children:w==="correct"?t.cogita.library.revision.correct:t.cogita.library.revision.tryAgain}),qe?e.jsxs("div",{className:"cogita-revision-reveal",children:[Ue?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>N(B=>{const te=!B;return te&&ee(),te}),children:t.cogita.library.revision.showAnswer}),Ue?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),j.length>0?e.jsxs("div",{className:"cogita-detail-sample-grid",children:[j.map(B=>e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:B.key}),e.jsx("span",{children:B.expected})]},B.key)),M?e.jsxs("div",{className:"cogita-detail-sample-item",children:[e.jsx("span",{children:t.cogita.library.revision.answerSentenceLabel}),e.jsx("span",{children:M})]}):null]}):e.jsx("p",{children:F?at():M})]}):null]}):null,m?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:k,children:t.cogita.library.revision.nextQuestion})}):null]})}const Ks={a:["ą","à","á","â","ä","ã","å"],c:["ć","č"],e:["ę","è","é","ê","ë"],i:["ì","í","î","ï"],l:["ł"],n:["ń"],o:["ò","ó","ô","ö","õ"],s:["ś","š"],u:["ù","ú","û","ü"],y:["ý","ÿ"],z:["ź","ż","ž"]},Ei=(t,a)=>{const s=Math.max(t.length,a.length,1),r=Math.abs(t.length-a.length);return Math.max(0,1-r/s)},Fi=(t,a)=>{const s=new Uint8Array(t.length),r=Ei(t,a);for(let i=0;i<t.length;i+=1){const u=t[i]===(a[i]??"")?128:0,o=t.length-1-i,j=a.length-1-i,g=t[o]===(a[j]??"")?127:0,x=Math.round((u+g)*r);s[i]=Math.max(0,Math.min(255,x))}return s},Ki=(t,a)=>t===a||(Ks[t]??[]).includes(a)?!0:(Ks[a]??[]).includes(t),en=(t,a,s)=>s?Ki(t,a):t===a,ln=(t,a,s)=>{const r=new Uint8Array(t.length);if(!t.length)return r;const i=(s==null?void 0:s.allowSimilarChars)??!0,u=[];for(let j=0;j<=t.length-3;j+=1)u.push({index:j,text:t.slice(j,j+3)});let o=!1;return u.forEach(j=>{for(let g=0;g<=a.length-3;g+=1){const x=a.slice(g,g+3);let c=0;for(let m=0;m<3;m+=1)en(j.text[m],x[m],i)&&(c+=1);if(c<2)continue;let f=j.index-1,l=g-1;for(;f>=0&&l>=0;){const m=t[f],S=a[l];if(m===S){r[f]=Math.max(r[f],255),f-=1,l-=1,o=!0;continue}if(en(m,S,i)&&m!==S){r[f]=Math.max(r[f],127),f-=1,l-=1,o=!0;continue}if(f>0&&t[f-1]===S){r[f]=Math.max(r[f],0),f-=1,o=!0;continue}if(l>0&&t[f]===a[l-1]){l-=1,o=!0;continue}break}for(let m=0;m<3;m+=1){const S=j.index+m,A=j.text[m],v=x[m],b=A===v?255:en(A,v,i)?127:0;r[S]=Math.max(r[S],b),o=!0}let d=j.index+3,w=g+3;for(;d<t.length&&w<a.length;){const m=t[d],S=a[w];if(m===S){r[d]=Math.max(r[d],255),d+=1,w+=1,o=!0;continue}if(en(m,S,i)&&m!==S){r[d]=Math.max(r[d],127),d+=1,w+=1,o=!0;continue}if(d+1<t.length&&t[d+1]===S){r[d]=Math.max(r[d],0),d+=1,o=!0;continue}if(w+1<a.length&&t[d]===a[w+1]){w+=1,o=!0;continue}break}}}),o?r:Fi(t,a)},Kn=t=>/[\p{L}\p{N}]/u.test(t),_s=t=>t.trim().toLowerCase(),xa=(t,a)=>{if(t.length===0)return 100;const s=(a==null?void 0:a.treatSimilarCharsAsSame)??!1,r=Array.from(t).reduce((i,u)=>s&&u===127?i+255:i+u,0);return Math.round(r/(t.length*255)*100)},Sa=(t,a,s)=>{const r=Math.max(0,Math.min(100,(s==null?void 0:s.thresholdPercent)??100)),i=(s==null?void 0:s.treatSimilarCharsAsSame)??!0,u=(s==null?void 0:s.ignorePunctuationAndSpacing)??!1,o=_s(t),j=_s(a);if(!u){const v=ln(o,j,{allowSimilarChars:i}),b=xa(v,{treatSimilarCharsAsSame:i});return{mask:v,percent:b,isCorrect:b>=r,normalizedExpected:o,normalizedAnswer:j}}const g=Array.from(o),x=Array.from(j),c=[],f=[],l=[];g.forEach((v,b)=>{Kn(v)&&(c.push(v),f.push(b))}),x.forEach(v=>{Kn(v)&&l.push(v)});const d=c.join(""),w=l.join(""),m=ln(d,w,{allowSimilarChars:i}),S=new Uint8Array(g.length);for(let v=0;v<S.length;v+=1)S[v]=Kn(g[v]??"")?0:255;for(let v=0;v<m.length;v+=1){const b=f[v];b!==void 0&&(S[b]=m[v])}const A=xa(m,{treatSimilarCharsAsSame:i});return{mask:S,percent:A,isCorrect:A>=r,normalizedExpected:d,normalizedAnswer:w}},Pa=(t,a,s)=>{const r=t.trim().toLowerCase(),i=a.trim().toLowerCase();return s==="prefix"||s==="bidirectional"?ln(r,i,{allowSimilarChars:!0}):ln(r,i,{allowSimilarChars:!0})},rs=t=>{if(typeof t!="string")return"";const a=t.trim().toLowerCase();return a==="single_select"||a==="multi_select"?"selection":a==="boolean"||a==="true_false"?"truefalse":a==="order"?"ordering":a==="short"||a==="open"||a==="short_text"?"text":a==="selection"||a==="truefalse"||a==="text"||a==="number"||a==="date"||a==="ordering"||a==="matching"?a:""};function dr(t){if(!t||typeof t!="object")return null;const a=t,s=a.definition&&typeof a.definition=="object"?a.definition:a,r=rs(s.type??s.kind);if(!r)return null;const i=typeof s.title=="string"?s.title:void 0,u=typeof s.question=="string"?s.question:"",o=Array.isArray(s.options)?s.options.map(x=>typeof x=="string"?x:"").filter(Boolean):void 0,j=Array.isArray(s.columns)?s.columns.map(x=>Array.isArray(x)?x.map(c=>typeof c=="string"?c:"").filter(Boolean):[]).filter(x=>x.length>0):void 0,g=(()=>{if(r==="selection")return(Array.isArray(s.answer)?s.answer:Array.isArray(s.correct)?s.correct:[]).map(c=>Number(c)).filter(c=>Number.isInteger(c)&&c>=0).sort((c,f)=>c-f);if(r==="truefalse")return typeof s.answer=="boolean"?s.answer:typeof s.expected=="boolean"?s.expected:!1;if(r==="matching"){const x=s.answer&&typeof s.answer=="object"?s.answer:null;return{paths:(Array.isArray(x==null?void 0:x.paths)?x.paths:Array.isArray(s.correctPairs)?s.correctPairs:[]).map(l=>Array.isArray(l)?l.map(d=>Number(d)).filter(d=>Number.isInteger(d)&&d>=0):[]).filter(l=>l.length>0)}}if(typeof s.answer=="string"||typeof s.answer=="number")return s.answer;if(typeof s.expected=="string"||typeof s.expected=="number")return s.expected})();return{type:r,title:i,question:u,options:o,answer:g,columns:j}}function Ds(t){const a=t.map((i,u)=>({value:i,oldIndex:u}));for(let i=a.length-1;i>0;i-=1){const u=Math.floor(Math.random()*(i+1));[a[i],a[u]]=[a[u],a[i]]}const s=a.map(i=>i.value),r=new Map;return a.forEach((i,u)=>r.set(i.oldIndex,u)),{values:s,oldToNew:r}}function _i(t){if(t.type==="selection"){const a=t.options??[],s=Ds(a),r=Array.isArray(t.answer)?t.answer:[];return{...t,options:s.values,answer:r.map(i=>s.oldToNew.get(i)).filter(i=>Number.isInteger(i)).sort((i,u)=>i-u)}}if(t.type==="matching"){const s=(t.columns??[]).map(u=>Ds(u)),i=(t.answer&&typeof t.answer=="object"&&"paths"in t.answer?t.answer.paths:[]).map(u=>u.map((o,j)=>{var g;return((g=s[j])==null?void 0:g.oldToNew.get(o))??o}));return{...t,columns:s.map(u=>u.values),answer:{paths:i}}}return t}function Di(t){const a=[...t];for(let s=a.length-1;s>0;s-=1){const r=Math.floor(Math.random()*(s+1));[a[s],a[r]]=[a[r],a[s]]}return a}function oa(t){return[t.cardId,t.checkType??"",t.direction??""].join("|")}function zs(t){return[t.parentItemId,t.parentCheckType??"",t.parentDirection??""].join("|")}function Bs(t){const a=t.checkType??"info",s=a.startsWith("question-")?`question / ${a.slice(9)}`:a;return t.direction?`${s} / ${t.direction}`:s}function zi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,libraryId:c,infoId:f,selectedReviewerRoleId:l}){const[d,w]=n.useState(f),[m,S]=n.useState([]),[A,v]=n.useState([]),[b,X]=n.useState("loading"),[R,k]=n.useState(null),[D,N]=n.useState(null),[ee,F]=n.useState(null),[M,H]=n.useState(null),[de,ke]=n.useState(""),[Je,ue]=n.useState(null),[$,be]=n.useState(1),[C,U]=n.useState(null),[O,K]=n.useState(0),[J,Y]=n.useState(!1),[ye,Te]=n.useState(null),[Re,Me]=n.useState({}),[tt,ot]=n.useState({}),[$e]=n.useState({}),[Oe,kt]=n.useState(null),[We,Ae]=n.useState({selection:[],booleanAnswer:null,ordering:[],matchingRows:[],matchingSelection:[]}),rt=n.useRef(null),gt=n.useRef({}),at=Wa();n.useEffect(()=>{let W=!1;return X("loading"),Promise.all([aa({libraryId:c,infoId:f}).catch(()=>null),nn({libraryId:c,infoId:f}),sn({libraryId:c,infoId:f})]).then(([L,we,ne])=>{if(W)return;const G=(L==null?void 0:L.payload)??{},Q=typeof G.title=="string"&&G.title||typeof G.label=="string"&&G.label||typeof G.name=="string"&&G.name||f;w(Q),N(G),F((L==null?void 0:L.infoType)??null),S(we.items),v(ne.items),X("ready")}).catch(()=>{W||(N(null),F(null),S([]),v([]),X("error"))}),()=>{W=!0}},[c,f]),n.useEffect(()=>{if(ee!=="translation"){H(null);return}Zs({libraryId:c,infoId:f,approachKey:"vocab-card"}).then(W=>H(W.projection??null)).catch(()=>H(null))},[ee,f,c]);const Ie=n.useMemo(()=>{var ge;const W=new Map(m.map(oe=>[oa(oe),oe])),L=new Map,we=new Map;for(const oe of m)L.set(oa(oe),0),we.set(oa(oe),[]);for(const oe of A){const le=zs({parentItemId:oe.parentItemId,parentCheckType:oe.parentCheckType,parentDirection:oe.parentDirection}),Ce=[oe.childItemId,oe.childCheckType??"",oe.childDirection??""].join("|");!W.has(le)||!W.has(Ce)||((ge=we.get(le))==null||ge.push(Ce),L.set(Ce,(L.get(Ce)??0)+1))}const ne=Array.from(L.entries()).filter(([,oe])=>oe===0).map(([oe])=>oe),G=new Map;for(const oe of ne)G.set(oe,0);for(;ne.length;){const oe=ne.shift(),le=G.get(oe)??0;for(const Ce of we.get(oe)??[]){const ze=Math.max(G.get(Ce)??0,le+1);G.set(Ce,ze),L.set(Ce,(L.get(Ce)??1)-1),(L.get(Ce)??0)<=0&&ne.push(Ce)}}const Q=new Map;for(const oe of m){const le=oa(oe),Ce=G.get(le)??0,ze=Q.get(Ce)??[];ze.push(le),Q.set(Ce,ze)}return m.map(oe=>{const le=oa(oe),Ce=G.get(le)??0,ze=Q.get(Ce)??[le],Ke=Math.max(0,ze.indexOf(le));return{id:le,position:{x:40+Ke*290+(Ce%2?18:0),y:30+Ce*120},draggable:!1,selectable:!0,data:{label:oe.label,subtitle:Bs(oe),checkType:oe.checkType??"info",direction:oe.direction??null},style:{width:250,borderRadius:10,border:"1px solid rgba(120,170,220,0.22)",background:"rgba(8,20,34,0.88)",color:"#e8f2ff",padding:8}}})},[m,A]),Ue=n.useMemo(()=>new Map(m.map(W=>[oa(W),W])),[m]),et=n.useMemo(()=>{const W=[];for(const L of A){const we=zs({parentItemId:L.parentItemId,parentCheckType:L.parentCheckType,parentDirection:L.parentDirection}),ne=[L.childItemId,L.childCheckType??"",L.childDirection??""].join("|");!Ue.has(we)||!Ue.has(ne)||W.push({id:`${we}->${ne}`,source:we,target:ne,selectable:!1,animated:!1,style:{stroke:"rgba(148, 202, 248, 0.7)"}})}return W},[Ue,A]),qe=n.useMemo(()=>R?Ue.get(R)??null:null,[Ue,R]);n.useEffect(()=>{ke(""),U(null),K(0),Y(!1),Te(null),ue(null),ot({}),Ae({selection:[],booleanAnswer:null,ordering:[],matchingRows:[],matchingSelection:[]})},[R]);const B=n.useMemo(()=>{var G,Q;if(!qe)return null;const W=ee??qe.infoType??null,L=qe.checkType??"info",we=qe.direction??null,ne=D??{};if(qe.cardType==="vocab"&&M&&Array.isArray(M.words)){const ge=M.words,oe=((G=ge[0])==null?void 0:G.label)??"?",le=((Q=ge[1])==null?void 0:Q.label)??"?";return we==="a-to-b"?{kind:"vocab",prompt:String(oe),expected:String(le)}:we==="b-to-a"?{kind:"vocab",prompt:String(le),expected:String(oe)}:{kind:"generic",prompt:`${oe} ↔ ${le}`,expected:`${oe} ↔ ${le}`}}if(W==="citation"&&L==="quote-fragment"&&we&&typeof ne.text=="string"){const ge=we,oe=va(ne.text),le=oe.nodes[ge];if(le){const Ce=vn(ne.text,le);return{kind:"citation-fragment",expected:le.text,quoteContext:{title:d,before:Ce.before,after:Ce.after,total:Object.keys(oe.nodes).length,completed:0},quotePlaceholder:le.text.length>0?".".repeat(Math.max(4,Math.min(18,le.text.length))):"..."}}}if(W==="question"){const ge=dr(ne);if(ge)return{kind:"question",definition:_i(ge)}}return{kind:"generic",prompt:qe.description||qe.label,expected:qe.label}},[ee,D,qe,d,M]);n.useEffect(()=>{var L;if(!B||B.kind!=="question")return;const W=B.definition;Ae({selection:[],booleanAnswer:null,ordering:W.type==="ordering"?Di(W.options??[]):[],matchingRows:[],matchingSelection:W.type==="matching"?new Array(Math.max(2,((L=W.columns)==null?void 0:L.length)??2)).fill(null):[]})},[B,R]);const te=async W=>{if(qe&&l)try{await Mr({libraryId:c,outcome:{itemType:"info",itemId:qe.cardId,checkType:qe.checkType??"info",direction:qe.direction??null,revisionType:"direct",evalType:"direct-check",correct:W,clientId:"cogita-info-checkcards",clientSequence:$,personRoleId:l}}),be(L=>L+1),ue(W?"Saved as correct.":"Saved as incorrect.")}catch{ue("Failed to save answer.")}},pe=qe?oa(qe):null,p=pe?!!Re[pe]:!1,T=async()=>{var ne;if(!qe||!B)return;const W=oa(qe);if(Re[W]){ue("This card was already checked.");return}let L=!1,we=null;if(B.kind==="question"){const G=B.definition;if(G.type==="selection"){const Q=Array.isArray(G.answer)?[...G.answer].sort((oe,le)=>oe-le):[],ge=[...We.selection].sort((oe,le)=>oe-le);L=Q.length===ge.length&&Q.every((oe,le)=>oe===ge[le])}else if(G.type==="truefalse")L=typeof G.answer=="boolean"&&We.booleanAnswer!==null&&G.answer===We.booleanAnswer;else if(G.type==="ordering"){const Q=(G.options??[]).join(`
`),ge=We.ordering.join(`
`),oe=Sa(Q,ge,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});L=oe.isCorrect,we=oe.mask}else if(G.type==="matching"){const Q=Math.max(2,((ne=G.columns)==null?void 0:ne.length)??2),ge=We.matchingRows.map(ze=>ze.slice(0,Q)).filter(ze=>ze.length===Q&&ze.every(Ke=>Number.isInteger(Ke)&&Ke>=0)).map(ze=>JSON.stringify(ze)),oe=(G.answer&&typeof G.answer=="object"&&"paths"in G.answer?G.answer.paths:[]).map(ze=>JSON.stringify(ze)),le=Array.from(new Set(ge)).sort(),Ce=Array.from(new Set(oe)).sort();L=le.length===Ce.length&&le.every((ze,Ke)=>ze===Ce[Ke])}else{const Q=String(G.answer??""),ge=Sa(Q,de,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!1});L=ge.isCorrect,we=ge.mask}Te(we),Y(!0)}else{const G=B.expected,Q=B.kind==="citation-fragment",ge=Sa(G,de,{thresholdPercent:Q?90:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:Q});L=ge.isCorrect,Te(ge.mask),Y(!0)}U(L?"correct":"incorrect"),K(G=>G+1),ue(l?null:"Answer checked locally (not saved: no person selected)."),Me(G=>({...G,[W]:!0})),l&&await te(L)},P=()=>{if(!qe||!B)return;const W=oa(qe);if(Re[W]||(Me(we=>({...we,[W]:!0})),ue("Answer revealed (not saved).")),B.kind==="question"){Te(null);return}const L=Sa(B.expected,B.expected,{thresholdPercent:100,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:B.kind==="citation-fragment"});Te(L.mask)},V=n.useMemo(()=>qe?qe.infoType==="question"?{...qe,description:qe.label}:qe.infoType==="citation"?{...qe,description:d}:{...qe,description:qe.label}:null,[qe,d]),Z=W=>{var dt,yt;const L=W.definition,we=p||J,ne=Array.isArray(L.answer)?L.answer:[],G=L.answer&&typeof L.answer=="object"&&"paths"in L.answer?L.answer.paths:[],Q=Math.max(2,((dt=L.columns)==null?void 0:dt.length)??2),ge=L.type==="matching"?We.matchingRows.filter(He=>He.length===Q&&He.every(_e=>Number.isInteger(_e)&&_e>=0)):[],oe=Array.from({length:Q},(He,_e)=>We.matchingSelection[_e]??null),le=He=>He.join("|"),Ce=new Map;for(const He of G){const _e=le(He);Ce.set(_e,(Ce.get(_e)??0)+1)}const ze=new Map;for(const He of ge){const _e=le(He);ze.set(_e,(ze.get(_e)??0)+1)}const Ke=G.filter(He=>{const _e=le(He),mt=ze.get(_e)??0;return mt>0?(ze.set(_e,mt-1),!1):!0}),Ee=new Map;for(const He of Ke)He.forEach((_e,mt)=>{const nt=Ee.get(mt)??new Map;nt.set(_e,(nt.get(_e)??0)+1),Ee.set(mt,nt)});const bt=(He,_e)=>{we||Ae(mt=>{var St;const nt=Math.max(2,((St=L.columns)==null?void 0:St.length)??2),pt=Array.from({length:nt},(ut,Kt)=>mt.matchingSelection[Kt]??null);if(pt[He]=pt[He]===_e?null:_e,pt.some(ut=>ut==null))return{...mt,matchingSelection:pt};const Bt=pt.map(ut=>Number(ut)),It=le(Bt),Nt=mt.matchingRows.filter(ut=>le(ut)===It).length;return(Ce.get(It)??0)>Nt?(U("correct"),K(ut=>ut+1),ue(null),{...mt,matchingRows:[...mt.matchingRows,Bt],matchingSelection:new Array(nt).fill(null)}):(U("incorrect"),K(ut=>ut+1),ue("This path is not valid or has already been used."),{...mt,matchingSelection:new Array(nt).fill(null)})})};return e.jsxs("div",{className:"cogita-revision-body",children:[e.jsx("h2",{children:L.question||(qe==null?void 0:qe.label)}),L.title?e.jsx("p",{className:"cogita-revision-hint",children:L.title}):null,L.type==="selection"?e.jsx("div",{className:"cogita-choice-grid",style:{gridTemplateColumns:"1fr"},children:(L.options??[]).map((He,_e)=>e.jsxs("label",{className:"cogita-field",style:{display:"flex",alignItems:"center",gap:"0.6rem"},children:[e.jsx("input",{type:"checkbox",checked:We.selection.includes(_e),disabled:we,onChange:mt=>Ae(nt=>({...nt,selection:mt.target.checked?Array.from(new Set([...nt.selection,_e])):nt.selection.filter(pt=>pt!==_e)}))}),e.jsx("span",{children:He})]},`q-opt:${_e}`))}):null,L.type==="truefalse"?e.jsxs("div",{className:"cogita-form-actions",style:{justifyContent:"flex-start"},children:[e.jsx("button",{type:"button",className:"ghost","data-active":We.booleanAnswer===!0,disabled:we,onClick:()=>Ae(He=>({...He,booleanAnswer:!0})),children:"True"}),e.jsx("button",{type:"button",className:"ghost","data-active":We.booleanAnswer===!1,disabled:we,onClick:()=>Ae(He=>({...He,booleanAnswer:!1})),children:"False"})]}):null,L.type==="text"||L.type==="number"||L.type==="date"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.answerLabel}),e.jsx("input",{ref:rt,type:L.type==="date"?"date":"text",value:de,onChange:He=>ke(He.target.value),disabled:we,"data-state":C==="correct"?"correct":C==="incorrect"?"incorrect":void 0})]}):null,L.type==="ordering"?e.jsx("div",{style:{display:"grid",gap:"0.45rem"},children:We.ordering.map((He,_e)=>e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto auto",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(184,209,234,0.75)"},children:[_e+1,"."]}),e.jsx("span",{children:He}),e.jsx("button",{type:"button",className:"ghost",disabled:we||_e===0,onClick:()=>Ae(mt=>{const nt=[...mt.ordering];return[nt[_e-1],nt[_e]]=[nt[_e],nt[_e-1]],{...mt,ordering:nt}}),children:"Up"}),e.jsx("button",{type:"button",className:"ghost",disabled:we||_e>=We.ordering.length-1,onClick:()=>Ae(mt=>{const nt=[...mt.ordering];return[nt[_e+1],nt[_e]]=[nt[_e],nt[_e+1]],{...mt,ordering:nt}}),children:"Down"})]},`q-order:${_e}:${He}`))}):null,L.type==="matching"?e.jsxs("div",{style:{display:"grid",gap:"0.65rem"},children:[e.jsx("div",{style:{display:"grid",gap:"0.65rem",gridTemplateColumns:`repeat(${Math.max(2,((yt=L.columns)==null?void 0:yt.length)??2)}, minmax(0, 1fr))`,alignItems:"start"},children:(L.columns??[]).map((He,_e)=>e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.35rem",padding:"0.6rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:`Column ${_e+1}`}),He.map((mt,nt)=>{var pt;return e.jsxs("button",{type:"button",className:"ghost cogita-checkcard-row",style:{textAlign:"left"},disabled:we||oe[_e]!==nt&&(((pt=Ee.get(_e))==null?void 0:pt.get(nt))??0)<=0,"data-active":oe[_e]===nt?"true":void 0,onClick:()=>bt(_e,nt),children:[e.jsx("span",{children:mt}),e.jsx("small",{children:nt})]},`q-col:${_e}:${nt}`)})]},`q-col:${_e}`))}),e.jsxs("div",{style:{display:"grid",gap:"0.4rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:"Selected paths"}),ge.length?ge.map((He,_e)=>e.jsxs("div",{className:"cogita-share-row",style:{alignItems:"center"},children:[e.jsx("span",{children:He.map((mt,nt)=>{var Bt,It;const pt=String(((It=(Bt=L.columns)==null?void 0:Bt[nt])==null?void 0:It[mt])??mt);return`${nt>0?" -> ":""}${pt}`})}),we?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>Ae(mt=>({...mt,matchingRows:mt.matchingRows.filter((nt,pt)=>pt!==_e)})),children:"Remove"})]},`q-path:${_e}`)):e.jsx("p",{className:"cogita-library-hint",children:"Choose one option in each column. After the last column is selected, the path is checked automatically."})]})]}):null,e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>void T(),disabled:we,children:t.cogita.library.revision.checkAnswer})}),J?e.jsxs("div",{className:"cogita-revision-answer",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.correctAnswerLabel}),L.type==="selection"?e.jsx("p",{children:ne.length?ne.map(He=>{var _e;return`${He}${(_e=L.options)!=null&&_e[He]?`: ${L.options[He]}`:""}`}).join(", "):"-"}):L.type==="truefalse"?e.jsx("p",{children:String(!!L.answer)}):L.type==="ordering"?e.jsx("ol",{children:(L.options??[]).map((He,_e)=>e.jsx("li",{children:He},`ans-order:${_e}`))}):L.type==="matching"?e.jsx("div",{style:{display:"grid",gap:"0.35rem"},children:G.length?G.map((He,_e)=>e.jsx("p",{children:He.join(" → ")},`ans-path:${_e}`)):e.jsx("p",{children:"-"})}):e.jsx("p",{children:String(L.answer??"")})]}):e.jsx("div",{className:"cogita-revision-reveal",children:e.jsx("button",{type:"button",className:"ghost",onClick:()=>{Y(!0),P()},children:t.cogita.library.revision.showAnswer})})]})},fe=n.useMemo(()=>ee?it(t,ee):t.cogita.library.infoTypes.any,[t,ee]);return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,children:e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-info-checkcards-page",children:[e.jsxs("header",{className:"cogita-info-checkcards-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:fe}),e.jsx("h2",{className:"cogita-card-title",children:d}),e.jsx("p",{className:"cogita-card-subtitle",children:f})]}),e.jsxs("div",{className:"cogita-selection-overview",children:[e.jsx("span",{className:"cogita-tag-chip",children:`Cards: ${m.length}`}),e.jsx("span",{className:"cogita-tag-chip",children:`Dependencies: ${A.length}`}),e.jsx("button",{type:"button",className:"cta",disabled:m.length===0,onClick:()=>at(`/cogita/library/${c}/revision/run?libraryTarget=revisions&scope=info&infoId=${encodeURIComponent(f)}`),children:"Start revision"})]})]}),b==="loading"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Loading checkcards..."})}):b==="error"?e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:"Failed to load checkcards."})}):e.jsxs("div",{className:"cogita-info-checkcards-layout",children:[e.jsxs("div",{className:"cogita-info-checkcards-main",children:[e.jsx("div",{className:"cogita-info-checkcards-graph",children:e.jsxs(fn,{nodes:Ie,edges:et,fitView:!0,nodesDraggable:!1,nodesConnectable:!1,elementsSelectable:!0,onNodeClick:(W,L)=>k(L.id),panOnDrag:!0,children:[e.jsx(bn,{}),e.jsx(yn,{showInteractive:!1})]})}),qe?e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[B&&V?e.jsx(Fa,{flashState:C,flashTick:O,children:B.kind==="question"?Z(B):e.jsx(ss,{copy:t,currentCard:V,currentTypeLabel:"",prompt:B.kind==="citation-fragment"?null:B.prompt,languages:[],answer:de,onAnswerChange:ke,computedExpected:[],computedAnswers:tt,onComputedAnswerChange:(W,L)=>ot(we=>({...we,[W]:L})),answerTemplate:null,outputVariables:null,variableValues:null,computedFieldFeedback:$e,feedback:C,canAdvance:!1,quoteContext:B.kind==="citation-fragment"?B.quoteContext:null,quotePlaceholder:B.kind==="citation-fragment"?B.quotePlaceholder:null,onCheckAnswer:()=>void T(),onSkip:()=>k(null),onLanguageSelect:()=>{},onMarkReviewed:()=>{},onAdvance:()=>{},showCorrectAnswer:J,setShowCorrectAnswer:Y,onRevealCorrect:P,answerMask:ye,expectedAnswer:B.expected,hasExpectedAnswer:!0,handleComputedKeyDown:()=>{},answerInputRef:rt,computedInputRefs:gt,scriptMode:Oe,setScriptMode:kt,matchPairs:void 0,matchLeftOrder:void 0,matchRightOrder:void 0,matchSelection:void 0,matchActiveLeft:null,matchActiveRight:null,matchFeedback:void 0,onMatchLeftSelect:void 0,onMatchRightSelect:void 0,disableCheckAnswer:p||J,hideSkipAction:!0,allowRevealBeforeCheck:!0,autoRevealAfterAnswer:!0,disableCheckAfterAnswer:!0})}):null,l?null:e.jsx("p",{className:"cogita-library-hint",children:"Result can be checked without a person; saving knowness requires a selected person in the header."}),Je?e.jsx("p",{className:"cogita-library-hint",children:Je}):null]}):e.jsxs("div",{className:"cogita-info-checkcards-selected",children:[e.jsx("h4",{children:"Select a checking card"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Choose a node in the dependency tree to preview and answer it."})]})]}),e.jsxs("aside",{className:"cogita-info-checkcards-panel",children:[e.jsx("h3",{children:"Checking cards"}),e.jsx("div",{className:"cogita-info-tree",children:m.map(W=>{const L=oa(W),we=R===L;return e.jsxs("button",{type:"button",className:`ghost cogita-checkcard-row ${we?"active":""}`,onClick:()=>k(L),children:[e.jsx("span",{children:W.label}),e.jsx("small",{children:Bs(W)})]},L)})})]})]})]})})})})})}function tn(t,a){var s,r;return((r=(s=t.fields.find(i=>i.fieldType===a))==null?void 0:s.plainValue)==null?void 0:r.trim())??""}function Bi(t){return tn(t,"role_kind").toLowerCase()==="person"}function Vi(t){return tn(t,"label")||tn(t,"display_name")||tn(t,"name")||t.roleId}function Oi({copy:t,onPersonCreated:a}){const[s,r]=n.useState([]),[i,u]=n.useState("loading"),[o,j]=n.useState(null),[g,x]=n.useState(!1),[c,f]=n.useState(""),l=async()=>{u("loading");try{const m=await er();r(m),u("ready")}catch{r([]),u("error")}};n.useEffect(()=>{l()},[]);const d=n.useMemo(()=>s.filter(Bi).map(m=>({roleId:m.roleId,label:Vi(m)})).sort((m,S)=>m.label.localeCompare(S.label)),[s]),w=async()=>{const m=c.trim();if(!m){j("Name is required.");return}x(!0),j(null);try{const S=await Ar({fields:[{fieldType:"nick",plainValue:m},{fieldType:"role_kind",plainValue:"person"},{fieldType:"label",plainValue:m},{fieldType:"display_name",plainValue:m}]});f(""),j("Person role created."),a==null||a(S.roleId),await l()}catch{j("Failed to create person role.")}finally{x(!1)}};return e.jsx("section",{className:"cogita-library-dashboard","data-mode":"detail",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-browser-panel",children:[e.jsx("div",{className:"cogita-info-overview-head",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Cogita"}),e.jsx("h2",{className:"cogita-card-title",children:"Persons"}),e.jsx("p",{className:"cogita-card-subtitle",children:"Select reviewer persons in the header and create new person roles here."})]})}),e.jsxs("div",{className:"cogita-info-overview-panels",children:[e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Create"}),e.jsx("h3",{className:"cogita-detail-title",children:"New person role"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:"Name"}),e.jsx("input",{type:"text",value:c,onChange:m=>f(m.target.value),placeholder:"e.g. Anna Kowalska",disabled:g})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:w,disabled:g,children:g?"Creating...":"Create person"})}),o?e.jsx("p",{className:"cogita-library-hint",children:o}):null]})]}),e.jsxs("article",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Overview"}),e.jsx("h3",{className:"cogita-detail-title",children:"All person roles"})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[i==="loading"?e.jsx("p",{children:"Loading persons..."}):null,i==="error"?e.jsx("p",{children:"Failed to load persons."}):null,i==="ready"&&d.length===0?e.jsx("p",{children:"No person roles found."}):null,i==="ready"&&d.length>0?e.jsxs("div",{className:"cogita-details-grid",children:[e.jsxs("div",{className:"cogita-details-grid-head",role:"row",children:[e.jsx("span",{}),e.jsx("span",{children:"Name"}),e.jsx("span",{children:"Type"}),e.jsx("span",{children:"Role ID"}),e.jsx("span",{})]}),d.map(m=>e.jsxs("div",{className:"cogita-details-row",role:"row",children:[e.jsx("span",{}),e.jsx("span",{title:m.label,children:m.label}),e.jsx("span",{children:"person"}),e.jsx("span",{title:m.roleId,children:m.roleId}),e.jsx("span",{})]},m.roleId))]}):null]})]})]})]})})})})}function qi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,libraryId:c,collectionId:f}){const{libraryName:l}=ua(c),[d,w]=n.useState([]),[m,S]=n.useState("loading"),[A,v]=n.useState("idle"),b=n.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),X=`/#/cogita/library/${c}`,R=()=>{S("loading"),tr({libraryId:c}).then(N=>{w(N),S("idle")}).catch(()=>{w([]),S("error")})};n.useEffect(()=>{R()},[c]);const k=async N=>{try{await ar({libraryId:c,shareId:N}),R()}catch{R()}},D=async N=>{const ee=`${b}/${N}`;try{await navigator.clipboard.writeText(ee),v("copied")}catch{v("failed")}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.shareTitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:X,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${X}/collections`,children:t.cogita.library.actions.collections})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsx("div",{className:"cogita-library-grid",children:e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[m==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):m==="error"?e.jsx("p",{children:t.cogita.library.revision.shareError}):d.filter(N=>!f||N.collectionId===f).length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:d.filter(N=>!f||N.collectionId===f).map(N=>e.jsxs("div",{className:"cogita-share-row","data-state":N.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:N.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(N.createdUtc).toLocaleString(),N.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]}),N.shareCode?e.jsx("div",{className:"cogita-share-meta",children:`${b}/${N.shareCode}`}):null]}),N.revokedUtc?null:e.jsxs("div",{className:"cogita-detail-actions",children:[N.shareCode?e.jsx("button",{type:"button",className:"ghost",onClick:()=>D(N.shareCode),children:t.cogita.library.revision.shareCopyAction}):null,e.jsx("button",{type:"button",className:"ghost",onClick:()=>k(N.shareId),children:t.cogita.library.revision.shareRevokeAction})]})]},N.shareId))}),A==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):A==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]})]})})})})})]})})}function Ui({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,libraryId:c}){const{libraryName:f}=ua(c),[l,d]=n.useState(null),[w,m]=n.useState(null),[S,A]=n.useState(null),[v,b]=n.useState(null),[X,R]=n.useState(null),[k,D]=n.useState(null),N=n.useRef(null),ee=H=>{if(!Number.isFinite(H))return"0 B";if(H<1024)return`${H} B`;const de=H/1024;if(de<1024)return`${de.toFixed(1)} KB`;const ke=de/1024;return ke<1024?`${ke.toFixed(1)} MB`:`${(ke/1024).toFixed(1)} GB`},F=async()=>{d(null),R({loadedBytes:0,totalBytes:null,percent:null});try{d(t.cogita.library.overview.exporting);const H=await Rr(c,R),de=URL.createObjectURL(H),ke=document.createElement("a");ke.href=de,ke.download=`cogita-library-${f||c}.json`,ke.click(),URL.revokeObjectURL(de),d(t.cogita.library.overview.exportReady)}catch{d(t.cogita.library.overview.exportFail)}finally{R(H=>H??{loadedBytes:0,totalBytes:null,percent:null})}},M=async H=>{var ke;m(null),A(null),b(null);const de=(ke=H.target.files)==null?void 0:ke[0];if(de)try{m(t.cogita.library.overview.importing),D({loadedBytes:0,totalBytes:de.size,percent:0});const Je=await $r(c,de,D,ue=>{const $=ue.stage==="infos"?t.cogita.library.overview.importStageInfos:ue.stage==="connections"?t.cogita.library.overview.importStageConnections:t.cogita.library.overview.importStageCollections;b(t.cogita.library.overview.importLiveProgress.replace("{stage}",$).replace("{done}",String(ue.processed)).replace("{total}",String(ue.total)).replace("{infos}",String(ue.infos)).replace("{connections}",String(ue.connections)).replace("{collections}",String(ue.collections)))});A({infos:Je.infosImported,connections:Je.connectionsImported,collections:Je.collectionsImported}),m(t.cogita.library.overview.importDone)}catch(Je){const ue=Je instanceof as&&Je.message?` ${Je.message}`:"";m(`${t.cogita.library.overview.importFail}${ue}`)}finally{N.current&&(N.current.value="")}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:f}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.overview.transferTitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("div",{children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.overview.transferTitle})})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.overview.transferBody}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:F,children:t.cogita.library.overview.export}),e.jsxs("label",{className:"cta ghost cogita-file-button",children:[t.cogita.library.overview.import,e.jsx("input",{ref:N,type:"file",accept:"application/json",onChange:M})]})]}),X?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:X.percent??void 0,max:X.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.exportProgress.replace("{loaded}",ee(X.loadedBytes)).replace("{total}",X.totalBytes?ee(X.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,k?e.jsxs("div",{className:"cogita-progress",children:[e.jsx("progress",{value:k.percent??void 0,max:k.totalBytes?100:void 0}),e.jsx("span",{children:t.cogita.library.overview.importProgress.replace("{loaded}",ee(k.loadedBytes)).replace("{total}",k.totalBytes?ee(k.totalBytes):t.cogita.library.overview.progressUnknown)})]}):null,l?e.jsx("p",{className:"cogita-help",children:l}):null,w?e.jsx("p",{className:"cogita-help",children:w}):null,v?e.jsx("p",{className:"cogita-help",children:v}):null,S?e.jsx("p",{className:"cogita-help",children:t.cogita.library.overview.importSummary.replace("{infos}",String(S.infos)).replace("{connections}",String(S.connections)).replace("{collections}",String(S.collections))}):null]})]})})})]})})}function Ji({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,libraryId:c}){const{libraryName:f}=ua(c),[l,d]=n.useState(""),[w,m]=n.useState([]),S=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:f}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.storyboardsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.storyboardsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:A=>d(A.target.value),placeholder:t.cogita.library.modules.storyboardsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const A=l.trim();A&&(m(v=>[{id:S(),name:A},...v]),d(""))},children:t.cogita.library.modules.storyboardsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.storyboardsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[w.length===0?e.jsx("p",{children:t.cogita.library.modules.storyboardsEmpty}):null,w.map(A=>e.jsx("button",{type:"button",className:"ghost",children:A.name},A.id))]})]})]})})})]})})}function Hi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,libraryId:c}){const{libraryName:f}=ua(c),[l,d]=n.useState(""),[w,m]=n.useState([]),S=()=>`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsx("header",{className:"cogita-library-dashboard-header",children:e.jsxs("div",{children:[e.jsx("h1",{className:"cogita-library-title",children:f}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.modules.textsSubtitle})]})}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsTitle})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.modules.textsNewLabel}),e.jsx("input",{type:"text",value:l,onChange:A=>d(A.target.value),placeholder:t.cogita.library.modules.textsNewPlaceholder})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:()=>{const A=l.trim();A&&(m(v=>[{id:S(),name:A},...v]),d(""))},children:t.cogita.library.modules.textsCreate})}),e.jsx("p",{className:"cogita-help",children:t.cogita.library.modules.draftInfo})]})]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.modules.textsExisting})}),e.jsxs("div",{className:"cogita-detail-body",children:[w.length===0?e.jsx("p",{children:t.cogita.library.modules.textsEmpty}):null,w.map(A=>e.jsx("button",{type:"button",className:"ghost",children:A.name},A.id))]})]})]})})})]})})}function Wi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,libraryId:c}){const{libraryName:f}=ua(c),l=`/#/cogita/library/${c}`,[d,w]=n.useState(""),[m,S]=n.useState([]),[A,v]=n.useState("idle"),[b,X]=n.useState(0),[R,k]=n.useState(null);n.useEffect(()=>{v("loading");const N=window.setTimeout(()=>{Ua({libraryId:c,query:d.trim()||void 0,limit:30}).then(ee=>{S(ee.items),X(ee.total),k(ee.nextCursor??null),v("ready")}).catch(()=>{S([]),X(0),k(null),v("ready")})},240);return()=>window.clearTimeout(N)},[c,d]);const D=async()=>{if(R){v("loading");try{const N=await Ua({libraryId:c,query:d.trim()||void 0,limit:30,cursor:R});S(ee=>[...ee,...N.items]),k(N.nextCursor??null),X(N.total),v("ready")}catch{v("ready")}}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"list",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h1",{className:"cogita-library-title",children:f}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.listSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta",href:`${l}/collections/new`,children:t.cogita.library.actions.createCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:d,onChange:N=>w(N.target.value),placeholder:t.cogita.library.collections.searchPlaceholder})})]})}),e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:t.cogita.library.collections.countLabel.replace("{shown}",String(m.length)).replace("{total}",String(b||m.length))}),e.jsx("span",{children:A==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:m.length?m.map(N=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("a",{className:"cogita-card-select",href:`${l}/collections/${N.collectionId}`,children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.library.collections.collectionLabel}),e.jsx("h3",{className:"cogita-card-title",children:N.name}),e.jsxs("p",{className:"cogita-card-subtitle",children:[t.cogita.library.collections.itemCountLabel.replace("{count}",String(N.itemCount))," ·"," ",N.notes||t.cogita.library.collections.noNotes]})]})},N.collectionId)):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.collections.emptyTitle}),e.jsx("a",{className:"ghost",href:`${l}/collections/new`,children:t.cogita.library.collections.emptyAction})]})}),R?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:D,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.listKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})})]})})]})})})]})})}const Se=t=>`${t.cardType}:${t.cardId}:${t.checkType??""}:${t.direction??""}`,ta=(t,a,s,r)=>`${t}:${a}:${s??""}:${r??""}`;function Qi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,libraryId:c,collectionId:f}){ua(c);const l=`/#/cogita/library/${c}`,[d,w]=n.useState(t.cogita.library.collections.defaultName),[m,S]=n.useState(null),[A,v]=n.useState(0),[b,X]=n.useState([]),[R,k]=n.useState("idle"),[D,N]=n.useState(null),ee=n.useMemo(()=>t.cogita.library.list.cardCount.replace("{shown}",String(b.length)).replace("{total}",String(A||b.length)),[t,b.length,A]);n.useEffect(()=>{xn(c,f).then(M=>{w(M.name),S(M.notes??null),v(M.itemCount)}).catch(()=>{w(t.cogita.library.collections.defaultName),S(null)})},[c,f]),n.useEffect(()=>{k("loading"),Ja({libraryId:c,collectionId:f,limit:40}).then(M=>{X(M.items),N(M.nextCursor??null),v(M.total),k("ready")}).catch(()=>{X([]),N(null),k("ready")})},[c,f]);const F=async()=>{if(D){k("loading");try{const M=await Ja({libraryId:c,collectionId:f,limit:40,cursor:D});X(H=>[...H,...M.items]),N(M.nextCursor??null),v(M.total),k("ready")}catch{k("ready")}}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h1",{className:"cogita-library-title",children:d}),e.jsx("p",{className:"cogita-library-subtitle",children:m||t.cogita.library.collections.detailSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:l,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${l}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${l}/collections/${f}/graph`,children:t.cogita.library.graph.kicker}),e.jsx("a",{className:"cta",href:`${l}/collections/${f}/revision`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsxs("div",{className:"cogita-library-pane",children:[e.jsxs("div",{className:"cogita-card-count",children:[e.jsx("span",{children:ee}),e.jsx("span",{children:R==="loading"?t.cogita.library.collections.loading:t.cogita.library.collections.ready})]}),e.jsx("div",{className:"cogita-card-list","data-view":"list",children:b.length?b.map(M=>e.jsx("div",{className:"cogita-card-item",children:e.jsxs("div",{className:"cogita-card-select",children:[e.jsx("div",{className:"cogita-card-type",children:M.cardType==="vocab"?t.cogita.library.list.cardTypeVocab:M.cardType==="connection"?t.cogita.library.list.cardTypeConnection:t.cogita.library.list.cardTypeInfo}),e.jsx("h3",{className:"cogita-card-title",children:M.label}),e.jsx("p",{className:"cogita-card-subtitle",children:M.description})]})},Se(M))):e.jsx("div",{className:"cogita-card-empty",children:e.jsx("p",{children:t.cogita.library.collections.noCards})})}),D?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:F,children:t.cogita.library.list.loadMore})}):null]}),e.jsx("div",{className:"cogita-library-panel",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.detailKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.collections.detailFocusTitle})]})}),e.jsx("div",{className:"cogita-detail-body",children:e.jsx("p",{children:t.cogita.library.collections.detailFocusBody})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:`${l}/collections/${f}/revision`,children:t.cogita.library.actions.startRevision})})]})})]})})})]})})}const Vs=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],Gi={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},Yi=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],Xi=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function Zi({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,libraryId:c,onCreated:f}){const l=Ea(),{libraryName:d}=ua(c),w=`/#/cogita/library/${c}`,[m,S]=n.useState(null),[A,v]=n.useState(""),[b,X]=n.useState(""),[R,k,D]=Gn([]),[N,ee,F]=Yn([]),[M,H]=n.useState(null),[de,ke]=n.useState(null),Je=n.useRef(null),ue=n.useMemo(()=>R.find(O=>O.id===M)??null,[R,M]);n.useEffect(()=>{const O=new URLSearchParams(l.search),K=(O.get("draft")??"").trim(),J=(O.get("draftType")??"").trim();if(!K||J!=="info-selection"||Je.current===K)return;const Y=ji(c,K);if(!Y||Y.infoIds.length===0)return;const ye=crypto.randomUUID(),Te=Y.infoIds.length>1?crypto.randomUUID():null,Re=Y.infoIds.map(($e,Oe)=>({id:crypto.randomUUID(),type:"default",position:{x:80,y:80+Oe*100},data:{nodeType:"source.info",label:"Selected info",params:{infoId:$e,infoType:"any"}}})),Me=Te?[{id:Te,type:"default",position:{x:360,y:120+Math.max(0,(Y.infoIds.length-1)*50)},data:{nodeType:"logic.or",label:"Selected infos",params:{}}}]:[],tt={id:ye,type:"default",position:{x:660,y:140+Math.max(0,(Y.infoIds.length-1)*35)},data:{nodeType:"output.collection",label:"Collection output",params:{}}},ot=Re.map($e=>({id:crypto.randomUUID(),source:$e.id,target:Te??ye}));Te&&ot.push({id:crypto.randomUUID(),source:Te,target:ye}),k([...Re,...Me,tt]),ee(ot),H(ye),ke(`Draft loaded from ${Y.infoIds.length} selected infos. Set name and save to create collection.`),Je.current=K},[c,l.search,ee,k]);const $=O=>{var ye;const K=crypto.randomUUID(),J=((ye=Vs.find(Te=>Te.type===O))==null?void 0:ye.label)??O,Y={...Gi[O]};k(Te=>[...Te,{id:K,type:"default",position:{x:120+Te.length*40,y:120+Te.length*40},data:{nodeType:O,label:J,params:Y}}]),H(K)},be=n.useCallback(O=>{ee(K=>Xn({...O,id:crypto.randomUUID()},K))},[ee]),C=O=>{ue&&k(K=>K.map(J=>J.id===ue.id?{...J,data:{...J.data,params:O}}:J))},U=async()=>{if(ke(null),!A.trim()){ke(t.cogita.library.collections.saveRequiredName);return}try{const O={nodes:R.map(Y=>({nodeId:Y.id,nodeType:Y.data.nodeType,payload:{position:Y.position,params:Y.data.params}})),edges:N.map(Y=>({edgeId:Y.id,fromNodeId:Y.source,fromPort:Y.sourceHandle??null,toNodeId:Y.target,toPort:Y.targetHandle??null}))};let K=m,J=!1;if(K)await nr({libraryId:c,collectionId:K,nodes:O.nodes,edges:O.edges});else{const Y=await Pr({libraryId:c,name:A.trim(),notes:b.trim()||void 0,items:[],graph:O});K=Y.collectionId,J=!0,S(Y.collectionId)}ke(J?t.cogita.library.collections.saveSuccess:t.cogita.library.graph.saveSuccess),f(K)}catch{ke(m?t.cogita.library.graph.saveFail:t.cogita.library.collections.saveFail)}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.createKicker}),e.jsx("h1",{className:"cogita-library-title",children:d}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.collections.createSubtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:w,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${w}/collections`,children:t.cogita.library.actions.collections}),e.jsx("button",{type:"button",className:"cta",onClick:U,children:t.cogita.library.actions.saveCollection})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.collections.collectionInfoTitle}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.nameLabel}),e.jsx("input",{value:A,onChange:O=>v(O.target.value),placeholder:t.cogita.library.collections.namePlaceholder})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.collections.notesLabel}),e.jsx("textarea",{value:b,onChange:O=>X(O.target.value),placeholder:t.cogita.library.collections.notesPlaceholder})]}),de?e.jsx("p",{className:"cogita-help",children:de}):null,e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Vs.map(O=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>$(O.type),children:O.label},O.type))})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(fn,{nodes:R,edges:N,onNodesChange:D,onEdgesChange:F,onConnect:be,onNodeClick:(O,K)=>H(K.id),fitView:!0,children:[e.jsx(bn,{color:"rgba(120,160,200,0.2)"}),e.jsx(yn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),ue?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:ue.data.label}),ue.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Xt,{libraryId:c,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:ue.data.params.tagId?{id:ue.data.params.tagId,label:ue.data.params.tagLabel??"",infoType:"topic"}:null,onChange:O=>C({...ue.data.params,tagId:(O==null?void 0:O.id)??null,tagLabel:(O==null?void 0:O.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:ue.data.params.scope??"any",onChange:O=>C({...ue.data.params,scope:O.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),ue.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Xt,{libraryId:c,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:ue.data.params.languageId?{id:ue.data.params.languageId,label:ue.data.params.languageLabel??"",infoType:"language"}:null,onChange:O=>C({...ue.data.params,languageId:(O==null?void 0:O.id)??null,languageLabel:(O==null?void 0:O.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:ue.data.params.scope??"any",onChange:O=>C({...ue.data.params,scope:O.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),ue.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:ue.data.params.infoType??"word",onChange:O=>C({...ue.data.params,infoType:O.target.value}),children:Xi.map(O=>e.jsx("option",{value:O.value,children:O.label},O.value))})]}),e.jsx(Xt,{libraryId:c,infoType:ue.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:ue.data.params.infoId?{id:ue.data.params.infoId,label:ue.data.params.infoLabel??"",infoType:ue.data.params.infoType??"word"}:null,onChange:O=>C({...ue.data.params,infoId:(O==null?void 0:O.id)??null,infoLabel:(O==null?void 0:O.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),ue.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:ue.data.params.connectionType??"translation",onChange:O=>C({...ue.data.params,connectionType:O.target.value}),children:Yi.map(O=>e.jsx("option",{value:O.value,children:O.label},O.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:ue.data.params.connectionId??"",onChange:O=>C({...ue.data.params,connectionId:O.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(ue.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const ca=t=>{if(!t.length)return{score:0,total:0,correct:0,lastReviewedUtc:null};const a=t.length,s=t.filter(u=>u.correct).length,r=jn(is(t));return{score:Math.round(Math.max(0,Math.min(100,r.knowness*100))*100)/100,total:a,correct:s,lastReviewedUtc:r.lastReviewedUtc??null}},eo=t=>{if(t.maskBase64)try{const a=Er(t.maskBase64);if(!a.length)return t.correct?1:0;const s=a.reduce((r,i)=>r+i,0);return Math.max(0,Math.min(1,s/a.length/255))}catch{return t.correct?1:0}return t.correct?1:0},is=t=>t.map(a=>({correctness:eo(a),createdUtc:a.createdUtc})),jn=(t,a=Date.now())=>{var A;if(!t.length)return{knowness:0,avgCorrectness:0,lastReviewedUtc:null};const r=t.slice().sort((v,b)=>v.createdUtc.localeCompare(b.createdUtc)).slice(-5),i=r.reduce((v,b)=>v+b.correctness,0)/r.length,u=5,o=2,j=.15;let g=0,x=0;for(let v=0;v<r.length;v+=1){const b=new Date(r[v].createdUtc).getTime(),X=v===r.length-1?a:new Date(r[v+1].createdUtc).getTime(),R=Math.max(0,(X-b)/(1e3*60)),k=1-Math.exp(-R/u);g+=k,r[v].correctness>.5&&(x+=j)}let c=i*g*o+x;const f=((A=r[r.length-1])==null?void 0:A.createdUtc)??null,l=f?Math.max(0,(a-new Date(f).getTime())/(1e3*60)):0,w=1/(1+Math.log1p(l/60));return c*=w,r.length===1&&r[0].correctness>.5&&(c+=5.44*Math.exp(-l/2)),{knowness:c,avgCorrectness:i,lastReviewedUtc:f}},Ha=t=>{const a=t.slice();for(let s=a.length-1;s>0;s-=1){const r=Math.floor(Math.random()*(s+1));[a[s],a[r]]=[a[r],a[s]]}return a},an=t=>t[Math.floor(Math.random()*t.length)],to=(t,a)=>{const s=new Map;return t.forEach(r=>s.set(r,Math.random())),t.sort((r,i)=>{const u=a(r)-a(i);return u!==0?u:(s.get(r)??0)-(s.get(i)??0)})},wn=(t,a,s,r,i)=>{if(!t.length)return null;const u=t.filter(j=>!(i!=null&&i.has(Se(j))));if(u.length===0)return null;const o=u.filter(j=>Se(j)!==s);return an(o.length?o:u)},ao=(t,a,s,r,i)=>{if(!t.length)return null;let u=Number.POSITIVE_INFINITY;for(const x of t){const c=Se(x);if(s.has(c))continue;const f=a[c]??1;f<u&&(u=f)}if(!Number.isFinite(u))return null;const o=t.filter(x=>{const c=Se(x);return!s.has(c)&&(a[c]??1)===u}),j=o.filter(x=>!i||Se(x)!==i),g=r?j.filter(x=>!r.has(Se(x))):j;return g.length>0?an(g):j.length>0?an(j):i&&o.some(x=>Se(x)===i)?o.find(x=>Se(x)===i)??null:o.length?an(o):null},ur=(t,a,s,r,i)=>{const u=[],o=t.filter(g=>!i.has(Se(g))&&!s.has(Se(g))&&(a[Se(g)]??0)<1),j=to(o,g=>a[Se(g)]??0);for(const g of j){if(u.length>=r)break;u.push(g),i.add(Se(g))}if(u.length<r){const g=Ha(t.filter(x=>!i.has(Se(x))&&s.has(Se(x))));for(const x of g){if(u.length>=r)break;u.push(x),i.add(Se(x))}}return u},no=(t,a,s,r)=>ur(t,a,s,r,new Set),os=(t,a,s,r,i,u)=>{const o=Math.max(1,s.stackSize??a),g=Ha(t).filter((w,m,S)=>S.findIndex(A=>Se(A)===Se(w))===m),x=no(g,r,i,o),c=new Set,f=new Set,l=wn(x,{},null,c,f),d=l?[l]:[];return l&&f.add(Se(l)),{queue:d,meta:{pool:g,active:x,knownessMap:r,unknownSet:i,outcomesById:u,asked:c,queued:f}}},Qn={id:"random",labelKey:"modeValue",defaultSettings:{tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:t=>t,prepare:(t,a)=>{const r=Ha(t).filter((i,u,o)=>o.findIndex(j=>Se(j)===Se(i))===u);return{queue:r.slice(0,Math.min(a,r.length)),meta:{}}},applyOutcome:t=>t},ls=(t,a,s,r)=>{const i=Math.max(1,s.stackSize??a),o=Ha(t).filter((m,S,A)=>A.findIndex(v=>Se(v)===Se(m))===S),j={},g=new Set,x=new Set,c=new Set,f=Math.max(1,s.levels??1);o.forEach(m=>{const S=Se(m),A=r==null?void 0:r[S],v=typeof A=="number"&&Number.isFinite(A)?A:1;j[S]=Math.min(f,Math.max(1,Math.round(v)))});const l=[];if(o.length>0){const m=new Map;o.forEach(A=>{var b;const v=j[Se(A)]??1;m.has(v)||m.set(v,[]),(b=m.get(v))==null||b.push(A)});const S=Array.from(m.keys()).sort((A,v)=>A-v);for(const A of S){if(l.length>=i)break;const v=Ha(m.get(A)??[]);for(const b of v){if(l.length>=i)break;l.push(b)}}}const d=wn(l,j,null,g,x),w=d?[d]:[];return d&&x.add(Se(d)),{queue:w,meta:{pool:o,active:l,levelMap:j,asked:g,queued:x,wrongSinceCorrect:c}}},so={id:"levels",labelKey:"modeValueLevels",defaultSettings:{levels:5,stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"levels",labelKey:"levelsLabel",type:"number",min:1,max:20,step:1},{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"minCorrectness",labelKey:"minCorrectnessLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,a)=>Math.max(1,a.stackSize??t),getProgressTotal:()=>null,prepare:(t,a,s)=>ls(t,a,s),applyOutcome:(t,a,s,r,i)=>{if(!a)return t;const u=Math.max(1,r.levels??1),o=t.meta.pool??[],j=t.meta.active??[],g={...t.meta.levelMap??{}},x=new Set(t.meta.asked??[]),c=new Set(t.meta.queued??[]),f=new Set(t.meta.wrongSinceCorrect??[]),l=Se(a);c.delete(l),x.add(l);const d=g[l]??1;i.correct?(g[l]=f.has(l)?1:Math.min(d+1,u),f.delete(l)):(g[l]=1,f.add(l));const w=i.correct?j.filter(A=>Se(A)!==l):j.slice();if(i.correct&&w.length<Math.max(1,r.stackSize??1)){const A=new Set(w.map(b=>Se(b))),v=ao(o,g,A,x,l);v&&w.push(v)}const m=t.queue.slice(),S=wn(w,g,l,x,c);return S&&(m.push(S),c.add(Se(S))),{queue:m,meta:{pool:o,active:w,levelMap:g,asked:x,queued:c,wrongSinceCorrect:f}}}},ro={id:"temporal",labelKey:"modeValueTemporal",defaultSettings:{stackSize:20,tries:2,compare:"anchors",minCorrectness:70,considerDependencies:"on",dependencyThreshold:85},settingsFields:[{key:"stackSize",labelKey:"stackLabel",type:"number",min:1,max:200,step:1},{key:"tries",labelKey:"triesLabel",type:"number",min:1,max:10,step:1},{key:"dependencyThreshold",labelKey:"dependencyThresholdLabel",type:"number",min:0,max:100,step:1},{key:"considerDependencies",labelKey:"considerDependenciesLabel",type:"select",options:[{value:"on",labelKey:"considerDependenciesOn"},{value:"off",labelKey:"considerDependenciesOff"}]}],getFetchLimit:(t,a)=>Math.max(1,a.stackSize??t),getProgressTotal:()=>null,prepare:(t,a,s)=>os(t,a,s,{},new Set,{}),applyOutcome:(t,a,s,r,i)=>{if(!a)return t;const u=t.meta.pool??[],o=t.meta.active??[],j={...t.meta.knownessMap??{}},g=new Set(t.meta.unknownSet??[]),x={...t.meta.outcomesById??{}},c=new Set(t.meta.asked??[]),f=new Set(t.meta.queued??[]),l=Se(a);f.delete(l),c.add(l);const d={correctness:Math.max(0,Math.min(1,i.correctness??(i.correct?1:0))),createdUtc:i.createdUtc??new Date().toISOString()},m=(x[l]??[]).concat(d).sort((R,k)=>R.createdUtc.localeCompare(k.createdUtc)).slice(-5);x[l]=m,g.delete(l);const S=Date.now();u.forEach(R=>{const k=Se(R),D=x[k]??[];if(D.length===0){j[k]=0,g.add(k);return}const N=jn(D,S);j[k]=N.knowness});const A=o.slice();if((j[l]??0)>=1){const R=A.filter(k=>Se(k)!==l);A.length=0,A.push(...R)}const b=Math.max(1,r.stackSize??s);if(A.length<b){const R=new Set(A.map(D=>Se(D))),k=ur(u,j,g,b-A.length,R);A.push(...k)}const X=t.queue.slice();if(X.length===0||Se(X[X.length-1])===l){const R=wn(A,{},l,c,f);R&&(X.push(R),f.add(Se(R)))}return{queue:X,meta:{pool:u,active:A,knownessMap:j,unknownSet:g,outcomesById:x,asked:c,queued:f}}}},hr={random:Qn,levels:so,temporal:ro},io=Object.values(hr),cs=t=>{if(!t)return Qn;const a=t.trim().toLowerCase();return a==="random"||a==="levels"||a==="temporal"?hr[a]:Qn},kn=(t,a)=>{const s={...t.defaultSettings};return a&&Object.entries(a).forEach(([r,i])=>{typeof i=="number"&&Number.isFinite(i)&&(s[r]=i),typeof i=="string"&&(s[r]=i)}),t.settingsFields.forEach(r=>{var u;const i=s[r.key];if(r.type==="number"){if(typeof i!="number"||Number.isNaN(i)){s[r.key]=t.defaultSettings[r.key]??0;return}r.min!==void 0&&(s[r.key]=Math.max(r.min,s[r.key])),r.max!==void 0&&(s[r.key]=Math.min(r.max,s[r.key]));return}if(r.type==="select"){const o=((u=r.options)==null?void 0:u.map(j=>j.value))??[];(typeof i!="string"||o.length>0&&!o.includes(i))&&(s[r.key]=t.defaultSettings[r.key]??o[0]??"")}}),s},gr=(t,a)=>{const s={};return t.settingsFields.forEach(r=>{const i=a.get(r.key);if(i){if(r.type==="number"){const u=Number(i);Number.isNaN(u)||(s[r.key]=u);return}s[r.key]=i}}),kn(t,s)},oo=(t,a)=>{const s=new URLSearchParams;return t.settingsFields.forEach(r=>{const i=a[r.key];(typeof i=="number"||typeof i=="string")&&s.set(r.key,String(i))}),s};function Os({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,libraryId:c,collectionId:f,revisionId:l}){const d=Wa(),{libraryName:w}=ua(c),m=`/#/cogita/library/${c}`,[S,A]=n.useState(t.cogita.library.collections.defaultName),[v,b]=n.useState([]),[X,R]=n.useState(f??""),[k,D]=n.useState(""),[N,ee]=n.useState(20),[F,M]=n.useState("random"),[H,de]=n.useState({}),[ke,Je]=n.useState("exact"),[ue,$]=n.useState([]),[be,C]=n.useState(null),[U,O]=n.useState([]),[K,J]=n.useState([]),[Y,ye]=n.useState(""),[Te,Re]=n.useState("idle"),[Me,tt]=n.useState(null),[ot,$e]=n.useState("idle"),[Oe,kt]=n.useState("idle"),[We,Ae]=n.useState("idle"),rt=n.useMemo(()=>typeof window>"u"?"/#/cogita/public/revision":`${window.location.origin}/#/cogita/public/revision`,[]),gt=n.useMemo(()=>cs(F),[F]),at=n.useMemo(()=>kn(gt,H),[gt,H]),Ie=n.useMemo(()=>oo(gt,at).toString(),[gt,at]),Ue=n.useMemo(()=>{const p=Y.trim().toLocaleLowerCase();return p?K.filter(T=>T.name.toLocaleLowerCase().includes(p)):K},[Y,K]);n.useEffect(()=>{R(f??"")},[f]),n.useEffect(()=>{if(!X){A(t.cogita.library.collections.defaultName);return}xn(c,X).then(p=>A(p.name)).catch(()=>A(t.cogita.library.collections.defaultName))},[t.cogita.library.collections.defaultName,c,X]),n.useEffect(()=>{Ua({libraryId:c,limit:200}).then(p=>b(p.items.map(T=>({collectionId:T.collectionId,name:T.name})))).catch(()=>b([]))},[c]),n.useEffect(()=>{Zn({libraryId:c}).then(p=>J(p)).catch(()=>J([]))},[c]),n.useEffect(()=>{l&&ns({libraryId:c,revisionId:l}).then(p=>{R(p.collectionId),D(p.name),M(p.mode||"random"),Je(p.check||"exact"),ee(p.limit||20),de(p.revisionSettings??{})}).catch(()=>{D("")})},[c,l]),n.useEffect(()=>{sr({libraryId:c}).then(p=>{$(p),!be&&p.length>0&&C(p[0].roleId)}).catch(()=>{$([])})},[c]);const et=()=>{kt("loading"),tr({libraryId:c}).then(p=>{O(p),kt("idle")}).catch(()=>{O([]),kt("error")})};n.useEffect(()=>{et()},[c]);const qe=async()=>{Re("working"),$e("idle");try{if(!X){Re("error");return}const p=await Kr({libraryId:c,collectionId:X,revisionType:gt.id,revisionSettings:at,mode:F,check:ke,limit:N});tt(`${rt}/${p.shareCode}${Ie?`?${Ie}`:""}`),Re("ready"),et()}catch{Re("error")}},B=async()=>{if(l){Ae("saving");try{await Fr({libraryId:c,collectionId:f??X,revisionId:l,targetCollectionId:X,name:k||S,revisionType:gt.id,revisionSettings:at,mode:F,check:ke,limit:N}),Ae("saved"),X&&d(`/cogita/library/${c}/revisions/${encodeURIComponent(l)}`,{replace:!0})}catch{Ae("error")}}},te=async()=>{if(Me)try{await navigator.clipboard.writeText(Me),$e("copied")}catch{$e("failed")}},pe=async p=>{try{await ar({libraryId:c,shareId:p}),et()}catch{et()}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h1",{className:"cogita-library-title",children:S}),e.jsx("p",{className:"cogita-library-subtitle",children:w})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:m,children:t.cogita.library.actions.libraryOverview}),e.jsx("a",{className:"cta ghost",href:`${m}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:X?`${m}/collections/${X}`:`${m}/collections`,children:t.cogita.library.actions.collectionDetail}),e.jsx("a",{className:"cta",href:`${m}${l?`/revisions/${encodeURIComponent(l)}/run`:X?`/collections/${X}/revision/run`:"/revision/run"}?mode=${encodeURIComponent(F)}&check=${encodeURIComponent(ke)}&limit=${N}${Ie?`&${Ie}`:""}${be?`&reviewer=${encodeURIComponent(be)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane",children:e.jsx("div",{className:"cogita-library-controls",children:e.jsxs("div",{className:"cogita-library-search",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("div",{className:"cogita-search-field",children:e.jsx("input",{type:"text",value:Y,onChange:p=>ye(p.target.value),placeholder:t.cogita.workspace.revisionForm.namePlaceholder})}),e.jsxs("div",{className:"cogita-card-list","data-view":"list",children:[e.jsxs("a",{className:"cogita-card-select",href:`${m}/revisions/new`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:t.cogita.workspace.revisionForm.createAction})]}),Ue.map(p=>e.jsxs("a",{className:"cogita-card-select",href:`${m}/revisions/${encodeURIComponent(p.revisionId)}`,style:{display:"block"},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.workspace.layers.revision}),e.jsx("h3",{className:"cogita-card-title",children:p.name})]},p.revisionId))]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsx("select",{value:X,onChange:p=>R(p.target.value),children:v.map(p=>e.jsx("option",{value:p.collectionId,children:p.name},p.collectionId))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.workspace.revisionForm.nameLabel}),e.jsx("input",{value:k,onChange:p=>D(p.target.value)})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.modeLabel}),e.jsx("select",{value:F,onChange:p=>M(p.target.value),children:io.map(p=>e.jsx("option",{value:p.id,children:t.cogita.library.revision[p.labelKey]},p.id))})]}),gt.settingsFields.map(p=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision[p.labelKey]}),p.type==="select"?e.jsx("select",{value:String(at[p.key]??""),onChange:T=>de(P=>({...P,[p.key]:T.target.value})),children:(p.options??[]).map(T=>e.jsx("option",{value:T.value,children:t.cogita.library.revision[T.labelKey]},T.value))}):e.jsx("input",{type:"number",min:p.min,max:p.max,step:p.step,value:at[p.key]??0,onChange:T=>de(P=>({...P,[p.key]:Number(T.target.value||0)}))})]},p.key)),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.checkLabel}),e.jsx("input",{value:t.cogita.library.revision.checkValue,disabled:!0})]}),gt.id!=="levels"&&gt.id!=="temporal"?e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.cardsPerSessionLabel}),e.jsx("input",{type:"number",min:1,max:200,value:N,onChange:p=>ee(Number(p.target.value||1))})]}):null,e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.reviewerLabel}),e.jsx("select",{value:be??"",onChange:p=>C(p.target.value||null),children:ue.map(p=>e.jsx("option",{value:p.roleId,children:p.label},p.roleId))})]})]})})}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.settingsKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.previewTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.previewBody1}),e.jsx("p",{children:t.cogita.library.revision.previewBody2})]}),e.jsxs("div",{className:"cogita-form-actions",children:[l?e.jsx("button",{type:"button",className:"cta ghost",onClick:B,disabled:We==="saving",children:We==="saving"?"...":t.cogita.workspace.revisionForm.createAction}):null,e.jsx("a",{className:"cta",href:`${m}${l?`/revisions/${encodeURIComponent(l)}/run`:X?`/collections/${X}/revision/run`:"/revision/run"}?mode=${encodeURIComponent(F)}&check=${encodeURIComponent(ke)}&limit=${N}${Ie?`&${Ie}`:""}${be?`&reviewer=${encodeURIComponent(be)}`:""}${l?`&revisionId=${encodeURIComponent(l)}`:""}`,children:t.cogita.library.actions.startRevision}),l?e.jsx("a",{className:"cta ghost",href:`/#/cogita/live-revision-host/${encodeURIComponent(c)}/${encodeURIComponent(l)}`,children:"Live session"}):null,e.jsx("a",{className:"cta ghost",href:`/#/cogita/live-sessions/${encodeURIComponent(c)}`,children:"Active live sessions"})]}),We==="error"?e.jsx("p",{className:"cogita-help",children:"Failed to save revision."}):null]}),e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareKicker}),e.jsx("h3",{className:"cogita-detail-title",children:t.cogita.library.revision.shareTitle})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{children:t.cogita.library.revision.shareBody}),Me?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.revision.shareLinkLabel}),e.jsx("input",{value:Me,readOnly:!0})]}):null,Te==="error"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareError}):null,ot==="copied"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopied}):ot==="failed"?e.jsx("p",{className:"cogita-help",children:t.cogita.library.revision.shareCopyError}):null]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:qe,disabled:Te==="working",children:Te==="working"?t.cogita.library.revision.shareWorking:t.cogita.library.revision.shareAction}),Me?e.jsx("button",{type:"button",className:"cta ghost",onClick:te,children:t.cogita.library.revision.shareCopyAction}):null]}),e.jsxs("div",{className:"cogita-detail-body",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareListTitle}),Oe==="loading"?e.jsx("p",{children:t.cogita.library.revision.shareListLoading}):U.length===0?e.jsx("p",{children:t.cogita.library.revision.shareListEmpty}):e.jsx("div",{className:"cogita-share-list",children:U.map(p=>e.jsxs("div",{className:"cogita-share-row","data-state":p.revokedUtc?"revoked":"active",children:[e.jsxs("div",{children:[e.jsx("strong",{children:p.collectionName}),e.jsxs("div",{className:"cogita-share-meta",children:[new Date(p.createdUtc).toLocaleString(),p.revokedUtc?` · ${t.cogita.library.revision.shareRevoked}`:""]})]}),p.revokedUtc?null:e.jsx("button",{type:"button",className:"ghost",onClick:()=>pe(p.shareId),children:t.cogita.library.revision.shareRevokeAction})]},p.shareId))})]})]})]})]})})})]})})}const _n=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function mr(t,a,s){if(!t)return null;const r=new Map(t.nodes.map(R=>[R.id,R])),i=new Map,u=new Set,o=R=>{if(typeof R=="number")return R;if(typeof R=="string"){const k=Number(R);return Number.isFinite(k)?k:0}return 0},j=R=>{if(i.has(R))return i.get(R);if(u.has(R))return 0;const k=r.get(R);if(!k)return 0;u.add(R);const D=ee=>{var M,H;return(ee?((M=k.inputsByHandle)==null?void 0:M[ee])??[]:k.inputs??((H=k.inputsByHandle)==null?void 0:H.in)??[]).map(de=>j(de))};let N=0;switch(k.type){case"input.random":{const ee=k.min??0,F=k.max??ee+10,M=Math.min(ee,F),H=Math.max(ee,F);N=Math.floor(Math.random()*(H-M+1))+M;break}case"input.const":{N=k.value??0;break}case"input.list":{const ee=(k.list??[]).filter(Boolean),F=Math.round(o(D("index")[0]));N=ee.length?ee[Math.max(0,Math.min(ee.length-1,F))]:String(F);break}case"compute.add":{N=D("in").map(F=>o(F)).reduce((F,M)=>F+M,0);break}case"compute.sub":{const ee=D("add").map(M=>o(M)),F=D("sub").map(M=>o(M));N=ee.reduce((M,H)=>M+H,0)-F.reduce((M,H)=>M+H,0);break}case"compute.mul":{const ee=D("in").map(F=>o(F));N=ee.length?ee.reduce((F,M)=>F*M,1):0;break}case"compute.div":{const ee=o(D("num")[0]),F=D("den").map(M=>o(M)).reduce((M,H)=>M+H,0);N=Math.abs(F)<Number.EPSILON?0:ee/F;break}case"compute.pow":{const ee=o(D("base")[0]),F=o(D("exp")[0]);N=Math.pow(ee,F);break}case"compute.exp":{const ee=o(D("base")[0]),F=o(D("exp")[0]);N=Math.pow(ee,F);break}case"compute.log":{const ee=o(D("value")[0]),F=o(D("base")[0]),M=Math.max(ee,Number.EPSILON);N=Math.abs(F)<Number.EPSILON?Math.log(M):Math.log(M)/Math.log(F);break}case"compute.abs":{N=Math.abs(o(D("in")[0]));break}case"compute.min":{const ee=D("in").map(F=>o(F));N=ee.length?Math.min(...ee):0;break}case"compute.max":{const ee=D("in").map(F=>o(F));N=ee.length?Math.max(...ee):0;break}case"compute.floor":{N=Math.floor(o(D("in")[0]));break}case"compute.ceil":{N=Math.ceil(o(D("in")[0]));break}case"compute.round":{N=Math.round(o(D("in")[0]));break}case"compute.mod":{const ee=o(D("a")[0]),F=o(D("b")[0]);N=Math.abs(F)<Number.EPSILON?0:ee%F;break}case"compute.concat":{const F=["in1","in2","in3","in4","in5","in6"].flatMap(ke=>D(ke)),M=F.length?F:D("in");N=(M.length?M:D()).map(ke=>ke==null?"":String(ke)).join("");break}case"compute.trim":{const ee=D("text")[0]??D("in")[0]??"",F=ee==null?"":String(ee),M=Math.max(0,Math.round(o(D("start")[0]))),H=Math.max(0,Math.round(o(D("end")[0])));M+H>=F.length?N="":N=F.substring(M,F.length-H);break}case"output":{N=D("in")[0]??0;break}default:N=0}return u.delete(R),i.set(R,N),N},g=t.outputs&&t.outputs.length>0?t.outputs:t.output?[t.output]:t.nodes.filter(R=>R.type==="output").map(R=>R.id);t.nodes.forEach(R=>j(R.id)),g.forEach(R=>j(R));const x=R=>Math.abs(R%1)<1e-5?String(Math.round(R)):R.toFixed(3).replace(/\.?0+$/,""),c=R=>typeof R=="number"?x(R):R??"",f=new Map;g.forEach(R=>{var F,M,H,de;const k=r.get(R);if(!k)return;const D=(M=(F=k.inputsByHandle)==null?void 0:F.name)==null?void 0:M[0],N=D?c(i.get(D)):"",ee=(N==null?void 0:N.toString().trim())||((H=k.outputLabel)==null?void 0:H.trim())||((de=k.name)==null?void 0:de.trim())||R;f.set(R,ee)});const l={},d={},w={};g.forEach(R=>{var N,ee;const k=r.get(R);if(!k)return;const D=f.get(R)??(((N=k.outputLabel)==null?void 0:N.trim())||((ee=k.name)==null?void 0:ee.trim())||R);l[D]=c(i.get(R)),k.name&&(d[k.name.trim()]=D),d[R]=D});const m=(R,k)=>{let D=R;return t.nodes.forEach(N=>{var de,ke;const ee=c(i.get(N.id)),F=g.includes(N.id),M=F?f.get(N.id)??((de=N.outputLabel)==null?void 0:de.trim())??((ke=N.name)==null?void 0:ke.trim())??N.id:"",H=F&&k?M:ee;D=D.replace(new RegExp(`\\{\\s*${_n(N.id)}\\s*\\}`,"gi"),H),N.name&&(D=D.replace(new RegExp(`\\{\\s*${_n(N.name)}\\s*\\}`,"gi"),H)),F&&N.outputLabel&&(D=D.replace(new RegExp(`\\{\\s*${_n(N.outputLabel)}\\s*\\}`,"gi"),M))}),D},S=a;let A=S.trim().length>0?S:"";A||(A=g.length?`Compute ${g.join(", ")}`:"Compute"),A=m(A,!0);const v=(s==null?void 0:s.trim())??"",b=v?m(v,!1):"",X={};return i.forEach((R,k)=>{X[k]=R,w[k]=c(R);const D=r.get(k);D!=null&&D.name&&(w[D.name.trim()]=c(R))}),{prompt:A,answers:l,values:X,answerText:b,outputVariables:d,variableValues:w}}function pr(t){var s;const a=Object.entries(t.answers);return{prompt:t.prompt,expectedAnswer:t.answerText??((s=a[0])==null?void 0:s[1])??"",expectedAnswers:t.answers,values:t.values,expectedAnswerIsSentence:!!(t.answerText&&t.answerText.trim().length>0),outputVariables:t.outputVariables,variableValues:t.variableValues}}const Dn=[{id:"hour",label:"1h",ms:60*60*1e3},{id:"day",label:"24h",ms:24*60*60*1e3},{id:"month",label:"30d",ms:30*24*60*60*1e3},{id:"year",label:"1y",ms:365*24*60*60*1e3}];function fr({outcomes:t}){const[a,s]=n.useState("day"),r=n.useMemo(()=>{const i=Dn.find(j=>j.id===a)??Dn[1],u=Date.now()-i.ms,o=t.filter(j=>new Date(j.createdUtc).getTime()>=u);return ca(o)},[t,a]);return e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:"Card knowness"}),e.jsx("div",{className:"cogita-form-actions",children:Dn.map(i=>e.jsx("button",{type:"button",className:"ghost","data-active":a===i.id,onClick:()=>s(i.id),children:i.label},i.id))}),e.jsxs("h3",{className:"cogita-detail-title",children:[r.score.toFixed(1)," / 100"]}),e.jsxs("p",{children:[r.correct," / ",r.total]})]})}const lo="cogita-revision",co=1,cn="outcomes",uo=()=>new Promise((t,a)=>{const s=indexedDB.open(lo,co);s.onupgradeneeded=()=>{const r=s.result;if(!r.objectStoreNames.contains(cn)){const i=r.createObjectStore(cn,{keyPath:"id"});i.createIndex("byItem","itemKey",{unique:!1}),i.createIndex("byPending","pending",{unique:!1})}},s.onerror=()=>a(s.error),s.onsuccess=()=>t(s.result)}),Qa=async(t,a)=>{const s=await uo();return new Promise((r,i)=>{const u=s.transaction(cn,t),o=u.objectStore(cn);a(o).then(r).catch(i),u.onerror=()=>i(u.error)})},br=()=>{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();if(typeof crypto<"u"&&typeof crypto.getRandomValues=="function"){const t=new Uint8Array(16);crypto.getRandomValues(t);const a=Array.from(t).map(s=>s.toString(16).padStart(2,"0"));return`${a.slice(0,4).join("")}-${a.slice(4,6).join("")}-${a.slice(6,8).join("")}-${a.slice(8,10).join("")}-${a.slice(10,16).join("")}`}return`client-${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`},ho=()=>{const t="cogita_revision_client_id",a=localStorage.getItem(t);if(a)return a;const s=br();return localStorage.setItem(t,s),s},go=()=>{const t="cogita_revision_client_seq",a=Number(localStorage.getItem(t)??"0"),s=Number.isFinite(a)?a+1:1;return localStorage.setItem(t,String(s)),s},yr=(t,a,s,r)=>ta(t,a,s,r),dn=async t=>{const a=ho(),s=go(),r=new Date().toISOString(),i={...t,clientId:a,clientSequence:s,createdUtc:r,id:br(),pending:!0};return await Qa("readwrite",u=>new Promise((o,j)=>{const g={...i,itemKey:yr(i.itemType,i.itemId,i.checkType,i.direction)},x=u.add(g);x.onsuccess=()=>o(),x.onerror=()=>j(x.error)})),i},un=async(t,a,s,r)=>{if(!a)return[];try{const i=yr(t,a,s,r);return await Qa("readonly",u=>new Promise((o,j)=>{const x=u.index("byItem").getAll(i);x.onsuccess=()=>{const f=(x.result??[]).map(l=>({itemType:l.itemType,itemId:l.itemId,checkType:l.checkType??null,direction:l.direction??null,revisionType:l.revisionType,evalType:l.evalType,correct:l.correct,createdUtc:l.createdUtc,maskBase64:l.maskBase64,payloadBase64:l.payloadBase64,payloadHashBase64:l.payloadHashBase64,clientId:l.clientId,clientSequence:l.clientSequence,personRoleId:l.personRoleId??null})).sort((l,d)=>l.createdUtc.localeCompare(d.createdUtc));o(f)},x.onerror=()=>j(x.error)}))}catch{return[]}},da=async()=>{try{return await Qa("readonly",t=>new Promise((a,s)=>{const r=t.getAll();r.onsuccess=()=>{const u=(r.result??[]).map(o=>({itemType:o.itemType,itemId:o.itemId,checkType:o.checkType??null,direction:o.direction??null,revisionType:o.revisionType,evalType:o.evalType,correct:o.correct,createdUtc:o.createdUtc,maskBase64:o.maskBase64,payloadBase64:o.payloadBase64,payloadHashBase64:o.payloadHashBase64,clientId:o.clientId,clientSequence:o.clientSequence,personRoleId:o.personRoleId??null}));a(u)},r.onerror=()=>s(r.error)}))}catch{return[]}},mo=async(t=100)=>{try{return await Qa("readonly",a=>new Promise((s,r)=>{const u=a.index("byPending").getAll(!0);u.onsuccess=()=>{const o=u.result??[];s(o.slice(0,t))},u.onerror=()=>r(u.error)}))}catch{return[]}},po=async t=>{if(t.length!==0)try{await Qa("readwrite",a=>new Promise((s,r)=>{let i=t.length;t.forEach(u=>{const o=a.get(u);o.onsuccess=()=>{const j=o.result;if(j){j.pending=!1;const g=a.put(j);g.onsuccess=()=>{i-=1,i===0&&s()},g.onerror=()=>r(g.error)}else i-=1,i===0&&s()},o.onerror=()=>r(o.error)})}))}catch{}},zn=async(t,a)=>{const s=await mo(200);if(s.length===0)return;const r=new Map;s.forEach(i=>{var o;const u=i.personRoleId??a??"";r.has(u)||r.set(u,[]),(o=r.get(u))==null||o.push(i)});for(const[i,u]of r.entries()){const o=u.map(j=>({itemType:j.itemType,itemId:j.itemId,checkType:j.checkType??null,direction:j.direction??null,revisionType:j.revisionType,evalType:j.evalType,correct:j.correct,clientId:j.clientId,clientSequence:j.clientSequence,maskBase64:j.maskBase64??null,payloadHashBase64:j.payloadHashBase64??null,payloadBase64:j.payloadBase64??null,personRoleId:i||null}));try{await _r({libraryId:t,outcomes:o}),await po(u.map(j=>j.id))}catch{}}},zt=t=>t.trim().toLowerCase(),Qt=t=>{const a=t==null?void 0:t.trim();return a?{fragmentId:a}:null},hn=(t,a)=>{const s=Qt(a);if(!s)return!0;const r=Qt(t);return(r==null?void 0:r.fragmentId)===s.fragmentId},Mt=t=>{const a=t==null?void 0:t.trim().toLowerCase();return a||null},xr=(t,a)=>{if((Mt(t.childItemType)??"info")!==(a.cardType??"").toLowerCase()||t.childItemId!==a.cardId)return!1;const r=Mt(t.childCheckType),i=Mt(t.childDirection),u=Mt(a.checkType),o=Mt(a.direction);return!(r&&r!==u||i&&i!==o)},fo={0:"⁰",1:"¹",2:"²",3:"³",4:"⁴",5:"⁵",6:"⁶",7:"⁷",8:"⁸",9:"⁹","+":"⁺","-":"⁻","=":"⁼","(":"⁽",")":"⁾",n:"ⁿ",i:"ⁱ"},bo={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉","+":"₊","-":"₋","=":"₌","(":"₍",")":"₎",a:"ₐ",e:"ₑ",h:"ₕ",i:"ᵢ",j:"ⱼ",k:"ₖ",l:"ₗ",m:"ₘ",n:"ₙ",o:"ₒ",p:"ₚ",r:"ᵣ",s:"ₛ",t:"ₜ",u:"ᵤ",v:"ᵥ",x:"ₓ"},gn=(t,a,s)=>{if(!s||!a.startsWith(t))return a;const r=a.slice(t.length);if(!r)return a;const i=s==="super"?fo:bo,u=r.split("").map(o=>i[o]??o).join("");return t+u},mn=(t,a,s)=>{var o,j,g;if(!t)return((o=a[0])==null?void 0:o.key)??null;const r=new Set(a.map(x=>x.key)),i=/\{([^}]+)\}/g;let u;for(;(u=i.exec(t))!==null;){const x=((j=u[1])==null?void 0:j.trim())??"";if(!x)continue;if(r.has(x))return x;const c=s==null?void 0:s[x];if(c&&r.has(c))return c}return((g=a[0])==null?void 0:g.key)??null},qa=t=>(()=>{const a=new Set;return t.flatMap(s=>{if(s.cardType!=="info"||s.infoType!=="citation")return[s];const r=s.description??"";if(!r.trim())return[s];const i=va(r),u=Object.keys(i.nodes);return u.length===0?[s]:u.map(o=>({...s,checkType:"quote-fragment",direction:o})).filter(o=>{const j=[o.cardId,o.checkType??"",o.direction??""].join("|");return a.has(j)?!1:(a.add(j),!0)})})})();function Bn({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,libraryId:c,collectionId:f,revisionId:l}){const d=Ea(),w=`/#/cogita/library/${c}`,m=n.useMemo(()=>new URLSearchParams(d.search),[d.search]),S=Math.max(1,Number(m.get("limit")??20)),A=m.get("mode")??"random",v=n.useMemo(()=>cs(A),[A]),b=n.useMemo(()=>kn(v,gr(v,m)),[v,m]),X=m.get("check")??"exact",R=m.get("reviewer"),k=(m.get("scope")??"").trim(),D=k==="info"||k==="info-selection"?k:"collection",N=D==="info"?(m.get("infoId")??"").trim():"",ee=D==="info-selection"?(m.get("seed")??"").trim():"",[F,M]=n.useState(null),H=f??F??void 0,de=D==="collection"&&!!H,ke=n.useMemo(()=>t.cogita.library.revision[v.labelKey]??A,[t,A,v]),Je=n.useMemo(()=>X==="exact"?t.cogita.library.revision.checkValue:X,[t,X]),[ue,$]=n.useState(t.cogita.library.collections.defaultName),[be,C]=n.useState([]),[U,O]=n.useState([]),[K,J]=n.useState("idle"),[Y,ye]=n.useState({current:0,total:0}),[Te,Re]=n.useState(0),[Me,tt]=n.useState(""),[ot,$e]=n.useState(null),[Oe,kt]=n.useState(null),[We,Ae]=n.useState(null),[rt,gt]=n.useState(null),[at,Ie]=n.useState([]),[Ue,et]=n.useState({}),[qe,B]=n.useState({}),[te,pe]=n.useState(null),[p,T]=n.useState(null),[P,V]=n.useState(null),[Z,fe]=n.useState(null),[W,L]=n.useState(null),[we,ne]=n.useState({}),G=n.useRef(0),[Q,ge]=n.useState(null),oe=n.useRef(null),le=n.useRef(null),[Ce,ze]=n.useState(null),[Ke,Ee]=n.useState(!1),[bt,dt]=n.useState(null),[yt,He]=n.useState([]),[_e,mt]=n.useState(null),nt=n.useRef(null),pt=n.useRef(null),[Bt,It]=n.useState(null),[Nt,Lt]=n.useState(0),St=n.useRef(null),ut=n.useRef({}),[Kt,lt]=n.useState(!1),[Ye,Tt]=n.useState({}),[Gt,qt]=n.useState([]),Vt=n.useRef(new Map),[he,Et]=n.useState(new Set),[Zt,Ut]=n.useState(!1),_=n.useRef(null),h=n.useRef(new Set),se=n.useRef({});n.useEffect(()=>{if(!l||f){M(null);return}ns({libraryId:c,revisionId:l}).then(y=>M(y.collectionId)).catch(()=>M(null))},[f,c,l]);const q=be[Te]??null,Ze=(q==null?void 0:q.checkType)==="translation-match"&&W,ht=n.useRef(new Map),ft=n.useRef(new Map),Rt=n.useRef(new Map),At=n.useRef(new Map),Ct=n.useMemo(()=>q?q.cardType==="vocab"?t.cogita.library.revision.vocabLabel:q.infoType?it(t,q.infoType):t.cogita.library.revision.infoLabel:"",[t,q]),Pt=n.useMemo(()=>{var I;return v.id!=="levels"?be.length:((I=Ye.pool)==null?void 0:I.length)??v.getFetchLimit(S,b)},[Ye,b,v,be.length,S]),ha=v.getProgressTotal?v.getProgressTotal(be,Ye,S,b):v.id==="levels"?Math.min(S,Pt):be.length,ma=ha?Math.min(Te+1,ha):0,_t=Math.max(1,Number(b.tries??1)),na=b.compare??"anchors",Ta=Math.max(0,Math.min(100,Number(b.minCorrectness??0))),vt=(b.considerDependencies??"on")==="on",Dt=Math.max(0,Math.min(100,Number(b.dependencyThreshold??85))),ea=y=>{const I=y.slice();for(let z=I.length-1;z>0;z-=1){const ce=Math.floor(Math.random()*(z+1));[I[z],I[ce]]=[I[ce],I[z]]}return I},ja=y=>xa(y,{treatSimilarCharsAsSame:!0})>=Ta,Ga=async()=>{const y=await da(),I=new Map,z=new Map,ce=new Map;y.forEach(ae=>{const Ne=`${ae.itemType}:${ae.itemId}`,Ve=ta(ae.itemType,ae.itemId,ae.checkType,ae.direction);if(I.has(Ne)||I.set(Ne,[]),I.get(Ne).push(ae),z.has(Ve)||z.set(Ve,[]),z.get(Ve).push(ae),ae.itemType==="info"&&ae.checkType==="quote-fragment"&&ae.direction){const Qe=`${ae.itemId}:${ae.direction}`;ce.has(Qe)||ce.set(Qe,[]),ce.get(Qe).push(ae)}});const me=new Map,re=new Map,xe=new Map;return I.forEach((ae,Ne)=>me.set(Ne,ca(ae).score)),z.forEach((ae,Ne)=>re.set(Ne,ca(ae).score)),ce.forEach((ae,Ne)=>xe.set(Ne,ca(ae).score)),{itemKnowness:me,cardKnowness:re,fragmentKnowness:xe}},Yt=async y=>{const I=[];let z=null;for(;;){const ce=await Ja({libraryId:c,collectionId:y,limit:200,cursor:z});if(I.push(...ce.items),!ce.nextCursor)break;z=ce.nextCursor}return qa(I)},Ca=async(y,I)=>{if(Vt.current.has(y))return Vt.current.get(y)??0;const z=await Yt(y);if(z.length===0)return Vt.current.set(y,0),0;const me=z.reduce((re,xe)=>{const ae=Se(xe);return re+(I.get(ae)??0)},0)/z.length;return Vt.current.set(y,me),me},Ia=(y,I)=>{if(!vt||y.cardType!=="info"||y.infoType!=="citation"||y.checkType!=="quote-fragment")return!0;const z=Qt(y.direction);if(!(z!=null&&z.fragmentId))return!0;const ce=y.description??"";if(!ce.trim())return!0;const re=va(ce).nodes[z.fragmentId];if(!re||!re.leftId&&!re.rightId)return!0;const xe=[re.leftId,re.rightId].filter(Ve=>!!Ve);if(xe.length===0)return!0;const ae=xe.map(Ve=>{const Qe=ta("info",y.cardId,"quote-fragment",Ve);return I.get(Qe)??0});return ae.reduce((Ve,Qe)=>Ve+Qe,0)/ae.length>=Dt},Ka=async y=>{const I=Ye,z=y.concat(I.active??[]).concat(I.pool??[]).filter((ae,Ne,Ve)=>Ve.findIndex(Qe=>Se(Qe)===Se(ae))===Ne);if(!vt){Et(new Set(z.map(Se)));return}const{itemKnowness:ce,cardKnowness:me}=await Ga(),re=Gt.filter(ae=>Mt(ae.childItemType)==="collection"&&ae.childItemId===f&&!Mt(ae.childCheckType)&&!Mt(ae.childDirection)),xe=new Set;for(const ae of z){if(ae.cardType!=="info"){xe.add(Se(ae));continue}if(!Ia(ae,me))continue;const Ne=Gt.filter(Ge=>xr(Ge,ae)).concat(re);if(Ne.length===0){xe.add(Se(ae));continue}let Ve=0;for(const Ge of Ne)if(Mt(Ge.parentItemType)==="collection")Ve+=await Ca(Ge.parentItemId,me);else if(Mt(Ge.parentCheckType)||Mt(Ge.parentDirection)){const st=Mt(Ge.parentCheckType),ct=Mt(Ge.parentDirection),xt=ta(Ge.parentItemType,Ge.parentItemId,st,ct);Ve+=me.get(xt)??0}else{const st=`${Ge.parentItemType}:${Ge.parentItemId}`;Ve+=ce.get(st)??0}Ve/Ne.length>=Dt&&xe.add(Se(ae))}Et(xe)},Ya=y=>{for(let I=y;I<be.length;I+=1){const z=be[I];if(z&&(!vt||z.cardType!=="info"||he.has(Se(z))))return I}return-1},_a=y=>!vt||y.cardType!=="info"||he.has(Se(y)),Nn=y=>{if(v.id!=="temporal"&&v.id!=="levels")return null;const I=Ye,z=(I.active??[]).concat(I.pool??[]),ce=new Set;for(const me of z){const re=Se(me);if(!(ce.has(re)||y.has(re))&&(ce.add(re),_a(me)))return me}return null},Jt=n.useMemo(()=>{if(v.id!=="levels")return null;const y=Ye,I=y.pool??[],z=y.active??[],ce=y.levelMap??{},me=Math.max(1,Number(b.levels??1)),re=Array.from({length:me},()=>0),xe=new Set(z.map(Qe=>Se(Qe)));I.forEach(Qe=>{const Ge=Math.min(me,Math.max(1,ce[Se(Qe)]??1));re[Ge-1]+=1});const ae=I.length||1,Ne=re.map(Qe=>Qe/ae*100),Ve=q?ce[Se(q)]??1:null;return{counts:re,percentages:Ne,currentLevel:Ve,levelsCount:me,activeCount:z.length,poolCount:I.length,activeSet:xe}},[Ye,b,v,q]),Ht=n.useMemo(()=>{if(v.id!=="temporal")return null;const y=Ye,I=y.pool??[],z=y.active??[],ce=y.knownessMap??{},me=new Set(y.unknownSet??[]);let re=0;I.forEach(Ne=>{(ce[Se(Ne)]??0)>1&&(re+=1)});const xe=me.size,ae=z.map(Ne=>({id:Se(Ne),value:me.has(Se(Ne))?0:Math.max(0,Math.min(1,ce[Se(Ne)]??0))}));return{knownCount:re,unknownCount:xe,dots:ae}},[Ye,v]),Sn=n.useMemo(()=>{if(!vt)return 0;const y=Ye;return be.concat(y.active??[]).concat(y.pool??[]).filter((z,ce,me)=>me.findIndex(re=>Se(re)===Se(z))===ce).filter(z=>z.cardType==="info"&&!he.has(Se(z))).length},[vt,Ye,be,he]);n.useEffect(()=>{if(!vt||K!=="ready")return;const y=Ye,z=be.concat(y.active??[]).concat(y.pool??[]).filter((re,xe,ae)=>ae.findIndex(Ne=>Se(Ne)===Se(re))===xe).filter(re=>re.cardType!=="info"||he.has(Se(re))).length,ce=nt.current;if(nt.current=z,ce===null||z<=ce)return;const me=z-ce;mt(`New card available (+${me})`),pt.current&&window.clearTimeout(pt.current),pt.current=window.setTimeout(()=>mt(null),2200)},[vt,K,Ye,be,he]),n.useEffect(()=>()=>{pt.current&&window.clearTimeout(pt.current)},[]);const Ot=(y,I)=>{const z=v.applyOutcome({queue:be,meta:Ye},q,S,b,{correct:y,correctness:I,createdUtc:new Date().toISOString()});C(z.queue),Tt(z.meta);const ce=z.queue[Te+1];ce&&ga(ce,Te+1)};n.useEffect(()=>{if(de&&H){xn(c,H).then(y=>$(y.name)).catch(()=>$(t.cogita.library.collections.defaultName));return}if(D==="info"&&N){aa({libraryId:c,infoId:N}).then(y=>{const I=y.payload??{};$(I.title||I.label||I.name||N)}).catch(()=>$(N||t.cogita.library.revision.runKicker));return}if(D==="info-selection"){const y=ee?vs(c,ee):null,I=(y==null?void 0:y.infoIds.length)??0;$(I>0?`Selected infos (${I})`:"Selected infos");return}$(t.cogita.library.collections.defaultName)},[t,H,de,c,D,N,ee]),n.useEffect(()=>{ts({libraryId:c,type:"language"}).then(y=>O(y)).catch(()=>O([]))},[c]),n.useEffect(()=>{de&&es({libraryId:c}).then(y=>qt(y.items??[])).catch(()=>qt([]))},[de,c]),n.useEffect(()=>{zn(c,R)},[c,R]),n.useEffect(()=>{Ka(be)},[be,Gt,vt,Dt,H]),n.useEffect(()=>{if(!q||!vt){Ut(!1);return}if(q.cardType!=="info"||he.has(Se(q))){Ut(!1);return}const y=Ya(Te+1);if(y>=0){Ut(!1),Re(y);return}if(v.id==="temporal"||v.id==="levels"){const I=be.slice(0,Te+1),z=be.slice(Te+1).filter(_a),ce=I.concat(z),me=new Set(ce.map(Se)),re=Nn(me);if(re){const ae=Se(re);me.has(ae)||(ce.push(re),me.add(ae),Tt(Ne=>{const Ve=Ne,Qe=new Set(Ve.queued??[]);return Qe.add(ae),{...Ve,queued:Qe}}))}const xe=ce.findIndex((ae,Ne)=>Ne!==Te&&_a(ae));if(xe>=0){C(ce),Re(xe),Ut(!1);return}}Ut(!0)},[q,he,vt,Te,be,Ye,v.id]),n.useEffect(()=>{let y=!0;return(async()=>{J("loading"),ye({current:0,total:v.id==="levels"?0:v.getFetchLimit(S,b)});try{if(!de){if(qt([]),D==="info"){if(!N){y&&(C([]),qt([]),Tt({}),Re(0),J("ready"));return}const[Ge,st]=await Promise.all([nn({libraryId:c,infoId:N}),sn({libraryId:c,infoId:N})]);if(!y)return;const ct=qa(Ge.items??[]);qt(st.items??[]);const xt=v.prepare(ct,S,b);C(xt.queue),Tt(xt.meta),Re(0),J("ready"),ye({current:ct.length,total:ct.length});return}if(D==="info-selection"){const Ge=ee?vs(c,ee):null,st=(Ge==null?void 0:Ge.infoIds)??[];if(!st.length){y&&(C([]),qt([]),Tt({}),Re(0),J("ready"));return}const ct=await Promise.all(st.map(async pa=>{const[Wt,Xa]=await Promise.all([nn({libraryId:c,infoId:pa}),sn({libraryId:c,infoId:pa})]);return{cards:Wt.items??[],deps:Xa.items??[]}}));if(!y)return;const xt=new Map;ct.forEach(pa=>{qa(pa.cards).forEach(Wt=>{xt.set(Se(Wt),Wt)})});const jt=Array.from(xt.values()),wt=new Set(jt.map(Se)),Ft=new Map;ct.forEach(pa=>{(pa.deps??[]).forEach(Wt=>{const Xa=ta(Wt.parentItemType,Wt.parentItemId,Mt(Wt.parentCheckType),Mt(Wt.parentDirection)),us=ta(Wt.childItemType,Wt.childItemId,Mt(Wt.childCheckType),Mt(Wt.childDirection));if(!wt.has(Xa)||!wt.has(us))return;const hs=`${Xa}->${us}`;Ft.has(hs)||Ft.set(hs,Wt)})}),qt(Array.from(Ft.values()));const ka=v.prepare(jt,S,b);C(ka.queue),Tt(ka.meta),Re(0),J("ready"),ye({current:jt.length,total:jt.length});return}}const z=[];let ce=null,me=null;do{const Ge=await Ja({libraryId:c,collectionId:H,limit:300,cursor:ce});if(z.push(...Ge.items),(v.id==="levels"||v.id==="temporal")&&Ge.total&&(me=Ge.total),ye(st=>({current:z.length,total:st.total||Ge.total||v.getFetchLimit(S,b)})),ce=Ge.nextCursor??null,me!==null&&z.length>=me||v.id!=="levels"&&v.id!=="temporal"&&z.length>=v.getFetchLimit(S,b))break}while(ce);if(!y)return;const re=qa(z);let xe;if(v.id==="levels"){const Ge=Math.max(1,Number(b.levels??1)),ct=(await da()).reduce((xt,jt)=>{const wt=ta(jt.itemType,jt.itemId,jt.checkType,jt.direction);return xt[wt]||(xt[wt]=[]),xt[wt].push(jt),xt},{});xe={},re.forEach(xt=>{const jt=Se(xt),wt=ct[jt]??[],Ft=wt.length>0?ca(wt).score:0,ka=Math.max(1,Math.min(Ge,Math.ceil(Ft/100*Ge)));xe[jt]=ka})}let ae=null,Ne=null,Ve=null;if(v.id==="temporal"){const Ge=await da(),st=new Set(re.map(jt=>Se(jt))),ct=Ge.reduce((jt,wt)=>{const Ft=ta(wt.itemType,wt.itemId,wt.checkType,wt.direction);return st.has(Ft)&&(jt[Ft]||(jt[Ft]=[]),jt[Ft].push(wt)),jt},{});ae={},Ne=new Set,Ve={};const xt=Date.now();re.forEach(jt=>{const wt=Se(jt),Ft=ct[wt]??[];if(Ft.length===0){ae[wt]=0,Ne.add(wt),Ve[wt]=[];return}const ka=is(Ft);Ve[wt]=ka;const pa=jn(ka,xt);ae[wt]=pa.knowness})}const Qe=v.id==="levels"?ls(re,S,b,xe):v.id==="temporal"?os(re,S,b,ae??{},Ne??new Set,Ve??{}):v.prepare(re,S,b);C(Qe.queue),Tt(Qe.meta),Re(0),J("ready"),ye(Ge=>({current:Math.min(Ge.current,Ge.total),total:Ge.total}))}catch{y&&J("error")}})(),()=>{y=!1}},[H,de,c,S,D,b,v,R,N,ee]),n.useEffect(()=>{if(tt(""),$e(null),It(null),Lt(0),Ie([]),et({}),B({}),T(null),V(null),fe(null),Ee(!1),lt(!1),ze(null),L(null),ne({}),!q){kt(null),Ae(null),pe(null),dt(null);return}q.cardType==="info"&&q.infoType==="computed"&&kt(t.cogita.library.revision.loadingComputed);let y=!0;return ga(q,Te).then(I=>{!y||!I||(kt(I.prompt),Ae(I.expectedAnswer),Ie(I.computedExpected),et(I.computedAnswers),pe(I.computedValues),T(I.answerTemplate),V(I.outputVariables),fe(I.variableValues))}),()=>{y=!1}},[q,t]),n.useEffect(()=>{if(!q||q.cardType!=="info"||q.infoType!=="citation"){_.current=null,h.current=new Set,gt(null);return}const y=q.description??"",I=(q.label??"").trim(),z=I.replace(/\s+/g," ").trim(),ce=y.replace(/\s+/g," ").trim(),me=z&&z!==ce?I:t.cogita.library.infoTypes.citation;if(!y){gt(null),Ae(null);return}const re=va(y);_.current=re,kt(me);let xe=!0;return Ga().then(({fragmentKnowness:ae})=>{if(!xe)return;const Ne=new Set,Ve={};ae.forEach((st,ct)=>{const[xt,jt]=ct.split(":",2);if(xt!==q.cardId)return;const wt=Qt(jt);if(!wt)return;const{fragmentId:Ft}=wt;Ve[Ft]=st,st>=Dt&&Ne.add(Ft)}),h.current=Ne,se.current=Ve;const Qe=Qt(q.direction);if(Qe!=null&&Qe.fragmentId&&re.nodes[Qe.fragmentId]){E(re,Qe.fragmentId,me);return}const Ge=$a(re,Ne,Ve,Dt,vt,q.direction);E(re,(Ge==null?void 0:Ge.id)??null,me)}).catch(()=>{h.current=new Set,se.current={};const ae=Qt(q.direction);if(ae!=null&&ae.fragmentId&&re.nodes[ae.fragmentId]){E(re,ae.fragmentId,me);return}const Ne=$a(re,h.current,{},Dt,vt,q.direction);E(re,(Ne==null?void 0:Ne.id)??null,me)}),()=>{xe=!1}},[q,t,vt,Dt]),n.useEffect(()=>{if(!q||q.cardType!=="vocab"||q.checkType!=="translation-match"){L(null),ne({});return}const z=(Ye.pool??Ye.active??be).filter(ae=>ae.cardType==="vocab"&&ae.checkType==="translation-match").filter((ae,Ne,Ve)=>Ve.findIndex(Qe=>Qe.cardId===ae.cardId)===Ne);z.some(ae=>ae.cardId===q.cardId)||z.unshift(q);const me=ea(z).slice(0,6).map(ae=>{const Ne=ae.label.split("↔").map(Ge=>Ge.trim()).filter(Boolean);if(Ne.length<2)return null;const Ve=`${ae.cardId}:L`,Qe=`${ae.cardId}:R`;return{cardId:ae.cardId,leftId:Ve,rightId:Qe,leftLabel:Ne[0],rightLabel:Ne[1]}}).filter(Boolean),re=me.map(ae=>ae.leftId),xe=ea(me.map(ae=>ae.rightId));L({pairs:me,leftOrder:re,rightOrder:xe,selection:{},activeLeft:null,activeRight:null,locked:{}})},[q,be,Ye]),n.useEffect(()=>()=>{oe.current&&window.clearTimeout(oe.current),le.current&&window.clearTimeout(le.current)},[]);const ra=n.useRef(null);n.useEffect(()=>{if(!q)return;const y=Se(q),I=typeof document<"u"?document.activeElement:null;if(ra.current===y&&I&&(I.tagName==="INPUT"||I.tagName==="TEXTAREA"))return;let z=0;const ce=()=>{if(q){if(q.cardType==="info"&&q.infoType==="computed"){if(at.length>0){const re=mn(p,at,P),xe=re?ut.current[re]:null;if(xe&&(xe.focus(),document.activeElement===xe)){ra.current=y;return}}if(St.current&&(St.current.focus(),document.activeElement===St.current)){ra.current=y;return}}else if(q.cardType==="vocab"&&St.current&&(St.current.focus(),document.activeElement===St.current)){ra.current=y;return}z<6&&(z+=1,window.setTimeout(ce,40))}},me=window.setTimeout(ce,40);return()=>window.clearTimeout(me)},[q,at,p,P]),n.useEffect(()=>{if(!Kt)return;const y=I=>{I.key==="Enter"&&(I.preventDefault(),Ma())};return window.addEventListener("keydown",y),()=>window.removeEventListener("keydown",y)},[Kt]);const La=y=>{He(y),dt(ca(y))};n.useEffect(()=>{if(!q){dt(null),He([]);return}const y=q.cardType==="info"?"info":"connection";if(q.cardType==="info"&&q.infoType==="citation"){da().then(I=>{const z=I.filter(ce=>ce.itemType==="info"&&ce.itemId===q.cardId&&ce.checkType==="quote-fragment"&&hn(ce.direction,q.direction));La(z)}).catch(()=>{dt(null),He([])});return}un(y,q.cardId,q.checkType,q.direction).then(I=>La(I)).catch(()=>{dt(null),He([])})},[c,q,R]);const wa=(y,I,z,ce)=>{if(y==="info"&&z==="quote-fragment"){da().then(me=>{const re=me.filter(xe=>xe.itemType==="info"&&xe.itemId===I&&xe.checkType==="quote-fragment"&&hn(xe.direction,ce));La(re)}).catch(()=>{dt(null),He([])});return}un(y,I,z,ce).then(me=>La(me)).catch(()=>{dt(null),He([])})},Da=(y,I,z)=>{var xe;const ce=((xe=z.pairs.find(ae=>ae.leftId===y))==null?void 0:xe.rightId)??null;if(!ce)return z;const me=ce===I;ne(ae=>({...ae,[y]:me?"correct":"incorrect"})),oe.current&&window.clearTimeout(oe.current),le.current&&window.clearTimeout(le.current),G.current+=1;const re={kind:me?"correct":"incorrect",tick:G.current};if(ge(null),oe.current=window.setTimeout(()=>ge(re),0),le.current=window.setTimeout(()=>ge(null),420),me){const ae={...z.locked,[y]:!0};return Object.keys(ae).length>=z.pairs.length?($e("correct"),lt(!0)):$e("correct"),{...z,selection:{...z.selection,[y]:I},activeLeft:null,activeRight:null,locked:ae}}return $e("incorrect"),{...z,activeLeft:null,activeRight:null}},Tn=y=>{L(I=>!I||I.locked[y]?I:I.activeRight?Da(y,I.activeRight,I):{...I,activeLeft:I.activeLeft===y?null:y})},Cn=y=>{L(I=>I&&(I.activeLeft?Da(I.activeLeft,y,I):{...I,activeRight:I.activeRight===y?null:y}))},Ma=()=>{var y;if(q&&q.cardType==="info"&&q.infoType==="citation"&&_.current&&rt&&!((y=Qt(q.direction))!=null&&y.fragmentId)){const I=$a(_.current,h.current,se.current,Dt,vt,q.direction,rt.fragmentId);if(I){$e(null),tt(""),Ee(!1),B({}),lt(!1),It(null),Lt(0),E(_.current,I.id,rt.title);return}}$e(null),tt(""),Ee(!1),B({}),lt(!1),It(null),Lt(0),Re(I=>Math.min(I+1,be.length))},sa=y=>{if(!q)return;const I=y.expected??null,z=y.answer??"";let ce=I??"",me=z;if(!I&&y.expectedMap&&y.answerMap){const Ge=Object.keys(y.expectedMap).sort((st,ct)=>st.localeCompare(ct));ce=Ge.map(st=>{var ct;return((ct=y.expectedMap)==null?void 0:ct[st])??""}).join("|"),me=Ge.map(st=>{var ct;return((ct=y.answerMap)==null?void 0:ct[st])??""}).join("|")}const re=ce?Pa(ce,me,na):new Uint8Array,xe={revisionType:v.id,evalType:y.evalType,direction:y.direction,prompt:Oe??"",expected:I,answer:z,expectedAnswers:y.expectedMap??null,answers:y.answerMap??null,correct:y.correct,maskBase64:re.length?ya(re):null,values:te??null,checkMode:X,compareMode:na,minCorrectness:Ta},ae=new TextEncoder().encode(JSON.stringify(xe)),Ne=q.cardType==="info"?"info":"connection",Ve=y.overrideCheckType??q.checkType??null,Qe=y.overrideDirection??q.direction??null;dn({itemType:Ne,itemId:q.cardId,checkType:Ve,direction:Qe,revisionType:v.id,evalType:y.evalType,correct:y.correct,maskBase64:re.length?ya(re):null,payloadBase64:ya(ae),personRoleId:R??null}).then(()=>{wa(Ne,q.cardId,Ve,Qe),Ka(be),zn(c,R)}).catch(()=>{})},In=(y,I)=>{const z=ht.current.get(I);if(z)return Promise.resolve(z);const ce=ft.current.get(I);if(ce)return ce;const me=aa({libraryId:c,infoId:y}).then(re=>{var Ge,st;const xe=re.payload,ae=((Ge=xe.definition)==null?void 0:Ge.graph)??null,Ne="",Ve=((st=xe.definition)==null?void 0:st.answerTemplate)??"",Qe=mr(ae,Ne,Ve);if(Qe){const xt={sample:pr(Qe),answerTemplate:Ve||null};return ht.current.set(I,xt),xt}return Hn({libraryId:c,infoId:y}).then(ct=>{const xt={sample:ct,answerTemplate:null};return ht.current.set(I,xt),xt})}).catch(()=>Hn({libraryId:c,infoId:y}).then(re=>{const xe={sample:re,answerTemplate:null};return ht.current.set(I,xe),xe}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{ft.current.delete(I)});return ft.current.set(I,me),me},ga=(y,I)=>{var ae;const z=`${Se(y)}:${I}`,ce=Rt.current.get(z);if(ce)return Promise.resolve(ce);const me=At.current.get(z);if(me)return me;const re=Ne=>(Rt.current.set(z,Ne),Ne);let xe;if(y.cardType==="vocab"){if(y.checkType==="translation-match")return xe=Promise.resolve(re({prompt:y.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),xe;const Ne=y.label.split("↔").map(Ve=>Ve.trim()).filter(Boolean);if(Ne.length>=2){const Qe=(y.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",Ge=Qe?Ne[0]:Ne[1],st=Qe?Ne[1]:Ne[0];xe=Promise.resolve(re({prompt:Ge,expectedAnswer:st,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else xe=Promise.resolve(re({prompt:y.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else if(y.cardType==="info"&&y.infoType==="word"){const Ne=(ae=y.description)!=null&&ae.startsWith("Language: ")?y.description.replace("Language: ",""):null;xe=Promise.resolve(re({prompt:y.label,expectedAnswer:Ne,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}))}else y.cardType==="info"&&y.infoType==="question"?xe=aa({libraryId:c,infoId:y.cardId}).then(Ne=>{const Ve=Ne.payload??{},Qe=Ve.definition??Ve??{},Ge=rs(Qe.type??Qe.kind),st=(typeof Qe.question=="string"&&Qe.question.trim()?Qe.question.trim():null)??(typeof Qe.title=="string"&&Qe.title.trim()?Qe.title.trim():null)??y.label,ct=Qe.answer;return re(Ge==="text"||Ge==="number"||Ge==="date"?{prompt:st,expectedAnswer:typeof ct=="string"||typeof ct=="number"?String(ct):null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}:{prompt:st,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})}).catch(()=>re({prompt:y.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{At.current.delete(z)}):y.cardType==="info"&&y.infoType==="computed"?xe=In(y.cardId,z).then(Ne=>{var ct,xt;if(!Ne.sample)return re({prompt:y.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null});const Ve=Ne.sample,Qe=Ve.expectedAnswers?Object.entries(Ve.expectedAnswers).map(([jt,wt])=>({key:jt,expected:wt})):[],Ge=Qe.reduce((jt,wt)=>(jt[wt.key]="",jt),{}),st=Ve.expectedAnswerIsSentence&&((ct=Ve.expectedAnswer)==null?void 0:ct.trim())||null;return re({prompt:Ve.prompt,expectedAnswer:Qe.length>0?st:((xt=Ve.expectedAnswer)==null?void 0:xt.trim())||null,computedExpected:Qe,computedAnswers:Ge,computedValues:Ve.values??null,answerTemplate:Ne.answerTemplate,outputVariables:Ve.outputVariables??null,variableValues:Ve.variableValues??null})}).catch(()=>re({prompt:y.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{At.current.delete(z)}):xe=Promise.resolve(re({prompt:y.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}));return At.current.set(z,xe),xe},E=(y,I,z)=>{const ce=Object.keys(y.nodes).length,me=h.current.size;if(!I){gt({title:z,before:y.text,after:"",fragmentId:null,total:ce,completed:me}),Ae(null),lt(!0);return}const re=y.nodes[I];if(!re)return;const xe=vn(y.text,re);gt({title:z,before:xe.before,after:xe.after,fragmentId:re.id,total:ce,completed:me}),Ae(xe.fragment),lt(!1)},ie=()=>{const y=_.current;y&&gt(I=>I&&{...I,total:Object.keys(y.nodes).length,completed:h.current.size})},ve=()=>{const y=be[Te+1];y&&ga(y,Te+1)},De=()=>{if(ve(),q&&q.cardType==="vocab"&&q.checkType==="translation-match"&&W){if(W.pairs.length===0){$e("incorrect"),lt(!0);return}const re=W.pairs.reduce((st,ct)=>(st[ct.rightId]=ct.rightLabel,st),{});let xe=0;const ae={};W.pairs.forEach(st=>{const xt=W.selection[st.leftId]===st.rightId;ae[st.leftId]=xt?"correct":"incorrect",xt&&(xe+=1)});const Ne=W.pairs.length||1,Ve=xe/Ne,Qe=xe===W.pairs.length;ne(st=>({...st,...ae})),Qe?($e("correct"),lt(!0),Lt(0)):($e("incorrect"),lt(!1),Lt(st=>{const ct=st+1;return ct>=_t&&(Ee(!0),lt(!0),L(xt=>{if(!xt)return xt;const jt=xt.pairs.reduce((wt,Ft)=>(wt[Ft.leftId]=Ft.rightId,wt),{});return{...xt,selection:jt}})),ct})),Ot(Qe,Ve);const Ge="connection";Promise.all(W.pairs.map(st=>{const ct=W.selection[st.leftId]??null,xt=ct?re[ct]:"",jt={left:st.leftLabel,expected:st.rightLabel,answer:xt,checkType:"translation-match"},wt=new TextEncoder().encode(JSON.stringify(jt));return dn({itemType:Ge,itemId:st.cardId,checkType:"translation-match",direction:null,revisionType:v.id,evalType:"translation-match",correct:ct===st.rightId,maskBase64:null,payloadBase64:ya(wt),personRoleId:R??null})})).then(()=>{wa(Ge,q.cardId,q.checkType,q.direction),zn(c,R)}).catch(()=>{});return}if(at.length>0){const re=at.reduce((ae,Ne)=>{const Ve=Ue[Ne.key]??"";return ae[Ne.key]=zt(Ve)===zt(Ne.expected)?"correct":"incorrect",ae},{});at.every(({key:ae,expected:Ne})=>{const Ve=Ue[ae]??"";return X==="exact"&&zt(Ve)===zt(Ne)})?($e("correct"),B(re),lt(!0),Lt(0),Ot(!0,1),sa({correct:!0,direction:Oe?`${Oe} -> computed`:"computed",expectedMap:at.reduce((ae,Ne)=>(ae[Ne.key]=Ne.expected,ae),{}),answerMap:Ue,evalType:"computed"})):($e("incorrect"),B(re),lt(!1),Lt(ae=>{const Ne=ae+1;return Ne>=_t&&Xe&&(Ee(!0),lt(!0)),Ne}),Ot(!1,0),window.setTimeout(()=>{var Ne;const ae=mn(p,at,P);ae&&ut.current[ae]&&((Ne=ut.current[ae])==null||Ne.focus())},40),sa({correct:!1,direction:Oe?`${Oe} -> computed`:"computed",expectedMap:at.reduce((ae,Ne)=>(ae[Ne.key]=Ne.expected,ae),{}),answerMap:Ue,evalType:"computed"}));return}if(q&&q.cardType==="info"&&q.infoType==="citation"&&(rt!=null&&rt.fragmentId)){if(!We)return;const re=Qt(q.direction),xe=(re==null?void 0:re.fragmentId)??rt.fragmentId,ae=Sa(We,Me,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Ne=ae.mask,Ve=ae.isCorrect,Qe=ae.percent;Ve?(se.current[rt.fragmentId]=Math.max(se.current[rt.fragmentId]??0,Qe),(se.current[rt.fragmentId]??0)>=Dt&&h.current.add(rt.fragmentId),ie(),$e("correct"),B({}),lt(!0),It(Ne),Lt(0),Qe<100&&_t<=1&&Ee(!0),Ot(!0,Qe/100),sa({correct:!0,direction:`quote:${rt.fragmentId}`,expected:We,answer:Me,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:xe})):($e("incorrect"),B({}),lt(!1),It(Ne),Lt(Ge=>{const st=Ge+1;return st>=_t&&Xe&&(Ee(!0),lt(!0)),st}),Ot(!1,Qe/100),window.setTimeout(()=>{var Ge;return(Ge=St.current)==null?void 0:Ge.focus()},40),sa({correct:!1,direction:`quote:${rt.fragmentId}`,expected:We,answer:Me,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:xe}));return}if(!We)return;const y=Pa(We,Me,na),I=X==="exact"&&zt(Me)===zt(We),z=ja(y),ce=I||z,me=xa(y);ce?($e("correct"),B({}),lt(!0),It(y),Lt(0),me<100&&_t<=1&&Ee(!0),Ot(!0,me/100),sa({correct:!0,direction:Oe?`${Oe} -> ${We}`:null,expected:We,answer:Me,evalType:"text"})):($e("incorrect"),B({}),lt(!1),It(y),Lt(re=>{const xe=re+1;return xe>=_t&&Xe&&(Ee(!0),lt(!0)),xe}),Ot(!1,me/100),window.setTimeout(()=>{var re;return(re=St.current)==null?void 0:re.focus()},40),sa({correct:!1,direction:Oe?`${Oe} -> ${We}`:null,expected:We,answer:Me,evalType:"text"}))},Be=y=>{if(ve(),!We)return;const I=Pa(We,y,na),z=zt(y)===zt(We),ce=ja(I),me=z||ce,re=xa(I);me?($e("correct"),B({}),lt(!0),It(I),Lt(0),re<100&&_t<=1&&Ee(!0),Ot(!0,re/100),sa({correct:!0,direction:"word->language",expected:We,answer:y,evalType:"language-select"})):($e("incorrect"),B({}),lt(!1),It(I),Lt(xe=>{const ae=xe+1;return ae>=_t&&Xe&&(Ee(!0),lt(!0)),ae}),Ot(!1,re/100),sa({correct:!1,direction:"word->language",expected:We,answer:y,evalType:"language-select"}))},je=()=>{ve(),$e("correct"),lt(!0),Lt(0),Ot(!0,1),We&&sa({correct:!0,direction:"manual",expected:We,answer:Me,evalType:"manual"})},Fe=()=>{if(Ot(!1,0),q&&q.cardType==="info"&&q.infoType==="citation"){$e(null),tt(""),Ee(!1),B({}),lt(!1),It(null),Lt(0),Re(y=>Math.min(y+1,be.length));return}Ma()};n.useEffect(()=>{ve()},[Te,be]);const Le=y=>{var z;if(y.key!=="Enter")return;if(y.preventDefault(),y.stopPropagation(),Kt){Ma();return}const I=at.find(ce=>!(Ue[ce.key]??"").trim());if(I){(z=ut.current[I.key])==null||z.focus();return}De()},Pe=t.cogita.library.revision.revealModeAfterIncorrect,Xe=at.length>0||!!We;return e.jsxs($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,children:[K==="loading"&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${Y.total?Math.min(100,Math.max(0,Y.current/Y.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:Y.total?`${Math.min(Y.current,Y.total)} / ${Y.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.runKicker}),e.jsx("h1",{className:"cogita-library-title",children:ue}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",ke).replace("{check}",Je)})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:w,children:t.cogita.library.actions.libraryOverview}),de?e.jsxs(e.Fragment,{children:[e.jsx("a",{className:"cta ghost",href:`${w}/collections`,children:t.cogita.library.actions.collections}),e.jsx("a",{className:"cta ghost",href:`${w}/collections/${H}`,children:t.cogita.library.actions.collectionDetail})]}):e.jsx("a",{className:"cta ghost",href:`${w}/list`,children:t.cogita.library.actions.allCards})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:bt?`${bt.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[Jt?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",Jt.currentLevel??"-"," / ",Jt.levelsCount]}):null,bt?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(bt.correct)).replace("{total}",String(bt.total))}),bt.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(bt.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(fr,{outcomes:yt})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[_e?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:_e})}):null,e.jsx(Fa,{feedbackToken:Q?`${Q.kind}-${Q.tick}`:Ze?"idle":ot?`${ot}-${Te}-${Nt}`:"idle",children:q?e.jsx(e.Fragment,{children:Zt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(ss,{copy:t,currentCard:q,currentTypeLabel:Ct,prompt:Oe,languages:U,answer:Me,onAnswerChange:y=>tt(I=>gn(I,y,Ce)),computedExpected:at,computedAnswers:Ue,onComputedAnswerChange:(y,I)=>et(z=>({...z,[y]:gn(z[y]??"",I,Ce)})),answerTemplate:p,outputVariables:P,variableValues:Z,computedFieldFeedback:qe,feedback:ot,canAdvance:Kt,quoteContext:rt,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:De,onSkip:Fe,onLanguageSelect:Be,onMarkReviewed:je,onAdvance:Ma,showCorrectAnswer:Ke,setShowCorrectAnswer:Ee,onRevealCorrect:()=>lt(!0),answerMask:Bt,expectedAnswer:We,hasExpectedAnswer:Xe,handleComputedKeyDown:Le,answerInputRef:St,computedInputRefs:ut,scriptMode:Ce,setScriptMode:ze,matchPairs:W==null?void 0:W.pairs,matchLeftOrder:W==null?void 0:W.leftOrder,matchRightOrder:W==null?void 0:W.rightOrder,matchSelection:W==null?void 0:W.selection,matchActiveLeft:W==null?void 0:W.activeLeft,matchActiveRight:W==null?void 0:W.activeRight,matchFeedback:we,onMatchLeftSelect:Tn,onMatchRightSelect:Cn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:de?`${w}/collections/${H}`:`${w}/list`,children:de?t.cogita.library.actions.collectionDetail:t.cogita.library.actions.allCards})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:ha?`${ma} / ${ha}`:t.cogita.library.revision.progressUnlimited}),K==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),K==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),K==="ready"&&be.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:Pe}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",_t]})]})]}),Jt?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",Jt.activeCount," / ",Jt.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:Jt.counts.map((y,I)=>{const z=I+1,ce=Jt.currentLevel===z,me=Jt.percentages[I]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":ce,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:z}),e.jsx("strong",{children:y})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,me))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[me.toFixed(1),"%"]})]},`level-${z}`)})})]}):null,Ht?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:Ht.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:Ht.dots.map(y=>e.jsx("span",{style:{left:`${Math.min(100,Math.max(0,y.value*100))}%`,background:`rgba(${Math.round(255*(1-y.value))}, ${Math.round(200*y.value)}, 80, 0.9)`}},y.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:Ht.knownCount})]})]}):null,vt?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Sn})]})}):null]})]})]})})})]})]})}const Vn=[{type:"source.translation",label:"Translation source"},{type:"source.info.all",label:"All infos"},{type:"source.info",label:"Info source"},{type:"source.connection",label:"Connection source"},{type:"filter.tag",label:"Tag filter"},{type:"filter.language",label:"Language filter"},{type:"logic.and",label:"AND"},{type:"logic.or",label:"OR"},{type:"output.collection",label:"Collection output"}],yo={"filter.tag":{scope:"any"},"filter.language":{scope:"any"},"source.info":{infoType:"word"},"source.connection":{connectionType:"translation"}},xo=[{value:"translation",label:"Translation"},{value:"word-language",label:"Word ↔ Language"},{value:"language-sentence",label:"Language ↔ Sentence"},{value:"word-topic",label:"Word ↔ Topic"}],vo=[{value:"word",label:"Word"},{value:"sentence",label:"Sentence"},{value:"language",label:"Language"},{value:"topic",label:"Topic"},{value:"computed",label:"Computed"}];function jo({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,libraryId:c,collectionId:f}){const[l,d]=n.useState(""),[w,m,S]=Gn([]),[A,v,b]=Yn([]),[X,R]=n.useState(null),[k,D]=n.useState(null),[N,ee]=n.useState(null),F=`/#/cogita/library/${c}`;n.useEffect(()=>{xn(c,f).then($=>d($.name)).catch(()=>d(t.cogita.library.collections.defaultName))},[c,f,t]),n.useEffect(()=>{Dr({libraryId:c,collectionId:f}).then($=>{if(!$.graphId||$.graphId==="00000000-0000-0000-0000-000000000000"){m([]),v([]);return}const be=$.nodes.map(U=>{var Y;const O=U.payload??{},K=O.position??{x:120,y:120},J=O.params??{};return{id:U.nodeId,type:"default",position:K,data:{nodeType:U.nodeType,label:((Y=Vn.find(ye=>ye.type===U.nodeType))==null?void 0:Y.label)??U.nodeType,params:J}}}),C=$.edges.map(U=>({id:U.edgeId,source:U.fromNodeId,target:U.toNodeId,sourceHandle:U.fromPort??void 0,targetHandle:U.toPort??void 0}));m(be),v(C)}).catch(()=>{m([]),v([])})},[c,f,v,m]);const M=n.useMemo(()=>w.find($=>$.id===X)??null,[w,X]),H=$=>{var O;const be=crypto.randomUUID(),C=((O=Vn.find(K=>K.type===$))==null?void 0:O.label)??$,U={...yo[$]};m(K=>[...K,{id:be,type:"default",position:{x:120+K.length*40,y:120+K.length*40},data:{nodeType:$,label:C,params:U}}]),R(be)},de=n.useCallback($=>{v(be=>Xn({...$,id:crypto.randomUUID()},be))},[v]),ke=async()=>{D(null);try{await nr({libraryId:c,collectionId:f,nodes:w.map($=>({nodeId:$.id,nodeType:$.data.nodeType,payload:{position:$.position,params:$.data.params}})),edges:A.map($=>({edgeId:$.id,fromNodeId:$.source,fromPort:$.sourceHandle??null,toNodeId:$.target,toPort:$.targetHandle??null}))}),D(t.cogita.library.graph.saveSuccess)}catch{D(t.cogita.library.graph.saveFail)}},Je=async()=>{try{const $=await zr({libraryId:c,collectionId:f});ee($)}catch{ee(null)}},ue=$=>{M&&m(be=>be.map(C=>C.id===M.id?{...C,data:{...C.data,params:$}}:C))};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,children:e.jsxs("section",{className:"cogita-library-dashboard","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.kicker}),e.jsx("h1",{className:"cogita-library-title",children:l}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.graph.subtitle})]}),e.jsxs("div",{className:"cogita-library-actions",children:[e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita}),e.jsx("a",{className:"cta ghost",href:`${F}/collections/${f}`,children:t.cogita.library.actions.collectionDetail}),e.jsx("button",{type:"button",className:"cta ghost",onClick:Je,children:t.cogita.library.graph.preview}),e.jsx("button",{type:"button",className:"cta",onClick:ke,children:t.cogita.library.graph.save})]})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-collection-graph",children:[e.jsxs("div",{className:"cogita-graph-palette",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.palette}),e.jsx("div",{className:"cogita-graph-palette-grid",children:Vn.map($=>e.jsx("button",{type:"button",className:"ghost",onClick:()=>H($.type),children:$.label},$.type))}),k?e.jsx("p",{className:"cogita-help",children:k}):null,N&&e.jsxs("div",{className:"cogita-graph-preview",children:[e.jsx("p",{children:t.cogita.library.graph.previewLabel.replace("{total}",String(N.total))}),e.jsx("p",{children:t.cogita.library.graph.previewBreakdown.replace("{connections}",String(N.connections)).replace("{infos}",String(N.infos))})]})]}),e.jsx("div",{className:"cogita-graph-canvas",children:e.jsxs(fn,{nodes:w,edges:A,onNodesChange:S,onEdgesChange:b,onConnect:de,onNodeClick:($,be)=>R(be.id),fitView:!0,children:[e.jsx(bn,{color:"rgba(120,160,200,0.2)"}),e.jsx(yn,{})]})}),e.jsxs("div",{className:"cogita-graph-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.graph.inspector}),M?e.jsxs("div",{className:"cogita-graph-panel-body",children:[e.jsx("p",{className:"cogita-graph-node-title",children:M.data.label}),M.data.nodeType==="filter.tag"&&e.jsxs(e.Fragment,{children:[e.jsx(Xt,{libraryId:c,infoType:"topic",label:t.cogita.library.graph.tagLabel,placeholder:t.cogita.library.graph.tagPlaceholder,value:M.data.params.tagId?{id:M.data.params.tagId,label:M.data.params.tagLabel??"",infoType:"topic"}:null,onChange:$=>ue({...M.data.params,tagId:($==null?void 0:$.id)??null,tagLabel:($==null?void 0:$.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.topic),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:M.data.params.scope??"any",onChange:$=>ue({...M.data.params,scope:$.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"translation",children:t.cogita.library.graph.scopeTranslation}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),M.data.nodeType==="filter.language"&&e.jsxs(e.Fragment,{children:[e.jsx(Xt,{libraryId:c,infoType:"language",label:t.cogita.library.graph.languageLabel,placeholder:t.cogita.library.graph.languagePlaceholder,value:M.data.params.languageId?{id:M.data.params.languageId,label:M.data.params.languageLabel??"",infoType:"language"}:null,onChange:$=>ue({...M.data.params,languageId:($==null?void 0:$.id)??null,languageLabel:($==null?void 0:$.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.language),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.scopeLabel}),e.jsxs("select",{value:M.data.params.scope??"any",onChange:$=>ue({...M.data.params,scope:$.target.value}),children:[e.jsx("option",{value:"any",children:t.cogita.library.graph.scopeAny}),e.jsx("option",{value:"wordA",children:t.cogita.library.graph.scopeWordA}),e.jsx("option",{value:"wordB",children:t.cogita.library.graph.scopeWordB})]})]})]}),M.data.nodeType==="source.info"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.infoTypeLabel}),e.jsx("select",{value:M.data.params.infoType??"word",onChange:$=>ue({...M.data.params,infoType:$.target.value}),children:vo.map($=>e.jsx("option",{value:$.value,children:$.label},$.value))})]}),e.jsx(Xt,{libraryId:c,infoType:M.data.params.infoType??"word",label:t.cogita.library.graph.specificInfoLabel,placeholder:t.cogita.library.graph.specificInfoPlaceholder,value:M.data.params.infoId?{id:M.data.params.infoId,label:M.data.params.infoLabel??"",infoType:M.data.params.infoType??"word"}:null,onChange:$=>ue({...M.data.params,infoId:($==null?void 0:$.id)??null,infoLabel:($==null?void 0:$.label)??null}),searchFailedText:t.cogita.library.lookup.searchFailed,createFailedText:t.cogita.library.lookup.createFailed,createLabel:t.cogita.library.lookup.createNew.replace("{type}",t.cogita.library.infoTypes.word),savingLabel:t.cogita.library.lookup.saving,loadMoreLabel:t.cogita.library.lookup.loadMore})]}),M.data.nodeType==="source.connection"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionTypeLabel}),e.jsx("select",{value:M.data.params.connectionType??"translation",onChange:$=>ue({...M.data.params,connectionType:$.target.value}),children:xo.map($=>e.jsx("option",{value:$.value,children:$.label},$.value))})]}),e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:t.cogita.library.graph.connectionIdLabel}),e.jsx("input",{value:M.data.params.connectionId??"",onChange:$=>ue({...M.data.params,connectionId:$.target.value||null}),placeholder:t.cogita.library.graph.connectionIdPlaceholder})]})]}),["logic.and","logic.or","output.collection","source.translation","source.info.all"].includes(M.data.nodeType)&&e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.noParams})]}):e.jsx("p",{className:"cogita-help",children:t.cogita.library.graph.emptyInspector})]})]})})})]})})}const On="cogita.preferences",qn="cogita.reviewer.preferences",vr=["library_overview","all_cards","all_collections","all_revisions","storyboards","texts","dependencies","transfer"],Un={library_overview:{requiresCollection:!1,allowsRevision:!1},all_cards:{requiresCollection:!1,allowsRevision:!1},new_card:{requiresCollection:!1,allowsRevision:!1},all_collections:{requiresCollection:!0,allowsRevision:!0},all_revisions:{requiresCollection:!1,allowsRevision:!0},new_collection:{requiresCollection:!1,allowsRevision:!1},transfer:{requiresCollection:!1,allowsRevision:!1},storyboards:{requiresCollection:!1,allowsRevision:!1},new_storyboard:{requiresCollection:!1,allowsRevision:!1},texts:{requiresCollection:!1,allowsRevision:!1},new_text:{requiresCollection:!1,allowsRevision:!1},dependencies:{requiresCollection:!1,allowsRevision:!1}},wo=["settings","run","shared"],Ra=30,qs=42;function fa(t,a){const s=(t??"").trim();return s.length<=a?s:a<=1?s.slice(0,a):`${s.slice(0,Math.max(1,a-1)).trimEnd()}…`}function ko(t,a=""){const s=t.split("/").filter(Boolean);if(s[0]!=="cogita"||s[1]!=="library")return{};const r=s[2];if(!r)return{};if(!s[3])return{libraryId:r,target:"library_overview"};const i=new URLSearchParams(a),u=i.get("revisionId")??void 0,o=i.get("infoId")??void 0,j=i.get("infoView"),g=j==="cards"?"cards":j==="collections"?"collections":"overview",x=i.get("collectionView")==="overview"?"overview":"infos",c=i.get("collectionAction"),f=i.get("libraryAction"),d=i.get("libraryTarget")==="revisions"?"all_revisions":"all_collections";if(s[3]==="list")return{libraryId:r,target:f==="new-info"?"new_card":"all_cards",cardMode:"list",revisionId:u,infoId:o,infoView:g,libraryAction:f==="new-info"?"new-info":void 0};if(s[3]==="detail"||s[3]==="collection")return{libraryId:r,target:"all_cards",cardMode:s[3],revisionId:u,infoId:o,infoView:g};if(s[3]==="new"||s[3]==="add")return{libraryId:r,target:"new_card",revisionId:u,libraryAction:"new-info"};if(s[3]==="edit")return{libraryId:r,target:"new_card",revisionId:u,infoId:s[4]};if(s[3]==="infos"){const m=s[4];return m?s[5]==="checkcards"?{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u,infoId:m,infoView:"cards"}:s[5]==="collections"?{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u,infoId:m,infoView:"collections"}:{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u,infoId:m,infoView:"overview"}:{libraryId:r,target:"all_cards",cardMode:"list",revisionId:u}}if(s[3]==="shared-revisions")return{libraryId:r,target:d,revisionId:u};if(s[3]==="revisions"){const m=s[4];return m?m==="shared-links"?{libraryId:r,target:"all_revisions",revisionView:"shared"}:m==="new"?{libraryId:r,target:"all_revisions",revisionView:"new"}:s[5]==="run"?{libraryId:r,target:"all_revisions",revisionId:m,revisionView:"run"}:s[5]==="shared"?{libraryId:r,target:"all_revisions",revisionId:m,revisionView:"shared"}:{libraryId:r,target:"all_revisions",revisionId:m,revisionView:"settings"}:{libraryId:r,target:"all_revisions"}}if(s[3]==="revision"&&s[4]==="run")return{libraryId:r,target:d,revisionView:"run",revisionId:u,infoId:o,infoView:g};if(s[3]==="dependencies")return{libraryId:r,target:"dependencies"};if(s[3]==="transfer")return{libraryId:r,target:"transfer"};if(s[3]==="storyboards")return s[4]==="new"?{libraryId:r,target:"new_storyboard"}:{libraryId:r,target:"storyboards"};if(s[3]==="texts")return s[4]==="new"?{libraryId:r,target:"new_text"}:{libraryId:r,target:"texts"};if(s[3]!=="collections")return{libraryId:r,target:"library_overview"};if(s[4]==="new")return{libraryId:r,target:"new_collection",revisionId:u};const w=s[4];return w?s[5]==="graph"?{libraryId:r,target:d,collectionId:w,revisionId:u,revisionView:"graph"}:s[5]==="shared-revisions"?{libraryId:r,target:d,collectionId:w,revisionId:u,revisionView:"shared"}:s[5]==="revision"?{libraryId:r,target:d,collectionId:w,revisionId:u,revisionView:s[6]==="run"?"run":"settings",collectionView:x}:c==="new-revision"?{libraryId:r,target:d,collectionId:w,revisionId:u,revisionView:"new"}:{libraryId:r,target:d,collectionId:w,revisionId:u,revisionView:"detail",collectionView:x}:c==="new-collection"?{libraryId:r,target:"new_collection",collectionAction:"new-collection"}:{libraryId:r,target:d}}function Us(t,a="library_overview",s,r,i,u,o="overview",j="infos"){const g=(x,c)=>{const f=new URLSearchParams;c!=null&&c.revisionId&&f.set("revisionId",c.revisionId),c!=null&&c.collectionAction&&f.set("collectionAction",c.collectionAction),c!=null&&c.libraryAction&&f.set("libraryAction",c.libraryAction),c!=null&&c.libraryTarget&&f.set("libraryTarget",c.libraryTarget),c!=null&&c.infoId&&f.set("infoId",c.infoId),c!=null&&c.infoView&&(c!=null&&c.infoId)&&f.set("infoView",c.infoView),c!=null&&c.collectionView&&c.collectionView!=="infos"&&f.set("collectionView",c.collectionView);const l=f.toString();return l?`${x}?${l}`:x};if(!t)return"/cogita";if(a==="library_overview")return g(`/cogita/library/${t}`,{revisionId:i});if(a==="all_cards")return u?o==="cards"?g(`/cogita/library/${t}/infos/${u}/checkcards`,{revisionId:i}):o==="collections"?g(`/cogita/library/${t}/infos/${u}/collections`,{revisionId:i}):g(`/cogita/library/${t}/infos/${u}`,{revisionId:i}):g(`/cogita/library/${t}/list`,{revisionId:i,infoId:u,infoView:o});if(a==="new_card")return u?g(`/cogita/library/${t}/edit/${u}`,{revisionId:i}):g(`/cogita/library/${t}/list`,{revisionId:i,libraryAction:"new-info"});if(a==="all_collections"||a==="all_revisions"){const x=a==="all_revisions"?"revisions":void 0;return a==="all_revisions"&&i?r==="run"?g(`/cogita/library/${t}/revisions/${i}/run`,{revisionId:i}):r==="shared"?g(`/cogita/library/${t}/revisions/${i}/shared`,{revisionId:i}):g(`/cogita/library/${t}/revisions/${i}`,{revisionId:i}):a==="all_revisions"&&r==="new"?g(`/cogita/library/${t}/revisions/new`,{revisionId:i}):a==="all_revisions"?r==="shared"?g(`/cogita/library/${t}/revisions/shared-links`,{revisionId:i}):r==="run"?g(`/cogita/library/${t}/revision/run`,{revisionId:i,libraryTarget:x}):g(`/cogita/library/${t}/revisions`,{revisionId:i}):!s&&r==="run"?g(`/cogita/library/${t}/revision/run`,{revisionId:i,libraryTarget:x}):s?r==="graph"?g(`/cogita/library/${t}/collections/${s}/graph`,{revisionId:i,libraryTarget:x}):r==="settings"?g(`/cogita/library/${t}/collections/${s}/revision`,{revisionId:i,libraryTarget:x}):r==="run"?g(`/cogita/library/${t}/collections/${s}/revision/run`,{revisionId:i,libraryTarget:x}):r==="shared"?g(`/cogita/library/${t}/collections/${s}/shared-revisions`,{revisionId:i,libraryTarget:x}):r==="new"?g(`/cogita/library/${t}/collections/${s}`,{revisionId:i,libraryTarget:x,collectionAction:"new-revision"}):g(`/cogita/library/${t}/collections/${s}`,{revisionId:i,libraryTarget:x,collectionView:j}):g(`/cogita/library/${t}/collections`,{revisionId:i,libraryTarget:x})}return a==="new_collection"?g(`/cogita/library/${t}/collections`,{revisionId:i,collectionAction:"new-collection"}):a==="transfer"?g(`/cogita/library/${t}/transfer`,{revisionId:i}):a==="storyboards"?g(`/cogita/library/${t}/storyboards`,{revisionId:i}):a==="new_storyboard"?g(`/cogita/library/${t}/storyboards/new`,{revisionId:i}):a==="texts"?g(`/cogita/library/${t}/texts`,{revisionId:i}):a==="new_text"?g(`/cogita/library/${t}/texts/new`,{revisionId:i}):a==="dependencies"?g(`/cogita/library/${t}/dependencies`,{revisionId:i}):g(`/cogita/library/${t}`,{revisionId:i})}function ba(t){return t.length>1&&t.endsWith("/")?t.slice(0,-1):t}function No(t){return typeof t=="string"&&vr.includes(t)}function So(t,a){var j;if(!t.length)return null;const s=t.filter(g=>a.has(g.roleId)),r=s.length>0?s:t,i=r.map(g=>{var c,f;const x=((f=(c=g.fields.find(l=>l.fieldType==="role_kind"))==null?void 0:c.plainValue)==null?void 0:f.toLowerCase())??"";return{roleId:g.roleId,roleKind:x}}),u=i.find(g=>g.roleKind.includes("master"));if(u)return u.roleId;const o=i.find(g=>g.roleKind.includes("account")||g.roleKind.includes("user"));return o?o.roleId:((j=r[0])==null?void 0:j.roleId)??null}function To(t){if(!t)return{version:1,byLibrary:{}};try{const a=JSON.parse(t);return!a||typeof a!="object"?{version:1,byLibrary:{}}:{version:1,lastLibraryId:a.lastLibraryId,byLibrary:a.byLibrary??{}}}catch{return{version:1,byLibrary:{}}}}function Co({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x}){const c=Wa(),f=Ea(),l=n.useMemo(()=>ko(f.pathname,f.search),[f.pathname,f.search]),d=t.cogita.workspace,[w,m]=n.useState([]),[S,A]=n.useState([]),[v,b]=n.useState([]),[X,R]=n.useState([]),[k,D]=n.useState(void 0),[N,ee]=n.useState("library_overview"),[F,M]=n.useState(void 0),[H,de]=n.useState(void 0),[ke,Je]=n.useState("detail"),[ue,$]=n.useState(void 0),[be,C]=n.useState(!1),[U,O]=n.useState(!0),[K,J]=n.useState(!1),[Y,ye]=n.useState(!1),[Te,Re]=n.useState(null),[Me,tt]=n.useState(0),[ot,$e]=n.useState(""),[Oe,kt]=n.useState(""),[We,Ae]=n.useState(""),[rt,gt]=n.useState([]),[at,Ie]=n.useState(""),[Ue,et]=n.useState(0),[qe,B]=n.useState(null),[te,pe]=n.useState(null),p=n.useRef({version:1,byLibrary:{}}),T=n.useRef(!1),P=n.useRef(!1),V=n.useRef(null),Z=n.useMemo(()=>w.find(h=>h.libraryId===k)??null,[w,k]),fe=n.useMemo(()=>S.find(h=>h.collectionId===F)??null,[S,F]),W=ba(f.pathname)==="/cogita/persons";n.useEffect(()=>{if(!k){gt([]),Ie("");return}let h=!1;return sr({libraryId:k}).then(se=>{if(h)return;const q=se.filter(Ze=>(Ze.roleKind??"").trim().toLowerCase()==="person");gt(q);try{const Ze=window.localStorage.getItem(qn),ft=(Ze?JSON.parse(Ze):{})[k]??"",Rt=ft&&q.some(At=>At.roleId===ft)?ft:"";Ie(Rt)}catch{Ie("")}}).catch(()=>{h||(gt([]),Ie(""))}),()=>{h=!0}},[k,Ue]),n.useEffect(()=>{if(k)try{const h=window.localStorage.getItem(qn),se=h?JSON.parse(h):{};at?se[k]=at:delete se[k],window.localStorage.setItem(qn,JSON.stringify(se))}catch{}},[k,at]);const L=n.useMemo(()=>X.find(h=>h.revisionId===H)??null,[X,H]),we=n.useMemo(()=>({detail:d.revisions.detail,graph:d.revisions.graph,settings:d.revisions.settings,run:d.revisions.run,shared:d.targets.sharedRevisions,new:d.revisionForm.createAction}),[d.revisions.detail,d.revisions.graph,d.revisions.run,d.revisions.settings,d.targets.sharedRevisions,d.revisionForm.createAction]),ne=n.useMemo(()=>N==="new_card"?"all_cards":N==="new_collection"?"all_collections":N==="new_storyboard"?"storyboards":N==="new_text"?"texts":N,[N]),G=n.useMemo(()=>ke==="new"?"settings":ke,[ke]),Q=N==="all_collections"||N==="all_revisions",ge=n.useMemo(()=>N==="new_collection"?"create":N==="all_collections"&&F?"selected":"search",[F,N]),oe=n.useMemo(()=>l.infoId?"selected":N==="new_card"?"create":"search",[l.infoId,N]),le=n.useMemo(()=>v.find(h=>h.infoId===l.infoId)??null,[v,l.infoId]),Ce=n.useMemo(()=>({library_overview:d.targets.libraryOverview,all_cards:d.targets.allCards,new_card:d.targets.newCard,all_collections:d.targets.allCollections,all_revisions:d.targets.allRevisions,new_collection:d.targets.newCollection,transfer:d.targets.transfer,storyboards:d.targets.storyboards,new_storyboard:d.targets.newStoryboard,texts:d.targets.texts,new_text:d.targets.newText,dependencies:d.targets.dependencies}),[d.targets]),ze=n.useMemo(()=>Ce[ne]??ne,[ne,Ce]),Ke=we[G],Ee=!!k,bt=n.useMemo(()=>{const h=g==="pl"?"Ruch na teraz: utwórz bibliotekę i wpisz pierwszy element wiedzy.":g==="de"?"Nächster Schritt: Erstelle eine Bibliothek und füge den ersten Wissenseintrag hinzu.":"Next action: create one library and add your first knowledge item.";return g==="pl"?[{step:"Krok 1",title:"Czym jest Cogita?",lead:"To centrum budowania i prowadzenia procesu nauki po zalogowaniu.",passages:["W jednym miejscu łączysz treści, ćwiczenia i współpracę zespołu.","Zamiast luźnych notatek dostajesz spójny przepływ: biblioteka → kolekcja → powtórka."],focus:["Jedna przestrzeń robocza","Spójny proces"],action:h},{step:"Krok 2",title:"Zacznij od biblioteki",lead:"Biblioteka jest bazą dla całego tematu.",passages:["Nazwij bibliotekę jasno: np. „Historia Kościoła – semestr 1”.","Każdy kolejny moduł korzysta z tej samej biblioteki jako źródła."],focus:["Nazwa tematyczna","Jeden punkt startowy"],action:h},{step:"Krok 3",title:"Dodawaj informacje",lead:"Twórz krótkie, konkretne jednostki wiedzy.",passages:["Wpisy typu info opisują pojęcia, osoby, źródła i cytaty.","Małe jednostki łatwiej łączyć, powtarzać i aktualizować."],focus:["Krótko i konkretnie","Łatwe aktualizacje"],action:h},{step:"Krok 4",title:"Pracuj na typach",lead:"Formularze dostosowują się do rodzaju informacji.",passages:["Każdy typ pokazuje właściwe pola i porządkuje dane.","To zmniejsza chaos i poprawia jakość wyszukiwania."],focus:["Lepsza struktura","Mniej błędów"],action:h},{step:"Krok 5",title:"Łącz wiedzę linkami",lead:"Buduj kontekst przez relacje między wpisami.",passages:["Połącz temat z definicją, źródłem i przykładem.","Graf relacji pomaga zobaczyć, czego brakuje przed kolejnym etapem."],focus:["Relacje między wpisami","Pełniejszy kontekst"],action:h},{step:"Krok 6",title:"Twórz kolekcje celu",lead:"Kolekcja grupuje wpisy pod konkretny scenariusz.",passages:["Osobna kolekcja dla lekcji, osobna dla quizu lub egzaminu.","Nie duplikujesz treści — tylko wybierasz, co jest potrzebne."],focus:["Celowe grupowanie","Bez duplikatów"],action:h},{step:"Krok 7",title:"Dodawaj powtórki",lead:"Powtórka definiuje jak przebiega sprawdzanie.",passages:["Ustaw tempo, kolejność i zakres materiału.","Dla jednej kolekcji możesz mieć kilka powtórek o różnych poziomach."],focus:["Kontrola tempa","Różne poziomy"],action:h},{step:"Krok 8",title:"Info vs karta",lead:"Rozróżniaj źródło wiedzy i widok ćwiczeniowy.",passages:["Info to rekord bazowy, który przechowuje treść.","Karta to forma pytania/utrwalenia generowana z info."],focus:["Źródło danych","Widok ćwiczeń"],action:h},{step:"Krok 9",title:"Uruchamiaj sesję",lead:"Tryb Run prowadzi uczestników krok po kroku.",passages:["Prowadzący kontroluje rytm i przejścia między etapami.","Uczestnicy mają jasny przebieg bez zgadywania, co dalej."],focus:["Płynny przebieg","Lepsza dynamika grupy"],action:h},{step:"Krok 10",title:"Czytaj graf zależności",lead:"Graf pokazuje priorytety nauki.",passages:["Węzły centralne oznaczają tematy, które wpływają na wiele innych.","Najpierw utrwal fundamenty, potem przechodź do warstw zaawansowanych."],focus:["Priorytety materiału","Lepsza kolejność"],action:h},{step:"Krok 11",title:"Storyboard i teksty",lead:"Plan i notatki trzymaj blisko wiedzy źródłowej.",passages:["Storyboard układa narrację i przebieg spotkania.","Teksty zbierają komentarze, wnioski i gotowe treści do publikacji."],focus:["Lepsze przygotowanie","Notatki w kontekście"],action:h},{step:"Krok 12",title:"Udostępniaj bezpiecznie",lead:"Dziel się materiałem bez utraty kontroli.",passages:["Możesz dać dostęp tylko do odczytu dla wybranych osób.","Edycja pozostaje po stronie autora lub zespołu prowadzącego."],focus:["Kontrola uprawnień","Bezpieczne współdzielenie"],action:h},{step:"Krok 13",title:"Nawiguj warstwowo",lead:"Sidebar i breadcrumb prowadzą przez poziomy.",passages:["Zawsze widzisz, czy pracujesz na bibliotece, kolekcji czy powtórce.","Mniej kliknięć „w ciemno”, więcej świadomej nawigacji."],focus:["Orientacja w systemie","Szybsze decyzje"],action:h},{step:"Krok 14",title:"Plan wdrożenia 30 minut",lead:"Najpierw prosty pilot, potem rozwijaj.",passages:["Plan: 1 biblioteka, 10 wpisów info, 1 kolekcja, 1 powtórka testowa.","Po pierwszej sesji popraw strukturę i dodaj kolejne scenariusze."],focus:["Szybki start","Iteracyjne doskonalenie"],action:"Gotowe? Załóż bibliotekę po prawej i przejdź do pierwszego wpisu."}]:g==="de"?[{step:"Schritt 1",title:"Was ist Cogita?",lead:"Ein zentraler Workspace für Lernen und Moderation nach dem Login.",passages:["Du verbindest Inhalte, Übungen und Teamarbeit in einem Ablauf.","Der Prozess bleibt klar: Bibliothek → Sammlung → Wiederholung."],focus:["Ein Workspace","Klarer Ablauf"],action:h},{step:"Schritt 2",title:"Mit Bibliothek starten",lead:"Die Bibliothek ist der Startpunkt für dein Thema.",passages:["Vergib einen klaren Namen für Kurs oder Modul.","Alle weiteren Bereiche greifen auf diese Basis zu."],focus:["Sauberer Start","Gemeinsame Basis"],action:h},{step:"Schritt 3",title:"Infos anlegen",lead:"Erfasse Wissen in kleinen, klaren Einträgen.",passages:["Info-Einträge enthalten Begriffe, Personen, Quellen und Zitate.","Kleinere Einheiten lassen sich besser verknüpfen und trainieren."],focus:["Kleine Einheiten","Leicht wartbar"],action:h},{step:"Schritt 4",title:"Typbasierte Eingabe",lead:"Formulare passen sich automatisch dem Info-Typ an.",passages:["Dadurch bleiben Daten strukturiert und konsistent.","Das verbessert Qualität und Auffindbarkeit."],focus:["Konsistenz","Bessere Suche"],action:h},{step:"Schritt 5",title:"Wissen verlinken",lead:"Verbinde Einträge zu einem Kontextnetz.",passages:["Thema, Quelle und Beispiel werden als Beziehung sichtbar.","So erkennst du Lücken vor der nächsten Lernphase."],focus:["Kontextnetz","Lücken erkennen"],action:h},{step:"Schritt 6",title:"Ziel-Sammlungen bauen",lead:"Eine Sammlung bündelt Inhalte für einen konkreten Zweck.",passages:["Nutze getrennte Sammlungen für Unterricht, Quiz oder Prüfung.","Du wählst Inhalte aus statt sie zu kopieren."],focus:["Zielorientierung","Keine Duplikate"],action:h},{step:"Schritt 7",title:"Wiederholungen erstellen",lead:"Wiederholungen definieren den Prüfungsablauf.",passages:["Tempo, Reihenfolge und Umfang sind pro Wiederholung steuerbar.","Mehrere Wiederholungen pro Sammlung sind möglich."],focus:["Ablaufsteuerung","Mehrere Niveaus"],action:h},{step:"Schritt 8",title:"Info und Karte",lead:"Datenobjekt und Trainingsansicht sind getrennt.",passages:["Info ist die Quelle der Inhalte.","Die Karte ist die Übungsansicht für Frage und Antwort."],focus:["Sauberes Modell","Wiederverwendbar"],action:h},{step:"Schritt 9",title:"Sitzung durchführen",lead:"Im Run-Modus führst du die Gruppe Schritt für Schritt.",passages:["Moderation steuert Übergänge und Timing.","Teilnehmende folgen einem klaren Ablauf."],focus:["Klare Moderation","Stabile Dynamik"],action:h},{step:"Schritt 10",title:"Abhängigkeitsgraph lesen",lead:"Der Graph zeigt Lernprioritäten.",passages:["Zentrale Knoten beeinflussen viele weitere Themen.","Starte mit Grundlagen und baue danach auf."],focus:["Priorisierung","Lernreihenfolge"],action:h},{step:"Schritt 11",title:"Storyboard & Texte",lead:"Plane Ablauf und sammle Notizen im selben Kontext.",passages:["Storyboards strukturieren Sequenzen und Rollen.","Texte halten Erkenntnisse und veröffentlichungsreife Inhalte fest."],focus:["Planung","Dokumentation"],action:h},{step:"Schritt 12",title:"Sicher teilen",lead:"Teile Inhalte ohne Kontrollverlust.",passages:["Leserechte sind separat von Bearbeitungsrechten steuerbar.","So bleibt der Kernbestand geschützt."],focus:["Rechtekontrolle","Sicheres Teilen"],action:h},{step:"Schritt 13",title:"Ebenen-Navigation",lead:"Sidebar und Breadcrumb zeigen deinen aktuellen Kontext.",passages:["Du siehst sofort, auf welcher Ebene du arbeitest.","Das spart Zeit und reduziert Fehlklicks."],focus:["Orientierung","Effizienz"],action:h},{step:"Schritt 14",title:"30-Minuten-Startplan",lead:"Starte klein und erweitere iterativ.",passages:["Plan: 1 Bibliothek, 10 Infos, 1 Sammlung, 1 Test-Wiederholung.","Nach der ersten Runde verbesserst du Struktur und Ablauf."],focus:["Schneller Einstieg","Iteratives Vorgehen"],action:"Jetzt starten: Bibliothek rechts anlegen und den ersten Eintrag erfassen."}]:[{step:"Step 1",title:"What is Cogita?",lead:"A post-login workspace to design, run, and improve knowledge journeys.",passages:["You can keep content, training flow, and collaboration in one place.","The path stays explicit: library → collection → revision → session."],focus:["Single workspace","Clear learning flow"],action:h},{step:"Step 2",title:"Start with a library",lead:"Your library is the root container for one domain or program.",passages:["Name it after your course, cohort, or topic scope.","Every next module reuses this foundation."],focus:["Root container","Consistent base"],action:h},{step:"Step 3",title:"Add information units",lead:"Build knowledge from small, reusable info entries.",passages:["Capture terms, references, people, concepts, and citations.","Smaller entries are easier to link, review, and update."],focus:["Reusable units","Easy maintenance"],action:h},{step:"Step 4",title:"Use type-based forms",lead:"Each info type has a matching data structure and fields.",passages:["Form layouts adapt automatically to the selected type.","This improves consistency and lowers input mistakes."],focus:["Structured input","Fewer errors"],action:h},{step:"Step 5",title:"Link the knowledge graph",lead:"Relationships turn isolated facts into usable context.",passages:["Connect topics, sources, and supporting examples.","Dependency links show what must be learned first."],focus:["Context building","Better sequencing"],action:h},{step:"Step 6",title:"Build goal collections",lead:"Collections package selected infos for a concrete objective.",passages:["Create separate collections for class, quiz, exam, or workshop.","You curate from existing entries instead of duplicating content."],focus:["Goal-oriented sets","No duplication"],action:h},{step:"Step 7",title:"Create revisions",lead:"Revisions define how practice and checking should run.",passages:["Set pacing, order, and scope for each session style.","One collection can host multiple revision strategies."],focus:["Practice design","Multiple modes"],action:h},{step:"Step 8",title:"Understand info vs card",lead:"Data objects and practice views are intentionally separate.",passages:["Info is the canonical source object.","Card is the generated training/checking view."],focus:["Clear model","Reusable content"],action:h},{step:"Step 9",title:"Run live sessions",lead:"Run mode helps facilitators guide each step with control.",passages:["Move through prompts, responses, and timing intentionally.","Participants get a predictable and focused session rhythm."],focus:["Facilitator control","Group clarity"],action:h},{step:"Step 10",title:"Read dependency graphs",lead:"Graph views expose prerequisites and high-impact nodes.",passages:["Central nodes usually deserve priority in onboarding.","Use this to plan revision order and reduce confusion."],focus:["Priority mapping","Smarter progression"],action:h},{step:"Step 11",title:"Use storyboards and texts",lead:"Plan narratives and keep notes near source knowledge.",passages:["Storyboards model session structure and transitions.","Texts capture outcomes, drafts, and reusable explanations."],focus:["Planning layer","Contextual notes"],action:h},{step:"Step 12",title:"Share safely",lead:"Share read access without losing editorial control.",passages:["Keep editing rights restricted to owners or maintainers.","Collaborators can consume material while core data stays protected."],focus:["Access control","Safe collaboration"],action:h},{step:"Step 13",title:"Navigate by layers",lead:"Sidebar and breadcrumb make system depth understandable.",passages:["You always know whether you are at library, collection, or revision level.","Clear location awareness reduces wrong actions."],focus:["Fast orientation","Lower friction"],action:h},{step:"Step 14",title:"30-minute launch plan",lead:"Start with a minimum viable setup, then iterate.",passages:["Plan: create 1 library, add 10 infos, build 1 collection, run 1 revision.","After the first run, refine structure and scale by scenario."],focus:["Immediate execution","Iterative improvement"],action:"Ready now? Create your first library on the right and start adding knowledge."}]},[g]),dt=bt.length,yt=Math.max(0,Math.min(Me,dt-1)),He=bt[yt],_e=!!F,mt=Ee&&N==="all_collections",nt=_e&&N==="all_collections",pt=Ee&&(N==="all_revisions"||_e&&N==="all_collections")&&(G==="settings"||G==="run"||G==="shared"||N==="all_revisions"),Bt=pt,It=pt&&!!H,Nt=n.useCallback(h=>{const se=!!h.libraryId;let q=h.target,Ze=h.collectionId,ht=h.revisionId,ft=h.revisionView,Rt=h.infoId,At=h.infoView??l.infoView??"overview",Ct=h.collectionView??l.collectionView??"infos";se?Un[q].requiresCollection&&!Ze?(q=q==="all_revisions"?"all_revisions":"all_collections",ht=void 0,ft="detail"):q!=="all_collections"&&q!=="all_revisions"?(Ze=void 0,ht=void 0,q!=="new_card"&&q!=="all_cards"&&(Rt=void 0,At="overview"),q!=="new_collection"&&(Ct="infos")):Un[q].allowsRevision?wo.includes(ft)||(ht=void 0):ft="detail":(q="library_overview",Ze=void 0,ht=void 0,ft="detail",Rt=void 0,At="overview",Ct="infos"),D(h.libraryId),ee(q),M(Ze),de(ht),Je(ft),C(!1);const Pt=ba(Us(h.libraryId,q,Ze,ft,ht,Rt,At,Ct));ba(`${f.pathname}${f.search}`)!==Pt&&(V.current=Pt,c(Pt))},[f.pathname,f.search,c,l.collectionView,l.infoView]),Lt=n.useMemo(()=>[{key:"library",label:d.layers.library,visible:!0,value:k??"",selectedLabel:(Z==null?void 0:Z.name)??d.path.noLibrarySelected,disabled:U||w.length===0,options:w.map(h=>({value:h.libraryId,label:h.name})),emptyOption:d.noLibraryOption,onSelect:h=>{const se=h||void 0;Nt({libraryId:se,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"target",label:d.layers.target,visible:Ee,value:ne,selectedLabel:ze,disabled:!Ee,options:vr.map(h=>({value:h,label:Ce[h]})),onSelect:h=>{const se=h;Nt({libraryId:k,target:se,collectionId:F,revisionId:H,revisionView:ke,infoId:se==="new_card"?l.infoId:void 0})}},{key:"info_mode",label:d.layers.target,visible:ne==="all_cards",value:oe,selectedLabel:oe==="create"?d.infoMode.create:oe==="selected"?(le==null?void 0:le.label)??ue??t.cogita.library.list.selectedEmpty:d.infoMode.search,disabled:!Ee,options:[{value:"search",label:d.infoMode.search},{value:"create",label:d.infoMode.create},...l.infoId?[{value:"selected",label:(le==null?void 0:le.label)??ue??t.cogita.library.list.selectedEmpty}]:[]],onSelect:h=>{if(h==="selected"){if(!l.infoId)return;Nt({libraryId:k,target:"all_cards",collectionId:F,revisionId:H,revisionView:ke,infoId:l.infoId,infoView:"overview"});return}if(h==="create"){Nt({libraryId:k,target:"new_card",collectionId:F,revisionId:H,revisionView:ke,infoId:void 0});return}Nt({libraryId:k,target:"all_cards",collectionId:F,revisionId:H,revisionView:ke,infoId:void 0,infoView:"overview"})}},{key:"info_selected_action",label:d.layers.target,visible:ne==="all_cards"&&!!l.infoId,value:N==="new_card"&&l.infoId?"edit":l.infoView==="cards"?"cards":l.infoView==="collections"?"collections":"overview",selectedLabel:N==="new_card"&&l.infoId?d.infoActions.edit:l.infoView==="cards"?d.infoActions.seeCards:l.infoView==="collections"?"Kolekcje":d.infoActions.overview,disabled:!Ee||!l.infoId,options:[{value:"overview",label:d.infoActions.overview},{value:"edit",label:d.infoActions.edit},{value:"cards",label:d.infoActions.seeCards},{value:"collections",label:"Kolekcje"}],onSelect:h=>{if(l.infoId){if(h==="edit"){Nt({libraryId:k,target:"new_card",collectionId:F,revisionId:H,revisionView:ke,infoId:l.infoId});return}if(h==="cards"){Nt({libraryId:k,target:"all_cards",collectionId:F,revisionId:H,revisionView:ke,infoId:l.infoId,infoView:"cards"});return}Nt({libraryId:k,target:"all_cards",collectionId:F,revisionId:H,revisionView:ke,infoId:l.infoId,infoView:"overview"})}}},{key:"collection_mode",label:d.layers.collection,visible:Ee&&(N==="all_collections"||N==="new_collection"),value:ge,selectedLabel:ge==="create"?t.cogita.library.actions.createCollection:ge==="selected"?(fe==null?void 0:fe.name)??d.path.noCollectionSelected:t.cogita.library.actions.collections,disabled:!Ee,options:[{value:"search",label:t.cogita.library.actions.collections},{value:"create",label:t.cogita.library.actions.createCollection},...F&&fe?[{value:"selected",label:fe.name}]:[]],onSelect:h=>{if(h==="create"){Nt({libraryId:k,target:"new_collection",collectionId:void 0,revisionId:void 0,revisionView:"detail"});return}if(h==="selected"&&F){const se=Q?N:"all_collections";Nt({libraryId:k,target:se,collectionId:F,revisionId:H,revisionView:se==="all_revisions"?"settings":"detail"});return}if(h==="collections"){Nt({libraryId:k,target:"all_cards",collectionId:F,revisionId:H,revisionView:ke,infoId:l.infoId,infoView:"collections"});return}Nt({libraryId:k,target:Q?N:"all_collections",collectionId:void 0,revisionId:void 0,revisionView:"detail"})}},{key:"collection",label:d.layers.collection,visible:mt&&ge!=="create",value:F??"",selectedLabel:(fe==null?void 0:fe.name)??d.path.noCollectionSelected,disabled:!Ee||K||S.length===0,options:S.map(h=>({value:h.collectionId,label:h.name})),emptyOption:d.selectCollectionOption,onSelect:h=>{const se=h||void 0,q=Q?N:"all_collections";Nt({libraryId:k,target:q,collectionId:se,revisionId:void 0,revisionView:q==="all_revisions"?"settings":"detail"})}},{key:"collection_selected_action",label:d.layers.revision,visible:nt,value:N==="all_revisions"?"revisions":G==="graph"?"edit":G==="settings"||G==="run"||G==="shared"?"revisions":(l.collectionView??"infos")==="overview"?"overview":"infos",selectedLabel:N==="all_revisions"?d.targets.allRevisions:G==="graph"?"Edytuj":G==="settings"||G==="run"||G==="shared"?d.targets.allRevisions:(l.collectionView??"infos")==="overview"?"Przegląd":"Informacje",disabled:!F,options:[{value:"overview",label:"Przegląd"},{value:"edit",label:"Edytuj"},{value:"infos",label:"Informacje"},{value:"revisions",label:d.targets.allRevisions}],onSelect:h=>{if(F){if(h==="edit"){Nt({libraryId:k,target:Q?N:"all_collections",collectionId:F,revisionId:void 0,revisionView:"graph"});return}if(h==="revisions"){Nt({libraryId:k,target:Q?N:"all_collections",collectionId:F,revisionId:H,revisionView:"settings"});return}Nt({libraryId:k,target:Q?N:"all_collections",collectionId:F,revisionId:void 0,revisionView:"detail",infoId:l.infoId,infoView:l.infoView,collectionView:h==="overview"?"overview":"infos"})}}},{key:"revision_mode",label:d.layers.revision,visible:Bt,value:ke==="new"?"create":!H&&G==="shared"?"shared":"search",selectedLabel:ke==="new"?d.revisionForm.createAction:!H&&G==="shared"?d.targets.sharedRevisions:d.infoActions.search,disabled:N==="all_revisions"?!Ee:!_e,options:[{value:"search",label:d.infoActions.search},{value:"create",label:d.revisionForm.createAction},{value:"shared",label:d.targets.sharedRevisions}],onSelect:h=>{Nt({libraryId:k,target:Q?N:"all_revisions",collectionId:N==="all_revisions"?void 0:F,revisionId:void 0,revisionView:h==="create"?"new":h==="shared"?"shared":"settings"})}},{key:"revision_entry",label:d.layers.revision,visible:Bt,value:H??"",selectedLabel:(L==null?void 0:L.name)??d.status.noRevisions,disabled:(N==="all_revisions"?!Ee:!_e)||Y||X.length===0,options:X.map(h=>({value:h.revisionId,label:h.name})),emptyOption:d.status.noRevisions,onSelect:h=>{Nt({libraryId:k,target:Q?N:"all_collections",collectionId:F,revisionId:h||void 0,revisionView:G==="settings"||G==="run"||G==="shared"?G:"settings"})}},{key:"revision_selected_action",label:d.layers.revision,visible:It,value:G==="run"?"run":G==="shared"?"shared":"settings",selectedLabel:G==="run"?d.revisions.run:G==="shared"?d.targets.sharedRevisions:d.infoActions.edit,disabled:!H,options:[{value:"settings",label:d.infoActions.edit},{value:"run",label:d.revisions.run},{value:"shared",label:d.targets.sharedRevisions}],onSelect:h=>{H&&Nt({libraryId:k,target:Q?N:"all_collections",collectionId:F,revisionId:H,revisionView:h==="run"?"run":h==="shared"?"shared":"settings"})}}],[S,K,oe,v,w,U,Nt,X,Y,fe,F,le,L,H,ue,_e,Ee,Z,Q,k,Ke,ke,N,G,ne,ze,mt,nt,Bt,It,Ce,t.cogita.library.list.selectedEmpty,l.infoId,l.infoView,l.collectionView,d.infoActions.edit,d.infoActions.overview,d.infoActions.seeCards,d.layers.collection,d.layers.library,d.layers.revision,d.layers.target,d.noLibraryOption,d.path.noCollectionSelected,d.path.noLibrarySelected,d.selectCollectionOption,d.targets.allRevisions,d.infoActions.search,d.revisionForm.createAction,d.revisions.run,d.targets.sharedRevisions,ge]),St=n.useMemo(()=>Lt.filter(h=>h.visible),[Lt]),ut=n.useMemo(()=>St.filter(h=>h.key!=="library"&&h.key!=="collection"),[St]),Kt=n.useMemo(()=>ut.find(h=>h.key==="target")??null,[ut]),lt=n.useMemo(()=>ut.find(h=>h.key==="info_mode")??null,[ut]),Ye=n.useMemo(()=>ut.find(h=>h.key==="info_selected_action")??null,[ut]),Tt=n.useMemo(()=>ut.find(h=>h.key==="collection_mode")??null,[ut]),Gt=n.useMemo(()=>ut.find(h=>h.key==="revision_mode")??null,[ut]),qt=n.useMemo(()=>ut.find(h=>h.key==="collection_selected_action")??null,[ut]),Vt=n.useMemo(()=>ut.find(h=>h.key==="revision_entry")??null,[ut]),he=n.useMemo(()=>ut.find(h=>h.key==="revision_selected_action")??null,[ut]),Et=n.useCallback((h,se)=>h?e.jsx("div",{className:"cogita-sidebar-actions",children:h.options.map(q=>e.jsx("button",{type:"button",className:`ghost ${String(h.value)===q.value?"active":""}`,onClick:()=>h.onSelect(q.value),disabled:h.disabled,title:q.label,children:fa(q.label,Ra)},`${se}:${h.key}:${q.value}`))}):null,[]),Zt=n.useMemo(()=>{const h=l.libraryId;if(!h||!f.pathname.startsWith("/cogita/library/"))return null;const se={copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,libraryId:h};if(l.target==="library_overview")return e.jsx(ui,{...se});if(l.target==="all_cards")return l.infoId&&l.infoView==="cards"?e.jsx(zi,{...se,infoId:l.infoId,selectedReviewerRoleId:at||null}):e.jsx(ki,{...se,mode:l.cardMode??"list"});if(l.target==="new_card")return e.jsx(Ri,{...se,editInfoId:l.infoId});if(l.target==="dependencies")return e.jsx(Pi,{...se});if(l.target==="transfer")return e.jsx(Ui,{...se});if(l.target==="storyboards"||l.target==="new_storyboard")return e.jsx(Ji,{...se});if(l.target==="texts"||l.target==="new_text")return e.jsx(Hi,{...se});if(l.target==="all_collections"||l.target==="all_revisions"){if(l.target==="all_revisions"&&!l.collectionId)return l.revisionView==="run"?e.jsx(Bn,{...se,revisionId:l.revisionId}):e.jsx(Os,{...se,revisionId:l.revisionId});if(!l.collectionId&&l.revisionView==="run")return e.jsx(Bn,{...se,revisionId:l.revisionId});if(l.collectionId){const q={...se,collectionId:l.collectionId};return l.revisionView==="graph"?e.jsx(jo,{...q}):l.revisionView==="shared"?e.jsx(qi,{...se,collectionId:l.collectionId}):l.revisionView==="settings"?e.jsx(Os,{...q,revisionId:l.revisionId}):l.revisionView==="run"?e.jsx(Bn,{...q,revisionId:l.revisionId}):e.jsx(Qi,{...q})}return e.jsx(Wi,{...se})}return l.target==="new_collection"?e.jsx(Zi,{...se,onCreated:q=>{Nt({libraryId:h,target:N==="all_revisions"?"all_revisions":"all_collections",collectionId:q,revisionId:void 0,revisionView:"graph"})}}):null},[a,Nt,t,g,f.pathname,c,x,u,j,r,i,l.cardMode,l.collectionId,l.infoId,l.libraryId,l.revisionId,l.revisionView,l.target,o,s,N,at]);n.useEffect(()=>{let h=!1;return(async()=>{var q,Ze,ht,ft,Rt;O(!0);try{await Br();const[At,Ct,Pt]=await Promise.all([Xs(),er(),Vr()]);if(h)return;m(At);const ha=new Set(Pt.nodes.filter(vt=>vt.nodeType==="role"&&vt.canLink).map(vt=>vt.roleId??"")),ma=So(Ct,ha);if(B(ma),ma){const vt=Pt.nodes.find(Dt=>Dt.nodeType==="data"&&Dt.roleId===ma&&(Dt.fieldType===On||Dt.label===On));pe((vt==null?void 0:vt.dataKeyId)??null),p.current=To(vt==null?void 0:vt.value)}const _t=(q=At.find(vt=>vt.libraryId===l.libraryId))==null?void 0:q.libraryId,na=_t?(ht=(Ze=p.current.byLibrary)==null?void 0:Ze[_t])==null?void 0:ht.lastTarget:void 0,Ta=No(na)?na:"library_overview";D(_t),ee(l.target??Ta),de(l.revisionId??(_t?(Rt=(ft=p.current.byLibrary)==null?void 0:ft[_t])==null?void 0:Rt.lastRevisionId:void 0)),Je(l.revisionView??"detail"),T.current=!0}catch{h||Re(d.status.loadFailed)}finally{h||O(!1)}})(),()=>{h=!0}},[d.status.loadFailed]),n.useLayoutEffect(()=>{if(T.current){if(!l.libraryId){D(void 0),ee(l.target??"library_overview"),M(void 0),de(void 0),Je("detail");return}l.libraryId&&w.some(h=>h.libraryId===l.libraryId)&&D(l.libraryId),l.target&&ee(l.target),M(l.collectionId),de(l.revisionId),l.revisionView&&Je(l.revisionView)}},[w,l.collectionId,l.libraryId,l.revisionId,l.revisionView,l.target]),n.useEffect(()=>{if(!k){A([]),M(void 0),b([]),R([]),de(void 0);return}let h=!1;return J(!0),Ua({libraryId:k,limit:200}).then(se=>{var ht;if(h)return;const q=se.items;A(q);const Ze=(ht=q.find(ft=>ft.collectionId===l.collectionId))==null?void 0:ht.collectionId;M(Ze)}).catch(()=>{h||(A([]),M(void 0))}).finally(()=>{h||J(!1)}),()=>{h=!0}},[l.collectionId,k]),n.useEffect(()=>{if(!k||ne!=="all_cards"&&N!=="new_card"){b([]);return}let h=!1;return ts({libraryId:k,limit:200}).then(se=>{h||b(se)}).catch(()=>{h||b([])}),()=>{h=!0}},[ne,k,N]),n.useEffect(()=>{if(!k||N!=="all_revisions"&&!F){R([]),N!=="all_revisions"&&de(void 0);return}let h=!1;return ye(!0),Zn({libraryId:k,collectionId:N==="all_revisions"?void 0:F}).then(se=>{var ht,ft,Rt,At;if(h)return;R(se);const q=(ft=(ht=p.current.byLibrary)==null?void 0:ht[k])==null?void 0:ft.lastRevisionId,Ze=((Rt=se.find(Ct=>Ct.revisionId===l.revisionId))==null?void 0:Rt.revisionId)??((At=se.find(Ct=>Ct.revisionId===q))==null?void 0:At.revisionId);de(Ze)}).catch(()=>{h||(R([]),de(void 0))}).finally(()=>{h||ye(!1)}),()=>{h=!0}},[l.revisionId,F,k,N]),n.useEffect(()=>{const h=l.infoId;if(!k||!h){$(void 0);return}let se=!1;return aa({libraryId:k,infoId:h}).then(q=>{if(se)return;const Ze=q.payload??{},ht=Ze.definition&&typeof Ze.definition=="object"?Ze.definition:null,ft=typeof(ht==null?void 0:ht.title)=="string"?ht.title:void 0,Rt=typeof(ht==null?void 0:ht.question)=="string"?ht.question:void 0,At=typeof Ze.label=="string"?Ze.label:void 0,Ct=typeof Ze.name=="string"?Ze.name:void 0,Pt=typeof Ze.title=="string"?Ze.title:void 0;$(ft??Rt??At??Ct??Pt??q.infoId)}).catch(()=>{se||$(h)}),()=>{se=!0}},[l.infoId,k]),n.useEffect(()=>{if(!T.current||l.libraryId&&w.some(ht=>ht.libraryId===l.libraryId)&&l.libraryId!==k||l.target&&l.target!==N||l.revisionView&&l.revisionView!==ke||l.revisionId&&l.revisionId!==H||Un[N].requiresCollection&&!F&&(l.target==="all_collections"||l.target==="all_revisions")&&l.collectionId)return;const h=ba(`${f.pathname}${f.search}`);if(ba(f.pathname)==="/cogita"&&!l.libraryId&&!k){V.current=null;return}if(ba(f.pathname)==="/cogita/persons"){V.current=null;return}if(ba(f.pathname)===`/cogita/library/${k}/revision/run`&&l.revisionView==="run"&&!l.collectionId&&(N==="all_collections"||N==="all_revisions")&&ke==="run"&&!F){V.current=null;return}const Ze=ba(Us(k,N,F,ke,H,l.infoId,l.infoView??"overview",l.collectionView??"infos"));if(h===Ze){V.current=null;return}V.current!==Ze&&(V.current=Ze,c(Ze,{replace:!0}))},[w,f.pathname,f.search,c,l.collectionId,l.infoId,l.infoView,l.collectionView,l.libraryId,l.revisionId,l.revisionView,l.target,F,k,H,ke,N]),n.useEffect(()=>{if(typeof window>"u")return;const h=()=>{window.innerWidth>920&&C(!1)};return window.addEventListener("resize",h),()=>window.removeEventListener("resize",h)},[]),n.useEffect(()=>{if(!T.current||!qe||!k||P.current)return;const h=p.current,se={...h.byLibrary??{}},q={...se[k]??{},lastCollectionId:F,lastRevisionId:H,lastRevisionView:ke,lastTarget:N},Ze={version:1,lastLibraryId:k,byLibrary:{...se,[k]:q}},ht=JSON.stringify(h),ft=JSON.stringify(Ze);if(ht===ft)return;p.current=Ze,P.current=!0,(async()=>{try{if(te)await Or(te,{plainValue:ft});else{const At=await qr(qe,{itemName:On,itemType:"data",plainValue:ft});pe(At.dataItemId)}}catch{Re(d.status.savePrefsFailed)}finally{P.current=!1}})()},[te,qe,F,k,H,ke,N,d.status.savePrefsFailed]);const Ut=async()=>{const h=ot.trim();if(!h){Re(t.cogita.user.libraryNameRequired);return}Re(null);try{const se=await Jr({name:h});m(q=>[se,...q]),D(se.libraryId),ee("library_overview"),M(void 0),$e("")}catch{Re(t.cogita.user.libraryCreateFailed)}},_=async()=>{if(!k||!F){Re(d.status.selectLibraryFirst);return}const h=We.trim();if(!h){Re(d.revisionForm.nameLabel);return}Re(null);try{const se=await Ur({libraryId:k,collectionId:F,name:h,revisionType:"random",revisionSettings:null,mode:"random",check:"exact",limit:20});R(q=>[se,...q]),de(se.revisionId),ee(N==="all_revisions"?"all_revisions":"all_collections"),Je("settings"),Ae("")}catch{Re(d.status.loadFailed)}};return e.jsx($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,headerExtra:e.jsxs("div",{className:"cogita-header-reviewer-actions",children:[e.jsxs("label",{className:"cogita-header-reviewer",children:[e.jsx("span",{children:"Person"}),e.jsxs("select",{value:at,disabled:!k,onChange:h=>{const se=h.target.value;if(se==="__new_person__"){c("/cogita/persons");return}Ie(se)},children:[e.jsx("option",{value:"",children:k?"No person":"Select library first"}),rt.map(h=>e.jsx("option",{value:h.roleId,children:h.label},h.roleId)),e.jsx("option",{value:"__new_person__",children:"+ Create new person"})]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>c("/cogita/persons"),children:"Persons"})]}),children:e.jsxs("section",{className:"cogita-browser-shell",children:[e.jsxs("aside",{className:`cogita-browser-sidebar ${be?"open":""}`,"aria-label":d.sidebar.title,children:[e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h2",{title:(Z==null?void 0:Z.name)??d.path.noLibrarySelected,children:fa((Z==null?void 0:Z.name)??d.path.noLibrarySelected,Ra)}),e.jsx("p",{className:"cogita-sidebar-note",children:Z?d.sidebar.libraryActionsHint:d.status.selectLibraryFirst}),Et(Kt,"sidebar"),N==="all_revisions"&&Vt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.targets.allRevisions}),Et(Gt,"sidebar"),Et(Vt,"sidebar"),he?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(L==null?void 0:L.name)??d.status.noRevisions,children:fa((L==null?void 0:L.name)??d.status.noRevisions,Ra)}),Et(he,"sidebar")]}):null]}):null,lt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.infoActionsHint}),Et(lt,"sidebar"),Ye?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(le==null?void 0:le.label)??ue??t.cogita.library.list.selectedEmpty,children:fa((le==null?void 0:le.label)??ue??t.cogita.library.list.selectedEmpty,Ra)}),e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.selectedInfoActionsHint}),Et(Ye,"sidebar")]}):null]}):null,Tt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.sidebar.collectionActionsHint}),Et(Tt,"sidebar"),fe&&qt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:fe.name,children:fa(fe.name,Ra)}),Et(qt,"sidebar"),N!=="all_revisions"&&Vt?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",children:d.targets.allRevisions}),Et(Gt,"sidebar"),Et(Vt,"sidebar"),he?e.jsxs("div",{className:"cogita-sidebar-actions-nested","data-level":"branch",children:[e.jsx("p",{className:"cogita-sidebar-note",title:(L==null?void 0:L.name)??d.status.noRevisions,children:fa((L==null?void 0:L.name)??d.status.noRevisions,Ra)}),Et(he,"sidebar")]}):null]}):null]}):null]}):null]}),e.jsxs("div",{className:"cogita-browser-sidebar-section",children:[e.jsx("h3",{children:d.sidebar.alwaysAvailable}),e.jsxs("div",{className:"cogita-sidebar-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:r,children:d.sidebar.accountSettings}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{j("cogita"),C(!1)},children:d.sidebar.cogitaHome}),e.jsx("button",{type:"button",className:"ghost",onClick:i,children:o?t.account.secureModeDisable:t.account.secureModeEnable}),e.jsx("button",{type:"button",className:"ghost",disabled:!k,onClick:()=>{k&&(c(`/cogita/live-sessions/${encodeURIComponent(k)}`),C(!1))},children:t.cogita.library.revision.live.hostTitle})]})]})]}),be?e.jsx("button",{type:"button",className:"cogita-sidebar-backdrop","aria-label":d.sidebar.closeMenu,onClick:()=>C(!1)}):null,e.jsxs("div",{className:"cogita-browser-page",children:[e.jsxs("nav",{className:"cogita-browser-menu","aria-label":d.navigationAria,children:[e.jsx("button",{type:"button",className:"ghost cogita-sidebar-toggle",onClick:()=>C(h=>!h),"aria-label":be?d.sidebar.closeMenu:d.sidebar.openMenu,children:e.jsxs("span",{className:"cogita-sidebar-toggle-icon","aria-hidden":"true",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),St.map((h,se)=>e.jsxs("div",{className:"cogita-browser-segment",children:[se>0?e.jsx("span",{className:"cogita-browser-separator",children:"›"}):null,h.options.length===0?e.jsx("span",{className:"cogita-browser-static","aria-label":h.label,title:h.selectedLabel,children:fa(h.selectedLabel,qs)}):e.jsxs("select",{"aria-label":h.label,value:h.value,onChange:q=>h.onSelect(q.target.value),disabled:h.disabled,children:[h.emptyOption?e.jsx("option",{value:"",children:h.emptyOption}):null,h.options.map(q=>e.jsx("option",{value:q.value,title:q.label,children:fa(q.label,qs)},`${h.key}:${q.value}`))]})]},`menu:${h.key}`))]}),Zt?e.jsxs(e.Fragment,{children:[(N==="all_collections"||N==="all_revisions")&&ke==="new"?e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:d.revisionForm.createAction}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.library.actions.collections}),e.jsxs("select",{value:F??"",onChange:h=>M(h.target.value||void 0),children:[e.jsx("option",{value:"",children:d.selectCollectionOption}),S.map(h=>e.jsx("option",{value:h.collectionId,children:h.name},h.collectionId))]})]}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:d.revisionForm.nameLabel}),e.jsx("input",{type:"text",value:We,onChange:h=>Ae(h.target.value),placeholder:d.revisionForm.namePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:_,children:d.revisionForm.createAction}),Te?e.jsx("p",{className:"cogita-form-error",children:Te}):null]}):null,e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(ir.Provider,{value:!0,children:Zt})})]}):null,Zt?null:e.jsxs(e.Fragment,{children:[W?e.jsx("section",{className:"cogita-browser-embedded",children:e.jsx(Oi,{copy:t,onPersonCreated:h=>{et(se=>se+1)}})}):null,!k&&!W?e.jsxs("section",{className:"cogita-browser-intro",children:[e.jsx("div",{className:"cogita-browser-intro-main",children:e.jsxs("article",{className:"cogita-browser-panel cogita-browser-tutorial",children:[e.jsxs("div",{className:"cogita-browser-tutorial-head",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-browser-tutorial-step",children:He.step}),e.jsx("h2",{children:He.title})]}),e.jsxs("p",{children:[yt+1," / ",dt]})]}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-lead",children:He.lead}),e.jsx("div",{className:"cogita-browser-tutorial-passages",children:He.passages.map(h=>e.jsx("p",{children:h},h))}),e.jsx("div",{className:"cogita-browser-tutorial-focus",children:He.focus.map(h=>e.jsx("span",{children:h},h))}),e.jsx("p",{className:"cogita-browser-note cogita-browser-tutorial-action",children:He.action}),e.jsx("div",{className:"cogita-browser-tutorial-progress",role:"list","aria-label":"Tutorial progress",children:bt.map((h,se)=>e.jsx("button",{type:"button",className:`ghost ${se===yt?"active":""}`,onClick:()=>tt(se),"aria-label":`${se+1}`,children:se+1},`tutorial:${h.title}:${se}`))}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",disabled:yt===0,onClick:()=>tt(h=>Math.max(0,h-1)),children:"Previous"}),e.jsx("button",{type:"button",className:"cta",disabled:yt===dt-1,onClick:()=>tt(h=>Math.min(dt-1,h+1)),children:"Next"})]})]})}),e.jsxs("div",{className:"cogita-browser-intro-side",children:[e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.createLibraryTitle}),e.jsxs("label",{className:"cogita-field full",children:[e.jsx("span",{children:t.cogita.user.libraryNameLabel}),e.jsx("input",{type:"text",value:ot,onChange:h=>$e(h.target.value),placeholder:t.cogita.user.libraryNamePlaceholder})]}),e.jsx("button",{type:"button",className:"cta",onClick:Ut,children:t.cogita.user.createLibraryAction}),Te?e.jsx("p",{className:"cogita-form-error",children:Te}):null]}),e.jsxs("article",{className:"cogita-browser-panel",children:[e.jsx("h2",{children:t.cogita.user.availableLibraries}),w.length===0?e.jsx("p",{className:"cogita-browser-note",children:t.cogita.user.noLibraries}):null,w.length>0?e.jsx("div",{className:"cogita-card-list","data-view":"list",children:w.map(h=>e.jsxs("button",{type:"button",className:"cogita-card-item",onClick:()=>{Nt({libraryId:h.libraryId,target:"library_overview",collectionId:void 0,revisionId:void 0,revisionView:"detail"})},children:[e.jsx("div",{className:"cogita-card-type",children:t.cogita.user.libraryRoleLabel}),e.jsx("h3",{className:"cogita-card-title",children:h.name})]},h.libraryId))}):null]})]})]}):null]})]})]})})}const Oo=Object.freeze(Object.defineProperty({__proto__:null,CogitaWorkspacePage:Co},Symbol.toStringTag,{value:"Module"}));function Io({copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,shareId:c}){const[f,l]=n.useState(null),[d,w]=n.useState("loading"),[m,S]=n.useState(t.cogita.library.collections.defaultName),[A,v]=n.useState("Cogita Library"),[b,X]=n.useState([]),[R,k]=n.useState([]),[D,N]=n.useState("idle"),[ee,F]=n.useState({current:0,total:0}),[M,H]=n.useState(0),[de,ke]=n.useState(""),[Je,ue]=n.useState(null),[$,be]=n.useState(null),[C,U]=n.useState(null),[O,K]=n.useState(null),[J,Y]=n.useState([]),[ye,Te]=n.useState({}),[Re,Me]=n.useState({}),[tt,ot]=n.useState(null),[$e,Oe]=n.useState(null),[kt,We]=n.useState(null),[Ae,rt]=n.useState(null),[gt,at]=n.useState({}),Ie=n.useRef(0),[Ue,et]=n.useState(null),qe=n.useRef(null),B=n.useRef(null),[te,pe]=n.useState(null),[p,T]=n.useState(!1),[P,V]=n.useState(null),[Z,fe]=n.useState([]),[W,L]=n.useState(null),we=n.useRef(null),ne=n.useRef(null),[G,Q]=n.useState(null),[ge,oe]=n.useState(0),le=n.useRef(null),Ce=n.useRef({}),[ze,Ke]=n.useState(!1),[Ee,bt]=n.useState({}),dt=n.useRef(null),yt=n.useRef(new Set),He=n.useRef({}),[_e,mt]=n.useState([]),[nt,pt]=n.useState(new Set),[Bt,It]=n.useState(!1),Nt=Ea(),Lt=n.useMemo(()=>new URLSearchParams(Nt.search),[Nt.search]),St=n.useMemo(()=>Lt.get("key")??"",[Lt]),ut=(f==null?void 0:f.mode)??"random",Kt=(f==null?void 0:f.check)??"exact",lt=(f==null?void 0:f.limit)??20,Ye=n.useMemo(()=>cs((f==null?void 0:f.revisionType)??ut),[f,ut]),Tt=n.useMemo(()=>{const E=f==null?void 0:f.revisionSettings,ie=gr(Ye,Lt);return kn(Ye,E??ie)},[f,Lt,Ye]),Gt=n.useMemo(()=>t.cogita.library.revision[Ye.labelKey]??ut,[t,ut,Ye]),qt=n.useMemo(()=>Kt==="exact"?t.cogita.library.revision.checkValue:Kt,[t,Kt]),he=d==="ready"?b[M]??null:null,Et=(he==null?void 0:he.checkType)==="translation-match"&&Ae,Zt=n.useRef(new Map),Ut=n.useRef(new Map),_=n.useRef(new Map),h=n.useRef(new Map),se=n.useMemo(()=>he?he.cardType==="vocab"?t.cogita.library.revision.vocabLabel:he.infoType?it(t,he.infoType):t.cogita.library.revision.infoLabel:"",[t,he]),q=n.useMemo(()=>{var ie;return Ye.id!=="levels"?b.length:((ie=Ee.pool)==null?void 0:ie.length)??Ye.getFetchLimit(lt,Tt)},[Ee,Tt,Ye,b.length,lt]),Ze=Ye.getProgressTotal?Ye.getProgressTotal(b,Ee,lt,Tt):Ye.id==="levels"?Math.min(lt,q):b.length,ht=Ze?Math.min(M+1,Ze):0,ft=Math.max(1,Number(Tt.tries??1)),Rt=Tt.compare??"anchors",At=Math.max(0,Math.min(100,Number(Tt.minCorrectness??0))),Ct=(Tt.considerDependencies??"on")==="on",Pt=Math.max(0,Math.min(100,Number(Tt.dependencyThreshold??85))),ha=E=>{const ie=E.slice();for(let ve=ie.length-1;ve>0;ve-=1){const De=Math.floor(Math.random()*(ve+1));[ie[ve],ie[De]]=[ie[De],ie[ve]]}return ie},ma=E=>xa(E,{treatSimilarCharsAsSame:!0})>=At,_t=async()=>{const E=await da(),ie=new Map,ve=new Map;E.forEach(je=>{const Fe=`${je.itemType}:${je.itemId}`,Le=ta(je.itemType,je.itemId,je.checkType,je.direction);ie.has(Fe)||ie.set(Fe,[]),ie.get(Fe).push(je),ve.has(Le)||ve.set(Le,[]),ve.get(Le).push(je)});const De=new Map,Be=new Map;return ie.forEach((je,Fe)=>De.set(Fe,ca(je).score)),ve.forEach((je,Fe)=>Be.set(Fe,ca(je).score)),{itemKnowness:De,cardKnowness:Be}},na=async E=>{const ie=Ee,ve=E.concat(ie.active??[]).concat(ie.pool??[]).filter((y,I,z)=>z.findIndex(ce=>Se(ce)===Se(y))===I);if(!Ct){pt(new Set(ve.map(Se)));return}const{itemKnowness:De,cardKnowness:Be}=await _t(),je=y=>{if(y.cardType!=="info"||y.infoType!=="citation"||y.checkType!=="quote-fragment")return!0;const I=Qt(y.direction);if(!(I!=null&&I.fragmentId))return!0;const z=y.description??"";if(!z.trim())return!0;const me=va(z).nodes[I.fragmentId];if(!me||!me.leftId&&!me.rightId)return!0;const re=[me.leftId,me.rightId].filter(Ne=>!!Ne);if(re.length===0)return!0;const xe=re.map(Ne=>{const Ve=ta("info",y.cardId,"quote-fragment",Ne);return Be.get(Ve)??0});return xe.reduce((Ne,Ve)=>Ne+Ve,0)/xe.length>=Pt},Fe=(f==null?void 0:f.collectionId)??null,Le=Fe?_e.filter(y=>Mt(y.childItemType)==="collection"&&y.childItemId===Fe&&!Mt(y.childCheckType)&&!Mt(y.childDirection)):[],Pe=Fe&&ve.length>0?ve.reduce((y,I)=>y+(Be.get(Se(I))??0),0)/ve.length:0,Xe=new Set;for(const y of ve){if(y.cardType!=="info"){Xe.add(Se(y));continue}if(!je(y))continue;const I=_e.filter(me=>xr(me,y)).concat(Le);if(I.length===0){Xe.add(Se(y));continue}let z=0;for(const me of I)if(Mt(me.parentItemType)==="collection")z+=me.parentItemId===Fe?Pe:0;else if(Mt(me.parentCheckType)||Mt(me.parentDirection)){const re=Mt(me.parentCheckType),xe=Mt(me.parentDirection),ae=ta(me.parentItemType,me.parentItemId,re,xe);z+=Be.get(ae)??0}else{const re=`${me.parentItemType}:${me.parentItemId}`;z+=De.get(re)??0}z/I.length>=Pt&&Xe.add(Se(y))}pt(Xe)},Ta=E=>{for(let ie=E;ie<b.length;ie+=1){const ve=b[ie];if(ve&&(!Ct||ve.cardType!=="info"||nt.has(Se(ve))))return ie}return-1},vt=E=>!Ct||E.cardType!=="info"||nt.has(Se(E)),Dt=E=>{if(Ye.id!=="temporal"&&Ye.id!=="levels")return null;const ie=Ee,ve=(ie.active??[]).concat(ie.pool??[]),De=new Set;for(const Be of ve){const je=Se(Be);if(!(De.has(je)||E.has(je))&&(De.add(je),vt(Be)))return Be}return null},ea=n.useMemo(()=>{if(Ye.id!=="levels")return null;const E=Ee,ie=E.pool??[],ve=E.active??[],De=E.levelMap??{},Be=Math.max(1,Number(Tt.levels??1)),je=Array.from({length:Be},()=>0),Fe=new Set(ve.map(y=>Se(y)));ie.forEach(y=>{const I=Math.min(Be,Math.max(1,De[Se(y)]??1));je[I-1]+=1});const Le=ie.length||1,Pe=je.map(y=>y/Le*100),Xe=he?De[Se(he)]??1:null;return{counts:je,percentages:Pe,currentLevel:Xe,levelsCount:Be,activeCount:ve.length,poolCount:ie.length,activeSet:Fe}},[Ee,Tt,Ye,he]),ja=n.useMemo(()=>{if(Ye.id!=="temporal")return null;const E=Ee,ie=E.pool??[],ve=E.active??[],De=E.knownessMap??{},Be=new Set(E.unknownSet??[]);let je=0;ie.forEach(Pe=>{(De[Se(Pe)]??0)>1&&(je+=1)});const Fe=Be.size,Le=ve.map(Pe=>({id:Se(Pe),value:Be.has(Se(Pe))?0:Math.max(0,Math.min(1,De[Se(Pe)]??0))}));return{knownCount:je,unknownCount:Fe,dots:Le}},[Ee,Ye]),Ga=n.useMemo(()=>{if(!Ct)return 0;const E=Ee;return b.concat(E.active??[]).concat(E.pool??[]).filter((ve,De,Be)=>Be.findIndex(je=>Se(je)===Se(ve))===De).filter(ve=>ve.cardType==="info"&&!nt.has(Se(ve))).length},[Ct,Ee,b,nt]);n.useEffect(()=>{if(!Ct||D!=="ready")return;const E=Ee,ve=b.concat(E.active??[]).concat(E.pool??[]).filter((je,Fe,Le)=>Le.findIndex(Pe=>Se(Pe)===Se(je))===Fe).filter(je=>je.cardType!=="info"||nt.has(Se(je))).length,De=we.current;if(we.current=ve,De===null||ve<=De)return;const Be=ve-De;L(`New card available (+${Be})`),ne.current&&window.clearTimeout(ne.current),ne.current=window.setTimeout(()=>L(null),2200)},[Ct,D,Ee,b,nt]),n.useEffect(()=>()=>{ne.current&&window.clearTimeout(ne.current)},[]);const Yt=(E,ie)=>{const ve=Ye.applyOutcome({queue:b,meta:Ee},he,lt,Tt,{correct:E,correctness:ie,createdUtc:new Date().toISOString()});X(ve.queue),bt(ve.meta);const De=ve.queue[M+1];De&&Ot(De,M+1)};n.useEffect(()=>{if(!c){w("error");return}w("loading"),Hr({shareId:c,key:St}).then(E=>{l(E),S(E.collectionName),v(E.libraryName),w("ready")}).catch(()=>{w("error")})},[c,St]),n.useEffect(()=>{c&&Wr({shareId:c,key:St,type:"language"}).then(E=>k(E)).catch(()=>k([]))},[c,St]),n.useEffect(()=>{!c||d!=="ready"||Qr({shareId:c,key:St}).then(E=>mt(E.items??[])).catch(()=>mt([]))},[c,St,d]),n.useEffect(()=>{if(!c||d!=="ready")return;let E=!0;return(async()=>{N("loading"),F({current:0,total:Ye.id==="levels"?0:Ye.getFetchLimit(lt,Tt)});try{const ve=[];let De=null,Be=null;do{const I=await Gr({shareId:c,key:St,limit:300,cursor:De});if(ve.push(...I.items),(Ye.id==="levels"||Ye.id==="temporal")&&I.total&&(Be=I.total),F(z=>({current:ve.length,total:z.total||I.total||Ye.getFetchLimit(lt,Tt)})),De=I.nextCursor??null,Be!==null&&ve.length>=Be||Ye.id!=="levels"&&Ye.id!=="temporal"&&ve.length>=Ye.getFetchLimit(lt,Tt))break}while(De);if(!E)return;const je=qa(ve);let Fe;if(Ye.id==="levels"){const I=Math.max(1,Number(Tt.levels??1));Fe={},je.forEach(z=>{const ce=Se(z);Fe[ce]=Math.max(1,Math.min(I,1))})}let Le=null,Pe=null,Xe=null;if(Ye.id==="temporal"){const I=await da(),z=new Set(je.map(re=>Se(re))),ce=I.reduce((re,xe)=>{const ae=ta(xe.itemType,xe.itemId,xe.checkType,xe.direction);return z.has(ae)&&(re[ae]||(re[ae]=[]),re[ae].push(xe)),re},{});Le={},Pe=new Set,Xe={};const me=Date.now();je.forEach(re=>{const xe=Se(re),ae=ce[xe]??[];if(ae.length===0){Le[xe]=0,Pe.add(xe),Xe[xe]=[];return}const Ne=is(ae);Xe[xe]=Ne;const Ve=jn(Ne,me);Le[xe]=Ve.knowness})}const y=Ye.id==="levels"?ls(je,lt,Tt,Fe):Ye.id==="temporal"?os(je,lt,Tt,Le??{},Pe??new Set,Xe??{}):Ye.prepare(je,lt,Tt);X(y.queue),bt(y.meta),H(0),N("ready"),F(I=>({current:Math.min(I.current,I.total),total:I.total}))}catch{E&&N("error")}})(),()=>{E=!1}},[c,St,lt,Ye,Tt,d]),n.useEffect(()=>{na(b)},[b,_e,Ct,Pt,f==null?void 0:f.collectionId]),n.useEffect(()=>{if(!he||!Ct){It(!1);return}if(he.cardType!=="info"||nt.has(Se(he))){It(!1);return}const E=Ta(M+1);if(E>=0){It(!1),H(E);return}if(Ye.id==="temporal"||Ye.id==="levels"){const ie=b.slice(0,M+1),ve=b.slice(M+1).filter(vt),De=ie.concat(ve),Be=new Set(De.map(Se)),je=Dt(Be);if(je){const Le=Se(je);Be.has(Le)||(De.push(je),Be.add(Le),bt(Pe=>{const Xe=Pe,y=new Set(Xe.queued??[]);return y.add(Le),{...Xe,queued:y}}))}const Fe=De.findIndex((Le,Pe)=>Pe!==M&&vt(Le));if(Fe>=0){X(De),H(Fe),It(!1);return}}It(!0)},[he,nt,Ct,M,b,Ee,Ye.id]),n.useEffect(()=>{if(ke(""),ue(null),Q(null),oe(0),Y([]),Te({}),Me({}),ot(null),Oe(null),We(null),T(!1),Ke(!1),pe(null),rt(null),at({}),!he){be(null),U(null);return}he.cardType==="info"&&he.infoType==="computed"&&be(t.cogita.library.revision.loadingComputed);let E=!0;return Ot(he,M).then(ie=>{!E||!ie||(be(ie.prompt),U(ie.expectedAnswer),Y(ie.computedExpected),Te(ie.computedAnswers),ot(ie.answerTemplate),Oe(ie.outputVariables),We(ie.variableValues))}),()=>{E=!1}},[he,c,t]),n.useEffect(()=>{if(!he||he.cardType!=="info"||he.infoType!=="citation"){dt.current=null,yt.current=new Set,K(null);return}const E=he.description??"",ie=(he.label??"").trim(),ve=ie.replace(/\s+/g," ").trim(),De=E.replace(/\s+/g," ").trim(),Be=ve&&ve!==De?ie:t.cogita.library.infoTypes.citation;if(!E){K(null),U(null);return}const je=va(E);dt.current=je,be(Be);let Fe=!0;return da().then(Le=>{if(!Fe)return;const Pe=new Map;Le.forEach(ce=>{if(ce.itemType!=="info"||ce.checkType!=="quote-fragment"||!ce.direction)return;const me=Qt(ce.direction);if(!me)return;const re=`${ce.itemId}:${me.fragmentId}`;Pe.has(re)||Pe.set(re,[]),Pe.get(re).push(ce)});const Xe={},y=new Set;Pe.forEach((ce,me)=>{const[re,xe]=me.split(":",2);if(re!==he.cardId)return;const ae=ca(ce).score;Xe[xe]=ae,ae>=Pt&&y.add(xe)}),yt.current=y,He.current=Xe;const I=Qt(he.direction);if(I!=null&&I.fragmentId&&je.nodes[I.fragmentId]){ra(je,I.fragmentId,Be);return}const z=$a(je,y,Xe,Pt,Ct,he.direction);ra(je,(z==null?void 0:z.id)??null,Be)}).catch(()=>{yt.current=new Set,He.current={};const Le=Qt(he.direction);if(Le!=null&&Le.fragmentId&&je.nodes[Le.fragmentId]){ra(je,Le.fragmentId,Be);return}const Pe=$a(je,yt.current,{},Pt,Ct,he.direction);ra(je,(Pe==null?void 0:Pe.id)??null,Be)}),()=>{Fe=!1}},[he,t,Ct,Pt]),n.useEffect(()=>{if(!he||he.cardType!=="vocab"||he.checkType!=="translation-match"){rt(null),at({});return}const ve=(Ee.pool??Ee.active??b).filter(Le=>Le.cardType==="vocab"&&Le.checkType==="translation-match").filter((Le,Pe,Xe)=>Xe.findIndex(y=>y.cardId===Le.cardId)===Pe);ve.some(Le=>Le.cardId===he.cardId)||ve.unshift(he);const Be=ha(ve).slice(0,6).map(Le=>{const Pe=Le.label.split("↔").map(I=>I.trim()).filter(Boolean);if(Pe.length<2)return null;const Xe=`${Le.cardId}:L`,y=`${Le.cardId}:R`;return{cardId:Le.cardId,leftId:Xe,rightId:y,leftLabel:Pe[0],rightLabel:Pe[1]}}).filter(Boolean),je=Be.map(Le=>Le.leftId),Fe=ha(Be.map(Le=>Le.rightId));rt({pairs:Be,leftOrder:je,rightOrder:Fe,selection:{},activeLeft:null,activeRight:null,locked:{}})},[he,b,Ee]),n.useEffect(()=>()=>{qe.current&&window.clearTimeout(qe.current),B.current&&window.clearTimeout(B.current)},[]);const Ca=n.useRef(null);n.useEffect(()=>{if(!he)return;const E=Se(he),ie=typeof document<"u"?document.activeElement:null;if(Ca.current===E&&ie&&(ie.tagName==="INPUT"||ie.tagName==="TEXTAREA"))return;let ve=0;const De=()=>{if(he){if(he.cardType==="info"&&he.infoType==="computed"){if(J.length>0){const je=mn(tt,J,$e),Fe=je?Ce.current[je]:null;if(Fe&&(Fe.focus(),document.activeElement===Fe)){Ca.current=E;return}}if(le.current&&(le.current.focus(),document.activeElement===le.current)){Ca.current=E;return}}else if(he.cardType==="vocab"&&le.current&&(le.current.focus(),document.activeElement===le.current)){Ca.current=E;return}ve<6&&(ve+=1,window.setTimeout(De,40))}},Be=window.setTimeout(De,40);return()=>window.clearTimeout(Be)},[he,J,tt,$e]),n.useEffect(()=>{if(!ze)return;const E=ie=>{ie.key==="Enter"&&(ie.preventDefault(),Jt())};return window.addEventListener("keydown",E),()=>window.removeEventListener("keydown",E)},[ze]);const Ia=E=>{fe(E),V(ca(E))};n.useEffect(()=>{if(!he){V(null),fe([]);return}const E=he.cardType==="info"?"info":"connection";if(he.cardType==="info"&&he.infoType==="citation"){da().then(ie=>{const ve=ie.filter(De=>De.itemType==="info"&&De.itemId===he.cardId&&De.checkType==="quote-fragment"&&hn(De.direction,he.direction));Ia(ve)}).catch(()=>{V(null),fe([])});return}un(E,he.cardId,he.checkType,he.direction).then(ie=>Ia(ie)).catch(()=>{V(null),fe([])})},[he]);const Ka=(E,ie,ve,De)=>{if(E==="info"&&ve==="quote-fragment"){da().then(Be=>{const je=Be.filter(Fe=>Fe.itemType==="info"&&Fe.itemId===ie&&Fe.checkType==="quote-fragment"&&hn(Fe.direction,De));Ia(je)}).catch(()=>{V(null),fe([])});return}un(E,ie,ve,De).then(Be=>Ia(Be)).catch(()=>{V(null),fe([])})},Ya=(E,ie,ve)=>{var Fe;const De=((Fe=ve.pairs.find(Le=>Le.leftId===E))==null?void 0:Fe.rightId)??null;if(!De)return ve;const Be=De===ie;at(Le=>({...Le,[E]:Be?"correct":"incorrect"})),qe.current&&window.clearTimeout(qe.current),B.current&&window.clearTimeout(B.current),Ie.current+=1;const je={kind:Be?"correct":"incorrect",tick:Ie.current};if(et(null),qe.current=window.setTimeout(()=>et(je),0),B.current=window.setTimeout(()=>et(null),420),Be){const Le={...ve.locked,[E]:!0};return Object.keys(Le).length>=ve.pairs.length?(ue("correct"),Ke(!0)):ue("correct"),{...ve,selection:{...ve.selection,[E]:ie},activeLeft:null,activeRight:null,locked:Le}}return ue("incorrect"),{...ve,activeLeft:null,activeRight:null}},_a=E=>{rt(ie=>!ie||ie.locked[E]?ie:ie.activeRight?Ya(E,ie.activeRight,ie):{...ie,activeLeft:ie.activeLeft===E?null:E})},Nn=E=>{rt(ie=>ie&&(ie.activeLeft?Ya(ie.activeLeft,E,ie):{...ie,activeRight:ie.activeRight===E?null:E}))},Jt=()=>{var E;if(he&&he.cardType==="info"&&he.infoType==="citation"&&dt.current&&O&&!((E=Qt(he.direction))!=null&&E.fragmentId)){const ie=$a(dt.current,yt.current,He.current,Pt,Ct,he.direction,O.fragmentId);if(ie){ue(null),ke(""),T(!1),Me({}),Ke(!1),Q(null),oe(0),ra(dt.current,ie.id,O.title);return}}ue(null),ke(""),T(!1),Me({}),Ke(!1),Q(null),oe(0),H(ie=>Math.min(ie+1,b.length))},Ht=E=>{if(!he)return;const ie=E.expected??null,ve=E.answer??"";let De=ie??"",Be=ve;if(!ie&&E.expectedMap&&E.answerMap){const I=Object.keys(E.expectedMap).sort((z,ce)=>z.localeCompare(ce));De=I.map(z=>{var ce;return((ce=E.expectedMap)==null?void 0:ce[z])??""}).join("|"),Be=I.map(z=>{var ce;return((ce=E.answerMap)==null?void 0:ce[z])??""}).join("|")}const je=De?Pa(De,Be,Rt):new Uint8Array,Fe={revisionType:Ye.id,evalType:E.evalType,direction:E.direction,prompt:$??"",expected:ie,answer:ve,expectedAnswers:E.expectedMap??null,answers:E.answerMap??null,correct:E.correct,maskBase64:je.length?ya(je):null,checkMode:Kt,compareMode:Rt,minCorrectness:At},Le=new TextEncoder().encode(JSON.stringify(Fe)),Pe=he.cardType==="info"?"info":"connection",Xe=E.overrideCheckType??he.checkType??null,y=E.overrideDirection??he.direction??null;dn({itemType:Pe,itemId:he.cardId,checkType:Xe,direction:y,revisionType:Ye.id,evalType:E.evalType,correct:E.correct,maskBase64:je.length?ya(je):null,payloadBase64:ya(Le)}).then(()=>{Ka(Pe,he.cardId,Xe,y),na(b)}).catch(()=>{})},Sn=(E,ie)=>{const ve=Zt.current.get(ie);if(ve)return Promise.resolve(ve);const De=Ut.current.get(ie);if(De)return De;const Be=ps({shareCode:c,infoId:E,key:St}).then(je=>{var I,z;const Fe=je.payload,Le=((I=Fe.definition)==null?void 0:I.graph)??null,Pe="",Xe=((z=Fe.definition)==null?void 0:z.answerTemplate)??"",y=mr(Le,Pe,Xe);if(y){const me={sample:pr(y),answerTemplate:Xe||null};return Zt.current.set(ie,me),me}return fs({shareId:c,infoId:E,key:St}).then(ce=>{const me={sample:ce,answerTemplate:null};return Zt.current.set(ie,me),me})}).catch(()=>fs({shareId:c,infoId:E,key:St}).then(je=>{const Fe={sample:je,answerTemplate:null};return Zt.current.set(ie,Fe),Fe}).catch(()=>({sample:null,answerTemplate:null}))).finally(()=>{Ut.current.delete(ie)});return Ut.current.set(ie,Be),Be},Ot=(E,ie)=>{var Le;const ve=`${Se(E)}:${ie}`,De=_.current.get(ve);if(De)return Promise.resolve(De);const Be=h.current.get(ve);if(Be)return Be;const je=Pe=>(_.current.set(ve,Pe),Pe);let Fe;if(E.cardType==="vocab"){if(E.checkType==="translation-match")return Fe=Promise.resolve(je({prompt:E.description||t.cogita.library.revision.matchLabel,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})),Fe;const Pe=E.label.split("↔").map(Xe=>Xe.trim()).filter(Boolean);if(Pe.length>=2){const y=(E.direction??(Math.random()>=.5?"a-to-b":"b-to-a"))!=="b-to-a",I=y?Pe[0]:Pe[1],z=y?Pe[1]:Pe[0];Fe=Promise.resolve(je({prompt:I,expectedAnswer:z,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else Fe=Promise.resolve(je({prompt:E.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else if(E.cardType==="info"&&E.infoType==="word"){const Pe=(Le=E.description)!=null&&Le.startsWith("Language: ")?E.description.replace("Language: ",""):null;Fe=Promise.resolve(je({prompt:E.label,expectedAnswer:Pe,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}))}else E.cardType==="info"&&E.infoType==="question"?Fe=ps({shareCode:c,infoId:E.cardId,key:St}).then(Pe=>{const Xe=Pe.payload??{},y=Xe.definition??Xe??{},I=rs(y.type??y.kind),z=(typeof y.question=="string"&&y.question.trim()?y.question.trim():null)??(typeof y.title=="string"&&y.title.trim()?y.title.trim():null)??E.label,ce=y.answer;return je(I==="text"||I==="number"||I==="date"?{prompt:z,expectedAnswer:typeof ce=="string"||typeof ce=="number"?String(ce):null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null}:{prompt:z,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})}).catch(()=>je({prompt:E.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},computedValues:null,answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{h.current.delete(ve)}):E.cardType==="info"&&E.infoType==="computed"?Fe=Sn(E.cardId,ve).then(Pe=>{var ce,me;if(!Pe.sample)return je({prompt:E.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null});const Xe=Pe.sample,y=Xe.expectedAnswers?Object.entries(Xe.expectedAnswers).map(([re,xe])=>({key:re,expected:xe})):[],I=y.reduce((re,xe)=>(re[xe.key]="",re),{}),z=Xe.expectedAnswerIsSentence&&((ce=Xe.expectedAnswer)==null?void 0:ce.trim())||null;return je({prompt:Xe.prompt,expectedAnswer:y.length>0?z:((me=Xe.expectedAnswer)==null?void 0:me.trim())||null,computedExpected:y,computedAnswers:I,answerTemplate:Pe.answerTemplate,outputVariables:Xe.outputVariables??null,variableValues:Xe.variableValues??null})}).catch(()=>je({prompt:E.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null})).finally(()=>{h.current.delete(ve)}):Fe=Promise.resolve(je({prompt:E.label,expectedAnswer:null,computedExpected:[],computedAnswers:{},answerTemplate:null,outputVariables:null,variableValues:null}));return h.current.set(ve,Fe),Fe},ra=(E,ie,ve)=>{const De=Object.keys(E.nodes).length,Be=yt.current.size;if(!ie){K({title:ve,before:E.text,after:"",fragmentId:null,total:De,completed:Be}),U(null),Ke(!0);return}const je=E.nodes[ie];if(!je)return;const Fe=vn(E.text,je);K({title:ve,before:Fe.before,after:Fe.after,fragmentId:je.id,total:De,completed:Be}),U(Fe.fragment),Ke(!1)},La=()=>{const E=dt.current;E&&K(ie=>ie&&{...ie,total:Object.keys(E.nodes).length,completed:yt.current.size})},wa=()=>{const E=b[M+1];E&&Ot(E,M+1)},Da=()=>{if(wa(),he&&he.cardType==="vocab"&&he.checkType==="translation-match"&&Ae){if(Ae.pairs.length===0){ue("incorrect"),Ke(!0);return}const je=Ae.pairs.reduce((z,ce)=>(z[ce.rightId]=ce.rightLabel,z),{});let Fe=0;const Le={};Ae.pairs.forEach(z=>{const me=Ae.selection[z.leftId]===z.rightId;Le[z.leftId]=me?"correct":"incorrect",me&&(Fe+=1)});const Pe=Ae.pairs.length||1,Xe=Fe/Pe,y=Fe===Ae.pairs.length;at(z=>({...z,...Le})),y?(ue("correct"),Ke(!0),oe(0)):(ue("incorrect"),Ke(!1),oe(z=>{const ce=z+1;return ce>=ft&&(T(!0),Ke(!0),rt(me=>{if(!me)return me;const re=me.pairs.reduce((xe,ae)=>(xe[ae.leftId]=ae.rightId,xe),{});return{...me,selection:re}})),ce})),Yt(y,Xe);const I="connection";Promise.all(Ae.pairs.map(z=>{const ce=Ae.selection[z.leftId]??null,me=ce?je[ce]:"",re={left:z.leftLabel,expected:z.rightLabel,answer:me,checkType:"translation-match"},xe=new TextEncoder().encode(JSON.stringify(re));return dn({itemType:I,itemId:z.cardId,checkType:"translation-match",direction:null,revisionType:Ye.id,evalType:"translation-match",correct:ce===z.rightId,maskBase64:null,payloadBase64:ya(xe)})})).then(()=>{Ka(I,he.cardId,he.checkType,he.direction),na(b)}).catch(()=>{});return}if(J.length>0){const je=J.reduce((Le,Pe)=>{const Xe=ye[Pe.key]??"";return Le[Pe.key]=zt(Xe)===zt(Pe.expected)?"correct":"incorrect",Le},{});J.every(({key:Le,expected:Pe})=>{const Xe=ye[Le]??"";return Kt==="exact"&&zt(Xe)===zt(Pe)})?(ue("correct"),Me(je),Ke(!0),oe(0),Yt(!0,1),Ht({correct:!0,direction:$?`${$} -> computed`:"computed",expectedMap:J.reduce((Le,Pe)=>(Le[Pe.key]=Pe.expected,Le),{}),answerMap:ye,evalType:"computed"})):(ue("incorrect"),Me(je),Ke(!1),oe(Le=>{const Pe=Le+1;return Pe>=ft&&ga&&(T(!0),Ke(!0)),Pe}),Yt(!1,0),window.setTimeout(()=>{var Pe;const Le=mn(tt,J,$e);Le&&Ce.current[Le]&&((Pe=Ce.current[Le])==null||Pe.focus())},40),Ht({correct:!1,direction:$?`${$} -> computed`:"computed",expectedMap:J.reduce((Le,Pe)=>(Le[Pe.key]=Pe.expected,Le),{}),answerMap:ye,evalType:"computed"}));return}if(he&&he.cardType==="info"&&he.infoType==="citation"&&(O!=null&&O.fragmentId)){if(!C)return;const je=Qt(he.direction),Fe=(je==null?void 0:je.fragmentId)??O.fragmentId,Le=Sa(C,de,{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}),Pe=Le.mask,Xe=Le.isCorrect,y=Le.percent;Xe?(He.current[O.fragmentId]=Math.max(He.current[O.fragmentId]??0,y),(He.current[O.fragmentId]??0)>=Pt&&yt.current.add(O.fragmentId),La(),ue("correct"),Me({}),Ke(!0),Q(Pe),oe(0),y<100&&ft<=1&&T(!0),Yt(!0,y/100),Ht({correct:!0,direction:`quote:${O.fragmentId}`,expected:C,answer:de,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Fe})):(ue("incorrect"),Me({}),Ke(!1),Q(Pe),oe(I=>{const z=I+1;return z>=ft&&ga&&(T(!0),Ke(!0)),z}),Yt(!1,y/100),window.setTimeout(()=>{var I;return(I=le.current)==null?void 0:I.focus()},40),Ht({correct:!1,direction:`quote:${O.fragmentId}`,expected:C,answer:de,evalType:"quote-fragment",overrideCheckType:"quote-fragment",overrideDirection:Fe}));return}if(!C)return;const E=Pa(C,de,Rt),ie=Kt==="exact"&&zt(de)===zt(C),ve=ma(E),De=ie||ve,Be=xa(E);De?(ue("correct"),Me({}),Ke(!0),Q(E),oe(0),Be<100&&ft<=1&&T(!0),Yt(!0,Be/100),Ht({correct:!0,direction:$?`${$} -> ${C}`:null,expected:C,answer:de,evalType:"text"})):(ue("incorrect"),Me({}),Ke(!1),Q(E),oe(je=>{const Fe=je+1;return Fe>=ft&&ga&&(T(!0),Ke(!0)),Fe}),Yt(!1,Be/100),window.setTimeout(()=>{var je;return(je=le.current)==null?void 0:je.focus()},40),Ht({correct:!1,direction:$?`${$} -> ${C}`:null,expected:C,answer:de,evalType:"text"}))},Tn=E=>{if(wa(),!C)return;const ie=Pa(C,E,Rt),ve=zt(E)===zt(C),De=ma(ie),Be=ve||De,je=xa(ie);Be?(ue("correct"),Me({}),Ke(!0),Q(ie),oe(0),je<100&&ft<=1&&T(!0),Yt(!0,je/100),Ht({correct:!0,direction:"word->language",expected:C,answer:E,evalType:"language-select"})):(ue("incorrect"),Me({}),Ke(!1),Q(ie),oe(Fe=>{const Le=Fe+1;return Le>=ft&&ga&&(T(!0),Ke(!0)),Le}),Yt(!1,je/100),Ht({correct:!1,direction:"word->language",expected:C,answer:E,evalType:"language-select"}))},Cn=E=>{var ve;if(E.key!=="Enter")return;if(E.preventDefault(),E.stopPropagation(),ze){Jt();return}const ie=J.find(De=>!(ye[De.key]??"").trim());if(ie){(ve=Ce.current[ie.key])==null||ve.focus();return}Da()},Ma=()=>{wa(),ue("correct"),Ke(!0),oe(0),Yt(!0,1),C&&Ht({correct:!0,direction:"manual",expected:C,answer:de,evalType:"manual"})},sa=()=>{if(Yt(!1,0),he&&he.cardType==="info"&&he.infoType==="citation"){ue(null),ke(""),T(!1),Me({}),Ke(!1),Q(null),oe(0),H(E=>Math.min(E+1,b.length));return}Jt()};n.useEffect(()=>{wa()},[M,b]);const In=t.cogita.library.revision.revealModeAfterIncorrect,ga=J.length>0||!!C;return e.jsxs($t,{copy:t,authLabel:a,showProfileMenu:s,onProfileNavigate:r,onToggleSecureMode:i,onLogout:u,secureMode:o,onNavigate:j,language:g,onLanguageChange:x,children:[(d==="loading"||D==="loading")&&e.jsx("div",{className:"cogita-revision-loading",children:e.jsxs("div",{className:"cogita-revision-loading-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:d==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.loading}),e.jsx("div",{className:"cogita-revision-loading-bar",children:e.jsx("span",{style:{width:`${ee.total?Math.min(100,Math.max(0,ee.current/ee.total*100)):0}%`}})}),e.jsx("p",{className:"cogita-revision-loading-meta",children:ee.total?`${Math.min(ee.current,ee.total)} / ${ee.total}`:t.cogita.library.revision.loading})]})}),e.jsxs("section",{className:"cogita-library-dashboard cogita-revision-run","data-mode":"detail",children:[e.jsxs("header",{className:"cogita-library-dashboard-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.shareRunKicker}),e.jsx("h1",{className:"cogita-library-title",children:m}),e.jsx("p",{className:"cogita-library-subtitle",children:A}),e.jsx("p",{className:"cogita-library-subtitle",children:t.cogita.library.revision.modeSummary.replace("{mode}",Gt).replace("{check}",qt)})]}),e.jsx("div",{className:"cogita-library-actions",children:e.jsx("a",{className:"cta ghost",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}),e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid",children:[e.jsx("div",{className:"cogita-library-pane cogita-revision-stats",children:e.jsxs("section",{className:"cogita-library-detail",children:[e.jsx("div",{className:"cogita-detail-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.knownessTitle}),e.jsx("h3",{className:"cogita-detail-title",children:P?`${P.score.toFixed(1)} / 100`:t.cogita.library.revision.knownessEmpty})]})}),e.jsxs("div",{className:"cogita-detail-body",children:[ea?e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.levelsCurrentLabel})," ",ea.currentLevel??"-"," / ",ea.levelsCount]}):null,P?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:t.cogita.library.revision.knownessStats.replace("{correct}",String(P.correct)).replace("{total}",String(P.total))}),P.lastReviewedUtc&&e.jsx("p",{children:t.cogita.library.revision.knownessLast.replace("{date}",new Date(P.lastReviewedUtc).toLocaleString())})]}):e.jsx("p",{children:t.cogita.library.revision.knownessHint}),e.jsx(fr,{outcomes:Z})]})]})}),e.jsxs("div",{className:"cogita-library-panel",children:[W?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:W})}):null,e.jsx(Fa,{feedbackToken:Ue?`${Ue.kind}-${Ue.tick}`:Et?"idle":Je?`${Je}-${M}-${ge}`:"idle",children:d!=="ready"?e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:d==="loading"?t.cogita.library.revision.shareLoading:t.cogita.library.revision.shareInvalid}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]}):he?e.jsx(e.Fragment,{children:Bt?e.jsx("div",{className:"cogita-revision-body",children:e.jsx("p",{className:"cogita-revision-hint",children:t.cogita.library.revision.dependenciesBlocked})}):e.jsx(ss,{copy:t,currentCard:he,currentTypeLabel:se,prompt:$,languages:R,answer:de,onAnswerChange:E=>ke(ie=>gn(ie,E,te)),computedExpected:J,computedAnswers:ye,onComputedAnswerChange:(E,ie)=>Te(ve=>({...ve,[E]:gn(ve[E]??"",ie,te)})),answerTemplate:tt,outputVariables:$e,variableValues:kt,computedFieldFeedback:Re,feedback:Je,canAdvance:ze,quoteContext:O,quotePlaceholder:t.cogita.library.revision.quoteMissingPlaceholder,onCheckAnswer:Da,onSkip:sa,onLanguageSelect:Tn,onMarkReviewed:Ma,onAdvance:Jt,showCorrectAnswer:p,setShowCorrectAnswer:T,onRevealCorrect:()=>Ke(!0),answerMask:G,expectedAnswer:C,hasExpectedAnswer:ga,handleComputedKeyDown:Cn,answerInputRef:le,computedInputRefs:Ce,scriptMode:te,setScriptMode:pe,matchPairs:Ae==null?void 0:Ae.pairs,matchLeftOrder:Ae==null?void 0:Ae.leftOrder,matchRightOrder:Ae==null?void 0:Ae.rightOrder,matchSelection:Ae==null?void 0:Ae.selection,matchActiveLeft:Ae==null?void 0:Ae.activeLeft,matchActiveRight:Ae==null?void 0:Ae.activeRight,matchFeedback:gt,onMatchLeftSelect:_a,onMatchRightSelect:Nn})}):e.jsxs("div",{className:"cogita-card-empty",children:[e.jsx("p",{children:t.cogita.library.revision.completed}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("a",{className:"cta",href:"/#/cogita",children:t.cogita.library.actions.backToCogita})})]})}),e.jsxs("section",{className:"cogita-revision-insights",children:[e.jsxs("div",{className:"cogita-revision-insight-grid",children:[e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.progressTitle}),e.jsx("h3",{className:"cogita-detail-title",children:Ze?`${ht} / ${Ze}`:t.cogita.library.revision.progressUnlimited}),d==="error"&&e.jsx("p",{children:t.cogita.library.revision.shareInvalid}),d==="loading"&&e.jsx("p",{children:t.cogita.library.revision.shareLoading}),d==="ready"&&D==="loading"&&e.jsx("p",{children:t.cogita.library.revision.loading}),d==="ready"&&D==="error"&&e.jsx("p",{children:t.cogita.library.revision.error}),d==="ready"&&D==="ready"&&b.length===0&&e.jsx("p",{children:t.cogita.library.revision.empty})]}),e.jsxs("div",{className:"cogita-revision-insight-card",children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.revealModeLabel}),e.jsx("h3",{className:"cogita-detail-title",children:In}),e.jsxs("p",{children:[e.jsx("strong",{children:t.cogita.library.revision.triesLabel})," ",ft]})]})]}),ea?e.jsxs("div",{className:"cogita-revision-levels",children:[e.jsx("div",{className:"cogita-revision-levels-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:t.cogita.library.revision.levelsCountsLabel}),e.jsxs("h3",{className:"cogita-detail-title",children:[t.cogita.library.revision.levelsStackLabel," ",ea.activeCount," / ",ea.poolCount]})]})}),e.jsx("div",{className:"cogita-revision-level-grid",children:ea.counts.map((E,ie)=>{const ve=ie+1,De=ea.currentLevel===ve,Be=ea.percentages[ie]??0;return e.jsxs("div",{className:"cogita-revision-level-column","data-active":De,children:[e.jsxs("div",{className:"cogita-revision-level-head",children:[e.jsx("span",{children:ve}),e.jsx("strong",{children:E})]}),e.jsx("div",{className:"cogita-revision-level-bar",children:e.jsx("span",{style:{width:`${Math.min(100,Math.max(0,Be))}%`}})}),e.jsxs("div",{className:"cogita-revision-level-meta",children:[Be.toFixed(1),"%"]})]},`level-${ve}`)})})]}):null,ja?e.jsxs("div",{className:"cogita-revision-temporal",children:[e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalUnknownLabel}),e.jsx("strong",{children:ja.unknownCount})]}),e.jsx("div",{className:"cogita-revision-temporal-dots",children:ja.dots.map(E=>e.jsx("span",{style:{background:`rgba(${Math.round(255*(1-E.value))}, ${Math.round(200*E.value)}, 80, 0.9)`}},E.id))}),e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:t.cogita.library.revision.temporalKnownLabel}),e.jsx("strong",{children:ja.knownCount})]})]}):null,Ct?e.jsx("div",{className:"cogita-revision-temporal",children:e.jsxs("div",{className:"cogita-revision-temporal-count",children:[e.jsx("span",{children:"Blocked cards"}),e.jsx("strong",{children:Ga})]})}):null]})]})]})})})]})]})}const qo=Object.freeze(Object.defineProperty({__proto__:null,CogitaRevisionShareRunPage:Io},Symbol.toStringTag,{value:"Module"})),Lo={answerLabel:"Answer",correctAnswerLabel:"Correct answer",trueLabel:"True",falseLabel:"False",fragmentLabel:"Fragment",correctFragmentLabel:"Correct fragment",participantAnswerPlaceholder:"",unsupportedPromptType:"Unsupported prompt type",waitingForReveal:"Waiting for reveal.",selectedPaths:"Selected paths",removePath:"Remove",columnPrefix:"Column"};function ds({prompt:t,revealExpected:a,mode:s,labels:r,answers:i,onTextChange:u,onSelectionToggle:o,onBooleanChange:j,onOrderingMove:g,onMatchingPick:x,onMatchingRemovePath:c}){var v;if(!t)return null;const f={...Lo,...r??{}},l=typeof a<"u",d=String(t.kind??""),w=Array.isArray(a)?a.map(b=>Number(b)).filter(Number.isFinite):[],m=(b,X,R)=>e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:l?f.correctAnswerLabel:f.answerLabel}),e.jsx("input",{type:b==="number"?"number":b==="date"?"date":"text",value:X??"",onChange:k=>R==null?void 0:R(k.target.value),readOnly:s==="readonly"||l,placeholder:f.participantAnswerPlaceholder})]}),S=(b,X)=>X.map((R,k)=>{const D=Array.isArray(b[k])?b[k]:[];return`${k>0?" -> ":""}${String(D[R]??R)}`}).join(""),A=b=>e.jsx("div",{className:"cogita-live-card-surface","data-state":l?"correct":"idle",children:b});if(d==="citation-fragment")return A(e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("span",{style:{opacity:.7},children:String(t.before??"")}),e.jsx("strong",{children:" [ ... ] "}),e.jsx("span",{style:{opacity:.7},children:String(t.after??"")})]}),m("text",l?String(a??""):(i==null?void 0:i.text)??"",u)]}));if(d==="text")return A(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),m(String(t.inputType??"text"),l?String(a??""):(i==null?void 0:i.text)??"",u)]}));if(d==="boolean"){const b=!!a,X=i==null?void 0:i.booleanAnswer;return A(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:`cta ghost ${l&&b?"live-correct-answer":""}`,"data-active":!l&&X===!0?"true":void 0,onClick:()=>j==null?void 0:j(!0),disabled:s==="readonly"||l,children:f.trueLabel}),e.jsx("button",{type:"button",className:`cta ghost ${l&&!b?"live-correct-answer":""}`,"data-active":!l&&X===!1?"true":void 0,onClick:()=>j==null?void 0:j(!1),disabled:s==="readonly"||l,children:f.falseLabel})]})]}))}if(d==="selection"){const b=Array.isArray(t.options)?t.options:[],X=!!t.multiple,R=(i==null?void 0:i.selection)??[];return A(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:b.map((k,D)=>e.jsxs("label",{className:"cogita-share-row","data-state":l&&w.includes(D)?"correct":void 0,children:[e.jsx("span",{children:k}),e.jsx("input",{type:X?"checkbox":"radio",name:"live-selection",checked:l?w.includes(D):R.includes(D),onChange:()=>o==null?void 0:o(D),disabled:s==="readonly"||l})]},`${D}-${k}`))})]}))}if(d==="ordering"){const b=Array.isArray(l?a:i==null?void 0:i.ordering)?(l?a:(i==null?void 0:i.ordering)??[]).map(String):[];return A(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),e.jsx("div",{className:"cogita-share-list",children:b.map((X,R)=>e.jsxs("div",{className:"cogita-share-row","data-state":l?"correct":void 0,children:[e.jsx("span",{children:X}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>g==null?void 0:g(R,-1),disabled:s==="readonly"||l,children:"↑"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>g==null?void 0:g(R,1),disabled:s==="readonly"||l,children:"↓"})]})]},`${R}-${X}`))})]}))}if(d==="matching"){const b=Array.isArray(t.columns)?t.columns:[],X=(a==null?void 0:a.paths)??[],R=Math.max(2,b.length),k=Array.from({length:R},(D,N)=>(i==null?void 0:i.matchingSelection[N])??null);return A(e.jsxs(e.Fragment,{children:[e.jsx("p",{children:String(t.prompt??"")}),e.jsx("div",{style:{display:"grid",gap:"0.65rem",gridTemplateColumns:`repeat(${R}, minmax(0, 1fr))`,alignItems:"start"},children:b.map((D,N)=>e.jsxs("div",{className:"cogita-library-panel",style:{display:"grid",gap:"0.35rem",padding:"0.6rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:`${f.columnPrefix} ${N+1}`}),D.map((ee,F)=>e.jsxs("button",{type:"button",className:"ghost cogita-checkcard-row",style:{textAlign:"left"},"data-active":!l&&k[N]===F?"true":void 0,onClick:()=>x==null?void 0:x(N,F),disabled:s==="readonly"||l,children:[e.jsx("span",{children:ee}),e.jsx("small",{children:F})]},`live-col:${N}:${F}`))]},`live-col:${N}`))}),e.jsxs("div",{style:{display:"grid",gap:"0.4rem",marginTop:"0.65rem"},children:[e.jsx("p",{className:"cogita-user-kicker",children:f.selectedPaths}),l?e.jsx("div",{className:"cogita-share-list",children:X.map((D,N)=>e.jsx("div",{className:"cogita-share-row","data-state":"correct",children:e.jsx("span",{children:S(b,D)})},`path-${N}`))}):(((v=i==null?void 0:i.matchingRows)==null?void 0:v.length)??0)>0?e.jsx("div",{className:"cogita-share-list",children:((i==null?void 0:i.matchingRows)??[]).map((D,N)=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("span",{children:S(b,D)}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>c==null?void 0:c(N),disabled:s==="readonly",children:f.removePath})]},`path-${N}`))}):e.jsx("p",{className:"cogita-library-hint",children:f.waitingForReveal})]})]}))}return e.jsx("p",{className:"cogita-help",children:f.unsupportedPromptType})}const la=t=>String(t??"").trim().toLocaleLowerCase(),pn=t=>Array.from(new Set(t.map(a=>Number(a)).filter(Number.isFinite))).sort((a,s)=>a-s),Js=t=>t.map(a=>a.join(",")).sort().join("|");function Mo(t){const a=[...t];for(let s=a.length-1;s>0;s-=1){const r=Math.floor(Math.random()*(s+1));[a[s],a[r]]=[a[r],a[s]]}return a}function Hs(t){const a=t.map((i,u)=>({value:i,oldIndex:u}));for(let i=a.length-1;i>0;i-=1){const u=Math.floor(Math.random()*(i+1));[a[i],a[u]]=[a[u],a[i]]}const s=a.map(i=>i.value),r=new Map;return a.forEach((i,u)=>r.set(i.oldIndex,u)),{values:s,oldToNew:r}}function Ao(t){const a=t.split("↔").map(s=>s.trim()).filter(Boolean);return a.length>=2?[a[0],a[1]]:null}function Ro(t){if(!t)return null;const a=t.indexOf(":");return a>=0?t.slice(a+1).trim():t.trim()}function $o(t,a,s,r){const i=typeof s.title=="string"&&s.title.trim()?s.title.trim():a,u=typeof s.question=="string"?s.question:a,o=s.type;if(!u)return null;if(o==="selection"){const j=Array.isArray(s.options)?s.options.filter(l=>typeof l=="string"):[],g=Array.isArray(s.answer)?pn(s.answer):[],x=g.length!==1,c=Hs(j),f=g.map(l=>c.oldToNew.get(l)).filter(l=>Number.isInteger(l)).sort((l,d)=>l-d);return{roundIndex:r,cardKey:`info:${t}:question-selection`,publicPrompt:{kind:"selection",title:i,prompt:u,options:c.values,multiple:x,cardLabel:"question"},reveal:{kind:"selection",expected:f,title:i},grade:l=>{const d=Array.isArray(l)?pn(l):[];return JSON.stringify(d)===JSON.stringify(f)}}}if(o==="truefalse"){const j=!!s.answer;return{roundIndex:r,cardKey:`info:${t}:question-truefalse`,publicPrompt:{kind:"boolean",title:i,prompt:u,cardLabel:"question"},reveal:{kind:"boolean",expected:j,title:i},grade:g=>!!g===j}}if(o==="text"||o==="number"||o==="date"){const j=String(s.answer??"");return{roundIndex:r,cardKey:`info:${t}:question-${o}`,publicPrompt:{kind:"text",title:i,prompt:u,inputType:o==="number"?"number":o==="date"?"date":"text",cardLabel:"question"},reveal:{kind:"text",expected:j,title:i},grade:g=>{if(o==="number"){const x=Number(g),c=Number(j);return Number.isFinite(x)&&Number.isFinite(c)&&Math.abs(x-c)<1e-9}return la(g)===la(j)}}}if(o==="ordering"){const j=Array.isArray(s.options)?s.options.filter(x=>typeof x=="string"):[],g=Mo(j);return{roundIndex:r,cardKey:`info:${t}:question-ordering`,publicPrompt:{kind:"ordering",title:i,prompt:u,options:g,cardLabel:"question"},reveal:{kind:"ordering",expected:j,title:i},grade:x=>JSON.stringify(Array.isArray(x)?x.map(String):[])===JSON.stringify(j)}}if(o==="matching"){const g=(Array.isArray(s.columns)?s.columns.map(l=>Array.isArray(l)?l.filter(d=>typeof d=="string"):[]):[]).map(l=>Hs(l)),x=s.answer??{},f=(Array.isArray(x.paths)?x.paths.map(l=>Array.isArray(l)?l.map(d=>Number(d)).filter(Number.isFinite):null).filter(l=>Array.isArray(l)):[]).map(l=>l.map((d,w)=>{var m;return((m=g[w])==null?void 0:m.oldToNew.get(d))??d}));return{roundIndex:r,cardKey:`info:${t}:question-matching`,publicPrompt:{kind:"matching",title:i,prompt:u,columns:g.map(l=>l.values),cardLabel:"question"},reveal:{kind:"matching",expected:{paths:f},title:i},grade:l=>{const d=l??{},w=Array.isArray(d.paths)?d.paths.map(m=>Array.isArray(m)?m.map(S=>Number(S)).filter(Number.isFinite):null).filter(m=>Array.isArray(m)):[];return Js(w)===Js(f)}}}return null}async function Po(t){var f,l;const a=await ns({libraryId:t.libraryId,revisionId:t.revisionId}),r=(await Ja({libraryId:t.libraryId,collectionId:a.collectionId,limit:1e3})).items,i=Array.from(new Set(r.filter(d=>d.cardType==="info").map(d=>d.cardId))),u=new Map;await Promise.all(i.map(async d=>{try{const w=await aa({libraryId:t.libraryId,infoId:d});u.set(d,{infoType:w.infoType,payload:w.payload})}catch{}}));const o=new Map;await Promise.all(Array.from(u.entries()).filter(([,d])=>d.infoType==="computed").map(async([d])=>{try{const w=await Hn({libraryId:t.libraryId,infoId:d});o.set(d,w)}catch{}}));const j=Array.from(new Set(r.filter(d=>d.cardType==="vocab").map(d=>d.label))).filter(Boolean),g={selectMatchingPairPrompt:((f=t.labels)==null?void 0:f.selectMatchingPairPrompt)??"Select the matching pair",wordLanguagePromptPrefix:((l=t.labels)==null?void 0:l.wordLanguagePromptPrefix)??"Language of"},x=[],c=new Set;for(const d of r){if(d.cardType==="vocab"){const m=Ao(d.label);if(!m)continue;if(d.checkType==="translation"&&d.direction==="a-to-b"){const[S,A]=m;x.push({roundIndex:x.length,cardKey:`connection:${d.cardId}:translation:a-to-b`,publicPrompt:{kind:"text",title:d.label,prompt:S,cardLabel:d.description??void 0},reveal:{kind:"text",expected:A,title:d.label},grade:v=>la(v)===la(A)})}else if(d.checkType==="translation"&&d.direction==="b-to-a"){const[S,A]=m;x.push({roundIndex:x.length,cardKey:`connection:${d.cardId}:translation:b-to-a`,publicPrompt:{kind:"text",title:d.label,prompt:A,cardLabel:d.description??void 0},reveal:{kind:"text",expected:S,title:d.label},grade:v=>la(v)===la(S)})}else if(d.checkType==="translation-match"){const S=Array.from(new Set([d.label,...j.filter(v=>v!==d.label).slice(0,3)])),A=S.findIndex(v=>v===d.label);x.push({roundIndex:x.length,cardKey:`connection:${d.cardId}:translation-match`,publicPrompt:{kind:"selection",title:d.label,prompt:g.selectMatchingPairPrompt,options:S,multiple:!1,cardLabel:d.description??void 0},reveal:{kind:"selection",expected:[A],title:d.label},grade:v=>{const b=Array.isArray(v)?pn(v):pn([v]);return b.length===1&&b[0]===A}})}continue}if(d.cardType!=="info")continue;const w=u.get(d.cardId);if(w){if(w.infoType==="word"&&d.checkType==="word-language"){const m=Ro(d.description);if(!m)continue;x.push({roundIndex:x.length,cardKey:`info:${d.cardId}:word-language:${d.direction??""}`,publicPrompt:{kind:"text",title:d.label,prompt:`${g.wordLanguagePromptPrefix}: ${d.label}`,cardLabel:"word-language"},reveal:{kind:"text",expected:m,title:d.label},grade:S=>la(S)===la(m)});continue}if(w.infoType==="computed"&&d.checkType==="computed"){const m=o.get(d.cardId);if(!m)continue;x.push({roundIndex:x.length,cardKey:`info:${d.cardId}:computed`,publicPrompt:{kind:"text",title:d.label,prompt:m.prompt,multiLine:!1,cardLabel:"computed"},reveal:{kind:"text",expected:m.expectedAnswer,title:d.label},grade:S=>la(S)===la(m.expectedAnswer)});continue}if(w.infoType==="question"){const m=dr(w.payload),S=m?$o(d.cardId,d.label,m,x.length):null;S&&(S.roundIndex=x.length,x.push(S));continue}if(w.infoType==="citation"&&!c.has(d.cardId)){c.add(d.cardId);const m=w.payload,S=typeof m.text=="string"?m.text:"",A=typeof m.title=="string"&&m.title.trim()?m.title.trim():d.label;if(!S.trim())continue;const v=va(S,{minLen:7,maxLen:13});for(const b of v.order){const X=v.nodes[b];if(!X)continue;const R=vn(S,X);x.push({roundIndex:x.length,cardKey:`info:${d.cardId}:quote-fragment:${b}`,publicPrompt:{kind:"citation-fragment",title:A,before:R.before,after:R.after,fragmentId:b,cardLabel:"quote-fragment"},reveal:{kind:"citation-fragment",expected:R.fragment,title:A},grade:k=>Sa(R.fragment,String(k??""),{thresholdPercent:90,treatSimilarCharsAsSame:!0,ignorePunctuationAndSpacing:!0}).isCorrect})}continue}}}return x.map((d,w)=>({...d,roundIndex:w}))}function Eo(t){var be;const{libraryId:a,revisionId:s}=t,r=Ea(),i=t.copy.cogita.library.revision,u=i.live,[o,j]=n.useState(null),[g,x]=n.useState([]),[c,f]=n.useState("loading"),[l,d]=n.useState(null),w=`cogita.live.host.${a}.${s}`,m=o?g[o.currentRoundIndex]??null:null,S=o!=null&&o.status&&o.status!=="lobby"?o.currentPrompt??null:null,A=(o==null?void 0:o.currentReveal)??null,v=n.useMemo(()=>o!=null&&o.code&&typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision/${encodeURIComponent(o.code)}`:"",[o==null?void 0:o.code]),b=n.useMemo(()=>o!=null&&o.code&&typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision-screen/${encodeURIComponent(o.code)}`:"",[o==null?void 0:o.code]),X=n.useMemo(()=>{if(!(o!=null&&o.sessionId)||!(o!=null&&o.hostSecret)||typeof window>"u")return"";const C=`${window.location.origin}/#/cogita/live-revision-host/${encodeURIComponent(a)}/${encodeURIComponent(s)}`,U=new URLSearchParams({sessionId:o.sessionId,hostSecret:o.hostSecret,code:o.code});return`${C}?${U.toString()}`},[a,s,o==null?void 0:o.code,o==null?void 0:o.hostSecret,o==null?void 0:o.sessionId]),R=(o==null?void 0:o.status)==="finished"?"finished":o!=null&&o.status&&o.status!=="lobby"?"active":"lobby",k=(C,U)=>C.replace(/\{(\w+)\}/g,(O,K)=>String(U[K]??"")),D={lobby:u.statusLobby,running:u.statusRunning,revealed:u.statusRevealed,finished:u.statusFinished},N=(C,U,O)=>({...C,hostSecret:C.hostSecret||(U==null?void 0:U.hostSecret)||(O==null?void 0:O.hostSecret)||"",code:C.code||(U==null?void 0:U.code)||(O==null?void 0:O.code)||""}),ee=n.useRef(null);n.useEffect(()=>{let C=!1;return Po({libraryId:a,revisionId:s,labels:{selectMatchingPairPrompt:u.selectMatchingPairPrompt,wordLanguagePromptPrefix:u.wordLanguagePromptPrefix}}).then(U=>{C||x(U)}).catch(()=>{C||(d(u.loadRoundsError),f("error"))}),()=>{C=!0}},[a,u.selectMatchingPairPrompt,u.wordLanguagePromptPrefix,s]),n.useEffect(()=>{let C=!1;async function U(){try{const O=new URLSearchParams(r.search),K=O.get("sessionId"),J=O.get("hostSecret"),Y=O.get("code");if(!!(K&&J)&&K&&J){const Re=await bs({libraryId:a,sessionId:K,hostSecret:J});if(C)return;const Me=N(Re,null,{hostSecret:J,code:Y??void 0});j(Me),typeof localStorage<"u"&&localStorage.setItem(w,JSON.stringify({sessionId:Me.sessionId,hostSecret:Me.hostSecret,code:Me.code})),f("ready");return}const Te=await Xr({libraryId:a,revisionId:s,title:u.hostKicker});if(C)return;j(Te),localStorage.setItem(w,JSON.stringify({sessionId:Te.sessionId,hostSecret:Te.hostSecret,code:Te.code})),f("ready")}catch{if(C)return;d(u.createSessionError),f("error")}}return U(),()=>{C=!0}},[a,u.hostKicker,r.search,s,w]),n.useEffect(()=>{if(!o)return;const C=window.setInterval(async()=>{try{const U=await bs({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret});j(O=>N(U,O))}catch{}},1200);return()=>window.clearInterval(C)},[a,o]),n.useEffect(()=>{if(!o||!m||o.status!=="running")return;const C=o.participants.filter(J=>J.isConnected);if(C.length===0)return;const U=new Set(o.currentRoundAnswers.filter(J=>J.roundIndex===o.currentRoundIndex&&(J.cardKey??"")===m.cardKey).map(J=>J.participantId));if(!C.every(J=>U.has(J.participantId)))return;const K=`${o.sessionId}:${o.currentRoundIndex}:${m.cardKey}:running`;ee.current!==K&&(ee.current=K,de().catch(()=>{ee.current=null}))},[m,o]);const F=async C=>{if(!o)return;const U=Object.prototype.hasOwnProperty.call(C,"currentPrompt"),O=Object.prototype.hasOwnProperty.call(C,"currentReveal"),K=await Zr({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret,status:C.status??o.status,currentRoundIndex:C.currentRoundIndex??o.currentRoundIndex,revealVersion:C.revealVersion??o.revealVersion,currentPrompt:U?C.currentPrompt??null:o.currentPrompt??null,currentReveal:O?C.currentReveal??null:o.currentReveal??null});j(J=>N(K,J))},M=async C=>{const U=g[C];!U||!o||await F({status:"running",currentRoundIndex:C,revealVersion:o.revealVersion+1,currentReveal:null,currentPrompt:{...U.publicPrompt,roundIndex:C,cardKey:U.cardKey}})},H=async()=>{g.length&&await M((o==null?void 0:o.currentRoundIndex)??0)},de=async()=>{if(!o||!m)return;const C=new Map(o.currentRoundAnswers.filter(K=>K.roundIndex===o.currentRoundIndex&&(K.cardKey??"")===m.cardKey).map(K=>[K.participantId,K.answer])),U=o.participants.map(K=>{const J=C.get(K.participantId),Y=m.grade(J);return{participantId:K.participantId,isCorrect:Y,pointsAwarded:Y?1:0}}),O=await Yr({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret,scores:U});j(K=>N(O,K)),await F({status:"revealed",revealVersion:O.revealVersion+1,currentReveal:m.reveal})},ke=async()=>{if(!o)return;const C=o.currentRoundIndex+1;if(C>=g.length){await F({status:"finished",currentReveal:null});return}await M(C)},Je=async()=>{if(o){if(o.status==="running"){await de();return}if(o.status==="revealed"){await ke();return}o.status==="lobby"&&await H()}},ue=async C=>{if(o!=null&&o.hostSecret)try{const U=await ei({libraryId:a,sessionId:o.sessionId,hostSecret:o.hostSecret,requestId:C});j(O=>N(U,O))}catch{}},$=async()=>{if(o)try{const C=await rr({libraryId:a,sessionId:o.sessionId});j(C),typeof localStorage<"u"&&localStorage.setItem(w,JSON.stringify({sessionId:C.sessionId,hostSecret:C.hostSecret,code:C.code}))}catch{}};return e.jsx($t,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":R,children:[e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:u.hostKicker}),e.jsx("h2",{className:"cogita-detail-title",children:u.hostTitle}),c==="loading"?e.jsx("p",{children:u.loading}):null,l?e.jsx("p",{className:"cogita-help",children:l}):null,o?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:u.joinCodeLabel}),e.jsx("input",{readOnly:!0,value:o.code})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:u.joinUrlLabel}),e.jsx("input",{readOnly:!0,value:v})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Host URL"}),e.jsx("input",{readOnly:!0,value:X})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:"Presenter URL"}),e.jsx("input",{readOnly:!0,value:b})]}),v?e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:u.qrLabel}),e.jsx("div",{style:{display:"inline-flex",padding:"0.75rem",borderRadius:"12px",background:"#fff"},children:e.jsx(Qs,{value:v,size:176,marginSize:2})})]}):null,e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:u.statusLabel}),e.jsx("input",{readOnly:!0,value:D[o.status]??o.status})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"cta",onClick:H,disabled:!g.length,children:u.publishCurrentRound}),e.jsx("button",{type:"button",className:"cta ghost",onClick:$,children:"Refresh links"})]}),e.jsx("p",{className:"cogita-help",children:k(u.roundsLabel,{count:g.length})})]}):null]}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:u.currentRoundTitle}),e.jsx("h3",{className:"cogita-detail-title",children:S&&typeof S.title=="string"?S.title:(o==null?void 0:o.status)==="lobby"?u.sessionNotStarted:u.waitingForPublishedRound}),(o==null?void 0:o.status)==="lobby"?e.jsx("p",{className:"cogita-help",children:u.hiddenBeforeStart}):e.jsx(Fa,{className:"cogita-live-card-container",feedbackToken:A?`correct-${(o==null?void 0:o.revealVersion)??0}`:"idle",children:e.jsx(ds,{prompt:S,revealExpected:A==null?void 0:A.expected,mode:"readonly",labels:{answerLabel:i.answerLabel,correctAnswerLabel:i.correctAnswerLabel,trueLabel:u.trueLabel,falseLabel:u.falseLabel,fragmentLabel:u.fragmentLabel,correctFragmentLabel:u.correctFragmentLabel,participantAnswerPlaceholder:u.participantAnswerPlaceholder,unsupportedPromptType:u.unsupportedPromptType,waitingForReveal:"Waiting for reveal.",selectedPaths:"Selected paths",removePath:"Remove",columnPrefix:"Column"}})}),R!=="lobby"?e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:Je,disabled:!g.length||!m||o.status==="finished",children:o.status==="revealed"?i.nextQuestion:i.checkAnswer})}):null,R!=="finished"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:u.participantsTitle}),e.jsxs("div",{className:"cogita-share-list",children:[o==null?void 0:o.participants.map(C=>{const U=o.currentRoundAnswers.find(O=>O.participantId===C.participantId);return e.jsx("div",{className:"cogita-share-row",children:e.jsxs("div",{children:[e.jsx("strong",{children:C.displayName}),e.jsxs("div",{className:"cogita-share-meta",children:[U?u.answerStatusAnswered:u.answerStatusWaiting,(U==null?void 0:U.isCorrect)===!0?` · ${u.answerStatusCorrect}`:"",(U==null?void 0:U.isCorrect)===!1?` · ${u.answerStatusIncorrect}`:""]})]})},C.participantId)}),o&&o.participants.length===0?e.jsx("p",{className:"cogita-help",children:u.noParticipants}):null]}),o&&(((be=o.pendingReloginRequests)==null?void 0:be.length)??0)>0?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:"Relogin requests"}),e.jsx("div",{className:"cogita-share-list",children:(o.pendingReloginRequests??[]).map(C=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsxs("div",{children:[e.jsx("strong",{children:C.displayName}),e.jsx("div",{className:"cogita-share-meta",children:new Date(C.requestedUtc).toLocaleTimeString()})]}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>ue(C.requestId),children:"Allow relogin"})]},C.requestId))})]}):null]}):null]}),R!=="lobby"?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:R==="finished"?u.finalScoreTitle:u.pointsTitle}),e.jsx("div",{className:"cogita-share-list",children:((o==null?void 0:o.scoreboard)??[]).map(C=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:C.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[C.score," ",u.scoreUnit]})]},`score:${C.participantId}`))})]}):null]})})})})})}const Uo=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionHostPage:Eo},Symbol.toStringTag,{value:"Module"}));function Ws(t){return`cogita.live.join.${t}`}function Fo(t){const{code:a}=t,s=t.copy.cogita.library.revision,r=s.live,[i,u]=n.useState(""),[o,j]=n.useState(()=>typeof localStorage>"u"?null:localStorage.getItem(Ws(a))),[g,x]=n.useState(null),[c,f]=n.useState("idle"),[l,d]=n.useState(""),[w,m]=n.useState([]),[S,A]=n.useState(null),[v,b]=n.useState([]),[X,R]=n.useState([]),[k,D]=n.useState([]),[N,ee]=n.useState(null),[F,M]=n.useState(!1),H=(g==null?void 0:g.currentPrompt)??null,de=(g==null?void 0:g.currentReveal)??null,ke=de==null?void 0:de.expected,Je=(g==null?void 0:g.status)==="finished"?"finished":g!=null&&g.status&&g.status!=="lobby"?"active":"lobby",ue=n.useMemo(()=>`${(g==null?void 0:g.currentRoundIndex)??0}:${(g==null?void 0:g.revealVersion)??0}:${String((H==null?void 0:H.cardKey)??"")}`,[H==null?void 0:H.cardKey,g==null?void 0:g.currentRoundIndex,g==null?void 0:g.revealVersion]);n.useEffect(()=>{d(""),m([]),A(null),b(Array.isArray(H==null?void 0:H.options)?[...H.options??[]]:[]);const K=Array.isArray(H==null?void 0:H.columns)?Math.max(2,H.columns.length):0;R([]),D(K>0?new Array(K).fill(null):[])},[ue]),n.useEffect(()=>{let K=!0;const J=async()=>{try{const ye=await Wn({code:a,participantToken:o});if(!K)return;x(ye),o&&f("ready")}catch{K&&c!=="joining"&&f("error")}};J();const Y=window.setInterval(J,1200);return()=>{K=!1,window.clearInterval(Y)}},[a,o,c]),n.useEffect(()=>{if(!N||!F||o)return;let K=!1;const J=window.setInterval(async()=>{try{const Y=await ti({code:a,requestId:N});if(K)return;Y.status==="approved"&&(M(!1),f("idle"))}catch{}},1200);return()=>{K=!0,window.clearInterval(J)}},[a,o,F,N]);const $=async()=>{f("joining");try{const K=await ai({code:a,name:i});j(K.participantToken),localStorage.setItem(Ws(a),K.participantToken),M(!1),ee(null),f("ready")}catch(K){if(K instanceof as&&K.status===409)try{const J=await ni({code:a,name:i});ee(J.requestId),M(!0),f("ready");return}catch{f("error");return}f("error")}},be=K=>{if(!!(H!=null&&H.multiple)){m(Y=>Y.includes(K)?Y.filter(ye=>ye!==K):[...Y,K].sort((ye,Te)=>ye-Te));return}m([K])},C=(K,J)=>{b(Y=>{const ye=[...Y],Te=K+J;return Te<0||Te>=ye.length?Y:([ye[K],ye[Te]]=[ye[Te],ye[K]],ye)})},U=(K,J)=>{const Y=Array.isArray(H==null?void 0:H.columns)?H.columns:[],ye=Math.max(2,Y.length);D(Te=>{const Re=Array.from({length:ye},(tt,ot)=>Te[ot]??null);if(Re[K]=Re[K]===J?null:J,Re.some(tt=>tt==null))return Re;const Me=Re.map(tt=>Number(tt));return R(tt=>[...tt,Me]),new Array(ye).fill(null)})},O=async()=>{if(!o||!H||typeof H.cardKey!="string")return;let K=null;switch(H.kind){case"selection":K=w;break;case"boolean":K=S;break;case"ordering":K=v;break;case"matching":K={paths:X};break;case"citation-fragment":case"text":default:K=l;break}try{await si({code:a,participantToken:o,roundIndex:Number(H.roundIndex??(g==null?void 0:g.currentRoundIndex)??0),cardKey:H.cardKey,answer:K});const J=await Wn({code:a,participantToken:o});x(J),f("ready")}catch{f("error")}};return e.jsx($t,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":Je,children:[e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:r.joinKicker}),e.jsx("h2",{className:"cogita-detail-title",children:r.joinTitle}),o?e.jsx("p",{className:"cogita-help",children:r.joinedWaiting}):e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"cogita-field",children:[e.jsx("span",{children:r.participantNameLabel}),e.jsx("input",{value:i,onChange:K=>u(K.target.value)})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:$,disabled:!i.trim()||c==="joining",children:c==="joining"?r.joiningAction:r.joinAction})})]}),F?e.jsx("p",{className:"cogita-help",children:"Relogin request sent. Wait for host approval and join again."}):null,c==="error"?e.jsx("p",{className:"cogita-help",children:r.connectionError}):null,Je==="lobby"?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"cogita-user-kicker",children:r.scoreboardTitle}),e.jsxs("div",{className:"cogita-share-list",children:[g==null?void 0:g.scoreboard.map(K=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:K.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[K.score," ",r.scoreUnit]})]},K.participantId)),g&&g.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:r.noParticipants}):null]})]}):null]}),e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:r.questionTitle}),e.jsx("h3",{className:"cogita-detail-title",children:typeof(H==null?void 0:H.title)=="string"?H.title:r.waitingForPublishedRound}),H?e.jsxs(e.Fragment,{children:[e.jsx(Fa,{className:"cogita-live-card-container",feedbackToken:de?`correct-${(g==null?void 0:g.revealVersion)??0}`:"idle",children:e.jsx(ds,{prompt:H,revealExpected:ke,mode:"interactive",labels:{answerLabel:s.answerLabel,correctAnswerLabel:s.correctAnswerLabel,trueLabel:r.trueLabel,falseLabel:r.falseLabel,fragmentLabel:r.fragmentLabel,correctFragmentLabel:r.correctFragmentLabel,participantAnswerPlaceholder:r.participantAnswerPlaceholder,unsupportedPromptType:r.unsupportedPromptType,waitingForReveal:"Waiting for reveal.",selectedPaths:"Selected paths",removePath:"Remove",columnPrefix:"Column"},answers:{text:l,selection:w,booleanAnswer:S,ordering:v,matchingRows:X,matchingSelection:k},onTextChange:d,onSelectionToggle:be,onBooleanChange:A,onOrderingMove:C,onMatchingPick:U,onMatchingRemovePath:K=>R(J=>J.filter((Y,ye)=>ye!==K))})}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta",onClick:O,disabled:!o||!H.cardKey||(g==null?void 0:g.answerSubmitted),children:g!=null&&g.answerSubmitted?r.submitted:r.submitAnswer})})]}):e.jsx("p",{className:"cogita-help",children:r.waitingForHostQuestion})]}),Je!=="lobby"?e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:Je==="finished"?r.finalScoreTitle:r.pointsTitle}),e.jsxs("div",{className:"cogita-share-list",children:[g==null?void 0:g.scoreboard.map(K=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:K.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[K.score," ",r.scoreUnit]})]},`score:${K.participantId}`)),g&&g.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:r.noParticipants}):null]})]}):null]})})})})})}const Jo=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionJoinPage:Fo},Symbol.toStringTag,{value:"Module"}));function Ko(t){const{code:a}=t,s=t.copy.cogita.library.revision.live,[r,i]=n.useState(null),[u,o]=n.useState("loading"),j=(r==null?void 0:r.currentPrompt)??null,g=(r==null?void 0:r.currentReveal)??null,x=g==null?void 0:g.expected,c=n.useMemo(()=>typeof window<"u"?`${window.location.origin}/#/cogita/public/live-revision/${encodeURIComponent(a)}`:"",[a]);return n.useEffect(()=>{let f=!0;const l=async()=>{try{const w=await Wn({code:a});if(!f)return;i(w),o("ready")}catch{if(!f)return;o("error")}};l();const d=window.setInterval(l,1200);return()=>{f=!1,window.clearInterval(d)}},[a]),e.jsx($t,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-grid cogita-live-session-layout","data-stage":(r==null?void 0:r.status)==="lobby"?"lobby":"active",children:[e.jsxs("div",{className:"cogita-library-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:s.hostKicker}),e.jsx("h2",{className:"cogita-detail-title",children:u==="error"?s.connectionError:s.statusLobby}),(r==null?void 0:r.status)==="lobby"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:s.joinCodeLabel}),e.jsx("input",{readOnly:!0,value:a})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:s.joinUrlLabel}),e.jsx("input",{readOnly:!0,value:c})]}),e.jsxs("div",{className:"cogita-field",children:[e.jsx("span",{children:s.qrLabel}),e.jsx("div",{style:{display:"inline-flex",padding:"0.75rem",borderRadius:"12px",background:"#fff"},children:e.jsx(Qs,{value:c,size:176,marginSize:2})})]})]}):e.jsx(Fa,{className:"cogita-live-card-container",feedbackToken:g?`correct-${(r==null?void 0:r.revealVersion)??0}`:"idle",children:e.jsx(ds,{prompt:j,revealExpected:x,mode:"readonly",labels:{answerLabel:t.copy.cogita.library.revision.answerLabel,correctAnswerLabel:t.copy.cogita.library.revision.correctAnswerLabel,trueLabel:s.trueLabel,falseLabel:s.falseLabel,fragmentLabel:s.fragmentLabel,correctFragmentLabel:s.correctFragmentLabel,participantAnswerPlaceholder:s.participantAnswerPlaceholder,unsupportedPromptType:s.unsupportedPromptType,waitingForReveal:"Waiting for reveal.",selectedPaths:"Selected paths",removePath:"Remove",columnPrefix:"Column"}})})]}),e.jsxs("div",{className:"cogita-library-panel cogita-live-scoreboard-panel",children:[e.jsx("p",{className:"cogita-user-kicker",children:(r==null?void 0:r.status)==="finished"?s.finalScoreTitle:s.pointsTitle}),e.jsxs("div",{className:"cogita-share-list",children:[((r==null?void 0:r.scoreboard)??[]).map(f=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsx("div",{children:e.jsx("strong",{children:f.displayName})}),e.jsxs("div",{className:"cogita-share-meta",children:[f.score," ",s.scoreUnit]})]},`presenter-score:${f.participantId}`)),r&&r.scoreboard.length===0?e.jsx("p",{className:"cogita-help",children:s.noParticipants}):null]})]})]})})})})})}const Ho=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveRevisionPresenterPage:Ko},Symbol.toStringTag,{value:"Module"}));function _o(t){const a=Wa(),s=t.copy.cogita.library.revision.live,{libraryId:r}=t,[i,u]=n.useState([]),[o,j]=n.useState("loading"),[g,x]=n.useState(null),[c,f]=n.useState({}),l=n.useMemo(()=>({lobby:s.statusLobby,running:s.statusRunning,revealed:s.statusRevealed,finished:s.statusFinished}),[s.statusFinished,s.statusLobby,s.statusRevealed,s.statusRunning]),d=async()=>{j("loading");try{const m=await ri({libraryId:r});u(m),j("ready")}catch{u([]),j("error")}};n.useEffect(()=>{d()},[r]);const w=async(m,S)=>{x(m.sessionId);try{const A=c[m.sessionId]??await rr({libraryId:r,sessionId:m.sessionId});c[m.sessionId]||f(X=>({...X,[m.sessionId]:{sessionId:A.sessionId,code:A.code,hostSecret:A.hostSecret}}));const v=encodeURIComponent(A.code);if(S==="host"){a(`/cogita/live-revision-host/${encodeURIComponent(r)}/${encodeURIComponent(m.revisionId)}?sessionId=${encodeURIComponent(A.sessionId)}&hostSecret=${encodeURIComponent(A.hostSecret)}&code=${v}`);return}const b=S==="presenter"?`${window.location.origin}/#/cogita/public/live-revision-screen/${v}`:`${window.location.origin}/#/cogita/public/live-revision/${v}`;window.open(b,"_blank","noopener")}finally{x(null)}};return e.jsx($t,{...t,children:e.jsx("section",{className:"cogita-library-dashboard",children:e.jsx("div",{className:"cogita-library-layout",children:e.jsx("div",{className:"cogita-library-content",children:e.jsxs("div",{className:"cogita-library-panel",children:[e.jsxs("div",{className:"cogita-detail-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cogita-user-kicker",children:s.hostKicker}),e.jsx("h2",{className:"cogita-detail-title",children:"Active live sessions"})]}),e.jsx("div",{className:"cogita-form-actions",children:e.jsx("button",{type:"button",className:"cta ghost",onClick:d,children:"Refresh"})})]}),o==="loading"?e.jsx("p",{children:s.loading}):null,o==="error"?e.jsx("p",{className:"cogita-help",children:s.connectionError}):null,o==="ready"&&i.length===0?e.jsx("p",{className:"cogita-help",children:"No active sessions."}):null,e.jsx("div",{className:"cogita-share-list",children:i.map(m=>e.jsxs("div",{className:"cogita-share-row",children:[e.jsxs("div",{children:[e.jsx("strong",{children:m.title||m.sessionId}),e.jsxs("div",{className:"cogita-share-meta",children:[l[m.status]??m.status," · ",s.participantsTitle,": ",m.participantCount]})]}),e.jsxs("div",{className:"cogita-form-actions",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>w(m,"host"),disabled:g===m.sessionId,children:"Host"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>w(m,"presenter"),disabled:g===m.sessionId,children:"Screen"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>w(m,"login"),disabled:g===m.sessionId,children:"Login panel"})]})]},m.sessionId))})]})})})})})}const Wo=Object.freeze(Object.defineProperty({__proto__:null,CogitaLiveSessionsPage:_o},Symbol.toStringTag,{value:"Module"}));export{Vo as C,Oo as a,qo as b,Uo as c,Jo as d,Ho as e,Wo as f};
